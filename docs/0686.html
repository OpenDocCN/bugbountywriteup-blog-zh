<html>
<head>
<title>Bypassing AWS WAF CRS with Cross-Site-Scripting (XSS) payload</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用跨站点脚本(XSS)有效负载绕过AWS WAF CRS</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/bypassing-aws-waf-crs-with-cross-site-scripting-xss-payload-fc90a09b370a?source=collection_archive---------1-----------------------#2020-07-14">https://infosecwriteups.com/bypassing-aws-waf-crs-with-cross-site-scripting-xss-payload-fc90a09b370a?source=collection_archive---------1-----------------------#2020-07-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="c347" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">今年早些时候，我的同事发现了一个明显易受跨站点脚本攻击的应用程序，因为没有对特殊字符进行编码。</p><p id="7830" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然而，他很快了解到，该应用程序是在一个WAF后面，因为试图利用XSS导致HTTP 403错误信息。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/be166d1e683730ebfcb3cb1d027a1885.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BC6YmgUFlMLFogaDxxFQJw.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">标准AWS晶圆错误信息</figcaption></figure><p id="0325" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在与应用程序所有者交谈后，我们了解到实际上应用程序在启用了核心规则集的AWS WAF后面。</p><p id="5b99" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">考虑到有多少web应用程序使用AWS WAF和CRS，绕过它似乎很有挑战性。然而，我们决定花一些额外的时间尝试这样做。</p><p id="6f4b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们开始检查Twitter上有什么，只是为了找到2019年初的这篇帖子:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lb"><img src="../Images/a1326805e0ddc22154ca042ea3cb975c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yCs4nZtMvpB1IZcV2gbtBg.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">不幸的是，这个有效载荷对我们不起作用</figcaption></figure><p id="a6f0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，我们更新了我们的有效载荷，并了解到WAF实际上被绕过了，但是脚本没有被执行，因为主要的web浏览器将这个有效载荷视为注释。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lc"><img src="../Images/c474ff13afcfa333eccad863f530abd6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Wk4cOwM-Xf7oNgjRzFkLmw.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">脚本不在web浏览器中执行</figcaption></figure><p id="26a2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然而，现在很清楚，在实际有效载荷前加上一些其他字符可能会导致晶片旁路。</p><p id="2d4c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">考虑到这一点，我启动了打嗝的入侵者试图取代“！”(%21)字符和一些其他十六进制值，这将允许绕过WAF。</p><p id="e3f0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">过了一会儿，我有了一个完整的值列表，它没有返回一个错误。但是，</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ld"><img src="../Images/3278260b7f41c9176693eb8b9aaa572b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DBVVuormk1vpmKL4DeSgmg.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">WAF Bypass — script not executed</figcaption></figure><p id="0371" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Best was yet to come though, as my list had also some special characters which went through the WAF unnoticed: <strong class="jp ir">后面的大部分字符(【A-Z】【A-Z】)！</strong> <em class="le"> (%21) </em>，<strong class="jp ir"> / </strong> <em class="le"> (%2F) </em>，<strong class="jp ir">？</strong><em class="le">(% 3F)</em><strong class="jp ir"/><strong class="jp ir">%</strong><em class="le">(% 25)。</em></p><p id="6327" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">几秒钟后，很明显，在这四个有效载荷中有一个幸运的赢家，它允许AWS WAF旁路和在web浏览器中执行脚本。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lf"><img src="../Images/8969517ad549e63f07639b8f2ab9f416.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ds1QaGwllYurs5wFkP1OXQ.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">AWS晶圆旁路和脚本执行</figcaption></figure><p id="ebfc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">晶片旁路在AWS晶片日志中也清晰可见</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lg"><img src="../Images/68cdcad73f48d0eb8393d73909525e69.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xQDB9kogQGLPztgTd3I8UQ.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">晶片日志证实XSS有效载荷没有被阻挡</figcaption></figure><p id="ee87" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在花了一段时间思考通过在各种bug bounty程序中使用这个有效载荷我可以赚多少钱之后，我决定向AWS公开它(AWS目前根本没有运行任何bug bounty程序)。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi lh"><img src="../Images/410ad6816c703d5d3a41b7f9359e8b2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:726/format:webp/1*tISYWaY8qy-1jfp877DMYw.png"/></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">好孩子…</figcaption></figure><p id="38d9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">披露时间表:<br/></strong>2020年5月23日—向AWS安全团队发送报告<br/>2020年5月24日—AWS安全团队的首次回应<br/>2020年4月6日—发现确认为漏洞</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi li"><img src="../Images/126a8a9029f3e32d0310fd3565b9d97a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wKWUo2MGxdJGhNDGB68WMg.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">漏洞已确认</figcaption></figure><p id="0803" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2020年10月7日—发布修复程序<br/>2020年13月7日—发表评论</p></div></div>    
</body>
</html>