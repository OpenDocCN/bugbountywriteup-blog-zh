<html>
<head>
<title>Write-Up 04- TryHackMe- Blue</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">向上写04- TryHackMe- Blue</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/write-up-04-tryhackme-blue-e3e58268ca22?source=collection_archive---------0-----------------------#2020-06-09">https://infosecwriteups.com/write-up-04-tryhackme-blue-e3e58268ca22?source=collection_archive---------0-----------------------#2020-06-09</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="fd8c" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">学习利用系统级漏洞并获得目标机器的根权限</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ki"><img src="../Images/07b01e2469ddfe037506f69d381b0c52.png" data-original-src="https://miro.medium.com/v2/resize:fit:1040/1*RJgOi1wt9dOTvaqBk4Ti1A.gif"/></div></figure><h2 id="7c95" class="kq kr it bd ks kt ku dn kv kw kx dp ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">利用系统级漏洞</h2><p id="9203" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu kz lv lw lx ld ly lz ma lh mb mc md me im bi translated">操作系统漏洞非常普遍，而且普遍存在，尤其是微软视窗系统。这些漏洞被以不同的方式利用，使得试图闯入系统的对手能够获得系统级的访问权限。本文将讨论这样一个漏洞。作为概念验证，我将利用微软Windows中一个非常著名的漏洞，名为永恒之蓝。我要开发的机器在<a class="ae mf" href="https://tryhackme.com/room/blue" rel="noopener ugc nofollow" target="_blank"> <strong class="lo iu"> TryHackMe </strong> </a>平台上有售。所以，废话少说，让我们开始吧</p><h2 id="60d9" class="kq kr it bd ks kt ku dn kv kw kx dp ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">目标</h2><p id="57ad" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu kz lv lw lx ld ly lz ma lh mb mc md me im bi translated">利用一个非常流行的Microsoft Windows漏洞获得系统级访问权限并提升权限。</p><h2 id="f1e4" class="kq kr it bd ks kt ku dn kv kw kx dp ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">学习成果</h2><p id="7937" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu kz lv lw lx ld ly lz ma lh mb mc md me im bi translated">利用考虑中的主机将使观众能够:</p><ol class=""><li id="ee9c" class="mg mh it lo b lp mi ls mj kz mk ld ml lh mm me mn mo mp mq bi translated">通过多种方式获得受损系统的外壳</li><li id="fd35" class="mg mh it lo b lp mr ls ms kz mt ld mu lh mv me mn mo mp mq bi translated">迁移进程id以获得更高特权的进程</li><li id="4eb6" class="mg mh it lo b lp mr ls ms kz mt ld mu lh mv me mn mo mp mq bi translated">破解哈希以获得对系统上不同用户帐户的访问权限，从而导致获得对系统上不同标志的访问权限</li></ol><h2 id="422a" class="kq kr it bd ks kt ku dn kv kw kx dp ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">1.侦察阶段</h2><p id="3ede" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu kz lv lw lx ld ly lz ma lh mb mc md me im bi translated">让我们首先收集关于折衷制度的信息。用于收集开放端口和服务相关信息的最常用工具是Nmap。因此，让我们使用Nmap扫描我们的主机，并设置以下标志。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi mw"><img src="../Images/4e0010264637f6f6c27a4d9c5b46d70c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4gFswfNs9nrnDXQcueSpgA.png"/></div></div></figure><p id="3750" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu kz nb lw lx ld nc lz ma lh nd mc md me im bi translated">好了，我们得到了开放端口的数量以及针对这些端口运行的服务。<strong class="lo iu">这回答了我们的任务2 </strong>。这些信息有助于识别服务级别漏洞。请注意，我们还包括脚本vuln，它充当漏洞扫描器，告诉我们它发现的漏洞。在我们的例子中，它的<a class="ae mf" href="https://docs.microsoft.com/en-us/security-updates/SecurityBulletins/2017/ms17-010" rel="noopener ugc nofollow" target="_blank"><strong class="lo iu">MS17–010</strong></a>也称为<a class="ae mf" href="https://en.wikipedia.org/wiki/EternalBlue#cite_note-microsoft.com-20" rel="noopener ugc nofollow" target="_blank"> <strong class="lo iu">永恒之蓝</strong> </a>，这个漏洞被标记为危险级别为严重，因此我们将利用这个漏洞。<strong class="lo iu">这给了我们任务3 </strong>的答案</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi ne"><img src="../Images/a76650b087b34fb269d863203886d046.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YRAuhMS54P70DzVqsOo-6w.png"/></div></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated">易受永恒之蓝攻击的系统</figcaption></figure><h2 id="b533" class="kq kr it bd ks kt ku dn kv kw kx dp ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">2.获得访问权限</h2><p id="4b98" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu kz lv lw lx ld ly lz ma lh mb mc md me im bi translated">现在我们知道了漏洞，是时候利用它了。对于漏洞利用，我们将使用Metasploit，它包含大量可以针对目标系统运行的漏洞利用和post漏洞利用。因此，通过在终端中键入msfconsole来启动Metasploit，并搜索与永恒之蓝(MS17–010)相对应的漏洞</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi nj"><img src="../Images/9b070be713bffc71f095425f09b4ef4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BDDH2ln8B9pofKMlF7dMNA.png"/></div></div></figure><p id="d5db" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu kz nb lw lx ld nc lz ma lh nd mc md me im bi translated">现在我们知道了要使用哪个漏洞，让我们运行这个漏洞。键入show options以了解运行漏洞攻击所需的先决条件参数，如下所示。一旦设置了漏洞和参数，运行如下所示的漏洞</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi nk"><img src="../Images/4e9248f298965537758ccc38b8305d9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4fAfQVzRi4xfY3XtqpKmpQ.png"/></div></div></figure><p id="91ad" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu kz nb lw lx ld nc lz ma lh nd mc md me im bi translated">运行漏洞利用后，我们看到我们已经获得了目标机器的外壳</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi nl"><img src="../Images/5b5a8287e7fb469399293f6019a41f47.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2mHdpx0fQdDEFFx5OVMxOQ.png"/></div></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated">目标系统外壳访问</figcaption></figure><p id="6cc3" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu kz nb lw lx ld nc lz ma lh nd mc md me im bi translated">我们得到了获得访问权阶段的所有答案</p><h2 id="061e" class="kq kr it bd ks kt ku dn kv kw kx dp ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">3.升级(剥削后)</h2><p id="caa6" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu kz lv lw lx ld ly lz ma lh mb mc md me im bi translated">获得一个shell是不够的，我们必须提升我们的权限，以便在系统上执行管理员级别的操作。首先，我们需要将我们的shell升级到meterpreter，因为与普通shell相比，它提供了很多功能。为此，我们需要在Metasploit中搜索<strong class="lo iu"> POST </strong> exploit。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi nm"><img src="../Images/db57db25d8736cc5b900ac9b872795bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pxUq11wxObmFqQArD0tDIw.png"/></div></div></figure><p id="0742" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu kz nb lw lx ld nc lz ma lh nd mc md me im bi translated">因此，在搜索之后，我们得到了要转换成meterpreter的shell的POST模块。这回答了我们在本部分的<strong class="lo iu">任务1问题</strong>。我们需要设置我们的帖子要利用的会话，您可以通过键入<strong class="lo iu"> sessions -l，</strong>列出所有活动的会话，现在通过键入<strong class="lo iu"> SET SESSION # </strong>选择会话。这回答了我们在本节的任务2问题。您也需要设置本地主机，因此键入<strong class="lo iu"> Set LHOST &lt; Ip地址&gt; </strong>。一旦所有参数都设置好了，现在让<strong class="lo iu">运行</strong>post exploit</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi nn"><img src="../Images/5667137e5347e40b1ef8a3a7bfb49d1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UXT-a3LCmBvghrgQjIQbmw.png"/></div></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated">后期开发</figcaption></figure><p id="056c" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu kz nb lw lx ld nc lz ma lh nd mc md me im bi translated">现在我们已经有了我们的meterpreter会话，我们可以通过运行<strong class="lo iu"> getsystem </strong>命令来验证系统信息</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi no"><img src="../Images/6dba108142125e7c567e9baab95dcc03.png" data-original-src="https://miro.medium.com/v2/resize:fit:1292/format:webp/1*M_PJKhr57J_heBAyttSBEA.png"/></div></figure><p id="f3d6" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu kz nb lw lx ld nc lz ma lh nd mc md me im bi translated">运行<strong class="lo iu"> ps </strong>命令检查系统上正在运行的所有进程。注意，放下<strong class="lo iu"> PID </strong>或<strong class="lo iu"> PPID </strong>其用户是NT Authority\SYSTEM。有很多进程作为NT Authority运行，所以我记下了<strong class="lo iu">spoolsv.exe。</strong></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi np"><img src="../Images/71dcc357d2761113be498d31f70de5a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*txeyzfOGUPPxY7EDekt4pQ.png"/></div></div></figure><p id="a8d3" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu kz nb lw lx ld nc lz ma lh nd mc md me im bi translated">现在让我们迁移到PPID来控制更高特权的进程。这回答了本节中的所有任务问题</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/7c042082b5b0569d73ddd11823006168.png" data-original-src="https://miro.medium.com/v2/resize:fit:730/format:webp/1*2YjI1w6Zy_SXFBkFGT78AQ.png"/></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated">迁移成功</figcaption></figure><h2 id="92c2" class="kq kr it bd ks kt ku dn kv kw kx dp ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">4.破裂</h2><p id="d056" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu kz lv lw lx ld ly lz ma lh mb mc md me im bi translated">现在，我们已经通过迁移更高特权的进程完全访问了NT授权系统。是时候破解一些使用用户凭证登录的密码了。使用<strong class="lo iu">散列转储</strong>从SAM数据库中转储所有散列。由此，我们得到了非默认用户的名字<strong class="lo iu"> (Task1) </strong></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi nr"><img src="../Images/7c1439c3b281a07f19c39d9eafd20b5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*duZ4Ilp3Dsb4Z4MvLEzGtg.png"/></div></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated">转储哈希值</figcaption></figure><p id="0173" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu kz nb lw lx ld nc lz ma lh nd mc md me im bi translated">现在我们需要破解非默认用户的哈希来获取密码。为此，我使用了名为<a class="ae mf" href="https://crackstation.net/" rel="noopener ugc nofollow" target="_blank"> <strong class="lo iu">的在线工具。</strong>T29】</a></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi ns"><img src="../Images/d5d9cd70215c18aa5cab3359e2cd19d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i0nj_i8SmaxU_TUTX5XaCw.png"/></div></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated">使用NTLM部分成功破解</figcaption></figure><p id="0d5e" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu kz nb lw lx ld nc lz ma lh nd mc md me im bi translated">这就回答了本节任务2的问题</p><h2 id="d2d5" class="kq kr it bd ks kt ku dn kv kw kx dp ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">5.查找标志</h2><p id="c9c4" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu kz lv lw lx ld ly lz ma lh mb mc md me im bi translated">现在我们已经完成了前一部分的所有任务，是时候找到标志了。<strong class="lo iu">标志</strong>是遍布系统的隐藏检查点。让我们跟着提示，试着找到它们。根据提示，我找到了第一面旗帜</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi nt"><img src="../Images/0c2a8107aa682d6443a45e5b6dcb058c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*46VAmxqI_OeB5tHojE97ow.png"/></div></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated">找到标志</figcaption></figure><p id="8e8c" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu kz nb lw lx ld nc lz ma lh nd mc md me im bi translated">要找到第二个标志，请查找用于存储windows密码的文件夹。你应该通过简单的谷歌搜索找到位置。导航到该文件夹，您会发现flag2</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/2395366d716673bf5b4c995a6ce04264.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/format:webp/1*-6Qf6VJRS8Dhm99Cw5vzMg.png"/></div></figure><p id="f0a5" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu kz nb lw lx ld nc lz ma lh nd mc md me im bi translated">要找出最后一面旗子，你得聪明点。因此，我所做的是搜索以标志开始的文件名，从结果出来，我能够导航到该特定文件夹，并获得我的最后一个标志。如果您无法访问如下所示的目录，请在目录和文件名前使用<strong class="lo iu"> \\ </strong>，这将解决无法访问的问题。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/48fd8aaa41ede704065016e873cfb414.png" data-original-src="https://miro.medium.com/v2/resize:fit:1350/format:webp/1*1eA83Vyedt9BKQELZWntKQ.png"/></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated">找到最终标志</figcaption></figure><h2 id="64ef" class="kq kr it bd ks kt ku dn kv kw kx dp ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">结束语</h2><p id="5ecb" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu kz lv lw lx ld ly lz ma lh mb mc md me im bi translated">永恒之蓝漏洞非常著名，许多系统都是利用这个漏洞被入侵的。微软发布了修复程序，为不同的操作系统修补这些漏洞。由此，我们得出结论，使用这样的漏洞系统可能会受到损害，并且对手可以以他喜欢的任何方式使用它。因此，建议始终使用最新版本、修复程序和补丁来更新您的软件和windows，以降低受到此类漏洞危害的风险</p><h1 id="936c" class="nw kr it bd ks nx ny nz kv oa ob oc ky jz od ka lc kc oe kd lg kf of kg lk og bi translated">关于我</h1><p id="2041" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu kz lv lw lx ld ly lz ma lh mb mc md me im bi translated"><a class="ae mf" href="https://medium.com/@anon_7" rel="noopener">我</a>是一名网络安全爱好者，正在攻读信息安全硕士学位，并试图进入全职网络安全职业。</p></div></div>    
</body>
</html>