<html>
<head>
<title>Using PGP to enhance security and non-repudiation of terraform ops</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用PGP增强平台运营的安全性和不可否认性</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/using-pgp-to-enhance-security-and-non-repudiation-of-terraform-ops-93c0b4bb209f?source=collection_archive---------1-----------------------#2022-04-27">https://infosecwriteups.com/using-pgp-to-enhance-security-and-non-repudiation-of-terraform-ops-93c0b4bb209f?source=collection_archive---------1-----------------------#2022-04-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div class="gh gi io"><img src="../Images/f0d76a43877d2da5fd35a1da26f3b7e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*RTXyjgi0_P4N-PBQ.png"/></div><figcaption class="iv iw gj gh gi ix iy bd b be z dk translated">示例devsecops流程</figcaption></figure><div class=""/><p id="06b1" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://www.terraform.io/" rel="noopener ugc nofollow" target="_blank"> Terraform </a>已经转变为一种<a class="ae kw" href="https://en.wikipedia.org/wiki/Lingua_franca" rel="noopener ugc nofollow" target="_blank">通用语</a>，作为一种代码用于多云基础设施。由于敏感内容(取决于组织政策，密码、IP地址、网络结构等可能被识别为敏感信息)存储为terraform计划和状态的一部分，大多数组织需要采取额外的控制措施，以确保terraform工件得到妥善保护。</p><p id="69e0" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Terraform提供了将<a class="ae kw" href="https://www.terraform.io/cloud-docs/workspaces/variables#sensitive-values" rel="noopener ugc nofollow" target="_blank">变量</a>和<a class="ae kw" href="https://www.terraform.io/language/functions/sensitive" rel="noopener ugc nofollow" target="_blank">值</a>标记为敏感、加密<a class="ae kw" href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_access_key#pgp_key" rel="noopener ugc nofollow" target="_blank">生成的</a>密码和<a class="ae kw" href="https://www.terraform.io/language/settings/backends/s3#kms_key_id" rel="noopener ugc nofollow" target="_blank">存储</a> <a class="ae kw" href="https://www.terraform.io/language/settings/backends/gcs#encryption_key" rel="noopener ugc nofollow" target="_blank">加密的</a>状态的能力，以降低敏感数据泄露的可能性。本文探讨了在这些功能的基础上创建一个标准方法来实现安全性和不可否认性的方法。在这个过程中，它建立在<a class="ae kw" href="https://medium.com/geekculture/enterprise-cloud-security-application-development-16a7efb2027f" rel="noopener">企业云安全:应用程序开发</a>中的高级思想之上。</p><h1 id="1329" class="kx ky jb bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">考虑</h1><p id="5f99" class="pw-post-body-paragraph jy jz jb ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">Terraform提供了可用于创建安全devops基础架构的功能，并且有许多文章介绍了这些功能的使用。同时，对于terraform安全性的当前状态有一些考虑。</p><h2 id="7c16" class="ma ky jb bd kz mb mc dn ld md me dp lh kj mf mg ll kn mh mi lp kr mj mk lt ml bi translated">安全性取决于提供商</h2><p id="c4b4" class="pw-post-body-paragraph jy jz jb ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">大多数安全功能，如加密密码、将值标记为敏感、后端加密特性，都依赖于插件提供者(或者在后端实现的情况下)。这导致了跨提供商甚至在单个提供商内的特别安全方法(例如，<a class="ae kw" href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_access_key#pgp_key" rel="noopener ugc nofollow" target="_blank"> AWS IAM访问密钥</a>使用PGP来启用加密，但是数据库实例中的<a class="ae kw" href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/db_instance#password" rel="noopener ugc nofollow" target="_blank">密码以明文形式维护),这可能为多云场景创建不一致的安全方法。这就需要一种能够跨提供者工作，而不依赖于单个提供者能力的方法。</a></p><h2 id="6c25" class="ma ky jb bd kz mb mc dn ld md me dp lh kj mf mg ll kn mh mi lp kr mj mk lt ml bi translated">国家和超越</h2><p id="7f8f" class="pw-post-body-paragraph jy jz jb ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">terraform安全性的一个重要部分集中在保护状态文件。这主要是因为该文件以纯文本的形式包含密码和其他敏感数据，除非开发人员使用提供者功能对其进行了明确的保护。terraform后端在保护状态文件的能力方面有所不同，从支持使用静态客户密钥加密的<a class="ae kw" href="https://www.terraform.io/language/settings/backends/s3#kms_key_id" rel="noopener ugc nofollow" target="_blank"> AWS </a>(服务器端加密)、<a class="ae kw" href="https://www.terraform.io/language/settings/backends/gcs#encryption_key" rel="noopener ugc nofollow" target="_blank"> GCS </a>(客户提供的加密)，到不提供任何此类能力的<a class="ae kw" href="https://www.terraform.io/language/settings/backends/azurerm" rel="noopener ugc nofollow" target="_blank"> Azure </a>、<a class="ae kw" href="https://www.terraform.io/language/settings/backends/artifactory" rel="noopener ugc nofollow" target="_blank"> Artifactory </a>。像服务器端加密这样的最佳可用安全措施仍然容易受到<a class="ae kw" href="https://en.wikipedia.org/wiki/Deep_packet_inspection#Encryption_and_tunneling_subverting_DPI" rel="noopener ugc nofollow" target="_blank">深度包检查</a>方法的影响(没有适当的<a class="ae kw" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-troubleshooting.html#tshoot-certificate-verify-failed" rel="noopener ugc nofollow" target="_blank">证书验证控制</a>)。</p><p id="b6c1" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">除此之外，还有其他工件，如变量文件、计划，它们可能包含敏感内容，需要适当地保护。多个环境和相关的文件、配置会迅速增加开发团队为了安全需要跟踪的工件的数量。</p><h2 id="22ac" class="ma ky jb bd kz mb mc dn ld md me dp lh kj mf mg ll kn mh mi lp kr mj mk lt ml bi translated">不可否认性呢？</h2><p id="4825" class="pw-post-body-paragraph jy jz jb ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">如何识别变更是作为terraform操作的一部分进行的，还是由有权访问terraform操作所用身份的流氓实体进行的。随着自动化的发展，非常需要确保明确识别授权的变更。这需要超越传统的安全控制，如使用对称密钥加密，以确保工件被签名并发布到正确的工具进行分析。</p><h1 id="1bc4" class="kx ky jb bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">方法</h1><p id="11b7" class="pw-post-body-paragraph jy jz jb ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">为了提供一种安全性和不可否认性的方法，同时提供对多云、多环境场景的支持，已经开发并实现了一种自以为是的方法，该方法利用标准目录结构和PGP对工件进行加密/签名。执行这些操作的脚本可以在<a class="ae kw" href="https://github.com/shekhar-jha/base-demo/tree/infra-core/infra/scripts" rel="noopener ugc nofollow" target="_blank"> github </a>上获得。</p><p id="e93a" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">每个环境都有一个在设置期间生成的PGP密钥对(实现细节见<a class="ae kw" href="https://github.com/shekhar-jha/base-demo/blob/infra-core/infra/aws/core/setup.sh" rel="noopener ugc nofollow" target="_blank"> setup.sh </a>)。创建特定于terraform的目录结构，并复制所有相关文件。随后执行terraform验证、计划操作。计划的输出被存储以供下一步参考和使用。Terraform apply创建状态备份，并使用之前创建的计划来应用更改。成功应用后，terraform目录将被清除(*。tf文件被移除，插件被打包到。插件目录)并打包。该文件被加密并保存到存储位置。</p><p id="497a" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在下一次执行期间(通常使用<a class="ae kw" href="https://github.com/shekhar-jha/base-demo/blob/infra-core/infra/aws/core/apply.sh" rel="noopener ugc nofollow" target="_blank"> apply.sh </a>执行)，保存的状态被加载、解密，然后执行terraform apply命令。这确保了所有内容在存储时都是加密的。这可以很容易地扩展到支持使用外部密钥的签名，以增加过程的不可否认性。</p><h2 id="ef3c" class="ma ky jb bd kz mb mc dn ld md me dp lh kj mf mg ll kn mh mi lp kr mj mk lt ml bi translated">目录结构</h2><p id="7dbc" class="pw-post-body-paragraph jy jz jb ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">传统上，特定于环境的变量文件已经被签入到源代码控制中，而计划和其他中间工件没有被跟踪。在这种方法中，我们为每个环境创建一个目录结构，并跟踪计划、状态、后端配置和变量。</p><figure class="mn mo mp mq gt is gh gi paragraph-image"><div class="gh gi mm"><img src="../Images/f646a203e99832ad274be35b504b9cd6.png" data-original-src="https://miro.medium.com/v2/resize:fit:588/format:webp/1*j_lv-qN18SFwR4DTLrQOmg.png"/></div><figcaption class="iv iw gj gh gi ix iy bd b be z dk translated">地形目录结构</figcaption></figure><p id="0507" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Terraform目录有适当的计划目录(。计划)、状态备份(。状态)和用于审计目的的插件。</p><div class="mn mo mp mq gt ab cb"><figure class="mr is ms mt mu mv mw paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><img src="../Images/658c29a1c454375c61b89d733cd0f880.png" data-original-src="https://miro.medium.com/v2/resize:fit:762/format:webp/1*xov3Y2PM-VxLUFF6ji3zuw.png"/></div></figure><figure class="mr is nb mt mu mv mw paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><img src="../Images/1ff49a35b023bc1624d4649fea0fc336.png" data-original-src="https://miro.medium.com/v2/resize:fit:706/format:webp/1*O8ke8EIMEWxsPYdLGAOUBA.png"/></div></figure><figure class="mr is nc mt mu mv mw paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><img src="../Images/d6d433c1f6daa9531c6f6b21e09b82a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:536/format:webp/1*oi58OQujAH6om8X68QK5Rg.png"/></div><figcaption class="iv iw gj gh gi ix iy bd b be z dk nd di ne nf translated">地形环境中各种目录的内容</figcaption></figure></div><p id="19b0" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这个目录构成了-chdir选项的输入，以确保生成的所有内容(。terraform，. terraform.lock.hcl)，后端配置(backend.cfg)，变量值(terraform.tfvars)在单一位置管理。</p><p id="de35" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">地形操作在<a class="ae kw" href="https://github.com/shekhar-jha/base-demo/blob/infra-core/infra/scripts/tf.sh" rel="noopener ugc nofollow" target="_blank"> tf.sh </a>中实现，并通过<a class="ae kw" href="https://github.com/shekhar-jha/base-demo/blob/infra-core/infra/scripts/infra.sh" rel="noopener ugc nofollow" target="_blank"> infra.sh </a>进行抽象。它提供了初始化环境、应用更改和清理的功能。打包和解包方法清理不必要的文件，并创建tar和压缩文件进行存储</p><h2 id="62f3" class="ma ky jb bd kz mb mc dn ld md me dp lh kj mf mg ll kn mh mi lp kr mj mk lt ml bi translated">加密和签名</h2><p id="0c2f" class="pw-post-body-paragraph jy jz jb ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">terraform目录可以打包，然后存储，以重新创建环境并执行各种操作。该打包文件使用PGP密钥加密，PGP密钥生成并存储在适当的存储器(例如<a class="ae kw" href="https://aws.amazon.com/secrets-manager/" rel="noopener ugc nofollow" target="_blank"> AWS Secret Manager </a>)中，以便在需要时检索。<a class="ae kw" href="https://github.com/shekhar-jha/base-demo/blob/infra-core/infra/scripts/pgp.sh" rel="noopener ugc nofollow" target="_blank"> pgp.sh </a>文件提供了使用<a class="ae kw" href="https://gnupg.org/" rel="noopener ugc nofollow" target="_blank"> gpg </a>包生成、存储、检索和删除pgp密钥的方法。除此之外，它还提供加密和解密文件的方法。</p><h2 id="ba8d" class="ma ky jb bd kz mb mc dn ld md me dp lh kj mf mg ll kn mh mi lp kr mj mk lt ml bi translated">管理文件</h2><p id="6dd7" class="pw-post-body-paragraph jy jz jb ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">使用包含存储密钥和文件的通用方法的<a class="ae kw" href="https://github.com/shekhar-jha/base-demo/blob/infra-core/infra/scripts/store.sh" rel="noopener ugc nofollow" target="_blank"> store.sh </a>文件中的可用脚本，可以从选择的文件存储中存储和检索加密文件(目前支持AWS S3)。aws.sh提供了特定于aws的操作。</p></div><div class="ab cl ng nh hu ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="ij ik il im in"><p id="d2a1" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">随着terraform成为基础设施代码的首选语言，开发控制措施以确保在生成环境的生命周期中保持适当的审计、日志记录、安全性和不可否认性水平，这带来了独特的挑战。本文分享了到目前为止所做的一些工作。这项工作将继续建立在当前工作的基础上，以增加对GCP和azure作为商店的支持，签署和验证文件的能力。</p></div></div>    
</body>
</html>