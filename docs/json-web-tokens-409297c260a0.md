# JSON Web 令牌

> 原文：<https://infosecwriteups.com/json-web-tokens-409297c260a0?source=collection_archive---------1----------------------->

作者:[安舒尔·维亚斯](https://www.instagram.com/_ansh_vyas/)

![](img/f9bdf76f3789889cb494d95cf17d2c75.png)

# 介绍

一个名为 JSON Web Token 的开放行业标准用于在两个实体之间交换数据，这两个实体通常是客户端(如应用程序的前端)和服务器(如应用程序的后端)。它们包括 JSON 对象，这些对象包含了需要交流的必要信息。为了确保 JSON 内容(也称为 JWT 声明)不能被客户端或恶意方更改，每个 JWT 都使用加密技术(哈希)进行了额外的签名。

# 代币

您可能会问，为什么认证服务器将数据转换成“令牌”,而不只是作为普通的 JSON 对象发送。如果认证服务器以普通 JSON 格式发送，客户端应用程序的 API 将无法确认他们正在
获取的材料是否准确。例如，应用程序的 API 无法知道恶意攻击者是否更改了用户 ID(上面 JSON 示例中的子声明)。由于这种安全考虑，身份验证服务器必须以客户端应用程序可以验证的方式传递这些数据。这就是“令牌”的概念出现的地方。

简而言之，令牌是包含可以安全检查的数据的字符串。它可能由随机的字母数字字符序列组成，导致数据库中的 ID，也可能是客户端可以自我验证的编码 JSON(称为 jwt)。

# JSON Web 令牌结构

JWT 由三部分组成:

*   **表头:**分为两段-
    1。正在应用的签名方法。
    2。令牌的种类，在本例中通常为“JWT”。
*   **有效负载:**断言在有效负载中。注册声明列表包括“发行人”、“有效期”、“主题”和“aud”(受众)等术语。虽然不是必需的，但是这些声明提供了一组实用的、可互操作的断言。建立定制声明的附加参数，例如雇员角色，也可以包括在有效载荷中。通常，OpenID 连接用户主题是使用主题 claim 创建的。不过，Liberty JVM 服务器可能被设置为使用不同的声明。JWT 的第二个组成部分是有效负载，它已经过 Base64Url 编码。
*   **签名:**由加密技术产生的字符串被称为签名，它可以用来检查 JSON 负载的完整性。

# 如何使用签名来确保身份验证

为了确保认证，我们使用签名:

1.  用户向认证服务器发送登录和密码，该服务器可能是也可能不是我们的应用服务器，但通常是不同的服务器。
2.  身份验证服务器验证输入的用户名和密码，然后生成一个 JWT 令牌，将用户的技术身份和到期时间戳作为有效负载的一部分。
3.  使用秘密密钥，认证服务器在将报头和有效载荷发送回用户的浏览器之前对其进行签名(我们将在后面详细介绍签名是如何工作的)
4.  浏览器获取签名的 JWT，并开始将它与每个 HTTP 请求一起传递给我们的应用服务器。
5.  签名的 JWT 本质上充当临时用户凭证，代替充当永久凭证的用户名和密码。

# 在哪里存储 JSON Web 令牌

我将尝试简单地介绍一下，但是因为我不是安全方面的专家，所以我更愿意让您了解其他外部资源。jwt 是护照，所以要时刻记住这一点。获得用户令牌访问权限的人能够代表您提交请求。情况不妙。本地存储中的令牌存储很常见，因为它很方便。然而，这并不是最安全的做法。它有很高的 XSS 风险(跨站点脚本)。将令牌保存在 HttpOnly cookie 中比保存在标准 cookie 中更好。尽管它更能抵抗 XSS 的攻击，但 CSRF 的攻击仍然是可能的。显然，这可能会给 CORS 政策带来麻烦，但是，嘿，我们正在处理安全问题。

# 如果我想加密我的令牌怎么办？

在某些情况下，您可能希望加密您的令牌，以防止劫持者阅读您的声明。大多数情况下，服务器到服务器的通信使用这种方式。那是完全可以的；只要另一端能够安全地解码和显示令牌，您就可以随意加密您的令牌。无论哪种情况，请记住，使用 HTTPS 进行通信是必需的，并且可以极大地提高通信安全性。

示例:

```
eyJhbGciOiJIUzI1NiJ9.eyJuYW1lIjoiSm9lIENvZGVyIn0.5dlp7GmziL2QS06sZgK4mtaqv0_xX4oFUuTDh1zHK4U
```

我们的各个部分细分如下:

```
eyJhbGciOiJIUzI1NiJ9 # header .
eyJuYW1lIjoiSm9lIENvZGVyIn0 # payload .
5dlp7GmziL2QS06sZgK4mtaqv0_xX4oFUuTDh1zHK4U #signature
```

# JSON Web 令牌是如何工作的？

为了演示 JSON Web Token 如何工作，让我们以用户登录为例。在使用 JWT 之前，您必须定义一个密钥(称为“秘密”)。一旦用户成功提供了他们的登录详细信息，JWT 将与密钥一起返回并保存在本地。为了保证数据的安全，传输应该在 HTTPS 进行。

每当用户试图访问受保护的资源(如 API 或受保护的路由)时，JWT 将作为参数或授权头从用户代理传递。在成功审查之后，通信伙伴可以解密 JSON Web 令牌并执行查询。

# JSON WEB 令牌是用来做什么的？

相对于传统的基于 cookie 的认证和授权方法，jwt 提供了一些好处。这有助于它们在以下情况下被接受:

*   使用 rest 的应用程序:由于身份验证信息随请求一起提供，REST 应用程序确保了无状态协议。
*   源之间的资源共享:jwt 传输数据作为跨源共享资源的一部分。与通常不能作为此过程的一部分交付的 cookies 相比，这提供了显著的好处。
*   在不同的环境中使用:JWT 是标准化的。如果使用许多框架，与身份验证相关的数据可以更容易地交换。

# 创建 JSON Web 令牌的步骤

为了建立 JWT，采取了后续的动作。在流程的输入和输出之间没有关系的情况下，阶段的顺序并不重要。

1.  将所需索赔作为 JWT 索赔集的一部分。应该注意的是，在表示中明确允许空白，并且在编码之前不需要规范化表示。
2.  使 JWT 声明集成为消息八位字节的 UTF-8 表示。
3.  将适当的标题参数设置到 JOSE 标题中。要求 JWT 遵守[JWS]或[JWE]标准。应该注意的是，在表示中明确允许空白，并且在编码之前不需要规范化表示。
4.  根据 JWT 是 JWS 还是 JWE，有两种情况:如果 JWT 是 JWS，则使用消息作为 JWS 有效载荷来创建 JWS；必须遵循[JWS]中关于建造 JWS 的说明。否则，如果 JWT 是一个 JWE，使用消息作为明文创建一个 JWE，确保遵循[JWE]中的所有说明。
5.  如果将执行嵌套签名或加密操作，则返回到步骤 3，在该步骤中产生的新 JOSE 报头中使用“JWT”的" cty "(内容类型)值。让消息成为 JWS 或 JWE。
6.  如果不是，使结果 JWT 成为 JWS 或 JWE。

# 验证 JSON Web 令牌的步骤

这些操作在验证 JWT 时进行。在流程的输入和输出之间没有关系的情况下，阶段的顺序并不重要。如果任何指定的阶段失败，JWT 必须被拒绝，或者被应用程序作为无效输入处理。

1.  请确保至少有一个句点(' . '))JWT 中的人物。
2.  制作第一个句点('.'之前的 JWT 部分)字符编码的 JOSE 头。
3.  Base64url 解码编码的 JOSE 头，同时记住没有使用额外的字符，如空白或换行符。
4.  确认产生的八位字节序列是符合 RFC 7159 [RFC7159]的完全合法的 JSON 对象的 UTF-8 编码表示；JOSE 头应该是这个 JSON 对象。
5.  检查只有其语法和语义得到支持和理解的参数和值，或者在不理解时被指定为被忽略的参数和值，才被包含在最终的 JOSE 头中。
6.  使用[JWE]第 9 节中概述的技术之一来确定 JWT 是 JWS 还是 JWE。
7.  根据 JWT 是 JWS 还是 JWE，有两种情况:
    *如果 JWT 是 JWS，根据【JWS 指令】验证 JWS。让 JWS 有效负载的 base64url 解码产生消息。
    *否则，如果 JWT 是 JWE，继续进行【JWEinstructions】的验证 JWE。让生成的明文成为消息。
8.  如果 JOSE 头中的“cty”(内容类型)值是“JWT”，则消息是经过嵌套签名或加密过程的 JWT。在这种情况下，返回到步骤 1，用消息替换 JWT。
9.  如果没有，base64url 解码消息，同时遵守没有使用额外字符(如空白或换行符)的要求。
10.  确认产生的八位字节序列是完全合法的符合 RFC 7159 [RFC7159]的 JSON 对象的 UTF-8 编码表示；JWT 声明集应该是这个 JSON 对象。
11.  最后，请记住，在特定情况下可能应用的算法的选择取决于应用程序。即使可以正确验证 JWT，应用程序也应该拒绝 JWT，除非应用程序可以接受 JWT 中使用的算法。

# **jwt 的优势**

使用 JWT 有很多好处，包括:

**安全**:由于数字签名使用了秘密密钥(HMAC)或公钥/私钥组合(RSA 或 ECDSA)，jwt 受到保护，不会被客户端或攻击者修改。

**存储在客户端的存储器上**:jwt 在服务器上创建，然后发送到客户端。然后，JWT 由客户端随每个请求一起发送。这减少了数据库空间的使用。

**有效/无状态**:由于 JWT 不需要数据库搜索，因此可以快速验证。特别是在大型分散系统中，这很有帮助。

# **jwt 的缺点**

使用 JWT 一些缺点是:

**不可撤销**:由于 jwt 是独立的，并且使用无状态技术进行验证，因此在它自然过期之前取消它可能会很困难。因此，很难执行像立即禁止用户这样的措施。话虽如此，有一种技术可以让 JWT 拒绝/黑名单保持最新，通过这样做，我们可以立即撤销它们。

**依赖单个密钥**:构造一个 JWT 需要一个密钥。攻击者可以创建他们自己的 jwt，如果密钥泄露，API 层将接受这些 jwt。这表明如果密钥泄露，攻击者可以冒充任何用户的身份。通过定期更换密钥，我们可以降低这种危险。

# **结论**

JWT 比其他 web 令牌简单得多，因为它基于 JSON，比 XML 更容易掌握。其他 web 令牌包括简单 Web 令牌(swt)和安全声明标记语言(SAML)。如果我们对 JSON 进行加密，它的大小甚至会比 SAML 更小，这使得它更容易在 HTML 和 HTTP 上下文中传递。swt 使用单个密钥来保证安全，但是 JWT 和 SAML 都使用公钥和私钥对来进行更强的认证。说到使用，jwt 在互联网上盛行。换句话说，无论是笔记本电脑还是智能手机，在用户的设备上处理都更简单。

除了身份验证之外，JSON Web 令牌是在多方之间传输数据的一种奇妙而安全的方法。每个人都可以更容易地识别信息的发送者，因为 jwt 包含签名。你只需要一把正确的钥匙。

## 来自 Infosec 的报道:Infosec 每天都有很多内容，很难跟上。[加入我们的每周简讯](https://weekly.infosecwriteups.com/)以 5 篇文章、4 条线索、3 个视频、2 个 GitHub Repos 和工具以及 1 个工作提醒的形式免费获取所有最新的 Infosec 趋势！