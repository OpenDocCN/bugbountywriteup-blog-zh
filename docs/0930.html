<html>
<head>
<title>Setting up a WireGuard VPN Server Architecture for Internal Network Access</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为内部网络访问设置WireGuard VPN服务器架构</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/setting-up-a-wireguard-vpn-server-architecture-for-internal-network-access-2adcdc79e8e1?source=collection_archive---------0-----------------------#2020-11-05">https://infosecwriteups.com/setting-up-a-wireguard-vpn-server-architecture-for-internal-network-access-2adcdc79e8e1?source=collection_archive---------0-----------------------#2020-11-05</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="fec3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi ko translated">利用云命令和控制(C2)服务器以及各种端点配置，您可以轻松设置完整的WireGuard网络，允许直接访问私有内部网络，甚至通过一个IP路由所有流量，以便于审计。这个博客和项目诞生于渗透测试的需要，但是这个概念可以很容易地应用于其他地方的家庭和企业。</p></div><div class="ab cl kx ky hx kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="im in io ip iq"><p id="675d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我最近的工作挑战之一是创建一种方法，允许内部渗透测试人员安全地访问公司的现场内部网络。我提出的解决方案需要满足三个主要标准:</p><p id="0ae7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">1.易于扩展、可公开访问并由我们安全拥有。</p><p id="666f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">2.对于外部测试，所有内部渗透测试人员都应该来自同一个公共IP，这样客户就可以跟踪进入的请求并轻松审计连接。</p><p id="43cc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">3.内部测试人员需要能够直接连接并看到内部网络，客户端之间需要的配置最少(如果有的话)。</p><p id="b4e8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了满足这些标准，我决定将WireGuard与Azure结合用于公共命令和控制(C2)服务器，并将预配置的OVA、Raspberry Pis甚至Azure站点到站点VPN结合用于客户端访问。WireGuard和Azure C2允许创建一个私有VPN，我可以轻松地添加任何新的测试人员，来自外部机器的出站流量将通过Azure C2发送，作为一个公共IP输出。最后，由于VPN将我们测试人员的机器和C2服务器连接在一起，任何其他连接到C2的子网或网络，无论是通过站点到站点还是通过Raspberry Pi或OVA拨出，测试人员都可以访问，就像他们就在网络上一样。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div class="gh gi le"><img src="../Images/88581ae2301025cb8511fa8438d15047.png" data-original-src="https://miro.medium.com/v2/resize:fit:1246/format:webp/1*QH_WnEehHrUmxgIix97W_w.png"/></div><figcaption class="lm ln gj gh gi lo lp bd b be z dk translated">WireGuard VPN的基本网络图</figcaption></figure></div><div class="ab cl kx ky hx kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="im in io ip iq"><h2 id="f25c" class="lq lr it bd ls lt lu dn lv lw lx dp ly kb lz ma mb kf mc md me kj mf mg mh mi bi translated">为什么是Azure？</h2><p id="a53a" class="pw-post-body-paragraph jq jr it js b jt mj jv jw jx mk jz ka kb ml kd ke kf mm kh ki kj mn kl km kn im bi translated">实际上，你为C2服务器使用哪家提供商并不重要，只要它有一个可公开访问的IP地址和正确的规模和带宽来支持VPN网络。此外，操作系统并不重要，尽管我强烈建议使用Linux，因为大多数定制规则都使用/bin/ip或iptables。我选择实际使用Kali Linux，以防测试人员由于他们自己的客户端的网络问题而想要通过该机器运行漏洞。</p><h2 id="332a" class="lq lr it bd ls lt lu dn lv lw lx dp ly kb lz ma mb kf mc md me kj mf mg mh mi bi translated">什么是WireGuard，我们为什么要使用它？</h2><p id="5bc5" class="pw-post-body-paragraph jq jr it js b jt mj jv jw jx mk jz ka kb ml kd ke kf mm kh ki kj mn kl km kn im bi translated">来自<a class="ae mo" href="https://www.csoonline.com/author/Lucian-Constantin/" rel="noopener ugc nofollow" target="_blank">卢西恩·康斯坦丁</a>在他的文章<a class="ae mo" href="https://www.csoonline.com/article/3434788/what-is-wireguard-secure-simple-vpn-still-in-development.html" rel="noopener ugc nofollow" target="_blank">这里</a>:</p><blockquote class="mp mq mr"><p id="e5cc" class="jq jr ms js b jt ju jv jw jx jy jz ka mt kc kd ke mu kg kh ki mv kk kl km kn im bi translated">WireGuard是以安全为中心的虚拟专用网络(VPN ),以其简单易用而闻名。它使用成熟的加密协议和算法来保护数据。最初是为Linux内核开发的，现在可以部署在Windows、macOS、BSD、iOS和Android上。</p></blockquote><p id="4a2e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在使用WireGuard和OpenVPN用户等其他解决方案之间存在持续的争论，没有明确的答案。每个人都把自己的优势带到了这个领域。特别是对于这个项目，由于服务器和客户端都将基于Linux，并且总的来说连接速度是一个重要因素，我们选择了WireGuard，它是为Linux内核的速度和性能而设计的。OpenVPN的主要好处是支持多种密码和算法的能力，这与我们的用途无关。这里有一篇关于WireGuard好处的有趣文章。</p><h1 id="776d" class="mw lr it bd ls mx my mz lv na nb nc ly nd ne nf mb ng nh ni me nj nk nl mh nm bi translated">网络设置概述</h1><p id="459a" class="pw-post-body-paragraph jq jr it js b jt mj jv jw jx mk jz ka kb ml kd ke kf mm kh ki kj mn kl km kn im bi translated">对于此网络设置，将有3种主要的WireGuard配置:</p><p id="c22b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">1.C2服务器，处理客户端之间的翻译连接，并作为测试人员公共互联网接入的中央NAT。</p><p id="883d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">2.面向客户端的连接，连接回C2，并通过VPN将流量转发到它们所连接的内部网络。我创建了一个OVA虚拟机映像和一个RPi配置，它会在启动时自动连接回C2，这将绕过任何NAT问题。</p><p id="9f51" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">3.测试者的连接，简单地直接连接到C2，并通过接口路由所有流量，让C2最终处理路由。</p></div><div class="ab cl kx ky hx kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="im in io ip iq"><h1 id="a68b" class="mw lr it bd ls mx nn mz lv na no nc ly nd np nf mb ng nq ni me nj nr nl mh nm bi translated">电线保护装置</h1><p id="fc64" class="pw-post-body-paragraph jq jr it js b jt mj jv jw jx mk jz ka kb ml kd ke kf mm kh ki kj mn kl km kn im bi translated">对于Kali，WireGuard在大多数情况下已经安装，但如果不是一个简单的“apt install wireguard”将安装它。您可能需要重新启动系统。对于其他系统，请参考具体的安装说明<a class="ae mo" href="https://www.wireguard.com/install/" rel="noopener ugc nofollow" target="_blank">此处</a>。</p><h1 id="c202" class="mw lr it bd ls mx my mz lv na nb nc ly nd ne nf mb ng nh ni me nj nk nl mh nm bi translated">电线保护配置</h1><p id="46fc" class="pw-post-body-paragraph jq jr it js b jt mj jv jw jx mk jz ka kb ml kd ke kf mm kh ki kj mn kl km kn im bi translated">与OpenVPN等其他VPN不同，没有特定的服务器应用程序启动，WireGuard直接连接点对点。要创建服务器-客户端关系，只需配置一个特定的客户端，在接受入站通信的同时将通信路由到其他客户端。此外，WireGuard通过为您自己创建的每个客户端创建和使用一组私有/公共密钥来工作。一旦您创建了一组密钥，公钥就被放置在“服务器”的配置中，这允许它对出站流量进行加密。同时，“客户端”配置包含私钥，用于解密入站流量。</p><p id="eb8c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">基本上，如果您想要将数据发送到端点，您只需要用该端点的公钥创建一个对等体(一旦您看到一些配置，这将更有意义)。WireGuard配置文件作为. conf文件放在/etc/wireguard中。无论您将该文件命名为什么，它都将反映为接口名称，对于我的设置，我使用wg0作为服务器接口，使用wg0-client作为客户端的配置。</p><h2 id="fe3d" class="lq lr it bd ls lt lu dn lv lw lx dp ly kb lz ma mb kf mc md me kj mf mg mh mi bi translated">密钥创建</h2><p id="6a0f" class="pw-post-body-paragraph jq jr it js b jt mj jv jw jx mk jz ka kb ml kd ke kf mm kh ki kj mn kl km kn im bi translated">创建WireGuard密钥对非常简单，在Linux上，私钥是用<code class="fe ns nt nu nv b">wg genkey</code>创建的，公钥是用<code class="fe ns nt nu nv b">wg pubkey</code>创建的，私钥是通过管道输入的。为了使它更容易和更可重复，我已经包含了一个小的shell脚本，您可以用<code class="fe ns nt nu nv b">./create-key.sh &lt;name of key&gt;</code>运行它，它将创建并保存具有正确名称的私有和公共密钥对。</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="nw nx l"/></div><figcaption class="lm ln gj gh gi lo lp bd b be z dk translated">创建_密钥. sh</figcaption></figure><h2 id="88ca" class="lq lr it bd ls lt lu dn lv lw lx dp ly kb lz ma mb kf mc md me kj mf mg mh mi bi translated">服务器配置</h2><p id="01c4" class="pw-post-body-paragraph jq jr it js b jt mj jv jw jx mk jz ka kb ml kd ke kf mm kh ki kj mn kl km kn im bi translated">这是整体的服务器配置，我们将在下面一点一点地分解。为了不发布我自己的配置，私有和公共密钥值将被删除，您只需用您自己的值填充它。请记住，公钥是对等方的值，而不是主机的值。</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="nw nx l"/></div><figcaption class="lm ln gj gh gi lo lp bd b be z dk translated">C2服务器WireGuard配置</figcaption></figure><p id="f3e5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">所有WireGuard配置都以[Interface]开始，这是您在网络中插入客户端私钥和IP的位置。在本例中是10.10.20.1，如初始图表所示，密钥是使用前面显示的shell脚本创建的。ListenPort就是您希望为入站连接打开的UDP端口，默认端口为51820。</p><p id="80ca" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">PostUp用于在接口启动时运行命令，PostDown用于在接口停止时运行命令。在这种情况下，这些值是从这里的<a class="ae mo" href="https://gist.github.com/nealfennimore/92d571db63404e7ddfba660646ceaf0d" rel="noopener ugc nofollow" target="_blank">复制过来的</a>，用于将通过VPN接口进入的所有流量路由回eth0接口。换句话说，这些线路告诉WireGuard客户端充当所有定向到公共互联网的传入VPN流量的NAT网关。如果您有不同的公共互联网接口，请确保调整eth0值。</p><p id="9a14" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">每个[Peer]值代表一个新的VPN连接点。对于这些值，PublicKey是与客户机的[Interface]部分中的任何私钥相匹配的公钥。AllowedIPs充当每个客户端的路由表和安全组。基本上，放置在C2服务器上的任何值都会将入站流量路由到这些IP。请注意，对于10.10.20.10对等体，原始网络图中显示的内部IP范围是如何添加到允许的IP中的。这让C2知道，这些范围内的任何传入流量都必须发送到该对等方。正是这种设置允许我们的测试客户端直接连接到内部网络(在端点上还需要额外的设置)。</p><blockquote class="mp mq mr"><p id="cb38" class="jq jr ms js b jt ju jv jw jx jy jz ka mt kc kd ke mu kg kh ki mv kk kl km kn im bi translated"><strong class="js iu">重要！</strong></p><p id="e481" class="jq jr ms js b jt ju jv jw jx jy jz ka mt kc kd ke mu kg kh ki mv kk kl km kn im bi translated">为此，您必须在C2主机、客户端端点和测试者端点上配置IPv4转发。为此:</p><p id="ec2c" class="jq jr ms js b jt ju jv jw jx jy jz ka mt kc kd ke mu kg kh ki mv kk kl km kn im bi translated">#通过将下面的内容添加到/etc/sysctl.conf，确保允许转发</p><p id="9872" class="jq jr ms js b jt ju jv jw jx jy jz ka mt kc kd ke mu kg kh ki mv kk kl km kn im bi translated">net.ipv4.ip_forward=1</p><p id="35b2" class="jq jr ms js b jt ju jv jw jx jy jz ka mt kc kd ke mu kg kh ki mv kk kl km kn im bi translated">或者运行<code class="fe ns nt nu nv b">sudo sysctl net.ipv4.ip_forward=1</code></p></blockquote><p id="da77" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">要启动C2 WireGuard，以root用户身份或使用sudo运行命令<code class="fe ns nt nu nv b">wg-quick up wg0</code>。现在，您应该看到wg与ifconfig的接口。要让界面在启动时运行，只需运行<code class="fe ns nt nu nv b">sudo systemctl enable wg-quick@wg0</code></p><blockquote class="mp mq mr"><p id="4bbd" class="jq jr ms js b jt ju jv jw jx jy jz ka mt kc kd ke mu kg kh ki mv kk kl km kn im bi translated">用您命名的配置文件替换wg0(不带。会议)</p></blockquote><h2 id="58f1" class="lq lr it bd ls lt lu dn lv lw lx dp ly kb lz ma mb kf mc md me kj mf mg mh mi bi translated">面向客户端的端点配置</h2><p id="9650" class="pw-post-body-paragraph jq jr it js b jt mj jv jw jx mk jz ka kb ml kd ke kf mm kh ki kj mn kl km kn im bi translated">现在C2已经设置好了，我们需要配置一个端点来连接并允许访问客户的内部网络。我用这种配置设置了VM OVA映像和硬件Raspberry Pi，以便用最简单的方法访问客户端网络。</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="nw nx l"/></div><figcaption class="lm ln gj gh gi lo lp bd b be z dk translated">客户端端点WireGuard配置</figcaption></figure><p id="940e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">[接口]和PostUp/PostDown与C2设置基本相同，只是调整了地址和私有密钥。然而，与C2不同的是，只有一个对等体(实际上是C2 ),并且它有更多的选择。具体来说，端点值是实际连接两个客户端的东西。由于RPi可能位于NAT之后，或者无法通过直接互联网访问，因此我们没有向C2添加端点值，而是让端点连接到C2公共IP或DNS。为外面所有的黑客设想一个反向外壳。为了确保这个连接保持活动，我们添加了PersistentKeepalive选项，它每隔x秒维护一次连接。此外，请注意，我们允许来自整个WireGuard 10.10.20.0/24网络的连接，而不仅仅是特定的/32地址。</p><p id="b1ac" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">记住启用ipv4转发，并启用wg服务进行启动。</p><h2 id="783b" class="lq lr it bd ls lt lu dn lv lw lx dp ly kb lz ma mb kf mc md me kj mf mg mh mi bi translated">笔测试仪的配置</h2><p id="e33b" class="pw-post-body-paragraph jq jr it js b jt mj jv jw jx mk jz ka kb ml kd ke kf mm kh ki kj mn kl km kn im bi translated">对于Pen Tester配置，我们需要设置一些PostUp/PostDown ip路由规则来创建到C2的静态路由，以便当我们通过接口发送所有流量时，它不会尝试发送C2流量，而是基本上自行循环。您需要调整规则以匹配您的默认网关IP。</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="nw nx l"/></div></figure><p id="02e4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">注意，像客户端设置一样，我们连接回C2并保持连接活动。唯一的大区别是，我们在AllowedIPs中添加了0.0.0.0/0，它基本上通知WireGuard接口通过该接口转发所有流量，并让C2服务器处理发送到internet的流量。此外，我们还创建了一条通过普通互联网接口到达C2的静态路由，这样C2流量就不会试图通过该接口发送出去并自行循环。</p><p id="1469" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">同样，您必须确保启用了IP转发，这样才能正常工作。如果一切按预期运行，您应该会看到您的公共ip更改为C2公共IP。此外，您应该能够ping通WireGuard内部网络并与之对话。</p><h1 id="de1c" class="mw lr it bd ls mx my mz lv na nb nc ly nd ne nf mb ng nh ni me nj nk nl mh nm bi translated">示例时间！</h1><p id="b9de" class="pw-post-body-paragraph jq jr it js b jt mj jv jw jx mk jz ka kb ml kd ke kf mm kh ki kj mn kl km kn im bi translated">为了弄清楚这种设置的实际用途，让我们看一个小例子。我是一个笔测试员，在我的本地网络上有一个Kali VM。我用IP为10.10.20.2的WireGuard客户端配置了这个虚拟机，连接到我之前设置的Azure C2 Kali服务器，并允许通过安全组进行访问。我需要测试一个客户的内部网络，该网络在NAT后有几台机器。客户端不拥有出站防火墙，因此他们不能设置站点到站点VPN，但是他们可以确认连接上没有出站过滤。我向他们发送了一个带有预配置虚拟机的OVA，该虚拟机作为10.10.20.10连接回C2。</p><p id="1eab" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">(假设以下步骤是在发货前设置网络和虚拟机。)</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div class="gh gi le"><img src="../Images/46324f022dac973bff3558d54d09c0cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1246/format:webp/1*mMhjcITjHYA42usKGkDDBA.png"/></div><figcaption class="lm ln gj gh gi lo lp bd b be z dk translated">示例网络图</figcaption></figure><ol class=""><li id="03a8" class="ny nz it js b jt ju jx jy kb oa kf ob kj oc kn od oe of og bi translated">设置VPN C2、客户端和测试仪密钥。</li></ol><figure class="lf lg lh li gt lj gh gi paragraph-image"><div class="gh gi oh"><img src="../Images/8ebfaf5202d0a494a64051e49f53684d.png" data-original-src="https://miro.medium.com/v2/resize:fit:970/format:webp/1*PNLNyFNHU3jX3vaVxMM_oQ.png"/></div></figure><figure class="lf lg lh li gt lj gh gi paragraph-image"><div class="gh gi oi"><img src="../Images/31788ee6b0b42b655ffe3c5e29e4bda2.png" data-original-src="https://miro.medium.com/v2/resize:fit:974/format:webp/1*dtT5aHk4l4IV78D7YLg61Q.png"/></div></figure><p id="2671" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">2.配置C2 VPN配置(/etc/wireguard/ex.conf)。</p><pre class="lf lg lh li gt oj nv ok ol aw om bi"><span id="d18c" class="lq lr it nv b gy on oo l op oq">[Interface]<br/>Address = 10.10.20.1<br/>PrivateKey = GFYJl5xBIhQqeedYGckNaFBIS+n9+5hWEwWeQM5Iyks=<br/>ListenPort = 51820</span><span id="d181" class="lq lr it nv b gy or oo l op oq">[Peer]<br/>AllowedIPs = 10.10.20.2<br/>PublicKey = 5OeEHFIejwuEHoQUx/CeuT35IF5aWkvbjPUWPRCEfhE=</span><span id="0221" class="lq lr it nv b gy or oo l op oq">[Peer]<br/>AllowedIPs = 10.10.20.10<br/>PublicKey = AgYvXOVn+6ED/ylxhIfMjlhgW4/CPvWfFCb3PzmS3mc</span></pre><p id="7afa" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">3.旋转C2虚拟专用网。</p><p id="db04" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe ns nt nu nv b">wg-quick up ex</code></p><p id="261b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">4.在远程端点上安装客户端配置(/etc/wireguard/ex-client.conf)。</p><pre class="lf lg lh li gt oj nv ok ol aw om bi"><span id="a022" class="lq lr it nv b gy on oo l op oq">[Interface]<br/>Address = 10.10.20.10<br/>PrivateKey = ILaVhY6259CoqUY6/dMnjKZsIel578cF+ssqKC+wrXY=</span><span id="c68a" class="lq lr it nv b gy or oo l op oq">[Peer]<br/>PublicKey = Q5+LvmPu8a76oKnKOnxGfbWzKZ7WhxxP4YNKy6LgJ0k=<br/>Endpoint = &lt;C2 Public IP&gt;:51820<br/>AllowedIPs = 10.10.20.0/24<br/>PersistentKeepalive = 25</span></pre><p id="3e89" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">5.启动客户端虚拟机，并设置为在启动时启动。</p><p id="5fce" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe ns nt nu nv b">wg-quick up ex-client</code></p><p id="0dac" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe ns nt nu nv b">sudo systemctl <strong class="js iu">enable</strong> wg-quick@ex-client</code></p><p id="86a2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">6.检查连接。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div class="gh gi os"><img src="../Images/d6d2f93a954d2bfcac2cdf8827b7e72c.png" data-original-src="https://miro.medium.com/v2/resize:fit:916/format:webp/1*senlerbI8y2mpEIsXe2zNw.png"/></div></figure><p id="28fb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">7.在测试者端点上设置连接(/etc/wireguard/ex-client.conf)。</p><pre class="lf lg lh li gt oj nv ok ol aw om bi"><span id="8f9f" class="lq lr it nv b gy on oo l op oq">[Interface]<br/>Address = 10.10.20.2<br/>PrivateKey = yJAl7s7xoRpYZI6B/bAdCX/Ccj1oleUD5gEjDOfv+nm=</span><span id="36b0" class="lq lr it nv b gy or oo l op oq">[Peer]<br/>PublicKey = Q5+LvmPu8a76oKnKOnxGfbWzKZ7WhxxP4YNKy6LgJ0k=<br/>Endpoint = &lt;C2 Public IP&gt;:51820<br/>AllowedIPs = 10.10.20.0/24<br/>PersistentKeepalive = 25</span></pre><p id="d734" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">8.测试C2和测试仪之间的连接。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div class="gh gi os"><img src="../Images/031bba6f1d888f562ceae14b7d9569e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:916/format:webp/1*SrzzCyA7Dpa-y1JYEOUIgQ.png"/></div></figure><figure class="lf lg lh li gt lj gh gi paragraph-image"><div class="gh gi os"><img src="../Images/59faa3d308ec125b42e2d45bd650e156.png" data-original-src="https://miro.medium.com/v2/resize:fit:916/format:webp/1*Hf3RiAgmJaIFSF17FQNUhg.png"/></div></figure><p id="674f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">9.通过C2从测试仪-&gt;客户端测试连接。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="ou ov di ow bf ox"><div class="gh gi ot"><img src="../Images/0033c4da5124b2800e337a262c2b3462.png" data-original-src="https://miro.medium.com/v2/resize:fit:918/format:webp/1*APStmRsqeGJWi4-alVrYtA.png"/></div></div></figure><p id="0acb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">10.现在有趣的部分来了，让我们调整服务器以路由到客户端端点上的内部网络，这样我们就可以通过这个连接做一些事情了。</p><pre class="lf lg lh li gt oj nv ok ol aw om bi"><span id="4a83" class="lq lr it nv b gy on oo l op oq">[Interface]<br/>Address = 10.10.20.1<br/>PrivateKey = GFYJl5xBIhQqeedYGckNaFBIS+n9+5hWEwWeQM5Iyks=<br/>ListenPort = 51820</span><span id="d43f" class="lq lr it nv b gy or oo l op oq">[Peer]<br/>AllowedIPs = 10.10.20.2<br/>PublicKey = 5OeEHFIejwuEHoQUx/CeuT35IF5aWkvbjPUWPRCEfhE=</span><span id="6b31" class="lq lr it nv b gy or oo l op oq">[Peer]<br/>AllowedIPs = 10.10.20.10, <strong class="nv iu">192.168.1.0/24</strong><br/>PublicKey = AgYvXOVn+6ED/ylxhIfMjlhgW4/CPvWfFCb3PzmS3mc=</span></pre><p id="49a7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">11.并调整客户端配置以添加PostUp规则，从而将流量转发到内部端点。</p><pre class="lf lg lh li gt oj nv ok ol aw om bi"><span id="9cea" class="lq lr it nv b gy on oo l op oq">[Interface]<br/>Address = 10.10.20.10<br/>PrivateKey = ILaVhY6259CoqUY6/dMnjKZsIel578cF+ssqKC+wrXY=</span><span id="e339" class="lq lr it nv b gy or oo l op oq"><strong class="nv iu">PostUp = iptables -A FORWARD -i %i -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE<br/>PostDown = iptables -D FORWARD -i %i -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE</strong></span><span id="0329" class="lq lr it nv b gy or oo l op oq">[Peer]<br/>PublicKey = Q5+LvmPu8a76oKnKOnxGfbWzKZ7WhxxP4YNKy6LgJ0k=<br/>Endpoint = &lt;C2 Public IP&gt;:51820<br/>AllowedIPs = 10.10.20.0/24<br/>PersistentKeepalive = 25</span></pre><p id="e839" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">12.最后，调整测试仪以正确布线。</p><pre class="lf lg lh li gt oj nv ok ol aw om bi"><span id="d757" class="lq lr it nv b gy on oo l op oq">[Interface]<br/>Address = 10.10.20.2<br/>PrivateKey = yJAl7s7xoRpYZI6B/bAdCX/Ccj1oleUD5gEjDOfv+nm=</span><span id="c103" class="lq lr it nv b gy or oo l op oq">[Peer]<br/>PublicKey = Q5+LvmPu8a76oKnKOnxGfbWzKZ7WhxxP4YNKy6LgJ0k=<br/>Endpoint = &lt;C2 Public IP&gt;:51820<br/>AllowedIPs = 10.10.20.0/24,<strong class="nv iu"> 192.168.1.0/24</strong><br/>PersistentKeepalive = 25</span></pre><p id="ff48" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">13.检查连接。</p><p id="e18d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">来自C2:</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div class="gh gi oy"><img src="../Images/3475665eca03017531cdd4ce755c9504.png" data-original-src="https://miro.medium.com/v2/resize:fit:946/format:webp/1*5oXrS9nBFskLQzzvtiT3Bw.png"/></div></figure><p id="40b3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">来自测试仪:</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div class="gh gi oy"><img src="../Images/3475665eca03017531cdd4ce755c9504.png" data-original-src="https://miro.medium.com/v2/resize:fit:946/format:webp/1*5oXrS9nBFskLQzzvtiT3Bw.png"/></div></figure><p id="f2fe" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您可以看到数据包通过C2和客户端端点进行路由，对我的测试人员来说，这是一种无缝体验。</p><p id="bf01" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">14.作为我的测试人员，我现在可以完全访问内部192.168.1.0/24网络，就好像我就在网络上一样！</p></div><div class="ab cl kx ky hx kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="im in io ip iq"><p id="e2b3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">好处:配置测试仪和C2配置，通过C2路由所有流量，有一个公共ip！这也减少了测试人员所需的配置，因为他们不必在添加或删除新客户端时调整配置。</p><p id="fc27" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">1.您需要在C2服务器配置中添加以下几行:</p><pre class="lf lg lh li gt oj nv ok ol aw om bi"><span id="25a0" class="lq lr it nv b gy on oo l op oq">[Interface]<br/>Address = 10.10.20.1<br/>PrivateKey = GFYJl5xBIhQqeedYGckNaFBIS+n9+5hWEwWeQM5Iyks=<br/>ListenPort = 51820</span><span id="fe9c" class="lq lr it nv b gy or oo l op oq"><strong class="nv iu">PostUp = iptables -A FORWARD -i %i -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE # Add forwarding when VPN is started                                                                                                                                                   PostDown = iptables -D FORWARD -i %i -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE # Remove forwarding when VPN is shutdown</strong></span><span id="f783" class="lq lr it nv b gy or oo l op oq">[Peer]<br/>AllowedIPs = 10.10.20.2<br/>PublicKey = 5OeEHFIejwuEHoQUx/CeuT35IF5aWkvbjPUWPRCEfhE=</span><span id="e4b6" class="lq lr it nv b gy or oo l op oq">[Peer]<br/>AllowedIPs = 10.10.20.10<br/>PublicKey = AgYvXOVn+6ED/ylxhIfMjlhgW4/CPvWfFCb3PzmS3mc[Interface]                                                                                                                                                                                       </span></pre><p id="1c25" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这(像客户端端点一样)将C2变成了WireGuard接口上入站流量的NAT网关。如果您有不同的互联网网关，请确保调整eth0</p><p id="bbd1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">2.对于tester客户端，您需要添加这些行，并将0.0.0.0/0添加到AllowedIPs</p><pre class="lf lg lh li gt oj nv ok ol aw om bi"><span id="824b" class="lq lr it nv b gy on oo l op oq">[Interface]<br/>Address = 10.10.20.2<br/>PrivateKey = yJAl7s7xoRpYZI6B/bAdCX/Ccj1oleUD5gEjDOfv+nm=</span><span id="d23c" class="lq lr it nv b gy or oo l op oq"><strong class="nv iu">PostUp = /bin/ip route add &lt;C2 Public IP&gt; via &lt;Default gateway ip&gt;                       PostDown = /bin/ip route del &lt;C2 Public IP&gt; via &lt;Default gateway ip&gt;</strong></span><span id="555f" class="lq lr it nv b gy or oo l op oq">[Peer]<br/>PublicKey = Q5+LvmPu8a76oKnKOnxGfbWzKZ7WhxxP4YNKy6LgJ0k=<br/>Endpoint = &lt;C2 Public IP&gt;:51820<br/>AllowedIPs = <strong class="nv iu">10.10.20.0/24, 10.10.20.1/32, 0.0.0.0/0</strong><br/>PersistentKeepalive = 25</span></pre><p id="29aa" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">PostUp确保发送到C2的请求是通过正常的internet网关发送的，而不是试图通过WG接口发送，那样会中断。</p><blockquote class="mp mq mr"><p id="b74d" class="jq jr ms js b jt ju jv jw jx jy jz ka mt kc kd ke mu kg kh ki mv kk kl km kn im bi translated">边注:确保您有10.10.20.1/32或任何您的C2内部IP作为一个特定的允许的IP除了正常的WireGuard CIDR范围，不知道为什么，但这个设置不会工作，除非您指定。</p></blockquote><p id="133c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">3.通过卷曲检查更改<a class="ae mo" href="https://ifconfig.me" rel="noopener ugc nofollow" target="_blank"> https://ifconfig.me </a></p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div class="gh gi oz"><img src="../Images/3947b88b7efabf75da803b6a2b105113.png" data-original-src="https://miro.medium.com/v2/resize:fit:894/format:webp/1*QgHbLZxGOr96IjHWgj5h-A.png"/></div></figure><p id="8ba0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">4.现在，您的所有公共互联网连接都显示为C2公共IP地址外，因为它对您来说就像一个NAT网关。此外，由于您通过WireGuard接口路由所有流量，并让C2处理路由，因此您不必在客户端指定要路由到的内部网络，而只需在服务器端设置即可。</p><p id="ba84" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">显然，这个设置可以建立和改进，但我发现它是可靠的，易于使用和维护，并强烈推荐它的使用！</p></div></div>    
</body>
</html>