<html>
<head>
<title>BAT Downloader to Keylogger Technical Analysis — Part 1</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">键盘记录器技术分析的BAT下载器—第1部分</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/bat-downloader-to-keylogger-technical-analysis-part-1-49e68bc6eb04?source=collection_archive---------3-----------------------#2020-10-04">https://infosecwriteups.com/bat-downloader-to-keylogger-technical-analysis-part-1-49e68bc6eb04?source=collection_archive---------3-----------------------#2020-10-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="fb26" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最近，我遇到了一个有趣的恶意软件，它使用多种技术来混淆文件并将其放入磁盘。我认为对样本做一个快速的记录/分析并讨论一些使用的技术会很有趣。</p><p id="0609" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我将把这一分析分成两部分，第一部分我们将讨论最初的攻击媒介，以及恶意软件是如何安装和混淆自身到机器中的。第二个将关注恶意软件在其第二阶段丢弃的两个PowerShell脚本。</p><p id="187b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有兴趣的人可以看看下面的例子:</p><pre class="kl km kn ko gt kp kq kr ks aw kt bi"><span id="fd96" class="ku kv iq kq b gy kw kx l ky kz"><strong class="kq ir">MD5: 5f7ad1a818d95f29d7c449270d06ff8a<br/>SHA-1: 2b382662621a82103424437e8c1c4fc217eedc48<br/>SHA-256: dd03221a35480c483c86195956ebb5d094c3e875c5f18f2d6e95a7dc32db78a9</strong></span></pre><p id="dfe7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">目前，样品在VT中只有<strong class="jp ir"> 8/60 </strong>检测</p><figure class="kl km kn ko gt lb gh gi paragraph-image"><div class="gh gi la"><img src="../Images/b0b64eae096c3fdd8d8f6b5be7dddc2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1210/format:webp/1*xxyggC_uDrrFHEoJXtCGWA.png"/></div></figure><h1 id="55a3" class="le kv iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated"><strong class="ak">开头</strong></h1><p id="1908" class="pw-post-body-paragraph jn jo iq jp b jq mb js jt ju mc jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">恶意软件是通过Dropbox链接传播的。下载完成后，我们会得到一个名为<strong class="jp ir">的压缩文件。PDF。ZIP" </strong>。</p><p id="2301" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">zip文件使用双扩展名来欺骗用户，使其认为这是一个PDF文件。这是windows恶意软件的常见技术，因为默认情况下，显示文件扩展名的选项是禁用的。</p><p id="05f8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">zip文件包含一个带有“.”的文件。蝙蝠”分机。bat文件再次使用了双扩展名技术来欺骗用户，让他们以为这是一个PDF文件。</p><figure class="kl km kn ko gt lb gh gi paragraph-image"><div class="gh gi la"><img src="../Images/3944f410c083038638a515174c40c5e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1210/format:webp/1*fW0FA_LH3dS296o28qxkJw.png"/></div></figure><p id="b7f6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们把bat文件解压一下，看看里面的代码。</p><figure class="kl km kn ko gt lb gh gi paragraph-image"><div class="gh gi mg"><img src="../Images/54e00d833d98d06d5ff9e64575ed7394.png" data-original-src="https://miro.medium.com/v2/resize:fit:1208/format:webp/1*pWmCIrLRBgRup7eBcwQPwQ.png"/></div></figure><p id="7166" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如你所看到的，这个文件似乎在某种形式上被混淆了，所有的东西都是用中文写的。但是如果我们用命令行工具如“file”来看一下文件的编码，我们会看到它是用“UTF-16 LE”编码的。</p><p id="80f6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">例如，在VSCode中，我们可以选择用不同的编码重新打开文件。我们会选择“UTF八号”，瞧。恶意bat文件的内容现在是可读的。</p><figure class="kl km kn ko gt lb gh gi paragraph-image"><div class="gh gi mg"><img src="../Images/ec96a022d5a3abf1c42de45b593a26ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1208/format:webp/1*UVCXjzLv4Mt2ecuzo-_vZw.png"/></div></figure><p id="d261" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们开始分析。</p><h2 id="b290" class="ku kv iq bd lf mh mi dn lj mj mk dp ln jy ml mm lr kc mn mo lv kg mp mq lz mr bi translated"><strong class="ak">“CV _ YASMINA。PDF。BAT”分析</strong></h2><p id="070a" class="pw-post-body-paragraph jn jo iq jp b jq mb js jt ju mc jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">bat文件做了一些事情来欺骗用户并下载它的下一阶段。让我们来看看所使用的技术。</p><figure class="kl km kn ko gt lb gh gi paragraph-image"><div class="gh gi la"><img src="../Images/650213d55c1e4159ba6ad2d8006a7229.png" data-original-src="https://miro.medium.com/v2/resize:fit:1210/format:webp/1*hIavRiCh3ht8UuQsybzadg.png"/></div></figure><p id="6e51" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，恶意软件调用“Shows Desktop.lnk”文件，该文件用于最小化所有窗口并显示桌面。和按“Ctrl+M”键盘快捷键是一样的。</p><p id="34c0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后它调用“mshta”实用程序弹出一条用法语写的错误消息，翻译成<strong class="jp ir">“无法读取文件。文件类型可能不受支持，文件扩展名不正确，或者文件可能已损坏。欺骗用户，使其认为某个东西已经失败。(下面是错误信息)。</strong></p><figure class="kl km kn ko gt lb gh gi paragraph-image"><div class="gh gi ms"><img src="../Images/6ffb60d7ce549a25cc9b872296c30de3.png" data-original-src="https://miro.medium.com/v2/resize:fit:986/format:webp/1*GLCoA3aJTKvXjc1LmfyJ4g.png"/></div></figure><p id="56c0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来是第二阶段下载器部分。该文件检查机器是否在%temp%目录中不包含“test.bat”实例。如果没有，它继续创建从字母“a”到“j”的多个变量，每个变量保存完整命令的一小部分，用于下载第二阶段。所有这些都是用来躲避检测的。</p><figure class="kl km kn ko gt lb gh gi paragraph-image"><div class="gh gi la"><img src="../Images/c7f99be2120b96130e5ec15a2de07457.png" data-original-src="https://miro.medium.com/v2/resize:fit:1210/format:webp/1*ZD0mAMxlxXchBJzwPAQp7w.png"/></div></figure><p id="0fe4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果我们连接所有这些变量，我们将得到下面的字符串。</p><figure class="kl km kn ko gt lb gh gi paragraph-image"><div class="gh gi mg"><img src="../Images/0e5cc3e7f54826d612f045172efc23d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1208/format:webp/1*4aL9XomZCSvgNR_qAEnntg.png"/></div></figure><p id="4feb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上面的代码执行以下操作:</p><ul class=""><li id="7e33" class="mt mu iq jp b jq jr ju jv jy mv kc mw kg mx kk my mz na nb bi translated">在%temp%目录中创建一个名为“WindowsNT”的文件夹。</li></ul><figure class="kl km kn ko gt lb gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/8c9e50c8c301238613462141054547b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:922/format:webp/1*7x0Zo7cQtWqVa9xcQIcpIg.png"/></div></figure><ul class=""><li id="19b6" class="mt mu iq jp b jq jr ju jv jy mv kc mw kg mx kk my mz na nb bi translated">使用“bitsadmin”实用程序开始下载，并下载两个文件。第一个是<strong class="jp ir">“launcher _ KL . txt”</strong>，它将作为“cert.exe”保存在先前创建的目录“WindowsNT”中，第二个是<strong class="jp ir">“KL _ exe . txt”</strong>，它也将作为“certificate_kl.txt”保存在“WindowsNT”目录中。</li></ul><figure class="kl km kn ko gt lb gh gi paragraph-image"><div class="gh gi la"><img src="../Images/64c94947cd1b92b4bd940b86684ac857.png" data-original-src="https://miro.medium.com/v2/resize:fit:1210/format:webp/1*-vvwR_LyRQEzpVaSTjWpkw.png"/></div></figure><ul class=""><li id="f42a" class="mt mu iq jp b jq jr ju jv jy mv kc mw kg mx kk my mz na nb bi translated">执行刚下载的“cert.exe”。</li></ul><figure class="kl km kn ko gt lb gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/c6630e3956abb92de4d16d8eca64057e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1124/format:webp/1*s9DZY14kMAMfhKeq9BRGjg.png"/></div></figure><ul class=""><li id="f07d" class="mt mu iq jp b jq jr ju jv jy mv kc mw kg mx kk my mz na nb bi translated">创建一个名为“Update Manager”的计划任务，每10分钟执行一次，并启动“cert.exe”文件。</li></ul><figure class="kl km kn ko gt lb gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/1ecea03cf9561e673c57f39b89b57d79.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/format:webp/1*6n084xK4ouy8PMtPb2ypQw.png"/></div></figure><p id="1079" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所有这些都将被推送到名为“test.bat”的文件中，该文件将放在%temp%目录中并被执行。</p><figure class="kl km kn ko gt lb gh gi paragraph-image"><div class="gh gi la"><img src="../Images/df5a11c8289f4a52bac7d39ca16d4b19.png" data-original-src="https://miro.medium.com/v2/resize:fit:1210/format:webp/1*Rg0hDJz6WNmN2b4_Z7MKvQ.png"/></div></figure><p id="0a90" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">只是为了确保第二阶段下载程序无论如何都会被执行。将创建一个名为“Update Manager”的计划任务，每10分钟执行一次“test.bat”文件。</p><figure class="kl km kn ko gt lb gh gi paragraph-image"><div class="gh gi la"><img src="../Images/83e284773cdc4d7ad07252d1a371bc5f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1210/format:webp/1*GvuClk0Yi5-Dsz30RAerPA.png"/></div></figure><p id="7ac4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">假设一切按计划进行，恶意软件成功下载了所有内容。接下来要执行的是新下载的“cert.exe”。这是我们接下来要看的文件。</p><h2 id="8534" class="ku kv iq bd lf mh mi dn lj mj mk dp ln jy ml mm lr kc mn mo lv kg mp mq lz mr bi translated"><strong class="ak">“cert . exe”解析</strong></h2><p id="71b9" class="pw-post-body-paragraph jn jo iq jp b jq mb js jt ju mc jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">首先，我们查看可执行文件上的file命令的结果，我们将看到它是一个带有GUI的PE32可执行文件，并且符号被去除了。</p><figure class="kl km kn ko gt lb gh gi paragraph-image"><div class="gh gi la"><img src="../Images/8d8e75c317f06cc842eba7ee96783a9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1210/format:webp/1*rHsnrKaHwYGkKRMBtYk_tA.png"/></div></figure><p id="a4ca" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，让我们通过对它执行“strings”命令来检查它是否包含任何有趣的字符串。</p><figure class="kl km kn ko gt lb gh gi paragraph-image"><div class="gh gi la"><img src="../Images/9819b4941ed008817642627224346e45.png" data-original-src="https://miro.medium.com/v2/resize:fit:1210/format:webp/1*2INc4VFrteiBev_MtaVqJw.png"/></div></figure><p id="0c91" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">答对了。正如你所看到的，这些字符串包含看起来像WMI命令和一些PowerShell。我们把这个美化一下，放到一个好看的编辑器里，开始分析。</p><figure class="kl km kn ko gt lb gh gi paragraph-image"><div class="gh gi la"><img src="../Images/4edda32c65685947287d7d1237c4a9d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1210/format:webp/1*JU3vJnzvTcg4vskivEKpTg.png"/></div></figure><p id="cd2c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">简而言之，下面的代码使用带有<strong class="jp ir">-decode "</strong>标志的<strong class="jp ir"> "certutil" </strong>实用程序，对之前下载的<strong class="jp ir"> "certificate_kl.txt" </strong>进行解码，该文件存储在“WindowsNT”文件夹的temp目录下。它用于解码base64编码的文件。</p><figure class="kl km kn ko gt lb gh gi paragraph-image"><div class="gh gi la"><img src="../Images/53bef9be1df6a3339b1e5b0c537b910e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1210/format:webp/1*mmePps6WGVDUlp3nficFIA.png"/></div></figure><p id="f72e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">解码后的文件类型为<strong class="jp ir">“微软CAB存档数据”</strong>或<strong class="jp ir">“CAB”</strong>文件简称(即:压缩)。恶意软件做的下一件事是解压缩例程，包括使用“EXPAND”命令。</p><figure class="kl km kn ko gt lb gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/7d62b75cc0852639ef14b87e6dc8094a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1180/format:webp/1*APhJDEtHoUASv2nkXGDyYg.png"/></div></figure><p id="669a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">新获得的PowerShell文件是包含用C#编写的“键盘记录器”的最后一个阶段(或者我是这样认为的)。(我将在第2部分对此进行分析)。</p><p id="6e85" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">执行PowerShell脚本之前的最后一步是模糊处理。恶意软件作者创建了一个快速混淆例程来更改脚本中一些函数的名称。它使用简单的替换方法和一些随机化，用一组随机字符替换每个函数。</p><figure class="kl km kn ko gt lb gh gi paragraph-image"><div class="gh gi mg"><img src="../Images/299792165f1fd416738e6be74a62be91.png" data-original-src="https://miro.medium.com/v2/resize:fit:1208/format:webp/1*lLx2vf7DQqg_PNx0r5IbUg.png"/></div></figure><p id="7c81" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，脚本被执行，原始编码文件“certificate_kl.txt”被删除。</p><figure class="kl km kn ko gt lb gh gi paragraph-image"><div class="gh gi mg"><img src="../Images/6f148c0bc6727f626a1fd5f74786faff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1208/format:webp/1*d_CzjaLjAPkl6fC4cyXPhw.png"/></div></figure></div><div class="ab cl ng nh hu ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="ij ik il im in"><h1 id="f7e5" class="le kv iq bd lf lg nn li lj lk no lm ln lo np lq lr ls nq lu lv lw nr ly lz ma bi translated"><strong class="ak">总结</strong></h1><p id="01d3" class="pw-post-body-paragraph jn jo iq jp b jq mb js jt ju mc jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">在我们结束分析的第一部分之前，让我们快速回顾一下恶意软件做了什么以及使用了什么技术。</p><ul class=""><li id="2989" class="mt mu iq jp b jq jr ju jv jy mv kc mw kg mx kk my mz na nb bi translated">该恶意软件以PDF文件的形式隐藏在名为“CV_YASMINA”的ZIP文件中，以欺骗用户认为它是CV(课程表Vita)的一个示例。</li><li id="33a0" class="mt mu iq jp b jq ns ju nt jy nu kc nv kg nw kk my mz na nb bi translated">ZIP文件包含一个恶意的bat文件，该文件通过使用UTF-16 LE编码和多个变量名来分隔正在执行的命令，从而混淆其内容。</li><li id="460a" class="mt mu iq jp b jq ns ju nt jy nu kc nv kg nw kk my mz na nb bi translated">当执行时，它会显示一条错误消息，让用户误以为出了问题。</li><li id="0a94" class="mt mu iq jp b jq ns ju nt jy nu kc nv kg nw kk my mz na nb bi translated">它将两个文件(“cert.exe”和certificate_kl.txt”)下载到temp目录中。请注意，dropbox上的原始文件带有一个“.”。txt”扩展名，它添加了一个小的混淆层作为“txt”文件，在日志分析过程中有时会被忽略。</li><li id="f476" class="mt mu iq jp b jq ns ju nt jy nu kc nv kg nw kk my mz na nb bi translated">它创建了两个计划任务，以确保第二阶段无论如何都会被下载和执行。</li><li id="55de" class="mt mu iq jp b jq ns ju nt jy nu kc nv kg nw kk my mz na nb bi translated">一旦第二阶段下载完成。恶意软件继续执行“cert.exe ”,它将解码并创建“最终”有效负载</li></ul><h1 id="b12d" class="le kv iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated"><strong class="ak">危害指示器(IoCs) </strong></h1><pre class="kl km kn ko gt kp kq kr ks aw kt bi"><span id="f9d7" class="ku kv iq kq b gy kw kx l ky kz"><strong class="kq ir">CV_YASMINA.PDF .zip: </strong>dd03221a35480c483c86195956ebb5d094c3e875c5f18f2d6e95a7dc32db78a9</span><span id="df2e" class="ku kv iq kq b gy nx kx l ky kz"><strong class="kq ir">CV_YASMINA.PDF .bat:</strong> dd42edae0008019aac47cee7962f564f1c201a232fe62f269b485e8e6332e498</span><span id="8685" class="ku kv iq kq b gy nx kx l ky kz"><strong class="kq ir">launcher_kl.txt / cert.exe:</strong> cf7fc1e176f3931bfbb508ddeb1b24b79f3db166ff1739cff69bee4d7f5d5a6a</span><span id="83b6" class="ku kv iq kq b gy nx kx l ky kz"><strong class="kq ir">kl_exe.txt / certificate_kl.txt:</strong><br/>1dd960fad2a8d057d32a9889e1f6a7c1349697d7df0fee2bc08d39709c443bd4</span><span id="5d7b" class="ku kv iq kq b gy nx kx l ky kz"><strong class="kq ir">windows_activator.ps1 (After Obfuscation):</strong><br/>4a8f8f6053b1a43498c609599dfd2b491c957defede8a064194e6cf5de5c958d</span></pre><h1 id="48a1" class="le kv iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">结论</h1><p id="3b90" class="pw-post-body-paragraph jn jo iq jp b jq mb js jt ju mc jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">我希望你喜欢这个快速的分析，并且在这个过程中学到了一些东西。第2部分再见，希望很快。</p><p id="2bc0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您有任何反馈或建议，请发送给我<a class="ae ny" href="https://twitter.com/nas_bench" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir"> @nas_bench </strong> </a></p></div></div>    
</body>
</html>