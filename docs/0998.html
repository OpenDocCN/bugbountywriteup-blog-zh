<html>
<head>
<title>HTB SneakyMailer [writeup]</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">HTB·斯奈克米勒</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/htb-sneakymailer-writeup-bb32e94f593?source=collection_archive---------5-----------------------#2020-11-29">https://infosecwriteups.com/htb-sneakymailer-writeup-bb32e94f593?source=collection_archive---------5-----------------------#2020-11-29</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="2501" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">群发电子邮件网络钓鱼| PyPi软件包文件滥用| pip3</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/eedbfcc3fd39e82beb79c43a526b91d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LYx-S_SrZ-M43XvLhWsMww.png"/></div></div></figure><h1 id="ee40" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">摘要</h1><p id="fba7" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">这台机器教会了我一些有趣的攻击途径，尤其是如何设置一个钓鱼邮件来提取用户凭证。机器有打开的FTP，所以我上传了shell脚本，通过FTP子域浏览器执行。</p><p id="be1c" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">在检索到低特权shell后，我使用了通过钓鱼邮件找到的用户凭据，并使用它升级到一个开发人员的帐户。</p><p id="7c80" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">在横向移动过程中，我发现pypi服务器正在这台机器上运行，它的凭证也暴露了。配置此服务器以实现升级到另一个用户。利用在互联网上找到的指南，我设法得到了外壳。</p><p id="8152" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">如果执行基本枚举来利用该漏洞，根升级是非常简单的。</p><h2 id="cba9" class="mn kv it bd kw mo mp dn la mq mr dp le lv ms mt lg lz mu mv li md mw mx lk my bi translated">使用的工具:</h2><ul class=""><li id="7b35" class="mz na it lo b lp lq ls lt lv nb lz nc md nd mh ne nf ng nh bi translated"><code class="fe ni nj nk nl b">nmap -sCVS 10.10.10.197 -p- &gt; nmap.txt</code></li><li id="6436" class="mz na it lo b lp nm ls nn lv no lz np md nq mh ne nf ng nh bi translated"><code class="fe ni nj nk nl b">gobuster</code></li><li id="a574" class="mz na it lo b lp nm ls nn lv no lz np md nq mh ne nf ng nh bi translated"><code class="fe ni nj nk nl b">dirsearch.py</code></li><li id="fe44" class="mz na it lo b lp nm ls nn lv no lz np md nq mh ne nf ng nh bi translated"><code class="fe ni nj nk nl b">wfuzz</code></li><li id="926f" class="mz na it lo b lp nm ls nn lv no lz np md nq mh ne nf ng nh bi translated">Evolution - IMAP客户端</li></ul><p id="c122" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">网络服务器: nginx/1.14.2</p><p id="195a" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated"><strong class="lo iu">服务器端语言:</strong> PHP</p><p id="53a1" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated"><strong class="lo iu">脚本语言:</strong> Python</p></div><div class="ab cl nr ns hx nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="im in io ip iq"><p id="aa30" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated"><strong class="lo iu"> Nmap TCP扫描输出</strong></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ny"><img src="../Images/1e24725c026e5862fe3c05df01b4d2a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Gh4YGZ97vsmSffaXxCewIw.png"/></div></div></figure><p id="fbb9" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated"><strong class="lo iu"> ************端口80 HTTP * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *</strong></p><p id="bbf2" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">输入IP地址<em class="nz"> 10.10.10.197，</em>它试图重定向到sneakycorp.htb。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oa"><img src="../Images/387264ffc4eb63ee0a2a4c435ef4272c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*TiPK0HZL3EVHt4OvuMQYeA.gif"/></div></div></figure><p id="caac" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated"><strong class="lo iu"> etc/hosts </strong>文件将主机名映射到IP地址。包括它，如下所示。等待几秒钟让它生效，然后执行URL中的<em class="nz"> sneakycorp.htb </em>。</p><p id="d47c" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">在成功运行该网站后，我注意到员工邮件的域名是<em class="nz"> sneakymailer.htb </em>。然后将其添加到<strong class="lo iu"> /etc/hosts </strong>文件中。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ob"><img src="../Images/4c918321673fc2b04983ed24273677da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I0pPz2179mKwnL4kDm--Eg.png"/></div></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oc"><img src="../Images/d9d12a42f21adef823740ce2e395d6d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i9iUYmx4PJ6eqPMmKsat3w.png"/></div></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi od"><img src="../Images/28e4713dde1c5ae3c3a35115a09a259f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0iDcCoEHWPHVeP3_scyffQ.png"/></div></div></figure><p id="ac80" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated"><strong class="lo iu"> /team.php </strong>下有57个词条！我创建了两个txt文件。一个包括所有员工的电子邮件地址，另一个只包括员工姓名<em class="nz">(潜在用户名)</em>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oe"><img src="../Images/b3cd3e5e2624ce3c098513629517520a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sA1gtPqzzI7xiU8FD46BDg.png"/></div></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi of"><img src="../Images/5e6ae935ab569dbcdadcc19a27193e71.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WHRjmBjlRFPlV0iWMyoK0g.png"/></div></div></figure><blockquote class="og"><p id="6501" class="oh oi it bd oj ok ol om on oo op mh dk translated">内容目录搜索</p></blockquote><p id="a53a" class="pw-post-body-paragraph lm ln it lo b lp oq ju lr ls or jx lu lv os lx ly lz ot mb mc md ou mf mg mh im bi translated"><code class="fe ni nj nk nl b">gobuster</code>使用单词列表<em class="nz">/usr/share/dir buster/word lists/directory-list-2.3-medium . txt</em>你会找到<em class="nz"> /pypi </em>子目录。</p><p id="ed15" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">针对特定扩展运行了<code class="fe ni nj nk nl b">dirsearch.py</code>:php，。txt，。zip并找到了<em class="nz">register.php的</em>文件</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ov"><img src="../Images/021b9839177d5ca5d9314f535699714b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mA80AHAMWAYLM5ezWxJxpg.png"/></div></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ow"><img src="../Images/331a0a012c63695b65d8a459614235a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AVwYpV9_MuFa4Ra1cFX5Hw.png"/></div></div><figcaption class="ox oy gj gh gi oz pa bd b be z dk translated">这只不过是一个虚假的页面。</figcaption></figure><blockquote class="og"><p id="49f8" class="oh oi it bd oj ok ol om on oo op mh dk translated">子域模糊</p></blockquote><p id="d95e" class="pw-post-body-paragraph lm ln it lo b lp oq ju lr ls or jx lu lv os lx ly lz ot mb mc md ou mf mg mh im bi translated"><code class="fe ni nj nk nl b">sudo wfuzz. -H "host:FUZZ.sneakycorp.htb" -u sneakycorp.htb -w /usr/share/dirb/wordlists/big.txt --hc 404,301</code></p><p id="1b45" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">web fuzzer发现<em class="nz">‘dev’</em>是sneakycorp.htb的子域</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pb"><img src="../Images/d8e50768011ef437fbffc51b30b8fa87.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CxzutINnzS9-ztDfYXIGXg.png"/></div></div></figure><p id="0dd3" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">在<em class="nz"> /etc/hosts </em>中添加子域来解析该地址</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi pc"><img src="../Images/44bbf5b4deacc280e59645bc48ba07a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1172/format:webp/1*FPCjjk40G-sa6n3bIjvPDg.png"/></div></figure><p id="f74a" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated"><strong class="lo iu"> dev.sneakycorp.htb </strong>拥有与主域相同的GUI。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pd"><img src="../Images/3d0ab66ed86c4368bb4ea040be85f90c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*39kmyoLwesXzwrFm7mIK1g.png"/></div></div></figure><p id="fea0" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated"><strong class="lo iu">对于端口8080，</strong>我重复了与端口80相同的过程。</p><p id="0e51" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">在这个端口上只找到了子域'<em class="nz"> Dev </em>'。</p></div><div class="ab cl nr ns hx nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="im in io ip iq"><p id="a1e0" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated"><strong class="lo iu">* * * * * * * * * * * *端口25 SMTP * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *</strong></p><blockquote class="og"><p id="4535" class="oh oi it bd oj ok pe pf pg ph pi mh dk translated">设置网络钓鱼电子邮件</p></blockquote><p id="ec60" class="pw-post-body-paragraph lm ln it lo b lp oq ju lr ls or jx lu lv os lx ly lz ot mb mc md ou mf mg mh im bi translated">向“team.php”页面上列出的名字之一发送了一封测试邮件。电子邮件已成功发送给收件人。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pj"><img src="../Images/11ffe24cde871426011726f13824858f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7__zt8X0CwtvSdiSaXW_Hw.png"/></div></div></figure><p id="b218" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">现在，设置一封钓鱼邮件来引诱用户点击链接。</p><p id="d1ed" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">接下来，在web服务器上设置一个监听端口<a class="ae pk" href="http://10.10.14.42" rel="noopener ugc nofollow" target="_blank"> http://10.10.14.42 </a></p><p id="580e" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated"><code class="fe ni nj nk nl b">nc -lvnp 7529</code></p><p id="05f2" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">当接收者点击发送的链接时，它将被web服务器端口捕获。</p><p id="7e0e" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated"><code class="fe ni nj nk nl b">sudo swaks --to carastevens@sneakymailer.htb,bradleygreer@sneakymailer.htb,zoritaserrano@sneakymailer.htb,zenaidafrank@sneakymailer.htb,yuriberry@sneakymailer.htb,vivianharrell@sneakymailer.htb,unitybutler@sneakymailer.htb,timothymooney@sneakymailer.htb,tigernixon@sneakymailer.htb,thorwalton@sneakymailer.htb,tatyanafitzpatrick@sneakymailer.htb,sulcud@sneakymailer.htb,sukiburks@sneakymailer.htb,sonyafrost@sneakymailer.htb,shouitou@sneakymailer.htb,shaddecker@sneakymailer.htb,sergebaldwin@sneakymailer.htb,sakurayamamoto@sneakymailer.htb,rhonadavidson@sneakymailer.htb,quinnflynn@sneakymailer.htb,prescottbartlett@sneakymailer.htb,paulbyrd@sneakymailer.htb,olivialiang@sneakymailer.htb,michellehouse@sneakymailer.htb,michaelsilva@sneakymailer.htb,martenamccray@sneakymailer.htb,laelgreer@sneakymailer.htb,jonasalexander@sneakymailer.htb,jenniferchang@sneakymailer.htb,jenniferacosta@sneakymailer.htb,jenettecaldwell@sneakymailer.htb,jenagaines@sneakymailer.htb,jacksonbradshaw@sneakymailer.htb,howardhatfield@sneakymailer.htb,hopefuentes@sneakymailer.htb,herrodchandler@sneakymailer.htb,hermionebutler@sneakymailer.htb,haleykennedy@sneakymailer.htb,glorialittle@sneakymailer.htb,gavinjoyce@sneakymailer.htb,gavincortez@sneakymailer.htb,garrettwinters@sneakymailer.htb,fionagreen@sneakymailer.htb,finncamacho@sneakymailer.htb,doriswilder@sneakymailer.htb,donnasnider@sneakymailer.htb,dairios@sneakymailer.htb,colleenhurst@sneakymailer.htb,chardemarshall@sneakymailer.htb,cedrickelly@sneakymailer.htb,caesarvance@sneakymailer.htb,brunonash@sneakymailer.htb,briellewilliamson@sneakymailer.htb,brendenwagner@sneakymailer.htb,ashtoncox@sneakymailer.htb,angelicaramos@sneakymailer.htb,airisatou@sneakymailer.htb --server 10.10.10.197 --body “<a class="ae pk" href="http://10.10.14.42:7529" rel="noopener ugc nofollow" target="_blank">http://10.10.14.42:7529</a>"</code></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pl"><img src="../Images/b97bb9281f3ddffec19455997f7bea87.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*oYRQOZolzyQMPlTZHzivPg.gif"/></div></div><figcaption class="ox oy gj gh gi oz pa bd b be z dk translated">通过监听服务器端口进行身份验证捕获</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pm"><img src="../Images/fbf8e7d39f0cfa84d5083423e39367d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QaZ3Npl-038RZEYc-RzMtg.png"/></div></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pn"><img src="../Images/e6d5e11271a704e8025ef18746ac40d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ptXWUTXGl0pATdIYd87xFw.png"/></div></div></figure><h2 id="2a04" class="mn kv it bd kw mo mp dn la mq mr dp le lv ms mt lg lz mu mv li md mw mx lk my bi translated">********端口143 IMAP * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *</h2><p id="a3cb" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">我用evolution为paulbyrd@sneakymailer.htb账号设置了IMAP UI。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi po"><img src="../Images/ecd6213bc877ed59256f5cae5d755147.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DvAQ2esC1RncTiO5X9eROg.png"/></div></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pp"><img src="../Images/0e8412c1b85c7c27c52a887f10646a26.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V3GEaAxxPEm_LXFB8yTONA.png"/></div></div><figcaption class="ox oy gj gh gi oz pa bd b be z dk translated">找到开发人员凭据</figcaption></figure><h2 id="4da1" class="mn kv it bd kw mo mp dn la mq mr dp le lv ms mt lg lz mu mv li md mw mx lk my bi translated">********端口21 FTP * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *</h2><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pq"><img src="../Images/d390d8617369a613e4d118fbc5d98f1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KrEawco-UBPWII0Lx4jNNA.png"/></div></div><figcaption class="ox oy gj gh gi oz pa bd b be z dk translated">使用开发人员凭据的FTP登录。</figcaption></figure><p id="993f" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">在这里，我创建了一个shell.php，并上传到开发人员的FTP帐户。</p><blockquote class="og"><p id="cc82" class="oh oi it bd oj ok pe pf pg ph pi mh dk translated">创建有效负载</p></blockquote><figure class="ps pt pu pv pw kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pr"><img src="../Images/535bebf084a709e26536f1c2c67dbc41.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y4PtYASBx9WgNJgaNJl0UQ.png"/></div></div></figure><blockquote class="og"><p id="6a81" class="oh oi it bd oj ok ol om on oo op mh dk translated">上传到开发者的FTP</p></blockquote><figure class="ps pt pu pv pw kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi px"><img src="../Images/e69e690fe9a8c02b0c1636190f939213.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rsDB-dZRujpfjx2x_J04kA.png"/></div></div></figure><blockquote class="og"><p id="92b0" class="oh oi it bd oj ok ol om on oo op mh dk translated">设置一个监听器端口并执行shell</p></blockquote><figure class="ps pt pu pv pw kn gh gi paragraph-image"><div class="gh gi py"><img src="../Images/50fd5a83efb9ea44055ae2e999be4f83.png" data-original-src="https://miro.medium.com/v2/resize:fit:1060/format:webp/1*k-Q5pu1TtZo98zHd1CWcxA.png"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pz"><img src="../Images/9ebbdc4b624e1568b28c62027813c6e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U8VhIy7BtHq-ut6kNzRrEA.png"/></div></div></figure><blockquote class="qa qb qc"><p id="cf23" class="lm ln nz lo b lp mi ju lr ls mj jx lu qd mk lx ly qe ml mb mc qf mm mf mg mh im bi translated">我还能够使用相同的凭证升级到用户开发人员。</p></blockquote><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi qg"><img src="../Images/1cdb21954550d2efcff97423e915d807.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CHV7uBXu-aAwlC6vr9iw8g.png"/></div></div></figure><blockquote class="qa qb qc"><p id="16cb" class="lm ln nz lo b lp mi ju lr ls mj jx lu qd mk lx ly qe ml mb mc qf mm mf mg mh im bi translated">我下载了临时文件夹中的<code class="fe ni nj nk nl b">linenum.sh</code>，在<strong class="lo iu">/var/www/pypi . sneaky corp . htb/中找到了以下凭证。htpasswd </strong>文件。</p></blockquote><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi qh"><img src="../Images/0e5bea23b25db6eb88bd7c452a730f9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nNVYSx3ShntfGwB3-lZBXA.png"/></div></div></figure><blockquote class="qa qb qc"><p id="7289" class="lm ln nz lo b lp mi ju lr ls mj jx lu qd mk lx ly qe ml mb mc qf mm mf mg mh im bi translated">在<em class="it"> /etc/hosts </em>文件中添加pypi.sneakycorp.htb，我们看到pypiserver运行在8080上。</p></blockquote></div><div class="ab cl nr ns hx nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="im in io ip iq"><p id="1d9f" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated"><strong class="lo iu">* * * * * * * * * * * * * *端口8080 HTTP * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *</strong></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi qi"><img src="../Images/ccf86fada3007a98c5008083fb3bb878.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VHfmm3nCVNHEK7jMNAFEtg.png"/></div></div></figure></div><div class="ab cl nr ns hx nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="im in io ip iq"><h2 id="b39e" class="mn kv it bd kw mo mp dn la mq mr dp le lv ms mt lg lz mu mv li md mw mx lk my bi translated">横向权限提升</h2><p id="3c81" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">对于这部分，我们知道/有以下两件事:</p><ul class=""><li id="eb52" class="mz na it lo b lp mi ls mj lv qj lz qk md ql mh ne nf ng nh bi translated">pypi服务器凭据</li><li id="c307" class="mz na it lo b lp nm ls nn lv no lz np md nq mh ne nf ng nh bi translated">pypi服务器正在pypi.sneakycorp.htb:8080上运行</li></ul><h2 id="38b2" class="mn kv it bd kw mo mp dn la mq mr dp le lv ms mt lg lz mu mv li md mw mx lk my bi translated">理解P <a class="ae pk" href="https://pypi.org" rel="noopener ugc nofollow" target="_blank"> yPi </a></h2><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi qm"><img src="../Images/da18696d01eb57b24eb7656cf076e59c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iReJBPje1EJMkPdlFzgI9A.png"/></div></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi qn"><img src="../Images/7d2aba34b8ab9333438cd10335d10e32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U2fqGtEtebaF-oV0yvOwGw.png"/></div></div></figure><h2 id="7ad5" class="mn kv it bd kw mo mp dn la mq mr dp le lv ms mt lg lz mu mv li md mw mx lk my bi translated">将“恶意”包上传到PyPi服务器</h2><p id="9561" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">使用这个<a class="ae pk" href="https://pypi.org/project/pypiserver/#upload-with-setuptools" rel="noopener ugc nofollow" target="_blank">链接</a>配置PyPi服务器。</p><p id="d810" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">pypi_pkg目录中有两个文件:</p><ul class=""><li id="432a" class="mz na it lo b lp mi ls mj lv qj lz qk md ql mh ne nf ng nh bi translated">。pypirc</li><li id="1f22" class="mz na it lo b lp nm ls nn lv no lz np md nq mh ne nf ng nh bi translated">setup.py</li></ul><blockquote class="og"><p id="ec9d" class="oh oi it bd oj ok ol om on oo op mh dk translated">1.在主机上创建一个包文件夹。</p><p id="eba7" class="oh oi it bd oj ok pe pf pg ph pi mh dk translated">2.使用pypirc文件并包含pypi服务器凭证。</p></blockquote><figure class="ps pt pu pv pw kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi qo"><img src="../Images/0176fd8f9f218bf7c1891fa01cd7fd2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d0QScfSS2UnqTSwzutX54A.png"/></div></div></figure><blockquote class="og"><p id="bbe8" class="oh oi it bd oj ok ol om on oo op mh dk translated">3.使用示例<a class="ae pk" href="https://packaging.python.org/tutorials/packaging-projects/" rel="noopener ugc nofollow" target="_blank"> setup.py </a>文件并修改。</p></blockquote><figure class="ps pt pu pv pw kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi qp"><img src="../Images/e0c4df7eb501d8f5ebfa688aa1a204a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n5L8AEYGmqrC8yQ2U-pCtA.png"/></div></div></figure><blockquote class="og"><p id="8ea4" class="oh oi it bd oj ok ol om on oo op mh dk translated">4.将pypi_pkg目录上传到开发者的机器上。</p></blockquote><p id="3bda" class="pw-post-body-paragraph lm ln it lo b lp oq ju lr ls or jx lu lv os lx ly lz ot mb mc md ou mf mg mh im bi translated">在主机上运行apache2 web服务器:<code class="fe ni nj nk nl b"> sudo service apache2 restart</code></p><p id="9b0c" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">在开发者的机器中，进入<em class="nz"> /tmp </em>文件夹，然后上传包文件。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi qq"><img src="../Images/a935bd8f0687b7904420f3a3312a43de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z4i3tpnnkilr2EL4N7-ypw.png"/></div></div></figure><p id="5fcf" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">确保文件是可执行的。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi qr"><img src="../Images/e9b11c88f35c13d16034022e0b3e2462.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bHCpiF3okzERso8vmXIQEA.png"/></div></div></figure><blockquote class="og"><p id="f65e" class="oh oi it bd oj ok ol om on oo op mh dk translated">5.将Home变量更改为文件所在的位置。</p></blockquote><figure class="ps pt pu pv pw kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi qs"><img src="../Images/ba6dc87a33126af540c7223ff37e2106.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4G_jfAcPzxUp_UXtJ7awbg.png"/></div></div></figure><blockquote class="og"><p id="af8e" class="oh oi it bd oj ok ol om on oo op mh dk translated">6.启动主机上的监听端口</p></blockquote><p id="b7ac" class="pw-post-body-paragraph lm ln it lo b lp oq ju lr ls or jx lu lv os lx ly lz ot mb mc md ou mf mg mh im bi translated"><code class="fe ni nj nk nl b">nc -lvnp 3826</code></p><blockquote class="og"><p id="82f4" class="oh oi it bd oj ok pe pf pg ph pi mh dk translated">7.执行</p></blockquote><p id="8656" class="pw-post-body-paragraph lm ln it lo b lp oq ju lr ls or jx lu lv os lx ly lz ot mb mc md ou mf mg mh im bi translated">现在一切都已正确配置，执行命令将恶意文件上传到pypi服务器</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi qt"><img src="../Images/17a76c766e871bc209206ddbab27e8a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N3UnXdHuy6S_aDIAeYdNeA.png"/></div></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi qu"><img src="../Images/cf5b8f6373f45b939479885540897cd8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dSWvH2WW5LLIDJ6nebzJnw.png"/></div></div></figure></div><div class="ab cl nr ns hx nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="im in io ip iq"><h2 id="6b1f" class="mn kv it bd kw mo mp dn la mq mr dp le lv ms mt lg lz mu mv li md mw mx lk my bi translated">垂直权限提升— Root！</h2><p id="6c06" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">使用命令<code class="fe ni nj nk nl b">sudo -l</code>我们可以看到，用户<em class="nz"> low </em>可以通过执行<code class="fe ni nj nk nl b">/usr/bin/pip3</code>命令以root身份运行自己，以获得反向shell</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi qv"><img src="../Images/49b8e14e548db71b15d159623bbfb638.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ccMg523cTMw4PUoabtD4oA.png"/></div></div></figure><p id="646e" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated"><a class="ae pk" href="https://gtfobins.github.io/gtfobins/pip/" rel="noopener ugc nofollow" target="_blank"><strong class="lo iu">gtfobins</strong></a><strong class="lo iu"/>在这里被用来滥用pip3</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi qw"><img src="../Images/ffba7a5aade76eb66533d7e306bde856.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*s9N1AzdZRcMdf8--97OO7g.png"/></div></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi qx"><img src="../Images/f81ee9a49aa6e62ec89e0ef4f4f1eee2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1068/format:webp/1*BVN66vD_8YxQqJulQFJLeg.png"/></div><figcaption class="ox oy gj gh gi oz pa bd b be z dk translated">成功了！！！</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi qy"><img src="../Images/5510077aeff9b70d9e878efcda01645a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1392/1*kWs89sQTRihmZDU3Dk_5Tg.gif"/></div></figure></div><div class="ab cl nr ns hx nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="im in io ip iq"><h1 id="41d0" class="ku kv it bd kw kx qz kz la lb ra ld le jz rb ka lg kc rc kd li kf rd kg lk ll bi translated">补救</h1><ul class=""><li id="06fd" class="mz na it lo b lp lq ls lt lv nb lz nc md nd mh ne nf ng nh bi translated">使用根级别权限限制标准用户对工具的访问。或者从该工具中删除root权限。</li><li id="34ef" class="mz na it lo b lp nm ls nn lv no lz np md nq mh ne nf ng nh bi translated">设置适当的权限，使用户无法导航到任何其他用户的目录/文件。</li><li id="89bf" class="mz na it lo b lp nm ls nn lv no lz np md nq mh ne nf ng nh bi translated">使用SFTP而不是FTP，并始终使用至少12位数的密码，以更好地保护您的帐户。</li></ul></div></div>    
</body>
</html>