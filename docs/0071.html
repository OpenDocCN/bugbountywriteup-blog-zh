<html>
<head>
<title>Piercing the Veil: Server Side Request Forgery to NIPRNet access</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">穿透面纱:服务器端请求伪造NIPRNet访问</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/piercing-the-veil-server-side-request-forgery-to-niprnet-access-c358fd5e249a?source=collection_archive---------0-----------------------#2018-04-09">https://infosecwriteups.com/piercing-the-veil-server-side-request-forgery-to-niprnet-access-c358fd5e249a?source=collection_archive---------0-----------------------#2018-04-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/></div><div class="ab cl jn jo hu jp" role="separator"><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js"/></div><div class="ij ik il im in"><p id="e15e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在我作为国防部漏洞披露的一部分对军事网站进行侦察的过程中，我注意到两个特定的网站正在使用吉拉，这是一个流行的问题跟踪web应用程序。我最初写下这些网站，因为当时我不知道有任何利用。</p><p id="4ef2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">后来，我在查看我的Twitter feed，注意到一条<a class="ae ks" href="https://twitter.com/ankit_anubhav/status/973566620676382721" rel="noopener ugc nofollow" target="_blank">推文</a>讨论一个<a class="ae ks" href="https://www.owasp.org/index.php/Server_Side_Request_Forgery" rel="noopener ugc nofollow" target="_blank">服务器端请求伪造漏洞</a> (SSRF)正在吉拉被积极利用。阅读完这篇文章后，我立即重新访问了我之前发现的两个吉拉实例，看看是否可以使用这种新技术来利用它们。</p><p id="1081" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">最初，我通过端点访问google.com，找到了第一个网站；完整的网址应该是这样的，【https://website.mil/plugins/servlet/oauth/users/icon-uri?】T5<br/>consumer uri = http://Google . com</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div class="ab gu cl ky"><img src="../Images/956ec1274f1001540fe67bc39a087181.png" data-original-src="https://miro.medium.com/v2/format:webp/1*WjEv-2jD3rk_uNhE8avplg.png"/></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated">谷歌被加载向我表明，它仍然是脆弱的！</figcaption></figure><p id="2889" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我从Brett Buerhaus的一篇博客文章中了解到，任何AWS实例都可以查询一个ip并接收与该实例相关的信息，甚至是帐户信息。然后，我通过访问<br/><a class="ae ks" href="http://169.254.169.254/latest/meta-data/local-hostname/" rel="noopener ugc nofollow" target="_blank">http://169 . 254 . 169 . 254/latest/meta-data/local-hostname/</a>，通过<a class="ae ks" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html#instancedata-data-categories" rel="noopener ugc nofollow" target="_blank"> AWS元数据端点</a>检查本地主机名</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div class="ab gu cl ky"><img src="../Images/977ebee994bfb24c7c93c1168b6bbe5b.png" data-original-src="https://miro.medium.com/v2/format:webp/1*PLJsDvxgGi7Lqs4QWNDMDA.png"/></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated">我能够看到证明访问云服务器元数据的主机名</figcaption></figure><p id="cb06" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在这里，我试图通过访问http://169 . 254 . 169 . 254/latest/meta-data/iam/security-credential来获取他们的AWS实例的凭证。但是很遗憾，我发现我做不到。在阅读了AWS文档后，我开始查询我可以从该端点提取的其他敏感数据，如<a class="ae ks" href="http://169.254.169.254/latest/dynamic/instance-identity/document" rel="noopener ugc nofollow" target="_blank">http://169 . 254 . 169 . 254/latest/dynamic/instance-identity/document</a>，这些数据显示了私有IP、帐户ID、服务器信息等，然后立即进行了报告。</p><p id="a415" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我立即停止了所有的测试，因为我不想违反任何参与规则，并迅速提交了一份关于我的发现的报告。不久后，我收到了分流成员的回复，我开始让他们知道我将尝试升级漏洞，以证明最大的严重性。他们最初将报告标记为中等严重程度的漏洞，但鉴于我目前所能做的，我觉得这是一个关键问题。有了许可，我开始工作，最大限度地旋转和利用端点。</p><p id="94e2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我首先简单地从端口扫描本地主机开始，看看是否有我可以调用的协议。我分别测试了以下端口。</p><p id="5810" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">21、(FTP) <br/> 22、(SSH) <br/> 80、(Web) <br/> 443、(SSL Web) <br/> 8080、(代理)</p><p id="0130" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让测试这个端点变得非常容易的是，我可以看到发生的各种错误，这可以帮助我探测他们的服务器和网络。这被认为是基于误差的SSRF。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div class="ab gu cl ky"><img src="../Images/fa69dac8f579735ffd9e7dc9daf21f8c.png" data-original-src="https://miro.medium.com/v2/format:webp/1*mN556SmNcvchvQWGGf9ddg.png"/></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated">查询本地主机的结果:8080</figcaption></figure><p id="acca" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">接下来，我继续检查不同的协议以涵盖我的所有基础，gopher://(文件分发)<br/> dict://(字典网络协议)<br/> ftp:// <!-- -->(文件传输协议)<br/> File://(文件URI方案)<br/> ldap://(轻量级目录访问协议<em class="lf"> ) </em> <br/>尽管这些都没有产生任何结果，因为它们不支持我尝试的任何协议。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div class="ab gu cl ky"><img src="../Images/d4d7745ec45c940d1d5f7bbc8339b775.png" data-original-src="https://miro.medium.com/v2/format:webp/1*lE9O2xvMTgYlJ21Y4qIkJQ.png"/></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated">不支持LDAP</figcaption></figure><p id="4490" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在为报告记录了所有这些信息后，我想起了研究员James Kettle的一个名为“<a class="ae ks" href="http://blog.portswigger.net/2017/07/cracking-lens-targeting-https-hidden.html" rel="noopener ugc nofollow" target="_blank">破解镜头:瞄准HTTP的隐藏攻击面</a>的演示，其中提到能够访问国防部内部网或隐藏的内部服务，只有通过国防部IP才能访问或来自国防部服务。在视频演示中，他展示了两个这样的网站，如果攻击者的IP来自国防部，就可以访问这两个网站。</p><p id="093f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在谷歌搜索了他提到的那篇文章后，我很容易就找到了，于是我开始查询这两个网站，看看它们的结果。结果非常清楚。访问这些内部网站。我查询的第一个网站显示USG警告，而另一个网站只是超时。在这个测试过程中，我还发现了其他intranet web服务。通过这个，我能够访问<a class="ae ks" href="https://en.wikipedia.org/wiki/NIPRNet" rel="noopener ugc nofollow" target="_blank"> NIPRnet </a>，这是一个非机密的内部协议网络，用于处理过于敏感的信息，以至于不能面向互联网，并被确认访问过它。由于这些内部服务或网站的敏感性，我不会公开这些服务或网站。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div class="ab gu cl ky"><img src="../Images/e15bac6c10fb1b119b9ecf57150e567a.png" data-original-src="https://miro.medium.com/v2/format:webp/1*gwuerLKrGw23_nDHp10H6Q.png"/></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated">这个内部网站最终超时，但其他领域的连接和显示给我。</figcaption></figure><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div class="ab gu cl ky"><img src="../Images/386dcb1359fdb8d3f05d0eea9ad520ae.png" data-original-src="https://miro.medium.com/v2/format:webp/1*lq-vmbEsl5lgNX-IkPiYsg.png"/></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated">美国政府警告所有敏感信息完全编辑。</figcaption></figure><p id="2eca" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我发现的第二个吉拉网站出人意料地难以利用。它没有给出像我上面讨论和展示的那种冗长的错误。我最终发现，我可以根据响应时间来评估内部是否存在某些端口。</p><p id="6cc2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">例如:查询端口22导致1000毫秒的响应时间。其中as查询端口21导致10，000毫秒的响应时间。此外，由于缺乏详细的错误，我无法找出任何支持的协议，尽管我最终专注于本文的关键点，即访问NIPRnet。我还使用burp collaborator来查看当它从我控制的服务器请求数据时，泄露了什么类型的信息。</p><p id="dcf9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我从请求标头中注意到，它们泄漏了敏感信息，包括泄漏内部IP的“X-Forwarded-For”标头。我最后查询了所有与我的“Burp Collaborator”服务器链接交互的IP，看看是否有什么奇怪的事情发生。然而，除了超时错误之外，什么也没有做。在这一点上，我还发现我无法在这个端点上查询AWS元数据，尽管我可以像在第一个网站上一样查询内部网IP和国防部服务器。</p><p id="3f49" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在报告了我的发现后，两份报告的严重性都提高到了危急。后来，我重新访问了我之前发现并在今年早些时候报告的两个低严重性SSRF漏洞，希望通过我在之前的研究中发现的信息来提高严重性。</p><p id="72ac" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这两个漏洞通过滥用HTTP connect请求来查询特定的IP地址，从而利用了web应用程序过滤器。这个请求非常简单，我们提交了<em class="lf">连接IP </em>，然后我们可以通过这个方法<em class="lf">枚举服务。</em>我们还可能滥用主机头对内部ip或外部IP执行认证请求，例如:<em class="lf">military website . mil @ internal _ IP。</em>在重新访问它们时，我发现我可以通过查询内部IP或服务来执行盲目的服务器端请求伪造，这导致页面告诉我操作超时、SSL错误或其某种变体。事件发生后，报告的严重性被提高到中等。</p><h1 id="a291" class="lg lh iq bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">关于开发阿尔塔西SSRF的其他提示</h1><p id="3fbb" class="pw-post-body-paragraph ju jv iq jw b jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn mi kp kq kr ij bi translated">在我研究这些漏洞并使用它们发现bug bounty目标的过程中，我发现在漏洞利用的某些情况下，会发生堆栈错误并泄露各种敏感信息。我还没有真正找到为什么在某些情况下会发生而在其他情况下不会发生的原因。您通常可以使用不完整的HTTP协议来触发它，比如http://或者我最初是如何使用，<a class="ae ks" rel="noopener ugc nofollow" target="_blank" href="/[::]."> http://[::]来发现它的。</a>泄露的信息包括数据库IP、数据库版本、正在使用的插件、操作系统、操作系统的架构等。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div class="ab gu cl ky"><img src="../Images/3f3fa04e02814eaa363334c3baa83e2b.png" data-original-src="https://miro.medium.com/v2/format:webp/1*VKgyyVvcH31puiVHUtXsWw.png"/></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated">泄漏敏感内部信息的堆栈跟踪错误</figcaption></figure><p id="3014" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">当您获得这个详细的堆栈跟踪时，您仍然可以利用该网站。我还注意到，有时网站会有链接到其他Altassian实例，这是我在测试一个资产时了解到的。他们在不同的子域上有一个confluence实例，我发现这是由于一个下拉菜单列出了他们使用的其他实例，这也容易受到漏洞的攻击。</p><h1 id="f5e6" class="lg lh iq bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">TL；速度三角形定位法(dead reckoning)</h1><p id="1c32" class="pw-post-body-paragraph ju jv iq jw b jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn mi kp kq kr ij bi translated">两个过时的吉拉实例容易受到服务器端请求伪造(SSRF)漏洞的攻击，这种攻击被利用，并转入对国防部内部服务和网络的访问。<br/> <br/>我们还发现，另一个被利用的网站允许攻击者查看敏感的AWS元数据服务的内容，这可能会泄露帐户ID、私有IP和其他与服务器和相关帐户相关的私有配置信息等信息。</p><p id="61db" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">攻击者可以利用这两个易受攻击的网站来访问内部可访问的国防部实例。这可能导致敏感数据受损，并可能中断关键任务资产。</p><p id="01e6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">国防部的漏洞披露计划范围广泛，并愿意与研究人员合作保护他们的资产。在与此类似的文章中，我讨论了我在国防部发现的常见问题和独特漏洞，你可以在这里找到<a class="ae ks" href="https://medium.com/@alyssa.o.herrera/high-risk-vulnerabilities-within-the-dod-from-coldfusion-dotnet-nuke-oracle-and-more-cc730f748c69" rel="noopener"/>。</p><p id="4bbd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">你可以在下面找到披露的报告</p><p id="3706" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">【https://hackerone.com/reports/330860<br/><a class="ae ks" href="https://hackerone.com/reports/326043" rel="noopener ugc nofollow" target="_blank">https://hackerone.com/reports/326043</a></p><h1 id="e3cd" class="lg lh iq bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">附录</h1><p id="700c" class="pw-post-body-paragraph ju jv iq jw b jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn mi kp kq kr ij bi translated">在撰写本文的过程中，我偶然发现了另一个运行易受攻击的confluence实例的国防部网站，其利用方法与前一个完全相同，因此我不会深入讨论这个网站。它的严重性与前两个漏洞报告相同。此外，我被要求暂时把这篇文章记下来，直到这篇文章得到适当的授权并公之于众。随着我的报告被披露，我现在可以发表这些文章了。</p></div></div>    
</body>
</html>