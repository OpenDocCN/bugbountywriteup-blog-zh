<html>
<head>
<title>Let’s have a SAML talks!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">让我们好好谈谈吧！</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/lets-have-a-saml-talks-402559b34d4e?source=collection_archive---------2-----------------------#2021-03-21">https://infosecwriteups.com/lets-have-a-saml-talks-402559b34d4e?source=collection_archive---------2-----------------------#2021-03-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="f5a9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">嘿大家好👋</p><p id="6708" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">大家都好吗？！希望你很好，并保持自己的生产力。本文将只关注SAML基础知识和与之相关的一些漏洞。</p></div><div class="ab cl kl km hu kn" role="separator"><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq"/></div><div class="ij ik il im in"><h1 id="717e" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">#引言</h1><p id="988e" class="pw-post-body-paragraph jn jo iq jp b jq lq js jt ju lr jw jx jy ls ka kb kc lt ke kf kg lu ki kj kk ij bi translated">SAML的正确定义是，“SAML( <strong class="jp ir">安全声明标记语言)</strong>是一种基于XML的SSO(单点登录)认证机制，它在身份提供者(IdP)和服务提供者(SP)之间传输用户身份数据，以认证用户访问其请求的资源，而无需每次都询问凭证”。</p><p id="e526" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">用外行的话来说，“SAML是你在你居住的城镇中的一个朋友(身份提供者)，他认识该城镇的每一个供应商(服务提供者)，并且由于他已经授权给你(你是他的朋友)，所以每一个其他供应商无需任何进一步的询问就向你提供他们的服务。”</p><p id="2561" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它具有以下优势:</p><ul class=""><li id="af24" class="lv lw iq jp b jq jr ju jv jy lx kc ly kg lz kk ma mb mc md bi translated">不需要输入凭证</li><li id="1529" class="lv lw iq jp b jq me ju mf jy mg kc mh kg mi kk ma mb mc md bi translated">无需记住和更新密码</li><li id="0406" class="lv lw iq jp b jq me ju mf jy mg kc mh kg mi kk ma mb mc md bi translated">没有弱密码</li></ul><p id="27b8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">SAML的实现似乎是合乎逻辑的，因为大多数组织在用户登录到他们的Active Directory域或Intranet时已经知道他们的身份。因此，让用户登录其他第三方应用程序，如web-app应用程序(gmail、Outlook、微软Office等)也是有意义的。</p></div><div class="ab cl kl km hu kn" role="separator"><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq"/></div><div class="ij ik il im in"><h1 id="f0a0" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">SAML认证是如何工作的？</h1><p id="dd04" class="pw-post-body-paragraph jn jo iq jp b jq lq js jt ju lr jw jx jy ls ka kb kc lt ke kf kg lu ki kj kk ij bi translated">在我们进入技术解释之前，让我们先来看几个术语。</p><ul class=""><li id="2672" class="lv lw iq jp b jq jr ju jv jy lx kc ly kg lz kk ma mb mc md bi translated"><strong class="jp ir">身份提供者:</strong>身份提供者(IdP)是一种存储和验证用户身份的服务。IDP通常是云托管的服务，它们通常与单点登录(SSO)提供商合作来验证用户。</li><li id="fb05" class="lv lw iq jp b jq me ju mf jy mg kc mh kg mi kk ma mb mc md bi translated"><strong class="jp ir">服务提供者:</strong>信任身份提供者并授权给定用户访问所请求的资源。</li><li id="18b6" class="lv lw iq jp b jq me ju mf jy mg kc mh kg mi kk ma mb mc md bi translated"><strong class="jp ir"> SAML断言:</strong>由身份提供者发送给服务提供者的包含用户授权的XML文档。这是通过HTTP浏览器重定向发送的。</li></ul><p id="b450" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有3种类型的SAML断言:</p><ul class=""><li id="b7ef" class="lv lw iq jp b jq jr ju jv jy lx kc ly kg lz kk ma mb mc md bi translated"><strong class="jp ir">认证声明</strong>证明用户的身份，同时产生用户的登录时间&amp;所使用的认证方法。</li></ul><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div class="gh gi mj"><img src="../Images/c0a78d397740f010763eaa77352ea0f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1046/1*zVOZDYB1JDLTEFVzhjgZmQ.gif"/></div><figcaption class="mr ms gj gh gi mt mu bd b be z dk translated">SAML身份验证断言示例</figcaption></figure><ul class=""><li id="aa3f" class="lv lw iq jp b jq jr ju jv jy lx kc ly kg lz kk ma mb mc md bi translated"><strong class="jp ir">属性断言</strong>为服务提供者提供SAML属性。SAML属性是关于登录用户的数据。</li></ul><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/3c550ef2f89b60a5a20dd74cb165d919.png" data-original-src="https://miro.medium.com/v2/resize:fit:1008/1*zURstj9wamu4SZ2sXjmTyg.gif"/></div><figcaption class="mr ms gj gh gi mt mu bd b be z dk translated">SAML属性断言示例</figcaption></figure><ul class=""><li id="e872" class="lv lw iq jp b jq jr ju jv jy lx kc ly kg lz kk ma mb mc md bi translated"><strong class="jp ir">授权声明</strong>包含某个用户已经被授权访问指定资源的证明。</li></ul><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div class="gh gi mw"><img src="../Images/92b24927d6117f5e28877924d70867be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1006/1*zRlhwLMsE62nrcg0RlyTbQ.gif"/></div><figcaption class="mr ms gj gh gi mt mu bd b be z dk translated">SAML授权<em class="mx">断言示例</em></figcaption></figure><p id="0dd1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Microsoft Active Directory或Azure是常见的身份提供者。Salesforce和其他CRM安排通常是专业合作，因为它们依赖身份提供商进行客户验证。</p><p id="0aa8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以让我们试着理解这一切。</p><p id="e759" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">假设您登录了一个充当身份提供者(Microsoft AD)的系统。让我们假设用户也想访问任何第三方应用程序，如Salesforce。</p><p id="cbd6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上面的SAML身份验证流程看起来像这样:</p><ol class=""><li id="b8b1" class="lv lw iq jp b jq jr ju jv jy lx kc ly kg lz kk my mb mc md bi translated">你可以通过互联网访问任何微软的广告。</li><li id="4a13" class="lv lw iq jp b jq me ju mf jy mg kc mh kg mi kk my mb mc md bi translated">应用程序Microsoft AD识别您，即用户，并将您重定向到身份提供者(IdP ),提示您输入有效的凭证(用户名、密码&amp;可能还有您的2fa身份验证)。这就是身份验证请求的样子。</li><li id="b603" class="lv lw iq jp b jq me ju mf jy mg kc mh kg mi kk my mb mc md bi translated">现在，您可以通过登录身份提供者来建立会话。</li><li id="fc90" class="lv lw iq jp b jq me ju mf jy mg kc mh kg mi kk my mb mc md bi translated">身份提供者以XML文档的形式制作和验证响应，其中包含电子邮件、用户名等用户数据，现在身份提供者使用<a class="ae mz" href="https://www.ssl.com/faqs/what-is-an-x-509-certificate/" rel="noopener ugc nofollow" target="_blank"> X.509 </a>证书对该文档进行签名。</li><li id="daaa" class="lv lw iq jp b jq me ju mf jy mg kc mh kg mi kk my mb mc md bi translated">现在，当登录Microsoft AD(身份提供商)时，您尝试访问第三方应用程序，如Salesforce(服务提供商)。您从Salesforce请求资源，它会通过SAML请求将您重定向到身份提供商(即Microsoft AD)。</li><li id="4de4" class="lv lw iq jp b jq me ju mf jy mg kc mh kg mi kk my mb mc md bi translated">SAML请求通过浏览器(用户代理)传递给身份提供者(Microsoft AD ),后者现在向浏览器(用户代理)发回一个SAML响应(XML文档),该响应是之前在步骤4中制作的，并用X.509证书进行了数字签名。</li><li id="bd69" class="lv lw iq jp b jq me ju mf jy mg kc mh kg mi kk my mb mc md bi translated">浏览器(用户代理)现在将相同的SAML响应传递回服务提供商(Salesforce)。</li><li id="bb9d" class="lv lw iq jp b jq me ju mf jy mg kc mh kg mi kk my mb mc md bi translated">服务提供商(Salesforce)在通过浏览器(用户代理)从身份提供商(Microsoft AD)收到SAML响应后，现在无需要求凭据即可对用户进行身份验证。</li></ol><blockquote class="na nb nc"><p id="fd0e" class="jn jo nd jp b jq jr js jt ju jv jw jx ne jz ka kb nf kd ke kf ng kh ki kj kk ij bi translated">请注意，在整个过程中，服务提供商知道身份提供商的存在，这也是服务提供商信任身份提供商来认证任何用户的原因。</p></blockquote><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="ni nj di nk bf nl"><div class="gh gi nh"><img src="../Images/0e2a6e468eab866a1bee2bb4bf809436.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fKv4cWqciTI9KQsTsFlkKA.png"/></div></div><figcaption class="mr ms gj gh gi mt mu bd b be z dk translated">SAML流可视化。</figcaption></figure><p id="bc67" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">综上所述，我认为SAML身份验证允许您访问一个服务，最终允许您访问所有其他相关服务。</p></div><div class="ab cl kl km hu kn" role="separator"><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq"/></div><div class="ij ik il im in"><h1 id="874d" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated"># SAML配置</h1><p id="1823" class="pw-post-body-paragraph jn jo iq jp b jq lq js jt ju lr jw jx jy ls ka kb kc lt ke kf kg lu ki kj kk ij bi translated">任何SAML配置都是在SAML的两个关联实体上完成的，即IdP和SP。IdP的配置很重要，因为它应该知道当用户尝试访问任何SP时应该被重定向到哪里。并且需要配置SP，因为它需要知道IdP发送的SAML断言是可信的。</p><p id="467b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">配置IdP </strong></p><p id="bec7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">SAML断言格式由SP提供，由IdP设置。以下是任何管理员都需要设置的任何SAML断言的几个关键元素。</p><p id="3b42" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> # EntityID: </strong>对任何SP来说都是独一无二的名字。格式/语法可能会有所不同。参见下面的例子。</p><pre class="mk ml mm mn gt nm nn no np aw nq bi"><span id="e166" class="nr kt iq nn b gy ns nt l nu nv">&lt;EntityDescriptor<!-- --> <!-- -->entityID="urn:mace:incommon:example.edu"&gt;</span></pre><p id="fbf4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> #断言消费者服务(ACS):</strong>SAML断言将被发送到的URL的位置。参见下面的例子</p><pre class="mk ml mm mn gt nm nn no np aw nq bi"><span id="c126" class="nr kt iq nn b gy ns nt l nu nv">https://example.edu/SAML/consume</span></pre><p id="8ffd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> # ACS验证器:</strong>正则表达式形式的安全机制，确保SAML断言到达指定的ACS。</p><pre class="mk ml mm mn gt nm nn no np aw nq bi"><span id="49e6" class="nr kt iq nn b gy ns nt l nu nv">^https:\/\/example\.edu\/saml\/consume\/$</span></pre><p id="3df8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> #属性:</strong>SAML断言属性包含用户的信息。</p><pre class="mk ml mm mn gt nm nn no np aw nq bi"><span id="89c1" class="nr kt iq nn b gy ns nt l nu nv">&lt;saml:AttributeStatement&gt;<br/>    &lt;saml:Attribute FriendlyName="fooAttrib" Name="SFDC_USERNAME" NameFormat="urn:oasis:names:tc:SAML:2.0:attrname-format:unspecified"&gt;<br/>        &lt;saml:AttributeValue xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="xs:string"&gt;<br/>            user@example.edu<br/>        &lt;/saml:AttributeValue&gt;<br/>    &lt;/saml:Attribute&gt;<br/> &lt;/saml:AttributeStatement&gt;</span></pre><p id="9462" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> SP配置</strong></p><p id="9aec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里，我们处理的信息由IdP提供，并在SP上设置。</p><p id="24e4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"># x . 509 Certificate:</strong>IdP提供的证书，通过SAML断言传递，用于验证公钥。</p><p id="2a8b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> # Issuer URL: </strong>包含关于IdP的信息，以便验证从IdP提供的URL接收的SAML断言。</p><pre class="mk ml mm mn gt nm nn no np aw nq bi"><span id="6fc0" class="nr kt iq nn b gy ns nt l nu nv">&lt;saml:Issuer&gt;https://example.edu/saml/id/metadata.php&lt;/saml:Issuer&gt;</span></pre><blockquote class="na nb nc"><p id="5926" class="jn jo nd jp b jq jr js jt ju jv jw jx ne jz ka kb nf kd ke kf ng kh ki kj kk ij bi translated"><a class="ae mz" href="https://duo.com/blog/the-beer-drinkers-guide-to-saml" rel="noopener ugc nofollow" target="_blank">在此阅读更多关于SAML配置的信息</a></p></blockquote></div><div class="ab cl kl km hu kn" role="separator"><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq"/></div><div class="ij ik il im in"><h1 id="f767" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">#漏洞和攻击</h1><p id="9e23" class="pw-post-body-paragraph jn jo iq jp b jq lq js jt ju lr jw jx jy ls ka kb kc lt ke kf kg lu ki kj kk ij bi translated">既然我们已经了解了SAML的基本概念，现在我们可以继续讨论与SAML相关的攻击和漏洞。显然，我无法在这里一一解释，所以我会在这里列出一些参考资料。在我的下一篇文章中，我可能会解释它们，然后阅读这里的参考资料。</p><p id="c1e8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"># 1.<a class="ae mz" href="https://www.youtube.com/watch?v=h7ViO5YUuFA" rel="noopener ugc nofollow" target="_blank">身份盗窃攻击</a></p><p id="69e9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"># 2.<a class="ae mz" href="https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps" rel="noopener ugc nofollow" target="_blank">金色样品</a></p><p id="903b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"># 3.<a class="ae mz" href="https://www.idm-360.com/idm360/the-dangers-of-saml-replay-attacks/" rel="noopener ugc nofollow" target="_blank"> SAML重放攻击</a></p><p id="3d8e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"># 4.<a class="ae mz" href="https://advisories.dxw.com/advisories/publicly-exploitable-command-injection-in-ruby-saml-0-7-2-library-can-root-the-host/" rel="noopener ugc nofollow" target="_blank"> SAML命令注入</a></p><p id="ac4d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">参考资料:</p><ul class=""><li id="c8d4" class="lv lw iq jp b jq jr ju jv jy lx kc ly kg lz kk ma mb mc md bi translated"><a class="ae mz" href="https://docs.oracle.com/cd/E27515_01/common/tutorials/authz_saml_assertion.html" rel="noopener ugc nofollow" target="_blank">https://docs . Oracle . com/CD/e 27515 _ 01/common/tutorials/authz _ SAML _ assertion . html</a></li><li id="6a41" class="lv lw iq jp b jq me ju mf jy mg kc mh kg mi kk ma mb mc md bi translated"><a class="ae mz" href="https://duo.com/blog/the-beer-drinkers-guide-to-saml" rel="noopener ugc nofollow" target="_blank">https://duo.com/blog/the-beer-drinkers-guide-to-saml</a></li><li id="943c" class="lv lw iq jp b jq me ju mf jy mg kc mh kg mi kk ma mb mc md bi translated"><a class="ae mz" href="https://developers.onelogin.com/saml" rel="noopener ugc nofollow" target="_blank">https://developers.onelogin.com/saml</a></li><li id="df6e" class="lv lw iq jp b jq me ju mf jy mg kc mh kg mi kk ma mb mc md bi translated"><a class="ae mz" href="https://www.varonis.com/blog/what-is-saml/" rel="noopener ugc nofollow" target="_blank">https://www.varonis.com/blog/what-is-saml/</a></li></ul><p id="c28a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在推特上关注我:<a class="ae mz" href="https://twitter.com/mr_fr3qu3n533" rel="noopener ugc nofollow" target="_blank"> @mr_fr3qu3n533 </a></p></div></div>    
</body>
</html>