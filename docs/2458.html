<html>
<head>
<title>JSON Web Tokens</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">JSON Web令牌</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/json-web-tokens-409297c260a0?source=collection_archive---------1-----------------------#2022-10-19">https://infosecwriteups.com/json-web-tokens-409297c260a0?source=collection_archive---------1-----------------------#2022-10-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="a8aa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">作者:<a class="ae kl" href="https://www.instagram.com/_ansh_vyas/" rel="noopener ugc nofollow" target="_blank">安舒尔·维亚斯</a></p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/f9bdf76f3789889cb494d95cf17d2c75.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*OwMRq_BpKWunzyrc.png"/></div></div></figure><h1 id="dc47" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">介绍</h1><p id="e394" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">一个名为JSON Web Token的开放行业标准用于在两个实体之间交换数据，这两个实体通常是客户端(如应用程序的前端)和服务器(如应用程序的后端)。它们包括JSON对象，这些对象包含了需要交流的必要信息。为了确保JSON内容(也称为JWT声明)不能被客户端或恶意方更改，每个JWT都使用加密技术(哈希)进行了额外的签名。</p><h1 id="6f10" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">代币</h1><p id="c465" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">您可能会问，为什么认证服务器将数据转换成“令牌”,而不只是作为普通的JSON对象发送。如果认证服务器以普通JSON格式发送，客户端应用程序的API将无法确认他们正在<br/>获取的材料是否准确。例如，应用程序的API无法知道恶意攻击者是否更改了用户ID(上面JSON示例中的子声明)。由于这种安全考虑，身份验证服务器必须以客户端应用程序可以验证的方式传递这些数据。这就是“令牌”的概念出现的地方。</p><p id="be98" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">简而言之，令牌是包含可以安全检查的数据的字符串。它可能由随机的字母数字字符序列组成，导致数据库中的ID，也可能是客户端可以自我验证的编码JSON(称为jwt)。</p><h1 id="2512" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">JSON Web令牌结构</h1><p id="93d3" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">JWT由三部分组成:</p><ul class=""><li id="9680" class="mb mc iq jp b jq jr ju jv jy md kc me kg mf kk mg mh mi mj bi translated"><strong class="jp ir">表头:</strong>分为两段- <br/> 1。正在应用的签名方法。<br/> 2。令牌的种类，在本例中通常为“JWT”。</li><li id="9ff5" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mg mh mi mj bi translated"><strong class="jp ir">有效负载:</strong>断言在有效负载中。注册声明列表包括“发行人”、“有效期”、“主题”和“aud”(受众)等术语。虽然不是必需的，但是这些声明提供了一组实用的、可互操作的断言。建立定制声明的附加参数，例如雇员角色，也可以包括在有效载荷中。通常，OpenID连接用户主题是使用主题claim创建的。不过，Liberty JVM服务器可能被设置为使用不同的声明。JWT的第二个组成部分是有效负载，它已经过Base64Url编码。</li><li id="3747" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mg mh mi mj bi translated"><strong class="jp ir">签名:</strong>由加密技术产生的字符串被称为签名，它可以用来检查JSON负载的完整性。</li></ul><h1 id="c8db" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">如何使用签名来确保身份验证</h1><p id="894e" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">为了确保认证，我们使用签名:</p><ol class=""><li id="ed0b" class="mb mc iq jp b jq jr ju jv jy md kc me kg mf kk mp mh mi mj bi translated">用户向认证服务器发送登录和密码，该服务器可能是也可能不是我们的应用服务器，但通常是不同的服务器。</li><li id="b8f6" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mp mh mi mj bi translated">身份验证服务器验证输入的用户名和密码，然后生成一个JWT令牌，将用户的技术身份和到期时间戳作为有效负载的一部分。</li><li id="d6f4" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mp mh mi mj bi translated">使用秘密密钥，认证服务器在将报头和有效载荷发送回用户的浏览器之前对其进行签名(我们将在后面详细介绍签名是如何工作的)</li><li id="4d40" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mp mh mi mj bi translated">浏览器获取签名的JWT，并开始将它与每个HTTP请求一起传递给我们的应用服务器。</li><li id="df28" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mp mh mi mj bi translated">签名的JWT本质上充当临时用户凭证，代替充当永久凭证的用户名和密码。</li></ol><h1 id="69e8" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">在哪里存储JSON Web令牌</h1><p id="2d49" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">我将尝试简单地介绍一下，但是因为我不是安全方面的专家，所以我更愿意让您了解其他外部资源。jwt是护照，所以要时刻记住这一点。获得用户令牌访问权限的人能够代表您提交请求。情况不妙。本地存储中的令牌存储很常见，因为它很方便。然而，这并不是最安全的做法。它有很高的XSS风险(跨站点脚本)。将令牌保存在HttpOnly cookie中比保存在标准cookie中更好。尽管它更能抵抗XSS的攻击，但CSRF的攻击仍然是可能的。显然，这可能会给CORS政策带来麻烦，但是，嘿，我们正在处理安全问题。</p><h1 id="a3c5" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">如果我想加密我的令牌怎么办？</h1><p id="7c6a" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">在某些情况下，您可能希望加密您的令牌，以防止劫持者阅读您的声明。大多数情况下，服务器到服务器的通信使用这种方式。那是完全可以的；只要另一端能够安全地解码和显示令牌，您就可以随意加密您的令牌。无论哪种情况，请记住，使用HTTPS进行通信是必需的，并且可以极大地提高通信安全性。</p><p id="e63e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">示例:</p><pre class="kn ko kp kq gt mq mr ms mt aw mu bi"><span id="8deb" class="mv kz iq mr b gy mw mx l my mz">eyJhbGciOiJIUzI1NiJ9.eyJuYW1lIjoiSm9lIENvZGVyIn0.5dlp7GmziL2QS06sZgK4mtaqv0_xX4oFUuTDh1zHK4U</span></pre><p id="28bb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们的各个部分细分如下:</p><pre class="kn ko kp kq gt mq mr ms mt aw mu bi"><span id="e9d0" class="mv kz iq mr b gy mw mx l my mz">eyJhbGciOiJIUzI1NiJ9 # header .<br/>eyJuYW1lIjoiSm9lIENvZGVyIn0 # payload .<br/>5dlp7GmziL2QS06sZgK4mtaqv0_xX4oFUuTDh1zHK4U #signature</span></pre><h1 id="f1c5" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">JSON Web令牌是如何工作的？</h1><p id="a5d1" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">为了演示JSON Web Token如何工作，让我们以用户登录为例。在使用JWT之前，您必须定义一个密钥(称为“秘密”)。一旦用户成功提供了他们的登录详细信息，JWT将与密钥一起返回并保存在本地。为了保证数据的安全，传输应该在HTTPS进行。</p><p id="1432" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">每当用户试图访问受保护的资源(如API或受保护的路由)时，JWT将作为参数或授权头从用户代理传递。在成功审查之后，通信伙伴可以解密JSON Web令牌并执行查询。</p><h1 id="5062" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">JSON WEB令牌是用来做什么的？</h1><p id="86a6" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">相对于传统的基于cookie的认证和授权方法，jwt提供了一些好处。这有助于它们在以下情况下被接受:</p><ul class=""><li id="6400" class="mb mc iq jp b jq jr ju jv jy md kc me kg mf kk mg mh mi mj bi translated">使用rest的应用程序:由于身份验证信息随请求一起提供，REST应用程序确保了无状态协议。</li><li id="a601" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mg mh mi mj bi translated">源之间的资源共享:jwt传输数据作为跨源共享资源的一部分。与通常不能作为此过程的一部分交付的cookies相比，这提供了显著的好处。</li><li id="e5a3" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mg mh mi mj bi translated">在不同的环境中使用:JWT是标准化的。如果使用许多框架，与身份验证相关的数据可以更容易地交换。</li></ul><h1 id="0694" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">创建JSON Web令牌的步骤</h1><p id="16ec" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">为了建立JWT，采取了后续的动作。在流程的输入和输出之间没有关系的情况下，阶段的顺序并不重要。</p><ol class=""><li id="e27f" class="mb mc iq jp b jq jr ju jv jy md kc me kg mf kk mp mh mi mj bi translated">将所需索赔作为JWT索赔集的一部分。应该注意的是，在表示中明确允许空白，并且在编码之前不需要规范化表示。</li><li id="875c" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mp mh mi mj bi translated">使JWT声明集成为消息八位字节的UTF-8表示。</li><li id="64a1" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mp mh mi mj bi translated">将适当的标题参数设置到JOSE标题中。要求JWT遵守[JWS]或[JWE]标准。应该注意的是，在表示中明确允许空白，并且在编码之前不需要规范化表示。</li><li id="4af4" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mp mh mi mj bi translated">根据JWT是JWS还是JWE，有两种情况:如果JWT是JWS，则使用消息作为JWS有效载荷来创建JWS；必须遵循[JWS]中关于建造JWS的说明。否则，如果JWT是一个JWE，使用消息作为明文创建一个JWE，确保遵循[JWE]中的所有说明。</li><li id="52f5" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mp mh mi mj bi translated">如果将执行嵌套签名或加密操作，则返回到步骤3，在该步骤中产生的新JOSE报头中使用“JWT”的" cty "(内容类型)值。让消息成为JWS或JWE。</li><li id="7ced" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mp mh mi mj bi translated">如果不是，使结果JWT成为JWS或JWE。</li></ol><h1 id="7674" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">验证JSON Web令牌的步骤</h1><p id="d133" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">这些操作在验证JWT时进行。在流程的输入和输出之间没有关系的情况下，阶段的顺序并不重要。如果任何指定的阶段失败，JWT必须被拒绝，或者被应用程序作为无效输入处理。</p><ol class=""><li id="cb1e" class="mb mc iq jp b jq jr ju jv jy md kc me kg mf kk mp mh mi mj bi translated">请确保至少有一个句点(' . '))JWT中的人物。</li><li id="d27c" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mp mh mi mj bi translated">制作第一个句点('.'之前的JWT部分)字符编码的JOSE头。</li><li id="9fd8" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mp mh mi mj bi translated">Base64url解码编码的JOSE头，同时记住没有使用额外的字符，如空白或换行符。</li><li id="dd82" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mp mh mi mj bi translated">确认产生的八位字节序列是符合RFC 7159 [RFC7159]的完全合法的JSON对象的UTF-8编码表示；JOSE头应该是这个JSON对象。</li><li id="9cd0" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mp mh mi mj bi translated">检查只有其语法和语义得到支持和理解的参数和值，或者在不理解时被指定为被忽略的参数和值，才被包含在最终的JOSE头中。</li><li id="bef9" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mp mh mi mj bi translated">使用[JWE]第9节中概述的技术之一来确定JWT是JWS还是JWE。</li><li id="b0f5" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mp mh mi mj bi translated">根据JWT是JWS还是JWE，有两种情况:<br/> *如果JWT是JWS，根据【JWS指令】验证JWS。让JWS有效负载的base64url解码产生消息。<br/> *否则，如果JWT是JWE，继续进行【JWEinstructions】的验证JWE。让生成的明文成为消息。</li><li id="32a9" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mp mh mi mj bi translated">如果JOSE头中的“cty”(内容类型)值是“JWT”，则消息是经过嵌套签名或加密过程的JWT。在这种情况下，返回到步骤1，用消息替换JWT。</li><li id="376a" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mp mh mi mj bi translated">如果没有，base64url解码消息，同时遵守没有使用额外字符(如空白或换行符)的要求。</li><li id="0bd5" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mp mh mi mj bi translated">确认产生的八位字节序列是完全合法的符合RFC 7159 [RFC7159]的JSON对象的UTF-8编码表示；JWT声明集应该是这个JSON对象。</li><li id="9ab5" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mp mh mi mj bi translated">最后，请记住，在特定情况下可能应用的算法的选择取决于应用程序。即使可以正确验证JWT，应用程序也应该拒绝JWT，除非应用程序可以接受JWT中使用的算法。</li></ol><h1 id="c439" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated"><strong class="ak">jwt的优势</strong></h1><p id="0162" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">使用JWT有很多好处，包括:</p><p id="eaae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">安全</strong>:由于数字签名使用了秘密密钥(HMAC)或公钥/私钥组合(RSA或ECDSA)，jwt受到保护，不会被客户端或攻击者修改。</p><p id="d96f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">存储在客户端的存储器上</strong>:jwt在服务器上创建，然后发送到客户端。然后，JWT由客户端随每个请求一起发送。这减少了数据库空间的使用。</p><p id="18c0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">有效/无状态</strong>:由于JWT不需要数据库搜索，因此可以快速验证。特别是在大型分散系统中，这很有帮助。</p><h1 id="d0cb" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated"><strong class="ak">jwt的缺点</strong></h1><p id="d1da" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">使用JWT一些缺点是:</p><p id="dec5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">不可撤销</strong>:由于jwt是独立的，并且使用无状态技术进行验证，因此在它自然过期之前取消它可能会很困难。因此，很难执行像立即禁止用户这样的措施。话虽如此，有一种技术可以让JWT拒绝/黑名单保持最新，通过这样做，我们可以立即撤销它们。</p><p id="0ea0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">依赖单个密钥</strong>:构造一个JWT需要一个密钥。攻击者可以创建他们自己的jwt，如果密钥泄露，API层将接受这些jwt。这表明如果密钥泄露，攻击者可以冒充任何用户的身份。通过定期更换密钥，我们可以降低这种危险。</p><h1 id="df93" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated"><strong class="ak">结论</strong></h1><p id="d42d" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">JWT比其他web令牌简单得多，因为它基于JSON，比XML更容易掌握。其他web令牌包括简单Web令牌(swt)和安全声明标记语言(SAML)。如果我们对JSON进行加密，它的大小甚至会比SAML更小，这使得它更容易在HTML和HTTP上下文中传递。swt使用单个密钥来保证安全，但是JWT和SAML都使用公钥和私钥对来进行更强的认证。说到使用，jwt在互联网上盛行。换句话说，无论是笔记本电脑还是智能手机，在用户的设备上处理都更简单。</p><p id="dbaf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">除了身份验证之外，JSON Web令牌是在多方之间传输数据的一种奇妙而安全的方法。每个人都可以更容易地识别信息的发送者，因为jwt包含签名。你只需要一把正确的钥匙。</p></div><div class="ab cl na nb hu nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="ij ik il im in"><h2 id="175e" class="mv kz iq bd la nh ni dn le nj nk dp li jy nl nm lm kc nn no lq kg np nq lu nr bi translated">来自Infosec的报道:Infosec每天都有很多内容，很难跟上。<a class="ae kl" href="https://weekly.infosecwriteups.com/" rel="noopener ugc nofollow" target="_blank">加入我们的每周简讯</a>以5篇文章、4条线索、3个视频、2个GitHub Repos和工具以及1个工作提醒的形式免费获取所有最新的Infosec趋势！</h2></div></div>    
</body>
</html>