<html>
<head>
<title>Hacking Microservices For Fun and Bounty</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">黑客微服务的乐趣和赏金</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/hacking-microservices-for-fun-and-bounty-5cc302769e94?source=collection_archive---------0-----------------------#2021-07-06">https://infosecwriteups.com/hacking-microservices-for-fun-and-bounty-5cc302769e94?source=collection_archive---------0-----------------------#2021-07-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="b601" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">了解微服务的工作原理和破解方法。</h2></div><p id="83fe" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">微服务最近备受关注，它们即将成为主流，根据Nginx 、<em class="lc">最近的<a class="ae lb" href="https://www.nginx.com/resources/library/app-dev-survey/" rel="noopener ugc nofollow" target="_blank">调查，36%的受访企业</a></em>、<em class="lc">目前正在使用微服务，另有26%的企业</em>处于研究阶段。但是什么是微服务架构呢？</p><p id="fcf8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">从渗透测试人员或Bug赏金猎人的角度来看，在实际测试破解技术之前，首先了解技术的核心工作是非常重要的。所以今天我们来深入研究一下微服务。</p><h1 id="325a" class="ld le iq bd lf lg lh li lj lk ll lm ln jw lo jx lp jz lq ka lr kc ls kd lt lu bi translated">什么是微服务？</h1><p id="1aa4" class="pw-post-body-paragraph kf kg iq kh b ki lv jr kk kl lw ju kn ko lx kq kr ks ly ku kv kw lz ky kz la ij bi translated"><strong class="kh ir">微服务</strong>是一种架构风格，它将应用程序构建为小型自治服务的集合，围绕<strong class="kh ir">业务领域进行建模。它帮助不同的服务在它们的pod中独立运行，并在彼此之间高效地传输数据，而不太依赖彼此。</strong></p><figure class="mb mc md me gt mf gh gi paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="gh gi ma"><img src="../Images/18c77e63db6d748bca88d0b7946ab124.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*otxhz3jtRLE5FZskm_uhDw.png"/></div></div><figcaption class="mm mn gj gh gi mo mp bd b be z dk translated">来源:https://www.edureka.co</figcaption></figure><h2 id="a0d2" class="mq le iq bd lf mr ms dn lj mt mu dp ln ko mv mw lp ks mx my lr kw mz na lt nb bi translated"><strong class="ak">微服务与Monolith和Rest APIs有何不同？</strong></h2><p id="af30" class="pw-post-body-paragraph kf kg iq kh b ki lv jr kk kl lw ju kn ko lx kq kr ks ly ku kv kw lz ky kz la ij bi translated">传统架构(Monoliths和RESTful APIs)和微服务之间的根本区别在于它们在应用程序中共享资源和服务的方式。所有服务都根据其领域和功能进行分离，并进一步分配给各个微服务。微服务架构中的每个服务都是<strong class="kh ir">自包含的</strong>，并且实现了<strong class="kh ir">单一业务能力</strong>，如用户认证、搜索等等。</p><p id="e7d2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这些微服务有它们自己的<strong class="kh ir">负载平衡器</strong>和<strong class="kh ir">执行环境</strong>来执行它们的功能&amp;，同时在它们自己的数据库中捕获数据。所有内部点都从API网关连接。因此，任何连接到API网关的人都会自动连接到整个系统</p><figure class="mb mc md me gt mf gh gi paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="gh gi nc"><img src="../Images/fab22280747bfdae0d404a2c9f92c3d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zF9jZ63rn_sZiMX6euRsmw.png"/></div></div></figure><h1 id="6cc2" class="ld le iq bd lf lg lh li lj lk ll lm ln jw lo jx lp jz lq ka lr kc ls kd lt lu bi translated">侵入服务系统。</h1><p id="3105" class="pw-post-body-paragraph kf kg iq kh b ki lv jr kk kl lw ju kn ko lx kq kr ks ly ku kv kw lz ky kz la ij bi translated">微服务通过增加交互的复杂性来利用代码的复杂性，而更多的复杂性会导致更多的错误。根据许多研究，<strong class="kh ir"> <em class="lc">微服务被认为比传统的单片应用</em> </strong>更易受到攻击。由于其分布式结构，每个服务API和网络层都将易受攻击的入口点暴露给潜在的攻击媒介。</p><figure class="mb mc md me gt mf gh gi paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="gh gi nd"><img src="../Images/17118e2899b3ac3021503db94729ce7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dA_g199KIlqL6ulRMab0kA.png"/></div></div></figure><p id="cda0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">通常，通过实现API网关来保护服务调用，API网关充当接收调用的<strong class="kh ir">单一入口点，然后将流量路由到不同的服务。这种通过身份验证获得单一入口点的方法有其优点和缺点。有时候攻击者只需要绕过BFF/API网关就可以控制整个架构。这对任何公司来说都是最糟糕的噩梦</strong></p><p id="b86c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">理论上，API网关限制了攻击面；然而，这也是潜在攻击媒介的<strong class="kh ir">单点故障。大多数情况下，认证部分由网关控制，如果被绕过，就会变得更加危险。最近的研究还表明，大多数传统的攻击手段都是通过API调用来攻击应用程序。</strong></p></div><div class="ab cl ne nf hu ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ij ik il im in"><h1 id="95b9" class="ld le iq bd lf lg nl li lj lk nm lm ln jw nn jx lp jz no ka lr kc np kd lt lu bi translated">进入内部…</h1><p id="ff5a" class="pw-post-body-paragraph kf kg iq kh b ki lv jr kk kl lw ju kn ko lx kq kr ks ly ku kv kw lz ky kz la ij bi translated">有许多方法可以绕过API网关进入系统内部并进行进一步的攻击。我们来讨论一下。</p><h2 id="a2f2" class="mq le iq bd lf mr ms dn lj mt mu dp ln ko mv mw lp ks mx my lr kw mz na lt nb bi translated">你在和谁说话？？</h2><p id="5059" class="pw-post-body-paragraph kf kg iq kh b ki lv jr kk kl lw ju kn ko lx kq kr ks ly ku kv kw lz ky kz la ij bi translated">每当进行服务调用时，它很可能会通过API网关，并且网关会在所请求的路径上执行许多操作，例如路由和路径规范化。</p><p id="6ebf" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您知道您在与哪些服务对话，那么继续攻击就变得很容易了。确保您的调用被内部架构监听可以帮助您进行路径遍历、目录暴力等攻击。</p><figure class="mb mc md me gt mf gh gi paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="gh gi nq"><img src="../Images/6037c7d44600b8ce235659ad1a74c607.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V3IbaDpYaalrKmfwqP-PhA.png"/></div></div><figcaption class="mm mn gj gh gi mo mp bd b be z dk translated">API网关正在过滤请求</figcaption></figure><figure class="mb mc md me gt mf gh gi paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="gh gi nr"><img src="../Images/78222d4639d59cd0c175ae13edc4c100.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dXgBJajzmKWwXdZ_1h3pHA.png"/></div></div><figcaption class="mm mn gj gh gi mo mp bd b be z dk translated">请求已被侦听，并且正在由内部微服务响应。</figcaption></figure><p id="fa2f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在上面的图片中，您可以看到2个请求以几乎相同的路径发送到同一个主机，但响应完全不同。</p><p id="35cd" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这里，网关对所请求的路径执行检查，并确保微服务在转发请求之前确实存在(在本例中为“auth”微服务)。如果路径存在，那么我把请求转移到前面。</p><p id="2810" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在实际的攻击场景中，攻击者可以执行路径遍历攻击，使API网关将请求路由到微服务的根，从而允许他们在没有任何身份验证的情况下在系统内做任何事情。</p><p id="046c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">不同的响应有助于攻击者了解哪些服务受到攻击。这使得目录暴力变得非常容易，因为只要知道一些服务，他们就可以发现一些隐藏的端点。</p><h2 id="040b" class="mq le iq bd lf mr ms dn lj mt mu dp ln ko mv mw lp ks mx my lr kw mz na lt nb bi translated">识别应用程序路由。</h2><p id="6e0c" class="pw-post-body-paragraph kf kg iq kh b ki lv jr kk kl lw ju kn ko lx kq kr ks ly ku kv kw lz ky kz la ij bi translated">路由是为网络中或多个网络之间的流量选择路径的过程。这是应用程序安全性最重要的方面，如果没有正确实施，可能会导致信息泄露。</p><p id="65b6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们必须执行一些检查，看看应用程序是如何将请求路由到内部架构的。</p><ol class=""><li id="aec7" class="ns nt iq kh b ki kj kl km ko nu ks nv kw nw la nx ny nz oa bi translated"><strong class="kh ir">执行目录遍历</strong></li></ol><ul class=""><li id="35d8" class="ns nt iq kh b ki kj kl km ko nu ks nv kw nw la ob ny nz oa bi translated">尝试查看<strong class="kh ir"> "/v1/auth" </strong>是否返回除<strong class="kh ir"> "/v1/auth/user/之外的其他内容../</strong></li><li id="8d87" class="ns nt iq kh b ki oc kl od ko oe ks of kw og la ob ny nz oa bi translated">是否在不检查路径的情况下传输请求？<strong class="kh ir"> "/v1/auth/../../database" </strong>被传递到内部架构，即使<em class="lc">数据库</em>服务不存在。</li></ul><p id="f8b1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">2.<strong class="kh ir">用随机输入破坏应用</strong></p><ul class=""><li id="8240" class="ns nt iq kh b ki kj kl km ko nu ks nv kw nw la ob ny nz oa bi translated">我们可以尝试使用不同的控制字符来模糊应用程序<strong class="kh ir">，例如</strong></li></ul><blockquote class="oh oi oj"><p id="d96d" class="kf kg lc kh b ki kj jr kk kl km ju kn ok kp kq kr ol kt ku kv om kx ky kz la ij bi translated"><strong class="kh ir"> <em class="iq"> %23 (#)，%3f(？)、%26 ( &amp;)、%2e(。)、%2f (/)、% 40(@)</em>T11】</strong></p></blockquote><ul class=""><li id="b923" class="ns nt iq kh b ki kj kl km ko nu ks nv kw nw la ob ny nz oa bi translated">以双重/三重URL编码提供输入</li></ul><p id="79f1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">3.注意微小的变化。</p><ul class=""><li id="68e0" class="ns nt iq kh b ki kj kl km ko nu ks nv kw nw la ob ny nz oa bi translated">API网关的<strong class="kh ir">根("/") </strong>是否给出了一些信息？</li><li id="f492" class="ns nt iq kh b ki oc kl od ko oe ks of kw og la ob ny nz oa bi translated">某些目录的行为会突然改变吗？</li><li id="88c4" class="ns nt iq kh b ki oc kl od ko oe ks of kw og la ob ny nz oa bi translated">为什么<strong class="kh ir"> "/v1/auth" </strong>返回的头与<strong class="kh ir"> "/v1/auth/register" </strong>不同？</li><li id="87c4" class="ns nt iq kh b ki oc kl od ko oe ks of kw og la ob ny nz oa bi translated"><strong class="kh ir">" API . com apny . com:443 "</strong>-&gt;<em class="lc">200 OK</em>和<strong class="kh ir">" API . com pany:80 "</strong>-&gt;<em class="lc">500内部服务器错误</em></li><li id="fd67" class="ns nt iq kh b ki oc kl od ko oe ks of kw og la ob ny nz oa bi translated">向后遍历允许我们覆盖API路径吗？</li></ul></div><div class="ab cl ne nf hu ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ij ik il im in"><h1 id="a1f3" class="ld le iq bd lf lg nl li lj lk nm lm ln jw nn jx lp jz no ka lr kc np kd lt lu bi translated">结论</h1><p id="6691" class="pw-post-body-paragraph kf kg iq kh b ki lv jr kk kl lw ju kn ko lx kq kr ks ly ku kv kw lz ky kz la ij bi translated">微服务既复杂又易受攻击，你只需要跳出框框思考。</p><figure class="mb mc md me gt mf gh gi paragraph-image"><div class="gh gi on"><img src="../Images/fa49a2ae0702545726cf00f3925899bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1336/format:webp/1*caHUsxk7Y-OKqaG0wxi-2g.png"/></div><figcaption class="mm mn gj gh gi mo mp bd b be z dk translated">“安全不是产品，而是process✨”</figcaption></figure><p id="4d94" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">非常感谢你的阅读。喜欢就分享😇😇</p><p id="0574" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">可以在推特上找我:<a class="ae lb" href="https://twitter.com/mayank_pandey01" rel="noopener ugc nofollow" target="_blank"><strong class="kh ir">mayank _ pandey 01</strong></a></p></div></div>    
</body>
</html>