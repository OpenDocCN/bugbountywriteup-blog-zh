<html>
<head>
<title>How a badly configured DB allowed us to own an entire cloud of over 25K hosts (2/2)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">一个配置糟糕的数据库如何让我们拥有超过25000台主机的整个云(2/2)</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/how-a-badly-configured-db-allowed-us-to-own-an-entire-cloud-of-over-25k-hosts-part-2-2-5a63da194bc1?source=collection_archive---------2-----------------------#2020-09-03">https://infosecwriteups.com/how-a-badly-configured-db-allowed-us-to-own-an-entire-cloud-of-over-25k-hosts-part-2-2-5a63da194bc1?source=collection_archive---------2-----------------------#2020-09-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="4c09" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<a class="ae kl" href="https://medium.com/bugbountywriteup/how-a-badly-configured-db-allowed-us-to-own-an-entire-cloud-of-over-25k-hosts-part-1-2-8846beab691e" rel="noopener">第1部分</a>中，我们简要解释了我们如何获得几乎所有托管原生Openstack云的BMC设备的管理员权限。在这一部分，我们将展示我们如何使用这些来实现完全的妥协。</p><p id="3450" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你对BMC设备有所了解，现在你会知道它们允许你</p><ul class=""><li id="da08" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated">班长</li><li id="9d2c" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">重新启动</li><li id="f861" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">重新设置</li><li id="db15" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">千伏计（kilovoltmeter的缩写）</li></ul><p id="da60" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">连接的设备。这很好，但它们只是模拟了对服务器的物理访问，您仍然需要进入服务器。是的，你可以通过关闭它们来做，但是我们认为这还不够，所以我们继续挖掘。</p><p id="e4d7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">损害具有物理地址的设备的最常见方式之一是重新启动该设备并操纵启动，以便获得根外壳。您也可以在Unix、Mac和Windows中这样做。</p><p id="eb8c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这种方法的注意事项是，每台服务器通常托管大约2000台虚拟主机。所以我们需要找到一台没有被使用的服务器。计划是关闭它(或者只启动它，如果它已经关闭的话)并编辑启动，给我们root访问权限。之后，我们想看一下配置，以找到任何错误/有用的数据，这些错误/有用的数据会让我们危及其他服务器的安全。</p><p id="8126" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Openstack允许您查询本地基础设施并请求某些参数。其中之一是实例的状态，在这个本地公司的例子中，定义为实例的可用性(接收流量的白名单/黑名单)+运行状态(启动/关闭)。<br/>我们需要找到一个黑名单服务器(运行状态并不重要)。我们设法找到了一个磁盘问题，这是关闭的。幸运的是，我们能够引导，困难在于文件系统的某些部分处于只读模式。</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi la"><img src="../Images/bdfd36199f64b912c22c074533b001f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ElPeZbEzyBA_Jx25Bvmnlg.jpeg"/></div></div><figcaption class="lm ln gj gh gi lo lp bd b be z dk translated">查询openstack以寻找合适的服务器进行攻击</figcaption></figure><p id="7e53" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦我们找到它，我们就用之前破解的凭证登录。</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi lq"><img src="../Images/2d93db2b76b74c96ca21248471f243de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ChWM9itgAOSrXe89AgA8BA.jpeg"/></div></div><figcaption class="lm ln gj gh gi lo lp bd b be z dk translated">使用在第1部分获得的凭证</figcaption></figure><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi lr"><img src="../Images/1e21ebcae8404105f348d721155a8c2f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kgMiMohV-Xz2tXJHSkDiWg.png"/></div></div><figcaption class="lm ln gj gh gi lo lp bd b be z dk translated">访问KVM界面</figcaption></figure><p id="ba22" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">KVM界面模拟通过BMC直接连接到服务器。当它启动时，你需要编辑grub的启动和附加</p><pre class="lb lc ld le gt ls lt lu lv aw lw bi"><span id="70e2" class="lx ly iq lt b gy lz ma l mb mc">ro init=/bin/bash</span></pre><p id="7e98" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">到适当的行，才能引导进入根shell(<a class="ae kl" href="https://wiki.archlinux.org/index.php/Reset_lost_root_password" rel="noopener ugc nofollow" target="_blank">https://wiki . arch Linux . org/index . PHP/Reset _ lost _ root _ password</a>)。通常您会使用读写标志(rw)，但我们必须使用只读标志(ro)来防止故障磁盘出现任何问题。</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div class="gh gi md"><img src="../Images/db72959a1398b45f95912b930149a7b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1306/format:webp/1*zbCu6GUam6N1CCQ9YznNuQ.jpeg"/></div><figcaption class="lm ln gj gh gi lo lp bd b be z dk translated">编辑grub的菜单</figcaption></figure><p id="6021" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">登录后，我们列出了网络接口来验证服务器的连接性。如您所见，ifconfig显示了超过10个活动接口。</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi me"><img src="../Images/d3bea6f66220cd478e086360b357880c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u4cvW1U-rpgIDs91ojWoag.jpeg"/></div></div></figure><p id="2642" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在花了相当多的时间分析了网络布局并了解了我们所处的位置之后，我们开始分析服务器。</p><p id="8d67" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">几分钟后，我们用bash_history(您可以在Linux机器上找到的最好的法庭信息来源之一)挖到了金子</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi mf"><img src="../Images/8372b44edc5390b12056b50b47bfd2e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mAO9BJjR1YkKoqxdxhsiPQ.png"/></div></div><figcaption class="lm ln gj gh gi lo lp bd b be z dk translated">服务器历史记录中novadb的凭证。</figcaption></figure><p id="5d2e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于那些不熟悉Openstack架构的人来说，Nova是管理数据库的名称，它保存了整个云的管理信息，如证书、配额、实例名称、元数据和许多其他关键信息(<a class="ae kl" href="https://docs.openstack.org/nova/rocky/cli/nova-manage.html" rel="noopener ugc nofollow" target="_blank">https://docs.openstack.org/nova/rocky/cli/nova-manage.html)</a>。</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi mg"><img src="../Images/767159dc1588aed74d3b12c47cdcc896.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nF7w7VC6B5NxB8EHJVFaug.png"/></div></div><figcaption class="lm ln gj gh gi lo lp bd b be z dk translated">测试连接凭据</figcaption></figure><p id="d7e9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">登录后，我们验证了我们的管理员访问查询MySQL的授权。</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi mh"><img src="../Images/553179b0100ddd0e9da3807c83050e1c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SB0tN1oZPPurTtM6zVKMBA.png"/></div></div></figure><p id="bd36" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">检查完之后，现在我们可以列出NovaDB的内部结构。</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div class="gh gi mi"><img src="../Images/b5c4a38992aa35e9936d422060caa6cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:912/format:webp/1*GmnT3XnB4YjPgujveq9fZw.png"/></div><figcaption class="lm ln gj gh gi lo lp bd b be z dk translated">Novadb数据库中的表</figcaption></figure><p id="9644" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当列出实例信息时，我们可以看到大约34K个已定义的实例。然而，其中约有三分之一在任何特定时间都无法访问/未启动。查看floating_ips记录，可以获得更可靠的实例数量。</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi mj"><img src="../Images/790d5dd08656126a3579f480e0dca318.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aBfVDIHU-0kptE5FcFgkYw.png"/></div></div></figure><p id="5e89" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我解释一下为什么这个数据库发现如此重要。</p><p id="7bf8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您想关闭整个公司，您可以通过BMC界面关闭每一台虚拟化服务器，但这只会在系统管理员重新启动所有设备之前关闭它。</p><p id="f928" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以编写自定义恶意软件来感染所有服务器，但通过BMC渠道进行大规模部署并不容易(记住，我们需要启动一个未使用的服务器来编辑grubs启动，然后才能访问它)。</p><p id="3f4a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">不过，使用NovaDB access，您可以简单地破坏数据库，整个云环境将停止工作。不仅如此，假设系统管理员足够精明，能够立即查看数据库，那么对损坏的数据库进行故障诊断要比对不存在的数据库进行故障诊断困难得多。</p><p id="1b80" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当然，系统管理员可能会意识到某些地方出了问题，并简单地用最新的备份覆盖所有内容，对吗？我们，我们也想到了。这就是我们破坏备份的原因。</p><p id="1a82" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，我们尝试用类似下面的语句查询主数据库</p><pre class="lb lc ld le gt ls lt lu lv aw lw bi"><span id="fc57" class="lx ly iq lt b gy lz ma l mb mc">SELECT * FROM information_schema.PROCESSLIST AS p WHERE p.COMMAND = 'Binlog Dump';</span></pre><p id="143f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">(<a class="ae kl" href="https://serverfault.com/questions/207640/how-to-find-slaves-ip-address-and-user-name-from-master-server" rel="noopener ugc nofollow" target="_blank">https://server fault . com/questions/207640/how-to-find-slaves-IP-address-and-user-name-from-master-server</a>)，但他们使用的是一种定制的备份解决方案，这种备份是偶尔进行的，而不是采用主从复制模式。所以我们继续扫描相邻子网，只是为了找到与主数据库运行在同一个端口的备份数据库。</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi mk"><img src="../Images/d8ab501c623355f808f29ac64911a568.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WFHJXQF9a1ByvfmapbmcKA.png"/></div></div><figcaption class="lm ln gj gh gi lo lp bd b be z dk translated">我们是如何找到备份的</figcaption></figure><p id="bda6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们检查了凭证重用，果然，凭证与主凭证相同。</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi ml"><img src="../Images/dec6910faa0e6d5ebed2bfe678d9ab70.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yaawnDYGe2DsdikPV3oVSw.png"/></div></div><figcaption class="lm ln gj gh gi lo lp bd b be z dk translated">验证备份访问</figcaption></figure><p id="6e79" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">由于拥有备份，我们能够证明虚拟化基础架构的整体危害，以及在几分钟内永久停止运营的方法。</p><p id="9601" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我总是喜欢在总结/报告的结尾写下对发现的问题可能的解决方法。这种情况有很多，比如:</p><ul class=""><li id="117b" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated">凭据重复使用</li><li id="e7d5" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">缺失网络分段</li><li id="e41b" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">琐碎的密码</li><li id="279c" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">不安全的备份结构</li><li id="f81c" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">过时的固件</li></ul><p id="e839" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">不容易解决的一个关键点是《IPMI议定书》的弱点。引用丹·法默的网站:</p><blockquote class="mm mn mo"><p id="d5ff" class="jn jo mp jp b jq jr js jt ju jv jw jx mq jz ka kb mr kd ke kf ms kh ki kj kk ij bi translated">注释4。脸书已经发布了OpenBMC，这是一个看起来很有趣的实现，理论上，可以放在BMC上。大多数供应商都有问题(惠普、戴尔、IBM等。)不会让你安装没有他们签名的固件…所以你就倒霉了。再加上低级别的司机之类的……谁知道呢。我自己无法建造它，但让我们保持希望。如果任何人知道(公开可用的)硬件，这将实际上运行，给我写信。</p></blockquote><p id="ebcc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，最全面的补救措施是将支持BMC的服务器放在不同的网段上，使用受限和受监控的访问IP白名单。这就是这家公司最终做的事情。</p><p id="9668" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我希望这是有教育意义的，我们确实在研究这些主题和做这个评估中得到了很多乐趣！</p></div></div>    
</body>
</html>