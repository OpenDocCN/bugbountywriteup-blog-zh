<html>
<head>
<title>Kerberos Authentication in Active Directory</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Active Directory中的Kerberos身份验证</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/kerberos-authentication-in-active-directory-2dc4af232f65?source=collection_archive---------1-----------------------#2022-05-24">https://infosecwriteups.com/kerberos-authentication-in-active-directory-2dc4af232f65?source=collection_archive---------1-----------------------#2022-05-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/17a092b09f4f65e77cacae2244056ae9.png" data-original-src="https://miro.medium.com/v2/resize:fit:780/format:webp/1*0EqssoJHE_qo926-L8K4Ig.png"/></div></figure><p id="d352" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">本文提供了Kerberos身份验证协议工作原理的基本概述。在本文中，我们将探索Kerberos的基本功能以及如何在Active Directory中使用它。Kerberos是一个很大的主题，本文将只涉及基础知识，所以说了这些之后，让我们开始吧！</p></div><div class="ab cl ks kt hu ku" role="separator"><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx"/></div><div class="ij ik il im in"><h1 id="7391" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">什么是Kerberos？</h1><p id="2291" class="pw-post-body-paragraph ju jv iq jw b jx lx jz ka kb ly kd ke kf lz kh ki kj ma kl km kn mb kp kq kr ij bi translated">在我上一篇名为“<a class="ae mc" rel="noopener ugc nofollow" target="_blank" href="/active-directory-overview-98692e1b0233"> <strong class="jw ir"> <em class="md">活动目录概述</em> </strong> </a>”的文章中，我简要提到了活动目录有两种主要的认证类型，即<strong class="jw ir"> NTLM </strong>和<strong class="jw ir"> Kerberos </strong>。<a class="ae mc" href="https://docs.microsoft.com/en-us/windows-server/security/kerberos/kerberos-authentication-overview" rel="noopener ugc nofollow" target="_blank">微软</a>为Kerberos提供了以下描述:</p><blockquote class="me mf mg"><p id="8ba2" class="ju jv md jw b jx jy jz ka kb kc kd ke mh kg kh ki mi kk kl km mj ko kp kq kr ij bi translated">Kerberos是一种认证协议，用于<strong class="jw ir">验证用户或主机</strong>的身份。</p></blockquote><p id="7287" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">Kerberos是一种计算机网络认证协议，用于识别每个提供秘密密码的用户。Kerberos在Active Directory中用于提供每个用户的权限信息，但是它不执行授权。确定用户是否可以访问其资源是每个服务的责任，Kerberos不验证用户可以访问哪个资源或服务。</p></div><div class="ab cl ks kt hu ku" role="separator"><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx"/></div><div class="ij ik il im in"><h1 id="8976" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">为什么要用Kerberos？</h1><p id="b602" class="pw-post-body-paragraph ju jv iq jw b jx lx jz ka kb ly kd ke kf lz kh ki kj ma kl km kn mb kp kq kr ij bi translated">由于它有许多<a class="ae mc" href="https://www.educative.io/blog/kerberos-in-5-minutes" rel="noopener ugc nofollow" target="_blank">好处</a>，所以被广泛使用，下面列出了其中的一些。</p><ul class=""><li id="51ce" class="mk ml iq jw b jx jy kb kc kf mm kj mn kn mo kr mp mq mr ms bi translated">安全: Kerberos从不通过网络传输密码。</li><li id="4797" class="mk ml iq jw b jx mt kb mu kf mv kj mw kn mx kr mp mq mr ms bi translated"><strong class="jw ir">单点登录:</strong> Kerberos只要求用户在第一次认证客户端时输入一次密码。</li><li id="7662" class="mk ml iq jw b jx mt kb mu kf mv kj mw kn mx kr mp mq mr ms bi translated"><strong class="jw ir">受信任的第三方:</strong> Kerberos使用一个称为密钥分发中心(KDC)的集中式认证服务器，网络中的所有其他设备默认信任该服务器。这种外包确保了敏感信息不会存储在本地机器上。</li><li id="8b2f" class="mk ml iq jw b jx mt kb mu kf mv kj mw kn mx kr mp mq mr ms bi translated"><strong class="jw ir">相互认证:</strong>在Kerberos中，在允许通信之前，必须对通信的两端进行认证。</li></ul></div><div class="ab cl ks kt hu ku" role="separator"><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx"/></div><div class="ij ik il im in"><h1 id="9bd2" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">Kerberos的核心组件是什么？</h1><p id="1bb3" class="pw-post-body-paragraph ju jv iq jw b jx lx jz ka kb ly kd ke kf lz kh ki kj ma kl km kn mb kp kq kr ij bi translated">在讨论Kerberos的核心组件时，经常会用到以下术语。</p><ul class=""><li id="dd4b" class="mk ml iq jw b jx jy kb kc kf mm kj mn kn mo kr mp mq mr ms bi translated"><a class="ae mc" href="https://www.citrix.com/blogs/2015/10/21/domain-to-kerberos-realm-mapping/#:~:text=A%20Kerberos%20realm%20is%20the,domain%20over%20which%20it%20presides." rel="noopener ugc nofollow" target="_blank"> <strong class="jw ir"> Kerberos域</strong> </a>:类似于域的逻辑网络，Kerberos认证服务器有权通过该网络认证用户、主机或服务。</li><li id="f9b7" class="mk ml iq jw b jx mt kb mu kf mv kj mw kn mx kr mp mq mr ms bi translated"><a class="ae mc" href="https://www.educative.io/blog/kerberos-in-5-minutes" rel="noopener ugc nofollow" target="_blank"><strong class="jw ir">【KDC】</strong></a>:包含认证服务器(AS)和票据授予服务(TGS)。它的主要功能是充当这两者之间的仲裁者，中继来自AS的消息，授予一个票据授予票据(TGT)，然后将它传递给TGS进行加密。域的KDC位于域控制器上。</li><li id="e852" class="mk ml iq jw b jx mt kb mu kf mv kj mw kn mx kr mp mq mr ms bi translated"><a class="ae mc" href="https://www.educative.io/blog/kerberos-in-5-minutes" rel="noopener ugc nofollow" target="_blank"> <strong class="jw ir">认证服务器(AS) </strong> </a>:客户端使用用户名和密码登录，向AS认证自己。然后，AS将用户名转发给KDC，后者进而授予TGT。</li><li id="88b2" class="mk ml iq jw b jx mt kb mu kf mv kj mw kn mx kr mp mq mr ms bi translated"><a class="ae mc" href="https://www.educative.io/blog/kerberos-in-5-minutes" rel="noopener ugc nofollow" target="_blank"> <strong class="jw ir">【票据授予服务(TGS) </strong> </a>:当客户想要访问一项服务时，他们必须向TGS出示他们的TGT。</li><li id="5e6b" class="mk ml iq jw b jx mt kb mu kf mv kj mw kn mx kr mp mq mr ms bi translated"><strong class="jw ir">服务主体名称(SPN): </strong>赋予服务实例的标识符，用于将服务实例与域服务帐户相关联。</li></ul><p id="349c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">下图说明了这些组件是如何组合在一起的。</p><figure class="mz na nb nc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nd ne di nf bf ng"><div class="gh gi my"><img src="../Images/581530f915af720485b60a57d6879541.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P0wjMun-wXZQc-ZeiiPvSQ.png"/></div></div><figcaption class="nh ni gj gh gi nj nk bd b be z dk translated">Kerberos组件概述。</figcaption></figure></div><div class="ab cl ks kt hu ku" role="separator"><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx"/></div><div class="ij ik il im in"><h1 id="3095" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">什么是Kerberos票证？</h1><p id="8202" class="pw-post-body-paragraph ju jv iq jw b jx lx jz ka kb ly kd ke kf lz kh ki kj ma kl km kn mb kp kq kr ij bi translated">Kerberos处理的主要结构是票证。这些票被交付给用户，以便用户使用它们在Kerberos领域中执行一些操作。有两种类型:</p><ul class=""><li id="e4b4" class="mk ml iq jw b jx jy kb kc kf mm kj mn kn mo kr mp mq mr ms bi translated"><a class="ae mc" href="https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/kerberos-authentication" rel="noopener ugc nofollow" target="_blank"> <strong class="jw ir"> TGS </strong>(票证授予服务)</a>是用户可以用来验证服务的票证。它用服务密钥加密。</li><li id="d433" class="mk ml iq jw b jx mt kb mu kf mv kj mw kn mx kr mp mq mr ms bi translated">客户端认证成功后，KDC授予<a class="ae mc" href="https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/kerberos-authentication" rel="noopener ugc nofollow" target="_blank"> <strong class="jw ir"> TGT </strong>(票据授予票)</a>。它被提交给KDC以请求TGSs，并用KDC密钥加密。</li></ul></div><div class="ab cl ks kt hu ku" role="separator"><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx"/></div><div class="ij ik il im in"><h1 id="a3ec" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">Kerberos身份验证如何在AD环境中工作？</h1><p id="0d73" class="pw-post-body-paragraph ju jv iq jw b jx lx jz ka kb ly kd ke kf lz kh ki kj ma kl km kn mb kp kq kr ij bi translated">在Kerberos身份验证过程中会执行一系列步骤，但是在实时情况下，该过程非常快。以下步骤概述了Kerberos身份验证在Active Directory中的工作方式。</p><ol class=""><li id="73c4" class="mk ml iq jw b jx jy kb kc kf mm kj mn kn mo kr nl mq mr ms bi translated">当用户登录到活动目录时，用户<strong class="jw ir">使用用户的密码向位于域控制器(DC)上的认证服务器(AS) </strong>进行认证，DC当然知道该密码。</li><li id="b4f9" class="mk ml iq jw b jx mt kb mu kf mv kj mw kn mx kr nl mq mr ms bi translated">DC向用户发送一张<strong class="jw ir">票据授予票据(TGT) </strong> Kerberos票据，用于Kerberos有权认证的领域。然后，TGT被缓存在用户的计算机上供以后使用，并呈现给任何DC来证明Kerberos服务票据的身份验证。</li><li id="02f8" class="mk ml iq jw b jx mt kb mu kf mv kj mw kn mx kr nl mq mr ms bi translated">用户决定他们想要访问Skype服务，这使得用户的工作站为用户的exchange服务器查找<strong class="jw ir">服务主体名称(SPN) </strong>。</li><li id="8e07" class="mk ml iq jw b jx mt kb mu kf mv kj mw kn mx kr nl mq mr ms bi translated">一旦SPN被识别，计算机再次与DC通信，并且<strong class="jw ir">将用户的TGT以及SPN </strong> <strong class="jw ir">呈现给用于用户需要通信的资源的票据授予服务</strong>。</li><li id="d970" class="mk ml iq jw b jx mt kb mu kf mv kj mw kn mx kr nl mq mr ms bi translated">DC用票据授予服务(TGS) Kerberos <strong class="jw ir">服务票据进行回复。</strong></li><li id="1a39" class="mk ml iq jw b jx mt kb mu kf mv kj mw kn mx kr nl mq mr ms bi translated">用户工作站<strong class="jw ir">将TGS提交给交换服务器</strong>进行访问。</li><li id="92bb" class="mk ml iq jw b jx mt kb mu kf mv kj mw kn mx kr nl mq mr ms bi translated">Skype连接成功。</li></ol><p id="2653" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">下面的序列图说明了上面概述的步骤。</p><figure class="mz na nb nc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nd ne di nf bf ng"><div class="gh gi nm"><img src="../Images/bac20cf00f410469f6f50e27fa00d284.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bzFAly53SdEXvrAe0XAsIw.png"/></div></div><figcaption class="nh ni gj gh gi nj nk bd b be z dk translated">Kerberos认证序列图示例。</figcaption></figure></div><div class="ab cl ks kt hu ku" role="separator"><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx"/></div><div class="ij ik il im in"><h1 id="10d1" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">结束语</h1><p id="0d83" class="pw-post-body-paragraph ju jv iq jw b jx lx jz ka kb ly kd ke kf lz kh ki kj ma kl km kn mb kp kq kr ij bi translated">希望这篇关于Kerberos的短文有助于提供它是什么以及它如何工作的基本概述。Kerberos是一个很大的话题，值得深入了解，并且被大多数使用Active Directory的大公司广泛使用。谢谢你看完，继续黑！😄</p></div></div>    
</body>
</html>