<html>
<head>
<title>Somebody Call The Plumber, GraphQL is Leaking Again…</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">谁去叫水管工，GraphQL又漏水了…</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/somebody-call-the-plumber-graphql-is-leaking-again-654bf1a38d26?source=collection_archive---------0-----------------------#2021-02-27">https://infosecwriteups.com/somebody-call-the-plumber-graphql-is-leaking-again-654bf1a38d26?source=collection_archive---------0-----------------------#2021-02-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/></div><div class="ab cl jn jo hu jp" role="separator"><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js"/></div><div class="ij ik il im in"><p id="54a8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">大家好，今天我要给大家讲一个故事。它主要是关于一个GraphQL漏洞，我最近因为这个漏洞被BugCrowd平台上的一个公共程序授予了奖励。这个项目不允许公开，所以我可能需要在“规则”范围内进行编辑。这也将涉及到我觉得我必须做的一点强制手段，以确保我的奖金支付是适当的。</p><p id="d67a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">因此，为了让每个人都快速上手，GraphQL是一种允许通过API交互进行数据库查询和操作的技术。它由脸书开发，仅在内部使用，直到2015年向公众发布。如今在大公司遇到这种情况非常普遍。BugCrowd是一家在bug赏金猎人和支付BugCrowd实质上扮演裁判的组织之间的互动中充当中间人的公司。这些都是非常高层次的定义，如果你愿意，你可以独立地对它们进行大量的研究。</p><p id="5ad3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如今，我并不总是有大量的时间致力于虫类赏金项目，我是一名圣灵降临者/威胁猎人。我是一个父亲，一个丈夫，一个游戏玩家，一个DIY者……老实说，很难把一切都融入其中。所以当我想花些时间在赏金上时，通常会有很多侦查任务。这意味着我只是试图找到web应用程序中可能还没有被深入研究的部分。或者在今天的例子中，部分不应该对公众开放…</p><p id="d83a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">而四处打探目标的主要”。我查看了我的Burpsuite目标选项卡，注意到“/api”端点及其子端点。其中大多数是在浏览和使用网站上的“正常”功能时被动发现的。我还发现了其中的几个，在目录强制过程中，我发现了尽可能多的API端点。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div class="gh gi ks"><img src="../Images/d33cc452383e16ff06370940bb623d8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:506/format:webp/1*4e4GpHu57viNNTAuXNwVJg.png"/></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">像往常一样半编辑过</figcaption></figure><p id="cca2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这些不同的子API端点中的每一个都在很大程度上限制了我们通过要求认证所能获得的数据。其他人给我们的数据只是用来宣传网站界面(如头像、侧栏标志等)。换句话说，对我这个臭虫猎人来说没有任何用处。至少在脆弱性方面。</p><p id="16f2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">然而，我注意到这些端点中的大多数都利用了GraphQL查询…</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div class="gh gi le"><img src="../Images/cef6d0a44b5d1c106d98d4a4e0e8b06e.png" data-original-src="https://miro.medium.com/v2/resize:fit:246/format:webp/1*79fqFwCHFu3Uf8U9zwYfdw.png"/></div></figure><p id="0cbd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果说我对GraphQL有所了解的话，那就是它很少在一开始就设置正确。许多公司都有不安全的GraphQL端点，并在Bug Bounty报告中呼吁。考虑到GraphQL在现有技术基础上的复杂性，这是可以理解的。但是一旦我注意到这一点，我就开始了我的GraphQL测试之路。我已经在其他几个公共程序和一个私有程序中测试了GraphQL端点，但从未发现任何问题，但正如前面提到的，我已经阅读了足够多的错误报告，知道这只是时间问题！一个可以帮助你保持动力的例子是【HackerOne向一名赏金猎人支付了20，000美元,这名赏金猎人发现他们的GraphQL实例泄露了大量敏感数据。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi lg"><img src="../Images/228e57f753b3f049b9e401b756627162.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*C9jiKtdiDhJR8e3S.jpg"/></div></div></figure><p id="ad35" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">不管怎样，我的第一步通常是尝试对端点运行自省查询。如果成功；GraphQL中的自省查询将为您提供大量关于“模式”/数据配置的信息。比如存在什么类型的信息，它们是如何连接的，它们接受什么格式，如何查询数据，以及如何操作数据。</p><p id="4c36" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">几乎每一篇关于测试GraphQL实例的文章都会告诉您寻找以下端点:</p><ul class=""><li id="2df3" class="ll lm iq jw b jx jy kb kc kf ln kj lo kn lp kr lq lr ls lt bi translated"><em class="lu"> /graphql </em></li><li id="42dd" class="ll lm iq jw b jx lv kb lw kf lx kj ly kn lz kr lq lr ls lt bi translated"><em class="lu"> /graphiql </em></li><li id="299f" class="ll lm iq jw b jx lv kb lw kf lx kj ly kn lz kr lq lr ls lt bi translated"><em class="lu"> /graphql.php </em></li><li id="becd" class="ll lm iq jw b jx lv kb lw kf lx kj ly kn lz kr lq lr ls lt bi translated"><em class="lu">/graph QL/控制台</em></li></ul><p id="3ca7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果你在BurpSuite中使用graph QL“InQL Scanner”BApp(add on ),你所要做的就是输入你想要发送自省查询的URL。然而，我认为重要的是要认识到，仅仅因为上面列出的那些端点表明GraphQL的存在，并不意味着如果您怀疑某个目标正在运行某个实例，就应该将它视为运行自省查询的端点的完整列表。例如…你确实可以在我上面的截图中看到一些/ <em class="lu"> graphql </em>端点…但是当运行Introspecition查询时，我实际上得到的有趣细节的端点根本没有标记为“<em class="lu"> graphql </em>”!</p><p id="7b29" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为了与目标保持一致，我不想/也不能说出实际的端点名称，但为了简单起见，我们将称它为"<em class="lu">/API/vulnerable</em>"…只需知道graphql不是端点的名称，因为这是我最终要说明的要点。所以我发<em class="lu"> https://【编校】。com/api/vulnerable </em>转移到Burpsuite中的InQL扫描器，果然……基于该端点支持的查询，大量看起来有趣的数据查询潜在地可用。我迅速向Repeater选项卡发送一个名为“<em class="lu"> customer.query </em>”的查询，并填写“<em class="lu"> ID </em>”参数，仅猜测“<em class="lu"> 1 </em>”，以查看是否有任何用户数据返回，但我基本上得到一个错误，表明ID格式不被接受。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi ma"><img src="../Images/464623e4fd77ca64c4065cd8c97324cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Zs8nbpWZ_bn_XCaEcFgfWA.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">我还看到了SQL语句的一部分，并且使用了“Psycopg2”。这告诉我他们正在使用Python，很可能是PostgresSQL。</figcaption></figure><p id="dd93" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">好的，我正在寻找一个UUID…可能会太复杂而无法猜测…所以我查看了从我运行的初始自省查询中得到的其他可能的查询，我看到了“<em class="lu"> customers.query </em>”(注意在这种情况下<em class="lu"> customers </em>是复数)。唉，我为什么不从那个开始呢！哈哈…我把那个查询扔掉了，它只需要两个参数… <em class="lu">每页的结果数</em> …和<em class="lu">要查询哪个页面</em>…这有多简单？！我不需要猜测任何事情，所以希望查询运行时不需要认证…</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi mb"><img src="../Images/6b1e4cddb1a8e5633d0bc2abcadf20a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xCcgolOcl_k63hJDdgtfcw.png"/></div></div></figure><p id="992f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我肯定没有“黑”任何东西。但是我确实发现了一堆我觉得我不应该有的敏感信息！下一个合乎逻辑的步骤是探索我能够处理的其他查询。还有一些更敏感的信息，关于以其他方式与平台相关的各种合作伙伴和用户(有点像承包商)。我发现了一些API键以及外部webhook urls，但这些URL超出了范围，所以除了在BugCrowd的报告中提到它们之外，我真的不能做太多。</p><p id="39e8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我整理了我的数据，试图尽可能地提高影响力，然后把报告寄出去。在选择类别时，我认为该漏洞符合我注意到的“P1”严重性，因为它会导致“敏感机密”泄露。然后我看了看P1公司的项目支出，很快意识到如果一切顺利，我可以得到一笔可观的支出。</p><p id="7eaa" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我在一个周六的晚上提交了报告，焦急地等待着审查，我以为审查要到周一才会进行。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi mc"><img src="../Images/bdfac8fde77e72e018bf6867c50d6999.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*vW5-Dqlfr6C_W1x7.jpg"/></div></div></figure><p id="31d0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">星期一到了，一天的大部分时间过去了，我只是得到一个回应，我在报告中发送的概念证明在运行时没有产生相同的结果。我发送了一些替代的有效载荷，我知道这些载荷可以避免复制/粘贴格式问题，我认为这是我发送的最初的Curl概念证明不起作用的原因。然后更多的时间过去了，我没有听到一个字。周一午夜左右，BugCrowd的一名员工跳到了报告上，我认为他是在推动目标在报告上向前迈进。星期二我醒来时，目标如下…</p><p id="771d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这个发现是合法的，因此我们撤下了这个网站。使用的数据是假的，但是我们知道研究人员不会知道，我们正在评估奖金。我们感谢好的工作，并将很快颁奖。</p><p id="a076" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="lu">谢谢。”</em></p><p id="b15c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我的直觉告诉我这些数据看起来不是假的。好像我在制作中到处挖掘。如果数据是假的，为什么要这么快就把整个页面拉出来？有些事不合情理。</p><p id="b7b9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我又回到了侦察模式……我从之前的查询中去掉了一些客户的名字，把他们的名字放到了脸书和LinkedIn的搜索栏中……嘣！我发现许多人，他们的名字和位置与PII的名字和位置完全匹配……所以我用我的“customers.query”概念证明中的一些用户在脸书的名字和城镇与PII并排匹配的截图回击了这个报告线程。他们现在能说什么？我有他们的电子邮件地址、电话号码，还有他们的一些脸书主页。我会去问用户他们自己是否使用目标网站…哈哈好吧好吧，我只是在开玩笑。</p><p id="5d9e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我最不想做的事情就是陷入这样一种境地:我在BugCrowd上呼吁一个程序对此撒谎，所以我试图尽可能好地表达事情，以防他们方面有一些真正的误解。又一次…我等待着…</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi md"><img src="../Images/67eae24d021ea623082ebb72846ae590.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*iRjwE-COm4iOTPHy.jpg"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">我也许应该试着再看一遍毒品。看起来是个不错的节目。不过字幕有时会让人精疲力尽。</figcaption></figure><p id="2322" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">两天后，我推了他们一下。他们回复让我知道我的支出即将到来，但从未真正回应我关于数据真实的评论。但我认为，延迟回应肯定来自于对数据的一些内部困惑。最终，他们只是给它加上了“p3”严重性(“中度”严重性——显然有一个“p3”版本的“敏感机密泄露”)😕不过我还是要了..lol)并给我发了我的赏金，还说了一些客气话。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi me"><img src="../Images/49f8204591d9f0287d4433b559664fce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3wuTeuHSonJj0Un-"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">…出去买些家庭健身器材😃</figcaption></figure><p id="ba01" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">总结:有几点真的…</p><ol class=""><li id="0db1" class="ll lm iq jw b jx jy kb kc kf ln kj lo kn lp kr mf lr ls lt bi translated">监控你的网络日志。理想情况下，这意味着放置一个SIEM，并确保web服务器日志被转发用于日志关联。我无法想象将一个公开的bug赏金目标的web服务器日志转储到一个SIEM中会有多疯狂。我想既然大多数程序要求你在User-Agent头中包含一个特殊的字符串，你可以用这种方式丢弃/过滤掉所有的bounty流量。但是我确信你仍然会被那些不阅读交战规则或者不知道如何配置他们的工具来修改UA报头的人打败。然而，理论上你可以使用WAF将明显是新手测试者的具有恶意行为的IP列入黑名单，允许适当的用户代理通过，并监控来自不符合这两个类别的web服务器的日志。这只是一个不切实际的想法，但是沿着这个逻辑的一些东西可能是有意义的。当然，在这种情况下，攻击者可以只使用一个bug-bounty接受的用户代理，并在实际上是恶意的情况下不受监控。看看这变成猫捉老鼠有多快！？</li><li id="c433" class="ll lm iq jw b jx lv kb lw kf lx kj ly kn lz kr mf lr ls lt bi translated">很少有理由允许公共用户在GraphQL端点上运行自省查询。但是我相信它曾经是，并且可能仍然是GraphQL实例中的默认设置😐。不要相信任何东西的默认设置。阅读你实现的所有东西的“安全问题”部分，尤其是面向web的。</li><li id="4478" class="ll lm iq jw b jx lv kb lw kf lx kj ly kn lz kr mf lr ls lt bi translated">在虫子赏金猎人方面，我自己的逻辑是“侦查为王”，和很多人一样。当然，我已经听到了来自P1勇士队的反对意见，即有时只是彻底了解那些显而易见的东西是一个更好的选择。这一切都是基于你自己的优势，随着时间的推移，你最终会根据我自己的经历和别人的经历来塑造自己的方法。我只想说……人们花了几百美元就收集了大量的复杂步骤的报告。我找到了一个开放的端点，在提交一个2000万美元的bug之前，花了大概一个小时的时间查询它，看看有没有影响。我并不是说金钱应该是主要的动力，不管怎样，如果金钱是你的主要动力，那就更难了解了。但我要说，即使你不喜欢侦察深潜，它们显然有一些价值！这种情况下2000美元lol。</li></ol><p id="9f5f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">*在此奖励期间没有黑客攻击发生😉。*</p><p id="c5a1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">下次见！</p><p id="1291" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">N0ur5</p></div></div>    
</body>
</html>