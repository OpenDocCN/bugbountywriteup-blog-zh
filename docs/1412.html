<html>
<head>
<title>Build, Hack, and Defend Azure Identity</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">构建、攻击和保护Azure身份</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/build-hack-and-defend-azure-identity-9297f31231e9?source=collection_archive---------4-----------------------#2021-06-18">https://infosecwriteups.com/build-hack-and-defend-azure-identity-9297f31231e9?source=collection_archive---------4-----------------------#2021-06-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/09a3b8293ebbfbbc40334f8b51a2cf1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lwxmokx9zJ8esna1kVCkRQ.jpeg"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Kaylee Stepkoski摄</figcaption></figure><div class=""/><div class=""><h2 id="594e" class="pw-subtitle-paragraph kc je jf bd b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt dk translated">purple cloud Hybrid+Identity Cyber系列简介</h2></div><h1 id="cd05" class="ku kv jf bd kw kx ky kz la lb lc ld le kl lf km lg ko lh kp li kr lj ks lk ll bi translated">概观</h1><p id="5885" class="pw-post-body-paragraph lm ln jf lo b lp lq kg lr ls lt kj lu lv lw lx ly lz ma mb mc md me mf mg mh ij bi translated">攻击身份系统是一种越来越常见的攻击手段。看看网络安全管理软件产品战役中使用的黄金法则[1]就知道了。我们正看到网络安全工具[2，3]，技术[4，5]和可靠的演示[6]的爆炸式增长，它们传达了对身份安全问题的更好理解。为了建立检测和响应弹性，网络防御人员需要一个安全的实验室环境，能够模拟攻击和防御身份系统的真实场景。<a class="ae mi" href="https://purple.iknowjason.io/" rel="noopener ugc nofollow" target="_blank"> PurpleCloud </a>是一个混合+身份网络安全系列，为Azure云构建，具有自动化部署脚本。它实现了一种快速和自动化的方法来为各种用例建立Azure Active Directory安全实验室。将其用于Azure广告渗透测试实验室。云安全研究人员可以用它来研究对手的交易技巧。在这篇博客中，我们将通过描述Azure Active Directory和使用Bloodhound进行侦察的一个具体用例，对该系列进行简单介绍。</p><h1 id="b08e" class="ku kv jf bd kw kx ky kz la lb lc ld le kl lf km lg ko lh kp li kr lj ks lk ll bi translated">用例</h1><p id="d2ff" class="pw-post-body-paragraph lm ln jf lo b lp lq kg lr ls lt kj lu lv lw lx ly lz ma mb mc md me mf mg mh ij bi translated">PurpleCloud的功能远不止Azure AD。PurpleCloud通过模拟内部、混合或云原生实验室，为企业安全测试用例提供了无数激动人心的功能。一些功能包括:</p><ul class=""><li id="2909" class="mj mk jf lo b lp ml ls mm lv mn lz mo md mp mh mq mr ms mt bi translated">Azure AD和Azure域服务的研究和渗透测试实验室</li><li id="b4be" class="mj mk jf lo b lp mu ls mv lv mw lz mx md my mh mq mr ms mt bi translated">混合加入和Azure AD加入设备的安全性测试</li><li id="e018" class="mj mk jf lo b lp mu ls mv lv mw lz mx md my mh mq mr ms mt bi translated">EDR测试实验室</li><li id="6e9d" class="mj mk jf lo b lp mu ls mv lv mw lz mx md my mh mq mr ms mt bi translated">PoC /产品安全实验室</li><li id="2fc1" class="mj mk jf lo b lp mu ls mv lv mw lz mx md my mh mq mr ms mt bi translated">使用加入域的设备的企业活动目录实验室</li><li id="23ec" class="mj mk jf lo b lp mu ls mv lv mw lz mx md my mh mq mr ms mt bi translated">恶意软件/逆向工程针对加入域的设备研究工件</li><li id="d6f6" class="mj mk jf lo b lp mu ls mv lv mw lz mx md my mh mq mr ms mt bi translated">SIEM /威胁追踪/DFIR/HELK+迅猛龙实时响应实验室</li><li id="18e0" class="mj mk jf lo b lp mu ls mv lv mw lz mx md my mh mq mr ms mt bi translated">日志聚合器架构，用于将日志转发到云原生SIEM (Azure Sentinel)</li><li id="1744" class="mj mk jf lo b lp mu ls mv lv mw lz mx md my mh mq mr ms mt bi translated">使用HELK服务器、Jupyter笔记本电脑进行数据科学研究</li><li id="b02a" class="mj mk jf lo b lp mu ls mv lv mw lz mx md my mh mq mr ms mt bi translated">基于Mordor的检测工程研究</li></ul></div><div class="ab cl mz na hu nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="ij ik il im in"><p id="0fd2" class="pw-post-body-paragraph lm ln jf lo b lp ml kg lr ls mm kj lu lv ng lx ly lz nh mb mc md ni mf mg mh ij bi translated">在这篇博客中，我们将特别关注Azure Active Directory用例。该实验室能够模拟Azure租户内的权限提升，并研究托管身份，如针对OAuth 2.0未授权同意授权的攻击的应用程序/服务主体。该系列是一个使用terraform的免费开源基础设施代码(IaC)项目。这些术语是什么？快速入门:</p><ul class=""><li id="2a4b" class="mj mk jf lo b lp ml ls mm lv mn lz mo md mp mh mq mr ms mt bi translated"><strong class="lo jg"> <em class="nj">基础设施即代码(IaC) </em> </strong>是一种使用模板或定义文件实现云基础设施自动化部署和管理的技术。IaC有很多不断增长的网络安全用例。</li><li id="27e9" class="mj mk jf lo b lp mu ls mv lv mw lz mx md my mh mq mr ms mt bi translated"><strong class="lo jg"> <em class="nj"> Terraform.io </em> </strong>是一家为IaC提供商业和开源工具的公司。使用Terraform，我们以terraform声明性文件格式指定定义，并使用terraform free工具，通过terraform提供程序在Azure中自动快速部署Azure AD。Terraform对所有三个CSP(AWS、Azure、Google)以及其他提供商都有灵活丰富的支持。Terraform管理范围的状态，以自动建立和破坏资源。于是奇迹发生了。很好。</li></ul><h1 id="5190" class="ku kv jf bd kw kx ky kz la lb lc ld le kl lf km lg ko lh kp li kr lj ks lk ll bi translated"><strong class="ak"> PurpleCloud安装Azure广告支持</strong></h1><p id="ad9b" class="pw-post-body-paragraph lm ln jf lo b lp lq kg lr ls lt kj lu lv lw lx ly lz ma mb mc md me mf mg mh ij bi translated">让我们深入研究这一点，并使用PurpleCloud的Azure AD模块建立一个Azure AD安全实验室。这些Terraform模块将自动创建许多漂亮的Azure AD对象，这些对象通常需要花费相当多的时间来使用Azure门户手工构建。然后，可以通过导航到目录并修改terraform文件来进一步调整它们以获得额外的功能和安全性研究:<strong class="lo jg"> <em class="nj"> modules/azure_ad </em> </strong>。Terraform的Azure AD模块构建映射到以下文件的以下Azure AD资源:</p><ul class=""><li id="bcf0" class="mj mk jf lo b lp ml ls mm lv mn lz mo md mp mh mq mr ms mt bi translated">62个用户(users.tf)</li><li id="c9a0" class="mj mk jf lo b lp mu ls mv lv mw lz mx md my mh mq mr ms mt bi translated">8组(groups.tf)</li><li id="8c72" class="mj mk jf lo b lp mu ls mv lv mw lz mx md my mh mq mr ms mt bi translated">2个应用程序和2个服务主体(apps.tf)</li></ul><h2 id="8d42" class="nk kv jf bd kw nl nm dn la nn no dp le lv np nq lg lz nr ns li md nt nu lk nv bi translated">我们开始吧！</h2><p id="9c2a" class="pw-post-body-paragraph lm ln jf lo b lp lq kg lr ls lt kj lu lv lw lx ly lz ma mb mc md me mf mg mh ij bi translated"><strong class="lo jg">注:</strong>本程序已经在Ubuntu Linux 20.04上验证。</p><h1 id="1e92" class="ku kv jf bd kw kx ky kz la lb lc ld le kl lf km lg ko lh kp li kr lj ks lk ll bi translated">要求</h1><ul class=""><li id="5b13" class="mj mk jf lo b lp lq ls lt lv nw lz nx md ny mh mq mr ms mt bi translated">Azure租户和订阅</li><li id="f302" class="mj mk jf lo b lp mu ls mv lv mw lz mx md my mh mq mr ms mt bi translated">全局管理员角色</li><li id="fd4e" class="mj mk jf lo b lp mu ls mv lv mw lz mx md my mh mq mr ms mt bi translated">地形:<strong class="lo jg"> </strong>在v0.14.7上测试</li><li id="7e3a" class="mj mk jf lo b lp mu ls mv lv mw lz mx md my mh mq mr ms mt bi translated">Azure CLI工具</li></ul><h1 id="7a8e" class="ku kv jf bd kw kx ky kz la lb lc ld le kl lf km lg ko lh kp li kr lj ks lk ll bi translated">安装步骤</h1><p id="3ccc" class="pw-post-body-paragraph lm ln jf lo b lp lq kg lr ls lt kj lu lv lw lx ly lz ma mb mc md me mf mg mh ij bi translated"><strong class="lo jg">步骤1: </strong>在您的Linux系统上安装Terraform以及Azure CLI工具。</p><p id="9746" class="pw-post-body-paragraph lm ln jf lo b lp ml kg lr ls mm kj lu lv ng lx ly lz nh mb mc md ni mf mg mh ij bi translated">为您的平台下载并安装Terraform:<a class="ae mi" href="https://www.terraform.io/downloads.html" rel="noopener ugc nofollow" target="_blank">https://www.terraform.io/downloads.html</a></p><p id="e2c6" class="pw-post-body-paragraph lm ln jf lo b lp ml kg lr ls mm kj lu lv ng lx ly lz nh mb mc md ni mf mg mh ij bi translated">运行这个一行程序在Ubuntu 20.04上安装Azure CLI工具:</p><pre class="nz oa ob oc gt od oe of og aw oh bi"><span id="16c1" class="nk kv jf oe b gy oi oj l ok ol">curl -sL <a class="ae mi" href="https://aka.ms/InstallAzureCLIDeb" rel="noopener ugc nofollow" target="_blank">https://aka.ms/InstallAzureCLIDeb</a> | sudo bash</span></pre><p id="6f40" class="pw-post-body-paragraph lm ln jf lo b lp ml kg lr ls mm kj lu lv ng lx ly lz nh mb mc md ni mf mg mh ij bi translated"><strong class="lo jg">步骤2: </strong>在你的Azure订阅上设置一个Azure服务主体，允许Terraform自动执行你的Azure订阅下的任务。</p><p id="121b" class="pw-post-body-paragraph lm ln jf lo b lp ml kg lr ls mm kj lu lv ng lx ly lz nh mb mc md ni mf mg mh ij bi translated">请严格遵循微软文档中的说明:<a class="ae mi" href="https://docs.microsoft.com/en-us/azure/developer/terraform/getting-started-cloud-shell" rel="noopener ugc nofollow" target="_blank">https://docs . Microsoft . com/en-us/azure/developer/terra form/getting-started-cloud-shell</a></p><p id="acc8" class="pw-post-body-paragraph lm ln jf lo b lp ml kg lr ls mm kj lu lv ng lx ly lz nh mb mc md ni mf mg mh ij bi translated">这是基于上面的链接运行的两个基本命令。首先，为terraform将使用的自动化资源创建创建一个服务主体。在下面的命令中，我们为它分配了所有者角色。</p><pre class="nz oa ob oc gt od oe of og aw oh bi"><span id="4c25" class="nk kv jf oe b gy oi oj l ok ol">az ad sp create-for-rbac --role="Owner" --scopes="/subscriptions/&lt;subscription_id&gt;"</span></pre><p id="8748" class="pw-post-body-paragraph lm ln jf lo b lp ml kg lr ls mm kj lu lv ng lx ly lz nh mb mc md ni mf mg mh ij bi translated">其次，在下面的步骤中，我们将使用该服务主体登录，并收集Terraform应用程序将使用的凭据。</p><pre class="nz oa ob oc gt od oe of og aw oh bi"><span id="c8e8" class="nk kv jf oe b gy oi oj l ok ol">az login --service-principal -u &lt;service_principal_name&gt; -p "&lt;service_principal_password&gt;" --tenant "&lt;service_principal_tenant&gt;"</span></pre><p id="c847" class="pw-post-body-paragraph lm ln jf lo b lp ml kg lr ls mm kj lu lv ng lx ly lz nh mb mc md ni mf mg mh ij bi translated">请注意以下内容，我们接下来将使用这些内容来配置我们的Terraform Azure提供程序:</p><pre class="nz oa ob oc gt od oe of og aw oh bi"><span id="d8e3" class="nk kv jf oe b gy oi oj l ok ol">subscription_id = ""<br/>client_id = ""<br/>client_secret = ""<br/>tenant_id = ""</span></pre><p id="f8b6" class="pw-post-body-paragraph lm ln jf lo b lp ml kg lr ls mm kj lu lv ng lx ly lz nh mb mc md ni mf mg mh ij bi translated"><strong class="lo jg">第三步:</strong>在你的Azure门户帐户中设置Azure服务主体的权限。</p><h1 id="3387" class="ku kv jf bd kw kx ky kz la lb lc ld le kl lf km lg ko lh kp li kr lj ks lk ll bi translated">Azure AD模块说明:Azure Active Directory权限要求</h1><p id="a3bd" class="pw-post-body-paragraph lm ln jf lo b lp lq kg lr ls lt kj lu lv lw lx ly lz ma mb mc md me mf mg mh ij bi translated">要将Azure Active Directory模块与terraform automation一起使用，服务主体需要特殊权限来读写Azure AD用户、组和应用程序。在我最近的测试中，将需要下面描述的这两种权限。</p><p id="554f" class="pw-post-body-paragraph lm ln jf lo b lp ml kg lr ls mm kj lu lv ng lx ly lz nh mb mc md ni mf mg mh ij bi translated"><strong class="lo jg">步骤#3.1: </strong>将“全局管理员”角色分配给服务主体。要在Azure AD门户中做到这一点，请导航到<strong class="lo jg"> <em class="nj"> Azure AD </em> </strong> → <strong class="lo jg"> <em class="nj">角色和管理员</em> </strong>。搜索<strong class="lo jg"> <em class="nj">全局管理员</em> </strong>角色。选中它，点击<strong class="lo jg"> <em class="nj">【添加作业+】</em></strong>。在右侧，搜索Azure服务主体的名称。默认情况下，它会以“<strong class="lo jg"> <em class="nj"> azure-cli- </em> </strong>开头。选择<strong class="lo jg"> <em class="nj">添加</em> </strong>为服务主体添加全局管理员角色。完成此操作后，验证您的工作。它应该类似于以下内容:</p><figure class="nz oa ob oc gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi om"><img src="../Images/ef890472d46085218f04ad3d8ca80e5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aClejweXMd2JTlPPCdsnsQ.png"/></div></div></figure><p id="4e04" class="pw-post-body-paragraph lm ln jf lo b lp ml kg lr ls mm kj lu lv ng lx ly lz nh mb mc md ni mf mg mh ij bi translated"><strong class="lo jg">步骤#3.2: </strong>将以下API权限分配给下面列出的服务主体。可以通过导航到<strong class="lo jg"> <em class="nj"> Azure Active Directory →应用注册→ &lt; Select_App &gt; → API权限</em> </strong>来访问API权限的正确屏幕。</p><ul class=""><li id="d672" class="mj mk jf lo b lp ml ls mm lv mn lz mo md mp mh mq mr ms mt bi translated">Azure活动目录图→应用程序。读写。全部</li><li id="7636" class="mj mk jf lo b lp mu ls mv lv mw lz mx md my mh mq mr ms mt bi translated">Azure活动目录图→目录。读写。全部</li><li id="e1a7" class="mj mk jf lo b lp mu ls mv lv mw lz mx md my mh mq mr ms mt bi translated">Microsoft Graph →用户。阅读</li></ul><p id="b26c" class="pw-post-body-paragraph lm ln jf lo b lp ml kg lr ls mm kj lu lv ng lx ly lz nh mb mc md ni mf mg mh ij bi translated">这是成功设置后的样子:</p><figure class="nz oa ob oc gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi on"><img src="../Images/cf4ede29f0da216b56551c2573df0ac8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GKhjAsEMokzE3_KlOI1QEA.png"/></div></div></figure><p id="e53f" class="pw-post-body-paragraph lm ln jf lo b lp ml kg lr ls mm kj lu lv ng lx ly lz nh mb mc md ni mf mg mh ij bi translated"><strong class="lo jg">步骤4: </strong>克隆PurpleCloud repo</p><pre class="nz oa ob oc gt od oe of og aw oh bi"><span id="ae39" class="nk kv jf oe b gy oi oj l ok ol">$ git clone <a class="ae mi" href="https://github.com/iknowjason/PurpleCloud.git" rel="noopener ugc nofollow" target="_blank">https://github.com/iknowjason/PurpleCloud.git</a></span></pre><p id="95d9" class="pw-post-body-paragraph lm ln jf lo b lp ml kg lr ls mm kj lu lv ng lx ly lz nh mb mc md ni mf mg mh ij bi translated"><strong class="lo jg">第四步:</strong>首先将<strong class="lo jg"><em class="nj">terra form . TF example</em></strong>复制到<strong class="lo jg"><em class="nj">terra form . TF vars</em></strong>。接下来，使用您喜欢的文本编辑器，为匹配您的Azure服务主体凭证的Azure资源提供者编辑<strong class="lo jg"><em class="nj">terra form . TF vars</em></strong>文件。Azure AD provider需要这些凭据来使用服务主体，并使用正确的API权限创建用户、组和应用程序。</p><pre class="nz oa ob oc gt od oe of og aw oh bi"><span id="1e09" class="nk kv jf oe b gy oi oj l ok ol">$ cd PurpleCloud\deploy<br/>$ cp terraform.tfexample terraform.tfvars<br/>$ vi terraform.tfvars</span></pre><p id="96e7" class="pw-post-body-paragraph lm ln jf lo b lp ml kg lr ls mm kj lu lv ng lx ly lz nh mb mc md ni mf mg mh ij bi translated">在<strong class="lo jg"><em class="nj">terra form . TF vars</em></strong>文件中编辑这些参数，替换“REPLACE_WITH_YOUR_VALUES”以正确匹配您的Azure环境。</p><pre class="nz oa ob oc gt od oe of og aw oh bi"><span id="011f" class="nk kv jf oe b gy oi oj l ok ol"># Azure RM<br/>arm_client_id = "REPLACE_WITH_YOUR_VALUES"<br/>arm_client_secret = "REPLACE_WITH_YOUR_VALUES"</span><span id="7b65" class="nk kv jf oe b gy oo oj l ok ol"># Azure AD<br/>aad_client_id = "REPLACE_WITH_YOUR_VALUES"<br/>aad_client_secret = "REPLACE_WITH_YOUR_VALUES" </span><span id="6bd8" class="nk kv jf oe b gy oo oj l ok ol"># General Subscription and Tenant ID<br/>subscription_id = "REPLACE_WITH_YOUR_VALUES"<br/>tenant_id = "REPLACE_WITH_YOUR_VALUES"</span></pre><p id="3d86" class="pw-post-body-paragraph lm ln jf lo b lp ml kg lr ls mm kj lu lv ng lx ly lz nh mb mc md ni mf mg mh ij bi translated">您的terraform.tfvars文件应该类似于下图，但带有您自己的Azure服务主体凭据。请注意，这些是用于演示目的的虚假值，而不是真实的帐户信息。</p><pre class="nz oa ob oc gt od oe of og aw oh bi"><span id="4e73" class="nk kv jf oe b gy oi oj l ok ol"># Azure RM<br/>arm_client_id = "7e3c2cce-8bd4-887d-b2b0-90cd1e7e4781"<br/>arm_client_secret = ":+2$+cdfafdaF-?%:.?d/EYZLK6po9`|E&lt;["</span><span id="a5e4" class="nk kv jf oe b gy oo oj l ok ol"># Azure AD<!-- --> <br/>aad_client_id = "7e3c2cce-8bd4-887d-b2b0-90cd1e7e4781"<br/>aad_client_secret = ":+2$+cdfafdaF-?%:.?d/EYZLK6po9`|E&lt;["</span><span id="aae4" class="nk kv jf oe b gy oo oj l ok ol"># General Subscription and Tenant ID<br/>subscription_id = "aa7d8c9f-39c2-6262-89ff-3c78527c1b22"<br/>tenant_id = "8b6917d9-f209-3061-8f4f-dd03332847cb"</span></pre><p id="5d45" class="pw-post-body-paragraph lm ln jf lo b lp ml kg lr ls mm kj lu lv ng lx ly lz nh mb mc md ni mf mg mh ij bi translated"><strong class="lo jg">第五步:</strong>取消main.tf中Azure AD模块的注释，默认是禁用的。查找此节块并删除多行注释。它应该是这样的:</p><pre class="nz oa ob oc gt od oe of og aw oh bi"><span id="da84" class="nk kv jf oe b gy oi oj l ok ol">##########################################################<br/>## Azure AD Module - Create Azure AD Users, Groups, and Application<br/>##########################################################<br/>module "azure_ad" {<br/>  source              = "../modules/azure_ad"<br/>  upn_suffix          = local.upn_suffix<br/>  tenant_id           = local.tenant_id<br/>}</span></pre><p id="5ab4" class="pw-post-body-paragraph lm ln jf lo b lp ml kg lr ls mm kj lu lv ng lx ly lz nh mb mc md ni mf mg mh ij bi translated"><strong class="lo jg">步骤6: </strong>在main.tf中，使用/*和*/注释掉所有其他模块，以进行多行注释。PurpleCloud默认安装Windows域控制器、Windows 10端点、ELK SIEM服务器以及Azure虚拟网络。对于本实验，我们希望禁用所有这些基础架构组件，以便仅启用Azure AD模块。注释掉以下模块。在terraform中，多行注释的开头是/*，多行注释的结尾是*/。</p><ul class=""><li id="9028" class="mj mk jf lo b lp ml ls mm lv mn lz mo md mp mh mq mr ms mt bi translated">模块“网络”</li><li id="ca13" class="mj mk jf lo b lp mu ls mv lv mw lz mx md my mh mq mr ms mt bi translated">模块“dc-vm”</li><li id="bfc8" class="mj mk jf lo b lp mu ls mv lv mw lz mx md my mh mq mr ms mt bi translated">模块“velocihelk”</li><li id="8480" class="mj mk jf lo b lp mu ls mv lv mw lz mx md my mh mq mr ms mt bi translated">模块“win10-vm1”</li></ul><p id="3304" class="pw-post-body-paragraph lm ln jf lo b lp ml kg lr ls mm kj lu lv ng lx ly lz nh mb mc md ni mf mg mh ij bi translated">这里有一个注释掉对手VM模块的例子。应该对其他模块执行相同的步骤来禁用它们。</p><figure class="nz oa ob oc gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi op"><img src="../Images/4de986450e7a331cb596e5438c2a91e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2_57WsCIQD7OtxG2278sEg.png"/></div></div></figure><p id="b87d" class="pw-post-body-paragraph lm ln jf lo b lp ml kg lr ls mm kj lu lv ng lx ly lz nh mb mc md ni mf mg mh ij bi translated"><strong class="lo jg">第七步:</strong>在main.tf中，为Azure AD正确设置以下两个变量:</p><ul class=""><li id="c2ec" class="mj mk jf lo b lp ml ls mm lv mn lz mo md mp mh mq mr ms mt bi translated">租户id</li><li id="6df3" class="mj mk jf lo b lp mu ls mv lv mw lz mx md my mh mq mr ms mt bi translated">upn_suffix ( <strong class="lo jg">可选:</strong>仅当使用自定义域时)</li></ul><p id="da2f" class="pw-post-body-paragraph lm ln jf lo b lp ml kg lr ls mm kj lu lv ng lx ly lz nh mb mc md ni mf mg mh ij bi translated">tenant_id变量应该是设置时与您的租户帐户关联的用户名，它构成了AD用户的通用主体名称(UPN)后缀。假设您的用户名是acmecorp。那么upn后缀将是acmecorp.onmicrosoft.com。如果您已经向Azure添加了自定义域，那么您可以使用该自定义域作为您的upn后缀，而不是“<strong class="lo jg"><em class="nj">tenant _ id . on Microsoft . com</em></strong>”。以下屏幕截图显示了tenant_id的沙盒配置:</p><figure class="nz oa ob oc gt is gh gi paragraph-image"><div class="gh gi oq"><img src="../Images/65b3b90a9b92dbe090bea452527da16e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1308/format:webp/1*EXD7ds8F9e5at3cvTtNtTw.png"/></div></figure><p id="34b5" class="pw-post-body-paragraph lm ln jf lo b lp ml kg lr ls mm kj lu lv ng lx ly lz nh mb mc md ni mf mg mh ij bi translated"><strong class="lo jg">步骤8: </strong>运行命令初始化terraform并应用资源计划</p><pre class="nz oa ob oc gt od oe of og aw oh bi"><span id="955a" class="nk kv jf oe b gy oi oj l ok ol">$ cd PurpleCloud/deploy<br/>$ terraform init<br/>$ terraform apply -auto-approve</span></pre><p id="f2f6" class="pw-post-body-paragraph lm ln jf lo b lp ml kg lr ls mm kj lu lv ng lx ly lz nh mb mc md ni mf mg mh ij bi translated">这应该会启动Terraform自动部署计划，并且您应该会看到资源计划的创建。如果由于任何原因收到错误，请再次运行terraform apply。完成后，您将看到以下内容:</p><figure class="nz oa ob oc gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi or"><img src="../Images/00b11def80d038be3d697e66f188d596.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sMFGsUgZxhLw7YZcsplk0w.png"/></div></div></figure><p id="a714" class="pw-post-body-paragraph lm ln jf lo b lp ml kg lr ls mm kj lu lv ng lx ly lz nh mb mc md ni mf mg mh ij bi translated"><strong class="lo jg">第九步:</strong>获取Azure AD用户密码。以下文件包含terraform为每次实验运行创建的动态生成的密码。该文件位于以下位置:</p><p id="6fa5" class="pw-post-body-paragraph lm ln jf lo b lp ml kg lr ls mm kj lu lv ng lx ly lz nh mb mc md ni mf mg mh ij bi translated"><strong class="lo jg"> <em class="nj">模块/azure _ ad/AAD _ password . txt</em></strong></p><p id="a691" class="pw-post-body-paragraph lm ln jf lo b lp ml kg lr ls mm kj lu lv ng lx ly lz nh mb mc md ni mf mg mh ij bi translated">这是为所有62个Azure AD用户设置的密码。</p><p id="eb19" class="pw-post-body-paragraph lm ln jf lo b lp ml kg lr ls mm kj lu lv ng lx ly lz nh mb mc md ni mf mg mh ij bi translated"><strong class="lo jg">第十步:</strong>核实你在https://portal.azure.com的工作</p><p id="8687" class="pw-post-body-paragraph lm ln jf lo b lp ml kg lr ls mm kj lu lv ng lx ly lz nh mb mc md ni mf mg mh ij bi translated">验证在<strong class="lo jg"> <em class="nj"> Azure Active Directory中创建的Azure用户→用户</em> </strong></p><figure class="nz oa ob oc gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi os"><img src="../Images/be799af75ee9ea59be9191752f90a953.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cp_uF4tm22Re1mBHsrgDsQ.png"/></div></div></figure><p id="c7e8" class="pw-post-body-paragraph lm ln jf lo b lp ml kg lr ls mm kj lu lv ng lx ly lz nh mb mc md ni mf mg mh ij bi translated">验证在<strong class="lo jg"> <em class="nj"> Azure Active Directory中创建的Azure组→组</em> </strong></p><figure class="nz oa ob oc gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ot"><img src="../Images/0b1e574171381e0640b6d7b493cf2caa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CrPiKrSLSi6je6LYjQDy5Q.png"/></div></div></figure><p id="3d7a" class="pw-post-body-paragraph lm ln jf lo b lp ml kg lr ls mm kj lu lv ng lx ly lz nh mb mc md ni mf mg mh ij bi translated">验证在<strong class="lo jg"> <em class="nj"> Azure Active Directory中创建的应用程序→应用程序注册</em> </strong>。你应该在<strong class="lo jg"> <em class="nj"> HR-App </em> </strong>看到一个结尾，在<strong class="lo jg"> <em class="nj"> Fin-App </em> </strong>看到一个结尾。</p><figure class="nz oa ob oc gt is gh gi paragraph-image"><div class="gh gi ou"><img src="../Images/3a2e6ae0575a4cd247b8cee07df2f91f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1348/format:webp/1*3YCMu5L2NWek6ib6aLhkww.png"/></div></figure><h1 id="16fc" class="ku kv jf bd kw kx ky kz la lb lc ld le kl lf km lg ko lh kp li kr lj ks lk ll bi translated">使用Bloodhound的Azure广告侦察</h1><p id="efad" class="pw-post-body-paragraph lm ln jf lo b lp lq kg lr ls lt kj lu lv lw lx ly lz ma mb mc md me mf mg mh ij bi translated">对于渗透测试来说，BloodHound是一个有效且有价值的侦察工具。它在一个由Neo4j图形数据库支持的非常好的可视化用户界面中提供了对映射攻击路径、横向移动和权限提升的高度可见性。Andy Robbins和其他BloodHound作者最近用AzureHound收集器添加了Azure对象支持和数据摄取[7]。这对我们意味着什么？现在，我们可以有效地查看Azure租户内权限提升的攻击途径，从内部AD到Azure的途径，以及从Azure迁移到内部AD环境的自上而下的攻击[8]。</p><p id="d771" class="pw-post-body-paragraph lm ln jf lo b lp ml kg lr ls mm kj lu lv ng lx ly lz nh mb mc md ni mf mg mh ij bi translated">让我们使用新的AzureHound收集器快速完成数据接收并导入Bloodhound。</p><p id="ff28" class="pw-post-body-paragraph lm ln jf lo b lp ml kg lr ls mm kj lu lv ng lx ly lz nh mb mc md ni mf mg mh ij bi translated"><strong class="lo jg">第一步:</strong>在Windows 10 Pro系统上，从https://github.com/BloodHoundAD/AzureHound<a class="ae mi" href="https://github.com/BloodHoundAD/AzureHound" rel="noopener ugc nofollow" target="_blank">下载AzureHound数据收集器powershell脚本</a></p><p id="ef78" class="pw-post-body-paragraph lm ln jf lo b lp ml kg lr ls mm kj lu lv ng lx ly lz nh mb mc md ni mf mg mh ij bi translated"><strong class="lo jg">步骤2: </strong>使用管理员权限启动powershell会话:</p><pre class="nz oa ob oc gt od oe of og aw oh bi"><span id="a094" class="nk kv jf oe b gy oi oj l ok ol">powershell -exec bypass</span></pre><p id="d2c6" class="pw-post-body-paragraph lm ln jf lo b lp ml kg lr ls mm kj lu lv ng lx ly lz nh mb mc md ni mf mg mh ij bi translated"><strong class="lo jg">第三步:</strong>安装Az模块，出现提示时选择<strong class="lo jg"> <em class="nj"> A </em> </strong>:</p><pre class="nz oa ob oc gt od oe of og aw oh bi"><span id="e935" class="nk kv jf oe b gy oi oj l ok ol">Install-Module -name Az -AllowClobber</span></pre><figure class="nz oa ob oc gt is gh gi paragraph-image"><div class="gh gi ov"><img src="../Images/c58a8df3c5a421635dd7a62cb5b5578c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1202/format:webp/1*4AkVyhixjCkZM8mtDdZl9w.png"/></div></figure><p id="a1b1" class="pw-post-body-paragraph lm ln jf lo b lp ml kg lr ls mm kj lu lv ng lx ly lz nh mb mc md ni mf mg mh ij bi translated"><strong class="lo jg">第四步:</strong>安装AzureAdPreview模块，出现提示时选择<strong class="lo jg"> <em class="nj"> A </em> </strong>:</p><pre class="nz oa ob oc gt od oe of og aw oh bi"><span id="d4ce" class="nk kv jf oe b gy oi oj l ok ol">Install-Module -name AzureAdPreview -AllowClobber</span></pre><p id="fdf2" class="pw-post-body-paragraph lm ln jf lo b lp ml kg lr ls mm kj lu lv ng lx ly lz nh mb mc md ni mf mg mh ij bi translated"><strong class="lo jg">第5步:</strong>运行以下两个cmdlets向Azure和Azure AD powershell进行身份验证以收集数据。对于这个安全的实验室概念验证，我建议对这些cmdlets使用您的全局管理员帐户。它允许在租户级别查看更多对象，如订阅。</p><pre class="nz oa ob oc gt od oe of og aw oh bi"><span id="3b4f" class="nk kv jf oe b gy oi oj l ok ol">Connect-AzureAD<br/>Connect-AzAccount</span></pre><p id="8b81" class="pw-post-body-paragraph lm ln jf lo b lp ml kg lr ls mm kj lu lv ng lx ly lz nh mb mc md ni mf mg mh ij bi translated"><strong class="lo jg">第六步:</strong>解压AzureHound zip文件，从下载解压目录导入模块。</p><pre class="nz oa ob oc gt od oe of og aw oh bi"><span id="3f88" class="nk kv jf oe b gy oi oj l ok ol">Import-Module C:\Users\Username\Downloads\AzureHound-master\AzureHound-master\AzureHound.ps1</span></pre><p id="b4c2" class="pw-post-body-paragraph lm ln jf lo b lp ml kg lr ls mm kj lu lv ng lx ly lz nh mb mc md ni mf mg mh ij bi translated"><strong class="lo jg">第七步:</strong>从前一个目录运行Invoke-AzureHound，查看收集到的数据！</p><pre class="nz oa ob oc gt od oe of og aw oh bi"><span id="0c84" class="nk kv jf oe b gy oi oj l ok ol">Invoke-AzureHound</span></pre><p id="f52f" class="pw-post-body-paragraph lm ln jf lo b lp ml kg lr ls mm kj lu lv ng lx ly lz nh mb mc md ni mf mg mh ij bi translated">您应该看到它收集了租户中的所有Azure对象，并将其打包成一个zip文件。然后，这个zip文件可以被复制到运行BloodHound二进制文件的系统中！</p><figure class="nz oa ob oc gt is gh gi paragraph-image"><div class="gh gi ow"><img src="../Images/87ab7089cb8c7a4e0e663c136f37f799.png" data-original-src="https://miro.medium.com/v2/resize:fit:1260/format:webp/1*9uL0uWcA6PCj_dgcuiMOdg.png"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">运行Invoke-AzureHound</figcaption></figure><figure class="nz oa ob oc gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ox"><img src="../Images/0f2227136efba6bb4334b43fd6430b8a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k1Q0eKxyKVV04SmVCzuvhw.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">AzureHound跑了！将压缩文件复制到BloodHound系统。</figcaption></figure><p id="7072" class="pw-post-body-paragraph lm ln jf lo b lp ml kg lr ls mm kj lu lv ng lx ly lz nh mb mc md ni mf mg mh ij bi translated"><strong class="lo jg">步骤8: </strong>将zip文件复制到您的BloodHound系统，并上传zip文件中的数据。本文假设您已经安装了Bloodhound并且熟悉它。如需了解更多信息，请查阅BloodHound文档:</p><div class="ip iq gp gr ir oy"><a href="https://bloodhound.readthedocs.io/en/latest/index.html" rel="noopener  ugc nofollow" target="_blank"><div class="oz ab fo"><div class="pa ab pb cl cj pc"><h2 class="bd jg gy z fp pd fr fs pe fu fw je bi translated">BloodHound:六度域管理- BloodHound 3.0.3文档</h2><div class="pf l"><h3 class="bd b gy z fp pd fr fs pe fu fw dk translated">BloodHound使用图论来揭示活动目录中隐藏的、通常是无意的关系…</h3></div><div class="pg l"><p class="bd b dl z fp pd fr fs pe fu fw dk translated">bloodhound.readthedocs.io</p></div></div><div class="ph l"><div class="pi l pj pk pl ph pm ix oy"/></div></div></a></div><p id="7763" class="pw-post-body-paragraph lm ln jf lo b lp ml kg lr ls mm kj lu lv ng lx ly lz nh mb mc md ni mf mg mh ij bi translated"><strong class="lo jg">第九步:</strong>将数据可视化。导航到顶部搜索并键入<strong class="lo jg"> <em class="nj">日期:</em> </strong></p><p id="253c" class="pw-post-body-paragraph lm ln jf lo b lp ml kg lr ls mm kj lu lv ng lx ly lz nh mb mc md ni mf mg mh ij bi translated">选择租户。从这个视图中，您可以看到Azure用户和组对象以及其他后代对象。</p><figure class="nz oa ob oc gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi pn"><img src="../Images/407d91d92954f0a6b135ea5542990c95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O__-TId4I_5chSgvtwP_Mw.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">BloodHound中Azure广告用户的视图</figcaption></figure><h1 id="2b04" class="ku kv jf bd kw kx ky kz la lb lc ld le kl lf km lg ko lh kp li kr lj ks lk ll bi translated">破坏紫云AzureAD资源</h1><p id="4d54" class="pw-post-body-paragraph lm ln jf lo b lp lq kg lr ls lt kj lu lv lw lx ly lz ma mb mc md me mf mg mh ij bi translated">当需要销毁实验室资源时，Terraform可以自动提供便利。只需导航到启动terraform apply的同一目录:</p><pre class="nz oa ob oc gt od oe of og aw oh bi"><span id="d749" class="nk kv jf oe b gy oi oj l ok ol">$ cd PurpleCloud/deploy<br/>$ terraform destroy -auto-approve</span></pre><figure class="nz oa ob oc gt is gh gi paragraph-image"><div class="gh gi po"><img src="../Images/b6ad943c26626f4abb7873ee2893b441.png" data-original-src="https://miro.medium.com/v2/resize:fit:1038/format:webp/1*eB8spqFsl8O8biq0IzJKOA.png"/></div></figure><h1 id="07f3" class="ku kv jf bd kw kx ky kz la lb lc ld le kl lf km lg ko lh kp li kr lj ks lk ll bi translated">结论</h1><p id="5a08" class="pw-post-body-paragraph lm ln jf lo b lp lq kg lr ls lt kj lu lv lw lx ly lz ma mb mc md me mf mg mh ij bi translated">这是一个R&amp;D框架工具，用于安全研究和构建新的工具。我计划用针对Azure AD security的研讨会、练习和其他工具来扩展它。欢迎反馈和建议。</p><h1 id="1665" class="ku kv jf bd kw kx ky kz la lb lc ld le kl lf km lg ko lh kp li kr lj ks lk ll bi translated">参考</h1><p id="b434" class="pw-post-body-paragraph lm ln jf lo b lp lq kg lr ls lt kj lu lv lw lx ly lz ma mb mc md me mf mg mh ij bi translated">[1]<a class="ae mi" href="https://www.darkreading.com/attacks-breaches/solarwinds-campaign-focuses-attention-on-golden-saml-attack-vector/d/d-id/1339794" rel="noopener ugc nofollow" target="_blank">https://www . dark reading . com/attacks-breaks/solarwinds-campaign-focuss-attention-golden-SAML-attack-vector/d/d-id/1339794</a></p><p id="758c" class="pw-post-body-paragraph lm ln jf lo b lp ml kg lr ls mm kj lu lv ng lx ly lz nh mb mc md ni mf mg mh ij bi translated">[2]https://github.com/AlteredSecurity/365-Stealer<a class="ae mi" href="https://github.com/AlteredSecurity/365-Stealer" rel="noopener ugc nofollow" target="_blank"/></p><p id="23cb" class="pw-post-body-paragraph lm ln jf lo b lp ml kg lr ls mm kj lu lv ng lx ly lz nh mb mc md ni mf mg mh ij bi translated">[3]<a class="ae mi" href="https://www.microsoft.com/security/blog/2021/05/20/simuland-understand-adversary-tradecraft-and-improve-detection-strategies/" rel="noopener ugc nofollow" target="_blank">https://www . Microsoft . com/security/blog/2021/05/20/simuland-understand-attendant-trade craft-and-improve-detection-strategies/</a></p><p id="53a4" class="pw-post-body-paragraph lm ln jf lo b lp ml kg lr ls mm kj lu lv ng lx ly lz nh mb mc md ni mf mg mh ij bi translated">[4]<a class="ae mi" href="https://www.slideshare.net/DouglasBienstock/troopers-19-i-am-ad-fs-and-so-can-you" rel="noopener ugc nofollow" target="_blank">https://www . slide share . net/DouglasBienstock/troopers-19-I-am-ad-fs-and-so-can-you</a></p><p id="9a7f" class="pw-post-body-paragraph lm ln jf lo b lp ml kg lr ls mm kj lu lv ng lx ly lz nh mb mc md ni mf mg mh ij bi translated">[5]<a class="ae mi" href="https://www.fireeye.com/blog/threat-research/2021/04/abusing-replication-stealing-adfs-secrets-over-the-network.html" rel="noopener ugc nofollow" target="_blank">https://www . fire eye . com/blog/threat-research/2021/04/滥用-复制-窃取-adfs-secrets-over-the-network . html</a></p><p id="c29f" class="pw-post-body-paragraph lm ln jf lo b lp ml kg lr ls mm kj lu lv ng lx ly lz nh mb mc md ni mf mg mh ij bi translated"><a class="ae mi" href="https://www.youtube.com/watch?v=mxOHcqHxpi8" rel="noopener ugc nofollow" target="_blank">https://www.youtube.com/watch?v=mxOHcqHxpi8</a></p><p id="2480" class="pw-post-body-paragraph lm ln jf lo b lp ml kg lr ls mm kj lu lv ng lx ly lz nh mb mc md ni mf mg mh ij bi translated"><a class="ae mi" href="https://www.youtube.com/watch?v=gAConW5P5uU" rel="noopener ugc nofollow" target="_blank">https://www.youtube.com/watch?v=gAConW5P5uU</a></p><p id="678e" class="pw-post-body-paragraph lm ln jf lo b lp ml kg lr ls mm kj lu lv ng lx ly lz nh mb mc md ni mf mg mh ij bi translated">[8]<a class="ae mi" href="https://posts.specterops.io/death-from-above-lateral-movement-from-azure-to-on-prem-ad-d18cb3959d4d" rel="noopener ugc nofollow" target="_blank">https://posts . specter ops . io/death-from-above-lateral-movement-from-azure-to-on-prem-ad-d18cb 3959 d4d</a></p></div></div>    
</body>
</html>