<html>
<head>
<title>Kubernetes Security</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes安全公司</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/kubernetes-security-df58a8e5f379?source=collection_archive---------1-----------------------#2022-08-08">https://infosecwriteups.com/kubernetes-security-df58a8e5f379?source=collection_archive---------1-----------------------#2022-08-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="ffeb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这篇博客文章从安全的角度介绍了Kubernetes中的安全特性和最佳实践。</p><h1 id="5a49" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">1.保护集群</h1><h1 id="6ed0" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">1.1 Kubernetes组件</h1><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi lj"><img src="../Images/145bbb6f8debbed0b52747d6cd345867.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*guMWPkdgqnBnQLIpLFjesQ.png"/></div></div></figure><p id="e1b7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Kubernetes是一个可移植、可扩展的开源平台，用于管理容器化的工作负载和服务。Kubernetes集群通常由一组工作节点和一个主节点组成，提供容错和高可用性。控制平面托管重要组件，如API服务器、etcd、kube-scheduler和kubelet等。，它负责做出有关集群的决策，并将其推向所需的状态。</p><p id="f97b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在Kubernetes的早期，默认配置使Kubernetes的控制平面不安全。尽管从安全性的角度来看，默认设置已经有所改进，但是仍然值得在您的Kubernetes环境中检查一下配置。</p><h1 id="3aa7" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">1.2安全API服务器</h1><p id="04ab" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">API服务器验证和配置API对象的数据。它通过HTTP公开RESTful APIs，执行所有操作，并将API对象存储到持久存储中。当您使用命令行与Kubernetes集群进行交互时，您实际上是在与API服务器进行通信。</p><p id="9189" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">控制API服务器相当于在集群中的每台机器上进行根访问。</p><p id="dd97" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要保护API服务器:</p><ol class=""><li id="3ba9" class="ma mb iq jp b jq jr ju jv jy mc kc md kg me kk mf mg mh mi bi translated">对所有API流量使用传输层安全性(TLS)</li></ol><ul class=""><li id="acd6" class="ma mb iq jp b jq jr ju jv jy mc kc md kg me kk mj mg mh mi bi translated">安全端口</li></ul><p id="f36e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">默认情况下，集群中的所有API通信都将使用TLS进行加密，安全端口用于为https提供身份验证和授权。如果禁用它，所有流量都不加密。因此，请确保<strong class="jp ir"> —安全端口</strong>参数(默认端口为6443)未设置或设置为1到65535之间的整数值，对于旧版本，请确保<strong class="jp ir"> —不安全端口</strong>为0，以禁用不需要身份验证和授权的localhost:8080。</p><ul class=""><li id="a50f" class="ma mb iq jp b jq jr ju jv jy mc kc md kg me kk mj mg mh mi bi translated">HTTPS流量加密</li></ul><p id="24b3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用<strong class="jp ir"> — tls-cert-file </strong>，<strong class="jp ir"> — tls-private-key-file </strong>为HTTPS连接配置x509证书和私钥。</p><p id="2656" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.启用对API服务器的身份验证</p><p id="66a2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Kubernetes使用客户端证书、不记名令牌或认证代理来通过认证插件认证API请求。</p><p id="59ff" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通过将<strong class="jp ir"> — client-ca-file </strong>参数传递给API服务器来启用客户端证书认证。</p><p id="bb38" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要禁用匿名访问，将<strong class="jp ir"> — anonymous-auth </strong>设置为false。</p><p id="77a3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">3.批准请求</p><p id="cf0e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">授权检查用户是否被允许执行特定的任务。有几种授权模式:节点、ABAC、RBAC、Webhook。</p><p id="eab4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通过使用<strong class="jp ir">节点</strong>作为<strong class="jp ir"> —授权模式</strong>之一，限制Kubelet节点只能读取与其相关的对象。</p><p id="94a9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用<strong class="jp ir"> RBAC </strong>允许不同的实体在集群中执行不同的对象。</p><p id="b1f7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">确保<strong class="jp ir"> —授权模式</strong>参数未设置为<strong class="jp ir"> AlwaysAllow </strong>。</p><p id="32b3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">4.验证请求的准入控制</p><p id="d27c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">准入控制保证经过身份验证和授权的用户正确安全地执行任务。Kubernetes API服务器使用<strong class="jp ir">—enable-admission-plugins</strong>来定义在修改集群中的对象之前要调用的准入控制插件的逗号分隔列表。</p><p id="e4ff" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">准入控制插件<strong class="jp ir"> AlwaysAdmit </strong>允许所有请求，不过滤任何请求。所以确保<strong class="jp ir">—enable-admission-plugins</strong>参数被设置，其值不包括<strong class="jp ir">always admission</strong>。在不同的场景中，可以使用其他插件来保护集群。</p><h1 id="e5de" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">1.3保护Kubelet</h1><p id="7fe0" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">Kubelet是每个节点上的代理，它与容器运行时交互以启动pods，并确保Kubernetes创建的容器运行正常。</p><p id="2068" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">kubelet最小化攻击面的一些配置选项:</p><ol class=""><li id="2e40" class="ma mb iq jp b jq jr ju jv jy mc kc md kg me kk mf mg mh mi bi translated">使用证书启用身份验证</li></ol><p id="6d4f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">检查<strong class="jp ir"> — client-ca-file </strong>参数，并将其设置为客户端证书颁发机构文件的位置。如果没有<strong class="jp ir"> — client-ca-file </strong>参数，请检查Kubelet配置文件是否将<strong class="jp ir">身份验证:x509: clientCAFile </strong>设置为客户端证书颁发机构文件的位置。</p><p id="5bb0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">设置<strong class="jp ir"> — anonymous-auth </strong> false以禁用匿名访问。</p><p id="ea4e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将<strong class="jp ir"> —只读端口</strong>置0，关闭只读端口，防止匿名用户访问正在运行的工作负载信息。</p><p id="f034" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.启用对kubelet API的授权</p><p id="e3aa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">默认情况下，允许所有经过身份验证的请求。为了限制该行为，请确保<strong class="jp ir"> —授权模式</strong>存在并设置为<strong class="jp ir"> Webhook </strong>而不是<strong class="jp ir"> AlwaysAllow </strong>。</p><p id="b8d0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">3.限制kubelet权限</p><p id="4fb1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将<strong class="jp ir"> NodeRestriction </strong>包含在API server<strong class="jp ir">—admission-control</strong>设置中，这样kubelet将只被允许修改自己的节点API对象，并且只修改绑定到自己节点的Pod API对象。</p><p id="7c93" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在API服务器<strong class="jp ir">中包含<strong class="jp ir">节点</strong>—授权模式</strong>参数仅允许kubelets读取与其节点相关联的Secret、ConfigMap、PersistentVolume和PersistentVolumeClaim对象。</p><p id="47c8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">4.证书轮换</p><p id="eb58" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Kubelet使用客户端证书与API服务器通信，从1.8开始，kubelet使用<strong class="jp ir"> — rotate-certificates </strong>标志启用自动证书轮换，因此当到期截止日期临近时，将自动请求和颁发新证书。</p><h1 id="b57a" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">1.4保护Etcd</h1><p id="4c05" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">Etcd是一种高度可用的键值永久存储，用于存储高度敏感的配置数据。不幸的是，etcd错误配置仍然猖獗。应该对它应用与任何其他数据存储相同的安全原则。</p><ol class=""><li id="66b7" class="ma mb iq jp b jq jr ju jv jy mc kc md kg me kk mf mg mh mi bi translated">加密传输中的信息</li></ol><ul class=""><li id="3f45" class="ma mb iq jp b jq jr ju jv jy mc kc md kg me kk mj mg mh mi bi translated">客户端到服务器</li></ul><p id="1825" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">设置<strong class="jp ir"> —证书文件</strong>和<strong class="jp ir"> —密钥文件</strong>参数，以确保与etcd的SSL/TLS连接。</p><ul class=""><li id="ae09" class="ma mb iq jp b jq jr ju jv jy mc kc md kg me kk mj mg mh mi bi translated">服务器对服务器</li></ul><p id="75dd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">设置<strong class="jp ir"> —对等证书文件</strong>和<strong class="jp ir"> —对等密钥文件</strong>参数，以确保与etcd的SSL/TLS连接。</p><p id="f065" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.启用身份验证</p><ul class=""><li id="db24" class="ma mb iq jp b jq jr ju jv jy mc kc md kg me kk mj mg mh mi bi translated">客户端到服务器</li></ul><p id="fd20" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">检查所有由可信CA签署的客户端证书的传入HTTPS请求。通过将<strong class="jp ir"> — client-cert-auth </strong>参数设置为true并使用<strong class="jp ir"> — trusted-ca-file </strong>参数指定已签署客户端证书的可信CA，启用etcd服务上的客户端身份验证。</p><p id="b446" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">设置<strong class="jp ir"> — auto-tls=false </strong>禁止生成和使用自签名证书。</p><ul class=""><li id="d303" class="ma mb iq jp b jq jr ju jv jy mc kc md kg me kk mj mg mh mi bi translated">服务器对服务器</li></ul><p id="e0de" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">与客户端到服务器的身份验证类似，对于服务器到服务器的身份验证，将<strong class="jp ir"> — peer-client-cert-auth </strong>设置为true，使用<strong class="jp ir"> — peer-trusted-ca-file </strong>参数为对等方指定可信CA。</p><p id="7835" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">3.加密静态敏感数据</p><p id="e9ca" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您将Kubernetes的机密存储在etcd而不是外部机密存储中，加密存储在磁盘上的etcd数据尤为重要。</p><p id="cd87" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">—encryption-provider-config</strong>控制如何在etcd中加密API数据。该配置作为API服务器的一个名为EncryptionConfiguration的API提供。</p><pre class="lk ll lm ln gt mk ml mm mn aw mo bi"><span id="efa4" class="mp km iq ml b gy mq mr l ms mt">/usr/local/bin/kube-apiserver  --encryption-provider-config=/var/lib/kubernetes/EncryptionConfiguration-example.yaml ...</span></pre><p id="1849" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">encryption configuration-example . YAML结构如下:</p><pre class="lk ll lm ln gt mk ml mm mn aw mo bi"><span id="eaf5" class="mp km iq ml b gy mq mr l ms mt">apiVersion: apiserver.config.k8s.io/v1<br/>kind: EncryptionConfiguration<br/>resources:<br/>  - resources:<br/>      - secrets<br/>    providers:<br/>      - identity: {}<br/>      - aescbc:<br/>          keys:<br/>            - name: key1<br/>              secret: c2VjcmV0IGlzIHNlY3VyZQ==<br/>           ...</span></pre><p id="41f2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用本地管理的密钥加密机密无法防止主机受损，因此如果可以的话，请使用KMS来获得额外的安全性。</p><h1 id="f7ce" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">2.认证和授权</h1><p id="3ddc" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">如何配置认证和授权已经在<strong class="jp ir">安全集群</strong>-&gt;-<strong class="jp ir">安全API服务器</strong>中说明。这里只概述了与身份验证和授权相关的其他主题。</p><p id="62b5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于认证请求的API服务器，请求发布者需要拥有一个身份。</p><h1 id="4d3d" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">2.1服务账户</h1><p id="5d2f" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">在Kubernetes中，服务帐户用于为位于pod内的容器中的任何流程或应用程序提供身份。服务帐户是命名空间资源。</p><p id="f39d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了在不指定服务帐户的情况下自动管理服务帐户，应该将<strong class="jp ir"> ServiceAccount </strong>包含在API服务器的<strong class="jp ir">—enable-admission-plugins</strong>中，并且不使用<strong class="jp ir">—disable-admission-plugins</strong>参数将其关闭。</p><p id="5485" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建服务帐户令牌以访问API，并将其作为卷安装到pod。如果pod遭到破坏，在pod内安装服务帐户令牌可以作为提升权限的途径。如果在pod中运行的工作负载不需要与API服务器通信，请在ServiceAccount或Pod定义上将<strong class="jp ir">automountserviceaccountoken</strong>设置为false，以退出自动挂载令牌。</p><p id="db07" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">或者，您可以创建自己的服务帐户，并根据最小特权原则授予它特定的角色，而不是使用默认的服务帐户。</p><h1 id="1a10" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">2.2角色和集群角色</h1><p id="b3ab" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">Kubernetes使用Role和ClusterRole来管理对API的身份(用户或工作负载)访问。角色或集群角色包含一组规则来表示不同的附加权限(没有“拒绝”规则)。当创建角色或集群角色时，避免使用通配符来匹配所有项目。使用<strong class="jp ir">通配符</strong>可能会导致无意中获得访问新资源的权限。</p><p id="6cc0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">API服务器创建一组默认的ClusterRole，其中一些属于被硬编码到API服务器源代码中的<strong class="jp ir"> system:masters </strong>组，可以不受限制地对任何资源执行任何操作。</p><p id="45fc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">系统的成员资格:masters </strong>组在与客户端证书认证模式结合时是非常危险的，因为这种类型的客户端证书不能被撤销。应该避免让任何用户成为<strong class="jp ir"> system:masters </strong>组的成员，而是授予某人集群管理权限，这与使用<strong class="jp ir"> system:masters </strong>组具有相同的效果。</p><h1 id="23fa" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">3.安全运行容器</h1><p id="f011" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">为了在Kubernetes中安全地运行容器，您需要执行以下操作:</p><ul class=""><li id="7853" class="ma mb iq jp b jq jr ju jv jy mc kc md kg me kk mj mg mh mi bi translated">使用最低特权来执行任务</li><li id="6ada" class="ma mb iq jp b jq mu ju mv jy mw kc mx kg my kk mj mg mh mi bi translated">根据需要进行最小主机装载</li><li id="85e9" class="ma mb iq jp b jq mu ju mv jy mw kc mx kg my kk mj mg mh mi bi translated">限制应用程序之间以及与外部之间的通信。</li></ul><p id="bc82" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从pod的角度来看，安全性的主要问题是防止容器内运行的进程逃离隔离边界并获得对底层主机的访问权。pod规范中有多种属性可以限制pod的容量。</p><ul class=""><li id="3216" class="ma mb iq jp b jq jr ju jv jy mc kc md kg me kk mj mg mh mi bi translated">特权容器拥有完全的访问权限，可以做宿主可以做的几乎所有事情。应防止pod在<strong class="jp ir">特权</strong>模式下运行，并且通常不应在<strong class="jp ir">allowprivilegescalation</strong>标志设置为真的情况下运行容器。</li><li id="ebe2" class="ma mb iq jp b jq mu ju mv jy mw kc mx kg my kk mj mg mh mi bi translated">同样，其他主机资源应该被限制为与容器共享，如<strong class="jp ir"> hostNetwork </strong>、<strong class="jp ir"> hostPID </strong>、<strong class="jp ir"> hostIPC </strong>、<strong class="jp ir"> hostPort </strong>、<strong class="jp ir"> hostPath </strong>。</li><li id="fe16" class="ma mb iq jp b jq mu ju mv jy mw kc mx kg my kk mj mg mh mi bi translated"><strong class="jp ir">runAsNonRoot</strong>/<strong class="jp ir">MustRunAsNonRoot</strong>为真或者uid范围不包括0的<strong class="jp ir"> MustRunAs </strong>阻止容器作为非根用户运行。</li><li id="8dee" class="ma mb iq jp b jq mu ju mv jy mw kc mx kg my kk mj mg mh mi bi translated">从最低特权原则的角度来看，应该最小化容器允许的能力，不适当的能力可以被利用来执行特权提升或容器突破。</li><li id="c0a5" class="ma mb iq jp b jq mu ju mv jy mw kc mx kg my kk mj mg mh mi bi translated">sysctl接口允许管理员在运行时修改内核参数，如果使用不当，它可以禁用安全机制，应该只允许安全的<strong class="jp ir">sysctls</strong>子集。</li><li id="9ab2" class="ma mb iq jp b jq mu ju mv jy mw kc mx kg my kk mj mg mh mi bi translated">容器不是沙箱，当在容器中运行不受信任的程序时，沙箱提供的额外隔离可以防止恶意代码伤害主机。<strong class="jp ir"> gVisor </strong>，一个沙盒运行时工具，通过<strong class="jp ir"> runsc </strong> handler(简称“运行<em class="mz">沙盒容器</em>”)作为<strong class="jp ir"> RuntimeClass </strong>与Kubernetes集成，在应用程序与其主机之间创建一个强大的安全边界。</li><li id="f2da" class="ma mb iq jp b jq mu ju mv jy mw kc mx kg my kk mj mg mh mi bi translated">使用CPU / RAM限制来防止DOS。这些值应该是容器化应用程序工作的最小值。<strong class="jp ir"> LimitRange </strong>和<strong class="jp ir"> ResourceQuota </strong>可用于管理租户工作负载的资源使用情况。</li></ul><p id="9c28" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于网络通信，默认情况下，Kubernetes集群中的所有pod发送和接收流量没有限制。网络分段对于确保所有pod仅与它们应该通信的精选pod通信非常重要。您还可以使用网络策略来阻止云平台中元数据API的流量。</p><p id="a0a7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所有名称空间都应该有<strong class="jp ir">网络策略</strong>，以确保只允许合法的流量。但是使用NetworkPolicy的前提条件是正在使用的CNI必须支持这样的功能。Calico是支持网络政策的CNI之一。</p><h1 id="6836" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">4.容器运行时安全性</h1><p id="5f0c" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">容器运行时是每个节点中的底层软件。运行容器是容器运行时的责任。运行时安全性是为了检测和防止恶意活动在容器内部发生。这些是Linux内核安全特性，也可以通过SecurityContext进行设置，为容器提供主动保护:</p><ul class=""><li id="63ae" class="ma mb iq jp b jq jr ju jv jy mc kc md kg me kk mj mg mh mi bi translated">安全计算模式(seccomp)是一种限制进程访问系统调用的机制。它的工作原理是拦截系统调用，只允许那些被允许的系统调用通过</li><li id="c950" class="ma mb iq jp b jq mu ju mv jy mw kc mx kg my kk mj mg mh mi bi translated">安全增强的Linux (SELinux)是细粒度强制访问控制(MAC)的实现。</li><li id="74cf" class="ma mb iq jp b jq mu ju mv jy mw kc mx kg my kk mj mg mh mi bi translated">AppArmor允许系统管理员使用每个程序的配置文件来限制程序的能力，这些配置文件决定了应用程序需要什么文件和权限。由于建筑设备配置文件具有挑战性，建议您使用类似于<a class="ae na" href="https://github.com/genuinetools/bane" rel="noopener ugc nofollow" target="_blank"> bane </a>的工具。</li></ul><h1 id="8bad" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">5.安全图像</h1><p id="956e" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">在多租户集群中，私有映像只应由拥有凭证的用户使用。为了禁止未授权用户使用图像，使用API服务器的<strong class="jp ir"> AlwaysPullImages </strong>准入插件。此外，AlwaysPullImages可以确保获得与特定标签相匹配的最新版本的图像。</p><p id="8648" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当您从公共注册中心或内部私有注册中心获取现成的图像时，您可以依靠签名图像来确保这些图像是真实的和预期的。一个更好的解决方案是，尝试让kubernetes只从一个可信的注册表中提取图像，并阻止所有其他图像。</p><p id="c840" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当您构建您的映像时，在第一个“from”语句中从一个经过全面审查的注册表中开始一个安全的基础映像是很重要的。</p><p id="ac44" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">集装箱图像扫描仪用于检查图像中包含的包裹。一些扫描程序还报告已知的恶意软件或敏感数据的存在。自动扫描仪应定期扫描文档和图像。</p><h1 id="5d32" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">6.机密管理</h1><p id="425a" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">如果您的应用程序代码需要访问凭证和其他机密信息，您有两种选择:将机密存储在etcd或第三方存储中。主要的云提供商都有密钥管理系统，将它们用于机密信息，与etcd一起用于不太敏感的信息。限制读写RBAC的秘密。</p><p id="bc14" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将机密传递给应用程序代码时，最好使用机密作为挂载的机密文件，而不是来自环境变量，因为注销环境以暴露机密是很常见的，并且永远不要将敏感信息(密码、令牌、证书)存储在映像中。</p><h1 id="6cd0" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">7.记录和监控API访问事件</h1><p id="5530" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">Kubernetes中有不同的日志来源。应用程序、工作负载和Kubernetes组件生成自己的日志。入口流量是非常重要的日志来源。Kubernetes事件详细描述了资源状态的错误和变化。审计日志包括对Kubernetes的API调用。</p><p id="499c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">日志应定期轮换，以确保它们在删除前得到存储。一些日志，比如事件日志和审计日志，应该存储在Kubernetes集群之外的持久位置。在所有集群节点上依靠第三方安全监控工具(<strong class="jp ir"> Falco </strong>、<strong class="jp ir"> Aqua Enterprise </strong>)是一种选择。</p></div><div class="ab cl nb nc hu nd" role="separator"><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng"/></div><div class="ij ik il im in"><p id="bed5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">来自Infosec的报道:Infosec上每天都会出现很多难以跟上的内容。 <a class="ae na" href="https://weekly.infosecwriteups.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir"> <em class="mz">加入我们的每周简讯</em> </strong> </a> <em class="mz">以5篇文章、4个线程、3个视频、2个Github Repos和工具以及1个工作提醒的形式免费获取所有最新的Infosec趋势！</em></p></div></div>    
</body>
</html>