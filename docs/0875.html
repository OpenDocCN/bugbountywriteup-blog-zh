<html>
<head>
<title>Secure network monitoring with elastic — Packetbeat + Suricata</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用elastic-packet beat+Suricata实现安全网络监控</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/secure-network-monitoring-with-elastic-packetbeat-suricata-7ecd871b1a52?source=collection_archive---------0-----------------------#2020-10-11">https://infosecwriteups.com/secure-network-monitoring-with-elastic-packetbeat-suricata-7ecd871b1a52?source=collection_archive---------0-----------------------#2020-10-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="e7d5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">使用ELK stack、Packetbeat和Suricata对网络进行安全监控</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/7136bb0c42fda2231a0ffbb1a99eaed7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*poXRRZdZAElrrP9C3ZQLoQ.jpeg"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">泰勒·维克在Unsplash<a class="ae le" href="https://unsplash.com/s/photos/network?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">上的照片</a></figcaption></figure><p id="ecab" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果你想保护网络分段，这不是你唯一需要的东西。我们现在面对的是拥有多种设备需要保护的公司。如今，监控您的网络和设备是绝对必要的，每个组织都应该收集有关其设备和网络的所有可能的安全信息。如果您不监控您的网络或设备，您如何能够检测出什么是正常行为或攻击？存在明显的恶意攻击，但在任何网络安全事件中，早期检测都至关重要。检测异常活动的最佳且更实用的方法之一是网络监控。在这篇文章中，我们将会看到如何用一些开源工具来监控你的网络，然后将所有的信息聚集到一个ELK集群中。</p><h1 id="49ea" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">期待tcpdump和Wireshark</h1><p id="52d1" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">可能在阅读标题后，您想到的一些工具是Wireshark/tshark或tcpdump。尽管这些工具是很好的网络数据包分析器，但并不集中于自动检测。我们将使用使用或实现tcpdump功能但具有更多功能的工具。此外，tshark和tcpdump都没有与elasticsearch直接集成。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi mi"><img src="../Images/0e577e59e1368bcf0da1499c7e63e21b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QFTJwELHBOTvbKFh2LinXw.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">与ELK集成的开源监控工具</figcaption></figure><p id="2060" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这并不完全正确，tshark已经与旧版本的elasticsearch进行了某种整合，但目前还不可用。Tshark提供了一个选项<code class="fe mj mk ml mm b">-T ek</code>，可以生成JSON输出和弹性映射。但是我只能在ELK 6.6.0集群上配置和使用这些选项，并且经过了大量的调整。</p><pre class="kp kq kr ks gt mn mm mo mp aw mq bi"><span id="bcda" class="mr lg it mm b gy ms mt l mu mv">tshark -i en0 -T ek <br/>tshark -G elastic-mapping --elastic-mapping-filter ip,udp,dns</span></pre><p id="454c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">ELK目前在7.9.2 版本上，在6.6.0版本中我们缺少了很多新功能，比如弹性SIEM。对于<a class="ae le" href="https://bugs.wireshark.org/bugzilla/show_bug.cgi?id=15784" rel="noopener ugc nofollow" target="_blank">的每个功能</a>都有<a class="ae le" href="https://bugs.wireshark.org/bugzilla/show_bug.cgi?id=15719" rel="noopener ugc nofollow" target="_blank">两个未解决的bug</a>，所以让我们希望一切都在某个时候得到解决。这种情况促使我检查网络监控的其他可能性，事实是，现在，我们不需要tshark。在这种情况下，我们将使用Packetbeat和Suricata。</p><h1 id="ce70" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">包装杯</h1><p id="9ae9" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated"><a class="ae le" href="https://www.elastic.co/es/beats/packetbeat" rel="noopener ugc nofollow" target="_blank"> Packetbeat </a>是由Elasticsearch开发的网络监控工具，使用libpcap库进行网络流量捕获。使用这个工具，我们可以监控HTTP、TLS或DNS以及其他网络协议。但有必要提及的是，该工具的重点不是安全性，而是应用程序监控。这并不意味着从安全角度来看没有用，但是我们需要注意一些限制。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi mw"><img src="../Images/3bc4bc2dc86af716e6a947648cf139c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1132/format:webp/1*Mz6u0UcbN6PDyEBC2tEhrQ.png"/></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated"><a class="ae le" href="https://www.elastic.co/es/beats/packetbeat" rel="noopener ugc nofollow" target="_blank">https://www.elastic.co/es/beats/packetbeat</a></figcaption></figure><h2 id="b2e7" class="mr lg it bd lh mx my dn ll mz na dp lp kb nb nc lt kf nd ne lx kj nf ng mb nh bi translated">配置数据包比特</h2><p id="3411" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">要使用Packetbeat，需要修改packetbeat.yml文件来调整我们的配置。首先，我们需要指定嗅探接口。如果你不知道使用哪一个，你可以运行<code class="fe mj mk ml mm b">packetbeat devices</code>来检查你的接口。分配了IP地址的接口可能就是您想要监控的接口。不幸的是，现在你不能选择两个或更多的接口<a class="ae le" href="https://github.com/elastic/beats/issues/263" rel="noopener ugc nofollow" target="_blank">，因为缺乏对多接口</a>的支持。在Linux中，我们有选择<code class="fe mj mk ml mm b">any</code> <em class="ni"> </em>监听所有接口的可能性。要选择我们的接口，我们只需在<em class="ni"> packetbeat.yml. </em>中写入接口名称</p><pre class="kp kq kr ks gt mn mm mo mp aw mq bi"><span id="d281" class="mr lg it mm b gy ms mt l mu mv">packetbeat.interfaces.device: <strong class="mm iu">eth0</strong></span></pre><p id="e266" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">同样在Linux中，我们可以打开<code class="fe mj mk ml mm b">af_packet</code>作为数据包接口。af_packet是libpcap的替代方案，能够提供快速网络嗅探。</p><pre class="kp kq kr ks gt mn mm mo mp aw mq bi"><span id="5e01" class="mr lg it mm b gy ms mt l mu mv">packetbeat.interfaces.type: af_packet</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/e3155cb147405672eb3beb17273e8de8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1396/format:webp/1*m640q6g6kiq8p4DOzxWZDg.png"/></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">packetbeat.yml配置文件</figcaption></figure><h2 id="96bd" class="mr lg it bd lh mx my dn ll mz na dp lp kb nb nc lt kf nd ne lx kj nf ng mb nh bi translated">数据包协议</h2><p id="9cfb" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">如前所述，我们可以使用Packetbeat监控几个网络协议。同样在<em class="ni"> packetbeat.yml </em>文件中，我们需要指定我们想要监控的每个端口和协议。如果我们使用一些非标准端口，我们将需要在这一部分指定它们。此时，您可能意识到了packetbeat的安全限制，如果有人通过8081端口或任何其他非默认端口发送HTTP流量，而我们没有在配置中包括这些端口，会发生什么情况？。如果发生这种情况，Packetbeat将无法检测和解析该流量。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nk"><img src="../Images/fbc59e433807e3ebba65f63ae6d1c47e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3VuD_45hjQ_RmW-1C21qnA.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">指定端口和协议的packetbeat.yml文件</figcaption></figure><p id="47f5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">尽管这种情况可能发生，但这并不意味着packetbeat在网络监控中没有用。例如，使用Packetbeat的DNS监控对于防范安全事故非常有用。我只是指出这一点，以证明包括更多网络监控工具的必要性，就像前面提到的那些。</p><h2 id="3299" class="mr lg it bd lh mx my dn ll mz na dp lp kb nb nc lt kf nd ne lx kj nf ng mb nh bi translated">打包输出</h2><p id="1c6f" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">被打包作为Elastic团队开发的工具，针对elasticsearch进行配置真的很容易吗？像ELK stack的任何其他beat一样，我们需要在<em class="ni"> packetbeat.yml </em>中指定elasticsearch或logstash输出。至此，包含一个<code class="fe mj mk ml mm b">geoip-info</code>管道真的有用吗？</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/a2c71bcceb472497aead4ac8292a6b7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1356/format:webp/1*6W-Y4C2NJLgarlvE51Fmug.png"/></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">packetbeat.yml输出配置文件</figcaption></figure><h2 id="ccaa" class="mr lg it bd lh mx my dn ll mz na dp lp kb nb nc lt kf nd ne lx kj nf ng mb nh bi translated">地理信息</h2><p id="b730" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">Kibana的一个很酷的功能是他们的地图，如果我们对网络IP进行地理定位，我们将能够在地图上描绘这些信息。由于与Maxmind GeoLite2城市数据库的集成，Elastic能够自动地理定位IP，但我们需要配置elastic <code class="fe mj mk ml mm b">geoip</code>处理器。在将<code class="fe mj mk ml mm b">pipeline: geoip-info</code>添加到我们的<em class="ni"> packetbeat.yml </em>文件之后，我们需要指明elastic来地理定位这些IP。</p><p id="8385" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">执行该操作所需的唯一步骤是在elasticsearch中创建一个摄取节点管道。我们可以使用Kibana控制台或<code class="fe mj mk ml mm b">curl</code>运行下面的PUT来创建管道。</p><pre class="kp kq kr ks gt mn mm mo mp aw mq bi"><span id="d6a4" class="mr lg it mm b gy ms mt l mu mv">PUT _ingest/pipeline/geoip-info<br/>{<br/>  "description": "Add geoip info",<br/>  "processors": [<br/>    {<br/>      "geoip": {<br/>        "field": "client.ip",<br/>        "target_field": "client.geo",<br/>        "ignore_missing": true<br/>      }<br/>    },<br/>    {<br/>      "geoip": {<br/>        "field": "source.ip",<br/>        "target_field": "source.geo",<br/>        "ignore_missing": true<br/>      }<br/>    },<br/>    {<br/>      "geoip": {<br/>        "field": "destination.ip",<br/>        "target_field": "destination.geo",<br/>        "ignore_missing": true<br/>      }<br/>    },<br/>    {<br/>      "geoip": {<br/>        "field": "server.ip",<br/>        "target_field": "server.geo",<br/>        "ignore_missing": true<br/>      }<br/>    },<br/>    {<br/>      "geoip": {<br/>        "field": "host.ip",<br/>        "target_field": "host.geo",<br/>        "ignore_missing": true<br/>      }<br/>    }<br/>  ]<br/>}</span></pre><p id="c575" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在执行这个PUT之后，Packetbeat发送到我们ELK集群的每个IP都将被地理定位。这个过程也可以使用Logstash和<a class="ae le" href="https://www.elastic.co/guide/en/logstash/current/plugins-filters-geoip.html" rel="noopener ugc nofollow" target="_blank"> Geoip过滤器插件</a>来完成，但是在ELK集群中并不总是需要Logstash。</p><h2 id="80c4" class="mr lg it bd lh mx my dn ll mz na dp lp kb nb nc lt kf nd ne lx kj nf ng mb nh bi translated">Kibana仪表板</h2><p id="0cd3" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">使用Packetbeat的另一个有用的东西是它们预先配置的Kibana仪表板。Packetbeat附带了几个仪表板，用于轻松分析网络流量。此外，每个仪表板都可以修改，我总是建议在Kibana中设置这些仪表板，然后根据您的需要定制它们。同样，我们需要修改<em class="ni"> packetbeat.yml </em>来指示我们在setup.kibana下的Kibana位置。如果在此部分没有指定凭证，packetbeat将使用output.elasticsearch凭证来验证kibana。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nk"><img src="../Images/652e170e893a9b838d63b5a03c720908.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ytVfr1trZ-xWmyS9_s9vTQ.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">packetbeat.yml Kibana配置</figcaption></figure><p id="b951" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">写完这些配置后，我们可以用<code class="fe mj mk ml mm b">packetbeat test config -e</code>来检查一切是否正确</p><p id="96c7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">此后，我们可以开始部署Kibana仪表板，并使用<code class="fe mj mk ml mm b">packetbeat setup -e</code>加载弹性指数映射。如果一切正常，我们应该会看到这条消息:<em class="ni">“ki Bana仪表板成功加载”。</em></p><h2 id="14ab" class="mr lg it bd lh mx my dn ll mz na dp lp kb nb nc lt kf nd ne lx kj nf ng mb nh bi translated">发射包包</h2><p id="549e" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">唯一剩下的就是发射Packetbeat。作为一个网络监控工具，我们需要一个sudo用户。首先，我们需要将<em class="ni"> packetbeat.yml </em>的所有者改为root，然后启动packetbeat。</p><pre class="kp kq kr ks gt mn mm mo mp aw mq bi"><span id="1ae2" class="mr lg it mm b gy ms mt l mu mv">sudo chown root packetbeat.yml</span><span id="5a67" class="mr lg it mm b gy nm mt l mu mv">sudo ./packetbeat -e</span></pre><h1 id="503b" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">网络IDS和IPS — Suricata</h1><p id="2dca" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">在整篇文章中，我一直提到，作为一个完整的网络安全监控解决方案，Packetbeat是不够的。我们需要用其他网络安全解决方案来补充这个工具，这些解决方案可以充当网络入侵检测和保护系统(NIDS和NIPS)。一个可以实现这个功能的开源工具是<a class="ae le" href="https://suricata-ids.org/features/all-features/" rel="noopener ugc nofollow" target="_blank"> Suricata </a>。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/1095540b25d2678cda2c9793b3c604f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:722/0*3p3RC0fxA-TbeGrN"/></div></figure><p id="34de" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Suricata提供检测和保护功能，可与ELK堆栈集成。与Packetbeat不同，Suricata监控网络流量，并尝试与一些预定义的安全规则进行匹配。如果该流量符合特定安全规则，Suricata可以生成警报或阻止该流量。此外，有许多检测恶意活动的开放规则，但我们也可以创建自己的规则。</p><h2 id="fa05" class="mr lg it bd lh mx my dn ll mz na dp lp kb nb nc lt kf nd ne lx kj nf ng mb nh bi translated">安装Suricata</h2><p id="4c17" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">Suricata被广泛使用，有<a class="ae le" href="https://suricata-ids.org/download/" rel="noopener ugc nofollow" target="_blank">二进制包</a>帮助它的安装。在Ubuntu/Debian系统中安装Suricata就像输入<code class="fe mj mk ml mm b">sudo apt install suricata</code>一样简单。</p><p id="bb31" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果你在Ubuntu/Debian系统上通过二进制包安装Suricata，日志的默认文件夹将是<em class="ni"> /var/log/suricata </em>，配置文件将在<em class="ni"> /etc/suricata </em>中。</p><h2 id="b8a0" class="mr lg it bd lh mx my dn ll mz na dp lp kb nb nc lt kf nd ne lx kj nf ng mb nh bi translated">下载苏里卡塔规则</h2><p id="0dba" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">如前所述，Suricata使用规则来检测恶意活动。这使得Suricata成为NIDS/NIPS的标志性基础系统。您可以手动下载并安装这些规则，但最好的方法是使用像suricata-update或oinkmaster这样的工具。有几组公共规则由社区维护并经常更新，因为最好的选择是使用可以定期下载这些更新的工具。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi no"><img src="../Images/ae03f39ace47502ba5f1d4bdf6311aba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OHifWo8G5mEn6YbdKv_pSg.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">来自<a class="ae le" href="https://suricata.readthedocs.io/en/suricata-4.1.4/rules/intro.html" rel="noopener ugc nofollow" target="_blank">https://Suricata . readthedocs . io/en/suricata-4 . 1 . 4/rules/intro . html</a>的suricata规则示例</figcaption></figure><p id="020f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果我们选择oinkmaster，它可以很容易地在Debian/Ubuntu系统中使用apt安装<code class="fe mj mk ml mm b">sudo apt install oinkmaster</code>。然后我们需要编辑<em class="ni"> /etc/oinkmaster.conf </em>来指定规则可以从哪里<a class="ae le" href="http://rules.emergingthreats.net/open/suricata/emerging.rules.tar.gz" rel="noopener ugc nofollow" target="_blank">下载</a>。</p><pre class="kp kq kr ks gt mn mm mo mp aw mq bi"><span id="0337" class="mr lg it mm b gy ms mt l mu mv">url  = http://rules.emergingthreats.net/open/suricata/emerging.rules.tar.gz</span></pre><p id="c950" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">添加这些信息后，我们可以使用我们的配置文件运行oinkmaster，并指定存储规则的位置。</p><pre class="kp kq kr ks gt mn mm mo mp aw mq bi"><span id="4e76" class="mr lg it mm b gy ms mt l mu mv">sudo oinkmaster -C /etc/oinkmaster.conf -o /etc/suricata/rules</span></pre><p id="7a5d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这个命令也是更新规则的命令，所以您应该每天运行oinkmaster。一个简单的方法是用oinkmaster命令添加一个crontab。只需记住oinkmaster需要sudo权限，因此它应该是root用户crontab。</p><pre class="kp kq kr ks gt mn mm mo mp aw mq bi"><span id="8d86" class="mr lg it mm b gy ms mt l mu mv">0 1 * * * oinkmaster -C /etc/oinkamaster.conf –o /etc/suricata/rules</span></pre><h2 id="baf3" class="mr lg it bd lh mx my dn ll mz na dp lp kb nb nc lt kf nd ne lx kj nf ng mb nh bi translated">配置Suricata规则</h2><p id="fcb1" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">Suricata有多个规则，我们需要告诉Surica使用哪一组规则。首先，我们需要编辑<em class="ni">/etc/suricata/suricata . YAML</em>来指示分类文件所在的位置。这个分类文件列出了Suricata使用所有可能的规则集。用oinkmaster下载规则后，这个分类文件必须出现在<em class="ni"> /etc/suricata/rules a </em>下。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi np"><img src="../Images/18a3f8a867bb2b9681a353cad4143759.png" data-original-src="https://miro.medium.com/v2/resize:fit:1348/format:webp/1*XkO5_DqsAjsSU7_rzUsDFA.png"/></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">suricata.yaml配置文件</figcaption></figure><p id="44ea" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然后，我们需要在rule-files部分下添加我们想要使用的规则集。如果你只是想添加所有的规则，我创建了一个<a class="ae le" href="https://gist.github.com/CarlosLannister/3ea9aaa15fe4f0825134e21881354139" rel="noopener ugc nofollow" target="_blank"> gist </a>文件，方便复制粘贴所有的名字。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nq"><img src="../Images/78b36caa60019e6f7ced55260e1222aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CeH4eVlK6kJXmgSEnmC_SA.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">suricata.yaml规则-文件</figcaption></figure><h2 id="49a9" class="mr lg it bd lh mx my dn ll mz na dp lp kb nb nc lt kf nd ne lx kj nf ng mb nh bi translated">网络结构</h2><p id="d6c5" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">我们需要配置的另一件事是在<em class="ni"> suricata.yaml </em>文件中指定我们的家庭网络。这将允许Suricata区分传入和传出流量。默认情况下，所有不是来自我们家庭网络的流量都将被归类为外部流量，<em class="ni">！$HOME_NET </em>。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nr"><img src="../Images/1673ef5849ea099e9d45f522c694e6b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oKYshjliCZATx8AntBlj-g.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">suricata.yaml中的家庭网络和外部网络IPs</figcaption></figure><h2 id="e63d" class="mr lg it bd lh mx my dn ll mz na dp lp kb nb nc lt kf nd ne lx kj nf ng mb nh bi translated">测试并运行Suricata</h2><p id="e0c8" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">在安装和配置完Suricata之后，我们可以试着运行它。使用<code class="fe mj mk ml mm b">-i</code>选项，我们可以选择Suricata将要监听的接口，也推荐使用<code class="fe mj mk ml mm b">--init-errors-fatal</code>来检测可能的错误。</p><pre class="kp kq kr ks gt mn mm mo mp aw mq bi"><span id="57ec" class="mr lg it mm b gy ms mt l mu mv">sudo suricata -c /etc/suricata/suricata.yaml -i <strong class="mm iu">eth0 --init-errors-fatal</strong></span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ns"><img src="../Images/7c95e61a1ea3b900c9a6384f1beed5e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*arbWy0SzVKg_Hi1b7nUPSQ.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">苏里卡塔发射无误</figcaption></figure><p id="0e9a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">根据您的系统和您的Suricata安装，一些规则可能会给您带来错误。例如，Suricata可以监控网络工业协议，如Modbus或DNP3，但您需要从源代码安装Suricata才能拥有这些功能。如果您对监控这些协议不感兴趣，您可以禁用这个规则文件(在<em class="ni"> suricata.yaml </em>中)。</p><h2 id="58cf" class="mr lg it bd lh mx my dn ll mz na dp lp kb nb nc lt kf nd ne lx kj nf ng mb nh bi translated">IPS模式</h2><p id="47d3" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">所有以前的Suricata设置它是作为一个IDS，没有任何交通阻塞选项。如果我们想要阻止流量，我们需要激活IPS模式。Suricata可以使用NFQUEUE作为IPS工作，因此这种IPS模式只能在Linux系统中运行。</p><p id="03e5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们可以用我们想要的配置创建一个nf queue<a class="ae le" href="https://suricata.readthedocs.io/en/suricata-4.1.2/setting-up-ipsinline-for-linux.html" rel="noopener ugc nofollow" target="_blank">,然后用<code class="fe mj mk ml mm b">-q</code>参数将该队列指定给Suricata。</a></p><pre class="kp kq kr ks gt mn mm mo mp aw mq bi"><span id="a780" class="mr lg it mm b gy ms mt l mu mv">sudo suricata -c /etc/suricata/suricata.yaml <strong class="mm iu">-q 0</strong></span></pre><h2 id="b0a3" class="mr lg it bd lh mx my dn ll mz na dp lp kb nb nc lt kf nd ne lx kj nf ng mb nh bi translated">苏里卡塔与麋鹿的融合</h2><p id="4313" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">在所有这些之后，剩下的唯一事情就是将Suricata与我们的麋鹿群整合。默认情况下，Suricata会在<em class="ni"> /var/log/suricata/eve.json中创建一个包含json事件的日志。</em>任何JSON事件都可以插入到elastic中，但是我们有一个官方的、受支持的使用Filebeat的集成。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nt"><img src="../Images/5137622b5c402fb0c18fc3c1d5a19c6c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1398/format:webp/1*3J9eH8e9kPSwEbw0_hd4xA.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">包含Tor事件的Suricata eve.json文件</figcaption></figure><h2 id="61c9" class="mr lg it bd lh mx my dn ll mz na dp lp kb nb nc lt kf nd ne lx kj nf ng mb nh bi translated">Filebeat</h2><p id="4179" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">Filebeat是将日志传送到ELK集群的最佳方式之一。Filebeat有许多<a class="ae le" href="https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-modules.html" rel="noopener ugc nofollow" target="_blank">模块</a>，可用于吸收多种服务和技术。第一步是从<a class="ae le" href="https://www.elastic.co/es/downloads/beats/filebeat" rel="noopener ugc nofollow" target="_blank">弹性网页</a>下载Filebeat。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/26bb699d9d67c884f517746e2687c68b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1150/format:webp/1*kEblSe4HMbkuhxkO7FvQWA.png"/></div></figure><p id="6e0e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">下载Filebeat后，我们可以开始启用我们感兴趣的模块。我们将发布Suricata日志事件，因此我们需要启用Suricata模块。</p><pre class="kp kq kr ks gt mn mm mo mp aw mq bi"><span id="c811" class="mr lg it mm b gy ms mt l mu mv">filebeat modules enable suricata</span></pre><p id="4631" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然后我们需要在<em class="ni"> /modules.d/suricata.yml </em>中编辑模块Suricata的配置。Filebeat中的每个模块都有一个配置文件，因为我们只发送Suricata日志，我们只需要修改suricata.yaml中的<em class="ni"> suricata.yml. </em>我们需要在tag var.paths部分指定Suricata JSON日志的位置。在我们的例子中，路径将是<em class="ni">/var/log/suricata/eve . JSON</em>。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nv"><img src="../Images/026b4526cb8bb0d60aae8b13c3e56044.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qE0Wlp5uWUxcHjg-SSafLw.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">filebeat/modules . d/suricata . yml配置文件</figcaption></figure><p id="e904" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，我们需要编辑<em class="ni"> filebeat.yml. A </em> s，我们用<em class="ni"> packetbeat.yml </em>进行了编辑。有必要配置我们的elastic和Kibana输出，添加必要的地址和凭证。在这里，我还将推荐添加地理ip信息管道，以地理定位苏里卡塔确定的所有IP。</p><p id="1393" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">此外，我们可以执行的另一个调整是地理定位我们的家庭网络IP。内部地址不能使用MaxMind数据库进行地理定位，但是我们可以在<em class="ni"> filebeat.yml、</em>中指定如何处理这些地址。这不是一个强制性的步骤，但它可以让我们看到基巴纳内部更完整的地图。在<em class="ni"> filebeat.yml </em>里面有一个叫做processors的部分，在这里我们可以指定属于一个网络空间的所有地址都要添加某些地理位置信息。在我的例子中，我正在把马德里地区的地理位置信息添加到我的家庭网络中，但是你可以选择你想要的任何信息。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/522c202642f41f52ef74a2a1be4ee260.png" data-original-src="https://miro.medium.com/v2/resize:fit:1294/format:webp/1*jCpTnP5lBmYAiCqtpIB5lQ.png"/></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">geo-ip处理器文件节拍</figcaption></figure><p id="d74b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最后，我们只需要在Kibana上加载所有映射和仪表板，没错，Suricata也有预定义的Kibana仪表板，然后启动Filebeat。</p><pre class="kp kq kr ks gt mn mm mo mp aw mq bi"><span id="2cf7" class="mr lg it mm b gy ms mt l mu mv">filebeat setup -e</span><span id="f489" class="mr lg it mm b gy nm mt l mu mv">filebeat -e</span></pre><p id="673f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果一切正常，您应该会看到如下所示的输出，从中您可以了解日志路径是如何配置的。另外，记得使用sudo权限启动Filebeat，以便能够读取<em class="ni"> /var/log/suricata </em>文件夹。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nv"><img src="../Images/8faf1602f3d36b55910aed4175729586.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*J8QJBzznsk0Y0rGxgLT5iQ.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">来自Suricata eve.json日志文件的Filebeat运行和运输信息</figcaption></figure><h1 id="6f40" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">基巴纳</h1><p id="fdd7" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">最后，我们可以打开我们的Kibana，查看所有已经加载的酷信息和仪表板。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi nx"><img src="../Images/3235d8e1de8126e1fb405b2cc724a1c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/format:webp/0*-2ZRcYcE_xpr5VuD.jpg"/></div></figure><p id="3e16" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">请记住，您可以使用Kibana创建自己的可视化效果，但是在我看来，您已经拥有了足够多的可视化效果。Packetbeat有一个概述仪表板，显示一些通用信息和几个到其他仪表板的链接。我的建议是从概览仪表板开始，然后根据你的需要跳到每个细节。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ny"><img src="../Images/eb8bc141a958a97977ea5505826d2d2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AOcOfTm7tt3BqKu8AWEMHA.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">Packetbeat概览仪表板</figcaption></figure><p id="158f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在Suricata的情况下，您将拥有一个警报总览仪表板和事件总览仪表板。事件概述提供了一些关于我们网络的一般信息，更多安全关键信息将在警报概述仪表板中显示。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nz"><img src="../Images/151743e43f7a66a72a33279d7eafd7d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3EcKr3uf09IYOohs3mTaFQ.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">苏里卡塔事件概述仪表板</figcaption></figure><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi oa"><img src="../Images/596014aa6496cd98949009ee86e4f4d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*z7gJf-C6nhNIqCrlsWl3Hw.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">苏里卡塔警报概览仪表板</figcaption></figure><p id="7678" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">每次匹配某个Suricata规则时，都会生成一个警报。根据您激活或包含的规则，您将在Kibana中看到不同的警报。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ob"><img src="../Images/764a77965b887408d0ab7efb8990c2b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-27W8cXaeupCJu_kJQ6TvQ.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">Suricata检测到的顶级警报特征的详细信息</figcaption></figure><p id="511c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">例如，我已经添加了一些Suricata规则来阻止西班牙国家报policia.es的网站，然后如果我试图访问它，就会生成警报。</p><pre class="kp kq kr ks gt mn mm mo mp aw mq bi"><span id="404c" class="mr lg it mm b gy ms mt l mu mv">drop http $HOME_NET any -&gt; $EXTERNAL_NET any (msg:"HTTP Policia.es not allowed *.policia.es"; flow:established,to_server; content:"policia.es"; http_host; isdataat:!1,relative; classtype:bad-unknown; sid:1;)</span><span id="952d" class="mr lg it mm b gy nm mt l mu mv">drop dns $HOME_NET any -&gt; $EXTERNAL_NET any (msg:"DNS Policia.es"; content:"policia"; classtype:policy-violation; sid:2; rev:1;)</span><span id="8cf9" class="mr lg it mm b gy nm mt l mu mv">drop tls $HOME_NET any -&gt; $EXTERNAL_NET any (msg:"SSL Policia.es"; tls.subject:"policia"; classtype:policy-violation; sid:3; rev:1;)</span></pre><h1 id="da5b" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">建议和进一步工作</h1><p id="3337" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">我已经将ELK集群的安全性排除在了本文的范围之外，但是请记住始终启用安全性。你<strong class="js iu">不得在没有任何适当认证</strong>的情况下离开你的麋鹿群 <strong class="js iu">。此外，麋鹿最大的优点之一就是它们的灵活性。我的建议是根据你的需要来调整这个框架。想想你的需求是什么，然后运用我们在这篇文章中学到的所有东西。</strong></p><p id="3758" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我没有谈到和解释的另一件事是Kibana内部的SIEM功能。在我看来，<a class="ae le" href="https://www.elastic.co/siem" rel="noopener ugc nofollow" target="_blank">弹性SIEM </a>是目前创建SIEM的最佳选择。我们已经讨论了如何在Kibana中插入和可视化信息，但是elastic SIEM允许我们做更多的事情。我们可以交叉关联信息，添加检测规则，使用机器学习进行异常检测或通过Slack发送警报。检查并使用Elastic SIEM，因为Packetbeat和Suricata添加的所有信息在那里也是可见和可操作的。</p><p id="e546" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">此外，请记住，还有其他网络安全监控工具。也许你们中的一些人正在考虑Snort和Zeek。这两个工具都与ELK Stack集成，如果你想使用Zeek，最近有一篇关于如何将<a class="ae le" href="https://www.elastic.co/es/blog/collecting-and-analyzing-zeek-data-with-elastic-security" rel="noopener ugc nofollow" target="_blank"> Zeek与elasticsearch </a>结合使用的帖子。最后，就说我正在写另一个系列的文章，涵盖了前面提到的一些话题，所以如果你想阅读其中的一些，请跟我来；).</p></div></div>    
</body>
</html>