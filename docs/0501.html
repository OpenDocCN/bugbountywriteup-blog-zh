<html>
<head>
<title>Account Hijack using Authorization bypass $$$$</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用授权旁路的帐户劫持$$$$</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/account-hijack-using-authorization-bypass-which-made-me-richer-by-ba9dace72682?source=collection_archive---------0-----------------------#2020-02-29">https://infosecwriteups.com/account-hijack-using-authorization-bypass-which-made-me-richer-by-ba9dace72682?source=collection_archive---------0-----------------------#2020-02-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/b2f5b71d6ed760a9080fc5cfb83ddc9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1014/format:webp/1*1vqvnH7bfQlwkZleHkwrhA.jpeg"/></div></figure><p id="fd7b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">读者们好，</p><p id="4336" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">今天，我将分享我的一个发现，通过这个发现，我能够执行完全的账户接管。在继续之前，让我们了解什么是授权。这是一种机制，应用程序通过这种机制来决定经过身份验证的用户是否有资格访问特定的资源。通过下面的例子可以更简单地理解这一点:</p><p id="1451" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">一家公司有两名员工。他们都可以进入自己的办公室，但除了自己的柜子，他们不能进入别人的柜子。还有，这些员工除了自己的以外，看不到别人的工资条或个人详细信息。现在想一想，如果一名员工可以看到某人的个人资料或工资条或任何他无权看到的机密数据？这对公司的保密性将是一个很大的威胁。在这里，这被称为系统漏洞。</p><p id="757c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="ks">还有一个例子是某人的驾照。驾照上的照片可以证明你是谁(身份证明),上面提到的允许你驾驶的车辆只是授权。可以清楚地理解，认证和授权都是遵循基于角色的访问的任何机制的组成部分。</em></p><p id="ac5d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为了更清楚地理解授权，让我们先来理解身份验证，因为我看到许多开发人员没有将两者视为不同的实体，这使得他们的应用程序容易受到破坏的访问控制的攻击。</p><p id="d0d5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">流行的身份验证机制</p><p id="3fa8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">1.<strong class="jw ir"> HTTP基本认证</strong>:这种方法需要用户名和密码通过HTTP头本身，以base64编码。不建议这样做，因为它以纯文本形式发送用户名和密码，这很容易在中间攻击中通过main获得。为了避免这种情况，开发人员需要加密这些数据。但是这又会影响应用程序的速度，因为服务器必须解密每个HTTP请求。</p><p id="d8e2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">2.<strong class="jw ir">摘要认证</strong>:在这种方法中，授权头包含用户名和密码，在发送给服务器之前，将用户名和密码发送给哈希函数，哈希函数使用带有随机数的MD5加密哈希。这种机制容易受到暴力攻击和MD5碰撞攻击。</p><p id="38e9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">3.<strong class="jw ir"> Cookies </strong>:每当用户登录到应用服务器时，都会在用户的浏览器中生成会话Cookies。如你所知，HTTP是一个无状态协议，因此需要在每个请求中向服务器发送这些会话cookies。一旦服务器收到来自用户的任何请求，它就检查有效的会话cookies。如果cookies是有效的，应用程序识别谁是登录用户。</p><p id="bd08" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">4.<strong class="jw ir">承载令牌</strong>:在这种机制中，通过令牌执行认证。提供正确的凭证后，服务器会生成一个令牌，并在每个请求中发送给服务器。</p><p id="c236" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">登录用户的唯一标识不能帮助定义与访问相关的问题。现在，为了确定该经过身份验证的用户应用程序需要执行授权检查的角色和用户权限。这可以通过以下方式实现。</p><p id="e6d7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">1.<strong class="jw ir"> JWT令牌</strong>:这是一种将数据作为JSON对象传输的方法。该信息经过数字签名。可以使用RSA加密算法使用秘密或公共/私有密钥对其进行签名。一个JSON Web Token由三部分组成:<em class="ks">头</em>、<em class="ks">负载、</em>和<em class="ks">签名</em>。标头和有效负载是Base64编码的，然后用句点连接，最后，结果经过算法签名，生成[HEADER]形式的令牌。[索赔]。[签名]。报头由元数据组成，元数据包括令牌类型和用于对令牌进行签名的哈希算法。</p><p id="ec17" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">2.<strong class="jw ir"> OAuth: </strong>该机制定义了一个委托协议，该协议有助于在支持web的应用程序和API的网络中传达授权决策。开放标准授权协议或框架的OAuth标准，描述了分布式和非连接的服务器和服务如何安全地允许对其资产进行身份验证访问，而无需实际共享初始的、相关的单一登录凭据。</p><p id="d110" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">3.<strong class="jw ir"> SAML(安全断言标记语言):</strong>安全断言标记语言(SAML)是双方授权的框架。它有两种机制服务提供者和身份提供者。身份提供者向应用程序提供身份验证，服务提供者信任此信息来提供授权。这是通过交换数字签名的XML文档来完成的。</p><p id="3773" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在我将向您解释我是如何绕过应用程序的授权机制并能够访问某人的数据的。</p><p id="e74f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在我将描述我的一个发现，在这个发现中，我能够绕过特定模块上的授权。使用不正确的旧密码验证来劫持任何最终用户的帐户，同样的漏洞也被利用了！</p><p id="ad73" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在该应用程序的个人资料部分，有一个选项可以获取最终用户活动的详细信息。我发现已经执行了多个活动，如密码重置、图像上传、名字更新等。我注意到，每当我点击任何活动时，它都会向我显示日期、IP、与所执行的操作相关的信息以及活动ID。根据这些信息，我应该做什么，我可以验证我是否执行了这些活动？否则，如果我看到任何恶意活动，我可以更改我的密码。当我点击任何特定活动时，我注意到URL如下所示:</p><p id="2536" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">网址:<a class="ae kt" href="https://example.com/account/activities/" rel="noopener ugc nofollow" target="_blank">https://example.com/account/activities/</a></p><p id="746d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">以下是实际的请求</p><figure class="kv kw kx ky gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi ku"><img src="../Images/44678aef71660701f2227223cd324033.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tr-h-Lax0nXsE0mvpWAVwg.png"/></div></div></figure><p id="fae9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">以下是回应:</p><figure class="kv kw kx ky gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi ld"><img src="../Images/661ff51ff26d3176fbf7371b9f6b4c41.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7_sJGDbVqbm0RkHvfvKFkw.png"/></div></div></figure><p id="eb47" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">通过观察响应，我注意到每个活动都有一个ID。幸运的是只有数字。此外，如果发现可疑活动，还有一个报告链接。当点击报告链接时，有一个重置密码和从所有设备注销的选项。我在下面的请求中观察到一个奇怪的行为。</p><figure class="kv kw kx ky gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi ld"><img src="../Images/68b2b83db64e20faeb604c1f2c7db945.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e1J5_imLbCtuz--j77c1iA.png"/></div></div></figure><p id="2beb" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果发现该活动是恶意的，此请求将更改密码。我向服务器发送了一个原始请求，发现当前会话立即失效。什么！！这太酷了。我执行了相同的活动，但是将参数report-block更改为false。这次什么都没发生。我没有被赶出会议。但我观察到的反应与之前的反应相同。为了验证这一点，我登录并尝试再次登录。奇怪的是，我成功登录。我认为报告块参数是导致这种行为的原因。我把它设置为false，这就是为什么这个请求没有被服务器接受，即使响应是相同的。</p><p id="33c5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">但是等等…为什么我的帐户活动显示我刚刚重设了密码。</p><figure class="kv kw kx ky gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi le"><img src="../Images/8c523788e244fea73c39b010e330c5db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0cRE6eg0waoLhY_X6K8YiA.png"/></div></div></figure><p id="d8f9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">好的，根据应用程序，我的密码被更改了。但是怎么样，我在举报的时候没有输入我现在的密码。我执行了相同的操作，得出的结论是报告模块根本没有验证旧密码！这是一个发现，但严重性仍然很低。</p><p id="953c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我试图暴力报告ID，但得到403响应。</p><p id="7189" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，是时候检查这个请求的授权了。我观察到请求中有3个具有随机id的报头。首先，我删除了授权头，并将请求发送到服务器。应用程序立即抛出一个错误。好吧，这个标题是必不可少的。现在我删除了HUXID和AUXID，并将请求发送到服务器。</p><figure class="kv kw kx ky gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi lf"><img src="../Images/b11923a7370235dd80e8148c9534919b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ov681R6WdXDrWAmvSt76gw.png"/></div></div></figure><p id="11e6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">尽管如此，我还是收到了服务器的403响应。现在除了篡改网址别无选择。我从服务器响应下面的请求中删除了报告id。</p><figure class="kv kw kx ky gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi lg"><img src="../Images/50eca9ea813a25ea1017471e14596852.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vbmOtxIx1vglF5CoFIQRgA.png"/></div></div></figure><p id="0047" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我尝试了很多方法来绕过这个限制，最后，我用下面的方法成功了。</p><figure class="kv kw kx ky gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi lf"><img src="../Images/b8a4a95d707d3ac84497b09e8e3806ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OB5XWfmM3LowKkTn_TpxSg.png"/></div></div></figure><p id="e9e9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我只是补充废话/../../../report/ <activity id="" of="" another="" account=""> /到原网址瞧！！我得到了200 OK的回复。我立即尝试用新设置的密码登录我的另一个帐户，是的，我成功登录了！</activity></p><p id="47f7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我多次验证这个漏洞，观察到同样的行为！我赶紧创建了一个视频POC，报了上去。他们在三天内修补了相同的内容，并以4位数的形式奖励了我$$。</p><p id="6792" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">被利用的漏洞</strong>:模块中旧密码的不正确验证+使用URL操作绕过授权</p><p id="159b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如有任何反馈或建议，请联系我@ <a class="ae kt" href="http://twitter.com/Bhavesh_Thakur_?s=09" rel="noopener ugc nofollow" target="_blank">巴维什</a></p></div><div class="ab cl lh li hu lj" role="separator"><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm"/></div><div class="ij ik il im in"><p id="c315" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="ks">关注</em> <a class="ae kt" href="https://medium.com/bugbountywriteup" rel="noopener"> <em class="ks"> Infosec报道</em> </a> <em class="ks">获取更多此类精彩报道。</em></p><div class="lo lp gp gr lq lr"><a href="https://medium.com/bugbountywriteup" rel="noopener follow" target="_blank"><div class="ls ab fo"><div class="lt ab lu cl cj lv"><h2 class="bd ir gy z fp lw fr fs lx fu fw ip bi translated">信息安全报道</h2><div class="ly l"><h3 class="bd b gy z fp lw fr fs lx fu fw dk translated">收集了世界上最好的黑客的文章，主题从bug奖金和CTF到vulnhub…</h3></div><div class="lz l"><p class="bd b dl z fp lw fr fs lx fu fw dk translated">medium.com</p></div></div><div class="ma l"><div class="mb l mc md me ma mf js lr"/></div></div></a></div></div></div>    
</body>
</html>