<html>
<head>
<title>DHCP starvation attack without making any DHCP requests</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">不发出任何DHCP请求的DHCP饥饿攻击</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/dhcp-starvation-attack-without-making-any-dhcp-requests-bef0022133c9?source=collection_archive---------2-----------------------#2020-08-20">https://infosecwriteups.com/dhcp-starvation-attack-without-making-any-dhcp-requests-bef0022133c9?source=collection_archive---------2-----------------------#2020-08-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/90bef974b11551c0ed7c9ec1db9b912e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CNbOSTdkJn3gYqrVDU1l3A.jpeg"/></div></div></figure><p id="a734" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">DHCP(动态主机配置协议)是一种网络协议，它为进入网络的主机提供IP地址和其他所需的详细信息，包括网关IP、DNS IP。在<a class="ae kw" href="https://tools.ietf.org/html/rfc2131" rel="noopener ugc nofollow" target="_blank"> RFC2131 </a>中定义的DHCP协议涉及客户端和服务器之间的4个来回交易，即:</p><ul class=""><li id="2da9" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated">DHCP发现—从客户端广播</li><li id="f6b5" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">DHCP服务—从服务器广播</li><li id="b582" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">DHCP请求—来自客户端的单播</li><li id="50a1" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">DHCP ACK —来自服务器的单播</li></ul><p id="885f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://en.wikipedia.org/wiki/Dynamic_Host_Configuration_Protocol" rel="noopener ugc nofollow" target="_blank">维基百科惊人地解释了DHCP协议</a>！</p><h1 id="e9d3" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">DHCP攻击</h1><p id="99ef" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">与ARP协议类似，由于其无法对进入网络的用户进行身份认证，对该协议的攻击也出现了多种类型。以下是一些众所周知的DHCP攻击:</p><ul class=""><li id="2268" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated"><strong class="ka ir"> DHCP窥探</strong>:在这种攻击中，恶意客户端充当DHCP服务器，在客户端进入网络时为其提供服务。恶意客户端可以发送自定义网关和DNS服务器IP，以将自己确立为中间人并执行DNS中毒。</li><li id="9f9f" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><strong class="ka ir"> DHCP饥饿</strong>:在这种攻击中，恶意客户端发送多个DHCP请求，并持有DHCP池中存在的所有IP地址，从而不允许任何新主机加入网络。拒绝服务。</li></ul><h1 id="230b" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">DHCP饥饿—协议剖析</h1><p id="ecfa" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">下图显示了DHCP交易期间数据包捕获的屏幕截图。</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mo"><img src="../Images/33885442d90aa24b330ab2ed682b4602.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yYviCGk8gqPq4DXZHdanvw.png"/></div></div><figcaption class="mt mu gj gh gi mv mw bd b be z dk translated">DHCP事务的数据包捕获</figcaption></figure><h2 id="f580" class="mx lm iq bd ln my mz dn lr na nb dp lv kj nc nd lz kn ne nf md kr ng nh mh ni bi translated">ARP在这里做什么？</h2><p id="8a3c" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">DHCP服务器广播一个ARP请求，然后是一个ICMP请求，以确保它要提供给DHCP的IP地址确实可用。尤里卡。</p><p id="b29f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为什么需要发出DHCP请求来使DHCP池饥饿？大多数防御系统会寻找来自同一个MAC地址的重复DHCP请求。如果我回复了DHCP的ARP请求，让DHCP相信IP地址已经在用了怎么办？</p><p id="5fee" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，在本文中，让我们看看如何进行ARP欺骗来模拟一个不存在的客户端，使DHCP服务器相信从地址池中挑选出来提供DHCP服务的IP地址已经被另一个客户端占用。</p><h1 id="532d" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">实验</h1><p id="d8fa" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">在这个实验中，让我们使用网络模拟工具<a class="ae kw" href="https://www.gns3.com/" rel="noopener ugc nofollow" target="_blank"> GNS3 </a>和<a class="ae kw" href="https://www.docker.com/" rel="noopener ugc nofollow" target="_blank"> Docker </a>容器作为DHCP服务器、恶意客户端和良性客户端。</p><h2 id="8f4c" class="mx lm iq bd ln my mz dn lr na nb dp lv kj nc nd lz kn ne nf md kr ng nh mh ni bi translated">DHCP服务器</h2><p id="268b" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">让我们从头开始创建一个DHCP服务器。登录到GNS3虚拟机(这是容器旋转的地方)。ISC DHCP服务器软件用于在ubuntu容器[ <a class="ae kw" href="https://www.tecmint.com/install-dhcp-server-in-ubuntu-debian/" rel="noopener ugc nofollow" target="_blank">参考</a> ]中配置和运行DHCP服务器。</p><ul class=""><li id="a5e5" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated">创建一个包含以下内容的Dockerfile文件:</li></ul><figure class="mp mq mr ms gt jr"><div class="bz fp l di"><div class="nj nk l"/></div></figure><ul class=""><li id="b3f9" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated">通过运行<code class="fe nl nm nn no b">docker build -t dhcp-server .</code>构建docker映像。</li><li id="c423" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">然后，将构建的docker映像作为GNS3设备导入。<a class="ae kw" href="https://docs.gns3.com/docs/emulators/docker-support-in-gns3/" rel="noopener ugc nofollow" target="_blank">如何</a>？</li><li id="25c8" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">将创建的设备拖入GNS3工作区。</li><li id="950b" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">通过右键单击并选择“启动”来启动服务器。双击节点以获得控制台。</li><li id="4761" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">导航到<code class="fe nl nm nn no b">/etc/dhcp</code>并将以下内容添加到<code class="fe nl nm nn no b">dhcpd.conf</code>文件中。</li></ul><figure class="mp mq mr ms gt jr"><div class="bz fp l di"><div class="nj nk l"/></div></figure><ul class=""><li id="607f" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated">通过运行以下命令，为DHCP服务器创建一个空文件来保存租用的IP地址:</li></ul><pre class="mp mq mr ms gt np no nq nr aw ns bi"><span id="5a34" class="mx lm iq no b gy nt nu l nv nw">touch /var/lib/dhcp/dhcpd.lease</span></pre><ul class=""><li id="cc5d" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated">此外，通过运行以下命令为DHCP服务器分配一个IP地址:</li></ul><pre class="mp mq mr ms gt np no nq nr aw ns bi"><span id="cde1" class="mx lm iq no b gy nt nu l nv nw">ifconfig eth0 192.168.1.1/24</span></pre><ul class=""><li id="9f8c" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated">最后，通过运行命令<code class="fe nl nm nn no b">dhcpd</code>启动DHCP服务器。</li></ul><h2 id="5e4d" class="mx lm iq bd ln my mz dn lr na nb dp lv kj nc nd lz kn ne nf md kr ng nh mh ni bi translated">恶意客户端和良性客户端</h2><p id="b727" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">恶意客户端是安装了<a class="ae kw" href="https://scapy.net/" rel="noopener ugc nofollow" target="_blank"> scapy </a>，<code class="fe nl nm nn no b"><a class="ae kw" href="https://hub.docker.com/r/ehlers/scapy" rel="noopener ugc nofollow" target="_blank">ehlers/scapy</a></code>的Linux机器。将这个docker映像作为一个设备导入到GNS3中，并将它的一个实例拖到工作区中。右键单击工作区上的恶意客户端实例，并使用<code class="fe nl nm nn no b">edit config</code>取消DHCP config下的注释行。这会将实例配置为从DHCP服务器获取IP地址。</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nx"><img src="../Images/151f88965bc7a687f23ffc6a43ef43e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tLMrWi3QCIxztwrDOxjbgw.png"/></div></div><figcaption class="mt mu gj gh gi mv mw bd b be z dk translated">DHCP客户端已启用</figcaption></figure><p id="85ba" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在我们启动恶意客户端之前，将一个GNS3默认交换机拖到工作区。然后，将恶意客户端和DHCP服务器连接到交换机。拖动另一个<code class="fe nl nm nn no b">ehlers/scapy</code>实例，它扮演一个良性客户端的角色。编辑配置，使其看起来类似于恶意客户端。设置完成后，网络看起来类似于下图:</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ny"><img src="../Images/251e27c674d194ea5eae32d7752afc5b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lYXXB64Dwpu7HbU593UbPQ.png"/></div></div><figcaption class="mt mu gj gh gi mv mw bd b be z dk translated">网络拓扑结构</figcaption></figure><p id="27df" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">是时候了！</p><p id="f2a7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">右键单击DHCP服务器和交换机之间的链路，开始数据包捕获。然后，启动恶意客户端。</p><p id="73bb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">观察DHCP事务的发生，恶意客户端成功获得IP地址。</p><h2 id="6215" class="mx lm iq bd ln my mz dn lr na nb dp lv kj nc nd lz kn ne nf md kr ng nh mh ni bi translated">攻击</h2><p id="09dc" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">通过双击恶意客户端获得一个控制台，并使用以下内容创建一个<code class="fe nl nm nn no b">arp_spoof.py</code> python文件。</p><figure class="mp mq mr ms gt jr"><div class="bz fp l di"><div class="nj nk l"/></div><figcaption class="mt mu gj gh gi mv mw bd b be z dk translated">arp_spoof.py</figcaption></figure><p id="37c6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">代码执行ARP欺骗，在我的旧博客中有详细解释。简而言之，每个线程监听特定类型的请求，即ARP请求和ICMP请求，并相应地响应它们。当恶意节点回复ARP请求时，交换机认为与所讨论的IP地址(ARP协议)相关联的MAC地址就是恶意节点的MAC地址。ARP欺骗就是这样实现的。</p><p id="2a07" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">通过点击以下命令运行python代码:</p><pre class="mp mq mr ms gt np no nq nr aw ns bi"><span id="ac79" class="mx lm iq no b gy nt nu l nv nw">python arp_spoof.py</span></pre><p id="dc69" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，启动良性客户端并观察！</p><h1 id="017e" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">观察</h1><p id="2b39" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">双击良性客户端以获得控制台。运行，<code class="fe nl nm nn no b">ifconfig</code>并观察良性客户端尚未收到IP地址！</p><h2 id="0e46" class="mx lm iq bd ln my mz dn lr na nb dp lv kj nc nd lz kn ne nf md kr ng nh mh ni bi translated">为什么？</h2><p id="0fcc" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">观察正在运行的数据包捕获。</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nz"><img src="../Images/9843bba4b263c8f40df4c0ff26449797.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u50ap912c1LC8_ufFmq1AA.png"/></div></div><figcaption class="mt mu gj gh gi mv mw bd b be z dk translated">ARP和IP欺骗造成的DHCP饥饿</figcaption></figure><p id="34c4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">良性客户端不断地让DHCP发现，而DHCP服务器则忙于制作DHCP提供。DHCP服务器无法在其DHCP地址池中找到可用的IP地址。它从DHCP地址池中找到一个IP地址，通过先发出ARP请求再发出ICMP请求来检查该地址是否已被另一台主机占用，这就是恶意客户端对这些消息做出响应的地方。因此，DHCP服务器断定该IP地址已被占用，并跳到地址池中的下一个可用IP地址。这个过程无限重复，良性客户端没有IP地址。<br/>因此，进行了DHCP饥饿攻击！</p><blockquote class="oa ob oc"><p id="c147" class="jy jz od ka b kb kc kd ke kf kg kh ki oe kk kl km of ko kp kq og ks kt ku kv ij bi translated">我都有，但是一个都不会用！— DHCP服务器</p></blockquote></div></div>    
</body>
</html>