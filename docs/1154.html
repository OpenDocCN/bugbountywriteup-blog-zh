<html>
<head>
<title>Finding And Exploiting S3 Amazon Buckets For Bug Bounties</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">寻找和利用S3亚马逊昆虫奖励桶</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/finding-and-exploiting-s3-amazon-buckets-for-bug-bounties-6b782872a6c4?source=collection_archive---------2-----------------------#2021-03-09">https://infosecwriteups.com/finding-and-exploiting-s3-amazon-buckets-for-bug-bounties-6b782872a6c4?source=collection_archive---------2-----------------------#2021-03-09</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="e151" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">许多网站都有私人S3桶，里面装着秘密。我们想要他们。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/7c1bf7ad5b878dfdbb8e777d5bb6f237.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*5JfI57sJOJ_nPkwa"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">克里斯蒂安·威迪格在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><h1 id="a91c" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">什么是亚马逊S3桶？</h1><p id="337f" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">是一种公共静态云文件存储资源，可在亚马逊网络服务的(<strong class="lt iu"> AWS </strong>)简单存储服务(<strong class="lt iu"> S3 </strong>)中获得，这是一种对象存储产品。<strong class="lt iu"> S3桶</strong>，类似于文件夹，存储对象，由数据及其描述性元数据组成。</p><p id="7294" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">亚马逊S3使用与Amazon.com相同的可扩展存储基础设施来运行其全球电子商务网络。它可以用来存储任何类型的对象，允许用户存储互联网应用程序、备份和恢复、灾难恢复、数据归档、<a class="ae ky" href="https://en.wikipedia.org/wiki/Data_lake" rel="noopener ugc nofollow" target="_blank">数据湖</a>分析和<a class="ae ky" href="https://en.wikipedia.org/wiki/Cloud_computing#Hybrid_cloud" rel="noopener ugc nofollow" target="_blank">混合云存储</a>。</p><h1 id="a349" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">最薄弱的环节</h1><p id="4a5b" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">许多web开发人员使用这项服务来托管像JavaScript、HTML、图像、CSS这样的文件。</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="cc14" class="my la it mu b gy mz na l nb nc">.s3.amazonaws.com/js/main.js</span></pre><p id="bd07" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">创建S3存储桶时，开发人员有时会为公共用户配置不必要的策略和配置。这会导致未经授权的文件<strong class="lt iu">访问</strong>、<strong class="lt iu">上传</strong>、<strong class="lt iu">删除</strong>。</p><h1 id="6ea9" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">如何利用这一点？</h1><p id="8527" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">实际上，有许多方法可以做到这一点，但是今天我们将构建一个python脚本来帮助我们完成这项任务。该应用程序将使用正则表达式找到s3桶及其秘密。</p><blockquote class="nd"><p id="fc7d" class="ne nf it bd ng nh ni nj nk nl nm mm dk translated"><em class="nn">一个</em> <strong class="ak"> <em class="nn">正则表达式</em> </strong> <em class="nn">是一个特殊的字符序列，它使用一个</em> <strong class="ak"> <em class="nn">模式</em> </strong> <em class="nn">中的特殊语法来帮助你匹配或查找其他字符串或字符串集。……</em><strong class="ak"><em class="nn">Python</em></strong><em class="nn">模块re全面支持</em><strong class="ak"><em class="nn">Python</em></strong><em class="nn">中的类Perl</em><strong class="ak"><em class="nn">正则表达式</em> </strong> <em class="nn">。</em></p></blockquote></div><div class="ab cl no np hx nq" role="separator"><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt"/></div><div class="im in io ip iq"><h1 id="df70" class="kz la it bd lb lc nv le lf lg nw li lj jz nx ka ll kc ny kd ln kf nz kg lp lq bi translated">第1.0部分</h1><p id="6648" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在使用任何s3 buckets之前，您需要有一个amazon帐户。登录到您的帐户并创建一个访问密钥和秘密密钥。现在，我们需要配置<strong class="lt iu"> AWS-CLI </strong>。</p><p id="b8ec" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">打开您的<strong class="lt iu">终端</strong>并运行以下代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="893f" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">它会要求您输入访问密钥和秘密密钥。只需添加先前制作的密钥。</p><h1 id="3558" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">第1.5部分</h1><p id="6d4f" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在开始构建应用程序之前，我们需要编写一个正则表达式来帮助检测s3存储桶。我们将在python应用程序中使用它来查找它们。在虚拟托管式请求中，存储段名称是URL中域名的一部分。虚拟托管样式的URL遵循如下所示的格式。</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="c1f5" class="my la it mu b gy mz na l nb nc"><a class="ae ky" href="https://bucket-name.s3.Region.amazonaws.com/" rel="noopener ugc nofollow" target="_blank">https://bucket-name.s3.Region.amazonaws.com/</a> #key name</span></pre><p id="e9d2" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在本例中，<code class="fe oc od oe mu b">my-bucket</code>是存储桶名称，US West (Oregon)是地区，而<code class="fe oc od oe mu b">puppy.png</code>是关键字名称:</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="f093" class="my la it mu b gy mz na l nb nc"><a class="ae ky" href="https://my-bucket.s3.us-west-2.amazonaws.com/puppy.png" rel="noopener ugc nofollow" target="_blank">https://my-bucket.s3.us-west-2.amazonaws.com/puppy.png</a></span></pre><blockquote class="nd"><p id="edef" class="ne nf it bd ng nh of og oh oi oj mm dk translated"><strong class="ak"><em class="nn">【S3木桶访问】有:</em> </strong></p><p id="8f04" class="ne nf it bd ng nh ni nj nk nl nm mm dk translated"><em class="nn">虚拟托管式请求。</em></p><p id="3910" class="ne nf it bd ng nh ni nj nk nl nm mm dk translated"><em class="nn">路径式请求。</em></p><p id="64bc" class="ne nf it bd ng nh ni nj nk nl nm mm dk translated"><em class="nn">对互联网协议版本6 (IPv6)和IPv4进行请求。</em></p></blockquote></div><div class="ab cl no np hx nq" role="separator"><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt"/></div><div class="im in io ip iq"><h1 id="ce4b" class="kz la it bd lb lc nv le lf lg nw li lj jz nx ka ll kc ny kd ln kf nz kg lp lq bi translated">正则表达式</h1><p id="e13e" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">当制作正则表达式时，我们需要覆盖所有和任何可能的匹配来命中URLs s3桶。对于这个任务，我们将创建一个正则表达式。</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="5224" class="my la it mu b gy mz na l nb nc">[\w\-\.]+\.s3\.?(?:[\w\-\.]+)?\.amazonaws\.com|<br/>(?&lt;!\.)s3\.?(?:[\w\-\.]+)?\.amazonaws\.com\\?\/[\w\-\.]+</span></pre><h1 id="cd28" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">Java Script语言</h1><p id="a22b" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">大多数s3存储桶隐藏在JavaScript文件中。首先，让我们找到这些js路径，其次，我们需要收集这些js文件，并检查其中隐藏的桶。让我们写一个正则表达式来找到这些。我们的js路径。</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="26b0" class="my la it mu b gy mz na l nb nc">(?&lt;=src=[‘\”])[a-zA-Z0–9_\.\-\:\/]+\.js</span></pre></div><div class="ab cl no np hx nq" role="separator"><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt"/></div><div class="im in io ip iq"><h1 id="e2f0" class="kz la it bd lb lc nv le lf lg nw li lj jz nx ka ll kc ny kd ln kf nz kg lp lq bi translated">创建应用程序</h1><p id="362a" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">让我们编写代码来检测s3存储桶。在本节中，我们将编写实际的应用程序，并将所有内容嵌入在一起，使其工作并找到这些桶。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oa ob l"/></div></figure><h1 id="c2ed" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">HTML表单编码</h1><p id="1190" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">表单的编码类型由属性<code class="fe oc od oe mu b">enctype</code>决定。它可以有三个值。<strong class="lt iu"> URL编码格式</strong>、<strong class="lt iu">多部分格式、文本/普通格式</strong></p><ul class=""><li id="0c0d" class="ok ol it lt b lu mn lx mo ma om me on mi oo mm op oq or os bi translated"><code class="fe oc od oe mu b">application/x-www-form-urlencoded</code> -代表一个URL编码形式。如果<code class="fe oc od oe mu b">enctype</code>属性没有设置为任何值，这就是默认值。</li><li id="2140" class="ok ol it lt b lu ot lx ou ma ov me ow mi ox mm op oq or os bi translated"><code class="fe oc od oe mu b">multipart/form-data</code> -代表多部分形式。这种类型的表单在用户想要上传文件时使用</li><li id="3769" class="ok ol it lt b lu ot lx ou ma ov me ow mi ox mm op oq or os bi translated"><code class="fe oc od oe mu b">text/plain</code>-html 5中引入的一种新的表单类型，顾名思义，它只是发送数据而不进行任何编码</li></ul><p id="463f" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">正如您在<strong class="lt iu">第2行</strong>中看到的，来自<strong class="lt iu"> urllib </strong> <strong class="lt iu">模块</strong>的<strong class="lt iu"> unquote </strong>函数被导入，因为大部分<strong class="lt iu"> Html </strong>内容是以<strong class="lt iu"> urlencoded </strong>格式。这需要解码，否则，我们以前的正则表达式将永远不会得到匹配。<strong class="lt iu">第4行，<em class="ms">Domains-to-test . txt</em></strong>将是保存您想要测试s3存储桶的域的文件。</p><p id="ced5" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">发现网页隐藏s3桶后，可以手动测试漏洞。让我们使用之前在<strong class="lt iu">第1.0部分</strong>中配置的<strong class="lt iu"> AWS-CLI </strong>来完成此任务。</p><h1 id="1349" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">剥削</h1><p id="ced3" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">要测试任何找到的桶，打开您的<strong class="lt iu">终端</strong>并运行以下命令。</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="c4f5" class="my la it mu b gy mz na l nb nc">aws s3 ls s3://whateverbucketname</span></pre><p id="cc5f" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">检查是否存在任何敏感文件，如果有，尝试将其下载到您的邮箱中</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="4b0f" class="my la it mu b gy mz na l nb nc">aws s3 cp s3://whateverbucketname/secret.txt</span></pre><p id="7fef" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">你也可以上传文件，为此只需运行、</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="c63a" class="my la it mu b gy mz na l nb nc">aws s3 mv Exploit.txt s3://whateverbucketname/</span></pre></div><div class="ab cl no np hx nq" role="separator"><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt"/></div><div class="im in io ip iq"><h1 id="f371" class="kz la it bd lb lc nv le lf lg nw li lj jz nx ka ll kc ny kd ln kf nz kg lp lq bi translated">结论</h1><p id="b974" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">当然，这也可以使用像<strong class="lt iu"> BurpSuite </strong>这样的工具来完成，但是除非你有<strong class="lt iu"> Pro </strong>版本，否则你无法做到这一点。而且，当我使用自制的工具、脚本工作时，我感到更加满意。</p><p id="fa00" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">享受吧，祝狩猎愉快！</p></div></div>    
</body>
</html>