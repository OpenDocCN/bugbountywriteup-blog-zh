<html>
<head>
<title/>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1/>
<blockquote>原文：<a href="https://infosecwriteups.com/debuggers-nightmare-2bf6b6ffec05?source=collection_archive---------0-----------------------#2019-09-24">https://infosecwriteups.com/debuggers-nightmare-2bf6b6ffec05?source=collection_archive---------0-----------------------#2019-09-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><p id="5185" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">调试器的噩梦</p></div><div class="ab cl jn jo hu jp" role="separator"><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js"/></div><div class="ij ik il im in"><p id="25e7" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">这是在空艾哈迈达巴德CTF -1中出现的挑战调试器的噩梦的书面解决方案</p></div><div class="ab cl jn jo hu jp" role="separator"><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js"/></div><div class="ij ik il im in"><p id="f732" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">您可以在下面链接的Github资源库中找到二进制文件。</p></div><div class="ab cl jn jo hu jp" role="separator"><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js"/></div><div class="ij ik il im in"><div class="ju jv jw jx gt jy"><a href="https://github.com/MalavVyas/BinaryExploitationChallenge-Nightmare" rel="noopener  ugc nofollow" target="_blank"><div class="jz ab fo"><div class="ka ab kb cl cj kc"><h2 class="bd kd gy z fp ke fr fs kf fu fw kg bi translated">MalavVyas/binary探索挑战-噩梦</h2><div class="kh l"><h3 class="bd b gy z fp ke fr fs kf fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="ki l"><p class="bd b dl z fp ke fr fs kf fu fw dk translated">github.com</p></div></div><div class="kj l"><div class="kk l kl km kn kj ko kp jy"/></div></div></a></div><p id="e4fe" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">首先，让我们运行二进制文件，看看输出是什么:</p><figure class="ju jv jw jx gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi kq"><img src="../Images/f05c3589dc68dd8fde84191f387ac5d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Cbs6a0MzDdwfDFCw-k3vXQ.png"/></div></div></figure></div><div class="ab cl jn jo hu jp" role="separator"><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js"/></div><div class="ij ik il im in"><p id="ff08" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">二进制不给出任何输出。</p><p id="a070" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">当我们输入任何内容时，结果都是一样的。</p><figure class="ju jv jw jx gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi kx"><img src="../Images/724fb920aec9b7981da89c2739c0fa33.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*afdrS6LfuHH-_C7CuEcSlQ.png"/></div></div></figure><p id="5e37" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">现在让我们给它一串字符，看看它是否会导致分段错误。</p><figure class="ju jv jw jx gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi ky"><img src="../Images/7b4eda482d244b63a7e06b42422db965.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZF7HhTKfas95isWFuuK6pA.png"/></div></div></figure><p id="74b9" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">这里我们用python为文件提供了99 A，这导致了分段错误。</p><p id="88eb" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">根据错误，“分段故障(核心转储)”。</p><p id="8f8e" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">因此，要确定到底是什么导致了这一点，我们需要分析堆栈。</p><p id="f32d" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">我们可以使用strace实用程序来实现同样的目的</p><figure class="ju jv jw jx gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi kz"><img src="../Images/ae343278fd8274d992e4a8ae47ddb49f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZBNVXwpxhsMitDMufEprCA.png"/></div></div></figure><p id="ec06" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">现在，看图像中突出显示的部分，</p><p id="1a08" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">这里，si_addr被0x41414141覆盖，其中表示“A”</p><p id="1434" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">现在我们需要找到导致覆盖的确切的A数，这样我们就可以找到偏移量。</p><p id="4b5b" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">为此，我们需要提供一个特别设计的字符串来找出偏移量。</p><p id="b80d" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">可以使用<a class="ae la" href="https://projects.jason-rush.com/tools/buffer-overflow-eip-offset-string-generator/" rel="noopener ugc nofollow" target="_blank">https://projects . Jason-rush . com/tools/buffer-overflow-EIP-offset-string-generator/</a>生成字符串。</p><figure class="ju jv jw jx gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi lb"><img src="../Images/72f6d9007c2720dac7b7d3dfac17fee6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qdbPVJG2RZFCNQ7MKriRbA.png"/></div></div></figure><p id="27ec" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">生成字符串后我们会得到:aa 0 aa 1 aa 2 aa 3 aa 4 aa 5 aa 6a aa 7 aa 8 aa 9 ab 0 ab 1 ab 2 ab 3 ab 4 ab 5 ab 6 ab 7 ab 8 ab 9 AC 0 AC 1 AC 2 AC 3 AC 4 AC 5 AC 6 AC 7 AC 8 AC 9 ad 0 ad 1 ad 2 a。</p><p id="947f" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">现在让我们用它来溢出二进制。</p><figure class="ju jv jw jx gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi lc"><img src="../Images/1a8f5b3703cf990e9458e9261f6542f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8oLqEV-8sTlvd_jRfGtSXg.png"/></div></div></figure><p id="a3ee" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">分析堆栈，</p><figure class="ju jv jw jx gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi kz"><img src="../Images/3ce4c648ecda9254d0d04b422be5c23a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iGlXVYbaZjh9wVhzDWmoRQ.png"/></div></div></figure><p id="dcf8" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">si_addr被值“0x62413961”覆盖</p><p id="0a44" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">现在把它放在同一个网站上，</p><figure class="ju jv jw jx gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi ld"><img src="../Images/5359f56392bcdd02bf00ff751cd52e42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*McNEwK6c-e8t-fNhRW9oPg.png"/></div></div></figure><p id="a5de" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">因此，偏移值为28。</p><p id="cdb1" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">现在我们需要函数地址，它可能会给我们一个标志。</p><p id="b6b4" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">首先，用objdump实用程序获得二进制文件中所有函数的列表。</p><p id="7064" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">with objdump -d nightmare1 | grep " &gt;:"</p><figure class="ju jv jw jx gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi le"><img src="../Images/deb37bf097da5e179a43961f16b1d21f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vCtga_ph_HXpdvG665fWAQ.png"/></div></div></figure><p id="1f8d" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">这里需要注意两个函数“vuln”和“pasdfjsdfuefa”。</p><p id="4e4e" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">更详细的分析，我们用gdb -q nightmare1和反汇编vuln函数来火起来gdb。</p><figure class="ju jv jw jx gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi le"><img src="../Images/6c0c94611bf953dbb8d0abaae8d1a9da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EutFgQDCjMCMclz7SSx3gA.png"/></div></div></figure><p id="30b2" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">在这里，除了易受缓冲区溢出攻击的strcpy之外，我们看不到什么。</p><p id="270d" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">现在，我们可以假设flag必须在其他函数中，因为没有打印系统调用。</p><p id="c0da" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">所以，拆解“pasdfjsdfuefa”，</p><figure class="ju jv jw jx gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi kz"><img src="../Images/799d28c5d4d3dc0a9996ecd1ee230ab1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HbiXUhvSbFIL4NhIJX78AQ.png"/></div></div></figure><p id="b82c" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">所以，这里发生了很多事情。</p><p id="8f68" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">由于大量的jle、jmp和inc指令，我们可以猜测这里可能有一个循环，在这些循环指令之后，我们看到两个打印指令。</p><p id="be4a" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">当我们用很少的字符运行binary时，我们没有得到任何输出，我们可以断言这个函数永远不会被调用。</p><p id="398f" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">所以，我们也可以预测，这一定是包含flag的函数。</p><figure class="ju jv jw jx gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi le"><img src="../Images/deb37bf097da5e179a43961f16b1d21f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vCtga_ph_HXpdvG665fWAQ.png"/></div></div></figure><p id="e17e" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">现在，再次查看" objdump -d nightmare1 | grep " &gt;:" "</p><p id="330f" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">我们可以找到函数pasdfjsdfuefa的地址为“08048454”</p><p id="3b32" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">现在，我们知道这个二进制文件容易受到缓冲区溢出的攻击，我们知道偏移量，我们也知道我们想要执行的函数的地址。</p><p id="93e7" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">因此，让我们生成将导致函数被执行的输入。</p><p id="2755" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">因为偏移量是28，所以在此之前写的任何东西都无关紧要，所以我们需要，</p><p id="d2c1" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">。/nightmare 1 $(python 2-c ' print " A " * 28 ')</p><p id="abad" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">然后我们需要提供地址，这样si_addr就会被函数的地址覆盖。</p><p id="e7ec" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">通常二进制以小端格式获取地址，因此，输入地址将是，</p><p id="e3c9" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">" \x54\x84\x04\x08 "</p><p id="e416" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">最后，利用二进制文件的命令应该是，</p><p id="a443" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">。/nightmare 1 $(python 2-c ' print " A " " 28+" \ x54 \ x84 \ x04 \ x08 " ')</p><figure class="ju jv jw jx gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi lf"><img src="../Images/3a3d895f8e92a773088371bcd5982f90.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v-hakFClxcKdl7CZO0e7mA.png"/></div></div></figure><p id="33fb" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">现在，我们得到了旗子和贝壳。</p><p id="0bbb" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated">感谢阅读！！</p></div><div class="ab cl jn jo hu jp" role="separator"><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js"/></div><div class="ij ik il im in"><p id="a840" class="pw-post-body-paragraph io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ij bi translated"><em class="lg">关注</em> <a class="ae la" href="https://medium.com/bugbountywriteup" rel="noopener"> <em class="lg"> Infosec报道</em> </a> <em class="lg">获取更多此类精彩报道。</em></p><div class="lh li gp gr lj jy"><a href="https://medium.com/bugbountywriteup" rel="noopener follow" target="_blank"><div class="jz ab fo"><div class="ka ab kb cl cj kc"><h2 class="bd kd gy z fp ke fr fs kf fu fw kg bi translated">信息安全报道</h2><div class="kh l"><h3 class="bd b gy z fp ke fr fs kf fu fw dk translated">收集了世界上最好的黑客的文章，主题从bug奖金和CTF到vulnhub…</h3></div><div class="ki l"><p class="bd b dl z fp ke fr fs kf fu fw dk translated">medium.com</p></div></div><div class="kj l"><div class="lk l kl km kn kj ko kp jy"/></div></div></a></div></div></div>    
</body>
</html>