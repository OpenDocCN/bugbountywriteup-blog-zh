<html>
<head>
<title>A story about a not-so-direct SSRF</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">一个关于不太直接的SSRF的故事</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/a-story-about-a-not-so-direct-ssrf-b2b98e128af0?source=collection_archive---------2-----------------------#2021-12-12">https://infosecwriteups.com/a-story-about-a-not-so-direct-ssrf-b2b98e128af0?source=collection_archive---------2-----------------------#2021-12-12</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="9a85" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">大家好，希望你们一切都好，保持安全。这个博客是关于我最近在SSRF的发现。</h2></div><h2 id="1e6e" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">介绍和侦察</h2><p id="1fd6" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm kr ln lo lp kv lq lr ls kz lt lu lv lw im bi translated">我在测试一个有合适范围的目标。在做了一些基本的google dorking来查找关于目标的域/子域后，我最终找到了一个子域，这是一个与一些智能认证相关的“演示测试”站点。</p><p id="d906" class="pw-post-body-paragraph le lf it lg b lh lx ju lj lk ly jx lm kr lz lo lp kv ma lr ls kz mb lu lv lw im bi translated">对你们感兴趣的人来说，这是我用过的呆子。</p><blockquote class="mc md me"><p id="3666" class="le lf mf lg b lh lx ju lj lk ly jx lm mg lz lo lp mh ma lr ls mi mb lu lv lw im bi translated">站点:target . com-inurl:" https://target . com "</p></blockquote><p id="1419" class="pw-post-body-paragraph le lf it lg b lh lx ju lj lk ly jx lm kr lz lo lp kv ma lr ls kz mb lu lv lw im bi translated">马上，我们有了一个包含三个字段的基本页面，其中一个是URL。我们有一个下拉菜单来选择一个URL，通过它进行身份验证(记住smart-auth)。</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mj"><img src="../Images/1b25fed75ab2326988277b2763be2bb3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lIXz8ROOeqSoBTA3eRPmPA.png"/></div></div></figure><p id="f12c" class="pw-post-body-paragraph le lf it lg b lh lx ju lj lk ly jx lm kr lz lo lp kv ma lr ls kz mb lu lv lw im bi translated">在提供了虚拟数据并拦截了请求之后，我们看到应用程序正在尝试借助所提供的“token”值进行身份验证。由于令牌无效(虚拟值)，终端服务器返回401错误。</p><p id="98a7" class="pw-post-body-paragraph le lf it lg b lh lx ju lj lk ly jx lm kr lz lo lp kv ma lr ls kz mb lu lv lw im bi translated">有趣的是，应用程序正在向端点服务器请求“/某个其他端点”。</p><h2 id="052a" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">剥削</h2><p id="44ea" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm kr ln lo lp kv lq lr ls kz lt lu lv lw im bi translated">注意到URL参数并提供burp collaborator位置，我们得到DNS和HTTP请求，并且burp collab服务器的响应也反映在HTTP响应中。</p><p id="9a1b" class="pw-post-body-paragraph le lf it lg b lh lx ju lj lk ly jx lm kr lz lo lp kv ma lr ls kz mb lu lv lw im bi translated">即使在这里，也是同样的情况，应用程序向burp collab服务器请求“/某个其他端点”。</p><p id="4a9c" class="pw-post-body-paragraph le lf it lg b lh lx ju lj lk ly jx lm kr lz lo lp kv ma lr ls kz mb lu lv lw im bi translated">经查明，该知识产权属于谷歌，托管在GCP。通过提供<a class="ae mv" href="https://github.com/cujanovic/SSRF-Testing/blob/master/cloud-metadata.txt" rel="noopener ugc nofollow" target="_blank">云元数据端点</a>,我们要么得到403禁止错误，要么得到404未找到(记住服务器将“/某个其他端点”附加到所有请求上)。</p><p id="87c6" class="pw-post-body-paragraph le lf it lg b lh lx ju lj lk ly jx lm kr lz lo lp kv ma lr ls kz mb lu lv lw im bi translated">为了利用这个缺陷，我们需要运行一个服务器，在访问“/some-other-endpoint”时将应用程序重定向到云元数据端点或其他任意位置，如localhost:22。</p><p id="d0e8" class="pw-post-body-paragraph le lf it lg b lh lx ju lj lk ly jx lm kr lz lo lp kv ma lr ls kz mb lu lv lw im bi translated">我在https://github.com/macloo/basic-flask-app<a class="ae mv" href="https://github.com/macloo/basic-flask-app/" rel="noopener ugc nofollow" target="_blank">的</a>用了一个flask app，对<a class="ae mv" href="https://github.com/macloo/basic-flask-app/blob/master/routes.py" rel="noopener ugc nofollow" target="_blank"> routes.py </a>文件做了修改。下面突出显示了这一变化。</p><blockquote class="mc md me"><p id="9a5b" class="le lf mf lg b lh lx ju lj lk ly jx lm mg lz lo lp mh ma lr ls mi mb lu lv lw im bi translated"><a class="ae mv" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank"> @app </a>。route('/some-other-endpoint ')<br/>def metadata():<br/>return flask . redirect("<a class="ae mv" href="http://169.254.169.254/" rel="noopener ugc nofollow" target="_blank">http://169 . 254 . 169 . 254/</a>")</p></blockquote><p id="01e5" class="pw-post-body-paragraph le lf it lg b lh lx ju lj lk ly jx lm kr lz lo lp kv ma lr ls kz mb lu lv lw im bi translated">通过使用ngrok HTTP隧道，向ngrok服务器发出的请求将被重定向到运行在5000端口上的flask服务器。</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mw"><img src="../Images/1d224f7dfcf7e5b3061bd51e1309e112.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AJYw93OK0CMi7JtseatXxw.png"/></div></div></figure><p id="b2f5" class="pw-post-body-paragraph le lf it lg b lh lx ju lj lk ly jx lm kr lz lo lp kv ma lr ls kz mb lu lv lw im bi translated">现在，通过在URL字段中提供ngrok服务器，向ngrok服务器发出带有“<strong class="lg iu"><em class="mf">/some-other-endpoint”</em></strong>的请求，并且由于flask应用重定向到云元数据，所以我们从元数据服务器获得响应。请看下面的截图，以供参考。</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mx"><img src="../Images/ebf12152062bf3a366ac519ec2610cf4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Xf5WqyZuiWzHMnW0tdyrKQ.png"/></div></div></figure><p id="4ac5" class="pw-post-body-paragraph le lf it lg b lh lx ju lj lk ly jx lm kr lz lo lp kv ma lr ls kz mb lu lv lw im bi translated">使用这种方法，我能够通过相应地更改<a class="ae mv" href="https://github.com/macloo/basic-flask-app/blob/master/routes.py" rel="noopener ugc nofollow" target="_blank"> routes.py </a>文件来枚举本地文件并执行内部主机/端口扫描。</p><p id="c193" class="pw-post-body-paragraph le lf it lg b lh lx ju lj lk ly jx lm kr lz lo lp kv ma lr ls kz mb lu lv lw im bi translated">最后是一些反馈。</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div class="gh gi my"><img src="../Images/e304b452a218a8915e32ff0a6b30fb2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:590/format:webp/1*L2Ts6xBQXa2tbzodL8-g-Q.png"/></div></figure><h2 id="9fad" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">失败</h2><p id="2a18" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm kr ln lo lp kv lq lr ls kz lt lu lv lw im bi translated">在确认了SSRF之后，我尝试使用一个简单的PHP文件重定向到云元数据服务器。但是挑战或者说我无能为力的地方在于，在点击<strong class="lg iu"><em class="mf">"/some-other-endpoint "</em></strong>时，必须发生重定向。</p><p id="3702" class="pw-post-body-paragraph le lf it lg b lh lx ju lj lk ly jx lm kr lz lo lp kv ma lr ls kz mb lu lv lw im bi translated">我试着部署一个azure PHP web应用程序，但是失败了，因为我不能让逻辑工作。我知道我必须利用路线，但部署一个应用程序是一个麻烦，因为它需要一些框架或其他依赖我认为(我可能是错的)。</p><p id="c389" class="pw-post-body-paragraph le lf it lg b lh lx ju lj lk ly jx lm kr lz lo lp kv ma lr ls kz mb lu lv lw im bi translated">一个简单的python flask服务器是最简单的选择，因为它不需要太多的依赖，但是部署到云或其他服务对我来说是新事物。因此，我想到了在本地运行服务器并使用ngrok HTTP隧道的想法，所需的需求得到了满足。</p><p id="12bd" class="pw-post-body-paragraph le lf it lg b lh lx ju lj lk ly jx lm kr lz lo lp kv ma lr ls kz mb lu lv lw im bi translated">请让我知道你会如何实现重定向或您的反馈。</p><p id="c94f" class="pw-post-body-paragraph le lf it lg b lh lx ju lj lk ly jx lm kr lz lo lp kv ma lr ls kz mb lu lv lw im bi translated">直到下一次…</p><p id="c2a7" class="pw-post-body-paragraph le lf it lg b lh lx ju lj lk ly jx lm kr lz lo lp kv ma lr ls kz mb lu lv lw im bi translated">黑客快乐！</p><p id="7508" class="pw-post-body-paragraph le lf it lg b lh lx ju lj lk ly jx lm kr lz lo lp kv ma lr ls kz mb lu lv lw im bi translated">普雷瑟姆</p></div></div>    
</body>
</html>