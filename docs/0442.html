<html>
<head>
<title>Android CTF — KGB Messenger</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">安卓CTF——克格勃信使</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/android-ctf-kgb-messenger-d9069f4cedf8?source=collection_archive---------0-----------------------#2019-12-04">https://infosecwriteups.com/android-ctf-kgb-messenger-d9069f4cedf8?source=collection_archive---------0-----------------------#2019-12-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="fb13" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是一篇关于开源CTF实践挑战的文章。这个CTF的目的是学习如何对Android应用程序进行逆向工程。你可以在这里找到CTF的链接。</p></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><h2 id="4557" class="kt ku iq bd kv kw kx dn ky kz la dp lb jy lc ld le kc lf lg lh kg li lj lk ll bi translated">使用的工具</h2><ul class=""><li id="1055" class="lu lv iq jp b jq lw ju lx jy ly kc lz kg ma kk mb mc md me bi translated"><a class="ae kl" href="https://ibotpeaches.github.io/Apktool/" rel="noopener ugc nofollow" target="_blank"> Apktool </a></li><li id="2af3" class="lu lv iq jp b jq mf ju mg jy mh kc mi kg mj kk mb mc md me bi translated"><a class="ae kl" href="https://github.com/java-decompiler/jd-gui/releases/" rel="noopener ugc nofollow" target="_blank"> jd-gui </a></li><li id="f2bd" class="lu lv iq jp b jq mf ju mg jy mh kc mi kg mj kk mb mc md me bi translated"><a class="ae kl" href="https://github.com/patrickfav/uber-apk-signer" rel="noopener ugc nofollow" target="_blank">优步Apk签名人</a></li><li id="843b" class="lu lv iq jp b jq mf ju mg jy mh kc mi kg mj kk mb mc md me bi translated"><a class="ae kl" href="https://github.com/pxb1988/dex2jar/" rel="noopener ugc nofollow" target="_blank"> dex2jar </a></li></ul><h2 id="c34e" class="kt ku iq bd kv kw kx dn ky kz la dp lb jy lc ld le kc lf lg lh kg li lj lk ll bi translated"><strong class="ak">安装应用程序</strong></h2><p id="acfc" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy mk ka kb kc ml ke kf kg mm ki kj kk ij bi translated">确保在启用调试模式的情况下连接android手机，然后安装应用程序。</p><p id="8b72" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mn mo mp mq b">adb install kgb-messenger.apk</code></p><h2 id="e5bc" class="kt ku iq bd kv kw kx dn ky kz la dp lb jy lc ld le kc lf lg lh kg li lj lk ll bi translated">使用Apktool解码</h2><p id="bebc" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy mk ka kb kc ml ke kf kg mm ki kj kk ij bi translated">使用Apktool解码APK，并将其输出到<code class="fe mn mo mp mq b">kgb-smali</code>文件夹。</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi mr"><img src="../Images/c47260288b07aa93a9fc25dcdb384190.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Bi7Q_rVomlGzdFko5DJlIw.png"/></div></div></figure><h2 id="a531" class="kt ku iq bd kv kw kx dn ky kz la dp lb jy lc ld le kc lf lg lh kg li lj lk ll bi translated">正在转换apk。使用dex2jar的jar格式</h2><p id="2d5c" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy mk ka kb kc ml ke kf kg mm ki kj kk ij bi translated">我们转换成jar，因为这样我们就可以使用JD-GUI来查看Java代码。</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/b7073928f0035dcf2517fc03e0d04890.png" data-original-src="https://miro.medium.com/v2/resize:fit:1396/0*c5DGqjKODExd_TJl"/></div></figure><p id="a44f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用<strong class="jp ir"> JD-GUI </strong>，我们打开由dex2jar创建的<code class="fe mn mo mp mq b">kgb-jar.jar</code>(之前的命令)。</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/621e185959209d38943ff75a592d58d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1164/format:webp/1*-PNbYjV-6jDsq1ISkKAvnA.png"/></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated"><strong class="bd kv">注意</strong>:我下载了JD-GUI并创建了一个名为tools的目录，然后将它移动到这个目录中</figcaption></figure><h2 id="6275" class="kt ku iq bd kv kw kx dn ky kz la dp lb jy lc ld le kc lf lg lh kg li lj lk ll bi translated"><strong class="ak">现在启动应用</strong></h2><p id="8736" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy mk ka kb kc ml ke kf kg mm ki kj kk ij bi translated">一旦我们启动应用程序，我们得到这个错误。</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/b756d0c9a40f9d67f346032277f17433.png" data-original-src="https://miro.medium.com/v2/resize:fit:644/format:webp/1*yXOwagk_u6Fq_PwrsdRXSw.jpeg"/></div></figure><p id="a25b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要查看导致该错误的原因，我们需要先查看哪个活动正在启动。所以我们打开<code class="fe mn mo mp mq b">AndroidManifest.xml</code>，它可以在<code class="fe mn mo mp mq b">kgb-smali </code>(apk tool创建的文件)中找到</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/a1d9b7fa0912ed70d4a61be0a4209160.png" data-original-src="https://miro.medium.com/v2/resize:fit:1398/format:webp/1*abkleTtjpX__IeiSd2HShQ.png"/></div></figure><p id="f56f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用vim编辑器，我们打开<code class="fe mn mo mp mq b">AndroidManifest.xml</code></p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/38262939af283cc463c061ea7dd2e22d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1220/format:webp/1*oVI2pqnG3OaqOWbwKL1JRA.png"/></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated">AndroidManifest.xml的部分代码片段</figcaption></figure><p id="f9c3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mn mo mp mq b">MainActivity</code>是最先发起的活动。所以用JD-GUI查看<code class="fe mn mo mp mq b">MainActivity.class</code></p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/0881762c0b8d5899c836a239c44b309a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1254/format:webp/1*nl_NWIixkGk4_K5bKXifGQ.png"/></div></figure><p id="2e86" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以看到，创建活动时，检查了两个字符串值。首先检查<code class="fe mn mo mp mq b">str1</code>是否等于<em class="nn">俄罗斯。</em>同理，<code class="fe mn mo mp mq b">str2</code> <strong class="jp ir"> </strong>如果等于<code class="fe mn mo mp mq b">getResources().getString(<em class="nn">2131558400</em>)</code>则检查。<strong class="jp ir"> </strong>数字是存储在<code class="fe mn mo mp mq b"><a class="ae kl" href="https://developer.android.com/guide/topics/resources/string-resource" rel="noopener ugc nofollow" target="_blank">strings.xml</a></code>文件中的字符串值的数字表示。</p><p id="cbe6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因为我们在Apktool创建的smali文件夹中也有<code class="fe mn mo mp mq b">.smali</code> <strong class="jp ir"> </strong>文件，所以我们打开<code class="fe mn mo mp mq b">MainActivity.smali</code>并找到这一行<code class="fe mn mo mp mq b">getResources().getString(2131558400)</code></p><p id="d70e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在此之前，我们需要用十六进制格式表示<code class="fe mn mo mp mq b">2131558400</code>,以便我们更容易找到smali代码中的值。</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div class="gh gi no"><img src="../Images/3def1e167eea64d1b8993c54af788f14.png" data-original-src="https://miro.medium.com/v2/resize:fit:1278/format:webp/1*u1KvXOorF9aFAI55s7l9hg.png"/></div></figure><p id="a6b1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以我们使用Vim编辑器打开<code class="fe mn mo mp mq b">MainActivity.smali</code>文件。</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi mr"><img src="../Images/f35e1f9101328c21e2c9d56d0210e2af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*PbT0zbT5PyaccPDk"/></div></div></figure><p id="64bc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，我们尝试定位id为<code class="fe mn mo mp mq b">0x7f0d0000</code>并与<code class="fe mn mo mp mq b">str2</code>进行比较的字符串资源。</p><p id="d22e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们转到<strong class="jp ir"> res/values </strong>目录，搜索<code class="fe mn mo mp mq b">0x7f0d0000</code> <strong class="jp ir"> </strong>出现的位置</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div class="gh gi np"><img src="../Images/37511cc12f7d7355b738668bd308be22.png" data-original-src="https://miro.medium.com/v2/resize:fit:1362/format:webp/1*pS-1flAXQrOjTtRRqtHoHA.png"/></div></figure><p id="e400" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们看到名字是<strong class="jp ir">【用户】</strong>，类型是<strong class="jp ir">【字符串】</strong>。因此，我们搜索<strong class="jp ir"> "User" </strong>，在strings.xml文件中，name="User "的值使用Base64编码。我们对它进行编码。</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/b72a7b8554cc79090f8d03c8c7a8e9d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1372/format:webp/1*_5l9saOR-njueyJgldPSZQ.png"/></div></figure><h1 id="dacd" class="nr ku iq bd kv ns nt nu ky nv nw nx lb ny nz oa le ob oc od lh oe of og lk oh bi translated">捕获第二面旗帜</h1><p id="99d1" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy mk ka kb kc ml ke kf kg mm ki kj kk ij bi translated"><em class="nn">要捕获第二个标志，我们需要进入下一个活动，即</em> <code class="fe mn mo mp mq b"><em class="nn">LoginActivity</em></code> <em class="nn">。</em></p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div class="gh gi oi"><img src="../Images/56112e64c4f977778aea33e0d828d358.png" data-original-src="https://miro.medium.com/v2/resize:fit:1360/format:webp/1*hI8Kajk8qBuNzrs2IQxABA.png"/></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated">MainActivity的onCreate方法</figcaption></figure><p id="bbc5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了到达<code class="fe mn mo mp mq b">LoginActivity</code>，我们需要找到一种方法来通过这两个if条件，或者我们可以只移除它们。</p><p id="8080" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们打开<code class="fe mn mo mp mq b">MainActivity.class</code>的<code class="fe mn mo mp mq b">.smali</code>版本，删除负责两个if条件的代码。</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div class="gh gi oj"><img src="../Images/6f6dc6c3f700b2f45e5c7cb896969385.png" data-original-src="https://miro.medium.com/v2/resize:fit:1366/0*eqJBxvnnE2HQL2tz"/></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated">第一条件的小版本</figcaption></figure><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div class="gh gi oj"><img src="../Images/bd32d2d6192b7ce9f13023404d144268.png" data-original-src="https://miro.medium.com/v2/resize:fit:1366/0*LoOSIYFg4CN0OeVw"/></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated">第二条件的小版本</figcaption></figure><h2 id="7740" class="kt ku iq bd kv kw kx dn ky kz la dp lb jy lc ld le kc lf lg lh kg li lj lk ll bi translated">摆脱这两种情况</h2><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div class="gh gi oj"><img src="../Images/d4e975d96bb4a8af5b0965fb4c35eb2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1366/0*maA0rMCkgZiglXk_"/></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated">选择要删除的代码</figcaption></figure><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div class="gh gi oj"><img src="../Images/6d71b47580d6b9ce6b0bc1e81ececc80.png" data-original-src="https://miro.medium.com/v2/resize:fit:1366/0*FEm9b0f8VqTC-5AU"/></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated">移除后</figcaption></figure><p id="c20d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="nn">注意:确保在删除代码后看起来像这样，并以</em> <code class="fe mn mo mp mq b"><em class="nn">goto :go_to_0</em></code>结束</p><h2 id="2965" class="kt ku iq bd kv kw kx dn ky kz la dp lb jy lc ld le kc lf lg lh kg li lj lk ll bi translated">构建apk</h2><p id="9884" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy mk ka kb kc ml ke kf kg mm ki kj kk ij bi translated">做出更改后，我们需要构建apk。所以我们使用Apktool构建apk。</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div class="gh gi ok"><img src="../Images/9746c1c2c3788bc6905665c3997e37d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1184/format:webp/1*kZVaENKs7Wq_CZaSxLXuog.png"/></div></figure><h2 id="61e9" class="kt ku iq bd kv kw kx dn ky kz la dp lb jy lc ld le kc lf lg lh kg li lj lk ll bi translated">签署apk</h2><p id="a9c0" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy mk ka kb kc ml ke kf kg mm ki kj kk ij bi translated">我们不能直接安装apk。我们需要先在<a class="ae kl" href="http://www.androiddocs.com/tools/publishing/app-signing.html" rel="noopener ugc nofollow" target="_blank">和</a>上签字。然而，由于我们不是这个应用程序的原始开发者，我们将为此目的优步Apk签名。</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi ol"><img src="../Images/65f68578a176970695b308027ce66ad8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*S4gIFG1JJDynyUND"/></div></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated"><strong class="bd kv">注意:</strong>我下载了优步Apk Signer并创建了一个名为tools的目录，然后将它移动到这个目录中</figcaption></figure><h2 id="3f5f" class="kt ku iq bd kv kw kx dn ky kz la dp lb jy lc ld le kc lf lg lh kg li lj lk ll bi translated">安装和运行修改后的apk</h2><p id="203b" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy mk ka kb kc ml ke kf kg mm ki kj kk ij bi translated">现在当我们启动时，我们直接被带到<code class="fe mn mo mp mq b">LoginActivity</code>。</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div class="gh gi om"><img src="../Images/25652f0d9a3757983999963de3a2df15.png" data-original-src="https://miro.medium.com/v2/resize:fit:648/format:webp/1*iXBg8Htuw8wb2s7UUA3nWA.jpeg"/></div></figure><p id="066f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们必须找出用户名和密码是什么。让我们再次看看源代码，但是这次是使用<code class="fe mn mo mp mq b">JD-GUI</code>的LoginActivity</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div class="gh gi on"><img src="../Images/b025d0805ff6b7fa58736af5d085a7d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1316/format:webp/1*EhH3Q8kmfI9m3vGOml_Pxg.png"/></div></figure><p id="617b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<code class="fe mn mo mp mq b">onLogin</code>方法中，我们有两个被转换成字符串的编辑文本。<code class="fe mn mo mp mq b">EditText1</code>转换为字符串<code class="fe mn mo mp mq b">n</code>，<code class="fe mn mo mp mq b">EditText2</code>转换为字符串<code class="fe mn mo mp mq b">o</code>。现在我们不知道哪个编辑文本对应于用户名和密码。</p><h2 id="21c2" class="kt ku iq bd kv kw kx dn ky kz la dp lb jy lc ld le kc lf lg lh kg li lj lk ll bi translated">查找用户名</h2><p id="0288" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy mk ka kb kc ml ke kf kg mm ki kj kk ij bi translated">我们来看第一个嵌套的if条件，字符串<code class="fe mn mo mp mq b">n</code>正在与id为<code class="fe mn mo mp mq b">2131158450</code>的资源进行比较。所以我们再次将其转换为十六进制代码，并检查是否可以找到相应的字符串名称。</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div class="gh gi oj"><img src="../Images/08b8466d6cfbd929b37b834d5e6ea6b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1366/format:webp/1*CuTQtfLwnPq9Ig-DFRx8Dg.png"/></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated">通过使用十六进制代码<code class="fe mn mo mp mq b">2131158450</code>找到的id，找到<strong class="bd kv">用户名</strong>值</figcaption></figure><p id="1f51" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以用户名是<strong class="jp ir"> codenameduchess </strong>。</p><h2 id="b8dc" class="kt ku iq bd kv kw kx dn ky kz la dp lb jy lc ld le kc lf lg lh kg li lj lk ll bi translated">查找密码</h2><p id="f08b" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy mk ka kb kc ml ke kf kg mm ki kj kk ij bi translated">让我们尝试使用与用户名相同的方法来查找密码。</p><p id="2fa6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们再次检查代码，可以看到函数<code class="fe mn mo mp mq b">j</code>应该返回<code class="fe mn mo mp mq b">false</code>。</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div class="gh gi oo"><img src="../Images/93c654404e006294854e00621fc42b46.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/1*1VnPhBbncBCYlqwqgiAONA.png"/></div></figure><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div class="gh gi op"><img src="../Images/524bb26cfa03fa16b7c036abe255aa91.png" data-original-src="https://miro.medium.com/v2/resize:fit:362/format:webp/1*etHk9x6vEt-GcyS6fpqo7w.png"/></div></figure><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div class="gh gi oq"><img src="../Images/50fd102e93012959c44de760af34181b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*C9aaQCw1cJOEJ9hNA-vQLw.png"/></div></figure><p id="6d8d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里，使用MD5对字符串<code class="fe mn mo mp mq b">o</code>进行哈希运算，然后与字符串资源id <code class="fe mn mo mp mq b">2131558446</code>进行比较。</p><p id="0ad9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们试图从strings.xml中找到hash的值，并使用<code class="fe mn mo mp mq b">findmyhash</code>找到它的原始值。</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div class="gh gi or"><img src="../Images/08e8ca75243221a05cf41c1c8e6371f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1368/format:webp/1*iE1i-MlasrMZ50Z2TcBGtA.png"/></div></figure><p id="71dc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们在<code class="fe mn mo mp mq b">strings.xml</code>中获得散列值，但是当我们试图使用<code class="fe mn mo mp mq b">findmyhash</code>来寻找散列的原始值时，我们没有获得任何结果。这个问题确实说了我们必须使用社会工程来获取密码。所以我们试着在谷歌上搜索<strong class="jp ir">代号公爵夫人</strong>。</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi os"><img src="../Images/2eaf9490caf2bd260f151bc71c98e3ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1286/0*pQfTGuSgeW_bAWoS"/></div></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated">codenameduchess的谷歌搜索结果</figcaption></figure><p id="a156" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">账户名<strong class="jp ir">‘Sterling Archer’</strong>也与第一个标志相符。所以我们来看看它的推特账户。</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi ot"><img src="../Images/9285bf16a598634e3002d31fa3a35b1e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*5efkfUlhLBwWccQC"/></div></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated">代号女公爵(斯特林·阿彻)的推特页面</figcaption></figure><p id="c410" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">看起来像是电视剧里的人物。我们现在尝试谷歌搜索<code class="fe mn mo mp mq b">codename duchess password</code>。</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div class="gh gi ou"><img src="../Images/8d45064c46b72a353f55b85aa83707fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1052/0*kCTg8tkgzelbTbQr"/></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated">代号公爵夫人密码的谷歌搜索结果</figcaption></figure><p id="324e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们打开PDF，并在其中搜索密码。</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi ov"><img src="../Images/8623a192bbed18aab8a915c4888a6c0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*RUhLhqm0GDv_H5va"/></div></div></figure><p id="b471" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">据此，密码为<strong class="jp ir">客人</strong>。于是我们输入密码为'<strong class="jp ir"> guest </strong>'(全小写)。</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div class="gh gi om"><img src="../Images/41fd1a93dc374bdf9c78f929b4d179f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:648/format:webp/1*exESxY33phclNRn3z6I-mw.jpeg"/></div></figure><p id="2cdf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">和..我们进去了。标志为<strong class="jp ir"> G00G13_PR0 </strong>。</p><h2 id="7545" class="kt ku iq bd kv kw kx dn ky kz la dp lb jy lc ld le kc lf lg lh kg li lj lk ll bi translated">检查哈希的值</h2><p id="c916" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy mk ka kb kc ml ke kf kg mm ki kj kk ij bi translated">只是为了好玩，让我们看看为什么我们找不到哈希。因此，当我们计算guest虚拟机的MD5哈希时，我们得到</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div class="gh gi ow"><img src="../Images/951c4e1231849da8eb70ec56e60ff3d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:702/0*XLjWrxUB6xRbFgBp"/></div></figure><p id="5bfb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以我们找不到结果的原因是我们的散列不完整(开始时没有零)。</p><h1 id="f419" class="nr ku iq bd kv ns nt nu ky nv nw nx lb ny nz oa le ob oc od lh oe of og lk oh bi translated">捕捉第三面旗帜</h1><p id="53cd" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy mk ka kb kc ml ke kf kg mm ki kj kk ij bi translated"><em class="nn">登录后，我们被带到MessageActivity。在那里我们会找到第三面旗帜。</em></p><p id="52a5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以我们用<code class="fe mn mo mp mq b">JD-GUI</code>打开<code class="fe mn mo mp mq b">MessageActivity</code>，我们来看看源代码。</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi ox"><img src="../Images/fd99e9f3d89a5140b4aa4d0bb15d4bf5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*LMB1vOs34Zg_KVtC"/></div></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated">来自MessageActivity的函数onSendMessage</figcaption></figure><p id="7502" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">每当我们发送消息时，<code class="fe mn mo mp mq b">onSendMessage</code>函数被调用，使用EditText输入的文本被转换成字符串<code class="fe mn mo mp mq b">str</code>。</p><p id="d86d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，如果我们仔细观察，字符串<strong class="jp ir"> str </strong>被传递给一个名为<strong class="jp ir"> a </strong>的函数，在该函数上调用equals函数来检查它是否等于<strong class="jp ir"> p </strong>。</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div class="gh gi oy"><img src="../Images/e31501db4c86de5222538fb1e7467c03.png" data-original-src="https://miro.medium.com/v2/resize:fit:1078/0*gzeSfauvA_nblVaC"/></div></figure><p id="14c1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> p </strong>的值为:</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div class="gh gi oz"><img src="../Images/34fa32e0b0b6a33c4df7eb693793e24a.png" data-original-src="https://miro.medium.com/v2/resize:fit:820/format:webp/1*ftWhJr5rN_ZSA-rNzTEx6Q.png"/></div></figure><p id="e5ad" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，让我们来看看功能<code class="fe mn mo mp mq b">a</code></p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/0d41bfed25f82e148669f3037d772201.png" data-original-src="https://miro.medium.com/v2/resize:fit:1164/0*serjcz7YzZkD70kI"/></div></figure><p id="118d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">函数<code class="fe mn mo mp mq b">a</code> <strong class="jp ir"> </strong>返回字符串。在此函数中，作为参数传递的字符串值通过以下方式获得:</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div class="gh gi pa"><img src="../Images/8195a06ca7cd4624b267bfa5eeef1fd6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1244/format:webp/1*WNgLkw-NgbZvZJ3sfACG8g.png"/></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated">函数a的可视化表示</figcaption></figure><p id="9e41" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，<strong class="jp ir"> p </strong>的值等于传递给此函数<strong class="jp ir"> a </strong>的参数字符串。因此，我们可以通过反向执行这些步骤来逆向工程出<strong class="jp ir"> p </strong>的原始值。正如我们知道的<code class="fe mn mo mp mq b">(A XOR B) XOR B = A</code>，我们可以用它来寻找字符串的原始值:</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div class="gh gi oo"><img src="../Images/a6da2823831070ec3933faa44d30b088.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/1*vC6PV5N1cytGKcOEcW_lvw.png"/></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated">再次进行异或运算的函数的可视化表示</figcaption></figure><p id="ef1f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们使用Python重新创建了上面的算法:</p><figure class="ms mt mu mv gt mw"><div class="bz fp l di"><div class="pb pc l"/></div></figure><p id="5ee6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当我们运行这个文件时，我们得到</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div class="gh gi pd"><img src="../Images/f449017259eb13e24387367f7f86f86d.png" data-original-src="https://miro.medium.com/v2/resize:fit:902/0*e4tzOJ7YacoD7-fm"/></div></figure><p id="5523" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以我们输入这个字符串作为应用程序的EditText的输入:</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div class="gh gi pe"><img src="../Images/9a83aaefe824da5145cdb9ebb89b0b89.png" data-original-src="https://miro.medium.com/v2/resize:fit:966/format:webp/1*OdUTNQfQSU42HpxQlN-QsA.png"/></div></figure><p id="e7fa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">类似地，来自EditText的输入通过函数<code class="fe mn mo mp mq b">b</code>传递，并检查它是否等于字符串<code class="fe mn mo mp mq b">r</code>。</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div class="gh gi oq"><img src="../Images/4600be9b75bc3033fd6ac998f3d95332.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*Gr-cQn_dQSM88B4JbftQWQ.png"/></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated">字符串r的值</figcaption></figure><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi pf"><img src="../Images/6210dece1fb56cd5e9470e6f110f2b1d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1202/0*kDT9QhVm015Q5pY6"/></div></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated">函数b，其返回值与字符串r进行比较</figcaption></figure><p id="0351" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在将smali代码转换为java类时，似乎出现了一些问题。代码可以重构，以便更好地理解。</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi pg"><img src="../Images/ceb791d26f7523183ca2bb05d89b05f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*LSNKMof9nI_hhx0W"/></div></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated">只是函数b的可读版本</figcaption></figure><p id="c4b2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这里，逆向工程是不可能的，所以我们试图强行进入。我们检查循环iterable <code class="fe mn mo mp mq b">i</code>和alphabet的值，我们得到输出<code class="fe mn mo mp mq b">r</code>。</p><figure class="ms mt mu mv gt mw"><div class="bz fp l di"><div class="pb pc l"/></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated">解码-r.py</figcaption></figure><p id="62a9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行这个文件后，我们得到了输出。</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div class="gh gi ph"><img src="../Images/fb2cf5de57990d78f2af2135c3671cb9.png" data-original-src="https://miro.medium.com/v2/resize:fit:904/0*2l3YUXwHRTiocYUK"/></div></figure><p id="d252" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">每第8个位置的值是' _ '，因为我们有i%8 == 0。不管是什么字母，函数的输出都是0，所以很难用蛮力找到答案。</p><p id="a683" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以消息可以是<strong class="jp ir">我可以*请*有密码</strong>吗？</p><p id="de01" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们把这个消息</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi pi"><img src="../Images/5e5caec5f24fd89eff8c828af86adf9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q3uWdINI9QQ9NF4EpMtaig.jpeg"/></div></div></figure><p id="634a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">捕获第三面旗帜。</p><h2 id="a91a" class="kt ku iq bd kv kw kx dn ky kz la dp lb jy lc ld le kc lf lg lh kg li lj lk ll bi translated">为什么不直接打这个消息而打之前的消息？</h2><p id="a1ab" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy mk ka kb kc ml ke kf kg mm ki kj kk ij bi translated">要理解这一点，我们需要看看旗帜是如何计算的。函数<code class="fe mn mo mp mq b">i</code>负责计算标志。让我们看看如何</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div class="gh gi pj"><img src="../Images/ecff338326204537b0532bdd5412e761.png" data-original-src="https://miro.medium.com/v2/resize:fit:948/format:webp/1*6gHnhid59KUUj7mDg54lkw.png"/></div></figure><p id="3f1f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第一个条件检查字符串<code class="fe mn mo mp mq b">q</code>和<code class="fe mn mo mp mq b">s</code>是否不为空。也就是说，它们必须被初始化并设置为某个特定的值。我们不能像以前一样删除这个if条件，因为我们需要<code class="fe mn mo mp mq b">q</code>和<code class="fe mn mo mp mq b">s</code>的值来计算标志。</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi pk"><img src="../Images/da3a9da3bf134bb426f550a2393bcf9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o-0u1INYr1chxf7yUPA-NQ.jpeg"/></div></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated">在函数onSendMessage中</figcaption></figure><p id="90d2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">只有在成功发送两个问题后，才会设置<code class="fe mn mo mp mq b">q</code>和<code class="fe mn mo mp mq b">s</code>的值。所以两个消息都要发。</p></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><p id="90ee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这就是我对这个CTF的解决方案。这是我第一次参加CTF，在这次挑战中我学到了很多。希望你也学到了一些东西。</p><p id="8384" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">感谢阅读我的文章！干杯！🍺</p><p id="a754" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<a class="ae kl" href="https://twitter.com/fake_batman_" rel="noopener ugc nofollow" target="_blank"> Twitter </a>、<a class="ae kl" href="https://github.com/harshitm98" rel="noopener ugc nofollow" target="_blank"> Github </a>上关注我，或者在<a class="ae kl" href="https://linkedin.com/in/harshitm98" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>上联系我。</p></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><p id="2f02" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="nn">关注</em> <a class="ae kl" href="https://medium.com/bugbountywriteup" rel="noopener"> <em class="nn"> Infosec报道</em> </a> <em class="nn">获取更多此类精彩报道。</em></p><div class="pl pm gp gr pn po"><a href="https://medium.com/bugbountywriteup" rel="noopener follow" target="_blank"><div class="pp ab fo"><div class="pq ab pr cl cj ps"><h2 class="bd ir gy z fp pt fr fs pu fu fw ip bi translated">信息安全报道</h2><div class="pv l"><h3 class="bd b gy z fp pt fr fs pu fu fw dk translated">收集了世界上最好的黑客的文章，主题从bug奖金和CTF到vulnhub…</h3></div><div class="pw l"><p class="bd b dl z fp pt fr fs pu fu fw dk translated">medium.com</p></div></div><div class="px l"><div class="py l pz qa qb px qc nb po"/></div></div></a></div></div></div>    
</body>
</html>