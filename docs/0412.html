<html>
<head>
<title>CVE-2019-12415: XML processing vulnerability in Apache POI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">CVE-2019-12415:Apache POI中的XML处理漏洞</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/cve-2019-12415-xml-processing-vulnerability-579fdbfbaa18?source=collection_archive---------1-----------------------#2019-11-03">https://infosecwriteups.com/cve-2019-12415-xml-processing-vulnerability-579fdbfbaa18?source=collection_archive---------1-----------------------#2019-11-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="597f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Apache POI是一个流行的Java库，用于处理Microsoft文档。例如，它允许您使用Java读写Microsoft Excel文件。当我最近查看图书馆时，我注意到一个小漏洞，后来成为CVE-2019–12415。该问题已在POI 4.1.1中修复。以下是详细内容。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/771138ef2d42211ed15f8e51b3afb7be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zu7Yjm9u36U1fvgXQp_KjA.jpeg"/></div></div></figure><h1 id="a7ea" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">问题</h1><p id="766a" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">除了许多其他格式，Apache POI还可以处理Microsoft Excel文档。特别是，该库包含用于处理Microsoft Excel Open XML电子表格(XLSX)文件的<code class="fe md me mf mg b">XSSFExportToXml</code>类。该类接受一个在Open Office XML规范中定义的<code class="fe md me mf mg b">Map</code>元素，并将其转换为XML。</p><p id="d905" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">元素包含了XLSX文件的内部内容。特别是，它包含一个XSD模式。可以指示<code class="fe md me mf mg b">XSSFExportToXml.exportToXml()</code>方法使用这个模式进行XML验证:</p><pre class="kp kq kr ks gt mh mg mi mj aw mk bi"><span id="7ba9" class="ml lb it mg b gy mm mn l mo mp">private boolean isValid(Document xml) throws SAXException {<br/>    try {<br/>        String language = "http://www.w3.org/2001/XMLSchema";<br/>        SchemaFactory factory = SchemaFactory.newInstance(language);<br/>        Source source = new DOMSource(map.getSchema());<br/>        Schema schema = factory.newSchema(source);<br/>        Validator validator = schema.newValidator();<br/>        validator.validate(new DOMSource(xml));<br/>...</span></pre><p id="c5c9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这里的问题是，<code class="fe md me mf mg b">SchemaFactory</code>没有打开安全XML处理模式，如果攻击者可以将恶意的XSD模式传递给<code class="fe md me mf mg b">isValid()</code>方法，就会导致XXE漏洞。</p><p id="9a6d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">模式是如何到达<code class="fe md me mf mg b">isValid()</code>方法的？答案很简单:它来自一个XLSX文档。首先，XSLT文档只是一个ZIP存档。如果您提取它，您会发现一堆XML文档和其他文件。XSD模式来自<code class="fe md me mf mg b">xl/xmlMaps.xml</code>文件，该文件包含如下内容:</p><pre class="kp kq kr ks gt mh mg mi mj aw mk bi"><span id="7f63" class="ml lb it mg b gy mm mn l mo mp">&lt;MapInfo  SelectionNamespaces=""&gt;<br/>    &lt;Schema ID="Schema2"&gt;<br/>        &lt;xs:schema xmlns:xs="http://www.w3.org/2001/XMLSchema" elementFormDefault="qualified" 1be1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi"&gt;There may be various payloads. For example, an attacker can inject a <code class="fe md me mf mg b">&lt;xs:redefine schemaLocation="https://internal.site/endpoint"&gt;</code> element into the schema. Here <code class="fe md me mf mg b">https://internal.site/endpoint</code> is a URL to a resource from the private network which can't be directly accessed by an attacker:<pre class="kp kq kr ks gt mh mg mi mj aw mk bi"><span id="6ddd" class="ml lb it mg b gy mm mn l mo mp">&lt;MapInfo  SelectionNamespaces=""&gt;<br/>    &lt;Schema ID="Schema2"&gt;<br/>        &lt;xs:schema xmlns:xs="http://www.w3.org/2001/XMLSchema" elementFormDefault="qualified" https://internal.site/endpoint"&gt;<br/>            ...</span></pre><p id="4c49" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然后，攻击者把所有东西归档回去，恶意的XLSX就准备好了。当<code class="fe md me mf mg b">SchemaFactory</code>加载模式时，它将访问<code class="fe md me mf mg b"><a class="ae mq" href="https://internal.site/endpoint." rel="noopener ugc nofollow" target="_blank">https://internal.site/endpoint</a></code> <a class="ae mq" href="https://internal.site/endpoint." rel="noopener ugc nofollow" target="_blank">。</a></p><p id="1529" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">已通过将<code class="fe md me mf mg b">XMLConstants.FEATURE_SECURE_PROCESSING</code>功能设置为<code class="fe md me mf mg b">SchemaFactory</code>修复了该问题。</p><h1 id="f6c6" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">攻击者能做什么</h1><p id="7713" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">攻击者可以在有效载荷中使用XSD格式的所有功能。可能的后果包括但不限于:</p><ol class=""><li id="f54f" class="mr ms it js b jt ju jx jy kb mt kf mu kj mv kn mw mx my mz bi translated">服务器端请求伪造(SSRF)</li><li id="22fe" class="mr ms it js b jt na jx nb kb nc kf nd kj ne kn mw mx my mz bi translated">本地和远程资源的敏感信息泄漏</li></ol><h1 id="eb11" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">利用漏洞的先决条件</h1><p id="9141" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">以下是使应用程序易受攻击的原因:</p><ol class=""><li id="edf1" class="mr ms it js b jt ju jx jy kb mt kf mu kj mv kn mw mx my mz bi translated">该应用程序使用Apache POI 4.1.0及更低版本。</li><li id="20a6" class="mr ms it js b jt na jx nb kb nc kf nd kj ne kn mw mx my mz bi translated">该应用程序允许不受信任的数据被<code class="fe md me mf mg b">XSSFExportToXml</code>类处理。</li><li id="069f" class="mr ms it js b jt na jx nb kb nc kf nd kj ne kn mw mx my mz bi translated"><code class="fe md me mf mg b">XSSFExportToXml.exportToXml()</code>方法的第三个参数被设置为true，这将启用XML验证。</li></ol><h1 id="022b" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">结论</h1><p id="400e" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">Java标准库为XML处理提供了许多类。<code class="fe md me mf mg b">DocumentBuilder</code>是加载XML文档最流行的类之一。然而，还有许多其他的类，比如<code class="fe md me mf mg b">SchemaFactory</code>、<code class="fe md me mf mg b">Transformer</code>等等可以解析XML文档。如果这些类从不受信任的来源获取数据，那么所有这些类都应该配置为以一种安全的方式完成这项工作。</p><h1 id="1f37" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">参考</h1><ul class=""><li id="08bf" class="mr ms it js b jt ly jx lz kb nf kf ng kj nh kn ni mx my mz bi translated"><a class="ae mq" href="https://poi.apache.org/" rel="noopener ugc nofollow" target="_blank">阿帕奇兴趣点</a></li><li id="c584" class="mr ms it js b jt na jx nb kb nc kf nd kj ne kn ni mx my mz bi translated"><a class="ae mq" href="https://nvd.nist.gov/vuln/detail/CVE-2019-12415" rel="noopener ugc nofollow" target="_blank">CVE-2019–12415</a></li><li id="2f4e" class="mr ms it js b jt na jx nb kb nc kf nd kj ne kn ni mx my mz bi translated"><a class="ae mq" href="https://svn.apache.org/viewvc?view=revision&amp;revision=1867484" rel="noopener ugc nofollow" target="_blank">补丁</a></li><li id="93ca" class="mr ms it js b jt na jx nb kb nc kf nd kj ne kn ni mx my mz bi translated"><a class="ae mq" href="https://lists.apache.org/thread.html/13a54b6a03369cfb418a699180ffb83bd727320b6ddfec198b9b728e@%3Cannounce.apache.org%3E" rel="noopener ugc nofollow" target="_blank">兴趣点4.1.1公告</a></li><li id="5f04" class="mr ms it js b jt na jx nb kb nc kf nd kj ne kn ni mx my mz bi translated"><a class="ae mq" href="https://www.owasp.org/index.php/Server_Side_Request_Forgery" rel="noopener ugc nofollow" target="_blank">服务器端请求伪造</a></li></ul></span></pre></div><div class="ab cl nj nk hx nl" role="separator"><span class="nm bw bk nn no np"/><span class="nm bw bk nn no np"/><span class="nm bw bk nn no"/></div><div class="im in io ip iq"><p id="0af0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="nq">关注</em> <a class="ae mq" href="https://medium.com/bugbountywriteup" rel="noopener"> <em class="nq"> Infosec报道</em> </a> <em class="nq">获取更多此类精彩报道。</em></p><div class="nr ns gp gr nt nu"><a href="https://medium.com/bugbountywriteup" rel="noopener follow" target="_blank"><div class="nv ab fo"><div class="nw ab nx cl cj ny"><h2 class="bd iu gy z fp nz fr fs oa fu fw is bi translated">信息安全报道</h2><div class="ob l"><h3 class="bd b gy z fp nz fr fs oa fu fw dk translated">收集了世界上最好的黑客的文章，主题从bug奖金和CTF到vulnhub…</h3></div><div class="oc l"><p class="bd b dl z fp nz fr fs oa fu fw dk translated">medium.com</p></div></div><div class="od l"><div class="oe l of og oh od oi ky nu"/></div></div></a></div></div></div>    
</body>
</html>