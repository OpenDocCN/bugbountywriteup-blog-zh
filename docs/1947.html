<html>
<head>
<title>HackTheBox — Devzat</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">HackTheBox — Devzat</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/hackthebox-devzat-4520e4808286?source=collection_archive---------0-----------------------#2022-03-15">https://infosecwriteups.com/hackthebox-devzat-4520e4808286?source=collection_archive---------0-----------------------#2022-03-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/5cb8f204b490bb7c422644a060636b14.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*9LzjJ_ICN9A3Tb4G.png"/></div></div></figure><h1 id="8c83" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">列举</h1><h2 id="2067" class="kw jz iq bd ka kx ky dn ke kz la dp ki lb lc ld km le lf lg kq lh li lj ku lk bi translated">TCP端口扫描</h2><figure class="ll lm ln lo gt jr"><div class="bz fp l di"><div class="lp lq l"/></div></figure><h2 id="09b3" class="kw jz iq bd ka kx ky dn ke kz la dp ki lb lc ld km le lf lg kq lh li lj ku lk bi translated">Web服务器枚举</h2><p id="91dc" class="pw-post-body-paragraph lr ls iq lt b lu lv lw lx ly lz ma mb lb mc md me le mf mg mh lh mi mj mk ml ij bi translated">从nmap输出中，我们可以看到端口80被重定向到<a class="ae mm" href="http://devzat.htb" rel="noopener ugc nofollow" target="_blank"> http://devzat.htb </a>。我们需要在hosts文件中添加主机名<code class="fe mn mo mp mq b">devzat.htb</code>才能访问该网站。</p><figure class="ll lm ln lo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mr"><img src="../Images/4c5dbb703748b74343bea5801c547c2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*aEmWt-R31j0KXfED.png"/></div></div></figure><p id="a393" class="pw-post-body-paragraph lr ls iq lt b lu ms lw lx ly mt ma mb lb mu md me le mv mg mh lh mw mj mk ml ij bi translated">我们还会在网站上收到一封电子邮件:<code class="fe mn mo mp mq b">patrick@devzat.htb</code>。</p><h2 id="dd04" class="kw jz iq bd ka kx ky dn ke kz la dp ki lb lc ld km le lf lg kq lh li lj ku lk bi translated">其他服务枚举</h2><p id="0fae" class="pw-post-body-paragraph lr ls iq lt b lu lv lw lx ly lz ma mb lb mc md me le mf mg mh lh mi mj mk ml ij bi translated">在尝试连接时，我们在端口8000有一个SSH服务，如果您收到以下错误消息:</p><pre class="ll lm ln lo gt mx mq my mz aw na bi"><span id="b908" class="kw jz iq mq b gy nb nc l nd ne">Unable to negotiate with 10.10.11.118 port 8000: no matching host key type found. Their offer: ssh-rsa</span></pre><p id="2c70" class="pw-post-body-paragraph lr ls iq lt b lu ms lw lx ly mt ma mb lb mu md me le mv mg mh lh mw mj mk ml ij bi translated">将下面一行添加到<code class="fe mn mo mp mq b">/etc/ssh/ssh_config</code>文件中以解决该问题:</p><pre class="ll lm ln lo gt mx mq my mz aw na bi"><span id="7cda" class="kw jz iq mq b gy nb nc l nd ne">HostKeyAlgorithms +ssh-rsa,ssh-dss</span></pre><figure class="ll lm ln lo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nf"><img src="../Images/d7bcd19d7cbbfda7a7e66a8b2b642cc1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*VOl7WSqEOn9JXgr3.png"/></div></div></figure><p id="4716" class="pw-post-body-paragraph lr ls iq lt b lu ms lw lx ly mt ma mb lb mu md me le mv mg mh lh mw mj mk ml ij bi translated">登录后，我们看到这是一个SSH聊天室。就是<a class="ae mm" href="https://github.com/quackduck/devzat" rel="noopener ugc nofollow" target="_blank"> devzat </a>聊天应用。它接受文本的不同语法选项，例如:</p><ul class=""><li id="dd08" class="ng nh iq lt b lu ms ly mt lb ni le nj lh nk ml nl nm nn no bi translated"><code class="fe mn mo mp mq b">*text*</code> - &gt;斜体</li><li id="204a" class="ng nh iq lt b lu np ly nq lb nr le ns lh nt ml nl nm nn no bi translated"><code class="fe mn mo mp mq b">_text_</code> - &gt;斜体</li><li id="5af6" class="ng nh iq lt b lu np ly nq lb nr le ns lh nt ml nl nm nn no bi translated"><code class="fe mn mo mp mq b">**text**</code> - &gt;加粗</li><li id="a2ac" class="ng nh iq lt b lu np ly nq lb nr le ns lh nt ml nl nm nn no bi translated"><code class="fe mn mo mp mq b">~~text~~</code> - &gt;删除线</li><li id="66d3" class="ng nh iq lt b lu np ly nq lb nr le ns lh nt ml nl nm nn no bi translated"><code class="fe mn mo mp mq b">_text_</code> - &gt;斜体</li><li id="2d7a" class="ng nh iq lt b lu np ly nq lb nr le ns lh nt ml nl nm nn no bi translated"><code class="fe mn mo mp mq b">**text**</code> - &gt;加粗</li><li id="c456" class="ng nh iq lt b lu np ly nq lb nr le ns lh nt ml nl nm nn no bi translated"><code class="fe mn mo mp mq b">~~text~~</code> - &gt;删除线</li></ul><figure class="ll lm ln lo gt jr gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/0640f41fa246a1462532c9a78b67115d.png" data-original-src="https://miro.medium.com/v2/resize:fit:984/format:webp/0*eV0j3l3tG_CzlkFi.png"/></div></figure><p id="a852" class="pw-post-body-paragraph lr ls iq lt b lu ms lw lx ly mt ma mb lb mu md me le mv mg mh lh mw mj mk ml ij bi translated">这让我开始寻找其他的方式来处理这些文字。在这个过程中，我发现URL是以<code class="fe mn mo mp mq b">[link text](URL of link)</code>的markdown格式显示的，例如:<code class="fe mn mo mp mq b">http://example.com</code>会变成<code class="fe mn mo mp mq b">[http://example.com](http://example.com)</code></p><p id="3688" class="pw-post-body-paragraph lr ls iq lt b lu ms lw lx ly mt ma mb lb mu md me le mv mg mh lh mw mj mk ml ij bi translated">在markdown中，我们可以用<code class="fe mn mo mp mq b">![](URL of image)</code>的语法包含远程图像。我尝试用这种技术获取远程文件，并成功地向我的python http服务器发出了服务器端请求。这可能是一个潜在的SSRF攻击面。</p><figure class="ll lm ln lo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nv"><img src="../Images/0602e0657061ff672e941cf81e3d25bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*63DlQiglGxuMWULi.png"/></div></div></figure><figure class="ll lm ln lo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nw"><img src="../Images/58b722aac4374b9284b86a31f5a25468.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Spk_v7y5K1fARPJT.png"/></div></div></figure><p id="f541" class="pw-post-body-paragraph lr ls iq lt b lu ms lw lx ly mt ma mb lb mu md me le mv mg mh lh mw mj mk ml ij bi translated">然而，除了发出一个简单的get请求，我什么也做不了。所以我将转向子域枚举。</p><h2 id="f68e" class="kw jz iq bd ka kx ky dn ke kz la dp ki lb lc ld km le lf lg kq lh li lj ku lk bi translated">子域枚举:</h2><pre class="ll lm ln lo gt mx mq my mz aw na bi"><span id="fa32" class="kw jz iq mq b gy nb nc l nd ne">ffuf -w /usr/share/seclists/Discovery/DNS/shubs-subdomains.txt -o ffuf-vhosts.out -u <a class="ae mm" href="http://devzat.htb" rel="noopener ugc nofollow" target="_blank">http://devzat.htb</a> -H -fw 18</span></pre><p id="efdf" class="pw-post-body-paragraph lr ls iq lt b lu ms lw lx ly mt ma mb lb mu md me le mv mg mh lh mw mj mk ml ij bi translated">找到子域:<code class="fe mn mo mp mq b">pets.devzat.htb</code></p><figure class="ll lm ln lo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mr"><img src="../Images/9380823624383b76995452e811b2078d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*CUEpD6CFDDC0Fshy.png"/></div></div></figure><p id="5902" class="pw-post-body-paragraph lr ls iq lt b lu ms lw lx ly mt ma mb lb mu md me le mv mg mh lh mw mj mk ml ij bi translated">该网站接收宠物名称和宠物种类。宠物种类可以从网站后端包含不同种类的下拉列表中选择。添加宠物后，网站会显示该物种的相关文本。</p><p id="6e3b" class="pw-post-body-paragraph lr ls iq lt b lu ms lw lx ly mt ma mb lb mu md me le mv mg mh lh mw mj mk ml ij bi translated">让我们查看一下Burpsuite上的请求:</p><figure class="ll lm ln lo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nx"><img src="../Images/24d3b5e6282e4f9d8bc3406a969875bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*5qbZiQBeVgBFDGVt.png"/></div></div></figure><p id="7fda" class="pw-post-body-paragraph lr ls iq lt b lu ms lw lx ly mt ma mb lb mu md me le mv mg mh lh mw mj mk ml ij bi translated">玩转参数后，可以成功获得命令注入。尝试以下有效负载，如下所示的物种参数:</p><figure class="ll lm ln lo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ny"><img src="../Images/f20eb1f926b9d1fcbfd65668c2757fba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*5NIejr3kNmlTFQYJ.png"/></div></div></figure><p id="382a" class="pw-post-body-paragraph lr ls iq lt b lu ms lw lx ly mt ma mb lb mu md me le mv mg mh lh mw mj mk ml ij bi translated">因为我们添加了<code class="fe mn mo mp mq b">sleep 4</code>命令，所以这个请求需要4秒钟。</p><h1 id="b161" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">剥削</h1><h2 id="af79" class="kw jz iq bd ka kx ky dn ke kz la dp ki lb lc ld km le lf lg kq lh li lj ku lk bi translated">据点</h2><p id="8296" class="pw-post-body-paragraph lr ls iq lt b lu lv lw lx ly lz ma mb lb mc md me le mf mg mh lh mi mj mk ml ij bi translated">我使用下面的反向shell来获得系统上的一个shell:</p><figure class="ll lm ln lo gt jr"><div class="bz fp l di"><div class="lp lq l"/></div></figure><figure class="ll lm ln lo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nz"><img src="../Images/82ee4e747a2d545d313c46b7561073c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*hNWH52IobrBtpLD3.png"/></div></div></figure><p id="df8d" class="pw-post-body-paragraph lr ls iq lt b lu ms lw lx ly mt ma mb lb mu md me le mv mg mh lh mw mj mk ml ij bi translated">在得到一个简单的shell之后，我们可以用在<code class="fe mn mo mp mq b">~/.ssh/id_rsa</code>找到的SSH私有密钥得到一个加密的SSH shell。</p><figure class="ll lm ln lo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oa"><img src="../Images/744b0cfe199a34bc7e873b2194763b49.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*VqikWwgIcZpNb-Io.png"/></div></div></figure><h2 id="cc49" class="kw jz iq bd ka kx ky dn ke kz la dp ki lb lc ld km le lf lg kq lh li lj ku lk bi translated">横向运动</h2><p id="fc20" class="pw-post-body-paragraph lr ls iq lt b lu lv lw lx ly lz ma mb lb mc md me le mf mg mh lh mi mj mk ml ij bi translated">系统上有两个用户帐户:</p><ul class=""><li id="3d8e" class="ng nh iq lt b lu ms ly mt lb ni le nj lh nk ml nl nm nn no bi translated">帕特里克</li><li id="6493" class="ng nh iq lt b lu np ly nq lb nr le ns lh nt ml nl nm nn no bi translated">凯瑟琳</li></ul><p id="0360" class="pw-post-body-paragraph lr ls iq lt b lu ms lw lx ly mt ma mb lb mu md me le mv mg mh lh mw mj mk ml ij bi translated">以patrick和catherine的身份登录后，我们在devzat聊天室看到了他们的私人聊天记录:</p><figure class="ll lm ln lo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ob"><img src="../Images/4e7d652c936db7360d13b0e1388cbdaa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*y8vD-hgWoAJAQ3NR.png"/></div></div></figure><p id="3edb" class="pw-post-body-paragraph lr ls iq lt b lu ms lw lx ly mt ma mb lb mu md me le mv mg mh lh mw mj mk ml ij bi translated">以patrick的身份查看devzat聊天室的聊天记录，我们可以看到patrick和admin讨论了influxdb实例。</p><p id="c84e" class="pw-post-body-paragraph lr ls iq lt b lu ms lw lx ly mt ma mb lb mu md me le mv mg mh lh mw mj mk ml ij bi translated">使用<code class="fe mn mo mp mq b">netstat</code>，我们可以看到influxdb端口8086是打开的:</p><figure class="ll lm ln lo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oc"><img src="../Images/e5e2d69a81ec643831d4ffde517fac56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*8UweNnNrvAQL5dQU.png"/></div></div></figure><p id="de67" class="pw-post-body-paragraph lr ls iq lt b lu ms lw lx ly mt ma mb lb mu md me le mv mg mh lh mw mj mk ml ij bi translated">为了识别InfluxDB版本，我们使用<code class="fe mn mo mp mq b">curl</code>并检查<code class="fe mn mo mp mq b">X-Influxdb-Version</code>头。</p><figure class="ll lm ln lo gt jr gh gi paragraph-image"><div class="gh gi od"><img src="../Images/e908d9ed197954b745ac20c343fb30de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/format:webp/0*gbuHgAryNTgCerXT.png"/></div></figure><p id="4f37" class="pw-post-body-paragraph lr ls iq lt b lu ms lw lx ly mt ma mb lb mu md me le mv mg mh lh mw mj mk ml ij bi translated">InfluxDB版本:1.7.5在谷歌上快速搜索时，我发现该版本因共享机密为空而容易受到Influxdb的authenticate函数中的身份验证旁路漏洞(CVE-2019–20933)的攻击。</p><p id="dffd" class="pw-post-body-paragraph lr ls iq lt b lu ms lw lx ly mt ma mb lb mu md me le mv mg mh lh mw mj mk ml ij bi translated">Github<a class="ae mm" href="https://github.com/LorenzoTullini/InfluxDB-Exploit-CVE-2019-20933" rel="noopener ugc nofollow" target="_blank">https://Github . com/LorenzoTullini/InfluxDB-Exploit-CVE-2019-20933</a>上有一个针对此漏洞的公开攻击</p><p id="8562" class="pw-post-body-paragraph lr ls iq lt b lu ms lw lx ly mt ma mb lb mu md me le mv mg mh lh mw mj mk ml ij bi translated">我们将利用这个漏洞。首先，我们需要从端口8086到我们的攻击者机器建立一个SSH端口。</p><pre class="ll lm ln lo gt mx mq my mz aw na bi"><span id="04e5" class="kw jz iq mq b gy nb nc l nd ne">ssh -L 8086:127.0.0.1:8086 patrick@devzat.htb -i patrick-id_rsa -fN</span></pre><figure class="ll lm ln lo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oe"><img src="../Images/af2033417f8ed36bec15b263b95b38da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*wspqBU4g-NNgs9U9.png"/></div></div><figcaption class="of og gj gh gi oh oi bd b be z dk translated">开发CVE-2019–20933</figcaption></figure><p id="3d10" class="pw-post-body-paragraph lr ls iq lt b lu ms lw lx ly mt ma mb lb mu md me le mv mg mh lh mw mj mk ml ij bi translated">从数据库中获得了三个用户的密码:</p><figure class="ll lm ln lo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oj"><img src="../Images/f50cdd0a30d964c96d59c2e4412c6a6b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*fRzA5MZcg6WLPQL4.png"/></div></div></figure><figure class="ll lm ln lo gt jr"><div class="bz fp l di"><div class="lp lq l"/></div></figure><p id="27ce" class="pw-post-body-paragraph lr ls iq lt b lu ms lw lx ly mt ma mb lb mu md me le mv mg mh lh mw mj mk ml ij bi translated">我们可以用用户catherine的密码<code class="fe mn mo mp mq b">woBeeYa*************************</code>切换到她</p><h2 id="d1a3" class="kw jz iq bd ka kx ky dn ke kz la dp ki lb lc ld km le lf lg kq lh li lj ku lk bi translated">权限提升至Root用户</h2><p id="36e0" class="pw-post-body-paragraph lr ls iq lt b lu lv lw lx ly lz ma mb lb mc md me le mf mg mh lh mi mj mk ml ij bi translated">从我们之前找到的聊天记录来看，提到备份中有可用的源代码。</p><figure class="ll lm ln lo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ok"><img src="../Images/3e3788df3abe5179257d5372607a0d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*jf8Zv_aLN87VVScc.png"/></div></div></figure><p id="a7b4" class="pw-post-body-paragraph lr ls iq lt b lu ms lw lx ly mt ma mb lb mu md me le mv mg mh lh mw mj mk ml ij bi translated">将这些zip文件下载到我们的本地机器上，并提取它们。使用<code class="fe mn mo mp mq b">grep</code>，我们在备份中发现了一个密码<code class="fe mn mo mp mq b">CeilingCat******************</code></p><figure class="ll lm ln lo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ok"><img src="../Images/b0444c50fc97519f698bab61333719c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*oQbR-N6IlvPLtB6K.png"/></div></div></figure><p id="0ad7" class="pw-post-body-paragraph lr ls iq lt b lu ms lw lx ly mt ma mb lb mu md me le mv mg mh lh mw mj mk ml ij bi translated">在devzat的本地dev实例中，我们可以看到一个在端口8000上运行的生产环境中不存在的<code class="fe mn mo mp mq b">/file</code>命令。预览文件需要密码。</p><figure class="ll lm ln lo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ol"><img src="../Images/0b641fb892df4a21dce3080f83c6c584.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*kV2-BdXrX2PQRsnh.png"/></div></div></figure><p id="c99d" class="pw-post-body-paragraph lr ls iq lt b lu ms lw lx ly mt ma mb lb mu md me le mv mg mh lh mw mj mk ml ij bi translated">让我们使用在源代码中找到的密码。我们现在有了根用户的私有密钥，可以作为根用户获得一个shell。</p><figure class="ll lm ln lo gt jr gh gi paragraph-image"><div class="gh gi om"><img src="../Images/e54d63c430358a87c4baf583ebdd6ae4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1342/format:webp/0*zrdETOqLFZZJGaFx.png"/></div></figure><p id="63cd" class="pw-post-body-paragraph lr ls iq lt b lu ms lw lx ly mt ma mb lb mu md me le mv mg mh lh mw mj mk ml ij bi translated">获得一个shell作为root就像这样简单:</p><figure class="ll lm ln lo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi on"><img src="../Images/d90ac90bbddb6cf1463e6152b860a9cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*qbt1yVqVa-LTOVy1.png"/></div></div></figure><p id="1d2f" class="pw-post-body-paragraph lr ls iq lt b lu ms lw lx ly mt ma mb lb mu md me le mv mg mh lh mw mj mk ml ij bi translated">确保最后清理你的文件:)</p></div><div class="ab cl oo op hu oq" role="separator"><span class="or bw bk os ot ou"/><span class="or bw bk os ot ou"/><span class="or bw bk os ot"/></div><div class="ij ik il im in"><p id="2397" class="pw-post-body-paragraph lr ls iq lt b lu ms lw lx ly mt ma mb lb mu md me le mv mg mh lh mw mj mk ml ij bi translated"><em class="ov">最初发表于</em><a class="ae mm" href="https://github.com/xplo1t-sec/CTF/blob/master/HackTheBox/machines/Devzat/README.md" rel="noopener ugc nofollow" target="_blank"><em class="ov">https://github.com</em></a><em class="ov">。</em></p></div></div>    
</body>
</html>