<html>
<head>
<title>Learning More about File Upload Vulnerabilities</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">了解有关文件上传漏洞的更多信息</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/learning-more-about-file-upload-vulnerabilities-1833bed29f5d?source=collection_archive---------1-----------------------#2022-06-28">https://infosecwriteups.com/learning-more-about-file-upload-vulnerabilities-1833bed29f5d?source=collection_archive---------1-----------------------#2022-06-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/deefef157bbf71e3d6604f4f9ce0b0f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*tia56VnJ3cTu8KmT"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated"><strong class="bd kf">照片由</strong><a class="ae kg" href="https://unsplash.com/@shams_ad?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"><strong class="bd kf">Shamsudeen Adedokun</strong></a><strong class="bd kf">上</strong> <a class="ae kg" href="https://unsplash.com/s/photos/hacking?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> <strong class="bd kf"> Unsplas </strong> </a></figcaption></figure><p id="2c23" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">与文件上传相关的漏洞是众所周知的，并且被认为是非常严重的。此漏洞的存在是因为应用程序允许用户在服务器上上传文件。这些图片可能是你的个人资料照片，也可能是你喜欢的任何附件。如果上传的文件处理不当，就会对应用程序造成威胁，攻击者可以利用这些上传的文件对应用程序进行进一步的攻击。这些攻击可能涉及远程代码执行(RCE)或危及整个基础架构的安全。</p><h1 id="5fc3" class="lf lg it bd kf lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated"><strong class="ak">文件上传漏洞有哪些？</strong></h1><figure class="md me mf mg gt ju gh gi paragraph-image"><div class="gh gi mc"><img src="../Images/18a4dfb28c70ddabfb2180b27bef4801.png" data-original-src="https://miro.medium.com/v2/resize:fit:1270/0*nnjxQ8JZHjX1hWRr"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated"><a class="ae kg" href="https://secnhack.in/unrestricted-file-uploading-vulnerability/" rel="noopener ugc nofollow" target="_blank">来源</a></figcaption></figure><p id="81fa" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">当用户能够使用应用程序将文件上传到服务器时，这些文件可能是附件或个人资料图片。然后，应用程序将这些文件存储在几种不同类型的存储中的一种。一些应用程序可能会将这些文件直接保存在服务器上，但许多组织使用存储桶来代替。将文件上传到服务器的过程称为文件上传。如果上传的文件没有得到安全管理，攻击者可能会将恶意文件上传到服务器。该文件可能是一个webshell，根据具体情况，它可能被用来执行命令或危害web服务器。大多数情况下，应用程序通常会对已上传的文件执行大量检查，包括调整它们的大小、继续处理它们或根据要求压缩它们。他们还使用一些机制来添加对已上传文件的验证。例如，它们验证文件的内容类型或MIME类型，这两种类型在大多数情况下通常都能正常工作。</p><p id="cc9e" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">但是，如果应用程序无法对正在上传的文件进行这些验证，对手就能够上传恶意文件，这将从整体上损害服务器的完整性。</p><p id="809b" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">让我们了解一下易受攻击的文件上传代码是什么样子的</p><blockquote class="mh mi mj"><p id="e728" class="kh ki mk kj b kk kl km kn ko kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld le im bi translated"><?服务器端编程语言 （Professional Hypertext Preprocessor的缩写）</root?></p><p id="df87" class="kh ki mk kj b kk kl km kn ko kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld le im bi translated">if(is set($ _ FILES[' image ']){</p><p id="e189" class="kh ki mk kj b kk kl km kn ko kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld le im bi translated">$ file _ name = $ _ FILES[' image '][' name ']；</p><p id="5279" class="kh ki mk kj b kk kl km kn ko kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld le im bi translated">$ file _ ext = strtolow(end(explode(' . ')，$ _ FILES[' image '][' name ']))；</p><p id="0130" class="kh ki mk kj b kk kl km kn ko kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld le im bi translated">move_uploaded_file($file_tmp，" images/"。$文件名称)；</p><p id="8374" class="kh ki mk kj b kk kl km kn ko kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld le im bi translated">呼应“成功”；</p><p id="7926" class="kh ki mk kj b kk kl km kn ko kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld le im bi">?&gt;</p></blockquote><p id="e56d" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">当用户将文件上传到网站时，网站会将文件直接移动到web服务器上的images文件夹中，而不是先对文件进行任何验证。</p><p id="1e56" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">攻击者可以轻松上传如下所示的webshell</p><blockquote class="mh mi mj"><p id="077d" class="kh ki mk kj b kk kl km kn ko kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld le im bi translated"><?php </root?></p><p id="6abb" class="kh ki mk kj b kk kl km kn ko kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld le im bi translated">if(isset($_GET[‘cmd’]))</p><p id="95b3" class="kh ki mk kj b kk kl km kn ko kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld le im bi">{</p><p id="e50d" class="kh ki mk kj b kk kl km kn ko kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld le im bi translated">system($_GET[‘cmd’]);</p><p id="bdb4" class="kh ki mk kj b kk kl km kn ko kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld le im bi">}</p><p id="2940" class="kh ki mk kj b kk kl km kn ko kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld le im bi">?&gt;</p></blockquote><p id="f96a" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">After the shell has been uploaded, for example as a profile picture, an attacker can easily execute commands on the server by right-clicking on the profile picture and opening it in a new tab.</p><h1 id="42db" class="lf lg it bd kf lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated"><strong class="ak">让我们了解一下剥削</strong></h1><p id="94b5" class="pw-post-body-paragraph kh ki it kj b kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ms lc ld le im bi translated">有几种方法可以利用这个漏洞。Web应用程序通常有时会对</p><p id="b530" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">有多种方法可以绕过这一限制。比如:</p><h2 id="8488" class="mt lg it bd kf mu mv dn lk mw mx dp lo ks my mz ls kw na nb lw la nc nd ma ne bi translated"><strong class="ak">通过修改内容类型头绕过它</strong></h2><p id="54fc" class="pw-post-body-paragraph kh ki it kj b kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ms lc ld le im bi translated">如果web应用程序只检查正在上传的文件的文件扩展名，这通常是通过检查随请求一起发送的内容类型头来完成的，那么攻击者可以通过拦截请求并使用该信息进行更改来轻松修改文件的内容类型头。例如，如果上传的文件包含PHP扩展名，如“bypass.php”，但应用程序只支持图像文件扩展名，如“png”或“jpeg”，则该文件将不被接受。这个特定的值，应用/八位字节流，将在那时被插入到内容类型报头中。因此，攻击者将上传一个文件，然后通过拦截请求，他们将能够将其转换为图像/jpeg格式。如果攻击者这样做，因为只有内容类型头被匹配，文件将能够被上载，并且它将绕过对它的约束。</p><figure class="md me mf mg gt ju gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/d069c99a94a333af414596fa3c644ddf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*U1Fzn3WMG8t6QAoY"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated"><a class="ae kg" href="https://beaglesecurity.com/blog/vulnerability/insecure-file-upload.html" rel="noopener ugc nofollow" target="_blank">来源</a></figcaption></figure><h2 id="aaa4" class="mt lg it bd kf mu mv dn lk mw mx dp lo ks my mz ls kw na nb lw la nc nd ma ne bi translated"><strong class="ak">使用空字节绕过限制</strong></h2><p id="cd70" class="pw-post-body-paragraph kh ki it kj b kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ms lc ld le im bi translated">对手可以通过在文件名中插入空字节字符(%00)来规避这一限制。因此，修改后的文件名将更改为bypass.php%00.jpg。因此，空字节(%00)后面的所有内容都将被忽略。这将使应用程序认为正在上传一个JPEG文件，因为扩展名和内容类型头是完全匹配的。因此，文件将被成功上传。</p><h1 id="696d" class="lf lg it bd kf lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated"><strong class="ak">补救</strong></h1><ul class=""><li id="8a5a" class="ng nh it kj b kk mo ko mp ks ni kw nj la nk le nl nm nn no bi translated">将可以上传的文件类型限制为公司日常运营所必需的类型非常重要。</li><li id="59eb" class="ng nh it kj b kk np ko nq ks nr kw ns la nt le nl nm nn no bi translated">除非您首先对文件应用了基于允许列表的过滤器，否则不要接受未经过滤的文件名及其扩展名。</li><li id="024a" class="ng nh it kj b kk np ko nq ks nr kw ns la nt le nl nm nn no bi translated">任何上传到服务器的文件都应该首先被应用程序扫描，然后应用程序应该检查文件的内容。在被其他用户访问之前，每一个文件都应该事先经过验证和病毒扫描。如果有哪怕是一丁点儿的怀疑，该文件应该被删除。</li></ul><h1 id="2c22" class="lf lg it bd kf lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated"><strong class="ak">结论</strong></h1><p id="6527" class="pw-post-body-paragraph kh ki it kj b kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ms lc ld le im bi translated">就应用程序安全性而言，上传文件的能力是最常见的漏洞之一，如果程序员管理员没有正确集成验证过程，利用该漏洞就相对简单。利用漏洞的方式或服务器授予的权限都会影响攻击的整体严重性。尽快实现OWASP前10项中列出的所有验证，然后尽快修补您的应用程序。这将避免您的应用程序中的文件上传漏洞。</p><p id="b49c" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated"><em class="mk">又及:信息安全领域每天都有很多事情发生，很难跟上。加入我们的</em> <strong class="kj iu"> <em class="mk">每周简讯</em> </strong> <em class="mk">以5篇文章、4个线程、3个视频、2个Github Repos和工具以及1个</em> <strong class="kj iu"> <em class="mk">工作提醒的形式免费获取所有最新的信息安全趋势！</em></strong><em class="mk"/><a class="ae kg" href="https://weekly.infosecwriteups.com/" rel="noopener ugc nofollow" target="_blank"><em class="mk">https://weekly.infosecwriteups.com/</em></a></p></div></div>    
</body>
</html>