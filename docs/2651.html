<html>
<head>
<title>CVE-2022-42710: A journey through XXE to Stored-XSS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">CVE-2022-42710:从XXE到XSS的旅行</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/cve-2022-42710-a-journey-through-xxe-to-stored-xss-851d74dfe917?source=collection_archive---------0-----------------------#2022-12-16">https://infosecwriteups.com/cve-2022-42710-a-journey-through-xxe-to-stored-xss-851d74dfe917?source=collection_archive---------0-----------------------#2022-12-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="0c10" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">大家好，我将在这篇文章中与大家详细分享我是如何通过静态分析找到CVE-2022–42710的</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/1f156882e5b5b6c13791565823818b1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JctrRQKTtk3BjmPYBINsMw.jpeg"/></div></div></figure><h2 id="705d" class="kr ks iq bd kt ku kv dn kw kx ky dp kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">线性浮现E3系列概述:</h2><p id="c8b3" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">线性浮现E3系列是建筑管理系统中的行业领先产品之一，因为它是控制行业中使用最广泛的产品之一</p><ul class=""><li id="68f1" class="mg mh iq lp b lq mi lt mj la mk le ml li mm mf mn mo mp mq bi translated">学区和校园(K12和高等教育)</li><li id="7778" class="mg mh iq lp b lq mr lt ms la mt le mu li mv mf mn mo mp mq bi translated">企业园区</li><li id="5ebd" class="mg mh iq lp b lq mr lt ms la mt le mu li mv mf mn mo mp mq bi translated">州/地方政府建筑(市政中心、市政厅、警察局、监狱等。)</li><li id="3345" class="mg mh iq lp b lq mr lt ms la mt le mu li mv mf mn mo mp mq bi translated">公用事业</li><li id="ba21" class="mg mh iq lp b lq mr lt ms la mt le mu li mv mf mn mo mp mq bi translated">交通(机场、地铁、公共汽车站)</li><li id="afb7" class="mg mh iq lp b lq mr lt ms la mt le mu li mv mf mn mo mp mq bi translated">礼拜场所(教堂、大型教堂校园)</li><li id="a620" class="mg mh iq lp b lq mr lt ms la mt le mu li mv mf mn mo mp mq bi translated">医疗设施(医院、制药公司、生物实验室等。)</li><li id="88d9" class="mg mh iq lp b lq mr lt ms la mt le mu li mv mf mn mo mp mq bi translated">更多</li></ul><h2 id="fbef" class="kr ks iq bd kt ku kv dn kw kx ky dp kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">让我们开始静态分析:</h2><p id="c6cc" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">当我在做安全源代码审查时，我看到了这个PHP脚本</p><p id="222e" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">http://127 . 0 . 0 . 1/badging/badge _ template _ print . PHP</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mz"><img src="../Images/87f3b253f18681dbecfecff1ba81573c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tLqLg4hi64RZ1wpOE9yCTg.png"/></div></div></figure><blockquote class="na nb nc"><p id="7f1e" class="ln lo nd lp b lq mi jr ls lt mj ju lv ne mw lx ly nf mx ma mb ng my md me mf ij bi translated">配置文件中的TPL _ DIR = TPL/</p></blockquote><p id="a048" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">我们从用户那里获得“tpl”参数，然后将它传递给simplexml_load_file，这样我们的输入将被xml解析器解析，乍一看，它似乎不容易受到XXE的攻击，而容易受到XXE的攻击，它需要加载“LIBXML_NOENT”类，该类替换导致XXE的外部实体</p><p id="0065" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">易受XXE攻击的代码示例</p><pre class="kg kh ki kj gt nh ni nj bn nk nl bi"><span id="40b7" class="nm ks iq ni b be nn no l np nq">try<br/>{<br/>    $template = $_REQUEST["tpl"];<br/>    $xml = simplexml_load_file(TPL_DIR.$template, 'SimpleXMLElement', LIBXML_NOENT);</span></pre><p id="5db9" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">但这不是我们的情况，所以到目前为止，它还不容易受到XXE的影响</p><p id="6328" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">但是我开始收集更多关于XML解析器库的信息</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nr"><img src="../Images/3b28258ce32be8fddd31f65d6e88b175.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RVa_8_4Yh2LmPft7tWt-mw.png"/></div></div></figure><p id="5733" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">好的，libxml版本不容易受到XXE的攻击，默认情况下在最新版本中“替换外部实体”,但根据这个版本，它似乎有点旧，所以我们需要在https://www.cvedetails.com/的CVE详细信息<a class="ae ns" href="https://www.cvedetails.com/" rel="noopener ugc nofollow" target="_blank">上做一些搜索</a></p><p id="e24d" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">也许有剥削或以某种方式滥用功能在一个坏的方式</p><p id="18b4" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">在做了一些搜索后，发现了一些漏洞，但它们与应用程序的配置不匹配，所以它们不会导致任何漏洞</p><p id="b64f" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">无论如何，上述步骤在我们的静态代码分析中很重要，因为它有时会导致严重的漏洞</p><p id="db4b" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">有一位研究人员在对一个java应用程序进行代码审查时发现了一个类似的场景，他发现开发人员使用XMLparser库，默认情况下允许外部实体替换，最终导致XXE漏洞，您可以在https://nvd.nist.gov/vuln/detail/CVE-2017-1000190<a class="ae ns" href="https://nvd.nist.gov/vuln/detail/CVE-2017-1000190" rel="noopener ugc nofollow" target="_blank">的</a>找到关于易受攻击应用程序在之前的场景中使用的易受攻击的XML parser库的更多详细信息</p><p id="9f5e" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">因此，我没有找到这个特定版本的任何内容，唯一允许的方法是将“LIBXML_NOENT”类添加到“simplexml_load_file”函数中，以替换外部实体，这样产品就不会受到XXE的攻击</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="4028" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">所以让我们回到我们的主题</p><p id="4ce6" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">在下划线代码中，我们可以知道XML数据将如何被解析</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mz"><img src="../Images/87f3b253f18681dbecfecff1ba81573c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tLqLg4hi64RZ1wpOE9yCTg.png"/></div></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nv"><img src="../Images/dca4262c9fb6845c80f40122eb495436.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UHfelocaGvMZme8cRlc8IA.png"/></div></div></figure><p id="bd8e" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">应用程序将一个文件作为输入，由XMLparser解析它，然后将它保存在$xml变量中</p><p id="d082" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">正如你在上面的代码中看到的，输入文件应该包含一个方向标签，在它里面应该有两个标签方向和背景标签，然后在第56行你会发现背景标签里面的任何内容都会被打印出来</p><p id="0bca" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">因此，为了实现我们的XSS，我们应该首先定义<xml>标记，让解析器知道我们解析XML文件，然后像我们在PHP代码中看到的那样定义<orientations>标记，然后在它内部定义两个标记，第一个是<orientation>标记，第二个是<background>标记，它们将通过echo函数打印，并包含我们的XSS有效负载</background></orientation></orientations></xml></p><p id="c9ff" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">最终的有效载荷会是这样的</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nv"><img src="../Images/88ceef9153c66c9796873d26d9dd823b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JOwD36ALJEKy-GTIREpmVg.png"/></div></div><figcaption class="nw nx gj gh gi ny nz bd b be z dk translated">剥削</figcaption></figure><p id="4479" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">CDATA用于命令解析器，文档的特定部分不包含标记，应该被视为常规文本，而不是XML</p><p id="10c1" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">这样做的原因是让解析器将我们的<script>标签视为背景标签中的文本，稍后将在应用程序中打印出来&lt;/root&gt;</script></p><p id="dc9c" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">但是等一下</p><p id="b8b5" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">我们如何上传包含利用漏洞实现XSS的XML文件？</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oa nu l"/></div></figure><p id="1f2b" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">在对应用程序做了一些研究后，我发现了这个PHP脚本</p><p id="b300" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">http://127 . 0 . 0 . 1/badging/person _ funct . PHP</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nv"><img src="../Images/cdf646ea1455aef9e545ad268891b3d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SP6nm56iivcm9F7v3cWeCg.png"/></div></div></figure><p id="da0f" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">这是一个文件上传功能，验证大小，以防止DOS攻击，并命名与上传文件的时间，以防止XSS在文件名和部队”。jpg "文件扩展名，以防止上传恶意扩展名</p><blockquote class="na nb nc"><p id="a4ad" class="ln lo nd lp b lq mi jr ls lt mj ju lv ne mw lx ly nf mx ma mb ng my md me mf ij bi translated">在这个PHP脚本中有一些最佳实践，但是让我们关注更重要的事情</p></blockquote><p id="02eb" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">现在我们需要上传exploit.xml文件，但是应用程序强制使用jpg扩展名，那么我们该如何做呢</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ob nu l"/></div></figure><p id="7b11" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">实际上，文件扩展名是什么并不重要，因为simplexml_load_file()使用的XML解析器并不关心文件扩展名，它所关心的只是文件语法，所以我们将使用“http://127 . 0 . 0 . 1/badging/person _ funct . PHP”脚本上传我们的漏洞</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oc"><img src="../Images/447a062d3cca24e39ab369b8dd2b46cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Jjv3hL8E4iZIR4Y-UriaHA.png"/></div></div><figcaption class="nw nx gj gh gi ny nz bd b be z dk translated">上传我们的expolit请求</figcaption></figure><p id="9dee" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">我们的漏洞被上传到“http://127 . 0 . 0 . 1/user _ img/20220830152741 . jpg”</p><p id="9677" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">现在我们将在“http://127 . 0 . 0 . 1/badging/badge _ template _ print . PHP”脚本中使用tpl参数请求它</p><p id="0c44" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">但是我们在“user_img”目录中的漏洞和易受攻击的函数从不同的目录“/badging/tpl/”中加载文件，那么我们如何加载我们的漏洞呢？</p><p id="ddae" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">我们需要从user_img目录中获取漏洞，因此我们将进行目录遍历”../../user_img "从" http://127.0.0.1/badging/tpl/"目录转到我们的漏洞所在的" http://127.0.0.1/user_img "目录</p><blockquote class="na nb nc"><p id="d9f5" class="ln lo nd lp b lq mi jr ls lt mj ju lv ne mw lx ly nf mx ma mb ng my md me mf ij bi translated">http://127 . 0 . 0 . 1/badging/badge _ template _ print . PHP？idt=1&amp;tpl=../../user_img/20220830152741.jpg</p></blockquote><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi od"><img src="../Images/a6c8fa6e40fe2ecfce91b124658a204c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*x7BO7lcWcY6PXq3tF-9bjg.png"/></div></div></figure><p id="3ecd" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">我们得到了我们储存的XSS</p><h2 id="51f0" class="kr ks iq bd kt ku kv dn kw kx ky dp kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">自动化漏洞脚本:</h2><p id="5bcd" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated"><a class="ae ns" href="https://github.com/omarhashem123/Security-Research/tree/main/CVE-2022-42710" rel="noopener ugc nofollow" target="_blank">https://github . com/omarhashem 123/Security-Research/tree/main/CVE-2022-42710</a></p><h1 id="5f40" class="oe ks iq bd kt of og oh kw oi oj ok kz jw ol jx ld jz om ka lh kc on kd ll oo bi translated">保持联络</h1><p id="d2df" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">推特:<a class="ae ns" href="https://twitter.com/OmarHashem666" rel="noopener ugc nofollow" target="_blank"> @OmarHashem666 </a></p><p id="f100" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">领英:【https://www.linkedin.com/in/omar-1-hashem T2】</p><p id="39a1" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">YouTube:【https://www.youtube.com/@omarhashem7351 T4】</p></div><div class="ab cl op oq hu or" role="separator"><span class="os bw bk ot ou ov"/><span class="os bw bk ot ou ov"/><span class="os bw bk ot ou"/></div><div class="ij ik il im in"><h2 id="df88" class="kr ks iq bd kt ku kv dn kw kx ky dp kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">来自Infosec的报道:Infosec每天都有很多内容，很难跟上。<a class="ae ns" href="https://weekly.infosecwriteups.com/" rel="noopener ugc nofollow" target="_blank">加入我们的每周简讯</a>以5篇文章、4个线程、3个视频、2个GitHub Repos和工具以及1个工作提醒的形式免费获取所有最新的Infosec趋势！</h2></div></div>    
</body>
</html>