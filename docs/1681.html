<html>
<head>
<title>Compiling Postgres library for exploiting UDF to RCE</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为开发UDF到RCE而编写Postgres图书馆</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/compiling-postgres-library-for-exploiting-udf-to-rce-d8cfd197bdf9?source=collection_archive---------0-----------------------#2021-11-23">https://infosecwriteups.com/compiling-postgres-library-for-exploiting-udf-to-rce-d8cfd197bdf9?source=collection_archive---------0-----------------------#2021-11-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="b8d9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我最近参加了WEB-300课程并通过了OSWE考试。WEB-300课程模块包括UDF反向外壳。我发现困难的一件事是如何为postgres的特定版本编译库以用于UDF。所以我决定分享我所学到的。</p><div class="kl km gp gr kn ko"><a href="https://www.offensive-security.com/awae-oswe/" rel="noopener  ugc nofollow" target="_blank"><div class="kp ab fo"><div class="kq ab kr cl cj ks"><h2 class="bd ir gy z fp kt fr fs ku fu fw ip bi translated">高级网络攻击和利用(AWAE) |攻击性安全</h2><div class="kv l"><h3 class="bd b gy z fp kt fr fs ku fu fw dk translated">了解高级web攻击和利用中的白盒Web应用程序安全测试(WEB-300)。完成课程并…</h3></div><div class="kw l"><p class="bd b dl z fp kt fr fs ku fu fw dk translated">www.offensive-security.com</p></div></div><div class="kx l"><div class="ky l kz la lb kx lc ld ko"/></div></div></a></div><h2 id="d98f" class="le lf iq bd lg lh li dn lj lk ll dp lm jy ln lo lp kc lq lr ls kg lt lu lv lw bi translated">我为什么写这个？</h2><p id="c339" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">这有两个原因:</p><ol class=""><li id="14f5" class="mc md iq jp b jq jr ju jv jy me kc mf kg mg kk mh mi mj mk bi translated">开发过程中所需的库依赖于平台。你不能运行在linux操作系统上编译的库来利用运行在windows上的postgres，反之亦然</li><li id="cddc" class="mc md iq jp b jq ml ju mm jy mn kc mo kg mp kk mh mi mj mk bi translated">同时，图书馆依赖于postgres的主要版本</li></ol><p id="5daa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">注意:如果postgres版本高于9.3并且复制功能在需要的权限下可用，可以使用</strong><a class="ae mq" href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/PostgreSQL%20Injection.md#postgresql-command-execution" rel="noopener ugc nofollow" target="_blank"><strong class="jp ir">payload all things command injection</strong></a><strong class="jp ir">获得一个反向shell，而不必为UDF而烦恼:)</strong></p><h2 id="0642" class="le lf iq bd lg lh li dn lj lk ll dp lm jy ln lo lp kc lq lr ls kg lt lu lv lw bi translated">在Linux上编译库</h2><p id="ee98" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">为此，我们将在kali上使用docker，以避免搞乱主机配置和文件(<strong class="jp ir"> <em class="mr">)我首先尝试在主机上这样做，导致我的机器崩溃。谢天谢地，我有重要东西的备份。</em> </strong>)</p><ol class=""><li id="5ed4" class="mc md iq jp b jq jr ju jv jy me kc mf kg mg kk mh mi mj mk bi translated">如果你还没有安装docker，这个链接会为你解释清楚<a class="ae mq" href="https://airman604.medium.com/installing-docker-in-kali-linux-2017-1-fbaa4d1447fe" rel="noopener">https://airman 604 . medium . com/installing-docker-in-kali-Linux-2017-1-FBA a4 d 1447 Fe</a></li><li id="55ee" class="mc md iq jp b jq ml ju mm jy mn kc mo kg mp kk mh mi mj mk bi translated">让我们用<em class="mr"> docker pull postgres:10.18来拉一下postgres主要版本的docker镜像。如果你已经开发了sql注入，你可以很容易地找到postgres版本</em></li></ol><figure class="mt mu mv mw gt mx gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi ms"><img src="../Images/c42c724f4a01bec101661ab463d3dbf3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Mm8x9iPVYgfPzX9RF4MMWw.png"/></div></div></figure><p id="5f5f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">3.在主机上创建一个postgres-data目录，并将其挂载为容器的数据卷，以存储所有数据库文件</p><pre class="mt mu mv mw gt nd ne nf ng aw nh bi"><span id="5325" class="le lf iq ne b gy ni nj l nk nl">root💀osboxes)-[/home/osboxes]<br/>└─# <strong class="ne ir">mkdir postgres-data</strong></span></pre><p id="192b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">4.使用命令运行docker容器，将数据卷映射到容器<strong class="jp ir"> <em class="mr"> udf-postgres </em> </strong>，将密码设置为<strong class="jp ir"> <em class="mr"> noob@123 </em> </strong>，并将端口映射到5432</p><pre class="mt mu mv mw gt nd ne nf ng aw nh bi"><span id="f3c6" class="le lf iq ne b gy ni nj l nk nl">──(root💀osboxes)-[/home/osboxes]<br/>└─# d<strong class="ne ir">ocker run -d --name udf-postgres -e POSTGRES_PASSWORD=noob@123 -v /home/osboxes/postgres-data/:/var/lib/postgresql/data -p 5432:5432 postgres:10.18</strong>    <br/>92212e425db4ce74108a95d9a891ca1233979c470d2bb2fa58092618ef7f73f1<br/>                                                                                                                                                                          <br/>┌──(root💀osboxes)-[/home/osboxes]<br/>└─# <strong class="ne ir">docker ps</strong>                                                                                                                                           <br/>CONTAINER ID   IMAGE            COMMAND                  CREATED          STATUS          PORTS                                       NAMES<br/>92212e425db4   postgres:10.18   "docker-entrypoint.s…"   14 seconds ago   Up 12 seconds   0.0.0.0:5432-&gt;5432/tcp, :::5432-&gt;5432/tcp   udf-postgres</span></pre><p id="b9cf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">5.Exec进入正在运行的容器</p><pre class="mt mu mv mw gt nd ne nf ng aw nh bi"><span id="536a" class="le lf iq ne b gy ni nj l nk nl">┌──(root💀osboxes)-[/home/osboxes]<br/>└─# <strong class="ne ir">docker exec -it udf-postgres bash</strong>                                                                                                                               <br/>root@92212e425db4:/#</span></pre><p id="8eee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">6.运行<strong class="jp ir"> <em class="mr"> apt-get更新</em> </strong>和<strong class="jp ir"> <em class="mr"> apt-get安装PostgreSQL-server-dev-10</em></strong><em class="mr">(使用dev-10考虑到postgres的主要版本)。我们需要安装postgresql-server-dev cause，它包含编译UDF所需的库</em></p><pre class="mt mu mv mw gt nd ne nf ng aw nh bi"><span id="240d" class="le lf iq ne b gy ni nj l nk nl">root@92212e425db4:/# <strong class="ne ir">apt-get update</strong><br/><br/>Fetched 8,448 kB in 5s (1,491 kB/s)                                   <br/>Reading package lists... Done</span><span id="e243" class="le lf iq ne b gy nm nj l nk nl">root@92212e425db4:/# <strong class="ne ir">apt-get install postgresql-server-dev-10</strong></span></pre><p id="48d9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">7.将gcc安装在容器内</p><pre class="mt mu mv mw gt nd ne nf ng aw nh bi"><span id="014b" class="le lf iq ne b gy ni nj l nk nl">root@92212e425db4:/# <strong class="ne ir">apt install gcc</strong></span></pre><p id="6bb4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">8.从这个github库<a class="ae mq" href="https://github.com/Dionach/pgexec/blob/master/pg_exec.c" rel="noopener ugc nofollow" target="_blank">https://github.com/Dionach/pgexec/blob/master/pg_exec.c</a>下载pg_exec.c，并移动到映射到容器卷的<strong class="jp ir"> postgres-data </strong>目录</p><pre class="mt mu mv mw gt nd ne nf ng aw nh bi"><span id="410b" class="le lf iq ne b gy ni nj l nk nl">┌──(root💀osboxes)-[/home/osboxes/postgres-data]<br/>└─# <strong class="ne ir">ls -la *.c</strong><br/>-rw-r--r-- 1 root root 255 Nov 20 04:58 pg_exec.c</span></pre><p id="32fc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">9.找到<strong class="jp ir"> postgres.h </strong>库，因为它是编译所需要的</p><pre class="mt mu mv mw gt nd ne nf ng aw nh bi"><span id="11ac" class="le lf iq ne b gy ni nj l nk nl">root@92212e425db4:/# <strong class="ne ir">find / -iname postgres.h 2&gt;/dev/null</strong><br/>/usr/include/postgresql/10/server/postgres.h</span></pre><p id="43cc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">10.cd到容器内的映射目录，即<strong class="jp ir"> /var/lib/postgresql/data </strong>。这就是我们的<strong class="jp ir"> pg_exec.c </strong>文件所在的位置</p><figure class="mt mu mv mw gt mx gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi nn"><img src="../Images/a00c999406d63d1082a2504c164ae937.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*csIM4Z9T-gk0d2a1iDQdqA.png"/></div></div></figure><p id="8af5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">11.现在将<strong class="jp ir"> pg_exec.c </strong>编译成一个。所以使用下面的命令归档</p><pre class="mt mu mv mw gt nd ne nf ng aw nh bi"><span id="b9e0" class="le lf iq ne b gy ni nj l nk nl">root@92212e425db4:/var/lib/postgresql/data# <strong class="ne ir">gcc -I /usr/include/postgresql/10/server/ -shared -fPIC -o pg_exec.so pg_exec.c</strong></span></pre><p id="8dd5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">12.您可以在主机服务器的postgres-data目录中找到编译后的二进制文件<strong class="jp ir"> pg_exec.so </strong></p><figure class="mt mu mv mw gt mx gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi no"><img src="../Images/fbb7d9a395d79c077c9ef103e3046433.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KvmEzZVrUucdP_iCzTow9Q.png"/></div></div></figure><p id="5e42" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在剩下的就是使用发现的sql注入将生成的<strong class="jp ir"> pg_exec.so </strong>传输到目标系统，并将它们存储在postgres大型对象中。稍后，将相同的二进制文件复制到目标上的本地文件系统中，以供UDF调用。一旦你有了正确的二进制文件，这里有一些资源可以帮助你获得反向shell</p><div class="kl km gp gr kn ko"><a href="https://blog.pentesteracademy.com/postgresql-udf-command-execution-372f0c68cfed" rel="noopener  ugc nofollow" target="_blank"><div class="kp ab fo"><div class="kq ab kr cl cj ks"><h2 class="bd ir gy z fp kt fr fs ku fu fw ip bi translated">PostgreSQL UDF命令执行</h2><div class="kv l"><h3 class="bd b gy z fp kt fr fs ku fu fw dk translated">Metasploit框架是最流行和最强大的网络渗透测试工具，广泛应用于…</h3></div><div class="kw l"><p class="bd b dl z fp kt fr fs ku fu fw dk translated">blog.pentesteracademy.com</p></div></div><div class="kx l"><div class="np l kz la lb kx lc ld ko"/></div></div></a></div><div class="kl km gp gr kn ko"><a href="https://www.dionach.com/blog/postgresql-9-x-remote-command-execution/" rel="noopener  ugc nofollow" target="_blank"><div class="kp ab fo"><div class="kq ab kr cl cj ks"><h2 class="bd ir gy z fp kt fr fs ku fu fw ip bi translated">PostgreSQL 9.x远程命令执行- Dionach</h2><div class="kv l"><h3 class="bd b gy z fp kt fr fs ku fu fw dk translated">在最近的一次渗透测试中，我能够访问PostgreSQL 9.0服务。而执行的过程…</h3></div><div class="kw l"><p class="bd b dl z fp kt fr fs ku fu fw dk translated">www.dionach.com</p></div></div></div></a></div><p id="814d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">感谢阅读。让我知道，如果你发现任何困难复制上述步骤，将很乐意清除您的疑问。另外，如果你需要一步一步的指导来创建一个用于UDF -&gt; RCE漏洞的窗口DLL，请在评论中留言。</p><p id="fee6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在LinkedIn<a class="ae mq" href="https://www.linkedin.com/in/niraj-kumar-choubey-7351b892/" rel="noopener ugc nofollow" target="_blank">https://www.linkedin.com/in/niraj-kumar-choubey-7351b892/</a>上与我联系，打招呼或讨论任何网络安全问题。</p></div></div>    
</body>
</html>