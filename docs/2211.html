<html>
<head>
<title>Pivoting Techniques with THM Wreath</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">花环的旋转技巧</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/pivoting-techniques-with-thm-wreath-95fecba1b580?source=collection_archive---------0-----------------------#2022-07-24">https://infosecwriteups.com/pivoting-techniques-with-thm-wreath-95fecba1b580?source=collection_archive---------0-----------------------#2022-07-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/57cbbf4a094ca24701bc500af32f4a8f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1302/format:webp/1*acgev7SZUi3Kz3h2DYPyzg.png"/></div></figure><p id="877b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在本文中，我将介绍一些基本的旋转方法，这些方法可以用来访问我们通常无法通过被入侵的计算机访问的网络。为了演示这些旋转技巧，我将使用由用户<a class="ae ks" href="https://tryhackme.com/p/MuirlandOracle" rel="noopener ugc nofollow" target="_blank"> MuirlandOracle </a>创建的<a class="ae ks" href="https://tryhackme.com/room/wreath" rel="noopener ugc nofollow" target="_blank"> TryHackMe </a>花环网络。旋转是一个很大的主题，这篇文章将只涵盖基本原理，所以说，让我们深入！</p></div><div class="ab cl kt ku hu kv" role="separator"><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky"/></div><div class="ij ik il im in"><h1 id="e991" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">什么是旋转？</h1><p id="691e" class="pw-post-body-paragraph ju jv iq jw b jx ly jz ka kb lz kd ke kf ma kh ki kj mb kl km kn mc kp kq kr ij bi translated"><a class="ae ks" href="https://pentest.blog/explore-hidden-networks-with-double-pivoting/" rel="noopener ugc nofollow" target="_blank">旋转</a>指的是使用一台被入侵的机器在网络内移动并攻击其他无法访问的系统的技术。这是通过使用各种不同的工具将流量路由通过被入侵的机器来实现的。当讨论旋转时，您会碰到端口转发和隧道/代理这两个术语。</p><p id="7ce8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><a class="ae ks" href="https://tryhackme.com/room/wreath" rel="noopener ugc nofollow" target="_blank"> <strong class="jw ir">端口转发</strong> </a> <strong class="jw ir"> </strong>通过被入侵的主机在本地端口和目标上的单个端口之间创建连接。端口转发往往比代理更快、更可靠，但只允许我们访问单个目标设备上的单个端口(或小范围)。在下面的例子中，SSH被用于通过跳转服务器传输流量，允许我们通过导航到我们自己的攻击机器上的端口8000来访问端口80处的内部web服务器上的网站。</p><figure class="me mf mg mh gt jr gh gi paragraph-image"><div class="gh gi md"><img src="../Images/542534c7b4156e5c8f52bfeceb94e952.png" data-original-src="https://miro.medium.com/v2/resize:fit:1316/format:webp/1*N0ue9WN22MUDwQNvWiQsPA.png"/></div><figcaption class="mi mj gj gh gi mk ml bd b be z dk translated">SSH端口转发示例。</figcaption></figure><p id="623c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><a class="ae ks" href="https://tryhackme.com/room/wreath" rel="noopener ugc nofollow" target="_blank"> <strong class="jw ir">隧道/代理</strong> </a> <strong class="jw ir"> </strong>通过被入侵的机器创建代理类型的连接，以便将所有期望的流量路由到目标网络。这也有可能在另一个协议(例如SSH隧道)中通过隧道传输，这对于避开基本的入侵检测系统(IDS)或防火墙很有用。如果我们希望将大量不同类型的流量重定向到我们的目标网络，例如，通过NMAP扫描，或者访问多台不同机器上的多个端口，代理是很好的选择。</p><figure class="me mf mg mh gt jr gh gi paragraph-image"><div class="gh gi mm"><img src="../Images/8b4cfbb94e0acc7afac03bb6e19754eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1364/format:webp/1*czt0nUkVvZNGJjydi99V-Q.png"/></div><figcaption class="mi mj gj gh gi mk ml bd b be z dk translated">SSH隧道示例。</figcaption></figure></div><div class="ab cl kt ku hu kv" role="separator"><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky"/></div><div class="ij ik il im in"><h1 id="17d0" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">旋转枚举</h1><p id="6bae" class="pw-post-body-paragraph ju jv iq jw b jx ly jz ka kb lz kd ke kf ma kh ki kj mb kl km kn mc kp kq kr ij bi translated">在这个场景中，我们已经入侵了一个面向外部的Linux web服务器，并获得了root访问权限。虽然提供了环形网络布局，但这些信息最初可能并不总是对我们可用。假设我们不知道网络布局，下图显示了我们目前对花环网络的了解。</p><figure class="me mf mg mh gt jr gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/29134709b6795831141c8d2bcbdcfc55.png" data-original-src="https://miro.medium.com/v2/resize:fit:1386/format:webp/1*Olax936FlUfq9cIWT0xGSQ.png"/></div><figcaption class="mi mj gj gh gi mk ml bd b be z dk translated">环网的最新知识。</figcaption></figure><p id="7919" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为了执行我们的旋转，我们首先需要识别我们可能潜在的目标的任何内部机器或内部网络。为了实现这一点，我们可以从我们的攻击机器上传一个静态的NMAP二进制文件到web服务器，正如挑战所建议的那样。如果我们不能做到这一点，我们可以检查本地材料，如ARP缓存。</p><pre class="me mf mg mh gt mo mp mq mr aw ms bi"><span id="5312" class="mt lb iq mp b gy mu mv l mw mx">arp -a</span></pre><figure class="me mf mg mh gt jr gh gi paragraph-image"><div class="ab gu cl my"><img src="../Images/8dd39cf56ceb33e8c77be77883c93501.png" data-original-src="https://miro.medium.com/v2/format:webp/1*wHTlq9motrT7ObzKxqO07A.png"/></div><figcaption class="mi mj gj gh gi mk ml bd b be z dk translated">ARP缓存显示目标最近与之交互的主机的IP地址。</figcaption></figure><p id="16f0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我可以看到三个IP地址，用于识别网络的网络地址(即10.200.81.1)和两个主机地址(即10.200.81.100和10.200.81.150)。这让我们对环网布局有了更好的了解。</p><figure class="me mf mg mh gt jr gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/2439802f2ee5e290eb909fd2cac3e255.png" data-original-src="https://miro.medium.com/v2/resize:fit:1342/format:webp/1*-WoTkT_ATZ0YQCFNw18QAA.png"/></div><figcaption class="mi mj gj gh gi mk ml bd b be z dk translated">具有两个新识别的宿主的环网。</figcaption></figure><p id="5975" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在两台主机上执行NMAP扫描，我可以看到主机<strong class="jw ir"> 10.200.81.150上的以下端口是打开的。</strong></p><pre class="me mf mg mh gt mo mp mq mr aw ms bi"><span id="0689" class="mt lb iq mp b gy mu mv l mw mx">PORT      STATE SERVICE       REASON<br/>80/tcp    open  http          syn-ack ttl 128<br/>135/tcp   open  epmap         syn-ack ttl 128<br/>139/tcp   open  netbios-ssn   syn-ack ttl 128<br/>445/tcp   open  microsoft-ds  syn-ack ttl 128<br/>3389/tcp  open  ms-wbt-server syn-ack ttl 128<br/>5357/tcp  open  wsdapi        syn-ack ttl 128<br/>5985/tcp  open  wsman         syn-ack ttl 128</span></pre><p id="fabf" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">端口3389(通常为RDP保留)和5985 (WRM / WinRM)打开表明这很可能是一台Windows机器。从这里，我们终于可以开始考虑使用什么样的旋转技术来访问Windows主机上的服务了😃！</p><figure class="me mf mg mh gt jr gh gi paragraph-image"><div class="gh gi na"><img src="../Images/3627c220f5d7fc07509ef3b5860bae1e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/0*I_iShgHHhgpfwXqS.jpg"/></div><figcaption class="mi mj gj gh gi mk ml bd b be z dk translated"><a class="ae ks" href="https://www.pinterest.ie/pin/487162884662300442/" rel="noopener ugc nofollow" target="_blank">来源</a></figcaption></figure></div><div class="ab cl kt ku hu kv" role="separator"><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky"/></div><div class="ij ik il im in"><h1 id="385f" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">SSH端口转发/代理</h1><p id="4662" class="pw-post-body-paragraph ju jv iq jw b jx ly jz ka kb lz kd ke kf ma kh ki kj mb kl km kn mc kp kq kr ij bi translated"><strong class="jw ir"> SSH端口转发</strong>包括创建一个转发(或“本地”)SSH隧道，当我们拥有对目标的SSH访问权限时，可以从我们的攻击机器上完成。在这个场景中，我们在受损的Linux web服务器上有一个用户root的SSH密钥。通过导航到我们自己的攻击机器上的端口18021，可以使用下面的命令访问10.200.81.150(通过10.200.81.200)上的网站。</p><pre class="me mf mg mh gt mo mp mq mr aw ms bi"><span id="88bf" class="mt lb iq mp b gy mu mv l mw mx"><strong class="mp ir">ssh -L 18021:10.200.81.150:80 root@10.200.81.200 -i id_rsa </strong><br/>[root@prod-serv ~]#</span></pre><p id="ab28" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在我们可以通过访问<strong class="jw ir"> localhost:18021 </strong>导航到该网页。</p><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nc nd di ne bf nf"><div class="gh gi nb"><img src="../Images/06c5cb3a7b2512716768682bdee50846.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*S6exHyGBnZ1WMHdntugxpA.png"/></div></div><figcaption class="mi mj gj gh gi mk ml bd b be z dk translated">通过10.200.81.150访问端口80上托管的网页。</figcaption></figure><p id="f9f7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir"> SSH代理</strong>也可以使用<strong class="jw ir"> -D </strong>开关进行，例如:<code class="fe ng nh ni mp b">-D 1080</code>。这将打开攻击机器上的端口1080，作为代理向受保护的网络发送数据。这在与<strong class="jw ir"> proxychains </strong>等工具结合使用时非常有用。端口1080的选择完全是任意的——重要的是该端口可用，并且在proxychains(或等效的)配置文件中正确设置。设置此代理将允许我们将所有流量路由到目标网络。该命令的一个示例是:</p><pre class="me mf mg mh gt mo mp mq mr aw ms bi"><span id="0f57" class="mt lb iq mp b gy mu mv l mw mx"><strong class="mp ir">ssh -D 1080 root@10.200.81.200 -i id_rsa </strong><br/>[root@prod-serv ~]#</span></pre><p id="b0a5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">然后，我们使用工具，如NMAP与proxychains，来收集更多关于目标的信息:</p><pre class="me mf mg mh gt mo mp mq mr aw ms bi"><span id="e71e" class="mt lb iq mp b gy mu mv l mw mx"><strong class="mp ir">proxychains nmap -v -sV -sC -p 80 10.200.81.150</strong></span><span id="d157" class="mt lb iq mp b gy nj mv l mw mx">PORT   STATE SERVICE VERSION<br/>80/tcp open  http    Apache httpd 2.2.22 ((Win32) mod_ssl/2.2.22 OpenSSL/0.9.8u mod_wsgi/3.3 Python/2.7.2 PHP/5.4.3)<br/>|_http-server-header: Apache/2.2.22 (Win32) mod_ssl/2.2.22 OpenSSL/0.9.8u mod_wsgi/3.3 Python/2.7.2 PHP/5.4.3<br/>|_http-title: Page not found at /</span></pre></div><div class="ab cl kt ku hu kv" role="separator"><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky"/></div><div class="ij ik il im in"><h1 id="5886" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">舒特尔</h1><p id="3e40" class="pw-post-body-paragraph ju jv iq jw b jx ly jz ka kb lz kd ke kf ma kh ki kj mb kl km kn mc kp kq kr ij bi translated"><a class="ae ks" href="https://github.com/sshuttle/sshuttle" rel="noopener ugc nofollow" target="_blank"> Sshuttle </a>使用一个SSH连接来创建一个隧道代理，其行为就像一个新的接口。简而言之，它模拟了一个VPN，允许我们通过代理路由我们的流量，而不需要使用代理链(或等效物)。我们可以直接连接到目标网络中的设备，就像我们通常连接到联网设备一样。因为它通过SSH(安全外壳)创建了一个隧道，所以我们通过隧道发送的任何东西都是加密的，这是一个很好的好处。我们完全在攻击机器上使用sshuttle，就像SSH进入远程服务器一样。</p><p id="ace0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">注意:sshuttle仅适用于Linux目标。它还需要通过SSH访问被入侵的服务器，并且还需要在服务器上安装Python。</strong></p><p id="26d1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">不幸的是，sshuttle目前似乎没有一种简写方式来指定用于向服务器进行身份验证的私钥。也就是说，我们可以使用<code class="fe ng nh ni mp b">--ssh-cmd</code>开关轻松绕过这个限制。使用基于密钥的身份验证时，最终的命令如下所示:</p><pre class="me mf mg mh gt mo mp mq mr aw ms bi"><span id="f56a" class="mt lb iq mp b gy mu mv l mw mx"><strong class="mp ir">sshuttle -r root@10.200.81.200 --ssh-cmd "ssh -i id_rsa" 10.200.81.0/24</strong></span><span id="db05" class="mt lb iq mp b gy nj mv l mw mx">[local sudo] Password: <br/>c : Connected to server.<br/>Failed to flush caches: Unit dbus-org.freedesktop.resolve1.service not found.<br/>fw: Received non-zero return code 1 when flushing DNS resolver cache.</span></pre><p id="330c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们现在可以使用命令，例如NMAP，就像正常情况下没有代理链一样:</p><pre class="me mf mg mh gt mo mp mq mr aw ms bi"><span id="a120" class="mt lb iq mp b gy mu mv l mw mx"><strong class="mp ir">nmap -v -sV -sC -p 80 10.200.81.150</strong></span><span id="ac13" class="mt lb iq mp b gy nj mv l mw mx">PORT   STATE SERVICE VERSION<br/>80/tcp open  http    Apache httpd 2.2.22 ((Win32) mod_ssl/2.2.22 OpenSSL/0.9.8u mod_wsgi/3.3 Python/2.7.2 PHP/5.4.3)<br/>|_http-server-header: Apache/2.2.22 (Win32) mod_ssl/2.2.22 OpenSSL/0.9.8u mod_wsgi/3.3 Python/2.7.2 PHP/5.4.3<br/>|_http-title: Page not found at /</span></pre><p id="06d3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们也可以像平常一样访问网页，无需通过其他端口。</p><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nc nd di ne bf nf"><div class="gh gi nk"><img src="../Images/a882aef95600733effed1d154b231d23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZDQ2ir_V1d7RmjhdzqyKgA.png"/></div></div><figcaption class="mi mj gj gh gi mk ml bd b be z dk translated">使用sshuttle访问10.200.81.150端口80上托管的网页。</figcaption></figure></div><div class="ab cl kt ku hu kv" role="separator"><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky"/></div><div class="ij ik il im in"><h1 id="0e35" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">凿子</h1><p id="105e" class="pw-post-body-paragraph ju jv iq jw b jx ly jz ka kb lz kd ke kf ma kh ki kj mb kl km kn mc kp kq kr ij bi translated">前两种转换技术依赖于我们对作为转换点的受损主机的SSH访问。<a class="ae ks" href="https://github.com/jpillora/chisel" rel="noopener ugc nofollow" target="_blank"> Chisel </a>是一款工具，无论您是否拥有SSH访问权限，它都可以用来快速、轻松地通过受损系统建立隧道代理或端口转发。不利的一面是，您必须在攻击机器和受损服务器上都有chisel二进制文件的适当副本。chisel二进制有两种模式:<strong class="jw ir">客户端</strong>和<strong class="jw ir">服务器</strong>。</p><p id="e6bf" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">要创建一个反向socks代理，它从一个受损的服务器连接到一个在攻击机器上等待的监听器，我们可以执行以下步骤:</p><p id="4790" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在我们自己的攻击机器上，在我们选择的端口上设置一个监听器:</p><pre class="me mf mg mh gt mo mp mq mr aw ms bi"><span id="682d" class="mt lb iq mp b gy mu mv l mw mx">./chisel server -p 30000 --reverse</span></pre><p id="734b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在受损主机(即外部web服务器)上，我们将使用以下命令连接回我们攻击机器上的等待监听器，完成代理:</p><pre class="me mf mg mh gt mo mp mq mr aw ms bi"><span id="bfae" class="mt lb iq mp b gy mu mv l mw mx">./chisel client 10.10.101.50:30000 R:1080:socks</span></pre><p id="59f2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这将创建一个反向代理，并在我们的机器上打开端口1080。现在我们可以修改我们的<code class="fe ng nh ni mp b">proxychains.conf</code>文件来使用这个代理。在<code class="fe ng nh ni mp b">/etc/proxychains.conf</code>的底部添加<code class="fe ng nh ni mp b">socks5 127.0.0.1 1080</code>(注意:凿子使用一个SOCKS5代理)。</p></div><div class="ab cl kt ku hu kv" role="separator"><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky"/></div><div class="ij ik il im in"><h1 id="7e34" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">结论</h1><p id="3d7d" class="pw-post-body-paragraph ju jv iq jw b jx ly jz ka kb lz kd ke kf ma kh ki kj mb kl km kn mc kp kq kr ij bi translated">希望这篇关于旋转的短文有助于提供关于旋转是什么以及如何工作的基本概述。还有各种其他工具可以使用，如Meterpreter端口转发/代理、Socat、Plink.exe等。我会向任何想练习旋转技巧的人推荐THM花环网。旋转是一个很大的话题，值得了解更多，尤其是如果你对渗透测试感兴趣的话。谢谢你看完，继续黑！😄</p></div><div class="ab cl kt ku hu kv" role="separator"><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky"/></div><div class="ij ik il im in"><p id="be5a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">来自Infosec的报道:Infosec上每天都会出现很多难以跟上的内容。加入我们的每周简讯，以5篇文章、4个线程、3个视频、2个Github Repos和工具以及1个工作提醒的形式免费获取所有最新的Infosec趋势！<a class="ae ks" href="https://weekly.infosecwriteups.com/" rel="noopener ugc nofollow" target="_blank"><em class="nl"/></a></p></div></div>    
</body>
</html>