<html>
<head>
<title>How Capabilities actually Work ? | Exploitation | Privilege Escalation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">能力实际上是如何工作的？|利用|权限提升</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/how-capabilities-actually-work-exploitation-privilege-escalation-536afee917ad?source=collection_archive---------7-----------------------#2022-12-20">https://infosecwriteups.com/how-capabilities-actually-work-exploitation-privilege-escalation-536afee917ad?source=collection_archive---------7-----------------------#2022-12-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/86a4301ee1079fd5589fb511da1c45a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gW92rmWTGvdic9AkuWZO1A.png"/></div></div></figure><h1 id="da0e" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">SUID:传统的Linux方式</h1><p id="fe40" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">有时，低权限用户需要使用较高权限执行特定任务，为此，Linux提供了在特定二进制文件上设置SUID位的功能。</p><p id="17f6" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">SUID(设置用户ID)位是一种特殊的权限，可以在Linux操作系统中的可执行文件上设置。这允许非特权用户以文件所有者的权限运行程序。</p><p id="6b34" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">例如，如果一个非根用户想要执行一个设置了根用户的<strong class="ky ir">的SUID位的程序，他/她将在整个程序执行过程中被给予根权限。</strong></p><h1 id="5ae3" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">为什么是能力？</h1><p id="0fc5" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">SUID运行良好，但是它有很高的安全风险，因为它将完全权限授予非root用户，即使只要求使用root权限执行某些操作。</p><blockquote class="lz ma mb"><p id="7779" class="kw kx mc ky b kz lu lb lc ld lv lf lg md lw lj lk me lx ln lo mf ly lr ls lt ij bi translated">攻击者利用SUID位在系统上执行权限提升。</p></blockquote><p id="b51a" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">这就是<strong class="ky ir">功能</strong>的用武之地，功能还允许用户以根用户的权限运行某些可执行文件。但它更安全，<strong class="ky ir">如何？</strong>功能并不提供全部权限，而是将特权和权限划分为更小、更具体的单元或线程，可以有选择地启用或禁用。</p><blockquote class="lz ma mb"><p id="ccf2" class="kw kx mc ky b kz lu lb lc ld lv lf lg md lw lj lk me lx ln lo mf ly lr ls lt ij bi translated"><strong class="ky ir">注意:</strong>权能授予进程而不是用户特权。</p></blockquote><p id="38dd" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">每种功能都对应于特定的权限或特权，例如绑定到网络端口的功能、更改系统时间的功能或向其他进程发送信号的功能。</p><pre class="mg mh mi mj gt mk ml mm bn mn mo bi"><span id="9db2" class="mp jz iq ml b be mq mr l ms mt"><strong class="ml ir">Some Linux Capabilities and their functions are:-</strong><br/><br/>CAP_DAC_OVERRIDE: The ability to override file permissions.<br/><br/>CAP_DAC_READ_SEARCH: The ability to read and search directories and files that<br/>the process does not have permission to access.<br/><br/>CAP_KILL: The ability to send signals to other processes.<br/><br/>CAP_NET_BIND_SERVICE: The ability to bind to a network port below 1024.<br/><br/>CAP_SYS_BOOT: The ability to reboot the system.<br/><br/>CAP_CHOWN: The ability to change the owner and group of a file.</span></pre><p id="f6a2" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">点击此处阅读更多内容..</p><div class="mu mv gp gr mw mx"><a href="https://man7.org/linux/man-pages/man7/capabilities.7.html" rel="noopener  ugc nofollow" target="_blank"><div class="my ab fo"><div class="mz ab na cl cj nb"><h2 class="bd ir gy z fp nc fr fs nd fu fw ip bi translated">功能(7) - Linux手册页</h2><div class="ne l"><h3 class="bd b gy z fp nc fr fs nd fu fw dk translated">功能(7) Linux程序员手册功能(7)功能-概述Linux的功能…</h3></div><div class="nf l"><p class="bd b dl z fp nc fr fs nd fu fw dk translated">man7.org</p></div></div><div class="ng l"><div class="nh l ni nj nk ng nl jw mx"/></div></div></a></div><h1 id="2952" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">在Linux内核内部</h1><p id="d469" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">功能作为<strong class="ky ir">位掩码</strong>存储在<strong class="ky ir"> /proc </strong>文件系统中的一个单独文件中。对于每个进程，位掩码是一个数据结构，它将一组标志或选项表示为单个值中的单个位。位掩码中的每个位对应一个特定的功能，位的值(0或1)表示该功能是启用还是禁用。</p><p id="34f4" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">可以使用setcap命令和capsh命令对它们进行操作。当一个进程发出一个需要特定能力的系统调用时，内核会检查该进程的能力，看是否授予了必要的权限。如果权限未被授予，系统调用将被拒绝，并且进程会得到一个错误代码。</p><ol class=""><li id="aaae" class="nm nn iq ky b kz lu ld lv lh no ll np lp nq lt nr ns nt nu bi translated"><strong class="ky ir">允许的能力</strong>:这些是一个进程被允许拥有的特权，不管它当前是否正在使用这些特权执行。</li><li id="4362" class="nm nn iq ky b kz nv ld nw lh nx ll ny lp nz lt nr ns nt nu bi translated"><strong class="ky ir">有效功能:</strong>这些功能由Linux内核检查，看它是否有效。这些是进程当前正在执行的特权。一个进程只有在被允许并且有效的情况下才能行使特权。</li></ol><h2 id="2c13" class="oa jz iq bd ka ob oc dn ke od oe dp ki lh of og km ll oh oi kq lp oj ok ku ol bi translated">示例:</h2><p id="94de" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">这两者就像编程中的函数，首先编译器检查一个函数是否存在，如果存在，那么它将执行那个函数。这里的编译器是Linux内核，允许的能力是被声明的函数，有效的能力是被执行的函数。希望这能让你对它的工作原理有所了解。</p><p id="f242" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated"><code class="fe om on oo ml b">setcap</code>命令将功能名称和值作为参数，并相应地更新进程位掩码中的相应位。</p><pre class="mg mh mi mj gt mk ml mm bn mn mo bi"><span id="ad23" class="mp jz iq ml b be mq mr l op mt">setcap cap_chown=+ep myprogram</span></pre><p id="b89d" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">上述命令将<code class="fe om on oo ml b">myprogram</code>进程的位掩码中的<code class="fe om on oo ml b">CAP_CHOWN</code>位设置为1，表示该功能已启用。请注意文件名前的+号，如果是负(-)号，则表示该功能被禁用。</p><div class="mu mv gp gr mw mx"><a href="https://tryhackme.com/room/linprivesc" rel="noopener  ugc nofollow" target="_blank"><div class="my ab fo"><div class="mz ab na cl cj nb"><h2 class="bd ir gy z fp nc fr fs nd fu fw ip bi translated">TryHackMe | Linux权限提升</h2><div class="ne l"><h3 class="bd b gy z fp nc fr fs nd fu fw dk translated">了解Linux权限提升的基础知识。从列举到利用，获得超过8…</h3></div><div class="nf l"><p class="bd b dl z fp nc fr fs nd fu fw dk translated">tryhackme.com</p></div></div><div class="ng l"><div class="oq l ni nj nk ng nl jw mx"/></div></div></a></div><h1 id="0f58" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated"><strong class="ak">黑客思维:如何被利用？</strong></h1><p id="07ff" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">在目标机器中，我们可以看到使用<strong class="ky ir"> getcap </strong>命令启用的功能。当以非特权用户的身份运行时，<code class="fe om on oo ml b">getcap -r /</code>将生成大量的错误，因此将错误消息重定向到/dev/null是一个很好的做法。</p><blockquote class="lz ma mb"><p id="73d3" class="kw kx mc ky b kz lu lb lc ld lv lf lg md lw lj lk me lx ln lo mf ly lr ls lt ij bi translated"><strong class="ky ir"> cap_setuid </strong>如果不小心使用，功能可能会很危险，因为它允许进程更改进程的有效用户id和组ID，这可能会导致权限提升。</p></blockquote><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div class="gh gi or"><img src="../Images/35a6f101bd799b00d9d63ed4f1c81a01.png" data-original-src="https://miro.medium.com/v2/resize:fit:860/format:webp/1*eZlyotpCsMWZQv2oMcIciQ.png"/></div></figure><p id="727e" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">命令:<code class="fe om on oo ml b"> getcap -r / 2&gt;/dev/null</code></p><p id="19e8" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">有一个启用了<strong class="ky ir"> cap_setuid+ep </strong>的python二进制文件，这个<strong class="ky ir"> </strong>允许一个程序获得setuid(执行时设置用户id)和有效(ep)权限，这些权限需要以文件所有者的权限来执行，而不是执行它的用户的权限。</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi os"><img src="../Images/f8133ca93dbf167a691cd396489571d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EQMf-Ryfq1NVjTg3i-s-5Q.png"/></div></div></figure><p id="3a63" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">旁路:<code class="fe om on oo ml b">/usr/bin/python2.6 -c ‘import os; os.setuid(0); os.system(“/bin/bash”)’</code></p><p id="d1df" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">这可以通过添加一段代码并告诉python导入OS并生成一个<strong class="ky ir"> /bin/bash </strong> shell来轻松利用。因为它是以根用户的权限执行的，所以它将生成一个具有根用户权限的shell。</p><p id="e401" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">查看更多设置了该功能的二进制文件。</p><div class="mu mv gp gr mw mx"><a href="https://gtfobins.github.io/#+capabilities" rel="noopener  ugc nofollow" target="_blank"><div class="my ab fo"><div class="mz ab na cl cj nb"><h2 class="bd ir gy z fp nc fr fs nd fu fw ip bi translated">GTFOBins</h2><div class="ne l"><h3 class="bd b gy z fp nc fr fs nd fu fw dk translated">GTFOBins是Unix二进制文件的精选列表，可用于在错误配置的环境中绕过本地安全限制…</h3></div><div class="nf l"><p class="bd b dl z fp nc fr fs nd fu fw dk translated">gtfobins.github.io</p></div></div><div class="ng l"><div class="ot l ni nj nk ng nl jw mx"/></div></div></a></div><p id="d6c6" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">感谢您的阅读。</p></div><div class="ab cl ou ov hu ow" role="separator"><span class="ox bw bk oy oz pa"/><span class="ox bw bk oy oz pa"/><span class="ox bw bk oy oz"/></div><div class="ij ik il im in"><h2 id="3fff" class="oa jz iq bd ka ob oc dn ke od oe dp ki lh of og km ll oh oi kq lp oj ok ku ol bi translated">来自Infosec的报道:Infosec每天都有很多内容，很难跟上。<a class="ae pb" href="https://weekly.infosecwriteups.com/" rel="noopener ugc nofollow" target="_blank">加入我们的每周简讯</a>以5篇文章、4条线索、3个视频、2个GitHub Repos和工具以及1个工作提醒的形式免费获取所有最新的Infosec趋势！</h2></div></div>    
</body>
</html>