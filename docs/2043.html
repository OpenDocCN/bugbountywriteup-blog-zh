<html>
<head>
<title>The ABCs of Kerberoasting</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kerberoasting认证的基础知识</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/the-abcs-of-kerberoasting-4b192e6a9fb4?source=collection_archive---------0-----------------------#2022-05-03">https://infosecwriteups.com/the-abcs-of-kerberoasting-4b192e6a9fb4?source=collection_archive---------0-----------------------#2022-05-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/d7c7611540cae7448a075289b363c8f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*qnhxgfd5CAtfeUpS"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated"><a class="ae kf" href="https://unsplash.com/@jay_zhang?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">张杰</a>在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><h1 id="79b0" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated"><strong class="ak">简介</strong></h1><p id="a8ab" class="pw-post-body-paragraph le lf it lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">Kerberos是一种计算机网络安全协议，它通过不可信网络(如internet)验证两个或多个可信主机之间的服务请求。Kerberos用于保护计算机网络。它对客户机-服务器应用程序进行身份验证，并通过使用密钥加密和可信任的第三方来验证用户的身份。它旨在促进两个目的，安全和认证。</p><p id="c848" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">它在Active Directory环境中用于向用户提供快速身份验证，使他们无需通过网络共享/传输密码即可访问资源。</p><p id="b920" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">成功利用后，kerberoasting是一种利用后策略，攻击者通过利用权限提升和其他横向移动技术，集中精力访问组织内部网络中托管的其他目标。当在最基本的级别使用Kerberos时，攻击者可以从内存中请求与服务相关的TGS票证，同时伪装成具有预定义SPN属性的非特权域用户，试图破解与特定服务帐户相关联的明文密码的NTLM哈希。</p><p id="941f" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">在这篇博文中，我们将通过一个演示来学习Kerberos和Kerberoasting，以便更好地掌握它。</p><h1 id="2a9b" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated"><strong class="ak"> Kerberos </strong></h1><figure class="mi mj mk ml gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mh"><img src="../Images/1d475e8190ece20fbcc40be0cc0816c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y6O4CCOp64dfYnpOqxpcyg.jpeg"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated"><a class="ae kf" href="https://www.manageengine.com/products/active-directory-audit/kb/windows-security-log-event-id-4768.html" rel="noopener ugc nofollow" target="_blank">来源</a></figcaption></figure><p id="9fb2" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">正如我们刚刚了解到的，Kerberos是一种身份验证协议。它通常用于Active Directory环境中。Kerberos背后的机制及其工作原理非常复杂，所以我们只是对其进行概述。</p><p id="754c" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">涉及三个实体。</p><ol class=""><li id="fdf6" class="mm mn it lg b lh mc ll md lp mo lt mp lx mq mb mr ms mt mu bi translated">需要访问资源(服务器)的客户端。这可能是一个FTP服务器等。</li><li id="6fd2" class="mm mn it lg b lh mv ll mw lp mx lt my lx mz mb mr ms mt mu bi translated">资源服务器。这是客户端需要访问的服务器。</li><li id="3179" class="mm mn it lg b lh mv ll mw lp mx lt my lx mz mb mr ms mt mu bi translated">关键配送中心(KDC)。这可以称为Kerberos的核心。这包含了两个有助于身份验证的主要实体。</li><li id="c875" class="mm mn it lg b lh mv ll mw lp mx lt my lx mz mb mr ms mt mu bi translated">认证服务器(AS)</li><li id="b478" class="mm mn it lg b lh mv ll mw lp mx lt my lx mz mb mr ms mt mu bi translated">票证生成服务器(TGS)</li></ol><p id="31f1" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">如果一个客户端需要访问一个特定的资源，比如一个FTP服务器，它必须首先访问认证服务器(as)。认证服务器向客户端提供票据授予票据(TGT ),它可以使用该票据授予票据与票据生成服务器(TGS)进行通信。一旦用户和服务器相互验证，TGT文件可以提供安全的数据安全性。一旦通过身份验证并收到TGT (TGS)，用户就可以使用他们的TGT向票证授予服务请求服务票证。然后，他们可以访问受保护的资源。</p><p id="2d59" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">TGT文件被加密以防止中间人(MITM)攻击。它们还包含诸如会话密钥(及其到期日期)和用户的IP地址等信息。</p><p id="61b9" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">然后，TGS服务器将发出一个名为TGS票证的令牌，客户端将使用它来通信和访问FTP服务器的资源。</p><p id="6199" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">在任何时候，我们都不需要提交凭据。如果深入研究，您会发现我们的密码和资源服务器的密码的散列是用来加密发出的请求的。</p><h1 id="eb4e" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated"><strong class="ak">Kerberos认证</strong></h1><p id="89a2" class="pw-post-body-paragraph le lf it lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">对于Active Directory服务帐户凭据，kerberoasting是一种常用的攻击策略。事实上，Kerberoasting认证可以由域中的任何用户执行，而不仅仅是管理员，这使得它成为高级和低级攻击者的最爱。此外，它是一种“离线”攻击，这意味着它不需要向目标服务传输任何数据包，否则会导致流量被记录并可能触发警报。另一方面，虽然Kerberos认证利用了针对Active Directory的Kerberos身份验证中的已知漏洞，但它也在类似程度上利用了人性。Kerberoasting认证是一种密码破解攻击，它从内存中获取凭证，然后离线破解。</p><p id="be28" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">Kerberoasting认证的好处:</p><ol class=""><li id="2c64" class="mm mn it lg b lh mc ll md lp mo lt mp lx mq mb mr ms mt mu bi translated">不会专门发出/发送额外的数据包。</li><li id="81ba" class="mm mn it lg b lh mv ll mw lp mx lt my lx mz mb mr ms mt mu bi translated">这确保了我们的尝试不会发出任何警报或警告。</li><li id="85aa" class="mm mn it lg b lh mv ll mw lp mx lt my lx mz mb mr ms mt mu bi translated">不需要任何特权。所有你需要的是进入一个领域帐户。</li><li id="2bdf" class="mm mn it lg b lh mv ll mw lp mx lt my lx mz mb mr ms mt mu bi translated">它通常用于权限提升和横向网络移动。</li></ol><h1 id="6d1e" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated"><strong class="ak">背景</strong></h1><p id="7b7d" class="pw-post-body-paragraph le lf it lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated"><strong class="lg iu"> TGS </strong>门票是访问各种域名资源的钥匙。这些TGS票证是由服务帐户的(NTML)哈希加密的，资源服务器使用该服务帐户的权限进行操作。因此，在得到TGS门票并破解它，我们将获得一个服务帐户的密码。我们可以用它来喷射其他用户帐户，或者从服务帐户本身过滤信息。</p><p id="99fa" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated"><strong class="lg iu">发红</strong></p><p id="109e" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">Rubeus是攻击Kerberos的强大工具。使用Rubeus可以完成许多攻击，尤其是在Active Directory环境中。</p><p id="8567" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">一些可能的攻击包括获取、Kerberos认证、AS-REP烘烤、票据提取、票据请求和更新等。</p><p id="d566" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">要执行Kerberos认证攻击，只需从GitHub库下载Rubeus.exe文件，可以在这里找到<a class="ae kf" href="https://github.com/GhostPack/Rubeus" rel="noopener ugc nofollow" target="_blank"/>。将其上传到您的受害者主机，然后键入以下内容</p><pre class="mi mj mk ml gt na nb nc nd aw ne bi"><span id="a766" class="nf kh it nb b gy ng nh l ni nj">.\Rubeus.exe kerberoast</span></pre><figure class="mi mj mk ml gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nk"><img src="../Images/ba2a2bab98e7e6b64103c0acb33ce7d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bpcgjdUWh2XWoTsZx9uW7Q.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">使用Rubeus进行Kerberos认证</figcaption></figure><p id="b2c6" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">使用impacket工具也可以达到同样的效果。你可以在这里从<a class="ae kf" href="https://github.com/SecureAuthCorp/impacket/releases/tag/impacket_0_9_19" rel="noopener ugc nofollow" target="_blank">下载这个包。</a></p><p id="c9a7" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">我们需要的是用户名、密码、域名和域控制器的IP地址。</p><p id="b9c4" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">要通过impacket执行Kerberos认证，只需从刚刚克隆的存储库中切换到impacket目录。</p><pre class="mi mj mk ml gt na nb nc nd aw ne bi"><span id="10fc" class="nf kh it nb b gy ng nh l ni nj"><strong class="nb iu">python3</strong> <strong class="nb iu">GetUserSPNs.py </strong>mydomaincontroller.local/Alice:SupserSecure123 –dc-ip 10.10.10.10 -request</span></pre><p id="0c7c" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">这里，</p><p id="fa33" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated"><em class="nl"> mydomaincontroller.local </em>是域控制器的名称</p><p id="7d29" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">Alice是用户名，SupseSecure是密码</p><p id="c0aa" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated"><em class="nl"> 10.10.10.10 </em>是域控制器的IP</p><p id="538d" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">一旦下载了散列，就可以使用<strong class="lg iu"> hashcat </strong>来破解它们。破解这种哈希的方式是<strong class="lg iu"> 13100 </strong>。你需要一份可以从网上下载的密码列表。</p><pre class="mi mj mk ml gt na nb nc nd aw ne bi"><span id="94c1" class="nf kh it nb b gy ng nh l ni nj">hashcat -m 13100 Password_hashes.txt samplePasswordlist.txt</span></pre><h1 id="7944" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated"><strong class="ak">结论</strong></h1><p id="a0da" class="pw-post-body-paragraph le lf it lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">在这篇博客文章中，我们探讨了一种后利用策略，这种策略被红队和攻击者广泛用来获得对系统的控制。我们大致了解了Kerberos，并通过演示了解了什么是Kerberos。这是一种利用技术，通常用于控制计算机系统和广告。</p></div></div>    
</body>
</html>