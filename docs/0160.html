<html>
<head>
<title>TokyoWesterns CTF 4th 2018 Writeup — Part 3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">东京西部4th 2018年第4期报道—第3部分</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/tokyowesterns-ctf-4th-2018-writeup-part-3-1c8510dfad3f?source=collection_archive---------0-----------------------#2018-09-08">https://infosecwriteups.com/tokyowesterns-ctf-4th-2018-writeup-part-3-1c8510dfad3f?source=collection_archive---------0-----------------------#2018-09-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="5724" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">世界协调时+2时间2018年06月09日下午20:32</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/9bd7b9675d51f251ff69b4c4717bb63e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2zTq651YHNhfIBjQDOHpwg.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">东京西部4th 2018年第4期报道—第3部分</figcaption></figure><p id="c68d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">显然，在这篇博客中我将谈到一个重要的漏洞；<strong class="jp ir">服务器端模板注入(SSTI) </strong>我建议你也阅读这篇文章来理解它。</p><div class="lb lc gp gr ld le"><a href="https://portswigger.net/blog/server-side-template-injection" rel="noopener  ugc nofollow" target="_blank"><div class="lf ab fo"><div class="lg ab lh cl cj li"><h2 class="bd ir gy z fp lj fr fs lk fu fw ip bi translated">服务器端模板注入</h2><div class="ll l"><h3 class="bd b gy z fp lj fr fs lk fu fw dk translated">web应用程序广泛使用模板引擎来通过网页和电子邮件呈现动态数据。不安全…</h3></div><div class="lm l"><p class="bd b dl z fp lj fr fs lk fu fw dk translated">portswigger.net</p></div></div><div class="ln l"><div class="lo l lp lq lr ln ls kv le"/></div></div></a></div><h1 id="3c7c" class="lt lu iq bd lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">神龛—193页</h1><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mr"><img src="../Images/c799c42089fef241dea95e57fb9d569a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nPEJW3pnooOSLQ6qSbCJVw.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">圣地</figcaption></figure><blockquote class="ms mt mu"><p id="5074" class="jn jo mv jp b jq jr js jt ju jv jw jx mw jz ka kb mx kd ke kf my kh ki kj kk ij bi translated"><strong class="jp ir">挑战:</strong> <a class="ae mz" href="http://shrine.chal.ctf.westerns.tokyo/" rel="noopener ugc nofollow" target="_blank">神社</a></p></blockquote><p id="88f5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">世界协调时+2日上午05/09:06</p><p id="4163" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当我逆转<a class="ae mz" href="https://github.com/Abdelkad3r/CTF/tree/master/TokyoWesterns%20CTF%204th%202018/reversing/dec%20dec%20dec" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir"> dec dec dec </strong> </a>挑战时，我的队友分享了一个叫做<em class="mv">神殿</em>的挑战的python脚本，告诉我们他正在进行这个挑战。貌似这是后端用python创建的web应用的<a class="ae mz" href="https://github.com/Abdelkad3r/CTF/blob/master/TokyoWesterns%20CTF%204th%202018/web/shrine/app.py" rel="noopener ugc nofollow" target="_blank"> <em class="mv"> app.py </em> </a>。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi na"><img src="../Images/26dfc5ca6a3bb46b2c8e59b4bac49075.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZuAmaf4ns9bz8HM3o3nrUQ.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">圣地挑战— app.py</figcaption></figure><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="feab" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我查的比较快，注意到这个应用是基于Python <a class="ae mz" href="http://flask.pocoo.org/" rel="noopener ugc nofollow" target="_blank"> Flask </a>框架，我首先想到的是<a class="ae mz" href="https://nvisium.com/resources/blog/2015/12/07/injecting-flask.html" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir">服务器端模板注入(SSTI)漏洞</strong> </a>。</p><p id="6598" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如你在上面的<em class="mv"> app.py </em>中看到的；有两个滤镜的<em class="mv"> safe_jinja </em>功能。我们必须绕过它才能在<a class="ae mz" href="http://flask.pocoo.org/docs/0.12/api/#flask.config" rel="noopener ugc nofollow" target="_blank"><em class="mv">config</em></a><em class="mv"/>或<em class="mv"/><a class="ae mz" href="http://flask.pocoo.org/docs/0.12/api/#flask" rel="noopener ugc nofollow" target="_blank"><em class="mv">self</em></a><em class="mv"/>中获得两个黑名单文件。带有两个过滤符号<em class="mv">“(</em>和<em class="mv">”)。</em></p><p id="100e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以作为我们任务的总结就是我们必须分两步绕过:<em class="mv"> "()" </em>和黑名单<a class="ae mz" href="http://flask.pocoo.org/docs/0.12/api/#flask.config" rel="noopener ugc nofollow" target="_blank"> <em class="mv"> config </em> </a>和<a class="ae mz" href="http://flask.pocoo.org/docs/0.12/api/#flask" rel="noopener ugc nofollow" target="_blank"> <em class="mv"> self </em> </a> <em class="mv"> </em>以便最后进入<a class="ae mz" href="http://flask.pocoo.org/docs/0.12/api/#flask.config" rel="noopener ugc nofollow" target="_blank"> <em class="mv"> config </em> </a>或<a class="ae mz" href="http://flask.pocoo.org/docs/0.12/api/#flask" rel="noopener ugc nofollow" target="_blank"><em class="mv">self</em></a>self。</p><p id="9fe6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">事实上，我解决了一系列类似的挑战，并且有相同的背景，我写了一篇关于类似任务的精彩而丰富的文章，但没有经过过滤的<em class="mv">配置</em>或<a class="ae mz" href="http://flask.pocoo.org/docs/0.12/api/#flask" rel="noopener ugc nofollow" target="_blank"> <em class="mv">自我</em> </a>，<em class="mv"> </em>将在<em class="mv"/><a class="ae mz" href="https://medium.com/bugbountywriteup/angstromctf-2018-web-writeups-part-2-6c1ee586aa64" rel="noopener"><strong class="jp ir">AngstromCTF 2018网络文章-第2部分</strong> </a> <strong class="jp ir">中找到。</strong></p><p id="4110" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们遵循高层次的方法来捕获一个高效的攻击过程，然后将其应用到这次<strong class="jp ir"> SSTI </strong>攻击中！</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/101fdac2fc548cde2bff1aa918427275.png" data-original-src="https://miro.medium.com/v2/resize:fit:1160/format:webp/1*InDcv-1fGZ3NxxebTCns2Q.png"/></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">捕捉高效攻击过程的高级方法</figcaption></figure><h2 id="3d33" class="ne lu iq bd lv nf ng dn lz nh ni dp md jy nj nk mh kc nl nm ml kg nn no mp np bi translated">1.发现</h2><p id="6239" class="pw-post-body-paragraph jn jo iq jp b jq nq js jt ju nr jw jx jy ns ka kb kc nt ke kf kg nu ki kj kk ij bi translated">正如你在上面的<em class="mv"> app.py </em>中看到的；有一条有趣的路线:</p><pre class="km kn ko kp gt nv nw nx ny aw nz bi"><span id="adc8" class="ne lu iq nw b gy oa ob l oc od"><a class="ae mz" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.route('/shrine/<strong class="nw ir">&lt;path:shrine&gt;</strong>')</span></pre><p id="145c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们跟随它:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi oe"><img src="../Images/bb6ac56264f4dabdee58e2293d7a0f2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tnYVS8E5ATkSW4pdf1DmHw.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">未发现</figcaption></figure><p id="43e6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们通过在<strong class="jp ir"> &lt; path:shrine &gt; </strong>中注入<strong class="jp ir"> {{9*9}} </strong>来尝试检测<strong class="jp ir"> SSTI </strong>漏洞:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi of"><img src="../Images/981bfb2e4fd1646c6b1ad0f88819053e.png" data-original-src="https://miro.medium.com/v2/resize:fit:982/format:webp/1*_WLEuHZDMxnsqMaSxpSiGA.png"/></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">SSTI被发现了</figcaption></figure><p id="d15b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">耶…正如你所看到的，我得到了<strong class="jp ir"> 81 </strong>的结果，所以它被服务器执行，并最终使错误出来！</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi og"><img src="../Images/906f49c087ca65eb1258e422886eae80.png" data-original-src="https://miro.medium.com/v2/resize:fit:1214/format:webp/1*TZuFNvBJ89IyMeIaSkEeWQ.png"/></div></figure><p id="2aa1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">与此同时，<strong class="jp ir"><em class="mv"/></strong><a class="ae mz" href="https://nvisium.com/resources/blog/2015/12/07/injecting-flask.html" rel="noopener ugc nofollow" target="_blank"><strong class="jp ir"><em class="mv">服务器端烧瓶模板注入(SSTI)漏洞</em></strong></a><strong class="jp ir"><em class="mv"/></strong>已被检测到。</p><h2 id="551d" class="ne lu iq bd lv nf ng dn lz nh ni dp md jy nj nk mh kc nl nm ml kg nn no mp np bi translated">2.识别</h2><p id="ae6a" class="pw-post-body-paragraph jn jo iq jp b jq nq js jt ju nr jw jx jy ns ka kb kc nt ke kf kg nu ki kj kk ij bi translated">如上图<a class="ae mz" href="https://github.com/Abdelkad3r/CTF/blob/master/TokyoWesterns%20CTF%204th%202018/web/shrine/app.py" rel="noopener ugc nofollow" target="_blank"> <em class="mv"> app.py </em> </a>所示；这个模板引擎就是<a class="ae mz" href="http://jinja.pocoo.org/docs/2.10/" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir"> Jinja2 </strong> </a>。</p><p id="b03e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">与此同时，<a class="ae mz" href="https://nvisium.com/resources/blog/2015/12/07/injecting-flask.html" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir"> <em class="mv">服务器端Flask Jinja2模板注入(SSTI)漏洞</em> </strong> </a> <strong class="jp ir"> <em class="mv"> </em> </strong>已经确定。</p><h2 id="1723" class="ne lu iq bd lv nf ng dn lz nh ni dp md jy nj nk mh kc nl nm ml kg nn no mp np bi translated">3.剥削</h2><p id="8ecd" class="pw-post-body-paragraph jn jo iq jp b jq nq js jt ju nr jw jx jy ns ka kb kc nt ke kf kg nu ki kj kk ij bi translated">我的利用是基于这个:</p><div class="lb lc gp gr ld le"><a href="https://nvisium.com/resources/blog/2016/03/11/exploring-ssti-in-flask-jinja2-part-ii.html" rel="noopener  ugc nofollow" target="_blank"><div class="lf ab fo"><div class="lg ab lh cl cj li"><h2 class="bd ir gy z fp lj fr fs lk fu fw ip bi translated">探索烧瓶中的SSTI/jinja 2，第二部分</h2><div class="ll l"><h3 class="bd b gy z fp lj fr fs lk fu fw dk translated">我最近写了一篇关于探索服务器端模板注入(SSTI)在应用程序中的真正影响的文章…</h3></div><div class="lm l"><p class="bd b dl z fp lj fr fs lk fu fw dk translated">nvisium.com</p></div></div><div class="ln l"><div class="oh l lp lq lr ln ls kv le"/></div></div></a></div><p id="000d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你尝试直接进入<a class="ae mz" href="http://flask.pocoo.org/docs/0.12/api/#flask.config" rel="noopener ugc nofollow" target="_blank"> <em class="mv">配置</em> </a>或<a class="ae mz" href="http://flask.pocoo.org/docs/0.12/api/#flask" rel="noopener ugc nofollow" target="_blank"> <em class="mv">自我</em> </a>将不会发现任何有趣的东西，因为这些都被列入了黑名单。</p><pre class="km kn ko kp gt nv nw nx ny aw nz bi"><span id="5902" class="ne lu iq nw b gy oa ob l oc od"><a class="ae mz" href="http://shrine.chal.ctf.westerns.tokyo/shrine/" rel="noopener ugc nofollow" target="_blank">http://shrine.chal.ctf.westerns.tokyo/shrine/</a><strong class="nw ir">{{config}}</strong></span></pre><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi oi"><img src="../Images/39024c00a81f8bb4a992e5313d06d9a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fe_MAxJSJtMpNq6LQcW47w.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">配置为无(列入黑名单)</figcaption></figure><pre class="km kn ko kp gt nv nw nx ny aw nz bi"><span id="505a" class="ne lu iq nw b gy oa ob l oc od"><a class="ae mz" href="http://shrine.chal.ctf.westerns.tokyo/shrine/" rel="noopener ugc nofollow" target="_blank">http://shrine.chal.ctf.westerns.tokyo/shrine/</a><strong class="nw ir">{{self}}</strong></span></pre><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi oj"><img src="../Images/e9ad2f0d1b5f34666f4a6dd87e20104a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r1iEyAuXmWnvqfFc53WJ8Q.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">自己是无(黑名单)</figcaption></figure><p id="33ce" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">更多信息也请阅读:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="ok nc l"/></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">SSTI:现代网络应用的RCE</figcaption></figure><p id="7482" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以想法是通过使用另一种方法在<a class="ae mz" href="http://flask.pocoo.org/docs/0.12/api/#flask.config" rel="noopener ugc nofollow" target="_blank"> <em class="mv"> config </em> </a>或<a class="ae mz" href="http://flask.pocoo.org/docs/0.12/api/#flask" rel="noopener ugc nofollow" target="_blank"> <em class="mv"> self </em> </a>中得到，以便绕过它作为黑名单函数。我想到的第一件事是使用子类和属性，直到在<a class="ae mz" href="http://flask.pocoo.org/docs/0.12/api/#flask.config" rel="noopener ugc nofollow" target="_blank"> <em class="mv"> config </em> </a>中得到，而要做到这一点，我必须列出函数和属性。过了一会儿，我的朋友发现了一个有趣的功能:</p><pre class="km kn ko kp gt nv nw nx ny aw nz bi"><span id="34d3" class="ne lu iq nw b gy oa ob l oc od"><a class="ae mz" href="http://shrine.chal.ctf.westerns.tokyo/shrine/" rel="noopener ugc nofollow" target="_blank">http://shrine.chal.ctf.westerns.tokyo/shrine/</a><strong class="nw ir">{{request.environ}}</strong></span></pre><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ol"><img src="../Images/6ba8dfc99ce15be38bd776ea9c992c34.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VZj5d3j2h_Mh87WXCc854w.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">请求环境</figcaption></figure><p id="a337" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是没什么有趣的可以帮忙的。我试图通过搜索新的子类来发现一些新的东西，然后我发现在这个目录中使用有限的字节来注入，并且有可能注入html标签。注入了一些html标签，XSS终于完成了！</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi om"><img src="../Images/86c4bd6f5bfa1e1a47d1ebda087b12e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1344/format:webp/1*-5DYfxSXacVQ75y9NbYNgQ.png"/></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">XSS</figcaption></figure><p id="4c07" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我利用这张<a class="ae mz" href="https://www.owasp.org/index.php/Cross-site_Scripting_(XSS)" rel="noopener ugc nofollow" target="_blank"> XSS </a>来展示我的照片，但这并不是这次挑战的目的，我这样做只是为了好玩。</p><p id="014b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里是<a class="ae mz" href="https://www.owasp.org/index.php/Cross-site_Scripting_(XSS)" rel="noopener ugc nofollow" target="_blank"> XSS </a>有效载荷，我注入得到<a class="ae mz" href="https://www.owasp.org/index.php/Cross-site_Scripting_(XSS)" rel="noopener ugc nofollow" target="_blank"> XSS </a>:</p><blockquote class="on"><p id="f69d" class="oo op iq bd oq or os ot ou ov ow kk dk translated"><strong class="ak">&lt;html&gt;&lt;img % 20 src = https://goo . GL/pcgz 59% 20 width = 100% % 60 hight = 100% % 20 on error = confirm&gt;&lt;/html&gt;</strong></p></blockquote><figure class="oy oz pa pb pc kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ox"><img src="../Images/975a2d0232fbf2edd8cefb6c3b2e3043.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wv39X9Nk8trH7UjI-wIUOA.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">XSS谈神社挑战</figcaption></figure><p id="8780" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我叫上我的队友<a class="ae mz" href="https://github.com/tnmch" rel="noopener ugc nofollow" target="_blank"> @tnmch </a>在他的图片上方注入这个模板，用好玩的XD来享受这个挑战！！</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi pd"><img src="../Images/aa1a6e633ebe434b623bcc97b9144de3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1360/format:webp/1*5_cCZgef33HPilGbj2PorA.png"/></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">向@tnmch问好</figcaption></figure><p id="d384" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们一起享受在我的图片上方注入这个有趣的^^模板吧！！</p><pre class="km kn ko kp gt nv nw nx ny aw nz bi"><span id="5570" class="ne lu iq nw b gy oa ob l oc od"><a class="ae mz" href="http://shrine.chal.ctf.westerns.tokyo/shrine/" rel="noopener ugc nofollow" target="_blank">http://shrine.chal.ctf.westerns.tokyo/shrine/</a><strong class="nw ir">%7B%7B'hello%20tnmch'~'%20'~191*7%7D%7D%3Chtml%3E%3Cimg%20src=https://goo.gl/PCGz59%20width=100%%60highth=100%%20onerror=confirm(String.fromCharCode(88,83,83))%3E%3C/html%3E</strong></span></pre><p id="270d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们回到对这个模板注入的开发上来。经过长时间的尝试，没有任何有趣的结果，我只是试图阅读所有的<a class="ae mz" href="http://flask.pocoo.org/" rel="noopener ugc nofollow" target="_blank">烧瓶</a>函数和对象，发现一个有趣的叫做<a class="ae mz" href="http://flask.pocoo.org/docs/0.12/api/#flask.url_for" rel="noopener ugc nofollow" target="_blank"> <em class="mv"> url_for() </em> </a> <em class="mv">。</em>顺便在模板中你可以访问到<a class="ae mz" href="http://flask.pocoo.org/docs/0.12/api/#flask.config" rel="noopener ugc nofollow" target="_blank"><em class="mv"/></a><em class="mv"/><a class="ae mz" href="http://flask.pocoo.org/docs/0.12/api/#flask.request" rel="noopener ugc nofollow" target="_blank"><em class="mv">请求</em></a><em class="mv"/><a class="ae mz" href="http://flask.pocoo.org/docs/0.12/api/#flask.session" rel="noopener ugc nofollow" target="_blank"><em class="mv">会话</em></a><em class="mv"/><em class="mv"/><a class="ae mz" href="http://flask.pocoo.org/docs/0.12/api/#flask.g" rel="noopener ugc nofollow" target="_blank"><em class="mv">g</em><em class="mv"/>对象，以及</a><a class="ae mz" href="http://flask.pocoo.org/docs/0.12/api/#flask.url_for" rel="noopener ugc nofollow" target="_blank"> <em class="mv"> url_for() </em></a></p><p id="485b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我用<a class="ae mz" href="https://docs.python.org/3/reference/datamodel.html" rel="noopener ugc nofollow" target="_blank"> <em class="mv"> __globals__ </em> </a>属性，一个一个地尝试，直到得到<a class="ae mz" href="http://flask.pocoo.org/docs/0.12/api/#flask.url_for" rel="noopener ugc nofollow" target="_blank"> <em class="mv"> url_for() </em> </a>函数的所有全局变量。</p><pre class="km kn ko kp gt nv nw nx ny aw nz bi"><span id="1fbf" class="ne lu iq nw b gy oa ob l oc od"><a class="ae mz" href="http://shrine.chal.ctf.westerns.tokyo/shrine/" rel="noopener ugc nofollow" target="_blank">http://shrine.chal.ctf.westerns.tokyo/shrine/</a><strong class="nw ir">{{url_for.__globals__}}</strong></span></pre><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ol"><img src="../Images/13341ae06643b4fb34b08d92c99beac9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3mFL07HzedsUxOjtLZM9FQ.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">url_for() 1的全局变量</figcaption></figure><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi pe"><img src="../Images/35d67f16bfd74995aa0565667013df05.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Nf_Y1H0AGAB7-a9edGF3WA.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">url_for() 2的全局变量</figcaption></figure><p id="bdd3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">(CTRL+F)ed <strong class="jp ir"> "Flask" </strong> word之后我刚发现一个有趣的变量叫做:<strong class="jp ir"/><a class="ae mz" href="http://flask.pocoo.org/docs/0.12/api/#flask.current_app" rel="noopener ugc nofollow" target="_blank"><em class="mv">current _ app</em></a><em class="mv">。</em></p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi pf"><img src="../Images/2285f6fc96d175563f544c562a5ce68a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xLbmdcF5fclgEQVMz-o5ww.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">找到当前应用程序1</figcaption></figure><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi pg"><img src="../Images/842e5f4cc20966e9133f49eb9c27deab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IpT4mwjEbZRQm6FPpyRd0w.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">找到当前应用程序2</figcaption></figure><p id="7e9f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们试着进入<a class="ae mz" href="http://flask.pocoo.org/docs/0.12/api/#flask.current_app" rel="noopener ugc nofollow" target="_blank"><em class="mv">current _ app</em></a><em class="mv">:</em></p><pre class="km kn ko kp gt nv nw nx ny aw nz bi"><span id="a299" class="ne lu iq nw b gy oa ob l oc od"><a class="ae mz" href="http://shrine.chal.ctf.westerns.tokyo/shrine/" rel="noopener ugc nofollow" target="_blank">http://shrine.chal.ctf.westerns.tokyo/shrine/</a><strong class="nw ir">{{url_for.__globals__.current_app}}</strong></span></pre><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ph"><img src="../Images/41ec9dff1145945dcc35a114bf41697c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9C60PILl7M60OF2BZEolvw.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">当前应用1</figcaption></figure><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi oj"><img src="../Images/50d1dd6340fcf6818eade920ab252f30.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4lsP6eu6e_wddNYtAUZOlA.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">当前应用2</figcaption></figure><p id="8663" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这意味着我们又进入了应用程序<a class="ae mz" href="https://github.com/Abdelkad3r/CTF/blob/master/TokyoWesterns%20CTF%204th%202018/web/shrine/app.py" rel="noopener ugc nofollow" target="_blank"> <em class="mv"> app.py </em> </a> <em class="mv"> </em>中，所以现在让我们尝试进入config！</p><pre class="km kn ko kp gt nv nw nx ny aw nz bi"><span id="6334" class="ne lu iq nw b gy oa ob l oc od"><a class="ae mz" href="http://shrine.chal.ctf.westerns.tokyo/shrine/" rel="noopener ugc nofollow" target="_blank">http://shrine.chal.ctf.westerns.tokyo/shrine/</a><strong class="nw ir">{{url_for.__globals__.current_app.config}}</strong></span></pre><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi pi"><img src="../Images/11a6b4fdf2ba79c4e5e9a4799f585457.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q2-6HTWmtn6WWBmRwAy9FQ.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">配置(配置字典)1</figcaption></figure><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ol"><img src="../Images/7cfb635adb89782df0bac916d66f26eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JXOfuXY5jV8X2aWqxe4OYg.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">配置(配置字典)2</figcaption></figure><p id="d849" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">耶…我们只是通过使用<a class="ae mz" href="http://flask.pocoo.org/docs/0.12/api/#flask.url_for" rel="noopener ugc nofollow" target="_blank"> <em class="mv"> url_for() </em> </a>属性来访问<em class="mv"> config </em>，而不是直接访问config，因为它在<a class="ae mz" href="https://github.com/Abdelkad3r/CTF/blob/master/TokyoWesterns%20CTF%204th%202018/web/shrine/app.py" rel="noopener ugc nofollow" target="_blank"> <em class="mv"> app.py </em> </a> <em class="mv">中被列入黑名单并进行过滤，结果是<em class="mv"> None </em>，也没有使用“()”</em>，因为它在<em class="mv"/><a class="ae mz" href="https://github.com/Abdelkad3r/CTF/blob/master/TokyoWesterns%20CTF%204th%202018/web/shrine/app.py" rel="noopener ugc nofollow" target="_blank"><em class="mv">app . py</em></a>中也被过滤</p><p id="aecf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们的目标是获取进入<a class="ae mz" href="http://flask.pocoo.org/docs/0.12/api/#flask.config" rel="noopener ugc nofollow" target="_blank"> <em class="mv"> config </em> </a>或<a class="ae mz" href="http://flask.pocoo.org/docs/0.12/api/#flask" rel="noopener ugc nofollow" target="_blank"> <em class="mv"> self </em> </a>以便查找标志，如上图所示标志确实存储在<a class="ae mz" href="http://flask.pocoo.org/docs/0.12/api/#flask.config" rel="noopener ugc nofollow" target="_blank"> <em class="mv"> config </em> </a>中。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mr"><img src="../Images/769a2937553f9bf4aba1aae8e09a1095.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bPyezQj6Aa_O7sCvfPYZ3w.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">提交神社的旗帜</figcaption></figure><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi pj"><img src="../Images/a329a2bea1de4795f0503859b595cde2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HxgarQR4xMPLDt9WRzzTbA.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">神龛已经解决了</figcaption></figure><blockquote class="ms mt mu"><p id="86d6" class="jn jo mv jp b jq jr js jt ju jv jw jx mw jz ka kb mx kd ke kf my kh ki kj kk ij bi translated">标志是:<strong class="jp ir">tw CTF { pray _ f0r _ sacrible _ jinja 2 }</strong></p></blockquote><p id="b7fb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我要特别感谢这次挑战的作者，以及东京西部团队。这个任务是非常有教育意义的关于一个很强的弱点。我希望我的文章能帮助大家阅读，这里是这篇文章的第四部分 的<a class="ae mz" href="https://medium.com/@Abdelkad3r/tokyowesterns-ctf-4th-2018-writeup-part-4-f64e1583b315" rel="noopener"/></p></div></div>    
</body>
</html>