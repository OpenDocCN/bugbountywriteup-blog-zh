<html>
<head>
<title>Malware Analysis [#3]— Disk Writer</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">恶意软件分析[#3]—磁盘写入程序</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/malware-analysis-3-disk-writer-5ee764819597?source=collection_archive---------3-----------------------#2022-07-14">https://infosecwriteups.com/malware-analysis-3-disk-writer-5ee764819597?source=collection_archive---------3-----------------------#2022-07-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/32c779935bc98d0362072d74a94747c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:512/format:webp/1*BKNlS53BnQ4pXuv-piE63w.png"/></div></figure><p id="41ac" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在这篇文章中，我试图用Linux机器分析我从<a class="ae ks" href="https://bazaar.abuse.ch/browse.php?search=sha256%3Adf81fe69de455d1aeceb00e4cd4702d94edf9ab917dede008b65d0f045d75baf" rel="noopener ugc nofollow" target="_blank">恶意软件集市</a>中获取的这个恶意软件样本，但最终我需要使用windows机器进行调试和磁盘分析，所以让我们开始吧。</p><h2 id="a5d3" class="kt ku iq bd kv kw kx dn ky kz la dp lb kf lc ld le kj lf lg lh kn li lj lk ll bi translated">样本:</h2><ul class=""><li id="fe43" class="lm ln iq jw b jx lo kb lp kf lq kj lr kn ls kr lt lu lv lw bi translated">MD5:95 bfd 387 a 4105 a2 e 940 F3 c 50 C5 aa 1069</li><li id="3d92" class="lm ln iq jw b jx lx kb ly kf lz kj ma kn mb kr lt lu lv lw bi translated">sha 256:df 81 Fe 69 de 455d 1 AEC EB 00 E4 CD 4702d 94 EDF 9 ab 917 dede 008 b 65d 0 f 045d 75 BAF</li></ul><h2 id="fc18" class="kt ku iq bd kv kw kx dn ky kz la dp lb kf lc ld le kj lf lg lh kn li lj lk ll bi translated">一般信息:</h2><p id="f2db" class="pw-post-body-paragraph ju jv iq jw b jx lo jz ka kb lp kd ke kf mc kh ki kj md kl km kn me kp kq kr ij bi translated">在Linux机器上静态分析一个windows恶意软件样本，我们可以使用许多工具来获取关于样本的信息，如pefile、strings、file…等等，或者我们可以使用Cutter来分析样本，这就是我在这里使用的。</p><p id="aa34" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">下图是样品的一般信息:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi mf"><img src="../Images/2a29110be191b1394a8e496df5a60104.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OWDQFRzEdHsUuOCzGjwU9g.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">刀具:一般信息</figcaption></figure><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi ms"><img src="../Images/729a12d58c762e530fc13dab4c119795.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9M43bL15jvk33SvBC2tcCA.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">刀具:截面</figcaption></figure><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi mt"><img src="../Images/95644dc283903e655c788bd4bc731b33.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QsFse_w7aWjbMpXE3JhOVg.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">切割器:重要的琴弦</figcaption></figure><p id="8c84" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">从示例的字符串中，我们可以看到一些有趣的东西，它们是“\\\”。\\PHYSICALDRIVE0 "和" MBR "。第一个用于通过“create file”API函数获得硬盘的句柄，第二个是“主引导记录”的缩写，它位于硬盘的第一个扇区，负责指向操作系统的代码所在的位置，并具有关于硬盘中分区的信息，从这几行中，我们还可以预期该示例将获得硬盘的句柄，读取“MBR”并写入“MBR”记录，因此我们正在使用驱动器写入程序。</p></div><div class="ab cl mu mv hu mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="ij ik il im in"><h2 id="4039" class="kt ku iq bd kv kw kx dn ky kz la dp lb kf lc ld le kj lf lg lh kn li lj lk ll bi translated">在反汇编程序中:</h2><p id="004c" class="pw-post-body-paragraph ju jv iq jw b jx lo jz ka kb lp kd ke kf mc kh ki kj md kl km kn me kp kq kr ij bi translated">反汇编程序把我们放在了样本的入口点，但它不是恶意软件功能开始的地方，所以首先要寻找的是main函数。当分析C/C++软件/恶意软件时，您从初始化开始的入口点开始，大多数时候我们并不关心那里发生了什么，而是立即寻找主函数，大多数时候您会发现一个函数在调用它之前有3次推送，它们代表“argc”、“argv”和“envp”，这意味着环境变量:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/02ca39d236e0d1a623bda4201d65f422.png" data-original-src="https://miro.medium.com/v2/resize:fit:1258/format:webp/1*SjccG6sx6qMd_USm1MIIMg.png"/></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">刀具:主要功能</figcaption></figure><p id="7078" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在main函数中，我们发现只有一个函数调用:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/630b4c68d06e72360472f5912526190e.png" data-original-src="https://miro.medium.com/v2/resize:fit:954/format:webp/1*CiLoEbpIlSbmVD4yUcOX_g.png"/></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">刀具:调用磁盘写函数</figcaption></figure><p id="bc37" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在调用该函数后，我们看到它首先调用的是带参数的“CreateFileA”函数:</p><ul class=""><li id="c4fe" class="lm ln iq jw b jx jy kb kc kf nd kj ne kn nf kr lt lu lv lw bi translated">lpFileName: PHYSICALDRIVE0。</li><li id="57a2" class="lm ln iq jw b jx lx kb ly kf lz kj ma kn mb kr lt lu lv lw bi translated">dwDesiredAccess: (0xc)。</li><li id="c339" class="lm ln iq jw b jx lx kb ly kf lz kj ma kn mb kr lt lu lv lw bi translated">dwShareMode:(文件共享读取<strong class="jw ir"> | </strong>文件共享写入<strong class="jw ir">)。</strong></li><li id="6733" class="lm ln iq jw b jx lx kb ly kf lz kj ma kn mb kr lt lu lv lw bi translated">lpSecurityAttributes: (NULL)。</li><li id="4190" class="lm ln iq jw b jx lx kb ly kf lz kj ma kn mb kr lt lu lv lw bi translated">dwcreationdeposition:(OPEN _ EXISTING)。</li><li id="5685" class="lm ln iq jw b jx lx kb ly kf lz kj ma kn mb kr lt lu lv lw bi translated">dwFlagsAndAttributes: (NULL)。</li><li id="9c66" class="lm ln iq jw b jx lx kb ly kf lz kj ma kn mb kr lt lu lv lw bi translated">hTemplateFile: (NULL)。</li></ul><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/db52439a5c523a6b7e2c79ddaf52adc1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1298/format:webp/1*I3Mtf9hiVn3kXc_p3S7yNw.png"/></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">Cutter:获取磁盘的句柄</figcaption></figure><p id="602a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果函数失败，它会将一个字符串推送到一个函数，并打印出来，得到最后一个错误并退出。但是如果该函数成功，它将继续执行下一个函数“SetFilePointer”:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nh"><img src="../Images/d2a88569aa46a6876798978b5c5d49c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1R_FqN8U2To5GGOkBBWaPw.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">刀具:设置文件指针</figcaption></figure><p id="6213" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">SetFilePointer函数所做的是移动指定文件的文件指针，这里它取一个硬盘的句柄，其余参数为(0)。如果函数成功，它调用ReadFile函数:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi ni"><img src="../Images/a174ed93be118fd32ce32a699dbf3361.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YJvrWpODIjF3guXCDKpDrw.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">Cutter:读“MBR”</figcaption></figure><p id="a8a2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如上面截图所示,“ReadFile”函数采用十六进制的“nNumberOfBytesToRead”参数0x200，这表示“MBR”的大小为512字节。如果其中一个函数失败，它将推送字符串“read_mbr_Failed”并关闭句柄并退出，否则它将把128个“dword”字节(这意味着512个字节)从接收从“mbr”读取的数据的缓冲区移动到新的缓冲区，以将其与来自“MBR”的字节进行比较。数据”部分，如果它们相等，它将把字符串“already_infected”推入打印，如果在任何点上比较不相等，它将继续并准备写入“MBR”:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nj"><img src="../Images/7616db271a0391a079f8ee83bd2967c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YSjMRMWykC77VCgY1B0jPA.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">Cutter:比较原始“MBR”和恶意软件“MBR”</figcaption></figure><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/8c1c9652ee3eb608e950e851693fb6f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1306/format:webp/1*Ks5PFfAcAesJ4DWCbhnQRQ.png"/></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">切割器:恶意软件“MBR”</figcaption></figure><p id="0bc9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">从上面的屏幕截图中，我们可以看到hexdump与驱动器的“MBR”进行了比较，正如我提到的，如果它不相等，它将开始将其写入“MBR”，我还想在这里提到一个数字取证说明，这是上面屏幕截图中的最后两个字节(55，aa)，它们代表扇区的结束签名。</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/c09c85c5f3c51441144374e88bd14406.png" data-original-src="https://miro.medium.com/v2/resize:fit:1138/format:webp/1*Ml_WEgp87yrTTgT_wM3jPQ.png"/></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">Cutter:编写“MBR”</figcaption></figure><p id="9579" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">之后，它开始在一个循环中将原始“MBR”与“0x442260”地址中的一个值进行简单的异或运算，直到它小于200个十六进制数(512个字节):</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/8dc5da021226681887cdd09b2a4feb25.png" data-original-src="https://miro.medium.com/v2/resize:fit:1108/format:webp/1*GrwojW0vi3UVO5W9DaWQxw.png"/></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">切割器:Xoring循环</figcaption></figure><p id="066c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">然后，它将文件指针移动到第三个扇区的开头，并写入原始“MBR”。如果失败，它将推送字符串“write_backup_mbr_failed”进行打印，然后调用“CloseHandle”并退出，否则，它将推送字符串“Write_original_mbr”进行打印，然后调用“CloseHanle ”,然后推送字符串“Write_mbr_OK”进行打印。</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nn"><img src="../Images/e383115a0e7d8300733a7960d005b310.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*f-h0HmnbrErjmsm2OOUqaQ.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">Cutter:写原“MBR”</figcaption></figure><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div class="gh gi no"><img src="../Images/7e716f9e6c03a771f5af44416ecf6a79.png" data-original-src="https://miro.medium.com/v2/resize:fit:1272/format:webp/1*e156dKQuN_pOpLXKtGew3g.png"/></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">切割器:关闭手柄并退出</figcaption></figure></div><div class="ab cl mu mv hu mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="ij ik il im in"><h2 id="b778" class="kt ku iq bd kv kw kx dn ky kz la dp lb kf lc ld le kj lf lg lh kn li lj lk ll bi translated">在调试器中:</h2><p id="e07b" class="pw-post-body-paragraph ju jv iq jw b jx lo jz ka kb lp kd ke kf mc kh ki kj md kl km kn me kp kq kr ij bi translated">我们可以在获得物理驱动器的句柄并设置指向驱动器开头的指针后看到恶意软件，它读取它的第一个扇区，如下面的屏幕截图所示，左边来自WinHex，右边来自x64dbg:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi np"><img src="../Images/98cf5b329c97659ff2cd7a2a63d7b813.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kOnUrLjtXUrm3gBA3SjdHA.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">WinHex和x64dbg比较</figcaption></figure><p id="cf03" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">然后，它用来自“的新数据写入第一个扇区。数据”部分，因为它出现在WinHex的下一个屏幕截图中:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nq"><img src="../Images/a92770831a328aa760b43079dc14f29d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D28_4b3IJLKhIaJ_PgLYzg.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">WinHex和x64dbg比较</figcaption></figure><p id="8000" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">之后，它开始通过将原始“MBR”与“cdcdcdcdcdcdcdcdcdcdcdcdcdcdcdcdcdcdcdcdcdcdcdcd”进行异或运算来混淆原始“MBR ”,然后将其写入第三个扇区，并打印出成功的消息:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nr"><img src="../Images/ec7b8cbbf6e2063c2eafe0cddc33f13a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XOyRzpLE9ZTSnLVnfRPBgg.png"/></div></div></figure><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/00d4ffdfc237d7032577105507c5a212.png" data-original-src="https://miro.medium.com/v2/resize:fit:1276/format:webp/1*R49-t5rAUBGyCXoMHmIimw.png"/></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">WinHex:异或原始“MBR”</figcaption></figure><p id="cc34" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">重启机器时，我们会看到一个黑屏和红色文本，要求我们输入密码以解锁机器，输入任何密码时，我们都会收到一条消息，提示密码不正确:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nt"><img src="../Images/11235540ea66c6b455dd092e050a67ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*z_cjPrKu1WS2fuUYvSKBnQ.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">引导后</figcaption></figure><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nu"><img src="../Images/a43de8e0bd4524ec55c7a63dd00262d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5tgzPO4kvKO8scW-X0pepg.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">引导后</figcaption></figure><p id="78e6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">解决这个问题很简单，将模糊的“MBR”与值“cdcdcdcdcdcdcdcdcdcdcdcdcdcdcdcdcdcdcdcdcdcdcd”进行异或运算，删除恶意软件MBR，写回模糊的“MBR ”,一切都应该正常工作。</p></div><div class="ab cl mu mv hu mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="ij ik il im in"><p id="f92a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">防逆转技术:</strong></p><p id="15d2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">没有人</p><h2 id="fcbf" class="kt ku iq bd kv kw kx dn ky kz la dp lb kf lc ld le kj lf lg lh kn li lj lk ll bi translated">链接:</h2><div class="nv nw gp gr nx ny"><a href="https://www.flaticon.com/free-icons/code" rel="noopener  ugc nofollow" target="_blank"><div class="nz ab fo"><div class="oa ab ob cl cj oc"><h2 class="bd ir gy z fp od fr fs oe fu fw ip bi translated">39，536个免费的代码图标</h2><div class="of l"><h3 class="bd b gy z fp od fr fs oe fu fw dk translated">很抱歉您取消了Premium订阅，但您仍可以享受Flaticon收藏，但有以下限制…</h3></div><div class="og l"><p class="bd b dl z fp od fr fs oe fu fw dk translated">www.flaticon.com</p></div></div><div class="oh l"><div class="oi l oj ok ol oh om js ny"/></div></div></a></div></div><div class="ab cl mu mv hu mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="ij ik il im in"><h2 id="de82" class="kt ku iq bd kv kw kx dn ky kz la dp lb kf lc ld le kj lf lg lh kn li lj lk ll bi translated">来自Infosec的报道:Infosec每天都有很多内容，很难跟上。<a class="ae ks" href="https://weekly.infosecwriteups.com/" rel="noopener ugc nofollow" target="_blank">加入我们的每周简讯</a>以5篇文章、4个线程、3个视频、2个Github Repos和工具以及1个工作提醒的形式免费获取所有最新的Infosec趋势！</h2></div></div>    
</body>
</html>