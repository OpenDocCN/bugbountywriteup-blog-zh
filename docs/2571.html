<html>
<head>
<title>Write-up: Basic server-side template injection (code context) @ PortSwigger Academy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">上书:基础服务器端模板注入(代码上下文)@ PortSwigger Academy</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/write-up-basic-server-side-template-injection-code-context-portswigger-academy-910a3720c26d?source=collection_archive---------6-----------------------#2022-11-28">https://infosecwriteups.com/write-up-basic-server-side-template-injection-code-context-portswigger-academy-910a3720c26d?source=collection_archive---------6-----------------------#2022-11-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/06ae49f88d0e66835d331fe32d9c551a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*j_ABvkg5rYWGB6eK.png"/></div></div></figure><p id="55c8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这篇关于实验室<em class="kw">基本服务器端模板注入(代码上下文)</em>的文章是我为<a class="ae kx" href="https://portswigger.net/web-security" rel="noopener ugc nofollow" target="_blank"> PortSwigger的Web安全学院</a>所做的系列演练的一部分。</p><p id="eb2e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">学习路径</strong>:高级主题→服务器端模板注入</p><div class="ky kz gp gr la lb"><a href="https://portswigger.net/web-security/server-side-template-injection/exploiting/lab-server-side-template-injection-basic-code-context" rel="noopener  ugc nofollow" target="_blank"><div class="lc ab fo"><div class="ld ab le cl cj lf"><h2 class="bd ir gy z fp lg fr fs lh fu fw ip bi translated">实验室:基本服务器端模板注入(代码上下文)|网络安全学院</h2><div class="li l"><h3 class="bd b gy z fp lg fr fs lh fu fw dk translated">练习利用现实目标的弱点。记录你从学徒到专家的进步。看哪里…</h3></div><div class="lj l"><p class="bd b dl z fp lg fr fs lh fu fw dk translated">portswigger.net</p></div></div><div class="lk l"><div class="ll l lm ln lo lk lp jw lb"/></div></div></a></div><p id="5f78" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Python脚本:<a class="ae kx" href="https://github.com/frank-leitner/portswigger-websecurity-academy/blob/main/18_server_side_template_injection/Basic_server-side_template_injection_(code_context)/script.py" rel="noopener ugc nofollow" target="_blank"> script.py </a></p><h1 id="381c" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">实验室描述</h1><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mo"><img src="../Images/f066447f5f309ab03e2ecd35ba6fdfd1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*M983lnNC0FEci0aN.png"/></div></div></figure><h1 id="f1c8" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">步伐</h1><h1 id="a1d5" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">分析</h1><p id="93a7" class="pw-post-body-paragraph jy jz iq ka b kb mt kd ke kf mu kh ki kj mv kl km kn mw kp kq kr mx kt ku kv ij bi translated">通常，第一步是分析实验室应用程序的功能。在这个实验室中，它是一个向我提供凭据的博客网站。</p><p id="9263" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">公共页面没有显示任何有趣的内容。当我发表评论时，它会以匿名形式出现，但它似乎不包含我想要的内容。</p><p id="5d40" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我继续以<code class="fe my mz na nb b">wiener</code>的身份登录。在我的帐户页面上，我可以更改我的电子邮件并设置一个首选名称。我猜它会在博客上发布内容时用作用户名:</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nc"><img src="../Images/622cae92488b7d67d868e02e3df29fef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*E4nyaTxdKZVyQXbG.png"/></div></div></figure><p id="0e79" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">更改电子邮件地址不会带来任何实质性的东西。更改<code class="fe my mz na nb b">preferred name</code>确实会更改发布的评论的名称:</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nd"><img src="../Images/6c9a9a66b0eff0362ae803f08c09320e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*udRZeXT5gMWBsZS8.png"/></div></div></figure><p id="9a1a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">更有趣的是在更改首选名称时发送的请求:</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ne"><img src="../Images/f3c0cf36070fab1f6cbfb7f559980df3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*LOdcgwMUsQtm4QjS.png"/></div></div></figure><p id="e2fc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">name参数的值似乎包含了对某个数据结构的引用:<code class="fe my mz na nb b">user.name</code>，或者，对于其他选项，<code class="fe my mz na nb b">user.nickname</code>和<code class="fe my mz na nb b">user.first_name</code>。</p><p id="e6df" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一种安全的方法是将客户端提供的值用作查找表中的普通索引，而不是直接使用它。然而，通常情况并非如此。应用了或多或少的净化的输入用于实际逻辑中，可能会造成混乱。</p></div><div class="ab cl nf ng hu nh" role="separator"><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk"/></div><div class="ij ik il im in"><h1 id="4a2d" class="lq lr iq bd ls lt nm lv lw lx nn lz ma mb no md me mf np mh mi mj nq ml mm mn bi translated">该理论</h1><p id="0fd7" class="pw-post-body-paragraph jy jz iq ka b kb mt kd ke kf mu kh ki kj mv kl km kn mw kp kq kr mx kt ku kv ij bi translated">实验室描述提到了tornado模板，所以我查看了它的<a class="ae kx" href="https://www.tornadoweb.org/en/stable/template.html" rel="noopener ugc nofollow" target="_blank">文档</a>。在里面，我找到了一些基本信息:</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/9abb3bdf354a98d6c314c0883dc79d50.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/format:webp/0*2zSGzNrkegR-Drk1.png"/></div></figure><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ns"><img src="../Images/564a259db25892fdb5cac2c896d05f08.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*_Vjj1ZFWSVpKQqDO.png"/></div></div></figure><p id="8070" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，我现在假设关于来自<code class="fe my mz na nb b">POST</code>请求的name值的两件事:</p><ol class=""><li id="8c62" class="nt nu iq ka b kb kc kf kg kj nv kn nw kr nx kv ny nz oa ob bi translated">它要么根本没有消毒，要么消毒不充分</li><li id="f20c" class="nt nu iq ka b kb oc kf od kj oe kn of kr og kv ny nz oa ob bi translated">它直接用在生成HTML注释的模板中</li></ol><p id="734c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果这些假设为真，那么我将能够通过用<code class="fe my mz na nb b">}}</code>终止模板值并使用<code class="fe my mz na nb b">{{own_expression</code>添加一些自己的表达式来注入自己的代码。关闭<code class="fe my mz na nb b">}}</code>已经到位，所以我不提供他们。</p><p id="b494" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我通过将POST请求发送到Burp Repeater中，并将显示名称更改为<code class="fe my mz na nb b">user.name}}{{2*3</code>来测试我是否可以调用一个数学运算:</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oh"><img src="../Images/b20f9c99c1e8ff1c9e9c21300829ada1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*b5dwMIbxDntM3Q1A.png"/></div></div></figure><p id="3315" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">请求通过后，我用我的评论重新加载博客页面。现在的内容是</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div class="gh gi oi"><img src="../Images/453b9e9d8eb76eb8137b85a4de5b0838.png" data-original-src="https://miro.medium.com/v2/resize:fit:652/format:webp/0*C08K3X1YfLScshQ4.png"/></div></figure><p id="5b2d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这证实了我可以将表达式注入到模板中。</p></div><div class="ab cl nf ng hu nh" role="separator"><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk"/></div><div class="ij ik il im in"><h1 id="d20d" class="lq lr iq bd ls lt nm lv lw lx nn lz ma mb no md me mf np mh mi mj nq ml mm mn bi translated">恶意负载</h1><p id="3ade" class="pw-post-body-paragraph jy jz iq ka b kb mt kd ke kf mu kh ki kj mv kl km kn mw kp kq kr mx kt ku kv ij bi translated">根据文档，<code class="fe my mz na nb b">{{own_expression}}</code>语法只能用于表达式。所以为了包含我自己的代码，比如导入，我需要使用<code class="fe my mz na nb b">{% code %}</code>语法。</p><p id="5b37" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我使用上面的数学注入，并在两个表达式之间添加了一个代码块:<code class="fe my mz na nb b">user.name}}{%import+os;os.unlink("/home/carlos/morale.txt")%}{{2*3</code>。这样，它保持语法有效，但在中间执行我的任意代码:</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oj"><img src="../Images/4f9da681eb4ce49485df6e3a1b8ad5e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*QQRmc1TxEZPaUToC.png"/></div></div></figure><p id="0762" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我将评论页面和实验室更新重新加载到</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ok"><img src="../Images/ca4dc70294c3768191a71b8da82c2f08.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*5vAWcDSgME6qNOAF.png"/></div></div></figure></div><div class="ab cl nf ng hu nh" role="separator"><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk"/></div><div class="ij ik il im in"><p id="54b7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">注意</strong>:如果你在那个页面上发布了多个评论，你仍然可以解决这个实验，但是会收到这个错误:</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ol"><img src="../Images/8cd162261b540f4cf0efc795c0a04f2b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*2iznA0T17w-Kf2RW.png"/></div></div></figure><p id="6d69" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这是意料之中的。第一个注释的HTML生成会删除文件，当处理下一个注释时会出错。</p></div><div class="ab cl nf ng hu nh" role="separator"><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk"/></div><div class="ij ik il im in"><p id="8e1a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="kw">原载于</em><a class="ae kx" href="https://github.com/frank-leitner/portswigger-websecurity-academy/tree/main/18_server_side_template_injection/Basic_server-side_template_injection_%28code_context%29" rel="noopener ugc nofollow" target="_blank"><em class="kw">https://github.com</em></a><em class="kw">。</em></p><p id="11c1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe my mz na nb b"><a class="ae kx" href="https://medium.com/@frank.leitner/membership" rel="noopener">New to Medium? Become a Medium member to access all stories on the platform and support me at no extra cost for you!</a></code></p></div><div class="ab cl nf ng hu nh" role="separator"><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk"/></div><div class="ij ik il im in"><h2 id="9608" class="om lr iq bd ls on oo dn lw op oq dp ma kj or os me kn ot ou mi kr ov ow mm ox bi translated">来自Infosec的报道:Infosec每天都有很多内容，很难跟上。<a class="ae kx" href="https://weekly.infosecwriteups.com/" rel="noopener ugc nofollow" target="_blank">加入我们的每周简讯</a>以5篇文章、4个线程、3个视频、2个GitHub Repos和工具以及1个工作提醒的形式免费获取所有最新的Infosec趋势！</h2></div></div>    
</body>
</html>