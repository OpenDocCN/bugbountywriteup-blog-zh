<html>
<head>
<title>I have 1% chance to hack this company</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我有1%的机会黑掉这家公司</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/i-have-1-chance-to-hack-this-company-1044879f41a9?source=collection_archive---------0-----------------------#2022-05-05">https://infosecwriteups.com/i-have-1-chance-to-hack-this-company-1044879f41a9?source=collection_archive---------0-----------------------#2022-05-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div class="gh gi io"><img src="../Images/058c9ab041307aaba1d8a5f3b0a9ba25.png" data-original-src="https://miro.medium.com/v2/resize:fit:1172/format:webp/1*-qUGyCF47N8llxCAwHVhAA.png"/></div><figcaption class="iv iw gj gh gi ix iy bd b be z dk translated">我只有1%的机会利用SSRF漏洞黑掉这家公司</figcaption></figure><div class=""/><p id="1346" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">今天我将与你分享我在<a class="ae kw" href="https://serpapi.com/" rel="noopener ugc nofollow" target="_blank"> SerpApi，LLC上发现的第一个漏洞。</a></p><p id="42ef" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我在完成在<a class="ae kw" href="https://serpapi.com/" rel="noopener ugc nofollow" target="_blank"> SerpApi，LLC的入职流程后，就发现了这个漏洞。</a></p></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><h1 id="078e" class="le lf jb bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">目录</h1><p id="98d0" class="pw-post-body-paragraph jy jz jb ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">— <a class="ae kw" href="#fe91" rel="noopener ugc nofollow">目标。</a><br/>——<a class="ae kw" href="#b6ca" rel="noopener ugc nofollow">将漏洞武器化。</a><br/>——<a class="ae kw" href="#12f9" rel="noopener ugc nofollow">剥削。</a> <br/> — <a class="ae kw" href="#3bb7" rel="noopener ugc nofollow">影响和严重程度。</a> <br/> — <a class="ae kw" href="#9823" rel="noopener ugc nofollow">报告时间线。</a><br/>——<a class="ae kw" href="#583a" rel="noopener ugc nofollow">结局。</a></p><h1 id="fe91" class="le lf jb bd lg lh mh lj lk ll mi ln lo lp mj lr ls lt mk lv lw lx ml lz ma mb bi translated"><strong class="ak">目标</strong></h1><p id="8c00" class="pw-post-body-paragraph jy jz jb ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">SerpApi是一个实时Api，用于访问谷歌搜索结果和其他搜索引擎。他们处理代理，解决验证码，解析所有丰富的结构化数据，<a class="ae kw" href="https://serpapi.com/" rel="noopener ugc nofollow" target="_blank"> SerpApi </a>是这个行业的全球第一。</p><p id="fbc5" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我真的很想找到一个漏洞，一个关键的漏洞！..是的，我可以访问该公司的代码，但代码非常庞大，我刚刚加入，所以我决定先从黑盒方法开始(不看代码进行测试)。</p><p id="de16" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我注意到了他们的API URLs</p><p id="8b63" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于雅虎API : <code class="fe mm mn mo mp b"><a class="ae kw" href="https://serpapi.com/search?engine=yahoo&amp;p=Coffee&amp;yahoo_domain=be" rel="noopener ugc nofollow" target="_blank">https://serpapi.com/search?engine=yahoo&amp;p=Coffee&amp;yahoo_domain=be</a></code></p><p id="e510" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于谷歌API: <code class="fe mm mn mo mp b"><a class="ae kw" href="https://serpapi.com/search.json?engine=google&amp;q=Coffee&amp;google_domain=google.com" rel="noopener ugc nofollow" target="_blank">https://serpapi.com/search.json?engine=google&amp;q=Coffee&amp;google_domain=google.com</a></code></p><p id="b015" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">等等...</p><p id="59e9" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我已经决定检查每个API的域，并尝试用另一个主机名替换该域，但不幸的是，每次我这样做时，都会收到一个错误，指出该域不受支持！</p><figure class="mr ms mt mu gt is gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi mq"><img src="../Images/4220d9b94b6e67be8ed57ee3e458c899.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9qt0Ig6mVXFlyuHj627zlw.png"/></div></div><figcaption class="iv iw gj gh gi ix iy bd b be z dk translated">谷歌搜索API — SerpApi，LLC。</figcaption></figure><p id="df53" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我开始变得绝望，我打算放弃，测试了超过5或6个使用<code class="fe mm mn mo mp b">xx_domain</code>参数的API，但没有运气。</p><p id="4e20" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">直到我穿越了Yandex！</p><figure class="mr ms mt mu gt is gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi mz"><img src="../Images/63f35005c8f7ab143cfc94c8f01d64e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zv1-VD3vXlVbqjcryjTu0w.png"/></div></div><figcaption class="iv iw gj gh gi ix iy bd b be z dk translated">SerpApi Playground — HTML和JSON API结果</figcaption></figure><figure class="mr ms mt mu gt is gh gi paragraph-image"><div class="gh gi na"><img src="../Images/a1fef5bc1a79f9c4eec63f388a0ef742.png" data-original-src="https://miro.medium.com/v2/resize:fit:640/1*YivJGLQltqaYkDCd_QXPYQ.gif"/></div><figcaption class="iv iw gj gh gi ix iy bd b be z dk translated">是的，我做到了</figcaption></figure><p id="a7f2" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">看来对参数<code class="fe mm mn mo mp b">yandex_domain</code>没有保护。现在我开始变得非常兴奋！</p><p id="7bca" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们开始稍微分析一下目标，这样我们就可以用正确的方式利用这个漏洞。</p><h1 id="b6ca" class="le lf jb bd lg lh mh lj lk ll mi ln lo lp mj lr ls lt mk lv lw lx ml lz ma mb bi translated"><strong class="ak">将漏洞武器化</strong></h1><p id="7058" class="pw-post-body-paragraph jy jz jb ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">让我们暂时忘记HTML，专注于JSON输出，它看起来包含了非常丰富的有用信息:</p><figure class="mr ms mt mu gt is gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi nb"><img src="../Images/b1e8c4962c5ac419ec44a86d31dbe0de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YJ_GlUSGzyMQRMUZ7Zzpcw.png"/></div></div><figcaption class="iv iw gj gh gi ix iy bd b be z dk translated">Yandex搜索API — SerpApi，LLC。</figcaption></figure><p id="be8d" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你看一看<code class="fe mm mn mo mp b">yandex_url</code>，你会注意到几件事:</p><ul class=""><li id="7f95" class="nc nd jb ka b kb kc kf kg kj ne kn nf kr ng kv nh ni nj nk bi translated">URL协议模式是<code class="fe mm mn mo mp b">https://</code>——我们不能控制也不能改变它。</li><li id="b814" class="nc nd jb ka b kb nl kf nm kj nn kn no kr np kv nh ni nj nk bi translated">网址总是以<code class="fe mm mn mo mp b">/search/?text=a</code>结尾。</li></ul><p id="d44b" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我试过用#绕过网址，但是没用所以我试着编码直接发给操场，但是没用，看起来操场在逃避它！</p><p id="effb" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所以我尝试使用端点<code class="fe mm mn mo mp b">search.html</code>直接请求API<br/>我使用urlencode和<code class="fe mm mn mo mp b">/</code>最终结果将是<code class="fe mm mn mo mp b">%23/</code>猜猜看？</p><p id="a291" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">是的，效果很好。:D现在我们在塞尔帕皮有限责任公司拥有一个完整的SSRF。</p><figure class="mr ms mt mu gt is gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi nq"><img src="../Images/a8171f1b5ea4b4a39ae990e7ec772aa2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N-SLmS9bXbe-9bWjociNMg.png"/></div></div><figcaption class="iv iw gj gh gi ix iy bd b be z dk translated">服务器端请求伪造SerpApi，LLC。</figcaption></figure><p id="dd0f" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们使用<code class="fe mm mn mo mp b">#</code>来绕过硬编码的端点<code class="fe mm mn mo mp b">/search/?test=a</code>。</p><p id="0b6f" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">问题是，我们不能绕过协议<code class="fe mm mn mo mp b">https://</code>，如果我们绕过它，我们可以使用<code class="fe mm mn mo mp b">file:///</code>来读取本地文件，或者任何其他协议来利用它作为适当的SSRF。</p><p id="ee75" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我所想的就是把它升级到远程代码执行……<br/>仅仅一个请求怎么可能把一个<a class="ae kw" href="https://portswigger.net/web-security/ssrf" rel="noopener ugc nofollow" target="_blank"> SSRF </a>升级到<a class="ae kw" href="https://www.bugcrowd.com/glossary/remote-code-execution-rce/" rel="noopener ugc nofollow" target="_blank"> RCE </a>？</p><h1 id="12f9" class="le lf jb bd lg lh mh lj lk ll mi ln lo lp mj lr ls lt mk lv lw lx ml lz ma mb bi translated"><strong class="ak">剥削</strong></h1><p id="00ba" class="pw-post-body-paragraph jy jz jb ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">嗯，我有很多步骤要走。</p><ul class=""><li id="0f16" class="nc nd jb ka b kb kc kf kg kj ne kn nf kr ng kv nh ni nj nk bi translated">升级到<a class="ae kw" href="https://portswigger.net/web-security/cross-site-scripting" rel="noopener ugc nofollow" target="_blank"> XSS </a>然后接管账户。</li><li id="d32b" class="nc nd jb ka b kb nl kf nm kj nn kn no kr np kv nh ni nj nk bi translated">尝试找到真正的服务器IP，并希望它托管在AWS或Digitalocean等云上。</li></ul><p id="5fd7" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我注意到，我对任何页面的每个请求都缓存在公司的本地服务器上，所以当我从JSON请求我的页面时，我将获得页面的缓存HTML副本。</p><figure class="mr ms mt mu gt is gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi nr"><img src="../Images/58e2ca39b667fbe057f1f5c8ee98c637.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*206EnKzSxieGkLAmabGuiQ.png"/></div></div><figcaption class="iv iw gj gh gi ix iy bd b be z dk translated">SerpApi JSON结果</figcaption></figure><p id="4fb8" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这就是缓存的HTML页面。</p><figure class="mr ms mt mu gt is gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi ns"><img src="../Images/9310b536ede1aa2c55a758fda111a62a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hAf7qAzUW9ZP8ApSmhcvLQ.png"/></div></div><figcaption class="iv iw gj gh gi ix iy bd b be z dk translated">HTML结果serpapi</figcaption></figure><p id="a905" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此时，我可以缓存任何带有<a class="ae kw" href="https://portswigger.net/web-security/cross-site-scripting" rel="noopener ugc nofollow" target="_blank"> XSS </a>和JS有效载荷的页面，并简单地将链接发送给任何管理员来劫持他的帐户。</p><p id="af7d" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然而，这不是我的目标，我想要更多，所以我继续做了一些调查，我通过使用Shodan.io发现https://serpapi.com的<a class="ae kw" href="https://serpapi.com" rel="noopener ugc nofollow" target="_blank">正在使用:D的数字海洋，这意味着我可以访问这个神奇的链接，并且可以完全访问</a><a class="ae kw" href="https://docs.digitalocean.com/reference/api/metadata-api/" rel="noopener ugc nofollow" target="_blank">的元数据。</a></p><p id="e365" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我没有继续下去，因为它太明显了，我继续阅读代码，看看它是如何工作的。</p><p id="e626" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，当我请求任何URL时，<a class="ae kw" href="https://serpapi.com/" rel="noopener ugc nofollow" target="_blank"> SerpApi </a>引擎将尝试使用私有代理来访问该URL(不是Digitalocean ),至少我是这样认为的:</p><figure class="mr ms mt mu gt is gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/dbfb381b8fddb4572969e2c315f13250.png" data-original-src="https://miro.medium.com/v2/resize:fit:710/format:webp/1*m2AIELLDrY_BK7SHUg5yHQ.png"/></div><figcaption class="iv iw gj gh gi ix iy bd b be z dk translated">SerpApi代理选择器</figcaption></figure><p id="2ca7" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">通过查看，我意识到当发送请求时，应用程序将使用外部商业代理来发送大多数请求，当然，除了(1%) <code class="fe mm mn mo mp b">direct</code>之外，这意味着只有一个来自Digitalocean。</p><p id="526d" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所以通过简单的计算:</p><pre class="mr ms mt mu gt nu mp nv nw aw nx bi"><span id="f2cc" class="ny lf jb mp b gy nz oa l ob oc">5 + 5 + 20 + 1 + 5 + 25 + 1 = 62<br/>1/62=0.016 <br/>Direct = 0.0016 </span></pre><p id="eea3" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">大约我们有<code class="fe mm mn mo mp b">1%</code>或更少的时间来获得正确的请求。</p><p id="3d1a" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">幸运的是，<a class="ae kw" href="https://serpapi.com/" rel="noopener ugc nofollow" target="_blank"> SerpApi </a>正在代理上进行循环，不管百分比如何，直到目标URL可以工作或者继续重复请求。</p><h1 id="3bb7" class="le lf jb bd lg lh mh lj lk ll mi ln lo lp mj lr ls lt mk lv lw lx ml lz ma mb bi translated"><strong class="ak">影响和严重性</strong></h1><p id="d4d6" class="pw-post-body-paragraph jy jz jb ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">该漏洞具有高可用性和低复杂性。</p><p id="4a07" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">由于这些事实，我可以认为严重性<strong class="ka jc">至关重要</strong>。</p><p id="e330" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里的影响是未经验证的<a class="ae kw" href="https://portswigger.net/web-security/ssrf" rel="noopener ugc nofollow" target="_blank"> SSRF </a>，通过与<a class="ae kw" href="https://portswigger.net/web-security/cross-site-scripting" rel="noopener ugc nofollow" target="_blank"> XSS </a>链接，可以升级为ATO攻击者可以利用<a class="ae kw" href="https://portswigger.net/web-security/ssrf" rel="noopener ugc nofollow" target="_blank"> SSRF </a>发送内部请求来访问数字海洋元数据API。</p><h1 id="9823" class="le lf jb bd lg lh mh lj lk ll mi ln lo lp mj lr ls lt mk lv lw lx ml lz ma mb bi translated"><strong class="ak">报告时间表</strong></h1><p id="69a5" class="pw-post-body-paragraph jy jz jb ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">-2021年3月4日报道-凌晨4点18分。<br/>——2021年3月4日开审——上午6:37。<br/>——定格在2021年3月4日——上午7点24分。<br/>-2021年3月4日-上午9:00确定。</p><h1 id="583a" class="le lf jb bd lg lh mh lj lk ll mi ln lo lp mj lr ls lt mk lv lw lx ml lz ma mb bi translated"><strong class="ak">结局</strong></h1></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><p id="3455" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在Twitter上关注我，我会发布我的最新文章:<a class="ae kw" href="https://twitter.com/alaa0x2" rel="noopener ugc nofollow" target="_blank"> @alaa0x2 </a></p><p id="9e26" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">也可以关注<a class="ae kw" href="https://serpapi.com/" rel="noopener ugc nofollow" target="_blank"> SerpApi，LLC。</a>在Twitter上:<a class="ae kw" href="https://twitter.com/serp_api" rel="noopener ugc nofollow" target="_blank"> @serp_api </a> <br/>要报告安全漏洞，你可以发送给<a class="ae kw" href="mailto:contact@serpapi.com" rel="noopener ugc nofollow" target="_blank">contact@serpapi.com</a></p></div></div>    
</body>
</html>