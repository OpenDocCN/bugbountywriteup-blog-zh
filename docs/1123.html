<html>
<head>
<title>Leakage of Sensitive Data Through Android Webviews</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过Android Webviews泄露敏感数据</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/leakage-of-sensitive-data-through-android-webviews-3b0b86486a28?source=collection_archive---------1-----------------------#2021-02-16">https://infosecwriteups.com/leakage-of-sensitive-data-through-android-webviews-3b0b86486a28?source=collection_archive---------1-----------------------#2021-02-16</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="f902" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph">CVE-2021–21136:WebView中的政策执行不足</h2><div class=""/><div class=""><h2 id="3755" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">识别Android Webview组件中的漏洞并获取CVE的故事-2021–21136</h2></div><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/c17caf2e84dabe7a9ff506bb03ea970a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*944E9lxYtSOn4pS0Yo_x5A.png"/></div></div></figure><p id="1424" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">不久前，在分析一个安全问题时，我想到了学习一些Webview APIs的行为。在研究过程中，我发现在特定的场景中，Android webviews可能会泄漏敏感数据，如用户的身份验证令牌、API机密等。给第三方。medium博客捕获了已确定的安全问题的技术细节。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><p id="0505" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">我将通过复习一些基础知识来开始这个故事，以便刚接触Android世界的人能够理解这个问题。熟悉Android Webviews的人可以跳过下一部分。</p><h1 id="ed1a" class="mg mh it bd mi mj mk ml mm mn mo mp mq ki mr kj ms kl mt km mu ko mv kp mw mx bi translated">Android网络视图</h1><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi my"><img src="../Images/8009a11ae8e4a39db98bd828b7511ab8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*IImSRUe98f1PK_ZH"/></div></div></figure><p id="69aa" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">Android允许开发者通过Webviews将网页内容直接显示到他们的应用程序中。您可以将它视为应用程序的专用web浏览器实例，用于向用户交付网页。</p><h2 id="ac6e" class="mz mh it bd mi na nb dn mm nc nd dp mq lm ne nf ms lq ng nh mu lu ni nj mw iz bi translated">在Webview中加载内容</h2><p id="a121" class="pw-post-body-paragraph ld le it lf b lg nk kd li lj nl kg ll lm nm lo lp lq nn ls lt lu no lw lx ly im bi translated">Webviews的使用对开发者非常友好，因此目前被广泛使用。我们可以使用如下所示的<strong class="lf jd"><em class="np">Webview # loadUrl</em></strong><em class="np"/>方法加载网页内容:</p><pre class="ks kt ku kv gt nq nr ns nt aw nu bi"><span id="8e2b" class="mz mh it nr b gy nv nw l nx ny"><em class="np">--<br/></em><em class="np">WebView myWebView = (WebView) findViewById(R.id.webview);<br/>myWebView</em><em class="np">.loadUrl("http://www.google.com");<br/>--</em></span></pre><blockquote class="nz oa ob"><p id="08a8" class="ld le np lf b lg lh kd li lj lk kg ll oc ln lo lp od lr ls lt oe lv lw lx ly im bi translated">如果您希望在请求加载web内容时传递一些头，或者希望加载一些受保护的内容，该怎么办？？</p></blockquote><p id="21a2" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">Android还提供了一个重载版本的<strong class="lf jd"><em class="np">Webview # loadUrl</em></strong><em class="np"/>方法，该方法允许我们向请求传递额外的请求头，如下所示:</p><pre class="ks kt ku kv gt nq nr ns nt aw nu bi"><span id="0467" class="mz mh it nr b gy nv nw l nx ny"><em class="np">--</em></span><span id="9762" class="mz mh it nr b gy of nw l nx ny"><em class="np">Map&lt;String, String&gt; headers = new HashMap&lt;&gt;();<br/>headers.put("Authorization", token);<br/>--</em></span><span id="93b0" class="mz mh it nr b gy of nw l nx ny"><em class="np">WebView myWebView = (WebView) findViewById(R.id.webview);<br/>myWebView.loadUrl("http://shivsahni.com", headers);<br/></em><em class="np">--</em></span></pre><p id="39a7" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated"><em class="np">头</em>自变量<em class="np"> </em>是一个映射&lt;字符串，字符串&gt;具有头名称和相应的值。在调用加载web内容时，这些头被添加到请求中。</p><h1 id="2b04" class="mg mh it bd mi mj mk ml mm mn mo mp mq ki mr kj ms kl mt km mu ko mv kp mw mx bi translated">CVE-2021–21136:WebView中的政策执行不足</h1><p id="e598" class="pw-post-body-paragraph ld le it lf b lg nk kd li lj nl kg ll lm nm lo lp lq nn ls lt lu no lw lx ly im bi translated">该安全问题存在于重载版本的<em class="np"> loadUrl(String url，Map &lt; String，String&gt;additional httpheaders)</em>的实现中，它加载web内容并将<em class="np">additional httpheaders</em>HTTP头附加到请求。在这种情况下，它包含敏感数据，如身份验证令牌、共享机密等。它可能会泄露给第三方。</p><p id="7afd" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">当后端使用重定向来响应web内容加载(使用重载的loadUrl方法)时，就会发生这种情况。前端还会将报头附加到后续请求中，从而导致意外的数据泄漏。</p><p id="cc9c" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">以下截图来自<a class="ae og" href="https://developer.android.com/reference/android/webkit/WebView#loadUrl(java.lang.String,%20java.util.Map%3Cjava.lang.String,%20java.lang.String%3E)" rel="noopener ugc nofollow" target="_blank">谷歌文档</a>(在报告错误时拍摄)。这是一种误导，因为它提到为这个URL 发送报头<em class="np">，而实际行为是也向后续请求发送报头。</em></p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi oh"><img src="../Images/00448ced8ae10cebeac739c7ceba2cb9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mTFrS1p9GgjuiHdKiEU-wg.png"/></div></div></figure><h2 id="b764" class="mz mh it bd mi na nb dn mm nc nd dp mq lm ne nf ms lq ng nh mu lu ni nj mw iz bi translated">概念证明</h2><p id="a90f" class="pw-post-body-paragraph ld le it lf b lg nk kd li lj nl kg ll lm nm lo lp lq nn ls lt lu no lw lx ly im bi translated">我制作了一个Android应用程序来演示这个安全问题。该应用程序有一个Webview组件，它加载带有附加标题(授权)的网页。</p><pre class="ks kt ku kv gt nq nr ns nt aw nu bi"><span id="f7e7" class="mz mh it nr b gy nv nw l nx ny">Note: I have used <em class="np">shouldOverrideUrlLoading </em>in WebViewClient in order to allow Webview to control the redirects. </span><span id="9e43" class="mz mh it nr b gy of nw l nx ny">As per the Google Docs:</span><span id="df29" class="mz mh it nr b gy of nw l nx ny"><em class="np">Do not call WebView#loadUrl(String) with the request's URL and then return true. This unnecessarily cancels the current load and starts a new load with the same URL. </em><strong class="nr jd"><em class="np">The correct way to continue loading a given URL is to simply return false, without calling WebView#loadUrl(String)</em></strong><em class="np">.</em></span><span id="7253" class="mz mh it nr b gy of nw l nx ny">In case you are calling <em class="np">loadUrl</em> inside <em class="np">shouldOverrideUrlLoading</em>, you might not be leaking the sensitive data to third-party but you might be landing yourself into another security/privacy risk as this causes all renderer-initiated navigations (e.g. redirects, JS location changes, clicking on links, etc) to be converted into browser-initiated navigations.</span></pre><p id="b72f" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">以下代码片段显示了在Webview中加载web内容时如何传递auth数据</p><pre class="ks kt ku kv gt nq nr ns nt aw nu bi"><span id="38a5" class="mz mh it nr b gy nv nw l nx ny"><em class="np">Map&lt;String, String&gt; headers = new HashMap&lt;&gt;();<br/>headers.put("Authorization", auth);<br/>WebViewClient wc= new myWebClient();<br/>webView.setWebViewClient(wc);<br/>webView.loadUrl(URL, headers);</em></span></pre><p id="7049" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">对于这个概念验证代码，我使用Flask返回重定向响应。移动应用程序会收到一个HTTP-302响应，该响应会将应用程序重定向到https://google.com</p><pre class="ks kt ku kv gt nq nr ns nt aw nu bi"><span id="d97c" class="mz mh it nr b gy nv nw l nx ny"><em class="np">from flask import Flask,redirect<br/>import os<br/>app = Flask(__name__)</em></span><span id="a881" class="mz mh it nr b gy of nw l nx ny"><a class="ae og" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank"><em class="np">@app</em></a><em class="np">.route('/redirect')<br/>def hello_world():<br/>    return redirect("</em><a class="ae og" href="https://google.com" rel="noopener ugc nofollow" target="_blank"><em class="np">https://google.com</em></a><em class="np">", code=302)</em></span><span id="0a4f" class="mz mh it nr b gy of nw l nx ny"><em class="np">if __name__ == '__main__':<br/>    print "Hello World!"<br/>    port = int(os.environ.get('PORT', 5000))<br/>    app.run(debug=True,host='0.0.0.0')</em></span></pre><p id="787f" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">为了查看后台发生了什么，我将PoC移动应用程序连接到一个代理服务器。Burp Suite(Proxy)帮助我记录了所有的请求和响应。您可以很容易地观察到授权头也被发送到重定向请求(google.com)。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi oi"><img src="../Images/6f27ab7b38266d91526518315f07abb3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lC4ik1BzmiAFg_aH1x6d0Q.png"/></div></div><figcaption class="oj ok gj gh gi ol om bd b be z dk translated">原始请求</figcaption></figure><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi oi"><img src="../Images/f00982dec805fb32d198127466409f3b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F7xK5xfMj5W-vzL--QJhsg.png"/></div></div><figcaption class="oj ok gj gh gi ol om bd b be z dk translated">重定向请求</figcaption></figure><h1 id="dd26" class="mg mh it bd mi mj mk ml mm mn mo mp mq ki mr kj ms kl mt km mu ko mv kp mw mx bi translated">补救</h1><p id="d877" class="pw-post-body-paragraph ld le it lf b lg nk kd li lj nl kg ll lm nm lo lp lq nn ls lt lu no lw lx ly im bi translated">由于兼容性的考虑，谷歌花了很长时间来修复这个问题。安全问题在最新的铬版本中被修复。</p><h2 id="a36f" class="mz mh it bd mi na nb dn mm nc nd dp mq lm ne nf ms lq ng nh mu lu ni nj mw iz bi translated">你受影响了吗？</h2><p id="a0c9" class="pw-post-body-paragraph ld le it lf b lg nk kd li lj nl kg ll lm nm lo lp lq nn ls lt lu no lw lx ly im bi translated">如果您使用重载版本的<em class="np"> loadUrl </em>方法和附加的头来加载web内容并传递敏感数据，如身份验证令牌、共享机密(如API密钥)等。并期望重定向到第三方/不可信域的响应，那么您可能会有风险。您可能希望以以下方式对此做出回应:</p><ul class=""><li id="bad5" class="on oo it lf b lg lh lj lk lm op lq oq lu or ly os ot ou ov bi translated">如果您在额外的头参数中发送JWT，它们可能在过去已经与第三方共享，如果您有用户的长期JWT令牌，您必须使JWT令牌无效，以防止第三方在<a class="ae og" href="https://www.forbes.com/sites/kathleenchaykowski/2018/03/21/mark-zuckerberg-addresses-breach-of-trust-in-facebook-user-data-crisis/" rel="noopener ugc nofollow" target="_blank">违反信任</a>的情况下访问它们</li><li id="297b" class="on oo it lf b lg ow lj ox lm oy lq oz lu pa ly os ot ou ov bi translated">旋转秘密(API密钥等。)因为它们可能已经随着重定向无意中与第三方共享了。</li></ul><p id="142a" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">使用早于M88的版本的Android用户仍然容易受到攻击。建议用户必须立即更新Webview。</p></div></div>    
</body>
</html>