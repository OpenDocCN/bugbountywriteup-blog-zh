<html>
<head>
<title>HTB University CTF 2022 — Cloud — Enchanted</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">HTB大学CTF 2022-云-魔法</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/htb-university-ctf-2022-cloud-enchanted-2966780f13f5?source=collection_archive---------2-----------------------#2022-12-06">https://infosecwriteups.com/htb-university-ctf-2022-cloud-enchanted-2966780f13f5?source=collection_archive---------2-----------------------#2022-12-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="b6c3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">黑盒子大学CTF是一个伟大的CTF大学和世界各地的大学生。这些挑战代表了帮助您提高网络安全知识的真实世界场景。这篇文章主要关注Azure云枚举和开发。</p><h1 id="3e65" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">扫描打开的端口</h1><p id="2f3d" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">使用nmap扫描挑战中提供的IP地址。我们发现总共有5个港口开放。让我们列举运行在端口80上的web服务。</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi lo"><img src="../Images/ea625bf06ebb0b49d76c67b26b8f1749.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q0BzhVyvlB_erxRyo_TYEw.png"/></div></div></figure><h1 id="201a" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">枚举web服务</h1><p id="6129" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">分析客户端资源，我们可以说应用程序正在从Azure Blob获取某些资源。</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi ma"><img src="../Images/1e423f4b34e0b8c8bdf4bf19793bfd6f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cGooDyqOLnsRMKDPZgfnHg.png"/></div></div></figure><p id="b742" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Azure Blob可以在<a class="ae mb" href="http://enchanted.blob.core.windows.net:10000" rel="noopener ugc nofollow" target="_blank">http://enchanted.blob.core.windows.net:10000</a>访问。让我们打开/etc/hosts文件并在其中添加enchanted.blob.core.windows.net的<strong class="jp ir"/>。</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi mc"><img src="../Images/8e429b0f3069d007709833de9edf9e04.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GuGu3TGFeBmH0T7wn1F9Nw.png"/></div></div></figure><h1 id="056f" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">蓝色斑点开发</h1><p id="de5d" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">通过web枚举Azure blob是可能的。从上一节给出的截图中可以看到，我们可以看看一些参数，比如<strong class="jp ir"> se </strong>、<strong class="jp ir"> sp </strong>、<strong class="jp ir"> sv </strong>、<strong class="jp ir"> sr </strong>和<strong class="jp ir"> sig </strong>。这些参数组合在一起形成一个<strong class="jp ir"> sas_token </strong>，这是一种安全的方法，可以在不泄露帐户密钥的情况下授予对资源的有限访问权限。</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi md"><img src="../Images/c403bfff1c05efae193f95fe8ffaea48.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nbedirTtouEdXVfWRl_mnA.png"/></div></div></figure><p id="fa41" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这样，我们可以通过Web或SDK使用这个<strong class="jp ir"> sas_token </strong>来尝试访问或枚举Azure Blob中的一些其他资源。</p><h2 id="7a38" class="me km iq bd kn mf mg dn kr mh mi dp kv jy mj mk kz kc ml mm ld kg mn mo lh mp bi translated">枚举资源</h2><p id="290d" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">这里，容器名是<strong class="jp ir">魔法</strong>，我们可以访问<strong class="jp ir"> sas_token </strong>。要列出容器条目，我们可以访问下面给出的URL，</p><pre class="lp lq lr ls gt mq mr ms bn mt mu bi"><span id="7a32" class="mv km iq mr b be mw mx l my mz">http://enchanted.blob.core.windows.net:10000/enchanted?restype=container&amp;comp=list&amp;se=2420-01-01&amp;sp=rl&amp;sv=2021-06-08&amp;sr=c&amp;sig=pkZBtmnBrAd5UtKzsLNKq1XOUTOwpUcB2A%2B2jUa9UzI%3D</span></pre><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi na"><img src="../Images/56fe8baba1706a4f907fc1a5c7e3430f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X4RQEGCQ2UybWfwbosJt2A.png"/></div></div></figure><p id="1654" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> app.py </strong>文件看起来很有意思。我们可以通过访问下面给出的URL来访问它的内容，</p><pre class="lp lq lr ls gt mq mr ms bn mt mu bi"><span id="4504" class="mv km iq mr b be mw mx l my mz">http://enchanted.blob.core.windows.net:10000/enchanted/dev/app.py?se=2420-01-01&amp;sp=rl&amp;sv=2021-06-08&amp;sr=c&amp;sig=pkZBtmnBrAd5UtKzsLNKq1XOUTOwpUcB2A%2B2jUa9UzI%3D</span></pre><p id="7d8e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">访问URL后，<strong class="jp ir"> app.py </strong>文件应该会下载到您的本地机器中。</p><pre class="lp lq lr ls gt mq mr ms bn mt mu bi"><span id="f25f" class="mv km iq mr b be mw mx l my mz">from flask import *<br/><br/>dev = Flask(__name__)<br/><br/>@dev.route('/')<br/>def index():<br/>        return render_template('index.html')<br/><br/>@dev.route('/fetch')<br/>def fetch():<br/>        table_service = TableService(sas_token='se=2420-01-01&amp;sp=raud&amp;sv=2019-02-02&amp;tn=users&amp;sig=m9BmFvpbJBTug8psvW6RJo/FNLmReeLl8%2B4kH5bimCw%3D', protocol='http', endpoint_suffix='core.windows.net')<br/>        i=0<br/>        next_pk = None<br/>        next_rk = None<br/>        while True:<br/>            entities=table_service.query_entities('users',"PartitionKey eq 'Username'", next_partition_key = next_pk, next_row_key = next_rk, top=1000)<br/>            i+=1<br/>            for entity in entities:<br/>                return render_template('home.html',entities=entity.AddressLine1)<br/>            if hasattr(entities, 'x_ms_continuation'):<br/>                x_ms_continuation = getattr(entities, 'x_ms_continuation')<br/>                next_pk = x_ms_continuation['nextpartitionkey']<br/>                next_rk = x_ms_continuation['nextrowkey']<br/>            else:<br/>                break</span></pre><p id="d598" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该文件包含一些关于<strong class="jp ir">表服务</strong>和与之关联的<strong class="jp ir"> sas_token </strong>的信息。Azure Table storage是一种在云中存储非关系型结构化数据(也称为结构化NoSQL数据)的服务。</p><h1 id="b252" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">蓝色桌面开发</h1><p id="7e4e" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">Azure Table storage是一种在云中存储非关系型结构化数据(也称为结构化NoSQL数据)的服务，提供了一种无模式设计的键/属性存储。</p><p id="929e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">表服务运行在端口<strong class="jp ir"> <em class="nb"> 10002 </em> </strong>上，我们已经从源代码(之前下载的)中提取了<strong class="jp ir"> sas_token </strong>。使用目前收集的信息，我们可以通过Web或SDK枚举Azure表存储。</p><p id="fc7b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">参考:<a class="ae mb" href="https://learn.microsoft.com/en-us/rest/api/storageservices/query-entities" rel="noopener ugc nofollow" target="_blank">https://learn . Microsoft . com/en-us/rest/API/storage services/query-entities</a></p><p id="e9ce" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">还有一件事，我们需要在/etc/hosts文件中添加enchanted.table.core.windows.net的<strong class="jp ir">来访问表服务。</strong></p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi nc"><img src="../Images/7c775d6f1b5e0585b981f9ea4c978204.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MIRq6UXsuxXtbAMYWuzJOw.png"/></div></div></figure><h2 id="ae3a" class="me km iq bd kn mf mg dn kr mh mi dp kv jy mj mk kz kc ml mm ld kg mn mo lh mp bi translated">枚举用户表</h2><p id="ff99" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">要列出users表中的所有条目，我们可以访问下面给出的URL，</p><pre class="lp lq lr ls gt mq mr ms bn mt mu bi"><span id="773b" class="mv km iq mr b be mw mx l my mz">http://enchanted.blob.core.windows.net:10002/users?se=2420-01-01&amp;sp=raud&amp;sv=2019-02-02&amp;tn=users&amp;sig=m9BmFvpbJBTug8psvW6RJo/FNLmReeLl8%2B4kH5bimCw%3D</span></pre><p id="9ef7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们从之前下载的源代码中获得了<strong class="jp ir"> sas_token </strong>。在访问URL时，我们应该得到类似于<strong class="jp ir">atomformattonsupported</strong>的错误。</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi ca"><img src="../Images/d212f2f4e0b9e749caa36535b47ce231.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OGj7kz3pOGC62XXfqHCa8A.png"/></div></div></figure><p id="6817" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个错误可以通过将<strong class="jp ir"> Accept </strong>头替换为值<strong class="jp ir">application/JSON来修复；odata=nometadata" </strong></p><p id="b214" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">参考:<a class="ae mb" href="https://stackoverflow.com/questions/39463917/azure-table-service-rest-api-json-format-is-not-supported" rel="noopener ugc nofollow" target="_blank">https://stack overflow . com/questions/39463917/azure-table-service-rest-API-JSON-format-is-not-supported</a></p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi na"><img src="../Images/9e9bc02ca33606dc6eba9e8eb2482353.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QTEvZFb4paapwbEUCz3Exg.png"/></div></div></figure><p id="afb5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">感谢您花时间阅读我的文章:)</p><div class="nd ne gp gr nf ng"><a href="https://voker2311.github.io/" rel="noopener  ugc nofollow" target="_blank"><div class="nh ab fo"><div class="ni ab nj cl cj nk"><h2 class="bd ir gy z fp nl fr fs nm fu fw ip bi translated">主页</h2><div class="nn l"><h3 class="bd b gy z fp nl fr fs nm fu fw dk translated">网络安全分析师@Digisec360 CEH(实用)| CRTP |约格沙| Pentabug</h3></div><div class="no l"><p class="bd b dl z fp nl fr fs nm fu fw dk translated">voker2311.github.io</p></div></div><div class="np l"><div class="nq l nr ns nt np nu ly ng"/></div></div></a></div><div class="nd ne gp gr nf ng"><a href="https://twitter.com/v0k3r2311" rel="noopener  ugc nofollow" target="_blank"><div class="nh ab fo"><div class="ni ab nj cl cj nk"><h2 class="bd ir gy z fp nl fr fs nm fu fw ip bi translated">JavaScript不可用。</h2><div class="nn l"><h3 class="bd b gy z fp nl fr fs nm fu fw dk translated">编辑描述</h3></div><div class="no l"><p class="bd b dl z fp nl fr fs nm fu fw dk translated">twitter.com</p></div></div><div class="np l"><div class="nv l nr ns nt np nu ly ng"/></div></div></a></div><h2 id="839d" class="me km iq bd kn mf mg dn kr mh mi dp kv jy mj mk kz kc ml mm ld kg mn mo lh mp bi translated">来自Infosec的报道:Infosec每天都有很多内容，很难跟上。<a class="ae mb" href="https://weekly.infosecwriteups.com/" rel="noopener ugc nofollow" target="_blank">加入我们的每周简讯</a>以5篇文章、4个线程、3个视频、2个GitHub Repos和工具以及1个工作提醒的形式免费获取所有最新的Infosec趋势！</h2></div></div>    
</body>
</html>