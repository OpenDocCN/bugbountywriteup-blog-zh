<html>
<head>
<title>Exploiting PrintNightmare (CVE-2021–34527)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">利用印刷噩梦(CVE-2021–34527)</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/exploiting-printnightmare-cve-2021-34527-10c6e0f5b83f?source=collection_archive---------0-----------------------#2022-08-25">https://infosecwriteups.com/exploiting-printnightmare-cve-2021-34527-10c6e0f5b83f?source=collection_archive---------0-----------------------#2022-08-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/26fc960cb5be55e34414d01e94f94751.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GJ7UKXfaiUr31B21k8YKkw.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">Sebastiaan Stam的照片<a class="ae kc" href="https://www.pexels.com/photo/person-wearing-red-hoodie-1097456/" rel="noopener ugc nofollow" target="_blank"/></figcaption></figure><p id="949d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这篇文章提供了PrintNightmare漏洞的高级概述，并演示了针对Windows 2016服务器的成功利用。此外，我分享了我对漏洞利用代码的重新创作，它提供了一些在Linux主机上利用PrintNightmare时有用的更新。</p></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><h1 id="c2a8" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">弱点</h1><p id="de89" class="pw-post-body-paragraph kd ke iq kf b kg mg ki kj kk mh km kn ko mi kq kr ks mj ku kv kw mk ky kz la ij bi translated">“打印噩梦”(<a class="ae kc" href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527" rel="noopener ugc nofollow" target="_blank">CVE-2021–34527</a>)是Windows打印后台处理程序服务中存在的一个本地权限提升(LPE)和远程代码执行(RCE)漏洞。</p><p id="1896" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">PrintNightmare的工作原理是利用<code class="fe ml mm mn mo b">MS-RPRN</code>协议的<code class="fe ml mm mn mo b">RpcAddPrinterDriverEx</code>功能中的一个逻辑缺陷，该功能允许贫困用户定义他们自己的(<code class="fe ml mm mn mo b">.dll</code>)打印驱动程序。这些驱动程序最终由系统用户加载，让位于权限提升。</p><p id="2ed0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在PrintNightmare公开发布后不久，<a class="ae kc" href="https://twitter.com/cube0x0/status/1411364227089117185" rel="noopener ugc nofollow" target="_blank"> Cube0x0 </a>就能够通过<code class="fe ml mm mn mo b">MS-PAR</code>和<code class="fe ml mm mn mo b">RpcAsyncAddPrinterDriver</code>函数触发漏洞。这与<code class="fe ml mm mn mo b">RpcAddPrinterDriverEx</code>类似，但是约束要少得多，不局限于域控制器或者非默认设置的Windows 10系统。</p></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><h1 id="f4d0" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">剥削</h1><p id="7ba2" class="pw-post-body-paragraph kd ke iq kf b kg mg ki kj kk mh km kn ko mi kq kr ks mj ku kv kw mk ky kz la ij bi translated">鉴于这个漏洞已经存在一年多了，并且已经有几十个公开的例子，我认为发布我的漏洞利用版本是安全的——现在可以在<a class="ae kc" href="https://github.com/m8sec/CVE-2021-34527" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir"> GitHub </strong> </a>上获得。</p><p id="fd46" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我的代码基于由<a class="ae kc" href="https://github.com/cube0x0/CVE-2021-1675" rel="noopener ugc nofollow" target="_blank"> Cube0x0 </a>创建的Python漏洞，需要最新版本的<a class="ae kc" href="https://github.com/SecureAuthCorp/impacket" rel="noopener ugc nofollow" target="_blank"> Impacket </a>库。一些额外的好处包括:</p><ul class=""><li id="7e14" class="mp mq iq kf b kg kh kk kl ko mr ks ms kw mt la mu mv mw mx bi translated">能够定位多个主机、范围或子网。</li><li id="70b3" class="mp mq iq kf b kg my kk mz ko na ks nb kw nc la mu mv mw mx bi translated">用于有效负载交付的内置SMB服务器，消除了对开放文件共享的需求。按照命令行参数中的定义，仍然可以使用可选的远程共享。</li><li id="4e61" class="mp mq iq kf b kg my kk mz ko na ks nb kw nc la mu mv mw mx bi translated">漏洞利用包括两种<code class="fe ml mm mn mo b">MS-RPRN</code> &amp; <code class="fe ml mm mn mo b">MS-PAR</code>协议的选项。</li><li id="5057" class="mp mq iq kf b kg my kk mz ko na ks nb kw nc la mu mv mw mx bi translated">实现了<a class="ae kc" href="https://twitter.com/gentilkiwi" rel="noopener ugc nofollow" target="_blank">@ gentili kiwi的</a> <a class="ae kc" href="https://twitter.com/gentilkiwi/status/1412771368534528001" rel="noopener ugc nofollow" target="_blank"> UNC旁路</a>技术。</li></ul><h2 id="18f7" class="nd lj iq bd lk ne nf dn lo ng nh dp ls ko ni nj lw ks nk nl ma kw nm nn me no bi translated">要求</h2><p id="350a" class="pw-post-body-paragraph kd ke iq kf b kg mg ki kj kk mh km kn ko mi kq kr ks mj ku kv kw mk ky kz la ij bi translated">要成功利用PrintNightmare漏洞，必须满足以下要求:</p><ul class=""><li id="ab39" class="mp mq iq kf b kg kh kk kl ko mr ks ms kw mt la mu mv mw mx bi translated">启动有效登录会话的用户凭据。</li><li id="b294" class="mp mq iq kf b kg my kk mz ko na ks nb kw nc la mu mv mw mx bi translated">主机上启用了打印后台处理程序服务。</li></ul><h2 id="91b4" class="nd lj iq bd lk ne nf dn lo ng nh dp ls ko ni nj lw ks nk nl ma kw nm nn me no bi translated">发现</h2><p id="59dd" class="pw-post-body-paragraph kd ke iq kf b kg mg ki kj kk mh km kn ko mi kq kr ks mj ku kv kw mk ky kz la ij bi translated">Impacket的<code class="fe ml mm mn mo b">rpcdump</code>可用于测试<code class="fe ml mm mn mo b">MS-PAR</code>或<code class="fe ml mm mn mo b">MS-RPRN</code>协议:</p><figure class="nq nr ns nt gt jr gh gi paragraph-image"><div class="gh gi np"><img src="../Images/4ed5b5c572b71a25083b475b98ac9bd3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1152/format:webp/1*-9QVuMc7tZjubZBKpCoqVQ.png"/></div></figure><p id="6832" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">或者，<a class="ae kc" href="https://twitter.com/byt3bl33d3r" rel="noopener ugc nofollow" target="_blank"> byt3bl33d3r </a>发布了一个扫描器<a class="ae kc" href="https://github.com/byt3bl33d3r/ItWasAllADream" rel="noopener ugc nofollow" target="_blank">itwasalladdream</a>，它提供了一个漏洞利用的“去尖牙”版本来测试服务器的响应。</p><h2 id="a22b" class="nd lj iq bd lk ne nf dn lo ng nh dp ls ko ni nj lw ks nk nl ma kw nm nn me no bi translated">演示</h2><p id="a801" class="pw-post-body-paragraph kd ke iq kf b kg mg ki kj kk mh km kn ko mi kq kr ks mj ku kv kw mk ky kz la ij bi translated">下面演示了如何通过MS-RPRN协议在Windows Server 2016系统上从Kali Linux主机成功利用PrintNightmare。</p><figure class="nq nr ns nt gt jr"><div class="bz fp l di"><div class="nu nv l"/></div></figure></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><h1 id="b3a4" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">补救</h1><p id="b3e1" class="pw-post-body-paragraph kd ke iq kf b kg mg ki kj kk mh km kn ko mi kq kr ks mj ku kv kw mk ky kz la ij bi translated">微软已经发布了几个与PrintNightmare相关的补丁，最新的是2021年9月的补丁星期二。这解决了潜在的漏洞和后来发现的变通办法。更多信息，请访问微软官方<a class="ae kc" href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527" rel="noopener ugc nofollow" target="_blank">指南</a>。</p><p id="bf02" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">缓解此漏洞的其他<a class="ae kc" href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527#workarounds" rel="noopener ugc nofollow" target="_blank">策略</a>包括:</p><ul class=""><li id="b5f2" class="mp mq iq kf b kg kh kk kl ko mr ks ms kw mt la mu mv mw mx bi translated">在不重要的系统上禁用后台打印程序服务。</li><li id="444b" class="mp mq iq kf b kg my kk mz ko na ks nb kw nc la mu mv mw mx bi translated">通过组策略禁用入站远程打印</li></ul></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><p id="512c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">感谢阅读！在<a class="ae kc" href="https://m8sec.dev" rel="noopener ugc nofollow" target="_blank"> m8sec.dev </a>了解更多关于我的信息，并关注更多攻击性安全内容。</p><p id="1c1e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="nw">免责声明:所有内容仅用于教育目的。作者不对信息的使用负责。不要对你不拥有或没有明确许可的系统进行测试。</em></p></div></div>    
</body>
</html>