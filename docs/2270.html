<html>
<head>
<title>Server Side Template Injections By Hashar Mujahid.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">服务器端模板注入。</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/server-side-template-injections-by-hashar-mujahid-e5a1a383027e?source=collection_archive---------1-----------------------#2022-08-12">https://infosecwriteups.com/server-side-template-injections-by-hashar-mujahid-e5a1a383027e?source=collection_archive---------1-----------------------#2022-08-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="9232" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这篇博客中，我们将通过解决Portswiggers实验室来了解什么是服务器端模板注入以及它们是如何工作的。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/d802125414686024437e1cf508a8e335.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Cqj9YCQBnfhGLgdqLvIlvw.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">服务器端模板注入。</figcaption></figure><p id="dc6a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">什么是模板引擎？</strong></p><p id="5f12" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">由于模板引擎，您可以在应用程序中使用静态模板文件。模板引擎在运行时用实际值替换模板文件中的变量，并将模板转换成提供给客户端的HTML文件。这种方法使得创建HTML页面变得很容易。</p><p id="957e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">尽管模板是静态分布的，但是高度灵活的服务(SaaS)的发展导致了各种模板库在互联网上的直接暴露。这些看似不起眼的库比一些开发人员想象的要强大得多。</p><p id="aec9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">什么是SSTI？</strong></p><p id="bb04" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当攻击者能够将恶意有效负载注入模板，然后在服务器端执行时，就会发生服务器端模板注入。</p><p id="8374" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">例如:让我们假设一个大规模地为用户生成完成证书的LMS。开发人员可以使用一个模板，通过一个变量提供每个用户的名字，然后打印在证书上，而不是为每个用户生成整个证书。可以把它想象成一个<strong class="jp ir">填充空格</strong>，其中数据通过变量传递。如果攻击者可以插入恶意的有效载荷而不是用户名，并且它以某种方式在服务器端执行，将会产生灾难性的后果。</p><p id="854d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">SSTI的影响？</strong></p><p id="8083" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">成功的服务器端模板注入漏洞的后果往往是灾难性的，导致<strong class="jp ir">远程代码执行通过获得对后端服务器</strong>的完全控制。即使没有执行任何代码，攻击者也可能<strong class="jp ir">能够访问服务器</strong>上的敏感数据。</p><p id="33ec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">剥削:</strong></p><p id="ef56" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">服务器端模板注入的开发分为五个步骤。</p><ul class=""><li id="ddbe" class="lb lc iq jp b jq jr ju jv jy ld kc le kg lf kk lg lh li lj bi translated"><strong class="jp ir">检测</strong>易受SSTI攻击的端点。</li><li id="427e" class="lb lc iq jp b jq lk ju ll jy lm kc ln kg lo kk lg lh li lj bi translated"><strong class="jp ir">识别</strong>正在使用的模板引擎。这可能是Twig，Jinja2，樱井真子等。</li><li id="95d5" class="lb lc iq jp b jq lk ju ll jy lm kc ln kg lo kk lg lh li lj bi translated"><strong class="jp ir">开拓</strong>、<strong class="jp ir">探索</strong>和<strong class="jp ir">进攻</strong>是一个三步走的活动，经常重复，需要很大的决心，通过反复试验来完成。</li></ul><p id="f7a2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在说够了…让我们把手弄脏吧。</p><p id="e6a1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">实验1: <a class="ae lp" href="https://portswigger.net/web-security/server-side-template-injection/exploiting/lab-server-side-template-injection-basic" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir">基础服务器端模板注入</strong> </a></p><p id="d29e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">目标:由于ERB模板的不安全构造，该实验室容易受到<a class="ae lp" href="https://portswigger.net/web-security/server-side-template-injection" rel="noopener ugc nofollow" target="_blank">服务器端模板注入</a>的攻击。要解决这个问题，请查阅ERB文档，了解如何执行任意代码，然后从Carlos的主目录中删除<code class="fe lq lr ls lt b">morale.txt</code>文件。</p><p id="37d7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们进入实验室。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lu"><img src="../Images/734ec4cfd4a8204d45f789e7dcf47ff9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q-RSu3x8NJl0NV2A4jIqOg.png"/></div></div></figure><p id="4ce0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">网上商店的主页欢迎我们。</p><p id="80e8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在第一步:找到一个易受攻击的端点。点击我发现，当我们点击“查看详细信息”按钮时，web应用程序会将我们重定向到主页，并在页面上显示一个消息参数“很遗憾，此产品已缺货”。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lv"><img src="../Images/55d257ae37cd49cd7d2dcbd7b9d06952.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OtUGKi13Z2ir2GEb41OOnw.png"/></div></div></figure><p id="42b5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">任何对owasp 10有所了解的人都会尝试将一个XSS有效载荷。这就是我所做的，当然我们得到了它。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lu"><img src="../Images/6e594f1de708793d347328463fd74bbf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mieD3Nen9KwyNpcaf6Prdg.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk">🤣</figcaption></figure><p id="5768" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是我们也必须用SSTI的有效载荷来测试它。</p><p id="e8a8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，只需将带有消息参数的请求发送给入侵者，并用下面给出的有效载荷进行狙击。</p><pre class="km kn ko kp gt lw lt lx ly aw lz bi"><span id="1022" class="ma mb iq lt b gy mc md l me mf">{{7*7}}<br/>${7*7}<br/>&lt;%= 7*7 %&gt;<br/>${{7*7}}<br/>#{7*7}</span></pre><p id="f881" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">攻击完成后，分析服务器的响应。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mg"><img src="../Images/81141982e926dd9dc7f0bbb9c1cf2180.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zMlUncfLRj15wdbnQ9IxJw.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">入侵者攻击</figcaption></figure><p id="4121" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以看到<code class="fe lq lr ls lt b">&lt;%= 7*7 %&gt;</code>执行成功。</p><p id="aec0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们知道这是一个ERB模板引擎，所以让我们阅读文档，并尝试找到如何在服务器上执行任意代码。</p><p id="0fa2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">列出方法:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mh"><img src="../Images/fb950e1a9161aae7e9bf07e9ebd21fbd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xJPDWTtk9sKnwJZ1uONDcg.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">方法</figcaption></figure><pre class="km kn ko kp gt lw lt lx ly aw lz bi"><span id="e158" class="ma mb iq lt b gy mc md l me mf">&lt;%= self.methods %&gt;</span></pre><p id="56b8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">用instance.eval()方法尝试了很多方法之后。我在互联网上找到了一个命令系统，它执行代码就像PHP中的系统命令一样。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mi"><img src="../Images/4115d0a677a8608110821942fa762bf4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U6fgVwrRR6rWDCZt7iFdKA.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">/etc/passwd</figcaption></figure><pre class="km kn ko kp gt lw lt lx ly aw lz bi"><span id="201f" class="ma mb iq lt b gy mc md l me mf">&lt;%= system('cat /etc/passwd') %&gt;</span></pre><p id="4502" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们有RCE在系统上，让我们完成我们的目标</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lu"><img src="../Images/9746c7deccfcbcf540d8ae8651627ae3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Qob29lewiVr-ydPCaLhmog.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">限位开关（Limit Switch）</figcaption></figure><p id="23cf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">还是删了吧。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mj"><img src="../Images/a5fb9563db2fa0bf4d1522325462f492.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X0NQOKpoqj6u3Cj6AlBbAA.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">士气. txt</figcaption></figure><pre class="km kn ko kp gt lw lt lx ly aw lz bi"><span id="b189" class="ma mb iq lt b gy mc md l me mf">&lt;%= system('rm morale.txt') %&gt;</span></pre><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lu"><img src="../Images/861efe446e2aeeb24ee76e9e46089de8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MhzdvnIPukYYkn9pUX7apg.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">完成</figcaption></figure><p id="b940" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以看到我们已经成功完成了实验。</p><p id="f8e1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我会每天发布一个新的实验室。</p><p id="32f3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">敬请关注。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mk ml l"/></div></figure></div><div class="ab cl mm mn hu mo" role="separator"><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr"/></div><div class="ij ik il im in"><p id="0f9f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mt">来自Infosec的报道:Infosec上每天都有很多事情发生，很难跟上。</em> <a class="ae lp" href="https://weekly.infosecwriteups.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir"> <em class="mt">加入我们的每周简讯</em> </strong> </a> <em class="mt">以5篇文章、4个线程、3个视频、2个Github Repos和工具以及1个工作提醒的形式免费获取所有最新的Infosec趋势！</em></p></div></div>    
</body>
</html>