<html>
<head>
<title>AWS IAM explained for Red and Blue teams</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我为红队和蓝队解释了AWS</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/aws-iam-explained-for-red-and-blue-teams-2dda8b20fbf7?source=collection_archive---------0-----------------------#2020-09-24">https://infosecwriteups.com/aws-iam-explained-for-red-and-blue-teams-2dda8b20fbf7?source=collection_archive---------0-----------------------#2020-09-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><h1 id="f82e" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">介绍</h1><p id="fb71" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">当我开始进入AWS pentesting时，最难完全理解的事情之一是IAM。AWS文档通常很棒，但也可能很广泛，IAM也有很多类似的术语。您有用户、角色、组、受管策略、内联策略、实例角色等… <br/>本文将尝试阐明这个主题，以及用不同工具列举这些信息的一些方法。</p><p id="c26f" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated"><strong class="kn ir">警告:这篇文章将只包含理论，我将在下周发表一篇关于这方面的实际例子，但在“有趣”之前，你需要这方面的知识。</strong></p><p id="82f1" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">稍后编辑:<a class="ae lo" href="https://medium.com/@securityshenaningans/exploiting-fine-grained-aws-iam-permissions-for-total-cloud-compromise-a-real-world-example-part-5a2f3de4be08" rel="noopener">这是我提到的</a>的实际例子的链接</p><h1 id="ecdf" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">理论</h1><p id="e668" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">AWS将IAM定义为一种安全管理AWS服务和资源访问的方式。这都归结于权限。IAM是管理访问您的云资源的权限的一种方式。<strong class="kn ir">这些权限被分配给实体。实体是你可以分配权限给</strong>的东西。IAM中有3个可能的实体:</p><ul class=""><li id="38d4" class="lp lq iq kn b ko lj ks lk kw lr la ls le lt li lu lv lw lx bi translated">用户</li><li id="255d" class="lp lq iq kn b ko ly ks lz kw ma la mb le mc li lu lv lw lx bi translated">组</li><li id="66d6" class="lp lq iq kn b ko ly ks lz kw ma la mb le mc li lu lv lw lx bi translated">角色。</li></ul><p id="492a" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated"><strong class="kn ir">用户是与AWS交互的人或服务的代表。</strong></p><p id="8454" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated"><strong class="kn ir">群组是IAM用户的集合。</strong></p><p id="2fa6" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">这两个概念都相当直观，并且类似于在其他环境(如Active Directory)中发现的概念。</p><p id="83b0" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated"><strong class="kn ir">角色类似于用户，因为它是具有权限策略的身份，权限策略决定了身份在AWS中可以做什么和不可以做什么。</strong> <strong class="kn ir">然而，一个角色没有任何与之相关联的凭证(密码或访问密钥)</strong>。角色不是只与一个人相关联，而是旨在被任何需要它的人所接受。(来源:<a class="ae lo" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id.html" rel="noopener ugc nofollow" target="_blank">https://docs.aws.amazon.com/IAM/latest/UserGuide/id.html</a>)</p><p id="0d84" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">这些定义大多来自AWS的官方文档。但是这里有点复杂。<strong class="kn ir">您通过策略向实体分配权限。</strong>政策有两种形式:</p><ul class=""><li id="0adc" class="lp lq iq kn b ko lj ks lk kw lr la ls le lt li lu lv lw lx bi translated">托管策略</li><li id="06f7" class="lp lq iq kn b ko ly ks lz kw ma la mb le mc li lu lv lw lx bi translated">内联策略(将其视为不受管理的策略)</li></ul><p id="5821" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">它们之间的区别在于<strong class="kn ir">托管策略是独立的策略，由它们自己定义。它们不与任何特定实体相关联，并且可以附加到多个实体。</strong></p><p id="da29" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated"><strong class="kn ir">内嵌策略(或非托管策略)是嵌入在IAM身份(用户、组或角色)中的策略。政策是身份的固有部分。它不能分配给任何其他实体。</strong>把它们想象成一个实体的特定属性。</p><p id="d3fd" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">相比内联策略，建议使用托管策略，因为它们更易于管理和审核。您可以让一千个用户使用相同的托管策略，策略的一个更改会影响所有用户。您只需审核一个策略。如果您对每个用户都有内联策略，您将不得不审核1000个不同的策略，而且您没有办法一次修改所有的策略。</p><p id="9970" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">还有一个需要注意的区别。托管策略也可以分为两类:</p><ul class=""><li id="f11d" class="lp lq iq kn b ko lj ks lk kw lr la ls le lt li lu lv lw lx bi translated">托管策略(为了消除歧义，我们称之为AWS托管策略)</li><li id="0bce" class="lp lq iq kn b ko ly ks lz kw ma la mb le mc li lu lv lw lx bi translated">客户管理的策略</li></ul><p id="6db6" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">区别很简单。受管策略由AWS管理。它们定义了您可能需要的常见角色，并且您不能修改它们。</p><p id="4274" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">客户管理的策略是客户创建和管理的策略。您可以定义自定义策略，以适应您的特定需求。</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi md"><img src="../Images/329cf092e8ba21f0f76a32a116ab5399.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sND8yM8ZYEazdgSfkajDPA.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">亚马逊AWS托管策略</figcaption></figure><p id="aa85" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">您可以进行的另一个区分是:</p><ul class=""><li id="eb58" class="lp lq iq kn b ko lj ks lk kw lr la ls le lt li lu lv lw lx bi translated">基于身份的策略</li><li id="67a2" class="lp lq iq kn b ko ly ks lz kw ma la mb le mc li lu lv lw lx bi translated">基于资源的政策</li></ul><p id="e044" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">还记得我之前说过，实体是可以分配策略的事物吗？嗯，这有点不完整。身份是您可以向其分配基于身份的策略的事物。它们被分配给用户、组和角色。</p><p id="a54a" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">还有一种策略叫做基于资源的策略，只能分配给资源。想想AWS服务(S3桶、SQS队列等)..).此外，EC2实例。每当您拥有需要特定权限才能完成任务的资源时，您都可以使用基于资源的策略。</p><p id="c5a5" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">有一件事你需要知道，这非常重要。可以通过基于资源的策略(直接附加)以及通过角色授予资源权限。在开始时，我说过角色可以由任何需要的人担任。这也包括实例和AWS服务(<a class="ae lo" href="https://docs.amazonaws.cn/en_us/IAM/latest/UserGuide/id_roles_compare-resource-policies.html" rel="noopener ugc nofollow" target="_blank">https://docs . amazonaws . cn/en _ us/IAM/latest/user guide/id _ roles _ compare-resource-policies . html</a>)。</p><p id="ccd9" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">你问为什么这些知识很重要？嗯，在AWS环境中，旋转访问最常见的方式之一是劫持实例角色。</p><p id="659a" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">每当您希望实例拥有某些权限时，您可以授予它承担特定角色的权限。这称为实例角色。一个实例只能应用一个角色，但是可以有多个实例具有相同的角色。与该角色相关联的临时凭证保存在所谓的实例元数据中。您可以从实例内部访问此元数据，方法是向</p><pre class="me mf mg mh gt mt mu mv mw aw mx bi"><span id="fb9a" class="my jo iq mu b gy mz na l nb nc">curl <a class="ae lo" href="http://169.254.169.254/latest/meta-data/iam/security-credentials/scripts-role" rel="noopener ugc nofollow" target="_blank">http://169.254.169.254/latest/meta-data/iam/security-credentials/role-name</a></span></pre><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi nd"><img src="../Images/b1c4ac8cd1399324583f200197afbcf6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-cEmFY9Rcc1CaaW2FWu7gw.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">访问实例角色凭据</figcaption></figure><p id="93d1" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">该请求可以由实例中的任何用户执行。如果实例角色具有与其相关联的高特权，任何有权访问该实例的用户都可以劫持它。在下一个故事中，我将通过一个真实的例子来展示这一点。</p><p id="78d0" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">这也为利用开放重定向/ SSRF漏洞开辟了新的途径。如果在实例中找到一个角色，可以请求它的元数据并劫持该角色。</p><p id="21ab" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">使用<a class="ae lo" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/configuring-instance-metadata-service.html" rel="noopener ugc nofollow" target="_blank">元数据服务V2</a>可以防止大多数涉及元数据的利用，但我们很少看到这一功能的实现(如果你想知道这是如何工作的，我推荐这篇文章:<a class="ae lo" href="https://blog.artis3nal.com/2019-11-23-aws-instance-metadata-v2-announcement/" rel="noopener ugc nofollow" target="_blank">https://blog . artis 3 nal . com/2019-11-23-AWS-instance-Metadata-v2-announcement/</a>)</p><p id="630e" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">假设您可以获得一个AccessKey、一个SecretAccessKey和一个ExpirationToken，您会想要枚举您的可用权限并找到一种方法来保持访问，因为此凭据有一个到期日期(如您在图片中所见)，并且有可能不会续订。默认情况下这个时间是一个小时，所以你最好快点！我发现最好的工具是enumerate-iam . py(【https://github.com/andresriancho/enumerate-iam】T4)。您可以像这样使用它(会话令牌是可选的)</p><pre class="me mf mg mh gt mt mu mv mw aw mx bi"><span id="b72b" class="my jo iq mu b gy mz na l nb nc">enumerate-iam.py --access-key "ACCESSKEY" --secret-key "SECRETKEY" (--session-token "$AWS_SESSION_TOKEN")</span></pre><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi ne"><img src="../Images/60036569453540d4546298dc1aec8d43.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fOLlPKBeR5hY70-Z8oUBlg.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">enumerate-iam.py</figcaption></figure><h1 id="1497" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">IAM枚举工具</h1><p id="a86e" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">现在我们已经了解了IAM的大部分是如何工作的，我们可以开始学习如何枚举它。我们必须采取不同的方式:</p><h2 id="7d4c" class="my jo iq bd jp nf ng dn jt nh ni dp jx kw nj nk kb la nl nm kf le nn no kj np bi translated">GUI枚举</h2><p id="1bbb" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">如果你喜欢使用图形用户界面，你可以使用cs-suite(<a class="ae lo" href="https://github.com/SecurityFTW/cs-suite" rel="noopener ugc nofollow" target="_blank">https://github.com/SecurityFTW/cs-suite</a>)。这将其他几个工具组合起来执行全面的审计。你也可以使用ScoutSuite，它是cs-suite使用的工具之一scout2的继任者(<a class="ae lo" href="https://github.com/nccgroup/ScoutSuite" rel="noopener ugc nofollow" target="_blank">https://github.com/nccgroup/ScoutSuite</a>)。</p><p id="3ee8" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">我通常像这样通过docker运行它:</p><pre class="me mf mg mh gt mt mu mv mw aw mx bi"><span id="4d45" class="my jo iq mu b gy mz na l nb nc">cd /tmp<br/>mkdir .aws</span><span id="88a1" class="my jo iq mu b gy nq na l nb nc">cat &gt; .aws/config &lt;&lt;EOF<br/>[default]<br/>output = json<br/>region = us-east-1<br/>EOF</span><span id="c535" class="my jo iq mu b gy nq na l nb nc">cat &gt; .aws/credentials &lt;&lt;EOF<br/>[default]<br/>aws_access_key_id = XXXXXXXXXXXXXXX<br/>aws_secret_access_key = XXXXXXXXXXXXXXXXXXXXXXXXX<br/>EOF</span><span id="d8d9" class="my jo iq mu b gy nq na l nb nc">docker run -v `pwd`/.aws:/root/.aws -v `pwd`/reports:/app/reports securityftw/cs-suite -env aws</span></pre><p id="6c45" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">运行完成后，您将在/tmp/reports中获得一个图形报告。</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi nr"><img src="../Images/c00d10ec2bd6ddf916ace9efdf1ac153.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X9ozR34wEKev7fae15QOOQ.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">生成的报告显示了它使用的工具。</figcaption></figure><p id="9426" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">这将向您显示许多有用的信息，包括公共攻击面、一般不安全的权限和薄弱的配置。它还将为您提供所有云资源的摘要。</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi ns"><img src="../Images/86d0b3f3eb7ecefb8b6b0181d0828e93.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nCe1-qRmX65pJMJt56DQUA.png"/></div></div></figure><p id="8590" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">这种方法适合希望强化其基础设施的蓝队。我个人觉得红队有点吵。这类似于使用漏洞扫描器。当然，Nessus可能会发现许多Nmap无法发现的东西，但它也会提醒方圆一百英里内的每个SOC注意你的存在。在进行红队评估时，我通常更喜欢通过CLI进行手动枚举。</p><h2 id="c1e3" class="my jo iq bd jp nf ng dn jt nh ni dp jx kw nj nk kb la nl nm kf le nn no kj np bi translated">CLI枚举</h2><p id="4fc7" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">这种方法减少了日志中的活动，但是您必须自己关联信息。您可以从cs-suite中获得的大多数东西都可以从awscli中手动获得。在故事的开始，我花时间解释了角色和策略的区别，因为您将需要不同的命令来查询它们。</p><p id="568f" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">我通常做的枚举过程是</p><ol class=""><li id="e478" class="lp lq iq kn b ko lj ks lk kw lr la ls le lt li nt lv lw lx bi translated">定义我们将要使用的个人资料。</li></ol><p id="62d9" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">要防止在每个命令中键入您的凭据，您可以:</p><pre class="me mf mg mh gt mt mu mv mw aw mx bi"><span id="aff2" class="my jo iq mu b gy mz na l nb nc">aws configure --profile test </span></pre><p id="7d46" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">粘贴凭证后，您将能够使用配置文件标志运行以下所有命令。这也使得同时处理多个概要文件更加容易。</p><p id="d7c4" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated"><strong class="kn ir"> 2。让我们的用户可以使用托管策略。</strong></p><p id="232a" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">要获得每个策略的详细信息，您需要策略版本和策略arn。您可以通过以下方式获取适用于您的个人资料的策略的arn:</p><pre class="me mf mg mh gt mt mu mv mw aw mx bi"><span id="62ee" class="my jo iq mu b gy mz na l nb nc">aws --profile "$profile" iam list-policies | jq -r ".Policies[].Arn"</span></pre><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi nu"><img src="../Images/336a2fd750fc3551146634d0cf05f8e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*t3AT0qjoGx9pkGkAPkCvjQ.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">获取警方的亚马逊资源名称。</figcaption></figure><p id="2a41" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">您可以通过以下方式获得特定的策略版本</p><pre class="me mf mg mh gt mt mu mv mw aw mx bi"><span id="1b32" class="my jo iq mu b gy mz na l nb nc">aws --profile "$profile" iam get-policy --policy-arn "$i" --query "Policy.DefaultVersionId" --output text</span></pre><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi nv"><img src="../Images/8ddd11ae684f9f6b68ce2c2d0cc1c795.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gp95FPP-mZCnZMHn3GDQxg.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">获取策略的版本</figcaption></figure><p id="ed8c" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">您可以将这两个命令组合在一起，以获得所有相关的配置:</p><pre class="me mf mg mh gt mt mu mv mw aw mx bi"><span id="bff0" class="my jo iq mu b gy mz na l nb nc">profile="test"; for i in $(aws --profile "$profile" iam list-policies | jq -r '.Policies[].Arn'); do echo "Describing policy $i" &amp;&amp; aws --profile "$profile" iam get-policy-version --policy-arn "$i" --version-id $(aws --profile "$profile" iam get-policy --policy-arn "$i" --query 'Policy.DefaultVersionId' --output text); done | tee /tmp/policies.log</span></pre><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi nw"><img src="../Images/9250514f1c26e69cf2aff846643d8040.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jCSw8yW--52xrKzdfB8eUw.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">枚举所有策略</figcaption></figure><p id="cf0f" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">如您所见，每个策略由一个效果(允许/拒绝)+动作(您希望执行什么操作)+资源(受操作影响的资源的ARN)组成。您也可以选择关联一个条件。</p><p id="0372" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">你应该寻找这样的东西:</p><pre class="me mf mg mh gt mt mu mv mw aw mx bi"><span id="10f4" class="my jo iq mu b gy mz na l nb nc">Describing policy arn:aws:iam::aws:policy/AdministratorAccess<br/>{<br/>    "PolicyVersion": {<br/>        "Document": {<br/>            "Version": "2012-10-17",<br/>            "Statement": [<br/>                {<br/>                    "Effect": "Allow",<br/>                    "Action": "*",<br/>                    "Resource": "*"<br/>                }<br/>            ]<br/>        },<br/>        "VersionId": "v1",<br/>        "IsDefaultVersion": true,<br/>        "CreateDate": "2015-02-06T18:39:46Z"<br/>    }<br/>}</span></pre><p id="ec27" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">这个策略允许您对任何资源做任何事情。完全访问。</p><p id="3743" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated"><strong class="kn ir"> 3。查看哪些实体附加了有趣的策略。</strong></p><p id="0a1a" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">这应该让您知道应该瞄准哪些用户/组/角色。您可以使用以下命令枚举<strong class="kn ir">托管策略</strong>的分配</p><pre class="me mf mg mh gt mt mu mv mw aw mx bi"><span id="06b9" class="my jo iq mu b gy mz na l nb nc">#List Managed User policies<br/>aws --profile "test" iam list-attached-user-policies --user-name "test-user"</span><span id="b130" class="my jo iq mu b gy nq na l nb nc">#List Managed Group policies<br/>aws --profile "test" iam list-attached-group-policies --group-name "test-group"</span><span id="9892" class="my jo iq mu b gy nq na l nb nc">#List Managed Role policies<br/>aws --profile "test" iam list-attached-role-policies --role-name "test-role"</span></pre><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi nx"><img src="../Images/5833486c49abeebb45dbffc0d21fdbb6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N6oy8MFs2uVcidX2fxzEPg.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">托管角色策略的枚举。</figcaption></figure><p id="ea18" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">您还可以使用命令来枚举<strong class="kn ir">内联策略</strong>。你可以用</p><pre class="me mf mg mh gt mt mu mv mw aw mx bi"><span id="0550" class="my jo iq mu b gy mz na l nb nc">#List Inline User policies<br/>aws --profile "test" iam list-user-policies --user-name "test-user"</span><span id="eae5" class="my jo iq mu b gy nq na l nb nc">#List Inline Group policies<br/>aws --profile "test" iam list-group-policies --group-name "test-group"</span><span id="3a4a" class="my jo iq mu b gy nq na l nb nc">#List Inline Role policies<br/>aws --profile "test" iam list-role-policies --role-name "test-role"</span></pre><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi ny"><img src="../Images/3487076495344122bd8793a7b8f0b13b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EhH3Escm9LhCudrV7gzObA.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">内联用户策略的枚举。</figcaption></figure><p id="76ab" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">最后，要获得内联策略的详细信息，您可以:</p><pre class="me mf mg mh gt mt mu mv mw aw mx bi"><span id="cf6d" class="my jo iq mu b gy mz na l nb nc">#Describe Inline User policies <br/>aws --profile "test" iam get-user-policy --user-name "test-user" --policy-name "test-policy"</span><span id="afcc" class="my jo iq mu b gy nq na l nb nc">#Describe Inline Group policies<br/>aws --profile "test" iam get-group-policy --group-name "test-group" --policy-name "test-policy"</span><span id="d3ca" class="my jo iq mu b gy nq na l nb nc">#Describe Inline Role policies<br/>aws --profile "test" iam get-role-policy --role-name "test-role" --policy-name "test-policy"</span></pre><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi nz"><img src="../Images/cd801235401510721b29d8f12d14c472.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lVBxEaEYq7BZFfs3OG3YeQ.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">授予对所有资源的完全访问权限的内联用户策略的情况。你应该瞄准这个用户。</figcaption></figure><h2 id="7460" class="my jo iq bd jp nf ng dn jt nh ni dp jx kw nj nk kb la nl nm kf le nn no kj np bi translated">信任关系</h2><p id="85b6" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">还有一件事你需要知道。当角色被创建时，它们有一个特性叫做<strong class="kn ir">信任关系</strong>。在名为<strong class="kn ir">承担角色策略</strong>的JSON文档中，信任关系指定谁可以承担该角色。</p><p id="a6de" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">一个承担角色策略看起来像这样。</p><pre class="me mf mg mh gt mt mu mv mw aw mx bi"><span id="9c37" class="my jo iq mu b gy mz na l nb nc">"AssumeRolePolicyDocument": {<br/>            "Version": "2012-10-17",<br/>            "Statement": [<br/>                {<br/>                    "Effect": "Allow",<br/>                    "Principal": {<br/>                        "Service": "ec2.amazonaws.com"<br/>                    },<br/>                    "Action": "sts:AssumeRole"<br/>                }<br/>            ]<br/>        }</span></pre><p id="0cf9" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">您可以使用以下命令手动查询与特定角色关联的承担角色策略:</p><pre class="me mf mg mh gt mt mu mv mw aw mx bi"><span id="5f5b" class="my jo iq mu b gy mz na l nb nc">aws --profile "test" iam get-role --role-name "test-role"</span></pre><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi oa"><img src="../Images/eb06206ce9f292d2b37e1becf3e85285.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vGCPRhMAxxdgLCM3oLrRdA.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">查询承担角色策略。你可以在“AssumeRolePolicyDocument”下看到它</figcaption></figure><p id="9747" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">该示例假定角色策略允许任何ec2资源承担该角色。我应该做一个澄清。这并不意味着您可以承担任何ec2实例的角色。您仍然需要一个管理员来</p><p id="78ef" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">1.创建一个实例概要文件<br/> 2。将角色与实例概要文件<br/> 3相关联。将实例配置文件与要使用的特定实例相关联</p><p id="8742" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">假设已经创建了角色，并且已经附加了感兴趣的策略，那么执行这3个步骤需要运行的命令是:</p><pre class="me mf mg mh gt mt mu mv mw aw mx bi"><span id="9813" class="my jo iq mu b gy mz na l nb nc">aws iam create-instance-profile --instance-profile-name YourNewRole-Instance-Profile</span><span id="d4c6" class="my jo iq mu b gy nq na l nb nc">aws iam add-role-to-instance-profile --role-name YourNewRole<strong class="mu ir"> </strong>--instance-profile-name YourNewRole-Instance-Profile</span><span id="32e6" class="my jo iq mu b gy nq na l nb nc">aws ec2 associate-iam-instance-profile --instance-id YourInstanceId --iam-instance-profile Name=YourNewRole-Instance-Profile</span></pre><p id="ab75" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">(更多信息请访问<a class="ae lo" href="https://aws.amazon.com/blogs/security/new-attach-an-aws-iam-role-to-an-existing-amazon-ec2-instance-by-using-the-aws-cli/" rel="noopener ugc nofollow" target="_blank">https://AWS . Amazon . com/blogs/security/new-attach-an-AWS-iam-role-to-an-existing-Amazon-ec2-instance-by-using-the-AWS-CLI/？sc _ channel = sm&amp;sc _ campaign = rolesforrunninginstances&amp;sc _ publisher = tw&amp;sc _ medium = social&amp;sc _ content = read-post&amp;sc _ country = global&amp;sc _ geo = global&amp;sc _ category = ec2&amp;sc _ outcome = launch</a></p><p id="4809" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">有一件事我无法从aws cli中完成，那就是列出承担特定角色的每个资源。如果您有权访问某个实例，您可以看到它在中承担的角色</p><pre class="me mf mg mh gt mt mu mv mw aw mx bi"><span id="1139" class="my jo iq mu b gy mz na l nb nc">aws --profile test sts get-caller-identity</span></pre><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi ob"><img src="../Images/bbf26a3232a3c02cc0a05c9df3a31b3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9eJGsY_h8AqB9iJwTfL4DA.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">查询假定角色</figcaption></figure><p id="f104" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">您还可以看到实例元数据卷曲的角色:</p><pre class="me mf mg mh gt mt mu mv mw aw mx bi"><span id="0985" class="my jo iq mu b gy mz na l nb nc">curl <a class="ae lo" href="http://169.254.169.254/latest/meta-data/iam/security-credentials/" rel="noopener ugc nofollow" target="_blank">http://169.254.169.254/latest/meta-data/iam/security-credentials/</a></span></pre><h1 id="3fce" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">结论</h1><p id="097a" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">这是一篇冗长的文章。如果它变得有点乏味，我很抱歉，但是我无法找到大多数IAM特性的简明解释，或者手动枚举的命令参考。</p><p id="44fd" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">如果您想要AWS pentesting的额外资料，我想推荐3个资源。这三篇文章都是由Rinho Labs的人写的，Rinho Labs是AWS pentesting研究的先驱。</p><p id="bd59" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">首先，这篇文章涵盖了21种权限提升方法，写得非常棒:<a class="ae lo" href="https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/" rel="noopener ugc nofollow" target="_blank">https://rhinosecuritylabs . com/AWS/AWS-privilege-escalation-methods-mitigation/</a></p><p id="1077" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">第二个资源实际上是一个名为Pacu的AWS开发框架，我可能会写另一个关于它的故事。这是我发现的最好的工具之一。<a class="ae lo" href="https://github.com/RhinoSecurityLabs/pacu" rel="noopener ugc nofollow" target="_blank">https://github.com/RhinoSecurityLabs/pacu</a></p><p id="20ad" class="pw-post-body-paragraph kl km iq kn b ko lj kq kr ks lk ku kv kw ll ky kz la lm lc ld le ln lg lh li ij bi translated">最后，有一本关于AWS Pentesting的很棒的书，叫做《Kali Linux下的AWS渗透测试实践》(https://www.amazon.com/-/es/Karl-Gilbert/dp/1789136725)，作者是Karl Gilbert和Benjamin cau dill(Pacu的开发者之一)。我经常用这本书来温习评估中可能出现的某些话题。</p></div></div>    
</body>
</html>