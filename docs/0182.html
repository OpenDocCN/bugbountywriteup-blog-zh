<html>
<head>
<title>DevOops — An XML External Entity (XXE) HackTheBox Walkthrough</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">DevOops —一个XML外部实体(XXE) HackTheBox演练</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/devoops-an-xml-external-entity-xxe-hackthebox-walkthrough-fb5ba03aaaa2?source=collection_archive---------0-----------------------#2018-10-14">https://infosecwriteups.com/devoops-an-xml-external-entity-xxe-hackthebox-walkthrough-fb5ba03aaaa2?source=collection_archive---------0-----------------------#2018-10-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/c00f79d88b6c0380e5fa85c0b54e1842.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*kbPmjNYaIAWaqrqFKi_mCw.gif"/></div></div></figure><h1 id="9ab5" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">摘要</h1><p id="daa2" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">DevOops是一个运行web服务的Linux主机，其文件上传容易受到<a class="ae lu" href="https://www.owasp.org/index.php/XML_External_Entity_(XXE)_Processing" rel="noopener ugc nofollow" target="_blank"> XML外部实体处理</a>的攻击。这被用来访问系统上的文件，以便枚举用户、读取bash历史和检索SSH密钥。通过从用户的bash历史记录中找到根SSH密钥，可以在主机上获得根shell。</p><h1 id="a416" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">侦察</h1><p id="db78" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">我开始在这台主机上进行侦察，通过<code class="fe lv lw lx ly b">nmap</code>扫描检查服务版本，并在前1000个最常见的端口上运行默认脚本:</p><pre class="lz ma mb mc gt md ly me mf aw mg bi"><span id="329f" class="mh jz iq ly b gy mi mj l mk ml">nmap -sV -sC 10.10.10.91</span></pre><figure class="lz ma mb mc gt jr"><div class="bz fp l di"><div class="mm mn l"/></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">nmap</figcaption></figure><p id="9362" class="pw-post-body-paragraph kw kx iq ky b kz ms lb lc ld mt lf lg lh mu lj lk ll mv ln lo lp mw lr ls lt ij bi translated">这返回了两个服务:端口22上的SSH和端口5000上的HTTP。接下来，我决定用<code class="fe lv lw lx ly b">gobuster</code>枚举web服务以返回额外的web目录:</p><pre class="lz ma mb mc gt md ly me mf aw mg bi"><span id="b44b" class="mh jz iq ly b gy mi mj l mk ml">gobuster -u <a class="ae lu" href="http://10.10.10.91:5000" rel="noopener ugc nofollow" target="_blank">http://10.10.10.91:5000</a> -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt</span></pre><blockquote class="mx my mz"><p id="44ce" class="kw kx na ky b kz ms lb lc ld mt lf lg nb mu lj lk nc mv ln lo nd mw lr ls lt ij bi translated"><code class="fe lv lw lx ly b">-u</code>指定网址<br/>指定单词列表<code class="fe lv lw lx ly b">-w</code></p></blockquote><figure class="lz ma mb mc gt jr"><div class="bz fp l di"><div class="mm mn l"/></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">gobuster</figcaption></figure><p id="30be" class="pw-post-body-paragraph kw kx iq ky b kz ms lb lc ld mt lf lg lh mu lj lk ll mv ln lo lp mw lr ls lt ij bi translated">这返回了一个<code class="fe lv lw lx ly b">/upload</code>目录。这个页面很有趣，因为它规定上传的文件必须是XML格式，并且包含三个特定的元素:Autor、Subject和Content。</p><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ne"><img src="../Images/d441fadb3e8ac68ea7df22a0de46be8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*phDQGIGX-df-_2tnaw60Jw.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">/上传</figcaption></figure><h1 id="fdba" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">最初的立足点</h1><p id="02d7" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">经过一点研究(大声喊出来<a class="ae lu" href="https://www.owasp.org/index.php/XML_External_Entity_(XXE)_Processing" rel="noopener ugc nofollow" target="_blank"> OWASP </a>和<a class="ae lu" href="https://www.w3schools.com/xml/xml_dtd.asp" rel="noopener ugc nofollow" target="_blank"> w3schools </a>，我能够构造一个有效的XML文档，它利用了XML外部实体处理(XXE)。XXE利用弱配置的XML解析器来访问本地或远程内容。这种攻击在2017年发布的OWASP十大攻击中排名第四。外部实体可通过文件URI处理程序、内部文件共享、内部端口扫描、远程代码执行和拒绝服务攻击来泄露内部文件。</p><p id="b87b" class="pw-post-body-paragraph kw kx iq ky b kz ms lb lc ld mt lf lg lh mu lj lk ll mv ln lo lp mw lr ls lt ij bi translated">我的XML模板如下所示:</p><figure class="lz ma mb mc gt jr"><div class="bz fp l di"><div class="mm mn l"/></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">XML模板</figcaption></figure><p id="cad0" class="pw-post-body-paragraph kw kx iq ky b kz ms lb lc ld mt lf lg lh mu lj lk ll mv ln lo lp mw lr ls lt ij bi translated">当这个文件上传到主机时，我被重定向到服务器上呈现的文件。因为我在<code class="fe lv lw lx ly b">Content</code>字段中将<code class="fe lv lw lx ly b">/etc/passwd</code>作为XML实体引用，所以这个文件也被加载到网页上。</p><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nf"><img src="../Images/2a3649eb7d495adc2ae9c33b4ccba13b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QvIpR3fXPH6n3-jffmLE1g.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">凌乱|格式化</figcaption></figure><p id="1520" class="pw-post-body-paragraph kw kx iq ky b kz ms lb lc ld mt lf lg lh mu lj lk ll mv ln lo lp mw lr ls lt ij bi translated">处理像这样返回“非预期”数据的web漏洞的一个非常方便的技巧是查看页面源，而不是“呈现”的页面。这对于其他信息泄露攻击是有用的，例如本地文件包含等。换行符有时只能在<code class="fe lv lw lx ly b">view-source:</code>页面中处理。</p><p id="c16a" class="pw-post-body-paragraph kw kx iq ky b kz ms lb lc ld mt lf lg lh mu lj lk ll mv ln lo lp mw lr ls lt ij bi translated">现在我有了一个<code class="fe lv lw lx ly b">/etc/passwd</code>的副本，我能够返回一个包含有效登录shells的用户列表:</p><pre class="lz ma mb mc gt md ly me mf aw mg bi"><span id="1a47" class="mh jz iq ly b gy mi mj l mk ml">grep -v “nologin\|false\|sync” passwd</span></pre><p id="56b7" class="pw-post-body-paragraph kw kx iq ky b kz ms lb lc ld mt lf lg lh mu lj lk ll mv ln lo lp mw lr ls lt ij bi translated">该命令删除了<code class="fe lv lw lx ly b">/etc/passwd</code>中包含<code class="fe lv lw lx ly b">/bin/false</code>、<code class="fe lv lw lx ly b">/bin/sync</code>和<code class="fe lv lw lx ly b">/usr/sbin/nologin</code>的行，这些行不是交互式shells。此命令返回了以下用户:</p><figure class="lz ma mb mc gt jr"><div class="bz fp l di"><div class="mm mn l"/></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">用户</figcaption></figure><p id="50d2" class="pw-post-body-paragraph kw kx iq ky b kz ms lb lc ld mt lf lg lh mu lj lk ll mv ln lo lp mw lr ls lt ij bi translated">这绝对缩小了范围！因此，现在我们有3个用户需要关注——如果我们考虑到可能需要将权限提升到<code class="fe lv lw lx ly b">root</code>的话，还有2个。</p><h1 id="7c39" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">本地枚举</h1><p id="8e46" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">这个主机上的初始立足点和本地枚举步骤相互渗透，因为我能够从XXE漏洞中获得大量有价值的信息。我开始在用户的主目录中寻找我能找到的所有文件。我甚至不用上箱子就能拿到<code class="fe lv lw lx ly b">user.txt</code>旗！</p><figure class="lz ma mb mc gt jr"><div class="bz fp l di"><div class="mm mn l"/></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">user.txt</figcaption></figure><p id="e17b" class="pw-post-body-paragraph kw kx iq ky b kz ms lb lc ld mt lf lg lh mu lj lk ll mv ln lo lp mw lr ls lt ij bi translated">我可以使用下面的XML文档获取<code class="fe lv lw lx ly b">roosa</code>帐户的bash历史记录:</p><figure class="lz ma mb mc gt jr"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="442e" class="pw-post-body-paragraph kw kx iq ky b kz ms lb lc ld mt lf lg lh mu lj lk ll mv ln lo lp mw lr ls lt ij bi translated">这返回了一个非常长的命令历史，其中包含了一个有趣的<code class="fe lv lw lx ly b">authcredentials.key</code>片段:</p><figure class="lz ma mb mc gt jr"><div class="bz fp l di"><div class="mm mn l"/></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">authcredentials.key</figcaption></figure><p id="93f4" class="pw-post-body-paragraph kw kx iq ky b kz ms lb lc ld mt lf lg lh mu lj lk ll mv ln lo lp mw lr ls lt ij bi translated">我不知道这个文件的完整路径，所以无法检索到那个密钥。然而，我能够从<code class="fe lv lw lx ly b">roosa</code>的主目录中获取一个SSH密钥，这使我能够在主机上进行本地访问。</p><figure class="lz ma mb mc gt jr"><div class="bz fp l di"><div class="mm mn l"/></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">SSH密钥XML</figcaption></figure><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ng"><img src="../Images/cb1259d219e41e6ba5a2033c1e57320c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hVeJUmYpcLGkirNCE16SWQ.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">SSH密钥</figcaption></figure><h1 id="3a80" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">权限提升</h1><p id="6e83" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">这是一个非常简单的权限提升，因为我已经通过XXE攻击在主机上做了大量的枚举。我使用SSH密钥登录主机:</p><pre class="lz ma mb mc gt md ly me mf aw mg bi"><span id="8a14" class="mh jz iq ly b gy mi mj l mk ml">ssh -i roosa.key roosa@10.10.10.91</span></pre><p id="1390" class="pw-post-body-paragraph kw kx iq ky b kz ms lb lc ld mt lf lg lh mu lj lk ll mv ln lo lp mw lr ls lt ij bi translated">从那里我找到了<code class="fe lv lw lx ly b">authcredentials.key</code>文件，使用:</p><pre class="lz ma mb mc gt md ly me mf aw mg bi"><span id="f2cb" class="mh jz iq ly b gy mi mj l mk ml">locate authcredentials.key</span></pre><p id="b816" class="pw-post-body-paragraph kw kx iq ky b kz ms lb lc ld mt lf lg lh mu lj lk ll mv ln lo lp mw lr ls lt ij bi translated">这返回了两个相同的文件，只有<code class="fe lv lw lx ly b">roosa</code>有读写权限:</p><pre class="lz ma mb mc gt md ly me mf aw mg bi"><span id="1ae7" class="mh jz iq ly b gy mi mj l mk ml">/home/roosa/deploy/resources/integration/authcredentials.key</span><span id="be3e" class="mh jz iq ly b gy nh mj l mk ml">/home/roosa/work/blogfeed/resources/integration/authcredentials.key</span></pre><p id="391c" class="pw-post-body-paragraph kw kx iq ky b kz ms lb lc ld mt lf lg lh mu lj lk ll mv ln lo lp mw lr ls lt ij bi translated">这些文件包含一个RSA私钥，可用于以根用户身份访问机器。</p><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ni"><img src="../Images/0ab6188157f9700d29f29d5f2b1d225a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pUF_beVafaulwibHYonkuw.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">根</figcaption></figure></div></div>    
</body>
</html>