<html>
<head>
<title>NahamCon CTF 2022 Write-up: Click Me! Android challenge</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">NahamCon CTF 2022报道:点击我！安卓挑战</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/nahamcon-ctf-2022-write-up-click-me-android-challenge-63ccba7cb663?source=collection_archive---------0-----------------------#2022-05-01">https://infosecwriteups.com/nahamcon-ctf-2022-write-up-click-me-android-challenge-63ccba7cb663?source=collection_archive---------0-----------------------#2022-05-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/c39867596ce7c11e64dbb12bd6419f2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oXRZ2wO0Q5Jjhw5kAjKqFA.png"/></div></div></figure><p id="33b6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">约翰·哈蒙德 &amp;很少有其他人在这个周末举办CTF。我解决了Android挑战，这些挑战真的很有趣。我决定写下这个。</p><p id="ad7e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">挑战</strong></p><figure class="ky kz la lb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi kx"><img src="../Images/b344e57525a165b24eb257a0a163dfc2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mtgKyMjKmz7_NsdiwgNlvw.png"/></div></div></figure><p id="7cb2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们下载并运行<strong class="ka ir"> click_me.apk </strong></p><figure class="ky kz la lb gt jr gh gi paragraph-image"><div class="gh gi lc"><img src="../Images/2c249af4dfc5e7a24908a948cac0ec0b.png" data-original-src="https://miro.medium.com/v2/resize:fit:698/format:webp/1*p3TgCWPNq5scNP8Td0QgWg.png"/></div></figure><p id="8225" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们看到了这个屏幕，让我们单击GET FLAG按钮看看会发生什么。</p><figure class="ky kz la lb gt jr gh gi paragraph-image"><div class="gh gi ld"><img src="../Images/b25822e679a6ba09472feaee2f45daa6.png" data-original-src="https://miro.medium.com/v2/resize:fit:688/format:webp/1*YpatLNIJE0tl1NjmQleW8A.png"/></div></figure><p id="3d67" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">吐司上写着“你没有足够的饼干拿到旗子”。现在的问题是如何获得足够的饼干？</p><p id="e479" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要回答这个问题，我们需要看看代码。</p><p id="51ba" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们用<a class="ae kw" href="https://github.com/skylot/jadx" rel="noopener ugc nofollow" target="_blank"> Jadx-GUI </a>打开这个应用程序，并导航到com . example . click me . main activity</p><figure class="ky kz la lb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi le"><img src="../Images/850e01c09122d7c85f231056d992bfea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4xIdaWaZhEVJmLatwwwG5A.png"/></div></div></figure><p id="584d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">主要活动</strong>有两个我们感兴趣的功能。</p><p id="74d6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">有趣的函数#1: getFlagButtonClick() </strong></p><figure class="ky kz la lb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lf"><img src="../Images/780eabc291bcf36e4258c72d6cd6b2f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mkPfiCK03oBorOZCQ-QIeQ.png"/></div></div></figure><p id="0298" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">根据这个功能，我们需要点击按钮99999999次，以获得标志，否则我们会看到这条消息“你没有足够的cookies来获得标志”。</p><p id="7c38" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">有趣的函数#2: cookieViewClick() </strong></p><figure class="ky kz la lb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lg"><img src="../Images/c5013fad812f6fd8002804b5ddf9e471.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d4ZHSiSu4c7rHvfzB6ADNw.png"/></div></div></figure><p id="2a27" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，该函数正在计算点击<strong class="ka ir">获取标志</strong>按钮的次数。但是如果我们看一下if条件，它不会让我们超过来自1337133号的点击次数。一旦我们点击超过13371337次，它将重置回13371337。</p><p id="2f50" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，这是一个永无止境的条件，即使有人决定坐下来点击按钮几个小时！</p><p id="beba" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当然，我们不会去那里。有什么简单的方法？</p><p id="57c2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，可能有多种方法来解决这个挑战。使用<a class="ae kw" href="https://frida.re/" rel="noopener ugc nofollow" target="_blank"> FRIDA </a>脚本或修改<a class="ae kw" href="https://stackoverflow.com/questions/30837450/what-is-smali-code-android" rel="noopener ugc nofollow" target="_blank"> smali代码</a>。</p><p id="8678" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这次我选择玩smali代码。</p><p id="041e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果我们看看主活动的简单表示，它看起来像这样。</p><figure class="ky kz la lb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lh"><img src="../Images/9a3b2881700e770700d4604f4ca86ae6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6PQ5Pydktp1mVBMVKxQgZQ.png"/></div></div></figure><p id="967d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们的目标仍然是这段代码中的<strong class="ka ir"> getFlagButtonClick() </strong>方法。</p><figure class="ky kz la lb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi li"><img src="../Images/5d5e75ec3afc0efaff7f8cd72fde61de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wHtKxjSGG2NHuMD2BxndMQ.png"/></div></div></figure><p id="3464" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">回到<strong class="ka ir"> getFlagButtonClick() </strong>方法的java表示。</p><figure class="ky kz la lb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lf"><img src="../Images/780eabc291bcf36e4258c72d6cd6b2f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mkPfiCK03oBorOZCQ-QIeQ.png"/></div></div></figure><p id="baea" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">If-condition表示按钮点击次数应该等于99999999，以打印标志或“您没有足够的cookies”将显示消息。</p><p id="c04f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从技术上来说，可以从上述代码中的任何地方调用<strong class="ka ir"> getFlag() </strong>方法。如果我们将<strong class="ka ir"> getFlag() </strong>方法放在“您不…”消息的位置会怎么样？只要两者都是字符串，就不会有问题。</p><p id="90de" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">像这样..</p><figure class="ky kz la lb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lj"><img src="../Images/0c4c4c9a76f54e2bebfad8656317e0ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5IBY87S7gzAzSKdONN64tg.png"/></div></div></figure><p id="2090" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，每次都将打印该标志，而不检查任何条件。</p><p id="b1e7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是我们不能在java中这样做，所以我们需要在smali代码中进行精确的修改。要修改smali代码，我们必须使用APKTOOL反编译应用程序。</p><figure class="ky kz la lb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lk"><img src="../Images/885a4d5d0331f27e59527d81671c5d73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jGPALHvYpI2CIHnyQl_LSA.png"/></div></div></figure><p id="8dcb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们打开MainActivity.smali并理解下面几行。</p><figure class="ky kz la lb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ll"><img src="../Images/c68dd966a129295f2d693d0c67726d44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FMlro1xAlzZHvqS8eU2G5A.png"/></div></div></figure><pre class="ky kz la lb gt lm ln lo lp aw lq bi"><span id="b500" class="lr ls iq ln b gy lt lu l lv lw">const-string p1, “You do not have enough cookies to get the flag”</span></pre><p id="65e1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这一行表示p1寄存器有字符串“你没有…”</p><pre class="ky kz la lb gt lm ln lo lp aw lq bi"><span id="fbbc" class="lr ls iq ln b gy lt lu l lv lw">invoke-static {p0, p1, v0}, Landroid/widget/Toast;-&gt;makeText(Landroid/content/Context;Ljava/lang/CharSequence;I)Landroid/widget/Toast;</span></pre><p id="4528" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">上面一行将显示保存在p1寄存器中的值。</p><p id="e21c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们的目标是用getFlag()方法的结果替换p1寄存器的值。</p><p id="8c5e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将添加下面一行来调用getFlag()方法。</p><pre class="ky kz la lb gt lm ln lo lp aw lq bi"><span id="c811" class="lr ls iq ln b gy lt lu l lv lw">invoke-virtual {p0}, Lcom/example/clickme/MainActivity;-&gt;getFlag()Ljava/lang/String;</span></pre><p id="4d34" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们将getFlag()方法的输出存储到p1寄存器中。</p><pre class="ky kz la lb gt lm ln lo lp aw lq bi"><span id="b96b" class="lr ls iq ln b gy lt lu l lv lw">move-result-object p1</span></pre><p id="81a7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后，我们需要注释将预定义消息添加到p1寄存器的那一行。</p><pre class="ky kz la lb gt lm ln lo lp aw lq bi"><span id="3aea" class="lr ls iq ln b gy lt lu l lv lw"># const-string p1, “You do not have enough cookies to get the flag”</span></pre><p id="754a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">修改后的代码将如下所示..</p><figure class="ky kz la lb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lx"><img src="../Images/9ff66a8d3eef59490a64a2e1d0c6d9cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vyLJ_MExtFjhvEuIGyf1XQ.png"/></div></div></figure><p id="9cd7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">更改完成后，让我们重新构建apk。</p><figure class="ky kz la lb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ly"><img src="../Images/fb4d75e98035a5d26d9fed9e9234e669.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZsCOHU1fNOaMSPriQOhHFA.png"/></div></div></figure><p id="5003" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">该应用程序需要重新签名，然后我们才能安装它。</p><figure class="ky kz la lb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lz"><img src="../Images/b696993bd26b7031c5489c0a965ac2f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YAeZnfqcAKesm5c4i8ZWBw.png"/></div></div></figure><p id="0020" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">安装和运行修改后的应用程序。</p><p id="2aa4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">` adb安装c.apk '</p><figure class="ky kz la lb gt jr gh gi paragraph-image"><div class="gh gi lc"><img src="../Images/2c249af4dfc5e7a24908a948cac0ec0b.png" data-original-src="https://miro.medium.com/v2/resize:fit:698/format:webp/1*p3TgCWPNq5scNP8Td0QgWg.png"/></div></figure><p id="d871" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">只要我们点击获取标志按钮，而不是消息，我们的标志将会显示。</p><figure class="ky kz la lb gt jr gh gi paragraph-image"><div class="gh gi ma"><img src="../Images/1a373b55fc9e2708cd5ad39001eb5c15.png" data-original-src="https://miro.medium.com/v2/resize:fit:692/format:webp/1*GOgxcc19vCeSULHM6K4E9A.png"/></div></figure><h2 id="02e6" class="lr ls iq bd mb mc md dn me mf mg dp mh kj mi mj mk kn ml mm mn kr mo mp mq mr bi translated">挑战解决了！</h2><p id="6788" class="pw-post-body-paragraph jy jz iq ka b kb ms kd ke kf mt kh ki kj mu kl km kn mv kp kq kr mw kt ku kv ij bi translated">我喜欢写这篇文章，我希望你也喜欢阅读它。</p><p id="1f1b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">保持安全，快乐黑客:-) </strong></p><p id="2e43" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">推特:<a class="ae kw" href="https://twitter.com/jaimin_gohel" rel="noopener ugc nofollow" target="_blank">@ jaimin _ gohel</a><br/>LinkedIn:<a class="ae kw" href="https://www.linkedin.com/in/jaimin-gohel-440a4a52" rel="noopener ugc nofollow" target="_blank">@ jaimin-gohel-440 a4 a52</a></p></div></div>    
</body>
</html>