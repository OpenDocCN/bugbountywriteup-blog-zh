<html>
<head>
<title>TryHackMe. Exploiting EternalBlue Vulnerability.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">TryHackMe。利用永恒之蓝漏洞。</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/tryhackme-exploiting-eternalblue-vulnerability-24fed2799540?source=collection_archive---------1-----------------------#2020-07-19">https://infosecwriteups.com/tryhackme-exploiting-eternalblue-vulnerability-24fed2799540?source=collection_archive---------1-----------------------#2020-07-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="e62e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">TryHackMe EternalBlue机器演练。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/4c1e599fe2b8a1cc97840bafe3eb9e9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ElTdK2Oyxcdit-g18BiShg.png"/></div></div></figure><ol class=""><li id="6f75" class="kx ky iq jp b jq jr ju jv jy kz kc la kg lb kk lc ld le lf bi translated">侦察</li></ol><p id="08e6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在处理任何机器之前，我喜欢使用两个Nmap扫描:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lg"><img src="../Images/c33985debad4476b4d5d787711303748.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5gkR4gtmvcKMfcgOzBotQw.png"/></div></div></figure><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lh"><img src="../Images/7ef5260c583bf0982e822d4d0c5a9513.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VBhQZWIQzC2YCEEwtzcT8Q.png"/></div></div></figure><p id="0e61" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第一次扫描中的所有开关都可以简单地替换为<strong class="jp ir">-一个</strong>开关，但有时提醒自己那个开关是做什么的也是好的。</p><p id="4dab" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第二个运行Nmap脚本引擎的vuln类别中包含的所有扫描，并可能显示目标机器的一些漏洞。</p><p id="ecb1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们观察第一次扫描的结果:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi li"><img src="../Images/9373b74db80bc3941ddd2275225104e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KOJk77iVHk3m0HqpWj2HKQ.png"/></div></div></figure><p id="33ba" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以清楚的看到目标机的OS是Windows 7专业版。操作系统检测的一个小技巧只是一个常规的ping。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lj"><img src="../Images/adcd16f36569f8a002b122381661588d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qOdbSgNK__JdgBmHNNFFuA.png"/></div></div></figure><p id="4827" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这里，我们可以看到TTL是127，这意味着受害者机器具有Windows操作系统(TTL=128是Windows的默认设置)。对于基于UNIX的系统，默认TTL是64。</p><p id="2bb1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">回到神经元特异性烯醇化酶外阴扫描。它显示了可能被利用的不同漏洞。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lk"><img src="../Images/eb2e488dd3c2511b5a08eadd24d0116b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dnvlTOEhh1WQQYvvjwqq7A.png"/></div></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk translated">MS12–020，CVSS 4.3(中)和9.3(高)。</figcaption></figure><p id="8bc4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">去看看CVEs和微软的公告是一个基本的做法，以了解漏洞是什么。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lp"><img src="../Images/c7eb0fe842062fee1d2c68ec358ae8d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rc60VlTpiarzUdZn4ZdUfg.png"/></div></div></figure><p id="0d75" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后一个截图展示了我们感兴趣的漏洞。要了解更多信息，请在微软网站的安全公告部分查找MS17–010漏洞。</p><p id="901c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Nmap vuln扫描显示安装在目标上的SMBv1易受EternalBlue漏洞攻击。如果扫描输出显示公共SMB端口打开(139，445)，最好运行一些基本的Nmap SMB脚本来查看系统中是否存在潜在漏洞。我们可以通过发出以下命令来做到这一点:nmap -script=smb* <target-host>。</target-host></p><p id="6f91" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">smb末尾的星号将运行Nmap脚本引擎提供的所有SMB相关脚本。</p><p id="9075" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最终，它将运行所有这些脚本。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lq"><img src="../Images/5cd7cebff48d791f7c858fca87786488.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*95pOuqv30Fr8qtkS90Dnpw.png"/></div></div></figure><p id="2b6b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.获得访问</p><p id="4c55" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将使用Metasploit框架进行进一步的黑客攻击！</p><p id="7d42" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"># <strong class="jp ir"> msfconsole </strong> —启动Metasploit</p><p id="753c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">启动后，我们可以输入是否</p><p id="63aa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> &gt;搜索ms17–010</strong></p><p id="f4dc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">或者</p><p id="677a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> &gt;搜索永恒之蓝</strong></p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lr"><img src="../Images/59520257ecb84c4e3b6f6782f03c6127.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XFGKPJ1As2i_KkeiM8FDAA.png"/></div></div></figure><p id="793a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们对eternalblue模块感兴趣，所以让我们选择使用<strong class="jp ir">命令:</strong></p><p id="643f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> &gt;使用exploit/windows/SMB/ms17 _ 010 _ eternal blue</strong></p><p id="e317" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">或者</p><p id="e0dd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> &gt;使用3 </strong> —我们可以只使用漏洞的数量</p><p id="11ce" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">另外，以“exploit/”开头的模块是真正的漏洞，而以“auxiliary/”开头的模块将检查机器是否容易受到该漏洞的攻击。</p><p id="00be" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当模块命令行打开时，我们通常会检查可用选项:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ls"><img src="../Images/59068fd4f4aabfe8f0a259e9f07c215f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HiTVOYb_nQls805BDUdLjw.png"/></div></div></figure><p id="ae07" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这种情况下，<strong class="jp ir">只设置</strong>带有受害者IP地址的RHOSTS选项就足够了。</p><p id="174a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一切就绪后，键入<strong class="jp ir">运行</strong>或<strong class="jp ir">利用</strong>。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lt"><img src="../Images/b33cefded395f8075071268fcbb31cb0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OBi5g3uoAPQpL6O3IuLNGQ.png"/></div></div></figure><p id="5b22" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是受害者的外壳。</p><p id="6bbb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从这一点来说，用Meterpreter升级我们的shell是一个非常好的做法。</p><p id="e9c0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是首先，我们需要使用<strong class="jp ir"> Ctrl+z </strong>快捷键或<strong class="jp ir"> background </strong>命令为我们的shell设置背景。</p><p id="7c45" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这样做之后，我们可以用<strong class="jp ir"> show sessions </strong>命令检查哪些会话是打开的:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lu"><img src="../Images/5e93ab8dd189927575f16e2d0c0e075c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MBqdUKeFaCSgmZtTsc1zow.png"/></div></div></figure><p id="4c34" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要返回到那个会话，我们可以键入<strong class="jp ir"> sessions -i 1 </strong>。</p><p id="dc27" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">3.逐步升级</p><p id="5337" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有两种方法可以将我们的Windows shell升级到Meterpreter:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lv"><img src="../Images/a8d29aa23a23c692141e12d77c981dad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ExJ6AfAi2ATWCfye8UEYhA.png"/></div></div></figure><p id="9fc4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">或者</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lw"><img src="../Images/c3210f8ca6553ea7635b06f0f36d3cd3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xCntAEf30JpR-MOxvvC0xA.png"/></div></div></figure><p id="780c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第一个选项非常简单:我们搜索模块并使用它。</p><p id="cb5b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第二个选项做同样的事情(将shell升级到meterpreter)，但是它更短。</p><p id="209d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要查看我们是否已经升级了Windows shell，让我们键入show sessions:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lx"><img src="../Images/edd8eb7f19d1d33cfaac5ee41a47db74.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vW3UVsrzMijqRd6cGIobtg.png"/></div></div></figure><p id="bb24" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下一步是流程迁移。</p><p id="2eeb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当我们在受害者机器上使用meterpreter shell时，我们正在创建一个进程。为了将我们在机器上的行为隐藏在具有潜在高特权的合法进程下，我们可以将我们的进程迁移到系统的进程中。</p><p id="5ff9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，我们使用<strong class="jp ir"> ps </strong>命令来显示系统上的进程。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ly"><img src="../Images/e647e33ac93685ade962522765e25ee5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C5KoyAxpfYB8ZGBl_EpD8w.png"/></div></div></figure><p id="eb95" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后我们<strong class="jp ir">将</strong>迁移到一个使用PID的服务器上。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lz"><img src="../Images/f3ef61f03813db6b757d9f0931037c9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jniSxROMGR8ZhmM9b3QeQg.png"/></div></div></figure><p id="3da6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">4.破裂</p><p id="0226" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如我们所知，Windows操作系统在安全帐户管理器(SAM)中保存用户名和密码的哈希，所以让我们使用Meterpreter的<strong class="jp ir"> hashdump </strong>实用程序来转储这些哈希。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ma"><img src="../Images/0a37dc09631137f4429452ec4b415627.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1SGD0y3j0b6n0RlXqw4Iyw.png"/></div></div></figure><p id="4971" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">管理员(500)和来宾(501)是默认帐户。</p><p id="a468" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">开膛手约翰会帮助我们破解密码。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mb"><img src="../Images/2d1ff4494d2f85ebf97eac80eca97e2f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fm3tjk5JzuLcpg6JDZCgCw.png"/></div></div></figure><p id="396a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是破解密码的实际命令。因为我不是第一次这么做了，开膛手约翰说已经没有密码可以破解了，所以让我们把破解的密码带来。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mc"><img src="../Images/26762a8d5ecc79eab67abd45b8f098e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9OYSrvJ-XHCTyvwS0uSYVA.png"/></div></div></figure><p id="2872" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，我们有了！剩下的唯一事情就是仔细检查受害者机器上的文件和目录，找到一些有价值的东西。</p></div></div>    
</body>
</html>