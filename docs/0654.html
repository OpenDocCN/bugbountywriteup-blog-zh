<html>
<head>
<title>Hack the Box — DevOops Write-up</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">黑盒子— DevOops报道</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/hack-the-box-devoops-write-up-367d260d550c?source=collection_archive---------2-----------------------#2020-06-25">https://infosecwriteups.com/hack-the-box-devoops-write-up-367d260d550c?source=collection_archive---------2-----------------------#2020-06-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/1eb606e30d6cb6dbdaaf5843d0af5e9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1180/format:webp/1*sCDDJGpua9_YK_HShHzIMQ.png"/></div></figure><p id="e03b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">DevOops是Hack the Box pen-testing labs中难度中等的退役机。今天，我将向您展示如何通过一个已知的web漏洞找到这个盒子。</p><p id="e046" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">像往常一样，让我们运行Nmap来扫描主机:</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi ks"><img src="../Images/de756844142b1e5870f3a0c3a103bdc5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jyTj6LAB9ZlO13xT5k16Vw.png"/></div></div></figure><p id="1dc7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">端口5000上有一个HTTP服务器，默认端口22上运行一个SSH服务器。</p><p id="4cb1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">因此，通过访问该页面，我们可以看到一个正在建设中的网站。显然，这个web应用程序是博客提要的消费者，顾名思义。此外，feed.py参考向我们展示了它是用Python编写的:</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi lb"><img src="../Images/66d34b7b7a04a2ed7644620a1c39f15d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FE3EqGUrYYf0WMFFxP33xA.png"/></div></div></figure><p id="3a70" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">所以让我们开始模糊网站，看看我们能否找到有趣的路线。我们将在这里使用gobuster和中型目录wordlist，该目录可以在Kali的/urs/share/dirbuster/wordlists/中找到:</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi lc"><img src="../Images/0edf405113c9b43abf5d97f7eeab5a72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*15VC0V6A21UWYnMNH9c93w.png"/></div></div></figure><p id="eb00" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">Gobuster找到了/upload和/feed路径。最后一张是我们在第一页看到的图片，但是/upload非常有趣:</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div class="gh gi ld"><img src="../Images/e963b888077e02a60135c2342d6ad9c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1108/format:webp/1*1ghLc3EuTAqZOj-zaX34Hw.png"/></div></figure><p id="35cb" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这是一个我们可以上传XML文件的页面。它还给出了我们期望的模式:XML元素必须有作者、主题和内容字段。因此，让我们构建一个简单的XML文件并上传它，看看会发生什么:</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div class="gh gi le"><img src="../Images/c27af365da1144f90bae5549343c29ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:608/format:webp/1*MYXpYb1qcPhZ_0149ujTpQ.png"/></div></figure><p id="eedf" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在将其保存为payload.txt并上传后，我们得到了以下消息:</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi lf"><img src="../Images/ad58a5cee6e04fc57380a8fdd4ddc74f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k39UQU1Mdyyld-8ZvF8pxg.png"/></div></div></figure><p id="beba" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">正如您在上面看到的，应用程序向我们显示了我们刚刚通过XML插入的值，还向我们提供了用户名:roosa。</p><h1 id="7551" class="lg lh iq bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">XML外部实体</h1><p id="aee4" class="pw-post-body-paragraph ju jv iq jw b jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn mi kp kq kr ij bi translated">XML外部实体注入(XXE)是一种被<a class="ae mj" href="https://owasp.org/www-project-top-ten/OWASP_Top_Ten_2017/" rel="noopener ugc nofollow" target="_blank"> OWASP Top 10 - 2017 </a>列为web应用十大主要风险之一的漏洞。</p><p id="2f88" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">首先，让我们了解什么是XML文件。XML是一种允许我们描述数据的标记语言。这是一种允许两个不同系统相互通信的模式。因此，我们之前上传的文件将字段Author、Subject和Content定义为Foo、Bar和Baz值。</p><p id="6345" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">还可以定义实体，允许我们通过DOCTYPE头中的系统标识符引用外部资源。</p><p id="856e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这是声明实体的语法:</p><pre class="kt ku kv kw gt mk ml mm mn aw mo bi"><span id="5027" class="mp lh iq ml b gy mq mr l ms mt">&lt;!ENTITY <strong class="ml ir">reference_name</strong> SYSTEM <strong class="ml ir">reference</strong> &gt;</span></pre><p id="7dc2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们在一个字段中引用它:</p><pre class="kt ku kv kw gt mk ml mm mn aw mo bi"><span id="7294" class="mp lh iq ml b gy mq mr l ms mt">&lt;xpto&gt;&amp;reference_name&lt;/xpto&gt;</span></pre><p id="9e13" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们可以引用一个本地文件:</p><pre class="kt ku kv kw gt mk ml mm mn aw mo bi"><span id="83f7" class="mp lh iq ml b gy mq mr l ms mt">&lt;?xml version="1.0"?&gt;<br/>&lt;!DOCTYPE foo [ &lt;!ENTITY xxe SYSTEM "<strong class="ml ir">file:///etc/passwd"</strong> &gt; ] &gt;<br/>&lt;foo&gt;<br/>   &lt;content&gt;&amp;xxe&lt;/content&gt;<br/>&lt;/foo&gt;</span></pre><p id="a959" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">或远程服务器:</p><pre class="kt ku kv kw gt mk ml mm mn aw mo bi"><span id="db77" class="mp lh iq ml b gy mq mr l ms mt">&lt;?xml version="1.0"?&gt;<br/>&lt;!DOCTYPE foo [ &lt;!ENTITY xxe SYSTEM "<strong class="ml ir">http://xpto.com/resource"</strong> &gt; ] &gt;<br/>&lt;foo&gt;<br/>   &lt;content&gt;&amp;xxe&lt;/content&gt;<br/>&lt;/foo&gt;</span></pre><p id="543b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">通过禁用应用程序XML解析器中的外部实体和DTD处理，可以避免这种攻击。</p><h1 id="1792" class="lg lh iq bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">获取用户访问级别</h1><p id="f233" class="pw-post-body-paragraph ju jv iq jw b jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn mi kp kq kr ij bi translated">知道了如何利用XXE，我们就可以测试我们的应用程序是否易受攻击。让我们通过使用下面的有效负载来尝试获取<em class="mu"> /etc/passwd </em>文件:</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/8d899ac45973cf5343ae2d37761924c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1172/format:webp/1*h5rouAryFg1iV-xLItQHFA.png"/></div></figure><p id="dcdf" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">上传之后，我们得到了<em class="mu"> passwd </em>文件，所以这个应用程序确实很容易受到攻击:</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi mw"><img src="../Images/3a9da0238137caa8118e79673842308b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DzeQ31eTgKKl-hoeq_CNKQ.png"/></div></div></figure><p id="ef40" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">知道了有一个名为<em class="mu"> roosa </em>的用户和一个ssh服务器，让我们看看是否为这个用户配置了任何SSH密钥。通常ssh密钥存储在<em class="mu">里面。用户目录中的ssh </em>文件夹，为此，我们将使用以下有效负载:</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div class="gh gi mx"><img src="../Images/5926eec182262b261f662cb48d427fcc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1352/format:webp/1*EdtybpFOqqSIQLkODEfqpQ.png"/></div></figure><p id="38d5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">上传文件后，我们得到了一个密钥:</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi my"><img src="../Images/2ac39f99c1fcc2f95348fba23aa31cca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eihcko5Xv2uk2aYzTKJrXg.png"/></div></div></figure><p id="db3a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们将它保存在一个名为key的文件中，并通过运行以下命令来配置它的权限:</p><pre class="kt ku kv kw gt mk ml mm mn aw mo bi"><span id="84b0" class="mp lh iq ml b gy mq mr l ms mt">chmod 600 key</span></pre><p id="10b9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，让我们使用这个密钥连接到SSH服务器。连接后，旗帜就在我们面前:</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi mz"><img src="../Images/75aa5c828deb634b99d174bd2b80d78b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_e3GhpwRWuOoc8RsCyljSA.png"/></div></div></figure><h1 id="1276" class="lg lh iq bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">获取root访问权限</h1><p id="97fe" class="pw-post-body-paragraph ju jv iq jw b jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn mi kp kq kr ij bi translated">现在，让我们检查一下这个目录，以便找到有用的东西。只要运行<em class="mu"> ls -lah </em>来查看隐藏的文件，你就会发现一个非常有趣的文件:</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div class="gh gi na"><img src="../Images/9a627a75c055c197fb3b5ae38d808c0f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1380/format:webp/1*MIXu_F2pN-K8KstDeKTfuQ.png"/></div></figure><p id="6c12" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">似乎不知何故这个用户有root权限，我们记在心里吧。</p><p id="5a06" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，我们可以检查里面是什么。bash_history来验证用户输入了什么命令。正如您在下面看到的，用户在<em class="mu">资源/集成</em>目录中意外提交了一个错误的认证密钥，然后通过生成一个新的SSH密钥对来修复它:</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi nb"><img src="../Images/8613454b79781b248bbeaeeb10dab2f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1300/format:webp/1*h0qzgXKxIF5VCdmd1l_P6w.png"/></div></div></figure><p id="848d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">是根ssh密钥吗？让我想想…</p><p id="2812" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">通过搜索后。git目录我们找到了用户正在处理的目录:</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/fe9e81733c062731df43549befacd38e.png" data-original-src="https://miro.medium.com/v2/resize:fit:786/format:webp/1*q9q6QFhuvyozjrAL1NPPeA.png"/></div></figure><p id="2ade" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">导航到<em class="mu"> work/blogfeed </em>目录后，让我们查看git日志，找到添加了错误键的确切提交位置。只需键入<em class="mu"> git log </em>，您将看到提交时间表:</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/68e3e46b5c746b1ea85e34e3b88b4f69.png" data-original-src="https://miro.medium.com/v2/resize:fit:1164/format:webp/1*r_r47xpnjba2u4RgZrQGxw.png"/></div></figure><p id="e8f2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">那么让我们恢复这个提交。注意，我们需要使用<em class="mu"> -f </em>标志，因为有修改过的文件。</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi ne"><img src="../Images/156e25e46ec61da3451b2e172125c199.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pol132pUEohjCrUNJm2vjQ.png"/></div></div></figure><p id="e492" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">导航到<em class="mu">资源/集成</em>并将正确的权限设置为<em class="mu"> authcredentials.key </em>。然后尝试使用这个密钥以root用户身份连接到SSH。正如您在下面看到的，它起作用了，我们的根标志就在那里:</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi nf"><img src="../Images/2033191cda5ded54daaf84a0ecc95fe7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Cr6Wox6H-hdA-dYGWm5b7w.png"/></div></div></figure></div><div class="ab cl ng nh hu ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="ij ik il im in"><h1 id="1ed2" class="lg lh iq bd li lj nn ll lm ln no lp lq lr np lt lu lv nq lx ly lz nr mb mc md bi translated">结论</h1><p id="fe7e" class="pw-post-body-paragraph ju jv iq jw b jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn mi kp kq kr ij bi translated">从这个盒子里，我们可以学到三个重要的教训:</p><ul class=""><li id="18d7" class="ns nt iq jw b jx jy kb kc kf nu kj nv kn nw kr nx ny nz oa bi translated">千万不要相信用户输入的数据！像XSS和SQLi一样，XXE漏洞只是关于信任来自用户的数据。</li><li id="a4d1" class="ns nt iq jw b jx ob kb oc kf od kj oe kn of kr nx ny nz oa bi translated">Git是一个代码版本控制工具，所以你提交的所有东西都将被保存！如果您不小心提交了任何敏感凭据，您需要使其无效并生成另一个凭据。</li><li id="cf9e" class="ns nt iq jw b jx ob kb oc kf od kj oe kn of kr nx ny nz oa bi translated">此外，凭据必须以更安全的方式存储，例如，使用环境变量。查看<a class="ae mj" href="https://12factor.net/config" rel="noopener ugc nofollow" target="_blank">12因素</a>了解更多信息。</li></ul><h1 id="9e0d" class="lg lh iq bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">参考</h1><ul class=""><li id="715c" class="ns nt iq jw b jx me kb mf kf og kj oh kn oi kr nx ny nz oa bi translated"><a class="ae mj" href="https://resources.infosecinstitute.com/xxe-attacks/#gref" rel="noopener ugc nofollow" target="_blank">信息安全协会—什么是XXE攻击？</a></li><li id="a224" class="ns nt iq jw b jx ob kb oc kf od kj oe kn of kr nx ny nz oa bi translated"><a class="ae mj" href="https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html" rel="noopener ugc nofollow" target="_blank"> OWASP小抄系列— XXE预防</a></li></ul></div><div class="ab cl ng nh hu ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="ij ik il im in"><p id="a558" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我希望你喜欢这篇文章！</p><p id="d89b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果你对黑盒子感兴趣，看看我的其他文章:</p><ul class=""><li id="f48a" class="ns nt iq jw b jx jy kb kc kf nu kj nv kn nw kr nx ny nz oa bi translated">黑盒子——感觉</li><li id="a2fd" class="ns nt iq jw b jx ob kb oc kf od kj oe kn of kr nx ny nz oa bi translated"><a class="ae mj" href="https://medium.com/rd-shipit/dive-into-hack-the-box-lame-ec44fccb5711" rel="noopener">黑盒子——蹩脚</a></li></ul></div></div>    
</body>
</html>