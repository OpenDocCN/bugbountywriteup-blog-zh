# Apache Tomcat 服务器中 Ghostcat 漏洞(Cve-2020–1938)的详细分析

> 原文：<https://infosecwriteups.com/detailed-analysis-of-ghostcat-vulnerability-cve-2020-1938-in-apache-tomcat-servers-and-using-it-736146c986a3?source=collection_archive---------0----------------------->

## 并利用它在 Tryhackme 上攻破一台 Tomcat 机器

今天我们要讨论的是 2020 年 2 月柴天科技安全研究人员发现的一个新漏洞，这个漏洞被研究人员命名为 ghostcat

[Apache Tomcat](http://tomcat.apache.org/) 是一个流行的开源 Java servlet 容器，因此 Ghostcat 的发现可以理解地引发了一些警报。这篇博客文章试图通过深入研究可能允许 RCE 通过漏洞的不太可能的情况，将最令人恐惧的 Ghostcat 相关场景放入视野中。

该漏洞在默认配置下影响 Tomcat 的所有版本(我们发现该漏洞时，已确认影响 Tomcat 9/8/7/6 的所有版本，太旧的旧版本未验证)，这意味着它在 Tomcat 中已休眠十多年。

W **幽灵猫能做什么帽子？**

通过利用 Ghostcat 漏洞，攻击者可以读取 Tomcat 上部署的所有 webapps 的配置文件和源代码文件的内容。

此外，如果网站应用程序允许用户上传文件，攻击者可以首先将包含恶意 JSP 脚本代码的文件上传到服务器(上传的文件本身可以是任何类型的文件，如图片、纯文本文件等。)，然后通过利用 Ghostcat 漏洞包含上传的文件，这最终会导致远程代码执行

让我们先来谈谈 AJP (Apache Jserv 协议)

# 《AJP 议定书》

[AJP](https://tomcat.apache.org/connectors-doc/ajp/ajpv13a.html) 是 Apache Tomcat webserver 使用的二进制协议，通过 TCP 连接与位于 webserver 后面的 servlet 容器进行通信。它主要用于集群或反向代理场景，其中 web 服务器与应用服务器或 servlet 容器进行通信。

简单地说，这意味着 HTTP 连接器向客户端公开，而 AJP 在 web 服务器(例如，Apache HTTPD)和 Apache Tomcat 服务器之间内部使用(如图 1 所示)。AJP 是作为 Apache HTTP 服务器中的一个模块实现的，表示为 mod_jk 或 mod_proxy_ajp。底线是，AJP 本质上并不对外开放。指出这一点很重要，因为这是 RCE 场景的先决条件之一。

![](img/df5aaa982cdd14d3beecd999a637ce79.png)

GHOSTCAT 是一个 LFI(本地文件包含)漏洞，它不是 RCE(远程代码执行)。默认情况下，在某些情况下，它会成为 RCE

> **能让幽灵特工成为 RCE 的环境**

web 应用程序需要允许文件上传和在 web 应用程序本身中存储这些上传的文件，并结合将文件作为 JSP 处理的能力

来自巴西的知名安全研究员 joo Matos 指出了 Ghostcat 成为 RCE 的先决条件

链接-【https://twitter.com/joaomatosf/status/1230895566688792576 

**通过 APP 功能上传文件**。这第一个先决条件意味着具有文件上传功能的应用程序应该已经安装在系统中，RCE 才是可能的。如果是这种情况，潜在的攻击者可以更方便地使用带有文件上传漏洞的 web 应用程序来上传恶意的 web 外壳文件。只有在上传漏洞限制某些文件扩展名(如 JPG 或 TXT)的情况下，才需要将文件解释为 JSP。

这些文件保存在文档根目录下。一旦攻击者破坏了应用程序并能够上传恶意文件，这些文件将需要保存在应用程序根文件夹中。这个先决条件本身不太可能或很难协调，原因有二:1)在 Java 应用程序中，将文件保存在其应用程序根文件夹中是不常见的；以及 2)应用程序根文件夹是暂时的，因此每当部署应用程序的新版本时，该文件夹被完全覆盖。

此外，从开发人员的角度来看，文件上传功能上传根文件夹中的文件没有什么意义，因为大多数 Apache Tomcat 应用程序都是以. WAR 文件的形式部署的，这基本上是一个 zip 文件。

**直达 AJP 港**。最后，在满足这两个先决条件后，潜在的攻击者将必须能够通过反向代理直接从互联网到达 Tomcat AJP 连接器(默认端口 8009 ),这是一个对外公开的 AJP。如上所述，这不是推荐的或常见的配置。即使 AJP 连接器暴露，攻击者试图与之通信，他们也会收到来自 web 服务器的 400 错误请求响应，因为 AJP 是二进制协议。

**为什么会存在这个漏洞？**

默认情况下，与 HTTP 连接相比，Tomcat 认为 AJP 连接具有更高的信任级别。当 AJP 被正确实现时，该协议需要一个秘密，任何查询该协议的人都需要这个秘密。当使用默认的 Tomcat 配置时，这个秘密是不启用的，这意味着不会对进入端口 8009 的请求进行安全检查。这意味着未经验证的攻击者可以访问该端口来读取或可能写入服务器

> **在 TRYHACKME** 上演练 TOMGHOST 机器

# **在我们开始之前，给 tryhackme 说几句话**

Tryhackme 是目前学习黑客的最佳平台之一，它包括所有级别的所有课程，所以无论你是今天早上才开始学习黑客，还是你已经学习了 2-3 年，或者已经超过 5 年，这肯定会让你心动。这个平台的重点是通过这样做来学习，这对每个信息安全爱好者来说都是必须的

 [## 黑客培训

### TryHackMe 是一个学习和教授网络安全的在线平台，全部通过您的浏览器完成。

tryhackme.com](https://tryhackme.com/) 

**现在让我们开始排练**

[](https://tryhackme.com/room/tomghost) [## 尝试黑客| tomghost

### 识别最近的漏洞，尝试利用系统或读取您不应访问的文件。

tryhackme.com](https://tryhackme.com/room/tomghost) ![](img/f6764529e9a763ae8d0b8dd71227505b.png)

让我们首先部署机器

![](img/4b8dea095dc4bcf8b528534e787eac56.png)

现在让我们使用 nmap 对机器进行一些侦察

`**$ nmap -A -Pn [machine-ip]**`

![](img/4e96380d242ea02eda543fdaa97eab75.png)

他们把 AJP 暴露给每个人，我们可以在 8009 端口上看到完美！！！！！！！！！！！

现在，让我们来看看 ghostcat 漏洞的公开利用

![](img/59e13422653862181c65e55c8496dc59.png)

链接-[https://www.exploit-db.com/exploits/48143](https://www.exploit-db.com/exploits/48143)

让我们下载漏洞并运行它

![](img/fb386451b766003a5ebd8d2fa01490fc.png)

**$ python2 48143.py -p 8009【机器 IP】**

![](img/f9612e6341ef397671bf2b5473895047.png)![](img/e19f72c221c4fa0ccd604fba8e5217d2.png)

这是我们运行漏洞后得到的用户名和密码

好的，从我们的 nmap 扫描中，我们知道 SSH 服务在端口 22 上是打开的，所以让我们使用这些 SSH 凭据

`**$ ssh skyfuck@[machine-ip]**`

![](img/3c048ea55173982e93299a1a439aae19.png)

我们进去了

![](img/12ceff76d44b45efe12ec528c4f82141.png)

好的，让我们来看看 user.txt(用户标志)

![](img/41c6014fede01fbe6615c01a0a9581bb.png)

等等什么！可能有更多的用户这不是我们需要的 user.txt 文件的用户，所以让我们去/home 目录

![](img/9d26222549b5a0f33eff57c57bb9340f.png)

好的，还有一个用户叫梅林，让我们看看梅林目录的权限，我们可以进入吗

![](img/ed4a5c98cafebe5063e9f17216f60c94.png)

好的，我们被允许，让我们进入那个目录

![](img/0b32d2dedbe635f69ac86e3c26ec5f70.png)

好的，这是我们的 user.txt 文件，让我们检查一下在这个文本文件上设置了什么权限，我们可以读取用户标志吗

![](img/d911d387031e27bc0b4b7ce24bc86c5f.png)

是的。！！！！我们现在可以使用 cat 命令读取文件了，但不能显示旗帜，抱歉

**$ cat user.txt**

好了，现在让我们检查这个用户 skyfuck 的 sudo 权限(我们就是)

`**$ sudo -l**`

![](img/94170433ea52d7efd76d2f38f17f1aeb.png)

哦，这个用户不在 sudoers 文件中，这意味着这个用户不能运行*特权命令，所以这个用户是没有用的。我们需要成为第二个用户(merlin)才能获得 root*

好吧，让我们看看这些有趣的文件在我们的用户 skyfuck 的主目录

![](img/04f988005d0e3e8853d9ab52053ec14b.png)

所以我们有一个名为 credentials 的 pgp 文件，它看起来很可疑，所以我们需要使用 gpg 工具解密这个文件

让我们使用 sftp 连接到机器，因为用户在我们自己的系统上快速下载这两个文件

`**$ sftp skyfuck@[machine-ip]**`

![](img/faf2eabcc93d4ad592231b8281490fca.png)

现在我们使用 sftp 连接到机器，现在让我们使用`get command`下载这两个文件

`**sftp-> get credential.pgp**`

`**sftp-> get tryhackme.asc**`

现在我们已经将这些文件下载到我们自己的系统中

![](img/3ef1728e494923f469330442e9825f2b.png)

让我们使用 gpg2john 来获得密钥

`**$ gpg2john tryhackme.asc > hash**`

![](img/617c1034f8eccf258283b6e79670d843.png)

现在让我们通过使用 rockyou.txt 单词表来破解开膛手约翰的哈希格式

链接到 word list-[https://github . com/brannon dorsey/naive-hashcat/releases/download/data/rock you . txt](https://github.com/brannondorsey/naive-hashcat/releases/download/data/rockyou.txt)

`**$ john --wordlist=rockyou.txt hash**`

![](img/447ee38e9c24cee93031eee6065937a7.png)

现在我们得到了 pgp 加密的密码或密钥

现在使用命令在 gpg 中导入 pgp 密钥

`**$ gpg --import tryhackme.asc**`

![](img/03909cf612f43b00b1faaf870661a187.png)

现在运行以下命令来解密 pgp 密钥

`**$ gpg --decrypt credential.pgp**`

![](img/fddeb4ee6cfa315b98b395a061cbf4ab.png)

现在你会得到梅林的密码

![](img/3c42eeae12bfbb697110076d547561e8.png)

现在，我们将在 SSH 会话中更改用户

`**$ su merlin**`

![](img/a4e352a8c6ca1c6153bad9fab4a9a6b5.png)

现在我们是我们所期望的用户意味着梅林

让我们检查一下他可以以 root 用户身份运行哪些命令

`**$ sudo -l**`

![](img/b64a562bcbc77f41b148acd15322cfdc.png)

好了，现在我们可以以 root 用户身份运行 zip 命令，让我们看看如何提升*权限。*

有一个关于黑客文章的博客，它告诉我们当一个用户被允许以 root 用户身份运行 zip 命令时，这个用户是如何成为 root 用户的

链接-[https://www . hacking articles . in/Linux-for-pentester-zip-privilege-escalation/](https://www.hackingarticles.in/linux-for-pentester-zip-privilege-escalation/)

我们使用了上面博客中描述的技术来成为 root

首先我们创建一个名为 raj.txt 的文本文件

`**$ touch raj.txt**`

`**$**` **sudo zip 1 . zip Raj . txt-T—unzip-command = " sh-c/bin/bash "**

![](img/61e104ffc761c816e49a65390ef4b067.png)

huraay！！！！！！！！我们现在是黑客文章博客的粉丝

现在我们可以在/root 中获得根标志

![](img/425414d1bc69264baa8d8f89f7fb86df.png)

> **ghost cat 漏洞修复**

Apache Tomcat 团队为解决 Ghostcat 问题所做的修复也应该进一步澄清其真正的局限性。在本节中，我们将详细介绍 9.0.31 版本中的代码修复，该版本主要与其他版本共享相同的代码。

Ghostcat 依赖于 AJP 连接器的错误配置(如下所示),默认情况下，它在/conf/server.xml 文件中处于启用状态:

Apache Tomcat 团队注释掉了文件中的这一行，从而在提交时默认禁用了 AJP 连接器 [4c933d8](https://github.com/apache/tomcat/commit/4c933d80e340b4a841a672060351b2190b326782)

![](img/d858f3f550e89e1ff1d2d0e499020dfa.png)

该图显示了默认情况下禁用 AJP 连接器的提交 [4c933d8](https://github.com/apache/tomcat/commit/4c933d80e340b4a841a672060351b2190b326782)

就其本身而言，上面的代码修复足以阻止 Ghostcat 的发生，因为它默认禁用 AJP。只有在不使用 AJP 的情况下，才应该这样做。

我们详细介绍了第二种修复方法，这种方法不一定会禁用 AJP，但会将其限制为默认情况下只侦听环回接口(图 4)。Apache Tomcat 团队进行了其他更改，以改进 AJP 协议的整体使用，例如当 secretRequired 属性设置为 true 时，强制定义一个秘密(图 5)。他们还确保对 AJP 连接器的任何包含任意和未识别属性的请求都会收到 403(禁止)响应

![](img/932c7f74f87f0a8b4df2d2eb623c6228.png)

mage 显示 Commit [0e8a50f0](https://github.com/apache/tomcat/commit/0e8a50f0a5958744bea1fd6768c862e04d3b7e75) ，默认情况下强制 AJP 协议监听环回地址，而不是 0.0.0.0。

![](img/24bd898089912d77a573ff4e0f326bad.png)

显示提交 [9ac90532](https://github.com/apache/tomcat/commit/9ac90532e9a7d239f90952edb229b07c80a9a3eb) 的图像，该图像检查参数 secretRequired 是否设置为“真”,以及是否存在已定义的“秘密”

![](img/8fb928681f59ced90d06f0df67e51c8c.png)

显示 Commit [64fa5b99](https://github.com/apache/tomcat/commit/64fa5b99442589ef0bf2a7fcd71ad2bc68b35fad) 的图像，如果包含任何任意和不可识别的属性，该图像将使用 403 禁止消息响应阻止对 AJP 连接器的请求

# 结论

鉴于这篇文章中讨论的所有内容，让用户认识到 Ghostcat 仍然存在风险仍然很重要，即使它不是默认的 RCE。此漏洞已经有许多公开可用的攻击，这一事实应该促使用户尽快将他们的 Tomcat 更新到最新版本，以降低被利用的风险。

作者:infosec_boy

[](https://twitter.com/infosec_boy) [## 阿努巴夫·曼德瓦尔

### anubhav mandarwal 的最新推文(@infosec_boy)。一个喜欢 pwn 机器和搜索信息安全漏洞的家伙…

twitter.com](https://twitter.com/infosec_boy)  [## 登录* Instagram

### 欢迎回到 Instagram。登录查看您的朋友、家人和兴趣爱好捕捉和分享了什么…

www.instagram.com](https://www.instagram.com/infosec_boy/) [](https://www.linkedin.com/in/anubhav-mandarwal-318952186/) [## anubhav mandarwal -副威胁研究员-网络| LinkedIn

### 查看 anubhav mandarwal 在世界上最大的职业社区 LinkedIn 上的个人资料。anubhav 有 3 份工作列在…

www.linkedin.com](https://www.linkedin.com/in/anubhav-mandarwal-318952186/) 

特别感谢博客 https://blog . trend micro . com/trend labs-security-intelligence/busting-ghost cat-an-analysis-of-the-Apache-Tomcat-vulnerability-CVE-2020-1938-and-cnvd-2020-10487/提供的精彩信息