<html>
<head>
<title>Exploiting XSS with Javascript/JPEG Polyglot</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Javascript/JPEG语言开发XSS</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/exploiting-xss-with-javascript-jpeg-polyglot-4cff06f8201a?source=collection_archive---------0-----------------------#2022-04-08">https://infosecwriteups.com/exploiting-xss-with-javascript-jpeg-polyglot-4cff06f8201a?source=collection_archive---------0-----------------------#2022-04-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/6eadffecc0e5f09790402b5c8042bc2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XEFzRbN-eiQnxTujnE0mSA.png"/></div></div></figure><h2 id="f631" class="jy jz iq bd ka kb kc dn kd ke kf dp kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">什么是多语者？</h2><p id="3119" class="pw-post-body-paragraph ku kv iq kw b kx ky kz la lb lc ld le kh lf lg lh kl li lj lk kp ll lm ln lo ij bi translated">正如PNG、JPEG和DOC是有效的文件类型一样，多语言是两种不同文件类型的组合。比如Phar + JPEG (PHP存档和JPEG文件)，GIFAR (Gif和Rar文件)Javascript + JPEG等。</p><p id="23e2" class="pw-post-body-paragraph ku kv iq kw b kx lp kz la lb lq ld le kh lr lg lh kl ls lj lk kp lt lm ln lo ij bi translated">应用程序只允许某些文件类型的功能，如文件上传，不允许其他文件类型，如。php或者。js文件，因为这些文件可让攻击者在应用程序上上传恶意文件。应用程序执行扩展过滤检查，如双扩展(. jpg.php)或在扩展中使用空字节(。php%00.jpg)、文件名(。htaccess，。配置等..)，以及上传文件的签名是否也与其内容类型匹配。</p><p id="3943" class="pw-post-body-paragraph ku kv iq kw b kx lp kz la lb lq ld le kh lr lg lh kl ls lj lk kp lt lm ln lo ij bi translated">不同的应用使用不同的方法，可以使用多语种来绕过这些验证检查。</p><h2 id="f727" class="jy jz iq bd ka kb kc dn kd ke kf dp kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">JPEG结构</h2><p id="0476" class="pw-post-body-paragraph ku kv iq kw b kx ky kz la lb lc ld le kh lf lg lh kl li lj lk kp ll lm ln lo ij bi translated">JPEG图像表示为一系列片段，其中每个片段都以标题开始。每个报头都以某个字节开始。报头后面的有效载荷根据报头类型而不同。常见的JPEG标记类型如下所示:</p><pre class="lu lv lw lx gt ly lz ma mb aw mc bi"><span id="6978" class="jy jz iq lz b gy md me l mf mg">0xffd8: “Start of Image”,</span><span id="e89b" class="jy jz iq lz b gy mh me l mf mg">0xffe0: “Application Default Header”,</span><span id="a6ac" class="jy jz iq lz b gy mh me l mf mg">0xffdb: “Quantization Table”,</span><span id="c744" class="jy jz iq lz b gy mh me l mf mg">0xffc0: “Start of Frame”,</span><span id="2d4c" class="jy jz iq lz b gy mh me l mf mg">0xffc4: “Define Huffman Table”,</span><span id="3000" class="jy jz iq lz b gy mh me l mf mg">0xffda: “Start of Scan”,</span><span id="9a48" class="jy jz iq lz b gy mh me l mf mg">0xffd9: “End of Image”</span></pre><p id="090f" class="pw-post-body-paragraph ku kv iq kw b kx lp kz la lb lq ld le kh lr lg lh kl ls lj lk kp lt lm ln lo ij bi translated">每个二进制文件都包含几个头文件。它们对文件非常重要，因为它们定义了文件的特定信息。大多数报头后面都有长度信息。这告诉我们这个特定的片段有多长。</p><p id="ff01" class="pw-post-body-paragraph ku kv iq kw b kx lp kz la lb lq ld le kh lr lg lh kl ls lj lk kp lt lm ln lo ij bi translated">图像头的开始包含FF D8。如果我们没有看到它，我们可以假设这是一些其他文件。另一个重要的标志是FF D9，它表示图像的结束。</p><p id="4224" class="pw-post-body-paragraph ku kv iq kw b kx lp kz la lb lq ld le kh lr lg lh kl ls lj lk kp lt lm ln lo ij bi translated">为了使有效载荷看起来像一个合法的JPEG文件，我们将添加头的长度、注释头、要填充的空字节，然后是我们的javascript攻击向量。</p><p id="83f1" class="pw-post-body-paragraph ku kv iq kw b kx lp kz la lb lq ld le kh lr lg lh kl ls lj lk kp lt lm ln lo ij bi translated">假设攻击向量是<code class="fe mi mj mk lz b">*/=alert(“XSS”)/*</code>转换成十六进制会是这个样子。</p><figure class="lu lv lw lx gt jr gh gi paragraph-image"><div class="gh gi ml"><img src="../Images/6abd78038b293194426b5598db68eafc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1110/format:webp/1*tl0RmvkwMWXXLaZctB-WXA.png"/></div></figure><p id="4c84" class="pw-post-body-paragraph ku kv iq kw b kx lp kz la lb lq ld le kh lr lg lh kl ls lj lk kp lt lm ln lo ij bi translated">十六进制的有效载荷:-</p><pre class="lu lv lw lx gt ly lz ma mb aw mc bi"><span id="3679" class="jy jz iq lz b gy md me l mf mg">2A 2F 3D 61 6C 65 72 74 28 22 58 53 53 2E 22 29</span></pre><p id="0261" class="pw-post-body-paragraph ku kv iq kw b kx lp kz la lb lq ld le kh lr lg lh kl ls lj lk kp lt lm ln lo ij bi translated">我们可以使用十六进制编辑器在图像元数据中注入javascript。这是因为浏览器在将图像呈现为HTML时会解释代码。</p><figure class="lu lv lw lx gt jr gh gi paragraph-image"><div class="gh gi mm"><img src="../Images/7f9242223cffa381d656055bdd92c7a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1260/format:webp/1*97wCGHxeo_yv9uJIUm4clA.jpeg"/></div><figcaption class="mn mo gj gh gi mp mq bd b be z dk translated">test.jpg(目标图像文件)</figcaption></figure><p id="bb7b" class="pw-post-body-paragraph ku kv iq kw b kx lp kz la lb lq ld le kh lr lg lh kl ls lj lk kp lt lm ln lo ij bi translated">我有一张test.jpg的图片，下面是test.jpg的垃圾站。在<strong class="kw ir"> ghex编辑器</strong>的帮助下，我们将替换一些十六进制字符并保存它们。</p><figure class="lu lv lw lx gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mr"><img src="../Images/028ba574e641242a44dbe81d63ed6b0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HS9YL0FAk7wSPGplGsK83w.png"/></div></div></figure><p id="a1f2" class="pw-post-body-paragraph ku kv iq kw b kx lp kz la lb lq ld le kh lr lg lh kl ls lj lk kp lt lm ln lo ij bi translated">我们知道第一个<code class="fe mi mj mk lz b">FF D8</code>是图像的开始，接下来的两个字节代表即将到来的两个字节，<code class="fe mi mj mk lz b">00 10 </code>代表JPEG头的长度，在十进制中相当于16个字节。</p><h1 id="f197" class="ms jz iq bd ka mt mu mv kd mw mx my kg mz na nb kk nc nd ne ko nf ng nh ks ni bi translated">注射时间</h1><p id="2db9" class="pw-post-body-paragraph ku kv iq kw b kx ky kz la lb lc ld le kh lf lg lh kl li lj lk kp ll lm ln lo ij bi translated">我们将在<code class="fe mi mj mk lz b">FF E0</code>和<code class="fe mi mj mk lz b">FF DB</code>之间注入有效载荷。让我们从十六进制表示/*的<code class="fe mi mj mk lz b">2F 2A</code>开始</p><figure class="lu lv lw lx gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mr"><img src="../Images/5da19ee35b6332b18d72aa210c67f8b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mv3lnPCjPR-XLFFiNVvtMA.png"/></div></div></figure><blockquote class="nj nk nl"><p id="68c2" class="ku kv nm kw b kx lp kz la lb lq ld le nn lr lg lh no ls lj lk np lt lm ln lo ij bi translated"><em class="iq">如果你注意到我们刚刚用</em> <code class="fe mi mj mk lz b"><em class="iq">2F 2A</em></code> <em class="iq">替换了之前的</em> <code class="fe mi mj mk lz b"><em class="iq">00 10</em></code> <em class="iq">，十六进制</em> <code class="fe mi mj mk lz b"><em class="iq">2F 2A</em></code> <em class="iq">的十进制等效值是12074字节。所以现在图像头从16字节改为12074字节。</em></p></blockquote><figure class="lu lv lw lx gt jr gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/f3214980b085a4cc5ca37a1ef7608318.png" data-original-src="https://miro.medium.com/v2/resize:fit:1058/format:webp/1*5R_HeJdgeQV9vIUSFCilSw.png"/></div></figure><p id="769e" class="pw-post-body-paragraph ku kv iq kw b kx lp kz la lb lq ld le kh lr lg lh kl ls lj lk kp lt lm ln lo ij bi translated">从上面的截图中，我们可以看到我们的有效载荷的大小是18字节，所以我们必须用空值填充剩余的字节，即12074–16–18 = 12040字节。</p><figure class="lu lv lw lx gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nr"><img src="../Images/459538fc47193dd1efc215e6afa41b16.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a1tqwT8TDI_FENAxG7Q73w.png"/></div></div></figure><p id="73af" class="pw-post-body-paragraph ku kv iq kw b kx lp kz la lb lq ld le kh lr lg lh kl ls lj lk kp lt lm ln lo ij bi translated">上面的命令将读取test.jpg，在中间插入我们的有效负载<code class="fe mi mj mk lz b">2F 2A FF DB</code>将十六进制转换为缓冲区，添加12040个空字节并将其写入文件test_new.jpg。现在在ghex编辑器中关闭<code class="fe mi mj mk lz b">FF D9</code>前的注释标签</p><figure class="lu lv lw lx gt jr gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/8b3f39a23c424ce0be181c34c3501875.png" data-original-src="https://miro.medium.com/v2/resize:fit:1314/format:webp/1*_xpTlKAEluicg-GSmiHkLw.png"/></div><figcaption class="mn mo gj gh gi mp mq bd b be z dk translated">test_new.jpeg的hexdump(已修改)</figcaption></figure><pre class="lu lv lw lx gt ly lz ma mb aw mc bi"><span id="2954" class="jy jz iq lz b gy md me l mf mg">Code to execute image as javascript:-</span><span id="958e" class="jy jz iq lz b gy mh me l mf mg">&lt;script charset="ISO-8859-1" src="test_new.jpeg"&gt;</span></pre><p id="9a54" class="pw-post-body-paragraph ku kv iq kw b kx lp kz la lb lq ld le kh lr lg lh kl ls lj lk kp lt lm ln lo ij bi translated">在Firefox上，当文档使用UTF-8字符集时，当作为脚本包含时会破坏多语言环境！因此，为了让脚本工作，我们需要在脚本标签上指定ISO-8859–1字符集，它可以很好地执行。</p><p id="4dc0" class="pw-post-body-paragraph ku kv iq kw b kx lp kz la lb lq ld le kh lr lg lh kl ls lj lk kp lt lm ln lo ij bi translated">让我们在浏览器中测试一下。</p><figure class="lu lv lw lx gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nt"><img src="../Images/38baa67e205f20525453f317308247fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*auexuQr3KbHwFmLQli22sQ.gif"/></div></div></figure><p id="6707" class="pw-post-body-paragraph ku kv iq kw b kx lp kz la lb lq ld le kh lr lg lh kl ls lj lk kp lt lm ln lo ij bi translated">我们的<strong class="kw ir"> javascript/jpeg多语言</strong>有效！</p><blockquote class="nj nk nl"><p id="8bea" class="ku kv nm kw b kx lp kz la lb lq ld le nn lr lg lh no ls lj lk np lt lm ln lo ij bi translated"><em class="iq">更新:Mozilla </em> <a class="ae nu" href="https://bugzilla.mozilla.org/show_bug.cgi?id=1288361" rel="noopener ugc nofollow" target="_blank"> <em class="iq">在Firefox 51 </em> </a> <em class="iq">及以后版本中修复了这个问题。</em></p></blockquote><p id="c354" class="pw-post-body-paragraph ku kv iq kw b kx lp kz la lb lq ld le kh lr lg lh kl ls lj lk kp lt lm ln lo ij bi translated">如果你觉得有趣，就和你的朋友分享。</p><p id="09bd" class="pw-post-body-paragraph ku kv iq kw b kx lp kz la lb lq ld le kh lr lg lh kl ls lj lk kp lt lm ln lo ij bi translated">感谢您的阅读。</p></div><div class="ab cl nv nw hu nx" role="separator"><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa"/></div><div class="ij ik il im in"><h2 id="8fc3" class="jy jz iq bd ka kb kc dn kd ke kf dp kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">来自Infosec的报道:Infosec每天都有很多内容，很难跟上。<a class="ae nu" href="https://weekly.infosecwriteups.com/" rel="noopener ugc nofollow" target="_blank">加入我们的每周简讯</a>以5篇文章、4个线程、3个视频、2个GitHub Repos和工具以及1个工作提醒的形式免费获取所有最新的Infosec趋势！</h2></div></div>    
</body>
</html>