<html>
<head>
<title>OAuth and the flaws in its implementation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">OAuth及其实现中的缺陷</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/oauth-and-the-flaws-in-its-implementation-74de16f115c0?source=collection_archive---------0-----------------------#2022-10-27">https://infosecwriteups.com/oauth-and-the-flaws-in-its-implementation-74de16f115c0?source=collection_archive---------0-----------------------#2022-10-27</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/0f7a98c7a963da76ef92b0f94059849d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NAV0dHyrjPi3VB4r7PZUpw.jpeg"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated"><a class="ae kf" href="https://unsplash.com/@freestocks?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">自由股票</a>在<a class="ae kf" href="https://unsplash.com/@freestocks?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="31af" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">OAuth是什么？</p><p id="2f76" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">开放授权(也称为OAuth)是一个开源框架，允许您在网站上创建帐户，而不必为每个网站创建不同的用户帐户。他们依赖可信的第三方网站，如脸书或谷歌，为他们执行身份验证过程。</p><p id="ce96" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">它是:</p><ol class=""><li id="9924" class="le lf it ki b kj kk kn ko kr lg kv lh kz li ld lj lk ll lm bi translated">它用于登录网站，无需先建立帐户。</li><li id="e941" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">通过这种方法执行资源共享。</li><li id="1574" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">SSO也在商业和企业网络中用于各种目的(单点登录)</li></ol><p id="720d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">想想是不是很耐人寻味？但是，有哪些方法可以在不创建帐户的情况下访问某些内容呢？让我们看看它对你有多有效。</p><p id="4467" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">【OAuth是如何工作的？</p><figure class="lt lu lv lw gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ls"><img src="../Images/cb8c2d34311c8799283c967db4840a9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OXKDkVB8hWHn-bS_auIrNQ.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated"><a class="ae kf" href="https://goteleport.com/blog/how-oauth-authentication-works/" rel="noopener ugc nofollow" target="_blank">来源</a></figcaption></figure><p id="2254" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了简化工作流程，让我们首先隔离所涉及的实体。</p><p id="03c6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">它们是:</p><ol class=""><li id="bf67" class="le lf it ki b kj kk kn ko kr lg kv lh kz li ld lj lk ll lm bi translated">用户(即您)</li><li id="7175" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">您想要访问的应用程序</li><li id="ab18" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">授权服务器</li></ol><p id="e239" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">例如，你去example.com。要访问它的服务，该网站告诉你登录。但你不想创建一个单独的帐户，并处理创建一个新的用户帐户和记住密码的麻烦。但是有一个使用脸书登录的选项。因为你有一个脸书的账户，你选择了脸书，避免了创建新账户和记住不同服务的密码的痛苦。</p><p id="05f5" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您刚才所做的是使用OAuth完成的。它简化了我们的工作流程，我们应该感谢开发人员创建了这样一个框架。但是就像市场上出现的任何框架一样，基于它的配置方式，它可能会导致帐户接管。让我们来了解如何。</p><p id="68e8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在上面的例子中，您是用户，example.com是您想要访问的应用程序，因为您决定通过脸书登录，所以授权和资源服务器将属于脸书。</p><p id="57de" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当您单击“使用脸书登录”按钮时，需要执行一系列步骤才能允许您访问example.com</p><p id="72fe" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们先来了解一下工作流程:</p><ol class=""><li id="c3c3" class="le lf it ki b kj kk kn ko kr lg kv lh kz li ld lj lk ll lm bi translated">你用脸书按钮点击登录。</li><li id="8f3c" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">您将被带到脸书授权服务器，可能会要求您登录。</li><li id="422c" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">一旦登录，它会要求你授权脸书提供您的详细资料(如个人资料图片，用户名等。)对example.com来说，范围是预先定义好的，facebook会向你展示第三方网站需要的信息。</li><li id="85ca" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">一旦你点击“是”,它会将你重定向到example.com，并向example.com发送一个独特的令牌，example.com可以使用该令牌从脸书资源服务器获取您的详细信息。</li></ol><p id="8a6f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让我们一个一个地看。</p><p id="55bc" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">第一步:</p><p id="e84b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当通过脸书登录时，您可能会发现您被重定向到一个URL，看起来像这样:</p><figure class="lt lu lv lw gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi lx"><img src="../Images/1df05ff449c14ecaec5dac341c22a4da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5yfPL4eCXznj486hzZhTiQ.png"/></div></div></figure><p id="bb33" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让我们看一下参数:</p><ol class=""><li id="1a9f" class="le lf it ki b kj kk kn ko kr lg kv lh kz li ld lj lk ll lm bi translated">example.com必须在facebook.com注册，才能使用脸书按钮登录他们的网站。然后，脸书将向example.com提供一个唯一的id。这里是ot 99 ay 3 jj hmj 64 jmhx 6。脸书跟踪所有活动，例如网站获取的访问令牌，以及客户端或第三方可以从脸书获得的信息等。</li><li id="64e4" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">redirect_uri:一旦脸书确认确实是你，并且你允许example.com分享你的个人资料和电子邮件，它就会重定向到这个URL。脸书将使用访问令牌重定向到该URL，该令牌提供第三方网站授权，以从您授权的脸书获取相应的信息。</li><li id="eac9" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">response_type:可以是代码类型，也可以是令牌类型。在令牌类型中，example.com将直接从脸书的授权服务器获得一个令牌，通过这个令牌它可以从资源服务器访问你的账户信息。在代码类型中，example.com将向example.com返回一个代码，然后脸书将使用该代码再次向脸书发出请求。脸书将检查代码，然后返回一个令牌。</li><li id="7aa0" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">范围:这正是example.com希望从脸书得到的。我们可以看到，它要求我们的个人资料信息以及我们的电子邮件地址。它可以请求各种信息，比如性别、出生日期等等。</li><li id="81b4" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">状态:这执行CSRF令牌的功能。应该是随机选择的。</li></ol><p id="39d7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这一步的最终结果是您将被带到脸书，在那里您将首先登录，然后授予许可</p><p id="2cd8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">第二步:</p><p id="3640" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一旦您被重定向到登录页面，您可以输入您的脸书用户名和密码，一旦脸书验证用户名和密码，它会将您重定向到一个页面，显示该网站从脸书请求的信息，以及您是否同意允许该网站从脸书获取这些信息。在此之后，example.com会生成一个附加到您的帐户的令牌，然后将其返回给example.com/oauth,，可能会使用或保存该令牌以供将来使用。例如，让令牌为token=w1kcu82_23ce</p><p id="8c9e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">第三步:</p><p id="b331" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">exampe.com将使用生成的令牌向脸书资源服务器发出请求，并获取您的个人资料和电子邮件以及您允许的其他信息。</p><p id="3374" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu">OAuth错误配置导致的漏洞</strong></p><p id="2773" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果没有正确配置，不正确的OAuth实现可能导致完全的帐户接管。这不仅会危及用户的账户，还会因该事件给公司声誉带来损害。</p><figure class="lt lu lv lw gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ly"><img src="../Images/4ef3bf6e4a50e1dd9298fcff81586aec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zDka_auC7dVJ1XtZGCIwLw.jpeg"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated"><a class="ae kf" href="https://portswigger.net/web-security/oauth" rel="noopener ugc nofollow" target="_blank">来源</a></figcaption></figure><p id="4796" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让我们快速检查几个错误。</p><p id="21b0" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu">重定向URI </strong></p><p id="6bd3" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">看网址:</p><p id="2e2f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">【https://facebook.com/auth?client_id=ot99ay3jjhmhmj64jmhx6】T4&amp;redirect _ uri = example . com&amp;response _ type = token&amp;scope = profile，email&amp;state = luec 4 axce 76134 ll 89v 423 ke</p><figure class="lt lu lv lw gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/c78369baadff1fca172eb76e2481d80c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wknLZWi08wfKjrTv630eQQ.png"/></div></div></figure><p id="dfc4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果重定向URL定义不正确，例如，如果白名单太宽或配置不正确，重定向的性能会很差。假设example.com正在使用OAuth实现，用户通过令牌被定向到example.com/oauth/token.php，但他们没有配置绝对URL，而是简单地将example.com列入白名单，因此如果攻击者控制了几个页面，如个人资料或其他页面，他可以利用这一点将用户重定向到这些页面并捕获令牌，如下例所示。此外，当与开放重定向结合使用时，它变得非常有趣，攻击者可能会因此获得很大的优势。</p><p id="e792" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae kf" href="https://facebook.com/auth?client_id=ot99ay3jjhmhmj64jmhx6&amp;redirect_uri=attacker_domain.com&amp;response_type=token&amp;scope=profile,email&amp;state=luec4axce76134ll89v423ke" rel="noopener ugc nofollow" target="_blank">https://facebook.com/auth?client_id=ot99ay3jjhmhmj64jmhx6&amp;redirect _ uri = attack _ domain . com&amp;response _ type = token&amp;scope = profile，email&amp;state = luec 4 axce 76134 ll 89v 423 ke</a></p><figure class="lt lu lv lw gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/eca811c7fb5a175f42d5a9b7ab90e9a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lnKj5EkQHA6BVsZ7gZcK3Q.png"/></div></div></figure><p id="9a11" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在用户完成身份验证后，上述URL会将用户重定向到attack_domain.com。</p><p id="8be7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu">状态参数缺失或配置不当</strong></p><p id="d413" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">state参数用作CSRF令牌，以防止CSRF被执行。当用户被转发到授权服务器时，以及当授权服务器将用户转回到网站时，需要确保用户与之前相同，并且请求是用相同的凭证做出的。因此，需要一个CSRF令牌，它可以由网站发行，然后在用户返回网站时由网站验证。所以当用户被重定向到授权服务器时，一个随机状态参数将被附加到请求中，当用户完成授权并被重定向回网站时，网站将检查令牌是否相同，如果不相同，将放弃请求。</p><p id="cf6b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu">攻击场景:</strong></p><p id="3b0b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">攻击者可以通过发送社交媒体请求来启动登录，然后自己执行登录。一旦网站生成授权令牌，攻击者就复制它，然后丢弃请求，确保令牌保持有效且不会过期。在大多数情况下，他以CSRF表单的形式向用户提供链接。点击链接后，攻击者的社交媒体帐户将链接到用户的帐户，攻击者将能够通过使用自己的社交媒体帐户登录来接管用户的帐户。</p><p id="89f9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">几个因素造成了它的脆弱性，包括缺少状态参数，状态参数的低熵，以及在一致的基础上产生相同的状态参数。</p><p id="095b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu">结论:</strong></p><p id="b1bb" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">OAuth极大地减少了我们必须做的工作量，但是也增加了开发人员需要做的工作量。这可能会导致大量的问题，从而导致事件过程中的重大转变，这可能会给公司带来令人不快的情况。</p><p id="90b5" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">因此，开发人员注意上面列出的常见攻击场景是非常重要的。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h2 id="b6c2" class="mg mh it bd mi mj mk dn ml mm mn dp mo kr mp mq mr kv ms mt mu kz mv mw mx my bi translated">来自Infosec的报道:Infosec每天都有很多内容，很难跟上。<a class="ae kf" href="https://weekly.infosecwriteups.com/" rel="noopener ugc nofollow" target="_blank">加入我们的每周时事通讯</a>以5篇文章、4个线程、3个视频、2个GitHub Repos和工具以及1个工作提醒的形式免费获取所有最新的Infosec趋势！</h2></div></div>    
</body>
</html>