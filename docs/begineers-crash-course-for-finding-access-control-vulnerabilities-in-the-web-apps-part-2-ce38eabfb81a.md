# 寻找 WEB 应用程序中访问控制漏洞的速成班:第 2 部分

> 原文：<https://infosecwriteups.com/begineers-crash-course-for-finding-access-control-vulnerabilities-in-the-web-apps-part-2-ce38eabfb81a?source=collection_archive---------1----------------------->

一些应用程序通过基于用户角色限制对特定 URL 和 HTTP 方法的访问，在平台层实施访问控制。例如，应用程序可能会配置如下规则:

`DENY: POST, /admin/deleteUser, managers`该规则拒绝管理者组中的用户访问 URL `/admin/deleteUser`上的`POST`方法。在这种情况下，各种事情都可能出错，导致绕过访问控制。

一些应用程序框架支持各种非标准的 HTTP 头，可以用来覆盖原始请求中的 URL，比如`X-Original-URL`和`X-Rewrite-URL`。如果网站使用严格的前端控制来限制基于 URL 的访问，但应用程序允许通过请求标头覆盖 URL，则有可能使用如下请求绕过访问控制:

`POST / HTTP/1.1
X-Original-URL: /admin/deleteUser`

这里是我们的 web 应用程序

![](img/0b77473bb4f0b0c44d84be522fd10f6e.png)

让我们访问管理面板

![](img/753ab51b78fbfd4c9d88516eb382172e.png)

因此，我们不允许看到管理面板，当然，很明显，这只是为管理员，而不是为我们。

让我们看看 burp suite 中的请求

![](img/50ab7e82fb5fb85eec301e116b0052e6.png)

好的，它正在向/admin 端点发送 get 请求，因此必须为普通用户设置类似于`DENY: POST, /admin/dashboard, non-admin-users`的规则。

现在让我们尝试使用`X-Original-URL`头来绕过这个限制。

![](img/ba7571603aef121407c54e27616c1e4b.png)

发送请求后

![](img/97c2228acfdc1ec93fd6988ddd5a2ebf.png)

我们成功地获得了这个管理功能的访问权。

现在让我们删除 carlos 帐户

我们将发送另一个请求

![](img/90822e7ba81a267da4cfcf53cc2c53d8.png)![](img/eafe8083ad061e3499b7e4224b82b29c.png)

我们成功删除了卡洛斯账户

现在假设即使这个“X-Rewrite-URL”技巧不起作用，或者任何头技巧都不起作用，那么您必须求助于改变请求方法。这是非常有效的，它被用作很多其他弱点的旁路技巧，比如 CSRF。

如果请求使用 get 方法，请将请求方法更改为 post；如果请求使用 post 方法，请将请求方法更改为 get。

让我们分析一下这个 webapp

![](img/7e14e2d70c68a55d984705910bf89ec2.png)

在这个 web 应用程序中，我们获得了用户凭据和管理员凭据

`administrator:admin` < -管理员账号

`wiener:peter` < -用户账号

管理员有权提升任何用户作为管理员在这个 web 应用程序中，我们的目标是提升我们自己(维纳)作为管理员。

当我们处理白盒测试或 bug 奖励时，经常会出现这种情况，我们会得到特权和非特权帐户。

特权帐户是给我们熟悉的网络应用程序，并注意到管理功能，然后我们登录到普通用户帐户，然后尝试访问或使用管理功能。如果我们成功了，那么我们就发现了一个访问控制漏洞。

因此，让我们登录到管理员帐户

![](img/7ef8ca050dfc437e730054ad42bcfa97.png)

管理帐户

好吧，让我们访问管理面板

![](img/240ffea869526f6c378f766d9959c101.png)

好的，我们可以提升或降级用户。让我们提升 carlos，并在打嗝时抓住这一要求。

![](img/9f2792753b4f783178155569db920cdd.png)

好的，这是请求，现在我们将它发送给中继器。

![](img/3467044e36fea939e80ff6625d061115.png)

现在让我们看看检查访问控制错误的经典方法。

1.你基本上登录两个帐户，一个是特权(管理员)，另一个是非特权(普通用户)，在不同浏览器中，或者一个在普通模式，另一个在私人浏览模式。

2.然后，您开始使用管理帐户使用管理功能，并填写 burp 中的 http 历史记录选项卡

3.然后你记下普通用户帐户(非特权)的 cookie:只需重新加载普通用户的主页，你就会在打嗝流量中获得 cookie。

4.记下 cookies 后，你进入 http history 选项卡，该选项卡已经填充了管理员帐户对不同功能的请求。

5.您在 repeater 中发送一个这样的请求，然后用您记下的普通用户 cookie 交换 admin 的 cookie。

6.之后，如果函数被执行，你发送请求，那么这是一个访问控制错误，因为你使用的 cookies 不是管理员帐户，而是普通用户帐户，所以你在普通用户会话的上下文中使用管理员函数。

当然，像 AUTORISE 这样的打嗝扩展会自动为你完成这些任务，它还包含许多其他的东西。

因此，我们还将检查授予 admin 的提升和降级功能的访问控制漏洞。

现在让我们打开一个私人模式，作为普通用户登录

![](img/c7ebd1977e3086127fca9bffbe5a127d.png)

普通用户帐户

现在让我们重新加载主页，看看打嗝的流量

![](img/c406b2039d4fa7fc55d6c25892b98e58.png)

让我们复制饼干

现在请记住，我们向中继器发送了提升 carlos 的请求(该请求由 admin 帐户生成)。

我们的目标是将我们自己(维纳)提升为管理员。

让我们将复制的 cookie 粘贴到由 admin 帐户发送给 repeater 的请求中。

![](img/a60df747e1f802d28f092564c0b07bce.png)

我们用之前复制的普通用户的 cookie 替换了 admin cookie，现在我们将用户名改为 wiener(我们自己)。

![](img/afa5d167a653030f8f7cdbd9998dcdc4.png)

所以我们是未经授权的。那么它是否包含任何访问控制漏洞呢？

作为一个勇敢的人，每当你做不到的时候，就要努力尝试

在这种情况下，我前面谈到的更改请求方法可以工作。它可以绕过访问控制实现让我们试试

让我们右键单击请求并选择“更改请求方法”。

现在，我们已经将请求方法从 POST 转换为 GET。

![](img/2f3ada6e6a485f309ae52d70ee38a528.png)

让我们播放请求

![](img/9b918cb54ff996cb2f5a71e7172e3b04.png)

我们得到一个 302 重定向，而不是 401 未经授权看起来像我们做了一些应用程序没有预料到的事情。

让我们跟随重定向

![](img/29f6250b7656b3c8355b79bf6ab8b145.png)

万岁我们成功绕过了 web 应用中的访问控制实现，把自己变成了 admin。web 应用程序测试的规则之一是总是提供应用程序不期望的输入，并看到 web 应用程序的行为。

在这里，开发人员实施了防御措施，以防止对“/admin”的任何未经授权的访问，但没有假设如果应用程序收到 get 请求而不是预期的 post 请求会发生什么。

现在考虑另一个 web 应用程序

![](img/f2ec6efaf3369b13048f5ddfaa4dfcc5.png)

我们得到了一个用户名列表和一个测试帐户

用户是`wiener,administrator,carlos`

现在我们的测试凭证是`wiener:peter`

让我们转到“我的帐户”

![](img/fb9aa2de2ef2341d34e1566e9f819c53.png)

因此，在这里我们可以改变我们的电子邮件地址和我们的 API 密钥也给定。

让我们仔细看看这个 URL，注意“id”参数，它的值被设置为 out username wiener。

现在，如果我们将 id 的值更改为其他用户名，会发生什么情况。

![](img/b2ca65f3e931f52c1b2f288785cf2212.png)

我们的 API 密钥更改意味着这是 carlos 帐户的 API 密钥。

现在让我们将它改为 administrator，以获得 admin 的 API 密钥

![](img/417b277411b2d71a3b5af93a8a69cdfe.png)

现在，我们管理 API 密钥，以便我们可以将这些帐户链接到第三方，并代表这些帐户使用服务。

我们看到的是 IDOR 的经典例子。

IDORS 总是将这些参数的值更改为其他用户的相应参数的值，并查看我们是否可以像其他用户一样访问功能。

如果一个 web 应用程序包含用户枚举漏洞和 IDOR，攻击者可以很容易地获得用户名，甚至他可以猜出用户名，因为这些只是字符串。

因为只有通过改变用户名，我们才能访问其他帐户信息，但这并不总是这么简单。有时不是用户名而是 GUID 或 UUID 被用作这些参数的值，这些参数是不可猜测的并且对每个帐户都是唯一的。

一个**通用唯一标识符** ( **UUID** )是一个 128 位的数字，用于识别计算机系统中的信息。术语**全球唯一标识符** ( **GUID** )也被使用，通常在微软创建的软件中。

当按照标准方法生成时，UUIDs 实际上是唯一的。与大多数其他编号方案不同，它们的唯一性不依赖于中央注册机构或生成它们的各方之间的协调。虽然 UUID 被复制的概率不为零，但它已接近于零，可以忽略不计。

它们的格式类似于 123 e 4567-e89b-12 D3-a456–426614174000

![](img/50109a4a8687c14b8be9a82375100de2.png)

在这个 web 应用程序中，我们将 id 参数设置为 GUID，它对每个帐户都是唯一的。

![](img/4a9e64e487f98d8d843e6fa26a3e0834.png)

这个 GUID 对于其他用户来说是不可预测的，所以我们不能仅仅通过知道其他用户的用户名来获得 GUID。

即使它是不可预测的，它也不应该被用来防御 IDOR，因为这些 GUID 可能会在某个地方泄漏。

让我们转到主页，进一步探索 web 应用程序，为其他用户找到 GUID。

![](img/498e21f7f0caf76effaabbd78d1a26ea.png)

这些网站包含博客，现在博客是由 web 应用程序的用户编写的，所以这是其他用户与 web 应用程序交互的地方，所以肯定有一些有趣的信息，让我们开始访问这些博客。

![](img/8d4037ddd43c020ea4a9ff2d37ad7e83.png)

好的，让我们看看源代码

![](img/e90528d4f7ea1c377168601d50fdacd8.png)

源代码泄漏了博客所有者的 GUID。

这是另一个博客

![](img/30d7f529011ecce21a1b0fc05c6d382d.png)

博客的所有者是管理员，我们可以从源代码中看到这一点

![](img/6c390116a884c05a636dfba3dd36861a.png)

每当我们遇到这种 GUID 和 UUID 时，我们就会查看用户的公共可访问信息，如他们的公共个人资料页面或用户与 webapp 的任何其他公共交互，并查看是否有任何类似这些的标识符被暴露。

在某些情况下，应用程序会检测到用户何时被禁止访问资源，并返回一个到登录页面的重定向。但是，包含重定向的响应可能仍然包含属于目标用户的一些敏感数据，因此攻击仍然是成功的。

在此 webapp 中

![](img/0e78772e9a09611c75da252746941ce6.png)![](img/3586087493989625e500f2e8b6d6a1af.png)

现在，让我们将 id 更改为 carlos user，并重新加载页面，捕获请求和响应

![](img/278045f0b7e16b2b0eb570c6ce0efe21.png)![](img/f83ecb6ebce4c8c38da8e2499ba378c3.png)![](img/02ad3d12cf6560266345557549235fb2.png)

我们在响应中获得了 carlos 帐户的 API 密钥。

拦截对请求的响应总是一个好主意，它可能包含敏感信息，这是获取 bug 奖金的好方法。

有时在 web 应用程序中

![](img/2a791439e2db5d36e3033eabc759708a.png)

在更改设置页面或类似的页面上，如果有一个 IDOR，这意味着它可以导致帐户接管，因为我们可以简单地更改另一个用户的设置

就像这里一样，如果我们将 id 参数更改为另一个用户，比如管理员，那么我们可以更改他的密码

![](img/9a5e45952ada079cb58d624be80e14e9.png)

我们获得了管理 API 密钥，也可以改变管理员密码。

总是改变 post 请求或 get 请求中的参数总是将它们更改为另一个用户的参数。

有时，IDOR 不仅仅是接管帐户，它还可以帮助获取其他用户不允许查看的东西或文件

以这个 web 应用程序为例

![](img/fdc7d51787ad436b4234b5fd4de0cc3f.png)

现在让我们进一步探索这个网站

![](img/d5e654c9b8a3eb179abac0ece59806be.png)

这个网站有实时聊天的功能

![](img/724ba5ef4cff4b5cf9f42087694caadc.png)

实时聊天还有另一个功能，可以下载对话，点击查看文字记录

![](img/44388239d3d0275d2031681e83bee074.png)

它把所有发生的对话都下载成文本文件

让我们再使用一次这个功能，但这次我们将看到打嗝流量。

![](img/c9a4b3496eda5bd3e3d10880aa2b41d5.png)![](img/0d3ffc05a5aaccee2cc1fba1001cbdc1.png)

现在它将从 web app 的服务器下载 11.txt 文件，但我们可以获得信息。

我在这里得到的直觉是，我将能够通过把数字 11 换成别的东西比如说 1 来访问别人的抄本

所以我把 11.txt 改成了 1.txt

![](img/4c731650b723a0664a31259cee6fa501.png)![](img/b96c1d05216bd8d80b86cc69775638fd.png)

它从服务器下载了 1.txt 文件，让我们看看它的内容

![](img/ffb8e802c66a53e5e7115154ca1d1b8e.png)

在这里，我成功地得到了别人的谈话。

IDORS 很容易找到，大多数 web 应用程序都有，所以当我们在寻找 bug 赏金或 web 应用程序测试时，我们应该注意寻找这些 IDORS。

现在许多资源都在这里，以了解研究人员是如何发现它们的

感谢 Cristian Cornea 收集这些 IDOR 报告。

**#1**

> ***标题:*** *IDOR 在*[*www.paypal.com/businessmanage/users/api/v1/users*](http://www.paypal.com/businessmanage/users/api/v1/users)添加二级用户
> 
> ***公司:*** *支付宝*
> 
> ***赏金:****【10500 美元*
> 
> ***链接:***[https://hackerone.com/reports/415081](https://hackerone.com/reports/415081)

**#2**

> ***标题:****Vimeo.com 不安全直接引用对象重置密码*
> 
> ***公司:*** *Vimeo*
> 
> ***赏金:****【5000 美金*
> 
> ***链接:***[*https://hackerone.com/reports/42587*](https://hackerone.com/reports/42587)

**#3**

> ***标题:*** *idor 允许你从图库中删除照片和相册*
> 
> ***公司:*** *RedTube*
> 
> ***赏金:****【1500 美元*
> 
> ***链接:***[*https://hackerone.com/reports/380410*](https://hackerone.com/reports/380410)

**#4**

> ***标题:*** *IDOR 允许任何用户编辑他人视频*
> 
> ***公司:*** *YouPorn*
> 
> ***赏金:****【1500 美金*
> 
> ***链接:***[https://hackerone.com/reports/681473](https://hackerone.com/reports/681473)

**#5**

> ***标题:*** *IDOR —私密视频泄露—/API _ Android _ v3/getuser videos*
> 
> **公司:** *PornHub*
> 
> ***赏金:****【1500 美元*
> 
> 【https://hackerone.com/reports/186279】*链接:*[](https://hackerone.com/reports/186279)

***#6***

> ****标题:****social club 中的 IDOR 严重漏洞允许以其他用户的身份插入和删除评论，并泄露敏感信息**
> 
> ****公司:*** *摇滚明星游戏**
> 
> ****赏金:****【1400 美元**
> 
> ****链接:*【https://hackerone.com/reports/204292】[](https://hackerone.com/reports/204292)***

****#7****

> *****标题:*** *伊多尔·widget.support.my.com***
> 
> *****公司:***mail . ru**
> 
> *****赏金:****1000 美元***
> 
> *****链接:***[*https://hackerone.com/reports/328337*](https://hackerone.com/reports/328337)**

****#8****

> *****标题:*** *IDOR 允许访问任何用户的支付数据***
> 
> *****公司:***nord VPN**
> 
> *****赏金:****【1000 美元***
> 
> *****链接:***[*https://hackerone.com/reports/751577*](https://hackerone.com/reports/751577)**

****#9****

> *****标题:*** *IDOR —访问私人视频缩略图，即使视频需要密码认证***
> 
> *****公司:*** *YouPorn***
> 
> *****赏金:1000 美元*****
> 
> *****链接:***[*https://hackerone.com/reports/197114*](https://hackerone.com/reports/197114)**

****#10****

> *****标题:*** *IDOR 终止其他用户会话***
> 
> *****公司:*** *商店化***
> 
> *****赏金:****【1000 美元***
> 
> *****链接:***[*https://hackerone.com/reports/56511*](https://hackerone.com/reports/56511)**

****#11****

> *****标题:*** *IDOR —通过 PUT /appsuite/api/files 访问其他用户的附件？动作=另存为***
> 
> *****公司:*** *开-汇***
> 
> *****赏金:****【888】美元***
> 
> *****链接:***[*https://hackerone.com/reports/204984*](https://hackerone.com/reports/204984)**

****#12****

> *****标题:*** *IDOR —如果可以访问共享链接，则下载所有附件***
> 
> *****公司:*** *公开-交换***
> 
> *****赏金:****【888】美元***
> 
> *****链接:【https://hackerone.com/reports/194790】***[](https://hackerone.com/reports/194790)**

*****#13*****

> ******标题:*** *从其他商店删除图片****
> 
> *****公司:*** *佐玛托***
> 
> *****赏金:****【600 美元***
> 
> *****链接:***[*https://hackerone.com/reports/404797*](https://hackerone.com/reports/404797)**

****#14****

> *****标题:****【app.mavenlink.com】查看敏感信息的权限***
> 
> *****公司:*** *Mavenlink***
> 
> *****赏金:****【500 美元***
> 
> *****链接:***[*https://hackerone.com/reports/283419*](https://hackerone.com/reports/283419)**

****#15****

> *****标题:****activateFuelCard id 中的 IDOR 允许批量查找驱动 uuid***
> 
> *****公司:*** *优步***
> 
> *****赏金:****【500 美元***
> 
> *****链接:***[*https://hackerone.com/reports/254151*](https://hackerone.com/reports/254151)**

****#16****

> ***标题:**IDOR【partners.shopify.com】—只有管理应用程序权限的用户可以从商店内部获取商店信息和员工姓名***
> 
> *****公司:*** *Shopify***
> 
> *****赏金:****【500 美金***
> 
> *****链接:***[*https://hackerone.com/reports/243943*](https://hackerone.com/reports/243943)**

****#17****

> *****标题:*** *IDOR 导致删除任何账户***
> 
> *****公司:*** *Ubiquiti 公司***
> 
> *****赏金:****【500 美元】***
> 
> *****链接:***[*https://hackerone.com/reports/156537*](https://hackerone.com/reports/156537)**

****#18****

> *****标题:*** *CSRF 结合 IDOR 在文档转换器内暴露文件***
> 
> *****公司:*** *Open-Xchange***
> 
> *****赏金:****【500 美元***
> 
> *****链接:***[*https://hackerone.com/reports/398316*](https://hackerone.com/reports/398316)**

****#19****

> *****标题:****partners.uber.com 上的 IDOR 允许驱动程序覆盖管理员文档***
> 
> *****公司:*** *优步***
> 
> *****赏金:****【500 美元】***
> 
> *****链接:***[*https://hackerone.com/reports/194594*](https://hackerone.com/reports/194594)**

****#20****

> *****标题:*** *IDOR bug 查看任何用户隐藏的慢投票，即使你没有访问权限***
> 
> *****公司:*** *制作器***
> 
> *****赏金:****【300 美元***
> 
> *****链接:***[https://hackerone.com/reports/661978](https://hackerone.com/reports/661978)**

****#21****

> *****标题:*** *IDOR —通过/appsuite/api/snippet 删除其他用户的签名？动作=更新(尽管出现错误)***
> 
> *****公司:****Open-Xchange***
> 
> *****赏金:*** *$300***
> 
> *****链接:***[*https://hackerone.com/reports/199321*](https://hackerone.com/reports/199321)**

****#22****

> *****标题:*** *订单中的 IDOR 和统计漏单***
> 
> *****公司:*** *推特***
> 
> *****赏金:****【289】美元***
> 
> *****链接:***[*https://hackerone.com/reports/544329*](https://hackerone.com/reports/544329)**

****#23****

> *****标题:*** *IDOR 查看其他用户文件夹名称***
> 
> *****公司:*** *公开-交换***
> 
> *****赏金:****【250】美元***
> 
> *****链接:***[*https://hackerone.com/reports/333767*](https://hackerone.com/reports/333767)**

****#24****

> *****Title:****IDOR 取消任何桌位预订并泄露邮件、手机号码、uuid 等敏感信息***
> 
> *****公司:*** *佐马托***
> 
> *****赏金:****【250】美元***
> 
> *****链接:***[*https://hackerone.com/reports/265258*](https://hackerone.com/reports/265258)**

****#25****

> *****标题:*** *域“steamcommunity.com”的“Workshop”小节中的评论限制可以使用 IDOR* 绕过**
> 
> *****公司:*** *阀门***
> 
> *****赏金:****【200】美元***
> 
> *****链接:***[*https://hackerone.com/reports/365504*](https://hackerone.com/reports/365504)**

# **奖金:10 个零美元的 IDOR 报告**

****#1****

> *****标题:*** *报表 CSV 导出中的 IDOR 公开了程序自定义字段属性的 id***
> 
> *****公司:*** *排架***
> 
> *****赏金:*** *$0***
> 
> *****链接:***[*https://hackerone.com/reports/510759*](https://hackerone.com/reports/510759)**

****#2****

> *****标题:*** *IDOR on HackerOne 反馈评论***
> 
> *****公司:*** *哈克松***
> 
> *****赏金:*** *$0***
> 
> *****链接:***[*https://hackerone.com/reports/262661*](https://hackerone.com/reports/262661)**

****#3****

> *****标题:*** *IDOR 在更改共享文件名***
> 
> *****公司:*** *Trint 有限公司***
> 
> *****赏金:*** *$0***
> 
> *****链接:***[*https://hackerone.com/reports/547663*](https://hackerone.com/reports/547663)**

****#4****

> *****标题:*** *漏洞概述中的 IDOR 使攻击者能够确定黑客马拉松活动的日期范围***
> 
> *****公司:*** *哈克松***
> 
> *****赏金:****【0】美元***
> 
> *****链接:***[*https://hackerone.com/reports/663431*](https://hackerone.com/reports/663431)**

****#5****

> *****Title:****IDOR on Program visibility(暴露/隐藏)对抗其他团队成员***
> 
> *****公司:*** *钢骨***
> 
> *****赏金:*** *$0***
> 
> *****链接:***[*https://hackerone.com/reports/291721*](https://hackerone.com/reports/291721)**

****#6****

> *****标题:*** *不安全的直接对象引用(IDOR)允许我将其他用户的照片(驾驶证和自拍)声明为我的***
> 
> *****公司:*** *Cuvva***
> 
> *****赏金:*** *$0***
> 
> *****链接:***[*https://hackerone.com/reports/268167*](https://hackerone.com/reports/268167)**

****#7****

> *****标题:*** *泰国—不安全的直接对象引用允许未经授权的用户仅使用受害者的星巴克卡从受害者处转移资金***
> 
> *****公司:***星巴克**
> 
> *****赏金:*** *$0***
> 
> *****链接:***[*https://hackerone.com/reports/766437*](https://hackerone.com/reports/766437)**

****#8****

> *****标题:*** *IDOR 更新其他用户的文件夹名***
> 
> *****公司:*** *Trint 有限公司***
> 
> *****赏金:*** *$0***
> 
> *****链接:***[*https://hackerone.com/reports/587687*](https://hackerone.com/reports/587687)**

****#9****

> *****标题:*** *元数据通过 IDOR* 泄漏**
> 
> *****公司:*** *Polymail，Inc.***
> 
> *****赏金:****【0】美元***
> 
> *****链接:***[*https://hackerone.com/reports/762707*](https://hackerone.com/reports/762707)**

****#10****

> *****标题:****【cnvID】参数容易受到不安全的直接对象引用***
> 
> *****公司:*** *具体 5***
> 
> *****赏金:*** *$0***
> 
> *****链接:***[*https://hackerone.com/reports/265284*](https://hackerone.com/reports/265284)**

**许多网站通过一系列步骤实现重要的功能。当需要捕获各种输入或选项时，或者当用户需要在执行操作之前检查和确认细节时，通常会这样做。例如，更新用户详细信息的管理功能可能涉及以下步骤:**

1.  **包含特定用户详细信息的加载表单。**
2.  **提交更改。**
3.  **查看更改并确认。**

**有时，网站会对其中一些步骤实施严格的访问控制，但会忽略其他步骤。例如，假设访问控制正确地应用于第一步和第二步，但没有应用于第三步。实际上，网站假设用户只有在已经完成了第一步的情况下才会到达第三步，这是受到适当控制的。在这里，攻击者可以通过跳过前两个步骤并直接提交带有所需参数的第三个步骤的请求来获得对函数的未授权访问。**

**这里有一个 webapp，我们被赋予了两个账号`administrator:admin`和`wiener:peter`**

**让我们熟悉一下管理员帐户，看看管理员有哪些功能**

**![](img/2664e10195ad1de80a28c2c9aa6572a9.png)****![](img/55cd01deafdda86d938eaf1ec7a96fc8.png)**

**因此，我们可以再次降级和升级用户。让我们通过将 carlos 升级为管理员来检查功能**

**![](img/ea3cc85aa654ea48648b6c5aa6696dfc.png)**

**这一次有另一个功能让我们再一次考虑我们的决定。现在让我们点击“不，带我回去”**

**现在，我们将再次尝试使卡洛斯管理员这一次，我们将看到所有发生在打嗝，我们将尝试绕过访问控制。**

**我们将保存这两个请求(首先是升级 carlos，其次是确认将 carlos 升级为管理员),然后尝试与普通用户交换 cookies，以查看此功能是否容易受到破坏的访问控制的攻击。**

**![](img/2b9be8762543ef00615d067f1dc8d7e5.png)**

**请求将 carlos 升级为管理员**

**![](img/2720b9e6eb9959d6c05ad3c1b013cf8e.png)**

**请求确认卡洛斯为管理员**

**现在，我们将从私人浏览模式登录我们的普通用户帐户**

**![](img/5c893c01f988ad6c179acf43ad517a10.png)**

**现在，我们将重新加载页面并查看流量，以获取用户的正常 cookie**

**![](img/bcaf24c0b078aea7a8373fc203ccc2c2.png)**

**现在，我们将再次逐一重放来自管理员帐户的两个请求，用普通用户的 cookie 交换 cookie，并将用户名改为 wiener**

**![](img/88b1e400a12920a7e7bcc938a3f9da86.png)**

**这是回应**

**![](img/090a6ab14c3e0d46faafde4560de8a30.png)**

**我们未经授权**

**让我们检查第二个请求**

**![](img/2d2a9227810e2329b627f96f4d184764.png)**

**我们得到的回应是**

**![](img/6b1c46cd25c281b841fba83ce082f8a7.png)**

**让我们跟随重定向**

**![](img/e8d609f590e0dde79e076499ce3ee1c9.png)**

**我们被重定向到/admin 端点，让我们看看它的响应**

**![](img/df7f535a1c5f590467dfceb6884cd7ce.png)**

**我们把自己变成了管理员。**

**在这里提升任何用户为管理员的请求都被发送。正如我们所尝试的，第一个不容易受到攻击，但是第二个容易受到攻击，所以每当一个功能中有更多的步骤时，我们应该检查每一个方法是否有 bug。**

**现在让我们来谈谈 Referer 头**

**HTTP **referer** 是一个可选的 HTTP **header** 字段，用于标识链接到所请求资源的网页地址(即 URI 或 IRI)。通过检查 referrer，新网页可以看到请求是从哪里发出的。**

**`**Referer**`请求头包含前一个网页的地址，从这个地址可以链接到当前请求的页面。`Referer`头允许服务器识别人们从哪里访问他们，并可能使用该数据进行分析、记录或优化缓存。**

****支持的浏览器:**与 **HTTP header Referer** 兼容的浏览器如下:**

*   **谷歌浏览器**
*   **微软公司出品的 web 浏览器**
*   **微软 Edge**
*   **火狐浏览器**
*   **歌剧**
*   **旅行队**

**一些网站基于 HTTP 请求中提交的`Referer`头进行访问控制。浏览器通常会将`Referer`头添加到请求中，以指示发起请求的页面。**

**例如，假设一个应用程序在`/admin`的主管理页面上强制执行访问控制，但是对于像`/admin/deleteUser`这样的子页面，只检查`Referer`页面头。如果`Referer`头包含主`/admin` URL，那么请求被允许。**

**在这种情况下，由于`Referer`标题可以完全被攻击者控制，他们可以伪造对敏感子页面的直接请求，提供所需的`Referer`标题，从而获得未经授权的访问。**

**这是一个网络应用**

**![](img/635ac4387c81196ea99e83bae4367e00.png)**

**我们再次获得管理员凭证`administrator:admin`以更好地理解应用程序和普通用户凭证`wiener:peter`**

**让我们使用管理员凭据登录并探索网站的更多信息**

**![](img/007edd7040c0377076e10ef5211b528a.png)****![](img/e78760adf894acc01764b804dc1c235c.png)**

**现在让我们尝试升级 carlos 用户并捕获请求**

**![](img/a77e2026ea70611c0afc7f090e3271a6.png)**

**允许在浏览器的私人模式下以普通用户身份登录**

**![](img/63cffdb780b6c6b6f8af26ef38dea6bd.png)**

**让我们尝试使用普通用户帐户访问“/admin-roles”端点**

**![](img/bdcf1ba98248dcd3d46a8d589be2b91f.png)**

**好的，让我们尝试通过向端点'/admin-roles '发送请求来将自己升级为 admin，请求中包含的参数 username 的值将被设置为 wiener，操作参数的值将被设置为 upgrade。**

**![](img/9dba70c34c47b26c6c00e3a07b00ca9e.png)**

**普通用户发送的请求**

**这是我们得到的回应**

**![](img/06e9b1b4635e09f93b0001e6e0ab0ae2.png)**

**我们在将用户 carlos 升级为 admin 的 admin 请求中看到了 Referer 标头，现在我们将添加该标头，并将其值设置为与之前的 admin 请求相同。**

**![](img/56ca96c25b9aa1ba64c70ff96985c889.png)**

**让我们看看请求的响应**

**![](img/7a67cd9ffc6671d7d065b9c8c55eb43c.png)****![](img/97fdef2d916d861cf3176c602331cb05.png)**

**因此，我们能够成功地使自己成为管理员。**

> ****如何防范访问控制漏洞****

**访问控制只有在受信任的服务器端代码或无服务器 API 中实施时才有效，在这种情况下，攻击者无法修改访问控制检查或元数据。**

*   **默认情况下拒绝访问功能。**
*   **使用访问控制列表和基于角色的身份验证机制。**
*   **不要只是隐藏函数。**

**没有一种通用的解决方案可以正确实施访问控制。一般来说，您的访问控制策略应该涵盖三个方面:**

*   ****认证** —当用户返回应用程序时，正确识别用户。**
*   ****授权** —决定用户在通过身份验证后应该和不应该执行的操作。**
*   ****权限检查** —在用户试图执行一个动作的时间点评估授权。**

**授权通常是通过授予每个用户特定的角色来实现的。(例如，管理用户通常与普通用户不同。)如果各个文档或数据项需要具有单独的特权，则需要实现更细粒度的许可方案。**

**授权方案通常实现了一种**所有权**的思想。某些资源可以**属于**一个用户或一组用户，没有他们的许可，其他人可能无法访问。**

**最后，访问控制方案通常被声明为**策略**，这些策略将特定的实体和组列入白名单或黑名单，以阻止某些操作。**

**鉴于这种复杂性，设计正确的访问控制需要时间和仔细的思考。您需要遵循一些指导原则:**

*   ****确定你的组织面临的最大风险是什么，并专注于降低这些风险。****
*   ****提前设计并记录您的访问控制方案。**需要在整个系统中正确实施访问控制。没有一套一致同意的规则，很难定义“正确的”实现是什么样子的。**
*   ****尝试在您的代码库中集中访问控制决策。**这并不一定意味着所有的访问决策都通过一个代码路径，但是你应该有一个评估访问控制决策的标准方法。这可能包括函数装饰器、web 访问路径检查、数据库中的存储过程层、代码中的内联断言，或者对专用许可组件或内部 API 的调用。**
*   ****严格测试访问控制。确保你的测试程序真正试图在你的访问控制方案中找到漏洞。像攻击者那样对待它，当你第一次真正的攻击发生时，你会准备得更充分。如果您有时间和预算，可以考虑雇佣一个外部团队来执行渗透测试。****

**Python 中的大多数网络框架(Django，Flask，Tornado 等。)将 web 请求路由到各个类或函数。当评估一个用户是否应该访问给定的资源时，[decorator](http://en.wikipedia.org/wiki/Python_syntax_and_semantics#Decorators)提供了一个非常有用的语法。它们可以用于在调用函数之前检查权限，并且可以以一种不引人注目的声明性方式添加到代码中。**

**devise gem 是一个非常全面的身份验证解决方案，允许您挑选您想要的功能。它提供了助手方法，以最少的麻烦在控制器、路由逻辑或模板文件中执行访问控制决策。**

**Java 身份验证和授权服务(JAAS)是 Java 访问控制的行业标准。权限可以动态或以声明方式描述，并根据 URL 路径或在代码中进行评估。**

**ASP。NET 附带了一个全面的授权和身份验证框架，可用于对特定控制器、控制器中的特定功能或代码中的特定位置进行全局访问控制决策。**

**MustBe 和 ACL 是成熟的库，分别关注访问控制的不同方面:web 服务器路由和访问控制规则的评估。**

**访问控制漏洞通常可以通过采取深度防御方法和应用以下原则来防止:**

*   **永远不要仅仅依靠模糊来进行访问控制。**
*   **除非资源可以公开访问，否则默认情况下拒绝访问。**
*   **尽可能使用单个应用程序范围的机制来实施访问控制。**
*   **在代码级别，强制开发人员声明每个资源允许的访问，并在默认情况下拒绝访问。**
*   **彻底审计和测试访问控制，以确保它们按设计运行。**