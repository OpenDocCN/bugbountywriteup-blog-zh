<html>
<head>
<title>Alternate Data Streams (ADS)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">交替数据流(ADS)</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/alternate-data-streams-ads-54b144a831f1?source=collection_archive---------0-----------------------#2020-08-20">https://infosecwriteups.com/alternate-data-streams-ads-54b144a831f1?source=collection_archive---------0-----------------------#2020-08-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="0186" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">ADS在CTF和Pentesting环境中的实际但基本的应用</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/e30ac629994429de9b8553e484f701ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HL5nlbu3XIEMhw2a5QuMOg.jpeg"/></div></div></figure><h2 id="5de8" class="kr ks iq bd kt ku kv dn kw kx ky dp kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">那么什么是备用数据流(ADS)？</h2><p id="d347" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">它是新技术文件系统(也称为NT文件系统(NTFS ))中增加的功能，以增加与Macintosh分层文件系统(HFS)的可比性，用外行人的话说，它使在Mac(苹果)和PC (Windows)上使用文件变得更容易。</p><h2 id="1c53" class="kr ks iq bd kt ku kv dn kw kx ky dp kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">它是如何工作的，我为什么要关心它？</h2><p id="22b9" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">通常，当您将内容保存到文件(例如. txt文件)时，您将文件的内容(ascii文本)存储在一个数据流中，windows将该数据流识别为默认数据流，因此下次打开文件时，您将访问同一数据流来查看您的数据。</p><p id="8a25" class="pw-post-body-paragraph ln lo iq lp b lq mg jr ls lt mh ju lv la mi lx ly le mj ma mb li mk md me mf ij bi translated">例如</p><p id="bcac" class="pw-post-body-paragraph ln lo iq lp b lq mg jr ls lt mh ju lv la mi lx ly le mj ma mb li mk md me mf ij bi translated">如果我在windows系统上使用记事本创建一个. txt文件，并将其保存到一个文件(<em class="ml"> secret.txt </em>)中，那么每次打开它，我都会看到我的数据。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mm"><img src="../Images/dbcaac4946f591770453035288a8a5a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:818/format:webp/1*vZvpzlqWFtPqtb9jnberBg.png"/></div></figure><h2 id="9a5b" class="kr ks iq bd kt ku kv dn kw kx ky dp kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">但是如果文件中有更多您不知道的数据呢？</h2><p id="6063" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">这就是备用数据流发挥作用的地方。</p><p id="92a5" class="pw-post-body-paragraph ln lo iq lp b lq mg jr ls lt mh ju lv la mi lx ly le mj ma mb li mk md me mf ij bi translated">我将使用cmd.exe(命令提示符)来演示这些示例，以便人们更容易理解CLI(命令行界面)，但使用Power Shel<strong class="lp ir"><em class="ml">l</em></strong><em class="ml">也可以获得相同的结果。</em></p><p id="ac05" class="pw-post-body-paragraph ln lo iq lp b lq mg jr ls lt mh ju lv la mi lx ly le mj ma mb li mk md me mf ij bi translated"><strong class="lp ir">因此，当我使用命令提示符查看我的目录内容时，我可以看到我的<em class="ml"> secret.txt </em>和33字节的文件大小。</strong></p><pre class="kg kh ki kj gt mn mo mp mq aw mr bi"><span id="0dea" class="kr ks iq mo b gy ms mt l mu mv"><strong class="mo ir">dir</strong></span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mw"><img src="../Images/3a51e899f0431cbca2426f46253cfe65.png" data-original-src="https://miro.medium.com/v2/resize:fit:936/format:webp/1*nkpp4YGIZMBmg2PbNAJoxw.png"/></div></figure><p id="0132" class="pw-post-body-paragraph ln lo iq lp b lq mg jr ls lt mh ju lv la mi lx ly le mj ma mb li mk md me mf ij bi translated"><strong class="lp ir">这看起来像一个普通的文件，但是如果我将<em class="ml"> /r </em>添加到我的命令中会怎么样？</strong></p><pre class="kg kh ki kj gt mn mo mp mq aw mr bi"><span id="3c70" class="kr ks iq mo b gy ms mt l mu mv"><strong class="mo ir">dir /r</strong><br/></span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mx"><img src="../Images/e6db7549ddb02831ef3b3656984bb49e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1060/format:webp/1*pF0KdJQvVkv_E49mTOvG4Q.png"/></div></figure><p id="8aef" class="pw-post-body-paragraph ln lo iq lp b lq mg jr ls lt mh ju lv la mi lx ly le mj ma mb li mk md me mf ij bi translated">现在，我们可以在同一目录中看到另一个文件，其前缀与我们最初创建的<em class="ml"> secret.txt </em>相同，但后缀为evil.txt，因为<strong class="lp ir"> $DATA </strong>告诉我们这是一个<strong class="lp ir"> $DATA </strong>类型的流。</p><p id="fb95" class="pw-post-body-paragraph ln lo iq lp b lq mg jr ls lt mh ju lv la mi lx ly le mj ma mb li mk md me mf ij bi translated">通过将/r添加到我们的命令中，我们可以看到这两个文件在同一个目录中，但我们只能在桌面上看到<em class="ml"> secret.txt </em>，我们还可以看到文件大小的差异，而我们的<em class="ml"> secret.txt </em>文件仍然是33字节，我们的<em class="ml">secret . txt</em>是74，是我们的<em class="ml"> secret.txt </em>的两倍多。</p><p id="5dc5" class="pw-post-body-paragraph ln lo iq lp b lq mg jr ls lt mh ju lv la mi lx ly le mj ma mb li mk md me mf ij bi translated"><strong class="lp ir">比较两个命令的输出。</strong></p><pre class="kg kh ki kj gt mn mo mp mq aw mr bi"><span id="8f61" class="kr ks iq mo b gy ms mt l mu mv"># First Command<br/><strong class="mo ir">dir</strong></span><span id="9aef" class="kr ks iq mo b gy my mt l mu mv"># Second Command<br/><strong class="mo ir">dir /r</strong></span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/3e55eab5a357d33af7ac1d4fc13e08da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1046/format:webp/1*9zUj70K2c76WqRmzp6MJXQ.png"/></div></figure><p id="34e2" class="pw-post-body-paragraph ln lo iq lp b lq mg jr ls lt mh ju lv la mi lx ly le mj ma mb li mk md me mf ij bi translated">在这种情况下，我们可以通过两个命令更准确地看到信息，我们能够以更清晰的视角看到变化。</p><ul class=""><li id="d801" class="na nb iq lp b lq mg lt mh la nc le nd li ne mf nf ng nh ni bi translated">两个输出都说目录中只有两个文件，并且给出了相同的大小，这是因为secret.txt和secret.txt:evil.txt是相同的文件，而不是不同的文件，但是数据存储在不同的流中。</li><li id="4933" class="na nb iq lp b lq nj lt nk la nl le nm li nn mf nf ng nh ni bi translated">目录中使用的总空间和系统中可用的总空间仍然相同。</li></ul><p id="ba5d" class="pw-post-body-paragraph ln lo iq lp b lq mg jr ls lt mh ju lv la mi lx ly le mj ma mb li mk md me mf ij bi translated"><strong class="lp ir">让我们一起来看看两者的内容:</strong></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi no"><img src="../Images/e97b72954a02bbef6d2678161ef58f51.png" data-original-src="https://miro.medium.com/v2/resize:fit:1178/format:webp/1*7FxIh4kgnigYpsK7raVOag.png"/></div></figure><p id="ecd6" class="pw-post-body-paragraph ln lo iq lp b lq mg jr ls lt mh ju lv la mi lx ly le mj ma mb li mk md me mf ij bi translated">当查看它们时，我们可以看到内容不同，我们还可以看到文件名的不同，这使我们想到我们可以轻松地将信息存储在备用数据流中以用于多种目的。数据流在NTFS文件系统中遵循一个基本的命名约定，即<strong class="lp ir"> <em class="ml">文件名:流名:流类型</em> </strong>已经说过<em class="ml"> secret.txt </em>在NTFS文件系统中的全名将是<strong class="lp ir"><em class="ml">secret . txt::$ DATA</em></strong></p><p id="006c" class="pw-post-body-paragraph ln lo iq lp b lq mg jr ls lt mh ju lv la mi lx ly le mj ma mb li mk md me mf ij bi translated">不在记事本中打开它们的另一种方法是。</p><pre class="kg kh ki kj gt mn mo mp mq aw mr bi"><span id="203b" class="kr ks iq mo b gy ms mt l mu mv"># View secret.txt<br/>type secret.txt</span><span id="1e3a" class="kr ks iq mo b gy my mt l mu mv"># View Alternate Data Stream <br/>more &lt; secret.txt:evil.txt</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi np"><img src="../Images/135b1740a4fdc23322090d87586ee110.png" data-original-src="https://miro.medium.com/v2/resize:fit:1164/format:webp/1*sioJ9-Szo0CJeEyx-mU3uA.png"/></div></figure></div><div class="ab cl nq nr hu ns" role="separator"><span class="nt bw bk nu nv nw"/><span class="nt bw bk nu nv nw"/><span class="nt bw bk nu nv"/></div><div class="ij ik il im in"><p id="799a" class="pw-post-body-paragraph ln lo iq lp b lq mg jr ls lt mh ju lv la mi lx ly le mj ma mb li mk md me mf ij bi translated"><strong class="lp ir">现在我们知道了什么是备用数据流，您将如何创建一个呢？</strong></p><ul class=""><li id="5d0e" class="na nb iq lp b lq mg lt mh la nc le nd li ne mf nf ng nh ni bi translated">让我们先创建一个普通的<em class="ml"> secret.txt </em>文件</li></ul><pre class="kg kh ki kj gt mn mo mp mq aw mr bi"><span id="e399" class="kr ks iq mo b gy ms mt l mu mv"># Creating a basic .txt file<br/>echo &lt;YOUR TEXT&gt; &gt; filename.txt</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nx"><img src="../Images/ffd830d53ae53b001afe55fa5cf37105.png" data-original-src="https://miro.medium.com/v2/resize:fit:1216/format:webp/1*0CD_P9ZsAxMr_lQSfXj9gQ.png"/></div></figure><ul class=""><li id="c1ac" class="na nb iq lp b lq mg lt mh la nc le nd li ne mf nf ng nh ni bi translated">现在我们已经创建了一个没有任何备用数据流的secret.txt文件。</li></ul><pre class="kg kh ki kj gt mn mo mp mq aw mr bi"><span id="8eca" class="kr ks iq mo b gy ms mt l mu mv"># Creating an Alternative Data Stream <br/>echo &lt;YOUR DATA&gt; &gt; filename.txt:streamname.txt<br/></span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ny"><img src="../Images/11a8fe4eb1243d320a6272ae022bb94a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Tvi1OjSyq30C64cAI5LGsQ.png"/></div></div></figure><p id="e7de" class="pw-post-body-paragraph ln lo iq lp b lq mg jr ls lt mh ju lv la mi lx ly le mj ma mb li mk md me mf ij bi translated">另一个好处是备用数据流允许一个以上的数据流与一个文件名相关联。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nz"><img src="../Images/5122221ea72c2026a00db6fdeaaa56a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1126/format:webp/1*dsCoXMzmE-sQ7cdj7uEjMg.png"/></div></figure><p id="2939" class="pw-post-body-paragraph ln lo iq lp b lq mg jr ls lt mh ju lv la mi lx ly le mj ma mb li mk md me mf ij bi translated">您不需要将您的备选数据流仅限于类型<strong class="lp ir"> $DATA </strong>，因为还有其他类型的数据流可能更适合您的目的。</p><p id="5607" class="pw-post-body-paragraph ln lo iq lp b lq mg jr ls lt mh ju lv la mi lx ly le mj ma mb li mk md me mf ij bi translated">要了解更多信息，我建议访问参考资料部分的链接。</p></div><div class="ab cl nq nr hu ns" role="separator"><span class="nt bw bk nu nv nw"/><span class="nt bw bk nu nv nw"/><span class="nt bw bk nu nv"/></div><div class="ij ik il im in"><p id="93b0" class="pw-post-body-paragraph ln lo iq lp b lq mg jr ls lt mh ju lv la mi lx ly le mj ma mb li mk md me mf ij bi translated">现在我们知道了如何查看和创建备用数据流，但这看起来并无大碍，您仍然想知道为什么要关心这个。</p><p id="ca2e" class="pw-post-body-paragraph ln lo iq lp b lq mg jr ls lt mh ju lv la mi lx ly le mj ma mb li mk md me mf ij bi translated">即使广告不是出于任何邪恶的目的而创建的，它也可以很容易地被用来在目标系统上运行恶意文件，如后门或rootkit，从像您的计算器这样无害的东西。</p><p id="67b9" class="pw-post-body-paragraph ln lo iq lp b lq mg jr ls lt mh ju lv la mi lx ly le mj ma mb li mk md me mf ij bi translated"><strong class="lp ir">概念验证:</strong></p><p id="8da8" class="pw-post-body-paragraph ln lo iq lp b lq mg jr ls lt mh ju lv la mi lx ly le mj ma mb li mk md me mf ij bi translated">让我们添加一个替代数据流到我们的计算器应用程序，但这次我们不会添加一个文本文件，而是一个可执行文件。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oa"><img src="../Images/ce01cc4143fb31d2dabd1117041b3bd0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1110/format:webp/1*w36ZBOWNiy35hg-uIpnhag.png"/></div></figure><blockquote class="ob oc od"><p id="08e3" class="ln lo ml lp b lq mg jr ls lt mh ju lv oe mi lx ly of mj ma mb og mk md me mf ij bi translated">虽然<em class="iq">evil.exe</em>可以是您想要的任何东西，但在这个测试案例中，它是一个反向shell，将连接回我的Kali Linux机器。如果你不熟悉反向外壳，你可以参考我的文章<a class="ae oh" href="https://medium.com/@Proclus/reverse-bind-shells-for-everyoned-e7507853bf4e" rel="noopener">反向&amp;绑定给大家</a>来了解更多。</p></blockquote><ul class=""><li id="089a" class="na nb iq lp b lq mg lt mh la nc le nd li ne mf nf ng nh ni bi translated">在第一条命令中，我们将<em class="ml">evil.exe</em>的内容发送(重定向)到<em class="ml">calc.exe</em>的备用数据流，名为<em class="ml"> calc.exe:evil.exe。</em></li><li id="2659" class="na nb iq lp b lq nj lt nk la nl le nm li nn mf nf ng nh ni bi translated">通过<strong class="lp ir"> dir /r </strong>我们可以看到，我们成功地用恶意文件创建了一个替代数据流。</li></ul><p id="1b12" class="pw-post-body-paragraph ln lo iq lp b lq mg jr ls lt mh ju lv la mi lx ly le mj ma mb li mk md me mf ij bi translated">现在，我们可以将它作为任何可执行文件从我们的CLI运行，但如果我们这样做，我们会得到:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oi"><img src="../Images/d4095d8f80fcf0a8687facf5a30bf380.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XgeIMyQ9CoX_LpvXt4nvSQ.png"/></div></div></figure><p id="9e96" class="pw-post-body-paragraph ln lo iq lp b lq mg jr ls lt mh ju lv la mi lx ly le mj ma mb li mk md me mf ij bi translated">原因是:windows已经在较新版本的windows中修补了这个漏洞，所以这种方法会失败，因为windows不知道如何处理它，但我们仍然有一种方法来解决它。</p><p id="e2b2" class="pw-post-body-paragraph ln lo iq lp b lq mg jr ls lt mh ju lv la mi lx ly le mj ma mb li mk md me mf ij bi translated">在我们运行这个之前，我们应该确保在Kali机器上设置一个监听器。</p><pre class="kg kh ki kj gt mn mo mp mq aw mr bi"><span id="e66a" class="kr ks iq mo b gy ms mt l mu mv">forfiles /P C:\Windows\System32 /m calc.exe /c "C:\Users\admin\Desktop\calc.exe:evil.exe"</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oj"><img src="../Images/16a04cec3b7af567d5518ac2942f8ef5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HNaLUfIaaKhQ3jg_DJxyIA.png"/></div></div></figure><p id="7ae2" class="pw-post-body-paragraph ln lo iq lp b lq mg jr ls lt mh ju lv la mi lx ly le mj ma mb li mk md me mf ij bi translated">这现在已经工作并执行我们的<em class="ml">evil.exe</em>数据流。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ok"><img src="../Images/85bef0558967ecf5debfcdbfe4634c26.png" data-original-src="https://miro.medium.com/v2/resize:fit:1146/format:webp/1*hjhmeA2_FOS1c40og75prw.png"/></div></figure><p id="07de" class="pw-post-body-paragraph ln lo iq lp b lq mg jr ls lt mh ju lv la mi lx ly le mj ma mb li mk md me mf ij bi translated">我们可以看到，我们在Kali机器上从这个windows盒子中捕获了一个反向shell。</p></div><div class="ab cl nq nr hu ns" role="separator"><span class="nt bw bk nu nv nw"/><span class="nt bw bk nu nv nw"/><span class="nt bw bk nu nv"/></div><div class="ij ik il im in"><h1 id="3b37" class="ol ks iq bd kt om on oo kw op oq or kz jw os jx ld jz ot ka lh kc ou kd ll ov bi translated">摘要</h1><p id="9a41" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">虽然备用数据流的主题在其他资源中有很好的介绍，但它可能特别隐蔽，因为一些分析师可能没有意识到这一点。大多数主要的防病毒公司都可以扫描它们，并且有许多工具可用于查看和操作数据流。仍然有许多方法可以恶意使用它们，同时通过将其与反病毒规避相结合而不被检测到，因为这种攻击面不仅限于。txt或者。exe文件，您可以用它来做什么只受您的想象力和创造力的限制。由于备用数据流不会出现在Windows资源管理器或<strong class="lp ir"> dir </strong>命令的默认输出中，大多数用户都不知道它的存在，尽管仍有已知的恶意软件样本利用ADS来隐藏代码，但用于与之交互的命令多年来已经发生了变化。概念验证中显示了一个简单的示例。我建议你也试着用Powershell来复制这个方法，因为这样你会有更多的灵活性，而且广告有时会出现在CTF的电脑上，或者出现在像<a class="ae oh" href="https://www.hackthebox.eu/" rel="noopener ugc nofollow" target="_blank"> hackthebox </a>这样的平台上。</p><h2 id="dd93" class="kr ks iq bd kt ku kv dn kw kx ky dp kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">资源</h2><div class="ow ox gp gr oy oz"><a href="https://docs.microsoft.com/en-us/windows/win32/fileio/file-streams" rel="noopener  ugc nofollow" target="_blank"><div class="pa ab fo"><div class="pb ab pc cl cj pd"><h2 class="bd ir gy z fp pe fr fs pf fu fw ip bi translated">文件流(本地文件系统)- Win32应用程序</h2><div class="pg l"><h3 class="bd b gy z fp pe fr fs pf fu fw dk translated">流是一个字节序列。在NTFS文件系统中，流包含写入文件的数据，并且…</h3></div><div class="ph l"><p class="bd b dl z fp pe fr fs pf fu fw dk translated">docs.microsoft.com</p></div></div></div></a></div><div class="ow ox gp gr oy oz"><a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc781134%28v=ws.10%29" rel="noopener  ugc nofollow" target="_blank"><div class="pa ab fo"><div class="pb ab pc cl cj pd"><h2 class="bd ir gy z fp pe fr fs pf fu fw ip bi translated">NTFS的工作原理:本地文件系统</h2><div class="pg l"><h3 class="bd b gy z fp pe fr fs pf fu fw dk translated">适用于:Windows Server 2003、Windows Server 2003 R2版、Windows Server 2003 SP1版、Windows Server 2003 SP2版…</h3></div><div class="ph l"><p class="bd b dl z fp pe fr fs pf fu fw dk translated">docs.microsoft.com</p></div></div><div class="pi l"><div class="pj l pk pl pm pi pn kp oz"/></div></div></a></div></div></div>    
</body>
</html>