<html>
<head>
<title>DGAs and How to Detect Them</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">DGAs及其检测方法</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/dgas-and-how-to-detect-them-c3dbf5211ecf?source=collection_archive---------2-----------------------#2021-06-22">https://infosecwriteups.com/dgas-and-how-to-detect-them-c3dbf5211ecf?source=collection_archive---------2-----------------------#2021-06-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="27c3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">像宙斯，Conficker和许多其他恶意软件使用DGAs(域生成算法)来建立弹性C2服务器</p><p id="6e8d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">实际上，一旦计算机被感染，黑客通过C2(命令和控制)服务器发送指令(文件传输、更新等)。尽管存在许多方法，如IRC、P2P协议、Tor等，但大多数C2使用DNS协议在彼此之间交换数据，因为DNS有几个优点，如:</p><ul class=""><li id="0c52" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated">DNS流量通常被允许通过防火墙</li><li id="5caf" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated">由于Fast-Flux或DGA等技术，使用DNS可以构建更具弹性的僵尸网络</li></ul><p id="b23e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">起初，网络犯罪分子在恶意软件中硬编码了C2的域名。因此，一旦机器被感染，它只需解析嵌入的域名，以获取C2服务器的IP地址。即使它是有效的，一旦被发现，硬编码的域名或C2的IP可以很容易地被列入黑名单。</p><p id="a9a8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">黑客们通过结合动态DNS、DGA和Fast-Flux提出了一个有效的解决方案。在本文中，我将进一步解释什么是DGA以及我们如何检测它。</p><blockquote class="kz la lb"><p id="38aa" class="jn jo lc jp b jq jr js jt ju jv jw jx ld jz ka kb le kd ke kf lf kh ki kj kk ij bi translated"><strong class="jp ir"> NB:动态DNS </strong> ( <strong class="jp ir"> DDNS </strong>)是一种自动更新<a class="ae lg" href="https://en.wikipedia.org/wiki/Domain_Name_System" rel="noopener ugc nofollow" target="_blank">域名系统</a> (DNS)中的<a class="ae lg" href="https://en.wikipedia.org/wiki/Name_server" rel="noopener ugc nofollow" target="_blank">域名服务器</a>的方法，通常是实时的，使用其配置的主机名、地址或其他信息的活动DDNS配置。—维基百科</p></blockquote></div><div class="ab cl lh li hu lj" role="separator"><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm"/></div><div class="ij ik il im in"><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi lo"><img src="../Images/a968421f1036548021d80300dec794a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*-ygiJRRCoyqtDeff.jpg"/></div></div></figure><h1 id="cfd7" class="ma mb iq bd mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx bi translated">一.什么是DGA？</h1><p id="3f9f" class="pw-post-body-paragraph jn jo iq jp b jq my js jt ju mz jw jx jy na ka kb kc nb ke kf kg nc ki kj kk ij bi translated">DGAs是用于定期生成大量域名(因此得名)的算法。C2服务器可以使用这些域名与僵尸网络的僵尸进行通信。僵尸将试图通过请求所有(或仅一部分)生成的域名来联系C2。如果域名被DNS服务器成功解析，他们将收到来自C2的更新或命令。</p><p id="fa2f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们举个例子:被感染电脑上的DGA创建了10000个域名。与此同时，C2上的DGA创建了与受感染bot相同的域名列表，但其IP仅映射到一个域名。然后，bot请求DNS服务器从生成的10000个域名中获取1000个IP。这些DNS请求中的绝大多数(在我们的例子中是999个)将由“NXDomain”来回答，这意味着没有IP被映射到所请求的域名。但是其中一个域名将被解析为C2的IP，并且可以通过发送加密的DNS有效负载或使用DNS隧道传输其他应用协议(如SSH)在C2和受感染的计算机之间开始通信</p><p id="9e49" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，为了工作，C2必须将其IP与DNS服务器生成的域名之一进行映射。这就是动态DNS的关键所在，因为它允许C2在DNS服务器中更新其域名</p><p id="de19" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这样，安全人员很难处理它，因为:</p><ul class=""><li id="1a39" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated">域名不再是硬编码的，可以很容易地改变。因此，将域名列入黑名单的效率比以前低了</li><li id="9f60" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated">查询的域名范围很广，很难猜测哪一个与C2的域名相对应</li><li id="1246" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated">如果C2以前使用的域名被封锁。C2将其映射切换到另一个域名</li><li id="282f" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated">与此同时，为了避免IP黑名单，C2也可以通过使用诸如<a class="ae lg" href="https://en.wikipedia.org/wiki/Fast_flux" rel="noopener ugc nofollow" target="_blank"> Fast flux </a>之类的技术不断改变他们的IP</li></ul><p id="2d38" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">生成的域名取决于算法。有些生成一个伪随机字符序列:</p><ul class=""><li id="0d2e" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated">hpaxgpkteomjaxywwelr.com</li></ul><p id="62fa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">还有一些基于字典中的单词或名称(基于字典的DGA):</p><ul class=""><li id="ff72" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated">mariabellahuddleson.net</li></ul><p id="8e88" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你可以在https://github.com/baderj/domain_generation_algorithms的<a class="ae lg" href="https://github.com/baderj/domain_generation_algorithms" rel="noopener ugc nofollow" target="_blank">上看到更多例子</a></p><p id="2c5d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将在下一部分看到，我们可以使用由DGA生成的域名模式来发现对C2的DNS请求。</p><h1 id="8d4b" class="ma mb iq bd mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx bi translated">二。如何对抗DGAs？</h1><p id="e45b" class="pw-post-body-paragraph jn jo iq jp b jq my js jt ju mz jw jx jy na ka kb kc nb ke kf kg nc ki kj kk ij bi translated">有几种方法可以检测由DGA生成的域名:</p><ul class=""><li id="a2f8" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated">反动:基于非监督聚类技术和上下文信息，如NXDomain响应、WHOIS命令、TTL(生存时间)……我们可以评估域名的合法性。例如，如果一个域名在过去10天返回100 NXDomain，并且突然被映射到一个IP，这可能表明C2最近映射到该域名。</li><li id="cda3" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated">实时:基于深度/ML学习技术。我们考虑几个因素，域名的熵，加密或未加密，N-gram，域名的大小，字符的频率，……根据这些特征，我们简单地将它们相加，计算出一个分数，告诉我们一个域名由DGA生成的可能性有多大。或者我们使用这些特征作为机器学习模型的输入。我们表现最好的是深度学习架构，如LSTM或CNN。</li><li id="15d3" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated">逆向工程:如果我们可以访问源代码，我们就可以计算出DGA生成的下一个域名列表，并阻止它们。明显的缺点是我们并不总是有生成域名的代码</li></ul><p id="df86" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">什么效果最好？从我的个人经验来看，机器学习方法可以产生良好的结果，但有一个问题:生成域名的方法的多样性。</p><p id="794a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一个基于字典的DGA将具有与伪随机DGA完全不同的特征:熵、词频……</p><p id="2fe0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这就是为什么基于字典的DGA更难捕捉的原因:因为它们看起来像合法的域名。解决这个问题的一个方法是结合从域名(熵，长度，…)和上下文信息(NXDomain，TTL，…)计算的特征。通过这种方式，您不仅可以依赖域名，还可以捕获基于字典的DGA</p><blockquote class="kz la lb"><p id="b1d6" class="jn jo lc jp b jq jr js jt ju jv jw jx ld jz ka kb le kd ke kf lf kh ki kj kk ij bi translated">注意:尽管如此，我们最近看到了深层单词嵌入算法检测基于词典的DGA的巨大前景</p><p id="3bee" class="jn jo lc jp b jq jr js jt ju jv jw jx ld jz ka kb le kd ke kf lf kh ki kj kk ij bi translated">注意:当检测到僵尸时，将它重定向到另一个由我们控制的服务器更有用，这样我们就知道僵尸应该发送哪种数据到C2。我们通过改变机器人使用的DNS服务器的映射来做到这一点</p></blockquote><p id="e01b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">即使某些方法产生了良好的结果，您也不应该忘记类似生产环境中的两个主要特征:</p><ul class=""><li id="7ef7" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated">根据所考虑的网络，DNS流量可能太重要而无法像您在分析中所做的那样进行解析</li><li id="265e" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated">假设您让一个机器学习模型检测DGAs，并且您达到了98%的准确率……请记住，DNS流量可能非常重要，因此2%可能仍然是一个相当大的数量</li></ul></div><div class="ab cl lh li hu lj" role="separator"><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm"/></div><div class="ij ik il im in"><p id="483a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">感谢阅读！希望你喜欢它，请随意查看我的另一篇关于Unix系统中的竞争条件的文章:<a class="ae lg" rel="noopener ugc nofollow" target="_blank" href="/race-condition-vulnerability-in-unix-systems-db86b6daceb6">https://infosecwriteups . com/Race-condition-vulnerability-in-Unix-Systems-db 86 b 6 da CEB 6</a></p><p id="c5e4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">安:如果你想联系我，这是我的LinkedIn:【https://www.linkedin.com/in/malo-le-goff-480452170/? T2】locale=en_US </p></div></div>    
</body>
</html>