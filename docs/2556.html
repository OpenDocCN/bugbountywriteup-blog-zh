<html>
<head>
<title>THE ANATOMY OF KERBEROS AUTHENTICATION (AD BASICS 0x1)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">KERBEROS身份验证剖析(AD基础0x1)</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/the-anatomy-of-kerberos-authentication-ad-basics-0x1-1532305a18a3?source=collection_archive---------1-----------------------#2022-11-23">https://infosecwriteups.com/the-anatomy-of-kerberos-authentication-ad-basics-0x1-1532305a18a3?source=collection_archive---------1-----------------------#2022-11-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="d7f1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">嗨！我的名字是Hashar Mujahid，今天我们将了解Kerberos身份验证是如何工作的。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/6300287c503db1974c36ea2488df84b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Ez_CYfU-6HpaG2k5.jpg"/></div></div></figure><h2 id="e92f" class="kx ky iq bd kz la lb dn lc ld le dp lf jy lg lh li kc lj lk ll kg lm ln lo lp bi translated">什么是Kerberos？</h2><p id="b5cc" class="pw-post-body-paragraph jn jo iq jp b jq lq js jt ju lr jw jx jy ls ka kb kc lt ke kf kg lu ki kj kk ij bi translated">Kerberos是微软在其活动目录服务中广泛实施的一种身份验证协议。它允许用户在不可信的网络上访问服务或数据，方法是在票证的帮助下证明他们的身份。像macOS、Linux等所有主流操作系统也支持Kerberos。</p><h2 id="367f" class="kx ky iq bd kz la lb dn lc ld le dp lf jy lg lh li kc lj lk ll kg lm ln lo lp bi translated">为什么要了解Kerberos？</h2><p id="2be9" class="pw-post-body-paragraph jn jo iq jp b jq lq js jt ju lr jw jx jy ls ka kb kc lt ke kf kg lu ki kj kk ij bi translated">“知己知彼，百战不殆”(孙子)</p><p id="c0f7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从渗透测试者的角度来看，几乎90%的大公司都使用活动目录环境。Kerberos是AD服务中使用的主要身份验证系统。因此，对于每个想要成为pentester或red teamer的人来说，理解Kerberos身份验证是有害的。</p><h2 id="1a98" class="kx ky iq bd kz la lb dn lc ld le dp lf jy lg lh li kc lj lk ll kg lm ln lo lp bi translated">KERBEROS认证剖析。</h2><p id="84fe" class="pw-post-body-paragraph jn jo iq jp b jq lq js jt ju lr jw jx jy ls ka kb kc lt ke kf kg lu ki kj kk ij bi translated">现在，我们将了解这个身份验证系统是如何工作的，以及这个过程中涉及哪些组件或实体。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lv"><img src="../Images/d95af66901481ff51fce29f2dc93ce72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iXp8f8wFqCKqWIrHqkQnEQ.png"/></div></div></figure><h2 id="ad56" class="kx ky iq bd kz la lb dn lc ld le dp lf jy lg lh li kc lj lk ll kg lm ln lo lp bi translated">步骤1:认证服务器请求(AS-REQ)</h2><p id="f658" class="pw-post-body-paragraph jn jo iq jp b jq lq js jt ju lr jw jx jy ls ka kb kc lt ke kf kg lu ki kj kk ij bi translated">假设一个客户机想要访问资源服务器上的一些资源，首先它需要向密钥分发中心(KDC)发送一个请求。这个请求将包含客户端密码 的<strong class="jp ir"> <em class="lw"> NTLM散列和用那个NTLM散列</em> </strong>加密的<strong class="jp ir"> <em class="lw">时间戳。这是为了确定请求实际上来自它所声称的用户。</em></strong></p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lx"><img src="../Images/b40eb514346de23e162e2c70f055d4cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k5j6PipLTItWoGVa7CrjYA.png"/></div></div></figure><p id="c712" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在第一步的最后。KDC接收用户的请求并解密。</p><h2 id="79f4" class="kx ky iq bd kz la lb dn lc ld le dp lf jy lg lh li kc lj lk ll kg lm ln lo lp bi translated">步骤2:认证服务器响应(AS-REP)</h2><p id="e111" class="pw-post-body-paragraph jn jo iq jp b jq lq js jt ju lr jw jx jy ls ka kb kc lt ke kf kg lu ki kj kk ij bi translated">密钥分发中心主要由两部分组成。</p><ul class=""><li id="d354" class="ly lz iq jp b jq jr ju jv jy ma kc mb kg mc kk md me mf mg bi translated">认证服务器</li><li id="6064" class="ly lz iq jp b jq mh ju mi jy mj kc mk kg ml kk md me mf mg bi translated">票据授予服务器</li></ul><p id="81dc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">KDC接收用户的请求并解密。如果请求通过验证，KDC将使用TGT(票据授予票据)进行响应。TGT用域控制器名为“KRBTGT”的特殊帐户的哈希进行加密和签名。只有KRBTGT帐户可以打开和读取票证。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mm"><img src="../Images/0bdc5d2e8d016f1abfe7b93fc279145e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZNjFV6KIhi0oxj40V1AXGw.png"/></div></div></figure><p id="22f1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">步骤3:票据授予服务请求(TGS-请求)</strong></p><p id="940c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在客户有了一个TGT，但是他不能解密它，因为它是用krbtgt帐户的散列加密的。因此，客户端将TGT发送回KDC，并请求TGS票证。TGS票证是一种票证，它授予对AD域环境中特定服务的访问权限。在步骤3结束时，KDC收到请求并解密TGT。这是这一步中唯一的验证，如果TGT被验证，KDC假定TGT中返回的任何内容都是有效的。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mn"><img src="../Images/7255990e36161f3ba2ceb95ab44f98e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3Np9byRP4g4mMo9ru9xEBA.png"/></div></div></figure><h2 id="db63" class="kx ky iq bd kz la lb dn lc ld le dp lf jy lg lh li kc lj lk ll kg lm ln lo lp bi translated">步骤4:票证授予服务器响应(TGS代表)</h2><p id="c51a" class="pw-post-body-paragraph jn jo iq jp b jq lq js jt ju lr jw jx jy ls ka kb kc lt ke kf kg lu ki kj kk ij bi translated">一旦TGT得到确认，KDC将对TGS做出回应。TGS是使用目标服务器或资源服务器的NTLM散列加密的。因此客户端无法解密，只有资源服务器可以解密。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi mo"><img src="../Images/ef7f71efda354dc52ba402458e221a9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1378/format:webp/1*Z8IeR9m2s-zhGoUEdUsTig.png"/></div></figure><h2 id="10d9" class="kx ky iq bd kz la lb dn lc ld le dp lf jy lg lh li kc lj lk ll kg lm ln lo lp bi translated">步骤5:连接到资源服务器(AP-REQ)</h2><blockquote class="mp mq mr"><p id="33d6" class="jn jo lw jp b jq jr js jt ju jv jw jx ms jz ka kb mt kd ke kf mu kh ki kj kk ij bi translated">资源服务器也可以称为应用服务器</p></blockquote><p id="9e2d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，客户端拥有了一个TGS，客户端或用户可以连接到资源服务器，并将他们的TGS呈现给资源服务器。</p><p id="1904" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">步骤6:来自资源服务器(AP-REP)的响应</strong></p><p id="f70e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因为TGS是使用应用服务器或资源服务器的NTLM散列加密的。它对其进行解密，并决定用户是否可以访问该服务。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/19870ec5abf2406cfdf8d8eb57c4ee19.png" data-original-src="https://miro.medium.com/v2/resize:fit:1246/format:webp/1*o_PCThIYloy80uFh6twAzQ.png"/></div></figure><p id="1dfc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这就是Kerberos身份验证协议中所发生的一切。</p><p id="eb83" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我希望你能理解。我将会发表更多的博客，从一个测试者的角度讲述如何接近一个活动目录环境。如果你想了解更多关于系统和Web应用渗透测试的知识，请关注我。</p><p id="901b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我会在下一个博客中看到你，直到那时快乐的黑客！❤</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mw mx l"/></div></figure></div><div class="ab cl my mz hu na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="ij ik il im in"><h2 id="7e9b" class="kx ky iq bd kz la lb dn lc ld le dp lf jy lg lh li kc lj lk ll kg lm ln lo lp bi translated">来自Infosec的报道:Infosec每天都有很多内容，很难跟上。<a class="ae nf" href="https://weekly.infosecwriteups.com/" rel="noopener ugc nofollow" target="_blank">加入我们的每周简讯</a>以5篇文章、4个线程、3个视频、2个GitHub Repos和工具以及1个工作提醒的形式免费获取所有最新的Infosec趋势！</h2></div></div>    
</body>
</html>