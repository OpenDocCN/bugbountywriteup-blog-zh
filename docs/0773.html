<html>
<head>
<title>Fun with header and forget password, with a twist:</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">有趣的标题和忘记密码，有一个转折:</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/fun-with-header-and-forget-password-with-a-twist-af095b426fb2?source=collection_archive---------1-----------------------#2020-08-18">https://infosecwriteups.com/fun-with-header-and-forget-password-with-a-twist-af095b426fb2?source=collection_archive---------1-----------------------#2020-08-18</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div class="gh gi jq"><img src="../Images/7b1f45d1b71de95ff70722c6a2ea8877.png" data-original-src="https://miro.medium.com/v2/resize:fit:1208/format:webp/1*-r44LX3icqQ3rwNwIkaZmA.png"/></div></figure><p id="a813" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">头球是很好玩的东西。最常见的是X-Forwarded-For(通常用于waf bypass)和X-Forwarded-Host(就个人而言，这是实现dns/http pingbacks的一个有趣的方法，有时是ssrf)。</p><p id="a64a" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">本文将介绍这样一种情况，我能够使用其中一个标题来欺骗网站发送一个包含我选择的域名的忘记密码链接。</p><p id="49ff" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">X-Forwarded-Host和forgot password链接，有一点不好玩:</p><p id="1e0f" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">剧透警告，扭曲，加上这个错误的性质，导致了较低的支出，比如果没有所说的扭曲低得多。</p><p id="0635" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated"><strong class="jz iu">初始阶段:</strong></p><p id="41b1" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">这个很容易测试，但是很容易漏掉测试。说实话，不通过twitter和#BugBountyTip找到这个</p><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="8b45" class="le lf it la b gy lg lh l li lj">---For waf bypass, and similar---</span><span id="6eb9" class="le lf it la b gy lk lh l li lj">X-Forwarded-Host</span><span id="a822" class="le lf it la b gy lk lh l li lj">X-Forwarded-Port</span><span id="74a8" class="le lf it la b gy lk lh l li lj">X-Forwarded-Scheme</span><span id="18b5" class="le lf it la b gy lk lh l li lj">Origin: null</span><span id="f80d" class="le lf it la b gy lk lh l li lj">Origin: [siteDomain].attacker.com</span><span id="ccb9" class="le lf it la b gy lk lh l li lj">X-Frame-Options: Allow</span><span id="be39" class="le lf it la b gy lk lh l li lj">X-Forwarded-For: 127.0.0.1</span><span id="ca04" class="le lf it la b gy lk lh l li lj">X-Client-IP: 127.0.0.1</span><span id="ca0c" class="le lf it la b gy lk lh l li lj">Client-IP: 127.0.0.1</span></pre><p id="5e52" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">实际上运用它的智慧，我可能会错过它。至少第一次是这样。也许几天、几周、几个月后，我会无聊地通读我的笔记，有一个清晰的时刻，我会尝试一下:)</p><figure class="kv kw kx ky gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi ll"><img src="../Images/65b9fa51db216a72a10be3efaf662bc7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3Vpjz6NJpjUhJTWpV1BS9g.png"/></div></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated">注意X-Forwarded-Host的匹配和替换规则</figcaption></figure><p id="7e92" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">我在这个叫website.com的网站上创建了这个网站，它已经注册了，却忘记了密码。</p><p id="ae31" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">像往常一样，我第一次注册是为了进一步了解这个网站如何运行，它为注册用户提供了哪些额外的访问权限，以及它是否可以用于idor-s，甚至通过false2true获得管理功能(根据<a class="ae lu" href="https://medium.com/bugbountywriteup/false2true-match-and-replace-bug-hunting-a-cautionary-tale-fbe7020f02ad" rel="noopener">我的另一篇文章</a>)</p><p id="a834" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">在点击的过程中，什么也没有发现，有一个“最后”的东西需要测试。我倾向于把它留到最后，因为我要退出。</p><p id="dee2" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">因此，我注销，并前往忘记密码页面。</p><p id="ddf9" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated"><strong class="jz iu">忘记密码测试:</strong></p><p id="4959" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">当时(我后来了解到更多)，其背后的想法是看看整个忘记密码链接看起来是什么样的:是否有某种东西表明有一种方法可以猜测将链接与用户相关联的重置链接参数。但是，还有另外一件事需要注意:链接本身的基域。</p><p id="4300" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated"><strong class="jz iu">PoC前步骤:</strong></p><p id="caea" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">输入我的电子邮件地址后，我点击了提交按钮，然后等待。</p><p id="dff6" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">过了一会儿<em class="lv">作为解说员的海绵宝宝的声音:)</em></p><p id="ae87" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">我检查了我的电子邮件，几乎立即注意到重置密码链接有一个非常不寻常的基本域，很难错过:</p><p id="a8a3" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">而不是预期</p><p id="b226" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated"><a class="ae lu" href="https://website.com/resetpassword?email=email@website.com&amp;id=1234&amp;hash=randomstuff" rel="noopener ugc nofollow" target="_blank">https://website.com/resetpassword?email=email@website.com&amp;id = 1234&amp;hash = random stuff</a></p><p id="3224" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">我有:</p><p id="7f9d" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated"><a class="ae lu" href="https://localhost/resetpassword?email=email@website.com&amp;id=1234&amp;hash=randomstuff" rel="noopener ugc nofollow" target="_blank">https://localhost/resetpassword?email=email@website.com&amp;id = 1234&amp;hash = random stuff</a></p><p id="1c1d" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">我想你已经看到了潜力。</p><p id="27af" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">但是，这并不像看起来那么明显。</p><p id="bf7d" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated"><strong class="jz iu">概念验证:</strong></p><p id="76c0" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">我去找X转发主机的明显内容:</p><figure class="kv kw kx ky gt ju gh gi paragraph-image"><div class="gh gi lw"><img src="../Images/ec8ff5c31e5d362ffd802a57a4a0bc78.png" data-original-src="https://miro.medium.com/v2/resize:fit:1212/format:webp/1*k14UafVvSYYqe3CBBrqRrw.png"/></div></figure><p id="a474" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">但是我得到了不好的请求</p><p id="eebf" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">WTH？</p><p id="dd07" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">这就是经验/记忆/笔记派上用场的地方。我从前面的列表中想起了这一部分:</p><p id="153d" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">来源:[siteDomain]. attack . com</p><p id="438e" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">这让我有了这样的想法:</p><p id="e170" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">如果attacker.com在黑名单上，而本地主机在白名单上，那么= &gt; localhost.attacker.com就是答案(现在你也明白为什么赏金会更低了)</p><p id="00a5" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">这一次的结果是200 OK，并且电子邮件是以localhostattacker.com作为基本域发送的:</p><figure class="kv kw kx ky gt ju gh gi paragraph-image"><div class="gh gi jq"><img src="../Images/7b1f45d1b71de95ff70722c6a2ea8877.png" data-original-src="https://miro.medium.com/v2/resize:fit:1208/format:webp/1*-r44LX3icqQ3rwNwIkaZmA.png"/></div><figcaption class="lq lr gj gh gi ls lt bd b be z dk translated">请注意，它接受了localhostattacker.com，甚至没有要求点。</figcaption></figure><p id="87b6" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">现在，使用burp collaborator甚至您自己的vps，您可以记录密码重置所需的随机字符串，只要用户/受害者单击该链接。这样你就可以接管用户/受害者的账户。也就是说，只要用户不介意点击名称中包含localhost字符串的链接，更不用说不记得曾经请求重置密码:)</p><p id="c447" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">有趣的是，无论他们使用什么解析器，它实际上都接受任何基域，只要它包含localhost，这意味着junklocalhostjunk.com也被接受。</p></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><p id="a62b" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">这表明记笔记以及拥有免费或专业版的打嗝是多么的重要。或者任何其他允许向请求添加标题的方式，在这些标题中包含各种类型的值。</p><p id="3a38" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">此外，不要忘记监控这些响应的内容，同时记住它是否是一些熟悉的东西，一些您在整个bug搜索过程中看到的，当时看起来不太重要，但现在可能被证明是至关重要的东西。</p></div></div>    
</body>
</html>