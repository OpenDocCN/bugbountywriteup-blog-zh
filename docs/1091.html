<html>
<head>
<title>Insecure Deserialization 😈🐝</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">不安全的反序列化😈🐝</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/insecure-deserialization-5c64e9943f0e?source=collection_archive---------5-----------------------#2021-01-28">https://infosecwriteups.com/insecure-deserialization-5c64e9943f0e?source=collection_archive---------5-----------------------#2021-01-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/8aace66f37c97abd28b001ebe6c4a59b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*MBIjWBCBuBuNugl8"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">斯蒂芬·拉德福德在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="47f6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi le translated">序列化是将对象从内部表示转换成字符或字节流的行为。序列化对象的表示应该独立于平台和语言。数据在应用程序中被序列化和反序列化，以<strong class="ki iu">存储</strong>或<strong class="ki iu">传输</strong>它。在web应用中，<strong class="ki iu"> JSON </strong>或<strong class="ki iu"> XML </strong>经常被很多API和协议用于数据交换。像PNG/GIF/JPEG/MPEG这样的文件格式使用XML来存储元数据。YAML在配置文件方面变得非常流行，例如在<a class="ae kf" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-formats.html" rel="noopener ugc nofollow" target="_blank"> Cloudformation模板</a>或<a class="ae kf" href="https://docs.gitlab.com/ee/ci/yaml/" rel="noopener ugc nofollow" target="_blank"> GitlabCI配置文件</a>中。</p><p id="93af" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">有些文件格式允许您做的不仅仅是(反)序列化基本数据类型。例如，假设您想要建立一个CI管道。您可能有一个执行单元测试的步骤，一个检查类型的步骤，一个林挺的步骤。所有这些步骤可能都需要安装相同的依赖项集。与其重复自己，不如使用<strong class="ki iu">引用</strong>。你一次定义一个字典，在很多地方复制。引用允许人快速地读、写和修改文件，而机器只是在多个地方有相同的值。</p><p id="4584" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">另一个强大的功能是包括外部实体。在最简单的情况下，这意味着您想要包含另一个文件。例如，您可能有一个想要在多个地方使用的日志记录配置。在更极端的情况下，外部实体可能不在本地文件中，而只能通过互联网获得。老实说，我不知道你为什么要这样。如果你知道，请留下你的推荐！</p><p id="a88b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">大多数序列化格式不够强大，无法表示您可以拥有的任意对象。这些格式的功能有所不同。有些人希望在兼容多种语言方面走得更远。作为一个潜在的副作用，它们可能允许<strong class="ki iu">任意代码执行</strong>。</p><h1 id="6f46" class="ln lo it bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">为什么你应该关心</h1><ul class=""><li id="4428" class="ml mm it ki b kj mn kn mo kr mp kv mq kz mr ld ms mt mu mv bi translated">不安全的反序列化在<strong class="ki iu"> OWASP前10名</strong> ( <a class="ae kf" href="https://owasp.org/www-project-top-ten/2017/A8_2017-Insecure_Deserialization" rel="noopener ugc nofollow" target="_blank">来源</a>)中排在第8位🐝</li><li id="fc7b" class="ml mm it ki b kj mw kn mx kr my kv mz kz na ld ms mt mu mv bi translated">2013年:YAML节点包(<a class="ae kf" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2013-4660" rel="noopener ugc nofollow" target="_blank">CVE-2013–4660</a>)允许远程代码执行。远程代码执行非常糟糕:人们可以获取您的数据，安装后门，关闭您的服务，删除或加密您的数据，使用您的服务进行加密挖掘，潜在地损害您的硬件。</li><li id="fd3b" class="ml mm it ki b kj mw kn mx kr my kv mz kz na ld ms mt mu mv bi translated">2014年:安卓&lt; 5.0 an insecure deserialization can result in arbitrary code execution (<a class="ae kf" href="https://nvd.nist.gov/vuln/detail/CVE-2014-7911" rel="noopener ugc nofollow" target="_blank">CVE-2014–7911</a></li><li id="604d" class="ml mm it ki b kj mw kn mx kr my kv mz kz na ld ms mt mu mv bi translated">2015年:安卓&lt; 5.1.1 allows arbitrary code execution (<a class="ae kf" href="https://nvd.nist.gov/vuln/detail/CVE-2015-3837" rel="noopener ugc nofollow" target="_blank">CVE-2015–3837</a></li><li id="0fa9" class="ml mm it ki b kj mw kn mx kr my kv mz kz na ld ms mt mu mv bi translated">2015年:ArcGIS允许任意代码执行(<a class="ae kf" href="https://nvd.nist.gov/vuln/detail/CVE-2015-2002" rel="noopener ugc nofollow" target="_blank">CVE-2015–2002</a>)</li><li id="ed86" class="ml mm it ki b kj mw kn mx kr my kv mz kz na ld ms mt mu mv bi translated">2015: <a class="ae kf" href="https://www.usenix.org/system/files/conference/woot15/woot15-paper-peles.pdf" rel="noopener ugc nofollow" target="_blank">一个类统治一切:Android中的0天反序列化漏洞</a>作者Or Peles，Roee Hay引用<a class="ae kf" href="https://nvd.nist.gov/vuln/detail/CVE-2015-3837" rel="noopener ugc nofollow" target="_blank">CVE-2015–3837</a></li><li id="e529" class="ml mm it ki b kj mw kn mx kr my kv mz kz na ld ms mt mu mv bi translated">2019年:Kubernetes易受十亿次笑DOS攻击(<a class="ae kf" href="https://nvd.nist.gov/vuln/detail/CVE-2019-11253" rel="noopener ugc nofollow" target="_blank">CVE-2019–11253</a>)</li><li id="e3c6" class="ml mm it ki b kj mw kn mx kr my kv mz kz na ld ms mt mu mv bi translated">2020年:typo 3(<a class="ae kf" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-11067" rel="noopener ugc nofollow" target="_blank">CVE-2020–11067</a>)，IBM QRadar(<a class="ae kf" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-4280" rel="noopener ugc nofollow" target="_blank">CVE-2020–4280</a>)允许远程代码执行。</li><li id="890f" class="ml mm it ki b kj mw kn mx kr my kv mz kz na ld ms mt mu mv bi translated">2020年:Apache Tomcat允许远程执行代码(<a class="ae kf" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-9484" rel="noopener ugc nofollow" target="_blank">CVE-2020–9484</a>)</li></ul><h1 id="1f34" class="ln lo it bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">反序列化攻击是如何工作的？</h1><p id="c643" class="pw-post-body-paragraph kg kh it ki b kj mn kl km kn mo kp kq kr nb kt ku kv nc kx ky kz nd lb lc ld im bi translated">实际上有许多反序列化攻击。对它们进行分组的一种方式是按照文件格式，例如YAML、XML、Python pickle文件等等。另一种方式是通过攻击者想要达到的目标，例如任意代码执行或拒绝服务(DOS)。</p><p id="0058" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">问题是这些文件格式太强大了。它们要么直接允许代码执行，要么允许创建对文件系统的引用或对文档中元素的引用。</p><h2 id="8225" class="ne lo it bd lp nf ng dn lt nh ni dp lx kr nj nk mb kv nl nm mf kz nn no mj np bi translated">攻击YAML解串器</h2><p id="a18f" class="pw-post-body-paragraph kg kh it ki b kj mn kl km kn mo kp kq kr nb kt ku kv nc kx ky kz nd lb lc ld im bi translated">拿这个<code class="fe nq nr ns nt b">example.yaml</code>文件来说:</p><pre class="nu nv nw nx gt ny nt nz oa aw ob bi"><span id="c633" class="ne lo it nt b gy oc od l oe of">!!python/object/apply:os.system</span><span id="aa02" class="ne lo it nt b gy og od l oe of">args: ['cat /etc/passwd']</span></pre><p id="6326" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">并执行以下Python代码:</p><pre class="nu nv nw nx gt ny nt nz oa aw ob bi"><span id="b8c8" class="ne lo it nt b gy oc od l oe of">import yaml  # pip install pyyaml is required</span><span id="1f0f" class="ne lo it nt b gy og od l oe of">with open("example.yaml") as fp:<br/>    data = fp.read()<br/>yaml.unsafe_load(data)</span></pre><p id="3f8f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这将打印出<code class="fe nq nr ns nt b">/etc/passwd</code>的内容。您还可以删除系统上的任何(或所有)文件，发送web请求(例如带有密码文件的内容)，下载并执行软件(例如rootkit/后门)。这可能是最坏的情况了。</p><p id="beb6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果你想了解更多关于YAML的特色，请阅读:</p><div class="oh oi gp gr oj ok"><a href="https://levelup.gitconnected.com/6-yaml-features-most-programmers-dont-know-164762343af3" rel="noopener  ugc nofollow" target="_blank"><div class="ol ab fo"><div class="om ab on cl cj oo"><h2 class="bd iu gy z fp op fr fs oq fu fw is bi translated">6大多数程序员不知道的YAML特性</h2><div class="or l"><h3 class="bd b gy z fp op fr fs oq fu fw dk translated">提升你的YAML知识，写更干净的YAML文件</h3></div><div class="os l"><p class="bd b dl z fp op fr fs oq fu fw dk translated">levelup.gitconnected.com</p></div></div><div class="ot l"><div class="ou l ov ow ox ot oy jz ok"/></div></div></a></div><h2 id="d485" class="ne lo it bd lp nf ng dn lt nh ni dp lx kr nj nk mb kv nl nm mf kz nn no mj np bi translated">攻击XML反序列化</h2><p id="ef55" class="pw-post-body-paragraph kg kh it ki b kj mn kl km kn mo kp kq kr nb kt ku kv nc kx ky kz nd lb lc ld im bi translated">XML允许引用外部实体，如文件(如<code class="fe nq nr ns nt b">/etc/passwd</code>)或网站。如果你想了解更多为什么这是一个问题，请阅读我关于XXE袭击的文章</p><div class="oh oi gp gr oj ok"><a href="https://medium.com/faun/xxe-attacks-750e91448e8f" rel="noopener follow" target="_blank"><div class="ol ab fo"><div class="om ab on cl cj oo"><h2 class="bd iu gy z fp op fr fs oq fu fw is bi translated">XXE袭击😈</h2><div class="or l"><h3 class="bd b gy z fp op fr fs oq fu fw dk translated">PDF、Excel、SVG、电子书——都使用XML。他们可能很脆弱。</h3></div><div class="os l"><p class="bd b dl z fp op fr fs oq fu fw dk translated">medium.com</p></div></div><div class="ot l"><div class="oz l ov ow ox ot oy jz ok"/></div></div></a></div><p id="bcbb" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">另一个可能的攻击媒介是在十亿次攻击中使用XML的引用功能:</p><div class="oh oi gp gr oj ok"><a href="https://medium.com/bugbountywriteup/dos-via-a-billion-laughs-9a79be96e139" rel="noopener follow" target="_blank"><div class="ol ab fo"><div class="om ab on cl cj oo"><h2 class="bd iu gy z fp op fr fs oq fu fw is bi translated">通过十亿次大笑😈</h2><div class="or l"><h3 class="bd b gy z fp op fr fs oq fu fw dk translated">通过重复引用消耗任意多的RAM</h3></div><div class="os l"><p class="bd b dl z fp op fr fs oq fu fw dk translated">medium.com</p></div></div><div class="ot l"><div class="pa l ov ow ox ot oy jz ok"/></div></div></a></div><h2 id="f957" class="ne lo it bd lp nf ng dn lt nh ni dp lx kr nj nk mb kv nl nm mf kz nn no mj np bi translated">攻击Pickle反序列化</h2><p id="2581" class="pw-post-body-paragraph kg kh it ki b kj mn kl km kn mo kp kq kr nb kt ku kv nc kx ky kz nd lb lc ld im bi translated">Marco Slaviero在他的论文“<a class="ae kf" href="https://media.blackhat.com/bh-us-11/Slaviero/BH_US_11_Slaviero_Sour_Pickles_WP.pdf" rel="noopener ugc nofollow" target="_blank"> Sour Pickles </a>”中指出，pickle文件的反序列化允许任意代码执行。Charles Menguy在一个类似的例子中很好地总结了这一点:</p><pre class="nu nv nw nx gt ny nt nz oa aw ob bi"><span id="0b0f" class="ne lo it nt b gy oc od l oe of">import pickle<br/>pickle.loads(b"cos\nsystem\n(S'cat /etc/passwd'\ntR.")</span></pre></div><div class="ab cl pb pc hx pd" role="separator"><span class="pe bw bk pf pg ph"/><span class="pe bw bk pf pg ph"/><span class="pe bw bk pf pg"/></div><div class="im in io ip iq"><h1 id="dab4" class="ln lo it bd lp lq pi ls lt lu pj lw lx ly pk ma mb mc pl me mf mg pm mi mj mk bi translated">如何防御反序列化攻击？</h1><p id="039c" class="pw-post-body-paragraph kg kh it ki b kj mn kl km kn mo kp kq kr nb kt ku kv nc kx ky kz nd lb lc ld im bi translated">你几乎总是可以做的两个措施:</p><ul class=""><li id="c722" class="ml mm it ki b kj kk kn ko kr pn kv po kz pp ld ms mt mu mv bi translated"><strong class="ki iu">最小特权原则</strong>:用尽可能少的特权运行你的代码。您确实不需要root权限。根据您的偏执程度，您可以创建一个专门的用户来执行反序列化。您可以取消该用户使用网络的权利。</li><li id="310c" class="ml mm it ki b kj mw kn mx kr my kv mz kz na ld ms mt mu mv bi translated"><strong class="ki iu">纵深防御</strong>:确保每个组件都采取可能的安全措施。</li></ul><p id="b635" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对于某些格式，您可以告诉反序列化程序忽略它的某些功能:</p><ul class=""><li id="3518" class="ml mm it ki b kj kk kn ko kr pn kv po kz pp ld ms mt mu mv bi translated"><strong class="ki iu"> PyYAML </strong>:使用<code class="fe nq nr ns nt b">yaml.safe_load</code>功能。在某个时候，他们改变了界面，使<code class="fe nq nr ns nt b">yaml.load</code>指向<code class="fe nq nr ns nt b">yaml.safe_load</code>。还可以用<code class="fe nq nr ns nt b">yaml.unsafe_load</code>。我喜欢他们在函数调用中包含“不安全”。这表明有些事情可能是危险的。</li><li id="ef29" class="ml mm it ki b kj mw kn mx kr my kv mz kz na ld ms mt mu mv bi translated"><strong class="ki iu"> XML </strong>:对于Python，有<code class="fe nq nr ns nt b"><a class="ae kf" href="https://pypi.org/project/defusedxml" rel="noopener ugc nofollow" target="_blank">defusedxml</a></code>将Python的各种XML解析器设置为安全默认值，防止<a class="ae kf" href="https://medium.com/faun/xxe-attacks-750e91448e8f" rel="noopener"> XEE </a>、十亿次大笑攻击和二次爆发。</li></ul><p id="418d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对于pickle等其他格式，您只需确保您的输入不会造成伤害。</p><h1 id="b32a" class="ln lo it bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">下一步是什么？</h1><p id="6244" class="pw-post-body-paragraph kg kh it ki b kj mn kl km kn mo kp kq kr nb kt ku kv nc kx ky kz nd lb lc ld im bi translated">在这个关于应用安全(AppSec)的系列文章中，我们已经解释了攻击者的一些技术😈以及防守队员的技术😇：</p><ul class=""><li id="44b1" class="ml mm it ki b kj kk kn ko kr pn kv po kz pp ld ms mt mu mv bi translated">第1部分:<a class="ae kf" href="https://medium.com/faun/sql-injections-e8bc9a14c95" rel="noopener"> SQL注入</a>😈</li><li id="5f38" class="ml mm it ki b kj mw kn mx kr my kv mz kz na ld ms mt mu mv bi translated">第二部:<a class="ae kf" href="https://levelup.gitconnected.com/leaking-secrets-240a3484cb80" rel="noopener ugc nofollow" target="_blank">不要泄露秘密</a>😇</li><li id="fd21" class="ml mm it ki b kj mw kn mx kr my kv mz kz na ld ms mt mu mv bi translated">第3部分:<a class="ae kf" href="https://levelup.gitconnected.com/cross-site-scripting-xss-fd374ce71b2f" rel="noopener ugc nofollow" target="_blank">跨站脚本(XSS) </a>😈</li><li id="bd6a" class="ml mm it ki b kj mw kn mx kr my kv mz kz na ld ms mt mu mv bi translated">第4部分:<a class="ae kf" href="https://levelup.gitconnected.com/password-hashing-eb3b97684636" rel="noopener ugc nofollow" target="_blank">密码哈希</a>😇</li><li id="617f" class="ml mm it ki b kj mw kn mx kr my kv mz kz na ld ms mt mu mv bi translated">第五部分:<a class="ae kf" href="https://medium.com/bugbountywriteup/zip-bombs-30337a1b0112" rel="noopener"> ZIP炸弹</a>😈</li><li id="dd4d" class="ml mm it ki b kj mw kn mx kr my kv mz kz na ld ms mt mu mv bi translated">第六部分:<a class="ae kf" href="https://medium.com/plain-and-simple/captcha-500991bd90a3" rel="noopener">验证码</a>😇</li><li id="563d" class="ml mm it ki b kj mw kn mx kr my kv mz kz na ld ms mt mu mv bi translated">第7部分:<a class="ae kf" href="https://medium.com/bugbountywriteup/email-spoofing-9da8d33406bf" rel="noopener">电子邮件欺骗</a>😈</li><li id="d114" class="ml mm it ki b kj mw kn mx kr my kv mz kz na ld ms mt mu mv bi translated">第8部分:<a class="ae kf" href="https://medium.com/python-in-plain-english/software-composition-analysis-sca-7e573214a98e" rel="noopener">软件组成分析</a> (SCA)😇</li><li id="c925" class="ml mm it ki b kj mw kn mx kr my kv mz kz na ld ms mt mu mv bi translated">第九部分:<a class="ae kf" href="https://medium.com/faun/xxe-attacks-750e91448e8f" rel="noopener"> XXE袭击事件</a>😈</li><li id="6805" class="ml mm it ki b kj mw kn mx kr my kv mz kz na ld ms mt mu mv bi translated">第十部分:<a class="ae kf" href="https://levelup.gitconnected.com/effective-access-control-331f883cb0ff" rel="noopener ugc nofollow" target="_blank">有效的访问控制</a>😇</li><li id="2c17" class="ml mm it ki b kj mw kn mx kr my kv mz kz na ld ms mt mu mv bi translated">第十一部分:<a class="ae kf" href="https://medium.com/bugbountywriteup/dos-via-a-billion-laughs-9a79be96e139" rel="noopener"> DOS via十亿次大笑</a>😈</li><li id="0490" class="ml mm it ki b kj mw kn mx kr my kv mz kz na ld ms mt mu mv bi translated">第十二部分:<a class="ae kf" href="https://medium.com/faun/full-disk-encryption-2090489f9760" rel="noopener">全磁盘加密</a>😇</li><li id="fe99" class="ml mm it ki b kj mw kn mx kr my kv mz kz na ld ms mt mu mv bi translated">第13部分:不安全的反序列化😈</li></ul><p id="e406" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这即将到来:</p><ul class=""><li id="05df" class="ml mm it ki b kj kk kn ko kr pn kv po kz pp ld ms mt mu mv bi translated">CSRF😈</li><li id="6993" class="ml mm it ki b kj mw kn mx kr my kv mz kz na ld ms mt mu mv bi translated">磁盘操作系统😈</li><li id="febd" class="ml mm it ki b kj mw kn mx kr my kv mz kz na ld ms mt mu mv bi translated">凭据填充😈</li><li id="ac7e" class="ml mm it ki b kj mw kn mx kr my kv mz kz na ld ms mt mu mv bi translated">密码劫持😈</li><li id="9599" class="ml mm it ki b kj mw kn mx kr my kv mz kz na ld ms mt mu mv bi translated">单点登录😇</li><li id="d084" class="ml mm it ki b kj mw kn mx kr my kv mz kz na ld ms mt mu mv bi translated">双因素认证😇</li><li id="0377" class="ml mm it ki b kj mw kn mx kr my kv mz kz na ld ms mt mu mv bi translated">备份😇</li></ul><p id="3a58" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果您对更多关于AppSec / InfoSec的文章感兴趣，请告诉我！</p></div></div>    
</body>
</html>