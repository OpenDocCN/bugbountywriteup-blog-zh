<html>
<head>
<title>Find Edge’s HSTS Preload List (Part I)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">查找Edge的HSTS预加载列表(第一部分)</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/find-edges-hsts-preload-list-part-i-2ee5ce6bc5aa?source=collection_archive---------0-----------------------#2018-04-20">https://infosecwriteups.com/find-edges-hsts-preload-list-part-i-2ee5ce6bc5aa?source=collection_archive---------0-----------------------#2018-04-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="a924" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这篇文章中，我将讨论我是如何找到Edge浏览器的HSTS预加载列表的。这不是Edge的漏洞。我希望你仍然喜欢阅读它。本文分为两部分:第一部分，我将讨论如何在Fiddler的帮助下，通过在浏览器中运行JavaScript，让Edge自己生成列表。如果我有时间，我会写第二部分，其中我将展示如何通过逆向工程找到列表。</p><p id="5e53" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">背景</strong><br/>HTTP严格传输安全(HSTS)旨在通过在用户访问您的网站时强制浏览器使用HTTPS连接来减轻中间人攻击。HSTS策略可以动态设置，也可以预先加载到浏览器中。要动态设置HSTS，发送一个HTTP响应头“<code class="fe kl km kn ko b">Strict-Transport-Security: max-age=31536000; [includeSubDomains]</code>”，意味着在接下来的31536000秒(1年)内，浏览器在连接到该域时必须使用HTTPS。如果可选指令<code class="fe kl km kn ko b">includeSubDomains</code>被设置，它的所有子域也将被强制使用HTTPS。</p><p id="58af" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">动态HSTS策略的问题在于，与服务器的初始连接不受保护。为了解决这个问题，谷歌维护了一个<strong class="jp ir"> HSTS预加载列表</strong>。开发者可以在hstspreload.org<a class="ae kp" href="https://hstspreload.org" rel="noopener ugc nofollow" target="_blank">向预加载列表提交他们的域名。这个列表被硬编码在所有主流浏览器的二进制文件中。</a></p><p id="1f3c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">虽然所有浏览器的列表都是基于Chrome的，但由于不同的发布周期和额外的要求，不同浏览器的最新稳定版本有不同的硬编码预加载列表。Firefox和Chrome都是开源的，所以我们很容易从源代码中知道它们的预加载列表。最新的Firefox预加载列表可从<a class="ae kp" href="https://github.com/mozilla/gecko-dev/blob/master/security/manager/ssl/nsSTSPreloadList.inc" rel="noopener ugc nofollow" target="_blank"> mozilla#gecko-dev </a>获得，Chrome预加载列表可从<a class="ae kp" href="https://github.com/chromium/chromium/blob/master/net/http/transport_security_state_static.json" rel="noopener ugc nofollow" target="_blank"> chromium#chromium </a>获得。Edge不是开源的，到目前为止我没有发现有人在网上发布Edge的列表，所以，出于好奇，我决定自己去了解一下。</p><p id="3844" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">方法</strong>我们的想法是遍历Chrome列表中的每个域。对于它们中的每一个，我们都将其加载到Edge中。如果Edge自动将HTTP重写为HTTPS，则该域也会预加载到Edge中。我们可以这样检测它:例如，为了检查<code class="fe kl km kn ko b">example.com</code>，我们用<code class="fe kl km kn ko b">src=http://example.com/hsts.gif</code>构造一个<code class="fe kl km kn ko b">img</code>元素。如果是预加载的，发送给服务器的请求是HTTPS；否则，请求是HTTP。为了在JavaScript中检测到这两种情况，我使用Fiddler代理在本地伪造响应。如果Fiddler看到请求的URL是http://example.com/hsts.gif,，它会用一个示例gif文件来响应。当Edge得到响应时，调用<code class="fe kl km kn ko b">onload</code>处理程序。如果Fiddler看到一个连接请求，这意味着URL已经被重写为HTTPS。在这种情况下，Fiddler重置连接请求，让Edge触发<code class="fe kl km kn ko b">onerror</code>处理程序。然后我们只需要在JavaScript中处理<code class="fe kl km kn ko b">onload</code>和<code class="fe kl km kn ko b">onerror</code>事件，并相应地记录日志。如果<code class="fe kl km kn ko b">onload</code>被击发，则不预装；如果<code class="fe kl km kn ko b">onerror</code>被发射，它被预加载。</p><p id="3ec0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我已经在GitHub上发布了我使用的完整代码。https://github.com/xiaoyinl/EdgeHSTS有售。如果你想在你的浏览器中尝试一下，确保设置一个代理，规则在前面的段落中有详细说明，并删除浏览历史，以消除动态HSTS条目。如果您使用Fiddler，只需在自动回复器中添加以下三条规则:</p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi kq"><img src="../Images/4842ab4f4f5ffcd46abe6581ffba6c8f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3NST6LaC-bep57t3NLnbcw.png"/></div></div></figure><p id="6180" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后在你想测试的浏览器中打开<a class="ae kp" href="http://hsts.local/hststest.html" rel="noopener ugc nofollow" target="_blank">http://hsts.local/hststest.html</a>。测试需要一段时间才能完成。</p><p id="10f5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">结果</strong> <br/>提交时我使用的引用列表是<a class="ae kp" href="https://raw.githubusercontent.com/chromium/chromium/dee803ed55ad30b90e1a96622e2b4b5ca7ab5788/net/http/transport_security_state_static.json" rel="noopener ugc nofollow" target="_blank">transport _ security _ state _ static . JSON dee 803 ed</a>。</p><p id="e77b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">结果如下:</p><ul class=""><li id="ca8c" class="lc ld iq jp b jq jr ju jv jy le kc lf kg lg kk lh li lj lk bi translated"><code class="fe kl km kn ko b">transport_security_state_static.json</code> : <strong class="jp ir"> 48891 </strong>中HSTS条目总数</li><li id="ec3a" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">Windows 10上的edge Build 16299.371带补丁截至2018年4月:<strong class="jp ir"> 14843 </strong> ( <strong class="jp ir"> +636 </strong>不带子域)</li><li id="51b2" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">火狐59.0:<strong class="jp ir">33666</strong>(<strong class="jp ir">+1008</strong>不带子域)</li><li id="332f" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">chrome 66 . 0 . 3359 . 117:<strong class="jp ir">45447</strong>(+0无子域)</li><li id="5dc5" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">Opera 52.0: <strong class="jp ir"> 43611 </strong> (+0无子域)</li></ul><p id="c0e8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果一个域的<code class="fe kl km kn ko b">include_subdomains</code>属性在<code class="fe kl km kn ko b">transport_security_state_static.json</code>中被设置为<code class="fe kl km kn ko b">true</code>，则该域属于“无子域”类别，但是浏览器不会预加载它的子域。</p><p id="84ab" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请注意，我们只计算当前参考列表中的域。有许多域已经从主列表中删除，但尚未从这些浏览器中删除。所以每个浏览器的实际预载域名数应该比上面的结果略高。</p><p id="2fc7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">边缘:</p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi lq"><img src="../Images/04b43dbbde8f9caf4bdc678e6eaf7072.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_bldUksO95TEd_7avHgdLQ.png"/></div></div></figure><p id="b031" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">铬合金:</p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi lr"><img src="../Images/4732258b4b6fbe52f2131f75f22814e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GKyXlKR_1fTEnucX7Zn0Dg.png"/></div></div></figure><p id="2695" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">火狐浏览器:</p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi lq"><img src="../Images/e3cb5b949173024cd28778e47ed46a04.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NG6fyCaC4j4gO0jveCAjEw.png"/></div></div></figure><p id="fee5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">歌剧:</p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi ls"><img src="../Images/259e8c02a9adeacc99b7932b1386c358.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7MYZ5liTb6QHWjIERmuvVQ.png"/></div></div></figure><p id="4f56" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我认为Firefox的列表比Chrome短的原因是Mozilla会定期检查域是否仍然符合包含策略。不再发送<code class="fe kl km kn ko b">Strict-Transport-Security</code>或<code class="fe kl km kn ko b">max-age</code>少于18周的自动删除。Mozilla在<a class="ae kp" href="https://wiki.mozilla.org/SecurityEngineering/HTTP_Strict_Transport_Security_%28HSTS%29_Preload_List" rel="noopener ugc nofollow" target="_blank"> SecurityEngineering/HTTP严格传输安全(HSTS)预加载列表</a>中记录了该策略。</p><p id="3a65" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我发现Edge的HSTS预加载列表比其他浏览器短得多，这很令人惊讶。<a class="ae kp" href="https://docs.microsoft.com/en-us/microsoft-edge/dev-guide/security/hsts" rel="noopener ugc nofollow" target="_blank"> Edge文档</a>确实说“像其他已经实现这个功能的浏览器一样，微软Edge预加载列表是基于Chromium HSTS预加载列表的”。但是微软没有提到多久更新一次或者微软是否有额外的要求。希望微软将来会用更多的细节来记录他们的HSTS政策。</p><p id="89d5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">结论</strong> <br/>在本文中，我展示了如何使用JavaScript和Fiddler在Edge中构建HSTS预加载列表。在第二部分，我将讨论如何通过逆向工程找到准确的预加载列表。</p></div></div>    
</body>
</html>