<html>
<head>
<title>Active Directory Misconfigurations &amp; Attacks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">活动目录错误配置和攻击</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/as-rep-roast-attack-for-disabled-kerberos-pre-authentication-accounts-92b402ee492b?source=collection_archive---------3-----------------------#2020-10-03">https://infosecwriteups.com/as-rep-roast-attack-for-disabled-kerberos-pre-authentication-accounts-92b402ee492b?source=collection_archive---------3-----------------------#2020-10-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="51cf" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">威胁追踪</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/4ad5fff09ee0d146d371d6f9c4d29f64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*-OimZb20jiDFiIaz"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@mbaumi?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">米卡·鲍梅斯特</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><h1 id="e7b0" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">对禁用的“Kerberos预身份验证”帐户的AS-REP烘焙攻击</h1><p id="57f7" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">AS-REP过程是Kerberos预认证阶段的一部分。当<strong class="lt iu"> Kerberos预认证</strong>启用时，它提供了针对暴力密码猜测攻击的保护。</p><p id="3809" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><em class="ms">更多关于它如何工作的信息可以在</em> <a class="ae ky" href="https://ldapwiki.com/wiki/Kerberos%20Pre-Authentication" rel="noopener ugc nofollow" target="_blank"> <em class="ms">这里</em> </a>找到</p><p id="3c63" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">AS-REP烘烤允许攻击者为已禁用其帐户上的<strong class="lt iu"> kerberos预认证</strong>的用户检索密码哈希(Kerberos AS-REP (krb5asrep) <em class="ms">又名</em>加密TGT)。这使得它容易受到AS-REP烘烤攻击。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mt"><img src="../Images/c9030f52c4df2daba592f4f6acca83d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lJWyjOB9szDqKKd0lZHyjQ.png"/></div></div></figure><p id="be2a" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">来自<a class="ae ky" href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/GetNPUsers.py" rel="noopener ugc nofollow" target="_blank"> <strong class="lt iu">的命令工具<code class="fe mu mv mw mx b">GetNPUsers.py</code>插入</strong> </a>库，运行该命令不需要凭证。只有域名和用户文件。这种攻击被称为<strong class="lt iu">重发</strong>。该攻击将在<strong class="lt iu"> </strong>中搜索设置了“DONT _要求_预验证”的用户。</p><h2 id="798a" class="my la it bd lb mz na dn lf nb nc dp lj ma nd ne ll me nf ng ln mi nh ni lp nj bi translated"><strong class="ak">威胁搜寻场景</strong></h2><p id="f8cc" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">下面是一个简单的命令，我用它来识别非预认证帐户和检索密码散列。</p><p id="81e8" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><code class="fe mu mv mw mx b">python3 /usr/local/bin/GetNPUsers.py domainName.local/ -usersfile users.txt</code></p><p id="1ef3" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">该命令将向kerberos KDC(密钥分发中心)发送一个请求，以验证给定域帐户的用户列表。然后，KDC将返回一个加密的TGT(Kerberos AS-REP (krb5asrep))，攻击者可以离线强行破解它。</p><p id="4764" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">下图显示了以下内容:</p><ul class=""><li id="0446" class="nk nl it lt b lu mn lx mo ma nm me nn mi no mm np nq nr ns bi translated">用户名和密码哈希</li><li id="69c9" class="nk nl it lt b lu nt lx nu ma nv me nw mi nx mm np nq nr ns bi translated">另一个用户名没有“DONT _要求_预验证”设置，但没有密码哈希</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ny"><img src="../Images/72ab8fcc5d240bb3d2e005438fad1798.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NlkE0ss7sDkwuzycnaJBjw.png"/></div></div></figure><h2 id="96b7" class="my la it bd lb mz na dn lf nb nc dp lj ma nd ne ll me nf ng ln mi nh ni lp nj bi translated">破解杂凑</h2><p id="9e7f" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">一旦获取了散列值，就可以用<code class="fe mu mv mw mx b">John</code>或<code class="fe mu mv mw mx b">hashcat</code>来破解密码。</p><p id="3494" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">您也可以使用以下命令来搜索密码哈希，并且只使用一个命令强制执行:</p><p id="27fe" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><code class="fe mu mv mw mx b">python GetNPUsers.py &lt;domain_name&gt;/ -usersfile &lt;users_file&gt; -format &lt;AS_REP_responses_format [hashcat | john]&gt; -outputfile &lt;output_AS_REP_responses_file&gt;</code></p></div></div>    
</body>
</html>