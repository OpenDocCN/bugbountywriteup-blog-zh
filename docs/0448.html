<html>
<head>
<title>CVE-2019–17555: DoS via Retry-After header in Apache Olingo</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">CVE-2019–17555:通过Apache Olingo中的重试后标头拒绝服务</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/cve-2019-17555-dos-via-retry-after-header-in-apache-olingo-5b4a46cb6bde?source=collection_archive---------0-----------------------#2019-12-13">https://infosecwriteups.com/cve-2019-17555-dos-via-retry-after-header-in-apache-olingo-5b4a46cb6bde?source=collection_archive---------0-----------------------#2019-12-13</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="944e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Apache Olingo是一个实现开放数据协议(OData)的Java库。该协议允许以一种简单的方式创建和使用可查询和可互操作的RESTful APIs。</p><p id="2bf7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这篇文章描述了我最近在Apache Olingo中发现的一个小漏洞。该问题已在4.7.0版中修复。</p><p id="7a6c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">(最初发表于<a class="ae ko" href="https://blog.gypsyengineer.com/en/security/cve-2019-17555-dos-via-retry-after-header-in-apache-olingo.html" rel="noopener ugc nofollow" target="_blank">https://blog.gypsyengineer.com</a></p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi kp"><img src="../Images/42b5ef2dc7c411cd53c7ffafeffeb48d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*x7yeHHHBkVCSPu5n.jpg"/></div></div></figure><h1 id="fc30" class="lb lc it bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">问题</h1><p id="7aea" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated">OData协议在HTTP上运行。Apache Olingo实现了一个OData客户端。特别是，它提供了<code class="fe me mf mg mh b">AsyncRequestWrapperImpl</code>类，该类向OData服务器发送请求，然后处理响应。当客户端请求服务器创建新记录时，服务器可能无法立即创建记录。在这种情况下，服务器可能会回复202状态代码，并在响应中包含以下HTTP标头:</p><ul class=""><li id="d42b" class="mi mj it js b jt ju jx jy kb mk kf ml kj mm kn mn mo mp mq bi translated"><code class="fe me mf mg mh b">Location</code>带有一个监视器URL的标题，客户端可以检查该监视器以查看记录是否准备好。</li><li id="5b48" class="mi mj it js b jt mr jx ms kb mt kf mu kj mv kn mn mo mp mq bi translated"><code class="fe me mf mg mh b">Retry-After</code>带有客户端在检查监视器之前应该等待的秒数的标题。</li></ul><p id="89fe" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">发送请求后，<code class="fe me mf mg mh b">AsyncRequestWrapperImpl</code>类将收到的响应传递给<code class="fe me mf mg mh b">AsyncResponseWrapperImpl</code>。如果响应包含202状态码，那么<code class="fe me mf mg mh b">AsyncResponseWrapperImpl</code>类开始检查监视器。如果监视器返回202代码，那么类等待它从<code class="fe me mf mg mh b">Retry-After</code>头得到的秒数。<a class="ae ko" href="https://github.com/apache/olingo-odata4/blob/4.6.0/lib/client-core/src/main/java/org/apache/olingo/client/core/communication/request/AsyncRequestWrapperImpl.java" rel="noopener ugc nofollow" target="_blank">这里的</a>是它的样子:</p><pre class="kq kr ks kt gt mw mh mx my aw mz bi"><span id="a159" class="na lc it mh b gy nb nc l nd ne"><a class="ae ko" href="http://twitter.com/Override" rel="noopener ugc nofollow" target="_blank">@Override</a><br/>public R getODataResponse() {<br/>  HttpResponse res = null;<br/>  for (int i = 0; response == null &amp;&amp; i &lt; MAX_RETRY; i++) {<br/>    res = checkMonitor(location);</span><span id="52d4" class="na lc it mh b gy nf nc l nd ne">    if (res.getStatusLine().getStatusCode() == HttpStatusCode.ACCEPTED.getStatusCode()) {<br/>      final Header[] headers = res.getHeaders(HttpHeader.RETRY_AFTER);<br/>      if (ArrayUtils.isNotEmpty(headers)) {<br/>        this.retryAfter = Integer.parseInt(headers[0].getValue());<br/>      }</span><span id="b2a9" class="na lc it mh b gy nf nc l nd ne">      try {<br/>        // wait for retry-after<br/>        Thread.sleep((long)retryAfter * 1000);<br/>      } catch (InterruptedException ignore) {<br/>        // ignore<br/>      }</span></pre><p id="cbb2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这里的问题是头值直接指向<code class="fe me mf mg mh b">Thread.sleep()</code>方法。恶意服务器可以在<code class="fe me mf mg mh b">Retry-After</code>头中返回一个巨大的值，这使得客户端的线程长时间休眠。它可能有助于实现拒绝服务攻击，但是，攻击者可能很难欺骗客户端与恶意服务器对话。</p><h1 id="7afd" class="lb lc it bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">解决方案</h1><p id="8f1a" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated">通过检查<code class="fe me mf mg mh b">Retry-After</code>割台是否没有超过最大允许值，问题已被<a class="ae ko" href="https://github.com/apache/olingo-odata4/pull/61/files" rel="noopener ugc nofollow" target="_blank">修复</a>。如果报头大于最大允许值，则使用默认延迟。</p><h1 id="f65b" class="lb lc it bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="da03" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated">这个问题看起来并不严重，因为可能很难利用它。然而，为了安全起见，最好将Apache Olingo更新到4.7.0。</p><h1 id="767b" class="lb lc it bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">参考</h1><ul class=""><li id="74e2" class="mi mj it js b jt lz jx ma kb ng kf nh kj ni kn mn mo mp mq bi translated"><a class="ae ko" href="https://nvd.nist.gov/vuln/detail/CVE-2019-17555" rel="noopener ugc nofollow" target="_blank">CVE-2019-17555</a></li><li id="bf9a" class="mi mj it js b jt mr jx ms kb mt kf mu kj mv kn mn mo mp mq bi translated"><a class="ae ko" href="https://mail-archives.apache.org/mod_mbox/olingo-user/201912.mbox/%3CCAGSZ4d65UmudJ_MQkFXEv9YY_wwZbRA3sgtNDzMoLM51Qh%3DRCA%40mail.gmail.com%3E" rel="noopener ugc nofollow" target="_blank">阿帕奇安全咨询</a></li><li id="aeb3" class="mi mj it js b jt mr jx ms kb mt kf mu kj mv kn mn mo mp mq bi translated"><a class="ae ko" href="https://github.com/apache/olingo-odata4/pull/61" rel="noopener ugc nofollow" target="_blank">贴剂</a></li><li id="e4c0" class="mi mj it js b jt mr jx ms kb mt kf mu kj mv kn mn mo mp mq bi translated"><a class="ae ko" href="https://olingo.apache.org/" rel="noopener ugc nofollow" target="_blank"> Apache Olingo </a></li></ul></div><div class="ab cl nj nk hx nl" role="separator"><span class="nm bw bk nn no np"/><span class="nm bw bk nn no np"/><span class="nm bw bk nn no"/></div><div class="im in io ip iq"><p id="7069" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="nq">原为2019年12月13日在</em><a class="ae ko" href="https://blog.gypsyengineer.com/en/security/cve-2019-17555-dos-via-retry-after-header-in-apache-olingo.html" rel="noopener ugc nofollow" target="_blank"><em class="nq">https://blog.gypsyengineer.com</em></a><em class="nq">发表。</em></p></div><div class="ab cl nj nk hx nl" role="separator"><span class="nm bw bk nn no np"/><span class="nm bw bk nn no np"/><span class="nm bw bk nn no"/></div><div class="im in io ip iq"><p id="9240" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="nq">跟随</em> <a class="ae ko" href="https://medium.com/bugbountywriteup" rel="noopener"> <em class="nq"> Infosec写下</em> </a> <em class="nq">来获得更多精彩绝伦的写下。</em></p><div class="nr ns gp gr nt nu"><a href="https://medium.com/bugbountywriteup" rel="noopener follow" target="_blank"><div class="nv ab fo"><div class="nw ab nx cl cj ny"><h2 class="bd iu gy z fp nz fr fs oa fu fw is bi translated">信息安全记录</h2><div class="ob l"><h3 class="bd b gy z fp nz fr fs oa fu fw dk translated">世界上最好的黑客写的关于从臭虫奖励和CTF到vulnhub的话题的一个集合…</h3></div><div class="oc l"><p class="bd b dl z fp nz fr fs oa fu fw dk translated">medium.com</p></div></div><div class="od l"><div class="oe l of og oh od oi kz nu"/></div></div></a></div></div></div>    
</body>
</html>