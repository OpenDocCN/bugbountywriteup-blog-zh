<html>
<head>
<title>LDAP in Active Directory</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">活动目录中的LDAP</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/ldap-in-active-directory-f0de5729f72f?source=collection_archive---------0-----------------------#2022-06-19">https://infosecwriteups.com/ldap-in-active-directory-f0de5729f72f?source=collection_archive---------0-----------------------#2022-06-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/1917f405029370e6643e63a3ea8f892a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1306/format:webp/1*fSFKwxcjG1cRtTTXz2TmLg.png"/></div></figure><p id="3dc1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">本文提供了轻量级目录访问协议(LDAP)的基本概述。在本文中，我们将探索LDAP的基本功能以及如何在Active Directory (AD)环境中使用它。LDAP是一个很大的主题，本文将只涉及基础知识，所以说，让我们开始吧！</p></div><div class="ab cl ks kt hu ku" role="separator"><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx"/></div><div class="ij ik il im in"><h1 id="8380" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">什么是LDAP？</h1><p id="7777" class="pw-post-body-paragraph ju jv iq jw b jx lx jz ka kb ly kd ke kf lz kh ki kj ma kl km kn mb kp kq kr ij bi translated">微软对LDAP的描述如下:</p><blockquote class="md me mf"><p id="1a43" class="ju jv mg jw b jx jy jz ka kb kc kd ke mh kg kh ki mi kk kl km mj ko kp kq kr ij bi translated">轻型目录访问协议(LDAP)是一种直接在TCP/IP堆栈上运行的目录服务协议。它提供了一种用于连接、搜索和修改Internet目录的机制。</p></blockquote><p id="2d77" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">LDAP的主要功能是使用户能够找到关于组织、个人等的数据。LDAP是一种开放的跨平台协议，用于目录服务<strong class="jw ir">认证</strong>，并提供应用程序用来与其他目录服务服务器通信的通信语言。<strong class="jw ir">目录服务</strong>存储用户、密码和计算机帐户，并与网络上的其他实体(例如Active Directory)共享这些信息。</p></div><div class="ab cl ks kt hu ku" role="separator"><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx"/></div><div class="ij ik il im in"><h1 id="33d7" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">为什么在AD环境中使用LDAP？</h1><p id="f724" class="pw-post-body-paragraph ju jv iq jw b jx lx jz ka kb ly kd ke kf lz kh ki kj ma kl km kn mb kp kq kr ij bi translated">LDAP是AD背后的核心协议。目录访问是通过LDAP执行的—每当客户端在AD中搜索特定对象(比如用户或打印机)时，LDAP就会被用来查询相关对象并返回正确的结果。</p><p id="0ae8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">AD支持<a class="ae mc" href="https://medium.com/bugbountywriteup/kerberos-authentication-in-active-directory-2dc4af232f65" rel="noopener"> Kerberos </a>和LDAP认证协议，但是AD和Kerberos<strong class="jw ir">不跨平台</strong>。LDAP是一种与AD对话的方式，是一种跨平台的协议，许多不同的目录服务和访问管理解决方案都可以理解。由于Kerberos比LDAP更安全，并且LDAP比Kerberos具有更多功能，因此大多数组织同时使用这两种协议。</p><p id="a924" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">与Kerberos一样，LDAP用于AD环境中的身份验证。然而，使用LDAP认证，<strong class="jw ir">应用程序</strong>直接验证用户的凭证。应用程序有一对AD凭证，它可以首先使用这对凭证来查询LDAP，然后验证AD用户的凭证。LDAP身份验证是与AD集成的第三方(非微软)应用程序的常用机制。这些应用程序和系统包括:</p><ul class=""><li id="2939" class="mk ml iq jw b jx jy kb kc kf mm kj mn kn mo kr mp mq mr ms bi translated">Gitlab</li><li id="2541" class="mk ml iq jw b jx mt kb mu kf mv kj mw kn mx kr mp mq mr ms bi translated">詹金斯</li><li id="ea70" class="mk ml iq jw b jx mt kb mu kf mv kj mw kn mx kr mp mq mr ms bi translated">定制开发的web应用程序</li><li id="8f36" class="mk ml iq jw b jx mt kb mu kf mv kj mw kn mx kr mp mq mr ms bi translated">打印机</li><li id="593a" class="mk ml iq jw b jx mt kb mu kf mv kj mw kn mx kr mp mq mr ms bi translated">虚拟专用网</li></ul><p id="d6cc" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">总之，AD与LDAP一起工作，将两个应用程序结合起来可以改进访问管理。</p></div><div class="ab cl ks kt hu ku" role="separator"><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx"/></div><div class="ij ik il im in"><h1 id="acf5" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">LDAP认证是如何工作的？</h1><p id="cad1" class="pw-post-body-paragraph ju jv iq jw b jx lx jz ka kb ly kd ke kf lz kh ki kj ma kl km kn mb kp kq kr ij bi translated"><a class="ae mc" href="https://sensu.io/blog/what-is-ldap" rel="noopener ugc nofollow" target="_blank"> LDAP认证</a>包括通过连接使用LDAP协议的目录服务来验证所提供的用户名和密码。以这种方式使用LDAP的一些目录服务器有OpenLDAP、MS Active Directory和OpenDJ。</p><p id="1590" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">以下是客户端和AD集成打印机之间的认证过程的逐步分解:</p><ol class=""><li id="b3e4" class="mk ml iq jw b jx jy kb kc kf mm kj mn kn mo kr my mq mr ms bi translated">客户端发送一个带有他们的AD用户名和密码的打印请求。</li><li id="8710" class="mk ml iq jw b jx mt kb mu kf mv kj mw kn mx kr my mq mr ms bi translated">打印机(LDAP就绪系统)使用其AD凭据创建LDAP绑定请求，该请求用于验证客户端(例如用户或应用程序)并发送到域控制器(DC)。</li><li id="c089" class="mk ml iq jw b jx mt kb mu kf mv kj mw kn mx kr my mq mr ms bi translated">DC提供绑定响应来指示打印机的认证是否成功。</li><li id="6b01" class="mk ml iq jw b jx mt kb mu kf mv kj mw kn mx kr my mq mr ms bi translated">打印机请求LDAP用户搜索，用于在给定的<strong class="jw ir"> LDAP </strong>目录中搜索唯一用户<strong class="jw ir">。</strong></li><li id="87a6" class="mk ml iq jw b jx mt kb mu kf mv kj mw kn mx kr my mq mr ms bi translated">DC提供用户搜索响应。</li><li id="20e4" class="mk ml iq jw b jx mt kb mu kf mv kj mw kn mx kr my mq mr ms bi translated">打印机执行另一个LDAP绑定请求，但这次使用用户的AD凭证。</li><li id="a151" class="mk ml iq jw b jx mt kb mu kf mv kj mw kn mx kr my mq mr ms bi translated">DC提供另一个绑定响应来指示用户是否通过了身份验证。</li><li id="e991" class="mk ml iq jw b jx mt kb mu kf mv kj mw kn mx kr my mq mr ms bi translated">然后，打印机通知客户端验证是否成功以及打印作业是否被接受。</li></ol><p id="34a9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">下面的序列图说明了上面概述的步骤。</p><figure class="na nb nc nd gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi mz"><img src="../Images/6f08b61597709cf8fd3d95d191031b28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Nsehl_oAXqKH4UZpprRi2A.png"/></div></div><figcaption class="ni nj gj gh gi nk nl bd b be z dk translated">LDAP认证序列图示例。</figcaption></figure></div><div class="ab cl ks kt hu ku" role="separator"><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx"/></div><div class="ij ik il im in"><h1 id="5bca" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">LDAP信息收集</h1><h2 id="7529" class="nm la iq bd lb nn no dn lf np nq dp lj kf nr ns ln kj nt nu lr kn nv nw lv nx bi translated">NMAP扫描</h2><p id="ac6f" class="pw-post-body-paragraph ju jv iq jw b jx lx jz ka kb ly kd ke kf lz kh ki kj ma kl km kn mb kp kq kr ij bi translated">LDAP的默认端口是<strong class="jw ir"> </strong> 389和636(ldaps)。默认情况下，全局目录(ActiveDirectory中的LDAP)在LDAPS的3268和3269端口上可用。NMAP可用于检查目标机器上是否有任何默认LDAP端口是打开的。</p><pre class="na nb nc nd gt ny nz oa ob aw oc bi"><span id="a2ad" class="nm la iq nz b gy od oe l of og">nmap -sV -sC -Pn -v -oN nmap-report -p 389,636,3268,3269 10.10.174.119</span><span id="0be3" class="nm la iq nz b gy oh oe l of og"><strong class="nz ir">389/tcp</strong>   open  ldap          Microsoft Windows Active Directory LDAP (Domain: ENTERPRISE.THM0., Site: Default-First-Site-Name)<br/><strong class="nz ir">636/tcp </strong>  open  tcpwrapped<br/><strong class="nz ir">3268/tcp</strong>  open  ldap          Microsoft Windows Active Directory LDAP (Domain: ENTERPRISE.THM0., Site: Default-First-Site-Name)<br/><strong class="nz ir">3269/tcp</strong>  open  tcpwrapped</span></pre><p id="84f0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果LDAP端口打开，<a class="ae mc" href="https://book.hacktricks.xyz/network-services-pentesting/pentesting-ldap#automated" rel="noopener ugc nofollow" target="_blank"> NMAP </a>可用于查看公共信息(如企业的域名。THM):</p><pre class="na nb nc nd gt ny nz oa ob aw oc bi"><span id="3372" class="nm la iq nz b gy od oe l of og">nmap -n -sV --script "ldap* and not brute" -p 389 10.10.7.86</span><span id="77e6" class="nm la iq nz b gy oh oe l of og">| ldap-rootdse: <br/>| LDAP Results<br/>|   &lt;ROOT&gt;<br/>|       domainFunctionality: 7<br/>|       forestFunctionality: 7<br/>|       domainControllerFunctionality: 7<br/>|       rootDomainNamingContext: DC=ENTERPRISE,DC=THM<br/>|       ldapServiceName: <strong class="nz ir">ENTERPRISE.THM</strong>:lab-dc$@LAB.ENTERPRISE.THM<br/>|       isGlobalCatalogReady: TRUE<br/>|       supportedSASLMechanisms: GSSAPI<br/>|       supportedSASLMechanisms: GSS-SPNEGO<br/>|       supportedSASLMechanisms: EXTERNAL<br/>|       supportedSASLMechanisms: DIGEST-MD5<br/>.......etc.</span></pre><h2 id="a092" class="nm la iq bd lb nn no dn lf np nq dp lj kf nr ns ln kj nt nu lr kn nv nw lv nx bi translated">LDAP搜索</h2><p id="a34e" class="pw-post-body-paragraph ju jv iq jw b jx lx jz ka kb ly kd ke kf lz kh ki kj ma kl km kn mb kp kq kr ij bi translated"><a class="ae mc" href="https://book.hacktricks.xyz/network-services-pentesting/pentesting-ldap#ldapsearch" rel="noopener ugc nofollow" target="_blank"> LDAPsearch </a>可用于进一步查询域信息并执行额外的枚举，例如检查空凭证。</p><pre class="na nb nc nd gt ny nz oa ob aw oc bi"><span id="ba6e" class="nm la iq nz b gy od oe l of og"># Null Credentials<br/>ldapsearch -x -h &lt;IP&gt; -D '' -w '' -b "DC=&lt;1_SUBDOMAIN&gt;,DC=&lt;TDL&gt;"</span></pre><p id="7b02" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><a class="ae mc" href="https://book.hacktricks.xyz/network-services-pentesting/pentesting-ldap#basic-information" rel="noopener ugc nofollow" target="_blank"> HackTricks </a>提供了一个很好的概述，介绍了在渗透测试中如何枚举LDAP来查找关于域的信息。</p></div><div class="ab cl ks kt hu ku" role="separator"><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx"/></div><div class="ij ik il im in"><h1 id="d556" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">结束语</h1><p id="af97" class="pw-post-body-paragraph ju jv iq jw b jx lx jz ka kb ly kd ke kf lz kh ki kj ma kl km kn mb kp kq kr ij bi translated">希望这篇关于LDAP的短文有助于提供它是什么以及它如何工作的基本概述。LDAP是一个值得深入了解的大话题，并且被大多数使用Active Directory的大公司广泛使用。谢谢你看完，继续黑！😄</p></div></div>    
</body>
</html>