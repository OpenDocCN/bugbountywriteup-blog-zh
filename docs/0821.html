<html>
<head>
<title>How I hacked redbus [An online bus-ticketing application]</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我是如何黑掉redbus(一个在线公交售票应用程序)的</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/how-i-hacked-redbus-an-online-bus-ticketing-application-24ef5bb083cd?source=collection_archive---------0-----------------------#2020-09-12">https://infosecwriteups.com/how-i-hacked-redbus-an-online-bus-ticketing-application-24ef5bb083cd?source=collection_archive---------0-----------------------#2020-09-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="12f5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我两年前起草了这篇文章。因为补丁花了很长时间，现在贴上来]</p><p id="d2bd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是一个平常的清新而又困倦的星期一早晨。我走到办公桌前查看邮件。</p><p id="7ea8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">😴几分钟过去了..</p><p id="be3f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">☎️我的电话响了..</p><p id="2869" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我以为那是客户服务部打来的电话。不，是我妈妈(仅有的两个每天给我打电话的人😅).她打电话给我，提醒我周末订票的事。一切就是这样开始的。</p><p id="f488" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我订了票，最后到达确认页面，点击了一些我从来没有做过的事情。“<strong class="jp ir">打印/下载</strong>链接。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/e21f1c656222cdb453ba798233d34480.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*W6wNYgi7xj3nRKlUCRVGnQ.png"/></div></div></figure><p id="4d2e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">点击链接后，我被重定向到另一个子域“pdf.redbus.com ”,那里显示了我的门票的pdf版本。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kx"><img src="../Images/7226fd073284041a707e469f938e002d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*z8fDCFXIrC8XAz3e9uEV5A.png"/></div></div></figure><p id="1446" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">引起我注意的一件重要的事情是“PD4ML”。这个名字<br/> (PD-4-ML)本身就说明了它是某个东西的库。最明显的情况是它应该是pdf生成库。但是等等。为什么它显示pdf时没有任何票证ID或任何等效的标识符作为参数🤔。所以我只是回到上一页，监控所有点击“下载”链接后触发的请求。</p><p id="ac5b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是我得到的，</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ky"><img src="../Images/1a570cf0897861ae326b4c3f5b443ca4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jW5bEs1EsRy9qr1ihrcVTw.png"/></div></div></figure><p id="cf4a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这就是他们生成pdf的方式。从html内容到pdf。首先，为了验证服务器在转换过程中是否进行了外部调用，我尝试了下面的标记，</p><p id="a46e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><img src="”http://listener.myserver.com”"/></p><p id="726c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Woot。😃我收到一个java代理的请求。显然这是来自redbus pdf服务器。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kz"><img src="../Images/a7323800e431d46d11cf38cc88b4526c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Th4USQ0WjJo4t7xMZ4amMA.png"/></div></div></figure><p id="1554" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，我尝试使用iframe标签来检查它是否在框架上加载了本地文件。我得到的只是一个空白的回答。😐</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ky"><img src="../Images/96a6263f60643aaf16a2405e55cc5fa4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3BnGvOO-dn4QUyTQcESRsw.png"/></div></div></figure><p id="811f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Googled了一下pd4ml——是否支持javascript(针对动态页面)。答案是否定的！<br/>没有放弃，我开始看<a class="ae la" href="http://pd4ml.com/html.htm" rel="noopener ugc nofollow" target="_blank"> pd4ml </a>的文档。我发现pd4ml不支持iframe标签，也不支持object、applet等其他标签。</p><p id="feec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在该怎么办😕。向下滚动文档页面。并且发现了这个有趣的东西叫做“专有标签”。</p><p id="8256" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">开始试验这个<strong class="jp ir"> &lt; pd4ml:附件&gt; </strong>标签。根据文档，它用于在pdf中嵌入附件。这听起来很有趣😉。标签要求附件链接具有“src”属性。</p><p id="67c2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">像这样简单地修改了标签，</p><p id="b4a8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> &lt; pd4ml:附件src = " file:///etc/passwd "&gt;&lt;pd4ml:附件&gt; </strong></p><p id="36d3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">瞧😲。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ky"><img src="../Images/f45e8529f0969b48abf98e81f8d3c2cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VXryjMhN9E9tKC_LIcHmhA.png"/></div></div></figure><p id="0d9e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此时，我确认了任意文件就绪漏洞。但是我对passwd文件不是很满意。进一步挖掘。幸运的是，我也能看到目录名。所以很容易跳转到目录。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lb"><img src="../Images/9366919d5fa38541978e4af553e33eb1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JFiRXsflMlIvOVfehJU2vg.png"/></div></div></figure><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lc"><img src="../Images/f6105d6f92bf7a2ab54b533750ad2219.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0xe0n_b3_5E7JPYXYE4VEQ.png"/></div></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated">部分修订的私钥文件</figcaption></figure><p id="4418" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在看起来像一些真正的东西👻。<strong class="jp ir"> SSH私有密钥、带有数据库密码的配置文件以及包含一些有趣信息的MySQL _ history</strong>😜。</p><p id="a035" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">其他用户的pdf预订单应该在这里的某个地方🤔。</p><p id="ff52" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">手头有了读取的任意文件，我检查了index.jsp的源代码，并找到了pdf文件的确切存储位置。</p><p id="d30a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">去查了一下目录，终于找到了这个。😍</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lh"><img src="../Images/40389dd937a331791c8bdc41823298a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PQvkzjXuF-TT9YUCJRHRHQ.png"/></div></div></figure><p id="4b2f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这与pdf无关。这是关于你的机票id😉</p><p id="eb3f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有了ticketID，任何经过认证的用户都可以提取个人信息，如电子邮件、手机号码、年龄、出生日期(如果有的话)等。,</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lh"><img src="../Images/31f61daa39cb22eb52e3bc37e8a83f27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-odUejG2yq9RWCMf7v2wjg.png"/></div></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated">部分编辑的回复</figcaption></figure><p id="0a5a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">外卖:</strong></p><p id="ac4b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于Bug猎人来说，<br/>一旦你用侦察推断出后端库，总是要看文档。</p><p id="faf1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于开发者来说，</p><p id="2b99" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面是您需要添加到白名单中的本地目录或远程资源的配置</p><pre class="km kn ko kp gt li lj lk ll aw lm bi"><span id="45a2" class="ln lo iq lj b gy lp lq l lr ls"> Map m = new HashMap(); <br/> m.put(PD4Constants.PD4ML_ALLOWED_RESOURCE_LOCATION, “<a class="ae la" href="http://server/webapp,file:/my/safe/file/folder" rel="noopener ugc nofollow" target="_blank">http://server/webapp,file:/my/safe/file/folder</a>"); <br/> pd4ml.setDynamicParams(m);</span></pre><p id="4b77" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">时间线:</strong></p><ul class=""><li id="9860" class="lt lu iq jp b jq jr ju jv jy lv kc lw kg lx kk ly lz ma mb bi translated">【2018 . 10 . 15】问题上报给redbus。</li><li id="41c5" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">[2018年10月15日] Redbus团队在承认该问题后，立即删除了SSH私钥，作为即时修复措施。</li><li id="3b1d" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">[2018年10月16日]报告了额外的信息，即它也泄露了用户的PII，这被认为是重复的，因为他们已经作为一个单独的问题跟踪它。</li><li id="1ec3" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">[2018年10月16日]获得丰厚赏金🤥</li><li id="66c8" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">[2018年12月6日] Redbus安全团队要求我将其报告给pd4ml，以获得针对此问题分配的CVE，如果它在最新版本中可重现的话。</li><li id="31dc" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">【2018 . 12 . 14】发邮件给pd4ml举报问题。</li><li id="2af5" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">[2018年12月19日]与此同时，我收到redbus security的一封邮件，称他们计划删除该功能</li><li id="c9fb" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">[2019年1月4日]在与pd4ml的连续电子邮件之后，我了解到他们已经有了可选的控制措施来避免这个问题，并将其转发给了rebus团队。</li><li id="0676" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">【2019 . 2 . 26】有更新吗？—不，还没有。</li><li id="e7c3" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">【2019 . 9 . 20】有更新吗？—补丁将在一周内发布</li><li id="9d98" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">[2019年12月18日] Redbus团队通知我，他们为pdf生成实施了新的工作流程。但是pdf.redbus.com仍然是可以接近的，所以这个问题。</li><li id="dcd3" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">[2019年12月20日]在挖掘了新的实现后，发现他们正在使用<strong class="jp ir"> PhantomJS </strong>来生成pdf。不允许读取本地文件，因为他们正在加载关于:空白页中的自定义html。iframe内部不允许加载file:///协议，但允许http。最终去了SSRF😬并报告了同样的情况。</li><li id="5d84" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">[2020年2月3日] Redbus通过将pdf生成模块作为内部微服务进行移动，修复了该问题。(这个没有赏金😅。没关系！)</li><li id="1e51" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">[2020年7月16日]但是pdf.redbus.com仍然是公开的，有什么更新吗？</li><li id="0423" class="lt lu iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">[2020年9月11日]pdf.rebus.com被禁止公开访问。</li></ul><p id="7675" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在整个过程中，我注意到处理这个案子的人被提升为高级安全工程师。恭喜伙计！😃。那是一个漫长的旅程！</p></div></div>    
</body>
</html>