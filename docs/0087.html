<html>
<head>
<title>Stapler pt. 1 — Root with just Enumeration</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">订书机角1-仅包含枚举的根</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/stapler-pt-1-c9a14793eb3?source=collection_archive---------0-----------------------#2018-04-27">https://infosecwriteups.com/stapler-pt-1-c9a14793eb3?source=collection_archive---------0-----------------------#2018-04-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/dc5b72126888555d97583dfb961b3221.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pIXDvMvHXcU0_9RUja2IWg.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">订书机</figcaption></figure><h1 id="e99c" class="kc kd iq bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">摘要</h1><p id="8dec" class="pw-post-body-paragraph la lb iq lc b ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ij bi translated">Stapler是一个运行多种服务的Ubuntu服务器。本演练将讨论如何枚举其中三个服务以获得对计算机的root访问权限。被访问的服务有<strong class="lc ir"> FTP </strong>、<strong class="lc ir"> SMB </strong>和<strong class="lc ir"> SSH </strong>。</p><blockquote class="ly"><p id="c65d" class="lz ma iq bd mb mc md me mf mg mh lx dk translated">被利用的主要漏洞有:<br/>弱用户凭证<br/>强凭证使用不当</p></blockquote><h1 id="af1f" class="kc kd iq bd ke kf kg kh ki kj kk kl km kn mi kp kq kr mj kt ku kv mk kx ky kz bi translated">侦察/扫描</h1><p id="b3ea" class="pw-post-body-paragraph la lb iq lc b ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ij bi translated">我最初的侦察是对本地网络进行arp扫描，以便用<code class="fe ml mm mn mo b">netdiscover</code>快速返回目标在我私有范围内的IP地址。</p><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="4f56" class="mx kd iq mo b gy my mz l na nb">netdiscover -r 192.168.15.0/24</span></pre><blockquote class="nc nd ne"><p id="4a9b" class="la lb nf lc b ld ng lf lg lh nh lj lk ni nj ln lo nk nl lr ls nm nn lv lw lx ij bi translated">-r指定网络范围</p></blockquote><figure class="mp mq mr ms gt jr"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="3c90" class="pw-post-body-paragraph la lb iq lc b ld ng lf lg lh nh lj lk ll nj ln lo lp nl lr ls lt nn lv lw lx ij bi translated">接下来，我使用<code class="fe ml mm mn mo b">nmap</code>列举了主机上的操作系统和开放端口。</p><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="995e" class="mx kd iq mo b gy my mz l na nb">nmap -O 192.168.15.151</span></pre><figure class="mp mq mr ms gt jr"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="de84" class="pw-post-body-paragraph la lb iq lc b ld ng lf lg lh nh lj lk ll nj ln lo lp nl lr ls lt nn lv lw lx ij bi translated">很快，我们可以看到有大量的服务在运行。太多了，不知道从哪里开始。随着Linux 3.2 — 4.8的推出，操作系统检测又回来了，范围相当广泛……让我们再深入一点。</p><p id="d2df" class="pw-post-body-paragraph la lb iq lc b ld ng lf lg lh nh lj lk ll nj ln lo lp nl lr ls lt nn lv lw lx ij bi translated">接下来，我开始了另一次<code class="fe ml mm mn mo b">nmap</code>扫描。这一次是枚举在每个端口上运行的服务版本，并在这些服务上运行默认脚本，以潜在地获得附加信息。</p><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="8533" class="mx kd iq mo b gy my mz l na nb">nmap -sV -sC 192.168.15.151</span></pre><blockquote class="nc nd ne"><p id="a1b8" class="la lb nf lc b ld ng lf lg lh nh lj lk ni nj ln lo nk nl lr ls nm nn lv lw lx ij bi translated">-sV枚举服务版本</p><p id="a571" class="la lb nf lc b ld ng lf lg lh nh lj lk ni nj ln lo nk nl lr ls nm nn lv lw lx ij bi translated">-sC运行默认脚本</p></blockquote><figure class="mp mq mr ms gt jr"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="04da" class="pw-post-body-paragraph la lb iq lc b ld ng lf lg lh nh lj lk ll nj ln lo lp nl lr ls lt nn lv lw lx ij bi translated">好的，这里有很多东西要打开。</p><p id="da04" class="pw-post-body-paragraph la lb iq lc b ld ng lf lg lh nh lj lk ll nj ln lo lp nl lr ls lt nn lv lw lx ij bi translated">SMB和SSH在其版本中将Ubuntu 称为主机操作系统。很高兴知道。</p><p id="37c0" class="pw-post-body-paragraph la lb iq lc b ld ng lf lg lh nh lj lk ll nj ln lo lp nl lr ls lt nn lv lw lx ij bi translated">现在让我们一次只看一个端口。查看第一个打开的端口，我们可以看到该服务器允许匿名FTP。我们去看看。</p><h1 id="d32b" class="kc kd iq bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">文件传送协议</h1><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="c08b" class="mx kd iq mo b gy my mz l na nb">ftp 192.168.15.151</span></pre><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/13e832e34a7a0021ce31289c4c6b2256.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CSWs0xKHbv5ZQ7udRZypAQ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">匿名FTP</figcaption></figure><p id="c357" class="pw-post-body-paragraph la lb iq lc b ld ng lf lg lh nh lj lk ll nj ln lo lp nl lr ls lt nn lv lw lx ij bi translated">甚至在登录服务器之前，我们就会看到一个包含名字的横幅。我注意到这是一个潜在的用户名，并继续前进。</p><p id="abf6" class="pw-post-body-paragraph la lb iq lc b ld ng lf lg lh nh lj lk ll nj ln lo lp nl lr ls lt nn lv lw lx ij bi translated">要匿名登录FTP服务器，只需输入“Anonymous”作为用户名，并给出一个空密码。</p><p id="cfca" class="pw-post-body-paragraph la lb iq lc b ld ng lf lg lh nh lj lk ll nj ln lo lp nl lr ls lt nn lv lw lx ij bi translated">一旦在服务器上，我们被放在一个无处可去的目录和一个名为<code class="fe ml mm mn mo b">note</code>的文件中。我们可以使用命令<code class="fe ml mm mn mo b">get note</code>将便笺传输回我们的机器。</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/1d823869d8585c17338e073627ab225f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*azVnYp0pMFjBo7X4Y0vGxg.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">获取注释</figcaption></figure><p id="6f7d" class="pw-post-body-paragraph la lb iq lc b ld ng lf lg lh nh lj lk ll nj ln lo lp nl lr ls lt nn lv lw lx ij bi translated">这个文件揭示了另外两个潜在的用户名:<code class="fe ml mm mn mo b">Elly</code> &amp; <code class="fe ml mm mn mo b">John</code>。</p><h2 id="f5bc" class="mx kd iq bd ke nq nr dn ki ns nt dp km ll nu nv kq lp nw nx ku lt ny nz ky oa bi translated">FTP凭据审核</h2><p id="81a1" class="pw-post-body-paragraph la lb iq lc b ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ij bi translated">现在我们已经有了三个潜在的用户名，让我们使用<code class="fe ml mm mn mo b">hydra</code>来检查劣质的FTP凭证。我创建了一个大小写都合适的用户列表。</p><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="d19a" class="mx kd iq mo b gy my mz l na nb">hydra -L users -e nsr <!-- -->ftp://192.168.15.151</span></pre><blockquote class="nc nd ne"><p id="06f5" class="la lb nf lc b ld ng lf lg lh nh lj lk ni nj ln lo nk nl lr ls nm nn lv lw lx ij bi translated">-L提供用户名列表</p><p id="b334" class="la lb nf lc b ld ng lf lg lh nh lj lk ni nj ln lo nk nl lr ls nm nn lv lw lx ij bi translated"><code class="fe ml mm mn mo b">-e nsr</code>检查<strong class="lc ir">空</strong>密码、用户名为密码(<strong class="lc ir">同</strong>)或用户名为密码的反码(<strong class="lc ir">反</strong>)</p></blockquote><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/fdcb1276b32882514599c7daa2f452d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*07CaqiutSeH78IQE6frcsw.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">九头蛇FTP</figcaption></figure><p id="107d" class="pw-post-body-paragraph la lb iq lc b ld ng lf lg lh nh lj lk ll nj ln lo lp nl lr ls lt nn lv lw lx ij bi translated">本次审计返回了<code class="fe ml mm mn mo b">elly</code>的凭证！</p><p id="dbe1" class="pw-post-body-paragraph la lb iq lc b ld ng lf lg lh nh lj lk ll nj ln lo lp nl lr ls lt nn lv lw lx ij bi translated">访问他们的FTP目录会发现一堆文件。其中许多我们可以复制到我们的机器上…其中一个叫做<code class="fe ml mm mn mo b">passwd</code>。将它复制回主机，我们能够检查它并确认它似乎是<code class="fe ml mm mn mo b">/etc/passwd</code>的副本。</p><p id="0008" class="pw-post-body-paragraph la lb iq lc b ld ng lf lg lh nh lj lk ll nj ln lo lp nl lr ls lt nn lv lw lx ij bi translated">让我们使用一个聪明的<code class="fe ml mm mn mo b">awk</code>命令行程序来生成一个在登录时访问<code class="fe ml mm mn mo b">/bin/bash</code>的用户列表。</p><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="ac95" class="mx kd iq mo b gy my mz l na nb">awk -F':' '/\/bin\/bash/{print $1}' passwd &gt; users</span></pre><blockquote class="nc nd ne"><p id="b95b" class="la lb nf lc b ld ng lf lg lh nh lj lk ni nj ln lo nk nl lr ls nm nn lv lw lx ij bi translated"><code class="fe ml mm mn mo b">-F':'</code>集:为田忌</p><p id="8aa1" class="la lb nf lc b ld ng lf lg lh nh lj lk ni nj ln lo nk nl lr ls nm nn lv lw lx ij bi translated"><code class="fe ml mm mn mo b">/\/bin\/bash</code>查找包含/bin/bash的行</p><p id="74bc" class="la lb nf lc b ld ng lf lg lh nh lj lk ni nj ln lo nk nl lr ls nm nn lv lw lx ij bi translated"><code class="fe ml mm mn mo b">{print $1}</code>打印由<code class="fe ml mm mn mo b">:</code>分割的第一个字段</p><p id="1eb7" class="la lb nf lc b ld ng lf lg lh nh lj lk ni nj ln lo nk nl lr ls nm nn lv lw lx ij bi translated"><code class="fe ml mm mn mo b">&gt; users</code>将用户列表输出到名为<code class="fe ml mm mn mo b">users</code>的文件中</p></blockquote><p id="a465" class="pw-post-body-paragraph la lb iq lc b ld ng lf lg lh nh lj lk ll nj ln lo lp nl lr ls lt nn lv lw lx ij bi translated">现在我们已经有了一个很长的用户列表，可以ssh到bash shell中。让我们用这个列表做另一个弱密码审计，但是这次是在SSH上。</p><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="97f6" class="mx kd iq mo b gy my mz l na nb">hydra -L users -e nsr ssh://192.168.15.151</span></pre><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/8d6389f649de111ba46ae92d1e7a44a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aeIo9iSv-Xj4MpbT26aUWw.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">九头蛇SSH</figcaption></figure><p id="c5aa" class="pw-post-body-paragraph la lb iq lc b ld ng lf lg lh nh lj lk ll nj ln lo lp nl lr ls lt nn lv lw lx ij bi translated">这将为用户返回一个凭证<code class="fe ml mm mn mo b">SHayslett</code></p><blockquote class="ly"><p id="e958" class="lz ma iq bd mb mc md me mf mg mh lx dk translated">…在继续之前，让我们看看另一种更实际的枚举本地用户帐户的方法</p></blockquote><h1 id="fe38" class="kc kd iq bd ke kf kg kh ki kj kk kl km kn mi kp kq kr mj kt ku kv mk kx ky kz bi translated">服务器信息块</h1><p id="d450" class="pw-post-body-paragraph la lb iq lc b ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ij bi translated">我们之前的<code class="fe ml mm mn mo b">nmap</code>扫描显示SMB处于开放状态。我们可以使用<code class="fe ml mm mn mo b">enum4linux</code>来做大量繁重的工作，以从该服务返回结果。通常当我运行这个脚本时，我会指定<code class="fe ml mm mn mo b">-a</code>来使用所有的枚举方法，但是这非常冗长，并且有很多干扰需要筛选。让我们来看看返回本地用户帐户列表的内容:</p><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="e8d6" class="mx kd iq mo b gy my mz l na nb">enum4linux -r 192.168.15.151</span></pre><blockquote class="nc nd ne"><p id="bb7d" class="la lb nf lc b ld ng lf lg lh nh lj lk ni nj ln lo nk nl lr ls nm nn lv lw lx ij bi translated">-r将通过强制SID来枚举用户</p></blockquote><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ob"><img src="../Images/fc0fdad7331dad5e369615e38bc416a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QVxSWDq0do3sqY0qkRbctg.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">enum4linux强制sid</figcaption></figure><p id="f185" class="pw-post-body-paragraph la lb iq lc b ld ng lf lg lh nh lj lk ll nj ln lo lp nl lr ls lt nn lv lw lx ij bi translated">类似于我们如何解析<code class="fe ml mm mn mo b">passwd</code>文件，我们可以再次使用<code class="fe ml mm mn mo b">awk</code>来生成用户列表。我们可以使用这个带有<code class="fe ml mm mn mo b">hydra</code>的用户列表来返回与从FTP中的<code class="fe ml mm mn mo b">passwd</code>文件生成的列表相同的凭证。</p><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="4989" class="mx kd iq mo b gy my mz l na nb">awk -F’\‘ '/Local User/{print $1}' enumUsers | cut -d' ' -f1</span></pre><blockquote class="nc nd ne"><p id="baa9" class="la lb nf lc b ld ng lf lg lh nh lj lk ni nj ln lo nk nl lr ls nm nn lv lw lx ij bi translated"><code class="fe ml mm mn mo b">| cut -d' ' -f1</code>用空格分割<code class="fe ml mm mn mo b">awk</code>的输出，并返回第一个字段，在本例中，这是用户名</p></blockquote><h1 id="d5d0" class="kc kd iq bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">嘘</h1><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oc"><img src="../Images/a256ccdd0584a77ba68307db1540d127.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*051TzDV7EFGv4VaPLh9I5Q.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">嘘</figcaption></figure><p id="c9a2" class="pw-post-body-paragraph la lb iq lc b ld ng lf lg lh nh lj lk ll nj ln lo lp nl lr ls lt nn lv lw lx ij bi translated">以<code class="fe ml mm mn mo b">SHayslett</code>的身份通过SSH登录，我们看到我们似乎是一个低特权用户。我的主目录中没有多少文件，但是有一个我可以阅读的<code class="fe ml mm mn mo b">.bash_history</code>文件。这是一个由Bash维护的文件，它包含一个保存在内存中的命令列表，在退出时写入。</p><p id="05c2" class="pw-post-body-paragraph la lb iq lc b ld ng lf lg lh nh lj lk ll nj ln lo lp nl lr ls lt nn lv lw lx ij bi translated">事实上，每个用户的主目录中都有<code class="fe ml mm mn mo b">.bash_history</code>文件。我们可以阅读其中的一些！让我们看看其他人都做了些什么…</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi od"><img src="../Images/f6d9517d5107f882038d457b529b9051.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R1TSFlSUej3-cXsBr2_HOg.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">。bash _历史</figcaption></figure><p id="8c0d" class="pw-post-body-paragraph la lb iq lc b ld ng lf lg lh nh lj lk ll nj ln lo lp nl lr ls lt nn lv lw lx ij bi translated">不错！我们有另外两个用户的明文凭证。我们可以查看这些账户，看看他们有什么特权。</p><h1 id="f872" class="kc kd iq bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">权限提升</h1><p id="c0e6" class="pw-post-body-paragraph la lb iq lc b ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ij bi translated">切换到<code class="fe ml mm mn mo b">peter</code>给了我们<code class="fe ml mm mn mo b">sudo</code>特权以root用户身份运行任何命令。当我们以<code class="fe ml mm mn mo b">peter</code>身份执行sudo时，系统会提示我们输入用户密码，所有执行的东西都会以<code class="fe ml mm mn mo b">root</code>身份运行。有几个简单的oneliners程序可以实现完全交互的根shell，它们是:</p><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="2db2" class="mx kd iq mo b gy my mz l na nb">sudo su</span></pre><p id="825b" class="pw-post-body-paragraph la lb iq lc b ld ng lf lg lh nh lj lk ll nj ln lo lp nl lr ls lt nn lv lw lx ij bi translated">或者</p><pre class="mp mq mr ms gt mt mo mu mv aw mw bi"><span id="85ad" class="mx kd iq mo b gy my mz l na nb">sudo /bin/bash</span></pre><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/c4167f45776bf4670357d253beea40ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5blY4VXKwRauSQX2ziFWlA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">根</figcaption></figure><h1 id="6b44" class="kc kd iq bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">未完待续…</h1><p id="97fd" class="pw-post-body-paragraph la lb iq lc b ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ij bi translated">这还不算太糟——我们甚至没有参加所有的服务！</p><p id="d1da" class="pw-post-body-paragraph la lb iq lc b ld ng lf lg lh nh lj lk ll nj ln lo lp nl lr ls lt nn lv lw lx ij bi translated">第2部分将介绍更多的服务和根机器的替代路径。</p><p id="a810" class="pw-post-body-paragraph la lb iq lc b ld ng lf lg lh nh lj lk ll nj ln lo lp nl lr ls lt nn lv lw lx ij bi translated">会有战功。</p></div></div>    
</body>
</html>