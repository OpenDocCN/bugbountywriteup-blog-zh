<html>
<head>
<title>XML External Entities</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">XML外部实体</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/xml-external-entities-9c2f2169430a?source=collection_archive---------1-----------------------#2022-10-18">https://infosecwriteups.com/xml-external-entities-9c2f2169430a?source=collection_archive---------1-----------------------#2022-10-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="91e0" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">作者:<a class="ae kf" href="https://www.instagram.com/_ansh_vyas/" rel="noopener ugc nofollow" target="_blank">安舒尔·维亚斯</a></h2></div><figure class="kh ki kj kk gt kl gh gi paragraph-image"><div class="gh gi kg"><img src="../Images/91eb7334f4e58e9234286aaee60453bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/0*zQsFflz3jSiNvyRJ.png"/></div></figure><h1 id="04ff" class="ko kp iq bd kq kr ks kt ku kv kw kx ky jw kz jx la jz lb ka lc kc ld kd le lf bi translated">XML:可扩展标记语言</h1><p id="c363" class="pw-post-body-paragraph lg lh iq li b lj lk jr ll lm ln ju lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">顾名思义，XML代表可扩展标记语言。标记语言由一组称为标签的代码组成，用于描述数字文档中的文本。HTML是网站最流行的标记语言。</p><h1 id="1bf3" class="ko kp iq bd kq kr ks kt ku kv kw kx ky jw kz jx la jz lb ka lc kc ld kd le lf bi translated">XML外部实体</h1><p id="a57e" class="pw-post-body-paragraph lg lh iq li b lj lk jr ll lm ln ju lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">XML外部实体是一种具有定义值的自定义XML实体，这些值在声明它们的DTD之外加载。从安全的角度来看，外部实体特别有趣，因为它们允许基于文件路径或URL的内容来定义实体。XML外部实体攻击是针对解析XML输入的应用程序的攻击。</p><p id="15e2" class="pw-post-body-paragraph lg lh iq li b lj mc jr ll lm md ju lo lp me lr ls lt mf lv lw lx mg lz ma mb ij bi translated">当使用带有弱配置XML处理选项的XML解析器来处理包含外部实体引用的XML输入时，就会发生这种攻击。XXE仅用于获取包含“有效”XML的文件，而不是二进制文件。</p><h1 id="4d2c" class="ko kp iq bd kq kr ks kt ku kv kw kx ky jw kz jx la jz lb ka lc kc ld kd le lf bi translated">XML注入</h1><p id="c51d" class="pw-post-body-paragraph lg lh iq li b lj lk jr ll lm ln ju lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">攻击者可以在web上使用XML外部实体注入(或简称为XXE)来干扰应用程序对XML数据的处理。</p><h2 id="67c6" class="mh kp iq bd kq mi mj dn ku mk ml dp ky lp mm mn la lt mo mp lc lx mq mr le ms bi translated">工作</h2><p id="0281" class="pw-post-body-paragraph lg lh iq li b lj lk jr ll lm ln ju lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">通过使用标签和数据的树状结构来存储和传输数据，XML使用了树状结构。XML文档可以附带指定数据值、权限等的文档类型定义(DTD)。有两种方法可以使用DTD:可以将它合并到文档本身中，也可以引用外部版本。当文档引用外部DTD时，其定义位于声明它们的DTD之外的自定义实体被称为XML外部实体。</p><h1 id="a8de" class="ko kp iq bd kq kr ks kt ku kv kw kx ky jw kz jx la jz lb ka lc kc ld kd le lf bi translated">XML注入</h1><p id="afad" class="pw-post-body-paragraph lg lh iq li b lj lk jr ll lm ln ju lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">恶意方有可能通过XML外部实体注入(XXE)拦截或更改应用程序与其服务器之间传递的数据。恶意方还可以通过从您的服务器检索文件来执行SSRF攻击或发起盲目的XXE攻击。</p><p id="27db" class="pw-post-body-paragraph lg lh iq li b lj mc jr ll lm md ju lo lp me lr ls lt mf lv lw lx mg lz ma mb ij bi translated">通过使用XML元字符，可以修改结果XML文档的结构。当用户以不安全的方式将输入插入服务器端XML文档或SOAP消息时，就会出现XML注入漏洞。</p><h1 id="fb8f" class="ko kp iq bd kq kr ks kt ku kv kw kx ky jw kz jx la jz lb ka lc kc ld kd le lf bi translated">XML注入攻击的类型</h1><p id="c269" class="pw-post-body-paragraph lg lh iq li b lj lk jr ll lm ln ju lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">利用本主题中描述的攻击，可以攻击任何解析XML输入的应用程序。特别是，攻击者创建应用程序使用的畸形或狡猾的XML，目的是欺骗XML解析器进行一些破坏。一般来说，对有错误或配置错误的XML解析器会有两种类型的攻击。</p><h2 id="1f7d" class="mh kp iq bd kq mi mj dn ku mk ml dp ky lp mm mn la lt mo mp lc lx mq mr le ms bi translated">XML炸弹</h2><p id="e57e" class="pw-post-body-paragraph lg lh iq li b lj lk jr ll lm ln ju lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">当XML解析器崩溃或不能正确处理某些输入数据时，就会发生拒绝服务攻击。</p><h2 id="8e91" class="mh kp iq bd kq mi mj dn ku mk ml dp ky lp mm mn la lt mo mp lc lx mq mr le ms bi translated">XXE披露</h2><p id="472e" class="pw-post-body-paragraph lg lh iq li b lj lk jr ll lm ln ju lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">解析器可能会无意中泄露敏感信息。以下部分描述了每种类型的攻击是如何发起的。请注意，攻击可以利用完全有效的XML，也可以利用潜在的格式错误的XML(除非解析器检测到它并完全拒绝它)。</p><h2 id="57e5" class="mh kp iq bd kq mi mj dn ku mk ml dp ky lp mm mn la lt mo mp lc lx mq mr le ms bi translated">XML炸弹攻击</h2><p id="ad0c" class="pw-post-body-paragraph lg lh iq li b lj lk jr ll lm ln ju lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">有许多类型的XML炸弹，但它们都被设计成在执行时导致XML解析器或处理其输出的应用程序挂起或崩溃。例如，十亿次大笑攻击在XML解析期间使用一个短的XML文件来增长到大约3gb的数据。很容易看出数据大小是如何任意增加的，并且产生的大量数据通常会使任何应用程序崩溃。</p><h2 id="8c38" class="mh kp iq bd kq mi mj dn ku mk ml dp ky lp mm mn la lt mo mp lc lx mq mr le ms bi translated">减轻XML炸弹</h2><p id="cc65" class="pw-post-body-paragraph lg lh iq li b lj lk jr ll lm ln ju lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">应用程序可以通过配置XML解析器禁用内联实体扩展来避免XML炸弹。攻击者不可能在没有内联扩展的情况下增加几何尺寸，这导致这些攻击变得无害。当应用程序需要实体扩展时，或者如果XML解析器不提供此配置选项，设置解析器来强制限制扩展实体的大小。</p><p id="905a" class="pw-post-body-paragraph lg lh iq li b lj mc jr ll lm md ju lo lp me lr ls lt mf lv lw lx mg lz ma mb ij bi translated">以下示例代码禁用标准中的内联dtd。NET 4.0 XML解析器:</p><pre class="kh ki kj kk gt mt mu mv mw aw mx bi"><span id="5811" class="mh kp iq mu b gy my mz l na nb">XmlReaderSettings settings = new XmlReaderSettings();<br/>settings.DtdProcessing = DtdProcessing.Prohibit; XmlReader reader =<br/>XmlReader.Create(stream, settings);</span></pre><p id="fded" class="pw-post-body-paragraph lg lh iq li b lj mc jr ll lm md ju lo lp me lr ls lt mf lv lw lx mg lz ma mb ij bi translated">在这种配置中，两个XML炸弹都不会消耗过多的内存。数据结构将显示来自源XML的实体扩展结构，而不是存储千兆字节的数据。为了避免导致拒绝服务，应用程序必须直接构建相关实体的扩展形式，并确保在此过程中进行适当的检查。</p><h1 id="8122" class="ko kp iq bd kq kr ks kt ku kv kw kx ky jw kz jx la jz lb ka lc kc ld kd le lf bi translated">XML外部实体(XXE)攻击</h1><p id="a99d" class="pw-post-body-paragraph lg lh iq li b lj lk jr ll lm ln ju lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">外部实体是通用XML的一个特性，可以用来攻击应用程序。当攻击者提供包含对外部实体的引用的XML输入时，XML解析器将读取引用的数据，并将其处理成结果XML文档。XML外部实体允许从外部URIs提取替换值，以便可以访问文件和网络资源。攻击者有可能利用XML解析器进程的权限来操纵结果数据，从而泄漏数据。对非常大的数据源的引用也可能导致拒绝服务攻击。</p><p id="ee73" class="pw-post-body-paragraph lg lh iq li b lj mc jr ll lm md ju lo lp me lr ls lt mf lv lw lx mg lz ma mb ij bi translated">举个例子，假设一个XML输入引用/dev/random，一个无限期运行的伪随机字节文件(具体来说，连续读取随机字节会在系统熵池耗尽时阻塞，再次重新供应数据时会重新供应数据)。XML解析器将从外部实体读取和构造数据，直到文件结束。这将使系统过载到故障点。</p><pre class="kh ki kj kk gt mt mu mv mw aw mx bi"><span id="0c5e" class="mh kp iq mu b gy my mz l na nb">!ENTITY xxe SYSTEM file:///dev/random&gt;</span></pre><h1 id="b795" class="ko kp iq bd kq kr ks kt ku kv kw kx ky jw kz jx la jz lb ka lc kc ld kd le lf bi translated">减轻XML外部实体(XXE)攻击</h1><p id="dadc" class="pw-post-body-paragraph lg lh iq li b lj lk jr ll lm ln ju lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">通过防止外部引用被完全解析，XML解析器可以防止XXE攻击。</p><p id="375e" class="pw-post-body-paragraph lg lh iq li b lj mc jr ll lm md ju lo lp me lr ls lt mf lv lw lx mg lz ma mb ij bi translated">中的配置代码。NET 4.0防止了这种性质的攻击:</p><pre class="kh ki kj kk gt mt mu mv mw aw mx bi"><span id="5336" class="mh kp iq mu b gy my mz l na nb">XmlReaderSettings settings = new XmlReaderSettings();<br/>settings.XmlResolver = null; XmlReader reader =<br/>XmlReader.Create(stream, settings);<br/>PHP uses the default XML parser when processing XML:<br/>libxml_disable_entity_loader(true);</span></pre><p id="a39f" class="pw-post-body-paragraph lg lh iq li b lj mc jr ll lm md ju lo lp me lr ls lt mf lv lw lx mg lz ma mb ij bi translated">在某些情况下，XML外部实体可能是必要的，甚至是不可或缺的，这使得完全禁用它们不是一个可接受的解决方案。在这些情况下，您可以考虑配置或修改XML解析器来实现一个或多个策略:</p><ul class=""><li id="0e3a" class="nc nd iq li b lj mc lm md lp ne lt nf lx ng mb nh ni nj nk bi translated">通过强制超时来防止延迟或涉及大量数据的攻击。</li><li id="401a" class="nc nd iq li b lj nl lm nm lp nn lt no lx np mb nh ni nj nk bi translated">数据检索仅限于某些类型和数量。</li><li id="f278" class="nc nd iq li b lj nl lm nm lp nn lt no lx np mb nh ni nj nk bi translated">您可以阻止XmlResolver从本地计算机检索资源。</li></ul><p id="e89e" class="pw-post-body-paragraph lg lh iq li b lj mc jr ll lm md ju lo lp me lr ls lt mf lv lw lx mg lz ma mb ij bi translated">本地修改的使用提出了一个持续的维护问题，以跟上基础代码的未来版本。此外，修改XML解析器将是复杂的，并且会引入新的安全漏洞。</p><p id="ecd7" class="pw-post-body-paragraph lg lh iq li b lj mc jr ll lm md ju lo lp me lr ls lt mf lv lw lx mg lz ma mb ij bi translated">相比之下，任何没有安全配置的XML解析器在开发时可能都没有考虑到安全问题，除非进行彻底的检查并付出相当大的努力，否则很难保证安全。最好的方法是使用可配置的XML解析器来减轻安全威胁。</p><p id="711a" class="pw-post-body-paragraph lg lh iq li b lj mc jr ll lm md ju lo lp me lr ls lt mf lv lw lx mg lz ma mb ij bi translated">还可以通过检查呈现给XML解析器的XML数据是否有效来要求有效的头，从而防止任意文件被视为XML。因为当文件格式不正确时，XML解析器可能会以未知的方式运行，所以这可能是有用的。</p><h1 id="3f4a" class="ko kp iq bd kq kr ks kt ku kv kw kx ky jw kz jx la jz lb ka lc kc ld kd le lf bi translated">摘要</h1><p id="f8f2" class="pw-post-body-paragraph lg lh iq li b lj lk jr ll lm ln ju lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">当应用程序解析特制的XML输入时，它可能会造成损害。XML炸弹(拒绝服务)和XXE(信息泄露或拒绝服务)都是众所周知的攻击。一种较好的缓解方法是配置XML解析器，禁用或至少安全地限制导致这些问题的XML特性。可能会有配置不充分的情况，可能需要修改XML解析器，但是这是一个风险更大、劳动强度更大的选择。</p></div><div class="ab cl nq nr hu ns" role="separator"><span class="nt bw bk nu nv nw"/><span class="nt bw bk nu nv nw"/><span class="nt bw bk nu nv"/></div><div class="ij ik il im in"><h2 id="e12e" class="mh kp iq bd kq mi mj dn ku mk ml dp ky lp mm mn la lt mo mp lc lx mq mr le ms bi translated">来自Infosec的报道:Infosec每天都有很多内容，很难跟上。<a class="ae kf" href="https://weekly.infosecwriteups.com/" rel="noopener ugc nofollow" target="_blank">加入我们的每周简讯</a>以5篇文章、4条线索、3个视频、2个GitHub Repos和工具以及1个工作提醒的形式免费获取所有最新的Infosec趋势！</h2></div></div>    
</body>
</html>