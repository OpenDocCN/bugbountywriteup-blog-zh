<html>
<head>
<title>IKEEXT DLL Hijacking</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">IKEEXT DLL劫持</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/ikeext-dll-hijacking-3aefe4dde7f5?source=collection_archive---------0-----------------------#2020-04-19">https://infosecwriteups.com/ikeext-dll-hijacking-3aefe4dde7f5?source=collection_archive---------0-----------------------#2020-04-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="4d9e" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">手动利用it服务</h2></div><p id="6171" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我正在写我的<a class="ae lb" href="https://medium.com/@sghosh2402/privilege-escalation-in-windows-380bee3a2842" rel="noopener"> windows权限提升指南</a>，这时我遇到了PowerUp报告的一个潜在的DLL劫持漏洞。在互联网上搜索后，我发现这是由于IKEEXT服务中的一个漏洞。我将丢失的DLL <code class="fe lc ld le lf b">wlbctrl.dll</code>放在<code class="fe lc ld le lf b">C:\Temp</code>中，并尝试重新启动IKEEXT服务，但它确实重新启动了，因为我没有足够的权限。我试着使用这个<a class="ae lb" href="https://github.com/itm4n/Ikeext-Privesc" rel="noopener ugc nofollow" target="_blank">脚本</a>，它成功了。现在我很好奇这个脚本是如何工作的。搜索了一段时间后，我没有找到任何显示如何手动利用这一点的文章，所以我决定就此写一篇文章。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div class="gh gi lg"><img src="../Images/0e3c680e942f594c0c6e2b2c9621c03c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/0*sxO7oYlY_PKQcgSm.png"/></div></figure><h2 id="edd5" class="lo lp iq bd lq lr ls dn lt lu lv dp lw ko lx ly lz ks ma mb mc kw md me mf mg bi translated">背景</h2><p id="22a5" class="pw-post-body-paragraph kf kg iq kh b ki mh jr kk kl mi ju kn ko mj kq kr ks mk ku kv kw ml ky kz la ij bi translated">windows程序在启动时会寻找dll。如果这些DLL不存在，则有可能通过在应用程序寻找的位置放置恶意DLL来提升权限。</p><p id="7108" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">通常，Windows应用程序会使用预定义的搜索路径来查找DLL，并且会以特定的顺序检查这些路径。</p><p id="39d2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">1.应用程序加载的目录<br/> 2。32位系统目录(C:\Windows\System32) <br/> 3。16位系统目录(C:\Windows\System) <br/> 4。Windows目录(C:\Windows) <br/> 5。当前工作目录(CWD) <br/> 6。PATH环境变量中的目录(首先是系统，然后是用户)</p><h2 id="5588" class="lo lp iq bd lq lr ls dn lt lu lv dp lw ko lx ly lz ks ma mb mc kw md me mf mg bi translated">剥削</h2><figure class="lh li lj lk gt ll gh gi paragraph-image"><div class="gh gi mm"><img src="../Images/2f3380ec7acddfc00fda341d5c45ab09.png" data-original-src="https://miro.medium.com/v2/resize:fit:1350/format:webp/1*_BXH1Via6L41eMidTvXRdQ.png"/></div><figcaption class="mn mo gj gh gi mp mq bd b be z dk translated">上电输出</figcaption></figure><p id="2a4e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了验证这个漏洞确实存在，我使用了来自Windows Sysinternals的进程监视器(也称为Procmon)。我启动了procmon，并按照下面的方式配置过滤器，只收集相关的数据。所以基本上我们正在做的是搜索结果为<strong class="kh ir"> NAME NOT FOUND </strong>的进程，文件类型为<strong class="kh ir"> DLL </strong>并且执行进程的用户为<strong class="kh ir"> SYSTEM。</strong></p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div class="gh gi mr"><img src="../Images/58ad94fe054fb89918d1f890c4292a48.png" data-original-src="https://miro.medium.com/v2/resize:fit:1040/format:webp/1*G7Z6XlW7_Y_whDmCQVmhsA.png"/></div></figure><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi ms"><img src="../Images/fb9b512dcae2cea6ddea2afbe5d8a4fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1gdMO7h33iheThwZ8J_Rxg.png"/></div></div></figure><p id="efec" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在我们尝试用管理员权限重启IKEEXT服务，我们可以看到svchost.exe正在尝试寻找<code class="fe lc ld le lf b">wlbctrl.dll</code>。但是为什么是svchost.exe呢？</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi mx"><img src="../Images/0a55debfbbd7252881c02b894658f8cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*BjDTXcC5LAC2UIZj.png"/></div></div><figcaption class="mn mo gj gh gi mp mq bd b be z dk translated">来源:<a class="ae lb" href="https://posts.specterops.io/lateral-movement-scm-and-dll-hijacking-primer-d2f61e8ab992" rel="noopener ugc nofollow" target="_blank">https://posts . specter ops . io/lateral-movement-SCM-and-dll-jacking-primer-d 2f 61 E8 ab 992</a></figcaption></figure><p id="6e24" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以看到svchost.exe启动了IKEEXT服务，然后查询wlbsctrl.dll文件。现在我们已经证实了这个漏洞的存在，我们将利用它。还有一个问题，我们需要系统权限来重启IKEEXT，但是我们只有用户级权限。在浏览了漏洞之后，我发现它正在使用<code class="fe lc ld le lf b">rasdial </code>连接到一个虚拟VPN。这将触发IKEEXT服务启动，从而执行我们的恶意DLL。</p><p id="0e9d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们使用PowerUp编写了一个恶意的DLL，它添加了一个具有管理员权限的后门用户。</p><p id="256d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe lc ld le lf b">Write-HijackDll -DllPath 'C:\Temp\wlbsctrl.dll'</code></p><p id="75ea" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在用以下内容创建一个文件<code class="fe lc ld le lf b">rasphone.pbk</code></p><pre class="lh li lj lk gt my lf mz na aw nb bi"><span id="57fd" class="lo lp iq lf b gy nc nd l ne nf">[IKEEXT]<br/>MEDIA=rastapi<br/>Port=VPN2-0<br/>Device=Wan Miniport (IKEv2)<br/>DEVICE=vpn<br/>PhoneNumber=127.0.0.1</span></pre><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi ng"><img src="../Images/bce7e62a2c1224a25d62435115fb0569.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pLCN26oyPABAq4iv9g7G9Q.png"/></div></div><figcaption class="mn mo gj gh gi mp mq bd b be z dk translated">编写恶意DLL并创建VPN文件。</figcaption></figure><p id="1ed2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们检查我们的特权，并检查管理员组的成员。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi nh"><img src="../Images/746a7135d0a345fd2c7b2882be0ffb5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SJjoAkb5jT1ILFts7ZW2CQ.png"/></div></div><figcaption class="mn mo gj gh gi mp mq bd b be z dk translated">当前用户和管理组成员</figcaption></figure><p id="a371" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用以下命令使用<code class="fe lc ld le lf b">rasdial</code>连接到虚拟VPN。</p><pre class="lh li lj lk gt my lf mz na aw nb bi"><span id="c825" class="lo lp iq lf b gy nc nd l ne nf">rasdial IKEEXT test test /PHONEBOOK:rasphone.pbk</span></pre><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi ni"><img src="../Images/23e85ab0d5fc18ee1ab876f2e5e760bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TOJ7LVDNeiJ59Qw0zXPOvg.png"/></div></div><figcaption class="mn mo gj gh gi mp mq bd b be z dk translated">运行rasdial连接到我们的虚拟VPN</figcaption></figure><p id="4909" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以验证我们的利用是成功的，因为管理员组中有一个john用户。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi nj"><img src="../Images/dd36b8811a8f6728d17f7b3d2f2c5df8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F77YDEl5vhUPxmXCCx8l3w.png"/></div></div><figcaption class="mn mo gj gh gi mp mq bd b be z dk translated">成功开发</figcaption></figure></div></div>    
</body>
</html>