<html>
<head>
<title>BountyCon 2020 CTF — Anti What</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">BountyCon 2020 CTF——反什么</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/bountycon-2020-ctf-anti-what-5961293ab934?source=collection_archive---------1-----------------------#2020-02-15">https://infosecwriteups.com/bountycon-2020-ctf-anti-what-5961293ab934?source=collection_archive---------1-----------------------#2020-02-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="7529" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">嘿大家，这是我第一次写文章。希望对你有用。我想感谢信息安全社区分享他们宝贵的知识，最终帮助我了解CTF和所有其他信息安全的东西。让我们开始吧。</p></div><div class="ab cl kl km hu kn" role="separator"><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq"/></div><div class="ij ik il im in"><p id="350b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">BountyCon是脸书每年在新加坡为亚太地区的BugBounty社区举办的仅限受邀者参加的应用安全会议，BountyCon2020是他们的第二届会议。</p><p id="3f91" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">更多信息请点击<a class="ae ks" href="https://www.facebook.com/whitehat/ctf/bountycon2020/" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir">这里</strong> </a></p><p id="9ebe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">不幸的是，我没有收到邀请，但对于像我这样的新手来说，这仍然是一次很好的学习经历:)</p><p id="3e42" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">二进制反转挑战之一“反什么”是比较容易的一个。挑战说“你说已经连接了调试器是什么意思？这意味着下载二进制文件后，可能会有反调试代码。我很快启动了IDA反汇编器来拆解它。然后我注意到<strong class="jp ir">主</strong>函数有ptrace调用，表示反调试。</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi kt"><img src="../Images/5028aa047324ed6b9799445001a793fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E_Gm6NsbUGJox-psVp3LFg.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">主要功能</figcaption></figure><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi lj"><img src="../Images/5574929596932b8682282714dae379f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oF-4tVcYZ-lXcp2SqOXl6A.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">Strace输出</figcaption></figure><p id="d71e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，当我们试图调试这个二进制文件时，它只是关闭并删除(取消链接)自己。现在我们必须绕过它，最简单的方法是打补丁或修改二进制。<br/>所以我们将从first _ptrace调用到jmp之前的函数<strong class="jp ir"> RC4_set_key <br/> </strong>替换为NOP(无操作)也就是0x90。我将使用HxD编辑器来修改它。</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div class="gh gi lk"><img src="../Images/243ea3f763d04775b23788d053656c99.png" data-original-src="https://miro.medium.com/v2/resize:fit:1274/format:webp/1*moEv-Z8xa8qGGIPCaQRB7g.png"/></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">修补前</figcaption></figure><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div class="gh gi ll"><img src="../Images/b563ae730dec808e7c3ec919fb181815.png" data-original-src="https://miro.medium.com/v2/resize:fit:1326/format:webp/1*jSdGKQM7wbHSLJOEq3bmmw.png"/></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">修补后</figcaption></figure><p id="9902" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们可以毫无问题地调试它，如果我们检查它。它创建了一个很好的NOP幻灯片。</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi lm"><img src="../Images/7d36f4485b0a0b76eb0368ef220dee31.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sP6VAJDJF9RpctoASSngiA.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">带NOP幻灯片的路径二进制文件</figcaption></figure><p id="d3bc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有一个函数<strong class="jp ir"> RC4设置键</strong>以一个全局变量<strong class="jp ir">键</strong>为参数。它是一个字节数组。然后，它从第一个参数开始写入内存位置[rbp+0x110]，看起来像一个c++对象。现在，在函数<strong class="jp ir">之后，RC4 </strong>使用相同的对象指针和全局变量<strong class="jp ir"> ptext </strong>作为参数调用，并将输出写入ptext的位置，因此用解密的文本替换加密的文本。到目前为止，执行流程看起来很正常。</p><p id="591f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后调用<strong class="jp ir"> runPayload </strong>函数，通过查看该函数，我们可以看到它通过mmap syscall周围名为<strong class="jp ir"> rwxmalloc的自定义包装函数将内存位置动态分配到一个堆中。</strong>然后再调用一个函数<strong class="jp ir"> unpackPayload </strong>，将明文<strong class="jp ir"> ptext </strong>的字节与其他位置的字节混在一起，并将结果写入新分配的内存地址。然后它从那个内存地址调用。</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div class="gh gi ln"><img src="../Images/511d6c45ae9f4962adf17f9616c05aa8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1018/format:webp/1*7QAaOgUPSoLpK15rRqR4Ew.png"/></div></figure><p id="d7d3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，很明显，我们必须使用调试器来查看动态分配的内存地址，以找出标志。所以我在二进制上开了gdb。并在函数<strong class="jp ir"> rwxmalloc </strong>后设置第一个断点，在<strong class="jp ir"> unpackPayload </strong>后设置第二个断点。</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi lo"><img src="../Images/aa4588b45bddac65cba74c08f7880d26.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wQAEp5D9N58aBUzFb_WDZA.png"/></div></div></figure><p id="62be" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">不对不对😬，如果发生这种情况，首先在main函数上设置一个断点，然后运行binary。这将在主函数处停止执行，现在我们可以为其他指令设置一个断点。</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi lp"><img src="../Images/8ffcf73625518577661c5462544cb407.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hcczjWtFiXJWs22rFajmZw.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">断点集</figcaption></figure><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div class="gh gi lq"><img src="../Images/79d148b03c8772a3e4b8067c3aaeb038.png" data-original-src="https://miro.medium.com/v2/resize:fit:1354/format:webp/1*Y82s7d0ylNK_5wbGn3kZeQ.png"/></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">rwxmalloc返回的已分配内存地址</figcaption></figure><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div class="gh gi lr"><img src="../Images/3bcb15379d564eb454587f66ca0991cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1314/format:webp/1*ZiJF92Nkpky0Sdimu0QYvQ.png"/></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">未包装的机器说明</figcaption></figure><p id="0c8f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">😮它解包原始机器指令，调用指令将程序计数器传送到那个地址。这些指令执行xor运算来解密数据。因此，我们现在可以在<strong class="jp ir"> ret </strong>指令上快速设置一个断点，并查看返回的地址，我们已经成功地找到了标志😃</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div class="gh gi ls"><img src="../Images/c9dd88ffe661d350e22966b9d2ee5d14.png" data-original-src="https://miro.medium.com/v2/resize:fit:1264/format:webp/1*jbJ0ebzbyELGLKcax684uQ.png"/></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">返回地址显示的标志</figcaption></figure><p id="0027" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我希望你能从中学到一些东西。感谢阅读我的文章！干杯！🍺</p><p id="df49" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<a class="ae ks" href="https://twitter.com/BinXploit" rel="noopener ugc nofollow" target="_blank"> Twitter </a>、<a class="ae ks" href="https://github.com/kp7742/" rel="noopener ugc nofollow" target="_blank"> Github </a>上关注我，或者在<a class="ae ks" href="https://www.linkedin.com/in/kp7742/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>上联系我。</p></div><div class="ab cl kl km hu kn" role="separator"><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq"/></div><div class="ij ik il im in"><p id="3c7c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="lt">关注</em> <a class="ae ks" href="https://medium.com/bugbountywriteup" rel="noopener"> <em class="lt"> Infosec报道</em> </a> <em class="lt">获取更多此类精彩报道。</em></p><div class="lu lv gp gr lw lx"><a href="https://medium.com/bugbountywriteup" rel="noopener follow" target="_blank"><div class="ly ab fo"><div class="lz ab ma cl cj mb"><h2 class="bd ir gy z fp mc fr fs md fu fw ip bi translated">信息安全报道</h2><div class="me l"><h3 class="bd b gy z fp mc fr fs md fu fw dk translated">收集了世界上最好的黑客的文章，主题从bug奖金和CTF到vulnhub…</h3></div><div class="mf l"><p class="bd b dl z fp mc fr fs md fu fw dk translated">medium.com</p></div></div><div class="mg l"><div class="mh l mi mj mk mg ml ld lx"/></div></div></a></div></div></div>    
</body>
</html>