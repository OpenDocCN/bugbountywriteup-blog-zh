<html>
<head>
<title>CTF writeup: PHP object injection in kaspersky CTF</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">CTF报道:卡巴斯基CTF的PHP对象注入</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/ctf-writeup-php-object-injection-in-kaspersky-ctf-28a68805610d?source=collection_archive---------0-----------------------#2018-11-24">https://infosecwriteups.com/ctf-writeup-php-object-injection-in-kaspersky-ctf-28a68805610d?source=collection_archive---------0-----------------------#2018-11-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/07b422ba08cea5968032102fe427ea7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/format:webp/1*SptbDWfD04uXLuJ5IzxBGA.jpeg"/></div></figure><p id="abac" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这是卡巴斯基实验室组织的卡巴斯基工业the PHP对象注入挑战赛的演练。</p><p id="e63a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在这个挑战中，有一个表单根据用户提供的输入执行算术运算。</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi ks"><img src="../Images/b9193382178a76f0cc558bcd8bdc1c0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sJv928_5qqBwHZw9jkahCQ.png"/></div></div></figure><p id="4d71" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们首先执行正常的用例。我分别在第一个和第二个文本框中输入了2和3。</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi lb"><img src="../Images/2ddc188a3e49a9b44e422f4cacdb13e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0kvhpc7J7TCXr0pvfNH4yA.png"/></div></div></figure><p id="efaf" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">正如我们所看到的，我们得到了表达式2 + 3 = 5的结果。</p><p id="c0d3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">简单明了，但有一件事引起了我的注意，那就是“令牌”。让我们试着点击“分享”按钮。</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi lc"><img src="../Images/ffb7913bd1c9f822043e868297d81409.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yX4deFGrB26dISkjvpMLmg.png"/></div></div></figure><p id="15c6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">它发出一个带有“token”参数的GET请求。让我们看看回应。</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi ld"><img src="../Images/199ff6c433b15568015ff6923561244e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TR1EvSIC2dM_HpqEs5bJIw.png"/></div></div></figure><p id="904a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">它与我们之前计算的2 + 3 = 5有相同的表达式。</p><p id="f147" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在将令牌解码为<strong class="jw ir"> base64 </strong>之后，我得到了一个序列化的PHP对象。</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi le"><img src="../Images/4784cd64fb9a36693848644166089c2f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UBMVQEP4Ij9rztZD0dMaww.png"/></div></div></figure><p id="d5f2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">正如我们看到的，我们有一个SUM函数，参数(数组)是2和3。现在网上有很多关于PHP对象注入的内容。我几乎都看完了。尽管你可以看着它。</p><div class="lf lg gp gr lh li"><a href="https://www.owasp.org/index.php/PHP_Object_Injection" rel="noopener  ugc nofollow" target="_blank"><div class="lj ab fo"><div class="lk ab ll cl cj lm"><h2 class="bd ir gy z fp ln fr fs lo fu fw ip bi translated">PHP对象注入</h2><div class="lp l"><h3 class="bd b gy z fp ln fr fs lo fu fw dk translated">PHP对象注入是一个应用程序级别的漏洞，可能允许攻击者执行不同种类的…</h3></div><div class="lq l"><p class="bd b dl z fp ln fr fs lo fu fw dk translated">www.owasp.org</p></div></div></div></a></div><div class="lf lg gp gr lh li"><a href="https://mukarramkhalid.com/php-object-injection-serialization/" rel="noopener  ugc nofollow" target="_blank"><div class="lj ab fo"><div class="lk ab ll cl cj lm"><h2 class="bd ir gy z fp ln fr fs lo fu fw ip bi translated">PHP对象注入和序列化漏洞- Mukarram Khalid</h2><div class="lp l"><h3 class="bd b gy z fp ln fr fs lo fu fw dk translated">PHP对象注入和序列化漏洞PHP对象注入漏洞很难被利用…</h3></div><div class="lq l"><p class="bd b dl z fp ln fr fs lo fu fw dk translated">mukarramkhalid.com</p></div></div><div class="lr l"><div class="ls l lt lu lv lr lw js li"/></div></div></a></div><div class="lf lg gp gr lh li"><a href="https://securitycafe.ro/2015/01/05/understanding-php-object-injection/" rel="noopener  ugc nofollow" target="_blank"><div class="lj ab fo"><div class="lk ab ll cl cj lm"><h2 class="bd ir gy z fp ln fr fs lo fu fw ip bi translated">理解PHP对象注入</h2><div class="lp l"><h3 class="bd b gy z fp ln fr fs lo fu fw dk translated">PHP对象注入不是一个很常见的漏洞，它可能很难被利用，但也可能真的…</h3></div><div class="lq l"><p class="bd b dl z fp ln fr fs lo fu fw dk translated">安全咖啡. ro</p></div></div><div class="lr l"><div class="lx l lt lu lv lr lw js li"/></div></div></a></div><p id="4103" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在我做了很多尝试和错误，为了这篇文章的长度，我没有把它们都放在这里。</p><p id="8c35" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们看看我们的序列化对象</p><p id="696e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">o:10:“Expression”:3:{ s:14:“Expression op”；<strong class="jw ir"> s:3:《和》</strong>；s:18:“expression params”；答:2:<strong class="jw ir">{ I:0；d:2；I:1；d:3；} </strong> s:9:“纤弱”；s:5:“2+3”；}</p><p id="407a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">您可以玩这个序列化的对象，看看它的行为。</p><p id="44c0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我怀疑<strong class="jw ir">“sum”</strong>是一个用户定义的函数，而<strong class="jw ir">“expression params”</strong>是一个数组，其第一个值为<strong class="jw ir"> 2 </strong>，第二个值为<strong class="jw ir"> 3 </strong>。</p><p id="9aed" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">你可以调用任何PHP函数来代替<strong class="jw ir"> sum </strong>函数。</p><p id="8fac" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我把<strong class="jw ir"> sum </strong>函数改成了<a class="ae ly" href="http://php.net/manual/en/function.system.php" rel="noopener ugc nofollow" target="_blank"> <strong class="jw ir"> system() </strong> </a>这是一个PHP函数，执行给定的<code class="fe lz ma mb mc b"><strong class="jw ir">command</strong></code>并输出结果。</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi md"><img src="../Images/bba6ccf50d83181be69709580f8829f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*32dPTdqJL5rYsCnGK6baYg.png"/></div></div></figure><p id="7ee5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">o:10:“Expression”:3:{ s:14:“Expression op”；<strong class="jw ir"> s:6:《系统》</strong>；s:18:“expression params”；a:2:{ I:0；d:2；I:1；d:3；} s:9:“stringify”；s:5:“2+3”；}</p><p id="9152" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">请记住，我们需要将字符串的长度从<strong class="jw ir"> 3 </strong>更新为<strong class="jw ir"> 6 </strong>。因为我们函数名的长度是<strong class="jw ir"> 6 </strong> ( <strong class="jw ir">系统</strong>)。</p><p id="d36b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">学生3:“总和”</p><p id="e7d6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">学生6:“系统”</p><p id="4935" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">然后用BASE64再次编码</strong></p><p id="f0de" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们用新的有效载荷发送请求。</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi me"><img src="../Images/6101d5aa241d80dc063d00032cb45995.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WfnLji39gKXjuXmGteLoPw.png"/></div></div></figure><p id="3732" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">酷！！我们是对的，我们可以在这个序列化的对象中传递任何PHP函数，唯一剩下的就是以正确的格式给出参数。sum有数组作为参数，我们需要string作为我们的<strong class="jw ir">系统</strong>函数的参数。</p><p id="56d3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我替换了<strong class="jw ir">a:2:{ I:0；d:2；I:1；d:3；} </strong>(数组)</p><p id="8ae0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">随着</p><p id="88d6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir"> s:2:"ls" </strong>(字符串)</p><p id="df4b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们试着运行<strong class="jw ir"> LS </strong>命令。</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi mf"><img src="../Images/08959dfb588204424b2e1eb56cacd5ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9ceLiLy_r3p07wGqC_vjpQ.png"/></div></div></figure><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi mg"><img src="../Images/9738c99f507b024b0bd3dd7dc143efa7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iDecNpZI7DeuzQ3qzUuLzw.png"/></div></div></figure><p id="2f3b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">答对了。！</p><p id="7391" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们面前的最后一项任务是找到旗子，这并不太难。</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi mh"><img src="../Images/e4dee5d95bbb8ee85c3fbd17879952d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bfyj_H1SB-04ORELQVM0Wg.png"/></div></div></figure><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi mi"><img src="../Images/8b29203bdfdc75d75eddde90108049a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B93Sg_wdhFZS6nsrAes_oA.png"/></div></div></figure><p id="fb35" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们打开<strong class="jw ir"> fl4g_h4r3 </strong>文件。</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi mj"><img src="../Images/bdfba4fa8c086bb71bf5fcfc9647cbed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JARkDr16vB1puCAad_28nw.png"/></div></div></figure><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi mk"><img src="../Images/5fafeef4b4bf01c202d606702e752c71.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aHoJWdyO6CtsZNFv1dDcDQ.png"/></div></div></figure><p id="dc4b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">最后我们拿到了旗子。感谢阅读。</p><p id="df1a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">#分享伤疤</p><p id="d1ed" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们在推特上连线</p></div></div>    
</body>
</html>