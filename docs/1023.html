<html>
<head>
<title>Intigriti’s December XSS Challenge 2020 (unintended solution)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Intigriti的12月XSS挑战2020(非预期解决方案)</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/intigritis-december-xss-challenge-2020-unintended-solution-8205b4a4b95b?source=collection_archive---------1-----------------------#2020-12-13">https://infosecwriteups.com/intigritis-december-xss-challenge-2020-unintended-solution-8205b4a4b95b?source=collection_archive---------1-----------------------#2020-12-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="bccf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">和往常一样，我从阅读规则开始。目标是在<a class="ae kp" href="https://challenge-1220.intigriti.io/" rel="noopener ugc nofollow" target="_blank">challenge-1220 . intigriti . io</a>域上执行<code class="fe kl km kn ko b">alert(document.domain)</code>。Self XSS和MiTM攻击不在范围内，该解决方案应该可以在最新版本的Firefox和Chrome上运行。</p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div class="gh gi kq"><img src="../Images/dd0b6287de38b79f06497ad63d366d09.png" data-original-src="https://miro.medium.com/v2/resize:fit:1046/format:webp/1*ZQSmdOxlYbcOGIl-15poyA.png"/></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">挑战页面</figcaption></figure><p id="991f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我做的第一件事是像使用计算器一样使用它，看看它对我的输入有什么反应。看起来第一个数字、运算符和计算的第二个数字被设置为URL中的参数。看起来我们应该在这些参数中注入一个有效载荷，所以我开始查看JavaScript，看看它是如何处理这些参数的。</p><p id="22cd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">作为解决方案一部分的代码有三个功能。<code class="fe kl km kn ko b">init()</code>、<code class="fe kl km kn ko b">calc(num1="", num2="", operator="")</code>和<code class="fe kl km kn ko b">getQueryVariable(variable)</code>。</p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="gh gi lc"><img src="../Images/79f156548946d4729f11a4617228626c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eJrigThDW3LnXc488K0omA.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">挑战代码</figcaption></figure><p id="f904" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">init函数尝试执行calc，并给它三个参数，这些参数是从getQueryVariable中检索的。Calc将对参数进行一些检查，如果它们有效，它将执行eval来计算操作。</p><p id="3a5b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">GetQueryVariable，取第一个问号之后的URL部分。它在' &amp; '上拆分这个字符串，然后再在' = '上拆分，以检索每个参数及其值。如果参数名等于变量实参，则此参数的值将放在value变量中。迭代完参数后，返回value变量。这意味着在重复的情况下，将返回最后一个参数。</p><p id="8ece" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我在这段代码中注意到的第一件事是第17行的<code class="fe kl km kn ko b">eval(operation)</code>。我知道这个功能容易受到XSS的攻击，Mozilla页面<a class="ae kp" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/eval" rel="noopener ugc nofollow" target="_blank">在页面顶部警告了这一点。</a></p></div><div class="ab cl lh li hu lj" role="separator"><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm"/></div><div class="ij ik il im in"><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="gh gi lo"><img src="../Images/f50e2955453511ed778c2e80ac4bd282.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6Q9JnaEPRxNPGCnzI-2yUg.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">Mozilla警告</figcaption></figure><p id="14f6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我的想法是在操作变量中编译一个有效载荷，这样它就可以被eval函数执行。然而，这看起来并不容易。有效载荷必须由三部分组成，<code class="fe kl km kn ko b">num1</code>、<code class="fe kl km kn ko b">num2</code>和<code class="fe kl km kn ko b">operator</code>。Num1只能包含数字和字母(小写和大写)以及'-'。Num2也可以只包含数字和字母，但不能包含'-'。我觉得这很可疑。为什么num1上的正则表达式不同于num2上的正则表达式？这是不是开发者的错别字(<a class="ae kp" href="https://twitter.com/securinti" rel="noopener ugc nofollow" target="_blank"> @securinti在twitter上</a>)？我在num1中找不到任何可能使用'-'的有效负载。所以我开始看剩下的代码。</p><p id="70e9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运算符必须在常量数组运算符中。这里我注意到运算符包含' = '，但是计算器没有这个按钮。由此，我得出结论，我必须将操作符设置为' = '(在URL中，您必须用' %3D '来指定它，否则<code class="fe kl km kn ko b">getQueryVariable()</code>将在' = '字符上拆分，并且字符本身不会被传递给calc函数。最后，操作的长度不能超过20个字符。</p><p id="e80a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">那么我们能给<code class="fe kl km kn ko b">eval()</code>什么样的有效载荷呢？我们可以分配变量！我尝试了以下搜索查询</p><pre class="kr ks kt ku gt lp ko lq lr aw ls bi"><span id="4e4d" class="lt lu iq ko b gy lv lw l lx ly">?num1=a&amp;operator=%3D&amp;num2=123</span></pre><p id="53dd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了检查它是否工作，我来到控制台，键入<code class="fe kl km kn ko b">a</code>来查看变量的内容，确实，它工作了。</p><p id="2c90" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们如何利用这些知识来执行警报？在JavaScript中，可以覆盖函数。例如，如果我们有函数a</p><pre class="kr ks kt ku gt lp ko lq lr aw ls bi"><span id="59c4" class="lt lu iq ko b gy lv lw l lx ly">function a() {<br/>    console.log("a");<br/>}</span></pre><p id="7c7b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">和功能b</p><pre class="kr ks kt ku gt lp ko lq lr aw ls bi"><span id="6798" class="lt lu iq ko b gy lv lw l lx ly">function b {<br/>    console.log("b");<br/>}</span></pre><p id="adfa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，如果我们执行<code class="fe kl km kn ko b">a()</code>，我们将在控制台中看到“a”，如果我们执行<code class="fe kl km kn ko b">b()</code>，我们将看到“b”。</p><p id="d5ef" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果我们现在执行下面的<code class="fe kl km kn ko b">a=b</code>，然后我们执行<code class="fe kl km kn ko b">a()</code>，这一次我们将在控制台中看到“b”。这是因为我们告诉网页将函数a设置为等于函数b，所以现在如果我们执行函数a，函数b的代码就会被执行。所以现在如果我们尝试下面的搜索查询</p><pre class="kr ks kt ku gt lp ko lq lr aw ls bi"><span id="60f1" class="lt lu iq ko b gy lv lw l lx ly">?num1=eval&amp;operator=%3D&amp;num2=alert</span></pre><p id="f0d0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们按下计算器上的一个按钮后，会弹出一个警报。这是因为我们告诉网页应该将eval设置为alert，现在调用的不是原来的eval函数，而是alert函数。此时，我们可以弹出一个警报，但是我们不能将document.domain传递给警报，因为之前在操作中已经进行了检查。这意味着我们必须寻找另一个函数来覆盖。我认为calc函数是理想的，因为这是挑战中唯一的另一个函数，我们可以操纵传递哪些参数。我没有用alert来覆盖这个函数，而是用eval来覆盖这个函数，因为参数将是一个字符串，而<code class="fe kl km kn ko b">alert(“document.domain")</code>在alert中只会说‘document . domain ’,而不是所需的域。所以现在我们有了下面的搜索查询，但是我们仍然需要找到一种方法将我们的代码传递给被覆盖的函数。</p><pre class="kr ks kt ku gt lp ko lq lr aw ls bi"><span id="8666" class="lt lu iq ko b gy lv lw l lx ly">?num1=calc&amp;operator=%3D&amp;num2=eval</span></pre><p id="8f11" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我在这一部分被卡住了一段时间，但twitter上给出的一个提示说' hashoo '，并附有以下GIF。</p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div class="gh gi lz"><img src="../Images/1230a7480a7af99c2b16d726069d960a.png" data-original-src="https://miro.medium.com/v2/resize:fit:440/1*EdfKiYjMPc7b4J7WGUm-dA.gif"/></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">来自Intigriti tip的GIF</figcaption></figure><p id="2edb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从这篇技巧中，我得出结论，我应该使用URL散列(#)。在尝试了许多不同的东西之后，我注意到我可以在“？”之前添加一些文本并且在URL中的“/”之后。文本必须以' # '开头，这样浏览器就不会将文本视为文件名，而是散列值。我现在得到的网址是:</p><pre class="kr ks kt ku gt lp ko lq lr aw ls bi"><span id="b0ec" class="lt lu iq ko b gy lv lw l lx ly"><a class="ae kp" href="https://challenge-1220.intigriti.io/#sometext?num1=calc&amp;operator=%3D&amp;num2=eval" rel="noopener ugc nofollow" target="_blank">https://challenge-1220.intigriti.io/#sometext?num1=calc&amp;operator=%3D&amp;num2=eval</a></span></pre><p id="e745" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是变得棘手的部分。老实说，我不明白为什么浏览器会有下面提到的一些行为，但是我很确定它会被利用。</p><p id="b58a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">转到这个链接后，按下一个数字或操作按钮(不是清除按钮)，我注意到<code class="fe kl km kn ko b">#sometext?</code>被添加到num2或操作参数中，这取决于您按下了哪个按钮。</p><pre class="kr ks kt ku gt lp ko lq lr aw ls bi"><span id="e1e4" class="lt lu iq ko b gy lv lw l lx ly"><a class="ae kp" href="https://challenge-1220.intigriti.io/?num2=NaN#sometext?num1=calc&amp;operator=%3D&amp;num2=eval" rel="noopener ugc nofollow" target="_blank">https://challenge-1220.intigriti.io/?num2=NaN#sometext?num1=calc&amp;operator=%3D&amp;num2=eval</a></span></pre><p id="08db" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">num1参数这次被否定了，因为在<code class="fe kl km kn ko b">?num1</code>前又加了一个问号。所以现在JavaScript没有把它当作<code class="fe kl km kn ko b">num1</code>，而是当作<code class="fe kl km kn ko b">?num1</code>，因为getQueryVariable只否定了URL中的第一个问号。现在我们不再检查calc中的num1变量，我们有一种方法使第一个num1无效。剩下唯一要做的就是添加一个新的有效num1，这样我们的eval(以前是calc)就会执行它。</p><p id="f413" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">注意:我们必须使用num1，因为如果我们向eval函数传递多个参数，那么只有第一个参数会被执行(在我们的例子中是num1)。</p><p id="ea5f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">添加这个新的有效num1的方法是将它作为我们之前的散列来添加。警报过后，我又加了一句'；//'所以JS会处理num1('？num1=calc ')作为注释。最终的网址是:</p><pre class="kr ks kt ku gt lp ko lq lr aw ls bi"><span id="9417" class="lt lu iq ko b gy lv lw l lx ly"><a class="ae kp" href="https://challenge-1220.intigriti.io/#&amp;num1=alert(document.domain);//?num1=calc&amp;operator=%3D&amp;num2=eval" rel="noopener ugc nofollow" target="_blank">https://challenge-1220.intigriti.io/#&amp;num1=alert(document.domain);//?num1=calc&amp;operator=%3D&amp;num2=eval</a> </span></pre><p id="44ee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，当我们按下计算器上的一个数字时，<code class="fe kl km kn ko b">alert(document.domain)</code>被执行，URL如下所示:</p><pre class="kr ks kt ku gt lp ko lq lr aw ls bi"><span id="c9e8" class="lt lu iq ko b gy lv lw l lx ly"><a class="ae kp" href="https://challenge-1220.intigriti.io/?num2=NaN#&amp;num1=alert(document.domain);//?num1=calc&amp;operator=%3D&amp;num2=eval" rel="noopener ugc nofollow" target="_blank">https://challenge-1220.intigriti.io/?num2=NaN#&amp;num1=alert(document.domain);//?num1=calc&amp;operator=%3D&amp;num2=eval</a></span></pre><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div class="gh gi mb"><img src="../Images/3660a5b73b42989f52294c04c6cd4a35.png" data-original-src="https://miro.medium.com/v2/resize:fit:1238/format:webp/1*t9D6z3O7pYrs1hDBsQoRUQ.png"/></div></figure><p id="0bdc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是我(无意中)解决挑战的方法，我很好奇想知道这种方法是什么！</p><p id="1352" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您有任何问题，请随时联系我，我会尽可能回答您的问题。</p></div></div>    
</body>
</html>