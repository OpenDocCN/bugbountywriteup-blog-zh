<html>
<head>
<title>Sandboxing python modules in your code</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在代码中沙盒化python模块</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/sandboxing-python-modules-in-your-code-1e590d71fc26?source=collection_archive---------1-----------------------#2022-07-10">https://infosecwriteups.com/sandboxing-python-modules-in-your-code-1e590d71fc26?source=collection_archive---------1-----------------------#2022-07-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="d601" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行来自不可信来源的代码仍然是一个未解决的问题。<br/> 尤其是像Python和Javascript这样的动态语言。<br/>我将从两个未回答的问题开始；</p><blockquote class="kl km kn"><p id="16e0" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated">如果为http 导入<strong class="jp ir"> <em class="iq">请求</em> </strong> <em class="iq">，为什么<em class="iq">请求</em>要能打开一个<strong class="jp ir">终端</strong>并切换到<strong class="jp ir"> sudo </strong>？</em></p><p id="e3f8" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated">如果导入<strong class="jp ir"> <em class="iq">日志</em> </strong>，为什么只要<strong class="jp ir">把</strong>文件写到<strong class="jp ir">特定目录</strong>就可以<strong class="jp ir">网络</strong>(或者像Log4Shell里的LDAP)？</p></blockquote><p id="429f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是我如何为python导入编写沙箱的故事:<br/>创建一个生产就绪的解决方案，并针对不同的用例进行测试。</p><h2 id="e2eb" class="ks kt iq bd ku kv kw dn kx ky kz dp la jy lb lc ld kc le lf lg kg lh li lj lk bi translated"><em class="ll">TL；博士</em></h2><p id="a746" class="pw-post-body-paragraph jn jo iq jp b jq lm js jt ju ln jw jx jy lo ka kb kc lp ke kf kg lq ki kj kk ij bi translated"><em class="ko">解决方案如下。底部GitHub链接。<br/> </em>如何在你的第三方包中利用<strong class="jp ir">泡菜</strong>？</p><pre class="lr ls lt lu gt lv lw lx ly aw lz bi"><span id="2ba2" class="ks kt iq lw b gy ma mb l mc md">&gt;&gt;&gt; import pickle<br/>&gt;&gt;&gt; class Demo:<br/>...     def __reduce__(self):<br/>...         return (eval, ("__import__('os').system('echo Exploited!')",))<br/>... <br/>&gt;&gt;&gt; pickle.dumps(Demo())<br/>b"\x80\x04\x95F\x00\x00\x00\x00\x00\x00\x00\x8c\x08builtins\x94\x8c\x04eval\x94\x93\x94\x8c*__import__('os').system('echo Exploited!')\x94\x85\x94R\x94."<br/>&gt;&gt;&gt; pickle.loads(b"\x80\x04\x95F\x00\x00\x00\x00\x00\x00\x00\x8c\x08builtins\x94\x8c\x04eval\x94\x93\x94\x8c*__import__('os').system('echo Exploited!')\x94\x85\x94R\x94.")</span><span id="a12a" class="ks kt iq lw b gy me mb l mc md">Exploited!<br/>0</span></pre><p id="d0bc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有了<code class="fe mf mg mh lw b">secimport</code>，你可以控制这样的动作做任何你想做的事情:</p><pre class="lr ls lt lu gt lv lw lx ly aw lz bi"><span id="ec94" class="ks kt iq lw b gy ma mb l mc md">In [1]: import secimport<br/>In [2]: pickle = secimport.secure_import("pickle")<br/>In [3]: pickle.loads(b"\x80\x04\x95F\x00\x00\x00\x00\x00\x00\x00\x8c\x08builtins\x94\x8c\x04eval\x94\x93\x94\x8c*__import__('os').system('echo Exploited!')\x94\x85\x94R\x94.")</span><span id="6609" class="ks kt iq lw b gy me mb l mc md">[1]    28027 killed     ipython</span></pre></div><div class="ab cl mi mj hu mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="ij ik il im in"><figure class="lr ls lt lu gt mq gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi mp"><img src="../Images/7a075419cf4c06ed39682986a07d2e06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*z5WhJb6Czavh9iIQOEX3GQ.png"/></div></div><figcaption class="mx my gj gh gi mz na bd b be z dk translated">闵达莱为“secimport”创作的一些AI艺术作品。底部GitHub链接。</figcaption></figure><p id="fe3d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">向我们的代码中添加一个新的库可能具有挑战性，原因有几个:</p><ul class=""><li id="433f" class="nb nc iq jp b jq jr ju jv jy nd kc ne kg nf kk ng nh ni nj bi translated">开发人员无法确切地知道对一个包的期望。你导入它，但是在你不知道的情况下，它可以在你的环境中为所欲为。</li><li id="ce19" class="nb nc iq jp b jq nk ju nl jy nm kc nn kg no kk ng nh ni nj bi translated">对于您的用例来说，很难说运行这个库的最低要求是什么。</li><li id="bb2b" class="nb nc iq jp b jq nk ju nl jy nm kc nn kg no kk ng nh ni nj bi translated">一个人应该允许的系统调用集是什么，这样它才能正常工作，仅此而已？</li></ul><p id="accf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们信任开源社区。然而我们使用的包的维护者是个人。没有用<strong class="jp ir"> <em class="ko"> == </em> </strong> <em class="ko">锁定版本会有很大的风险；</em>我们的包会在您的CI中静默更新，新代码会在我们不知道的情况下在这些包中运行。</p><p id="5a41" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae np" href="https://www.bleepingcomputer.com/news/security/malicious-pypi-package-opens-backdoors-on-windows-linux-and-macs/" rel="noopener ugc nofollow" target="_blank">每天都有人匿名上传恶意车轮到PyPI </a>。<br/>有时候是你已经在用的包。</p><p id="a958" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一天早上，一个拿着全球通用pip包的人醒来后憎恨俄罗斯。为了抗议，<a class="ae np" href="https://www.bleepingcomputer.com/news/security/big-sabotage-famous-npm-package-deletes-files-to-protest-ukraine-war/" rel="noopener ugc nofollow" target="_blank">他在安装python包时删除了俄国和白俄罗斯安装程序的硬盘，方法是检查IP并在导入时运行</a> <strong class="jp ir"> <em class="ko"> os.system </em> </strong>(或类似的东西)。历史会重演，所以再次发生只是时间问题……这太容易了。</p><blockquote class="kl km kn"><p id="17c3" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated">更不用说，在添加一个新的开源软件时，你不能检查整个代码(但是谷歌和苹果可以)。</p></blockquote></div><div class="ab cl mi mj hu mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="ij ik il im in"><h1 id="c09b" class="nq kt iq bd ku nr ns nt kx nu nv nw la nx ny nz ld oa ob oc lg od oe of lj og bi translated">当今的解决方案大多是带外的，并且是基于进程的。</h1><p id="3fc7" class="pw-post-body-paragraph jn jo iq jp b jq lm js jt ju ln jw jx jy lo ka kb kc lp ke kf kg lq ki kj kk ij bi translated">如果一个给定的模块包含漏洞、恶意逻辑或一个很小任务的大代码库，我们必须以某种方式限制它。<br/><strong class="jp ir">主机(计算机)应该不会被你的应用程序或其第三方应用程序触及</strong>。</p><p id="a5c3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">那么我今天能做什么呢？</p><ol class=""><li id="8324" class="nb nc iq jp b jq jr ju jv jy nd kc ne kg nf kk oh nh ni nj bi translated">为整个应用程序创建一个<a class="ae np" href="https://en.wikipedia.org/wiki/Seccomp" rel="noopener ugc nofollow" target="_blank"> sec-comp </a> (Linux安全计算)概要文件。如果你的程序以一种意想不到的方式运行，无论是由于第三方库还是你自己的代码，它将被记录或者进程将被立即终止。RedHad，SE-Linux，SECCOMP，所有这些伟大的东西。</li><li id="101c" class="nb nc iq jp b jq nk ju nl jy nm kc nn kg no kk oh nh ni nj bi translated">CI/CD或IDE中的静态代码分析/安全扫描器。你寻找过时的包或者你分析代码。<br/>如:<a class="ae np" href="https://snyk.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir"> Snyk </strong> </a> <strong class="jp ir">，</strong><a class="ae np" href="https://checkmarx.com/" rel="noopener ugc nofollow" target="_blank"><strong class="jp ir">check Marx</strong></a><strong class="jp ir">，</strong><a class="ae np" href="https://github.com/quay/clair" rel="noopener ugc nofollow" target="_blank"><strong class="jp ir">Clair</strong></a><strong class="jp ir">。</strong></li><li id="c50d" class="nb nc iq jp b jq nk ju nl jy nm kc nn kg no kk oh nh ni nj bi translated">根本不在代码库中使用开源或第三方软件。那在规模上是不可行的…但是我知道一些小的创业公司根本不在他们的代码中使用开源。这是硬核——想象一下从头开始实现任何逻辑。</li><li id="976b" class="nb nc iq jp b jq nk ju nl jy nm kc nn kg no kk oh nh ni nj bi translated"><a class="ae np" href="https://wasi.dev/" rel="noopener ugc nofollow" target="_blank"> WASI </a>沙盒化— <strong class="jp ir"> WebAssembly太棒了！</strong> <br/>但是，不像Rust/Go/。Net，Python不编译成WebAssembly，所以这个解决方案目前与我们无关<a class="ae np" href="https://github.com/RustPython/RustPython" rel="noopener ugc nofollow" target="_blank"> (rust-python有人吗？).</a></li><li id="08e5" class="nb nc iq jp b jq nk ju nl jy nm kc nn kg no kk oh nh ni nj bi translated">在虚拟机或虚拟机管理程序(不同于容器)中运行软件。<br/> <a class="ae np" href="http://research.google.com" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir"> Google </strong> </a>开发了一款针对容器的沙盒，名为<a class="ae np" href="https://gvisor.dev/docs/" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir"> <em class="ko"> gVisor </em> </strong> </a>。gVisor 是一种VM，它翻译应用程序中的每个系统调用。<br/>为了这个项目，<strong class="jp ir"> Google从零开始实现了</strong><a class="ae np" href="https://www.linux.org/" rel="noopener ugc nofollow" target="_blank"><strong class="jp ir">Linux</strong></a><strong class="jp ir"/>，在Go。<br/>沙盒二进制文件(运行容器)大约17MB。 <br/>每个系统调用都被翻译成<a class="ae np" href="https://gvisor.dev/docs/" rel="noopener ugc nofollow" target="_blank"> gVisor </a>然后再翻译成主机，同时执行高级策略。印象深刻，对吧？</li></ol><figure class="lr ls lt lu gt mq gh gi paragraph-image"><div class="gh gi oi"><img src="../Images/7ee22454b790f0268225fae340a8a443.png" data-original-src="https://miro.medium.com/v2/resize:fit:980/format:webp/0*Ejr5ylVg3LD59yJ1.png"/></div></figure><p id="057b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然而，在虚拟机中运行应用程序通常会导致性能下降。我亲身体验过(很棒的)沙盒，它使应用程序的速度降低了50%。</p><p id="1fc9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae np" href="https://cloud.google.com/appengine/docs/standard/runtimes" rel="noopener ugc nofollow" target="_blank">谷歌使用gVisor来隔离谷歌应用引擎中的容器。</a></p><p id="6556" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">就像Google一样，我认为开源包将永远是您的应用程序的攻击面。但这并不意味着你应该改变你的编码方式。每个模块都应该有自己的限制，由开发人员定义或从某个模板中选择。</p></div><div class="ab cl mi mj hu mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="ij ik il im in"><h1 id="6c70" class="nq kt iq bd ku nr ns nt kx nu nv nw la nx ny nz ld oa ob oc lg od oe of lj og bi translated">如何在我们的python流程中约束模块</h1><p id="1042" class="pw-post-body-paragraph jn jo iq jp b jq lm js jt ju ln jw jx jy lo ka kb kc lp ke kf kg lq ki kj kk ij bi translated">我希望开发人员能够在导入/编译时，将代码中的任何包限制在给定的范围内，而不是为应用程序提供一个统一的概要文件。<br/>就像<a class="ae np" href="https://www.redhat.com/en/topics/linux/what-is-selinux#:~:text=Security%2DEnhanced%20Linux%20(SELinux),Linux%20Security%20Modules%20(LSM)." rel="noopener ugc nofollow" target="_blank"> SELinux </a>在执行时为Linux内核中的进程授予白名单范围一样，我希望开发人员能够在特定的约束下，在他们的代码中控制任何包<strong class="jp ir">。</strong></p><figure class="lr ls lt lu gt mq gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi oj"><img src="../Images/83112f1c6f9b60e1daa8e0e836a4c36e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*HSd5JQwCEU6pXHsX.png"/></div></div><figcaption class="mx my gj gh gi mz na bd b be z dk translated">log 4壳人？为什么Log4J应该可以默认打开LDAP连接？</figcaption></figure><h1 id="7f8d" class="nq kt iq bd ku nr ok nt kx nu ol nw la nx om nz ld oa on oc lg od oo of lj og bi translated">限制Python模块— MVP</h1><p id="e026" class="pw-post-body-paragraph jn jo iq jp b jq lm js jt ju ln jw jx jy lo ka kb kc lp ke kf kg lq ki kj kk ij bi translated">我想要一个可以记录每个python调用和每个syscall的工具。我假设我们和内核之间没有恶意会影响可见性。<br/>听起来很难，保持性能不变听起来更难。<br/>这种级别的跟踪/沙箱通常会影响运行时性能。</p><p id="0025" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">可以使用以下技术来实现这种工具:</p><ul class=""><li id="8d39" class="nb nc iq jp b jq jr ju jv jy nd kc ne kg nf kk ng nh ni nj bi translated">eBPF</li><li id="9637" class="nb nc iq jp b jq nk ju nl jy nm kc nn kg no kk ng nh ni nj bi translated"><strong class="jp ir"> DTrace </strong></li><li id="cc94" class="nb nc iq jp b jq nk ju nl jy nm kc nn kg no kk ng nh ni nj bi translated">任何其他的。*跟踪工具。</li></ul><blockquote class="kl km kn"><p id="d769" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated">我知道eBPF现在很常见，但是我们需要一些跨平台的东西，能够更快的学习曲线和更容易的动手评估设置，让时间更有价值。</p><p id="9963" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated">我们不能假设每个python开发者都知道eBPF的C语言。我假设在MVP之后很容易用eBPF代替(<strong class="jp ir"> eBPF也叫“DTrace 2.0”</strong>)。</p></blockquote><figure class="lr ls lt lu gt mq gh gi paragraph-image"><div class="gh gi op"><img src="../Images/7db1fc7f3cfd5a81a38dc59b208bfc1a.png" data-original-src="https://miro.medium.com/v2/resize:fit:934/format:webp/0*RXTIx1VYfE1JDmik.png"/></div><figcaption class="mx my gj gh gi mz na bd b be z dk translated">DTrace堆栈概述</figcaption></figure><p id="628a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在阅读了足够多的<a class="ae np" href="https://www.brendangregg.com/blog/index.html" rel="noopener ugc nofollow" target="_blank">博客</a>并尝试了不同的工具后，<br/>我明白了<a class="ae np" href="https://www.oracle.com/solaris/technologies/dtrace-tutorial.html#:~:text=DTrace%2C%20or%20Dynamic%20Tracing%2C%20is,DTrace%20to%20analyze%20several%20applications." rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir"> dtrace </strong> </a>是这个用例的正确起点。在我看来，与eBPF不同，dtrace不需要以某种方式编译内核(不是每个Linux都内置的)。<br/> <strong class="jp ir"> dtrace </strong>可以在Mac和Windows上工作，为更多用户提供任何基于dtrace的解决方案。<br/> <strong class="jp ir"> dtrace </strong>也是<a class="ae np" href="https://docs.oracle.com/cd/E19253-01/817-6223/chp-actsub-4/index.html" rel="noopener ugc nofollow" target="_blank">破坏性的</a>，这意味着它可以从监控python进程的<a class="ae np" href="https://docs.oracle.com/cd/E18752_01/html/819-5488/gcfqr.html" rel="noopener ugc nofollow" target="_blank"> dscript探测器</a>中杀死一个进程。这正是我想要的。</p><p id="c9e3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">看下图；代替<strong class="jp ir">容器</strong>的是python <strong class="jp ir">模块</strong>，代替<strong class="jp ir"> SELinux </strong>的是<strong class="jp ir"> dtrace </strong>，探测内核。</p><figure class="lr ls lt lu gt mq gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi oq"><img src="../Images/f20c8e368b76e7ed4a129dafcf84b0be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1288/format:webp/0*hTeYgvugpXgB3F8X.png"/></div></div><figcaption class="mx my gj gh gi mz na bd b be z dk translated">我们用python模块代替了容器，用dtrace代替了SELinux，探测内核。</figcaption></figure><p id="3d1b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">1.运行python过程:</p><figure class="lr ls lt lu gt mq gh gi paragraph-image"><div class="gh gi or"><img src="../Images/5851b096c258bc244d88880c7d2bad12.png" data-original-src="https://miro.medium.com/v2/resize:fit:420/format:webp/1*64N2c1nlx8zDZ_qd82Wm3Q.png"/></div></figure><p id="b8de" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.在后台运行dtrace进程:</p><figure class="lr ls lt lu gt mq gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi os"><img src="../Images/009582a6cd37650c6d51cc74d1204b6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H9NTNPNYfFLEYx3gx21HXQ.png"/></div></div></figure><p id="1aba" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="ko"> 3。想报道什么就报道什么</em></p><figure class="lr ls lt lu gt mq gh gi paragraph-image"><div class="gh gi ot"><img src="../Images/d066fb990c6176c8c072340846f32eff.png" data-original-src="https://miro.medium.com/v2/resize:fit:716/format:webp/1*r3Yoal436S6KivWHHcrD1Q.png"/></div></figure><p id="7ef3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">4.dtrace输出:</p><figure class="lr ls lt lu gt mq gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi ou"><img src="../Images/67179f673dd59204c474215f880da525.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xwEabs5swUJSJ37BNctvBQ.png"/></div></div></figure><p id="9849" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">太神奇了！我们可以看到<strong class="jp ir"><em class="ko">POSIX _ spawn</em></strong><em class="ko"/>syscall被调用(第4行)。</p><p id="40c7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这个例子中，我使用了<strong class="jp ir">" dtrace<em class="ko">-n "</em></strong><em class="ko">将一个钩子传递给dtrace。<br/> </em>我已经将这个dtrace命令扩展成了一个<a class="ae np" href="https://docs.oracle.com/cd/E18752_01/html/819-5488/gcfqr.html" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir"> dscript </strong> </a>，这是一种存储这些钩子并对这些探针进行编程来做我们想要做的事情的方法。</p><p id="c0dc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在一个示例之后，我编写了一个dscript程序(脚本文件),当一个特定的python模块调用一个“spawn”syscall时，它会终止一个进程。</p><figure class="lr ls lt lu gt mq gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi ov"><img src="../Images/1dc7ec500b77759e577a3b8f166ed4dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bzTCc1eLEhDkAyQAm0P5wA.png"/></div></div><figcaption class="mx my gj gh gi mz na bd b be z dk translated">当特定python模块调用“spawn”syscall时，终止python进程的dscript程序。</figcaption></figure><ul class=""><li id="71ae" class="nb nc iq jp b jq jr ju jv jy nd kc ne kg nf kk ng nh ni nj bi translated">我在dscript语言中使用一种叫做<a class="ae np" href="https://myaut.github.io/dtrace-stap-book/lang/assocarr.html" rel="noopener ugc nofollow" target="_blank">关联数组</a>的东西有效地实现了它。</li><li id="cb72" class="nb nc iq jp b jq nk ju nl jy nm kc nn kg no kk ng nh ni nj bi translated">我为脚本中需要的变量实现了一个python包装器，并为dtrace文件内容创建了一个模板。</li></ul><h1 id="ccfd" class="nq kt iq bd ku nr ok nt kx nu ol nw la nx om nz ld oa on oc lg od oo of lj og bi translated"><strong class="ak">然后，我写了“sec import”</strong>！</h1><figure class="lr ls lt lu gt mq gh gi paragraph-image"><div class="gh gi ow"><img src="../Images/b56ad82de09c602f18c57e687a71d35c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1060/format:webp/1*GaSXCPzn9Rej_FdVzRIluw.png"/></div><figcaption class="mx my gj gh gi mz na bd b be z dk translated">MVP版本的“安全导入”或“secimport”的示例。</figcaption></figure><p id="6536" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mf mg mh lw b">secimport</code>是一个python包，可用于:</p><ul class=""><li id="922d" class="nb nc iq jp b jq jr ju jv jy nd kc ne kg nf kk ng nh ni nj bi translated">在您的生产环境中约束/限制特定的python模块。</li><li id="e12a" class="nb nc iq jp b jq nk ju nl jy nm kc nn kg no kk ng nh ni nj bi translated">开源，来自不可信来源的第三方。</li><li id="8728" class="nb nc iq jp b jq nk ju nl jy nm kc nn kg no kk ng nh ni nj bi translated">在用户空间/操作系统/内核级别审计python应用程序的流程。</li><li id="3848" class="nb nc iq jp b jq nk ju nl jy nm kc nn kg no kk ng nh ni nj bi translated">在统一配置下运行整个python应用程序</li><li id="ca11" class="nb nc iq jp b jq nk ju nl jy nm kc nn kg no kk ng nh ni nj bi translated">有点像python模块的<code class="fe mf mg mh lw b">seccomp</code>。跨平台。</li></ul><h2 id="e9c2" class="ks kt iq bd ku kv kw dn kx ky kz dp la jy lb lc ld kc le lf lg kg lh li lj lk bi translated">网络示例</h2><pre class="lr ls lt lu gt lv lw lx ly aw lz bi"><span id="bbbd" class="ks kt iq lw b gy ma mb l mc md">&gt;&gt;&gt; import requests<br/>&gt;&gt;&gt; requests.get('https://google.com')<br/>&lt;Response [200]&gt;<br/>  <br/><br/>&gt;&gt;&gt; from secimport import secure_import<br/>&gt;&gt;&gt; requests = secure_import('requests', allow_networking=False)<br/><br/># The next call should kill the process,<br/># because we disallowed networking for the requests module.</span><span id="1128" class="ks kt iq lw b gy me mb l mc md">&gt;&gt;&gt; requests.get('https://google.com')<br/>[1]    86664 killed</span></pre><h2 id="b98a" class="ks kt iq bd ku kv kw dn kx ky kz dp la jy lb lc ld kc le lf lg kg lh li lj lk bi translated">外壳示例</h2><pre class="lr ls lt lu gt lv lw lx ly aw lz bi"><span id="b925" class="ks kt iq lw b gy ma mb l mc md">Python 3.10.0 (default, May  2 2022, 21:43:20) [Clang 13.0.0 (clang-1300.0.27.3)] on darwin<br/>Type "help", "copyright", "credits" or "license" for more information.<br/><br/># Let's import subprocess module.<br/>&gt;&gt;&gt; import secimport<br/>&gt;&gt;&gt; subprocess = secimport.secure_import("subprocess", allow_shells=False)<br/><br/># Let's import os <br/>&gt;&gt;&gt; import os<br/>&gt;&gt;&gt; os.system("ps")<br/>  PID TTY           TIME CMD<br/> 2022 ttys000    0:00.61 /bin/zsh -l<br/>50092 ttys001    0:04.66 /bin/zsh -l<br/>75860 ttys001    0:00.13 python<br/>0<br/># It worked as expected, returning exit code 0.<br/><br/><br/># Now, let's try to invoke the same logic using a different module, "subprocess", that was imported using "secure_import":<br/>&gt;&gt;&gt; subprocess.check_call('ps')</span><span id="1d8c" class="ks kt iq lw b gy me mb l mc md">[1]    75860 killed     python<br/><br/># Damn! That's cool.</span></pre><ul class=""><li id="9d96" class="nb nc iq jp b jq jr ju jv jy nd kc ne kg nf kk ng nh ni nj bi translated">模块的dtrace配置文件保存在:<code class="fe mf mg mh lw b">/tmp/.secimport/sandbox_subprocess.d</code></li><li id="963c" class="nb nc iq jp b jq nk ju nl jy nm kc nn kg no kk ng nh ni nj bi translated"><br/>日志文件:<code class="fe mf mg mh lw b">/tmp/.secimport/sandbox_subprocess.log</code></li></ul><h1 id="1f24" class="nq kt iq bd ku nr ok nt kx nu ol nw la nx om nz ld oa on oc lg od oo of lj og bi translated">结论</h1><p id="7b39" class="pw-post-body-paragraph jn jo iq jp b jq lm js jt ju ln jw jx jy lo ka kb kc lp ke kf kg lq ki kj kk ij bi translated">看起来安全社区需要一个沙箱，它能够限制代码中的特定模块，同时保持它在同一个进程中。我提出了一种在我们的代码库中处理第三方代码的方法。</p><p id="daf5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">源代码:<br/>T11】https://github.com/avilum/secimport</p><p id="1153" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">示例:<a class="ae np" href="https://github.com/avilum/secimport/blob/master/docs/EXAMPLES.md" rel="noopener ugc nofollow" target="_blank">https://github . com/avilum/sec import/blob/master/docs/examples . MD</a></p><p id="9efa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果我让像python这样的动态语言成为可能，我相信社区将能够用几行代码实现其他语言的工具。</p><h2 id="1ad4" class="ks kt iq bd ku kv kw dn kx ky kz dp la jy lb lc ld kc le lf lg kg lh li lj lk bi translated">谢谢你读到这里。</h2><p id="cd5a" class="pw-post-body-paragraph jn jo iq jp b jq lm js jt ju ln jw jx jy lo ka kb kc lp ke kf kg lq ki kj kk ij bi translated">如果你喜欢这篇文章，我欢迎你查看我以前的一些版本:</p><div class="ox oy gp gr oz pa"><a rel="noopener  ugc nofollow" target="_blank" href="/how-i-discovered-thousands-of-open-databases-on-aws-764729aa7f32"><div class="pb ab fo"><div class="pc ab pd cl cj pe"><h2 class="bd ir gy z fp pf fr fs pg fu fw ip bi translated">我是如何在AWS上发现数千个开放数据库的</h2><div class="ph l"><h3 class="bd b gy z fp pf fr fs pg fu fw dk translated">我寻找和报告包含财富500强公司、医院、加密等敏感数据的数据库的旅程</h3></div><div class="pi l"><p class="bd b dl z fp pf fr fs pg fu fw dk translated">infosecwriteups.com</p></div></div><div class="pj l"><div class="pk l pl pm pn pj po mv pa"/></div></div></a></div><div class="ox oy gp gr oz pa"><a rel="noopener  ugc nofollow" target="_blank" href="/poc-for-google-phishing-in-10-minutes-ɢoogletranslate-com-dcd0d2c32d91"><div class="pb ab fo"><div class="pc ab pd cl cj pe"><h2 class="bd ir gy z fp pf fr fs pg fu fw ip bi translated">10分钟后谷歌钓鱼的概念验证:ɢoogletranslate.com</h2><div class="ph l"><h3 class="bd b gy z fp pf fr fs pg fu fw dk translated">回到2016年，我看到一篇关于有人购买ɢoogle.com的帖子。它被用于网络钓鱼建议(注意第一个…</h3></div><div class="pi l"><p class="bd b dl z fp pf fr fs pg fu fw dk translated">infosecwriteups.com</p></div></div><div class="pj l"><div class="pp l pl pm pn pj po mv pa"/></div></div></a></div><div class="ox oy gp gr oz pa"><a rel="noopener  ugc nofollow" target="_blank" href="/identify-website-users-by-client-port-scanning-using-webassembly-and-go-e9798b4aa05c"><div class="pb ab fo"><div class="pc ab pd cl cj pe"><h2 class="bd ir gy z fp pf fr fs pg fu fw ip bi translated">通过客户端端口扫描识别网站用户—使用WebAssembly And Go</h2><div class="ph l"><h3 class="bd b gy z fp pf fr fs pg fu fw dk translated">网站倾向于从浏览器扫描其用户的开放端口，以更好地识别新用户/回头客。可以…</h3></div><div class="pi l"><p class="bd b dl z fp pf fr fs pg fu fw dk translated">infosecwriteups.com</p></div></div><div class="pj l"><div class="pq l pl pm pn pj po mv pa"/></div></div></a></div><div class="ox oy gp gr oz pa"><a href="https://medium.com/digital-diplomacy/facebook-knows-what-you-eat-how-to-visualize-all-the-data-facebook-knows-about-us-c89fe3cb4f89" rel="noopener follow" target="_blank"><div class="pb ab fo"><div class="pc ab pd cl cj pe"><h2 class="bd ir gy z fp pf fr fs pg fu fw ip bi translated">脸书知道你吃什么:一步一步地发现脸书收集的关于你的全部数据。</h2><div class="ph l"><h3 class="bd b gy z fp pf fr fs pg fu fw dk translated">一个我如何通过编程探索https://facebook.com/dyi的故事。</h3></div><div class="pi l"><p class="bd b dl z fp pf fr fs pg fu fw dk translated">medium.com</p></div></div><div class="pj l"><div class="pr l pl pm pn pj po mv pa"/></div></div></a></div></div></div>    
</body>
</html>