<html>
<head>
<title>Kerberos Authentication (again… but better)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kerberos身份验证(同样…但更好)</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/kerberos-authentication-again-but-better-badb5dc88b2d?source=collection_archive---------5-----------------------#2022-01-06">https://infosecwriteups.com/kerberos-authentication-again-but-better-badb5dc88b2d?source=collection_archive---------5-----------------------#2022-01-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="2208" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">认证协议旨在确保试图访问资源、信息或系统的个人、程序或实体是真实的，而不是入侵者。</p><p id="96fb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Windows环境中最知名的认证协议之一是<strong class="jp ir"> Kerberos </strong> ( <a class="ae kl" href="https://datatracker.ietf.org/doc/html/rfc1510" rel="noopener ugc nofollow" target="_blank"> RFC 1510 </a>为V5)。</p><p id="58d0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最初，该协议是由<a class="ae kl" href="https://kerberos.org/" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir">麻省理工</strong> </a>在80年代末开发的，但仍被Windows用作在<strong class="jp ir"> Active Directory </strong>环境中的默认认证协议，取代了旧的<strong class="jp ir"> NTLM </strong>协议(旧的但在许多AD环境中广泛使用)。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/3981f45b55e9f48b0f2878fc7b8ce5bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Qeh4qhAIiY1zxjCR.gif"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">参考文献。<a class="ae kl" href="https://m0chan.github.io/" rel="noopener ugc nofollow" target="_blank">https://m0chan.github.io/</a></figcaption></figure><p id="906b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Kerberos的基础是简单的加密概念:对称密钥和可信第三方。</p><p id="4954" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一个<strong class="jp ir"> </strong> <a class="ae kl" href="https://www.ibm.com/docs/en/ztpf/2020?topic=concepts-symmetric-cryptography" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir">对称密钥</strong> </a>只是各方用来加密或解密消息的一个字/串。</p><p id="c0ca" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://csrc.nist.gov/glossary/term/trusted_third_party" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir">可信第三方</strong> </a>是除所有者和验证者之外的实体，受所有者、验证者或两者的信任，提供某种服务。在Kerberos的情况下，受信任的第三方提供认证服务:一般来说，这就是域控制器。</p><p id="16ea" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于Kerberos身份验证，最常见的关键字是:<strong class="jp ir"> ticket </strong>。在这种情况下，门票只是进入电影院、音乐会或Windows服务的“通行证”。</p><p id="60fc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当用户想要访问Windows域中的任何服务(即他的Windows工作站)时，需要一个<strong class="jp ir">服务票</strong>。<br/>要获得服务票，客户端需要与<strong class="jp ir">出票服务器</strong> ( <strong class="jp ir"> TGS </strong>)对话，与TGS对话需要一张特殊的服务票。TGS的服务票被称为<strong class="jp ir">赠票</strong> (TGT)。</p><p id="25ac" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在一个真实世界的例子中，进入一场音乐会你需要一张票(TGT ),在入口处，在使用扫描仪验证后，它的一部分被工作人员撕掉；剩下的部分是TGS，允许你进入座位、后台等。</p><h1 id="7aa0" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">实体</h1><p id="c47e" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">Kerberos协议在身份验证过程中包括以下3个实体:</p><ul class=""><li id="69a2" class="mf mg iq jp b jq jr ju jv jy mh kc mi kg mj kk mk ml mm mn bi translated"><strong class="jp ir">客户端</strong>:想要访问资源用户或服务</li><li id="1c13" class="mf mg iq jp b jq mo ju mp jy mq kc mr kg ms kk mk ml mm mn bi translated"><strong class="jp ir">密钥分发中心(KDC) </strong>:认证服务(AS)支持的可信第三方认证服务，发布“票”(TGTs)。</li><li id="f6f1" class="mf mg iq jp b jq mo ju mp jy mq kc mr kg ms kk mk ml mm mn bi translated"><strong class="jp ir">应用服务器(AP) </strong>:提供用户需要的服务</li></ul><h1 id="85e7" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">流动</h1><p id="80b7" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">身份验证协议流程如下图所示；接下来的段落会爆炸每一步。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi mt"><img src="../Images/d540a7b68acf8fe77ae0f8141c4def78.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*8kVXQY3HFv-EzxWg.png"/></div></div></figure><ol class=""><li id="2f10" class="mf mg iq jp b jq jr ju jv jy mh kc mi kg mj kk mu ml mm mn bi translated">客户端向密钥分发中心(域控制器)发送一个<strong class="jp ir"> <em class="mv"> KRB_AS_REQ </em> </strong>请求一个TGT。</li></ol><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi mw"><img src="../Images/dc7b4dabab65298b408f27127893c651.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*lIofXdHd-UQWhTPt.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">[4]: Tarlogic</figcaption></figure><p id="e301" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该请求包括以下数据:</p><ul class=""><li id="20e1" class="mf mg iq jp b jq jr ju jv jy mh kc mi kg mj kk mk ml mm mn bi translated"><strong class="jp ir">时间戳</strong>:使用客户端密码哈希(对称密钥)加密<br/>–验证客户端并防止重放攻击</li><li id="5066" class="mf mg iq jp b jq mo ju mp jy mq kc mr kg ms kk mk ml mm mn bi translated"><strong class="jp ir">用户名</strong>:KDC必须知道哪个用户想要一个TGT</li><li id="e0ed" class="mf mg iq jp b jq mo ju mp jy mq kc mr kg ms kk mk ml mm mn bi translated">用于<em class="mv"> krbtgt </em>账户<br/>的<strong class="jp ir"> SPN服务</strong>——这是一个“硬编码”字符串，因为首先客户端需要与m̶a̶n̶a̶g̶e̶r Kerberos服务对话。</li><li id="0bc5" class="mf mg iq jp b jq mo ju mp jy mq kc mr kg ms kk mk ml mm mn bi translated">由用户<br/>生成的<strong class="jp ir">随机数</strong>，用户和KDC使用它来检测重放攻击</li></ul><p id="11d7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.密钥分发中心通过解密时间戳来验证用户身份，并且如果时间戳是正确的(解密是可能的)，则用<strong class="jp ir"><em class="mv">KRB _代理</em> </strong>消息来响应:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi mx"><img src="../Images/56c6107a56e01a7a2bbaeb95b7994f79.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Jx66gpF2NmBpSUmG.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">[4]: Tarlogic</figcaption></figure><p id="ece6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该响应包括以下数据:</p><ul class=""><li id="00c7" class="mf mg iq jp b jq jr ju jv jy mh kc mi kg mj kk mk ml mm mn bi translated"><strong class="jp ir">用户名</strong></li><li id="11f7" class="mf mg iq jp b jq mo ju mp jy mq kc mr kg ms kk mk ml mm mn bi translated"><strong class="jp ir">Ticket-Grant Ticket(TGT)<br/></strong>–TGT只有KDC可读，因为它是用<em class="mv"> krbtgt </em>帐户的密码散列加密的，并用于以下请求<br/>–krbtgt<strong class="jp ir">帐户是Kerberos协议的<a class="ae kl" href="https://ghostbusters.fandom.com/wiki/Vinz_Clortho" rel="noopener ugc nofollow" target="_blank">密钥主密钥</a>，可以访问存储在域控制器中的所有用户和服务密码散列</strong></li><li id="1de8" class="mf mg iq jp b jq mo ju mp jy mq kc mr kg ms kk mk ml mm mn bi translated"><strong class="jp ir">加密数据</strong>与用户密码哈希<br/>的哈希–这些数据只能由用户读取，用于验证随机数(与用户发送的随机数相同)，并记录会话和票证持续时间</li></ul><p id="5288" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">3.现在，用户已经可以使用TGT an来请求TGS使用所提供的TGT发送<strong class="jp ir"><em class="mv">KRB _ TGS _请求</em> </strong>消息来访问服务:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi my"><img src="../Images/5fd153f4e62aa409fe06c805a4ba45d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*8C-oYYe4TBVtKOSD.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">[4]: Tarlogic</figcaption></figure><p id="6982" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该消息包括以下数据:</p><ul class=""><li id="8d8e" class="mf mg iq jp b jq jr ju jv jy mh kc mi kg mj kk mk ml mm mn bi translated"><strong class="jp ir">用会话密钥</strong>加密数据(只有KDC和用户知道，对称密钥)<br/>–这用于验证用户请求TGS，因为TGT包含用户用来加密信息的相同会话密钥；如果解密失败，那么一定是出了问题，入侵者可能正在篡改流量</li><li id="f69e" class="mf mg iq jp b jq mo ju mp jy mq kc mr kg ms kk mk ml mm mn bi translated">KDC之前获得的<strong class="jp ir"> TGT </strong>作为“担保”</li><li id="bad7" class="mf mg iq jp b jq mo ju mp jy mq kc mr kg ms kk mk ml mm mn bi translated">请求服务的<strong class="jp ir"> SPN </strong>(即工作站登录、SMB共享等。)</li><li id="1b16" class="mf mg iq jp b jq mo ju mp jy mq kc mr kg ms kk mk ml mm mn bi translated">用户生成的另一个<strong class="jp ir">随机数</strong></li></ul><p id="fbca" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">4.KDC验证请求和TGT，然后在一条<strong class="jp ir"><em class="mv">KRB _ TGS _代表</em> </strong>消息中返回一个TGS:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi mz"><img src="../Images/bd0730f19a4eda34fa611d02e416e3a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*oZCBLqOiDV6GZ6r2.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">[4]: Tarlogic</figcaption></figure><p id="f926" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该响应包含:</p><ul class=""><li id="ae48" class="mf mg iq jp b jq jr ju jv jy mh kc mi kg mj kk mk ml mm mn bi translated">用户名</li><li id="f791" class="mf mg iq jp b jq mo ju mp jy mq kc mr kg ms kk mk ml mm mn bi translated">使用服务密码哈希加密的TGS(KDC知道所有用户/服务密码哈希，它是域控制器)<br/>–TGS仅可由KDC和服务读取，因为它使用SPN的密码哈希加密，并用于以下实际访问服务和维护会话的请求</li><li id="a2e5" class="mf mg iq jp b jq mo ju mp jy mq kc mr kg ms kk mk ml mm mn bi translated">带有会话密钥散列的加密数据<br/>–这些数据只能由用户读取，用于验证随机数(与用户发送的随机数相同)，并记录会话和访问服务的票证持续时间</li></ul><p id="4c54" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">5.用户最终可以使用<strong class="jp ir"> <em class="mv"> KRB_AP_REQ </em> </strong>消息发送TGS以与服务(AP)交互:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi na"><img src="../Images/3eb86857232b73080722fcfe38a2ebac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*QMsW1M7yEoZf4Ip8.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">[4]: Tarlogic</figcaption></figure><p id="ae3f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该消息包含:</p><ul class=""><li id="a9ee" class="mf mg iq jp b jq jr ju jv jy mh kc mi kg mj kk mk ml mm mn bi translated">先前由KDC发送的TGS<br/>——因为它是用服务密码散列加密的，所以AP可以解密票证并验证消息和会话</li><li id="e140" class="mf mg iq jp b jq mo ju mp jy mq kc mr kg ms kk mk ml mm mn bi translated">带有服务会话密钥的加密数据<br/>–服务会话密钥对用户是已知的，因为它是由KDC加密发送的，服务本身也是已知的，因为它在TGS内部；如果所有的解密都是正确的，则请求被验证</li></ul><p id="2260" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了进一步的安全验证(该步骤是可选的)，AP可以向KDC发送<strong class="jp ir"><em class="mv">KERB _ VERIFY _ PAC</em></strong>请求以验证PAC消息内容。特权属性证书(<strong class="jp ir"> PAC </strong>)是Kerberos票据的扩展，它包含关于用户特权的有用信息；如果KDC验证(如果不易受<a class="ae kl" href="https://support.microsoft.com/en-us/topic/ms14-068-vulnerability-in-kerberos-could-allow-elevation-of-privilege-november-18-2014-9692b9fc-e5e1-73e0-4058-37d19893275c" rel="noopener ugc nofollow" target="_blank">MS14–068</a>攻击)用户权限；该访问被准许。</p><p id="0e7f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">参考资料:</p><ul class=""><li id="9a63" class="mf mg iq jp b jq jr ju jv jy mh kc mi kg mj kk mk ml mm mn bi translated"><a class="ae kl" href="https://docs.microsoft.com/en-us/windows-server/security/kerberos/kerberos-authentication-overview" rel="noopener ugc nofollow" target="_blank">微软:Kerberos认证概述</a></li><li id="b337" class="mf mg iq jp b jq mo ju mp jy mq kc mr kg ms kk mk ml mm mn bi translated"><a class="ae kl" href="https://www.varonis.com/blog/kerberos-authentication-explained/" rel="noopener ugc nofollow" target="_blank"> Varonis: Kerberos认证说明</a></li><li id="2c0f" class="mf mg iq jp b jq mo ju mp jy mq kc mr kg ms kk mk ml mm mn bi translated"><a class="ae kl" href="https://stealthbits.com/blog/what-is-kerberos/" rel="noopener ugc nofollow" target="_blank">sthaltbits:什么是Kerberos？</a></li><li id="1047" class="mf mg iq jp b jq mo ju mp jy mq kc mr kg ms kk mk ml mm mn bi translated">Tarlogic:Kerberos是如何工作的？</li></ul></div></div>    
</body>
</html>