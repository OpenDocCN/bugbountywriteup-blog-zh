<html>
<head>
<title>One Gadget is EASY and POWERFUL! Tool and Example.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">一个小工具既简单又强大！工具和例子。</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/one-gadget-is-easy-and-powerful-tool-and-example-b7b1af9e57f5?source=collection_archive---------2-----------------------#2021-01-02">https://infosecwriteups.com/one-gadget-is-easy-and-powerful-tool-and-example-b7b1af9e57f5?source=collection_archive---------2-----------------------#2021-01-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/818f3b017aa456415e4ca956a9ffcae6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Douiz8LtW2DFCr1Y-GJyhA.png"/></div></div></figure><p id="f1da" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这个帖子来自我的个人网站:<a class="ae kw" href="https://pwnbykenny.com/" rel="noopener ugc nofollow" target="_blank">https://pwnbykenny.com</a>。以下是帖子的链接:<a class="ae kw" href="https://pwnbykenny.com/en/2020/12/31/one-gadget-easy-powerful-tool-example/" rel="noopener ugc nofollow" target="_blank">一个简单而强大的小工具！工具和例子。— Pwn By Kenny </a>。你可以在那里找到比这里发布的更多的帖子。</p><h1 id="bc14" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">1.内容</h1><ul class=""><li id="1eef" class="lv lw iq ka b kb lx kf ly kj lz kn ma kr mb kv mc md me mf bi translated"><a class="ae kw" href="https://pwnbykenny.com/en/2020/12/31/one-gadget-easy-powerful-tool-example/#one-gadget-exploitation" rel="noopener ugc nofollow" target="_blank">你一定要选一个小玩意来开发</a></li><li id="46e2" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated"><a class="ae kw" href="https://pwnbykenny.com/en/2020/12/31/one-gadget-easy-powerful-tool-example/#one-gadget-tool" rel="noopener ugc nofollow" target="_blank">著名的one_gadget工具</a></li><li id="e6c0" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated"><a class="ae kw" href="https://pwnbykenny.com/en/2020/12/31/one-gadget-easy-powerful-tool-example/#ctf-example" rel="noopener ugc nofollow" target="_blank">一个具体的CTF示例向您展示如何逐步使用该工具</a></li><li id="6328" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated"><a class="ae kw" href="https://pwnbykenny.com/en/2020/12/31/one-gadget-easy-powerful-tool-example/#environment-introduction" rel="noopener ugc nofollow" target="_blank">环境设置和介绍</a></li><li id="3b15" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated"><a class="ae kw" href="https://pwnbykenny.com/en/2020/12/31/one-gadget-easy-powerful-tool-example/#conquer-ctf" rel="noopener ugc nofollow" target="_blank">攻克CTF难题</a></li><li id="a8c8" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated"><a class="ae kw" href="https://pwnbykenny.com/en/2020/12/31/one-gadget-easy-powerful-tool-example/#summary" rel="noopener ugc nofollow" target="_blank">总结</a></li></ul><h1 id="0aa1" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">2.你肯定想选择一个小工具来开发</h1><p id="35d4" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">一个小工具是一行C代码:execve("/bin/sh "，0，0)；。显然，这段代码产生了一个外壳。如果您能够在内存中找到并运行它，您将获得一个shell！看到了吗？轻松又强大！</p><p id="86d4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">幸运的是，它存在于libc中。而且大部分程序都用libc！libc是一个C库文件。one_gadget工具会在这样的文件中找到所有出现的代码。</p><h1 id="c036" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">3.著名的one_gadget工具</h1><p id="91e1" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">(Linux OS)通过运行:gem install one_gadget下载该工具。然后你就可以很容易地在一个终端中运行它:one _ gadget/usr/lib/x86 _ 64-Linux-GNU/libc-2.31 . so .参数是你的libc文件的路径。它可能会在您的机器上发生变化。这将产生以下输出:</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div class="gh gi mo"><img src="../Images/23a978b8d4fc07d92a494783265ab508.png" data-original-src="https://miro.medium.com/v2/resize:fit:582/0*QYxBFnPboGo8ysNr"/></div></figure><p id="e139" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">execve("/bin/sh "，r12，r13)是一个小工具。在运行之前，您需要确保这两行约束都为真/满足。只有在满足约束的情况下，这个小工具才会变成execve("/bin/sh "，0，0)。0xcbcda是小工具在libc文件中的偏移量。为了知道小工具在内存中的地址，还需要知道内存中libc文件的基址:小工具的内存地址= libc文件的内存基址+小工具在libc文件内的偏移量。</p><h1 id="285a" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">4.一个具体的CTF示例逐步向您展示如何使用该工具</h1><h1 id="4ce4" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">4.1环境设置和介绍</h1><p id="5c8e" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">首先，下载这个<a class="ae kw" href="https://drive.google.com/file/d/1sunenD-xl6pZrrd38TFAi3cfgbwu1sS3/view?usp=sharing" rel="noopener ugc nofollow" target="_blank">文件</a>。它来源于这个<a class="ae kw" href="https://buuoj.cn/challenges" rel="noopener ugc nofollow" target="_blank">平台</a>&gt;Pwn&gt;【BJDCTF 2nd】one _ gadget。然后我们运行它，它产生以下输出:</p><pre class="mp mq mr ms gt mt mu mv mw aw mx bi"><span id="1890" class="my ky iq mu b gy mz na l nb nc">here is the gift for u:0x7f784418acb0<br/>Give me your one gadget:</span></pre><p id="d948" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果对可执行文件进行反汇编，会发现礼物其实是libc函数printf的地址。它可能在每次不同的执行中改变。您还会发现，可执行文件要求您输入一个小工具的地址。可执行文件将在给定的地址执行一个小工具。现在让我们看看如何执行一个小工具。</p><h1 id="5ae8" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">4.2征服CTF问题</h1><p id="58cf" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">以下是步骤:</p><ul class=""><li id="f0e3" class="lv lw iq ka b kb kc kf kg kj nd kn ne kr nf kv mc md me mf bi translated">给gdb安装某种支持命令“vmmap”的插件。我使用全球环境基金。</li><li id="3c18" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated">运行“广发问题”。现在gdb读入可执行文件。然后，用命令“r”运行gdb下的程序。接下来，按“ctrl + c”将控制权交还给gdb。现在，我们可以使用命令“vmmap”来检查内存。在输出中，您会注意到类似下图的内容，它显示了libc文件的路径。这是这个程序中使用的libc。现在我们想在libc文件中找到一些小工具。</li></ul><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ng"><img src="../Images/4fff15286d3a2a70cd9e36a22d43e44d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*DRo03b9Hgk6pygYV"/></div></div></figure><ul class=""><li id="2065" class="lv lw iq ka b kb kc kf kg kj nd kn ne kr nf kv mc md me mf bi translated">退出gdb进程。现在运行“one _ gadget/usr/lib/x86 _ 64-Linux-GNU/libc-2.31 . so”。你需要改变你的道路。您将在输出中看到类似于第3节中的图片。所以现在我们有了一个小工具在libc文件中的偏移量:0xcbcda。</li><li id="ad9b" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated">嗯，你还需要找到libc函数printf的偏移量。运行这个命令:objdump-TT/usr/lib/x86 _ 64-Linux-GNU/libc-2.31 . so | grep " printf "。您需要用自己的路径替换libc文件的路径。下图是输出。第一列是偏移量。所以printf的偏移量是:0x56cb0。</li></ul><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nh"><img src="../Images/911ff5e45d5c6321a566f6522f7263da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*WQwrY2FyeID3Pqz5"/></div></div></figure><ul class=""><li id="d409" class="lv lw iq ka b kb kc kf kg kj nd kn ne kr nf kv mc md me mf bi translated">再次启动gdb:gdb问题。在main: b main设置一个断点。运行程序:r。现在你会看到程序在main函数处停止。用命令一次运行一行代码:n .如果你看到这样的输出:这里是给u的礼物:0x7ffff7e3bcb0，用我在第3节给你的公式计算一个小工具的地址:小工具地址= libc基址+小工具偏移量= printf地址— printf偏移量+小工具偏移量= 0x 7 ffff 7 E3 BCB 0–0x 56 CB 0+0x cbcda = 0x 7 ffff 7 EB 0 CDA = 140737352764634。</li><li id="4bd1" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated">继续用n运行程序，现在看下图。执行printf函数后，您将看到输出:给我一个小工具:。但是现在不是输入一个小工具地址的正确时间。您需要等待，直到红色scanf功能被执行。这时，您需要输入一个小工具地址。</li></ul><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ni"><img src="../Images/f22bfed4479c35f7b6ebf46fb9813997.png" data-original-src="https://miro.medium.com/v2/resize:fit:1222/0*HQ-wyxqzlSVvydPr"/></div></div></figure><ul class=""><li id="ba35" class="lv lw iq ka b kb kc kf kg kj nd kn ne kr nf kv mc md me mf bi translated">运行scanf功能后，现在是输入您的小工具地址的时候了。请以十进制格式输入地址，而不是十六进制格式！我的情况是140737352764634。从现在开始请小心，因为一些魔法即将发生。在scanf函数之后，下面是将要执行的机器码。从$pc指针开始，你看到这三行代码在做什么？它们将存储器[rbp-0x18]中的值移动到rdx。运行这三行代码后，您会发现rdx存储了一个小工具地址！然后“调用rdx”去执行这个小工具！</li></ul><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/a4e4b52169fdbeb3824cb4ebe47a4c78.png" data-original-src="https://miro.medium.com/v2/resize:fit:1088/0*x1i2cLJLoedXQalr"/></div></figure><ul class=""><li id="c3f8" class="lv lw iq ka b kb kc kf kg kj nd kn ne kr nf kv mc md me mf bi translated">运行代码，直到“调用rdx”。但是不要运行“调用rdx”！为什么？回想一下，在我们能够成功执行这个小工具之前，需要满足一些约束。约束条件是:r12 == NULL &amp;&amp; r13 == NULL。现在我来观察一下它们是什么(如下图所示)。显然，r12不为空。我们需要使用命令set $r12 = 0将其设置为null。现在，如果您运行这个命令:p $r12，您会发现r12变成了null。</li></ul><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/0eeb10aa4f67a44bb1823dadab44ceda.png" data-original-src="https://miro.medium.com/v2/resize:fit:894/0*4O_j61YUhUlfquGa"/></div></figure><ul class=""><li id="c128" class="lv lw iq ka b kb kc kf kg kj nd kn ne kr nf kv mc md me mf bi translated">现在我们可以运行“调用rdx”了。这一次，我们继续执行命令:c . shell将立即生成！</li></ul><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/503633323094491cb2e16be08bec8195.png" data-original-src="https://miro.medium.com/v2/resize:fit:998/0*Msk_JZqyPiF-Qrc1"/></div></figure><h1 id="90fd" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">5.摘要</h1><p id="44b9" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">这篇文章用一个具体的CTF问题一步一步地向你展示如何找到并执行一个小工具，并最终生成一个外壳。如果你喜欢这个帖子，请帮我分享到你的社交媒体上。非常感谢！</p></div></div>    
</body>
</html>