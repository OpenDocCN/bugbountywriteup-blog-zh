<html>
<head>
<title>BGP: The weak link in the internet! What is BGP and how do hackers exploit it?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">BGP:互联网的薄弱环节！什么是BGP，黑客如何利用它？</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/bgp-the-weak-link-in-the-internet-what-is-bgp-and-how-do-hackers-exploit-it-d899a68ba5bb?source=collection_archive---------0-----------------------#2019-02-03">https://infosecwriteups.com/bgp-the-weak-link-in-the-internet-what-is-bgp-and-how-do-hackers-exploit-it-d899a68ba5bb?source=collection_archive---------0-----------------------#2019-02-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><blockquote class="jq jr js"><p id="f954" class="jt ju jv jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr im bi translated">解释BGP的最佳方式是酒吧里的人发誓戴夫就是戴夫，因为他们以前见过他。但有时他们喝醉了，会把戴夫当成丹尼斯。这是可以理解的，因为鲍勃发誓丹尼斯是戴夫12品脱。</p><p id="cf88" class="jt ju jv jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr im bi translated"><em class="it"> —凯文·博蒙特(</em><a class="ae ks" href="https://twitter.com/GossiTheDog" rel="noopener ugc nofollow" target="_blank"><em class="it">)@ GossiTheDog</em></a><em class="it">)</em><a class="ae ks" href="https://twitter.com/GossiTheDog/status/988844409683955712?ref_src=twsrc%5Etfw" rel="noopener ugc nofollow" target="_blank"><em class="it">2018年4月24日</em> </a></p></blockquote><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi kt"><img src="../Images/8cbdf91962f7a941e56f847b7cf42313.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*iaVsUk6dKXEADbYG"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated"><a class="ae ks" href="https://unsplash.com/@trhammerhead?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">布莱森锤</a>在<a class="ae ks" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</figcaption></figure><h1 id="4adc" class="lj lk it bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">#1什么是BGP</h1><p id="6250" class="pw-post-body-paragraph jt ju it jw b jx mh jz ka kb mi kd ke mj mk kh ki ml mm kl km mn mo kp kq kr im bi translated">BGP代表边界网关协议。它是一种在多个自治系统(AS)之间交换路由信息的路由协议。它被视为我们在互联网上路由流量的方式。</p><h2 id="5ea5" class="mp lk it bd ll mq mr dn lp ms mt dp lt mj mu mv lx ml mw mx mb mn my mz mf na bi translated">自治系统</h2><p id="771d" class="pw-post-body-paragraph jt ju it jw b jx mh jz ka kb mi kd ke mj mk kh ki ml mm kl km mn mo kp kq kr im bi translated">自治系统是具有相同网络策略的路由器或网络的集合，通常受单一管理控制。—<a class="ae ks" href="https://www.cisco.com/c/en/us/about/press/internet-protocol-journal/back-issues/table-contents-12/autonomous-system-numbers.html" rel="noopener ugc nofollow" target="_blank">https://www . Cisco . com/c/en/us/about/press/internet-protocol-journal/back-issues/table-contents-12/autonomous-system-numbers . html</a></p><p id="535e" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke mj kg kh ki ml kk kl km mn ko kp kq kr im bi translated">自治系统向其他as通告它拥有的或者可以到达的前缀地址。路由信息是通过BGP通告的。</p><p id="6341" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke mj kg kh ki ml kk kl km mn ko kp kq kr im bi translated">BGP用于在一个AS(内部)的路由器之间和多个AS(外部)之间传递信息。</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/4a0efc0830cb915d121ae4f06b263d6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1372/format:webp/1*y_lulqQT8i2KJ_wgDjGsWA.png"/></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">iBGP在AS中创建了完全的互连性</figcaption></figure><p id="eb30" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke mj kg kh ki ml kk kl km mn ko kp kq kr im bi translated">注意:内部网关协议应该使用全网状网络。这意味着每个iBGP发言人必须与其他iBGP发言人对等，如上图所示。</p><p id="0a12" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke mj kg kh ki ml kk kl km mn ko kp kq kr im bi translated">外部BGP (EGP)是运行在TCP上的as之间使用的路由协议。</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi nc"><img src="../Images/ff540f3c1e91dac37d6fe015e1724f8b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RZlTA3JEwPbeu9xyfFsTaw.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">跨多个自治系统的EGP示例</figcaption></figure><p id="736c" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke mj kg kh ki ml kk kl km mn ko kp kq kr im bi translated">内部和外部BGP的区别</p><h2 id="c630" class="mp lk it bd ll mq mr dn lp ms mt dp lt mj mu mv lx ml mw mx mb mn my mz mf na bi translated">内部</h2><ul class=""><li id="1fd4" class="nd ne it jw b jx mh kb mi mj nf ml ng mn nh kr ni nj nk nl bi translated">在与相同的路由器之间</li><li id="324d" class="nd ne it jw b jx nm kb nn mj no ml np mn nq kr ni nj nk nl bi translated">路由器通常离得很远</li><li id="bb55" class="nd ne it jw b jx nm kb nn mj no ml np mn nq kr ni nj nk nl bi translated">应该是全网状拓扑</li></ul><h2 id="de48" class="mp lk it bd ll mq mr dn lp ms mt dp lt mj mu mv lx ml mw mx mb mn my mz mf na bi translated">外部</h2><ul class=""><li id="7a6c" class="nd ne it jw b jx mh kb mi mj nf ml ng mn nh kr ni nj nk nl bi translated">不同as中的路由器之间</li><li id="4c82" class="nd ne it jw b jx nm kb nn mj no ml np mn nq kr ni nj nk nl bi translated">几乎总是通过以太网等直接连接路由器。</li></ul><h1 id="37a1" class="lj lk it bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated"># 2 BGP是如何工作的</h1><p id="2b80" class="pw-post-body-paragraph jt ju it jw b jx mh jz ka kb mi kd ke mj mk kh ki ml mm kl km mn mo kp kq kr im bi translated">BGP如何决定到达目的路由器的路径？</p><p id="15ed" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke mj kg kh ki ml kk kl km mn ko kp kq kr im bi translated">选择的道路应该是最短和最可靠的。</p><p id="9072" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke mj kg kh ki ml kk kl km mn ko kp kq kr im bi translated">这个决定是通过称为链路状态的协议来完成的。使用链路状态协议，每台路由器都会向网络中的所有其它路由器广播其链路和IP子网的状态。然后，每台路由器从其它路由器接收信息，构建整个网络的完整拓扑视图。下一跳路由表基于此拓扑视图。</p><p id="5d96" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke mj kg kh ki ml kk kl km mn ko kp kq kr im bi translated">链路状态协议使用计算机科学领域的一种著名算法，即Dijkstra最短路径算法。它是这样工作的:</p><ol class=""><li id="ff1f" class="nd ne it jw b jx jy kb kc mj nr ml ns mn nt kr nu nj nk nl bi translated">我们从路由器开始考虑到所有直接邻居的路径开销。(注意:路径开销就是AS路径长度，更多信息请访问<a class="ae ks" href="https://www.cisco.com/c/en/us/about/press/internet-protocol-journal/back-issues/table-contents-12/autonomous-system-numbers.html" rel="noopener ugc nofollow" target="_blank">此处</a>。)</li><li id="84ef" class="nd ne it jw b jx nm kb nn mj no ml np mn nq kr nu nj nk nl bi translated">然后选择最短的路径</li><li id="665b" class="nd ne it jw b jx nm kb nn mj no ml np mn nq kr nu nj nk nl bi translated">然后，我们重新查看我们可以到达的所有邻居，并用开销信息更新我们的链路状态表。然后，我们继续选择最短路径，直到访问完所有路由器。</li></ol><p id="3dc5" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke mj kg kh ki ml kk kl km mn ko kp kq kr im bi translated">现在我们知道了BGP是如何建立路由表的。路由表是一个简单的表格，包含网络中所有可能的路由以及到每个目的地的距离。</p><h2 id="fc44" class="mp lk it bd ll mq mr dn lp ms mt dp lt mj mu mv lx ml mw mx mb mn my mz mf na bi translated">朝着正确的方向前进</h2><p id="aa10" class="pw-post-body-paragraph jt ju it jw b jx mh jz ka kb mi kd ke mj mk kh ki ml mm kl km mn mo kp kq kr im bi translated"><em class="jv">当我们指定一个我们希望与之通信的IP地址时，我们的路由器如何知道数据包要发送到哪里(方向)？</em></p><p id="626b" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke mj kg kh ki ml kk kl km mn ko kp kq kr im bi translated">路由器的主要功能之一是通过网络传输数据包。它决定发送数据包的目的地是由其<strong class="jw iu">转发表</strong>中包含的信息决定的。</p><p id="8a79" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke mj kg kh ki ml kk kl km mn ko kp kq kr im bi translated"><strong class="jw iu"> <em class="jv">注意</em> </strong> <em class="jv">:转发表并不存储每个IP地址，因为这样会使表变得很大！！相反，使用前缀。</em> <strong class="jw iu"> <em class="jv">最长/最具体的</em> </strong> <em class="jv">匹配总是赢！！！</em></p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi nv"><img src="../Images/f27e692983672994faaa99718c5b51a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1364/format:webp/1*owDv8N4S_w6UBhGeTZ8Mfg.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">根据R2的FIB，R4具有最长的匹配，因此数据包被发送到那里</figcaption></figure><p id="2a66" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke mj kg kh ki ml kk kl km mn ko kp kq kr im bi translated"><strong class="jw iu"> <em class="jv">注</em> </strong> <em class="jv"> : 0.0.0.0/0被认为是默认网关，匹配一切</em></p><h1 id="f959" class="lj lk it bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">#3以前使用BGP的黑客攻击</h1><p id="7225" class="pw-post-body-paragraph jt ju it jw b jx mh jz ka kb mi kd ke mj mk kh ki ml mm kl km mn mo kp kq kr im bi translated">BGP黑客攻击可用于执行一系列恶意活动，包括:</p><ul class=""><li id="8b9e" class="nd ne it jw b jx jy kb kc mj nr ml ns mn nt kr ni nj nk nl bi translated">拒绝服务</li><li id="5fbd" class="nd ne it jw b jx nm kb nn mj no ml np mn nq kr ni nj nk nl bi translated">《中间人》( MITM)</li><li id="8ad2" class="nd ne it jw b jx nm kb nn mj no ml np mn nq kr ni nj nk nl bi translated">黑色孔洞</li></ul><p id="c11c" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke mj kg kh ki ml kk kl km mn ko kp kq kr im bi translated">在过去，BGP已经被黑客在大规模的黑客攻击中利用过很多次。2018年，myetherwallet.com持有的钱包发生了一次著名的<a class="ae ks" href="https://www.bankinfosecurity.com/cryptocurrency-heist-bgp-leak-masks-ether-theft-a-10898" rel="noopener ugc nofollow" target="_blank">加密货币抢劫</a>，利用BGP劫持执行中间人攻击。</p><p id="98d9" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke mj kg kh ki ml kk kl km mn ko kp kq kr im bi translated">另一次黑客攻击导致谷歌服务瘫痪，利用BGP操纵流量通过俄罗斯、中国和尼日利亚进行路由，随后被封锁。—<a class="ae ks" href="https://securityaffairs.co/wordpress/77971/hacking/google-traffic-bgp-leak.html" rel="noopener ugc nofollow" target="_blank">https://security affairs . co/WordPress/77971/hacking/Google-traffic-BGP-leak . html</a></p><p id="c336" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke mj kg kh ki ml kk kl km mn ko kp kq kr im bi translated"><a class="ae ks" href="http://www.enterprisenetworkingplanet.com/netsp/article.php/3615896/Networking-101-Understanding-BGP-Routing.htm" rel="noopener ugc nofollow" target="_blank"> Youtube 2008黑洞</a>——巴基斯坦决定通过创建一条通向黑洞的BGP路由来屏蔽Youtube。相反，这些路由信息被传输到香港的ISP，并从那里意外传播到世界各地，这意味着数百万人被路由到这个黑洞，因此无法访问YouTube。</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi nw"><img src="../Images/f395f31c1ee9d73318514384cdc70ec1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KZeNEFoODpXqV56myqU2bA.png"/></div></div></figure><blockquote class="nx"><p id="da7a" class="ny nz it bd oa ob oc od oe of og kr dk translated"><em class="oh"> BGP黑客攻击通常被称为网络整形或流量整形。</em></p></blockquote><h1 id="f044" class="lj lk it bd ll lm ln lo lp lq lr ls lt lu oi lw lx ly oj ma mb mc ok me mf mg bi translated">#4了解BGP劫持</h1><p id="537e" class="pw-post-body-paragraph jt ju it jw b jx mh jz ka kb mi kd ke mj mk kh ki ml mm kl km mn mo kp kq kr im bi translated">正如我们在前面的巴基斯坦YouTube事故中看到的，通过破坏BGP路由表，我们能够影响互联网上的流量流向！这种行为被称为BGP劫持。</p><p id="4d6e" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke mj kg kh ki ml kk kl km mn ko kp kq kr im bi translated">还记得我之前说过最具体/最长的前缀匹配总是获胜吗？事实证明，我们可以利用这个特性来重新路由流量！</p><p id="c63d" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke mj kg kh ki ml kk kl km mn ko kp kq kr im bi translated">通过毒化路由表，我们可以指定比其他as当前提供的更具体的路由匹配。如果新路由比其他广告路由更具体，流量将被定向到我们这里！我们也可以声称拥有同样效果的前缀。</p><p id="59a6" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke mj kg kh ki ml kk kl km mn ko kp kq kr im bi translated">我们之前在本文中讨论过的另一件事是BGP如何创建路由表。这是由基于Dikjstra最短路径算法的链路状态协议完成的。这可以通过通告比其他AS更短的AS路径来利用。通过这样做，其他路由器的下一个最短跳将是我们的路由器，因此我们可以接收流量。</p><p id="65e7" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke mj kg kh ki ml kk kl km mn ko kp kq kr im bi translated">为了执行这个<a class="ae ks" href="https://en.wikipedia.org/wiki/BGP_hijacking" rel="noopener ugc nofollow" target="_blank"> BGP劫持</a>假设我们可以访问网络，并且我们可以更改路由表，但是这是非常不可能的，除非作为内部攻击进行。然而，确实存在另一种方法来实现劫持，它需要以下条件:</p><ol class=""><li id="cbd9" class="nd ne it jw b jx jy kb kc mj nr ml ns mn nt kr nu nj nk nl bi translated">成为自治系统的外部对等体</li><li id="4829" class="nd ne it jw b jx nm kb nn mj no ml np mn nq kr nu nj nk nl bi translated">当一个新的对等体被添加时，它的所有被通告的路由被存储在其它设备的路由表中，然后被通告给其它EBGP。</li><li id="b6cf" class="nd ne it jw b jx nm kb nn mj no ml np mn nq kr nu nj nk nl bi translated">要执行第2步，ISP必须设置为无过滤，这意味着我们可以通告我们的所有路由</li></ol><h1 id="6ac1" class="lj lk it bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">结论</h1><p id="8e7a" class="pw-post-body-paragraph jt ju it jw b jx mh jz ka kb mi kd ke mj mk kh ki ml mm kl km mn mo kp kq kr im bi translated">总之，对我来说，无论是意外还是故意，理论上劫持和接管互联网是多么容易。ISP可以通过对客户设置过滤条件来限制可能被广告的路由，从而减少潜在的攻击。然而，这并不容易，也不是有效的任务。</p><p id="7c8f" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke mj kg kh ki ml kk kl km mn ko kp kq kr im bi translated">我对BGP的另一个担心是它的信任度。它只是传递信息包，而不验证接收者是谁。在未来探索BGP黑客攻击的可能防御和路由协议的改进将是令人感兴趣的。</p></div><div class="ab cl ol om hx on" role="separator"><span class="oo bw bk op oq or"/><span class="oo bw bk op oq or"/><span class="oo bw bk op oq"/></div><div class="im in io ip iq"><p id="42b4" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke mj kg kh ki ml kk kl km mn ko kp kq kr im bi translated">如果你们对BGP及其弱点有所了解，或者只是觉得这个博客很有趣，那么请点击“喜欢”按钮来表示你们对这篇文章的支持！这真的激励我去做更多😃。</p></div><div class="ab cl ol om hx on" role="separator"><span class="oo bw bk op oq or"/><span class="oo bw bk op oq or"/><span class="oo bw bk op oq"/></div><div class="im in io ip iq"><p id="5d2c" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke mj kg kh ki ml kk kl km mn ko kp kq kr im bi translated"><em class="jv">关注</em> <a class="ae ks" href="https://medium.com/bugbountywriteup" rel="noopener"> <em class="jv"> Infosec报道</em> </a> <em class="jv">获取更多此类精彩报道。</em></p><div class="os ot gp gr ou ov"><a href="https://medium.com/bugbountywriteup" rel="noopener follow" target="_blank"><div class="ow ab fo"><div class="ox ab oy cl cj oz"><h2 class="bd iu gy z fp pa fr fs pb fu fw is bi translated">信息安全报道</h2><div class="pc l"><h3 class="bd b gy z fp pa fr fs pb fu fw dk translated">收集了世界上最好的黑客的文章，主题从bug奖金和CTF到vulnhub…</h3></div><div class="pd l"><p class="bd b dl z fp pa fr fs pb fu fw dk translated">medium.com</p></div></div><div class="pe l"><div class="pf l pg ph pi pe pj ld ov"/></div></div></a></div></div></div>    
</body>
</html>