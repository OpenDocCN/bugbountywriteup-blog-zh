<html>
<head>
<title>Combining Hadoop and MCollective for total network compromise</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">结合Hadoop和MCollective实现全面网络妥协</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/combining-hadoop-and-mcollective-for-total-network-compromise-cda00429af27?source=collection_archive---------2-----------------------#2020-09-22">https://infosecwriteups.com/combining-hadoop-and-mcollective-for-total-network-compromise-cda00429af27?source=collection_archive---------2-----------------------#2020-09-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="5415" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是一个仅用两个不安全的配置就能让我们搞垮整个云托管公司的故事。对于一个相对较大的客户来说，这是一个灰箱测试，我们的任务是评估大约5个开发端点的安全性，只能使用客户端证书访问。设置好环境后，我们开始扫描端点，Nessus很快返回了一个可利用的漏洞:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/88eea5a4954ba5a9cd4024efc63146f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ai0-W17aW_cK-9ZpagSMoQ.png"/></div></div></figure><p id="678a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Hadoop公开了这个API来管理它的资源。应该进行身份验证，以防止匿名命令的执行。快速搜索ploit搜索返回了一个可用的RCE漏洞。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kx"><img src="../Images/f53e4dd79d7a7fd9bbff175264bab9d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FLAk4yyK4k1NDp5KtXf4Ew.png"/></div></div></figure><p id="6190" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">描述大概是这样的:</p><blockquote class="ky kz la"><p id="b171" class="jn jo lb jp b jq jr js jt ju jv jw jx lc jz ka kb ld kd ke kf le kh ki kj kk ij bi translated">该模块通过ResourceManager REST API利用了Apache Hadoop中未经验证的命令执行漏洞。</p></blockquote><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lf"><img src="../Images/bd65694f5be42fe4eb3f8b5cb279325f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FH5fszlOFM2v7YvyaRqawQ.png"/></div></div><figcaption class="lg lh gj gh gi li lj bd b be z dk translated">是的，那些被审查的名字都是系统管理员。</figcaption></figure><p id="c649" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">无论您何时在Hadoop环境中工作，都可以从以下两个优秀的资源开始(均来自wavestone):</p><ul class=""><li id="cc7d" class="lk ll iq jp b jq jr ju jv jy lm kc ln kg lo kk lp lq lr ls bi translated"><a class="ae lt" href="https://www.slideshare.net/phdays/hadoop-76515903" rel="noopener ugc nofollow" target="_blank">https://www.slideshare.net/phdays/hadoop-76515903</a></li><li id="2b33" class="lk ll iq jp b jq lu ju lv jy lw kc lx kg ly kk lp lq lr ls bi translated">【https://github.com/wavestone-cdt/hadoop-attack-library T2】号</li></ul><p id="3460" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这种情况下，我们已经通过YARN ResourceManager API控制了整个集群。引用Hadoop攻击库中的一段话:</p><blockquote class="ky kz la"><p id="324e" class="jn jo lb jp b jq jr js jt ju jv jw jx lc jz ka kb ld kd ke kf le kh ki kj kk ij bi translated">由于MapReduce作业的<strong class="jp ir">分布式本质，不可能指定您想要在哪个节点上执行您的有效负载。没有机制</strong>来确保您将在<strong class="jp ir">上启动的有效负载两个连续的作业</strong>将在<strong class="jp ir">同一个集群成员</strong>上执行。</p></blockquote><p id="ef46" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">基本上，您发送给API的每个命令都将被映射到一个随机节点。<br/>这实际上对我们是有益的，因为每次我们运行漏洞利用时，我们都会到达一个(可能)带有新信息的不同实例。当然，手动尝试每一种可能性并不是一个聪明的方法，所以让我们在一个随机的datanode上做一些枚举。</p><p id="7393" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用hdfs二进制文件可以从集群中获得大量信息。有用的报告可以通过以下方式查询</p><pre class="km kn ko kp gt lz ma mb mc aw md bi"><span id="5e24" class="me mf iq ma b gy mg mh l mi mj">hdfs dfsadmin -report</span></pre><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mk"><img src="../Images/975e58f71f6003db12cd3801dfcae179.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0dTM3U-TlsUGhqcZ-sqBhg.png"/></div></div></figure><p id="5f2b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好在我们没有尝试手动获取所有实例。他们有50个人！我们还从报告中看到，该群集有大量信息(大约70TB使用了90TB)。</p><h1 id="e9e4" class="ml mf iq bd mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh bi translated">提升权限</h1><p id="bc7e" class="pw-post-body-paragraph jn jo iq jp b jq ni js jt ju nj jw jx jy nk ka kb kc nl ke kf kg nm ki kj kk ij bi translated">在调用一个反向shell后，我们被一个运行YARN ResourceManager服务的低特权用户卡住了。我们试图寻找提升特权的方法</p><pre class="km kn ko kp gt lz ma mb mc aw md bi"><span id="8a21" class="me mf iq ma b gy mg mh l mi mj">sudo -l</span></pre><p id="c281" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">揭示了我们在项目中经常发现的一种配置方法:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nn"><img src="../Images/abd7bde941ef26103cd5845a9154586b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vVELylbuh6aM9LHKODeA9w.png"/></div></div></figure><p id="29b9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个sudoers条目基本上采用了黑名单方法，除了那些被明确拒绝的参数之外，允许服务命令使用它的所有参数。通常最好将你需要的加入白名单。快速浏览一下<a class="ae lt" href="https://gtfobins.github.io/gtfobins/service/" rel="noopener ugc nofollow" target="_blank"> gtfobins </a>将会告诉你，你可以使用类似</p><pre class="km kn ko kp gt lz ma mb mc aw md bi"><span id="76bb" class="me mf iq ma b gy mg mh l mi mj">sudo service ../../bin/sh</span></pre><p id="0c54" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您注意几段前的metasploit图像，您会看到我们在列出目录之前使用它来提升权限。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi no"><img src="../Images/97f72548eca732580bd46b34e78987e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:480/format:webp/1*bGBOIrvLr2_YdBH9f-MJDA.png"/></div></figure><p id="15e3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你不能打电话的原因</p><pre class="km kn ko kp gt lz ma mb mc aw md bi"><span id="c18f" class="me mf iq ma b gy mg mh l mi mj">service /bin/bash</span></pre><p id="fe15" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">服务二进制文件有一个查找服务配置文件的路径，类似于运行shell命令时的path变量。服务的手册页显示:</p><blockquote class="ky kz la"><p id="438b" class="jn jo lb jp b jq jr js jt ju jv jw jx lc jz ka kb ld kd ke kf le kh ki kj kk ij bi translated">描述<br/>服务在尽可能可预测的环境中运行System V init脚本或systemd单元，删除大多数环境变量和当前工作目录设置为/的<br/>。</p></blockquote><p id="dba3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">和</p><blockquote class="ky kz la"><p id="c17a" class="jn jo lb jp b jq jr js jt ju jv jw jx lc jz ka kb ld kd ke kf le kh ki kj kk ij bi translated">文件<br/> /etc/init.d <br/>包含System V init脚本的目录。</p><p id="47c5" class="jn jo lb jp b jq jr js jt ju jv jw jx lc jz ka kb ld kd ke kf le kh ki kj kk ij bi translated">/{lib、run等}/systemd/system <br/>包含systemd单元的目录。</p></blockquote><p id="c919" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它在/etc/init.d上查找System V init脚本。使用我们的有效负载，我们将得到如下结果:</p><pre class="km kn ko kp gt lz ma mb mc aw md bi"><span id="5264" class="me mf iq ma b gy mg mh l mi mj">service /etc/init.d/../../bin/bash</span></pre><p id="4cbb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这相当于</p><pre class="km kn ko kp gt lz ma mb mc aw md bi"><span id="05c5" class="me mf iq ma b gy mg mh l mi mj">service /bin/bash</span></pre><h1 id="3493" class="ml mf iq bd mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh bi translated">绕轴旋转</h1><p id="76c0" class="pw-post-body-paragraph jn jo iq jp b jq ni js jt ju nj jw jx jy nk ka kb kc nl ke kf kg nm ki kj kk ij bi translated">我们现在拥有对整个Hadoop集群的root访问权限。我们研究了改变访问权限的方法，但找不到任何方法。Ssh登录是通过公钥认证完成的，因此我们无法仿冒任何凭据来重复利用。网络扫描显示，集群已正确分段，除了一些管理服务器外，可见性有限。没有易受攻击的服务暴露在其他机器上，也没有脆弱的配置。</p><p id="ddbe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当然，我们在群集上有70 TB的信息，但这是与业务相关的数据，不太可能包含对我们的目的有用的配置信息。此外，要浏览数据湖，你必须:</p><ul class=""><li id="ddba" class="lk ll iq jp b jq jr ju jv jy lm kc ln kg lo kk lp lq lr ls bi translated"><a class="ae lt" href="https://github.com/wavestone-cdt/hadoop-attack-library/tree/master/Tools%20Techniques%20and%20Procedures/Browsing%20the%20HDFS%20datalake#webhdfs" rel="noopener ugc nofollow" target="_blank"> Hadoops WebHDFS API </a></li><li id="1557" class="lk ll iq jp b jq lu ju lv jy lw kc lx kg ly kk lp lq lr ls bi translated"><a class="ae lt" href="https://github.com/wavestone-cdt/hadoop-attack-library/tree/master/Tools%20Techniques%20and%20Procedures/Browsing%20the%20HDFS%20datalake#hadoop-cli" rel="noopener ugc nofollow" target="_blank"> Hadoop CLI </a></li></ul><p id="1975" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">而且都很难自动化。如果你读过<a class="ae lt" href="https://medium.com/bugbountywriteup/chaining-multiple-vulnerabilities-to-exfiltrate-over-250gb-of-pia-2d624f030ed1" rel="noopener">我的另一篇文章，</a>你就会知道分析大数据有多难。如果250GB的信息很难，那么70 TB就更不可能了。</p><p id="e95e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们正要放弃并展示这些发现时，想起了sudo -l下的一个禁止命令:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nn"><img src="../Images/522396882a74d2c2f32a05b0066d91cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35hwXIcTyZn53dGW4a5xTw.png"/></div></div></figure><blockquote class="ky kz la"><p id="f8ac" class="jn jo lb jp b jq jr js jt ju jv jw jx lc jz ka kb ld kd ke kf le kh ki kj kk ij bi translated">牵线木偶集合，也称为<strong class="jp ir"> MCollective </strong>，是一个用于构建服务器编排或并行作业执行系统的框架。</p></blockquote><p id="c939" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Puppet使用<a class="ae lt" href="https://puppet.com/docs/mcollective/current/index.html" rel="noopener ugc nofollow" target="_blank"> MCollective </a>来运行并行作业(同时在每个托管实例上运行作业)。它使用一个队列来发布作业，每个节点上的服务提取作业并同时运行它。这对于在大量实例上并发运行作业非常有用，在这些实例中,<a class="ae lt" href="https://www.ansible.com/" rel="noopener ugc nofollow" target="_blank"> Ansible </a>通过SSH使用的“迭代/顺序”方法会花费很长时间。</p><p id="019d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">了解这一点后，我们开始研究Mcollective的配置:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi np"><img src="../Images/a66345acfa0cf308231473e7b666b6cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1348/format:webp/1*Go2PyGhXTuvfo42c7TcqgQ.png"/></div></figure><p id="4392" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们看到有两台MCollective服务器具有相同的凭据。MCollective需要一个队列消息服务器，这个特定的客户端使用了<a class="ae lt" href="http://activemq.apache.org/" rel="noopener ugc nofollow" target="_blank"> ActiveMQ </a>，这是Apache的Java消息服务器。与大多数消息服务器一样，它基于队列工作。作为客户端，您订阅特定的队列，并接收发送到该队列的消息。</p><p id="8887" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们以前使用过这样的消息服务器(看看你的Kafka和RabbitMQ ),但从未专门与Puppet结合，所以我们搜索了配置教程。我们没找到多少，但我们遇到的第一个是来自<a class="ae lt" href="https://www.oreilly.com/library/view/managing-infrastructure-with/9781449309671/ch04.html" rel="noopener ugc nofollow" target="_blank">奥赖利</a>的。在本文中，它为两个不同的用户配置权限:</p><ul class=""><li id="6ec7" class="lk ll iq jp b jq jr ju jv jy lm kc ln kg lo kk lp lq lr ls bi translated">管理</li><li id="e2e0" class="lk ll iq jp b jq lu ju lv jy lw kc lx kg ly kk lp lq lr ls bi translated">mcollective</li></ul><p id="c80f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">顾名思义，admin用户将用于发布消息，mcollective用户将用于读取队列。理想情况下，admin用户应该有完全访问权限，而mcollective应该只有读取权限，对吗？嗯不…</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nq"><img src="../Images/551ec5c74d4dfb24ae4ebf7a26ef70f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AxTgjDvIBtvFIM4B2fu_0w.png"/></div></div></figure><p id="51ab" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">用户mcollective拥有对mcollective队列</strong>的写权限！也许我们可以利用这一点？</p><p id="4df8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们安装了MCollective，复制了server.cfg，开始了我们的测试。首先，我们尝试使用<a class="ae lt" href="https://puppet.com/docs/mcollective/current/reference/basic/basic_cli_usage.html" rel="noopener ugc nofollow" target="_blank"> mco find </a>列出由MCollective管理的实例。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nr"><img src="../Images/8430dfc9cd8ca320b600317ac70b869e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mfvFWhr64Y74RDFe_bAINA.png"/></div></div></figure><p id="ba1d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">只有79例..让我们尝试用另一个命令来验证。我们还可以使用<a class="ae lt" href="https://puppet.com/docs/mcollective/current/reference/basic/basic_cli_usage.html" rel="noopener ugc nofollow" target="_blank"> mco ping </a>来发现实例。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ns"><img src="../Images/cc0e5408b2d1bae14f3de16ed638de0d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8vY7COWltPfF6fQ4eMXgEw.png"/></div></div></figure><p id="77c7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">根据这些结果，我们可以假设可能存在涉及超时的网络问题。ping命令返回了1695个实例，远远多于前79个，再次运行后，我们只返回了1085个。如果我们看看超时，它接近5000毫秒。这可能是默认超时，其他实例需要更长时间来重放。让我们大幅增加超时时间，看看我们会得到什么:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nt"><img src="../Images/4e66c1c66e35b460d11356eb34282f6f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UH6L2K7I10zRfgJHfu1wpQ.png"/></div></div></figure><p id="1f0f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">太好了！这看起来是个更好的结果。12514个实例，其中一些需要长达24秒的时间来回复。</p><blockquote class="ky kz la"><p id="e9f0" class="jn jo lb jp b jq jr js jt ju jv jw jx lc jz ka kb ld kd ke kf le kh ki kj kk ij bi translated">有趣的事实:在pentest之后，我们能够与一位系统管理员交谈，他建议我们将-t(命令运行的超时时间)改为- dt(发现超时时间，或者代理等待订阅者获取消息的时间)。我们试了一下，效果也不错(并修复了查找输出)</p></blockquote><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nu"><img src="../Images/733b91f2716fce4ebeb538e937860afc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yWxqB-mvwqfscVty_-0xUQ.png"/></div></div></figure><p id="253b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们可以看到实例了，让我们试着执行一个命令。为了做到这一点，我们需要shellcmd插件。这不是唯一的选择，但这是我们的客户正在使用的一个。为了验证我们的访问权限，我们使用以下语法在单个实例中运行了一个命令:</p><pre class="km kn ko kp gt lz ma mb mc aw md bi"><span id="2e5d" class="me mf iq ma b gy mg mh l mi mj">mco shellcmd -I hostname 'ifconfig' -c server.cfg</span></pre><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nv"><img src="../Images/880c4fecf04540260c655155dc2e38d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CRcfv82ObIkhhFM_Yod8pg.png"/></div></div></figure><p id="df3b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们有命令执行！我们基本上控制了所有的12000个实例。</p><h1 id="2708" class="ml mf iq bd mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh bi translated">修理</h1><p id="fabc" class="pw-post-body-paragraph jn jo iq jp b jq ni js jt ju nj jw jx jy nk ka kb kc nl ke kf kg nm ki kj kk ij bi translated">解决此问题的理想方法是限制ActiveMQ权限，为mcollective用户指定只读访问权限，但是在阅读OReilly的网站时，我们发现了以下消息:</p><blockquote class="ky kz la"><p id="3781" class="jn jo lb jp b jq jr js jt ju jv jw jx lc jz ka kb ld kd ke kf le kh ki kj kk ij bi translated"><strong class="jp ir"> <em class="iq">警告<br/> </em> </strong>这些配置文件包含可用于向MCollective通道发布命令的秘密。MCollective服务器必须以root用户身份运行，并以完全权限执行。小心控制对秘密和Stomp服务器的访问是非常重要的。</p></blockquote><p id="774c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此外，MCollective在Puppet 5.5.4中已被弃用。我们客户的基础设施注定要更新，他们选择了<a class="ae lt" href="https://choria.io/docs/about/" rel="noopener ugc nofollow" target="_blank"> Choria，这是更新的MCollective的分支</a>。</p><p id="aba6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有了Choria，你可以使用一个<a class="ae lt" href="https://github.com/choria-plugins/action-policy" rel="noopener ugc nofollow" target="_blank">动作策略插件</a>，它允许你为每个插件定义自定义规则。引用其文档:</p><blockquote class="ky kz la"><p id="fcc0" class="jn jo lb jp b jq jr js jt ju jv jw jx lc jz ka kb ld kd ke kf le kh ki kj kk ij bi translated">策略在类似<code class="fe nw nx ny ma b">&lt;configdir&gt;/policies/&lt;agent&gt;.policy</code>的文件中定义</p></blockquote><p id="759c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以你必须定义这样的东西</p><pre class="km kn ko kp gt lz ma mb mc aw md bi"><span id="29a2" class="me mf iq ma b gy mg mh l mi mj">/etc/puppetlabs/mcollective/policies/shellcmd.policy</span></pre><p id="f269" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">包含以下内容:</p><pre class="km kn ko kp gt lz ma mb mc aw md bi"><span id="de7f" class="me mf iq ma b gy mg mh l mi mj">policy default deny</span><span id="1425" class="me mf iq ma b gy nz mh l mi mj"># site wide policies<br/>allow choria=admin.mcollective choria=mco.mcollective * * *</span></pre><p id="762c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第一行建立了关于这个插件的默认策略。另一行使用以下语法:</p><p id="dc45" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">允许/拒绝+来电显示+操作+事实+类别</p><p id="0daa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">基本上，我们的线授予mco用户和admin用户在所有服务器上运行所有命令的权限。任何其他用户都会收到这样的消息:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi oa"><img src="../Images/9bbdf2ff56d9f1390170631894b9e7a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1210/format:webp/1*PwgrJSYCaG6jc-1jGlEp4w.png"/></div><figcaption class="lg lh gj gh gi li lj bd b be z dk translated">拒绝行动</figcaption></figure><h1 id="ea24" class="ml mf iq bd mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh bi translated">包扎</h1><p id="60d4" class="pw-post-body-paragraph jn jo iq jp b jq ni js jt ju nj jw jx jy nk ka kb kc nl ke kf kg nm ki kj kk ij bi translated">无论何时，当你试图在一个网络中(或者提升权限)时，试着像一个系统管理员一样思考！如果您熟悉编排技术，您也许能够利用这些工具。即使你不是(就像我们使用MCollective一样)，也要从你的狂热中休息一下，去读一下这个工具的文档。总是确保找到至少2或3个不同的教程。这些可能会给你一些如何“创造性地”使用工具的新想法。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="ob oc l"/></div><figcaption class="lg lh gj gh gi li lj bd b be z dk translated">我找不到埃利奥特眨眼睛的GIF，但足够接近了。</figcaption></figure><p id="cb13" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">另外，请花时间查看位于/etc；中的服务配置文件。它们通常包含有用的信息，可以让你更好地了解自己的位置，以及这台机器的用途。这应该是本地枚举过程中的一个标准步骤。</p></div></div>    
</body>
</html>