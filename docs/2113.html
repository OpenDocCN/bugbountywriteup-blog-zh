<html>
<head>
<title>Enumeration and lateral movement in GCP environments</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GCP环境中的计数和横向运动</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/enumeration-and-lateral-movement-in-gcp-environments-c3b82d342794?source=collection_archive---------0-----------------------#2022-06-01">https://infosecwriteups.com/enumeration-and-lateral-movement-in-gcp-environments-c3b82d342794?source=collection_archive---------0-----------------------#2022-06-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="d447" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这篇文章是关于我们做的一个pentest，在这个测试中，我们使用GCP本地工具来实现情景感知和横向移动，成功地折衷了混合GCP托管的基础架构。</p><p id="cda8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我们继续之前，我想声明我们没有想到很多我将要解释的东西，它们可以在两篇优秀的文章中找到。一篇来自<a class="ae kl" href="https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/" rel="noopener ugc nofollow" target="_blank"> Gitlab的红队</a>，另一篇来自<a class="ae kl" href="https://medium.com/@tomaszwybraniec/google-cloud-platform-pentest-notes-service-accounts-b960dc59d93a" rel="noopener">媒体博客</a>作者<a class="km kn ep" href="https://medium.com/u/37464751a36c?source=post_page-----c3b82d342794--------------------------------" rel="noopener" target="_blank">托马斯W. </a>我推荐在继续之前阅读这两篇文章！</p><h1 id="3218" class="ko kp iq bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">最初的妥协</h1><p id="7dfc" class="pw-post-body-paragraph jn jo iq jp b jq lm js jt ju ln jw jx jy lo ka kb kc lp ke kf kg lq ki kj kk ij bi translated">我将简要介绍我们是如何在公司网络中立足的。在进行了初步的侦察，并在范围内收集了感兴趣的ip后，对相邻IP地址空间的激烈扫描返回了一个<a class="ae kl" href="https://www.scriptcase.net/" rel="noopener ugc nofollow" target="_blank"> scriptcase服务器</a>(我们后来确认这是有人在测试后忘记删除的阴影云)。</p><figure class="ls lt lu lv gt lw gh gi paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="gh gi lr"><img src="../Images/53f269cbf9b004f8e36e2206f1d790a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*adl6bUPcL3wRPoHRqOsxGw.png"/></div></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated">(在任何人试图访问之前，出于隐私原因，ip地址和端口已被更改)</figcaption></figure><p id="b9d7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在强制服务一段时间后，我们发现了admin帐户的琐碎凭证，并能够从实例内部运行回调脚本。</p><figure class="ls lt lu lv gt lw gh gi paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="gh gi mh"><img src="../Images/40547f0d1b2eeb8041ed8a18e0cc33bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wtq2KM0H6gz1EILJ0YwK7w.png"/></div></div></figure><p id="d6ba" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我不打算详细说明，因为pentest的这一部分对客户来说是独一无二的，对读者来说可能没什么用处。</p><h1 id="107f" class="ko kp iq bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">枚举和权限提升</h1><p id="2cb8" class="pw-post-body-paragraph jn jo iq jp b jq lm js jt ju ln jw jx jy lo ka kb kc lp ke kf kg lq ki kj kk ij bi translated">我们使用运行scriptcase服务的守护程序帐户登录到该实例。每当您在特定的云环境中着陆时，使用环境提供的本机工具来执行初始枚举总是一个好主意(例如aws中的aws-cli提供的aws二进制文件，或者GCP的gcloud/gutils)。这是我们首先尝试的事情之一。</p><figure class="ls lt lu lv gt lw gh gi paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="gh gi mi"><img src="../Images/540d1853275bd21847fb76e51377816f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LXw90kWGVc2KZfrdrWhbEA.png"/></div></div></figure><p id="5b84" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">哼。首要问题。似乎守护程序帐户没有权限创建运行gcloud二进制文件所需的大量文件夹。也许我们应该尝试手动下载二进制文件，并从tmp文件夹中运行它。让我们检查一下我们的帐户是如何在/etc/passwd(默认shell、主目录等)上配置的..).</p><figure class="ls lt lu lv gt lw gh gi paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="gh gi mj"><img src="../Images/609fcb94fffbba93cc3ec1b8c58124a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5c9QScBCGK4DPDnRThKSDA.png"/></div></div></figure><p id="a369" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是需要解决的问题。我们的缺省shell是nologin(这是大多数服务帐户的标准，因为它们不打算交互使用)，我们的主目录是/usr/sbin，我们不能访问它(否则提升我们的特权是微不足道的)。gcloud二进制文件需要一个主文件夹来创建我们的配置文件，所以让我们给它一个主文件夹并手动运行独立的安装程序。</p><figure class="ls lt lu lv gt lw gh gi paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="gh gi mk"><img src="../Images/6d5db9e99a6ece7f4cf173c5dd8e3496.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cUb6fEbHuJwg8sgE7_0f8A.png"/></div></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated">设置我们的家和下载gcloud。</figcaption></figure><figure class="ls lt lu lv gt lw gh gi paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="gh gi ml"><img src="../Images/5ed35881d8e657953d3b29752c15dbbf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2QdfUloqQOm_-2FVB2Hnjw.png"/></div></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated">正在安装二进制文件。</figcaption></figure><figure class="ls lt lu lv gt lw gh gi paragraph-image"><div class="gh gi mm"><img src="../Images/02f38ec0c50f00f4aead7e740d40dacc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1166/format:webp/1*w55WVkJpYvQ4X2mAc3L6dg.png"/></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated">Gcloud已成功安装。</figcaption></figure><p id="8283" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">成功！这涉及到几个步骤，但我们设法让GCP的本地工具在一个有点受限的环境中工作。</p><figure class="ls lt lu lv gt lw"><div class="bz fp l di"><div class="mn mo l"/></div></figure><p id="8312" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们已经可以访问二进制文件了，让我们尝试枚举我们的服务帐户角色。重要的是要记住，无论何时在GCP创建一个实例，它都需要有一个关联的服务帐户，因此默认情况下会为您创建一个。我们可以列举我们的角色:</p><pre class="ls lt lu lv gt mp mq mr ms aw mt bi"><span id="55c8" class="mu kp iq mq b gy mv mw l mx my">PROJECT=$(curl http://metadata.google.internal/computeMetadata/v1/project/project-id -H “Metadata-Flavor: Google” -s)<br/>ACCOUNT=$(curl http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/email -H “Metadata-Flavor: Google” -s)<br/>gcloud projects get-iam-policy $PROJECT --flatten=”bindings[].members” --format=’table(bindings.role)’ --filter=”bindings.members:$ACCOUNT”</span></pre><p id="4d85" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">(如果您使用的是本地安装的二进制文件，记得替换您的gcloud路径:例如/tmp/Google-cloud-SDK/bin/g cloud)</p><figure class="ls lt lu lv gt lw gh gi paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="gh gi mz"><img src="../Images/f01e22fb22b26ec3e893824cb2200f06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8qb_xOylh2Vws0GKXwOfKA.png"/></div></div></figure><p id="c735" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">编辑者角色是与服务帐户相关联的默认角色，它允许拥有特权。让我们尝试修改实例元数据来注入ssh密钥(这种方法默认在我在开头链接的gitlab文章中解释)。首先，让我们检查一下是否已经有一些我们可以替换的用户密钥。让我们用</p><pre class="ls lt lu lv gt mp mq mr ms aw mt bi"><span id="07b0" class="mu kp iq mq b gy mv mw l mx my">INSTANCEID=$(curl http://metadata.google.internal/computeMetadata/v1/instance/id -H “Metadata-Flavor:Google” -s)<br/>FULLZONE=$(curl http://metadata.google.internal/computeMetadata/v1/instance/zone -H “Metadata-Flavor: Google” -s)<br/>gcloud compute instances describe $INSTANCEID --zone $FULLZONE</span></pre><figure class="ls lt lu lv gt lw gh gi paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="gh gi na"><img src="../Images/6b4a45e4ab948d9cd5c26ecd1aa19952.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Yx5it32aokhXGUM8T6mF3w.png"/></div></div></figure><figure class="ls lt lu lv gt lw gh gi paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="gh gi nb"><img src="../Images/f155a1700f34c5986c73ce13b6b7cc97.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eCFq5tSLDsiZS--5sgqjpA.png"/></div></div></figure><p id="b9c8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个实例元数据中似乎没有任何ssh密钥。仅供参考，这是取自项目中另一个实例的外观:</p><figure class="ls lt lu lv gt lw gh gi paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="gh gi nc"><img src="../Images/95fe08a6f47c450e113de5ed4bc6a4f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Tjv1h7N3ELgTmb-gpsq5zQ.png"/></div></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated">(钥匙也换了，别激动)</figcaption></figure><p id="6e71" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在两个图像中，我们都有一点重要的信息:下面一行指定正在使用oslogin:</p><pre class="ls lt lu lv gt mp mq mr ms aw mt bi"><span id="49b6" class="mu kp iq mq b gy mv mw l mx my">-key: enable-oslogin </span></pre><p id="2abc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们稍后将回到这一点。现在，让我们尝试将我们的键注入实例元数据:</p><pre class="ls lt lu lv gt mp mq mr ms aw mt bi"><span id="76b6" class="mu kp iq mq b gy mv mw l mx my">ssh-keygen -t rsa -C “shenanigans” -f ./key -P “” &amp;&amp; cat ./key.pub<br/>gcloud compute instances add-metadata instance012 --metadata-from-file ssh-keys=meta.txt</span></pre><figure class="ls lt lu lv gt lw gh gi paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="gh gi nd"><img src="../Images/d7a20aa1dd10af16a3695021e8e2662f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qIXzkys9HqCRvx_6_fWW2w.png"/></div></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated">创造我们的钥匙。</figcaption></figure><figure class="ls lt lu lv gt lw gh gi paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="gh gi ne"><img src="../Images/b08d3541c8291797dfb8d6b004fedd73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VnHRwBTpjSbXZOHol1pNtQ.png"/></div></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated">将它们注入到我们的元数据中。</figcaption></figure><figure class="ls lt lu lv gt lw gh gi paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="gh gi nf"><img src="../Images/456aa63ab616edae4b5c9a7852cb863e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EFthotnjou2L17eQtKt0ig.png"/></div></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated">尝试一下。</figcaption></figure><p id="2685" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们发现的第二个问题是。我们的ssh密钥似乎不起作用。让我们验证它们是否存在:</p><figure class="ls lt lu lv gt lw gh gi paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="gh gi ng"><img src="../Images/adbc1c61d7653d78401666b5de5e3178.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rNMRKRjHJljPy1HUpbGQrg.png"/></div></div></figure><p id="9ce3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">是的，都在那里。一定还有别的东西阻止我们登录。还记得我们说过操作系统登录很重要吗？嗯，这家公司为ssh登录配置了强制的2FA，我们没有为我们的帐户创建第二个因子。我们需要找到绕过它的方法。如果你关注过Gitlab的文章，他们解释说2FA的要求对于服务账户是不强制的。请记住，我们是作为gcloud compute instance服务帐户运行的(您可以使用auth命令查看是哪个帐户):</p><pre class="ls lt lu lv gt mp mq mr ms aw mt bi"><span id="6c28" class="mu kp iq mq b gy mv mw l mx my">gcloud auth list</span></pre><figure class="ls lt lu lv gt lw gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/d7dac53b76f33fcc2f24d29fc6c5b8d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1350/format:webp/1*r6AvgPZnjCAn2_WKCqUT2Q.png"/></div></figure><p id="b362" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">GCP的另一个很酷的特性是，从compute API运行ssh命令将为您的服务帐户创建密钥，将它们注入目标实例(在本例中是localhost ),并允许您加入sudoers组，所有这些都是默认的。让我们试一试:</p><pre class="ls lt lu lv gt mp mq mr ms aw mt bi"><span id="b82b" class="mu kp iq mq b gy mv mw l mx my">gcloud compute ssh $INSTANCENAME</span></pre><figure class="ls lt lu lv gt lw gh gi paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="gh gi ni"><img src="../Images/3c397e595de46bdf370b1533da7d133a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kdTnChtOkkzCvinP-P2t7g.png"/></div></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated">创造我们的钥匙并注入它们</figcaption></figure><figure class="ls lt lu lv gt lw gh gi paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="gh gi nj"><img src="../Images/bdc9872bfbc46a9aa8edf49bf1af7cd4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7doGrkFLYuedQesV4niREA.png"/></div></div></figure><p id="8ac8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们成功地提升了我们的特权。现在，让我们横向移动。</p><h1 id="9b9d" class="ko kp iq bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">横向运动</h1><figure class="ls lt lu lv gt lw"><div class="bz fp l di"><div class="nk mo l"/></div></figure><p id="3c3b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以从列举项目中的实例开始:</p><blockquote class="nl nm nn"><p id="95fe" class="jn jo no jp b jq jr js jt ju jv jw jx np jz ka kb nq kd ke kf nr kh ki kj kk ij bi translated"><em class="iq"> gcloud计算实例列表</em></p></blockquote><figure class="ls lt lu lv gt lw gh gi paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="gh gi ns"><img src="../Images/ded9a4c4811566eefa9a8bd4f59705fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qHq9cVoqu9d3GOpHMRkNmQ.png"/></div></div></figure><p id="5dcc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">ssh命令应该也适用于其他实例。</p><figure class="ls lt lu lv gt lw gh gi paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="gh gi nt"><img src="../Images/41606ab2f9fd05583aae15e764ed9c94.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nodqZZS4LUBA8CPH7KPqcg.png"/></div></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated">一个实例完成了，还有三个</figcaption></figure><p id="39bd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是由于某种原因，部分实例没有响应我们的ssh命令:</p><figure class="ls lt lu lv gt lw gh gi paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="gh gi nu"><img src="../Images/f69b31e2358e578704b3e40ddaada1c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hgjF605qf8B9rmrkvvEDIw.png"/></div></div></figure><p id="1921" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在做了一个快速的端口扫描后，我们发现这个项目既有Linux机器也有Windows机器。</p><figure class="ls lt lu lv gt lw gh gi paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="gh gi nv"><img src="../Images/9327ef6bd74f2861b66150b890352b47.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CE_jXV5EDnMOHnpWgsVXsw.png"/></div></div></figure><p id="7bf1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是一个简单的故障诊断，但是扫描实例并不总是确定其操作系统的最佳方式。你可能正在执行一个红队任务，并且可能有一个IDS监视扫描。您可能手头没有nmap(您可能只需要telneting连接端口或使用socat或类似工具，但这很不方便)。或者您可能希望自动化该过程的某个部分。无论哪种方式，我们试图通过谷歌的API找到查询的方法，没有简单的方法可以做到这一点，除非你非常幸运地为你启用了alpha compute API(我们从未见过IRL)。</p><p id="80e6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">幸运的是，有一个变通办法:当您查询实例信息时，您可以从JSON结果中获得的参数之一是许可信息。这应该允许您推断出实例OS。我们可以使用以下内容对此进行查询:</p><pre class="ls lt lu lv gt mp mq mr ms aw mt bi"><span id="9913" class="mu kp iq mq b gy mv mw l mx my">INSTANCES=$(gcloud compute instances list — format=json | jq -r .[].name)<br/>ZONE=$(curl http://metadata.google.internal/computeMetadata/v1/instance/zone -H “Metadata-Flavor: Google” -s | cut -d/ -f4)<br/>for i in $(echo $INSTANCES); do echo “$i:” &amp;&amp; gcloud compute instances describe g-shr-scriptcase-01 --zone $ZONE --format=json | jq -r .disks[].licenses[] | rev | cut -d / -f 1 | rev &amp;&amp; echo; done</span></pre><figure class="ls lt lu lv gt lw gh gi paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="gh gi nw"><img src="../Images/bcdaa76b8b791cd871b35e4d6f7c70ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FcbNOXYnuFLtDQAfQ0OeAg.png"/></div></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated">基于许可记录枚举操作系统信息</figcaption></figure><p id="20bb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">了解一个实例的操作系统是很重要的，但是我们如何真正转向Windows主机呢？我们有一个类似于“计算ssh”的命令，但是是针对windows的。这在<a class="km kn ep" href="https://medium.com/u/37464751a36c?source=post_page-----c3b82d342794--------------------------------" rel="noopener" target="_blank">托马什</a> <a class="ae kl" href="https://medium.com/@tomaszwybraniec/google-cloud-platform-pentest-notes-service-accounts-b960dc59d93a" rel="noopener">篇</a>上有解释。你能做到</p><pre class="ls lt lu lv gt mp mq mr ms aw mt bi"><span id="2a7e" class="mu kp iq mq b gy mv mw l mx my">gcloud compute reset-windows-password g-xbz-qlikview-01 --user=shenanigans</span></pre><figure class="ls lt lu lv gt lw gh gi paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="gh gi nw"><img src="../Images/7fe766653e8a1ef1af80beb2079d81da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Cd9xjmjzGt4lWablm8DgUg.png"/></div></div></figure><p id="7a12" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在proxychains上快速定义代理之后，我们应该能够使用新创建的用户rdp到实例中:</p><pre class="ls lt lu lv gt mp mq mr ms aw mt bi"><span id="2385" class="mu kp iq mq b gy mv mw l mx my">proxychains4 xfreerdp /u:shenanigans /p:’;QfJt@fJt\fJtHfJt4)L’ /v:172.21.31.8</span></pre><figure class="ls lt lu lv gt lw gh gi paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="gh gi nx"><img src="../Images/6e0bc53291046d136985f9f17c26c43a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O7urhg-a65UHAtdGI8kYLw.png"/></div></div></figure><figure class="ls lt lu lv gt lw gh gi paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="gh gi ny"><img src="../Images/1e0f3cb7d6f642612859835639071c12.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TfECjC9rzvTN9xehW4XQow.png"/></div></div></figure><figure class="ls lt lu lv gt lw gh gi paragraph-image"><div class="gh gi nz"><img src="../Images/c0c3bca016c039d3f281c9266064c140.png" data-original-src="https://miro.medium.com/v2/resize:fit:968/format:webp/1*M7OLOUDcTeLeQ0JHmk6SrQ.png"/></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated">*黑客声音*“我们进来了”</figcaption></figure><h1 id="4572" class="ko kp iq bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">结论</h1><p id="11ed" class="pw-post-body-paragraph jn jo iq jp b jq lm js jt ju ln jw jx jy lo ka kb kc lp ke kf kg lq ki kj kk ij bi translated">在设置您的云基础架构时，重要的是要意识到这样一个事实，即一些配置在默认情况下可能不是100%安全的。在安全性和可用性之间总是有一场持续的斗争，有时天平倾向于后者。尤其是当默认情况下您有单个命令来执行以下操作时:</p><ul class=""><li id="e47b" class="oa ob iq jp b jq jr ju jv jy oc kc od kg oe kk of og oh oi bi translated">为您创建ssh密钥</li><li id="dfc4" class="oa ob iq jp b jq oj ju ok jy ol kc om kg on kk of og oh oi bi translated">将它们注入到目标实例中</li><li id="0e08" class="oa ob iq jp b jq oj ju ok jy ol kc om kg on kk of og oh oi bi translated">将您的密钥添加到该实例</li><li id="d45b" class="oa ob iq jp b jq oj ju ok jy ol kc om kg on kk of og oh oi bi translated">将您添加到sudoers组</li></ul><p id="e23e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">(对于那些没有注意的人，这里是我所说的命令)</p><pre class="ls lt lu lv gt mp mq mr ms aw mt bi"><span id="ccb7" class="mu kp iq mq b gy mv mw l mx my">gcloud compute ssh $INSTANCENAME</span></pre><p id="379a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我之前也提到过，但我想重申一下，我的这篇文章有很多参考资料，但其中两个最有用的是:</p><p id="1c9e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">- <a class="ae kl" href="https://medium.com/@tomaszwybraniec/google-cloud-platform-pentest-notes-service-accounts-b960dc59d93a" rel="noopener">托马斯·w的这些五旬节笔记</a> <br/> - <a class="ae kl" href="https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/" rel="noopener ugc nofollow" target="_blank">本文由克里斯·莫伯利</a>撰写</p><p id="dae4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">去读读吧，它们很棒。</p></div></div>    
</body>
</html>