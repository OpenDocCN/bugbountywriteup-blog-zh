<html>
<head>
<title>The Importance of Infrastructure as Code Security Scanning</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">基础设施作为代码安全扫描的重要性</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/the-importance-of-infrastructure-as-code-security-scanning-7add9e8dbb06?source=collection_archive---------0-----------------------#2022-10-07">https://infosecwriteups.com/the-importance-of-infrastructure-as-code-security-scanning-7add9e8dbb06?source=collection_archive---------0-----------------------#2022-10-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/1487334aa5f84e64040dfa588014d351.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6c1aRa4E2aHnWkap0XFdBw.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">来自Pixabay的标题</figcaption></figure><h1 id="2144" class="kc kd iq bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">将基础设施用作代码而不进行安全测试的问题是</h1><p id="77f1" class="pw-post-body-paragraph la lb iq lc b ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ij bi translated">如今，大多数(如果不是所有的话)公司都看到了通过基础设施即代码(IAC)部署基础设施的价值，无论是Terraform、AWS CDK还是Cloudformation、Azure RM Templates或其他。然而，我敢打赌，并不是所有的组织都在实现或者甚至考虑为他们的IAC代码添加任何安全性测试。云错误配置正成为恶意实体违规的常见根本原因。对整个互联网开放防火墙的公共S3桶和计算实例只是工程师可以部署的许可配置的几个例子。如果你不小心的话，这些错误的配置会让你的公司损失数万亿美元。</p><p id="a942" class="pw-post-body-paragraph la lb iq lc b ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt md lv lw lx ij bi translated">你可能已经看过我以前的<a class="ae ly" href="https://www.linkedin.com/pulse/how-protect-your-google-cloud-organization-from-security-santos/?trackingId=o%2BqSeu3MROeKgHUb%2BAPMrA%3D%3D" rel="noopener ugc nofollow" target="_blank">文章</a>，关于谷歌云中自动修复的重要性，以及自动修复如何帮助你检测和应对通过你的安全大门的错误配置。在这篇文章中，我将后退一步，谈谈在IAC开发生命周期中增加安全性的重要性，以帮助在部署到云环境之前防止错误配置。</p><h1 id="c80b" class="kc kd iq bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">我们如何将基础设施扫描为错误配置的代码？</h1><p id="b853" class="pw-post-body-paragraph la lb iq lc b ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ij bi translated">有许多工具，包括开源的、免费的和付费的，可以帮助你扫描你的IAC模板，找出不需要的配置。一些例子是Aquasec的<a class="ae ly" href="https://github.com/aquasecurity/tfsec" rel="noopener ugc nofollow" target="_blank"> tfsec </a>，Snyk <a class="ae ly" href="https://snyk.io/product/infrastructure-as-code-security/" rel="noopener ugc nofollow" target="_blank"> IAC </a>，Palo Alto Bridgecrew的<a class="ae ly" href="https://www.checkov.io/" rel="noopener ugc nofollow" target="_blank"> Checkov </a>，Checkmarx的<a class="ae ly" href="https://kics.io/" rel="noopener ugc nofollow" target="_blank"> KICS </a>，<a class="ae ly" href="https://github.com/datreeio/datree" rel="noopener ugc nofollow" target="_blank"> datree </a>，以及随Terraform Cloud/Enterprise软件包提供的Hashicorp的<a class="ae ly" href="https://www.terraform.io/cloud-docs/sentinel" rel="noopener ugc nofollow" target="_blank"> Sentinel </a>。所有这些工具都可以帮助我们防止IAC配置错误。</p><p id="2617" class="pw-post-body-paragraph la lb iq lc b ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt md lv lw lx ij bi translated">首先，请记住下面的工作流，它展示了一种非常简单的方法，在添加安全性之前，我们可以在云中端到端地部署IAC。我们将讨论端到端工作流中可以集成安全性测试的三个不同领域。我们还将在不同领域使用此<a class="ae ly" href="https://github.com/donsantos/dvtf" rel="noopener ugc nofollow" target="_blank">回购</a>作为示例。</p><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi me"><img src="../Images/5ef5cdc92ffb88c48ba4ff4cdec18bf9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MuuPlURfpFgoKDeJBVx9mw.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">简单的IAC工作流程</figcaption></figure><h1 id="e45d" class="kc kd iq bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">在工作站(CLI、IDE等)中本地扫描源代码。)</h1><p id="8f95" class="pw-post-body-paragraph la lb iq lc b ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ij bi translated">让我们从本地扫描源代码开始。作为一个安全组织，我们的工作是尽可能减少安全漏洞。一种方法是启用将要部署的IAC工程师。如果我们看一下上面的工作流程，它是从工程师开始的。我们可以为工程师提供工具，让他们能够从工作站直接扫描IAC。Aquasec的tfsec是使用命令行界面(CLI)测试IAC的一个很好的例子。拥有一个可以在本地扫描IAC的工具，工程师就可以按需运行自助扫描。通过为工程师提供像tfsec这样的自助服务工具，安全团队也可以从中受益，减少提交给源代码管理(SCM)工具的安全错误配置。</p><p id="fd77" class="pw-post-body-paragraph la lb iq lc b ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt md lv lw lx ij bi translated">下面是在我的工作站的CLI中针对示例Terraform repo本地运行的tfsec的输出示例。</p><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mj"><img src="../Images/170e8e490e6fb25b8128ef4bdcf4c58b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QmKcBgaV4M_cu1-0-F1GYA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">tfsec CLI的输出</figcaption></figure><p id="ed39" class="pw-post-body-paragraph la lb iq lc b ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt md lv lw lx ij bi translated">Tfsec在显示哪些Terraform资源可能违反安全策略方面做得很好。在上面的例子中，我们可以看到tfsec选择了没有配置为需要SSL的cloudsql实例，并且它被授予了公共internet访问权限。这些只是安全团队不一定想要的一些控件。这些工具还提供了一些关于这些发现意味着什么的有用信息，以及如何保护资源的示例。</p><p id="1ed8" class="pw-post-body-paragraph la lb iq lc b ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt md lv lw lx ij bi translated">这个例子完成后，我们可以在工作流中指出我们可以实现第一层防御的地方，如下所示。</p><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi me"><img src="../Images/a066ecaede1abcf9b9aa7a3c44ddf7c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CbxaRpBqj-92gDhgYnE_Qw.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">IAC工作流程中的第一道防线</figcaption></figure><h1 id="a89c" class="kc kd iq bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">直接从你的SCM (Github，Bitbucket，Gitlab等)扫描源代码。)</h1><p id="284d" class="pw-post-body-paragraph la lb iq lc b ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ij bi translated">有像Snyk这样的工具可以和你的配置管理工具集成。现在，Snyk不仅仅是IAC的工具，它还可以用来扫描应用程序代码、工件和容器注册表。Snyk还可以集成到持续集成工具，以及VSCode或Sublime之类的ide中。下面是Snyk可以集成的配置管理工具的片段。</p><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mk"><img src="../Images/d1c734ffc145e9baf3478c587486bce8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mjoutt60B946_y4BSlO1eg.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">Snyk可用的SCM集成</figcaption></figure><p id="e03c" class="pw-post-body-paragraph la lb iq lc b ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt md lv lw lx ij bi translated">使用包含易受攻击的Terraform代码的示例repo，下面是Snyk IAC扫描的结果，Snyk显示我们的Google Cloud SQL实例没有强制使用SSL，也没有配置IAM。Snyk也很好地展示了这种配置的影响以及我们如何解决它。</p><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ml"><img src="../Images/a45112452b99bcf4f2d17ac9c92cf11b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NaBe28GOiddFSdQ9AFdSlg.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">未针对CloudSQL配置Cloud IAM的Snyk控制台输出</figcaption></figure><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ml"><img src="../Images/96bc6efa52610fc30de5cf1b5b766935.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yyr6knWpmPs9A17N1zAIUQ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">没有为CloudSQL启用SSL的Snyk控制台输出</figcaption></figure><p id="cd7f" class="pw-post-body-paragraph la lb iq lc b ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt md lv lw lx ij bi translated">将SCM直接集成到像Snyk这样的IAC扫描工具中有利于保护您的开发生命周期。扫描您的SCM增加了一层额外的安全性，可以捕获工程师可能不会通过他们的本地工作站/CLI扫描的代码。有了这一增加，我们现在可以看到我们在工作流程中的第二层防御。</p><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi me"><img src="../Images/a345e406e3e0e683db83da8cc795987f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bfrJIUVCRgFjbJbWgUNT0w.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">IAC工作流程中的第二层防御</figcaption></figure><h1 id="590f" class="kc kd iq bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">浏览orchestrator (Github、Jenkins、Cloudbuild等)中的构建步骤。)</h1><p id="dcbb" class="pw-post-body-paragraph la lb iq lc b ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ij bi translated">我们现在已经讨论了端到端工作流中的两个方面，即如何为IAC实现安全性测试。让我们再讨论一个地方，在IAC部署到您的云之前，我们可以在那里添加安全性测试。</p><p id="b430" class="pw-post-body-paragraph la lb iq lc b ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt md lv lw lx ij bi translated">如果我们看一下部署IAC的工作流程，没有任何东西自动检查部署管道中的Terraform代码，以查看是否有我们不认可的配置。假设您的云环境中没有预防性控制，在这种情况下，Google Cloud组织策略，当前的流程仍然允许工程师使用许可的防火墙或可公开访问的存储桶来部署计算实例。我肯定我们不希望这样。</p><p id="c814" class="pw-post-body-paragraph la lb iq lc b ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt md lv lw lx ij bi translated">在这里，我们可以添加一个像tfsec或Snyk这样的工具，作为一个构建步骤来扫描terraform中我们不想要的配置。下面的流程显示了添加一个将基础设施扫描为代码的步骤如何在部署之前防止错误配置。如果正在部署的代码有违规，我们可以创建一个步骤来使构建失败，并用从构建日志中提取的必要信息警告必要的团队。</p><p id="121d" class="pw-post-body-paragraph la lb iq lc b ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt md lv lw lx ij bi translated">让我们使用Github Actions作为针对易受攻击的IAC代码的示例orchestrator。我们将使用Snyk和tfsec来扫描Github操作中的IAC。Snyk 和<a class="ae ly" href="https://github.com/aquasecurity/tfsec-action" rel="noopener ugc nofollow" target="_blank"> tfsec </a>在记录Github行为的例子方面都做得很好。如下所示，您可以看到构建步骤由于在部署管道期间捕获错误而失败。</p><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mm"><img src="../Images/448a6a049fac19651e393b87f7fa7a63.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wgOpiw2a1hEjMSF77uGXyA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">tfsec Github操作输出</figcaption></figure><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mn"><img src="../Images/d8cae791ea0938f5af0589b49ee91dbc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SaQLof6MCEFuDMBh3tj6QA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">Snyk Github动作输出</figcaption></figure><p id="4dc2" class="pw-post-body-paragraph la lb iq lc b ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt md lv lw lx ij bi translated">您可以更进一步，为由于这些违规而导致的失败构建添加警报。</p><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi me"><img src="../Images/3869da09d110fd9d222f85090106aa6d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ABxgSDDyQ4ph7adPcfOyXQ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">IAC工作流程中的第三层防御</figcaption></figure><p id="8b40" class="pw-post-body-paragraph la lb iq lc b ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt md lv lw lx ij bi translated">所以现在我们可以将第三层防御添加到您的IAC开发生命周期中。这些层对于确保IAC开发的安全是必不可少的，因为它们提供了安全性和安心，以确保在部署到您的技术环境之前发现错误配置。</p><h1 id="2910" class="kc kd iq bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">那么…为什么这很重要？</h1><p id="500d" class="pw-post-body-paragraph la lb iq lc b ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ij bi translated">像上面提到的那样，在开发的早期实现安全步骤可以帮助您防止错误配置被部署到您的技术环境中。云错误配置给公司带来了巨大的财务和声誉损失。一个例子是数据泄漏，这是一种常见的违规行为，可能是由于配置不当造成的。恶意用户可以访问可能包含私人身份信息或其他高度机密的公司信息的数据。这可能会伤害公司和其他相关人员。</p><p id="1c7e" class="pw-post-body-paragraph la lb iq lc b ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt md lv lw lx ij bi translated">Terraform只是适合作为代码域的基础设施的一个例子。还有其他像Azure RM，AWS Cloudformation或CDK，Helm Charts，dockerfiles…这个名单可以继续下去。将安全门添加到IAC开发生命周期中，允许您强化您的工作流，以获得额外的安全层，这有助于防止组织中的错误配置和违规行为。</p><h1 id="30b5" class="kc kd iq bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">有几件事需要注意</h1><p id="084f" class="pw-post-body-paragraph la lb iq lc b ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ij bi translated">当您对如何部署IAC进行治理时，这个解决方案最有效。如果没有集中部署IAC的方法，那么就没有办法确保这些防御层被添加到您的环境中。至关重要的是，您的组织将如何部署IAC的方法集中起来，以便您可以开始实施这些控制。</p><p id="0722" class="pw-post-body-paragraph la lb iq lc b ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt md lv lw lx ij bi translated">如果您对在开发生命周期中增加更多的安全性感兴趣，我建议您深入了解DevSecOps，并将安全性留给开发人员。这一概念带来了让开发人员和工程师能够用键盘操作进入你的云和基础设施的代码的想法。在开发的早期阶段实现安全性有助于组织受益，并有可能保护您免受恶意破坏。这也可能让你免于一次代价高昂的泄密。</p><h1 id="9635" class="kc kd iq bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">关于唐</h1><p id="bcf9" class="pw-post-body-paragraph la lb iq lc b ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ij bi translated">Don是埃森哲公司的安全经理，主要负责应用安全、云安全和开发安全。他在财富100强公司中担任角色，负责运行云和应用程序安全评估，同时围绕客户的生态系统实施安全测试和控制。有兴趣将其部署到您的环境中吗？让我们<a class="ae ly" href="https://www.linkedin.com/in/donsantos/" rel="noopener ugc nofollow" target="_blank">连线</a>！</p><h1 id="8b6d" class="kc kd iq bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">免责声明:</h1><p id="1e74" class="pw-post-body-paragraph la lb iq lc b ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ij bi translated">我的帖子反映了我自己的观点，不一定代表我的雇主埃森哲的观点。这篇博文中的信息是一般性的，没有考虑到您的IT生态系统和网络的具体需求，这些需求可能会有所不同，需要采取独特的措施。在决定使用上述任何工具时，您应该独立评估您的具体需求。tfsec和Snyk等。工具不是埃森哲的工具。埃森哲不表示其已审查或认可这些工具，埃森哲对这些工具的使用、有效性或因使用这些工具而导致的任何中断或损失不承担任何责任。</p></div><div class="ab cl mo mp hu mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="ij ik il im in"><p id="c08a" class="pw-post-body-paragraph la lb iq lc b ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt md lv lw lx ij bi translated"><em class="mv">最初发表于</em><a class="ae ly" href="https://www.linkedin.com/pulse/importance-infrastructure-code-security-scanning-don-antonio-santos/?trackingId=DtFWYgoeRterXI53OScegA%3D%3D" rel="noopener ugc nofollow" target="_blank"><em class="mv">【https://www.linkedin.com】</em></a><em class="mv">。</em></p><h2 id="93e0" class="mw kd iq bd ke mx my dn ki mz na dp km ll nb nc kq lp nd ne ku lt nf ng ky nh bi translated">来自Infosec的报道:Infosec每天都有很多内容，很难跟上。<a class="ae ly" href="https://weekly.infosecwriteups.com/" rel="noopener ugc nofollow" target="_blank">加入我们的每周简讯</a>以5篇文章、4个线程、3个视频、2个GitHub Repos和工具以及1个工作提醒的形式免费获取所有最新的Infosec趋势！</h2></div></div>    
</body>
</html>