<html>
<head>
<title>Querier — HackTheBox Writeup</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Querier — HackTheBox详细报道</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/querier-hackthebox-writeup-71d40bf55a65?source=collection_archive---------2-----------------------#2019-06-22">https://infosecwriteups.com/querier-hackthebox-writeup-71d40bf55a65?source=collection_archive---------2-----------------------#2019-06-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="adae" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">Querier是一个很棒的盒子，里面有一些对Windows初学者来说很不错的东西。该框从smb枚举开始，它为我们提供了登录数据库服务器的凭据。我将让主机给我建立一个SMB连接，在那里我可以收集Net-NTLMv2挑战响应，并破解它以获得密码。话虽如此，让我们直接开始吧。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/f7f86b5460a8820fc88ef0283521c181.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ssCf_8RMBEocm8rDC_F7wA.png"/></div></div></figure><h1 id="ac8f" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">计数和侦察</h1><p id="84bb" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated"><strong class="ll ir"> Nmap扫描</strong></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mf"><img src="../Images/cf0ecf9a405188951b465815b2a915cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EJO05Gp3SBv27wgWGDRdFA.png"/></div></div></figure><p id="ec56" class="pw-post-body-paragraph lj lk iq ll b lm mg jr lo lp mh ju lr ls mi lu lv lw mj ly lz ma mk mc md me ij bi translated"><strong class="ll ir"> SMB — TCP 445 </strong></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ml"><img src="../Images/6697076ff9a25bcb5f1c76cb98831227.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VmrqKzEon6NC_NuR0SUnNA.png"/></div></div><figcaption class="mm mn gj gh gi mo mp bd b be z dk translated">桑巴股份</figcaption></figure><p id="0819" class="pw-post-body-paragraph lj lk iq ll b lm mg jr lo lp mh ju lr ls mi lu lv lw mj ly lz ma mk mc md me ij bi translated"><strong class="ll ir">报道</strong>看起来很有趣。让我们看看那里有什么。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mq"><img src="../Images/67e054bb072711dac24dd02abf532fbb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*x_wzUy5I6TDJ1224uHBLVw.png"/></div></div><figcaption class="mm mn gj gh gi mo mp bd b be z dk translated">SMB客户端输出</figcaption></figure><p id="ed2b" class="pw-post-body-paragraph lj lk iq ll b lm mg jr lo lp mh ju lr ls mi lu lv lw mj ly lz ma mk mc md me ij bi translated">有一个扩展名为<strong class="ll ir"><em class="mr">【xslm】</em></strong>的文件。对它运行文件命令，显示它是一个<em class="mr"> Microsoft Excel文档</em>。我试图通过Google Sheets打开它，结果却遭到了攻击。后来我走了一圈，想看看文件里藏了什么。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ms"><img src="../Images/12da3f1148362edfac1ba6d0e0de42a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*s6-8WKEIQuII85HpX-aeDA.png"/></div></div><figcaption class="mm mn gj gh gi mo mp bd b be z dk translated">binwalk输出</figcaption></figure><p id="202a" class="pw-post-body-paragraph lj lk iq ll b lm mg jr lo lp mh ju lr ls mi lu lv lw mj ly lz ma mk mc md me ij bi translated">我使用<a class="ae mt" href="https://github.com/decalage2/oletools" rel="noopener ugc nofollow" target="_blank"> <strong class="ll ir"> oletools </strong> </a>来获取宏，发现了一个潜在的用户名和密码。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mu"><img src="../Images/f5cbd686b66e1b4159a3c86d5683260f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mEKsFTRNXgR8i9opmKvx8g.png"/></div></div></figure><blockquote class="mv mw mx"><p id="ceae" class="lj lk mr ll b lm mg jr lo lp mh ju lr my mi lu lv mz mj ly lz na mk mc md me ij bi translated">用户名= <strong class="ll ir">报告</strong></p><p id="447f" class="lj lk mr ll b lm mg jr lo lp mh ju lr my mi lu lv mz mj ly lz na mk mc md me ij bi translated">密码=<strong class="ll ir">PcwTWTHRwryjc＄C6</strong></p><p id="9515" class="lj lk mr ll b lm mg jr lo lp mh ju lr my mi lu lv mz mj ly lz na mk mc md me ij bi translated">数据库= <strong class="ll ir">卷</strong></p></blockquote><h2 id="21a3" class="nb ks iq bd kt nc nd dn kx ne nf dp lb ls ng nh ld lw ni nj lf ma nk nl lh nm bi translated"><strong class="ak"> MSSQL — 1433 </strong></h2><p id="5c64" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">现在我们有了凭证，让我们登录到DB并检查我们得到了什么。我试着用<strong class="ll ir"> sqsh </strong>和<strong class="ll ir"> dbeaver </strong>登录，但是由于某种原因他们失败了。后来我用这个metasploit辅助模块<strong class="ll ir"><em class="mr">auxiliary/admin/MSSQL/MSSQL _ SQL</em></strong>枚举数据库。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nn"><img src="../Images/33a91d1ed06a6fb4ed49ec6b022a6d91.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WGdZ5EbqLwHQCKW4rngbDA.png"/></div></div><figcaption class="mm mn gj gh gi mo mp bd b be z dk translated">MSF模块</figcaption></figure><p id="3595" class="pw-post-body-paragraph lj lk iq ll b lm mg jr lo lp mh ju lr ls mi lu lv lw mj ly lz ma mk mc md me ij bi translated">好了，我们得到了SQL Server版本。由于用这个模块枚举相当慢，我切换到<strong class="ll ir"> impacket — mssqlclient </strong>继续枚举。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi no"><img src="../Images/c750aa7c330823aca2f45212b022da2f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FAPwSafCGMn3Ls--whAc5A.png"/></div></div></figure><p id="dc0a" class="pw-post-body-paragraph lj lk iq ll b lm mg jr lo lp mh ju lr ls mi lu lv lw mj ly lz ma mk mc md me ij bi translated">启用xp_cmdshell失败，因此我们可能需要提升到更高权限的用户。让我们使用<a class="ae mt" href="https://github.com/SpiderLabs/Responder" rel="noopener ugc nofollow" target="_blank"><strong class="ll ir"><em class="mr">responder</em></strong></a><strong class="ll ir">抓取哈希。</strong></p><p id="aa02" class="pw-post-body-paragraph lj lk iq ll b lm mg jr lo lp mh ju lr ls mi lu lv lw mj ly lz ma mk mc md me ij bi translated">这是一篇从windows获取ntlm哈希的好文章。</p><div class="np nq gp gr nr ns"><a href="https://0xdf.gitlab.io/2019/01/13/getting-net-ntlm-hases-from-windows.html" rel="noopener  ugc nofollow" target="_blank"><div class="nt ab fo"><div class="nu ab nv cl cj nw"><h2 class="bd ir gy z fp nx fr fs ny fu fw ip bi translated">通过NTLMv2获取凭据</h2><div class="nz l"><h3 class="bd b gy z fp nx fr fs ny fu fw dk translated">Windows机器用于通过网络进行身份验证的身份验证协议之一是质询/响应/…</h3></div><div class="oa l"><p class="bd b dl z fp nx fr fs ny fu fw dk translated">0xdf.gitlab.io</p></div></div><div class="ob l"><div class="oc l od oe of ob og kp ns"/></div></div></a></div><blockquote class="mv mw mx"><p id="3b75" class="lj lk mr ll b lm mg jr lo lp mh ju lr my mi lu lv mz mj ly lz na mk mc md me ij bi translated">运行<strong class="ll ir"><em class="iq">responder-I tun 0-v</em></strong>启动responder</p></blockquote><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oh"><img src="../Images/681443593a590dc6bfef24507297a8af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kujww-XiG1EfqIRUw2UPMA.png"/></div></div><figcaption class="mm mn gj gh gi mo mp bd b be z dk translated">散列滚滚而来</figcaption></figure><p id="e3df" class="pw-post-body-paragraph lj lk iq ll b lm mg jr lo lp mh ju lr ls mi lu lv lw mj ly lz ma mk mc md me ij bi translated">让我们和约翰一起破解这些散列。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oh"><img src="../Images/875882a524cfb4b69b054765d889bc17.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YIGYhS5uE8k3Zn-Wj5rbYw.png"/></div></div></figure><blockquote class="mv mw mx"><p id="ac47" class="lj lk mr ll b lm mg jr lo lp mh ju lr my mi lu lv mz mj ly lz na mk mc md me ij bi translated">用户名= <strong class="ll ir"> mssql-svc </strong></p><p id="2c2d" class="lj lk mr ll b lm mg jr lo lp mh ju lr my mi lu lv mz mj ly lz na mk mc md me ij bi translated">密码= <strong class="ll ir">公司568 </strong></p></blockquote><p id="22ec" class="pw-post-body-paragraph lj lk iq ll b lm mg jr lo lp mh ju lr ls mi lu lv lw mj ly lz ma mk mc md me ij bi translated">再次登录数据库的时间到了。当我第一次这样做的时候，我用上面的凭证登录了<strong class="ll ir"> <em class="mr">【端口135】</em></strong>，但是不能再用它了。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oh"><img src="../Images/4e5bbb1b507d0d5823cee691e537928c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Yljv6dugN8pYUYkrjYZsWQ.png"/></div></div><figcaption class="mm mn gj gh gi mo mp bd b be z dk translated">xp_cmdshell已启用。</figcaption></figure><p id="6734" class="pw-post-body-paragraph lj lk iq ll b lm mg jr lo lp mh ju lr ls mi lu lv lw mj ly lz ma mk mc md me ij bi translated">xp_cmdshell已启用，我们可以ping自己。太棒了。是时候买个壳了。</p><h1 id="cf03" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">作为mssql-svc的Shell</h1><p id="ea52" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">我用了霓裳<code class="fe oi oj ok ol b"><a class="ae mt" href="https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1" rel="noopener ugc nofollow" target="_blank"><strong class="ll ir">Invoke-PowerShellTcp.ps1</strong></a></code>反壳。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi om"><img src="../Images/2b6ece4fb25ec427f7705e3ea18d9a3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2q1JfxSBOJ0e3KdWG_m4zw.png"/></div></div></figure><h1 id="459f" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">系统特权</h1><p id="0ed9" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">我运行了<a class="ae mt" href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Privesc/PowerUp.ps1" rel="noopener ugc nofollow" target="_blank"><strong class="ll ir">power up . PS1</strong></a><strong class="ll ir"/>，马上就找到了管理员凭证。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi on"><img src="../Images/4c20742f94dcdebe8d4059b429e2e29a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wdeB97Hm8b_AmWlj-vPJCQ.png"/></div></div></figure><blockquote class="mv mw mx"><p id="73dd" class="lj lk mr ll b lm mg jr lo lp mh ju lr my mi lu lv mz mj ly lz na mk mc md me ij bi translated">用户名:<strong class="ll ir">管理员</strong></p><p id="140f" class="lj lk mr ll b lm mg jr lo lp mh ju lr my mi lu lv mz mj ly lz na mk mc md me ij bi translated">密码:<strong class="ll ir"> MyUnclesAreMarioAndLuigi！！1!</strong></p></blockquote><h1 id="b294" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">阅读标志</h1><h1 id="ae37" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">净使用</h1><p id="f3a8" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">只需获取对文件系统的访问权，但这就是获取标志所需的全部内容:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oo"><img src="../Images/c4631280cfaa09026e4a61c83466f487.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SFT8Oh85iuUwB9FuvMf6_w.png"/></div></div></figure><h1 id="48d0" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">Shell作为nt-authority\system</h1><p id="77b5" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">因为我们有管理员凭证，我们可以使用<a class="ae mt" href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/psexec.py" rel="noopener ugc nofollow" target="_blank"><strong class="ll ir">impacket/psexec . py</strong></a><strong class="ll ir"/>登录。</p><p id="5fee" class="pw-post-body-paragraph lj lk iq ll b lm mg jr lo lp mh ju lr ls mi lu lv lw mj ly lz ma mk mc md me ij bi translated">请务必下载最新的psexec.py文件，因为我在克隆repo后得到的文件有问题。这个壳本质上是慢的，耐心点。</p><blockquote class="mv mw mx"><p id="9647" class="lj lk mr ll b lm mg jr lo lp mh ju lr my mi lu lv mz mj ly lz na mk mc md me ij bi translated"><a class="ae mt" href="https://github.com/SecureAuthCorp/impacket" rel="noopener ugc nofollow" target="_blank">https://github.com/SecureAuthCorp/impacketT21</a></p></blockquote><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi op"><img src="../Images/5ad68754fbec3686b9b8803f365765fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q4Qaxw1s5t0PglVV-VFMFg.png"/></div></div></figure><h1 id="c862" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">powershell“运行方式”</h1><p id="b61c" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">使用密码创建一个可以传递给<code class="fe oi oj ok ol b"><strong class="ll ir">Invoke-Command</strong></code>的凭证。在这种情况下，<code class="fe oi oj ok ol b"><strong class="ll ir">adminShell.ps1</strong></code>是另一个<code class="fe oi oj ok ol b"><a class="ae mt" href="https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1" rel="noopener ugc nofollow" target="_blank"><strong class="ll ir">Invoke-PowerShellTcp.ps1</strong></a></code>，端口改为9001:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oq"><img src="../Images/b469edbd066914ec408ec95491c9c7f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JrshpVGZarSjGX_6fdkq6g.png"/></div></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi or"><img src="../Images/d04970b47662367e04eeb566d3e5637c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aUQYmhfB7R4_048OPwMEqA.png"/></div></div><figcaption class="mm mn gj gh gi mo mp bd b be z dk translated">作为管理员的Shell</figcaption></figure><p id="f36a" class="pw-post-body-paragraph lj lk iq ll b lm mg jr lo lp mh ju lr ls mi lu lv lw mj ly lz ma mk mc md me ij bi translated">我试图使用WinRM作为管理员获取shell，但它给了我一个授权错误。</p><p id="77d1" class="pw-post-body-paragraph lj lk iq ll b lm mg jr lo lp mh ju lr ls mi lu lv lw mj ly lz ma mk mc md me ij bi translated">嗯，这次我就说这么多了。希望你阅读愉快。</p><p id="07e5" class="pw-post-body-paragraph lj lk iq ll b lm mg jr lo lp mh ju lr ls mi lu lv lw mj ly lz ma mk mc md me ij bi translated"><strong class="ll ir">感谢并快乐黑客，<br/>Preetham(</strong><a class="ae mt" href="https://www.hackthebox.eu/profile/9160" rel="noopener ugc nofollow" target="_blank"><strong class="ll ir"><em class="mr">)@ cyber 01</em></strong></a><strong class="ll ir"><em class="mr"/>)</strong></p></div></div>    
</body>
</html>