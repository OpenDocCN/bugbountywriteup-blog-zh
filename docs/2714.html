<html>
<head>
<title>Exploring the World of ESI Injection</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">探索ESI注射的世界</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/exploring-the-world-of-esi-injection-b86234e66f91?source=collection_archive---------0-----------------------#2022-12-29">https://infosecwriteups.com/exploring-the-world-of-esi-injection-b86234e66f91?source=collection_archive---------0-----------------------#2022-12-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="6ab7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">嘿，大家好，</p><p id="daf2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这篇文章中，我将分享我和我的朋友<a class="ae km" href="https://twitter.com/nytr0gen_" rel="noopener ugc nofollow" target="_blank"> nytr0gen </a>在一个私人bug bounty计划中发现的与ESI ( <strong class="jp ir"> <em class="kl"> Edge Side包括</em> </strong>)注射相关的发现。我们找到了一堆，所以请确保你一直读到最后，因为你不会错过最有趣的发现:)</p><p id="e097" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你不知道/还没有听说过<strong class="jp ir"><em class="kl">Edge Side Include Injection，</em> </strong>我强烈建议你先阅读下面的文章，因为Gosecure已经做了很好的解释，你也可以查看下面的Alex Birsan tweet，了解如何最后找到它们，但同样重要的是，你也可以观看DEFCON演讲:</p><div class="kn ko gp gr kp kq"><a href="https://www.gosecure.net/blog/2018/04/03/beyond-xss-edge-side-include-injection/" rel="noopener  ugc nofollow" target="_blank"><div class="kr ab fo"><div class="ks ab kt cl cj ku"><h2 class="bd ir gy z fp kv fr fs kw fu fw ip bi translated">超越XSS:边缘方包括注射- GoSecure</h2><div class="kx l"><h3 class="bd b gy z fp kv fr fs kw fu fw dk translated">更新:作为这篇文章的后续，一篇新的博客文章已经发表:ESI第2部分:滥用特定…</h3></div><div class="ky l"><p class="bd b dl z fp kv fr fs kw fu fw dk translated">www.gosecure.net</p></div></div><div class="kz l"><div class="la l lb lc ld kz le lf kq"/></div></div></a></div><div class="kn ko gp gr kp kq"><a href="https://www.gosecure.net/blog/2019/05/02/esi-injection-part-2-abusing-specific-implementations/" rel="noopener  ugc nofollow" target="_blank"><div class="kr ab fo"><div class="ks ab kt cl cj ku"><h2 class="bd ir gy z fp kv fr fs kw fu fw ip bi translated">ESI注入第2部分:滥用特定实现</h2><div class="kx l"><h3 class="bd b gy z fp kv fr fs kw fu fw dk translated">这篇文章是对第一次ESI发布后发现的项目的跟进。这些发现是攻击媒介…</h3></div><div class="ky l"><p class="bd b dl z fp kv fr fs kw fu fw dk translated">www.gosecure.net</p></div></div><div class="kz l"><div class="lg l lb lc ld kz le lf kq"/></div></div></a></div><figure class="lh li lj lk gt ll"><div class="bz fp l di"><div class="lm ln l"/></div></figure><figure class="lh li lj lk gt ll"><div class="bz fp l di"><div class="lo ln l"/></div></figure><h2 id="a3bd" class="lp lq iq bd lr ls lt dn lu lv lw dp lx jy ly lz ma kc mb mc md kg me mf mg mh bi translated">故事开始了</h2><p id="5451" class="pw-post-body-paragraph jn jo iq jp b jq mi js jt ju mj jw jx jy mk ka kb kc ml ke kf kg mm ki kj kk ij bi translated">这些发现是在一个私人项目中发现的，所以我将把目标称为<strong class="jp ir">redacted.com</strong>，为了让你对这家公司有所了解，我会让你知道这是一家非常著名的体育组织。</p><p id="12d3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我一直在寻找xss错误，很快就找到了一个端点，它允许<code class="fe mn mo mp mq b">&lt;&gt;'" </code>字符在响应中反射，但是我不能很容易地在那里得到xss，因为<em class="kl"> Akamai WAF </em>已经就位。</p><p id="b8d2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">浏览页面源代码时，我注意到一段代码看起来有点可疑:</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi mr"><img src="../Images/bdbadd5923832ca64ccaebc0285c802d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*InPK3iHArBuUKZ1s2hWH6w.png"/></div></div></figure><p id="220b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我知道<strong class="jp ir"> <em class="kl"> ESI </em> </strong>所以我开始检查<em class="kl">缓存服务器</em>是否会呈现我输入的ESI标签，</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi mx"><img src="../Images/8f6d25a1ca7106815d2bb27ec9ab9d07.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*W_9UgYxqu8bmxwQzov0XkQ.png"/></div></div></figure><p id="ce0a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我使用了上面的有效载荷，它被waf阻止了，在进一步测试后，应用程序有了一些更严格的waf规则。我意识到waf寻找像这样的模式<code class="fe mn mo mp mq b">&lt;esi:placeholderhere&gt; </code>，如果它包含任何有效的<em class="kl"> ESI </em>标签，如include等，就会被阻止。只使用<code class="fe mn mo mp mq b">&lt;esi:&gt; </code>返回500内部服务器错误，所以我知道缓存服务器实际上是在试图呈现<em class="kl"> ESI </em>标签，我尝试了各种字符，如%00、%0A等，以检查是否有任何字符允许绕过检查，但最终什么也没有。</p><p id="7966" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当时我正在使用<strong class="jp ir"> <em class="kl">打嗝Pro试用</em> </strong>，所以我用它扫描了这个参数，我收到了这个输出:</p><pre class="lh li lj lk gt my mq mz bn na nb bi"><span id="9097" class="nc lq iq mq b be nd ne l nf ng">https://globe.redacted.com/?showFooter=um6k%3c!--esi--%3e8omf%3c!--esx--%3eekdi<br/><br/>Note: This issue was generated by the Burp extension: Active Scan++.<br/>Issue detail<br/>The application appears to support Edge Side Includes:  The following probe was sent: um6k&lt;!--esi--&gt;8omf&lt;!--esx--&gt;ekdi In the response, the ESI comment has been stripped: um6k8omf&lt;!--esx--&gt;ekdi  Refer to https://gosecure.net/2018/04/03/beyond-xss-edge-side-include-injection/ for further information</span></pre><p id="3cd3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以我能够使用注释标签来确认<em class="kl"> ESI注射</em>，但是仍然不是很有用。由于我没有进一步尝试的想法，我决定继续前进。</p><p id="6a92" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，我在笔记中保存了这个端点，并继续前进，希望将来能够升级它。</p><p id="70a6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">几个月过去了，我收到了该公司bbp的一封邮件，他们发起了一个<strong class="jp ir"><em class="kl"/></strong>促销活动，并为所有高/批评性的投稿支付<strong class="jp ir"> 2x </strong>。</p><p id="7a44" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">看到这封邮件，我不能再在我的笔记中留下端点，我需要以某种方式升级它，无论需要什么。</p><p id="f6b8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我很确定我自己无法升级它，因为我不具备所需的技能，所以为什么不联系其他比我更有经验的人，他们能够提出绕过waf的解决方案。</p><p id="563c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该程序允许<strong class="jp ir"> <em class="kl">在报告上与</em> </strong>合作，所以我可以直接联系<code class="fe mn mo mp mq b">collaborator </code>部门的人。</p><p id="16fe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个节目中有很多人，甚至一些大人物也在那里，所以在我联系了<strong class="jp ir"> <em class="kl"> nytr0gen，</em> </strong>之后，我很难决定我应该联系谁，因为我一直在玩ctfs。他来自<em class="kl">沉船线</em> ctf团队，相信我，ctf球员的技能完全在不同的水平上。</p><h1 id="caa8" class="nh lq iq bd lr ni nj nk lu nl nm nn lx no np nq ma nr ns nt md nu nv nw mg nx bi translated">合作魔法⭐</h1><p id="5fe3" class="pw-post-body-paragraph jn jo iq jp b jq mi js jt ju mj jw jx jy mk ka kb kc ml ke kf kg mm ki kj kk ij bi translated">大约在30分钟内，nytr0gen提出了可用于弹出xss警告框的ESI有效载荷。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi ny"><img src="../Images/7ff1b666be923645819ea130fbb09911.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u-oj9vcDFjE6BxpbkIKOMA.png"/></div></div></figure><p id="18fd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">更多示例可帮助您理解如何使用ESI标签绕过WAF:</p><figure class="lh li lj lk gt ll"><div class="bz fp l di"><div class="lo ln l"/></div></figure><figure class="lh li lj lk gt ll"><div class="bz fp l di"><div class="lo ln l"/></div></figure><p id="7eda" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我解码有效载荷，让你了解实际发生了什么</p><figure class="lh li lj lk gt ll"><div class="bz fp l di"><div class="nz ln l"/></div></figure><p id="d9c5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当我第一次看到这个的时候，我被震惊了，因为我不知道你也可以在ESI注释标签中使用变量。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi oa"><img src="../Images/8b1c3ed73db9142b7d343fd7a64a7523.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Vmx6y09Moau1U5_IBACReA.png"/></div></div><figcaption class="ob oc gj gh gi od oe bd b be z dk translated"><a class="ae km" href="https://docs.oracle.com/cd/A97335_02/caching.102/a90372/esi.htm#633138" rel="noopener ugc nofollow" target="_blank">https://docs . Oracle . com/CD/a 97335 _ 02/caching . 102/a 90372/ESI . htm # 633138</a></figcaption></figure><p id="5c1c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当缓存服务器呈现上述有效负载时，它将在页面源上仅返回以下内容:</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi of"><img src="../Images/be80e99dfdd98650930209be4bc84341.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jvkwoikvdqO8RMedlVrCKg.png"/></div></div></figure><p id="2507" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mn mo mp mq b">$(QUERY_STRING{countryCode}) </code>返回了<code class="fe mn mo mp mq b">countryCode </code>参数值，ESI标签真的非常强大，你可以用它们做很多事情。</p><p id="f4a4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">另一件有趣的事情是，应用程序会话cookie被标记为<strong class="jp ir"> <em class="kl"> httponly </em> </strong>和scope to <code class="fe mn mo mp mq b">.redacted.com , </code>因为cookie被标记为<strong class="jp ir"> <em class="kl"> httponly </em> </strong>用普通的纯xss不可能窃取会话cookie，但用ESI标签是可能的:)</p><p id="04a2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我甚至问他是如何想到在ESI注释中使用变量的，他告诉我他只是看了文档</p><div class="kn ko gp gr kp kq"><a href="https://docs.oracle.com/cd/B14099_19/caching.1012/b14046/esi.htm#i654520" rel="noopener  ugc nofollow" target="_blank"><div class="kr ab fo"><div class="ks ab kt cl cj ku"><h2 class="bd ir gy z fp kv fr fs kw fu fw ip bi translated">边缘侧包括(ESI)语言标签</h2><div class="kx l"><h3 class="bd b gy z fp kv fr fs kw fu fw dk translated">本章描述了为动态片段的内容组装提供的边缘侧包含(ESI)标签。这个…</h3></div><div class="ky l"><p class="bd b dl z fp kv fr fs kw fu fw dk translated">docs.oracle.com</p></div></div></div></a></div><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi og"><img src="../Images/ed942530599bac6614974143c5048b17.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SyNnIKxIUwixF1gwIo-0DQ.png"/></div></div></figure><p id="3f01" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">报告中提供了一个全面的账户接管概念验证，该问题得到了<em class="kl">审判</em>，并获得了<em class="kl">高严重性</em>评级(感谢2x倍增器):</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi oh"><img src="../Images/e73f35342d9d14ee0205388718075680.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cyMqqPBhbHJm93p4LTeu0A.png"/></div></div></figure><p id="0161" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">故事并没有在这里结束，因为nytr0gen发现了另一个子域，在那里他使用ESI标签时有xss，它们也由缓存服务器呈现，这对我们来说是一个很好的信号，因为这可能意味着整个目标上可能仍有更多的ESI注入错误。</p><p id="fb73" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该应用程序对我们的输入进行了一些奇怪的大写/小写转换，因此我们无法使用任何变量，例如<code class="fe mn mo mp mq b">HTTP_COOKIE </code>，因为它被转换为大写/小写的wierdly <strong class="jp ir"> http_COOKIE </strong>，但nytr0gen仍然能够再次读取文档并找到另一个有用的ESI函数，该函数允许解码url编码的字符串:</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi oi"><img src="../Images/bea3b37da88d2e51d28cb72dc131d3f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fhSCF1_6wG1jLiI5MI3aoQ.png"/></div></div><figcaption class="ob oc gj gh gi od oe bd b be z dk translated"><a class="ae km" href="https://www.akamai.com/site/zh/documents/technical-publication/akamai-esi-developers-guide-technical-publication.pdf" rel="noopener ugc nofollow" target="_blank">https://www . akamai . com/site/zh/documents/technical-publication/akamai-ESI-developers-guide-technical-publication . pdf</a></figcaption></figure><p id="3c6c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">url对有效载荷进行了两次编码以确保Akamai不会阻止它，</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi oj"><img src="../Images/4f44556bc692c47430fb7bb68d386b06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B4vjQfVX3OOx32AmvPfYOA.png"/></div></div></figure><p id="91a2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">继续，现在我通过多次阅读nytr0gen慢慢开始掌握这种ESI注射。我已经在另一个子域上找到了一个xss，在页面源代码中没有任何ESI标签的迹象，但我仍然决定尝试一下<code class="fe mn mo mp mq b">aaa&lt;!--esi--&gt;bbb&lt;!--esx--&gt;ccc , </code>使用它作为有效载荷，服务器实际上呈现了它，所以我知道ESI注入错误在那里使用相同的有效载荷进行帐户接管</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi ok"><img src="../Images/70289bd3ff5b35b64cb2e6a99b7eedf9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hhXrjLUd7xxESt_u4h32ZA.png"/></div></div></figure><p id="2ba9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你对<em class="kl">账户接管概念验证</em>感兴趣，这里有(js代码放在散列之后，我只是把它放在下面，使它更易读):</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi ol"><img src="../Images/533cf0e334de73cb24c3485fb51a894d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JJcsDm8V7QZL7gYfNQNZ2g.png"/></div></div></figure><p id="69a4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">nytr0gen在这里做了一项出色的工作，使得triager很容易使用这个概念验证来重现实际的影响。因为你们现在已经知道了<code class="fe mn mo mp mq b">HTTP_COOKIE</code>和<code class="fe mn mo mp mq b">QUERY_STRING{x} </code>变量的作用，所以理解概念验证应该很容易。</p><p id="030f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">顺便说一句，nytr0gen在10个月前已经提交了这个xss错误，我们仍然决定报告它，因为它比普通的xss有更大的影响。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi om"><img src="../Images/ad6e362d57e809165ebd8f7ee0f614a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BkqmkF1peTYOEIocmZMp5w.png"/></div></div></figure><p id="deee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">另一个严重程度很高的bug，我们做得很好:)</p><p id="6219" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们继续前进，即将到来的ESI注入错误是超级有趣的，所以抓紧你的座位，最好的还在后面。</p><p id="d7bf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">几天后，nytr0gen再次发现了另一个易受攻击的新端点。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi on"><img src="../Images/e51bf2f13fadb815f0d463b4405b40e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d5LXW5ihf2d1FYRSwSIURg.png"/></div></div></figure><p id="7735" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">是的，你没看错，这个端点的响应<code class="fe mn mo mp mq b">Content-Type </code>头值是<code class="fe mn mo mp mq b">application/json</code>，ESI标签仍然由缓存服务器呈现。</p><p id="392d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">虽然可以在这里包含ESI标签，但是你如何能够窃取页面响应中的cookie，因为xss不能与<code class="fe mn mo mp mq b">Content-Type: application/json </code>一起工作，或者是这样吗<code class="fe mn mo mp mq b">?</code></p><p id="2f6e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">任何人都会在这里停下来，认为由于<code class="fe mn mo mp mq b">Content-Type ,</code>你现在什么也做不了，但是当nytr0gen在那里掩护你的时候，你不应该担心:)</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi oo"><img src="../Images/1a70fceb5639af89529d7b0b87b23101.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aRHptw99NJtB2Niee5_9Dw.png"/></div></div></figure><p id="d040" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面是答案使用<code class="fe mn mo mp mq b">$add_header() </code>方法你可以覆盖任何响应头。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi op"><img src="../Images/e4ef45d3626821508a550bc73112aa5b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VdEUWFnYWD1h-0GrMNN0wA.png"/></div></div><figcaption class="ob oc gj gh gi od oe bd b be z dk translated"><a class="ae km" href="https://www.akamai.com/site/zh/documents/technical-publication/akamai-esi-developers-guide-technical-publication.pdf" rel="noopener ugc nofollow" target="_blank">https://www . akamai . com/site/zh/documents/technical-publication/akamai-ESI-developers-guide-technical-publication . pdf</a></figcaption></figure><p id="59de" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">以下有效载荷会将响应<code class="fe mn mo mp mq b">content-type </code>更改为<code class="fe mn mo mp mq b">text/html</code></p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div class="gh gi oq"><img src="../Images/28013cb5a56d3411841a156070aeb1bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1374/format:webp/1*Fd50GPveRabA_2KLV7iPXA.png"/></div></figure><p id="11ba" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是我们用来执行js代码的最终有效载荷，我们首先使用了<code class="fe mn mo mp mq b">HTTP_COOKIE</code>，然后是<code class="fe mn mo mp mq b">add_header</code>，然后是<code class="fe mn mo mp mq b">url_decode</code>函数:</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi or"><img src="../Images/9b0dffd36a1b216bb9eccfc488ffac1c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RvvowpnpSZycjwBm1fNfiQ.png"/></div></div></figure><p id="921b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mn mo mp mq b">HTTP_COOKIE </code>变量返回响应中的cookies，<code class="fe mn mo mp mq b">add_header </code>函数改变响应的<em class="kl">内容类型</em>，最后使用<code class="fe mn mo mp mq b">url_decode</code>函数我们放置xss有效载荷(url编码两次以避免waf ),使用它我们可以窃取页面响应。</p><p id="169e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一只大虫子值得一大笔赏金:)</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi os"><img src="../Images/396bab76bfa9181d0be8a6c87f210ca2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5kufvYug-OnnNjskYjoVGg.png"/></div></div></figure><p id="65a0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们以为这一定是结束了，不会再有ESI错误了，但是我们错了……..</p><h1 id="6cff" class="nh lq iq bd lr ni nj nk lu nl nm nn lx no np nq ma nr ns nt md nu nv nw mg nx bi translated">故事继续</h1><p id="8895" class="pw-post-body-paragraph jn jo iq jp b jq mi js jt ju mj jw jx jy mk ka kb kc ml ke kf kg mm ki kj kk ij bi translated">我们发现了另一个端点，它看起来像一个代理，接受一个url参数作为输入，然后获取该url的响应。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi ot"><img src="../Images/c83441f5f60bb85d487c3d62e1a71ab3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PwXiz5U2QP92-iriHUY1dw.png"/></div></div></figure><p id="7236" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它只把一些域名列入白名单，其中一些在我们的目标redacted.com，少数在其他第三方网站。</p><p id="d146" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">由于它的工作方式，我们开始测试ssrf在这里是否可行。由于它只允许向一些白名单主机发出请求，我们开始寻找这些主机中的任何开放重定向错误。</p><p id="8b0f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们在redacted.com找到了一个，但是只有当用户通过认证时才有效，顺便说一句，这个开放重定向有点意思。</p><p id="fc7b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">访问这个网址:<a class="ae km" href="https://www.redacted.com/auth#login?url=http://evil.com" rel="noopener ugc nofollow" target="_blank">https://www.redacted.com/auth#login?url=http://evil.com</a></p><p id="61ad" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它在iframe中加载了另一个url，然后重定向到我们的url，我尝试了xss，但是没有成功，因为重定向是通过<code class="fe mn mo mp mq b">Location</code>头发生的。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi ou"><img src="../Images/85cba7515dc083d317988e0624aaf9c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZYFqILdcN9dAsWlq6NX7ZQ.png"/></div></div></figure><p id="610f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后我们转移到第三方网站xyz.com，也在白名单中，尽管我们在这些第三方网站上发现了一些xs，但我们仍然没有发现任何对我们有用的开放重定向。</p><p id="4591" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Ssrf在这里看起来如此接近，但我们仍然不能做出任意的请求。</p><p id="6fbb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在摆弄这个端点时，我在url参数中使用了第三方站点xss易受攻击的端点，令人惊讶的是xss弹出窗口出现在redacted.com域的上下文中。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi ov"><img src="../Images/5f811470c71dccd1ce68600534b041ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8Jco2DUpQp0h4ZtfNfsY6w.jpeg"/></div></div></figure><p id="cb22" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们之前已经报告了该主机上的ESI注入，所以我只是尝试使用ESI有效负载，它确实有效</p><p id="565e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，通过在不同的第三方域上使用xss，我们能够让ESI注入在我们的目标域上工作，我们无法获得ssrf，因为我们在花了几天时间后没有找到任何打开的重定向，但至少我们使用ESI注入成功升级了此问题，因此我们报告了此问题。</p><p id="76b6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们还尝试了另一件事，我想我应该提一下，正如你已经知道的ESI的<code class="fe mn mo mp mq b">add_header</code>功能，我们认为我们可以用这样的有效负载创建我们自己的开放重定向bug:</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi ow"><img src="../Images/eff42d7b7426301d542f27f908d73859.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5c0iN1sBrN_wBtIJjtN6uw.png"/></div></div></figure><p id="bc2f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我们发现易受ESI注入攻击的任何先前端点上使用此有效负载，将为我们提供一个简单的开放式重定向。</p><p id="c73d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它正常工作，但当我们在<strong class="jp ir"> <em class="kl">代理</em> </strong>端点上使用这个打开的重定向url时，它由于某种原因无法工作，可能是Akamai waf或我们不知道的其他原因。</p><p id="52a3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">故事的转折来了，这个bug被<em class="kl"> h1三元组标记为重复，</em>我们俩都觉得这不可能。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi ox"><img src="../Images/29d1f0ca97b5c2d00f4d54bd56135497.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Muu8_lsFfMtgKDo1Vm0alQ.png"/></div></div></figure><p id="0c89" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果这实际上是重复的，那将意味着在这个程序中有其他人也知道这个ESI魔术或者将要知道？</p><p id="b612" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在与<em class="kl"> h1 triager、</em>进一步反复后，我们了解到最初的报告者实际上能够将其升级以执行SSRF，但显然没有ESI技巧。</p><p id="5a1d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们忘记了这份报告，继续前进。很快<em class="kl">促销</em>就结束了，我们决定现在也停下来，如果将来他们做同样的2倍促销，我们会回头看看，我们认为这种可能性很小。</p><h1 id="c06b" class="nh lq iq bd lr ni nj nk lu nl nm nn lx no np nq ma nr ns nt md nu nv nw mg nx bi translated">又一次升职</h1><p id="8471" class="pw-post-body-paragraph jn jo iq jp b jq mi js jt ju mj jw jx jy mk ka kb kc ml ke kf kg mm ki kj kk ij bi translated">4-5个月后，他们很快再次推出相同的2倍乘数促销，我们准备再次搜寻那些ESI注入漏洞</p><figure class="lh li lj lk gt ll"><div class="bz fp l di"><div class="oy ln l"/></div></figure><p id="f504" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我测试了一些<em class="kl">回调</em>参数，因为它们通常在响应中反映输入，并发现一些甚至允许<code class="fe mn mo mp mq b">&lt;&gt; </code>字符，但这些主机的缓存服务器配置不同，因此ESI标签不起作用。</p><p id="e625" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一些旧的报告已经修复，nytr0gen发现相同的json api端点现在可以通过不同的路径访问。为了修复最初的json api ESI错误，他们完全删除了端点，但是同一个端点存在于另一个路径上，所以错误仍然存在，使用了与我们能够重现错误之前相同的poc。</p><p id="7933" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">提交它作为端点是不同的，虽然它有相同的api，由程序分类，并再次奖励为高。</p><p id="86ec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">团队这次甚至问了我们一个关于缓解的问题:)</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi oz"><img src="../Images/18e06901714ea6ba95b6379e65c9c0b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H9r_nxk7vAjwxP5u5Ut68Q.png"/></div></div></figure><p id="a1d6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我要谈谈我们发现的最后一个ESI bug，这是我们想出的最好的方法，实际上是想出一个可行的利用方法。</p><p id="fdab" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你在博客上呆了这么久，非常感谢，请做好准备，因为我将告诉你我们发现的最好的ESI bug。</p><p id="8db3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我找到了另一个端点，这个端点的<code class="fe mn mo mp mq b">Content-Type</code>是<code class="fe mn mo mp mq b">application/json</code></p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi pa"><img src="../Images/f20fa8ba52d15a82427edf106041e65a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GXdzqyEH8eliaGjjXiH4cw.png"/></div></div></figure><p id="4135" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在上面的截图中，您可以看到locale参数值反映在源代码中，但是ESI标记没有被缓存服务器呈现。因为我们之前已经在这里发现了一个ESI注入错误，所以这应该是可行的。</p><p id="dfb5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我把这个网址发给了nytr0gen，据他所说，这应该是有效的。过了一段时间，他给我发消息说他让它工作了，但是没用。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi pb"><img src="../Images/610d8033393b420e807e35ee970de730.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xkgyYq56yLGLxQPob-kXWA.png"/></div></div></figure><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi pc"><img src="../Images/59aa2c3358dd2a962ab2458d7bcf7161.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cVbLEn-ZwMJ3v0F3hRPUtw.png"/></div></div></figure><p id="b0d1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这张屏幕截图中，您可以看到ESI标签起作用了，但是您能看出对此请求所做的更改吗？</p><p id="8a60" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一个训练有素的眼睛应该已经发现了编码在url <code class="fe mn mo mp mq b">%2e</code>中的URL<code class="fe mn mo mp mq b">. </code></p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi pd"><img src="../Images/145493edc78399b7a663324103c94a3c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ifR64FQWqcSBiHV4jrdH_Q.png"/></div></div></figure><p id="a7bf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">后端服务器</strong>解码了url中的<code class="fe mn mo mp mq b">%2e </code>并返回了相同的响应，<strong class="jp ir">缓存服务器</strong>没有忽略<code class="fe mn mo mp mq b">%2e </code>，因此它不再将其视为<em class="kl">静态文件</em>，因此它允许ESI标签工作。</p><p id="9633" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是可行的，但可悲的是这是不可利用的:(</p><p id="ec9d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你把这个网址发给受害者，当他加载这个网址时。浏览器将自动解码<code class="fe mn mo mp mq b">%2e </code>，因此请求被发送到原始端点，而不是我们想要的端点，因此ESI标签不会被呈现。</p><p id="7d69" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们在这上面花了更多的时间，但是无法解决如何让它在浏览器上也能工作。</p><p id="5378" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">离开了这个端点，转而寻找更多的端点进行测试。</p><p id="d9f4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">整整一个月过去了，我在测试另一个程序，在那里我有一个潜在的客户端路径遍历错误，例如假设在下面的js代码中，你可以控制<code class="fe mn mo mp mq b">key </code>变量。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi pd"><img src="../Images/1a7c24660936aed4777c87104d74df98.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cwGPCLWE3lePcdWrKoPVbQ.png"/></div></div></figure><p id="1476" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在同一个主机上还有一个jsonp回调端点，所以我试图加载它而不是<code class="fe mn mo mp mq b">/api.js </code>文件，这将允许我弹出一个警告</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi pe"><img src="../Images/3cc5b85366c8bba45f02be97fa70ba72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sG6bn-GfbAIOHhFE7Wa6Dg.png"/></div></div></figure><p id="0f00" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我试图做类似的事情，但是<code class="fe mn mo mp mq b">key </code>变量值取自查询参数，所以我不能使用<code class="fe mn mo mp mq b"># </code>符号。</p><p id="2661" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">就好像我把这个<code class="fe mn mo mp mq b"># </code>放在参数值里，它会被浏览器消耗掉，不会在<code class="fe mn mo mp mq b">key </code>变量值里被传递下去。</p><p id="7e51" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果我urlencode %23它，那么浏览器在获取js文件时不会自动解码它，所以我被困在这里。由于这部分代码，我也不能用<code class="fe mn mo mp mq b">? </code>来<code class="fe mn mo mp mq b"> </code>忽略<code class="fe mn mo mp mq b">/api.js</code>部分。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi pf"><img src="../Images/eb51bced2a087c0e05e40c07fb78fdea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nWBy13XKChCBZSkrY2AUTA.png"/></div></div></figure><p id="ad6a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<code class="fe mn mo mp mq b">getAllUrlParams </code>方法里面注意到了<code class="fe mn mo mp mq b"> </code>的第一行<code class="fe mn mo mp mq b">url.split('?')[1] , </code>那么如果我用？在我的url参数值中会发生这种情况</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div class="gh gi pg"><img src="../Images/7f960276f17c0637af0c7d42b69e2c41.png" data-original-src="https://miro.medium.com/v2/resize:fit:1282/format:webp/1*6LpeUpQOo9Dsk3czJPUPRg.png"/></div></figure><p id="1ef3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">由于split方法，<code class="fe mn mo mp mq b">? </code>将被完全忽略。</p><p id="8080" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当时我想，如果我在iframe中加载编码为#的url，可能会成功。但遗憾的是，这并没有奏效。</p><p id="b598" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我也想过在<em class="kl">修订的目标</em>上使用同样的想法，如果你不是急性子，记得这个端点吗？</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi pc"><img src="../Images/59aa2c3358dd2a962ab2458d7bcf7161.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cVbLEn-ZwMJ3v0F3hRPUtw.png"/></div></div></figure><p id="bc6f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果我在iframe中加载这个url会怎样？让我们找出答案</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi oi"><img src="../Images/d2c6eec4d609777764ce3621b3f25d98.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uusKhHzrIwvM_87BerA2Sg.png"/></div></div></figure><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi ph"><img src="../Images/43c13c22010b07ebd72789419a1491df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LsyF6INIG4clKi2KOrIROw.png"/></div></div></figure><p id="d426" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它确实起作用了:)</p><figure class="lh li lj lk gt ll"><div class="bz fp l di"><div class="pi ln l"/></div></figure><p id="9110" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当我试图在Chrome浏览器中加载相同的代码时，它不起作用:(</p><p id="59be" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mn mo mp mq b">%2e </code>被Chrome自动解码</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi oi"><img src="../Images/66db62604542345c0e1dbca65cc6a36b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wtoQ82I_oPNUFbeotMwOxg.png"/></div></div></figure><p id="eff1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">奇怪的是，这在Firefox中有效，但在Chrome中无效，我后来证实它在Safari中也和Firefox一样有效。</p><p id="732b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我很高兴它终于起作用了，我很快联系了nytr0gen告诉他这个好消息</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi pj"><img src="../Images/dd6620d398d20a32bfefc9adef160fe6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bNrln2kdAU6qkhsz9sbJyQ.png"/></div></div></figure><p id="89e2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在到了POC部分，当我使用<code class="fe mn mo mp mq b">HTTP_COOKIE , </code>时，我注意到所有的cookies都不存在，主要是用于会话目的的那个。我询问了ntr0gen，结果发现这是因为页面被加载到iframe中，而父页面来自不同的地方。</p><p id="dad9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，我们使用了另一个xss(使用我们的旧ESI注入bug创建的),并用它来iframe这个<code class="fe mn mo mp mq b">.json</code> url，瞧，这一次cookie出现了。</p><p id="d648" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当我尝试使用<code class="fe mn mo mp mq b">add_header </code>方法将<code class="fe mn mo mp mq b">application/json</code>内容类型更改为<code class="fe mn mo mp mq b">text/html </code>时，waf阻塞了请求，缩短后我发现waf现在阻塞了<code class="fe mn mo mp mq b">text/html</code>关键字。这个额外的规则可能是从我们之前的报告中设置的，所以我需要创建一个旁路。</p><p id="45c9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">经过模糊处理，我发现<code class="fe mn mo mp mq b">%09 </code>标签字符(<code class="fe mn mo mp mq b">\t</code>)被服务器转换成了<code class="fe mn mo mp mq b">t </code>。通过使用下面的有效载荷，可以改变<code class="fe mn mo mp mq b">Content-Type</code>，然后使用xss窃取会话cookie。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi pk"><img src="../Images/ea16197f5809318724ad5cdbe733527d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0ehpBJMKY2oFikGPgg4HAg.png"/></div></div></figure><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi pl"><img src="../Images/0fb53b0f673b83f3ea693d5ae40a0bda.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mQNg92C_DdV2eMAh5IEqpQ.png"/></div></div></figure><p id="03da" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这并没有得到2倍的回报，因为我们发现错误的资产不属于推广的一部分，我们同意它，因为他们仍然支付了高严重性，即使它只在Firefox中工作，而不是在Chrome中。</p><p id="c47e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后这里发生了另一件事，项目经理要求我们停止进一步测试ESI注入错误，因为他们正在微调他们的WAF。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi pm"><img src="../Images/ce6af52d1ae34be74ae90c33a6309e9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QiTam4KlJUUIBTw1u9IB8Q.png"/></div></div></figure><p id="57d4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们终于结束了，我希望你没有感到无聊，并喜欢阅读:)这就是全部，非常感谢你一直读到最后。希望你会喜欢它。</p><p id="3728" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">祝2023年好运</p><p id="5c7c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">大家好</p></div></div>    
</body>
</html>