<html>
<head>
<title>Bypassing CSRF Protection (I)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">绕过CSRF保护(一)</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/bypassing-csrf-protection-i-bc014384d0aa?source=collection_archive---------2-----------------------#2022-09-20">https://infosecwriteups.com/bypassing-csrf-protection-i-bc014384d0aa?source=collection_archive---------2-----------------------#2022-09-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="9253" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">嗨，我的名字是<strong class="jp ir">哈沙尔·穆贾希德</strong>，在这篇博客中，我们将讨论一些绕过csrf保护的<strong class="jp ir">技术。</strong></p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/10d7fac5a9b45766d5bf76bdce36ddf1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*r_5gAFw0ejp_TiIA.png"/></div></div></figure><p id="549d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你想了解csrf是什么，你可以在这里阅读我以前的博客。</p><div class="kx ky gp gr kz la"><a href="https://medium.com/@hasharmujahid/cross-site-request-forgery-csrf-explained-and-exploited-i-db464a61a582" rel="noopener follow" target="_blank"><div class="lb ab fo"><div class="lc ab ld cl cj le"><h2 class="bd ir gy z fp lf fr fs lg fu fw ip bi translated">跨站点请求伪造(CSRF)解释和利用I</h2><div class="lh l"><h3 class="bd b gy z fp lf fr fs lg fu fw dk translated">嗨！这篇博客将教你CSRF袭击是如何发生的，以及我们如何预防它们。</h3></div><div class="li l"><p class="bd b dl z fp lf fr fs lg fu fw dk translated">medium.com</p></div></div><div class="lj l"><div class="lk l ll lm ln lj lo kv la"/></div></div></a></div><p id="8486" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果应用程序只依赖于客户端的值，如cookies，那么应用程序将容易受到csrf攻击。攻击者可以很容易地欺骗用户点击恶意负载，并启动用户不希望发生的操作。</p><p id="ceb2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了防止csrf攻击，使用了Csrf令牌。现在你可能会有一个问题</p><p id="af6b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">什么是CSRF代币？</strong></p><p id="f3cb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">简而言之，csrf令牌是web应用程序分配给每个用户会话的随机生成的值，该值将在用户执行的每个post操作后更新。</p><p id="03d7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">CSRF令牌是如何工作的？</strong></p><p id="0552" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当用户在应用程序上执行任何操作时，请求包含用户会话(cookies)对吗？在这种情况下，请求还包含一个由应用程序在csrf参数中分配的<strong class="jp ir">随机生成值</strong>，该值将在服务器端进行验证。如果csrf值无效，那么服务器将停止处理该请求。</p><p id="50dd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">如何绕过CSRF保护？</strong></p><p id="f01f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">众所周知，如果任何协议被正确实现，那么我们就很少有机会绕过它。CSRF旁路的情况也是如此。如果有一些实现错误，那么我们可以绕过这种保护。</p><p id="bc40" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi">— — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — —</p><h2 id="2ca0" class="lp lq iq bd lr ls lt dn lu lv lw dp lx jy ly lz ma kc mb mc md kg me mf mg mh bi translated">1:检查CSRF值是否在后端得到验证。</h2><p id="1a4f" class="pw-post-body-paragraph jn jo iq jp b jq mi js jt ju mj jw jx jy mk ka kb kc ml ke kf kg mm ki kj kk ij bi translated">要测试CSRF是否正在后端进行验证，请尝试修改CSRF参数中的CSRF值，如果该值正在接受检查和验证，则发送请求。如果没有，则不应处理该请求。您将拥有一个有效的CSRF旁路。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mn"><img src="../Images/0a1e7c80bef5ed24d99ed347a7b0ec37.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wOXOaBmjimvtKSDcPNyazw.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">有效Csrf</figcaption></figure><p id="b58a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，当我们更改或修改该值时，我们可以看到服务器用一个无效的csrf令牌进行响应。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ms"><img src="../Images/d6820e83785dfa4c7f1ca46a4b10e735.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9cRMl5nDOzAzM8j4AoDImg.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">无效的csrf令牌。</figcaption></figure><p id="5e34" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果存在漏洞，应用程序应该会正确无误地将您重定向到您的配置文件。</p><p id="2c6d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi">— — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — —</p><p id="8e7b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> 2: CSRF，令牌验证依赖于令牌的存在。</strong></p><p id="3a65" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果我们从请求中删除csrf参数，一些应用程序会跳过csrf验证。简而言之，如果应用程序标记了缓和的或无效的令牌，我们可以尝试完全删除csrf参数，以查看我们的请求是否仍被处理。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ms"><img src="../Images/d6820e83785dfa4c7f1ca46a4b10e735.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9cRMl5nDOzAzM8j4AoDImg.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">检测到缓和令牌</figcaption></figure><p id="586f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们去掉csrf参数。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ms"><img src="../Images/25386e90e779b5d8a93fea92da34bcef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U696SALtVtWUMpd80EiddQ.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">移除的参数</figcaption></figure><p id="3c5a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以看到我们的请求是成功的。</p><p id="4f20" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以利用此漏洞代表用户执行非预期的操作，如通过生成csrf有效负载来更改用户的电子邮件。如果你想知道如何在没有专业打嗝的情况下生成csrf有效载荷，请阅读我以前的博客。</p><p id="b35f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">——————</strong></p><h2 id="f5d4" class="lp lq iq bd lr ls lt dn lu lv lw dp lx jy ly lz ma kc mb mc md kg me mf mg mh bi translated">3:CSRF令牌的验证取决于请求方法。</h2><p id="5a62" class="pw-post-body-paragraph jn jo iq jp b jq mi js jt ju mj jw jx jy mk ka kb kc ml ke kf kg mm ki kj kk ij bi translated">有时应用程序只验证post请求上的csrf，但这可能是一个严重的错误，因为攻击者也可以使用GET request方法代表用户执行类似的操作。</p><p id="7044" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以将请求类型更改为get from burp并测试此漏洞。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mt"><img src="../Images/354d16035a77e936f3f98f064da5decf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M9bTAfL01rQqQvhFOxylEA.png"/></div></div></figure><p id="083d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以看到，当我们调整请求中的令牌并发送它时，服务器响应了错误。</p><p id="e74e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在让我们改变请求方法，发送这个请求。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ms"><img src="../Images/6fa12f5b234cc612db26444b49e52608.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-mmsgCi8IHdvvlczcFJ6Hw.png"/></div></div></figure><p id="d166" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们现在可以看到，我们的缓和令牌没有得到验证，我们的请求成功了。</p><p id="d3d1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">——————</strong></p><h2 id="5274" class="lp lq iq bd lr ls lt dn lu lv lw dp lx jy ly lz ma kc mb mc md kg me mf mg mh bi translated">4: CSRF令牌与用户会话无关</h2><p id="d5b5" class="pw-post-body-paragraph jn jo iq jp b jq mi js jt ju mj jw jx jy mk ka kb kc ml ke kf kg mm ki kj kk ij bi translated">对于应用程序来说，验证csrf令牌是否属于发送请求的同一个会话也很重要。</p><p id="aead" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有时，攻击者可以注册一个帐户，并在有效负载中发送他们的有效csrf令牌，以使攻击成功。</p><p id="af9d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了解决这个问题，服务器应该验证令牌是否属于同一个会话。</p><p id="b94a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要测试此漏洞，请在web应用程序上创建两个帐户，并在执行操作时将一个帐户上的令牌更改为另一个帐户，如果请求完成，则发送请求，这意味着csrf值与用户会话无关。</p><div class="kx ky gp gr kz la"><a href="https://portswigger.net/web-security/csrf/lab-token-not-tied-to-user-session" rel="noopener  ugc nofollow" target="_blank"><div class="lb ab fo"><div class="lc ab ld cl cj le"><h2 class="bd ir gy z fp lf fr fs lg fu fw ip bi translated">实验室:CSRF，令牌与用户会话无关|网络安全学院</h2><div class="lh l"><h3 class="bd b gy z fp lf fr fs lg fu fw dk translated">练习利用现实目标的弱点。记录你从学徒到专家的进步。看哪里…</h3></div><div class="li l"><p class="bd b dl z fp lf fr fs lg fu fw dk translated">portswigger.net</p></div></div><div class="lj l"><div class="mu l ll lm ln lj lo kv la"/></div></div></a></div><p id="ecc0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">解决这个实验来练习我们所学的内容。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ms"><img src="../Images/76113d79ba4c6a6bfa5b00d97e46a6ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*c_2w6nDMmqySaK6hE2YdTQ.png"/></div></div></figure><p id="3f62" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">今天到此为止，我将在未来发布一些更先进的绕过CSRF保护的技术。</p><p id="71b0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在那之前快乐的黑客！❤</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mv mw l"/></div></figure><h2 id="6209" class="lp lq iq bd lr ls lt dn lu lv lw dp lx jy ly lz ma kc mb mc md kg me mf mg mh bi translated">来自Infosec的报道:Infosec每天都有很多内容，很难跟上。<a class="ae mx" href="https://weekly.infosecwriteups.com/" rel="noopener ugc nofollow" target="_blank">加入我们的每周时事通讯</a>以5篇文章、4个线程、3个视频、2个Github Repos和工具以及1个工作提醒的形式免费获取所有最新的Infosec趋势！</h2></div></div>    
</body>
</html>