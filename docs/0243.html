<html>
<head>
<title>Frappé Technologies ERPNext Server Side Template Injection</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Frappé Technologies ERPNext服务器端模板注入</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/frapp%C3%A9-technologies-erpnext-server-side-template-injection-74e1c95ec872?source=collection_archive---------0-----------------------#2019-01-23">https://infosecwriteups.com/frapp%C3%A9-technologies-erpnext-server-side-template-injection-74e1c95ec872?source=collection_archive---------0-----------------------#2019-01-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="e6ea" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">几个月前，我特别专注于研究电子病历web应用程序中出现的漏洞。在我的研究过程中，我发现了ERPNext，这是一款由Frappé Technologies Pvt. Ltd .开发的企业资源规划软件，它提供医疗保健模块和漏洞披露程序，因此我决定研究一下ERPNext，并审核他们产品的免费试用版。没过多久，我就在web应用程序用户配置文件页面中发现了一个服务器端模板注入漏洞。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/229952229dfa7dc6a48ddf846115aa08.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B_GcP5OL7FY2Z-fPM6fwNg.jpeg"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">服务器端模板注入概念验证</figcaption></figure><p id="e9b4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如你在上面的照片中看到的，名<code class="fe lb lc ld le b">{{7*7}}</code>和姓<code class="fe lb lc ld le b">{{8*8}}</code>字段在上面被渲染为<code class="fe lb lc ld le b">49</code>和<code class="fe lb lc ld le b">64</code>。这非常清楚地表明存在模板注入漏洞。我使用了下面的图片，它是在https://portswigger.net/blog/server-side-template-injection的Portswigger博客上找到的，作者是James Kettle，我用它来标识被用作Jinja2的模板引擎。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi lg"><img src="../Images/546c4d5a9fb6eed435684e9f496e972f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*jeI82s02ke_rf8bh-gnk8A.png"/></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">模板引擎识别流程图</figcaption></figure><p id="1cc5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，我将名字字段设置为:</p><pre class="km kn ko kp gt lh le li lj aw lk bi"><span id="ee63" class="ll lm iq le b gy ln lo l lp lq">{{ ''.__class__.__mro__[2].__subclasses__()[40]('/etc/passwd').read() }}</span></pre><p id="e89d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">刷新页面后，我看到了下面的页面，这表明我在运行web应用程序的服务器上具有读取功能。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lr"><img src="../Images/4d221c28762cd417e60e68f7dfde585c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a-FKLy13PLSXjjERwzK4LA.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">成功读取任意文件</figcaption></figure><p id="6153" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，我将我的名字设置为:</p><pre class="km kn ko kp gt lh le li lj aw lk bi"><span id="cf9e" class="ll lm iq le b gy ln lo l lp lq">{{ ''.__class__.__mro__[2].__subclasses__()[40]('/home/frappe/PoC.txt', 'w').write(' Proof of Concept: <a class="ae lf" href="mailto:brian@hyde.solutions" rel="noopener ugc nofollow" target="_blank">brian@hyde.solutions</a>') }}</span></pre><p id="8275" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">刷新页面，然后将我的名字设置为:</p><pre class="km kn ko kp gt lh le li lj aw lk bi"><span id="df61" class="ll lm iq le b gy ln lo l lp lq">{{ ''.__class__.__mro__[2].__subclasses__()[40]('/home/frappe/PoC.txt').read() }}</span></pre><p id="b52a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">又刷新了一次，出现了以下消息，表明我也能够在文件系统上成功地写入文件。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ls"><img src="../Images/fed2ebcd78a7d7a35c0dfe8536ed44e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rAoGu4gbYunRjsvbA18Nuw.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">读+写概念证明成功</figcaption></figure><p id="3075" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我也能够读取他们的SSH RSA私钥，但是我不会张贴那张图片，因为我不认为Frappé的人会喜欢那样。总之，这是一个非常严重的安全缺陷。我向Frappé报告了这个漏洞，他们很快推出了一个补丁，似乎部分解决了这个问题。从本质上讲，他们试图修补这个问题只是将任何包含字符串<code class="fe lb lc ld le b">.__</code>的名字列入黑名单，而不是呈现模板。然而，其他任何东西，比如<code class="fe lb lc ld le b">{{ 7*7 }}</code>，仍然会被渲染为<code class="fe lb lc ld le b">49</code>。在阅读了Frappé的一些文档并在Github上查看了ERPNext的一些源代码后，我发现通过提交以下模板语法作为我的名字或姓氏，我甚至可以泄漏更敏感的信息:</p><pre class="km kn ko kp gt lh le li lj aw lk bi"><span id="d92f" class="ll lm iq le b gy ln lo l lp lq">{{ frappe.local.conf }}</span></pre><p id="b190" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">刷新页面后，将显示以下信息:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lt"><img src="../Images/1a3407b843de20f205b9f29daab519ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O-3ed2Pp3oOyb2xvUU7jRw.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">成功的Frappe本地配置泄漏</figcaption></figure><p id="4cd1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后我第二次报告了这个问题，看起来他们推出的补丁比之前的好得多。ERPNext的开发人员非常感谢我的审计和报告，并因此奖励了我1250美元。我想指出的是，Frappé的漏洞披露计划并没有正式提供奖励。但是，他们会给予认可，并为您发现并负责任地向他们披露的任何漏洞分配一个CVE。</p><p id="d3ad" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">除了上面列出的SSTI，我还在下面的电子邮件回复中发现了多个XSS漏洞、一个SQL注入漏洞和另一个SSTI:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lu"><img src="../Images/7b13078de4a5522fc93703f30f92a2ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dz9gFVRHL_6crxPHOqrEGA.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">SSTI概念验证</figcaption></figure><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lv"><img src="../Images/27a8910131b18935ea0bd173af08e7d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IYcl4Nyp1KYkjoXGBH10HA.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">SSTI概念验证</figcaption></figure><p id="c5cc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">总之，如果你想为一个开源软件基金会做贡献，或者找一个好的目标来获得一些实践，并且CVE被分配到你的发现中，请查看由Frappé Technologies Pvt. Ltd .提供的ERPNext</p><div class="lw lx gp gr ly lz"><a href="https://erpnext.com/report" rel="noopener  ugc nofollow" target="_blank"><div class="ma ab fo"><div class="mb ab mc cl cj md"><h2 class="bd ir gy z fp me fr fs mf fu fw ip bi translated">报告安全漏洞</h2><div class="mg l"><h3 class="bd b gy z fp me fr fs mf fu fw dk translated">您有责任遵守所有适用的法律，并且只能使用或以其他方式访问您自己的测试…</h3></div><div class="mh l"><p class="bd b dl z fp me fr fs mf fu fw dk translated">erpnext.com</p></div></div></div></a></div><div class="lw lx gp gr ly lz"><a href="https://frappe.io/security" rel="noopener  ugc nofollow" target="_blank"><div class="ma ab fo"><div class="mb ab mc cl cj md"><h2 class="bd ir gy z fp me fr fs mf fu fw ip bi translated">Frappe安全通报</h2><div class="mg l"><h3 class="bd b gy z fp me fr fs mf fu fw dk translated">此安全公告包含有关影响Frappe的漏洞的详细信息。</h3></div><div class="mh l"><p class="bd b dl z fp me fr fs mf fu fw dk translated">弗拉佩. io</p></div></div></div></a></div></div></div>    
</body>
</html>