<html>
<head>
<title>QNAP Pre-Auth Root RCE Affecting ~312K Devices on the Internet</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">影响互联网上大约312K设备的QNAP预授权根RCE</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/qnap-pre-auth-root-rce-affecting-450k-devices-on-the-internet-d55488d28a05?source=collection_archive---------2-----------------------#2020-05-18">https://infosecwriteups.com/qnap-pre-auth-root-rce-affecting-450k-devices-on-the-internet-d55488d28a05?source=collection_archive---------2-----------------------#2020-05-18</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="2e67" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">2019年，我在QNAP PhotoStation和CGI程序中发现了多个漏洞。这些漏洞可以链接成一个<strong class="js iu">预授权根RCE </strong>。所有QNAP NAS模型都存在漏洞，互联网上存在~312K的漏洞QNAS实例(统计预测)。这些漏洞已被负责任地报告、修复和分配<a class="ae ko" href="https://nvd.nist.gov/vuln/detail/CVE-2019-7192)" rel="noopener ugc nofollow" target="_blank">CVE-2019–7192</a>(CVSS 9.8)<a class="ae ko" href="https://nvd.nist.gov/vuln/detail/CVE-2019-71923" rel="noopener ugc nofollow" target="_blank">CVE-2019–7193</a>(CVSS 9.8)<a class="ae ko" href="https://nvd.nist.gov/vuln/detail/CVE-2019-7194" rel="noopener ugc nofollow" target="_blank">CVE-2019–7194</a>(CVSS 9.8)<a class="ae ko" href="https://nvd.nist.gov/vuln/detail/CVE-2019-7195" rel="noopener ugc nofollow" target="_blank">CVE-2019–7195</a>(CVSS 9.8)。这篇文章是第一次公开披露，但只有3个漏洞被披露，因为它们足以实现预授权根RCE。</p><h1 id="721c" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">影响</h1><h2 id="17ca" class="ln kq it bd kr lo lp dn kv lq lr dp kz kb ls lt ld kf lu lv lh kj lw lx ll ly bi translated">脆弱的实例</h2><p id="c328" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated">下面的Shodan搜索揭示了互联网上的564K QNAP实例。其中，1065个随机选择的实例中有590个启用了Photo Station。(通过<code class="fe me mf mg mh b">GET /photo/slideshow.php</code>检查，看它是否用<code class="fe me mf mg mh b">Invalid album selection</code>响应)因此，从统计上来说，在<a class="ae ko" href="https://www.surveysystem.com/sscalc.htm" rel="noopener ugc nofollow" target="_blank"> 95%置信水平，置信区间3 </a>的情况下，应该有~312K个实例启用了Photo Station，并且它们在当时(2019)都是易受攻击的。</p><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div class="gh gi mi"><img src="../Images/c9f797fb4cb3cd1edf97f6c0761373f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:856/format:webp/1*2tyz2oz9tuKI_ElP-EG7HA.png"/></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk translated">在Shodan上发现564K QNAP实例</figcaption></figure><h2 id="dc1a" class="ln kq it bd kr lo lp dn kv lq lr dp kz kb ls lt ld kf lu lv lh kj lw lx ll ly bi translated">受影响的照片站版本</h2><p id="8530" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated">修复版本(6.0.3、5.2.11、5.4.9)之前的所有可下载版本都受到了影响。</p><p id="fe82" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">请访问<a class="ae ko" href="https://www.qnap.com/zh-tw/security-advisory/nas-201911-25" rel="noopener ugc nofollow" target="_blank"> QNAP的安全顾问</a>了解版本信息等详细信息。</p><h1 id="04bf" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">编辑</h1><p id="ab04" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated"><strong class="js iu">根据QNAP PSIRT的要求，这篇文章已经做了很大的修改，以便为更多用户提供更长的时间来获得补丁</strong>。我们一起建设一个更安全的世界。</p></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><p id="2df1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，让我们来看看这3个漏洞，它们稍后将被链接起来，形成一个预授权根RCE。</p><h1 id="3519" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">漏洞1:预授权本地文件泄露(有效的绕过登录)</h1><p id="9eb2" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated"><strong class="js iu">【修订】</strong></p><h1 id="398b" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">将预授权本地文件公开升级到权限提升(绕过登录)</h1><p id="314d" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated">我们可以使用这个预先授权的本地文件公开来读取一个包含一个<strong class="js iu">登录令牌</strong>的神奇文件，我们可以用它来验证一个有效的内置用户<code class="fe me mf mg mh b">appuser</code>。</p><p id="1b0b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">魔法文件[已编辑]:</p><pre class="mj mk ml mm gt nb mh nc nd aw ne bi"><span id="1fb2" class="ln kq it mh b gy nf ng l nh ni">[redacted]</span></pre><ul class=""><li id="3f8d" class="nj nk it js b jt ju jx jy kb nl kf nm kj nn kn no np nq nr bi translated">恢复出厂设置后，文件内容不会改变</li><li id="df2f" class="nj nk it js b jt ns jx nt kb nu kf nv kj nw kn no np nq nr bi translated">该文件在<code class="fe me mf mg mh b">[redacted]</code>第一次成功时生成</li><li id="d876" class="nj nk it js b jt ns jx nt kb nu kf nv kj nw kn no np nq nr bi translated"><code class="fe me mf mg mh b">[redacted]</code>是加密的</li><li id="f569" class="nj nk it js b jt ns jx nt kb nu kf nv kj nw kn no np nq nr bi translated">PhotoStation缓存了<code class="fe me mf mg mh b">[redacted]</code>中<code class="fe me mf mg mh b">[redacted]</code>的<strong class="js iu">明文</strong>版本</li></ul><pre class="mj mk ml mm gt nb mh nc nd aw ne bi"><span id="0923" class="ln kq it mh b gy nf ng l nh ni">[redacted]</span></pre><p id="16f1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">因此，我们可以利用漏洞1来<strong class="js iu">读取缓存的明文令牌以绕过登录</strong>并认证为<code class="fe me mf mg mh b">appuser</code>:</p><p id="7ce3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">[编辑:绕过认证的图片]</p><p id="3fc1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">用这个技巧，漏洞1实际上是一个<strong class="js iu">认证旁路</strong>。</p><p id="2f5f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">快速回顾:</p><ul class=""><li id="6ef8" class="nj nk it js b jt ju jx jy kb nl kf nm kj nn kn no np nq nr bi translated">[已编辑]</li><li id="71be" class="nj nk it js b jt ns jx nt kb nu kf nv kj nw kn no np nq nr bi translated">[已编辑]</li><li id="4f7f" class="nj nk it js b jt ns jx nt kb nu kf nv kj nw kn no np nq nr bi translated">[已编辑]</li></ul><h1 id="cceb" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">漏洞2:认证会话篡改——将PHP代码写入会话</h1><p id="8c76" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated">被认证为<code class="fe me mf mg mh b">appuser</code>使我们能够访问SMTP设置，该设置在电子邮件字符串中有一个<strong class="js iu">不正确的过滤。经过认证的攻击者可以[编校]，这可以链接到下一个漏洞，或者其他文件包含漏洞(例如<code class="fe me mf mg mh b">[redacted]</code>)。</strong></p><h2 id="6620" class="ln kq it bd kr lo lp dn kv lq lr dp kz kb ls lt ld kf lu lv lh kj lw lx ll ly bi translated">POC:认证的会话篡改</h2><p id="3766" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated"><strong class="js iu">【编辑的会话篡改图片】</strong></p><h1 id="ba91" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">漏洞3:(预授权)将会话写入任意位置</h1><p id="7df2" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated">根据QNAP PSIRT的要求，对本节进行了编辑。</p><p id="e5e8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">此漏洞使得未经验证的攻击者能够将会话内容(<code class="fe me mf mg mh b">[redacted]</code>)写入服务器上的任意位置。</p><p id="d4fe" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">易受攻击的代码:</p><p id="887c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">【修订版】</strong></p><h2 id="7df4" class="ln kq it bd kr lo lp dn kv lq lr dp kz kb ls lt ld kf lu lv lh kj lw lx ll ly bi translated">POC:将会话写入任意位置</h2><p id="5e91" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated"><strong class="js iu">【编校】</strong></p><h1 id="05f1" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">预授权根RCE的链接</h1><ul class=""><li id="ebe3" class="nj nk it js b jt lz jx ma kb nx kf ny kj nz kn no np nq nr bi translated">利用漏洞1绕过认证，认证为<code class="fe me mf mg mh b">appuser</code></li><li id="951f" class="nj nk it js b jt ns jx nt kb nu kf nv kj nw kn no np nq nr bi translated">利用漏洞2将[修订的]代码(通过SMTP电子邮件)放入[修订的]会话(<code class="fe me mf mg mh b">[redacted]</code>)</li><li id="efb8" class="nj nk it js b jt ns jx nt kb nu kf nv kj nw kn no np nq nr bi translated">利用漏洞3将被污染的[修订的]会话写入Photo Station的web目录，以创建一个webshell</li></ul><p id="7876" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">[已编辑]</p><h1 id="f039" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">公开</h1><ul class=""><li id="1a5a" class="nj nk it js b jt lz jx ma kb nx kf ny kj nz kn no np nq nr bi translated">2019/06/14:向QNAP报告技术细节</li><li id="66ba" class="nj nk it js b jt ns jx nt kb nu kf nv kj nw kn no np nq nr bi translated">2019/12/16:供应商修复了所有4个漏洞，提出提供赏金(由于赏金条款，金额被隐藏)</li><li id="30da" class="nj nk it js b jt ns jx nt kb nu kf nv kj nw kn no np nq nr bi translated">2019/12/31:获得赏金</li><li id="8155" class="nj nk it js b jt ns jx nt kb nu kf nv kj nw kn no np nq nr bi translated">2020/05/19:公开披露</li><li id="6a33" class="nj nk it js b jt ns jx nt kb nu kf nv kj nw kn no np nq nr bi translated">2020/06/09:应供应商要求，修改了漏洞1的详细信息</li><li id="0663" class="nj nk it js b jt ns jx nt kb nu kf nv kj nw kn no np nq nr bi translated">2020/06/10:应供应商要求，修改了漏洞2和2的详细信息</li><li id="f179" class="nj nk it js b jt ns jx nt kb nu kf nv kj nw kn no np nq nr bi translated">2020/06/19:应供应商要求进行更多编辑</li></ul><h1 id="b2c5" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">结论</h1><p id="8923" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated">3个漏洞被链接起来，以获得QNAP PhotoStation中的预授权根RCE，它可以在QNAP的所有NAS型号上工作。还公开了利用QNAP产品的几种技巧。希望QNAP有一天能解决这些问题，否则我敢肯定会有更多的高CVSS简历出现。</p><h2 id="caef" class="ln kq it bd kr lo lp dn kv lq lr dp kz kb ls lt ld kf lu lv lh kj lw lx ll ly bi translated">关键要点:</h2><ul class=""><li id="b050" class="nj nk it js b jt lz jx ma kb nx kf ny kj nz kn no np nq nr bi translated"><a class="ae ko" href="https://www.qnap.com/zh-tw/security-advisory/nas-201911-25" rel="noopener ugc nofollow" target="_blank">如果您还没有升级QNAP NAS，现在就升级</a></li><li id="a4e7" class="nj nk it js b jt ns jx nt kb nu kf nv kj nw kn no np nq nr bi translated">[已编辑]</li><li id="4ef1" class="nj nk it js b jt ns jx nt kb nu kf nv kj nw kn no np nq nr bi translated">有一种方法可以解密<code class="fe me mf mg mh b">[redacted]</code>，但我会把它作为家庭作业留给你</li><li id="c857" class="nj nk it js b jt ns jx nt kb nu kf nv kj nw kn no np nq nr bi translated">QNAP的网络服务器以[修订版]运行</li><li id="b210" class="nj nk it js b jt ns jx nt kb nu kf nv kj nw kn no np nq nr bi translated">[修订]可能会给你更多的0天</li></ul><h2 id="09c4" class="ln kq it bd kr lo lp dn kv lq lr dp kz kb ls lt ld kf lu lv lh kj lw lx ll ly bi translated">供应商咨询</h2><p id="8e8e" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated"><a class="ae ko" href="https://www.qnap.com/zh-tw/security-advisory/nas-201911-25" rel="noopener ugc nofollow" target="_blank">https://www.qnap.com/zh-tw/security-advisory/nas-201911-25</a></p></div></div>    
</body>
</html>