<html>
<head>
<title>Vulnerable Websocket Server</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">易受攻击的Websocket服务器</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/vulnerable-websocket-server-e44bee5e0b5f?source=collection_archive---------1-----------------------#2022-08-13">https://infosecwriteups.com/vulnerable-websocket-server-e44bee5e0b5f?source=collection_archive---------1-----------------------#2022-08-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="d571" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本文中，我们将讨论一些websocket漏洞。为了测试安全漏洞，需要在<a class="ae kl" href="https://github.com/Serhatcck/vulnsocket" rel="noopener ugc nofollow" target="_blank">github</a>(【https://github.com/Serhatcck/vulnsocket】T2)中安装repo。</p><p id="469f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">安装后，我们会在登录页面上看到它。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/ecc0521734a8a44434cc8f909a498dc6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C5LH2SyTN87LRgz7mYEZYQ.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">Vulnsocket登录页面</figcaption></figure><p id="6ca0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们必须在登录前创建一个用户。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi lc"><img src="../Images/30ce04f0005fe14d552398648f24ebe1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dYtqMngLQFIbEsbAxcK9EQ.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">Vulnsocket注册页面</figcaption></figure><p id="992d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">注册后，我们被重定向到index.php。我们在这个页面上看到两个不同的漏洞。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi ld"><img src="../Images/95245fc97082ba0176916114ef561b32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ImqwsG8BfVQjLHle0oHnjg.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">Vulnsocket索引页面</figcaption></figure></div><div class="ab cl le lf hu lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="ij ik il im in"><h1 id="7e23" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">CSWSH</h1><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi mj"><img src="../Images/567f813eaa53e029b283a174acb84367.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mS4JCX_q1MRbuz_q5uVQCw.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">Vulnsocket CSWSH页面</figcaption></figure><p id="c44a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这个页面上，我们可以看到一个简单的消息应用程序。我们正在用python启动WebSocket服务器。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi mk"><img src="../Images/59f197d50c38ca675ec7ed05a6fb4536.png" data-original-src="https://miro.medium.com/v2/resize:fit:896/format:webp/1*vUz1EnMy2z59KfYwQln72w.png"/></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">CSWSH套接字服务器</figcaption></figure><p id="f86c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当我们刷新页面时，我们看到连接状态已经改变。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi ml"><img src="../Images/9e71ba056dec8abb1d1ef8c3af75ac62.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gYte7z5eeZgMR1_TE45FUA.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">Vulnsocket CSWSH页面</figcaption></figure><p id="01f3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们开始发信息。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi mm"><img src="../Images/4178be3778c6cb9d4b55ea5382fa45d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7qS-yo_zg6w0qbho-r4P4w.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">Vulnsocket CSWSH页面</figcaption></figure><p id="b22f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以在Burp Suite上看到websocket连接请求</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi mn"><img src="../Images/38a036cacaaf0e04190fad2dad653cbe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oHFalTgzNxdrPgVjQL7nUQ.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">Burp套件Web套接字请求</figcaption></figure><p id="3db0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以看到websocket消息。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi mo"><img src="../Images/bea6b8b1f074c452350186cbef18a9a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pxJ1aXZMV9VHGFZS6x_tkw.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">Burp套件Web套接字消息</figcaption></figure><p id="ce64" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在上图看到的websocket连接请求中，我们看不到任何csrf令牌信息。这就是为什么我们开始尝试跨站点Websocket劫持漏洞。</p><p id="e5a8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了利用跨站点Websocket劫持漏洞，有必要创建一个HTML/JS poc。这个HTML页面应该向websocket服务器发送一个连接请求，并且能够提取配置文件信息。在提取配置文件信息后，它应该将配置文件信息发送给Burp Collaborator。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="c550" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们需要测试上面的HTML页面是否有效。这就是我们访问这个页面的原因。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi mr"><img src="../Images/2578928f0fb62a3143e7ff8c8556b332.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*af02j6PkysOnZyZhGSYhlg.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">漏洞利用页面</figcaption></figure><p id="e90d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Burp Suite Collaborator客户端:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi ms"><img src="../Images/4eac4c82c5e5ba853a03f3559242f6d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q-4ayj38K2JFHq4dOkcn-A.png"/></div></div></figure><p id="9563" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如我们在上面的图片中所看到的，该页面运行成功。现在我们需要在管理员用户中运行这个页面。为此，我们需要运行cswsh_exploit.py</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi mt"><img src="../Images/551b3320e39b20b9095e390a9ab2c57f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nSxpKERNax4627YJv0xChg.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">cswsh_exploit.py</figcaption></figure><p id="5dcb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Python代码运行后，我们将看到管理员用户的信息被放入Collaborator:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi mu"><img src="../Images/b3f5b46d637dc5b5301714988908332c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LIE1lMBkQuMiAazAMvugsA.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">合作者客户</figcaption></figure><p id="3def" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">看到admin用户的信息后，我们需要做的就是修改admin用户的密码。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mp mq l"/></div></figure><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi mv"><img src="../Images/bb27fb2b0a842024a57a7d061e51ab97.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y-gTLdtxgnjylr6qmagz2Q.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">cswsh_exploit.py</figcaption></figure><p id="fc6a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Python代码运行后，我们将看到管理员用户的密码信息被放入Collaborator:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi mw"><img src="../Images/5bdbb95ae0c56f4e8d45ac594a9c6cf1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Psbobkw9kmSwV7dVpoGDfw.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">合作者客户</figcaption></figure><p id="9d1a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将使用管理员用户的信息登录(admin@admin.com:admin)</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi mx"><img src="../Images/38d52114d987a453445be10468f743b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ApOmG1Q5rX-GsMEiCkDYEw.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">Vulnsocket索引页面</figcaption></figure></div><div class="ab cl le lf hu lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="ij ik il im in"><h1 id="89f9" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">如何预防CSWSH？</h1><p id="1f1d" class="pw-post-body-paragraph jn jo iq jp b jq my js jt ju mz jw jx jy na ka kb kc nb ke kf kg nc ki kj kk ij bi translated">为了理解如何防止漏洞，有必要检查cswsh_secure.php页面。在此页面上，Websocket连接请求按如下方式发送:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/a06324284d77d47e70353d21715adeda.png" data-original-src="https://miro.medium.com/v2/resize:fit:956/format:webp/1*noqFZyelm1LesuRGGk90xw.png"/></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">Websocket连接请求</figcaption></figure><p id="3998" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个令牌值是用户特定的，并且是可任意使用的。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/59c21e668abf60d20f538cc1a0ec30df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1088/format:webp/1*39xHEtHyNHk3YsiI9RoKVg.png"/></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">cswsh_secure.php</figcaption></figure><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi nf"><img src="../Images/778a778a4c1ea2604c669bae5cb16a3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d9lYWCXT_e0-DA0eqdY-4A.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">socket_cswsh_secure.py</figcaption></figure><p id="c8dc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因为我们不知道admin用户的令牌值，所以消除了这个CSWSH漏洞。</p></div></div>    
</body>
</html>