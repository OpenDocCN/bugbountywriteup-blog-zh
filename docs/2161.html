<html>
<head>
<title>Let’s Understand SSRF vulnerability</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">让我们理解SSRF的脆弱性</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/lets-understand-ssrf-vulnerability-6f1d28b228f9?source=collection_archive---------0-----------------------#2022-07-01">https://infosecwriteups.com/lets-understand-ssrf-vulnerability-6f1d28b228f9?source=collection_archive---------0-----------------------#2022-07-01</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/fdb1bf76011be72aed74bba26e1648cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ng8Lok1fxomlENRU"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated"><strong class="bd kf">照片由</strong> <a class="ae kg" href="https://unsplash.com/@nateggrant?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> <strong class="bd kf">张瀚授</strong> </a> <strong class="bd kf">上</strong> <a class="ae kg" href="https://unsplash.com/s/photos/coding?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> <strong class="bd kf">下</strong> </a></figcaption></figure><p id="7d26" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated"><strong class="kj iu">简介</strong></p><p id="c78e" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">在大多数情况下，OWASP Top 10会发布一个漏洞列表。这些是包含各种类型漏洞的宽泛类别。开放Web应用程序安全项目(OWASP)提供了许多不同方面的定义，包括它调查的许多类型的漏洞以及对这些缺陷的补救措施。该列表是根据漏洞被发现的频率以及缺陷的严重性和发生率生成的。SSRF是一个严重程度很高的漏洞，是OWASP十大漏洞之一，也是最常检测到的漏洞之一。SSRF攻击通常具有很高的严重性，因为它允许攻击者从服务器检索大量敏感信息，例如当前使用的协议版本，还允许攻击者访问服务器上可能包含敏感信息的一些文件。如果凭据被泄露，这些文件也可以被用来控制服务器，并随意使用它。利用SSRF的方式有很多种，但攻击者的主要目标是绕过防火墙限制，以访问内部系统和网络。</p><p id="c066" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated"><strong class="kj iu">什么是SSRF/服务器端请求伪造攻击？</strong></p><figure class="lg lh li lj gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi lf"><img src="../Images/606d8e1d13e7a29b537d5b7542097a30.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*2s4vf3q9Na62prHG"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated"><a class="ae kg" href="https://www.cobalt.io/blog/a-pentesters-guide-to-server-side-request-forgery-ssrf" rel="noopener ugc nofollow" target="_blank"> <strong class="bd kf">来源</strong> </a></figcaption></figure><p id="4d9d" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">如果没有输入验证并且没有维护URL的白名单，攻击者就能够强迫易受攻击的服务器在第三方服务器或作为组织内部基础架构一部分的任何内部服务器上执行恶意请求。如果网站的公共服务器向内部服务器发出任何请求以获取诸如文件、股票等信息。，那么这次攻击正在进行。在这种攻击中，如果网站的公共服务器向内部服务器发出任何请求，如果攻击者通过组织的内部服务器重定向请求，那么它可能绕过内部服务器限制，并可能对组织的敏感信息构成威胁。有时，攻击者对服务器的控制很少或只有部分控制，因为许多内部服务没有向外部用户公开。如果攻击者通过组织的内部服务器重定向请求，则可能会对组织的敏感信息造成威胁。此请求可能会导致额外的攻击，如跨站点攻击，包括枚举服务器上的端口和服务，这可能会对易受攻击的服务器造成损害；远程代码执行；未经授权访问内部应用程序和服务；能够读取存储在内部服务器上的信息；扫描内部和外部网络。</p><p id="ea5d" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated"><strong class="kj iu">让我们来理解简单剥削</strong></p><p id="8820" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">因为这些内部服务器位于防火墙后面，所以不属于内部网络的用户无法使用它们。这意味着普通用户将无法访问它们；相反，只有内部系统和服务能够做到这一点。在攻击的这一阶段，攻击者执行端口扫描，搜索内部应用程序，并检查任何被认为是敏感的和可能被利用的信息。</p><p id="646c" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">在公共服务器与内部服务器交互之前，这种攻击永远不会发生。通过他们系统的公众形象。大多数情况下，这个问题的出现是因为相关的应用程序缺少任何类型的URL白名单。如果没有这一点，对手可以欺骗服务器发送恶意请求，以便与网络的内部服务进行通信。</p><p id="c828" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated"><strong class="kj iu">它们为什么会发生？</strong></p><p id="baae" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">当应用程序没有足够的可访问资源的白名单时，或者当请求没有输入验证时，这些类型的攻击就可能发生。这可能会导致攻击者访问一些不打算让他们访问的服务。</p><figure class="lg lh li lj gt ju gh gi paragraph-image"><div class="gh gi lk"><img src="../Images/777dd33850a73169fe2ced9a5e080a91.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*nM_TjOVLRqmiDRU_"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated"><a class="ae kg" href="https://hdivsecurity.com/bornsecure/ssrf-what-is-server-side-request-forgery/" rel="noopener ugc nofollow" target="_blank">来源</a></figcaption></figure><p id="927c" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">让我们来看一个例子，看看它是否对我们有所帮助。当提供一个URL时，我们有一个应用程序将使用该URL获取图像。这意味着它导航到所提供的URL，并在URL上查找图像。如果图像被发现，它将被呈现在网页上，以便可以显示。该应用程序正在使用下面句子中描述的这段代码。</p><blockquote class="ll lm ln"><p id="11b0" class="kh ki lo kj b kk kl km kn ko kp kq kr lp kt ku kv lq kx ky kz lr lb lc ld le im bi translated"><?php </root?></p><p id="b332" class="kh ki lo kj b kk kl km kn ko kp kq kr lp kt ku kv lq kx ky kz lr lb lc ld le im bi translated">if (isset($_GET[‘url’])){</p><p id="8dfb" class="kh ki lo kj b kk kl km kn ko kp kq kr lp kt ku kv lq kx ky kz lr lb lc ld le im bi translated">$url = $_GET[‘url’];</p><p id="3f0c" class="kh ki lo kj b kk kl km kn ko kp kq kr lp kt ku kv lq kx ky kz lr lb lc ld le im bi translated"># Open file in read mode to fetch the image from the user supplied URL</p><p id="7fa7" class="kh ki lo kj b kk kl km kn ko kp kq kr lp kt ku kv lq kx ky kz lr lb lc ld le im bi translated">$file = fopen($url, ‘rb’);</p><p id="3d97" class="kh ki lo kj b kk kl km kn ko kp kq kr lp kt ku kv lq kx ky kz lr lb lc ld le im bi translated"># Set the image header</p><p id="a50a" class="kh ki lo kj b kk kl km kn ko kp kq kr lp kt ku kv lq kx ky kz lr lb lc ld le im bi translated">header(“Content-Type: image/png”);</p><p id="9095" class="kh ki lo kj b kk kl km kn ko kp kq kr lp kt ku kv lq kx ky kz lr lb lc ld le im bi translated"># Dump the file</p><p id="efe9" class="kh ki lo kj b kk kl km kn ko kp kq kr lp kt ku kv lq kx ky kz lr lb lc ld le im bi translated">fpassthru($file);</p><p id="af50" class="kh ki lo kj b kk kl km kn ko kp kq kr lp kt ku kv lq kx ky kz lr lb lc ld le im bi">}</p><p id="a95c" class="kh ki lo kj b kk kl km kn ko kp kq kr lp kt ku kv lq kx ky kz lr lb lc ld le im bi translated">echo ‘Please enter image url’</p><p id="f27d" class="kh ki lo kj b kk kl km kn ko kp kq kr lp kt ku kv lq kx ky kz lr lb lc ld le im bi">?&gt;</p></blockquote><p id="2e06" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">As soon as a URL is provided, it will look for the image on that URL and will fetch the image from the webpage. This process occurs immediately once the URL is submitted, as described above.</p><p id="72ab" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated"><strong class="kj iu">假设你有这样的图片网址</strong><a class="ae kg" href="http://example.com/image.jpg" rel="noopener ugc nofollow" target="_blank"><strong class="kj iu">【http://example.com/image.jpg】</strong></a></p><p id="9776" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated"><a class="ae kg" href="http://localhost/fetchimage.php?img" rel="noopener ugc nofollow" target="_blank">http://vulnerable-website.com/fetchimagebyurl.php?</a>网址=<strong class="kj iu">http://example.com/image.jpg</strong></p><p id="d74a" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">如果没有输入验证和URL白名单，那么攻击者就有可能使用这些端点从服务器访问敏感文件。诸如</p><p id="54a4" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated"><a class="ae kg" href="http://localhost/fetchimage.php?img" rel="noopener ugc nofollow" target="_blank">http://vulnerable-website.com/fetchimagebyurl.php?</a>网址=<strong class="kj iu">http://example.com/image.jpg</strong></p><p id="111b" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">由于没有验证，这个URL将被处理，应用程序将获取并呈现包含所有用户信息的/etc/passwd文件的内容。</p><p id="9b8b" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">它还可以通过提供元数据URL来获取AWS实例的信息，如密钥或秘密，例如</p><p id="ab94" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated"><a class="ae kg" href="http://169.254.169.254/latest/meta-data/hostname" rel="noopener ugc nofollow" target="_blank"><strong class="kj iu"><em class="lo">http://169 . 254 . 169 . 254/最新/元数据/主机名</em> </strong> </a></p><p id="bc8d" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated"><strong class="kj iu">例子</strong></p><p id="130f" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated"><a class="ae kg" href="http://localhost/fetchimage.php?img" rel="noopener ugc nofollow" target="_blank">http://vulnerable-website.com/fetchimagebyurl.php?</a>网址=<a class="ae kg" href="http://169.254.169.254/latest/meta-data/hostname" rel="noopener ugc nofollow" target="_blank">http://169 . 254 . 169 . 254/最新/元数据/主机名</a></p><p id="b204" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">攻击者可以执行端口扫描，因为他会尝试使用url连接到不同的服务。例如127.0.0.1:21。如果服务器返回任何响应，则端口打开，如果没有，则端口关闭。</p><p id="7357" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated"><strong class="kj iu">补救:</strong></p><ul class=""><li id="a6c0" class="ls lt it kj b kk kl ko kp ks lu kw lv la lw le lx ly lz ma bi translated">禁用未使用的URL模式，如ftp://。ftp://，或file://。会减少攻击面。</li><li id="4a2f" class="ls lt it kj b kk mb ko mc ks md kw me la mf le lx ly lz ma bi translated">对用户输入执行URL白名单和适当的验证。</li></ul><p id="77a8" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated"><strong class="kj iu">结论</strong></p><p id="937d" class="pw-post-body-paragraph kh ki it kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le im bi translated">随着威胁级别上升到危急或更高，SSRF攻击会对组织造成更大的损害。因此，管理员应该始终确保提供适当的数据验证，这样攻击者就不能轻易绕过它们。如果成功利用SSRF漏洞，攻击者可以检索非常敏感的数据。有时，攻击者需要做一点小小的改动，才能成功执行。然而，这样做的结果是，需要对正在处理的每一个输入进行输入验证。如果不这样做，可能会导致严重的漏洞。</p></div></div>    
</body>
</html>