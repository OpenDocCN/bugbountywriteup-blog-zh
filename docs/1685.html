<html>
<head>
<title>Evading Firewall/IDS during network reconnaissance using nmap</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">利用nmap在网络侦察中规避防火墙/IDS</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/evading-firewall-ids-during-network-reconnaissance-using-nmap-7dc393138178?source=collection_archive---------0-----------------------#2021-11-26">https://infosecwriteups.com/evading-firewall-ids-during-network-reconnaissance-using-nmap-7dc393138178?source=collection_archive---------0-----------------------#2021-11-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="772f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">IDS(入侵检测系统)和防火墙是旨在防止未经授权的人访问网络的安全机制。然而，即使是IDS和防火墙也有一些安全限制。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi kl"><img src="../Images/2a15fc844fcc0d242bef6511bca0a7ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:998/format:webp/1*5wR39JyoEIWhbIAPRurl1Q.jpeg"/></div></figure><p id="ad24" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">防火墙和入侵检测系统旨在避免恶意流量进入网络，但某些技术可用于向目标发送预期的数据包并避开入侵检测系统/防火墙。</p><p id="3c4e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将涉及的一些技术有:-</p><p id="4ce7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">数据包分片</strong> -向预定目标发送分片的探测数据包，目标在收到所有分片后重新组装。</p><p id="ccc1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">源端口操纵</strong>——用普通源端口操纵实际源端口，以规避IDS/防火墙</p><p id="e118" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> IP地址欺骗/诱骗IP </strong> -生成或手动指定诱骗IP地址，使IDS/防火墙无法确定实际IP。</p><p id="bf24" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">创建定制数据包:- </strong>发送定制数据包来扫描防火墙之外的目标。</p><p id="5706" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">欺骗MAC地址:- </strong>欺骗我们的MAC地址来隐藏我们的真实身份</p><p id="b2a8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">实验室要求</strong> :- Windows 7/10/11，Linux机器(Kali/ubuntu/Parrot)</p><p id="16f4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要设置我们的实验室，我们需要打开Windows Defender防火墙。导航到<strong class="jp ir">控制面板- &gt;系统和安全- &gt; windows defender防火墙- &gt;打开或关闭windows defender防火墙</strong>，启用defender并单击确定。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi kt"><img src="../Images/1ab781eea85b43036762de38f3e6f8bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*taSJjw-EaXf1f8Yhon2-uw.png"/></div></div></figure><p id="6789" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如下所示，我们的扫描被windows defender阻止。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ky"><img src="../Images/a5353c58438f2c408be3756ccefeec1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gpJYQ4zVY1bbSqnD2f_l8w.png"/></div></div></figure><h2 id="882d" class="kz la iq bd lb lc ld dn le lf lg dp lh jy li lj lk kc ll lm ln kg lo lp lq lr bi translated"><strong class="ak">使用数据包分片绕过defender:- </strong></h2><p id="59b8" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">数据包分段是指在将探测发送到网络时，将其分成几个更小的数据包(片段)。当这些数据包到达主机时，主机后面的IDS和防火墙一般会将它们全部排队并逐个处理。但是，由于这种处理方法会消耗更多的CPU和网络资源，大多数IDS的配置会使其在端口扫描期间跳过碎片数据包。</p><p id="b5de" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">再次运行扫描，<strong class="jp ir"> nmap -f &lt;目标IP地址&gt;</strong></p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi lx"><img src="../Images/04990c49621e6751f6522c6bd3ae2491.png" data-original-src="https://miro.medium.com/v2/resize:fit:1244/format:webp/1*jf_0kPEziogEOJ5cr-pFnw.png"/></div></div></figure><p id="0ed5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">另外，另一种技术是指定最大传输单元(mtu)的数量。使用mtu，传输较小的数据包，而不是一次发送一个完整的数据包。这种技术避开了目标机器中启用的过滤和检测机制。</p><p id="1917" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">nmap -mtu 8 <target ip="">，(-mtu指定最大传输单元数)这里是8个字节的数据包。</target></p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi ly"><img src="../Images/de5cb297e0c800ed0f7264abcbca7545.png" data-original-src="https://miro.medium.com/v2/resize:fit:1212/format:webp/1*iBvQ5Qk1Z4BnVq_VQUyxyg.png"/></div></figure><h2 id="2f13" class="kz la iq bd lb lc ld dn le lf lg dp lh jy li lj lk kc ll lm ln kg lo lp lq lr bi translated"><strong class="ak">源端口操纵:- </strong></h2><p id="ff12" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">源端口操纵是指用普通端口号操纵实际端口号，以规避IDS/防火墙。当防火墙配置为允许来自众所周知的端口(如HTTP、DNS、FTP等)的数据包时，这很有用。</p><p id="3ec0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> nmap -g 80 &lt;目标IP &gt; </strong>，(<strong class="jp ir"> -g </strong>或<strong class="jp ir"> -源端口</strong>选项进行源端口操作)</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi lz"><img src="../Images/c9b0e43a6f337badd0440c88dfe3ad70.png" data-original-src="https://miro.medium.com/v2/resize:fit:1170/format:webp/1*neMNuq2kOvbwhq4DbfLe-A.png"/></div></figure><h2 id="262f" class="kz la iq bd lb lc ld dn le lf lg dp lh jy li lj lk kc ll lm ln kg lo lp lq lr bi translated"><strong class="ak"> IP地址欺骗/诱骗IP:- </strong></h2><p id="d91d" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">IP地址诱饵技术是指生成或手动指定诱饵的IP地址，以规避IDS/防火墙。这种技术使得IDS/防火墙很难确定哪个IP地址真正在扫描网络，哪个IP地址是诱饵</p><p id="5201" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通过使用此命令，nmap自动为扫描生成随机数量的诱饵，并在诱饵IP地址之间随机定位真实IP地址。</p><p id="c550" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> nmap -D RND:12个172.168.1.26</strong>，(<strong class="jp ir"> -D </strong>执行诱饵扫描，<strong class="jp ir"> RND </strong>生成随机且非保留的IP地址，这里是12个IP)</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi ma"><img src="../Images/b97067962be6409d8948dcd51007d43c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1164/format:webp/1*fc-2vYgeeWs0wPpQv3SJSg.png"/></div></figure><p id="18ec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在Wireshark中，我们可以看到同一个目标IP的不同IP。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi mb"><img src="../Images/ead8333c0952547d2c75b5526a4acd8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_-ts23IDMVgc73rxuhxshg.png"/></div></div></figure></div><div class="ab cl mc md hu me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="ij ik il im in"><h1 id="6c6e" class="mj la iq bd lb mk ml mm le mn mo mp lh mq mr ms lk mt mu mv ln mw mx my lq mz bi translated"><strong class="ak">使用nmap创建自定义数据包</strong></h1><p id="5da8" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">我们可以使用nmap来执行各种扫描技术，如附加自定义二进制数据、附加自定义字符串、附加随机数据、随机化主机顺序以及发送错误校验和来扫描IDS/防火墙之外的目标主机。</p><h2 id="e68a" class="kz la iq bd lb lc ld dn le lf lg dp lh jy li lj lk kc ll lm ln kg lo lp lq lr bi translated"><strong class="ak"> <em class="na">二进制数据作为有效载荷</em> </strong></h2><p id="9139" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated"><strong class="jp ir"> nmap &lt;目标IP &gt; -数据0xdeadbeef </strong> ( <strong class="jp ir"> -数据</strong> &lt;十六进制字符串&gt;，在发送的数据包中发送二进制数据(0和1)作为有效载荷，以扫描防火墙以外的内容)</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/2e9e14c3a3eb1d190cea9f67edef2191.png" data-original-src="https://miro.medium.com/v2/resize:fit:1174/format:webp/1*m0N5hAYapG0wj1HOlwtGbQ.png"/></div></figure><h2 id="ca4f" class="kz la iq bd lb lc ld dn le lf lg dp lh jy li lj lk kc ll lm ln kg lo lp lq lr bi translated"><strong class="ak">作为有效载荷的常规字符串</strong></h2><p id="ca93" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated"><strong class="jp ir"> nmap &lt;目标IP &gt; - data-string“我的l33t技能”</strong>(<strong class="jp ir">-data-string&lt;string&gt;</strong>)，将一个常规字符串作为发送数据包中的有效载荷发送到目标机器进行防火墙外扫描。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/3267e0c145f802c49968b2c3a9b909d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1216/format:webp/1*s0rpjQb5KUDlWVwfm1XH6Q.png"/></div></figure><h2 id="8672" class="kz la iq bd lb lc ld dn le lf lg dp lh jy li lj lk kc ll lm ln kg lo lp lq lr bi translated"><strong class="ak">追加随机数据字节</strong></h2><p id="437c" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated"><strong class="jp ir"> nmap -数据-长度5 &lt;目标IP &gt; </strong> ( <strong class="jp ir"> -数据-长度&lt;长度&gt; </strong>是将一定数量的随机数据字节附加到没有任何协议特定有效载荷的大多数发送的包中)</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/4bf2d50cf56455d7604ea76f4dbf7cad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1214/format:webp/1*P4tDwmR4Kp3Qp95RSjkFhg.png"/></div></figure><h2 id="f96a" class="kz la iq bd lb lc ld dn le lf lg dp lh jy li lj lk kc ll lm ln kg lo lp lq lr bi translated">随机化主机顺序</h2><p id="1be0" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated"><strong class="jp ir"> nmap - randomize-hosts &lt;目标IP&gt;</strong>(<strong class="jp ir">-randomize-hosts</strong>随机扫描目标网络中的主机数量，扫描防火墙外的预定目标)</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/413fa67aca64e647968c0576999c0973.png" data-original-src="https://miro.medium.com/v2/resize:fit:1194/format:webp/1*DB8ZmVcV8L5vyRNpi-fOFQ.png"/></div></figure><h2 id="5dc7" class="kz la iq bd lb lc ld dn le lf lg dp lh jy li lj lk kc ll lm ln kg lo lp lq lr bi translated">发送错误的校验和</h2><p id="4a93" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated"><strong class="jp ir"> nmap - badsum &lt;目标IP &gt; </strong> ( <strong class="jp ir"> - badsum </strong>用于将带有错误或伪造TCP/UDP校验和的数据包发送到预定目标，以避开某些防火墙规则集)</p><p id="3279" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">扫描结果显示所有端口都被过滤，表明没有响应或数据包被丢弃，因此可以推断系统已配置。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/ae45769a3c261af089f740700d35081f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1188/format:webp/1*H60WfaWcDzT7iGt5_zXtXw.png"/></div></figure></div><div class="ab cl mc md hu me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="ij ik il im in"><h1 id="57d3" class="mj la iq bd lb mk ml mm le mn mo mp lh mq mr ms lk mt mu mv ln mw mx my lq mz bi translated"><strong class="ak">假冒MAC地址</strong></h1><p id="d2e4" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">假冒我们的MAC地址有助于我们扫描网络，即使我们的真实MAC地址被防火墙/IDS阻止。这也有助于我们保持匿名和绕过某些过滤器。</p><p id="152d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> nmap -sT -Pn - spoof-mac 0 &lt;目标IP &gt; </strong> ( <strong class="jp ir"> -sT </strong>，TCP扫描。<strong class="jp ir"> -Pn </strong>，无ping。<strong class="jp ir"> -欺骗mac </strong> 0，欺骗mac地址，0随机化mac)</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ng"><img src="../Images/f45cb627a73b9bdb0e896c9182c080dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ISVzZ3C86lQqvlFDpIizMA.png"/></div></div></figure></div><div class="ab cl mc md hu me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="ij ik il im in"><p id="a6eb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有关通过使用代理链绕过防火墙的更多信息，nmap和hp3即将推出。</p><p id="671a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">希望这对你有帮助。如果你喜欢这篇文章或者它对你有任何帮助。请留下一些掌声。我不介意他们中的50个；)</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nh"><img src="../Images/b8305e339c064263f6a7f0eabef7292a.png" data-original-src="https://miro.medium.com/v2/resize:fit:292/1*og4TxQHbtJMFuTILCiztAw.gif"/></div></div></figure></div></div>    
</body>
</html>