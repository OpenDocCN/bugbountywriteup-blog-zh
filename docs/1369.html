<html>
<head>
<title>Updating Mimikatz in Metasploit</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Metasploit中更新Mimikatz</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/updating-mimikatz-in-metasploit-1ce505e811e1?source=collection_archive---------2-----------------------#2021-06-07">https://infosecwriteups.com/updating-mimikatz-in-metasploit-1ce505e811e1?source=collection_archive---------2-----------------------#2021-06-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><blockquote class="jn jo jp"><p id="e95c" class="jq jr js jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ij bi translated">当前Metasploit框架中集成的Mimikatz有点过时。如果您想使用最近的特性(比如明文RDP凭证转储)，Mimikatz扩展(称为Kiwi)应该手动更新并编译到当前框架中。下面是怎么做的。</p></blockquote><h1 id="902a" class="kp kq iq bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">猕猴桃扩展</h1><p id="5059" class="pw-post-body-paragraph jq jr iq jt b ju ln jw jx jy lo ka kb lp lq ke kf lr ls ki kj lt lu km kn ko ij bi translated">Metasploit框架著名的Meterpreter shell有效负载允许攻击者加载扩展。扩展加载是通过内存中的DLL注入实现的，不会产生新的进程。如果Meterpreter外壳绕过了AV/EDR解决方案，那么扩展也很有可能保持隐蔽性。</p><p id="f4eb" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lp kd ke kf lr kh ki kj lt kl km kn ko ij bi translated">由<a class="ae lv" href="https://twitter.com/gentilkiwi/" rel="noopener ugc nofollow" target="_blank"> Gentilkiwi </a>开发的伟大的<a class="ae lv" href="https://github.com/gentilkiwi/mimikatz/" rel="noopener ugc nofollow" target="_blank"> Mimikatz </a>后期开发工具是一个名为kiwi的Meterpreter扩展。一旦我们有了一个Meterpreter会话(已经绕过了AV/EDR解决方案)，加载Kiwi扩展并在后期开发任务中启动各种Mimikatz模块就非常容易了。</p><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi lw"><img src="../Images/013e771e69b2d012153ac5268dd5801d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T2AUNmvWfyCCjDEBWUMsUg.png"/></div></div><figcaption class="mi mj gj gh gi mk ml bd b be z dk translated">在Meterpreter会话中使用Mimikatz(作为Kiwi扩展)</figcaption></figure><p id="113f" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lp kd ke kf lr kh ki kj lt kl km kn ko ij bi translated">唯一的问题是集成在当前Metasploit框架中的Mimikatz模块(在撰写本文时是v6.0.46)有点过时。在这个Meterpreter版本中使用的Mimikatz fork来自2019年末，它缺少一些令人敬畏的当前功能(我最喜欢的是最新的<a class="ae lv" href="https://twitter.com/gentilkiwi/status/1397263983221039105" rel="noopener ugc nofollow" target="_blank"> RDP明文凭据转储</a>)。</p><p id="049d" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lp kd ke kf lr kh ki kj lt kl km kn ko ij bi translated">获得最新特性的解决方案是通过使用当前的Mimikatz主分支重新编译来更新Kiwi扩展。</p><h1 id="d0d7" class="kp kq iq bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">准备源树</h1><p id="ad3d" class="pw-post-body-paragraph jq jr iq jt b ju ln jw jx jy lo ka kb lp lq ke kf lr ls ki kj lt lu km kn ko ij bi translated">Kiwi扩展可以与rapid 7 metasploit-payloads github<a class="ae lv" href="https://github.com/rapid7/metasploit-payloads" rel="noopener ugc nofollow" target="_blank">存储库</a>中托管的C Windows Meterpreter shell一起编译。</p><p id="7aa1" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lp kd ke kf lr kh ki kj lt kl km kn ko ij bi translated">首先，在Windows机器上(使用Visual Studio，最好是VS2019)克隆repo:</p><pre class="lx ly lz ma gt mm mn mo mp aw mq bi"><span id="e268" class="mr kq iq mn b gy ms mt l mu mv">git clone https://github.com/rapid7/metasploit-payloads<br/>cd metasploit-payloads<!-- --> </span></pre><p id="44f3" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lp kd ke kf lr kh ki kj lt kl km kn ko ij bi translated">有关Visual Studio依赖项，请参见Windows C meter preter Building<a class="ae lv" href="https://github.com/rapid7/metasploit-payloads/tree/master/c/meterpreter" rel="noopener ugc nofollow" target="_blank">自述文件</a>的“Building—Windows on Windows”<a class="ae lv" href="https://github.com/rapid7/metasploit-payloads/tree/master/c/meterpreter#building---windows-on-windows" rel="noopener ugc nofollow" target="_blank">部分</a>。</p><p id="4a9f" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lp kd ke kf lr kh ki kj lt kl km kn ko ij bi translated">接下来，不遵循自述文件，而是将最初引用rapid 7 Mimi Katz fork(<a class="ae lv" href="https://github.com/rapid7/mimikatz" rel="noopener ugc nofollow" target="_blank">https://github.com/rapid7/mimikatz</a>)的<code class="fe mw mx my mn b">c\meterpreter\source\extensions\kiwi\mimikatz</code>子模块替换为Benjamin Delpy(gentili kiwi)的官方mimikatz repo的主分支(<a class="ae lv" href="https://github.com/gentilkiwi/mimikatz/" rel="noopener ugc nofollow" target="_blank">https://github.com/gentilkiwi/mimikatz/</a>)。</p><p id="f260" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lp kd ke kf lr kh ki kj lt kl km kn ko ij bi translated">在kiwi扩展文件夹中设置mimikatz子模块的新url:</p><pre class="lx ly lz ma gt mm mn mo mp aw mq bi"><span id="aedd" class="mr kq iq mn b gy ms mt l mu mv">git submodule set-url c\meterpreter\source\extensions\kiwi\mimikatz <a class="ae lv" href="https://github.com/gentilkiwi/mimikatz" rel="noopener ugc nofollow" target="_blank">https://github.com/gentilkiwi/mimikatz</a></span></pre><p id="fa84" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lp kd ke kf lr kh ki kj lt kl km kn ko ij bi translated">如果不支持子模块set-url(在旧的git版本中)，请编辑。直接gitmodules并将c/meter preter/source/extensions/kiwi/Mimi Katz子模块部分中的rapid7 mimikatz github URL更改为gentilkiwi:</p><pre class="lx ly lz ma gt mm mn mo mp aw mq bi"><span id="b8cd" class="mr kq iq mn b gy ms mt l mu mv">url = <a class="ae lv" href="https://github.com/gentilkiwi/mimikatz" rel="noopener ugc nofollow" target="_blank">https://github.com/gentilkiwi/mimikatz</a></span></pre><p id="3c25" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lp kd ke kf lr kh ki kj lt kl km kn ko ij bi translated">下一步是初始化和更新(获取)子模块:</p><pre class="lx ly lz ma gt mm mn mo mp aw mq bi"><span id="6c93" class="mr kq iq mn b gy ms mt l mu mv">git submodule init<br/>git submodule update</span></pre><p id="de9b" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lp kd ke kf lr kh ki kj lt kl km kn ko ij bi translated">现在gentilkiwi mimikatz分支在项目中，但是它不在最近的提交中。查看最新更新:</p><pre class="lx ly lz ma gt mm mn mo mp aw mq bi"><span id="27d9" class="mr kq iq mn b gy ms mt l mu mv">git submodule update --remote</span></pre><p id="e973" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lp kd ke kf lr kh ki kj lt kl km kn ko ij bi translated">源代码树几乎准备好了，但是在编译之前，应该为更新的mimikatz组件修改适当的<code class="fe mw mx my mn b">c\meterpreter\workspace\ext_server_kiwi\ext_server_kiwi.vcxproj</code> Visual C++项目文件。</p><h1 id="3537" class="kp kq iq bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">修补Visual C++项目文件</h1><p id="5113" class="pw-post-body-paragraph jq jr iq jt b ju ln jw jx jy lo ka kb lp lq ke kf lr ls ki kj lt lu km kn ko ij bi translated">实际上，需要合并新mimikatz中存在的、旧mimikatz版本中缺少的新头文件和源文件位置。</p><p id="0fa6" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lp kd ke kf lr kh ki kj lt kl km kn ko ij bi translated">检查(在Linux上:)哪些源文件应该作为<code class="fe mw mx my mn b">ClCompile</code> <code class="fe mw mx my mn b">Include</code>属性添加到<code class="fe mw mx my mn b">c\meterpreter\workspace\ext_server_kiwi\ext_server_kiwi.vcxproj</code>中:</p><pre class="lx ly lz ma gt mm mn mo mp aw mq bi"><span id="03de" class="mr kq iq mn b gy ms mt l mu mv">diff &lt;(cat c/meterpreter/workspace/ext_server_kiwi/ext_server_kiwi.vcxproj | grep '&lt;ClCompile Include' | sort) &lt;(cat c/meterpreter/source/extensions/kiwi/mimikatz/mimikatz/mimikatz.vcxproj | grep '&lt;ClCompile Include' | sed -e 's/Include="/Include="..\\..\\source\\extensions\\kiwi\\mimikatz\\mimikatz\\/' -e 's/\\mimikatz\\\.\.//' | sort) | grep '^&gt;' | sed -e 's/^&gt; //'</span></pre><p id="8a2f" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lp kd ke kf lr kh ki kj lt kl km kn ko ij bi translated">结果是(由sqlite3 . c preforcessordefinitions补充):</p><figure class="lx ly lz ma gt mb"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="e199" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lp kd ke kf lr kh ki kj lt kl km kn ko ij bi translated">这几行要加到<code class="fe mw mx my mn b">c\meterpreter\workspace\ext_server_kiwi\ext_server_kiwi.vcxproj</code>。注意，<code class="fe mw mx my mn b">sqlite3_omit.c</code>(在它的<code class="fe mw mx my mn b">&lt;ClCompile&gt;&lt;/ClCompile&gt;</code>标签中有完整的元素列表)应该被移除(因为在最近的mimikatz中它被替换为<code class="fe mw mx my mn b">sqlite3.c</code>)。</p><p id="1456" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lp kd ke kf lr kh ki kj lt kl km kn ko ij bi translated">头文件也是如此:</p><pre class="lx ly lz ma gt mm mn mo mp aw mq bi"><span id="500d" class="mr kq iq mn b gy ms mt l mu mv">diff &lt;(cat c/meterpreter/workspace/ext_server_kiwi/ext_server_kiwi.vcxproj | grep '&lt;ClInclude Include' | sort) &lt;(cat c/meterpreter/source/extensions/kiwi/mimikatz/mimikatz/mimikatz.vcxproj | grep '&lt;ClInclude Include' | sed -e 's/Include="/Include="..\\..\\source\\extensions\\kiwi\\mimikatz\\mimikatz\\/' -e 's/\\mimikatz\\\.\.//' | sort) | grep '^&gt;' | sed -e 's/^&gt; //'</span></pre><p id="d72e" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lp kd ke kf lr kh ki kj lt kl km kn ko ij bi translated">结果是:</p><figure class="lx ly lz ma gt mb"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="567d" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lp kd ke kf lr kh ki kj lt kl km kn ko ij bi translated">这些行应该添加到<code class="fe mw mx my mn b">c\meterpreter\workspace\ext_server_kiwi\ext_server_kiwi.vcxproj</code>中。还要注意的是，<code class="fe mw mx my mn b">sqlite3_omit.h</code>应该被删除(因为在最近的mimikatz中它被<code class="fe mw mx my mn b">sqlite3.h</code>取代)。</p><p id="24eb" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lp kd ke kf lr kh ki kj lt kl km kn ko ij bi translated">现在需要将更多的编译选项从mimikatz分支合并到meterpreter工作区项目中。</p><p id="05c6" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lp kd ke kf lr kh ki kj lt kl km kn ko ij bi translated">首先，确保编译器警告不会因错误而中止，因此将所有出现的TreatWarningAsError元素从<code class="fe mw mx my mn b">&lt;TreatWarningAsError&gt;true&lt;/TreatWarningAsError&gt;</code>替换为<code class="fe mw mx my mn b">&lt;TreatWarningAsError&gt;false&lt;/TreatWarningAsError&gt;</code>。</p><p id="9530" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lp kd ke kf lr kh ki kj lt kl km kn ko ij bi translated">其次，添加新的链接器依赖项。要在不逐个手动比较依赖项的情况下查看更改(在Linux上):</p><pre class="lx ly lz ma gt mm mn mo mp aw mq bi"><span id="2ae2" class="mr kq iq mn b gy ms mt l mu mv">diff &lt;(cat c/meterpreter/source/extensions/kiwi/mimikatz/mimikatz/mimikatz.vcxproj | grep AdditionalDependencies | cut -d\&gt; -f2 | cut -d\&lt; -f1 | tr ';' '\n' | sort) &lt;(cat c/meterpreter/workspace/ext_server_kiwi/ext_server_kiwi.vcxproj | grep AdditionalDependencies | head -1 | cut -d\&gt; -f2 | cut -d\&lt; -f1 | tr ';' '\n' | sort)</span></pre><p id="6f3d" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lp kd ke kf lr kh ki kj lt kl km kn ko ij bi translated">这显示了新的链接库:bcrypt.lib、delayimp.lib、odbc32.lib、wbemuuid.lib。将这些作为AdditionalDependencies添加到工作区vcxproj文件中(在所有AdditionalDependencies出现后添加，以确保将其添加到所有目标):</p><pre class="lx ly lz ma gt mm mn mo mp aw mq bi"><span id="9c66" class="mr kq iq mn b gy ms mt l mu mv">&lt;AdditionalDependencies&gt;bcrypt.lib;delayimp.lib;odbc32.lib;wbemuuid.lib;%(AdditionalDependencies)&lt;/AdditionalDependencies&gt;</span></pre><p id="5fa7" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lp kd ke kf lr kh ki kj lt kl km kn ko ij bi translated">现在源代码树已经可以构建了。</p><h1 id="a604" class="kp kq iq bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">建筑和安装</h1><p id="6c01" class="pw-post-body-paragraph jq jr iq jt b ju ln jw jx jy lo ka kb lp lq ke kf lr ls ki kj lt lu km kn ko ij bi translated">构建项目(包括带有更新的mimikatz的kiwi扩展)很简单:只需启动一个“VS 2019的开发人员命令提示符”(或其他Visual Studio版本，请参见Windows C Meterpreter的<a class="ae lv" href="https://github.com/rapid7/metasploit-payloads/tree/master/c/meterpreter" rel="noopener ugc nofollow" target="_blank">自述文件</a>)，导航到metasploit-payloads树内的<code class="fe mw mx my mn b">c\meterpreter</code>文件夹并发出make:</p><pre class="lx ly lz ma gt mm mn mo mp aw mq bi"><span id="796b" class="mr kq iq mn b gy ms mt l mu mv">cd c\meterpreter<br/>make</span></pre><p id="743f" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lp kd ke kf lr kh ki kj lt kl km kn ko ij bi translated">这也为Windows x86和x64架构构建了完整的meterpreter项目(不要担心不仅要构建kiwi扩展，还要构建整个meterpreter，构建速度非常快)。</p><p id="2ead" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lp kd ke kf lr kh ki kj lt kl km kn ko ij bi translated">编译后的kiwi扩展(作为反射dll)应该在输出文件夹中:</p><pre class="lx ly lz ma gt mm mn mo mp aw mq bi"><span id="8707" class="mr kq iq mn b gy ms mt l mu mv">output\ext_server_kiwi.x64.dll<br/>output\ext_server_kiwi.x86.dll</span></pre><p id="9de1" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lp kd ke kf lr kh ki kj lt kl km kn ko ij bi translated">对于安装，只需替换您的Metasploit设置中现有的<code class="fe mw mx my mn b">ext_server_kiwi.x??.dll</code>文件即可(根metasploit-framework文件夹可能与/usr/share位于不同的位置，具体取决于您的设置):</p><pre class="lx ly lz ma gt mm mn mo mp aw mq bi"><span id="6a2b" class="mr kq iq mn b gy ms mt l mu mv">/usr/share/metasploit-framework/vendor/bundle/ruby/2.7.0/gems/metasploit-payloads-2.0.45/data/meterpreter/ext_server_kiwi.x64.dll<br/>/usr/share/metasploit-framework/vendor/bundle/ruby/2.7.0/gems/metasploit-payloads-2.0.45/data/meterpreter/ext_server_kiwi.x86.dll</span></pre><p id="d790" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lp kd ke kf lr kh ki kj lt kl km kn ko ij bi translated">对于测试，在正式的Metasploit设置中备份原始的<code class="fe mw mx my mn b">ext_server_kiwi.x??.dll</code>文件可能是有用的。</p><h1 id="a1f7" class="kp kq iq bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">尝试最新的Mimikatz</h1><p id="e36a" class="pw-post-body-paragraph jq jr iq jt b ju ln jw jx jy lo ka kb lp lq ke kf lr ls ki kj lt lu km kn ko ij bi translated">在触发了一个Meterpreter shell并加载了Kiwi扩展之后，Meterpreter中的前沿函数(比如RDP明文凭证转储)应该可以使用了。:)</p><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi nb"><img src="../Images/9bbd0dfd4630c64c23a9013da78f6b69.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*W9juxmV5_BJys2lupKbM_g.png"/></div></div><figcaption class="mi mj gj gh gi mk ml bd b be z dk translated">在Metasploit中将最新的Mimikatz作为集成的Kiwi扩展运行</figcaption></figure><p id="4882" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lp kd ke kf lr kh ki kj lt kl km kn ko ij bi translated">这个项目的动机是测试EDR规避技术(通过反射DLL注入),这在这篇短文中没有涉及。</p></div></div>    
</body>
</html>