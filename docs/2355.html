<html>
<head>
<title>Take Confusion Out of IAM Policies, AWS S3 Bucket Policies and AWS S3 ACLs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">消除IAM政策、AWS S3存储桶政策和AWS S3 ACL的混乱</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/take-confusion-out-of-iam-policies-aws-s3-bucket-policies-and-aws-s3-acls-61d8fa04a658?source=collection_archive---------0-----------------------#2022-09-11">https://infosecwriteups.com/take-confusion-out-of-iam-policies-aws-s3-bucket-policies-and-aws-s3-acls-61d8fa04a658?source=collection_archive---------0-----------------------#2022-09-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/4bd9b553e8b1dee958dfbd9bc9040d2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:994/format:webp/1*wp1Ln0DpnZbF0EtY5TwjDg.png"/></div></figure><p id="d219" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">亚马逊S3是一个对象存储服务，将数据作为对象存储在桶中。一个<em class="ks">对象</em>是一个文件和任何描述该文件的元数据。每个对象都有一个唯一的标识符，称为<em class="ks">对象键</em>。一个<em class="ks">桶</em>是盛放物品的容器。使用亚马逊S3服务，客户需要管理对存储在S3存储桶中的对象的访问权限。</p><h1 id="f1f7" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">存储桶和对象所有权</h1><p id="b2e7" class="pw-post-body-paragraph ju jv iq jw b jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr ij bi translated">在开始S3存储桶权限管理之前，有一个概念需要记住，那就是存储桶和对象所有权。一个AWS帐户中的S3存储桶允许其他AWS帐户或服务上传对象，存储桶所有者可能无法访问这些对象，因为它们属于不同的AWS帐户。默认情况下，所有亚马逊S3资源都是私有的。只有资源所有者才能访问资源。但是，资源所有者可以选择向其他资源和用户授予访问权限。值得一提的是，bucket或bucket中的对象的所有者不是IAM用户，而是用于创建bucket和上传对象的AWS帐户。</p><p id="0ebe" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">桶主</strong></p><blockquote class="lw lx ly"><p id="b248" class="ju jv ks jw b jx jy jz ka kb kc kd ke lz kg kh ki ma kk kl km mb ko kp kq kr ij bi translated">用于创建存储桶的AWS帐户。</p><p id="6035" class="ju jv ks jw b jx jy jz ka kb kc kd ke lz kg kh ki ma kk kl km mb ko kp kq kr ij bi translated">存储桶所有者不能对不属于自己的对象授予权限。授予对象权限的存储桶策略仅适用于存储桶所有者拥有的对象。</p></blockquote><p id="1d2a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">对象所有者</strong></p><blockquote class="lw lx ly"><p id="5d60" class="ju jv ks jw b jx jy jz ka kb kc kd ke lz kg kh ki ma kk kl km mb ko kp kq kr ij bi translated">如果使用AWS身份和访问管理(IAM)用户或角色凭据上载对象，则用户或角色所属的AWS帐户拥有该对象。</p><p id="dfd4" class="ju jv ks jw b jx jy jz ka kb kc kd ke lz kg kh ki ma kk kl km mb ko kp kq kr ij bi translated">如果存储桶所有者授予另一个AWS帐户跨帐户权限来上传对象，则存储桶所有者对这些对象没有权限。但是，对象所有权可以在上载期间或之后由对象所有者转移，也可以由存储桶所有者通过存储桶权限部分上的对象所有权设置转移。请参考<a class="ae mc" href="https://docs.amazonaws.cn/en_us/AmazonS3/latest/userguide/about-object-ownership.html" rel="noopener ugc nofollow" target="_blank">控制对象的所有权并为您的存储桶</a>禁用ACL。</p></blockquote><p id="9e1f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，了解了存储桶和对象所有权之后，让我们继续讨论对S3资源的访问控制。亚马逊S3有许多不同的S3访问策略选项:IAM策略、S3存储桶策略、S3 ACL。它们之间的区别让一些初学者感到困惑。</p><h1 id="412f" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">亚马逊S3访问政策</h1><p id="523d" class="pw-post-body-paragraph ju jv iq jw b jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr ij bi translated">从最基本的意义上来说，用户或存储桶策略通常包含以下元素:</p><ul class=""><li id="faa7" class="md me iq jw b jx jy kb kc kf mf kj mg kn mh kr mi mj mk ml bi translated"><strong class="jw ir">效果:</strong>安全许可(“允许”或“拒绝”)</li><li id="247d" class="md me iq jw b jx mm kb mn kf mo kj mp kn mq kr mi mj mk ml bi translated"><strong class="jw ir">原则:</strong>与策略相关联的用户、帐户、服务或其他实体</li><li id="3a89" class="md me iq jw b jx mm kb mn kf mo kj mp kn mq kr mi mj mk ml bi translated"><strong class="jw ir">动作:</strong>权限映射到的特定亚马逊S3操作。有关亚马逊S3运营的更多信息，请参见操作。</li><li id="0447" class="md me iq jw b jx mm kb mn kf mo kj mp kn mq kr mi mj mk ml bi translated"><strong class="jw ir">资源:</strong>桶、对象等。对其应用访问权限。在这里可以找到为S3定义的资源类型的完整列表。</li><li id="2923" class="md me iq jw b jx mm kb mn kf mo kj mp kn mq kr mi mj mk ml bi translated"><strong class="jw ir">条件:</strong>具体条件键适用于上述资源。</li></ul><p id="86c8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">通过用户或存储桶策略，您可以在特定条件下允许或限制特定AWS帐户内的IAM用户/服务访问亚马逊S3存储桶。</p><p id="abdd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">用户政策</strong></p><blockquote class="lw lx ly"><p id="cf7f" class="ju jv ks jw b jx jy jz ka kb kc kd ke lz kg kh ki ma kk kl km mb ko kp kq kr ij bi translated">IAM策略指定允许主体对任何AWS资源做什么。它可以附加到IAM用户、组或角色，这些用户、组或角色受您定义的权限的约束。如果您有许多具有不同权限要求的S3存储桶，则更详细、更少的IAM策略可以更容易地管理这些权限。</p></blockquote><p id="c671" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">存储桶策略</strong></p><blockquote class="lw lx ly"><p id="bf75" class="ju jv ks jw b jx jy jz ka kb kc kd ke lz kg kh ki ma kk kl km mb ko kp kq kr ij bi translated">S3存储桶策略仅控制对S3存储桶和对象的访问。如果您想实施securityTransport之类的安全控制，以确保无论谁读取对象都可以进行HTTPS，那么bucket策略是一个不错的选择。有一些<a class="ae mc" href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/example-bucket-policies.html" rel="noopener ugc nofollow" target="_blank">桶策略示例</a>来展示S3桶策略如何在许多使用案例中适合您。</p><p id="872b" class="ju jv ks jw b jx jy jz ka kb kc kd ke lz kg kh ki ma kk kl km mb ko kp kq kr ij bi translated">您可以在存储桶级别附加S3存储桶策略(即，您不能将存储桶策略附加到S3对象)，以控制对存储桶中所有对象的访问权限。</p><p id="83e1" class="ju jv ks jw b jx jy jz ka kb kc kd ke lz kg kh ki ma kk kl km mb ko kp kq kr ij bi translated">存储桶策略仅适用于存储桶所有者拥有的对象。如果您的存储桶包含不属于存储桶所有者的对象，则该帐户(对象写入者)拥有该对象，可以访问它，并且可以通过ACL授予其他用户对它的访问权限。</p></blockquote><p id="d6f4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">桶和对象ACL</strong></p><blockquote class="lw lx ly"><p id="4a8e" class="ju jv ks jw b jx jy jz ka kb kc kd ke lz kg kh ki ma kk kl km mb ko kp kq kr ij bi translated">S3访问控制列表(ACL)是IAM之前的遗留访问控制机制。S3 ACL被附加到每个S3桶和对象。亚马逊S3支持一组权限。使用ACL有一些限制:</p><p id="7bc8" class="ju jv ks jw b jx jy jz ka kb kc kd ke lz kg kh ki ma kk kl km mb ko kp kq kr ij bi translated">-您只能向AWS帐户授予权限，但不能向同一帐户内的实体授予权限。同样，您不能向自己帐户中的用户授予权限。</p><p id="db17" class="ju jv ks jw b jx jy jz ka kb kc kd ke lz kg kh ki ma kk kl km mb ko kp kq kr ij bi translated">-您不能授予有条件的权限</p><p id="737f" class="ju jv ks jw b jx jy jz ka kb kc kd ke lz kg kh ki ma kk kl km mb ko kp kq kr ij bi translated">-你不能明确拒绝许可</p><p id="88c4" class="ju jv ks jw b jx jy jz ka kb kc kd ke lz kg kh ki ma kk kl km mb ko kp kq kr ij bi translated">ACL的一个合适场景是跨帐户对象上传。如果存储桶所有者允许其他AWS帐户上载启用了ACL的对象(如下图所示)，则只能由拥有这些对象的AWS帐户使用对象ACL来管理这些对象的权限。</p></blockquote><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi mr"><img src="../Images/453ed04e4685e3ab14081a3aac6be870.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7wUcrkvZxTQsNnkEhRydFQ.png"/></div></div></figure><h1 id="1915" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">访问控制机制</h1><p id="485b" class="pw-post-body-paragraph ju jv iq jw b jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr ij bi translated">当一个以上的访问控制策略应用于S3存储桶/对象时，授权决定取决于上述策略的联合。决策默认为拒绝，除非有明确的允许，而明确的拒绝总是胜过允许。</p><p id="bcf5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在一个有趣的例子中，如果一个IAM策略拒绝特定的IAM用户访问一个对象，而一个S3存储桶策略允许公众访问同一个对象，组合的结果是IAM用户将被禁止访问S3对象，但他可以匿名访问该对象。</p><h1 id="ce6f" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">常见使用案例</h1><p id="5b4c" class="pw-post-body-paragraph ju jv iq jw b jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr ij bi translated"><strong class="jw ir">用例1 —一个IAM用户访问S3存储桶/对象属于IAM用户的父帐户</strong></p><p id="6782" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果目标S3时段/对象由IAM用户的父帐户所有。IAM用户的父帐户可以通过将IAM策略附加到IAM用户或定义存储桶策略，向其IAM用户授予S3存储桶/对象权限。</p><p id="c8fd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">允许IAM用户访问S3存储桶中的对象的IAM策略示例:</p><pre class="ms mt mu mv gt na nb nc nd aw ne bi"><span id="7aed" class="nf ku iq nb b gy ng nh l ni nj">{<br/>    "Version": "2012-10-17",<br/>    "Statement": [<br/>        {<br/>            "Sid": "PublicRead",<br/>            "Effect": "Allow",<br/>            "Action": [<br/>                "s3:GetObject",<br/>                "s3:PutObject",<br/>                "s3:PutObjectAcl"<br/>            ],<br/>            "Resource": "arn:aws:s3:::&lt;bucket-name&gt;/*"<br/>        },<br/>        {<br/>            "Sid": "PublicRead1",<br/>            "Effect": "Allow",<br/>            "Action": "s3:ListBucket",<br/>            "Resource": "arn:aws:s3:::&lt;bucket-name&gt;"<br/>        }<br/>    ]<br/>}</span></pre><p id="2301" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">授予IAM用户访问S3的存储桶策略示例:</p><pre class="ms mt mu mv gt na nb nc nd aw ne bi"><span id="7d94" class="nf ku iq nb b gy ng nh l ni nj">{<br/>    "Version": "2012-10-17",<br/>    "Statement": [<br/>        {<br/>            "Sid": "PublicRead",<br/>            "Effect": "Allow",<br/>            "Principal": {<br/>                "AWS": "arn:aws:iam::&lt;AWS-Account-Number&gt;:user/&lt;IAM-User&gt;"<br/>            },<br/>            "Action": [<br/>                "s3:GetObject",<br/>                "s3:PutObject",<br/>                "s3:PutObjectAcl"<br/>            ],<br/>            "Resource": "arn:aws:s3:::&lt;bucket-name&gt;/*"<br/>        },<br/>        {<br/>            "Sid": "PublicRead1",<br/>            "Effect": "Allow",<br/>            "Principal": {<br/>                "AWS": "arn:aws:iam::&lt;AWS-Account-Number&gt;:user/&lt;IAM-User&gt;"<br/>            },<br/>            "Action": "s3:ListBucket",<br/>            "Resource": "arn:aws:s3:::&lt;bucket-name&gt;"<br/>        }<br/>    ]<br/>}</span></pre><p id="20db" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="ks">请注意在以上情况下</em> <code class="fe nk nl nm nb b"><em class="ks">"AWS": "arn:aws:iam::&lt;AWS-Account-Number&gt;:root</em></code> <em class="ks">不起作用。</em></p><p id="72e6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">用例2 —一个IAM用户想要访问跨账户S3存储桶及其对象</strong></p><p id="0746" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">当IAM用户想要访问跨帐户S3时段时，AWS会执行两次评估。AWS评估两个帐户中的请求:拥有IAM用户的帐户和拥有S3存储桶的帐户。拥有IAM用户的AWS帐户必须通过IAM策略授予IAM用户S3存储桶权限。基于特定的用例，S3存储桶所有者还必须通过存储桶策略或ACL授予权限。你可以在帖子<a class="ae mc" href="https://aws.amazon.com/premiumsupport/knowledge-center/cross-account-access-s3/" rel="noopener ugc nofollow" target="_blank">上找到更多关于我如何提供对亚马逊S3存储桶中对象的跨账户访问？</a></p><p id="a25c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">请记住，如果IAM用户想要访问不属于存储桶所有者帐户的对象，存储桶所有者帐户不能授予对这些对象的访问权限。</p><p id="3391" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">用例3 —匿名访问S3存储桶中的对象</strong></p><p id="b692" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">您不能在IAM用户策略中授予匿名权限，因为该策略附加到用户/角色。</p><p id="f4bb" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">但是您可以添加一个存储桶策略来授予存储桶中所有对象的匿名权限。通过用通配符(<code class="fe nk nl nm nb b">"*"</code>)指定<code class="fe nk nl nm nb b">principal</code>作为<code class="fe nk nl nm nb b">Principal</code>值，如<code class="fe nk nl nm nb b">"Principal":"*"</code>或<code class="fe nk nl nm nb b">"Principal":{"AWS":"*"}</code>(参见IAM用户指南中的<a class="ae mc" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_principal.html#principal-anonymous" rel="noopener ugc nofollow" target="_blank">所有主体</a>)，该策略允许匿名访问，但是应该小心使用。</p><p id="0a49" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">使对象可公开访问的存储桶策略示例如下:</p><pre class="ms mt mu mv gt na nb nc nd aw ne bi"><span id="665e" class="nf ku iq nb b gy ng nh l ni nj">{<br/>    "Version":"2012-10-17",<br/>    "Statement": [<br/>        {<br/>            "Sid":"GrantAnonymousReadPermissions",<br/>            "Effect":"Allow",<br/>            "Principal": "*",<br/>            "Action":["s3:GetObject"],<br/>            "Resource":["arn:aws:s3:::&lt;bucket-name&gt;/*"]<br/>        }<br/>    ]<br/>}</span></pre><p id="e7b6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">对象ACL也可用于使对象可公开访问。要使存储在亚马逊S3的对象可公开访问，第一件事是将bucket Permissions部分的“阻止所有公共访问”设置为off，如下所示。</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi nn"><img src="../Images/96a3858d76e6fd581588796a12ff6d12.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PDMuKOozD4rNc8cPEcUIVg.png"/></div></div></figure><p id="f8ee" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">作为对象所有者，您可以运行以下命令来更新其对象ACL以进行公共读取访问:</p><pre class="ms mt mu mv gt na nb nc nd aw ne bi"><span id="1a54" class="nf ku iq nb b gy ng nh l ni nj">aws s3api put-object-acl --bucket &lt;bucket-name&gt; --key &lt;key-name&gt; --acl public-read</span></pre><p id="865b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">或者，您可以运行以下命令向其他所有人授予读取权限:</p><pre class="ms mt mu mv gt na nb nc nd aw ne bi"><span id="effb" class="nf ku iq nb b gy ng nh l ni nj">aws s3api put-object-acl --bucket &lt;bucket-name&gt; --key  &lt;key-name&gt; --grant-read uri=http://acs.amazonaws.com/groups/global/AllUsers</span></pre><h1 id="a03c" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">最后的想法</h1><p id="df63" class="pw-post-body-paragraph ju jv iq jw b jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr ij bi translated">如果您对AWS S3访问政策感到困惑，我希望这对您有用。如果您有任何问题或反馈，请随时发表评论。</p></div><div class="ab cl no np hu nq" role="separator"><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt"/></div><div class="ij ik il im in"><h2 id="075f" class="nf ku iq bd kv nv nw dn kz nx ny dp ld kf nz oa lh kj ob oc ll kn od oe lp of bi translated">来自Infosec的报道:Infosec每天都有很多内容，很难跟上。<a class="ae mc" href="https://weekly.infosecwriteups.com/" rel="noopener ugc nofollow" target="_blank">加入我们的每周简讯</a>以5篇文章、4个线程、3个视频、2个Github Repos和工具以及1个工作提醒的形式免费获取所有最新的Infosec趋势！</h2></div></div>    
</body>
</html>