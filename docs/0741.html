<html>
<head>
<title>Fun with Creating a VBS Payload to Bypass Endpoint Security</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">创建VBS有效负载以绕过端点安全的乐趣</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/fun-with-creating-a-vbs-payload-to-bypass-endpoint-security-and-other-layers-44afd724de1b?source=collection_archive---------0-----------------------#2020-08-07">https://infosecwriteups.com/fun-with-creating-a-vbs-payload-to-bypass-endpoint-security-and-other-layers-44afd724de1b?source=collection_archive---------0-----------------------#2020-08-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="f373" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">对Valak恶意软件变种的快速分析</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/3cce480202fd320e5d744106e6bfce34.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m4w5j0KRuP8Hj05KvlH4Jg.jpeg"/></div></div></figure><h1 id="d567" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">简介:创造另一个有趣的有效载荷来绕过一些东西</h1><p id="8a51" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">我不会关注从系统触发并绕过终端安全解决方案的新颖的<a class="ae mf" href="https://lolbas-project.github.io/" rel="noopener ugc nofollow" target="_blank"> LOLBAS </a>有效负载，我将向您展示一种替代方法，它可以更深入地了解您的控件如何组合在一起:您为什么认为进行真正端到端且真实的“紫色团队”网络钓鱼有效负载模拟如此重要？它不仅仅显示对单个检测或预防技术或过程的绕过。对于端到端，我的意思是让我们模拟一个最终用户有效负载，它不仅可以绕过SMTP内容安全扫描等电子邮件控制，还可以绕过EDR、EPP和传统防病毒等终端安全解决方案。让我们与SOC或MSSP携手合作，看看人工分析师能否在true Purple Team partnership的日志中检测到这一点，并确保日志得到正确配置和丰富，以提供这种可见性。让我们与企业卫士合作，帮助他们改进流程和技术，实现真实的模拟有效载荷。在这篇文章中，我将介绍如何通过启用VBA宏的Excel文档来创建一个有趣的VBS有效载荷。它将向您展示一个非常简单的例子。</p></div><div class="ab cl mg mh hu mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ij ik il im in"><p id="9008" class="pw-post-body-paragraph lj lk iq ll b lm mn jr lo lp mo ju lr ls mp lu lv lw mq ly lz ma mr mc md me ij bi translated">当我写这篇文章的时候，一个小小的安全事件触发了这个讨论，我不得不把它加入进来。在网络钓鱼模拟之后，我添加了一个对Valak恶意软件变种的快速分析，该变种攻击了我们的一个客户，并与一个新的隐形小VBA宏有关。</p><h1 id="7448" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">为什么这很重要？</h1><p id="41dd" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">这很重要，因为这是许多企业每天都要面对的问题。我与一位CISO和我们的MDR团队讨论了如何展示一个有效载荷，它可以绕过一个MDR供应商，而另一个供应商将被阻止。但我收到了一些推回来。这不够现实，因为它需要讲述整个客户故事。是真的。客户总是可以说，我们的校样点或Mimecast会阻止电子邮件到达我们用户的收件箱。恶意软件有效负载如何在所有层(包括入站电子邮件流和端点执行)传递和暂存？</p><h1 id="45dd" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">紫色团队钓鱼负载模拟</h1><p id="7c3c" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">让我们创建一个有效负载和一些测试用例场景，在这些场景中，我们可以测试发送一封带有有效负载的电子邮件，该邮件将原封不动地到达目标收件箱。首先，在您的实验室中有一个GSuite攻击者/受害者和一个Office365攻击者/受害者来测试云内部和云之间的这些网络钓鱼场景是有帮助的。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ms"><img src="../Images/0bd26499ba19a08363623746b83f7432.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*stOie763pVX22jXP453J1A.jpeg"/></div></div><figcaption class="mt mu gj gh gi mv mw bd b be z dk translated">紫色团队:终极“团队运动”</figcaption></figure><ul class=""><li id="f118" class="mx my iq ll b lm mn lp mo ls mz lw na ma nb me nc nd ne nf bi translated">建立一个新的Gsuite攻击者域。针对Office365托管的客户发送网络钓鱼有效负载。</li><li id="850a" class="mx my iq ll b lm ng lp nh ls ni lw nj ma nk me nc nd ne nf bi translated">站起来一个新的Office365攻击者域。针对Office365托管的客户发送网络钓鱼有效负载。</li><li id="ac20" class="mx my iq ll b lm ng lp nh ls ni lw nj ma nk me nc nd ne nf bi translated">验证有效负载是否在默认设置打开的情况下被阻止。</li><li id="2e46" class="mx my iq ll b lm ng lp nh ls ni lw nj ma nk me nc nd ne nf bi translated">验证有效负载是否被Office ATP服务阻止。</li></ul></div><div class="ab cl mg mh hu mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ij ik il im in"><p id="720d" class="pw-post-body-paragraph lj lk iq ll b lm mn jr lo lp mo ju lr ls mp lu lv lw mq ly lz ma mr mc md me ij bi translated">我用Office 365和GSuite设置了一些测试帐户，因为我想验证攻击者如何通过可信CSP的白名单从一个“云”发送到另一个“云”，以及会产生什么影响。在这个测试中，我观察到当攻击者向Office365托管的受害者发送消息时，GSuite阻止了出站宏VBA。但Office 365允许它在两个不同的客户之间使用默认设置。事实证明，您不仅需要购买并启用Office ATP订阅，还需要正确配置检测和隔离恶意VBS宏的正确策略。</p><h1 id="bc72" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">VBS有效负载演示:创建手动有效负载</h1><p id="ce07" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">让我们来看看VBS的有效载荷传输系统。微软Excel和Word VBS宏是失传的艺术，仍然非常有效地携带恶意载荷。研究显示，它们在野外仍然经常被观察到。这是为什么呢？事实证明，办公应用程序仍然非常受欢迎，用于高级计算和复杂工作流程的宏功能也是如此。嵌入到Microsoft Excel文档中的VBA应用程序对一些公司尤其有用。</p><p id="d9ac" class="pw-post-body-paragraph lj lk iq ll b lm mn jr lo lp mo ju lr ls mp lu lv lw mq ly lz ma mr mc md me ij bi translated">这个测试案例深受威尔·奥尔索普的《高级渗透测试:入侵世界上最安全的网络》的影响</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nl"><img src="../Images/44ef9fd3763cfe72008d4460c4854035.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_EaGfN7EqK96G-wLezDM2Q.png"/></div></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nm"><img src="../Images/2f1c74b8eacbc78405286914d4b348ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1a_bA3PrO5Gw4H-WbIKqmg.png"/></div></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nn"><img src="../Images/54dc35df6fb6d34908b1adafcf12d3e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PLv6kzQLWA9__9Xz8_MOLw.png"/></div></div></figure><p id="6ca4" class="pw-post-body-paragraph lj lk iq ll b lm mn jr lo lp mo ju lr ls mp lu lv lw mq ly lz ma mr mc md me ij bi translated">您可以使用Excel中的一些默认模板来创建预算，这正是我在本次测试中所做的。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi no"><img src="../Images/28a81a863f4a5e35ceaa907bfe9ac404.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vIkeL8stPMcRg3zPpA7zUQ.png"/></div></div></figure><p id="5a92" class="pw-post-body-paragraph lj lk iq ll b lm mn jr lo lp mo ju lr ls mp lu lv lw mq ly lz ma mr mc md me ij bi translated">我们上面所做的是避免使用AutoOpen()函数，因为它更容易被反病毒引擎标记。我们依靠一个借口，让目标点击“计算”宏按钮，这将启动所需的VBS函数。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi np"><img src="../Images/6e518af8430ba8f7386ef5de25dfb508.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3VLP0K2u9fKAhkidvqOTIg.png"/></div></div></figure><p id="f7a6" class="pw-post-body-paragraph lj lk iq ll b lm mn jr lo lp mo ju lr ls mp lu lv lw mq ly lz ma mr mc md me ij bi translated">现在，根据需要更改变量，以匹配您模拟的攻击基础设施。VBS电码就位于这个要点<a class="ae mf" href="https://gist.github.com/iknowjason/08d452e059ec43fa4efdb59ddb0da3e7" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nq"><img src="../Images/e6b8184f6759549f6bd4e4e260c7665b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zQbVL6JOWpAAbuWHwr8uBQ.png"/></div></div><figcaption class="mt mu gj gh gi mv mw bd b be z dk translated">带有TLS传输的反向外壳VBS有效载荷</figcaption></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nr"><img src="../Images/3efa8a1fa972883f878bc9be284b2631.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uYXHhNpqI3h5Rc1Yqb_BzQ.png"/></div></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ns"><img src="../Images/60d392cd61315884e11c429830a99602.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mkw_MpHeNg-J2Ou6y4f_sA.png"/></div></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nt"><img src="../Images/78ce1334b9ca0a84793ce6384e81b027.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JebAm5VMt9u6SKhFL3NdOQ.png"/></div></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nu"><img src="../Images/0eeaf53570d9130385ba211f27b96f5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*77ZAdm9sNBD4v2gSB5pZmQ.png"/></div></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nv"><img src="../Images/fad68bc1639e42f1fc421e5d7946d7a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RwD2F_WhVRkT7BVBsY3McQ.png"/></div></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nw"><img src="../Images/abfacc202b39f5189b4d900fb1baa309.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_eyYi1sullAsu05VRZmErw.png"/></div></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nx"><img src="../Images/ed83b3705c1f3098923c576dfe1b6d32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2pG6hC8GSQIKFYqZUHcSQA.png"/></div></div></figure><p id="d57d" class="pw-post-body-paragraph lj lk iq ll b lm mn jr lo lp mo ju lr ls mp lu lv lw mq ly lz ma mr mc md me ij bi translated">现在，我们已经建立了攻击基础设施。我们编个借口发给受害者。在我们的测试中，这个启用宏的Excel电子表格在两个Office365客户域之间发送，具有所有默认设置，没有检测到或警告。这封邮件是在受害者的收件箱里收到的。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ny"><img src="../Images/372c8f8635ac0be45220297596e6f0fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZEumrJttSkFCvnjYSczyaw.png"/></div></div></figure><p id="0ae0" class="pw-post-body-paragraph lj lk iq ll b lm mn jr lo lp mo ju lr ls mp lu lv lw mq ly lz ma mr mc md me ij bi translated">让我们假设托词是可信的，用户下载并打开了Excel电子表格，遵循托词中的所有提示。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nz"><img src="../Images/3401745228ccc121ecec623c0332f945.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NOk8jJkbuwCOm_a-IdjzZw.png"/></div></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oa"><img src="../Images/c9c69b2e03f7935d82c348f6f72ceded.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AwRMRE2IICATuS6sXvBrmA.png"/></div></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ob"><img src="../Images/7992d3dd6a4d0cd093332aefcdb654c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sa_F1pBh3r_nY7RV4-_kYQ.png"/></div></div></figure><p id="ae2c" class="pw-post-body-paragraph lj lk iq ll b lm mn jr lo lp mo ju lr ls mp lu lv lw mq ly lz ma mr mc md me ij bi translated">最后，您应该看到反向shell负载是由shell catcher监听器在云中使用ncat和加密的TLS会话捕获的！此时您应该会看到一个Windows CMD提示符。</p><h2 id="3d87" class="oc ks iq bd kt od oe dn kx of og dp lb ls oh oi ld lw oj ok lf ma ol om lh on bi translated">摘要</h2><ul class=""><li id="f533" class="mx my iq ll b lm ln lp lq ls oo lw op ma oq me nc nd ne nf bi translated">我们创建了一个VBA函数，它依赖于用户点击一个启用宏的按钮。</li><li id="dea3" class="mx my iq ll b lm ng lp nh ls ni lw nj ma nk me nc nd ne nf bi translated">我们没有依赖<strong class="ll ir"> <em class="or"> AutoOpen() </em> </strong>函数，这使得这个测试更加隐秘。</li><li id="f8b2" class="mx my iq ll b lm ng lp nh ls ni lw nj ma nk me nc nd ne nf bi translated">单击VBA函数时，它会在用户配置文件目录中编写一个VBScript。</li><li id="8226" class="mx my iq ll b lm ng lp nh ls ni lw nj ma nk me nc nd ne nf bi translated">剧本在VBA执行。</li><li id="c8e3" class="mx my iq ll b lm ng lp nh ls ni lw nj ma nk me nc nd ne nf bi translated">该脚本从Nginx web服务器下载一个可执行文件(ncat.exe)。</li><li id="852f" class="mx my iq ll b lm ng lp nh ls ni lw nj ma nk me nc nd ne nf bi translated">该脚本运行ncat.exe，使用TLS传输将外壳铲到基于云的C2服务器上。</li><li id="cc52" class="mx my iq ll b lm ng lp nh ls ni lw nj ma nk me nc nd ne nf bi translated">我们使用了一个看起来很无辜的VBA宏，它携带了一个VBS负载，将其写入一个文件，然后执行它！这是一个双阶段VBS，模拟了一个更复杂的C2框架将会使用的内容。</li></ul><p id="324d" class="pw-post-body-paragraph lj lk iq ll b lm mn jr lo lp mo ju lr ls mp lu lv lw mq ly lz ma mr mc md me ij bi translated">这种技术已经被证实可以绕过至少一个EDR供应商。所以享受它的乐趣，但请只把它用在好的方面，更好地理解和捍卫你的网络。注意，这是一个非常基础的例子。下一步将是混淆VBS，并对传送系统文件使用压缩/加密。借助这个紫色团队网络钓鱼测试案例，我们能够绕过任何电子邮件检测以及端点EDR解决方案。这比仅仅测试一个单一的预防或检测层更有价值，因为它模拟了端到端的攻击。</p><h1 id="2222" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">进入瓦拉克</h1><p id="1ba5" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">在我撰写本文时，我们的一位安全分析师帮助筛选了一份来自客户的可疑word文档报告。它最终成为了一个Valak恶意软件变种，与之前描述其工作原理的一些<a class="ae mf" href="https://www.cybereason.com/blog/valak-more-than-meets-the-eye" rel="noopener ugc nofollow" target="_blank">文章</a>有些不同。这是一个受密码保护的Word 97–2003，记录了VBA/VBS的有效载荷。下面是一些快速和肮脏的笔记对这一点的初步分析。不幸的是，在我们有机会收集更多信息之前，登台服务器(看起来第一阶段试图从那里投放更多恶意软件)被关闭了。</p><ul class=""><li id="060f" class="mx my iq ll b lm mn lp mo ls mz lw na ma nb me nc nd ne nf bi translated"><strong class="ll ir">2020年7月31日星期五:</strong>用户报告可疑word文档。</li><li id="dba3" class="mx my iq ll b lm ng lp nh ls ni lw nj ma nk me nc nd ne nf bi translated"><strong class="ll ir">2020年7月31日，星期五:</strong>安全分析师通过将word文档上传到混合分析来执行分类。</li><li id="de91" class="mx my iq ll b lm ng lp nh ls ni lw nj ma nk me nc nd ne nf bi translated"><strong class="ll ir">勘验API链接</strong> <a class="ae mf" href="https://labs.inquest.net/dfi/sha256/bf27a7b725ef434d21f6f7aa8af4fbd2398b352eb9b1d74c46a1e4595f7ce39b" rel="noopener ugc nofollow" target="_blank"> <strong class="ll ir">此处</strong> </a> <strong class="ll ir"> : </strong></li><li id="9f1c" class="mx my iq ll b lm ng lp nh ls ni lw nj ma nk me nc nd ne nf bi translated"><strong class="ll ir">2020年8月4日星期二:</strong>开始沙盒动态分析工作。</li><li id="e9dd" class="mx my iq ll b lm ng lp nh ls ni lw nj ma nk me nc nd ne nf bi translated">用户收到的电子邮件的图像。它似乎是来自可信第三方的前一个线程中的回复。这显示了对手危及第三方并将其自身插入之前的电子邮件线索的策略，在这种情况下，用户可能会放松警惕并更倾向于“信任”打开附件。</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi os"><img src="../Images/44f5a7d3a27875fc8c60be8ae74700fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JZOpe9dLzjpmU3Ln1Dj7yQ.png"/></div></div></figure><ul class=""><li id="5376" class="mx my iq ll b lm mn lp mo ls mz lw na ma nb me nc nd ne nf bi translated">解压缩zip文件时会显示一个受密码保护的Word 97–2003文档。请注意上面显示的电子邮件正文中包含的密码，这可能会降低电子邮件内容扫描引擎解析电子邮件正文中的密码并在沙箱中运行该密码的能力。</li><li id="ac40" class="mx my iq ll b lm ng lp nh ls ni lw nj ma nk me nc nd ne nf bi translated"><strong class="ll ir">文件名:</strong> ordain.07.20.doc</li><li id="a156" class="mx my iq ll b lm ng lp nh ls ni lw nj ma nk me nc nd ne nf bi translated"><strong class="ll ir">SHA-256:</strong>BF 27 a 7b 725 ef 434d 21 f 6 f 7 aa 8 af 4 FBD 2398 b 352 EB 9 B1 d 74 c 46 a 1e 4595 f 7 ce 39 b</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ot"><img src="../Images/7165be743e97a3ce8fad0a5d1b944988.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I5-eihwJ9MgXMQftpf2XIA.png"/></div></div></figure><ul class=""><li id="4026" class="mx my iq ll b lm mn lp mo ls mz lw na ma nb me nc nd ne nf bi translated">通过单击“启用编辑”和“启用内容”这两个默认值来打开word 97–2003文档宏</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ou"><img src="../Images/2d865088e66a6450f70d2e5d52d7c8af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q1vRh582Kv2wWIQqGOSR0w.png"/></div></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ov"><img src="../Images/f67e1ba5564219eb5f6cf4793582fd3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WQFIa71_98dOtwqODItQGA.png"/></div></div></figure><ul class=""><li id="d1fb" class="mx my iq ll b lm mn lp mo ls mz lw na ma nb me nc nd ne nf bi translated">用户选择<strong class="ll ir"> <em class="or">【启用编辑】</em></strong><strong class="ll ir"><em class="or">启用内容</em> </strong>(而不是需要功能宏按钮)后，VBA调用<strong class="ll ir"> <em class="or"> AutoOpen() </em> </strong>自动运行代码。</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ow"><img src="../Images/5d893e6a5c2b30aceb40403ff339cf1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1310/format:webp/1*5JHgvxrmYqxo_S6OVGZ8Rg.png"/></div></figure><ul class=""><li id="b485" class="mx my iq ll b lm mn lp mo ls mz lw na ma nb me nc nd ne nf bi translated">数据包跟踪显示在TCP/80上有一个HTTP GET请求发送到下列域和IP地址。图像就在下面，显示了请求的PHP页面和URI。</li><li id="3d2f" class="mx my iq ll b lm ng lp nh ls ni lw nj ma nk me nc nd ne nf bi translated"><strong class="ll ir">域:</strong>4xj0nhh.com</li><li id="9656" class="mx my iq ll b lm ng lp nh ls ni lw nj ma nk me nc nd ne nf bi translated"><strong class="ll ir">IP:</strong>188.127.224.179</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ox"><img src="../Images/639fb2c64dc54df84251a8f61f9f39e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iuqZ4NOZsTr6FYmMLBCzuA.png"/></div></div></figure><ul class=""><li id="d628" class="mx my iq ll b lm mn lp mo ls mz lw na ma nb me nc nd ne nf bi translated">8月4日星期二晚上:web服务器超时，一段时间后连接被拒绝。这与运行VBA时收到以下VB错误的时间相吻合，即临时服务器无法提供阶段2所需的文件。</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oy"><img src="../Images/53dd55f8f3706f2ae5046353864beb0b.png" data-original-src="https://miro.medium.com/v2/resize:fit:734/format:webp/1*n380yEM8o0Kzvu4UF6OrWg.png"/></div></figure><ul class=""><li id="d205" class="mx my iq ll b lm mn lp mo ls mz lw na ma nb me nc nd ne nf bi translated">在8月5日星期三，我们开始注意到服务器在端口80上对任何SYN TCP请求发出RST。到8月5日，网络服务器不再允许3次握手。</li><li id="44b2" class="mx my iq ll b lm ng lp nh ls ni lw nj ma nk me nc nd ne nf bi translated">下图显示了带有模糊VBS字符串的模块和类模块文件(总共三个)的结构。</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oz"><img src="../Images/5a0a7e3129c4ad1c04e7e70f17d7d744.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lLH6N069BvDnyeU0ybIqnQ.png"/></div></div></figure><ul class=""><li id="56af" class="mx my iq ll b lm mn lp mo ls mz lw na ma nb me nc nd ne nf bi translated">8月5日的运行时测试开始显示Windows Defender通过8月5日发布的新签名阻止了该变体:</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pa"><img src="../Images/887fdfb6be58f9768d53a9454d6f1699.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sWkM9csdW7z_oPc3fRexlg.png"/></div></div></figure><ul class=""><li id="6df3" class="mx my iq ll b lm mn lp mo ls mz lw na ma nb me nc nd ne nf bi translated">Microsoft威胁情报更改日志显示了8月5日发布的此Valak变体的更新威胁情报签名:</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pb"><img src="../Images/c20019d51ccf6ca1e0a63f3d9d08501a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9NxoYixzzSg4sERm9eE62Q.png"/></div></div></figure><h1 id="5699" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">名人</h1><ul class=""><li id="b5c3" class="mx my iq ll b lm ln lp lq ls oo lw op ma oq me nc nd ne nf bi translated">在收到时(Fri，2020年7月31日)，当检测到以前的恶意软件并自动隔离时，此变体绕过了Office ATP管理的订阅。</li><li id="7804" class="mx my iq ll b lm ng lp nh ls ni lw nj ma nk me nc nd ne nf bi translated">VBA在受密码保护的Word 97–2003文档中，密码在电子邮件正文中提供。</li><li id="99a6" class="mx my iq ll b lm ng lp nh ls ni lw nj ma nk me nc nd ne nf bi translated">发件人似乎是可信任的第三方，该电子邮件线程是对受害者和发件人之间的先前电子邮件线程的回复。</li><li id="7128" class="mx my iq ll b lm ng lp nh ls ni lw nj ma nk me nc nd ne nf bi translated">从这个快速的Valak案例研究中，你可以得到更多的想法，使前紫色队与VBA测试有效载荷更加隐蔽。</li></ul></div></div>    
</body>
</html>