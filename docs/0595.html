<html>
<head>
<title>Pooot Writeup</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Pooot书面报告</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/pooot-writeup-217384a6b69c?source=collection_archive---------3-----------------------#2020-05-18">https://infosecwriteups.com/pooot-writeup-217384a6b69c?source=collection_archive---------3-----------------------#2020-05-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/17935b8b91b9ff319071e5a32558259e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UituUb-s8W2w80qA3LAK5Q.png"/></div></div></figure><div class=""/><div class=""><h2 id="7cdd" class="pw-subtitle-paragraph jy ja jb bd b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp dk translated">CTF等级防御战</h2></div><p id="260d" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">是的… DEFCON今年真的取消了，不过我没有错过玩DEFCON CTF Quals的机会。我参加了Sauercloud团队，大部分时间都在参加pooot网络挑战赛。不幸的是，在测试结束之前，我们没有成功解决这个问题，但是我继续努力，最终找到了解决方案。为了记录我自己的解决方案，并希望帮助那些没有解决挑战的人，这里是我的记录。</p></div><div class="ab cl lm ln hu lo" role="separator"><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr"/></div><div class="ij ik il im in"><h2 id="2039" class="lt lu jb bd lv lw lx dn ly lz ma dp mb kz mc md me ld mf mg mh lh mi mj mk ml bi translated">我们有什么？</h2><blockquote class="mm mn mo"><p id="2da3" class="kq kr mp ks b kt ku kc kv kw kx kf ky mq la lb lc mr le lf lg ms li lj lk ll ij bi translated">网络每天都变得越来越危险。我们的安全pooot代理允许您安全地继续浏览，并对您访问的网站隐藏您的IP地址！在这里摇摆一下:pooot.challenges.ooo</p></blockquote><p id="7845" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">当我们打开网站时，我们看到一个输入URL和匿名冲浪的字段。提交后，网站渲染相应的网站。第一个有趣的提示是HTML中的注释，它将我们引向我上传的网站的来源<a class="ae mt" href="https://gist.github.com/FHantke/796e6f31a78f10503829873bd9713ad4" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><div class="mu mv mw mx gt ab cb"><figure class="my is mz na nb nc nd paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><img src="../Images/4d4ff1413edcbdfd8c66148bd92a27bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*uGO8EslbGa8Ima7ruwpscA.png"/></div></figure><figure class="my is mz na nb nc nd paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><img src="../Images/e4dd464f6c88dd82a13546e8c8e2a670.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*AAhHgbBD_MyE21CVTATtIw.png"/></div><figcaption class="ne nf gj gh gi ng nh bd b be z dk ni di nj nk translated">索引页(左)和反馈表(右)</figcaption></figure></div><p id="ca96" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">该网站使用Flask并提供以下端点:</p><ul class=""><li id="256a" class="nl nm jb ks b kt ku kw kx kz nn ld no lh np ll nq nr ns nt bi translated"><code class="fe nu nv nw nx b">/</code></li><li id="0c76" class="nl nm jb ks b kt ny kw nz kz oa ld ob lh oc ll nq nr ns nt bi translated"><code class="fe nu nv nw nx b">/&lt;string:domain&gt;/&lt;path:path&gt;</code></li><li id="bff3" class="nl nm jb ks b kt ny kw nz kz oa ld ob lh oc ll nq nr ns nt bi translated"><code class="fe nu nv nw nx b">/source</code></li><li id="0017" class="nl nm jb ks b kt ny kw nz kz oa ld ob lh oc ll nq nr ns nt bi translated"><code class="fe nu nv nw nx b">/feedback</code></li></ul><p id="1081" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated"><em class="mp">域/路径</em> URL使用python请求来<code class="fe nu nv nw nx b">GET</code>所请求的网站，并修改所有链接以与代理一起工作。之后，它呈现内容。反馈路径用于给出关于损坏页面的反馈。它使用Redis队列来调度任务。整个服务隐藏在一个代理后面。</p><h2 id="6c7f" class="lt lu jb bd lv lw lx dn ly lz ma dp mb kz mc md me ld mf mg mh lh mi mj mk ml bi translated">我们在找什么？</h2><p id="2f0c" class="pw-post-body-paragraph kq kr jb ks b kt od kc kv kw oe kf ky kz of lb lc ld og lf lg lh oh lj lk ll ij bi translated">我们的第一个想法是利用SSRF与Redis联系。所以，我们建立了一个nginx服务器，它回复了一个重定向到<em class="mp">pooot.challenges.ooo/&lt;我的服务器&gt; </em>的请求，并且成功了。我们收到了两个请求。然而，当我们试图重定向到内部IP时，我们收到错误“<em class="mp">不允许内部IP地址[…]”。</em>服务器检查请求是否来自<em class="mp"> 172.25.0.100，</em>本地IP，由于我们的源地址来自我们自己的PC，请求被阻止。</p><pre class="mu mv mw mx gt oi nx oj ok aw ol bi"><span id="0977" class="lt lu jb nx b gy om on l oo op">if request.headers.getlist("X-Forwarded-For"):<br/>    client_ip = request.headers.getlist("X-Forwarded-For")[0]<br/>else:<br/>    client_ip = request.remote_addr<br/>if isIP(domain):<br/>    protocol = “http”<br/>    if client_ip != “172.25.0.100”:<br/>        app.logger.error(f”Internal IP address [...] not allowed.” )<br/>        return “Internal IP address not allowed”, 400</span></pre><p id="34e3" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">接下来，我们想知道工人的工作是什么。</p><pre class="mu mv mw mx gt oi nx oj ok aw ol bi"><span id="3f95" class="lt lu jb nx b gy om on l oo op">from worker import task<br/>url = re.sub(r'http[s]*://', '', form.url.data)<br/>job = q.enqueue(task,url)</span></pre><p id="c1e5" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">当我们在表单中提交我们的服务器域时，一个请求出现在我们的nginx访问日志中。接下来，我们通过回复一个执行JS的html文档(如下)来请求我们的服务器——XSS，从而进行测试。是的，我们收到了两个请求。html由执行JS的无头chrome调用。从这一点来看，我们有一个由内部浏览器发起的请求。因此，我们可以调用/ <ip>并通过内部IP检查。现在是时候找到Redis并与之对话了…好吧，我将跳过这一部分，因为它将我们引向了一个我们永远无法逃脱的死胡同...</ip></p><figure class="mu mv mw mx gt is"><div class="bz fp l di"><div class="oq or l"/></div><figcaption class="ne nf gj gh gi ng nh bd b be z dk translated">请求内部IP的html内容</figcaption></figure><h2 id="e713" class="lt lu jb bd lv lw lx dn ly lz ma dp mb kz mc md me ld mf mg mh lh mi mj mk ml bi translated">最终解决方案</h2><p id="da99" class="pw-post-body-paragraph kq kr jb ks b kt od kc kv kw oe kf ky kz of lb lc ld og lf lg lh oh lj lk ll ij bi translated">CTF结束后，有人提出将工人任务中的XSS与服务工人结合起来，以检查其他被访问的URL。这让我开始研究服务人员，这是我以前不知道的概念。服务人员实质上是您网站/浏览器中的代理，可以拦截来自浏览器的请求，并从缓存中提取这些请求。它还可以做的是，它可以发送请求或关于请求的信息到另一个服务器！</p><p id="cae2" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">我精心制作了一个服务工作者，为这个任务注册了它，然后立即收到了另一个请求。在下面的访问日志中，我们可以看到无头chrome也访问了<em class="mp"> 172.25.0.102:3000 </em>。使用上面的方法，我请求了这个IP，我终于有了标志！！！</p><figure class="mu mv mw mx gt is"><div class="bz fp l di"><div class="oq or l"/></div><figcaption class="ne nf gj gh gi ng nh bd b be z dk translated">服务人员js</figcaption></figure><figure class="mu mv mw mx gt is"><div class="bz fp l di"><div class="oq or l"/></div><figcaption class="ne nf gj gh gi ng nh bd b be z dk translated">注册服务人员的html内容</figcaption></figure><figure class="mu mv mw mx gt is"><div class="bz fp l di"><div class="oq or l"/></div><figcaption class="ne nf gj gh gi ng nh bd b be z dk translated">访问日志</figcaption></figure><blockquote class="mm mn mo"><p id="c917" class="kq kr mp ks b kt ku kc kv kw kx kf ky mq la lb lc mr le lf lg ms li lj lk ll ij bi translated">OOO { m3lt 1 ng _ p0t _ of _ S3 cur 1 ty _ 0 R1 G1 n 5 }</p></blockquote><h2 id="5a05" class="lt lu jb bd lv lw lx dn ly lz ma dp mb kz mc md me ld mf mg mh lh mi mj mk ml bi translated">摘要</h2><p id="a520" class="pw-post-body-paragraph kq kr jb ks b kt od kc kv kw oe kf ky kz of lb lc ld og lf lg lh oh lj lk ll ij bi translated">挑战非常有趣，我学到了很多。这对我来说是最重要的部分——我喜欢在玩CTFs的时候学习新的东西。感谢溢出秩序组织的挑战，感谢我的团队给我展示了许多很酷的技巧。继续黑！</p></div></div>    
</body>
</html>