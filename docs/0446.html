<html>
<head>
<title>Out-of-Band (OOB) SQL Injection</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带外(OOB) SQL注入</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/out-of-band-oob-sql-injection-87b7c666548b?source=collection_archive---------0-----------------------#2019-12-10">https://infosecwriteups.com/out-of-band-oob-sql-injection-87b7c666548b?source=collection_archive---------0-----------------------#2019-12-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="2918" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">带外(OOB) SQL注入不是一种新的攻击，几年前就开始讨论了。撰写的目的是分享和总结研究过程中的发现。关于这项研究的详细讨论可以参考在<a class="ae kl" href="https://www.academia.edu/41117452/A_Study_of_Out-of-Band_Structured_Query_Language_Injection" rel="noopener ugc nofollow" target="_blank">学术界</a>和<a class="ae kl" href="https://zenodo.org/record/3556347#.XeDK1tURVPY" rel="noopener ugc nofollow" target="_blank">芝诺多</a>发表的论文。文中讨论的相关查询可以参考<a class="ae kl" href="https://github.com/Gabriel-Labs/OOB-SQLi" rel="noopener ugc nofollow" target="_blank"> GitHub </a>。</p><p id="9dc0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">与带内和盲SQL注入相比，OOB SQL注入通过出站通道过滤数据，可以是DNS或HTTP协议。数据库系统发起出站DNS或HTTP请求的能力可能需要依赖于可用的功能。该函数可以是文件操作函数(例如:load_file()，master..xp_dirtree)或建立连接函数(例如:DBMS_LDAP。INIT，UTL_HTTP.request)。要利用OOB SQL注入，目标web和数据库服务器应满足以下条件:</p><ol class=""><li id="a4e5" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated">web应用程序缺乏输入验证</li><li id="7c16" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">允许目标数据库服务器向公众发起出站请求(DNS或HTTP)而不受安全边界限制的网络环境</li><li id="df06" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">足够的权限来执行必要的功能，以启动出站请求</li></ol><p id="00ec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下图说明了OOB SQL注入的流程。在本文中，Burp Collaborator服务器用于监听和捕获从数据库系统发起的出站请求。Burp Collaborator server是Burp Suite Enterprise的一个组件，具有独特的FQDN，位于云上，用于接收指向服务器的任何出站请求。</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi la"><img src="../Images/63af68efcb48ab3b8f73bd9853f4b396.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hryYjQWH7XniH9KQLvnCYg.jpeg"/></div></div></figure><p id="9013" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">基于DNS的渗透:</strong></p><p id="7845" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">以下是MySQL数据库的分支之一MariaDB的基于DNS的过滤查询示例。关于微软SQL数据库、PostgreSQL数据库和Oracle数据库的讨论，可以参考前面提到的论文。该查询用于从MariaDB中获取数据库版本、用户名和密码。load_file()函数用于发起出站DNS请求和句点(。)作为分隔符来组织捕获数据的显示。</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div class="gh gi lm"><img src="../Images/c08d4047283ffe52b375bb02da6c705a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1116/format:webp/1*wxYUB7PCEkkmGd9T_-CCzQ.png"/></div></figure><p id="9fcd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Burp Collaborator服务器捕获的MariaDB的DNS出站请求如下所示:</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div class="gh gi ln"><img src="../Images/f1f57287a3b1a7dc1ba3e671f1068c63.png" data-original-src="https://miro.medium.com/v2/resize:fit:1322/format:webp/1*2DXi_8wzEWXtdo1C50uYeQ.jpeg"/></div></figure><p id="2c9a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">基于HTTP的渗透:</strong></p><p id="c47f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Oracle数据库通过使用UTL_HTTP.request函数来演示基于HTTP的过滤。下面显示了用于从数据库中提取数据库版本、当前用户名和散列密码的示例查询。UTL_HTTP.request()函数的目的是触发数据库系统的HTTP请求。String version、user和hashpass用于组织捕获的数据，并使其看起来像HTTP请求的参数。</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div class="gh gi lo"><img src="../Images/42a72964183a016aa993afa41e4d991c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1102/format:webp/1*mqfeM3B_VKb6sSnNIyMdKQ.png"/></div></figure><p id="ad82" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面显示了Burp Collaborator服务器捕获的HTTP请求:</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div class="gh gi lp"><img src="../Images/3b24f81222c582b17a60239e8d389630.png" data-original-src="https://miro.medium.com/v2/resize:fit:1010/format:webp/1*nFgGY5qfijZBF3m8d6hwXw.png"/></div></figure><p id="c73f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">高级OOB SQL注入</strong></p><p id="66bb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">域名和子域名有其规范和格式。每个子域名最多63个字符，完整域名最多允许253个字符。除此之外，域名只允许字母，数字和连字符(-)。规范和格式成为使用DNS通道进行数据渗透的限制。分段和编码是可以用来克服这些限制的两种方法。</p><p id="9d9c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面是一个结合了分段和编码方法的示例查询，用于Microsoft SQL数据库的过滤。SUBSTRING函数用于将提取的原始数据一分为二，base64用于在发送到Burp Collaborator服务器之前对碎片数据进行编码。</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div class="gh gi lq"><img src="../Images/950760099a93e4eced1ada4156cb2081.png" data-original-src="https://miro.medium.com/v2/resize:fit:1104/format:webp/1*WGSaC5dI_KdqngjYnaZrFw.png"/></div></figure><p id="8293" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下图显示了Burp Collaborator服务器捕获的编码碎片数据。</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div class="gh gi lr"><img src="../Images/e541e5419e613569392cd215709dce04.png" data-original-src="https://miro.medium.com/v2/resize:fit:1192/format:webp/1*H7Ts7uokueJ4KmwpXiPORg.jpeg"/></div></figure><figure class="lb lc ld le gt lf gh gi paragraph-image"><div class="gh gi ls"><img src="../Images/d6e10a130abf3bc798978aea7e159351.png" data-original-src="https://miro.medium.com/v2/resize:fit:1218/format:webp/1*ZfHIlb9sRiQ7TdUZf5KrMg.jpeg"/></div></figure><p id="e962" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在解码之前，需要将捕获的碎片数据按顺序合并。下面显示了base64解码后的Microsoft SQL server版本。</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div class="gh gi lt"><img src="../Images/92e0b47146c50d4b72e5d72b85780db4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1362/format:webp/1*o4yASOLSBOJ2XY7jsfgGzw.jpeg"/></div></figure><p id="9f25" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">结合使用基于HTTP和DNS的渗透方法可能会产生SQL注入链接。在下一节中，Oracle数据库和MariaDB都用于演示链接，链接的流程如下所示:</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi lu"><img src="../Images/a7b9b2fb1a7d62a662aa33d9e1b2574a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gEf0ZDNsHiEzeWYuXhA-mg.jpeg"/></div></div></figure><p id="6f18" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">以下是链接的示例查询。查询的内部用于触发MariaDB的DNS出站请求，外部用于触发Oracle DB的HTTP出站请求。</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div class="gh gi lv"><img src="../Images/90fec29d2ec25d7bba5cc0ac2e93b6f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1130/format:webp/1*pwnYUPq7jdwJMoktfbAIgw.png"/></div></figure><p id="a141" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面显示了链接结束时从MariaDB捕获的数据。</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div class="gh gi lw"><img src="../Images/3ed6d29816de362983795dc26716fb19.png" data-original-src="https://miro.medium.com/v2/resize:fit:1190/format:webp/1*qsExSmY-fshCVy9yhw-6AA.jpeg"/></div></figure><p id="cb32" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">推荐</strong></p><ol class=""><li id="2222" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated">客户端和服务器端的输入验证</li><li id="a382" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">正确的错误处理，以避免显示详细的错误信息</li><li id="7fd9" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">评审网络和安全架构设计</li><li id="9936" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">根据最小特权原则将数据库帐户分配给应用程序</li><li id="ca39" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">实施Web应用程序防火墙(WAF)和入侵防御系统(IPS)等安全控制作为附加控制</li><li id="911b" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">持续监控异常和适当的事件响应流程，作为控制措施的安全网</li></ol><p id="5343" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">参考文献:</strong></p><p id="900c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://www.notsosecure.com/oob-exploitation-cheatsheet" rel="noopener ugc nofollow" target="_blank">https://www.notsosecure.com/oob-exploitation-cheatsheet</a></p><p id="5140" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://www.owasp.org/index.php/SQL_Injection" rel="noopener ugc nofollow" target="_blank">https://www.owasp.org/index.php/SQL_Injection</a></p><p id="53ef" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://www.acunetix.com/websitesecurity/sql-injection2" rel="noopener ugc nofollow" target="_blank">https://www.acunetix.com/websitesecurity/sql-injection2</a></p><p id="196a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://portswigger.net/burp/documentation/desktop/tools/collaborator-client" rel="noopener ugc nofollow" target="_blank">https://portswigger . net/burp/documentation/desktop/tools/collaborator-client</a></p><p id="d8b5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Justin Clarke的SQL注入攻击和防御(2012年)</p><div class="lx ly gp gr lz ma"><a href="https://www.cnet.com/forums/discussions/what-special-characters-can-you-use-in-a-domain-name-271485/" rel="noopener  ugc nofollow" target="_blank"><div class="mb ab fo"><div class="mc ab md cl cj me"><h2 class="bd ir gy z fp mf fr fs mg fu fw ip bi translated">域名中可以使用哪些特殊字符？-2014年11月-论坛</h2><div class="mh l"><h3 class="bd b gy z fp mf fr fs mg fu fw dk translated">我正在设法建立一个域名，但是我有问题。我想用的大多数名字都已经有人用了。我…</h3></div><div class="mi l"><p class="bd b dl z fp mf fr fs mg fu fw dk translated">www.cnet.com</p></div></div><div class="mj l"><div class="mk l ml mm mn mj mo lk ma"/></div></div></a></div></div><div class="ab cl mp mq hu mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="ij ik il im in"><p id="f3d8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mw">关注</em> <a class="ae kl" href="https://medium.com/bugbountywriteup" rel="noopener"> <em class="mw"> Infosec报道</em> </a> <em class="mw">获取更多此类精彩报道。</em></p><div class="lx ly gp gr lz ma"><a href="https://medium.com/bugbountywriteup" rel="noopener follow" target="_blank"><div class="mb ab fo"><div class="mc ab md cl cj me"><h2 class="bd ir gy z fp mf fr fs mg fu fw ip bi translated">信息安全报道</h2><div class="mh l"><h3 class="bd b gy z fp mf fr fs mg fu fw dk translated">收集了世界上最好的黑客的文章，主题从bug奖金和CTF到vulnhub…</h3></div><div class="mi l"><p class="bd b dl z fp mf fr fs mg fu fw dk translated">medium.com</p></div></div><div class="mj l"><div class="mx l ml mm mn mj mo lk ma"/></div></div></a></div></div></div>    
</body>
</html>