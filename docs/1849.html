<html>
<head>
<title>Multiple HTTP Redirects to Bypass SSRF Protections</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">多个HTTP重定向绕过SSRF保护</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/multiple-http-redirects-to-bypass-ssrf-protections-45c894e5d41c?source=collection_archive---------3-----------------------#2022-01-29">https://infosecwriteups.com/multiple-http-redirects-to-bypass-ssrf-protections-45c894e5d41c?source=collection_archive---------3-----------------------#2022-01-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="b0ff" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你好黑客们，</p><p id="11f4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我需要同时利用许多已知的SSRF技术来成功利用同一家公司的许多终端。在发现之后，我将其应用于所有使用攻击者控制的URL的功能，发现了2个盲读和1个全读SSRFs。这是一个bug赏金计划，所以盲SSRFs作为dup关闭，另一个被接受。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/aecd1b55a6df5d85859ded6e4957f4ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_G8blW1A54p8eo0LEAPkIw.png"/></div></div></figure><h2 id="092c" class="kx ky iq bd kz la lb dn lc ld le dp lf jy lg lh li kc lj lk ll kg lm ln lo lp bi translated">关于目标</h2><p id="afa8" class="pw-post-body-paragraph jn jo iq jp b jq lq js jt ju lr jw jx jy ls ka kb kc lt ke kf kg lu ki kj kk ij bi translated">这家公司为其他企业提供营销服务。他们的应用程序可以让您创建和管理营销活动。有许多功能需要测试，但应用程序本身很慢，我不喜欢测试臃肿的应用程序。所以，在学会在应用程序中做一些基本的东西后，我决定不花太多时间，在找到一些漏洞后通过程序。<br/>该应用程序与URL有很大关系。因此，它引起了我的注意，我决定主要寻找SSRFs。</p><p id="3ee6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">报告本身没有披露。因此，我将它命名为“【company.com】T2”，我不会分享任何来自应用程序本身的图片，也不会改变URL结构。</p><h2 id="6e29" class="kx ky iq bd kz la lb dn lc ld le dp lf jy lg lh li kc lj lk ll kg lm ln lo lp bi translated">开发过程</h2><ol class=""><li id="aafa" class="lv lw iq jp b jq lq ju lr jy lx kc ly kg lz kk ma mb mc md bi translated">API需要用户通过应用程序的身份验证，并使用cookies来完成这项工作。</li></ol><p id="6829" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.我们有一个API调用，例如</p><pre class="km kn ko kp gt me mf mg mh aw mi bi"><span id="c1b3" class="kx ky iq mf b gy mj mk l ml mm">https://www.company.com/api/campaign/v3/check-snippet?url=http://example.com/</span></pre><p id="2e5e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">3.<code class="fe mn mo mp mf b">url</code>参数是我们的注入点。我尝试的第一件事是向我的<a class="ae mq" href="https://github.com/projectdiscovery/interactsh" rel="noopener ugc nofollow" target="_blank"> interactsh </a>处理程序发出请求，以获取请求的HTTP头和IP地址。提出了以下请求。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mr"><img src="../Images/86c681f315e86227939d823f33921a43.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*trTy4ZbnvyIg4HPwY-F9WA.png"/></div></div></figure><p id="1485" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">4.该请求来自AWS EC2 IP地址，并且没有任何打开的端口。也没有有用的HTTP头泄露。</p><p id="9c83" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">5.应用程序发出任何传出请求。所以，我的目标是击中内部主机。这是一个盲目的请求，因为它没有泄露给我它得到的回应。但是，如果成功发出对攻击者控制的URL的请求，此功能将以JSON的形式返回完整的URL。</p><p id="1ff6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">6.域和直接IP都被允许。我已经在我的Linux VPS上运行了netcat HTTP server，并尝试向它发出请求，它成功了。然而，当我试图向"<strong class="jp ir"> 127.0.0.1 </strong>"发出请求时，却没有成功。然后，我尝试了“<strong class="jp ir"> localhost </strong>”，但也没有成功。</p><p id="b8a0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">7.我曾试图滥用URL解析器，在“<strong class="jp ir"> http://127.0.0.1/$FUZZ </strong>”、“$ <strong class="jp ir"> FUZZhttp://127.0.0.1 </strong>”和“<strong class="jp ir"> http://local$FUZZhost </strong>”中将00模糊化为FF，但没有任何结果。然后，我尝试了<a class="ae mq" href="https://github.com/cujanovic/SSRF-Testing/blob/master/ip.py" rel="noopener ugc nofollow" target="_blank">这个</a>漂亮的脚本，它可以生成许多有效载荷。同样，没有任何工作。我有在任何地方模糊所有UTF-8的倾向。通过这种方式，我在web应用程序中发现了许多奇怪的行为。</p><p id="ddca" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">8.我有像“127.0000000.000000.000001”和“127.1”这样的有效载荷。没起作用</p><p id="f1c1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">9.我尝试在DNS A记录查询中使用返回“127.0.0.1”的子域。没用。</p><p id="9e44" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">10.当我试图绕过SSRF保护时，我总是使用两个github repos。</p><pre class="km kn ko kp gt me mf mg mh aw mi bi"><span id="7777" class="kx ky iq mf b gy mj mk l ml mm"><a class="ae mq" href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Request%20Forgery" rel="noopener ugc nofollow" target="_blank">https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Request%20Forgery</a><br/><a class="ae mq" href="https://github.com/cujanovic/SSRF-Testing" rel="noopener ugc nofollow" target="_blank">https://github.com/cujanovic/SSRF-Testing</a></span></pre><p id="9750" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">11.我想看看API是否遵循HTTP重定向。所以，我做了我以前一直做的事情，使用了一个自动将302重定向到URL中设置的IP地址的网站。它看起来像这样:</p><pre class="km kn ko kp gt me mf mg mh aw mi bi"><span id="1198" class="kx ky iq mf b gy mj mk l ml mm">https://make302redirect.io/127.0.0.1</span></pre><p id="bb37" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">12.我已经使用这个有效载荷获得了一个请求，但是它不起作用。结果是，应用程序基本上搜索了像“localhost”和“127.0.0.1”这样的关键字，如果这些关键字存在于用户提供的URL中，它就会被阻止。</p><p id="b895" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">13.因此，我尝试在我的VPS上运行一个简单的Netcat HTTP服务器，它可以对发送给它的任何请求进行302重定向。该命令如下所示:</p><pre class="km kn ko kp gt me mf mg mh aw mi bi"><span id="4322" class="kx ky iq mf b gy mj mk l ml mm">echo -e "HTTP/1.1 302 Found\nContent-Type: application/json\nLocation: <a class="ae mq" href="http://127.0.0.1\n" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1\n</a>" | sudo nc -l -s 64.227.116.98 -p 8080 -q 1</span></pre><blockquote class="ms mt mu"><p id="ce1b" class="jn jo mv jp b jq jr js jt ju jv jw jx mw jz ka kb mx kd ke kf my kh ki kj kk ij bi translated"><em class="iq">(我现在不用那个IP地址了。请不要辱骂当前用户)</em></p></blockquote><p id="600a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">14.我在下面提出了API请求。</p><pre class="km kn ko kp gt me mf mg mh aw mi bi"><span id="b433" class="kx ky iq mf b gy mj mk l ml mm">https://www.company.com/api/campaign/v3/check-snippet?url=http://myIP/</span></pre><p id="dc8a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">15.没用。</p><p id="ed91" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">16.此时，我绝望了。该应用程序基本上使用了类似“localhost，127.0.0.1”的关键字，并遵循HTTP重定向。因此，在用<a class="mz na ep" href="https://medium.com/u/a37e2352fa39?source=post_page-----45c894e5d41c--------------------------------" rel="noopener" target="_blank"> pleorqy </a>尝试了一些其他有效负载后，我在不同的端口运行了两个netcat服务器，并将第一个服务器重定向到本地主机。它看起来像这样:</p><pre class="km kn ko kp gt me mf mg mh aw mi bi"><span id="8027" class="kx ky iq mf b gy mj mk l ml mm">Vulnerable server ---&gt; my server on port 8080 ---&gt; my server on port 8081 ---&gt; localhost</span></pre><p id="5e87" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">17.这一次成功了。</p><h2 id="273a" class="kx ky iq bd kz la lb dn lc ld le dp lf jy lg lh li kc lj lk ll kg lm ln lo lp bi translated">结论</h2><p id="3f14" class="pw-post-body-paragraph jn jo iq jp b jq lq js jt ju lr jw jx jy ls ka kb kc lt ke kf kg lu ki kj kk ij bi translated">如果我使用类似<code class="fe mn mo mp mf b"><strong class="jp ir">127.0.0.1.nip.io</strong></code> <strong class="jp ir"> </strong>的服务，我永远不会发现这个漏洞，因为应用程序不接受任何包含<strong class="jp ir"/><strong class="jp ir">127 . 0 . 0 . 1</strong>的内容。<br/>应用程序检查了第一个HTTP 302重定向中报头<code class="fe mn mo mp mf b"><strong class="jp ir">Location</strong></code>的值。然而，它没有检查第二个。这就指向了SSRF。</p><p id="029d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我在不同的API端点中使用了这些方法，总共发现了3个这样的错误。其中之一是一个完整的SSRF，让我发现内部资产。</p></div><div class="ab cl nb nc hu nd" role="separator"><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng"/></div><div class="ij ik il im in"><h1 id="94c5" class="ni ky iq bd kz nj nk nl lc nm nn no lf np nq nr li ns nt nu ll nv nw nx lo ny bi translated">🔈 🔈Infosec Writeups正在组织其首次虚拟会议和网络活动。如果你对信息安全感兴趣，这是最酷的地方，有16个令人难以置信的演讲者和10多个小时充满力量的讨论会议。<a class="ae mq" href="https://iwcon.live/" rel="noopener ugc nofollow" target="_blank">查看更多详情并在此注册。</a></h1><div class="nz oa gp gr ob oc"><a href="https://iwcon.live/" rel="noopener  ugc nofollow" target="_blank"><div class="od ab fo"><div class="oe ab of cl cj og"><h2 class="bd ir gy z fp oh fr fs oi fu fw ip bi translated">IWCon2022 - Infosec书面报告虚拟会议</h2><div class="oj l"><h3 class="bd b gy z fp oh fr fs oi fu fw dk translated">与世界上最优秀的信息安全专家建立联系。了解网络安全专家如何取得成功。将新技能添加到您的…</h3></div><div class="ok l"><p class="bd b dl z fp oh fr fs oi fu fw dk translated">iwcon.live</p></div></div><div class="ol l"><div class="om l on oo op ol oq kv oc"/></div></div></a></div></div></div>    
</body>
</html>