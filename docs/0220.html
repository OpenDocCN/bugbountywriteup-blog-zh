<html>
<head>
<title>Ping Power — ICMP Tunnel</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Ping电源— ICMP隧道</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/ping-power-icmp-tunnel-31e2abb2aaea?source=collection_archive---------0-----------------------#2018-12-17">https://infosecwriteups.com/ping-power-icmp-tunnel-31e2abb2aaea?source=collection_archive---------0-----------------------#2018-12-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="208f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">攻击者在其活动中经常需要面对许多挑战。<br/>其中两项挑战包括</p><ol class=""><li id="780b" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated">克服网络障碍(网络策略、分段等。).</li><li id="82c7" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated">在“隐形模式”下执行不同的操作，这样他就不会被抓到。</li></ol><p id="dd0e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">应对这些挑战的一个好方法是，当试图创建一个可以跨越网络中不同障碍的秘密连接时，使用<strong class="jp ir"> ICMP隧道</strong>。</p><p id="4ddf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在计算机网络中，<strong class="jp ir">隧道</strong>一般是将一个网络协议封装成另一个网络协议的有效载荷。<a class="ae kz" href="https://en.m.wikipedia.org/wiki/Tunneling_protocol" rel="noopener ugc nofollow" target="_blank">阅读更多</a></p><p id="a5c5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> ICMP </strong>(互联网控制消息协议)是互联网协议簇中的支持协议。网络设备使用它来发送错误消息和操作信息。最广为人知也可能是最常用的ICMP消息是<a class="ae kz" href="https://en.wikipedia.org/wiki/Ping_(networking_utility)" rel="noopener ugc nofollow" target="_blank"> Ping </a>消息。</p><p id="cc81" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> Ping </strong>是控制消息，是ICMP(互联网控制消息协议)的一部分。</p><p id="54f2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Ping从网络中的一个节点发送到另一个节点。它由第2层和第3层报头(由OSI模块定义的MAC和IP报头)和一个特殊的ICMP数据包构成。发送节点将设置目的地参数，如果目的地收到消息，它将立即返回消息</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div class="gh gi la"><img src="../Images/9ca8583b7c453592be4214d3cdf889e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:942/format:webp/1*r3Vun5KPHe7ktYPpvVaPrg.png"/></div></figure><p id="c6c3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是ping数据包的IP数据报</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi li"><img src="../Images/c2ab8653dfec3ab2330f280eb4310977.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DJZez6oQhbC-pOYDgVfRTg.png"/></div></div></figure><p id="45d9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> ICMP隧道</strong>可以通过改变有效载荷数据来实现，因此它将包含我们想要发送的数据。</p><p id="c094" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通常，它包含一个默认的有效负载数据，比如这个ASCII字符串——“abcdefghijklmnopqrstuvwabcdefghi”</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi ln"><img src="../Images/7d97239489842d26e62bffed440d62ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DhqCSKkCHl8Lu_RwGWWP8A.png"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">Wireshark — ICMP数据包，有效负载数据</figcaption></figure><p id="9130" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果我们在有效载荷数据里面封装一个HTTP包，我们会得到这种方法最常见的方式——溜出一个付费WiFi。</p><p id="4d4d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这可以通过使用代理服务器来实现，该代理服务器等待ping消息并根据需要发送它们(例如，作为HTTP)。</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div class="gh gi ls"><img src="../Images/7db04f1f4f7b9f2ae0b7d79632e692e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1268/format:webp/1*yNNoRhB3taQLoGroWGSelw.png"/></div></figure><ol class=""><li id="beea" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated">使用正确的工具(例如<a class="ae kz" href="http://www.mit.edu/afs.new/sipb/user/golem/tmp/ptunnel-0.61.orig/web/" rel="noopener ugc nofollow" target="_blank"> ptunnel </a>)，将您想要发送给Google的HTTP数据包封装到Ping数据包中(在有效负载数据中)。然后将其发送到作为目的地的代理服务器IP地址。</li></ol><ul class=""><li id="8191" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk lt kr ks kt bi translated">注意—此IP不是HTTP数据包的目的地(HTTP数据包的IP目的地将是<a class="ae kz" href="http://www.google.com" rel="noopener ugc nofollow" target="_blank">www.google.com</a>的IP)</li></ul><ol class=""><li id="f533" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated">因为机场路由器通常允许ICMP流量流出网络，所以路由器会将Ping报文传送到代理服务器。</li><li id="cc00" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated">代理服务器接收Ping数据包，将其分成两部分——</li></ol><ul class=""><li id="3be9" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk lt kr ks kt bi translated">ICMP标头。</li><li id="a64b" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk lt kr ks kt bi translated">包含原始HTTP消息的有效负载。</li><li id="dbb1" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk lt kr ks kt bi translated">注意——代理发送给Google的HTTP数据包的源IP应该是代理服务器本身的IP，而不是您笔记本电脑(或机场路由器)的IP，因为Google应该回复给代理，而不是您。</li></ul><p id="0cc8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这可能是ICMP隧道最常见的用法，但是作为一名Red Teamer，我确实发现它作为一种逃避防火墙和其他网络策略的“隐蔽”方法非常有用。</p><p id="e67e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所有这些都是可能的，因为ping报文被允许从“付费WiFi”局域网通过路由器到达互联网。<br/>为什么有人会允许这种情况发生？</p><p id="8b97" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">作为一名前网络工程师，我可以告诉你，当试图理解和解决甚至是最复杂的问题时，<strong class="jp ir"> ping有很大的力量</strong>。<br/>大多数故障排除流程都是从测试信息是否从一点传递到另一点开始的。问——这条信息路线到底有没有可能？网络组件是否处于活动状态并能够做出响应？</p><p id="c1d6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Ping消息可以用最简单的方式回答这些问题和许多其他问题。</p><p id="19f2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这些故障排除过程每天都会发生。这意味着网络配置必须允许ping消息在网络上从一个节点传输到另一个节点。每个防火墙策略、路由器策略和交换机ACL(访问列表)都必须允许ICMP消息从几乎任何网络组件流向任何其他组件。<br/>这就是为什么<strong class="jp ir"> ping报文很可能较少受到网络分段和策略的影响</strong>。</p><p id="1fde" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">了解这一点后，在我看来，为了在网络中创建连接，当您需要通过分段和网络策略等障碍时，代理使用ICMP隧道连接C&amp;C服务器是一个好主意。</p><p id="e308" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我用python写了一个简单的POC(概念证明)来演示它是如何工作的。</p><blockquote class="lu lv lw"><p id="2d1a" class="jn jo lx jp b jq jr js jt ju jv jw jx ly jz ka kb lz kd ke kf ma kh ki kj kk ij bi translated"><em class="iq">注意:</em></p><p id="a74d" class="jn jo lx jp b jq jr js jt ju jv jw jx ly jz ka kb lz kd ke kf ma kh ki kj kk ij bi translated"><em class="iq">–此POC要求您安装</em><a class="ae kz" href="https://scapy.net/download/" rel="noopener ugc nofollow" target="_blank"><em class="iq">Scapy</em></a><em class="iq">(无论如何，这是一个了解</em>  <em class="iq">的伟大工具)</em></p><p id="150f" class="jn jo lx jp b jq jr js jt ju jv jw jx ly jz ka kb lz kd ke kf ma kh ki kj kk ij bi translated"><em class="iq">–本概念验证不涉及碎片处理。例如，如果来自代理的回答大于允许的有效载荷数据大小，则会出现碎片。</em></p></blockquote><p id="784e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此POC将涉及一台C&amp;C服务器和一个代理。其中C2服务器将通过ICMP隧道发送代理命令，代理也将通过ICMP隧道返回结果。</p><h1 id="2155" class="mb mc iq bd md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my bi translated">C2.py</h1><figure class="lb lc ld le gt lf"><div class="bz fp l di"><div class="mz na l"/></div></figure><h1 id="1a3a" class="mb mc iq bd md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my bi translated">Agent.py</h1><figure class="lb lc ld le gt lf"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="fea0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用它会看起来像这样——</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/11004e2f8dd6f9eea4cafe2fc74273d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1300/format:webp/1*sBukRk2VLDmXKY5pGhxsWQ.png"/></div></figure><p id="193d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用Wireshark查看到底发生了什么总是一个好主意</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi li"><img src="../Images/3d2cc47c4c182b10ace2ca062a71b10a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wyUjrKZkWxM99xjwx2V2dw.png"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">C2残疾人司令部</figcaption></figure><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi li"><img src="../Images/5c0f79d3b3149dafcd5ae60b7ba0f064.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YJMFLIW-_PigphvVpuwmAQ.png"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">代理— pwd结果</figcaption></figure><p id="15bf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如您所见，有两条ICMP消息，一条是命令，一条是结果。</p><h1 id="ac6c" class="mb mc iq bd md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my bi translated">D.辩护观点</h1><p id="b59c" class="pw-post-body-paragraph jn jo iq jp b jq nc js jt ju nd jw jx jy ne ka kb kc nf ke kf kg ng ki kj kk ij bi translated">重要的是从防御的角度来看，并思考我们在构建这种工具时应该考虑什么。</p><p id="4c9a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最重要的是要记住，网络安全工具并不以防火墙白名单政策开始和结束。今天的大多数防御工具将包括某种异常检测功能。</p><p id="6fa8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先描述相关主题的常见行为，这是一个绘制出一些有趣异常的好方法。</p><p id="c1d3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">谈到常规网络中的ping报文，我们可以假设以下特征</p><ol class=""><li id="dfcc" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated">大多数ping消息将以默认方式发送——一次4个ping。</li><li id="0da3" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated">ping消息来自类型8(回应ping请求), ping应答来自类型0(回应Ping回复)</li><li id="407c" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated">每个ping数据包都会发送一些字段(使用Windows 8.1)–</li></ol><ul class=""><li id="e9be" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk lt kr ks kt bi translated"><em class="lx"> id </em> = 0x0001</li><li id="12e5" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk lt kr ks kt bi translated">重放的<em class="lx">序列</em>将等于请求的<em class="lx">序列</em></li><li id="df80" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk lt kr ks kt bi translated"><em class="lx">有效载荷数据</em>将保持其默认大小(32字节)和内容——“abcdefghijklmnopqrstuvwabcdefghi”</li></ul><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi nh"><img src="../Images/b9c3121f5b07970ba865f033c00860c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dXu-hBtB1dnIQrZlUSCDTg.png"/></div></div></figure><p id="91b0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">了解以上所有内容后，您必须考虑-</p><ol class=""><li id="e68d" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated">构建C&amp;C和代理时，要确保每1分钟一批中的ping消息不超过4条(例如)。如果您需要传输的数据需要15条ping消息，则需要3分钟才能通过。这可能会很慢，但如果有人或有东西正在观察这种异常现象，这将是值得的。</li><li id="1be6" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated"><strong class="jp ir">确保</strong> <strong class="jp ir"> ping请求和回复逻辑正确</strong>。例如，如果您发送的每条ping消息都是0类型的，那么在没有ping请求的情况下看到大量ping回复就很奇怪了。</li><li id="6762" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated">尽量和你周围的环境相似。做你的研究。当然，您可以保持这些字段的可配置性，并随时进行更改。</li><li id="7a55" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated">请注意，<strong class="jp ir">有效载荷数据大小</strong>将影响第一部分(每个数据大小的ping消息数量)，并且<strong class="jp ir">是一个元数据信息</strong>。</li><li id="a227" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated"><strong class="jp ir">有效载荷数据内容</strong> —我们来谈谈DPI……</li></ol><p id="3756" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> DPI —深度数据包检测</strong></p><p id="1326" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">传统数据包检测读取数据包的元数据(主要是报头)，<strong class="jp ir">深度数据包检测实时读取正在通过的数据包的内容</strong>。基本上，它会查看有效载荷，并尝试了解它看起来是否正确。</p><p id="60ca" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我们的例子中，使用协议异常功能的DPI工具可以通过查看有效负载来发现ICMP隧道，并发现它与它应该的不同。</p><p id="2a72" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这种情况下，它不会帮助我们改变所有其他参数。</p><p id="080d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">那么——我们为什么还要为ICMP隧道费心呢？</p><p id="1f90" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因为–</p><ol class=""><li id="9945" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated">DPI不是一个微不足道的功能，您可能会遇到许多没有此功能的网络。</li><li id="c097" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated">大多数DPI工具依赖于签名数据库，如果没有与ICMP消息相关的签名，它将无法检测ICMP隧道。</li><li id="9c90" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated">即使数据库中有相关的签名，操作员也应首先将其配置为活动模式。</li></ol><ul class=""><li id="e858" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk lt kr ks kt bi translated">为什么他没有激活它？</li><li id="eb99" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk lt kr ks kt bi translated">每个签名检查都占用处理资源(主要是CPU和时间)，因此<strong class="jp ir">可能会降低网络速度</strong>。</li><li id="321f" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk lt kr ks kt bi translated">网络检查可以包括具有不同有效载荷大小的不同类型的ping消息(例如<strong class="jp ir">ping-l 1234 8.8.8.8</strong>，将发送包含大小为1234[字节]的有效载荷数据的ping消息，以解决涉及MTU功能的问题。<strong class="jp ir">激活这种签名会引起很多假阳性警报，从而惹恼监测小组，降低签名的可靠性。</strong></li></ul><h1 id="98eb" class="mb mc iq bd md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my bi translated">总和+= 1337</h1><p id="8040" class="pw-post-body-paragraph jn jo iq jp b jq nc js jt ju nd jw jx jy ne ka kb kc nf ke kf kg ng ki kj kk ij bi translated">ICMP隧道是一种“在雷达下”进行通信的优秀工具。虽然有时它会不太有效，但取决于网络上现有的防御措施，很多时候您会发现这是一种克服某些限制的简单而方便的方法。</p><p id="1ce0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最重要的是，这是一个值得了解的概念。如果你掌握了诀窍，你可以根据需要开发许多不同的解决方案，例如——DNS隧道、SSH隧道等等…</p></div></div>    
</body>
</html>