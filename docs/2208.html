<html>
<head>
<title>A Lab for Practicing Azure Service Principal Abuse</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">练习Azure服务主体滥用的实验室</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/a-lab-for-practicing-azure-service-principal-abuse-bd000e6c48eb?source=collection_archive---------3-----------------------#2022-07-22">https://infosecwriteups.com/a-lab-for-practicing-azure-service-principal-abuse-bd000e6c48eb?source=collection_archive---------3-----------------------#2022-07-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/5b0f595e09fe9d7897a55e57c256b16b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6hg53aYjUdXJ57JmCD95Kw.png"/></div></div></figure></div><div class="ab cl jy jz hu ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="ij ik il im in"><h2 id="5bea" class="kf kg iq bd kh ki kj dn kk kl km dp kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">介绍</h2><p id="bc71" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll ko lm ln lo ks lp lq lr kw ls lt lu lv ij bi translated"><a class="ae lw" href="https://www.purplecloud.network" rel="noopener ugc nofollow" target="_blank"> PurpleCloud </a>是一个开源的Azure Cyber Range，可以用来快速建立一个充满Azure资源的Azure AD安全实验室。这些资源提供了一种快速、安全的方法来测试、评估和理解服务主体滥用攻击原语。像这样运行:</p><p id="3fd4" class="pw-post-body-paragraph lb lc iq ld b le lx lg lh li ly lk ll ko lz ln lo ks ma lq lr kw mb lt lu lv ij bi translated"><code class="fe mc md me mf b">$ python3 azure_ad.py -c 25 --upn &lt;domain&gt; --apps 7 -aa -ga -pra</code></p><p id="fb21" class="pw-post-body-paragraph lb lc iq ld b le lx lg lh li ly lk ll ko lz ln lo ks ma lq lr kw mb lt lu lv ij bi translated">上面的这个命令生成了您需要构建、管理和销毁范围的所有声明性terraform文件。</p><h2 id="89e1" class="kf kg iq bd kh ki kj dn kk kl km dp kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">创建的资源</h2><p id="9249" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll ko lm ln lo ks lp lq lr kw ls lt lu lv ij bi translated">PurpleCloud是一个terraform代码生成器。它创建HCL格式的terraform文件，为各种用例快速创建模拟实验室。你可以在这里查看所有的新发电机<a class="ae lw" href="https://www.purplecloud.network/overview/" rel="noopener ugc nofollow" target="_blank">。上面这个是Azure广告安全模拟。以上示例中创建的资源:</a></p><ul class=""><li id="3ca2" class="mg mh iq ld b le lx li ly ko mi ks mj kw mk lv ml mm mn mo bi translated">25个Azure AD用户使用随机生成的密码</li><li id="a576" class="mg mh iq ld b le mp li mq ko mr ks ms kw mt lv ml mm mn mo bi translated">7款Azure广告应用</li><li id="dddd" class="mg mh iq ld b le mp li mq ko mr ks ms kw mt lv ml mm mn mo bi translated">1个应用程序管理员角色随机分配给25个用户中的一个</li><li id="5e52" class="mg mh iq ld b le mp li mq ko mr ks ms kw mt lv ml mm mn mo bi translated">随机分配给7个应用程序之一的全局管理员角色</li><li id="e6e8" class="mg mh iq ld b le mp li mq ko mr ks ms kw mt lv ml mm mn mo bi translated">一个特权角色管理员(PRA)角色被随机分配给7个应用程序中的一个</li></ul><h2 id="d2de" class="kf kg iq bd kh ki kj dn kk kl km dp kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">攻击概述和前期工作</h2><p id="6a97" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll ko lm ln lo ks lp lq lr kw ls lt lu lv ij bi translated">Andy Robbins [1]和Dirk-jan Mollema [2]在过去已经记录了这种权限提升攻击场景设置的服务主体滥用攻击原语。阅读他们的两个博客以了解详情。攻击原语允许应用程序管理员将任何用户的权限或角色提升为全局管理员。它是这样工作的:</p><ul class=""><li id="0ce2" class="mg mh iq ld b le lx li ly ko mi ks mj kw mk lv ml mm mn mo bi translated">租户中存在分配给应用程序管理员的AAD用户</li><li id="99cf" class="mg mh iq ld b le mp li mq ko mr ks ms kw mt lv ml mm mn mo bi translated">应用程序管理员拥有强大的权限，可以完全管理应用程序注册。他们可以给应用程序添加新的秘密。</li><li id="09f9" class="mg mh iq ld b le mp li mq ko mr ks ms kw mt lv ml mm mn mo bi translated">租户中存在分配了特权角色管理员(PRA)角色的应用程序。PRA角色允许添加任何特权角色分配，包括向全局管理员添加角色。</li><li id="3fa0" class="mg mh iq ld b le mp li mq ko mr ks ms kw mt lv ml mm mn mo bi translated">应用程序管理员向PRA应用程序添加一个秘密，允许他们使用PRA的服务主体登录Azure。</li><li id="cddc" class="mg mh iq ld b le mp li mq ko mr ks ms kw mt lv ml mm mn mo bi translated">普通用户可以在生成应用程序密码后作为服务主体登录。</li><li id="aee3" class="mg mh iq ld b le mp li mq ko mr ks ms kw mt lv ml mm mn mo bi translated">作为PRA服务主体登录后，应用程序管理员将任何Azure AD用户(包括他们自己的用户名)提升为全局管理员。</li></ul><p id="a6b2" class="pw-post-body-paragraph lb lc iq ld b le lx lg lh li ly lk ll ko lz ln lo ks ma lq lr kw mb lt lu lv ij bi translated">这里的重要想法和总结是，您不能使用位于<a class="ae lw" href="https://portal.azure.com" rel="noopener ugc nofollow" target="_blank">https://portal.azure.com</a>的前端门户为相同的用户重置密码。但是通过后端，使用服务原则，这是一种有效的技术。</p><h2 id="40b3" class="kf kg iq bd kh ki kj dn kk kl km dp kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">攻击脚本</h2><p id="6a2f" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll ko lm ln lo ks lp lq lr kw ls lt lu lv ij bi translated">PurpleCloud包括两个攻击脚本，可以自动执行这种权限提升场景。第一个脚本执行侦察。第二个脚本利用设置，将任何Azure AD用户提升为全局管理员。这两个脚本可以在<a class="ae lw" href="https://github.com/iknowjason/PurpleCloud/tree/master/attack_scripts" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><h2 id="07b7" class="kf kg iq bd kh ki kj dn kk kl km dp kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">演示视频</h2><figure class="mu mv mw mx gt jr"><div class="bz fp l di"><div class="my mz l"/></div></figure><h2 id="dd3f" class="kf kg iq bd kh ki kj dn kk kl km dp kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">参考</h2><p id="dab9" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll ko lm ln lo ks lp lq lr kw ls lt lu lv ij bi translated">[1]安迪·罗宾斯，SpectreOps:</p><div class="na nb gp gr nc nd"><a href="https://posts.specterops.io/azure-privilege-escalation-via-service-principal-abuse-210ae2be2a5" rel="noopener  ugc nofollow" target="_blank"><div class="ne ab fo"><div class="nf ab ng cl cj nh"><h2 class="bd ir gy z fp ni fr fs nj fu fw ip bi translated">通过服务主体滥用进行Azure权限提升</h2><div class="nk l"><h3 class="bd b gy z fp ni fr fs nj fu fw dk translated">介绍和前期工作</h3></div><div class="nl l"><p class="bd b dl z fp ni fr fs nj fu fw dk translated">post . specter ops . io</p></div></div><div class="nm l"><div class="nn l no np nq nm nr jw nd"/></div></div></a></div><p id="670b" class="pw-post-body-paragraph lb lc iq ld b le lx lg lh li ly lk ll ko lz ln lo ks ma lq lr kw mb lt lu lv ij bi translated">[2]德克-扬·莫莱马</p><p id="0511" class="pw-post-body-paragraph lb lc iq ld b le lx lg lh li ly lk ll ko lz ln lo ks ma lq lr kw mb lt lu lv ij bi translated"><a class="ae lw" href="https://dirkjanm.io/azure-ad-privilege-escalation-application-admin/" rel="noopener ugc nofollow" target="_blank">https://dirkjanm . io/azure-ad-privilege-escalation-application-admin/</a></p></div><div class="ab cl jy jz hu ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="ij ik il im in"><p id="dd65" class="pw-post-body-paragraph lb lc iq ld b le lx lg lh li ly lk ll ko lz ln lo ks ma lq lr kw mb lt lu lv ij bi translated"><em class="ns">来自Infosec的报道:Infosec上每天都有很多事情发生，很难跟上。加入我们的每周简讯，以5篇文章、4个线程、3个视频、2个Github Repos和工具以及1个工作提醒的形式免费获取所有最新的Infosec趋势！</em><a class="ae lw" href="https://weekly.infosecwriteups.com/" rel="noopener ugc nofollow" target="_blank"><em class="ns">https://weekly.infosecwriteups.com/</em></a></p></div></div>    
</body>
</html>