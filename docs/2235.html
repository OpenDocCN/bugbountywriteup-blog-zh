<html>
<head>
<title>Attacktive Directory</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">攻击目录</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/attacktive-directory-d1ab5fef716a?source=collection_archive---------0-----------------------#2022-08-03">https://infosecwriteups.com/attacktive-directory-d1ab5fef716a?source=collection_archive---------0-----------------------#2022-08-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="25fb" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">来自尝试黑我的活动目录房间</h2></div><p id="12a2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">简介:</strong></p><p id="a625" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这个房间旨在让您对什么是活动目录环境有一点了解。以及如何在域环境中枚举、利用和提升您的权限。</p><p id="97ee" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">什么是活动目录？</strong></p><p id="54a4" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">活动目录(AD)是一个数据库和一组服务，将用户与他们完成工作所需的网络资源联系起来。</p><p id="164e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">数据库(或目录)包含关于您的环境的关键信息，包括有哪些用户和计算机，以及允许谁做什么。例如，数据库可能会列出100个用户帐户，包括每个人的职位、电话号码和密码等详细信息。它还会记录他们的权限。</p><p id="da10" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">枚举:</strong></p><p id="33bf" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们从枚举开始。Nmap可以在这方面帮助我们。你可以使用任何你喜欢的端口扫描器，例如:Rustscan，Masscan也可以。</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="9bd1" class="lk ll iq lg b gy lm ln l lo lp">NMAP</span><span id="4444" class="lk ll iq lg b gy lq ln l lo lp"># Nmap 7.92 scan initiated Mon Aug  1 09:40:35 2022 as: nmap -sC -sV -p- --min-rate 1500 -oN nmap.out 10.10.210.216<br/>Nmap scan report for 10.10.210.216<br/>Host is up (0.18s latency).<br/>Not shown: 65508 closed tcp ports (reset)<br/>PORT      STATE SERVICE       VERSION<br/><strong class="lg ir">53/tcp    open  domain        Simple DNS Plus</strong><br/><strong class="lg ir">80/tcp    open  http          Microsoft IIS httpd 10.0<br/>|_http-server-header: Microsoft-IIS/10.0<br/>|_http-title: IIS Windows Server<br/>| http-methods: <br/>|_  Potentially risky methods: TRACE</strong><br/><strong class="lg ir">88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2022-08-01 13:41:39Z)</strong><br/><strong class="lg ir">135/tcp   open  msrpc         Microsoft Windows RPC</strong><br/><strong class="lg ir">139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn<br/>389/tcp   open ldap          Microsoft Windows Active Directory LDAP (Domain: spookysec.local0., Site: Default-First-Site-Name)</strong><br/><strong class="lg ir">445/tcp   open  microsoft-ds?<br/>464/tcp   open  kpasswd5?<br/>593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0<br/>636/tcp   open  tcpwrapped<br/>3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: spookysec.local0., Site: Default-First-Site-Name)<br/>3269/tcp  open  tcpwrapped</strong><br/><strong class="lg ir">3389/tcp  open  ms-wbt-server Microsoft Terminal Services<br/>| rdp-ntlm-info: <br/>|   Target_Name: THM-AD<br/>|   NetBIOS_Domain_Name: THM-AD<br/>|   NetBIOS_Computer_Name: ATTACKTIVEDIREC<br/>|   DNS_Domain_Name: spookysec.local<br/>|   DNS_Computer_Name: AttacktiveDirectory.spookysec.local<br/>|   Product_Version: 10.0.17763<br/>|_  System_Time: 2022-08-01T13:42:43+00:00<br/>|_ssl-date: 2022-08-01T13:43:13+00:00; +1s from scanner time.<br/>| ssl-cert: Subject: commonName=AttacktiveDirectory.spookysec.local<br/>| Not valid before: 2022-07-31T13:20:35<br/>|_Not valid after:  2023-01-30T13:20:35</strong><br/><strong class="lg ir">5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)<br/>|_http-server-header: Microsoft-HTTPAPI/2.0<br/>|_http-title: Not Found<br/>9389/tcp  open  mc-nmf        .NET Message Framing<br/>47001/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)<br/>|_http-server-header: Microsoft-HTTPAPI/2.0<br/>|_http-title: Not Found<br/>49664/tcp open  unknown<br/>49665/tcp open  msrpc         Microsoft Windows RPC<br/>49666/tcp open  msrpc         Microsoft Windows RPC<br/>49669/tcp open  unknown<br/>49672/tcp open  msrpc         Microsoft Windows RPC<br/>49675/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0<br/>49676/tcp open  msrpc         Microsoft Windows RPC<br/>49679/tcp open  msrpc         Microsoft Windows RPC<br/>49685/tcp open  msrpc         Microsoft Windows RPC<br/>49696/tcp open  msrpc         Microsoft Windows RPC<br/>49824/tcp open  msrpc         Microsoft Windows RPC</strong><br/>Service Info: Host: ATTACKTIVEDIREC; OS: Windows; CPE: cpe:/o:microsoft:windows</span><span id="06af" class="lk ll iq lg b gy lq ln l lo lp">Host script results:<br/>| smb2-time: <br/>|   date: 2022-08-01T13:42:43<br/>|_  start_date: N/A<br/>| smb2-security-mode: <br/>|   3.1.1: <br/>|_    Message signing enabled and required</span><span id="8465" class="lk ll iq lg b gy lq ln l lo lp">Service detection performed. Please report any incorrect results at <a class="ae lr" href="https://nmap.org/submit/" rel="noopener ugc nofollow" target="_blank">https://nmap.org/submit/</a> .<br/># Nmap done at Mon Aug  1 09:43:18 2022 -- 1 IP address (1 host up) scanned in 163.82 seconds</span></pre><p id="3948" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以得到一些关于目标的信息。</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="6509" class="lk ll iq lg b gy lm ln l lo lp"><strong class="lg ir">|   Target_Name: THM-AD<br/>|   NetBIOS_Domain_Name: THM-AD<br/>|   NetBIOS_Computer_Name: ATTACKTIVEDIREC<br/>|   DNS_Domain_Name: spookysec.local<br/>|   DNS_Computer_Name: AttacktiveDirectory.spookysec.local<br/>|   Product_Version: 10.0.17763</strong></span></pre></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="99e0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> SMB枚举:</strong></p><p id="59a1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们看到SMB处于活动状态，让我们尝试列举它。我们可以使用多种工具来列举SMB</p><blockquote class="lz ma mb"><p id="96ad" class="kf kg mc kh b ki kj jr kk kl km ju kn md kp kq kr me kt ku kv mf kx ky kz la ij bi translated">1: Smbclient</p><p id="3df9" class="kf kg mc kh b ki kj jr kk kl km ju kn md kp kq kr me kt ku kv mf kx ky kz la ij bi translated">2: Smbmap</p><p id="3b5c" class="kf kg mc kh b ki kj jr kk kl km ju kn md kp kq kr me kt ku kv mf kx ky kz la ij bi translated">3: Enum4linux</p></blockquote><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="a5c2" class="lk ll iq lg b gy lm ln l lo lp">=================================( Share Enumeration on 10.10.210.216 )=================================</span><span id="f993" class="lk ll iq lg b gy lq ln l lo lp">do_connect: Connection to 10.10.210.216 failed (Error NT_STATUS_RESOURCE_NAME_NOT_FOUND)</span><span id="69fd" class="lk ll iq lg b gy lq ln l lo lp">Sharename       Type      Comment<br/>        ---------       ----      -------<br/>Reconnecting with SMB1 for workgroup listing.<br/>Unable to connect with SMB1 -- no workgroup available</span><span id="678c" class="lk ll iq lg b gy lq ln l lo lp">[+] Attempting to map shares on 10.10.210.216</span></pre><p id="30f7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我尝试用所有的工具枚举，但没有股票上市。</p><p id="8fcd" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">通过Kerberos枚举用户:</strong></p><p id="76d0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在端口88 Kerberos正在运行，也许我们可以通过Kerberos枚举有效用户。如果您想了解kerberos是什么以及它是如何工作的，您可以观看此视频，它解释了Kerberos如何执行身份验证。</p><figure class="lb lc ld le gt mg"><div class="bz fp l di"><div class="mh mi l"/></div></figure><p id="8fc7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae lr" href="https://github.com/ropnop/kerbrute" rel="noopener ugc nofollow" target="_blank">安装Kerbrute </a>:</p><p id="fdb8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用userenum标志，并尝试使用房间作者提供的用户名列表来枚举用户。</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="ebd5" class="lk ll iq lg b gy lm ln l lo lp">[0/45]<br/>    __             __               __     <br/>   / /_____  _____/ /_  _______  __/ /____ <br/>  / //_/ _ \/ ___/ __ \/ ___/ / / / __/ _ \<br/> / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/<br/>/_/|_|\___/_/  /_.___/_/   \__,_/\__/\___/</span><span id="3423" class="lk ll iq lg b gy lq ln l lo lp">Version: v1.0.3 (9dad6e1) - 08/03/22 - Ronnie Flathers <a class="ae lr" href="http://twitter.com/ropnop" rel="noopener ugc nofollow" target="_blank">@ropnop</a></span><span id="341a" class="lk ll iq lg b gy lq ln l lo lp">2022/08/03 09:20:12 &gt;  Using KDC(s):<br/>2022/08/03 09:20:12 &gt;   spookysec.local:88</span><span id="2e94" class="lk ll iq lg b gy lq ln l lo lp">james@spookysec.local<br/>svc-admin@spookysec.local<br/>James@spookysec.local<br/>robin@spookysec.local<br/>darkstar@spookysec.local<br/>administrator@spookysec.local<br/>backup@spookysec.local<br/>paradox@spookysec.local<br/>JAMES@spookysec.local<br/>Robin@spookysec.local<br/>Administrator@spookysec.local<br/>Darkstar@spookysec.local<br/>Paradox@spookysec.local<br/>DARKSTAR@spookysec.local<br/>ori@spookysec.local<br/>ROBIN@spookysec.local</span></pre><figure class="lb lc ld le gt mg"><div class="bz fp l di"><div class="mj mi l"/></div><figcaption class="mk ml gj gh gi mm mn bd b be z dk translated">有效用户</figcaption></figure><p id="814d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">作为重新发布:</strong></p><p id="41a0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在枚举完用户帐户之后，我们可以尝试滥用Kerberos中的一个特性，使用一种叫做<strong class="kh ir">as repasting的攻击方法。</strong>当用户帐户具有“不需要预认证”权限设置时，会发生重新发布。这意味着帐户<strong class="kh ir">在请求指定用户帐户上的Kerberos票据之前不需要提供有效的身份证明。</strong></p><p id="3583" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">布兰登重新录制了一个很棒的视频。</p><figure class="lb lc ld le gt mg"><div class="bz fp l di"><div class="mh mi l"/></div></figure><p id="3280" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们尝试进行攻击。</p><figure class="lb lc ld le gt mg gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mo"><img src="../Images/0e435282f8dd7e78d6ce186c02656bcf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e_QGlFiFlSoZddKqc0wrIQ.jpeg"/></div></div><figcaption class="mk ml gj gh gi mm mn bd b be z dk translated">GetNPusers.py</figcaption></figure><p id="2017" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在我们得到一个散列后，只需复制这个散列并保存到一个文件中，然后运行hascat来尝试破解这个散列。</p><p id="324a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">语法:</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="76be" class="lk ll iq lg b gy lm ln l lo lp">hashcat -m 18200 hash password.list</span></pre><figure class="lb lc ld le gt mg gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mv"><img src="../Images/527c9c6d9dc35e51d5ccd9288f562972.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wIuoR7WuyF_Y4jajLcxswQ.jpeg"/></div></div><figcaption class="mk ml gj gh gi mm mn bd b be z dk translated">哈希卡特</figcaption></figure><p id="a2a8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">获得有效凭据后，我们可以尝试列出需要身份认证的smb共享。</p><p id="8807" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">中小企业股票:</strong></p><figure class="lb lc ld le gt mg gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mw"><img src="../Images/0098c8efa607488bbbbeae84102046b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5__wjLi4uTVSxnvVrRRf-w.png"/></div></div><figcaption class="mk ml gj gh gi mm mn bd b be z dk translated">分享</figcaption></figure><p id="eac1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们看到了备份共享，它特别有趣，让我们用smbclient连接到它。</p><figure class="lb lc ld le gt mg gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mx"><img src="../Images/5e434e59c2419102b5c252115f80b614.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vlcc2Rgx8xdM95IZZRAwCw.png"/></div></div><figcaption class="mk ml gj gh gi mm mn bd b be z dk translated">服务器信息块</figcaption></figure><p id="a353" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以看到一个backup_credentials.txt让我们得到它。</p><figure class="lb lc ld le gt mg gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mx"><img src="../Images/101938098de65088fd390fbaa2057965.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wmrg1aFnBODCxEH7Vn951Q.png"/></div></div></figure><p id="8528" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">看起来像base64编码让我们解码它</p><figure class="lb lc ld le gt mg gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi my"><img src="../Images/0a73ddb1bb5f123811e5fa94f4473577.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uzWtIPWUlurESBffYKQKXg.png"/></div></div><figcaption class="mk ml gj gh gi mm mn bd b be z dk translated">Creds</figcaption></figure><p id="e5c2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们获得了另一个用户的凭据。</p><p id="255f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">提升域内权限:</strong></p><p id="f5b3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在我们有了新的用户帐户凭据，我们在系统上可能比以前拥有更多的特权。帐户“backup”的用户名引发了我们的思考。这是什么备份帐户？这是域控制器的备份帐户。此帐户具有唯一权限，允许所有Active Directory更改与此用户帐户同步。这包括密码哈希。</p><p id="11ee" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以使用impacket的secretsdump.py来检索所有的散列。</p><figure class="lb lc ld le gt mg gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mz"><img src="../Images/8f1a7cd552f9b5e2b8672e2ee895459f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4R6S_9S7bAGeptqnbvDhHg.png"/></div></div><figcaption class="mk ml gj gh gi mm mn bd b be z dk translated">混杂</figcaption></figure><p id="f074" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">有了用户的散列，我们可以执行一个非常有效的攻击“传递散列”,如果你想了解更多关于传递散列攻击的信息。</p><figure class="lb lc ld le gt mg"><div class="bz fp l di"><div class="mh mi l"/></div></figure><p id="af43" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以用evil-winrm来攻击。</p><figure class="lb lc ld le gt mg gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mz"><img src="../Images/8ec6418ec4d580cbf072db0adef8545f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aZmjp_dMewju60NL2WOq8g.png"/></div></div><figcaption class="mk ml gj gh gi mm mn bd b be z dk translated">Evilwinrm</figcaption></figure><p id="a078" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在只需获取所有标志并提交即可。</p><figure class="lb lc ld le gt mg"><div class="bz fp l di"><div class="na mi l"/></div></figure><p id="b40b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一会儿见。</p><p id="c77c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">黑客快乐！</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h2 id="644f" class="lk ll iq bd nb nc nd dn ne nf ng dp nh ko ni nj nk ks nl nm nn kw no np nq nr bi translated">来自Infosec的报道:Infosec每天都有很多内容，很难跟上。<a class="ae lr" href="https://weekly.infosecwriteups.com/" rel="noopener ugc nofollow" target="_blank">加入我们的每周简讯</a>以5篇文章、4条线索、3个视频、2个GitHub Repos和工具以及1个工作提醒的形式免费获取所有最新的Infosec趋势！</h2></div></div>    
</body>
</html>