<html>
<head>
<title>Subdomain Takeover — New Level</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">子域接管—新级别</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/subdomain-takeover-new-level-43f88b55e0b2?source=collection_archive---------1-----------------------#2018-12-17">https://infosecwriteups.com/subdomain-takeover-new-level-43f88b55e0b2?source=collection_archive---------1-----------------------#2018-12-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/3bbd03b7c267dafd8fe09cbcdda301d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*nhr-6cyBpnaHGVIMyPjctw.gif"/></div></div></figure><p id="86b6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最近，我开始收到让pentest为一些项目工作的请求(又名私人bug bounty)。在这样的项目中，我尽最大努力为客户创造成果，并从过程中获得最大的乐趣。但是最后一个项目的结果却让我震惊。</p><p id="e07b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我被要求为一个主机提供商做一个pentest。</p><p id="7539" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我不会透露那家公司的名字。在我的故事中，我将使用“Hoster”这个名字。与托管服务网页一切都是标准。提供购买VDS，域名，SSL证书。</p><p id="0aca" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，我对用户的个人账户是如何实现的感到惊讶。注册时不需要证明电子邮件地址的所有权。Ie可以用电子邮件地址<a class="ae kw" href="mailto:steve.jobs@apple.com" rel="noopener ugc nofollow" target="_blank">steve.jobs@apple.com</a>注册。或者更好——support@hoster.com<a class="ae kw" href="mailto:support@hoster.com" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="4718" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但幸运的是，类比<a class="ae kw" href="https://medium.com/intigriti/how-i-hacked-hundreds-of-companies-through-their-helpdesk-b7680ddc2d4c" rel="noopener">这样的故事</a>，敏感信息支持服务的泄露并没有发生。</p><p id="6dca" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然而，当我创建一个支持测试请求并立即检查其他支持请求的相邻id的可用性时，它确实发生了。令人惊讶的是，他们是可用的。并且可以观察到谁和什么在那个主人那里注册。以及用户面临什么样的问题。一般来说，这是一个常见的IDOR漏洞，目前没有人对此感到惊讶。已经尽快修好了。</p><p id="b005" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">还有几个地方储存了XSS。还有一个盲人XSS把服务管理员的饼干还给了我。多亏了这个XSS，我才能够找到管理员界面的位置，总体来说，我发现了很多有趣的信息。</p><ul class=""><li id="e2e7" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated">有多少活跃用户。</li><li id="0972" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">控制了多少个域。</li><li id="f0a7" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">部署了多少VDS？</li><li id="360e" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">支付记录。</li></ul><p id="35ba" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">还有一些其他的东西…</p><figure class="lm ln lo lp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ll"><img src="../Images/caaa82b583b3bbd691db5aa62ec9e671.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_G2cVtmKvGmfEQFAn965eA.png"/></div></div></figure><p id="eb3e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">CSRF令牌有各种各样的问题，允许代表用户在我的帐户上做许多危险的事情。如果有实施CSRF代币的地方。没有人计划在后台检查它们。根据我的发现，一些功能被完全禁用了。例如，2FA身份验证由于没有很好地实现而被决定暂时删除。</p><p id="c166" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在我的工作过程中，我不仅关注安全问题，还关注一些功能操作中的实现错误或问题。作为一名质量工程师，我不能错过这个机会。总之，我的问题追踪器达到了22个。我发现了很多问题。</p><p id="5500" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">结果非常令人信服。我已经计划完成这个项目。但出于某种原因，我又想起了注册时没有确认电子邮件地址所有者的问题。在这里，我开始发明一些情况，在这些情况下，这可能会给托管公司及其所有者带来最大的问题。在某些时候，我开始思考这个托管服务的所有者与同一公司的其他项目的联系。几分钟后，我用该公司另一个项目的邮箱地址注册了一个账户(就叫<a class="ae kw" href="mailto:support@example.com" rel="noopener ugc nofollow" target="_blank">support@example.com</a>)。然后我设法将域名example.com链接到我创建的账户suppot@example.com<a class="ae kw" href="mailto:suppot@example.com" rel="noopener ugc nofollow" target="_blank"/>。但是我仍然无法控制链接域的内容。</p><p id="e3b3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是完全可以代表example.com服务发送电子邮件。对网络钓鱼攻击来说是件好事。</p><figure class="lm ln lo lp gt jr gh gi paragraph-image"><div class="gh gi lq"><img src="../Images/ace95aae560e881f2dbecf42e40a9248.png" data-original-src="https://miro.medium.com/v2/resize:fit:966/format:webp/1*Uj--XE6ogOmT_AKvrtsDUA.png"/></div></figure><p id="ea9b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我不知道回信是从哪里来的。因为我给自己回了一封这样的测试信。但是我没有得到答案。很可能它回到了邮箱的真正主人support@example.com<a class="ae kw" href="mailto:support@example.com" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="2e70" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里发生了一些有趣的事情，我决定写这篇文章。</p><p id="e7cd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我设法解决了被遗忘的子域。经典子域接管漏洞。你可以在这里阅读它的详细内容<a class="ae kw" href="https://labs.detectify.com/2014/10/21/hostile-subdomain-takeover-using-herokugithubdesk-more/" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="3d39" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我不知道为什么，但我试图添加一个绑定到一个不存在的域。</p><figure class="lm ln lo lp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lr"><img src="../Images/92054e5f0a534b7c009f03a932f467f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fMzPS-FHEdBWIXMc3_T4mg.png"/></div></div></figure><p id="21ba" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我做到了！！！子域已成功创建/添加，我可以控制这个子域的内容！！！并且显示了内容！</p><figure class="lm ln lo lp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ls"><img src="../Images/467aa59d985036e40b2552aa56b216d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Piq7OtFY567JvBMI8xdn7w.png"/></div></div></figure><p id="c13c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">等一下。为什么毕竟，经典的子域接管漏洞只对已经存在的子域起作用。我们不允许制造新的…</p><p id="afea" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这种情况还不清楚。也就是说，好吧，我能够绕过对我和example.com关系的验证，这从来就不是我的(可能要感谢我的账户名中的example.com)。但是，在DNS A、TXT、CNAME记录中没有任何检查组件的情况下，怎么可能添加子域并控制它们呢？</p><p id="83ae" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">通常是这样的——我们会给你加一个子域，只有你证明你能做到。转到DNS，将散列omnomnomtom0110添加到TXT。</p><p id="c8f5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是没有这回事。你想要admin.example.com子域吗？没问题！</p><figure class="lm ln lo lp gt jr gh gi paragraph-image"><div class="gh gi lt"><img src="../Images/fb3a0a09bbc25f49fe27b1cb01107b08.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KULJzob8tvUeu6Es8cu3CQ.jpeg"/></div></figure><p id="8f73" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">好像这个漏洞——子域接管V2。</p><p id="9ae8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我能够与正在测试的托管服务的所有者交流，他们打开了一点潘多拉的盒子。</p><p id="9904" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">结果是这样的。通过CloudFlare进行托管。他以一种非常巧妙的方式工作。我会试着用简单的语言给你解释。</p><p id="4bd6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">大致说来，我是告诉你，去找我，我会招待你的。把你的域名委托给我。<br/>然后我将所有来电发送到CloudFlare，认为它们是正确的。<br/>如果我受托管理president.com的<strong class="ka ir">域名，而一个邻居过来与notour.president.com<strong class="ka ir">一起做了一个网站</strong>并交给我托管，那么我的服务器，可以访问CloudFlare并已经拥有president.com<strong class="ka ir">的所有权限</strong>，将会毫无疑问地快速为一个邻居添加三级域名。来自CloudFlare的所有DNS信息都是正确的。CloudFlare信任我作为托管人。</strong></p><p id="eb70" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当然，大多数主机提供商配置自己的DNS服务。但该公司只是将所有内容从一个已配置的用户转移到了CloudFlare。</p><p id="b735" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所以我们有一个子域接管V2。当然，这只适用于那些已经被托管服务控制的地址。但是结合之前发现的管理服务——这可能会与托管者和托管服务客户端开一个昂贵的玩笑。</p><p id="3cd8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">目前，几乎所有的关键漏洞和错误都已修复。我希望没有其他人在读完这个故事后会决定做出这样的建筑作品。</p></div></div>    
</body>
</html>