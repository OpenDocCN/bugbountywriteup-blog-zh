<html>
<head>
<title>Kubernetes Security Policy Enforcement Using OPA</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用OPA执行Kubernetes安全策略</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/kubernetes-security-policy-enforcement-opa-70975ec51272?source=collection_archive---------1-----------------------#2022-06-20">https://infosecwriteups.com/kubernetes-security-policy-enforcement-opa-70975ec51272?source=collection_archive---------1-----------------------#2022-06-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/43dabdb2a9c09ab2ae28757237ce5fe0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1202/format:webp/1*bg99K_1QZxejvfesR1MGow.png"/></div></figure><h1 id="71ae" class="ju jv iq bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">1.通过OPA将策略作为代码</h1><p id="3f11" class="pw-post-body-paragraph ks kt iq ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">Kubernetes是一个著名的编排引擎，可以自动部署、管理和扩展容器化的工作负载。云原生容器正在被大规模使用，这使得保护Kubernetes环境变得势在必行。</p><p id="e85a" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">随着技术和安全形势的不断变化，各种机构提供了标准化的框架和指南来帮助管理动态的Kubernetes生态系统安全。</p><p id="9501" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">有各种各样的安全框架可供Kubernetes使用，如CIS、NIST和米特ATT&amp;CK。但是，如何使Kubernetes生态系统遵守基于手册的安全指南和法规对Kubernetes专业人员来说可能是一个挑战。并不是每个人都有足够的资源来研究这些安全指南的细节，并确定在有限的资源下哪些是最重要的。警察作为代码发挥作用，以帮助执行合规标准。这种方法背后的理由是以编程语言(如Yaml或减压阀)的形式表示策略，并利用策略即代码执行引擎来确保策略在整个环境中得到满足。</p><p id="cef4" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">在Kubernetes系统中，当通过发送请求与API服务器交互时，在API请求访问系统之前有三个步骤:认证、授权和准入控制。</p><p id="c3f5" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">第三步中的准入控制器是Kubernetes编排系统的插件，用于管理和实施集群的使用方式。它充当看门人的角色，在API请求通过身份验证和授权后对其进行解释，根据预定义的策略对其进行修改或检查，以在它进入集群之前拒绝或允许它。</p><p id="f4ef" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">开放策略代理(OPA)是准入控制器插件之一。在它的帮助下，减压阀语言可以用来实现政策作为代码。它管理跨不同系统的策略实施，预先检查请求是否违反策略或限制。正如其他准入控制器插件一样，OPA确保在创建、更新和删除工作负载时符合策略。</p><p id="779f" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">本文介绍了OPA和一些简单的用例，以及如何将OPA作为准入控制器集成到Kubernetes系统中。</p><h1 id="38e3" class="ju jv iq bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">2.OPA是如何工作的</h1><p id="aba6" class="pw-post-body-paragraph ks kt iq ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">OPA是一个策略引擎，它允许用户或其他系统查询策略，以便对作为输入的数据做出决策。用户使用减压阀定义策略，通过这些策略，减压阀检查数据输入并将其转换为结构化文档，评估它是否符合或违反自定义策略。</p><p id="d32f" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">策略可以被认为是一组规则。由于OPA，策略可以在不同的应用程序之间共享，从一个中心位置分发，与应用程序业务逻辑隔离。</p><p id="d87f" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">OPA可以作为一个库嵌入，作为一个守护进程部署，或者简单地在命令行上运行，理解OPA最简单的方法是使用<a class="ae lv" href="https://play.openpolicyagent.org/" rel="noopener ugc nofollow" target="_blank">减压阀游乐场</a>试验不同的策略创建。</p><p id="a3ed" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">在深入简单的OPA用例之前，介绍一些OPA的核心概念是有帮助的。</p><h1 id="4eb0" class="ju jv iq bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">2.1政策</h1><p id="648f" class="pw-post-body-paragraph ks kt iq ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">策略是用减压阀编写的，每个减压阀文件使用一组规则定义一个策略模块，这些规则可用于评估某个状态或输入。</p><p id="ccd4" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">一个简单的策略文件示例:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="5a1e" class="mf jv iq mb b gy mg mh l mi mj">package example<br/>​<br/>allow[result] = true {<br/>    input.user.role == "HR"<br/>    result = "allow HR"<br/>}</span></pre><p id="64fe" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">如果你不理解这里的语法，不要担心，稍后会有更多的介绍。</p><h1 id="f6e3" class="ju jv iq bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">2.2规则</h1><p id="5d2f" class="pw-post-body-paragraph ks kt iq ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">规则是if=then逻辑语句。规则期望它们的输入来自于<code class="fe mk ml mm mb b">input</code>对象。用户可以使用一个标识符查询OPA中加载的任何规则的值或决策，该标识符是从根数据节点<code class="fe mk ml mm mb b">data.&lt;package-path&gt;.&lt;rule-name&gt;</code>开始的绝对分层路径。请注意根数据节点，它是OPA中的重要组件。</p><p id="0714" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">规则有头有体。</p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mo mp di mq bf mr"><div class="gh gi mn"><img src="../Images/7d4035429612f834140d2bb6575dbc05.png" data-original-src="https://miro.medium.com/v2/resize:fit:626/format:webp/1*_zJuC1e9c3-oC0Mm-U6I1w.png"/></div></div></figure><p id="2157" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">“结果”是规则的名称，头中的“动作”和“用户名”将对象结构定义为规则的值，格式为{" <value of="" action=""> ":" <value of="" username=""> "}，规则查询响应的一部分如下:</value></value></p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="ce4b" class="mf jv iq mb b gy mg mh l mi mj">{<br/>    "result": <br/>    {<br/>         "&lt;value of action&gt;":"&lt;value of username&gt;"<br/>    }<br/>}</span></pre><p id="cd7b" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated"><a class="ae lv" href="https://www.openpolicyagent.org/docs/latest/#rules" rel="noopener ugc nofollow" target="_blank">规则可以是“完整的”也可以是“部分的”</a>。对于部分规则，有集合生成规则，它在查询响应中返回一个集合作为规则的值，还有对象生成规则，就像上面的例子一样。</p><p id="5474" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated"><strong class="ku ir">注意</strong>:规则是函数的超集，不要把<a class="ae lv" href="https://www.openpolicyagent.org/docs/latest/faq/#functions-versus-rules" rel="noopener ugc nofollow" target="_blank">和</a>混淆，后者是一个带参数的规则。一个函数示例:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="3e77" class="mf jv iq mb b gy mg mh l mi mj">result(str) = true {<br/>    str == "GET"<br/>}</span></pre><h1 id="3f4a" class="ju jv iq bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">2.3文件</h1><p id="1f9c" class="pw-post-body-paragraph ks kt iq ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">文档是OPA中的基本数据单位。OPA围绕JSON等结构化文档中表示的信息进行推理。OPA中有两种类型的文档:基础文档和虚拟文档。</p><h2 id="8a22" class="mf jv iq bd jw ms mt dn ka mu mv dp ke ld mw mx ki lh my mz km ll na nb kq nc bi translated">基础文档</h2><p id="db87" class="pw-post-body-paragraph ks kt iq ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">基本文档包含存储在内存中的静态结构化数据。基础文档可用于描述当前状态。</p><h2 id="53b3" class="mf jv iq bd jw ms mt dn ka mu mv dp ke ld mw mx ki lh my mz km ll na nb kq nc bi translated">虚拟文档</h2><p id="8a7f" class="pw-post-body-paragraph ks kt iq ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">虚拟文档是通过评估策略模块中包含的规则来计算的。规则可以生成结构化数据，通常基于被查询规则可用的其他规则、数据或内置函数。</p><h2 id="bd15" class="mf jv iq bd jw ms mt dn ka mu mv dp ke ld mw mx ki lh my mz km ll na nb kq nc bi translated">数据文档</h2><p id="13b4" class="pw-post-body-paragraph ks kt iq ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">数据是一个全局变量，数据文档像树一样分支在不同的层中，基础文档和虚拟文档都可以使用数据作为分层结构中的根来访问，您可以通过<code class="fe mk ml mm mb b">/v1/data</code> HTTP API(如/v1/data/foo)或标识符(如<code class="fe mk ml mm mb b">data.foo</code>)来查询它们。</p><h2 id="a957" class="mf jv iq bd jw ms mt dn ka mu mv dp ke ld mw mx ki lh my mz km ll na nb kq nc bi translated">输入文档</h2><p id="4b23" class="pw-post-body-paragraph ks kt iq ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">在某些情况下，当用户查询规则决策时，策略需要来自输入文档的输入值。要提供输入值，请在请求体中使用POST HTTP request for OPA query和input。</p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/60cb9e0f5396a6eb601d95c3ea74f0c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:722/format:webp/1*VxuGfAHQ-R-0NNttQXwEGQ.png"/></div></figure><h2 id="97e7" class="mf jv iq bd jw ms mt dn ka mu mv dp ke ld mw mx ki lh my mz km ll na nb kq nc bi translated">文档API</h2><p id="338f" class="pw-post-body-paragraph ks kt iq ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated"><a class="ae lv" href="https://www.openpolicyagent.org/docs/v0.13.5/rest-api/#data-api" rel="noopener ugc nofollow" target="_blank">数据API </a>公开了在OPA中读写基本和虚拟文档的端点。</p><p id="2a43" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">一个常见的用例是通过数据API查询规则，您可以使用<code class="fe mk ml mm mb b">/v1/data/&lt;package-path&gt;/&lt;rule-name&gt;</code>，如果规则需要输入对象，那么创建一个POST请求，将输入作为请求体，将返回一个计算的虚拟文档。</p><p id="9e37" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">下面的图表解释了如何使用数据API调用规则。</p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mo mp di mq bf mr"><div class="gh gi ne"><img src="../Images/36940680563d904e4543151694ac1446.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*avqZDKMJsQkOVmH69eHIUQ.png"/></div></div></figure><h1 id="f501" class="ju jv iq bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">3.OPA使用案例</h1><p id="2505" class="pw-post-body-paragraph ks kt iq ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">OPA可以在不同的部署环境中运行。您可以在自己的机器上使用命令行直接与OPA交互，或者将它作为服务器运行，使用HTTP请求与它交互。</p><h1 id="0547" class="ju jv iq bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">3.1使用命令行与OPA交互</h1><p id="8e1d" class="pw-post-body-paragraph ks kt iq ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">从<a class="ae lv" href="https://github.com/open-policy-agent/opa/releases" rel="noopener ugc nofollow" target="_blank"> Github releases </a>下载一个OPA二进制，并通过命令行与之交互，非常方便。在某些情况下，如果下载的OPA不能在您的本地机器上正常工作，使用docker容器在内部运行OPA可能是一个更简单的选择。</p><p id="6490" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">在主机上的当前目录下准备一个OPA目录，进入该目录并下载一个OPA二进制文件，然后更改该二进制文件的模式。</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="18a1" class="mf jv iq mb b gy mg mh l mi mj">&gt; cd OPA<br/>​<br/># choose v0.37.2 in order to run it inside ubuntu:18.04 container<br/>&gt; curl -L -o opa <a class="ae lv" href="https://github.com/open-policy-agent/opa/releases/download/v0.37.2/opa_linux_amd64" rel="noopener ugc nofollow" target="_blank">https://github.com/open-policy-agent/opa/releases/download/v0.37.2/opa_linux_amd64</a><br/>​<br/>&gt; chmod 755 ./opa</span></pre><p id="6cbd" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">此处选择了unbuntu 18.04容器，运行映像并从主机将＄PWD/opadir挂载为容器内的/opadir:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="bad0" class="mf jv iq mb b gy mg mh l mi mj">&gt; docker run -it -v $PWD/opadir:/opadir -p 8181:8181 ubuntu:18.04<br/>​<br/>&gt; cd /opadir</span></pre><p id="0a19" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">导航到容器中的/opadir目录后，可以看到OPA二进制文件驻留在当前目录中。</p><p id="909d" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">完整的OPA CLI列表可在<a class="ae lv" href="https://www.openpolicyagent.org/docs/latest/cli/#opa-eval" rel="noopener ugc nofollow" target="_blank">这里</a>找到。我们仅使用<code class="fe mk ml mm mb b">opa eval</code>来演示如何基于上述核心概念使用opa CLI。</p><p id="070a" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">可以用<code class="fe mk ml mm mb b">opa eval</code>子命令评估减压阀查询，可以使用- data标志设置策略或数据文件，递归加载所有*。rego，*。json或*。yaml文件，或者分别加载它们。</p><p id="86fa" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">例如:</p><p id="c350" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">政策1.rego</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="649f" class="mf jv iq mb b gy mg mh l mi mj">package opa.examples<br/>​<br/>import input.example.flag<br/>​<br/>allow_request { flag == true }</span></pre><p id="2119" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">输入1.json</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="57e7" class="mf jv iq mb b gy mg mh l mi mj">{<br/>    "example": {<br/>      "flag": true<br/>    }<br/>  }</span></pre><p id="c37c" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">按如下方式运行OPA:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="73c6" class="mf jv iq mb b gy mg mh l mi mj">&gt; ./opa eval -i input1.json -d policy1.rego 'data.opa.examples.allow_request'<br/>{<br/>  "result": [<br/>    {<br/>      "expressions": [<br/>        {<br/>          "value": true,<br/>          "text": "data.opa.examples.allow_request",<br/>          "location": {<br/>            "row": 1,<br/>            "col": 1<br/>          }<br/>        }<br/>      ]<br/>    }<br/>  ]<br/>}</span></pre><p id="a827" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">响应中表达式块中的<code class="fe mk ml mm mb b">"value": true</code>是指data . OPA . examples . allow _ request规则的OPA查询值。</p><h1 id="cffa" class="ju jv iq bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">3.2作为服务器与OPA交互</h1><p id="fd8d" class="pw-post-body-paragraph ks kt iq ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated"><code class="fe mk ml mm mb b">opa run</code>命令启动OPA运行时的一个实例，它可以是交互式shell或服务器。</p><p id="d0ba" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">要运行服务器，在本地或docker容器中使用<code class="fe mk ml mm mb b">opa run --server</code>子命令行。</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="d4e2" class="mf jv iq mb b gy mg mh l mi mj">docker run -it -v $PWD/opadir:/opadir  -p 8181:8181 openpolicyagent/opa  run --server --log-level debug</span></pre><p id="9fe1" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">默认情况下，OPA服务器侦听0.0.0.0:8181上的HTTP连接。浏览<a class="ae lv" href="http://localhost:8181" rel="noopener ugc nofollow" target="_blank"> http://localhost:8181 </a>，如果一切正常，可以看到如下GUI:</p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/972823d95e81e383c60c25b40c1ac573.png" data-original-src="https://miro.medium.com/v2/resize:fit:834/format:webp/1*1nVvw0B-gWjPd0eXtK8_4w.png"/></div></figure><p id="ebc1" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">如果您在单击提交按钮时拦截流量，您将发现POST /v1/query请求被发送到后端服务器，以允许您执行特别查询并返回查询的值。有一个简单的例子，使用GUI根据输入数据执行查询。</p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/fdeef40d372e05858da3fc0e909e4803.png" data-original-src="https://miro.medium.com/v2/resize:fit:760/format:webp/1*fiXyWfU-egChdmb3Y0HQ4Q.png"/></div></figure><p id="2b46" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">除了从GUI发送的/v1/query请求之外，您还可以使用前面提到的文档API部分中提到的数据API与OPA服务器进行交互。当服务器启动时，没有数据和策略，所以首先要做的是使用/v1/policies端点通过PUT请求将策略文件推送到服务器。例如</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="402f" class="mf jv iq mb b gy mg mh l mi mj">&gt; curl -X PUT <a class="ae lv" href="http://localhost:8181/v1/policies/policy-1" rel="noopener ugc nofollow" target="_blank">http://localhost:8181/v1/policies/policy-1</a> --data-binary @policy1.rego</span></pre><p id="97e3" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">policy1.rego与上面的示例相同。policy-1是存储在OPA服务器中的策略名称。</p><p id="fad0" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">通过执行下面的检查策略是否已经成功推送，您将得到策略-1的原始数据:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="7c0d" class="mf jv iq mb b gy mg mh l mi mj">&gt; curl <a class="ae lv" href="http://localhost:8181/v1/policies/policy-1" rel="noopener ugc nofollow" target="_blank">http://localhost:8181/v1/policies/policy-1</a><br/>{"result":{"id":"policy-1","raw":"package opa.examples\n\nimport input.example.flag\n\nallow_request { flag == true }\n","ast":{"package":{"path":[{"type":"var","value":"data"},{"type":"string","value":"opa"},{"type":"string","value":"examples"}]},"rules":[{"head":{"name":"allow_request","value":{"type":"boolean","value":true}},"body":[{"terms":[{"type":"ref","value":[{"type":"var","value":"eq"}]},{"type":"ref","value":[{"type":"var","value":"input"},{"type":"string","value":"example"},{"type":"string","value":"flag"}]},{"type":"boolean","value":true}],"index":0}]}]}}}[</span></pre><p id="1e3e" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">创建一个新的输入文件:input2.json，之前的input1.json和input2.json的区别在于，input2.json将input1.json的内容包装到“input”块中。</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="fadd" class="mf jv iq mb b gy mg mh l mi mj">{<br/>    "input": <br/>    {<br/>        "example": <br/>        {<br/>            "flag": true<br/>        }<br/>    }<br/>}</span></pre><p id="952c" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">针对input2.json查询allow_request规则决策:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="3d3b" class="mf jv iq mb b gy mg mh l mi mj">&gt; curl -X POST <a class="ae lv" href="http://localhost:8181/v1/data/opa/examples/allow_request" rel="noopener ugc nofollow" target="_blank">http://localhost:8181/v1/data/opa/examples/allow_request</a>  -d @input2.json   -H 'Content-Type: application/json'<br/>​<br/>{"result":true}</span></pre><h1 id="b5c7" class="ju jv iq bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">4.作为Kubernetes许可控制器运行OPA</h1><p id="5e6c" class="pw-post-body-paragraph ks kt iq ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">现在是时候回到赛道上，并使用OPA的Kubernetes安全警察执法。OPA是一个通用策略引擎，它可以跨各种IT环境自动化和统一策略的实施。Kubernetes准入控制是OPA的用例之一。</p><p id="0d65" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">OPA可以作为准入控制器直接与Kubernetes集成，或者使用OPA Gatekeeper。</p><p id="d7bb" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">OPA Gatekeeper的创建是为了增强和促进OPA与Kubernetes的集成。您可以从<a class="ae lv" href="https://open-policy-agent.github.io/gatekeeper/website/docs/install/" rel="noopener ugc nofollow" target="_blank">网守网站</a>找到安装指南，但在某些情况下，要重用减压阀规则文件，将OPA直接集成到Kubernetes系统中可能是更简单的解决方案。OPA直接集成到Kubernetes的过程比较漫长，所以这里跳过这一部分。在<a class="ae lv" href="https://www.openpolicyagent.org/docs/latest/kubernetes-tutorial/" rel="noopener ugc nofollow" target="_blank"> OPA网站</a>有详细阐述。</p><p id="501d" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">关于OPA网站<a class="ae lv" href="https://www.openpolicyagent.org/docs/latest/kubernetes-tutorial/" rel="noopener ugc nofollow" target="_blank">上的集成指南有两点需要指出。</a></p><p id="cfcd" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">第一个是当提供OPA包时，使用网站中提供的命令可能会引起一些麻烦:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="de7e" class="mf jv iq mb b gy mg mh l mi mj">docker run --rm --name bundle-server -d -p 8888:80 -v ${PWD}:/usr/share/nginx/html:ro nginx:latest</span></pre><p id="1c5e" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">当在admission-controller.yaml中启动OPA服务器时，无法通过用标志指定的<a class="ae lv" href="http://host.minikube.internal:8888/bundle.tar.gz" rel="noopener ugc nofollow" target="_blank">http://host . minikube . internal:8888/bundle . tar . gz</a>成功访问以这种方式提供服务的OPA包。</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="761c" class="mf jv iq mb b gy mg mh l mi mj">- "--set=services.default.url=http://host.minikube.internal:8888"<br/>- "--set=bundles.default.resource=bundle.tar.gz"</span></pre><p id="98cc" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">捆绑文件服务的失败将导致OPA容器不能在pod内成功运行。</p><p id="46e9" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">相反，您可以使用Python SimpleHTTPServer来服务包文件。</p><p id="704c" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">第二个是当组合多个策略时，指南定义了main.rego，但是main.rego在某些情况下可能不起作用。例如，要对disallowed_wildcard_host.yaml执行以下block-wildcard-ingress.rego，除非交换两个入口规则，否则OPA不会像预期的那样阻止入口的创建。这两个文件提供如下，原始文件可以在github 的<a class="ae lv" href="https://github.com/open-policy-agent/gatekeeper-library/tree/master/library/general/block-wildcard-ingress" rel="noopener ugc nofollow" target="_blank">看门人库库中找到</a></p><p id="fb52" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">block-通配符-ingress.rego</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="9e44" class="mf jv iq mb b gy mg mh l mi mj">package kubernetes.admission<br/>​<br/>deny[msg] {<br/>  input.request.kind.kind == "Ingress"<br/>  hostname := object.get(input.request.object.spec.rules[_], "host", "")<br/>  contains_wildcard(hostname)<br/>  msg := sprintf("Hostname '%v' is not allowed since it is a wildcard.", [hostname])<br/>}<br/>​<br/>contains_wildcard(hostname) = true {<br/>  hostname == ""<br/>}<br/>​<br/>contains_wildcard(hostname) = true {<br/>  contains(hostname, "*")<br/>}</span></pre><p id="c6e2" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">不允许的_通配符_host.yaml</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="bc2e" class="mf jv iq mb b gy mg mh l mi mj">apiVersion: networking.k8s.io/v1<br/>kind: Ingress<br/>metadata:<br/>  name: wildcard-ingress<br/>spec:<br/>  rules:<br/>  - host: '*.example.com'<br/>    http:<br/>      paths:<br/>      - pathType: Prefix<br/>        path: "/"<br/>        backend:<br/>          service:<br/>            name: example<br/>            port:<br/>              number: 80<br/>  # Extra test to ensure the rule still detects invalid hosts in files containing valid hosts<br/>  - host: 'valid.example.com'<br/>    http:<br/>      paths:<br/>      - pathType: Prefix<br/>        path: "/"<br/>        backend:<br/>          service:<br/>            name: example<br/>            port:<br/>              number: 80</span></pre><p id="7916" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">在<a class="ae lv" href="https://www.openpolicyagent.org/docs/latest/kubernetes-tutorial/" rel="noopener ugc nofollow" target="_blank"> OPA网站</a>上有很好的使用案例，关于如何使用OPA来阻止基于减压阀规则文件捆绑包的Kubernetes系统内部的不合规操作。</p><p id="8b67" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">Kubernetes系统中的输入对象是一个保留的全局变量，其值等于<a class="ae lv" href="https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#admissionreview-request-0" rel="noopener ugc nofollow" target="_blank">准入审查</a>对象。API服务器获取该对象，并将其提供给任何准入控制webhook。</p><p id="c9b5" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">比如在<a class="ae lv" href="https://www.openpolicyagent.org/docs/latest/kubernetes-tutorial/" rel="noopener ugc nofollow" target="_blank"> OPA网站</a>的ingress-allowlist.rego文件中，在“拒绝”规则内部，可以找到input . request . kind . kind = =“Ingress”，这是AdmissionReview对象的一个用例。</p><p id="70ff" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">Kubernetes中OPA的完整输入对象如下所示:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="ca10" class="mf jv iq mb b gy mg mh l mi mj">{  <br/> "input": {<br/>    "apiVersion": "admission.k8s.io/v1",<br/>    "kind": "AdmissionReview",<br/>    "request": {<br/>      "dryRun": false,<br/>      "kind": {<br/>        "group": "",<br/>        "kind": "ConfigMap",<br/>        "version": "v1"<br/>      },<br/>      "name": "ingress-controller-leader",<br/>      "namespace": "ingress-nginx",<br/>      "object": {<br/>        "apiVersion": "v1",<br/>        "kind": "ConfigMap",<br/>        "metadata": {<br/>          "annotations": {<br/>            "control-plane.alpha.kubernetes.io/leader": "{\"holderIdentity\":\"ingress-nginx-controller-cc8496874-6f992\",\"leaseDurationSeconds\":30,\"acquireTime\":\"2022-06-18T04:43:42Z\",\"renewTime\":\"2022-06-18T14:56:30Z\",\"leaderTransitions\":0}"<br/>          },<br/>          "creationTimestamp": "2022-06-18T04:43:42Z",<br/>          "namespace": "ingress-nginx",<br/>            ...<br/>        }<br/>      },<br/>      "oldObject": {<br/>        ...<br/>      },<br/>      "operation": "UPDATE",<br/>       ...<br/>    }<br/>  }<br/>}</span></pre><p id="ed30" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">您可以按照OPA日志获取完整的webhook请求:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="9c0e" class="mf jv iq mb b gy mg mh l mi mj">kubectl logs -l app=opa -c opa -f</span></pre><p id="fabb" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated"><strong class="ku ir">感谢阅读，希望这篇博客能帮助你与OPA合作。</strong></p></div></div>    
</body>
</html>