<html>
<head>
<title>pentesting.cloud part 1: “Open To The Public” CTF walkthrough</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">第1部分:“向公众开放”CTF演练</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/pentesting-cloud-part-1-open-to-the-public-ctf-walkthrough-aa4dae59ec4e?source=collection_archive---------1-----------------------#2022-11-03">https://infosecwriteups.com/pentesting-cloud-part-1-open-to-the-public-ctf-walkthrough-aa4dae59ec4e?source=collection_archive---------1-----------------------#2022-11-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="9187" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最近我玩<a class="ae kl" href="https://pentesting.cloud/" rel="noopener ugc nofollow" target="_blank"> pentesting.cloud </a> CTF玩得很开心，在这篇博文中，我想开始一个新的IMHO最有趣挑战的演练系列。我先从名为<a class="ae kl" href="https://pentesting.cloud/challenge/open-to-the-public/" rel="noopener ugc nofollow" target="_blank">“对公众开放”</a>的硬挑战说起。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi km"><img src="../Images/17c0e4d4ad61b6a49366e5d1124274dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1182/format:webp/1*MUxAjq5mo4jbbqUiinCWxw.jpeg"/></div></figure><h1 id="2a9d" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">让我们开始吧！</h1><p id="0c6a" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">这个挑战不需要任何设置，乍一看，它的描述并没有提供太多信息:</p><blockquote class="lx ly lz"><p id="377c" class="jn jo ma jp b jq jr js jt ju jv jw jx mb jz ka kb mc kd ke kf md kh ki kj kk ij bi translated">本次挑战不需要任何文件。该标志是一个AWS访问键。</p><p id="71b6" class="jn jo ma jp b jq jr js jt ju jv jw jx mb jz ka kb mc kd ke kf md kh ki kj kk ij bi translated">访问密钥不在这个域上，不要试图枚举/攻击这个网站，否则你将被永久禁止。</p></blockquote><p id="86a6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有多种可以公开的AWS资源类型。<a class="ae kl" href="https://twitter.com/0xdabbad00" rel="noopener ugc nofollow" target="_blank"> Scott Piper </a>创建了此类资源类型的列表，可在<a class="ae kl" href="https://github.com/SummitRoute/aws_exposable_resources" rel="noopener ugc nofollow" target="_blank">这里</a>找到。但是，为了能够找到与挑战相关的任何内容，我们至少需要AWS帐户ID。如果你已经完成了任何其他pentesting.cloud的挑战(例如<a class="ae kl" href="https://pentesting.cloud/challenge/intro-the-first-challenge/" rel="noopener ugc nofollow" target="_blank"> Intro </a> challenge)，你会发现所有与挑战相关的文件都存储在名为<em class="ma">pentesting-challenges-public</em>的S3桶中。有一个<a class="ae kl" href="https://cloudar.be/awsblog/finding-the-account-id-of-any-public-s3-bucket/" rel="noopener ugc nofollow" target="_blank">有趣的研究</a>是关于从公共桶名中确定AWS帐户ID🤯研究作者还发布了<a class="ae kl" href="https://github.com/WeAreCloudar/s3-account-search" rel="noopener ugc nofollow" target="_blank">开源工具</a>，它会为你带来奇迹。所以让我们来试试:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi me"><img src="../Images/bd4862ce4fe9384ff1ccb1e509e00e93.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LeWvcdR5_0KDV-g7fnNAaw.png"/></div></div></figure><p id="f426" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在让我们检查同一个帐户是否被用来共享其他东西，而不仅仅是S3桶中的对象。让我们从寻找公开的EBS快照开始(我的第一个猜测是EBS，因为几年前我创建了一个类似的<a class="ae kl" href="https://medium.com/securing/krkanalytica-challenge-demystified-1c6477839e76" rel="noopener"> CTF挑战赛</a>)。您可以使用AWS管理控制台来搜索公共EBS快照。此外，您可以使用过滤器<code class="fe mj mk ml mm b">Owner = 943126763185</code>:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi mn"><img src="../Images/a21aaa3d6c0fa2a6d91ac0b55e3e6cff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YhqUDkz0jp-dODXPsNICNQ.png"/></div></div></figure><p id="d80c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">答对了。！！正如你在上面看到的，有公开共享的EBS快照。复制快照ID，让我们研究一下它的内容。</p><h1 id="53ff" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">探索EBS快照</h1><p id="a9c6" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">首先，您需要有一个正在运行的EC2实例(一个带有默认设置的自由层t2.micro实例在这里会很好地工作)。但是，您不能将快照直接连接到EC2实例。您需要首先从快照创建一个EBS卷(请注意<strong class="jp ir">该卷必须在与您正在运行的EC2实例</strong>相同的可用性区域中创建；不然就贴不上了)。为此，进入AWS管理控制台，然后:<strong class="jp ir">S<em class="ma">service-&gt;EC2-&gt;Volumes-&gt;Create Volume-&gt;指定自定义快照id… </em> </strong>并提供共享快照的id:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi mo"><img src="../Images/dc0614ea11ebefce25e0302cf53758fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BykNdUWNZwx6wALsKIG_wQ.png"/></div></div></figure><p id="3f1c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦创建了卷，现在是时候将它附加到正在运行的EC2实例了(在AWS管理控制台中:<strong class="jp ir">S<em class="ma">service-&gt;EC2-&gt;</em></strong><strong class="jp ir"><em class="ma">Actions-&gt;Attach volume</em></strong>，并在此选择您的EC2实例ID):</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi mp"><img src="../Images/f732929dabf0f9dd2c4bbf09d86635e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_xPIlcPtYx00JisuhGYcxA.png"/></div></div></figure><p id="09c5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后登录到您的EC2实例(在我的例子中，我使用了<a class="ae kl" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/session-manager.html" rel="noopener ugc nofollow" target="_blank"> AWS会话管理器</a>，找到附加的卷(命令:<code class="fe mj mk ml mm b">lsblk</code>)并将其挂载到您的文件系统(命令:<code class="fe mj mk ml mm b">sudo mount [device] [mount point]</code>):</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi mq"><img src="../Images/2ba6397e5217157296ca3ff5c7f83677.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Kfb7BE8TnEfjD7Dj6uWhxg.png"/></div></div></figure><p id="0e3b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">凭直觉，我去了<em class="ma"> /home </em>目录。在<code class="fe mj mk ml mm b">.bash_history</code>文件中你可以看到<em class="ma"> ssm用户</em>使用了OS <em class="ma"> root </em>用户:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi mr"><img src="../Images/d5e145b43e9ff22af11f17eab8474cf2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Bn2Fz7ezPSUTpvVaJ2rN8g.png"/></div></div></figure><p id="3c87" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以让我们检查一下<em class="ma">根的</em>T3文件:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi ms"><img src="../Images/46ab60fe0725650aa63cdc353f8e3503.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Bzgq7f4UxbvoY2DqvRGG2w.png"/></div></div></figure><p id="8b74" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">嗯……仍然看不到标志，但至少我可以看到采取所有这些行动的日期(请注意，根据<code class="fe mj mk ml mm b">ls -al</code>命令的输出，您可以发现<code class="fe mj mk ml mm b">.bash_history</code>文件在24ᵗʰ8月被修改)。因此，让我们不要检查挂载卷中的所有文件，而只过滤掉那些在23ʳᵈ8月之后修改过的文件(您可以通过运行下面的命令来做到这一点:<code class="fe mj mk ml mm b">find /mnt/ -type f -mtime -xx</code>其中<code class="fe mj mk ml mm b">-xx</code>是文件被修改的天数)。结果找到了165个文件。</p><p id="8fa9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从挑战描述中，我们知道:</p><blockquote class="lx ly lz"><p id="077f" class="jn jo ma jp b jq jr js jt ju jv jw jx mb jz ka kb mc kd ke kf md kh ki kj kk ij bi translated">"(…)标志是一个AWS访问密钥"</p></blockquote><p id="480a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在官方<a class="ae kl" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_identifiers.html#identifiers-prefixes" rel="noopener ugc nofollow" target="_blank">文档</a>中，你可以找到AWS访问键使用AKIA或亚洲前缀的信息。如果您对23ʳᵈ8月之后修改的所有文件运行<code class="fe mj mk ml mm b">grep ^AKIA</code>，您将最终在<code class="fe mj mk ml mm b">/mnt/var/lib/amazon/ssm/i-022903e02a0fed192/session/orchestration/sso-admin-087e79117eb921608/Standard_Stream/ipcTempFile.log</code>文件中找到该标志:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi mt"><img src="../Images/2e34feee3d4641208df4cf0d4fb7bdc8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ssw0XfXjBDwkH6TwYsOHuA.png"/></div></div></figure><p id="5bfb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如您所见<strong class="jp ir">所有SSM会话的命令及其输出都存储在本地</strong>的文件中</p><p id="66c2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mj mk ml mm b">/var/lib/amazon/ssm/[instance ID]/session/orchestration/[SSM session ID]/Standard_Stream/ipcTempFile.log</code></p><p id="85e1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对共享EBS快照拥有权限的任何人都可以很容易地泄露这些日志。换句话说，任何检索到的或作为参数传递的机密都可能通过本地SSM日志无意中暴露出来。</p><h1 id="186d" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">可选择的解决方案</h1><p id="cc0c" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">也可以用不同的方式检索标志。让我们再看一次<code class="fe mj mk ml mm b">/mnt/root/.bash_history</code>文件，特别是根用户最后采取的动作:</p><pre class="kn ko kp kq gt mu mm mv mw aw mx bi"><span id="2008" class="my kv iq mm b gy mz na l nb nc"># cat <!-- -->/mnt/root/.bash_history<br/>...<br/>python3 flag.pyc<br/>rm -f flag1.zip<br/>rm -f flag1.bz2<br/>rm -f flag.pyc<br/>rm -f flag.py<br/>ls<br/>rm -f flag*<br/>ls<br/>cd ec2-user/<br/>ls<br/>rm -f *<br/>ls ../ssm-user/<br/>exit</span></pre><p id="9aa7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如你所看到的,<em class="ma">标志* </em>文件被删除。但这是否意味着它们被永久移除了呢？如果您阅读官方白皮书<a class="ae kl" href="https://d0.awsstatic.com/whitepapers/aws-security-whitepaper.pdf" rel="noopener ugc nofollow" target="_blank">“安全流程概述”</a>，您会发现:</p><blockquote class="lx ly lz"><p id="482a" class="jn jo ma jp b jq jr js jt ju jv jw jx mb jz ka kb mc kd ke kf md kh ki kj kk ij bi translated">EBS快照是整个EBS卷的块级视图。请注意，通过卷上的文件系统不可见的数据(如已删除的文件)可能存在于EBS快照中。</p></blockquote><p id="9643" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这意味着我应该能够恢复删除的文件。为了测试它，我将使用<a class="ae kl" href="https://www.cgsecurity.org/wiki/TestDisk_Download" rel="noopener ugc nofollow" target="_blank"> PhotoRec </a>工具，这是一个免费的文件恢复工具。使用以下命令可以很容易地将它安装在Amazon Linux实例上:</p><pre class="kn ko kp kq gt mu mm mv mw aw mx bi"><span id="48f0" class="my kv iq mm b gy mz na l nb nc"># amazon-linux-extras install epel -y<br/># yum update -y<br/># yum install testdisk -y</span></pre><p id="d06f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们运行PhotoRec，并选择已装载的卷来恢复从中删除的文件:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi nd"><img src="../Images/7c0ab0cafb3dc6d57c98c13a3b2410e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_YedF7rVo6YKc3oxoJ5DFg.png"/></div></div></figure><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi ne"><img src="../Images/7993c7fdaecd21a72fae6518b010d5fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oCMPP4SeGDha1QBiw1pwsQ.png"/></div></div></figure><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi nf"><img src="../Images/2ca89fd5657db204be56c8528c247759.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QPv2HNdsDpH5EcsHDaiNrA.png"/></div></div></figure><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi ng"><img src="../Images/99b329d9ccd87fac7ebfed3b10f6f2d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NVwYUw4TdyeCVo8iR6HfQQ.png"/></div></div></figure><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi nh"><img src="../Images/17d05d7d4371fbf0f095f3698c70c2a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N-u1tev7Ebzn7Qyicdi1-Q.png"/></div></div></figure><p id="82f2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因为卷被挂载为XFS文件系统，所以您看不到恢复的文件名(EXT4在这里会更好)。然而，因为我们知道这个标志是一个AWS访问键，所以我们可以搜索所有恢复的文件。正如您在下面看到的，该标志是在Lorem Ipsum文本中“注入”的:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi ni"><img src="../Images/bd584a05e6505a38d16804d72dd2f194.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y0wsIoTmWAhdLCYkYC7ayw.png"/></div></div></figure><h1 id="e50f" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">结论</h1><p id="eae0" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">“向公众开放”的挑战不仅是一个很大的乐趣，但也集中在重要的安全风险。我们可以从中了解到:</p><ul class=""><li id="2ac6" class="nj nk iq jp b jq jr ju jv jy nl kc nm kg nn kk no np nq nr bi translated"><strong class="jp ir">所有SSM会话的命令及其输出都存储在本地，</strong></li><li id="11b4" class="nj nk iq jp b jq ns ju nt jy nu kc nv kg nw kk no np nq nr bi translated"><strong class="jp ir">从EBS卷中删除的文件可以恢复(EBS卷在终止后被擦除)。</strong></li></ul><p id="7d65" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请继续关注，不久我将发布更多关于<a class="ae kl" href="https://pentesting.cloud/" rel="noopener ugc nofollow" target="_blank"> pentesting.cloud </a>挑战的演练😉</p></div><div class="ab cl nx ny hu nz" role="separator"><span class="oa bw bk ob oc od"/><span class="oa bw bk ob oc od"/><span class="oa bw bk ob oc"/></div><div class="ij ik il im in"><h2 id="d1c9" class="my kv iq bd kw oe of dn la og oh dp le jy oi oj li kc ok ol lm kg om on lq oo bi translated">来自Infosec的报道:Infosec每天都有很多内容，很难跟上。<a class="ae kl" href="https://weekly.infosecwriteups.com/" rel="noopener ugc nofollow" target="_blank">加入我们的每周简讯</a>以5篇文章、4个线程、3个视频、2个GitHub Repos和工具以及1个工作提醒的形式免费获取所有最新的Infosec趋势！</h2></div></div>    
</body>
</html>