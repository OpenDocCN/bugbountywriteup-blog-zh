<html>
<head>
<title>Intercepting Network data with MITMProxy on MacOS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在MacOS上用MITMProxy拦截网络数据</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/intercepting-network-data-with-mitmproxy-on-macos-3e3f2f0123b2?source=collection_archive---------0-----------------------#2018-02-07">https://infosecwriteups.com/intercepting-network-data-with-mitmproxy-on-macos-3e3f2f0123b2?source=collection_archive---------0-----------------------#2018-02-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><h1 id="310b" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">要求</h1><p id="621c" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">对于我最近工作的一个客户来说，需要在网络上截取数据。在对截取的数据应用业务逻辑之后，需要采取某些行动。</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div class="gh gi lj"><img src="../Images/4aa97cd5ae98afb1e15665d40a22e399.png" data-original-src="https://miro.medium.com/v2/resize:fit:600/1*hhqUOoVuRgzdqUGicQZ1Ow.gif"/></div></figure><h1 id="4bca" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">方法</h1><p id="92e8" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在评估了其他工具后，我们认为我们会在MITMProxy上有所突破，这是一个HTTP和HTTPS的中间人代理，具有交互式控制台界面。它提供了各种代理模式，如:</p><ol class=""><li id="c813" class="lr ls iq kn b ko lt ks lu kw lv la lw le lx li ly lz ma mb bi translated">规则的</li><li id="9383" class="lr ls iq kn b ko mc ks md kw me la mf le mg li ly lz ma mb bi translated">透明代理√</li><li id="cfa0" class="lr ls iq kn b ko mc ks md kw me la mf le mg li ly lz ma mb bi translated">反向代理</li><li id="771e" class="lr ls iq kn b ko mc ks md kw me la mf le mg li ly lz ma mb bi translated">上游代理</li></ol><p id="f3e6" class="pw-post-body-paragraph kl km iq kn b ko lt kq kr ks lu ku kv kw mh ky kz la mi lc ld le mj lg lh li ij bi translated">这里详细解释了<a class="ae mk" href="http://docs.mitmproxy.org/en/stable/modes.html" rel="noopener ugc nofollow" target="_blank"> <strong class="kn ir">运行模式</strong> </a> <strong class="kn ir">。</strong></p><p id="b38d" class="pw-post-body-paragraph kl km iq kn b ko lt kq kr ks lu ku kv kw mh ky kz la mi lc ld le mj lg lh li ij bi translated">我们希望设置一个透明的代理，因为我们可以控制连接到网络的设备，所以在这些设备上设置证书不成问题。</p><h1 id="eb4a" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">设置</h1><p id="90ea" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">我有一台运行MacOS HighSierra的Mac和一台连接到<strong class="kn ir">同一个Wi-Fi网络</strong>的Android测试设备。我用<a class="ae mk" href="https://brew.sh/" rel="noopener ugc nofollow" target="_blank"> <strong class="kn ir"> Brew </strong> </a> <strong class="kn ir">，</strong>安装了MITMProxy，预建的二进制文件也可以从他们的<a class="ae mk" href="https://github.com/mitmproxy/mitmproxy/releases" rel="noopener ugc nofollow" target="_blank">发布页面</a>下载。</p><blockquote class="ml mm mn"><p id="81b5" class="kl km mo kn b ko lt kq kr ks lu ku kv mp mh ky kz mq mi lc ld mr mj lg lh li ij bi translated"><strong class="kn ir"> mitmproxy </strong>使用<strong class="kn ir"> pf包过滤</strong>实现透明模式。在OSX，它被整合在自《OSX狮子》以来的版本中。这意味着mitmproxy不支持OSX早期版本的透明模式。</p></blockquote><h2 id="2ad0" class="ms jo iq bd jp mt mu dn jt mv mw dp jx kw mx my kb la mz na kf le nb nc kj nd bi translated">在设备上安装证书</h2><p id="9343" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">MITMProxy通过在客户端设备上安装其自定义证书来支持HTTPS和HTTP。通过运行以下命令，在基本模式下启动代理</p><pre class="lk ll lm ln gt ne nf ng nh aw ni bi"><span id="65e6" class="ms jo iq nf b gy nj nk l nl nm">mitmproxy --host</span></pre><p id="376c" class="pw-post-body-paragraph kl km iq kn b ko lt kq kr ks lu ku kv kw mh ky kz la mi lc ld le mj lg lh li ij bi translated">您将能够看到交互式控制台。现在更新<strong class="kn ir"> <em class="mo"> Wi-Fi设置- &gt;选择网络- &gt;高级设置- &gt;代理配置。</em> </strong>添加主机的IP地址作为代理。</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/e6119ac29fae8bb10261c8f2bf05b787.png" data-original-src="https://miro.medium.com/v2/resize:fit:640/1*y0dQFcIiY5Jee1d2rziy5A.gif"/></div><figcaption class="no np gj gh gi nq nr bd b be z dk translated">在设置中设置代理配置</figcaption></figure><p id="13f1" class="pw-post-body-paragraph kl km iq kn b ko lt kq kr ks lu ku kv kw mh ky kz la mi lc ld le mj lg lh li ij bi translated">在设备的浏览器上访问<code class="fe ns nt nu nf b">mitm.it</code>，然后选择相关平台并按照提供的说明进行操作。这个过程相当简单。</p></div><div class="ab cl nv nw hu nx" role="separator"><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa"/></div><div class="ij ik il im in"><h2 id="dc5e" class="ms jo iq bd jp mt mu dn jt mv mw dp jx kw mx my kb la mz na kf le nb nc kj nd bi translated">配置透明代理模式</h2><p id="4518" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">一旦我们在设备上安装了mitmproxy证书。只需完成以下步骤即可启用它:</p><ol class=""><li id="1917" class="lr ls iq kn b ko lt ks lu kw lv la lw le lx li ly lz ma mb bi translated">启用IP转发</li></ol><pre class="lk ll lm ln gt ne nf ng nh aw ni bi"><span id="73e4" class="ms jo iq nf b gy nj nk l nl nm">sudo sysctl <strong class="nf ir">-</strong>w net<strong class="nf ir">.</strong>inet<strong class="nf ir">.</strong>ip<strong class="nf ir">.</strong>forwarding<strong class="nf ir">=</strong>1</span></pre><p id="fa34" class="pw-post-body-paragraph kl km iq kn b ko lt kq kr ks lu ku kv kw mh ky kz la mi lc ld le mj lg lh li ij bi translated">2.更新<strong class="kn ir"> <em class="mo"> pfctl </em> </strong>配置，将端口<strong class="kn ir"> 80 </strong>和<strong class="kn ir"> 443 </strong>上的流量重定向到端口<strong class="kn ir"> 8080 </strong>上运行的mitmproxy实例。假设您的网络接口是<code class="fe ns nt nu nf b">en0</code>,将以下配置添加到一个名为pf.conf的文件中</p><pre class="lk ll lm ln gt ne nf ng nh aw ni bi"><span id="7332" class="ms jo iq nf b gy nj nk l nl nm">rdr on en0 inet proto tcp to any port {80, 443} -&gt; 127.0.0.1 port 8080</span></pre><blockquote class="ml mm mn"><p id="613a" class="kl km mo kn b ko lt kq kr ks lu ku kv mp mh ky kz mq mi lc ld mr mj lg lh li ij bi translated">上面<strong class="kn ir"> pf.conf </strong>中的<strong class="kn ir"> rdr规则</strong>仅适用于入站流量。它们将<strong class="kn ir">而不是</strong>重定向来自运行pf本身的机器的流量。</p></blockquote><p id="16b6" class="pw-post-body-paragraph kl km iq kn b ko lt kq kr ks lu ku kv kw mh ky kz la mi lc ld le mj lg lh li ij bi translated">运行以下命令更新规则并启用pfctl</p><pre class="lk ll lm ln gt ne nf ng nh aw ni bi"><span id="bc19" class="ms jo iq nf b gy nj nk l nl nm">sudo pfctl <strong class="nf ir">-</strong>f pf<strong class="nf ir">.</strong>conf<br/>sudo pfctl -e</span></pre><p id="13e0" class="pw-post-body-paragraph kl km iq kn b ko lt kq kr ks lu ku kv kw mh ky kz la mi lc ld le mj lg lh li ij bi translated">3.配置sudoers以允许mitmproxy访问pfctl。以root用户身份编辑系统上的文件<strong class="kn ir"> /etc/sudoers </strong>。这仅允许检查状态表，因此不应该有不必要的安全风险。将以下行添加到文件末尾时要小心，覆盖其他行会导致用户无法访问<strong class="kn ir"> sudo </strong>:</p><pre class="lk ll lm ln gt ne nf ng nh aw ni bi"><span id="d201" class="ms jo iq nf b gy nj nk l nl nm">ALL ALL=NOPASSWD: /sbin/pfctl -s state</span></pre><p id="cc1b" class="pw-post-body-paragraph kl km iq kn b ko lt kq kr ks lu ku kv kw mh ky kz la mi lc ld le mj lg lh li ij bi translated">4.开始mitmproxy。</p><pre class="lk ll lm ln gt ne nf ng nh aw ni bi"><span id="6855" class="ms jo iq nf b gy nj nk l nl nm">mitmproxy -T --host</span></pre><p id="8b83" class="pw-post-body-paragraph kl km iq kn b ko lt kq kr ks lu ku kv kw mh ky kz la mi lc ld le mj lg lh li ij bi translated"><code class="fe ns nt nu nf b">-T</code>标志打开透明模式，<code class="fe ns nt nu nf b">--host</code>参数告诉mitmproxy使用主机头的值来显示URL。</p><p id="aa8d" class="pw-post-body-paragraph kl km iq kn b ko lt kq kr ks lu ku kv kw mh ky kz la mi lc ld le mj lg lh li ij bi translated">5.最后，将设备配置为使用Mac作为网络的默认网关。将Mac的IP地址添加为默认网关。</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/434541b6728f3481c318ced9ce47eca0.png" data-original-src="https://miro.medium.com/v2/resize:fit:640/1*1Bsf37jTOr6iT2q1ys88kg.gif"/></div><figcaption class="no np gj gh gi nq nr bd b be z dk translated">为Wifi网络配置默认网关</figcaption></figure><p id="f97a" class="pw-post-body-paragraph kl km iq kn b ko lt kq kr ks lu ku kv kw mh ky kz la mi lc ld le mj lg lh li ij bi translated">现在，您将能够拦截和处理来自连接到网络的设备的请求。</p><h2 id="a7e6" class="ms jo iq bd jp mt mu dn jt mv mw dp jx kw mx my kb la mz na kf le nb nc kj nd bi translated">好的读物:</h2><ol class=""><li id="94b6" class="lr ls iq kn b ko kp ks kt kw oc la od le oe li ly lz ma mb bi translated"><a class="ae mk" href="http://docs.mitmproxy.org/en/stable/mitmproxy.html" rel="noopener ugc nofollow" target="_blank">http://docs.mitmproxy.org/en/stable/mitmproxy.html</a></li><li id="8977" class="lr ls iq kn b ko mc ks md kw me la mf le mg li ly lz ma mb bi translated"><a class="ae mk" href="http://docs.mitmproxy.org/en/stable/transparent/osx.html" rel="noopener ugc nofollow" target="_blank">http://docs.mitmproxy.org/en/stable/transparent/osx.html</a></li><li id="4775" class="lr ls iq kn b ko mc ks md kw me la mf le mg li ly lz ma mb bi translated"><a class="ae mk" href="https://gist.github.com/tracphil/4353170" rel="noopener ugc nofollow" target="_blank">https://gist.github.com/tracphil/4353170</a></li></ol></div><div class="ab cl nv nw hu nx" role="separator"><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa"/></div><div class="ij ik il im in"><p id="feb5" class="pw-post-body-paragraph kl km iq kn b ko lt kq kr ks lu ku kv kw mh ky kz la mi lc ld le mj lg lh li ij bi translated"><strong class="kn ir">补遗(2018年2月20日)</strong></p><p id="1ea3" class="pw-post-body-paragraph kl km iq kn b ko lt kq kr ks lu ku kv kw mh ky kz la mi lc ld le mj lg lh li ij bi translated">官方文档现在包含了我推荐的MacOS设置的修改。那也可以作为参考。</p><p id="cf70" class="pw-post-body-paragraph kl km iq kn b ko lt kq kr ks lu ku kv kw mh ky kz la mi lc ld le mj lg lh li ij bi translated">希望你喜欢读这篇文章，就像我喜欢写这篇文章一样。 <br/> <em class="mo">你是否认为这样会对某人有所帮助？不要犹豫分享。如果你喜欢，点击下面的</em> <strong class="kn ir"> <em class="mo">拍拍</em> </strong> <em class="mo">，这样其他人会在媒体上看到。别忘了在博客后用</em> <strong class="kn ir"> <em class="mo">来表达爱意！</em> </strong></p></div></div>    
</body>
</html>