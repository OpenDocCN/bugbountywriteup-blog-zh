<html>
<head>
<title>Stop Active Directory Reconnaissance for sensitive infrastructure, once in for all.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">一劳永逸地停止对敏感基础架构的Active Directory侦测。</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/stop-active-directory-reconnaissance-for-sensitive-infrastructure-once-in-for-all-7c66a40c7d86?source=collection_archive---------0-----------------------#2018-12-22">https://infosecwriteups.com/stop-active-directory-reconnaissance-for-sensitive-infrastructure-once-in-for-all-7c66a40c7d86?source=collection_archive---------0-----------------------#2018-12-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="8453" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi kl translated">这是我的活动目录测试系列的第4部分。这一部分的重点是通过强制执行强制策略和减少外围应用来停止/限制Active Directory侦测。我在以前的文章中已经介绍了最基本的和一些高级的工具技术:<br/> 1。<a class="ae ku" href="https://medium.com/@Shorty420/enumerating-ad-98e0821c4c78" rel="noopener">第一部分:列举广告基础设施</a> <br/> 2。<a class="ae ku" href="https://medium.com/bugbountywriteup/automating-ad-enumeration-with-frameworks-f8c7449563be" rel="noopener">第二部分:自动化广告枚举</a> <br/> 3。<a class="ae ku" href="https://medium.com/@Shorty420/kerberoasting-9108477279cc" rel="noopener">第三部分:Kerberoasting在</a> <br/> 4中为您开路。<a class="ae ku" href="https://medium.com/@Shorty420/stop-active-directory-reconnaissance-for-sensitive-infrastructure-once-in-for-all-7c66a40c7d86" rel="noopener">第四部分:一劳永逸地停止对敏感基础架构的Active Directory侦察！</a></p><p id="3299" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">那么，使用Active Directory的组织可以做些什么来对抗侦察和自动化工具库呢？以上所有的攻击都滥用了NTLM认证协议，所以唯一完整的解决方案是完全禁用NTLM，转而使用Kerberos。正如我们所知，许多组织的传统操作系统不支持Kerberos身份验证，因此禁用NTLM将会对业务产生重大影响。作为一个缓解因素，可以启用几个设置来最小化枚举、信息泄露、侦察和中继的风险。</p><figure class="kw kx ky kz gt la gh gi paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="gh gi kv"><img src="../Images/993df7e0fecdfd3a9e9ec980ebb877b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZU2JUPYN62noMNR_NiPLmA.jpeg"/></div></div><figcaption class="lh li gj gh gi lj lk bd b be z dk translated">连接杀伤链，专注于侦察和信息收集。Img来源:https://docs . Microsoft . com/en-us/advanced-threat-analytics/ATA-threats</figcaption></figure><blockquote class="ll lm ln"><p id="63da" class="jn jo lo jp b jq jr js jt ju jv jw jx lp jz ka kb lq kd ke kf lr kh ki kj kk ij bi translated"><em class="iq">这些配置和变更特定于基础设施。因此，本文中不包含截图或cmdlets。审核员/评审员将不得不挖掘并为组织获取这些信息。</em></p></blockquote><p id="7f9d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">建立</strong>，实施和执行SMB签名将通过要求对所有流量进行签名来防止中继到SMB。签名需要用户密码来验证消息，因此中继连接的攻击者无法发送服务器会接受的任何流量，因为攻击者不拥有受害者的密码。</p><p id="7c4d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">建立</strong>，在TLS上实施和执行LDAP防止未签名的LDAP连接，并保护LDAP请求/响应。应该注意的是，通过TLS进行的LDAP连接也被认为是已签名的。</p><p id="6a61" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">考虑</strong>身份验证的扩展保护通过确保用于连接到服务器的TLS通道与客户端在身份验证时使用的通道相同，有助于防止一些中继攻击。此设置主要适用于IIS。</p><p id="cdd4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">建立</strong>，实施并强制执行SPN目标名称验证，通过验证客户端认为正在进行身份验证的目标名称来防止中继到SMB。如果名称与服务器不匹配，身份验证请求将被拒绝。</p><p id="dfe4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">强制</strong>所有内部网站对HTTPS的唯一功能，转播变得不那么有效。当通过不安全的HTTP协议访问内部网站时，用户无法验证连接的真实性。</p><p id="d8dc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">考虑</strong>如果域中需要NTLM认证，浏览器(主要是Internet Explorer)仅自动认证受信任的网站。通过组策略，可以禁用自动intranet检测，而只自动对自动身份验证应适用的内部网站的白名单进行身份验证。如前所述，强烈建议在这里只使用HTTPS网站。</p><p id="eebe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">考虑</strong>禁用Windows代理自动检测。虽然WPAD的安全问题大多已通过Microsoft MS16–077安全更新解决，但仍然建议通过组策略禁用WPAD。</p><p id="68d2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">考虑</strong>禁用LLMNR/NBNS，因为配置良好的网络通常不需要这些不安全的名称解析协议。禁用它们会减少攻击者进行名称解析欺骗的可能性，从而使攻击者更难欺骗受害者连接到攻击者的服务器。这也确保了运行Vista和更高版本的系统在防止内部网络上的哈希捕获方面有很大的进步。</p><p id="9218" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">确保</strong>通过更改默认帐户设置和设置安全密码来保护软件安装。</p><p id="b2a2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">建立并维护</strong>补丁管理流程，通过该流程定期扫描网络，查找过期的操作系统和软件，然后更新/升级并修补系统。</p><p id="2aa2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">避免</strong>通过组策略对象设置管理密码。如果必须使用本地管理帐户，请使用随机密码来限制危害的深度。</p><p id="61bf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">避免到处都是空会话。虽然空NetBIOS访问设置可能看起来是一个低风险问题，但当匿名访问发生时，它可能会泄露用户、组和策略，从而增加危害内部网络访问的机会。Windows域控制器和服务器可以禁用此功能，以防止数据枚举。</strong></p><p id="f5fc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">确保</strong>服务帐户密码超过25个字符(并且不易被猜到)。</p><p id="240c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">考虑</strong> <a class="ae ku" href="https://technet.microsoft.com/en-us/library/dd560633%28v=ws.10%29.aspx" rel="noopener ugc nofollow" target="_blank">托管服务账户</a>和<a class="ae ku" href="http://blogs.technet.com/b/askpfeplat/archive/2012/12/17/windows-server-2012-group-managed-service-accounts.aspx" rel="noopener ugc nofollow" target="_blank">组托管服务账户</a>，确保服务账户密码长且复杂，并定期更换。提供密码保险存储的第三方产品也是管理服务帐户密码的可靠解决方案。尽管任何第三方密码管理工具都需要正确评估，因为相关的服务帐户通常需要域管理员级别的权限。此评估还应包括如何在解决方案中管理这些凭据。</p><p id="d148" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">执行</strong>一次<em class="lo">活动目录有效访问审计</em>和<em class="lo">活动目录委派审计</em>以准确识别<strong class="jp ir">谁</strong>被委派了<strong class="jp ir">什么</strong>活动目录中的管理访问权限，从而轻松识别组织内部的关键基础设施，以提供更多的安全关注。</p><p id="047b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">执行</strong> CIS和IASE STIG审核，以确保足够的强化到位。<a class="ae ku" href="https://www.cisecurity.org/cis-benchmarks/" rel="noopener ugc nofollow" target="_blank"> CIS </a>和<a class="ae ku" href="https://iase.disa.mil/stigs/pages/a-z.aspx?Paged=TRUE" rel="noopener ugc nofollow" target="_blank"> IASE STIG </a>核对表保证系统和网络硬化，差不多。利用OpenSCAP和Nessus进行自动化审计。这些指南中的许多检查确保了对初始数据收集的防范。</p><blockquote class="ll lm ln"><p id="0619" class="jn jo lo jp b jq jr js jt ju jv jw jx lp jz ka kb lq kd ke kf lr kh ki kj kk ij bi translated"><strong class="jp ir">喊出:</strong> <br/>独联体基准:<a class="ae ku" href="https://www.cisecurity.org/cis-benchmarks/" rel="noopener ugc nofollow" target="_blank">https://www.cisecurity.org/cis-benchmarks/</a><br/>IASE DISA斯蒂格斯:<a class="ae ku" href="https://iase.disa.mil/stigs/pages/a-z.aspx?Paged=TRUE" rel="noopener ugc nofollow" target="_blank">https://iase.disa.mil/stigs/pages/a-z.aspx?Paged=TRUE</a><br/><a class="ae ku" href="https://adsecurity.org/?p=3458" rel="noopener ugc nofollow" target="_blank">https://adsecurity.org/?p=3458</a></p></blockquote></div></div>    
</body>
</html>