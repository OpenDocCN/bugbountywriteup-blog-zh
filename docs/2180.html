<html>
<head>
<title>Hunting malwares with Yara</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">和亚拉一起打猎</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/hunting-malwares-with-yara-6b451b2ad1a8?source=collection_archive---------2-----------------------#2022-07-10">https://infosecwriteups.com/hunting-malwares-with-yara-6b451b2ad1a8?source=collection_archive---------2-----------------------#2022-07-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="9192" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">恶意软件分析行业中最广泛使用的工具之一的初学者指南。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><a href="https://www.cybersecurityup.it/i-nostri-blog/cyber-pillole/443-pillole-di-malware-analysis-le-yara-rules+"><div class="gh gi kf"><img src="../Images/98f86e556a616c1feff99aa675a948d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1300/format:webp/1*O6usqywvwHQhuOFDBH6-XA.jpeg"/></div></a><figcaption class="kn ko gj gh gi kp kq bd b be z dk translated">Yara标志</figcaption></figure><p id="6c25" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">嗨伙计们！</p><p id="5d81" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">近年来，正如数据显示的那样，我们正在目睹每年造成数十亿美元损失的恶意软件攻击的惊人增长。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><a href="https://securityboulevard.com/2020/02/20-ransomware-statistics-youre-powerless-to-resist-reading/"><div class="gh gi ln"><img src="../Images/1ef043008cacceaae03969f38879f976.png" data-original-src="https://miro.medium.com/v2/resize:fit:1152/format:webp/1*UBSsO5ctZzWoVd8D5Z8DwA.png"/></div></a></figure><p id="8de6" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我最近对这个世界产生了兴趣，今天我想向大家展示一个恶意软件狩猎的必备工具，<strong class="kt ir"> Yara </strong>。</p><p id="9596" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">该工具由一组规则组成，允许我们识别所有与之匹配的文件。<br/>如果你感到困惑，不要担心，甚至当我第一次开始使用它时，我也很困惑。<br/>我们开始吧！</p></div><div class="ab cl lo lp hu lq" role="separator"><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt"/></div><div class="ij ik il im in"><p id="df71" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">您可以使用“<strong class="kt ir">sudo apt install Yara”</strong><em class="lv"/>在Linux上安装Yara，并通过以下链接下载zip文件在Windows上安装Yara。</p><p id="1d06" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><a class="ae lw" href="https://github.com/VirusTotal/yara/releases" rel="noopener ugc nofollow" target="_blank">发布VirusTotal/yara GitHub </a></p><p id="4fa6" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">为yara创建一个文件是非常容易的，你可以简单地创建一个txt文件，并将扩展名改为. yar。</p><p id="69a1" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">首先要做的是创建我们的规则，并按照我们喜欢的方式命名。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi lx"><img src="../Images/b7f06f40616875a53b010968bfdd4bf0.png" data-original-src="https://miro.medium.com/v2/resize:fit:438/format:webp/1*QLgpNXrF1vWTs0aZpzrvvw.png"/></div></figure><p id="25e9" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">接下来，我们必须把元部分在这里，我们可以输入信息，如描述，作者，日期等等。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ly"><img src="../Images/e475cf5e2f6b842abdeb98047a43a492.png" data-original-src="https://miro.medium.com/v2/resize:fit:1012/format:webp/1*qNHr2qbR9pElRMRK7ikhCA.png"/></div></figure><p id="6a03" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">注意:Yara有一个非常大的规则集，我将只列出最重要的规则，但是在文章的最后，我会给你留下文档的链接。</strong></p><p id="7131" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">请记住，字符串必须始终放在" "</p><p id="6351" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在是弦乐部分。<br/> Yara在这些文件上使用文件标识。</p><p id="0c69" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">对于外行来说，字符串是可以从二进制文件中读取的文本。</p><p id="5b0b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">以这个c++文件为例。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi lz"><img src="../Images/82dec7a93fab79be38d8a921c1bbe837.png" data-original-src="https://miro.medium.com/v2/resize:fit:526/format:webp/1*ZWhdxnMxO9qUnLMBlVbeBQ.png"/></div></figure><p id="96cc" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">一旦编译并执行，它将在控制台上打印“Hello”。</p><p id="3bf9" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如果我们在Linux上运行strings命令，我们可以看到字符串“Hello”。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ma"><img src="../Images/66db8e02415453eb3900f1adce6f2525.png" data-original-src="https://miro.medium.com/v2/resize:fit:1040/format:webp/1*Urc0T1r3aWo0earhAywNWA.png"/></div></figure><p id="ba46" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">注意:你肯定已经注意到了所有其他奇怪的字符串，不要担心它们是正常的，事实上它们是在编译时添加的。</strong></p><p id="5e07" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">让我们假设我们的文件是恶意软件，我们可以添加字符串hello，因为它允许我们识别我们的文件。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mb"><img src="../Images/0b8b1f64144f7dab3aa16990958fdb02.png" data-original-src="https://miro.medium.com/v2/resize:fit:1014/format:webp/1*LnaYzKNoQYHXvgNUxileZQ.png"/></div></figure><p id="879b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">注意:字符串需要$才能被声明。</strong></p><p id="339a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在我们做一些更难的事情。</p><p id="0253" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">每个文件在开头都有一个精确的字节序列，用来标识文件类型。</p><p id="eeec" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><a class="ae lw" href="https://en.wikipedia.org/wiki/List_of_file_signatures" rel="noopener ugc nofollow" target="_blank">文件签名列表—维基百科</a></p><p id="68f7" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">例如，Linux (ELF)中的可执行文件序列为7f 45 4c 46 02 01 01。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi mc"><img src="../Images/3c1c68e4f7460c4db4513493ffd96592.png" data-original-src="https://miro.medium.com/v2/resize:fit:1222/format:webp/1*K0O5ZHXz_5PG6fmj1EWIiQ.png"/></div></div></figure><p id="7e48" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">注意:在Windows (MZ)上是4D 5A。</strong></p><p id="87c7" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们可以添加这个十六进制数字序列来避免误报。</p><p id="a3cb" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">事实上，如果文件系统中有包含字符串“Hello”的txt文件或任何其他扩展名，如果我们不添加神奇的字节，就会被报告，这是我们不希望的。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mh"><img src="../Images/ebec7294098081b50414140ca449297f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1180/format:webp/1*Utptp93durzhJ4SGeA8esw.png"/></div></figure><p id="0256" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">注意:十六进制字符串必须放在{ }之间。</strong></p><p id="f495" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">最后一部分是条件部分。</p><p id="b4cb" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在这里，我们指定定位文件的条件。</p><p id="701f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">有几个关键词。</p><p id="188f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir"> And:两个条件都为真时为真。</strong></p><p id="d171" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">$first_string和$second_string</p><p id="0127" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">当两个字符串都存在时标识文件。</p><p id="4c7d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir"> Or:至少有一个在场时为真。</strong></p><p id="8078" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">$first_string或$second_string</p><p id="497c" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">当至少有第一个或第二个字符串时，它标识文件。</p><p id="71db" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">任何一个:仅当所有字符串都存在时为真。</strong></p><p id="88d9" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">让我们看一个例子。</p><p id="0a6a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们通过使用or操作符调用casual_string来声明一个无意义的字符串，由于存在字符串“hello ”,我们仍然能够定位该文件。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mi"><img src="../Images/29c86fa035355e6339c6efb7ad31ccea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1136/format:webp/1*GKzPiN3xPBxZa2YmRhf2oA.png"/></div></figure><p id="214c" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">另一个非常有用的关键字是“at ”,它用于检查字符串是否出现在指定的偏移量处。</p><p id="0b5b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">偏移量是从文件开始的距离，以字节为单位，因为魔术字节在文件的开始，所以偏移量为0。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi mj"><img src="../Images/2a0a817e40cef9db43cb5432fe880908.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xCfsWYYQ-sRONC91cb9ZAQ.png"/></div></div></figure><p id="c7b4" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在，让我们试着看看是否一切正常。让我们运行Yara，正如我们所看到的，这是我们的文件。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi mk"><img src="../Images/be76670a69b295e83d5d43c732c4074c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m7YVGyYT4Md_6Fo2O-Vqyg.png"/></div></div></figure></div><div class="ab cl lo lp hu lq" role="separator"><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt"/></div><div class="ij ik il im in"><p id="5b86" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如前所述，Yara是一个非常先进的工具，可能需要一整本书来描述它包含的所有功能，如果你感兴趣，我在这里留下了官方文档的链接。</p><p id="d86b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">欢迎来到YARA文档中心！— yara 4.2.0文档</p><p id="86e6" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我特别推荐看看这些模块，因为它们非常有用。</p></div><div class="ab cl lo lp hu lq" role="separator"><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt"/></div><div class="ij ik il im in"><h1 id="bdb5" class="ml mm iq bd mn mo mp mq mr ms mt mu mv jw mw jx mx jz my ka mz kc na kd nb nc bi translated">奖金:雅根</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/f0625d2806f16f852aea0ff2715433a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:608/format:webp/1*8jI9LdLnjwB_ZdZVQTMkXA.png"/></div></figure><p id="4033" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">随着时间的推移，恶意软件变得越来越复杂和不可预测，手动编写yara规则可能是一项非常困难的任务。</p><p id="84cd" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">为此，雅根来救我们了！</p><p id="2cb9" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><a class="ae lw" href="https://github.com/Neo23x0/yarGen" rel="noopener ugc nofollow" target="_blank">GitHub—neo 23 x 0/yarGen:yarGen是YARA规则的生成器</a></p><p id="2928" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">一旦安装完毕，我建议您使用以下命令。</p><pre class="kg kh ki kj gt ne nf ng nh aw ni bi"><span id="e043" class="nj mm iq nf b gy nk nl l nm nn">python3 yarGen.py -a "Your name" --excludegood -z 2 -m 'YourDirectory' -o Yourfile.yar</span></pre><ul class=""><li id="e39b" class="no np iq kt b ku kv kx ky la nq le nr li ns lm nt nu nv nw bi translated">-a:用于将作者的名字赋予规则。</li><li id="1b0e" class="no np iq kt b ku nx kx ny la nz le oa li ob lm nt nu nv nw bi translated">— excludegood: yarGen可能会将非恶意字符串放入规则中，为了避免这种情况，我们使用了此标志。</li><li id="364b" class="no np iq kt b ku nx kx ny la nz le oa li ob lm nt nu nv nw bi translated">-z: yarGen给字符串打分，分数越高，字符串越有可能是恶意的，为了避免误报，我们将最低分设为2。</li><li id="97bf" class="no np iq kt b ku nx kx ny la nz le oa li ob lm nt nu nv nw bi translated">-m:用于指定文件所在的目录。</li><li id="1951" class="no np iq kt b ku nx kx ny la nz le oa li ob lm nt nu nv nw bi translated">-o:用于输出文件。</li></ul><p id="092e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">注意:yarGen工作在目录上，而不是文件上，所以确保文件是目录中的唯一文件，以避免不便。还要记住，工具不能完全代替人，所以学习如何为自己手动编写规则也是很好的。</strong></p></div><div class="ab cl lo lp hu lq" role="separator"><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt"/></div><div class="ij ik il im in"><h1 id="3258" class="ml mm iq bd mn mo mp mq mr ms mt mu mv jw mw jx mx jz my ka mz kc na kd nb nc bi translated">结论</h1><p id="4877" class="pw-post-body-paragraph kr ks iq kt b ku oc jr kw kx od ju kz la oe lc ld le of lg lh li og lk ll lm ij bi translated">我希望这篇文章对您有所帮助，并帮助您更好地理解这个工具提供的潜力。</p><p id="6385" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我计划带来更多关于恶意软件分析的文章，因为我相信这是一个仍然没有得到足够重视的领域。</p><p id="ecb1" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">下一篇文章再见，再见伙计们！</p></div></div>    
</body>
</html>