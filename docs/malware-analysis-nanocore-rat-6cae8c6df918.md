# 恶意软件分析[#1]-纳米核心鼠

> 原文：<https://infosecwriteups.com/malware-analysis-nanocore-rat-6cae8c6df918?source=collection_archive---------0----------------------->

![](img/49a785cce47e580c26ca89c341f63465.png)

在恶意软件分析的这一系列文章中，我将从恶意软件市场[https://bazaar.abuse.ch/](https://bazaar.abuse.ch/)随机选取一个样本，我将在不知道它是什么的情况下分析它，(黑盒)方法。

让我们开始吧…

我们今天的例子:MD5(5846 c 3588 FBC F6 a 5078 b7a 2413 da 0345)。

![](img/ec4aac3c1858dc9fed3d87398076900e.png)

## 恶意软件构成:

该示例由以下组件组成:

![](img/84b71fe42ffcc17a5fe5313fd711ab0f.png)![](img/a8d07e8e1cf2688188d56691ca877fa3.png)

## 1605 f 0 e 74 c 7088 b 8 a2 ca 7190 b 71 c 83 F8 DC 0381 e 57d 817 df 3530 BDA 4 AC 5737511 . exe 的静态分析:

将样本上传到 PEStudio，我们看到它是 32 位高熵可执行文件，并使用 NSIS(Nullsoft Scriptable Install System)——这是一个创建 windows 安装程序的专业开源系统——来删除/重写新文件/可执行文件，它还有一个很旧的编译日期，可能是假的，我面对的是 ghost 恶意软件的样本，而不是以前使用相同的技术来安装恶意软件组件:

![](img/4946a0b21dccad031db6813d5a4f469b.png)

PEStudio

![](img/c846198b4322eb2c958e84b9f4a58e03.png)

PEStudio:覆盖

![](img/a9c186dea53dd95247dc2822abd0aa12.png)

PEbear:覆盖 Nullsoft 标头

解压缩 NSIS 包时，我们得到 4 个文件，一个是可执行文件，两个可能是外壳代码或加密文件，最后是 NSIS 脚本:

## 1605 f 0 e 74 c 7088 b 8 a2 ca 7190 b 71 c 83 f 8 DC 0381 e 57d 817 df 3530 BDA 4 AC 5737511 . exe 的动态分析:

运行此示例时，我们发现它会在%TEMP%文件夹中创建三个文件，然后写入每个文件，还会在%TEMP%文件夹中创建一个文件夹，每次都使用随机名称，并保持其为空:

*   ccgkcf.exe。
*   ka9zcqw3l6l48a1uuba。
*   cmdkuqqy。
*   ns*****。tmp。(最后五个字母在每次执行时都会改变)

![](img/1a61d97fbcb40938c853f64a4347a7b9.png)

Procmon:创建 **ka9zcqw3l6l48a1uuba** 并写入其中。

![](img/1051d9d76bbd5376ba8904c30c846305.png)

Procmon:创建 **cmdkuqqy** 并写入其中。

![](img/65f6f6d1e61d864500b770c598576f83.png)

Procmon:创建**ccgkcf.exe**并写入其中。

![](img/03f6e2903e9780b4d4bfbe406c7f50bb.png)

Procmon:正在创建 ns*****。tmp。

在调试器下，我们可以看到它正在创建一个新进程，使用命令行启动 **"ccgkcf.exe"** ，使用文件" **cmdkuqqy"** 作为参数，然后退出该进程:

![](img/68f0484a445c289bce81c8a30d6515a9.png)

x64dbg:创建流程

## ccgkcf.exe 的静态分析:

![](img/81c449a68f904b5e6fd681e7e6258184.png)

PEStudio:一般信息

它是一个 32 位可执行文件，具有新的编译和调试日期，将其上传到 **IDA** 我们看到它正在获取命令行参数，并尝试使用“CreateFileW”打开一个文件，如果该函数失败，它将退出，如果成功，它将获取文件大小，为该文件分配内存并读取它，然后继续解密从该文件读取的数据，然后跳转到该文件，这意味着它是一个外壳代码:

![](img/196198c9304fc785c0bd9ff3c28926a2.png)

IDA:ccgkcf.exe

![](img/844d36ead95318556f1c9ecb9a61a85a.png)

伊达:解密函数

## ccgkcf.exe 的动态分析:

如前所述，在没有任何参数的情况下运行该实例时，进程将退出，并且不会采取任何操作，但是当添加" **cmdkuqqy"** 作为参数时，正如我们看到的安装程序在创建新进程时所做的那样，该示例通过打开" **cmdkuqqy** "文件来继续其工作，获取其大小，读取并解密它，最后将执行处理为外壳代码:

![](img/3628a13a9cf81dbf30dd72ff714e5002.png)

x64dbg:找不到错误路径

![](img/632b47118e313bf45fddf44a95110be2.png)

x64dbg:添加参数的命令

![](img/fcb4a10255a5b530939d6179120e9664.png)

x64dbg:功能成功

![](img/7ab592493e235b7a7123199b811b60fb.png)

十六进制比较

![](img/87ff976f2c5cd4ac0eacd30595852434.png)

x64dbg:解密后跳转

shell 代码从加载库和导入模块开始，然后将下面的名字一个字母一个字母地推到内存中:

*   ka9zcqw3l6l48a1uuba。
*   ratotpvvsmo.exe。
*   gswccl。
*   hhtktvn。

之后，它从%TEMP%文件夹中打开" **ka9zcqw3l6l48a1uuba"** 文件以获得它的句柄，然后获得文件大小，分配内存，读取文件并解密从文件中读取的数据，因此我将它转储到一个文件中以供稍后分析:

![](img/fadfa9741231b63a4beb33b4c1bf1b41.png)

接收从文件" **ka9zcqw3l6l48a1uuba** 中读取的数据的缓冲区

![](img/1d241eb47b1007249ee34fd9cf8beeff.png)

x64dbg:解密数据后

之后，它在“C:\<USER>\ AppData \ Roaming”中创建一个名为“ **gswccl** 的文件夹，并在其中创建一个名为“**ratotpvvsmo.exe**的文件，并通过更改注册表“HKCU \软件\微软\Windows\CurrentVersion\Run”中名为“ **hhtktvn** ”的自动运行值，将该文件用作持久性技术:

![](img/72c35332b23f724106757eafdc65c1df.png)

注册表新值；快照的可执行文件路径已更改

通过快速查看" **ratotpvvsmo.exe"** ，我们看到它是 **"ccgkcf.exe "可执行文件的副本:**

![](img/6bc50c6d2fe700001a9e9878b7909898.png)

HashCalc:ccgkcf.exe 和 ratotpvvsmo.exe 的比较

**继续分析，我们看到它用自己的名字创建了一个新的进程，并将从" **ka9zcqw3l6l48a1uuba** "文件中解密的代码注入其中，然后退出该进程**

**![](img/a5490b5ee390410fb10f8fea1244e6af.png)**

**Procmon:进程注入**

**值得一提的是，它使用了“Havens gate”技术，这是指远返回，切换到 64 位模式，也可以作为一种反逆向工程技术，以保护恶意软件。**

## **ka9zcqw3l6l48a1uuba 的静态分析。解密:**

**上传这个实例到 PEStudio，我们看到它是 32 位高熵可执行文件，新的编译和调试日期也有一个可执行资源。从 IDA 中，我们发现这个实例将从资源中加载可执行文件并退出进程。**

**![](img/01695e60213d3824256bb678f74106bf.png)**

**PESutdio:ka 9 zcqw3l 6l 48 a 1 uuba . decrypted 一般信息**

**![](img/1b74dc69e1a066ea631ad3f8eafe6dc2.png)**

**IDA:加载资源文件**

**我使用“**resource hacker”**在 x64dbg 中检查完资源文件后将其删除**

## **资源文件的静态分析(NanoCore Rat):**

**![](img/95c3ef79e17c2b198b2f07c06ccd2e87.png)**

**纳米核心鼠一般信息**

**上传资源文件，看起来是的。NET 可执行文件，当查看该可执行文件的导入或字符串时，有一个很大的哈希导入列表，重要的是，我发现了一个 NanoCore ascii 字符串，当将文件上传到 dnSpy 时，我们可以看到它被严重混淆:**

**![](img/6bc4be250d1c813a298566b66bfd8208.png)**

**纳米核心鼠串**

**![](img/7b21906110f952da25cd9a2f3f9b72e5.png)**

**dnSpy: NanoCore 客户端混淆实例**

## **资源文件的动态分析(NanoCore Rat):**

**运行 NanoCore 时，它会在“< **用户> \AppData\Roaming** ”文件夹中创建一个文件“ **run.dat** ”。它还尝试连接到 C2 服务器，下面是 DNS 请求的快照和关于该域的信息:**

**![](img/041562c740120ff2a1cf6e812e6d9e13.png)**

**WireShark:为域发送了 DNS 请求**

**![](img/cd39fb79090c96e24f6e32bf9c75d7ff.png)**

**领域信息**

## **雅拉规则和签名:**

**![](img/24be6c1809a247246188305c2247b443.png)**

****防逆转技术:****

*   **IsDebuggerPresent。**
*   **远归(天堂之门)。**
*   **混淆视听。**

****链接:****

*   **[https://bazaar . abuse . ch/sample/1605 f 0e 74 c 7088 b 8 a2 ca 7190 b 71 c 83 f 8 DC 0381 e 57d 817 df 3530 BDA 4 AC 5737511/](https://bazaar.abuse.ch/sample/1605f0e74c7088b8a2ca7190b71c83f8dc0381e57d817df3530bda4ac5737511/)**
*   **[https://www . virus total . com/GUI/file/1605 f 0e 74 c 7088 b 8 a2 ca 7190 b 71 c 83 f 8 DC 0381 e 57d 817 df 3530 BDA 4 AC 5737511/detection/f-1605 f 0e 74 c 7088 b 8 a2 ca 7190 b 71 c 83 f 8 DC 0381 e 57d 817 df 3530 BDA 4 AC 5737511](https://www.virustotal.com/gui/file/1605f0e74c7088b8a2ca7190b71c83f8dc0381e57d817df3530bda4ac5737511/detection/f-1605f0e74c7088b8a2ca7190b71c83f8dc0381e57d817df3530bda4ac5737511-1648116728)**
*   **[https://www.flaticon.com/free-icons/trojan](https://www.flaticon.com/free-icons/trojan)**

## **来自 Infosec 的报道:Infosec 每天都有很多内容，很难跟上。[加入我们的每周简讯](https://weekly.infosecwriteups.com/)以 5 篇文章、4 个线程、3 个视频、2 个 Github Repos 和工具以及 1 个工作提醒的形式免费获取所有最新的 Infosec 趋势！**