<html>
<head>
<title>[DOM based XSS] Or why you should not rely on Cloudflare too much</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">[基于DOM的XSS]或者为什么您不应该过于依赖Cloudflare</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/dom-based-xss-or-why-you-should-not-rely-on-cloudflare-too-much-a1aa9f0ead7d?source=collection_archive---------0-----------------------#2018-11-14">https://infosecwriteups.com/dom-based-xss-or-why-you-should-not-rely-on-cloudflare-too-much-a1aa9f0ead7d?source=collection_archive---------0-----------------------#2018-11-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><h1 id="5b87" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">序</h1><p id="cd49" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">于是我又在一个虫子赏金项目里找到了另一个XSS。网站<em class="lj">【redacted.com】</em>受Cloudflare WAF保护，因此许多有效载荷被过滤。但是网站实现方式极其糟糕，连Cloudflare都保护不了。</p><p id="4370" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">就在我发现这个漏洞的前几天，我在一次内部会议上告诉我的同事<strong class="kn ir">“不要太依赖防火墙/安全产品”</strong>。现在我有一个真实的例子要讲。LOL。</p><h1 id="b2d1" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">摘要</h1><p id="8155" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">当我在登录页面上触发一个错误时，一个名为<strong class="kn ir">的参数Message </strong>被反映在html的主体和一个弹出框中(即“Message”的值被插入到javascript中，就在alert(“[value _ here]”)中，没有经过过滤)。所以我可以在脚本中插入任何我喜欢的东西。</p><p id="1927" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">有效载荷:</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="8111" class="ly jo iq lu b gy lz ma l mb mc">This is an outdated page. You will now be redirected to our new page"); window.location="https://google.com"//</span></pre><figure class="lp lq lr ls gt me gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi md"><img src="../Images/fb15a0f65a80dad4b040cbe0d86f9c6f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*F6MUze-_PCnp2WUV"/></div></div></figure><p id="4c65" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">因此，我们可以欺骗用户，让他们进入更新后的网页并再次登录。(此处重定向至google进行演示)</p><h1 id="b2fb" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">我是怎么找到它的</h1><p id="9d00" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">事实上，我正在检查他们的注册和登录功能，并试图找到一些应用程序的缺陷。我在没有验证的情况下用电子邮件<em class="lj">a@a.com</em>注册了一个账户，并试图用同一个电子邮件再次注册。然后弹出一条错误消息:</p><figure class="lp lq lr ls gt me gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi md"><img src="../Images/a34a8db5264387c3989b0b9f0c718d03.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*vh1lx2r8nmBadvpS"/></div></div></figure><p id="2f64" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">我发现网址变成了</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="28c5" class="ly jo iq lu b gy lz ma l mb mc"><a class="ae ml" href="https://redacted.com/Secure/Login.aspx?UserID=a@a.com&amp;ReturnUrl=&amp;Message=The" rel="noopener ugc nofollow" target="_blank">https://redacted.com/Secure/Login.aspx?UserID=a@a.com&amp;ReturnUrl=&amp;Message=The</a> E-Mail Address entered (a@a.com) is already on file. If this is your correct e-mail address, you may sign in as an existing customer.</span></pre><p id="3355" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">与弹出框中的内容和顶部显示的文本完全相同:</p><figure class="lp lq lr ls gt me gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi md"><img src="../Images/a57f124fc2e42122d1c2e4a2dfc6a73f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*QIAX3_z-2ZOBHuvg"/></div></div></figure><p id="5eca" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">因此，消息可能反映在HTML的主体中。我尝试了直接<script>警报(1) </script>有效载荷。</p><p id="d46d" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">然后我得到了这个:</p><figure class="lp lq lr ls gt me gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi md"><img src="../Images/12adc2ebb41ef038574806f3aa8a4c49.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*RHh_XLgqrbroXhTd"/></div></div></figure><p id="3e42" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">哎呀。云闪。但这在我的预料之中🙂。有效载荷是给假人的。</p><p id="9e71" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">我注意到消息被直接插入到javascript中:</p><figure class="lp lq lr ls gt me gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi md"><img src="../Images/abef24c09f94beb2d5900c68283686ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*a5O7UDCfKTF_UHTY"/></div></div></figure><p id="31b7" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">所以我们能做的是关闭双引号和括号，就像</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="71ff" class="ly jo iq lu b gy lz ma l mb mc">alert("<strong class="lu ir"><em class="lj">something_here");evil_script_here// </em></strong>")</span></pre><p id="6f36" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">然后我们可以做任何我们想做的事。</p><p id="aa42" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">好的防火墙不能保存坏的代码。就是这样。感谢阅读。</p></div></div>    
</body>
</html>