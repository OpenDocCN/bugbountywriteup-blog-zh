<html>
<head>
<title>OpenEMR 5.0.1.3 — (Authenticated) Arbitrary File Actions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">OpenEMR 5.0.1.3—(经过身份验证的)任意文件操作</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/openemr-5-0-1-3-authenticated-arbitrary-file-actions-f7006e636b8c?source=collection_archive---------3-----------------------#2020-11-17">https://infosecwriteups.com/openemr-5-0-1-3-authenticated-arbitrary-file-actions-f7006e636b8c?source=collection_archive---------3-----------------------#2020-11-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/75703256fcce4f9a83d2eabdcee637df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*3Xn66WycL49MnYfF.png"/></div></div></figure><p id="13bd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">回到2018年，我和一群安全研究人员决定在OpenEMR上一试身手，寻找安全漏洞。完整报告可在<a class="ae kw" href="https://www.open-emr.org/wiki/images/1/11/Openemr_insecurity.pdf" rel="noopener ugc nofollow" target="_blank">这里</a>找到。这是一本非常好的读物，我推荐完整阅读。然而这篇博文只是记录了我对这个项目的贡献。以下是我在合作中收到的三份简历。这些都是负责任地披露和修补，所以升级到最新版本将是明智的。</p><p id="1e43" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">1.CVE-2018–15140-验证任意读取</p><p id="92e2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">易受攻击的代码:</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="8991" class="lg lh iq lc b gy li lj l lk ll">if ($_POST['mode'] == 'get'){<br/>     echo file_get_contents($_POST['docid']);<br/>     exit;<br/>  }</span></pre><p id="82ae" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这是一个漏洞，使得攻击者能够在未打补丁的OpenEMR实例上向/portal/import_template.php发出恶意请求。该请求的结果是对位于文件系统上的本地文件的任意文件读取。如果将参数模式设置为get作为其值，则由于应用程序将用户输入传递到file_get_contents()而不进行任何清理，因此可能存在此漏洞。这个输入的结果是本地文件，然后在html响应中回显。</p><p id="3322" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">2.CVE-2018–15142-验证任意写入</p><p id="374f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">易受攻击的代码:</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="0a0a" class="lg lh iq lc b gy li lj l lk ll">} else if ($_POST['mode'] == 'save') {<br/>    file_put_contents($_POST['docid'], $_POST['content']);<br/>    exit(true);<br/>}</span></pre><p id="fe88" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这是/portal/import_template.php中的一个漏洞，使得攻击者能够将php文件写入本地文件系统。如果参数模式设置为保存，则此操作有效。如果是这种情况，post参数docid和content将被传递给file_put_contents()，而不进行任何清理。docid是文件名，内容包括恶意php代码。这本身并没有太大的影响，因为您无法执行该文件，但当与以前发现的任意文件读取配对时，会导致远程代码执行。</p><p id="b497" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">3.CVE-2018–15141-已验证的任意文件删除</p><p id="c329" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">易受攻击的代码:</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="7626" class="lg lh iq lc b gy li lj l lk ll">} else if ($_POST['mode'] == 'delete') {<br/>     unlink($_POST['docid']);<br/>     exit(true);<br/> }</span></pre><p id="40df" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这也是/portal/import_template.php中的一个漏洞，使得攻击者能够删除系统中的任何文件，如果文件名已知并且允许删除的权限。当post参数模式设置为删除时，这是可能的。然后将包含攻击者指定的文件名的docid参数传递给unlink()，而不进行清理。</p><p id="cd7f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">谢谢你的阅读，希望你喜欢。您可以在ExploitDB、<a class="ae kw" href="https://www.exploit-db.com/exploits/45202" rel="noopener ugc nofollow" target="_blank">这里</a>找到其中任何一个的概念证明。你也可以在这里或者我的博客<a class="ae kw" href="https://jsecu.github.io" rel="noopener ugc nofollow" target="_blank"> https://jsecu.github.io </a>上阅读CTF和bug bounty的文章。如果您有任何问题，请随时在Twitter上给我发消息，地址是@Pullerze。更多的Bug奖励和安全报道即将推出！</p></div></div>    
</body>
</html>