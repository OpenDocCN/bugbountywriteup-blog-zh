<html>
<head>
<title>WS-2016-7107: CSRF tokens in Spring and the BREACH attack</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">WS-2016-7107:春天的CSRF令牌和缺口攻击</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/ws-2016-7107-csrf-tokens-in-spring-and-the-breach-attack-4394b10d1b8?source=collection_archive---------2-----------------------#2021-04-14">https://infosecwriteups.com/ws-2016-7107-csrf-tokens-in-spring-and-the-breach-attack-4394b10d1b8?source=collection_archive---------2-----------------------#2021-04-14</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="98d2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最近，WhiteSource security scanner开始针对基于Spring的应用程序报告WS-2016-7107。这是2016年报道的春安老<a class="ae ko" href="https://github.com/spring-projects/spring-security/issues/4001" rel="noopener ugc nofollow" target="_blank">问题</a>。不幸的是，在写这篇文章的时候，这个问题还没有解决。但是有一个<a class="ae ko" href="https://github.com/spring-projects/spring-security/pull/8082" rel="noopener ugc nofollow" target="_blank">拉请求</a>可以解决这个问题。问题是Spring Security生成的CSRF令牌容易受到<a class="ae ko" href="http://breachattack.com/" rel="noopener ugc nofollow" target="_blank">漏洞</a>攻击。这一攻击甚至更早——发表于2013年。违规攻击类似于犯罪攻击，但违规不需要TLS压缩。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="gh gi kp"><img src="../Images/e14ad873b5d49c4be0a38e13155a1265.png" data-original-src="https://miro.medium.com/v2/resize:fit:966/format:webp/0*ciVGrFHUgbVff5uN.png"/></div></figure><p id="1cd7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">成功的攻击有几个条件:</p><ol class=""><li id="31ef" class="kx ky it js b jt ju jx jy kb kz kf la kj lb kn lc ld le lf bi translated">攻击者应该能够在受害者的请求中插入部分选择明文(这通常称为选择明文攻击模型)。</li><li id="1b10" class="kx ky it js b jt lg jx lh kb li kf lj kj lk kn lc ld le lf bi translated">攻击者应该能够观察到来自受害者的加密流量。</li><li id="e703" class="kx ky it js b jt lg jx lh kb li kf lj kj lk kn lc ld le lf bi translated">应该启用HTTP压缩。</li></ol><p id="7570" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">TLS配置无所谓。在基于Spring的应用程序中，成功的攻击允许攻击者恢复受害者的CSRF令牌。WS-2016-7107就是这么回事。</p><p id="a26e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这个问题似乎得到了相当多的关注，因为WhiteSource针对几乎所有使用Spring Framework的应用程序报告了这个问题。看看GitHub上原刊<a class="ae ko" href="https://github.com/spring-projects/spring-security/issues/4001" rel="noopener ugc nofollow" target="_blank">链接白源报道</a>的数量。这只是GitHub上使用WhiteSource的项目。更糟糕的是，这个问题仍未解决。因此，仅仅通过修改Spring Security的版本是不可能在应用程序中解决这个问题的。此外，如果建议的修复被接受，它可能只会在Spring Security的下一个主要更新中发布，因为该修复更新了公共API。</p><p id="bdf1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">看起来完全消除违规攻击风险的最可靠方法是确保HTTP压缩被禁用。好消息是，在最新版本的Spring Boot中，HTTP压缩被默认禁用。除非应用程序将属性<code class="fe ll lm ln lo b">server.compression.enabled</code>设置为<code class="fe ll lm ln lo b">true</code>，否则破坏攻击应该是不可能的。当然，最好是在not:</p><pre class="kq kr ks kt gt lp lo lq lr aw ls bi"><span id="37e6" class="lt lu it lo b gy lv lw l lx ly">GET /path/to/something<br/>HTTP/1.1 Host: test.server.com<br/>Accept-Encoding: gzip, deflate</span></pre><p id="f38b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">下面是你如何用<code class="fe ll lm ln lo b">curl</code>做到这一点:</p><pre class="kq kr ks kt gt lp lo lq lr aw ls bi"><span id="4c47" class="lt lu it lo b gy lv lw l lx ly">curl -v -H "Accept-Encoding: gzip, deflate" <a class="ae ko" href="https://test.server.com/path/to/something" rel="noopener ugc nofollow" target="_blank">https://test.server.com/path/to/something</a></span></pre><p id="cf2d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果服务器返回带有支持的压缩方法列表的Content-Encoding头，那么HTTP压缩是打开的。维基百科有一个这样回应的例子。否则，HTTP压缩关闭。</p><p id="d6b3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果必须打开HTTP压缩，可能还有另一个选项。该应用程序可以实现一个自定义的<code class="fe ll lm ln lo b">CsrfTokenRepository</code>，该自定义的<code class="fe ll lm ln lo b">CsrfTokenRepository</code>将未发布的<a class="ae ko" href="https://github.com/spring-projects/spring-security/pull/8082" rel="noopener ugc nofollow" target="_blank">补丁</a>应用于Spring安全。不过我还没有测试过这个选项。</p><p id="8fdb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">让我们希望这个问题将很快在春季安全中得到解决。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><p id="0136" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="mg">原载于2021年4月14日</em><a class="ae ko" href="https://blog.gypsyengineer.com/en/security/csrf-tokens-in-spring-and-the-breach-attack.html" rel="noopener ugc nofollow" target="_blank"><em class="mg"/></a><em class="mg">。</em></p></div></div>    
</body>
</html>