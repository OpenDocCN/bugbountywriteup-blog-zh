<html>
<head>
<title>Malware Analysis 101 — Emotet MalDoc behavioral approach</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">恶意软件分析101 — Emotet MalDoc行为方法</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/malware-analysis-101-emotet-maldoc-a-behavioral-approach-af69e40f708d?source=collection_archive---------0-----------------------#2020-10-08">https://infosecwriteups.com/malware-analysis-101-emotet-maldoc-a-behavioral-approach-af69e40f708d?source=collection_archive---------0-----------------------#2020-10-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="7b7e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">距离我上次写关于安全的文章已经有一段时间了，但是这次我带着我的新爱好回到了我热爱的低级安全领域，恶意软件分析。这篇文章是两篇文章的迷你系列的一部分，我将演示我是如何从恶意下载者到未打包版本的Emotet僵尸网络样本的，完全是靠运气。</p><p id="1a93" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">简介</strong></p><p id="9367" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我真的不认为我应该进一步解释Emotet是什么，我可以用一个短语将其命名为“一个即使撒旦也会失去他-她的银行账户的银行特洛伊木马/机器人”。要进一步了解Emotet是什么，你可以观看下面这个令人惊叹的动画视频:</p><figure class="kl km kn ko gt kp"><div class="bz fp l di"><div class="kq kr l"/></div><figcaption class="ks kt gj gh gi ku kv bd b be z dk translated">Emotet解释得很快</figcaption></figure><p id="19b7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们开始写吧:</p><pre class="kl km kn ko gt kw kx ky kz aw la bi"><span id="c776" class="lb lc iq kx b gy ld le l lf lg">Sample Characteristics <br/>MD5 =&gt; 7ab1d4fac08b7210c03058626a4ad49d<br/>SHA-1 =&gt; e918b7e867769884cded21f22acbf03a996e51d2<br/>SHA-256 =&gt; af5d152ec16da716f758d26ad30f58ec6bf0082e5ccc5db9b93d93a75c666718<br/>Vhash =&gt; 567c96ecc686ef1e7be0fc55d286c129<br/>SSDEEP =&gt; 1536:CJ0ZsWTJ0ZsWirdi1Ir77zOH98Wj2gpngR+a9+Q54LW056:5rfrzOH98ipga+qD56<br/>File type<br/>MS Word Document</span></pre><p id="0bd6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">病毒总数:</p><div class="lh li gp gr lj lk"><a href="https://www.virustotal.com/gui/file/af5d152ec16da716f758d26ad30f58ec6bf0082e5ccc5db9b93d93a75c666718/detection" rel="noopener  ugc nofollow" target="_blank"><div class="ll ab fo"><div class="lm ab ln cl cj lo"><h2 class="bd ir gy z fp lp fr fs lq fu fw ip bi translated">病毒总数</h2><div class="lr l"><h3 class="bd b gy z fp lp fr fs lq fu fw dk translated">病毒总数</h3></div><div class="ls l"><p class="bd b dl z fp lp fr fs lq fu fw dk translated">VirusTotalwww.virustotal.com</p></div></div></div></a></div><p id="752d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> README.txt —免责声明</strong></p><p id="73f0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">以下文章中执行的每个任务都是在Windows虚拟机上执行的，请不要将您的主要操作系统用作恶意软件分析实验室。此外，如果您选择按照写的内容操作，并最终导致机器、网络等受到感染，那么作者不承担任何责任。如果你选择实际遵循这篇文章，我认为如果事情出错，你可以采取必要的行动来保护自己和你的网络。</p><p id="b943" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">传播与规避</strong></p><p id="609f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Emotet通常使用maldocs(恶意文档)进行传播，如上所述，这些通常是Microsoft Office文件(例如MS-Word、MS-Excel等)，它们具有武器化的Visual Basic脚本，可将恶意可执行文件下载、安装并运行到目标计算机。我想，你会想到的第一个问题是,. doc文件为什么/如何运行VB-Script。原因是因为微软办公套件的所有程序中都嵌入了解释器来执行任务，例如提供有用的功能(例如在Excel中计算统计模型等)。)，但是他们说的好事不出门，也是真的。由于有了VB-Script解释器，恶意的开发人员可以利用它的功能编写一个脚本，将恶意代码传递给操作系统(使用PowerShell命令)。从VB-Script下载并运行病毒的角度来看，我们能做的阻止感染的事情有限。</p><p id="50e5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">获取代码</strong></p><p id="50a4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通过打开。我可以有把握地假设它是恶意的，但要证明我的假设是正确的，我需要更多的证据，所以我必须深入挖掘。为此，我必须获得宏的代码，我可以尝试使用MS-Word环境中“视图”选项卡上的“宏”选项来获得它，或者使用oletools(更具体地说是olevba ),这是一个对OLE2(基本上是Microsoft Office)文件执行各种操作的工具集。</p><figure class="kl km kn ko gt kp gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi lt"><img src="../Images/2768281cbd09d89df700641e9f27bcfe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4BrVDPqGi-U2nyYQAANhxA.png"/></div></div><figcaption class="ks kt gj gh gi ku kv bd b be z dk translated">恶意文件正试图对我们进行社会工程，以启用武器化宏。</figcaption></figure><p id="6d18" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">按照下面的链接安装oletools</p><div class="lh li gp gr lj lk"><a href="https://github.com/decalage2/oletools/wiki/Install" rel="noopener  ugc nofollow" target="_blank"><div class="ll ab fo"><div class="lm ab ln cl cj lo"><h2 class="bd ir gy z fp lp fr fs lq fu fw ip bi translated">十堰2/工具</h2><div class="lr l"><h3 class="bd b gy z fp lp fr fs lq fu fw dk translated">运行oletools的推荐Python版本是最新的Python 3.x(目前为3.7)。Python 2.7仍然受支持…</h3></div><div class="ls l"><p class="bd b dl z fp lp fr fs lq fu fw dk translated">github.com</p></div></div><div class="ma l"><div class="mb l mc md me ma mf ly lk"/></div></div></a></div><p id="9842" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因为我很懒，我只想尽快完成工作，所以我选择了第二个选项，使用olevba从OLE文件中提取Visual Basic脚本。</p><figure class="kl km kn ko gt kp"><div class="bz fp l di"><div class="mg kr l"/></div></figure><figure class="kl km kn ko gt kp gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi mh"><img src="../Images/c11cf9a82f610cfe70e7671f02d6ba31.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6AOdDGFFgSXsSoCsDD56hw.png"/></div></div><figcaption class="ks kt gj gh gi ku kv bd b be z dk translated">运行olevba的最终报告</figcaption></figure><p id="0142" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如你从上面的输出中看到的，运行olevba给了我高度混乱的代码，它也给了我一些额外的信息，脚本可能会自动执行一些东西。在这一点上，我有两个选择来深入挖掘，一个是对脚本进行逆向工程，这是缓慢但安全的，成功率很高，另一个是对它进行行为分析，这在某些情况下可能有风险，如果它很安静，我们可能不会发现任何东西，但过程很快。因为我知道这个脚本会尝试运行一个PowerShell命令，猜测这是一个病毒下载安装程序，所以我选择了第二个选项。</p><p id="ecf4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">对MalDoc进行行为分析</strong></p><p id="e985" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要在Windows机器上执行行为分析，您需要我们称之为“监控信标”的东西，这些基本上是在受感染机器上运行的监控工具，用于监控不同的攻击面，可以是网络和/或正在运行的进程(内存)。为了监控它们，我们需要我们的老朋友WireShark和ProcMon。这是两个功能强大的工具，基本上是监控将被感染的机器所需的最低要求。</p><pre class="kl km kn ko gt kw kx ky kz aw la bi"><span id="6f3f" class="lb lc iq kx b gy ld le l lf lg">TIP: A small tip that OALabs taught me, about these two is to rename their icons to something random (e.g. somethingrandom.exe) on the Desktop (and not only there) since a lot of the malwares in the wild check if their default names are present in the target system and if that's true the viruses remain dormant. In this case we don't have to face a malware (yet) but it's a good practice in general.</span></pre><p id="be17" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因为我设置了这两个，所以我必须在MalDoc中运行宏来看看它是如何工作的。按下“启用宏”按钮后的一秒钟，我终于看到了想要的输出。就是一个GET请求从这下载一个PE文件(被黑了？)网站。我的假设是正确的，它是恶意的。</p><pre class="kl km kn ko gt kw kx ky kz aw la bi"><span id="c228" class="lb lc iq kx b gy ld le l lf lg">http://intasistemas.com/cgi-bin/mTQls3</span></pre><figure class="kl km kn ko gt kp gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi mi"><img src="../Images/9f802f86ac23a5a6f96b7cd169a28bec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tSdqPJ1cznvYQeFE-D7kJA.png"/></div></div><figcaption class="ks kt gj gh gi ku kv bd b be z dk translated">执行了恶意VB脚本的GET请求和一些回复行。</figcaption></figure><p id="5d55" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以确认这下载了一个可移植的可执行文件，因为我们可以看到特征字符串:</p><pre class="kl km kn ko gt kw kx ky kz aw la bi"><span id="96ac" class="lb lc iq kx b gy ld le l lf lg">"MZ" which are the magic bytes of a PE file (4D 5A) and "This program cannot be run in DOS mode."</span></pre><p id="96ae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是PE文件的神奇字节和包含在大多数PE文件中的字符串。同样从<em class="mj">保活连接报头中，</em>我们知道其他请求将会关注同一个流。</p><figure class="kl km kn ko gt kp gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi mk"><img src="../Images/b8473b3e8d2473332608152c1bdbb7bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cdZd-h8KDMA8HGyvg2swNw.png"/></div></div><figcaption class="ks kt gj gh gi ku kv bd b be z dk translated">从IP地址107.161.177.229下载PE文件的数据流</figcaption></figure><p id="990b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在ProcMon端，除了一个名为CharMapX.exe的新运行进程之外，我们看不到任何奇怪的东西，我猜这是VB脚本的命令注入下载并执行的运行病毒。但那时我认为这无关紧要，我只想找到可执行文件本身。我关闭了我的虚拟机，将它恢复到我之前拍摄的干净快照。剩下的工作就是访问该站点并下载可执行文件以供进一步研究(第2部分)。</p><figure class="kl km kn ko gt kp gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi ml"><img src="../Images/a9e665b2f44171937cec6d928a2a0ffd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Yy4U4gede5iAIvseNp_DFg.png"/></div></div><figcaption class="ks kt gj gh gi ku kv bd b be z dk translated">使用浏览器下载恶意可执行文件。</figcaption></figure><p id="758a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正在上传。我敢肯定这是臭名昭著的Emotet病毒。</p><figure class="kl km kn ko gt kp gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi mm"><img src="../Images/3c457209f3fd59b882699f97985c2d93.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zcdRHUZeu1b09ORjwoJSsg.png"/></div></div><figcaption class="ks kt gj gh gi ku kv bd b be z dk translated">它被58种抗病毒病毒认为是恶意的和/或情绪化的。</figcaption></figure></div></div>    
</body>
</html>