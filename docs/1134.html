<html>
<head>
<title>Password Reset Token Leak via X-Forwarded-Host</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">密码重置令牌通过X-Forwarded-Host泄漏</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/password-reset-token-leak-via-x-forwarded-host-4ed3e33dca31?source=collection_archive---------0-----------------------#2021-02-26">https://infosecwriteups.com/password-reset-token-leak-via-x-forwarded-host-4ed3e33dca31?source=collection_archive---------0-----------------------#2021-02-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="d4f4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">大家好，</p><p id="9848" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我是<a class="ae kl" href="https://twitter.com/saajanbhujel" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir">萨扬·布杰尔</strong> </a>。</p><p id="f471" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">商学学士(B.Com)的学生，我也是一名昆虫赏金猎人。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/00772a5f84a8377fee4619201ee5d946.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ewxn1Fk0xz6akbc2Vd85UQ.png"/></div></div></figure><p id="f4ff" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是我的第一篇博客，如果你发现任何拼写错误，请耐心听我说几分钟。这个博客是关于一个漏洞的，我在黑客的私人程序中发现了这个漏洞，它允许我接管任何用户的账户。但是在开始这篇博客之前，我想提供一些关于主机头的基本信息。</p><h2 id="4759" class="ky kz iq bd la lb lc dn ld le lf dp lg jy lh li lj kc lk ll lm kg ln lo lp lq bi translated">什么是HTTP主机头？</h2><p id="5231" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">从HTTP/1.1开始，HTTP主机标头是强制的请求标头。它指定了用户想要访问的域名。</p><p id="00fa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">例如，如果一个用户访问https://example.com的<strong class="jp ir"/>，那么他们的浏览器将发出一个包含如下主机头的请求:</p><blockquote class="lw lx ly"><p id="2a5f" class="jn jo lz jp b jq jr js jt ju jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj kk ij bi translated">GET / HTTP/1.1</p><p id="25e4" class="jn jo lz jp b jq jr js jt ju jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj kk ij bi translated">主持人:example.com</p></blockquote></div><div class="ab cl md me hu mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="ij ik il im in"><p id="f7c7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在让我们开始写博客吧…</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi mk"><img src="../Images/714f936500ebce20aa3210cbfb42123f.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/1*fcwLWixk10G27dEqiHOM-Q.gif"/></div></figure><p id="9dc3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">几天前，我在Hackerone上收到通知，说我被邀请参加一个私人项目。所以我接受了邀请，开始寻找那个私人项目。在开始搜索那个私人程序时，我花了5-6天时间寻找跨站点脚本(XSS)、IDOR、SQL注入、登录页面缺陷、信息泄露和子域接管，但仍然什么也没找到。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi ml"><img src="../Images/8bc707bc86e7174f96e3d2293e757cea.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/1*k43oPsZ_NTyLUai2g79UDw.gif"/></div></figure><p id="75f0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">休息了几个小时后，我又开始在那个域上搜索，但这次我得到了一个有趣的功能，这是我上次没有看到的。有趣的功能是<strong class="jp ir">密码重置功能</strong>。所以我对自己说，让我们试试这个密码重置功能。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi mm"><img src="../Images/4a9a12c6ee511f02c6642b01e8d26a77.png" data-original-src="https://miro.medium.com/v2/resize:fit:756/1*zooSyTPo_XVuwLY0r3e4LQ.gif"/></div></figure><p id="7024" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我不能透露目标的名字，因为这是一个私人项目。所以，让我们假设目标是<strong class="jp ir">site.com</strong>。他们的密码重置功能是这样的:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/38c6e73d0c3411de9af4fc0b79b42a58.png" data-original-src="https://miro.medium.com/v2/resize:fit:1234/format:webp/1*9mc5b1ieIHASfZONprk_Dw.png"/></div></figure><p id="e8fb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我注意到，每当我们进入我们的电子邮件并点击重置密码。我们收到了一封带有密码重置令牌链接的更改密码的电子邮件。</p><p id="0ddb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">密码重置令牌链接如下所示:</p><blockquote class="lw lx ly"><p id="556f" class="jn jo lz jp b jq jr js jt ju jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj kk ij bi translated">https://site.com/action-token?key = eyjhbgcioijiuzi 1 nisinr 5 ccigoiaislduiwia 2 lkia 6 icizzwm 2 odu 2 z</p></blockquote><p id="ae74" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这一次我决定拦截密码重置请求，我还启动了我的ngrok服务器。</p><p id="243b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">原始请求</strong>是这样的:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi mo"><img src="../Images/5923779edf2f56f70cfbf8d63f3f70cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iKsLioLm0hg49zWlYveENQ.png"/></div></div></figure><p id="2c55" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后我在原始请求中添加了另一个带有我的ngrok服务器域的头“X-Forwarded-Host”。所以现在<strong class="jp ir">修改后的请求</strong>是这样的:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi mo"><img src="../Images/1a8efbd90a3d6b824f05c425b554fdfa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JarjoGXWZEnn3KOuTKHUGw.png"/></div></div></figure><p id="1aa7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这次我收到了一封更改密码的邮件，但是是用我的ngrok服务器域。密码重置令牌链接如下所示:</p><blockquote class="lw lx ly"><p id="1b73" class="jn jo lz jp b jq jr js jt ju jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj kk ij bi translated">https://95saf4ct71g.ngrok.io/action-token?key = wia 2 lkiia 6 iccioijiuzi 1 niis INR 5 ccigodu 2 zeyjhbgia</p></blockquote><p id="8105" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您还可以看到，我只需在密码重置请求中添加标题“X-Forwarded-Host ”,就可以成功地更改主机。</p><p id="aa8a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，我注意到，如果我在密码重置页面输入受害者的电子邮件，并拦截该请求，如果我添加另一个标题“X-Forwarded-Host”与我的恶意域名。然后受害者将收到一封电子邮件的密码重置令牌链接与我的恶意域名。当受害者点击那个链接时，他会重定向到我的网站，他的所有令牌都会泄露给我。然后我可以用受害者泄露的令牌更改他的密码。是的，这个漏洞的影响是一个完整的帐户接管。</p><p id="0506" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，现在我可以通过重置密码，完全接管任何在site.com拥有账户的人的账户。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi ml"><img src="../Images/c4e2c77096fb2ef81e424d7ed7ddf880.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/1*dBZmWRPzI4Sl2yOwe5shGA.gif"/></div></figure><p id="9e5b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，没有浪费任何时间，我成功地提交了这个漏洞的完整概念证明，然后，Hackerone的私人程序奖励了我1000美元。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi mp"><img src="../Images/0341a3479e0704bfe40cfb3f6c07aa74.png" data-original-src="https://miro.medium.com/v2/resize:fit:1298/format:webp/1*lDcdMU5guXrF0pVxBxNIbg.png"/></div></figure><p id="0640" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">谢谢你阅读这篇博客，我希望你能学到一些东西。</p><p id="0db5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">祝你愉快！….</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi ml"><img src="../Images/bacdad398f034746604751108e68faab.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/1*HW0JuR56ZCV95p01ECqILQ.gif"/></div></figure></div></div>    
</body>
</html>