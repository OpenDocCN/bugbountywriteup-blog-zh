<html>
<head>
<title>Is Your Organization Handling Secrets Securely?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">您的组织安全地处理机密吗？</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/is-your-organization-handling-secrets-securely-16bbdb15fe4f?source=collection_archive---------0-----------------------#2020-05-17">https://infosecwriteups.com/is-your-organization-handling-secrets-securely-16bbdb15fe4f?source=collection_archive---------0-----------------------#2020-05-17</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="a9d4" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">避免硬编码秘密的秘密</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ki"><img src="../Images/8d8fa6a4294fb5ecd932205c8a8fc904.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/0*OMgR9nXBSr85LbPl.jpg"/></div></figure><p id="af32" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">我记得在我的应用程序安全之旅的早期，我们曾经在后端代码中识别硬编码的秘密，在几乎每个源代码审查项目中，那时我经常努力想出考虑成本和整体架构的最佳补救措施。</p><p id="2dec" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">基于对这种非常普遍的硬编码秘密的学习和遗忘的一点经验，我想就此写点东西。在这个故事中，我将讨论与硬编码秘密相关的问题，以及我们可以有效解决这个问题的方法。</p><p id="7be2" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">最后，我们还将快速比较云市场领导者AWS和HashiCorp的Vault提供的解决方案，以有效、安全地管理机密。</p><h1 id="e936" class="lm ln it bd lo lp lq lr ls lt lu lv lw jz lx ka ly kc lz kd ma kf mb kg mc md bi translated">硬编码秘密的问题</h1><p id="7bda" class="pw-post-body-paragraph kq kr it ks b kt me ju kv kw mf jx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">如果你过去做过代码审查，我敢肯定你肯定会遇到硬编码的秘密问题。如果没有，请查看下面的代码片段，它显示了数据库凭据是在应用程序源代码中硬编码的:</p><pre class="kj kk kl km gt mj mk ml mm aw mn bi"><span id="f73b" class="mo ln it mk b gy mp mq l mr ms"><strong class="mk iu">public</strong> <strong class="mk iu">final</strong> <!-- -->Connection getConnection() <strong class="mk iu">throws</strong> <!-- -->SQLException{</span><span id="1a9d" class="mo ln it mk b gy mt mq l mr ms"><strong class="mk iu">  return </strong>DriverManager.getConnection("jdbc:mysql://localhost/dbName","username", "password");</span><span id="2824" class="mo ln it mk b gy mt mq l mr ms">}</span></pre><p id="3596" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">敏感数据如<strong class="ks iu"> <em class="mu">秘密密钥、私有密钥、SSH密钥、访问/秘密密钥</em> </strong> <em class="mu">、</em> <strong class="ks iu"> <em class="mu">第三方秘密和API密钥</em> </strong>等。不应在应用源代码或您的基础设施中作为代码(IaC)进行硬编码，即Chef、Ansible、Puppet、Terraform脚本。以下是与硬编码机密相关的问题:</p><h2 id="bd7e" class="mo ln it bd lo mv mw dn ls mx my dp lw kz mz na ly ld nb nc ma lh nd ne mc nf bi translated"><strong class="ak">内部威胁</strong></h2><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="nh ni di nj bf nk"><div class="gh gi ng"><img src="../Images/05cea108e6912a9bf77087483abed59d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*MERJE5q0cAnMHTFE"/></div></div></figure><p id="59a4" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">对源代码中的秘密进行硬编码违反了基本安全性<strong class="ks iu"> <em class="mu">最小特权原则</em> </strong>，因为任何人都可以访问代码/VCS(Github、Gitlab等。)也可以通过秘密访问底层服务/操作。想象一下，所有的应用程序开发人员/QA工程师都可以访问这些被认为是秘密的敏感信息，从而使其容易被内部攻击所泄露。</p><h2 id="4c9b" class="mo ln it bd lo mv mw dn ls mx my dp lw kz mz na ly ld nb nc ma lh nd ne mc nf bi translated"><strong class="ak">外部威胁</strong></h2><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/33973b7abcaf974f4a41998a619a3125.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/0*8bwyyr2XLdzWABXr.jpg"/></div></figure><p id="5d20" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">在应用程序的服务器遭到破坏并且攻击者能够访问代码的情况下，所有这些硬编码的秘密都是非常有趣的信息🤑这有助于攻击者横向移动。</p><p id="c659" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">想象一下，一旦驻留在DMZ中的web服务器(可通过互联网访问)受到威胁，代码中硬编码的秘密将帮助攻击者到达位于内部网络中的DB服务器，从而进一步渗透。</p><h2 id="d116" class="mo ln it bd lo mv mw dn ls mx my dp lw kz mz na ly ld nb nc ma lh nd ne mc nf bi translated"><strong class="ak">安全性与可用性</strong></h2><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/4728c283f40914c9dae209afa9ec2dfe.png" data-original-src="https://miro.medium.com/v2/resize:fit:922/format:webp/1*YsaQh0R6Y9D4vuEVqGKcvA.png"/></div></figure><p id="b2cd" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">一旦应用程序/服务投入生产，并且由于违反/合规性要求而需要更改硬编码的机密，更改就会变得更加麻烦，因为这可能会影响系统的可用性，从而导致直接的业务影响。</p><h2 id="6ca7" class="mo ln it bd lo mv mw dn ls mx my dp lw kz mz na ly ld nb nc ma lh nd ne mc nf bi translated"><strong class="ak">分布式访问控制&amp;管理</strong></h2><p id="685e" class="pw-post-body-paragraph kq kr it ks b kt me ju kv kw mf jx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">与硬编码机密相关的另一个问题是访问控制和审计。因为秘密分布在不同的地方，即应用程序代码、配置文件、基础结构脚本(IaC)等。在我们的版本控制系统中，我们既没有细粒度的访问控制，也没有有效执行审计跟踪的方法来识别何时、何地以及谁访问了这些秘密。</p><p id="f753" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi nn translated"><span class="l no np nq bm nr ns nt nu nv di"> N </span> <strong class="ks iu"> ote </strong>:有一段<a class="nw nx ep" href="https://medium.com/u/3a8ff4bf8a68?source=post_page-----16bbdb15fe4f--------------------------------" rel="noopener" target="_blank">艾蒙·达德加尔</a>的精彩视频，他非常精彩地讲述了<strong class="ks iu">秘密蔓延的问题</strong>——秘密遍布我们不同地方的基础设施的情况。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ny nz l"/></div></figure><h1 id="ee86" class="lm ln it bd lo lp lq lr ls lt lu lv lw jz lx ka ly kc lz kd ma kf mb kg mc md bi translated">安全有效的秘密管理要求</h1><p id="21d9" class="pw-post-body-paragraph kq kr it ks b kt me ju kv kw mf jx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">我们有各种解决方案可用于管理机密，如HashiCorp Vault、AWS Secrets Manager、Azure Key Vault、Google Secret Manager、Cloud HSMs、内部HSMs和其他内部解决方案。在本节中，我们将讨论一个有效且安全的secret manager解决方案的几个基本要求，显然除了具有<strong class="ks iu">高可用性</strong>和<strong class="ks iu">可伸缩性</strong>。</p><h2 id="5de0" class="mo ln it bd lo mv mw dn ls mx my dp lw kz mz na ly ld nb nc ma lh nd ne mc nf bi translated">安全储存和运输</h2><p id="c6a4" class="pw-post-body-paragraph kq kr it ks b kt me ju kv kw mf jx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">机密应安全地存储和传输(TLS ),即机密不仅应加密，还应在静止和传输期间<strong class="ks iu"> <em class="mu">安全地加密</em> </strong>。应该使用强大的加密算法，并且应该安全地管理用于加密秘密的密钥！</p><blockquote class="oa ob oc"><p id="57e3" class="kq kr mu ks b kt ku ju kv kw kx jx ky od la lb lc oe le lf lg of li lj lk ll im bi translated">听起来像是先有蛋还是先有鸡的问题？</p></blockquote><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi og"><img src="../Images/561556358d91d3fbbde11097c808bd58.png" data-original-src="https://miro.medium.com/v2/resize:fit:684/0*2CK2XBujov6XiutU"/></div></figure><p id="ff0b" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">秘密管理解决方案很好地处理了这一点。例如，HashiCorp Vault使用加密密钥对所有秘密进行加密，加密密钥本身使用主密钥进行加密，并与加密数据一起存储。主密钥不存储在任何地方。Vault使用<a class="ae oh" href="https://en.wikipedia.org/wiki/Shamir's_Secret_Sharing" rel="noopener ugc nofollow" target="_blank"> Shamir的秘密共享算法</a>将主密钥分割成5份，其中任何3份都需要重建主密钥。一旦生成了主密钥，我们就可以解密加密密钥，从而解密秘密数据。你可以在这里了解更多信息<a class="ae oh" href="https://www.vaultproject.io/docs/concepts/seal" rel="noopener ugc nofollow" target="_blank">。</a></p><h2 id="f481" class="mo ln it bd lo mv mw dn ls mx my dp lw kz mz na ly ld nb nc ma lh nd ne mc nf bi translated"><strong class="ak">细粒度访问控制&amp;审计</strong></h2><p id="ad7e" class="pw-post-body-paragraph kq kr it ks b kt me ju kv kw mf jx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">秘密管理器解决方案应该具有细粒度的访问控制，以允许一组用户/服务访问特定的秘密，而不是每个人都可以访问所有内容。此外，除了访问控制之外，还应该对访问机密的人员、时间和方式有很强的可见性，这有助于我们跟踪访问请求，也更容易确保符合内部政策和法规标准。</p><h2 id="aa36" class="mo ln it bd lo mv mw dn ls mx my dp lw kz mz na ly ld nb nc ma lh nd ne mc nf bi translated">机密的定期/按需轮换</h2><p id="963d" class="pw-post-body-paragraph kq kr it ks b kt me ju kv kw mf jx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">秘密轮换是安全秘密管理的另一个基本要求。要么我们需要定期轮换机密以符合组织的ISMS政策/法规要求(例如:PCI-DSS ),要么我们需要在数据泄露等情况下按需轮换机密。如果不能顺利实施，机密的轮换可能会对系统的可用性和稳定性产生重大影响。</p><p id="0de1" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">一些秘密管理解决方案已经有效地解决了这个问题。如果我们谈论<strong class="ks iu"> AWS Secrets Manager </strong>，它允许在<strong class="ks iu"> AWS Lambda </strong>功能的帮助下进行无缝的定期/按需轮换。</p><p id="7240" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">它本身就知道如何为<a class="ae oh" href="https://docs.aws.amazon.com/secretsmanager/latest/userguide/intro.html#rds-supported-database-list" rel="noopener ugc nofollow" target="_blank">支持的亚马逊RDS数据库</a>轮换机密，也让我们能够为不支持的数据库/第三方服务轮换机密。换句话说，如果我们需要为受支持的Amazon RDS数据库轮换密码，那么Secrets Manager会为我们提供Lambda函数，否则对于任何不受支持的数据库或服务，我们必须提供Lambda函数的代码。你可以在这里阅读更多相关信息<a class="ae oh" href="https://docs.aws.amazon.com/secretsmanager/latest/userguide/rotating-secrets.html" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="226b" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">如果你和我一样，也想知道AWS如何解决由于秘密 的<strong class="ks iu"> <em class="mu">传播延迟而可能发生的停机问题。你可以看看<a class="ae oh" href="https://docs.aws.amazon.com/secretsmanager/latest/userguide/rotating-secrets-two-users.html" rel="noopener ugc nofollow" target="_blank">这个</a>。</em></strong></p></div><div class="ab cl oi oj hx ok" role="separator"><span class="ol bw bk om on oo"/><span class="ol bw bk om on oo"/><span class="ol bw bk om on"/></div><div class="im in io ip iq"><p id="fcd7" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">现在我们已经讨论了秘密管理器的基本属性，我们知道如何安全地管理秘密，以及如何与需要它的用户/服务安全地共享它。</p><p id="b72c" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated"><strong class="ks iu">坚持住！</strong>虽然秘密在秘密管理器中是安全的，但您是否意识到我们仍然面临着秘密可能从安全的秘密管理器外部泄露的风险？</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="nh ni di nj bf nk"><div class="gh gi op"><img src="../Images/0a47edf0de5d3f86701965df4f5b36d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BH0PRe5zY9j9imxX7A-RGw.png"/></div></div></figure><h1 id="b602" class="lm ln it bd lo lp lq lr ls lt lu lv lw jz lx ka ly kc lz kd ma kf mb kg mc md bi translated">动态秘密</h1><p id="4cc0" class="pw-post-body-paragraph kq kr it ks b kt me ju kv kw mf jx ky kz mg lb lc ld mh lf lg lh mi lj lk ll im bi translated">即使我们可以在访问secret manager时安全地管理内部的秘密，但如果访问秘密的实体没有安全地处理它，那该怎么办呢？考虑一个场景，其中应用程序在日志文件中记录数据库密码。这是还应该管理的剩余风险。</p><p id="5db9" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">此外，对于静态密码，所有需要访问服务的实体将共享同一组凭证，并且在违规的情况下，我们应该为每个实体更改密码，这可能非常麻烦。或者，在动态秘密的情况下，我们可以很容易地识别大海捞针，并且只为受危害的实体改变秘密。</p><p id="0092" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">让我们来看看HashiCorp Vault是如何优雅地处理这个问题的:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="nh ni di nj bf nk"><div class="gh gi oq"><img src="../Images/02c26f8e644f713c9fbb0e53e74ab770.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*K46juLRHFtlbl9H-.jpeg"/></div></div></figure><p id="ff51" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">在高级别上，动态秘密是按需生成的，并且对于客户端是唯一的，而不是预先定义并共享的静态秘密。Vault将每个动态机密与租约相关联，并在租约到期时自动销毁凭据。</p><h1 id="18d3" class="lm ln it bd lo lp lq lr ls lt lu lv lw jz lx ka ly kc lz kd ma kf mb kg mc md bi translated">HashiCorp的Vault和AWS Secret Manager的快速比较</h1><h2 id="d4f9" class="mo ln it bd lo mv mw dn ls mx my dp lw kz mz na ly ld nb nc ma lh nd ne mc nf bi translated">费用</h2><ul class=""><li id="ea35" class="or os it ks b kt me kw mf kz ot ld ou lh ov ll ow ox oy oz bi translated">HashiCorp的Vault有开源和企业两个版本。开源版本为秘密管理提供了重要的特性。实际使用成本取决于用于部署Vault的服务器</li><li id="7a80" class="or os it ks b kt pa kw pb kz pc ld pd lh pe ll ow ox oy oz bi translated">AWS Secret Manager(ASM)是由AWS提供的托管服务。实际的使用成本取决于存储的机密数量和用于与ASM对话的API调用。</li></ul><h2 id="8b0d" class="mo ln it bd lo mv mw dn ls mx my dp lw kz mz na ly ld nb nc ma lh nd ne mc nf bi translated"><strong class="ak">生态系统</strong></h2><ul class=""><li id="32cb" class="or os it ks b kt me kw mf kz ot ld ou lh ov ll ow ox oy oz bi translated">Vault提供了一个独立于供应商的保密管理解决方案。它可以用一个通用的API在任何云或数据中心工作</li><li id="b9e0" class="or os it ks b kt pa kw pb kz pc ld pd lh pe ll ow ox oy oz bi translated">ASM与AWS生态系统紧密相连</li></ul><h2 id="c685" class="mo ln it bd lo mv mw dn ls mx my dp lw kz mz na ly ld nb nc ma lh nd ne mc nf bi translated">秘密轮换</h2><ul class=""><li id="6292" class="or os it ks b kt me kw mf kz ot ld ou lh ov ll ow ox oy oz bi translated">Vault允许我们创建每个实例都唯一的动态机密，并支持使用机密自动轮换。</li><li id="cece" class="or os it ks b kt pa kw pb kz pc ld pd lh pe ll ow ox oy oz bi translated">ASM为一些受支持的数据库提供了无缝的秘密轮换，并为不受支持的实体提供了Lambda函数。</li></ul><h2 id="8f3a" class="mo ln it bd lo mv mw dn ls mx my dp lw kz mz na ly ld nb nc ma lh nd ne mc nf bi translated">动态秘密</h2><ul class=""><li id="5a4d" class="or os it ks b kt me kw mf kz ot ld ou lh ov ll ow ox oy oz bi translated">Vault支持动态机密</li><li id="de00" class="or os it ks b kt pa kw pb kz pc ld pd lh pe ll ow ox oy oz bi translated">ASM不支持动态机密</li></ul><p id="8432" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">尽管实现一个解决方案在很大程度上取决于组织内的多种约束，例如当前的云平台。然而，总的来说，基于Vault的功能和与云无关的特性，我相信它是管理秘密的更好的解决方案。</p><h1 id="2d52" class="lm ln it bd lo lp lq lr ls lt lu lv lw jz lx ka ly kc lz kd ma kf mb kg mc md bi translated">参考</h1><ul class=""><li id="6f49" class="or os it ks b kt me kw mf kz ot ld ou lh ov ll ow ox oy oz bi translated">https://www.vaultproject.io/docs/internals/architecture<a class="ae oh" href="https://www.vaultproject.io/docs/internals/architecture" rel="noopener ugc nofollow" target="_blank"/></li><li id="6768" class="or os it ks b kt pa kw pb kz pc ld pd lh pe ll ow ox oy oz bi translated"><a class="ae oh" href="https://docs.aws.amazon.com/secretsmanager/latest/userguide/intro.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/secrets manager/latest/user guide/intro . html</a></li><li id="ea7e" class="or os it ks b kt pa kw pb kz pc ld pd lh pe ll ow ox oy oz bi translated"><a class="ae oh" href="https://www.hashicorp.com/blog/why-we-need-dynamic-secrets/" rel="noopener ugc nofollow" target="_blank">https://www.hashicorp.com/blog/why-we-need-dynamic-secrets/</a></li><li id="6994" class="or os it ks b kt pa kw pb kz pc ld pd lh pe ll ow ox oy oz bi translated"><a class="ae oh" href="https://discuss.hashicorp.com/t/how-does-hashicorp-vault-compare-to-tools-like-aws-secrets-manager/3024" rel="noopener ugc nofollow" target="_blank">https://discuse . hashi corp . com/t/how-does-hashi corp-vault-compare-to-tools-like-AWS-secrets-manager/3024</a></li><li id="f297" class="or os it ks b kt pa kw pb kz pc ld pd lh pe ll ow ox oy oz bi translated"><a class="ae oh" href="https://www.cloudjourney.io/articles/security/aws_secrets_manager_vs_hashi_vault-su/" rel="noopener ugc nofollow" target="_blank">https://www . cloud journey . io/articles/security/AWS _ secrets _ manager _ vs _ hashi _ vault-su/</a></li></ul></div></div>    
</body>
</html>