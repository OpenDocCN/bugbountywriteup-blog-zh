<html>
<head>
<title>Threat Hunting Series: Using Threat Emulation for Threat Hunting</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">威胁搜寻系列:使用威胁模拟进行威胁搜寻</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/threat-hunting-series-using-threat-emulation-for-threat-hunting-f7ccaa4b85e5?source=collection_archive---------0-----------------------#2022-10-10">https://infosecwriteups.com/threat-hunting-series-using-threat-emulation-for-threat-hunting-f7ccaa4b85e5?source=collection_archive---------0-----------------------#2022-10-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="c6d7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这篇文章将展示如何使用威胁模拟来寻找威胁。我经常使用威胁模拟来了解攻击执行后留下的证据。</p><p id="aab2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">虽然威胁模拟有许多用例，但这篇文章将重点关注模拟攻击者的技术，以帮助寻找威胁。威胁模拟是一种强大的工具，可用于搜索威胁。安全团队可以通过在实验室环境中模拟攻击者的技术来生成必要的遥测和测试安全解决方案。这个过程可以帮助您了解攻击者的心态和方法，从而让您更有效地寻找威胁。</p><p id="0bb7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">作为一个威胁猎人，寻找可用的资源来寻找敌对技术有时会很困难。一些资源可能是与攻击相关的信息(想想威胁情报/事件响应报告)和遥测数据(日志)。在这种情况下，您必须进行自己的研究，并采用威胁模拟来帮助生成必要的数据。</p><p id="fddc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">重要</strong></p><blockquote class="kl km kn"><p id="6323" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated"><em class="iq">在你开始模拟攻击和挖掘日志之前，最好先确定你在找什么和你研究的目的。</em></p></blockquote><p id="9ab2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有必要建立一个实验室环境来协助重现攻击场景，并收集生成的遥测数据。然后，您可以分析结果并寻找生产环境中的独特攻击指标(IOA)。</p><h1 id="36f0" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">成功模拟的步骤</h1><p id="10bc" class="pw-post-body-paragraph jn jo iq jp b jq lq js jt ju lr jw jx jy ls ka kb kc lt ke kf kg lu ki kj kk ij bi translated">在模拟攻击之前，有许多因素需要考虑。我将模拟的各个阶段划分如下:</p><ol class=""><li id="0034" class="lv lw iq jp b jq jr ju jv jy lx kc ly kg lz kk ma mb mc md bi translated">创建一个实验室环境。</li><li id="f71a" class="lv lw iq jp b jq me ju mf jy mg kc mh kg mi kk ma mb mc md bi translated">收集关于攻击的信息</li><li id="679e" class="lv lw iq jp b jq me ju mf jy mg kc mh kg mi kk ma mb mc md bi translated">执行攻击</li><li id="57ec" class="lv lw iq jp b jq me ju mf jy mg kc mh kg mi kk ma mb mc md bi translated">分析收集的数据并创建您的TH查询</li><li id="4e58" class="lv lw iq jp b jq me ju mf jy mg kc mh kg mi kk ma mb mc md bi translated">消除误报</li><li id="3e52" class="lv lw iq jp b jq me ju mf jy mg kc mh kg mi kk ma mb mc md bi translated">使威胁搜索可重复</li></ol><blockquote class="kl km kn"><p id="1b04" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated">这一节将回顾这些关键步骤，并对每个步骤进行高层次的解释。我还将包括一个例子来巩固这个概念。示例用例将支持Wdigest协议提取明文凭证。</p></blockquote><p id="514c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">以下是以下过程的思维导图:</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mj"><img src="../Images/2aa02737fcd8fbfafc2fa147fdd3da17.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NYGqf9e7DQ1451d8MFwkxw.png"/></div></div></figure><h1 id="0b26" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated"><strong class="ak"> 1。创建测试环境</strong></h1><p id="59fe" class="pw-post-body-paragraph jn jo iq jp b jq lq js jt ju lr jw jx jy ls ka kb kc lt ke kf kg lu ki kj kk ij bi translated"><strong class="jp ir">重要</strong></p><blockquote class="kl km kn"><p id="b006" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated">只是在这里澄清一下，这不会是一个恶意软件实验室。尽管仍然建议将实验室环境与实验室外的任何其他主机隔离开来，但这将是一个重现攻击的测试环境。</p></blockquote><p id="985a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在构建测试环境时，考虑使用与您的组织环境相匹配的策略。例如，请求IT部门将黄金映像安装在实验室的一台主机上。此外，在windows AD环境中，您可以使用相同的组策略，例如:</p><ul class=""><li id="8279" class="lv lw iq jp b jq jr ju jv jy lx kc ly kg lz kk mv mb mc md bi translated">禁用LDAP签名</li><li id="cc40" class="lv lw iq jp b jq me ju mf jy mg kc mh kg mi kk mv mb mc md bi translated">禁用SMB签名</li><li id="8d41" class="lv lw iq jp b jq me ju mf jy mg kc mh kg mi kk mv mb mc md bi translated">禁用NLA</li><li id="dd4d" class="lv lw iq jp b jq me ju mf jy mg kc mh kg mi kk mv mb mc md bi translated">等等。</li></ul><p id="43e2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">镜像您的测试环境不是必需的；但是，它可以使威胁模拟的结果与您稍后要搜索的网络更加相关。</p><p id="daae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">另一个重要方面是主机的日志记录能力。为了最大限度地利用模拟，主机应该记录所有活动，启用增强的日志记录将有助于这一点。增强日志功能的一个好方法是使用Sysmon。除了默认的Windows事件日志之外，Sysmon还可以提供大量的详细信息。此外，所有日志都应该转发到一个集中的位置，以便于分析。您可以使用ELK stack或任何您能得到的其他解决方案。</p><p id="04e5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你应该收集哪些日志？</p><p id="ec70" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">虽然端点遥测可能是大多数情况下最相关的数据源，但在开发恶意通信模式检测时，网络数据也很有用。像Suricata这样的入侵检测系统(IDS)可以帮助创建网络检测，而Zeek这样的解决方案可以提供详细的网络可见性。因此，获取网络流量可能是有益的。</p><p id="29c6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以使用Wireshark或T-Shark等开源软件捕获单个端点上的web流量。有更有效的方法来捕获网络流量，但这种方法应该足以让事情开始。</p><p id="3d29" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，如果您想评估您的组织正在使用的安全解决方案，最好将其包括在您的实验设置中。如果默认防御策略在模拟过程中阻止工具，请确保创建仅检测策略。</p><p id="8680" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通过整合上述所有配置，您可以重现攻击，并观察它们对您组织的生产环境的潜在影响。同时，生成的遥测将帮助您研究各种攻击和攻击路径。下面，我提供了一些建立实验室环境的资源:</p><p id="6894" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">—预制的实验室环境:</p><ul class=""><li id="8646" class="lv lw iq jp b jq jr ju jv jy lx kc ly kg lz kk mv mb mc md bi translated">检测实验室:<a class="ae mw" href="https://detectionlab.network/" rel="noopener ugc nofollow" target="_blank">https://detection Lab . network/</a></li><li id="e559" class="lv lw iq jp b jq me ju mf jy mg kc mh kg mi kk mv mb mc md bi translated">Splunk攻击范围v 2.0:<a class="ae mw" href="https://www.splunk.com/en_us/blog/security/introducing-splunk-attack-range-v2-0.html" rel="noopener ugc nofollow" target="_blank">https://www . splunk . com/en _ us/blog/security/introducing-splunk-Attack-Range-v2-0 . html</a></li></ul><p id="ec8d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">—逐步指南:</p><ul class=""><li id="ec96" class="lv lw iq jp b jq jr ju jv jy lx kc ly kg lz kk mv mb mc md bi translated">建立一个用于检测和监控的网络安全家庭实验室:<a class="ae mw" href="https://cyberwoxacademy.com/building-a-cybersecurity-homelab-for-detection-monitoring/" rel="noopener ugc nofollow" target="_blank">https://cyberwoxacademy . com/building-a-Cybersecurity-home lab-for-Detection-Monitoring/</a></li><li id="3a4b" class="lv lw iq jp b jq me ju mf jy mg kc mh kg mi kk mv mb mc md bi translated"><a class="ae mw" href="https://www.cyberhuntingguide.net/creating-homelab.html" rel="noopener ugc nofollow" target="_blank">https://www.cyberhuntingguide.net/creating-homelab.html</a></li><li id="775d" class="lv lw iq jp b jq me ju mf jy mg kc mh kg mi kk mv mb mc md bi translated">带PowerShell的活动目录主页实验室(2022指南):<a class="ae mw" href="https://systemweakness.com/active-directory-home-lab-w-powershell-2022-guide-a87311182ab2" rel="noopener ugc nofollow" target="_blank">https://system weakness . com/active-Directory-Home-Lab-w-PowerShell-2022-Guide-a 87311182 ab 2</a></li></ul><p id="9848" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">用例示例:</strong></p><ul class=""><li id="41e1" class="lv lw iq jp b jq jr ju jv jy lx kc ly kg lz kk mv mb mc md bi translated">设置和使用检测实验室</li></ul><h1 id="5277" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated"><strong class="ak"> 2。收集关于攻击的信息</strong></h1><p id="6cf8" class="pw-post-body-paragraph jn jo iq jp b jq lq js jt ju lr jw jx jy ls ka kb kc lt ke kf kg lu ki kj kk ij bi translated">下一步是收集尽可能多的关于重现攻击场景所需工具的信息。你可以使用OSINT收集尽可能多的信息。即使只有高层次的信息可用，每个小提示都有帮助。例如，您可能只会在威胁情报报告中发现攻击的内容，以及使用后的结果或最终目标。了解结果会在稍后的数据分析步骤中有所帮助。</p><p id="e014" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您感到困惑，可以联系信息安全社区中的其他人。你会惊讶有多少人愿意协助。向他人伸出援手时要有耐心；他们不会按照你的时间表工作。</p><p id="a58e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一些需要考虑的一般问题是:</p><ul class=""><li id="af25" class="lv lw iq jp b jq jr ju jv jy lx kc ly kg lz kk mv mb mc md bi translated">攻击的前提条件是什么？</li></ul><p id="1fd7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">—特定的应用程序/操作系统版本</p><p id="00c8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">—需要存在某种错误配置。</p><p id="2ac3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">—需要特权。</p><ul class=""><li id="4eaf" class="lv lw iq jp b jq jr ju jv jy lx kc ly kg lz kk mv mb mc md bi translated">攻击的最终目标是什么？</li><li id="7bec" class="lv lw iq jp b jq me ju mf jy mg kc mh kg mi kk mv mb mc md bi translated">我需要哪些数据源来捕捉活动？</li></ul><p id="74ce" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">—网络日志</p><p id="b4ed" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">—流程执行日志</p><p id="1ec3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">—身份验证日志</p><p id="f0b2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">—以上所有的组合？！</p><ul class=""><li id="8d75" class="lv lw iq jp b jq jr ju jv jy lx kc ly kg lz kk mv mb mc md bi translated">我如何发动攻击？</li></ul><p id="4980" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">用例示例:</strong></p><p id="c377" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">red teaming experiments博客有一篇关于攻击的精彩文章(<a class="ae mw" href="https://www.ired.team/offensive-security/credential-access-and-credential-dumping/forcing-wdigest-to-store-credentials-in-plaintext" rel="noopener ugc nofollow" target="_blank">https://www . ired . team/offensive-security/credential-access-and-credential-dumping/forced-wdigest-to-store-credentials-in-plaintext</a>)</p><p id="d6e5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">先决条件:</p><ul class=""><li id="8f28" class="lv lw iq jp b jq jr ju jv jy lx kc ly kg lz kk mv mb mc md bi translated">从gentilkiwi的官方Github页面下载mimikatz</li></ul><h1 id="ce13" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated"><strong class="ak"> 3。执行攻击</strong></h1><p id="3e15" class="pw-post-body-paragraph jn jo iq jp b jq lq js jt ju lr jw jx jy ls ka kb kc lt ke kf kg lu ki kj kk ij bi translated">一旦您获得了必要的信息和工具，就该执行威胁模拟了。在分析阶段，记下攻击的执行时间和主机名会很有用。</p><p id="d240" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">值得注意的是，如果您需要外部工具来执行攻击，您应该验证您打算使用的工具的可信度和真实性。人们发布后门工具和脚本的情况有很多。</p><p id="31cb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">用例示例:</strong></p><p id="0b05" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">步骤1:启用Wdigest协议，注销并重新登录</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mx"><img src="../Images/64ef7512f727d79d3b6aad0300c1e781.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fRCUmJYuXMen5Zp6kF_kUQ.png"/></div></div></figure><p id="eaa4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">步骤2:使用适当的命令行参数执行mimikatz</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi my"><img src="../Images/7ebe9e2df3161c26be0d505423d7e318.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jugIC_1BN6lJhQKiwSb7-w.png"/></div></div></figure><h1 id="e55a" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated"><strong class="ak"> 4。分析收集的数据并创建您的TH查询</strong></h1><p id="c34f" class="pw-post-body-paragraph jn jo iq jp b jq lq js jt ju lr jw jx jy ls ka kb kc lt ke kf kg lu ki kj kk ij bi translated">将丰富的日志转发到一个集中的位置，在那里可以对它们进行解析并准备好进行检查，这可以在此阶段节省大量时间。知道了执行时间，您就可以快速启动调查并开始研究数据，而不必担心运行额外的工具。</p><p id="6828" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果出于某种原因无法做到这一点，您仍然可以使用一些工具从仿真过程中涉及的主机收集信息。其中一些工具是<a class="ae mw" href="https://github.com/Velocidex/velociraptor" rel="noopener ugc nofollow" target="_blank">迅猛龙</a>和<a class="ae mw" href="https://www.kroll.com/en/insights/publications/cyber/kroll-artifact-parser-extractor-kape" rel="noopener ugc nofollow" target="_blank">卡普</a>。人们应该熟悉解决同一问题的多种方法。</p><p id="8029" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当捕获和分析网络流量时，像<a class="ae mw" href="https://securityonionsolutions.com/" rel="noopener ugc nofollow" target="_blank">安全洋葱</a>、<a class="ae mw" href="https://arkime.com/" rel="noopener ugc nofollow" target="_blank"> Arkime、</a>或good 'ol Wireshark这样的工具是这项工作的绝佳人选。</p><p id="05bb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行攻击后，可以检查已经安装的安全解决方案(如果有的话)。您是否看到任何基于网络或端点的检测？如果是这样，您可以获得关于触发的检测类型的更多信息。不管检测是否被触发，如果您使用EDR解决方案，您可以查询围绕执行时间生成的遥测。</p><p id="0b28" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">假设您发现了一些有趣且独特的攻击指标，下一步就是根据您的SIEM或您使用的其他解决方案所支持的语言来设计初始查询。</p><p id="c11a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">了解数据集中可能出现的一些指标有助于您识别与攻击执行相关的独特模式。下面的列表并不详尽，但它确实包括了一些我最喜欢的东西:</p><ul class=""><li id="6cdc" class="lv lw iq jp b jq jr ju jv jy lx kc ly kg lz kk mv mb mc md bi translated">过程树分析</li></ul><p id="3b7a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">—父子流程关系</p><ul class=""><li id="34c9" class="lv lw iq jp b jq jr ju jv jy lx kc ly kg lz kk mv mb mc md bi translated">命令行</li></ul><p id="df10" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">—执行路径</p><p id="aabe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">—使用的参数</p><p id="20c5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">—等等。</p><ul class=""><li id="fb5f" class="lv lw iq jp b jq jr ju jv jy lx kc ly kg lz kk mv mb mc md bi translated">文件</li></ul><p id="e74c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">—丢弃的文件</p><p id="457e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">—目录创建</p><ul class=""><li id="fd88" class="lv lw iq jp b jq jr ju jv jy lx kc ly kg lz kk mv mb mc md bi translated">服务/计划任务创建/修改</li><li id="08c2" class="lv lw iq jp b jq me ju mf jy mg kc mh kg mi kk mv mb mc md bi translated">注册表项创建/修改</li></ul><p id="0990" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Sysmon日志甚至可以包括更多详细的端点信息，这些信息对于创建初始威胁搜索查询非常有用。我最喜欢的增强可见性的Sysmon事件id有:</p><ul class=""><li id="898e" class="lv lw iq jp b jq jr ju jv jy lx kc ly kg lz kk mv mb mc md bi translated">事件ID 7:图像已加载</li><li id="809b" class="lv lw iq jp b jq me ju mf jy mg kc mh kg mi kk mv mb mc md bi translated">事件ID 8: CreateRemoteThread</li><li id="9a62" class="lv lw iq jp b jq me ju mf jy mg kc mh kg mi kk mv mb mc md bi translated">事件ID 9: RawAccessRead</li><li id="5f31" class="lv lw iq jp b jq me ju mf jy mg kc mh kg mi kk mv mb mc md bi translated">事件ID 10: ProcessAccess</li></ul><p id="7498" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Sysmon事件的完整列表和对上述Eid的进一步解释可以在这里找到:<a class="ae mw" href="https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon#events." rel="noopener ugc nofollow" target="_blank">https://learn . Microsoft . com/en-us/sysinternals/downloads/Sysmon # events。</a></p><p id="ccd8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在创建查询时，您可能希望研究一下<a class="ae mw" href="https://github.com/SigmaHQ/sigma" rel="noopener ugc nofollow" target="_blank">适马项目</a>。</p><p id="150c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> <em class="ko">“适马</em> </strong> <em class="ko">是一种通用的、开放的签名格式，允许您以直截了当的方式描述相关日志事件。”</em></p><p id="b12b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">许多安全研究人员以适马格式贡献他们的检测规则。您可以将一些规则翻译成您的SIEM/EDR特定语言。一旦熟悉了sigma规则的编写，这些规则就可以贡献给社区和项目。</p><p id="0503" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">适马规则示例:</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mz"><img src="../Images/aa722e68586c9038ed90ba621e9f9332.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ycDa_Cqj901KhG-k.png"/></div></div></figure><p id="11b0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有许多免费资源可以开始了解适马。<a class="ae mw" href="https://twitter.com/nas_bench" rel="noopener ugc nofollow" target="_blank"> @nas_bench </a>在这里整理了一些最好的:<a class="ae mw" href="https://github.com/nasbench/SIGMA-Resources" rel="noopener ugc nofollow" target="_blank">https://github.com/nasbench/SIGMA-Resources</a>。</p><p id="b6fa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">用例示例:</strong></p><p id="4ca6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">检测实验室包括一个Splunk实例，数据将被转发到该实例。在这个例子中，我使用Sysmon日志来检查数据并创建查询。</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi na"><img src="../Images/46ee175269e23af39f2e9960dd689aab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A2cwUkUemj9mDUG9R6yNZA.png"/></div></div></figure><p id="9567" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上述查询的sigma规则如下所示:</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi nb"><img src="../Images/d513f9c4b18d95b319e0546caf39d20a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q8nCSVl1QhAo5sAvfutK8A@2x.png"/></div></div></figure><p id="ccb4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以使用SOC Prime提供的<a class="ae mw" href="https://uncoder.io/" rel="noopener ugc nofollow" target="_blank">https://uncoder.io/</a>在线测试和翻译您的sigma规则。</p><h1 id="15d3" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated"><strong class="ak"> 5。消除误报</strong></h1><p id="b8ca" class="pw-post-body-paragraph jn jo iq jp b jq lq js jt ju lr jw jx jy ls ka kb kc lt ke kf kg lu ki kj kk ij bi translated">不幸的是，当你在寻找威胁时，事情并不总是美好的。在收到最初的广泛搜索结果后，出现误报是很常见的。过滤掉良性活动是改进查询的一种方式。假阳性需要一些时间来验证。有时，我会花几个小时分析数据，试图理解噪音(误报)。最终，目标是在不影响查询质量的情况下减少噪音。</p><p id="b056" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">用例示例:</strong></p><p id="245a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上面的查询可以进一步细化，以避免任何误报。这是一个例子:</p><blockquote class="kl km kn"><p id="fdea" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated">source = " WinEventLog:Sysmon "(event code = 13或event code = 1)(Image = " * \ \ reg . exe " command line = " * add * " target object = * wdi gest *)或((ParentImage="*\\cmd.exe "或parent Image = " * \ \ powershell . exe ")command line = " * wdi gest * " | sort+_ time | table event code Image command line target object task category | sort+_ time</p></blockquote><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi nc"><img src="../Images/dc9dacf12bce885d9698a9e7b3645c79.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3zQ3Q5x6mPuok56WHBbsKg@2x.png"/></div></div></figure><h1 id="3bab" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated"><strong class="ak"> 6。使威胁搜索可重复</strong></h1><p id="2ce1" class="pw-post-body-paragraph jn jo iq jp b jq lq js jt ju lr jw jx jy ls ka kb kc lt ke kf kg lu ki kj kk ij bi translated">现在您已经创建并优化了您的查询，剩下的就是记录您的研究，并与适当的团队和社区共享(如果您选择这样做的话)。这里的目标是创建一个检测，以消除相同的威胁搜索在未来的重复。</p><p id="61fd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果结果噪音太大，不适合进行新的检测，还有另一种方法可以重复进行威胁搜索。在应用编程接口(API)的帮助下，精确的查询可以被自动化。大多数免费和付费的SIEM/EDR解决方案都有一个API，它提供了一种以编程方式查询数据的方法。然后可以使用脚本自动运行查询并完成大部分分析。</p><h1 id="a5e5" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated"><strong class="ak">结论</strong></h1><p id="59fd" class="pw-post-body-paragraph jn jo iq jp b jq lq js jt ju lr jw jx jy ls ka kb kc lt ke kf kg lu ki kj kk ij bi translated">通过了解攻击者的运作方式，您可以更好地设计您的安全解决方案，并在您的网络中搜寻威胁。我希望这篇文章能帮助你应用威胁模拟来填补知识空白，试验和测试你的查询，以便更有效地寻找威胁。</p><p id="21c5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请在这里和Twitter上关注我，了解本系列后续文章的更新。</p><p id="4077" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">https://twitter.com/Kostastsale<a class="ae mw" href="https://twitter.com/Kostastsale" rel="noopener ugc nofollow" target="_blank"/></p><div class="nd ne gp gr nf ng"><a href="https://github.com/tsale" rel="noopener  ugc nofollow" target="_blank"><div class="nh ab fo"><div class="ni ab nj cl cj nk"><h2 class="bd ir gy z fp nl fr fs nm fu fw ip bi translated">tsale -概述</h2><div class="nn l"><h3 class="bd b gy z fp nl fr fs nm fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="no l"><p class="bd b dl z fp nl fr fs nm fu fw dk translated">github.com</p></div></div><div class="np l"><div class="nq l nr ns nt np nu mt ng"/></div></div></a></div></div><div class="ab cl nv nw hu nx" role="separator"><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa"/></div><div class="ij ik il im in"><h2 id="e172" class="oc kt iq bd ku od oe dn ky of og dp lc jy oh oi lg kc oj ok lk kg ol om lo on bi translated">来自Infosec的报道:Infosec每天都有很多内容，很难跟上。<a class="ae mw" href="https://weekly.infosecwriteups.com/" rel="noopener ugc nofollow" target="_blank">加入我们的每周时事通讯</a>以5篇文章、4个线程、3个视频、2个GitHub Repos和工具以及1个工作提醒的形式免费获取所有最新的Infosec趋势！</h2></div></div>    
</body>
</html>