<html>
<head>
<title>Safer deserialization in Spring Security OAuth2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Spring Security OAuth2中更安全的反序列化</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/safer-deserialization-in-spring-security-oauth2-37be6f55a860?source=collection_archive---------2-----------------------#2019-11-16">https://infosecwriteups.com/safer-deserialization-in-spring-security-oauth2-37be6f55a860?source=collection_archive---------2-----------------------#2019-11-16</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="a33b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Java标准库提供了<code class="fe ko kp kq kr b">ObjectInputStream</code>类，它为反序列化Java对象提供了一种便捷的方式。不幸的是，这种方式默认是不安全的。使用此类可能会为Java反序列化攻击打开大门，在更糟糕的情况下，这可能会导致任意代码执行。</p><p id="1241" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我最近发现Spring Security OAuth2库可能容易受到这样的攻击。幸运的是，成功的攻击有一个强大的先决条件，对手可能很难满足。尽管如此，我认为让库更安全一点可能更好，项目维护人员欣然接受了这一贡献。以下是细节。</p><p id="5a4a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">(最初发表于<a class="ae ks" href="https://blog.gypsyengineer.com/en/security/safer-deserialization-in-spring-security-oauth.html" rel="noopener ugc nofollow" target="_blank">https://blog.gypsyengineer.com</a>)</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div class="gh gi kt"><img src="../Images/b8b02b86c914e0f200d41029f539b5e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1316/format:webp/0*jubF7Gbk-4y7KfvT.jpg"/></div></figure><h1 id="0351" class="lb lc it bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">问题</h1><p id="6530" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated">Spring Security OAuth2可以将认证信息和用户详细信息存储到SQL或Redis数据库中。在将数据存储到数据库之前，库使用由<code class="fe ko kp kq kr b">ObjectOutputStream</code>提供的默认Java序列化机制对其进行序列化。然后，从数据库中读取数据后，库用<code class="fe ko kp kq kr b">ObjectInputStream</code>类不安全地反序列化它。参见<code class="fe ko kp kq kr b">SerializationUtils</code>类:</p><pre class="ku kv kw kx gt me kr mf mg aw mh bi"><span id="5a23" class="mi lc it kr b gy mj mk l ml mm">public static  T deserialize(byte[] byteArray) {<br/>         ObjectInputStream oip = null;<br/>         try {<br/>             oip = new ConfigurableObjectInputStream(<br/>                    new ByteArrayInputStream(byteArray),<br/>                    Thread.currentThread().getContextClassLoader());<br/>             <a class="ae ks" href="http://twitter.com/SuppressWarnings" rel="noopener ugc nofollow" target="_blank">@SuppressWarnings</a>("unchecked")<br/>             T result = (T) oip.readObject();</span></pre><p id="313b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Spring框架提供的<code class="fe ko kp kq kr b">ConfigurableObjectInputStream</code>类只是包装了<code class="fe ko kp kq kr b">InputObjectStream</code>类，没有添加任何安全检查。</p><p id="7704" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这意味着，如果攻击者能够将恶意数据放入数据库，那么在更糟糕的情况下，他可以执行任意代码，结果是危害整个应用程序。然而，成功利用漏洞有几个要求。</p><p id="96af" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">首先，攻击者必须使用应用程序的JVM中可用的类构建一个反序列化小工具。很可能这不是一个大问题，因为Java标准库提供了许多危险的类。此外，应用程序可以加载许多库，这也有助于构建反序列化小工具。</p><p id="7ab5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">第二，为了利用这个反序列化缺陷，攻击者必须找到一种方法将恶意数据放入数据库。例如，他可以尝试找到一个SQL注入。但是，可能没那么容易，以至于这个要求可能很难达到。</p><p id="6b1e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我通过检查代码发现了问题。然后，我向Pivotal安全团队报告了此事。但是由于上面的第二个要求，他们决定不将它视为库中的一个漏洞。然而，他们欢迎一个补丁，该补丁增加了一个深度防御措施来防止这种反序列化攻击。</p><h1 id="0e25" class="lb lc it bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">解决方案</h1><p id="dbf0" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated">为了防止Java反序列化漏洞，应用程序必须限制一组可以反序列化的类。最好的方法之一是实现一个允许类的白名单。有三种方法可以实现这种保护机制:</p><ol class=""><li id="fef3" class="mn mo it js b jt ju jx jy kb mp kf mq kj mr kn ms mt mu mv bi translated">使用JEP 290中引入的过滤API。</li><li id="823c" class="mn mo it js b jt mw jx mx kb my kf mz kj na kn ms mt mu mv bi translated">使用Apache Commons IO中的<code class="fe ko kp kq kr b">ValidatingObjectInputStream</code>类。</li><li id="0be4" class="mn mo it js b jt mw jx mx kb my kf mz kj na kn ms mt mu mv bi translated">覆盖<code class="fe ko kp kq kr b">ObjectInputStream.resolveClass()</code>方法，并在那里实现白名单。</li></ol><p id="0cba" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">第一种方式要求应用程序使用具有JEP 290的Java版本。第二种方法是向Spring Security OAuth添加一个额外的依赖项。我决定走第三条路，因为它不会引入任何额外的依赖性:</p><ul class=""><li id="050d" class="mn mo it js b jt ju jx jy kb mp kf mq kj mr kn nb mt mu mv bi translated">添加了一个新的<code class="fe ko kp kq kr b">SaferObjectInputStream</code>类，检查类是否允许反序列化。</li><li id="295e" class="mn mo it js b jt mw jx mx kb my kf mz kj na kn nb mt mu mv bi translated">定义了一个类别白名单，分别为<code class="fe ko kp kq kr b">java.lang.*</code>、<code class="fe ko kp kq kr b">java.util.*</code>和<code class="fe ko kp kq kr b">org.springframework.security.*</code>。</li><li id="06fe" class="mn mo it js b jt mw jx mx kb my kf mz kj na kn nb mt mu mv bi translated"><a class="ae ks" href="https://github.com/spring-projects/spring-security-oauth/pull/1703" rel="noopener ugc nofollow" target="_blank">更新了</a>的<code class="fe ko kp kq kr b">RedisTokenStore</code>类来使用白名单中的<code class="fe ko kp kq kr b">SaferObjectInputStream</code>。</li><li id="ffc6" class="mn mo it js b jt mw jx mx kb my kf mz kj na kn nb mt mu mv bi translated"><a class="ae ks" href="https://github.com/spring-projects/spring-security-oauth/pull/1760" rel="noopener ugc nofollow" target="_blank">更新了</a>JDBC类以使用白名单中的<code class="fe ko kp kq kr b">SaferObjectInputStream</code>。</li></ul><p id="c21d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">该更新已在Spring Security OAuth2 <code class="fe ko kp kq kr b">2.3.7</code>中发布，但不幸的是，该解决方案引发了一个问题。原来白名单太严格了。如果应用程序存储了令牌或用户详细信息的自定义实现，那么由于限制性白名单的原因，新版本的库将无法对它们进行反序列化。此外，用户无法修改白名单来使应用程序再次工作。几个用户<a class="ae ks" href="https://github.com/spring-projects/spring-security-oauth/issues/1759#issuecomment-543076614" rel="noopener ugc nofollow" target="_blank">报告了这个问题</a>。</p><p id="5531" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我在<code class="fe ko kp kq kr b">2.4.0</code>中通过引入一个新的API修复了这个问题，它允许用户指定一个自定义的白名单。默认的白名单仍然包含<code class="fe ko kp kq kr b">java.lang.*</code>、<code class="fe ko kp kq kr b">java.util.*</code>和<code class="fe ko kp kq kr b">org.springframework.security.*</code>类。起初，我更新了库，默认应用白名单。但是后来，项目维护者让我把它变成一个选择加入的选项。原因是<code class="fe ko kp kq kr b">2.4.0</code>是一个小版本，所以当它迁移到新版本时不会给应用程序带来任何问题。</p><p id="7529" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">下面是我对<a class="ae ks" href="https://github.com/spring-projects/spring-security-oauth/pull/1784" rel="noopener ugc nofollow" target="_blank">所做的，让反序列化再次变得伟大</a>:</p><ol class=""><li id="b46c" class="mn mo it js b jt ju jx jy kb mp kf mq kj mr kn ms mt mu mv bi translated">增加了一个新的<code class="fe ko kp kq kr b">SerializationStrategy</code>接口，有两个实现:<code class="fe ko kp kq kr b">DefaultSerializationStrategy</code>和<code class="fe ko kp kq kr b">WhitelistedSerializationStrategy</code>。</li><li id="af5d" class="mn mo it js b jt mw jx mx kb my kf mz kj na kn ms mt mu mv bi translated"><code class="fe ko kp kq kr b">DefaultSerializationStrategy</code>使用了不安全的反序列化。</li><li id="2867" class="mn mo it js b jt mw jx mx kb my kf mz kj na kn ms mt mu mv bi translated"><code class="fe ko kp kq kr b">WhitelistedSerializationStrategy</code>允许指定允许反序列化的类的白名单。如果没有指定类别，该策略将使用默认的白名单:<code class="fe ko kp kq kr b">java.lang.*</code>、<code class="fe ko kp kq kr b">java.util.*</code>和<code class="fe ko kp kq kr b">org.springframework.security.*</code>。</li><li id="e69f" class="mn mo it js b jt mw jx mx kb my kf mz kj na kn ms mt mu mv bi translated">向<code class="fe ko kp kq kr b">SerializationUtils</code>类添加了一个新的静态<code class="fe ko kp kq kr b">SerializationStrategy</code>字段。默认策略是不安全的<code class="fe ko kp kq kr b">DefaultSerializationStrategy</code>。</li><li id="57c2" class="mn mo it js b jt mw jx mx kb my kf mz kj na kn ms mt mu mv bi translated">该策略可以通过调用新的<code class="fe ko kp kq kr b">SerializationUtils.setSerializationStrategy()</code>方法或在<code class="fe ko kp kq kr b">META-INF/spring.factories</code>文件中指定策略来覆盖。</li></ol><p id="7f50" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，用户可以使用以下代码启用默认白名单:</p><pre class="ku kv kw kx gt me kr mf mg aw mh bi"><span id="38f6" class="mi lc it kr b gy mj mk l ml mm">SerializationUtils.setSerializationStrategy(new WhitelistedSerializationStrategy());</span></pre><p id="54ab" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">或者，用户可以实现自己的序列化策略，例如，通过扩展<code class="fe ko kp kq kr b">WhitelistedSerializationStrategy</code>类:</p><pre class="ku kv kw kx gt me kr mf mg aw mh bi"><span id="f55a" class="mi lc it kr b gy mj mk l ml mm">package org.custom.impl.oauth2;</span><span id="2455" class="mi lc it kr b gy nc mk l ml mm">public class CustomSerializationStrategy<br/>    extends WhitelistedSerializationStrategy {</span><span id="77ea" class="mi lc it kr b gy nc mk l ml mm">        private static final List&lt;String&gt; ALLOWED_CLASSES <br/>                = new ArrayList&lt;String&gt;();<br/>        static {<br/>            ALLOWED_CLASSES.add("java.lang.");<br/>            ALLOWED_CLASSES.add("java.util.");<br/>            ALLOWED_CLASSES.add("org.springframework.security.");<br/>            ALLOWED_CLASSES.add("org.custom.impl.oauth2.");<br/>        }</span><span id="80ad" class="mi lc it kr b gy nc mk l ml mm">        CustomSerializationStrategy() {<br/>            super(ALLOWED_CLASSES);<br/>        }<br/>    }<br/>}</span></pre><p id="81e1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">下面是用户如何在<code class="fe ko kp kq kr b">META-INF/spring.factories</code>文件中指定<code class="fe ko kp kq kr b">WhitelistedSerializationStrategy</code>策略:</p><pre class="ku kv kw kx gt me kr mf mg aw mh bi"><span id="5bbb" class="mi lc it kr b gy mj mk l ml mm">org.springframework.security.oauth2.common.util.SerializationStrategy = \<br/>org.springframework.security.oauth2.common.util.WhitelistedSerializationStrategy</span></pre><p id="8020" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当然，<code class="fe ko kp kq kr b">META-INF/spring.factories</code>也允许使用定制的序列化策略。</p><h1 id="0836" class="lb lc it bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="d9be" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated">默认情况下，Spring Security OAuth2库仍然以不安全的方式使用反序列化，这可能会使应用程序易受攻击。尽管所讨论的反序列化缺陷可能很难被利用，但为了安全起见，启用<code class="fe ko kp kq kr b">WhitelistedSerializationStrategy</code>可能更好。</p><h1 id="f5f7" class="lb lc it bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">参考</h1><ol class=""><li id="9038" class="mn mo it js b jt lz jx ma kb nd kf ne kj nf kn ms mt mu mv bi translated"><a class="ae ks" href="https://github.com/spring-projects/spring-security-oauth" rel="noopener ugc nofollow" target="_blank">春季安检口</a></li><li id="b7fa" class="mn mo it js b jt mw jx mx kb my kf mz kj na kn ms mt mu mv bi translated"><a class="ae ks" href="https://docs.oracle.com/javase/8/docs/api/java/io/ObjectInputStream.html" rel="noopener ugc nofollow" target="_blank">目标输入流</a></li><li id="5022" class="mn mo it js b jt mw jx mx kb my kf mz kj na kn ms mt mu mv bi translated"><a class="ae ks" href="https://openjdk.java.net/jeps/290" rel="noopener ugc nofollow" target="_blank"> JEP 290 </a></li><li id="2efe" class="mn mo it js b jt mw jx mx kb my kf mz kj na kn ms mt mu mv bi translated"><a class="ae ks" href="https://commons.apache.org/proper/commons-io/javadocs/api-2.5/org/apache/commons/io/serialization/ValidatingObjectInputStream.html" rel="noopener ugc nofollow" target="_blank">验证目标输入流</a></li></ol></div><div class="ab cl ng nh hx ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="im in io ip iq"><p id="d49e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="nn">原载于2019年11月16日</em><a class="ae ks" href="https://blog.gypsyengineer.com/en/security/safer-deserialization-in-spring-security-oauth.html" rel="noopener ugc nofollow" target="_blank"><em class="nn">https://blog.gypsyengineer.com</em></a><em class="nn">。</em></p></div><div class="ab cl ng nh hx ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="im in io ip iq"><p id="0a91" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="nn">关注</em> <a class="ae ks" href="https://medium.com/bugbountywriteup" rel="noopener"> <em class="nn"> Infosec报道</em> </a> <em class="nn">获取更多此类精彩报道。</em></p><div class="no np gp gr nq nr"><a href="https://medium.com/bugbountywriteup" rel="noopener follow" target="_blank"><div class="ns ab fo"><div class="nt ab nu cl cj nv"><h2 class="bd iu gy z fp nw fr fs nx fu fw is bi translated">信息安全报道</h2><div class="ny l"><h3 class="bd b gy z fp nw fr fs nx fu fw dk translated">收集了世界上最好的黑客的文章，主题从bug奖金和CTF到vulnhub…</h3></div><div class="nz l"><p class="bd b dl z fp nw fr fs nx fu fw dk translated">medium.com</p></div></div><div class="oa l"><div class="ob l oc od oe oa of kz nr"/></div></div></a></div></div></div>    
</body>
</html>