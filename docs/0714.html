<html>
<head>
<title>DNS Rebinding, The treacherous attack it can be</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">DNS重新绑定，这是一种危险的攻击</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/dns-rebinding-the-treacherous-attack-it-can-be-b367c61b4372?source=collection_archive---------0-----------------------#2020-07-25">https://infosecwriteups.com/dns-rebinding-the-treacherous-attack-it-can-be-b367c61b4372?source=collection_archive---------0-----------------------#2020-07-25</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="95f4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">真的。一件非常非常糟糕的事情。幸运的是，大多数时候你都是偶然发现的，而不是你故意发现的。当然，也许它会找你麻烦，谁知道呢。不管怎样，到目前为止，我已经经历了大约四次了。四次中，只有一次我真的把它修好了。</p><p id="4927" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这将不会是一个故事，它如何工作，直到它没有，或发生了一些事情，导致它停止正常工作，等等。这是关于我是如何让它工作的，我得到了结果，还有…有问题的aws实例不属于有问题的bbp。去想想。</p><p id="2cd1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">它是什么，如何工作:</strong></p><p id="625c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">首先，你为什么会陷入DNS重新绑定攻击，尤其是在做bug狩猎的时候？因为你得到了一个HTTP pingback，加分IP地址解析为aws。</p><p id="fcd4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">但是，什么是DNS重新绑定攻击呢？最简单的解释是(几乎有更长更漂亮的关于这个主题的文章，但不是这个),这是一种欺骗受害者(或具有javascript支持的无头web浏览器，这是必不可少的)的方法，使攻击者的服务器连接到它，然后快速切换到本地IP地址。有了这个“掩护”，攻击者就能够提取通常阻止外部IP地址而不是本地IP地址的内部网络信息。在aws的情况下，这意味着如果你将自己伪装成本地主机IP地址，那么你将能够访问<a class="ae ko" href="http://169.254.169.254/latest/meta-data" rel="noopener ugc nofollow" target="_blank">http://169 . 254 . 169 . 254/latest/meta-data</a>并在它下面填充内容，就好像你是内部网络的一部分一样。</p><p id="dac7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">但是，如何让您的服务器欺骗受害者，使它看起来好像是本地IP地址？嗯，有很多很多工具/框架需要你做一些调整，比如输入你的vps IP地址和可用端口(通常是8080或8000，你懂的)。据我所知，在所有情况下，最大的问题是，它还需要你将你的vps投入到这种攻击中，直到你要么完成它，要么放弃，无论哪种情况先发生，因为你需要停止你的vps上的DNS服务。当你这么做的时候会发生什么？如果你不知道，停止DNS服务，如命名和/或绑定，使你的vps仅限于与外界通信，只允许连接到它，这是非常多的。不能用wget，不能ping任何东西(其实可以，但是ping会显示本地IP地址)之类的。您唯一可以主动使用它的是，一旦受害者(无头web浏览器)最终触发您的DNS重新绑定负载(无论是进行端口扫描、aws数据提取、jenkins、IoT等的负载),就提取远程DNS重新绑定易受攻击服务器的内部网络信息。)</p><p id="6fae" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">下面是这个过程的图形简化(代码会及时出现):</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="gh gi kp"><img src="../Images/79befa174c21ce032f2cde4df3270841.png" data-original-src="https://miro.medium.com/v2/resize:fit:1090/format:webp/1*HiU3-hN9ePTMzDII4hgtTg.png"/></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">由于空间原因，我使用了0.0.0.0而不是169.254.169.254</figcaption></figure><p id="79ee" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">真实世界攻击—第1部分:准备</strong></p><p id="da26" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">受影响方的代码/PoC被改变/隐藏。</p><p id="acf7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我使用了奇点，你可以在这里阅读和下载整个东西:【https://github.com/nccgroup/singularity<a class="ae ko" href="https://github.com/nccgroup/singularity" rel="noopener ugc nofollow" target="_blank"/></p><p id="f475" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这是我在数字海洋上的DNS配置，网址是通过freenom免费注册的:【https://www.freenom.com/<a class="ae ko" href="https://www.freenom.com/" rel="noopener ugc nofollow" target="_blank">，其中域名服务器设置为指向数字海洋。</a></p><p id="1100" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这是我为这次特殊攻击设置的数字海洋DNS:</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="gh gi lb"><img src="../Images/efe2b940e2d1f9a76ba114b343a88224.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*z6XJ8K4tpH6Mqfq-ixrlTQ.png"/></div></div></figure><p id="3c06" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">情节转折——是时候改变你对接下来发展的预期了，因为我无法让它按照指示工作(你可能会有更好的运气),但我仍然得到了结果。</p><p id="90a5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">由于无法在任何时候将我的东西解析到127.0.0.1，因此无法欺骗受害者(无头网络浏览器)让我进入，我采用了50-50的解决方案。也许更像30-70。因为在30%中，我的修改是为了得到几乎想要的结果(我说几乎想要，是因为除了/latest/metadata中的默认aws路径之外，我不能使用任何东西)到我可以读取它们的地方。70%是处于几乎默认模式的工具(默认模式是aws路径，按照<a class="ae ko" href="https://github.com/nccgroup/singularity/blob/master/html/payloads/aws-metadata-exfil.js" rel="noopener ugc nofollow" target="_blank">https://github . com/NCC group/singularity/blob/master/html/payloads/AWS-metadata-exfil . js</a>，而将输出发送给我的代码必须添加到我的服务器上的autoattack.html内部)。</p><p id="6e02" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">先决条件:</p><p id="1915" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">1 —你需要副总裁</p><p id="9cc1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">2-你需要一个付费的网络主机或免费域名(付费的网络主机可能比免费域名走得更远，但是对于这个概念验证，我使用了免费域名)</p><p id="9277" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">3 —关键要求—目标必须支持JS</p><p id="05dd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">4 —(可选？)耐心</p><p id="67b6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">首先，您必须确定您得到的HTTP pingback(顺便说一下，在我的例子中是通过Referer header)支持javascript。</p><p id="34c0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您可以简单地添加如下内容:</p><p id="3a09" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><script src="//jstest.burpcollaborator.net">T9】&lt;/root&gt;</script></p><p id="f52c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">你可以把这个文件命名为index.html，这样你就可以处理pingback只针对根页面的情况。有时可以使用/autoattack.html(在这种情况下，我能够指定页面)，但在大多数情况下，最安全的做法是使用index.html，然后您可以只使用</p><p id="39a4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">推荐人:<a class="ae ko" href="http://yourserver.com/" rel="noopener ugc nofollow" target="_blank">http://yourserver.com/</a>完事。</p><p id="b15a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，等待。为了确保你不会等待永远不会到来的js，你需要在你的服务器上监控access.log或者类似的东西，或者对1.burpcollaborator.net、yourserver.com、2.burpcollaborator.net发出一个请求。如果你在burpcollaborator.net的1号和2号网站上得到http回应，而在jstest.burpcollaborator.net却没有，这可能意味着javascript支持没有通过。这样你可能就避免了令人头疼的DNS重新绑定攻击，即使它成功了，也可能会超出bug bounty计划的范围。如果jstest.burpcollaborator.net能成功，那我祝你好运。</p><p id="bf47" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">真实世界的攻击——第二部分:开始吧。概念验证</p><p id="7ba3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在我确定js是受支持的之后，是时候去争取了。我确实有一个DNS服务器缓存的问题，这导致我不得不改变我的freenom域名的名称，以绕过它，但这是一个快速修复。</p><p id="0c73" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我已经下载了奇点，并按照所有的指示让它运行起来。</p><p id="422c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然后，我按照说明编辑了/root/singularity/html下的各种文件</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="gh gi lg"><img src="../Images/ba744cf3a95dd6a7592fc1afcbba860c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*73qKDTi3TaplaNuJokvEdw.png"/></div></div></figure><p id="d9f4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然后我试了一下，然后…我特别是在js上发现了很多未发现的错误。这是因为*.myserver.tk的解析不想切换到127.0.0.1，因此它无法访问子文件夹中本地托管的js文件。但是，我就是我，这实质上意味着找到绕过事情的方法，那些不理想的方法，但是，嘿，它完成了工作，意味着我必须对代码做一些巧妙的编辑。我想，如果我可以保留autoattack.html内部的默认IP地址，同时添加一段代码来将输出发送到我的目的地，我就不必担心设置任何东西，除了让singularity在我的服务器上以几乎默认的模式运行之外，然后解析我的freenom域名就无关紧要了:</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="gh gi lh"><img src="../Images/f11846fee4e457206e4423f279c3303f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*84aZpGvOtEFHoEwhFP5d4w.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">左:原始代码，右:突出显示添加的代码</figcaption></figure><p id="5ac9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然后我重复发送了这个请求:</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="gh gi li"><img src="../Images/5e41599fdde5b1ec2d252cf6893ce81c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CPc3e_mDF9Ge5fElsmxyfQ.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">如前所述，在这种情况下，我能够指定页面</figcaption></figure><p id="56f0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="lj">此外，回应并不重要。根据我的经验，您可能会得到404，但几天后仍然会得到HTTP和/或DNS pingback。</em></p><p id="5924" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然后我就等了。我等待着。我等待着。然后:</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="gh gi lk"><img src="../Images/18a31f0d97e09ea06975ebd62dfa0e72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1212/format:webp/1*nmktckssi8VvSitWjocnQw.png"/></div></figure><p id="d6f1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">接下来的兴奋是我在公寓里走来走去，自鸣得意，自言自语“这个男人是谁？我是男人，是的，这就是我所说的“和这样的。这也与一个事实有关，那就是有问题的臭虫奖励计划是那些能为这类臭虫支付巨额奖金的计划之一。</p><p id="e309" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">喜悦过后,“我做到了”的感觉和其他刺痛的感觉平静下来，是时候写报告并提交了。</p><p id="c027" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在几个来回的消息之后，有问题的bbp从aws IP地址确定这不是他们的aws实例。他们认为可能是一些分析aws简单地跟踪了他们(bbp)页面上的推荐网址，并触发了来自分析端的HTTP pingback，因此浪费了我很多时间。嗯，也许这不是完全浪费时间，我学到了一两件事。</p><p id="42dd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">参考文献:</strong></p><p id="c797" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这些是我在工作中遇到困难的一些参考资料和其他工具，也许你会做得更好，对于那些敢于冒险的人，有时会紧张地追求这种可怕但仍然很酷的攻击:</p><p id="eca6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">https://github.com/FSecureLABS/dref<a class="ae ko" href="https://github.com/FSecureLABS/dref" rel="noopener ugc nofollow" target="_blank"/>——我要说的是，几年前，我设法让它正常工作，但最近我试用时遇到了问题。但是，我也对我的vps配置做了一些调整，尤其是在DNS和添加虚拟主机方面。不确定这是否与它的“崩溃”有关，但我认为最好提供免责声明，说明为什么我在这里建议它，但最近它没有工作。</p><p id="8f92" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><a class="ae ko" href="https://medium.com/@brannondorsey/attacking-private-networks-from-the-internet-with-dns-rebinding-ea7098a2d325" rel="noopener">https://medium . com/@ brannon dorsey/attack-private-networks-from-the-internet-with-DNS-rebinding-ea 7098 a2 d 325</a></p><p id="0465" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><a class="ae ko" href="https://portswigger.net/research/cracking-the-lens-targeting-https-hidden-attack-surface" rel="noopener ugc nofollow" target="_blank">https://ports wigger . net/research/cracking-the-lens-targeting-https-hidden-attack-surface</a>—不得不加上这个，对吧:)</p></div></div>    
</body>
</html>