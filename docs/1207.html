<html>
<head>
<title>Understanding &amp; Identifying Insecure Deserialization Vulnerabilities</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">理解和识别不安全的反序列化漏洞</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/understanding-identifying-insecure-deserialization-vulnerabilities-f7fac5414bb3?source=collection_archive---------0-----------------------#2021-04-03">https://infosecwriteups.com/understanding-identifying-insecure-deserialization-vulnerabilities-f7fac5414bb3?source=collection_archive---------0-----------------------#2021-04-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="42bc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这篇文章解释了不安全的反序列化漏洞的本质。我们将涵盖基本的理解和识别。，不安全的反序列化——漏洞位于OWASP十大漏洞——2017中的第8位。据说是OWASP Top 10中最难理解的漏洞。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi kl"><img src="../Images/2a2d43abaf74ef33744d79a7ea63d0a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:996/0*_2BHHi07u__4kHW5"/></div></figure><p id="4804" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">不安全的反序列化也是我在采访InfoSec概要文件时经常遇到的问题。这个漏洞肯定有炒作的成分&amp;如果你要参加InfoSec的面试，请把它放在你必须知道的列表中。那么，现在让我们开始吧。</p><h2 id="15ce" class="kt ku iq bd kv kw kx dn ky kz la dp lb jy lc ld le kc lf lg lh kg li lj lk ll bi translated">漏洞背后的根本原因是什么？</h2><blockquote class="lm ln lo"><p id="6e6a" class="jn jo lp jp b jq jr js jt ju jv jw jx lq jz ka kb lr kd ke kf ls kh ki kj kk ij bi translated">简单来说:应用程序<strong class="jp ir">在没有充分验证</strong>结果数据是否有效的情况下反序列化不受信任的数据。</p></blockquote><p id="f48b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当开发人员对“小工具链”或一系列可以在反序列化过程中自动执行的实例和方法调用(即，在对象返回给调用者之前)没有任何限制时，攻击者有时可能利用它们来执行未经授权的操作，比如生成shell。</p><h2 id="5d92" class="kt ku iq bd kv kw kx dn ky kz la dp lb jy lc ld le kc lf lg lh kg li lj lk ll bi translated">什么是序列化？</h2><p id="ec75" class="pw-post-body-paragraph jn jo iq jp b jq lt js jt ju lu jw jx jy lv ka kb kc lw ke kf kg lx ki kj kk ij bi translated">序列化是将一些对象转换成可以在以后恢复的数据格式的过程。人们经常序列化对象，以便将它们保存到存储器中或作为通信的一部分发送。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="gh gi ly"><img src="../Images/b096cbcec6b518ee0c2140e0a6230c03.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p-Dc62T113f60ZHIHLPs_w.png"/></div></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated">序列化-反序列化过程</figcaption></figure><h2 id="0178" class="kt ku iq bd kv kw kx dn ky kz la dp lb jy lc ld le kc lf lg lh kg li lj lk ll bi translated">什么是反序列化？</h2><p id="7e3d" class="pw-post-body-paragraph jn jo iq jp b jq lt js jt ju lu jw jx jy lv ka kb kc lw ke kf kg lx ki kj kk ij bi translated">反序列化是该过程的<strong class="jp ir">逆过程，获取某种格式的结构化数据，并将其重建为一个对象</strong>。序列化数据最流行的数据格式是JSON和XML。</p><p id="4061" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">序列化可以用在</strong> <br/> 1的应用中。远程和进程间通信(RPC/IPC)2。有线协议、web服务、消息代理<br/> 3。缓存/持久化<br/> 4。数据库、缓存服务器、文件系统<br/> 5。HTTP cookies、HTML表单参数、API认证令牌</p><h1 id="0ae3" class="mh ku iq bd kv mi mj mk ky ml mm mn lb mo mp mq le mr ms mt lh mu mv mw lk mx bi translated">识别-您的应用程序易受攻击吗？</h1><p id="b631" class="pw-post-body-paragraph jn jo iq jp b jq lt js jt ju lu jw jx jy lv ka kb kc lw ke kf kg lx ki kj kk ij bi translated">如果应用程序和API对攻击者提供的恶意或被篡改的对象进行反序列化，它们将容易受到攻击<strong class="jp ir">。这可能导致两种主要类型的攻击:</strong></p><ol class=""><li id="11d8" class="my mz iq jp b jq jr ju jv jy na kc nb kg nc kk nd ne nf ng bi translated"><strong class="jp ir">与对象和数据结构相关的攻击</strong>攻击者修改应用程序逻辑或实现任意远程代码执行，前提是应用程序中存在可在反序列化期间或之后改变行为的类。</li><li id="0d6c" class="my mz iq jp b jq nh ju ni jy nj kc nk kg nl kk nd ne nf ng bi translated">典型的数据篡改攻击，如<strong class="jp ir">访问控制相关攻击</strong>，其中使用现有的数据结构，但内容被改变。</li></ol><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/85bf2d62b40daae4cce24f707afb2fcc.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/0*uz-ra5UDO0sSJ3uo"/></div></figure><p id="4840" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">识别不安全的反序列化有时需要进行白盒测试和黑盒测试。</p><h2 id="a855" class="kt ku iq bd kv kw kx dn ky kz la dp lb jy lc ld le kc lf lg lh kg li lj lk ll bi translated">示例:</h2><ol class=""><li id="9423" class="my mz iq jp b jq lt ju lu jy nn kc no kg np kk nd ne nf ng bi translated">让我们以一个与<strong class="jp ir">访问控制相关的攻击为例，</strong> &amp; <strong class="jp ir"> </strong>为了更深入的理解，我们将它分解为:</li></ol><p id="566e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">比如说，一个PHP论坛使用<strong class="jp ir"> PHP对象序列化</strong>保存一个“<strong class="jp ir">超级</strong>”cookie，包含用户的用户ID、角色、密码hash等状态:</p><p id="1542" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">普通用户Cookie: </strong> <br/> <code class="fe nq nr ns nt b">a:4:{i:0;i:132;i:1;s:7:”Mallory”;i:2;s:4:”user”;<br/>i:3;s:32:”b6a8b3bea87fe0e05022f8f3c88bc960";}</code></p><p id="f856" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">攻击者更改序列化的对象以赋予自己管理权限:</p><p id="c0b0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">管理员的超级Cookie: </strong> <br/> <code class="fe nq nr ns nt b">a:4:{i:0;i:1;i:1;s:5:”Alice”;i:2;s:5:”admin”;<br/>i:3;s:32:”b6a8b3bea87fe0e05022f8f3c88bc960";}</code></p><p id="22be" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果上面修改的对象被应用程序反序列化，攻击者可以提升为“admin”。因此，由于易受攻击的<strong class="jp ir"> PHP对象序列化</strong>，绕过了访问控制。</p><h1 id="9a15" class="mh ku iq bd kv mi mj mk ky ml mm mn lb mo mp mq le mr ms mt lh mu mv mw lk mx bi translated">识别已知受影响编程语言中的不安全De <strong class="ak">序列化</strong>:</h1><h2 id="4b53" class="kt ku iq bd kv kw kx dn ky kz la dp lb jy lc ld le kc lf lg lh kg li lj lk ll bi translated">PHP，Python，Java，。Net:白盒和黑盒测试:</h2><ol class=""><li id="9152" class="my mz iq jp b jq lt ju lu jy nn kc no kg np kk nd ne nf ng bi translated"><strong class="jp ir">对于PHP: </strong></li></ol><p id="cf05" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">检查<a class="ae nu" href="https://www.php.net/manual/en/function.unserialize.php" rel="noopener ugc nofollow" target="_blank"> unserialize() </a>函数的使用，并检查外部参数是如何被接受的。</p><p id="1306" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> 2。对于Python: </strong></p><p id="3d55" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Python中的以下API将容易受到序列化攻击。搜索以下模式的代码。</p><ol class=""><li id="51f3" class="my mz iq jp b jq jr ju jv jy na kc nb kg nc kk nd ne nf ng bi translated"><code class="fe nq nr ns nt b">pickle/c_pickle/_pickle</code>与<code class="fe nq nr ns nt b">load/loads</code>的用途:</li></ol><p id="64c8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe nq nr ns nt b">import pickle<br/>data = “”” cos.system(S’dir’)tR. “””<br/>pickle.loads(data)</code></p><p id="8469" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.<code class="fe nq nr ns nt b">PyYAML</code>与<code class="fe nq nr ns nt b">load</code>的用途:</p><p id="704e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe nq nr ns nt b">import yaml<br/>document = “!!python/object/apply:os.system [‘ipconfig’]”<br/>print(yaml.load(document))</code></p><p id="382b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">3.使用<code class="fe nq nr ns nt b">jsonpickle</code>和<code class="fe nq nr ns nt b">encode</code>或<code class="fe nq nr ns nt b">store</code>方法。</p><p id="b169" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">在黑盒评论- </strong></p><p id="9143" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果流量数据在末尾包含符号点<code class="fe nq nr ns nt b">.</code>，很可能数据是以序列化方式发送的。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/fd3102e7a2822757b7d2295df243bfc3.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/0*Gw4JWnyxy7dRCN-v"/></div></figure><p id="e3d8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> 3。对于Java: </strong></p><p id="0de3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请注意以下Java API使用的潜在序列化漏洞。</p><p id="4775" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">1.<code class="fe nq nr ns nt b">XMLdecoder</code>带有外部用户自定义参数</p><p id="dd4d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.<code class="fe nq nr ns nt b">XStream</code>使用<code class="fe nq nr ns nt b">fromXML</code>方法(XStream版本&lt; = v1.46易受序列化问题影响)</p><p id="52ac" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">3.<code class="fe nq nr ns nt b">ObjectInputStream</code>同<code class="fe nq nr ns nt b">readObject</code></p><p id="47c4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">4.<code class="fe nq nr ns nt b">readObject</code>、<code class="fe nq nr ns nt b">readObjectNodData</code>、<code class="fe nq nr ns nt b">readResolve</code>或<code class="fe nq nr ns nt b">readExternal</code>的用途</p><p id="bc22" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">5.<code class="fe nq nr ns nt b">ObjectInputStream.readUnshared</code></p><p id="9c30" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">6.<code class="fe nq nr ns nt b">Serializable</code></p><p id="4a89" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">在黑盒评论- </strong></p><p id="52fa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果捕获的流量数据包括以下模式，则可能表明数据是在Java序列化流中发送的</p><ul class=""><li id="8e6d" class="my mz iq jp b jq jr ju jv jy na kc nb kg nc kk nv ne nf ng bi translated"><code class="fe nq nr ns nt b">AC ED 00 05</code>十六进制</li><li id="1927" class="my mz iq jp b jq nh ju ni jy nj kc nk kg nl kk nv ne nf ng bi translated"><code class="fe nq nr ns nt b">rO0</code>在Base64</li><li id="6fc3" class="my mz iq jp b jq nh ju ni jy nj kc nk kg nl kk nv ne nf ng bi translated"><code class="fe nq nr ns nt b">Content-type</code>设置为<code class="fe nq nr ns nt b">application/x-java-serialized-object</code>的HTTP响应的报头</li></ul><p id="d73f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> 4。因为。Net CSharp </strong></p><p id="b5dc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在源代码<strong class="jp ir">中搜索以下术语:</strong></p><ol class=""><li id="fa65" class="my mz iq jp b jq jr ju jv jy na kc nb kg nc kk nd ne nf ng bi translated"><code class="fe nq nr ns nt b">TypeNameHandling</code></li><li id="faa1" class="my mz iq jp b jq nh ju ni jy nj kc nk kg nl kk nd ne nf ng bi translated"><code class="fe nq nr ns nt b">JavaScriptTypeResolver</code></li></ol><p id="50f6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">查找类型由用户控制的变量设置的任何序列化程序。</p><p id="9fc3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">在黑盒测试中- </strong></p><p id="c55f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">搜索以下以下列内容开头的base64编码内容:</p><p id="9607" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe nq nr ns nt b">AAEAAAD/////</code></p><p id="a503" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用以下文本搜索内容:</p><ol class=""><li id="31f1" class="my mz iq jp b jq jr ju jv jy na kc nb kg nc kk nd ne nf ng bi translated"><code class="fe nq nr ns nt b">TypeObject</code></li><li id="b838" class="my mz iq jp b jq nh ju ni jy nj kc nk kg nl kk nd ne nf ng bi translated"><code class="fe nq nr ns nt b">$type:</code></li></ol><h2 id="d444" class="kt ku iq bd kv kw kx dn ky kz la dp lb jy lc ld le kc lf lg lh kg li lj lk ll bi translated">检测工具:</h2><p id="2425" class="pw-post-body-paragraph jn jo iq jp b jq lt js jt ju lu jw jx jy lv ka kb kc lw ke kf kg lx ki kj kk ij bi translated">Burp Suite扩展，可以简化反序列化漏洞的识别:<a class="ae nu" href="https://github.com/NetSPI/JavaSerialKiller" rel="noopener ugc nofollow" target="_blank"> JavaSerialKiller </a>，<a class="ae nu" href="https://github.com/federicodotta/Java-Deserialization-Scanner" rel="noopener ugc nofollow" target="_blank"> Java反序列化扫描器</a>，<a class="ae nu" href="https://github.com/summitt/burp-ysoserial" rel="noopener ugc nofollow" target="_blank">Burp-y serial</a>，<a class="ae nu" href="https://github.com/DirectDefense/SuperSerial" rel="noopener ugc nofollow" target="_blank"> SuperSerial </a>，<a class="ae nu" href="https://github.com/DirectDefense/SuperSerial-Active" rel="noopener ugc nofollow" target="_blank"> SuperSerial-Active </a>。</p><h2 id="d333" class="kt ku iq bd kv kw kx dn ky kz la dp lb jy lc ld le kc lf lg lh kg li lj lk ll bi translated">缓解措施:仅反序列化签名数据</h2><p id="bae7" class="pw-post-body-paragraph jn jo iq jp b jq lt js jt ju lu jw jx jy lv ka kb kc lw ke kf kg lx ki kj kk ij bi translated">如果应用程序在反序列化之前知道需要处理哪些消息，它们可以在序列化过程中对这些消息进行签名。然后，应用程序可以选择不反序列化任何没有经过验证的签名的消息。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi kl"><img src="../Images/f2c59045e5e2438036452d5c100c55b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:996/0*CUooTxyM8d7EnEk5"/></div></figure><p id="54aa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">练习剥削:</strong></p><div class="nw nx gp gr ny nz"><a href="https://portswigger.net/web-security/deserialization" rel="noopener  ugc nofollow" target="_blank"><div class="oa ab fo"><div class="ob ab oc cl cj od"><h2 class="bd ir gy z fp oe fr fs of fu fw ip bi translated">不安全的反序列化|网络安全学院</h2><div class="og l"><h3 class="bd b gy z fp oe fr fs of fu fw dk translated">在这一节中，我们将讨论什么是不安全的反序列化，并描述它如何潜在地将网站暴露给…</h3></div><div class="oh l"><p class="bd b dl z fp oe fr fs of fu fw dk translated">portswigger.net</p></div></div><div class="oi l"><div class="oj l ok ol om oi on kr nz"/></div></div></a></div><p id="9ebc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">参考:</strong></p><div class="nw nx gp gr ny nz"><a href="https://cheatsheetseries.owasp.org/cheatsheets/Deserialization_Cheat_Sheet.html" rel="noopener  ugc nofollow" target="_blank"><div class="oa ab fo"><div class="ob ab oc cl cj od"><h2 class="bd ir gy z fp oe fr fs of fu fw ip bi translated">反序列化— OWASP备忘单系列</h2><div class="og l"><h3 class="bd b gy z fp oe fr fs of fu fw dk translated">本文旨在为安全地反序列化您的系统中不可信的数据提供清晰、可行的指导</h3></div><div class="oh l"><p class="bd b dl z fp oe fr fs of fu fw dk translated">cheatsheetseries.owasp.org</p></div></div></div></a></div></div></div>    
</body>
</html>