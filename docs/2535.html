<html>
<head>
<title>DLL Hijacking Persistence Using Discord</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Discord的DLL劫持持久性</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/dll-hijacking-persistence-using-discord-80691a63c559?source=collection_archive---------1-----------------------#2022-11-16">https://infosecwriteups.com/dll-hijacking-persistence-using-discord-80691a63c559?source=collection_archive---------1-----------------------#2022-11-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="cdd7" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">古老的黑客技术在今天仍然有效</h2></div><p id="56f4" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在找到几种不同的持久化方法之后。我想验证一个旧的DLL劫持利用持久性。大约9个月前，我在HackerOne上披露了Discord的一个DLL劫持漏洞。但遗憾的是，它并没有被认为是一个弱点。因为它需要物理接触。但是一些bug bounty除外，DLL劫持有足够的可能性。</p><h1 id="1965" class="lb lc iq bd ld le lf lg lh li lj lk ll jw lm jx ln jz lo ka lp kc lq kd lr ls bi translated">剥削</h1><p id="3288" class="pw-post-body-paragraph kf kg iq kh b ki lt jr kk kl lu ju kn ko lv kq kr ks lw ku kv kw lx ky kz la ij bi translated">简而言之，有一个DLL劫持漏洞仍然不和谐。通过在以下目录中放置恶意DLL来获得用户级持久性:</p><p id="cdf0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">% APPDATA %/local/Discord/app-1 . 0 . 9004</strong></p><p id="f42a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这个DLL的名字应该是:【d3d12.dll T2】</p><p id="598b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它不需要DLL挖空或其他花哨的东西。所以，它只会执行你的代码。</p><figure class="lz ma mb mc gt md gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi ly"><img src="../Images/c5fec92caf42ab8fc5681ddc045ab0e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kMS55IuaIUi18_PBWkhMCQ.png"/></div></div></figure><h1 id="9aa2" class="lb lc iq bd ld le lf lg lh li lj lk ll jw lm jx ln jz lo ka lp kc lq kd lr ls bi translated">创建DLL</h1><p id="d117" class="pw-post-body-paragraph kf kg iq kh b ki lt jr kk kl lu ju kn ko lv kq kr ks lw ku kv kw lx ky kz la ij bi translated">使用的代码非常简单。只需使用基本动态链接库(DLL)创建新的visual studio项目</p><figure class="lz ma mb mc gt md gh gi paragraph-image"><div class="gh gi mk"><img src="../Images/f43f2018a4ac81a21b2280e54554b4f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/format:webp/1*hOmBx61mfVWyrLaAwSm9wQ.png"/></div></figure><p id="9313" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">并将主函数更改为下面的代码。所以每当DLL发生什么事情时，就会触发一个弹出消息。</p><pre class="lz ma mb mc gt ml mm mn bn mo mp bi"><span id="0a29" class="mq lc iq mm b be mr ms l mt mu">// dllmain.cpp : Defines the entry point for the DLL application.<br/>#include "pch.h"<br/><br/>BOOL APIENTRY DllMain( HMODULE hModule,<br/>                       DWORD  ul_reason_for_call,<br/>                       LPVOID lpReserved<br/>                     )<br/>{<br/>    switch (ul_reason_for_call)<br/>    {<br/>    case DLL_PROCESS_ATTACH:<br/>        MessageBox(NULL,<br/>            TEXT("DLL Hijacking verified Process Attach"),<br/>            TEXT("DLL Hijack BVS"),<br/>            MB_ICONERROR | MB_OK);<br/><br/>    case DLL_THREAD_ATTACH:<br/>        MessageBox(NULL,<br/>            TEXT("DLL Hijacking verified Thread Attach"),<br/>            TEXT("DLL Hijack BVS"),<br/>            MB_ICONERROR | MB_OK);<br/>    case DLL_THREAD_DETACH:<br/>        MessageBox(NULL,<br/>            TEXT("DLL Hijacking verified Thread Detach"),<br/>            TEXT("DLL Hijack BVS"),<br/>            MB_ICONERROR | MB_OK);<br/>    case DLL_PROCESS_DETACH:<br/>        MessageBox(NULL,<br/>            TEXT("DLL Hijacking verified Proces Detach"),<br/>            TEXT("DLL Hijack BVS"),<br/>            MB_ICONERROR | MB_OK);<br/>        break;<br/>    }<br/>    return TRUE;<br/>}</span></pre><p id="d12e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，您可以基于所需的架构创建一个发布版本，并随时随地使用它！为所有未来的“低挂水果”DLL劫持漏洞检查。</p><h1 id="ac86" class="lb lc iq bd ld le lf lg lh li lj lk ll jw lm jx ln jz lo ka lp kc lq kd lr ls bi translated">将它付诸行动</h1><p id="1e7e" class="pw-post-body-paragraph kf kg iq kh b ki lt jr kk kl lu ju kn ko lv kq kr ks lw ku kv kw lx ky kz la ij bi translated">将您精心制作的DLL放入文件夹时。下一次受害者开始不和谐，DLL将被加载。在这种情况下，DLL将生成一个弹出窗口以便于验证。(有时可能需要一点时间)</p><figure class="lz ma mb mc gt md gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/c0f847530565957dacbd3663c4ac8e5a.png" data-original-src="https://miro.medium.com/v2/resize:fit:422/format:webp/1*jxkHjZUWff_Nt4TvPHoZbA.png"/></div></figure><p id="b840" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">正如您在下面看到的，创建了一个额外的不协调进程，它执行DLL劫持弹出窗口</p><figure class="lz ma mb mc gt md gh gi paragraph-image"><div class="gh gi mw"><img src="../Images/67b47fff67851534631c13b93fc702e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:462/format:webp/1*PDBs423xv_P-UYjeqPQkdQ.png"/></div></figure><p id="8ab3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">交叉引用任务监视器和Process Explorer中的PID，我们可以找到执行的相关命令。</p><pre class="lz ma mb mc gt ml mm mn bn mo mp bi"><span id="aa36" class="mq lc iq mm b be mr ms l mt mu">%appdata%\Local\Discord\app-1.0.9007\Discord.exe --type=gpu-process --field-trial-handle=1636,17570466365889041215,795977594926311709,131072 --disable-features=CookiesWithoutSameSiteMustBeSecure,HardwareMediaKeyHandling,MediaSessionService,SameSiteByDefaultCookies,SpareRendererForSitePerProcess,WinRetrieveSuggestionsOnlyOnDemand --disable-gpu-sandbox --use-gl=disabled --gpu-vendor-id=4318 --gpu-device-id=5058 --gpu-sub-system-id=695482434 --gpu-revision=161 --gpu-driver-version=31.0.15.2647 --gpu-preferences=SAAAAAAAAADoAAAwAAAAAAAAAAAAAAAAAABgAAAQAAAoAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB4AAAAAAAAAHgAAAAAAAAAKAAAAAQAAAAgAAAAAAAAACgAAAAAAAAAMAAAAAAAAAA4AAAAAAAAABAAAAAAAAAAAAAAAAUAAAAQAAAAAAAAAAAAAAAGAAAAEAAAAAAAAAABAAAABQAAABAAAAAAAAAAAQAAAAYAAAAIAAAAAAAAAAgAAAAAAAAA --mojo-platform-channel-handle=3692 /prefetch:2</span></pre><p id="050d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然而，我不能通过在终端中重新运行这个Discord命令来重复这个漏洞。</p><h1 id="6fb0" class="lb lc iq bd ld le lf lg lh li lj lk ll jw lm jx ln jz lo ka lp kc lq kd lr ls bi translated">自己寻找DLL劫持漏洞</h1><p id="454d" class="pw-post-body-paragraph kf kg iq kh b ki lt jr kk kl lu ju kn ko lv kq kr ks lw ku kv kw lx ky kz la ij bi translated">要自己找到DLL劫持漏洞，你可以使用<strong class="kh ir">进程监视器</strong>。Process Monitor是一个用于Windows的高级监控工具，它显示实时文件系统和注册表更改。它带有S<em class="mx">y internal包</em>。它包含了一个用于各种windows相关任务的工具包。</p><p id="c16f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">请参见下面的链接，通过Microsoft store单独下载Process Monitor或下载完整的套件(我推荐Microsoft store，因为它会自动更新。)</p><div class="my mz gp gr na nb"><a href="https://live.sysinternals.com/" rel="noopener  ugc nofollow" target="_blank"><div class="nc ab fo"><div class="nd ab ne cl cj nf"><h2 class="bd ir gy z fp ng fr fs nh fu fw ip bi translated">live.sysinternals.com-/</h2><div class="ni l"><h3 class="bd b gy z fp ng fr fs nh fu fw dk translated">2021年8月20日星期五晚上10:19 670 about _ this _ site . txt 2022年5月1 1日星期三下午5:30 1468320 access chk . exe…</h3></div><div class="nj l"><p class="bd b dl z fp ng fr fs nh fu fw dk translated">live.sysinternals.com</p></div></div></div></a></div><div class="my mz gp gr na nb"><a href="https://apps.microsoft.com/store/detail/sysinternals-suite/9P7KNL5RWT25?hl=nl-nl&amp;gl=nl" rel="noopener  ugc nofollow" target="_blank"><div class="nc ab fo"><div class="nd ab ne cl cj nf"><h2 class="bd ir gy z fp ng fr fs nh fu fw ip bi translated">从微软商店获取Sysinternals套件</h2><div class="ni l"><h3 class="bd b gy z fp ng fr fs nh fu fw dk translated">Sysinternals套件是一个Sysinternals工具包，包括进程浏览器，进程监视器，Sysmon…</h3></div><div class="nj l"><p class="bd b dl z fp ng fr fs nh fu fw dk translated">apps.microsoft.com</p></div></div><div class="nk l"><div class="nl l nm nn no nk np mi nb"/></div></div></a></div><p id="1586" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当启动Proces Monitor时，您会被记录的数量淹没，因此最好选择您的目标并添加一些过滤器。为了找到DLL劫持漏洞，可以使用以下过滤器。</p><figure class="lz ma mb mc gt md gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/adfbe7c81b06140791baf870040cb7c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:950/format:webp/1*ufCamo_9pNBuJrCby-rc3A.png"/></div></figure><p id="05fc" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">找到值名为“未找到”的结果非常重要。指示文件丢失，并且路径以. dll结尾。dll文件。您可以进一步指定过滤器，例如仅列出特定的应用程序。</p><p id="bf29" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你打开Discord你会看到文件中的问题，d3d12.dll不见了。这就是为什么我们用它来劫持DLL。</p><figure class="lz ma mb mc gt md gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi nr"><img src="../Images/d8301ef8cf15ecb10e514eb05b497f5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bBJWCXaGlyeebcJQct9DrA.png"/></div></div></figure><h1 id="d05a" class="lb lc iq bd ld le lf lg lh li lj lk ll jw lm jx ln jz lo ka lp kc lq kd lr ls bi translated"><strong class="ak">用于检测/缓解:</strong></h1><ol class=""><li id="a142" class="ns nt iq kh b ki lt kl lu ko nu ks nv kw nw la nx ny nz oa bi translated">将文件更改限制在<strong class="kh ir">% APPDATA %/local/Discord/app-1 . 0 . 9004</strong>目录中，或者在那里放置您自己的DLL并验证哈希更改。</li><li id="afbe" class="ns nt iq kh b ki ob kl oc ko od ks oe kw of la nx ny nz oa bi translated">监视这个特定的DLL名称，并检查它是否被加载到discord中。</li><li id="b047" class="ns nt iq kh b ki ob kl oc ko od ks oe kw of la nx ny nz oa bi translated">对于您的应用程序，您可以利用散列，并在加载文件之前验证散列没有改变。</li><li id="ec67" class="ns nt iq kh b ki ob kl oc ko od ks oe kw of la nx ny nz oa bi translated">还建议不要从用户可写的位置加载文件。尤其是像SYSTEM这样需要更高权限的时候。</li></ol><h1 id="3cfb" class="lb lc iq bd ld le lf lg lh li lj lk ll jw lm jx ln jz lo ka lp kc lq kd lr ls bi translated"><strong class="ak">结论</strong></h1><p id="e4a7" class="pw-post-body-paragraph kf kg iq kh b ki lt jr kk kl lu ju kn ko lv kq kr ks lw ku kv kw lx ky kz la ij bi translated">有趣的是，有人可以很容易地通过利用DLL劫持获得持久性。有许多应用程序都存在这种漏洞，很难验证所有的应用程序。如果你在进程监视器中监视它们，你会震惊地发现有多少DLL被错误地加载。<br/>如果你想讨论任何与信息安全相关的话题，我在LinkedIn上:<a class="ae og" href="https://www.linkedin.com/in/bobvanderstaak/" rel="noopener ugc nofollow" target="_blank">https://www.linkedin.com/in/bobvanderstaak/</a></p></div><div class="ab cl oh oi hu oj" role="separator"><span class="ok bw bk ol om on"/><span class="ok bw bk ol om on"/><span class="ok bw bk ol om"/></div><div class="ij ik il im in"><h2 id="9c62" class="oo lc iq bd ld op oq dn lh or os dp ll ko ot ou ln ks ov ow lp kw ox oy lr oz bi translated">来自Infosec的报道:Infosec每天都有很多内容，很难跟上。<a class="ae og" href="https://weekly.infosecwriteups.com/" rel="noopener ugc nofollow" target="_blank">加入我们的每周简讯</a>以5篇文章、4个线程、3个视频、2个GitHub Repos和工具以及1个工作提醒的形式免费获取所有最新的Infosec趋势！</h2></div></div>    
</body>
</html>