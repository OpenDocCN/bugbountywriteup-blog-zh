<html>
<head>
<title>HTB ‘Blackfield’ [Writeup]</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">HTB·布莱克菲尔德[特写]</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/htb-blackfield-writeup-e7c3570aca00?source=collection_archive---------1-----------------------#2022-11-01">https://infosecwriteups.com/htb-blackfield-writeup-e7c3570aca00?source=collection_archive---------1-----------------------#2022-11-01</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="22fe" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated"><strong class="ak"> ASREPRoast </strong> |字典攻击|</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/1066e83ff11b97d800c36ba3db7dc867.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*cyVwYPKkPbfAmgeP"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@aaronburden?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">亚伦·伯顿</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><h2 id="fd56" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">摘要</h2><p id="202e" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated">我迄今为止尝试的第一台硬机器。用户需要大量的枚举和耐心来慢慢爬上梯子。对于该机器，来自开放SMB端口的暴露用户列表进一步允许主动域侦测提升权限并成为根用户。这台机器不需要利用漏洞。</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><p id="963b" class="pw-post-body-paragraph lv lw it lx b ly mv ju ma mb mw jx md li mx mf mg lm my mi mj lq mz ml mm mn im bi translated"><strong class="lx iu">计算平台:</strong> Windows</p><p id="7b35" class="pw-post-body-paragraph lv lw it lx b ly mv ju ma mb mw jx md li mx mf mg lm my mi mj lq mz ml mm mn im bi translated"><strong class="lx iu">使用的工具:</strong> nmap | john the ripper用于破解哈希</p><p id="25dd" class="pw-post-body-paragraph lv lw it lx b ly mv ju ma mb mw jx md li mx mf mg lm my mi mj lq mz ml mm mn im bi translated"><strong class="lx iu"> CVE(美国):</strong>不适用</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h2 id="c484" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">列举</h2><p id="aa30" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated">Nmap TCP扫描输出</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi na"><img src="../Images/b9d3b818886e44f2ea7f0233351b2afc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nS5WtFrZt5KuaOj9XIkBvQ.png"/></div></div></figure><p id="de70" class="pw-post-body-paragraph lv lw it lx b ly mv ju ma mb mw jx md li mx mf mg lm my mi mj lq mz ml mm mn im bi translated">nmap的结果让我们得到了域名<strong class="lx iu"> blackfield.local </strong>。将此保存在<strong class="lx iu"> /etc/hosts </strong>文件中。还要注意这里的关键词:<strong class="lx iu"> Kerberos，msrpc，Active Directory LDAP，domain，smb(微软-ds)。</strong></p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><p id="3534" class="pw-post-body-paragraph lv lw it lx b ly mv ju ma mb mw jx md li mx mf mg lm my mi mj lq mz ml mm mn im bi translated"><strong class="lx iu">* * * * * * * *端口445微软-ds(SMB)* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *</strong></p><p id="63aa" class="pw-post-body-paragraph lv lw it lx b ly mv ju ma mb mw jx md li mx mf mg lm my mi mj lq mz ml mm mn im bi translated">该机器有一个开放的SMBserver，不需要任何身份验证。发现的两个有趣的文件是:<strong class="lx iu">法医</strong>和<strong class="lx iu">个人资料$ </strong>。</p><p id="33ec" class="pw-post-body-paragraph lv lw it lx b ly mv ju ma mb mw jx md li mx mf mg lm my mi mj lq mz ml mm mn im bi translated"><strong class="lx iu">取证</strong>共享需要认证，但<strong class="lx iu">配置文件$ </strong>共享不需要。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nb"><img src="../Images/515a78095e7c498a94fdcccb829f1b4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hE3j5csanSUQBzW8hRhXzg.png"/></div></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nc"><img src="../Images/bc6fe872df8c5692b4f0b5e8b36ee2e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2938cefZ08A8GtLroj3Chg.png"/></div></div></figure><p id="3248" class="pw-post-body-paragraph lv lw it lx b ly mv ju ma mb mw jx md li mx mf mg lm my mi mj lq mz ml mm mn im bi translated">配置文件$ share包含用户名列表。我将这个列表保存在另一个文件中，并使用以下命令删除了剩余的数据:</p><p id="4362" class="pw-post-body-paragraph lv lw it lx b ly mv ju ma mb mw jx md li mx mf mg lm my mi mj lq mz ml mm mn im bi translated"><code class="fe nd ne nf ng b">cut -d “ ”-f 3 users.txt</code></p><p id="d653" class="pw-post-body-paragraph lv lw it lx b ly mv ju ma mb mw jx md li mx mf mg lm my mi mj lq mz ml mm mn im bi translated">发现的项目:(1。)域名(blackfield.local)来自nmap (2。)通过smb的用户列表。</p><p id="7069" class="pw-post-body-paragraph lv lw it lx b ly mv ju ma mb mw jx md li mx mf mg lm my mi mj lq mz ml mm mn im bi translated">接下来，我们检查这些用户的有效性。</p><p id="35ad" class="pw-post-body-paragraph lv lw it lx b ly mv ju ma mb mw jx md li mx mf mg lm my mi mj lq mz ml mm mn im bi translated"><strong class="lx iu">作为重新发布</strong></p><p id="eb4f" class="pw-post-body-paragraph lv lw it lx b ly mv ju ma mb mw jx md li mx mf mg lm my mi mj lq mz ml mm mn im bi translated">在搜索与Kerberos相关的攻击时，根据这篇<a class="ae ky" href="https://gist.github.com/TarlogicSecurity/2f221924fef8c14a1d8e29f3cb5c5c4a" rel="noopener ugc nofollow" target="_blank">文章</a>，我们了解到<strong class="lx iu"> Impackets </strong>库中的工具<code class="fe nd ne nf ng b">GetNPUsers.py</code>不需要凭据就可以运行该命令。只有域和用户文件。这种攻击被称为<strong class="lx iu">重发</strong>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nh"><img src="../Images/72b4f801d7d9021330bd1e34dcea53c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N3t31uN76LCVvwVrMTIyAQ.png"/></div></div></figure><p id="11a9" class="pw-post-body-paragraph lv lw it lx b ly mv ju ma mb mw jx md li mx mf mg lm my mi mj lq mz ml mm mn im bi">— — — — — — — — — — — — — — — — — — — — — — — — — — — — — —</p><p id="fa0f" class="pw-post-body-paragraph lv lw it lx b ly mv ju ma mb mw jx md li mx mf mg lm my mi mj lq mz ml mm mn im bi translated">根据这篇<a class="ae ky" href="https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/as-rep-roasting-using-rubeus-and-hashcat" rel="noopener ugc nofollow" target="_blank">文章</a>，AS-REP <strong class="lx iu">烘焙</strong>是“<em class="ni">一种允许为选择了</em> <code class="fe nd ne nf ng b"><em class="ni"> Do not require Kerberos preauthentication</em></code> <em class="ni">属性的用户检索密码哈希的技术”。</em></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nj"><img src="../Images/0cb1c8b2bae61095df74791845c45da3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ed1fskUU8XdZEiI9oetWOA.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/as-rep-roasting-using-rubeus-and-hashcat" rel="noopener ugc nofollow" target="_blank">https://www . ired . team/offensive-security-experiments/active-directory-Kerberos-abuse/as-rep-baking-using-rube us-and-hashcat</a></figcaption></figure><p id="06da" class="pw-post-body-paragraph lv lw it lx b ly mv ju ma mb mw jx md li mx mf mg lm my mi mj lq mz ml mm mn im bi translated"><a class="ae ky" href="https://ldapwiki.com/wiki/Kerberos%20Pre-Authentication" rel="noopener ugc nofollow" target="_blank"> ldapwiki </a>声明<strong class="lx iu">"<em class="ni">Kerberos Pre</em></strong><em class="ni">-</em><strong class="lx iu"><em class="ni">认证</em> </strong> <em class="ni">是一种安全特性，可提供针对密码猜测攻击的保护。AS请求以明文形式向KDC标识客户端。如果</em><strong class="lx iu"><em class="ni">Kerberos Pre</em></strong><em class="ni">-</em><strong class="lx iu"><em class="ni">认证</em> </strong> <em class="ni">启用，时间戳将使用用户的密码哈希作为加密密钥进行加密。</em></p><p id="b99b" class="pw-post-body-paragraph lv lw it lx b ly mv ju ma mb mw jx md li mx mf mg lm my mi mj lq mz ml mm mn im bi">— — — — — — — — — — — — — — — — — — — — — — — — — — — — — —</p><p id="d36f" class="pw-post-body-paragraph lv lw it lx b ly mv ju ma mb mw jx md li mx mf mg lm my mi mj lq mz ml mm mn im bi translated"><code class="fe nd ne nf ng b">GetNPUsers.py</code>需要域名，确保<strong class="lx iu"> blackfield.local </strong>设置在<strong class="lx iu"> /etc/hosts </strong>下。</p><p id="f287" class="pw-post-body-paragraph lv lw it lx b ly mv ju ma mb mw jx md li mx mf mg lm my mi mj lq mz ml mm mn im bi translated">运行此命令引发了以下两个图像中显示的错误。</p><p id="e84a" class="pw-post-body-paragraph lv lw it lx b ly mv ju ma mb mw jx md li mx mf mg lm my mi mj lq mz ml mm mn im bi translated">我们发现用户<strong class="lx iu"> audit2020 </strong>和<strong class="lx iu"> svc_backup </strong>不需要kerberos预认证。</p><p id="3842" class="pw-post-body-paragraph lv lw it lx b ly mv ju ma mb mw jx md li mx mf mg lm my mi mj lq mz ml mm mn im bi translated">因此，密码哈希已通过此攻击被检索到。</p><p id="7aa6" class="pw-post-body-paragraph lv lw it lx b ly mv ju ma mb mw jx md li mx mf mg lm my mi mj lq mz ml mm mn im bi translated"><code class="fe nd ne nf ng b">python3 /usr/local/bin/GetNPUsers.py blackfield.local/ -usersfile users.txt</code></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nk"><img src="../Images/72a948070b6f0170c659107b8f11854e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kQcC6BJfN0KhFtiPuy1CVA.png"/></div></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nl"><img src="../Images/36cf4983d8562d3f8e5dd6b7c29c1db9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ozCP96pXemWtF4octsomkw.png"/></div></div></figure><p id="167e" class="pw-post-body-paragraph lv lw it lx b ly mv ju ma mb mw jx md li mx mf mg lm my mi mj lq mz ml mm mn im bi translated">…约翰破解了这个散列的密码。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nm"><img src="../Images/a1e8aeb8cb923f81d490f49906053672.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nhrHlU3hVRQuPKX1zXS-IQ.png"/></div></div></figure><p id="fd7b" class="pw-post-body-paragraph lv lw it lx b ly mv ju ma mb mw jx md li mx mf mg lm my mi mj lq mz ml mm mn im bi translated"><strong class="lx iu">* * * * * * * * * *端口135 RPC客户端* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *</strong></p><p id="b236" class="pw-post-body-paragraph lv lw it lx b ly mv ju ma mb mw jx md li mx mf mg lm my mi mj lq mz ml mm mn im bi translated">使用找到的凭证，我能够登录到rpcclient。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nn"><img src="../Images/57c26ee1d7e126e913c83a59afcae07d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3lgGC20kYuMvq2sJilZCSA.png"/></div></div></figure><p id="db72" class="pw-post-body-paragraph lv lw it lx b ly mv ju ma mb mw jx md li mx mf mg lm my mi mj lq mz ml mm mn im bi translated">对于rpcclient的active directory侦察，我使用了这篇<a class="ae ky" href="https://bitvijays.github.io/LFF-IPS-P3-Exploitation.html" rel="noopener ugc nofollow" target="_blank">文章</a>，并发现在这里可以重置用户密码。</p><p id="8f5c" class="pw-post-body-paragraph lv lw it lx b ly mv ju ma mb mw jx md li mx mf mg lm my mi mj lq mz ml mm mn im bi translated">从用户列表中，尝试重置所有用户的密码，并尝试登录需要用户身份验证的SMB:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi no"><img src="../Images/410941d86fdbf5b96c5fa6e9f4206ad2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1192/format:webp/1*QXaPycZ4XnK95lziHr3egA.png"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi np"><img src="../Images/dbc6f18cfe60c5469c4d77e941cb421a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/format:webp/1*PnLJ7W8AIFsVd1r8rffwOw.png"/></div></figure><p id="90b7" class="pw-post-body-paragraph lv lw it lx b ly mv ju ma mb mw jx md li mx mf mg lm my mi mj lq mz ml mm mn im bi translated">在这里，我更改了<strong class="lx iu"> audit2020 </strong>用户的密码。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nq"><img src="../Images/5f313874f37f438c5db271b02b909110.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xRon1aCQNFZmFQLb7bqOaQ.png"/></div></div></figure></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h2 id="41f3" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">据点</h2><p id="11ba" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated">现在回到<strong class="lx iu"> SMBClient </strong>，以<strong class="lx iu"> audit2020 </strong>登录并访问最初需要认证的<strong class="lx iu"> forensic </strong>共享。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nr"><img src="../Images/53b1f78e444892ef3ba0b30c471d200f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kjF1a77g73_Z_IheHxLNsw.png"/></div></div></figure><p id="56c9" class="pw-post-body-paragraph lv lw it lx b ly mv ju ma mb mw jx md li mx mf mg lm my mi mj lq mz ml mm mn im bi translated">使用<code class="fe nd ne nf ng b">get lsass.zip</code>命令将其下载到您的本地机器上。</p><p id="1b22" class="pw-post-body-paragraph lv lw it lx b ly mv ju ma mb mw jx md li mx mf mg lm my mi mj lq mz ml mm mn im bi translated">我安装了pypykatz并从lsass获取了内容。DMP档案。</p><p id="38e9" class="pw-post-body-paragraph lv lw it lx b ly mv ju ma mb mw jx md li mx mf mg lm my mi mj lq mz ml mm mn im bi translated"><code class="fe nd ne nf ng b">python3 /usr/local/bin/pypykatz lsa minidump lsass.DMP</code></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/278c6e2eb2083a9912291d223130b851.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P-4eg7ytT98qLcTq2X4j6A.png"/></div></div></figure><p id="c0ae" class="pw-post-body-paragraph lv lw it lx b ly mv ju ma mb mw jx md li mx mf mg lm my mi mj lq mz ml mm mn im bi translated"><strong class="lx iu">* * * * * * * * * *端口5985 WinRM * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *</strong></p><h2 id="175c" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">反向外壳</h2><p id="3dae" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated"><code class="fe nd ne nf ng b">ruby /var/www/html/windows/evil-winrm/evil-winrm.rb -i 10.10.10.192 -u svc_backup -H 9658d1d1dcd9250115e2205d9f48400d</code></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/b7fb9ce84a55fe0dd42053f4523e08f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sY_sOdWIpfZJVjNvEIKWfw.png"/></div></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nu"><img src="../Images/974729c46e68af8a5b96e3e11738b8d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Hpdx4woldB-3j7JpRxAnNQ.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated"><strong class="bd lb">成功了！！！</strong></figcaption></figure></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h2 id="980a" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">来自Infosec的报道:Infosec每天都有很多内容，很难跟上。<a class="ae ky" href="https://weekly.infosecwriteups.com/" rel="noopener ugc nofollow" target="_blank">加入我们的每周简讯</a>以5篇文章、4个线程、3个视频、2个GitHub Repos和工具以及1个工作提醒的形式免费获取所有最新的Infosec趋势！</h2></div></div>    
</body>
</html>