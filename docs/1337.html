<html>
<head>
<title>Web Cache Poisoning: A Tale of chaining unkeyed inputs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">网络缓存中毒:链接未加密输入的故事</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/web-cache-poisoning-a-tale-of-chaining-unkeyed-inputs-6e3cb026bd23?source=collection_archive---------0-----------------------#2021-05-23">https://infosecwriteups.com/web-cache-poisoning-a-tale-of-chaining-unkeyed-inputs-6e3cb026bd23?source=collection_archive---------0-----------------------#2021-05-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="d6bb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你好，猎人们，我希望你们都做得很好，每天都在学习新的东西:)。我今天写的是由<a class="ae kl" href="http://twitter.com/albinowax" rel="noopener ugc nofollow" target="_blank">@白化蜡</a>解决的一个<a class="ae kl" href="https://hackxor.net/mission?id=8" rel="noopener ugc nofollow" target="_blank">实验室/任务</a>。</p><p id="05ce" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这一次我选择在deep学习web cache中毒，那么还有什么比portswigger更好的地方开始呢&amp;我刚刚从James(albinowax)发布的关于这一问题的第一篇研究论文开始。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="kr ks l"/></div></figure><p id="9b6a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我甚至还没有完全完成这个话题，但是在读完这篇文章后，最终会有一个挑战。完成后，我想我得写点什么。这东西太棒了。</p><p id="ff11" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="kt">免责声明:读完这篇文章后，你可能会认为你没有从中学到任何东西。很好，你不应该从这个博客中学习。我希望你自己去了解网络缓存中毒，然后自己解决这个挑战，如果遇到困难，就使用这个指南。</em></p><p id="13a6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">无论如何，我们非常欢迎你继续阅读</p><p id="77fd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">什么是web缓存中毒？</strong></p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi ku"><img src="../Images/709de24325c3c3e5263c29080e1adb76.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0E1tfiiTvku35JS9BfIDVg.png"/></div></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated">作者:cpdos.org</figcaption></figure><p id="0afb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要理解这一点，您需要了解什么是缓存以及它是如何工作的？</p><p id="8f1b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，当您在浏览器中查询某些内容时，您的浏览器会首先在本地缓存中查找相同的请求，如果没有，则将其转发到DNS服务器，同样，它还会在其本地缓存中查找其他人是否请求了相同的内容，如果没有，则将其转发到相应的服务器。现在，这些服务器不会直接与您对话，它们在客户端和后端之间还有一个缓存服务器。现在，这个缓存服务器将决定是否需要将请求转发到主服务器，并且它已经有了您的请求的副本。如果没有，您的回答将被再次保存，以供将来参考。</p><p id="e6ec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">回答将被发送给您，并保存在每一级缓存中。</p><ol class=""><li id="a73c" class="lf lg iq jp b jq jr ju jv jy lh kc li kg lj kk lk ll lm ln bi translated">您的浏览器缓存是本地缓存</li><li id="20ed" class="lf lg iq jp b jq lo ju lp jy lq kc lr kg ls kk lk ll lm ln bi translated">DNS级别缓存是DNS缓存</li><li id="e7de" class="lf lg iq jp b jq lo ju lp jy lq kc lr kg ls kk lk ll lm ln bi translated">应用程序级缓存是由服务器创建的。</li></ol><p id="95f0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，当我们谈论web缓存中毒时，不要将其与本地或DNS缓存混淆。我们的目标是污染主服务器的缓存，这样恶意内容就可以提供给合法用户，他们查询的请求与我们的相同。</p><p id="3ad4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我建议您仔细阅读这篇研究论文或portswigger内容，了解它是如何工作的。我向你保证这里有你需要知道的关于缓存中毒的一切。服务器如何决定两个请求是相同的？如何缓解这些问题？如何发现并利用它？也许我以后会发布一个关于它的详细博客。但是这个是关于挑战解决方案的。</p><div class="lt lu gp gr lv lw"><a href="https://portswigger.net/research/practical-web-cache-poisoning" rel="noopener  ugc nofollow" target="_blank"><div class="lx ab fo"><div class="ly ab lz cl cj ma"><h2 class="bd ir gy z fp mb fr fs mc fu fw ip bi translated">实用的Web缓存中毒</h2><div class="md l"><h3 class="bd b gy z fp mb fr fs mc fu fw dk translated">Web缓存中毒长期以来一直是一个难以捉摸的漏洞，一个“理论上”的威胁，主要用于吓唬开发人员…</h3></div><div class="me l"><p class="bd b dl z fp mb fr fs mc fu fw dk translated">portswigger.net</p></div></div><div class="mf l"><div class="mg l mh mi mj mf mk kz lw"/></div></div></a></div><p id="e16d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">任务:</strong></p><div class="lt lu gp gr lv lw"><a href="https://hackxor.net/mission?id=8" rel="noopener  ugc nofollow" target="_blank"><div class="lx ab fo"><div class="ly ab lz cl cj ma"><h2 class="bd ir gy z fp mb fr fs mc fu fw ip bi translated">使命:定制分析</h2><div class="md l"><h3 class="bd b gy z fp mb fr fs mc fu fw dk translated">奖励4600美元客户约翰·多伊建议之前的经验中等嗨，我们是博士生进行一些研究…</h3></div><div class="me l"><p class="bd b dl z fp mb fr fs mc fu fw dk translated">hackxor.net</p></div></div></div></a></div><p id="41e5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在的目标是在transparency.hackxor.net/contact页面上提供analytics.hackxor.net的内容。</p><p id="7714" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">param miner是一个burp扩展，用于暴力破解对应用程序响应有某种影响的标头。你可以从BApp商店安装它。</p><p id="b97c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在对transparency.hackxor.net/contact页面的标题进行暴力处理后，我们发现它支持X-original-Original标题。这意味着这个头可以覆盖所请求的路径。</p><blockquote class="ml mm mn"><p id="096d" class="jn jo kt jp b jq jr js jt ju jv jw jx mo jz ka kb mp kd ke kf mq kh ki kj kk ij bi translated">GET /admin HTTP/1.1 <br/>主机:unity.com</p><p id="cd13" class="jn jo kt jp b jq jr js jt ju jv jw jx mo jz ka kb mp kd ke kf mq kh ki kj kk ij bi translated">HTTP/1.1 403禁止<br/>……<br/>访问被拒绝</p></blockquote><p id="9e24" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi">— — — — — — —</p><blockquote class="ml mm mn"><p id="a6c9" class="jn jo kt jp b jq jr js jt ju jv jw jx mo jz ka kb mp kd ke kf mq kh ki kj kk ij bi translated">GET /anything HTTP/1.1 <br/>主持人:unity.com<br/>X原文网址:/admin<br/><br/>HTTP/1.1 200 OK<br/>……<br/>请登录</p></blockquote><p id="e344" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这意味着如果我们要求，我们可以</p><blockquote class="ml mm mn"><p id="95fd" class="jn jo kt jp b jq jr js jt ju jv jw jx mo jz ka kb mp kd ke kf mq kh ki kj kk ij bi translated">获取/联系HTTP/1.1</p><p id="514e" class="jn jo kt jp b jq jr js jt ju jv jw jx mo jz ka kb mp kd ke kf mq kh ki kj kk ij bi translated">主持人:transperncy.hackxor.net<br/>用户代理:Mozilla/…..<br/>Referer:<a class="ae kl" href="https://hackxor.net/" rel="noopener ugc nofollow" target="_blank">https://hackxor.net/</a><br/>连接:关闭<br/> Cookie: ………..<br/>X-original-URL:/任何东西</p></blockquote><p id="55de" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它不会给transparency.hackxor.net/contact回复，但会给transparency.hackxor.net/anything·佩奇。显然是404，因为/任何东西都不存在。</p><p id="6116" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以我们得到了第一个提示，如果我们用x-original-url头查询/联系，这个新路径的响应将被缓存在服务器的缓存中。</p><p id="750b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在经过一点来回我们会找到一页transparency.hackxor.net/blog。查看它的源代码，我们看到它从transparency.hackxor.net获取了一个looking。</p><pre class="km kn ko kp gt mr ms mt mu aw mv bi"><span id="f070" class="mw mx iq ms b gy my mz l na nb">&lt;img src="https://transparency.hackxor.net/static/logo.png"/&gt;</span></pre><p id="06ab" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以我们得到了我们的东西，用x-original-url查询/contact页面:/blog会在/contact页面缓存/blog页面的响应。因为服务器已经确定，无论何时有人在主机transparency.hackxor.net上查询/联系页面，它都是与之前在其缓存中相同的请求。</p><p id="ffc8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以我们的东道主在我们/博客页面的回应中得到了反映。现在几点了？现在是参数挖掘时间。</p><p id="1871" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行它会给出一个/blog page支持的头，这就是x-host头。现在，在这个挑战中，X-Host正在覆盖主机标头。</p><p id="51ac" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，请求/博客</p><blockquote class="ml mm mn"><p id="a2c3" class="jn jo kt jp b jq jr js jt ju jv jw jx mo jz ka kb mp kd ke kf mq kh ki kj kk ij bi translated">GET /blog HTTP/1.1 <br/>主持人:transparency.hackxor.net<br/>X-主持人:analytics.hackxor.net</p></blockquote><p id="df18" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它在获取徽标时用新主机返回一个响应。</p><pre class="km kn ko kp gt mr ms mt mu aw mv bi"><span id="2510" class="mw mx iq ms b gy my mz l na nb">&lt;img src="<a class="ae kl" href="https://analytics.hackxor.net/static/logo.png" rel="noopener ugc nofollow" target="_blank">https://analytics.hackxor.net/static/logo.png</a>"/&gt;</span></pre><p id="eeb7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们得到了所有需要的材料</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="nc ks l"/></div></figure><p id="91df" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们将这两个未加密的输入链接起来(头会影响响应，但在缓存时不会被服务器处理)</p><ol class=""><li id="cb70" class="lf lg iq jp b jq jr ju jv jy lh kc li kg lj kk lk ll lm ln bi translated">我们将请求/联系主机:transparency.hackxor.net，这样我们的恶意响应将提供给具有相同路径和主机的用户。</li><li id="4b5d" class="lf lg iq jp b jq lo ju lp jy lq kc lr kg ls kk lk ll lm ln bi translated">我们将用X-original-URL : /blog覆盖/contact路径。所以response返回/blog页面的响应，而不是contact。</li></ol><p id="39d8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在这个响应包含一个url来获取一个带有host:transparency.hackxor.net的徽标，</p><p id="864b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">3.我们将使用X-host报头将主机更改为analytics.hackxor.net</p><p id="53b7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">4.因此，最终的回应将包含analytics.hackxor.net主机/博客页面的内容</p><p id="05a4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最终有效载荷看起来像。</p><blockquote class="ml mm mn"><p id="7dea" class="jn jo kt jp b jq jr js jt ju jv jw jx mo jz ka kb mp kd ke kf mq kh ki kj kk ij bi translated">获取/联系HTTP/1.1 <br/>主持人:transparency.hackxor.net<br/>X-主持人:analytics.hackxor.net<br/>X-Original-URL:/blog</p></blockquote><p id="fa31" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在需要注意的是，当你向服务器发送请求时，它会注意到请求的路径与缓存中的路径相同，所以它会用缓存进行回复。您实际上没有与服务器通信。所以为了毒化缓存，你必须等到服务器的缓存过期。然后将你的恶意请求发送到服务器，这样服务器会将你的响应保存在缓存中。这更像是和时间赛跑。一个解决方案是重复做这件事，或者用你的有效负载做一个while curl请求循环。</p><blockquote class="ml mm mn"><p id="f24e" class="jn jo kt jp b jq jr js jt ju jv jw jx mo jz ka kb mp kd ke kf mq kh ki kj kk ij bi translated">缓存控制:公共；最大年龄:60岁；<br/>年龄:4岁</p></blockquote><p id="6f6a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在响应中，您可以看到缓存将过期多长时间，即60，而您当前处于4，请等到60，然后发送您的请求。</p><p id="de87" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在您的响应被缓存后，您会注意到/contact也通过不同的主机提供/blog的内容。</p><p id="3df2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">任务完成。</p><p id="28ef" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Ps:这个你自己试一次。</p><p id="4f23" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是将两个未加密的头链接起来防止缓存中毒的演练，同时给出了关于web缓存中毒的基本说明。无论如何，如果你被困在任何地方，欢迎你在twitter上ping我。<a class="ae kl" href="https://twitter.com/Avinashkroy" rel="noopener ugc nofollow" target="_blank"> @Avinashkroy </a></p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="nd ks l"/></div></figure></div></div>    
</body>
</html>