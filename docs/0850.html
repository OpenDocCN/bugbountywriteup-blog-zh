<html>
<head>
<title>Taking down the SSO, Account Takeover in the Websites of Kolesa due to Insecure JSONP Call</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">由于不安全的JSONP调用，Kolesa网站中的SSO、帐户被接管</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/taking-down-the-sso-account-takeover-in-3-websites-of-kolesa-due-to-insecure-jsonp-call-facd79732e45?source=collection_archive---------0-----------------------#2020-09-28">https://infosecwriteups.com/taking-down-the-sso-account-takeover-in-3-websites-of-kolesa-due-to-insecure-jsonp-call-facd79732e45?source=collection_archive---------0-----------------------#2020-09-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="1ee4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你好，这篇文章是关于我如何使用单点登录接管Kolesa网站的任何帐户。有一个不安全的JSONP调用可能会破坏整个SSO机制的安全性。</p><h1 id="e90e" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">JSONP是什么？</h1><p id="3bb8" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">JSONP是一种将JSON数据发送到其他域的方法。</p><ul class=""><li id="a47a" class="lo lp iq jp b jq jr ju jv jy lq kc lr kg ls kk lt lu lv lw bi translated">可以加载外部JavaScript对象</li><li id="6917" class="lo lp iq jp b jq lx ju ly jy lz kc ma kg mb kk lt lu lv lw bi translated">不使用XMLHttpRequest对象</li><li id="7bb4" class="lo lp iq jp b jq lx ju ly jy lz kc ma kg mb kk lt lu lv lw bi translated">不太安全</li><li id="e927" class="lo lp iq jp b jq lx ju ly jy lz kc ma kg mb kk lt lu lv lw bi translated">在浏览器中绕过SOP</li></ul><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi mc"><img src="../Images/c1b4651d536bc7af2dc10de0f78c9854.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eyBzLorQLkJha9WFwBoGMw.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">JSONP请求/响应示例</figcaption></figure><h1 id="e6f6" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">单点登录</h1><p id="102d" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">信息收集显示Kolesa网站使用单点登录，认证服务器是:</p><pre class="md me mf mg gt ms mt mu mv aw mw bi"><span id="8eac" class="mx km iq mt b gy my mz l na nb">https://<!-- -->id.kolesa.kz</span></pre><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi nc"><img src="../Images/c72a400d1be69d5532c5a269ef1e3e11.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*R46XUbUECwg82nAk.png"/></div></div></figure><p id="0ad1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用单点登录的网站有:</p><ol class=""><li id="905a" class="lo lp iq jp b jq jr ju jv jy lq kc lr kg ls kk nd lu lv lw bi translated"><a class="ae ne" href="https://market.kz" rel="noopener ugc nofollow" target="_blank"> https://market.kz </a></li><li id="6a74" class="lo lp iq jp b jq lx ju ly jy lz kc ma kg mb kk nd lu lv lw bi translated"><a class="ae ne" href="https://krisha.kz" rel="noopener ugc nofollow" target="_blank"> https://krisha.kz </a></li><li id="2b05" class="lo lp iq jp b jq lx ju ly jy lz kc ma kg mb kk nd lu lv lw bi translated"><a class="ae ne" href="https://kolesa.kz" rel="noopener ugc nofollow" target="_blank"> https://kolesa.kz </a></li></ol><p id="5709" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">SSO工作的一般工作流程:</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi nf"><img src="../Images/c352f86130fb14a6a3bdff3800d37e87.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*YMZdPeZgC1agW8D8.png"/></div></div></figure><p id="f1d0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这个认证模型中，由于一个域不能为其他域设置一个<code class="fe ng nh ni mt b">authentication cookie</code>，一个<code class="fe ng nh ni mt b">authentication token</code>应该在<code class="fe ng nh ni mt b">authentication server</code>和其他域之间传递。考虑到上图中的橙色框，每个站点应该在验证了<code class="fe ng nh ni mt b">authentication token</code>之后保存一个cookie。此外，<code class="fe ng nh ni mt b">authentication server</code>还保存它的cookie，所以在几次HTTP请求之后，我找到了每个Kolesa网站的认证cookie名称:</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/4fe9a7bc386ec9b32f733844a247b01f.png" data-original-src="https://miro.medium.com/v2/resize:fit:612/format:webp/1*y66HjfihE29_fMSQjIQqQA.png"/></div></figure><h1 id="e4ee" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">处理SSO的JSONP调用</h1><p id="fd9c" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">JSONP调用用于<strong class="jp ir">进一步认证</strong>。如果用户已经登录了三个网站中的任何一个，就会发出一个JSONP调用来验证用户的身份。这样做的原因是易于实现。由于域的来源不同，Kolesa网站应该已经实现了<code class="fe ng nh ni mt b">Cross Origin Resource Sharing</code>来传输认证，但是他们决定使用JSONP来避免CORS设置。</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi nk"><img src="../Images/32703df54bbcd81abdfe45d65958c95d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ql-t9BBStjHSY0k6rc98yQ.png"/></div></div></figure><p id="8534" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要点是，一旦用户登录，例如<code class="fe ng nh ni mt b">kosela.kz</code>，他们在<code class="fe ng nh ni mt b">id.kolesa.kz</code>中有一个<code class="fe ng nh ni mt b">ccid</code> cookie，一个用于传输认证的认证令牌，在<code class="fe ng nh ni mt b">kosela.kz</code>中有一个<code class="fe ng nh ni mt b">ssid</code> cookie。之后，如果用户想要登录其他网站，只需点击一下，因为<code class="fe ng nh ni mt b">id.kosela.kz</code>有认证cookie，它会立即生成<code class="fe ng nh ni mt b">authentication token</code>，用户将在网站上拥有相应的<code class="fe ng nh ni mt b">authentication cookie</code>。</p><p id="903c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">根据上图，阶段4展示了如何进行JSONP调用，以及如何将域中的<code class="fe ng nh ni mt b">authentication token</code>转换为<code class="fe ng nh ni mt b">authentication cookie</code>。JSONP调用的原因:</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi nl"><img src="../Images/402d39f540688860f1c058c4622c8d61.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NQCZnViLVcaeMO0FCWuxsQ.png"/></div></div></figure><p id="2878" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果用户已经通过了<code class="fe ng nh ni mt b">id.kolesa.kz</code>的认证，将会得到以下响应:</p><pre class="md me mf mg gt ms mt mu mv aw mw bi"><span id="fe8e" class="mx km iq mt b gy my mz l na nb">HTTP/1.1 200 OK<br/>Server: openresty/1.13.6.2<br/>Date: Mon, 19 Aug 2019 16:43:26 GMT<br/>Content-Type: text/javascript;charset=UTF-8<br/>Connection: close<br/>Expires: Thu, 19 Nov 1981 08:52:00 GMT<br/>Cache-Control: no-store, no-cache, must-revalidate<br/>Pragma: no-cache<br/>Backend-Server: auth-be3.alaps.kz.prod.bash.kz<br/>X-Bug-Bounty: Please report bugs and vulnerabilities to <a class="ae ne" href="mailto:bugs@kolesa.kz" rel="noopener ugc nofollow" target="_blank">bugs@kolesa.kz</a><br/>Content-Security-Policy: frame-ancestors 'self' <a class="ae ne" href="http://webvisor.com" rel="noopener ugc nofollow" target="_blank">http://webvisor.com</a> <a class="ae ne" href="https://webvisor.com" rel="noopener ugc nofollow" target="_blank">https://webvisor.com</a><br/>Strict-Transport-Security: max-age=31536000<br/>Content-Length: 627</span><span id="2014" class="mx km iq mt b gy nm mz l na nb">window.xdm = {<br/>    <strong class="mt ir">sess: {<br/>        is_authenticated: 1,<br/>        token: 'xG3ROFWcb7pnXSnMr8MkaBvH01pLlCHqn0sPt0PVL6BBWYdQPdvA31tBi6dLB5njv5jhMW3y/cGBMRB9LC/69zv867wweaDhkxX6arGVzYDy2q+J52nkOQJ+62rR9wLPYJGyEpNGWeOBSp12vugXZUPq2RA6FMptbNkGQpJFjAclXSzduj7wJJgAUONMj3mkkElM1nWmIllrl5zDEz6s7077E4ibx//BvnfZ9AIC/9b2PB+QzVKOnSzzcr9wSXqta9TEDHvjopqbUd4UE2xSMRSj/zxPQlCba5632hcIXnzZB3A8fvahvf2Hm5ssuC+cwuKU8pAdE/qcGQSJKdhpYXxntGkQiLdEAliyCq+fahS4itb6HlFH/+H20RsZA+cjyaF7ntnW5tYY31vxJXovrR3oinaj9YDSzoCZYMDYPJMdk+HuZhRuxxEl8abuNlGD0aCt2GCPV7GY0J9Ma7AcPw=='<br/>    }</strong><br/>};</span><span id="431b" class="mx km iq mt b gy nm mz l na nb">(function ($) {<br/>    "use strict";</span><span id="39f7" class="mx km iq mt b gy nm mz l na nb">$.xdm = window.xdm;<br/>}(jQuery));</span></pre><p id="43d1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如我们所看到的，有一个名为<code class="fe ng nh ni mt b">sess</code>的对象包含了名为<code class="fe ng nh ni mt b">is_authenticated</code>和<code class="fe ng nh ni mt b">token</code>的两个属性。该对象负责传输身份验证。此时用户有当前网站的<code class="fe ng nh ni mt b">authentication token</code>但没有<code class="fe ng nh ni mt b">authentication cookie</code>，所以进行第二次呼叫:</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi nn"><img src="../Images/a5e06c6cb61016b770c506cc7ae86ee3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CY3q97xvz1VGhrupKmeKKQ.png"/></div></div></figure><p id="ae9f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">JavaScript代码:</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi no"><img src="../Images/106704f9ef18d0af3d675fcf936e0e7e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6YYBvMixHizWLXavj-YTIg.png"/></div></div></figure><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi np"><img src="../Images/9d36a18546e70f95917c4d4c52297e13.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AOnIQeS5vfIeq6Xqw5sW6A.png"/></div></div></figure><h1 id="2688" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">易受攻击的外部JavaScript对象</h1><p id="46ec" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">问题是，任意一个原点都能提取出<code class="fe ng nh ni mt b">authentication token</code>？当然可以，因为JSONP调用绕过了<strong class="jp ir">同源策略</strong>。</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi nq"><img src="../Images/fd0b8952066f1fae48bdfdd15640c996.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*z-ra2t3iPapbkjHYNtqVkQ.png"/></div></div></figure><p id="4443" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">发现漏洞，一键接管账户:)</p><h1 id="3fc7" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">开发阶段</h1><p id="ba03" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">场景很简单:</p><ol class=""><li id="5e27" class="lo lp iq jp b jq jr ju jv jy lq kc lr kg ls kk nd lu lv lw bi translated">设置代表任何用户调用JSONP的页面</li><li id="ce22" class="lo lp iq jp b jq lx ju ly jy lz kc ma kg mb kk nd lu lv lw bi translated">欺骗认证用户访问我们的恶意网站</li><li id="2c8d" class="lo lp iq jp b jq lx ju ly jy lz kc ma kg mb kk nd lu lv lw bi translated">用户向我们的网站发送<code class="fe ng nh ni mt b">authentication token</code></li><li id="3b56" class="lo lp iq jp b jq lx ju ly jy lz kc ma kg mb kk nd lu lv lw bi translated">作为受害者登录并做坏事</li></ol><p id="2b32" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">漏洞代码(客户端+服务器端调用):</p><figure class="md me mf mg gt mh"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="9d5f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是视频概念验证:</p><figure class="md me mf mg gt mh"><div class="bz fp l di"><div class="nt ns l"/></div></figure></div></div>    
</body>
</html>