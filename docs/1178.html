<html>
<head>
<title>An Interesting Account Takeover!!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">一个有趣的账户接管！！</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/an-interesting-account-takeover-3a33f42d609d?source=collection_archive---------2-----------------------#2021-03-18">https://infosecwriteups.com/an-interesting-account-takeover-3a33f42d609d?source=collection_archive---------2-----------------------#2021-03-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="476a" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">IDOR和弱加密导致帐户被完全接管。</h2></div><p id="e018" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你好，我的黑客伙伴们。我是Mayank Pandey，一个臭虫猎人，一个有抱负的红队队员。这是我第一次写任何错误，所以如果我犯了任何错误，然后忽略它。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi lb"><img src="../Images/779751902f67950c708c5cb5a820bad5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9WIbqoPV50cFc9GaZZ5r-w.png"/></div></div></figure><p id="2047" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在直接进入有趣的部分。最近，我在媒体上读到许多帐户接管，他们通常使用“X-Forwarded-Host”标题来窃取令牌。所以我想为什么不试一试，换一种方式。我有几个未决的私人邀请，所以我接受了一个并开始寻找帐户接管，最终找到了宝石。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div class="gh gi ln"><img src="../Images/902f0cecfa0ca05143e678286cc60720.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/1*1IbZevL2ca--0NPOg6JjHg.png"/></div></figure></div><div class="ab cl lo lp hu lq" role="separator"><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt"/></div><div class="ij ik il im in"><p id="9180" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这个错误存在于“密码重置”功能中，该功能允许完全接管帐户，而无需用户进行任何交互。它是IDOR、一点密码学和大量目录模糊化的结合。</p><p id="fa70" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们给公司打个电话:“example.com”。首先，看看普通的密码重置是如何工作的。</p><p id="026b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">1:用户转到“example . com/PHP/log in _ or _ password _ forgotten ”,通过输入他们的个人资料ID和姓名请求重置密码。</p><p id="96f3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">2:验证他们的配置文件ID和名称，并生成一个<em class="lv">状态</em>参数。</p><blockquote class="lw lx ly"><p id="e46e" class="kf kg lv kh b ki kj jr kk kl km ju kn lz kp kq kr ma kt ku kv mb kx ky kz la ij bi translated">STATE = ejxdkn 1 owzamhd 8 ldza 1 xfft 9 gpmde 2 gdmktuixm 4 paililjjhbo 747 dfjrxlfhzyp 9 zgphpbduaryixzqn 8 wd evhz 1% 2 bo V8 utxeimshftxatwcjfwyeoeepgkppxttzfiojgssg % 2 fqrmgvgxbc 8 H4 zdyq 8 hhnfmsnza lo 3 ckekwftuurh % 2 b 7 snxt 0 ylsd DP 9 arxo 1 e 6y 96h rar 4 uevy</p></blockquote><p id="c251" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">3:此后，一个密码重置链接被发送到用户注册的电子邮件，如下所示</p><blockquote class="lw lx ly"><p id="e3c2" class="kf kg lv kh b ki kj jr kk kl km ju kn lz kp kq kr ma kt ku kv mb kx ky kz la ij bi translated">【https://example.com/php/login_or_password_forgotten? T2】k = 789 c 0 DC 8610 a 80200 c 06d 0 bbec 049 BC 9d 26 f 870921834192 a4 FFA 2 bbd 7 fbf 90 a 029 e 810 c 9 adeea 98 a 5753287 a 844 e 16555 b 1016150 BF AFC 3 cf BAF 94 eff 2450 e 494 a 2 e 640 f 67 ebc 89137 aade 927d 25 a 020 ab</p></blockquote><p id="efd9" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">4:现在，用户可以通过单击链接后转到仪表板来更改他们的密码。</p></div><div class="ab cl lo lp hu lq" role="separator"><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt"/></div><div class="ij ik il im in"><h1 id="dc2e" class="md me iq bd mf mg mh mi mj mk ml mm mn jw mo jx mp jz mq ka mr kc ms kd mt mu bi translated">有趣的部分</h1><p id="7b42" class="pw-post-body-paragraph kf kg iq kh b ki mv jr kk kl mw ju kn ko mx kq kr ks my ku kv kw mz ky kz la ij bi translated">“<em class="lv">？k" </em>参数对我来说有点可疑，所以我迅速复制并粘贴到<a class="ae mc" href="https://gchq.github.io/CyberChef/" rel="noopener ugc nofollow" target="_blank"> CyberChef </a>上，看看它是否是一个加密的字符串。令我惊讶的是，这是一个加密+压缩的字符串</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi na"><img src="../Images/171df77d24466363ec600aee9929c76d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*W06aZMbw4I4wzFsaDscYDA.png"/></div></div></figure><p id="0b8c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它首先被<strong class="kh ir"> Zlib-deflated </strong>，然后使用<strong class="kh ir"> Hex将被压缩的字符串加密回去。</strong>由此可见一斑</p><blockquote class="lw lx ly"><p id="0317" class="kf kg lv kh b ki kj jr kk kl km ju kn lz kp kq kr ma kt ku kv mb kx ky kz la ij bi translated">"<em class="iq">789 c 0 DC 8610 a 80200 c 06d 0 bbec 049 BC 9d 26 f 870921834192 a4 FFA 2 bbd 7 fbf 90 a 029 e 810 c 9 ade ea 98 a 5753287 a 844 e 16555 b 1016150 BF AFC 3 cf BAF 94 eff 2450 e 494 a2 e 640 f 67 ebc 89137 aade 927d 25 a 020</em></p></blockquote><p id="f92f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">解密回</p><blockquote class="lw lx ly"><p id="6b73" class="kf kg lv kh b ki kj jr kk kl km ju kn lz kp kq kr ma kt ku kv mb kx ky kz la ij bi translated"><em class="iq">“a:2:{ s:9:“时间戳”；我:1614104013；s:10:" profile _ id "；s:8:“40884692”；} </em>”</p></blockquote><p id="06e4" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">解密后的字符串由两个重要变量“profile_id”和“timestamp”组成。我很高兴看到这个，以为我找到了宝石。我立即伪造了我的第二个帐户的令牌，用它来更改密码。</p><blockquote class="lw lx ly"><p id="e56d" class="kf kg lv kh b ki kj jr kk kl km ju kn lz kp kq kr ma kt ku kv mb kx ky kz la ij bi translated">伪造令牌—789 c 0 DC 8510 a 85201005d 0 bdcc 0 AC 6 f 25 da 6 EB 62427806034992 Fe 457 bb 7 df 93 b 9 f0e 9 DC 28 c 36 be 923d 726 c 919107 EC 0 aa 40 ea 0 C4 a69 f 775 f 85976 ffcb 2746891 a 610693 f 44 ebe 171387</p></blockquote><p id="49c3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">但是我完全错了。该链接无效。</p><figure class="lc ld le lf gt lg"><div class="bz fp l di"><div class="nb nc l"/></div></figure><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi nd"><img src="../Images/736ce008a91a307d921e84138827568f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CF7bDZvtOadDbvS0hGYZnA.png"/></div></div></figure><p id="a638" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">没有什么来的这么容易…对吗？</p><h1 id="889e" class="md me iq bd mf mg ne mi mj mk nf mm mn jw ng jx mp jz nh ka mr kc ni kd mt mu bi translated">转折</h1><p id="0f18" class="pw-post-body-paragraph kf kg iq kh b ki mv jr kk kl mw ju kn ko mx kq kr ks my ku kv kw mz ky kz la ij bi translated">如果你仔细观察，你会发现原始令牌和伪造令牌的长度不同</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi nj"><img src="../Images/20e44cc9592597baa7e96849b7ab8350.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_iV1qh8tvYbzK-kNLOW-8A.png"/></div></div></figure><p id="ba19" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">原始令牌和伪造令牌相差32个字符。这是一个巨大的问题，因为服务器不接受任何垃圾值来代替这32个字符。两个令牌都被解密为相同的值</p><blockquote class="lw lx ly"><p id="d562" class="kf kg lv kh b ki kj jr kk kl km ju kn lz kp kq kr ma kt ku kv mb kx ky kz la ij bi translated">"<em class="iq"> a:2:{s:9:"时间戳"；我:1614104013；s:10:" profile _ id "；s:8:“40884692”；}".</em></p></blockquote><p id="bef1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这让我非常沮丧😫 😫。我开始搜索更多关于Zlib压缩的内容。我去了Reddit，发布了我的问题，令人惊讶的是，我的收件箱被无数令人惊讶的博客帖子和如何处理Zlib的想法淹没了。</p><p id="1575" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在网上阅读了2个小时后，我发现Zlib包含一个<strong class="kh ir"> ADLER32校验和</strong>如果你在膨胀后使用Adler-32_Checksum()函数，你会得到<strong class="kh ir"> BC89137A，</strong>注意，这个校验和存在于原始令牌中。在Zlib中，该校验和之后的所有内容都不是压缩流的一部分，因此将被忽略，这就是为什么即使长度不同，两个令牌也会给出相同的结果。</p><p id="1ba9" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">所以现在的挑战是找到32位的字符串。因为所有与令牌相关的工作都发生在客户端，所以我非常确定能在JS文件中找到一些东西。</p><p id="1f08" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在JS文件中查看了几个小时后，我发现了一个端点<strong class="kh ir">“/PHP/user”。</strong>我决定强行打开目录，最终找到了端点“<a class="ae mc" href="https://example.com" rel="noopener ugc nofollow" target="_blank"><strong class="kh ir">https://example.com</strong></a><strong class="kh ir">/PHP/user/example/”，</strong>这个端点有一个名为“Transction _ Token”的字符串，这确实是我要找的最后一个部分。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/552ef287c78ec42a4e0d702c3ab45323.png" data-original-src="https://miro.medium.com/v2/resize:fit:1162/format:webp/1*CqR9l8O5TcxaIylpkNsrAg.png"/></div></figure><h1 id="1ef5" class="md me iq bd mf mg ne mi mj mk nf mm mn jw ng jx mp jz nh ka mr kc ni kd mt mu bi translated">将碎片拼在一起</h1><p id="8fff" class="pw-post-body-paragraph kf kg iq kh b ki mv jr kk kl mw ju kn ko mx kq kr ks my ku kv kw mz ky kz la ij bi translated">现在是把所有东西放在一起并加以利用的时候了。</p><p id="fde6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这种攻击需要精确，因为每次页面刷新时,“Transaction _Token”都会发生变化。所以我做了一个python脚本来自动化整个过程。</p><p id="35d2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我为我的第二个帐户生成了令牌，并用它来更改密码，并且<strong class="kh ir">成功了！！！！</strong></p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi nl"><img src="../Images/cb1deb5268f611f859baaf5273a9e008.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sx9gJWxWU_JFYMJQ5Xbq1g.png"/></div></div></figure><figure class="lc ld le lf gt lg"><div class="bz fp l di"><div class="nm nc l"/></div></figure><h1 id="8c3b" class="md me iq bd mf mg ne mi mj mk nf mm mn jw ng jx mp jz nh ka mr kc ni kd mt mu bi translated">重要提示</h1><ul class=""><li id="8f95" class="nn no iq kh b ki mv kl mw ko np ks nq kw nr la ns nt nu nv bi translated">如果有令牌，就有可能被破解。</li><li id="850e" class="nn no iq kh b ki nw kl nx ko ny ks nz kw oa la ns nt nu nv bi translated">手动读取JS文件一次，因为这些文件包含关于Web应用程序工作的非常重要的信息</li><li id="eb14" class="nn no iq kh b ki nw kl nx ko ny ks nz kw oa la ns nt nu nv bi translated">尝试在Reddit上询问技术细节，这肯定会让你大吃一惊，而且人们在回复你之前不会看到你的粉丝数😅 😉。</li></ul><blockquote class="ob"><p id="3d88" class="oc od iq bd oe of og oh oi oj ok la dk translated">相信你的直觉，永远多走一步😇</p></blockquote><p id="97cb" class="pw-post-body-paragraph kf kg iq kh b ki ol jr kk kl om ju kn ko on kq kr ks oo ku kv kw op ky kz la ij bi translated">非常感谢你的阅读。喜欢就分享</p><p id="ca23" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">可以在推特上找我:<a class="ae mc" href="https://twitter.com/mayank_pandey01" rel="noopener ugc nofollow" target="_blank"> <strong class="kh ir"> mayank_pandey01 </strong> </a></p></div></div>    
</body>
</html>