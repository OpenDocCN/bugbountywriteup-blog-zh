<html>
<head>
<title>Open Redirects &amp; bypassing CSRF validations- Simplified</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">开放重定向和绕过CSRF验证-简化</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/open-redirects-bypassing-csrf-validations-simplified-4215dc4f180a?source=collection_archive---------2-----------------------#2020-10-04">https://infosecwriteups.com/open-redirects-bypassing-csrf-validations-simplified-4215dc4f180a?source=collection_archive---------2-----------------------#2020-10-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="b663" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">开放重定向是未经验证的重定向和转发，当web应用程序接受<strong class="jp ir">不受信任的输入</strong>时，可能会导致web应用程序将请求重定向到不受信任的输入中包含的URL。通过修改恶意站点的不可信URL输入，攻击者可以成功发起网络钓鱼诈骗并窃取用户凭据。这些漏洞可能会进一步升级，从网络钓鱼攻击到目录遍历、XSS、CSRF、SSRF、OAuth令牌泄露。等等</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi kl"><img src="../Images/61233075d028f169a3506cdf21aa5172.png" data-original-src="https://miro.medium.com/v2/resize:fit:1252/format:webp/1*BEvkiS-c33VDazvRhodOqg.jpeg"/></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk translated">开放重定向-未验证的重定向</figcaption></figure><p id="d931" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因为被更改的链接中的域名与原始站点无法区分，所以网络钓鱼企图看起来更可信。未经验证的重定向和转发攻击也可用于恶意创建URL，通过应用程序的访问控制检查，然后将攻击者转发到他们通常无法访问的特权功能。— OWASP备忘单。</p><h2 id="b173" class="kx ky iq bd kz la lb dn lc ld le dp lf jy lg lh li kc lj lk ll kg lm ln lo lp bi translated">安全重定向:</h2><p id="5608" class="pw-post-body-paragraph jn jo iq jp b jq lq js jt ju lr jw jx jy ls ka kb kc lt ke kf kg lu ki kj kk ij bi translated">然而，通过客户端，严格硬编码到源代码中的URL在某种程度上是安全的，不会受到未经验证的重定向的影响。</p><p id="721c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">举例:</strong></p><p id="b14d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">。<br/>-<code class="fe lv lw lx ly b">response.redirect(“~/mysafe-subdomain/login.aspx”)</code>网络代码</p><p id="cd2e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Java代码- <br/> <code class="fe lv lw lx ly b">response.redirect(“<a class="ae lz" href="https://mysafedomain.com" rel="noopener ugc nofollow" target="_blank">http://mysafedomain.com</a>");</code></p><p id="32b1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">PHP代码- <br/> <code class="fe lv lw lx ly b">&lt;?php<br/>/* browser redirections*/<br/>header(“Location: <a class="ae lz" href="http://mysafedomain.com" rel="noopener ugc nofollow" target="_blank">http://mysafedomain.com</a>");<br/>exit;<br/>?&gt;</code></p><h2 id="c0bb" class="kx ky iq bd kz la lb dn lc ld le dp lf jy lg lh li kc lj lk ll kg lm ln lo lp bi translated">恶意URL重定向:</h2><p id="5c89" class="pw-post-body-paragraph jn jo iq jp b jq lq js jt ju lr jw jx jy ls ka kb kc lt ke kf kg lu ki kj kk ij bi translated">考虑一个应用程序，它依赖客户端数据来生成重定向查询，并最终将应用程序的控制权传递给恶意用户。打开了欺骗应用程序和其他用户的机会之门。</p><p id="f7e4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">示例:</strong></p><p id="1693" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">。<br/>-<code class="fe lv lw lx ly b">string url = request.queryString[“<strong class="jp ir">url</strong>”]; <br/>response.redirect(<strong class="jp ir">url</strong>);</code>网码</p><p id="d1a4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这里，<code class="fe lv lw lx ly b">url</code>是从一个<em class="ma"> GET </em>或<em class="ma"> POST </em> query &amp;将用户重定向到目的地。</p><p id="887a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">应用程序接受以下输入:</p><p id="73b1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe lv lw lx ly b">GET /mysafe-subdomain?<strong class="jp ir">url=same-safe-domain/index.aspx</strong><br/>Host: mysafedomain.com<br/>HTTP/1.1 302 Object moved<br/>Location: <a class="ae lz" href="https://mysafedomain.com/" rel="noopener ugc nofollow" target="_blank"><strong class="jp ir">http://mysafedomain.com/</strong></a></code></p><p id="2b95" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">骗子可以将请求更改为:</p><p id="faf4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe lv lw lx ly b">GET /mysafe-subdomain?<strong class="jp ir">url=.notsafedomain/donate.plz</strong><br/>Host: mysafedomain.com<br/>HTTP/1.1 302 Object moved<br/>Location: <a class="ae lz" href="https://mysafedomain.com/" rel="noopener ugc nofollow" target="_blank"><strong class="jp ir">http://safedomain.com/</strong></a></code></p><p id="5998" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这将导致重定向到:</p><p id="3391" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe lv lw lx ly b">http://safedomain.com.notsafedomain/donate.plz</code></p><p id="bc23" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运筹学</p><p id="bd0e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe lv lw lx ly b">GET /mysafe-subdomain?<strong class="jp ir">url=http://not-so-safedomain/donate.plz</strong><br/>Host: mysafedomain.com<br/>HTTP/1.1 302 Object moved<br/>Location: <a class="ae lz" href="https://mysafedomain.com/" rel="noopener ugc nofollow" target="_blank"><strong class="jp ir">http://notsafedomain.com/</strong></a></code></p><p id="99aa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因为请求来自受信任的域，所以浏览器会将查询作为有效查询来执行。</p><p id="d6da" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运筹学</p><p id="0abb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">应用程序接受以下输入:</p><p id="1d9c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe lv lw lx ly b">POST /mysafe-subdomain/User HTTP 1.1<br/>Host: mysafedomain.com<br/>HTTP/1.1 302 Object moved<br/>Location: <a class="ae lz" href="https://mysafedomain.com/" rel="noopener ugc nofollow" target="_blank">https://mysafedomain.com/</a><br/><strong class="jp ir">url=mysafe-subdomain/editDetails.aspx</strong></code></p><p id="8d8d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">骗子可以将请求更改为:</p><p id="ddb4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe lv lw lx ly b">POST /mysafe-subdomain/User HTTP 1.1<br/>Host: mysafedomain.com<br/>HTTP/1.1 302 Object moved<br/>Location: <a class="ae lz" href="https://mysafedomain.com/" rel="noopener ugc nofollow" target="_blank">https://mysafedomain.com/</a><br/><strong class="jp ir">url=https://notsafedomain/pay-to-continue.plz</strong></code></p><p id="a904" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运筹学</p><p id="cf20" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe lv lw lx ly b">POST /mysafe-subdomain/User HTTP 1.1<br/>Host: mysafedomain.com<br/>HTTP/1.1 302 Object moved<br/>Location: <a class="ae lz" href="https://mysafedomain.com/" rel="noopener ugc nofollow" target="_blank">https://mysafedomain.com/</a><br/><strong class="jp ir">url=/../../internal-files/hidden.keys</strong></code></p><h2 id="2955" class="kx ky iq bd kz la lb dn lc ld le dp lf jy lg lh li kc lj lk ll kg lm ln lo lp bi translated">如何检查应用程序是否容易受到开放重定向的攻击？</h2><p id="8ca8" class="pw-post-body-paragraph jn jo iq jp b jq lq js jt ju lr jw jx jy ls ka kb kc lt ke kf kg lu ki kj kk ij bi translated">步骤:</p><ol class=""><li id="a0b7" class="mb mc iq jp b jq jr ju jv jy md kc me kg mf kk mg mh mi mj bi translated">查找应用程序中发生的每个重定向实例。<br/>查找<em class="ma"> 3xx状态码</em>和<em class="ma">位置</em>表头<br/>T6】</li><li id="3920" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mg mh mi mj bi translated">使用<em class="ma"> refresh </em> header，在固定的时间间隔后，用任意URL重新加载页面，您可以将时间间隔设置为0，触发立即重定向。<br/> <code class="fe lv lw lx ly b">HTTP/1.1 200 OK<br/>Refresh: 0; <br/>url=<a class="ae lz" href="http://my-safedomain.com/index.html" rel="noopener ugc nofollow" target="_blank">http://mysafedomain.com/index.html</a></code></li><li id="9636" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mg mh mi mj bi translated">检查HTML <em class="ma"> &lt; meta &gt; </em>标签，复制任何HTTP头的行为，进行重定向。<br/> <code class="fe lv lw lx ly b">HTTP/1.1 200 OK<br/>Content-Length: 123<br/>&lt;html&gt;<br/>&lt;head&gt;<br/>&lt;meta http-equiv=”refresh” content=”0;<br/>url=<a class="ae lz" href="http://my-safedomain.com/index.html" rel="noopener ugc nofollow" target="_blank">http://mysafedomain.com/index.html</a>"&gt;<br/>&lt;/head&gt;<br/>&lt;/html&gt;</code></li><li id="e5eb" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mg mh mi mj bi translated">检查JavaScript中用于将浏览器重定向到任意URL的API。<br/> <code class="fe lv lw lx ly b">HTTP/1.1 200 OK<br/>Content-Length: 123<br/>&lt;html&gt;<br/>&lt;head&gt;<br/>&lt;script&gt;<br/>document.location=”<a class="ae lz" href="http://mysafedomain.com/index.html" rel="noopener ugc nofollow" target="_blank">http://mysafedomain.com/index.html</a>";<br/>&lt;/script&gt;<br/>&lt;/head&gt;<br/>&lt;/html&gt;</code></li></ol><p id="79a0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在上述场景中，用您的URL替换安全重定向URL，并相应地修改请求。如果应用程序被重定向到修改过的目的地，它肯定是易受攻击的。</p><p id="b782" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">应用程序可能正在实现到绝对URL的重定向，尝试用外部域替换绝对URL以检查它是否重定向，或者用外部域的绝对URL替换相对URL以测试它是否重定向。</p><p id="5375" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此外，应用程序可能会通过阻止绝对URL来执行检查或将特定模式列入黑名单。您可以尝试将URL修改为:</p><p id="ac6d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe lv lw lx ly b">HtTp://notsafedomain.com<br/>%00http://notsafedomain.com<br/>(space)http://notsafedomain.com<br/>//notsafedomain.com<br/>(“http://” encoded) %68%74%74%70%3a%2f%2fnotsafedomain.com<br/>(“http://” double-encoded) %2568%2574%2574%2570%253a%252f%252fnotsafedomain.com <br/>https://notsafedomain.com<br/>http:\\notsafedomain.com<br/>http:///notsafedomain.com<br/>http://http://notsafedomain.com<br/>http://notsafedomain.com/http://notsafedomain.com<br/>hthttp://tp://notsafedomain.com<br/>http:/mysafedomain.com.notsafedomain.com<br/>http://notsafedomain.com/?http://safedomain.com<br/>http://notsafedomain.com/%23http://safedomain.com</code></p><p id="a030" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在重定向是通过从DOM请求数据的客户端JavaScript执行的情况下，重定向的代码通常在客户端是可见的。寻找下面可能执行重定向的JavaScript APIs:</p><p id="0ca7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe lv lw lx ly b">&gt;document.location<br/>&gt;document.URL<br/>&gt;document.open()<br/>&gt;window.location.href<br/>&gt;window.navigate()<br/>&gt;window.open()</code></p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi mp"><img src="../Images/45d4f129288982dc8ebdcac8ae0a23ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:996/1*yNRGpdCU3ut_3AbDJSwSLg.gif"/></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk translated">冲浪运动</figcaption></figure><h2 id="3343" class="kx ky iq bd kz la lb dn lc ld le dp lf jy lg lh li kc lj lk ll kg lm ln lo lp bi translated">绕过CSRF验证:</h2><p id="7c22" class="pw-post-body-paragraph jn jo iq jp b jq lq js jt ju lr jw jx jy ls ka kb kc lt ke kf kg lu ki kj kk ij bi translated">为了防止应用程序被重定向到随机URL，应用程序实现了CSRF令牌。颁发CSRF令牌并不意味着应用程序对CSRF是安全的。</p><p id="f45c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以检查颁发的令牌的有效性，并使用规定的方法绕过验证和测量，如下所示:</p><ol class=""><li id="51d9" class="mb mc iq jp b jq jr ju jv jy md kc me kg mf kk mg mh mi mj bi translated">检查是否有任何CSRF代币发行。否则，应用程序肯定容易受到CSRF的攻击。</li><li id="82c9" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mg mh mi mj bi translated">检查是否设置了适当的措施来验证令牌&amp;并相应地寻找响应。</li><li id="e349" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mg mh mi mj bi translated">通过代理拦截请求并修改它。尝试发送一个没有CSRF令牌的请求。如果请求被接受，应用程序无疑会发出一个令牌，但不会验证它。</li><li id="0229" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mg mh mi mj bi translated">尝试使用空白CSRF令牌发送请求。如果成功，应用程序再次无法验证令牌的值。</li><li id="eadd" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mg mh mi mj bi translated">尝试使用随机CSRF令牌发送请求，遵循应用程序实现的模式来颁发令牌。如果成功，应用程序会根据有效的令牌错误地验证令牌的值。</li><li id="adf0" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mg mh mi mj bi translated">检查应用程序是否接受来自过期用户会话的CSRF令牌。登录应用程序，捕获CSRF令牌。从应用程序注销并重新登录(确保从浏览器中删除本地缓存的数据和cookie值),并用之前的令牌值替换CSRF令牌。这里，问题在于令牌的到期时间。</li><li id="612b" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mg mh mi mj bi translated">尝试使用您的有效CSRF令牌向另一个用户发送修改后的请求。获取您的令牌，并尝试对另一个用户进行验证。这表明颁发的CSRF令牌没有针对特定用户会话进行验证。相反，它被单独验证为被接受的令牌。</li><li id="b10b" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mg mh mi mj bi translated">检查应用程序是否容易受到动词篡改的影响，用GET替换POST，反之亦然，然后提交请求。检查它是否被接受为有效请求。</li><li id="cc1c" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mg mh mi mj bi translated">解码CSRF令牌使用的模式，并相应地生成有效CSRF令牌的下一序列。<br/> <strong class="jp ir">举例:</strong>如果发布的令牌使用-<em class="ma"/><br/><code class="fe lv lw lx ly b">54adb3bf6a47a24f636213c6bb5b7537c504e997867633756826cee0c4bbbb55</code><br/>对上述令牌进行解码，我们得到值-<code class="fe lv lw lx ly b"><strong class="jp ir">19800765367890026786</strong></code><br/>将其递增为<code class="fe lv lw lx ly b"><strong class="jp ir">19800765367890026787, 19800765367890026788, 19800765367890026789</strong></code>，以此类推。<br/>在SHA-256将其编码为— <br/> <code class="fe lv lw lx ly b"><strong class="jp ir"><em class="ma">19800765367890026787:</em></strong><em class="ma">82b676033b162958cc97f4690ad01b5c007772b42763be6fe25693f6983f0219<br/></em><strong class="jp ir"><em class="ma">19800765367890026788:</em></strong><em class="ma">9e9589ba387c8a368ff7a4db21618d7af01288c6b234ce2beb7d162e38336602<br/></em><strong class="jp ir"><em class="ma">19800765367890026789:</em></strong><em class="ma">faa9e8d6270703700bd02ae6f7d1d6bebfe25e2530d7fd5f005b1c1aab896e68</em></code> <br/>尝试使用上述令牌作为CSRF令牌。</li><li id="61bd" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mg mh mi mj bi translated">检查cookie属性是否用于创建CSRF令牌。如果应用程序易受标头注入的影响。这可能会导致反CSRF绕过，因为攻击者可以修改自己的cookie。</li><li id="5652" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mg mh mi mj bi translated">仔细观察CSRF令牌，它们可能有一个静态值&amp;一个动态值。尝试仅使用CSRF令牌的静态值发送修改后的请求。检查它的所有内容是否都经过正确验证。</li></ol><p id="314c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">有关开放重定向的更多示例负载，请参考Pentester Land:备忘单:</strong></p><div class="mq mr gp gr ms mt"><a href="https://pentester.land/cheatsheets/2018/11/02/open-redirect-cheatsheet.html" rel="noopener  ugc nofollow" target="_blank"><div class="mu ab fo"><div class="mv ab mw cl cj mx"><h2 class="bd ir gy z fp my fr fs mz fu fw ip bi translated">打开重定向备忘单</h2><div class="na l"><h3 class="bd b gy z fp my fr fs mz fu fw dk translated">嗨，这是一个开放重定向漏洞的备忘单。这是初稿。我会在每次发现一个…</h3></div><div class="nb l"><p class="bd b dl z fp my fr fs mz fu fw dk translated">彭特斯.兰</p></div></div><div class="nc l"><div class="nd l ne nf ng nc nh kr mt"/></div></div></a></div><p id="4ca0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">再见。</p></div></div>    
</body>
</html>