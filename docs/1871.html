<html>
<head>
<title>Angler Exploitation Kit Infection 2 — Malware Traffic Analysis</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Angler漏洞利用工具包感染2 —恶意软件流量分析</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/angler-exploitation-kit-infection-2-malware-traffic-analysis-d4fc6ce8790b?source=collection_archive---------1-----------------------#2022-02-08">https://infosecwriteups.com/angler-exploitation-kit-infection-2-malware-traffic-analysis-d4fc6ce8790b?source=collection_archive---------1-----------------------#2022-02-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/499ee6b5a33e5e71605983e748129bb8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wUkoCoptXNIuT3S9FyGdQQ.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated"><a class="ae kc" href="https://www.flickr.com/photos/allan_bruce/398032677" rel="noopener ugc nofollow" target="_blank">琵琶鱼</a></figcaption></figure><p id="3a10" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我使用Network Miner、Wireshark和Brim来分析一个PCAP文件，该文件捕获了属于Angler漏洞利用工具包感染的网络流量。PCAP的文件属于蓝色团队在<a class="ae kc" href="https://cyberdefenders.org/blueteam-ctf-challenges/57" rel="noopener ugc nofollow" target="_blank">网络卫士</a>网站上发起的挑战，名为“<em class="lb">恶意软件流量分析4 </em>”，由<a class="ae kc" href="https://twitter.com/malware_traffic" rel="noopener ugc nofollow" target="_blank"> Brad Duncan </a>创建。</p></div><div class="ab cl lc ld hu le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="ij ik il im in"><h1 id="f446" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">放弃</h1><p id="98a6" class="pw-post-body-paragraph kd ke iq kf b kg mh ki kj kk mi km kn ko mj kq kr ks mk ku kv kw ml ky kz la ij bi translated">我喜欢在一篇文章之前添加一个简短的免责声明，以鼓励人们在阅读本文之前尝试挑战，因为这篇文章中显然会有<strong class="kf ir">剧透</strong><strong class="kf ir"/>。我相信，如果你先自己尝试，然后在遇到困难或需要提示时再回来写这篇文章，你会更喜欢这个挑战。所以不要再拖延了，让我们开始吧！</p></div><div class="ab cl lc ld hu le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="ij ik il im in"><h1 id="b3b1" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">挑战问题</h1><blockquote class="mm mn mo"><p id="b95e" class="kd ke lb kf b kg kh ki kj kk kl km kn mp kp kq kr mq kt ku kv mr kx ky kz la ij bi translated">1.受害者IP地址是什么？</p><p id="7d9f" class="kd ke lb kf b kg kh ki kj kk kl km kn mp kp kq kr mq kt ku kv mr kx ky kz la ij bi translated">2.受害者的主机名是什么？</p></blockquote><p id="d376" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在NetworkMiner的hosts选项卡下，我可以看到两个私有内部网络，它们都包含一台windows机器。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div class="gh gi ms"><img src="../Images/3260dc844a50806a866d5262012b5cc6.png" data-original-src="https://miro.medium.com/v2/resize:fit:848/format:webp/1*N08KvibUvUNu21nk5sSZQA.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">专用内部网络。</figcaption></figure><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mx"><img src="../Images/09978e6cb8abb88d601c0342b0fa3cd0.png" data-original-src="https://miro.medium.com/v2/resize:fit:820/format:webp/1*He2X3eSHILyu-rYE3iA3qA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">专用内部网络。</figcaption></figure><p id="e54f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在Wireshark中，我可以导航到“<em class="lb">统计数据&gt;端点&gt; IPv4选项卡</em>”，并根据数据包的数量对IP进行排序。可以看到<strong class="kf ir">土耳其-汤姆的</strong> Windows机流量很大。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div class="gh gi my"><img src="../Images/94fb3ba225572286aa4b15fa5433ef67.png" data-original-src="https://miro.medium.com/v2/resize:fit:394/format:webp/1*sJBkSZrflv6QCcbnZj0sZA.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">Wireshark端点。</figcaption></figure><p id="bbcc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">根据以上信息，我们可以假设<strong class="kf ir"> Turkey-Tom的</strong> Windows机器是被感染的主机，但需要更深入的调查来确认这一点。</p><blockquote class="mm mn mo"><p id="da28" class="kd ke lb kf b kg kh ki kj kk kl km kn mp kp kq kr mq kt ku kv mr kx ky kz la ij bi translated">3.漏洞利用工具包的名称是什么？</p></blockquote><p id="1fe6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在Wireshark中，我们可以导航到“<em class="lb">统计数据&gt;对话&gt; TCP选项卡</em>”，并根据数据包的数量对对话进行排序。我可以看到最上面的对话是在土耳其汤姆的T21 Windows机器和下面突出显示的IP之间。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/a6e0856bfffdde2fc389f640b39b290d.png" data-original-src="https://miro.medium.com/v2/resize:fit:852/format:webp/1*VMVcth9zlU3S7moDvhswwQ.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">Wireshark顶级TCP对话。</figcaption></figure><p id="f8ce" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在NetworkMiner中，我可以看到IP地址的详细信息。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div class="gh gi na"><img src="../Images/dabac965a444ca439c329ee30af74cad.png" data-original-src="https://miro.medium.com/v2/resize:fit:784/format:webp/1*RKFgd9L15pjSnWDt_qOv8g.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">NetworkMiner IP地址详细信息。</figcaption></figure><p id="80b0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我可以看到对话发生在端口80上，所以我决定看看可以从Wireshark导出哪些与IP地址的FQDN相关的HTTP对象。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/7a50926bd01bda6b81e445aab5129dd4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1334/format:webp/1*49QyC3heN414DNjkVBFRyA.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">与IP地址的FQDN相关的HTTP对象。</figcaption></figure><p id="6a3d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果我们导出这些HTTP对象并将它们上传到VirusTotal，我们可以看到其中两个被标记为恶意的。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/d3f66c6e9b6705e394d3a9e1f63b3435.png" data-original-src="https://miro.medium.com/v2/resize:fit:1244/format:webp/1*hBouOOgYXidyQ6AMAueMpA.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">嵌入JS的VirusTotal HTML文件。</figcaption></figure><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/2d18714bbbd50eb077efd09e9ae4cc6f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1302/format:webp/1*llvGOW2ToXX4x79YMUtHtA.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">病毒总数闪存文件。</figcaption></figure><p id="c3b2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在VirusTotal中，我们可以看到一些安全供应商已经确定这些恶意文件与Angler EK有关。在AlienVault中，我们还可以看到，从中检索到这些恶意文件的web服务器的IP地址是Angler EK 的一个<a class="ae kc" href="https://otx.alienvault.com/pulse/56c490f067db8c1250175b9d/" rel="noopener ugc nofollow" target="_blank">网络IoC。最后，在Brim中我们可以看到Bedep有效载荷，这是一个Angler独有的恶意软件下载器。</a></p><p id="3367" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">根据<a class="ae kc" href="https://blog.malwarebytes.com/detections/trojan-bedep/" rel="noopener ugc nofollow" target="_blank"> MalwareBytes </a>:</p><blockquote class="mm mn mo"><p id="5319" class="kd ke lb kf b kg kh ki kj kk kl km kn mp kp kq kr mq kt ku kv mr kx ky kz la ij bi translated">木马。Bedep在受感染的系统上打开后门，可以下载额外的<a class="ae kc" href="https://blog.malwarebytes.com/glossary/malware/" rel="noopener ugc nofollow" target="_blank">恶意软件</a>到系统中。<br/>该木马通常通过<a class="ae kc" href="https://blog.malwarebytes.com/glossary/exploit-kit/" rel="noopener ugc nofollow" target="_blank">漏洞利用工具包</a>投放到受影响的系统上。</p></blockquote><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div class="ab gu cl ne"><img src="../Images/aff061449b15493539b52fb3673060b5.png" data-original-src="https://miro.medium.com/v2/format:webp/1*N3P584Bi7wD3BjonUkjNuw.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">边缘比德普警报。</figcaption></figure><blockquote class="mm mn mo"><p id="d46a" class="kd ke lb kf b kg kh ki kj kk kl km kn mp kp kq kr mq kt ku kv mr kx ky kz la ij bi translated">4.为该漏洞提供服务的IP地址是什么？</p></blockquote><p id="78fe" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">正如我们前面已经看到的，可以在NetworkMiner中找到利用漏洞的IP地址。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div class="gh gi na"><img src="../Images/dabac965a444ca439c329ee30af74cad.png" data-original-src="https://miro.medium.com/v2/resize:fit:784/format:webp/1*RKFgd9L15pjSnWDt_qOv8g.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">利用该漏洞的IP地址。</figcaption></figure><blockquote class="mm mn mo"><p id="53c5" class="kd ke lb kf b kg kh ki kj kk kl km kn mp kp kq kr mq kt ku kv mr kx ky kz la ij bi translated">5.用于指示闪存版本的HTTP报头是什么？</p></blockquote><p id="0c53" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在Wireshark中，我们可以查看用于下载恶意flash文件的HTTP GET请求，并查看用于指示flash版本的标头。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/3e4883dfe43744787c79148e6f21e3e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:788/format:webp/1*d4F2udAMCsq1yh-qS9ZtAQ.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">Flash版本的HTTP标头。</figcaption></figure><blockquote class="mm mn mo"><p id="9467" class="kd ke lb kf b kg kh ki kj kk kl km kn mp kp kq kr mq kt ku kv mr kx ky kz la ij bi translated">6.重定向到利用漏洞的服务器的恶意URL是什么？</p></blockquote><p id="b4a3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在Wireshark中，我们可以查看包含嵌入JS代码的恶意HTML文件的HTTP流。在这里，我们可以看到重定向到利用漏洞的服务器的恶意URL。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/7a1f1704bdbe7163a773724c70395921.png" data-original-src="https://miro.medium.com/v2/resize:fit:1164/format:webp/1*kyyixNhBhBgdc57sPjMKzQ.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">重定向到利用漏洞的服务器的恶意URL。</figcaption></figure><blockquote class="mm mn mo"><p id="ea66" class="kd ke lb kf b kg kh ki kj kk kl km kn mp kp kq kr mq kt ku kv mr kx ky kz la ij bi translated">7.用于将受害者重定向到漏洞服务器的技术对应的CAPEC ID是什么？capec.mitre.org的更多信息</p></blockquote><p id="7fa3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了确定使用何种技术将受害者重定向到漏洞利用服务器，我们需要使用Wireshark追溯感染事件的时间线。查看上面问题6的图像，我们可以看到受害者为了访问利用漏洞的服务器而访问的网站。在Wireshark中，我们可以查看恶意重定向URL的HTTP流。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/a2d8a09635a8d144c68770609efd5a7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1166/format:webp/1*wIR0ylTJyx9h7nvnvdgRBw.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">Wireshark iFrame覆盖。</figcaption></figure><p id="a989" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以看到，iFrame覆盖攻击被用来将受害者重定向到漏洞利用登录页面。我们可以在谷歌上进行快速搜索，找到这次攻击对应的CAPEC ID(即<a class="ae kc" href="https://capec.mitre.org/data/definitions/222.html" rel="noopener ugc nofollow" target="_blank"> CAPEC-222: iFrame Overlay </a>)。</p><blockquote class="mm mn mo"><p id="b0a3" class="kd ke lb kf b kg kh ki kj kk kl km kn mp kp kq kr mq kt ku kv mr kx ky kz la ij bi translated">8.被入侵网站的FQDN是多少？</p><p id="c21a" class="kd ke lb kf b kg kh ki kj kk kl km kn mp kp kq kr mq kt ku kv mr kx ky kz la ij bi translated">9.受损网站包含恶意js，可将用户重定向到另一个网站。传递给“document.write”函数的变量名是什么？</p></blockquote><p id="2f4c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">仍然追溯我们在Wireshark中的步骤，我们可以在问题7的上图中看到受害者根据referrer请求头值访问的网站。查看这个网站的HTTP对象，我可以看到一个JS代码对象。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/dd08b3719b399a522a9ed8c91c686549.png" data-original-src="https://miro.medium.com/v2/resize:fit:984/format:webp/1*t0Nz4CkWk8lMcXU_JGealw.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">Wireshark HTTP JavaScript。</figcaption></figure><p id="5ecf" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在Wireshark中，我们可以查看该网站的HTTP流和JavaScript代码。查看代码，我们可以看到重定向到服务于漏洞的服务器的恶意URL，以及传递给“<em class="lb"> document.write </em>函数的变量名。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nj"><img src="../Images/d561e640096f2c79f5de99daa4472f17.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XFsEE1OZV962jjQj6lqopw.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">带有恶意URL的JavaScript，该恶意URL重定向到利用漏洞的服务器。</figcaption></figure><blockquote class="mm mn mo"><p id="d39e" class="kd ke lb kf b kg kh ki kj kk kl km kn mp kp kq kr mq kt ku kv mr kx ky kz la ij bi translated">10.在机器上发现的恶意软件的编译时间戳是什么？格式:YYYY-MM-DD hh:mm:ss</p></blockquote><p id="f9b8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在花了一段时间试图解决这个问题之后，我还是没有找到答案。</p></div><div class="ab cl lc ld hu le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="ij ik il im in"><h1 id="5d49" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">结束语</h1><p id="3d7e" class="pw-post-body-paragraph kd ke iq kf b kg mh ki kj kk mi km kn ko mj kq kr ks mk ku kv kw ml ky kz la ij bi translated">我发现这个挑战对于使用NetworkMiner、Brim和Wireshark进行练习来说非常棒。我也真的很喜欢通过这个PCAP挑战文件工作，并了解如何钓鱼开发工具包感染Windows虚拟机。谢谢你一直读到最后，继续黑下去😄！</p></div><div class="ab cl lc ld hu le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="ij ik il im in"><h1 id="4207" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">🔈 🔈Infosec Writeups正在组织其首次虚拟会议和网络活动。如果你对信息安全感兴趣，这是最酷的地方，有16个令人难以置信的演讲者和10多个小时充满力量的讨论会议。<a class="ae kc" href="https://iwcon.live/" rel="noopener ugc nofollow" target="_blank">查看更多详情并在此注册。</a></h1><div class="nk nl gp gr nm nn"><a href="https://iwcon.live/" rel="noopener  ugc nofollow" target="_blank"><div class="no ab fo"><div class="np ab nq cl cj nr"><h2 class="bd ir gy z fp ns fr fs nt fu fw ip bi translated">IWCon2022 - Infosec书面报告虚拟会议</h2><div class="nu l"><h3 class="bd b gy z fp ns fr fs nt fu fw dk translated">与世界上最优秀的信息安全专家建立联系。了解网络安全专家如何取得成功。将新技能添加到您的…</h3></div><div class="nv l"><p class="bd b dl z fp ns fr fs nt fu fw dk translated">iwcon.live</p></div></div><div class="nw l"><div class="nx l ny nz oa nw ob jw nn"/></div></div></a></div></div></div>    
</body>
</html>