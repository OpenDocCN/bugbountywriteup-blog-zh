<html>
<head>
<title>Intigriti — XSS Challenge 0321</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Intigriti — XSS挑战赛0321</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/intigriti-xss-challenge-0321-472ae0a48254?source=collection_archive---------0-----------------------#2021-03-28">https://infosecwriteups.com/intigriti-xss-challenge-0321-472ae0a48254?source=collection_archive---------0-----------------------#2021-03-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="84e6" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">XSS与CSRF旁路</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi kf"><img src="../Images/c4bd4f2b1a975bb67e77fa78734a2f77.png" data-original-src="https://miro.medium.com/v2/resize:fit:1166/format:webp/1*9AD-uoYs1mbF-wxaVYjwQQ.png"/></div><figcaption class="kn ko gj gh gi kp kq bd b be z dk translated">推特上的挑战公告</figcaption></figure><p id="5de8" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">那是三月，Intigriti出版了新的XSS挑战。因为好的XSS挑战总是学习新的有趣方法的一种方式，我给了它一个尝试。</p><h1 id="ff09" class="ln lo iq bd lp lq lr ls lt lu lv lw lx jw ly jx lz jz ma ka mb kc mc kd md me bi translated">XSS</h1><p id="9856" class="pw-post-body-paragraph kr ks iq kt b ku mf jr kw kx mg ju kz la mh lc ld le mi lg lh li mj lk ll lm ij bi translated">挑战赛网站(<a class="ae mk" href="https://challenge-0321.intigriti.io/" rel="noopener ugc nofollow" target="_blank">https://challenge-0321.intigriti.io/</a>)包含一般规则和输入注释的输入框。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="mm mn di mo bf mp"><div class="gh gi ml"><img src="../Images/276c26e54056ae05425fc62183f856dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rS9VlYB_RrL46u1jW-q_SA.png"/></div></div><figcaption class="kn ko gj gh gi kp kq bd b be z dk translated">注释输入字段</figcaption></figure><p id="c71a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如果我们输入并存储一个注释，浏览器会向服务器发送一个POST请求，其中包含注释、CSRF令牌和用户的PHP会话id。</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="cf27" class="mv lo iq mr b gy mw mx l my mz">POST / HTTP/1.1<br/>Host: challenge-0321.intigriti.io<br/>Content-Type: application/x-www-form-urlencoded<br/>Content-Length: 49<br/>Cookie: PHPSESSID=&lt;session id&gt;<br/>[...]<br/><br/>csrf=&lt;csrf token&gt;&amp;notes=this+is+an+example</span></pre><p id="80b5" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">因此，服务器将使用网站内容进行响应，包括新的注释、新的CSRF令牌和网站创建时的时间戳。</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="d33f" class="mv lo iq mr b gy mw mx l my mz">&lt;html&gt;<br/>[...]<br/>     &lt;div class="card-container"&gt;<br/>         &lt;form method="POST" action="./" id="update-notes"&gt;<br/>            &lt;div class="card-header"&gt;Your notes:&lt;span id="actions"&gt;&lt;a id="notes-save" href="#"&gt;save&lt;/a&gt;&lt;/span&gt;&lt;/div&gt;<br/>            &lt;p id="notes-display" class="card-content" contenteditable="true"&gt;this is an example&lt;/p&gt;<br/>            &lt;input type="hidden" name="csrf" value="e79f7691593b3775c173f13512979d00"/&gt;<br/>            &lt;input type="hidden" id="notes-value"  name="notes" value=""/&gt;<br/>         &lt;/form&gt;<br/>      &lt;/div&gt;<br/>    [...]<br/>   &lt;!-- page generated at 2021-03-25 10:34:19 --&gt;<br/>&lt;/html&gt;</span></pre><p id="93b9" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在服务器端，后端检查提交的笔记。如果我们发送一个特殊字符来转义HTML元素，比如<code class="fe na nb nc mr b">&lt;</code>或<code class="fe na nb nc mr b">&gt;</code>，服务器会对它们进行净化以防止注入攻击。此外，如果注释中包含URL或电子邮件地址，服务器会将它们转换为包含URL或邮件的<code class="fe na nb nc mr b">&lt;a&gt;</code>元素作为href。</p><p id="0ff2" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">例如，注释“<em class="nd"> http://a.b或a@b.com</em>”将被转换为:</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="ee59" class="mv lo iq mr b gy mw mx l my mz">&lt;a href="http://a.b" target="_blank"&gt;http://a.b&lt;/a&gt; or &lt;a href="mailto:a@b.com"&gt;a@b.com&lt;/a&gt;</span></pre><p id="28bb" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">摆弄电子邮件地址并阅读<a class="ae mk" href="https://tools.ietf.org/html/rfc5322" rel="noopener ugc nofollow" target="_blank"> RFC 5322 </a>，我们知道电子邮件地址的第一部分，即@之前的部分，可以用双引号括起来。在这种情况下，服务器不会清理电子邮件地址周围的双引号，我们可以对HTML元素进行转义。</p><p id="b9ec" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">和以前一样，在前面的例子<em class="nd">"a"@b.com</em>中添加双引号会导致<code class="fe na nb nc mr b">&lt;a href="mailto:"a"@b.com"&gt;"a"@b.com&lt;/a&gt;</code>中的字母<code class="fe na nb nc mr b">a</code>不属于任何属性。</p><p id="5a92" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">考虑到这一点，很容易向<code class="fe na nb nc mr b">&lt;a&gt;</code>元素添加任何属性，并滥用它来触发XSS。mouseover属性就是一个例子:</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="db6f" class="mv lo iq mr b gy mw mx l my mz">"onmousemove=alert('flag{THIS_IS_THE_FLAG}');"@evil.com</span></pre><p id="fd8d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">被转换为</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="626e" class="mv lo iq mr b gy mw mx l my mz">&lt;a href="mailto:" onmousemove="alert('flag{THIS_IS_THE_FLAG}');&amp;quot;<a class="ae mk" href="http://twitter.com/evil" rel="noopener ugc nofollow" target="_blank">@evil</a>.com&amp;quot;"&gt;"onmousemove=alert('flag{THIS_IS_THE_FLAG}');"<a class="ae mk" href="http://twitter.com/evil" rel="noopener ugc nofollow" target="_blank">@evil</a>.com&lt;/a&gt;</span></pre><h1 id="998e" class="ln lo iq bd lp lq lr ls lt lu lv lw lx jw ly jx lz jz ma ka mb kc mc kd md me bi translated">CSRF旁路</h1><p id="2273" class="pw-post-body-paragraph kr ks iq kt b ku mf jr kw kx mg ju kz la mh lc ld le mi lg lh li mj lk ll lm ij bi translated">为了将XSS传递给任何用户，我们仍然必须绕过CSRF令牌。</p><p id="4dc9" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">查看一个示例CSRF令牌<em class="nd">e79f 7691593 b 3775 c 173 f 13512979d 00</em>，我们可以从长度和使用的字符猜测它可能是一个MD5散列。在网页的底部，我们还可以看到服务器端创建网站时的时间戳。由于获取当前的UNIX时间戳、对其进行哈希处理并将其用作CSRF令牌是一个典型的错误，所以我们应该尝试一下。</p><p id="f7ae" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">为了快速检查，我们可以使用前面例子中的<a class="ae mk" href="https://gchq.github.io/CyberChef/#recipe=To_UNIX_Timestamp('Seconds%20(s)',true,false)MD5()&amp;input=MjAyMS0wMy0yNSAxMDozNDoxOQ" rel="noopener ugc nofollow" target="_blank"> CyberChef </a>以及时间戳和CSRF令牌。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/2834d7f35b14abed24aff5004df305f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1290/format:webp/1*myZatwklVQFQYXfHbflIsw.png"/></div><figcaption class="kn ko gj gh gi kp kq bd b be z dk translated">将时间戳转换为UNIX时间，并在<a class="ae mk" href="https://gchq.github.io/CyberChef/#recipe=To_UNIX_Timestamp('Seconds%20(s)',true,false)MD5()&amp;input=MjAyMS0wMy0yNSAxMDozNDoxOQ" rel="noopener ugc nofollow" target="_blank">赛博网</a>中使用MD5对其进行哈希运算</figcaption></figure><p id="ea90" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">正如我们所看到的，输出散列与前面提到的CSRF令牌相匹配。</p><p id="9519" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">了解这一点后，我们现在可以创建一个受害者会打开的PoC网页。网站首先向服务器发送初始请求，以生成新的CSRF令牌。由于CORS，网页不能简单地从响应中读取新生成的CSRF令牌，但它可以猜测它，因为我们大约知道创建的时间戳。然后，网站发送第二个带有XSS负载的请求。</p><h1 id="c169" class="ln lo iq bd lp lq lr ls lt lu lv lw lx jw ly jx lz jz ma ka mb kc mc kd md me bi translated">完整概念验证</h1><p id="d4e0" class="pw-post-body-paragraph kr ks iq kt b ku mf jr kw kx mg ju kz la mh lc ld le mi lg lh li mj lk ll lm ij bi translated">要重现该漏洞，可以在Firefox中使用以下HTML页面。</p><ol class=""><li id="98e8" class="nf ng iq kt b ku kv kx ky la nh le ni li nj lm nk nl nm nn bi translated">用Firefox打开https://challenge-0321.intigriti.io/的<a class="ae mk" href="https://challenge-0321.intigriti.io/" rel="noopener ugc nofollow" target="_blank">创建一个会话ID</a></li><li id="a9df" class="nf ng iq kt b ku no kx np la nq le nr li ns lm nk nl nm nn bi translated">用火狐打开poc.html</li><li id="866a" class="nf ng iq kt b ku no kx np la nq le nr li ns lm nk nl nm nn bi translated">点击几次<em class="nd">发送有效载荷</em>，因为有时时间戳不正确</li><li id="ee81" class="nf ng iq kt b ku no kx np la nq le nr li ns lm nk nl nm nn bi translated">返回<a class="ae mk" href="https://challenge-0321.intigriti.io/" rel="noopener ugc nofollow" target="_blank">https://challenge-0321.intigriti.io/</a>并将鼠标悬停在注释字段</li></ol><p id="a1da" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">poc.html</strong></p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nt nu l"/></div></figure><h1 id="519d" class="ln lo iq bd lp lq lr ls lt lu lv lw lx jw ly jx lz jz ma ka mb kc mc kd md me bi translated">摘要</h1><p id="e5b9" class="pw-post-body-paragraph kr ks iq kt b ku mf jr kw kx mg ju kz la mh lc ld le mi lg lh li mj lk ll lm ij bi translated">一如既往，这是一个有趣的挑战。此外，它是真实的，因为这个XSS漏洞在微软Outlook 中被类似地<a class="ae mk" href="https://www.cyberark.com/resources/threat-research-blog/outlook-for-android-xss" rel="noopener ugc nofollow" target="_blank">发现。</a></p><p id="c0bc" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我的解决方案只适用于用户交互，因为用户需要将鼠标悬停在notes字段上。不幸的是，我没有找到没有用户交互的解决方案，并期待其他文章。</p><p id="d549" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">稍微跟进一下:<br/>我被选为最佳文章作者之一，并赢得了一张€50英镑的代金券。感谢Intigriti的巨大挑战和奖品！</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nv nu l"/></div></figure></div></div>    
</body>
</html>