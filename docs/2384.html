<html>
<head>
<title>Write-up: JWT authentication bypass via jwk header injection @ PortSwigger Academy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">报道:通过jwk头注入@ PortSwigger Academy绕过JWT认证</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/write-up-jwt-authentication-bypass-via-jwk-header-injection-portswigger-academy-a08975256e8c?source=collection_archive---------1-----------------------#2022-09-22">https://infosecwriteups.com/write-up-jwt-authentication-bypass-via-jwk-header-injection-portswigger-academy-a08975256e8c?source=collection_archive---------1-----------------------#2022-09-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/3e47c073bdf3da23739f0fc07ddcaa49.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*zPhDGGupNrqISE6M.png"/></div></div></figure><p id="704f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这篇关于实验室<em class="kw">通过jwk头注入</em>绕过JWT认证的文章是我在<a class="ae kx" href="https://portswigger.net/web-security" rel="noopener ugc nofollow" target="_blank"> PortSwigger的Web安全学院</a>的演练系列的一部分。</p><p id="a9f8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">学习路径</strong>:高级主题→ JWT攻击</p><div class="ky kz gp gr la lb"><a href="https://portswigger.net/web-security/jwt/lab-jwt-authentication-bypass-via-jwk-header-injection" rel="noopener  ugc nofollow" target="_blank"><div class="lc ab fo"><div class="ld ab le cl cj lf"><h2 class="bd ir gy z fp lg fr fs lh fu fw ip bi translated">实验室:通过jwk报头注入绕过JWT认证|网络安全学院</h2><div class="li l"><h3 class="bd b gy z fp lg fr fs lh fu fw dk translated">练习利用现实目标的弱点。记录你从学徒到专家的进步。看哪里…</h3></div><div class="lj l"><p class="bd b dl z fp lg fr fs lh fu fw dk translated">portswigger.net</p></div></div><div class="lk l"><div class="ll l lm ln lo lk lp jw lb"/></div></div></a></div><p id="408d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Python脚本:<a class="ae kx" href="https://github.com/frank-leitner/portswigger-websecurity-academy/blob/main/23_JWT_attacks/JWT_authentication_bypass_via_jwk_header_injection/script.py" rel="noopener ugc nofollow" target="_blank"> script.py </a></p><h1 id="d198" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">实验室描述</h1><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mo"><img src="../Images/90477ab464dc671fbc66afdbd1d9f71b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*amdAn14I8NpByQ3R.png"/></div></div></figure><h1 id="cb3d" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">步伐</h1><p id="c91d" class="pw-post-body-paragraph jy jz iq ka b kb mt kd ke kf mu kh ki kj mv kl km kn mw kp kq kr mx kt ku kv ij bi translated">通常，第一步是分析实验室应用程序的功能。在这个实验室里，它是一个博客平台。为了帮助这个实验，我使用了扩展<em class="kw"> JWT编辑器</em>(可以在<em class="kw"> BApp商店</em>找到或者作为独立版本在<a class="ae kx" href="https://github.com/portswigger/jwt-editor" rel="noopener ugc nofollow" target="_blank"> github </a>上找到)</p><p id="62ef" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">实验室是关于认证功能的。我使用提供的凭证并以<code class="fe my mz na nb b">wiener</code>的身份登录。Burp将会话cookie识别为JWT，并立即对其进行解码:</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nc"><img src="../Images/42b6522a854728bf2f2c3e4cb9c899c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Ty7YCbonjU72hM1p.png"/></div></div></figure></div><div class="ab cl nd ne hu nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="ij ik il im in"><h1 id="78c1" class="lq lr iq bd ls lt nk lv lw lx nl lz ma mb nm md me mf nn mh mi mj no ml mm mn bi translated">该理论</h1><p id="e608" class="pw-post-body-paragraph jy jz iq ka b kb mt kd ke kf mu kh ki kj mv kl km kn mw kp kq kr mx kt ku kv ij bi translated">服务器使用<code class="fe my mz na nb b">RS256</code>作为令牌的算法。我有多种选择可以遵循</p><ol class=""><li id="95eb" class="np nq iq ka b kb kc kf kg kj nr kn ns kr nt kv nu nv nw nx bi translated">无算法/条形签名</li><li id="a3ac" class="np nq iq ka b kb ny kf nz kj oa kn ob kr oc kv nu nv nw nx bi translated">注入我自己的密钥</li><li id="bc62" class="np nq iq ka b kb ny kf nz kj oa kn ob kr oc kv nu nv nw nx bi translated">获取私钥(以及密码，如果受保护的话)</li></ol><p id="f099" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">第一个选项最容易测试。理论上，下一步将是检查我是否可以删除签名或将算法更改为<em class="kw"> none </em>。然而，这两个问题有专门的实验室，所以我在这里跳过检查。详情请参考我撰写的关于通过有缺陷的签名验证绕过<a class="ae kx" rel="noopener ugc nofollow" target="_blank" href="/write-up-jwt-authentication-bypass-via-flawed-signature-verification-portswigger-academy-2107eddec3b7"> JWT认证</a>和通过未验证签名绕过<a class="ae kx" href="https://systemweakness.com/write-up-jwt-authentication-bypass-via-unverified-signature-portswigger-academy-a890510bff1d" rel="noopener ugc nofollow" target="_blank"> JWT认证</a>的文章。</p><p id="03dd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">第二种选择有两种味道。我可以将算法更改为HS256并注入一个密钥，或者保留该算法并注入一个RSA密钥。尽可能少地改变总是最好的，所以尝试注入RSA密钥只改变一个变量。我也不知道后端是使用令牌中提供的算法还是执行RS256。</p><p id="9aab" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">选项(3)不太可能，也是最困难的，所以我现在跳过这一点，直到所有其他方法都失败。</p><p id="9cb7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我现在在<em class="kw"> JWT编辑器密钥库</em>中生成一个新的<em class="kw"> RSA密钥</em>:</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi od"><img src="../Images/11aab4ebdbedc34d54c9fff647c9e2b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*0S2GOXsf6otFJwBE.png"/></div></div><figcaption class="oe of gj gh gi og oh bd b be z dk translated">生成新的RSA密钥对</figcaption></figure><p id="9532" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在Burp代理中，我将请求发送到<code class="fe my mz na nb b">/my-account</code>中继器并选择<code class="fe my mz na nb b">Attack -&gt; Embedd JWK</code>选项。我选择刚刚生成的RSA签名密钥:</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oi"><img src="../Images/2d7ba00274ce4708a4a961a47c755d06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*xHde9RVYLvzmXWWc.png"/></div></div><figcaption class="oe of gj gh gi og oh bd b be z dk translated">嵌入JWK并用它签名</figcaption></figure><p id="c96c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">点击<code class="fe my mz na nb b">OK</code>后，签名自动更新。如果请求包含无效的或者没有JWT作为会话cookie，应用程序重定向到<code class="fe my mz na nb b">/login</code>页面。</p><p id="b319" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我发送请求，响应包含我的帐户页面，确认后端的签名验证使用了我在JWT报头中注入的RSA公钥信息。</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oj"><img src="../Images/777d793764c321cf2a924ccaec390498.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*TU-kRb7GEhbP7LOu.png"/></div></div><figcaption class="oe of gj gh gi og oh bd b be z dk translated">后端使用注入的公钥接受我自己的签名</figcaption></figure></div><div class="ab cl nd ne hu nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="ij ik il im in"><h1 id="b0e6" class="lq lr iq bd ls lt nk lv lw lx nl lz ma mb nm md me mf nn mh mi mj no ml mm mn bi translated">恶意负载</h1><p id="26cb" class="pw-post-body-paragraph jy jz iq ka b kb mt kd ke kf mu kh ki kj mv kl km kn mw kp kq kr mx kt ku kv ij bi translated">我将令牌的<code class="fe my mz na nb b">sub</code>值更改为<code class="fe my mz na nb b">administrator</code>，再次执行<code class="fe my mz na nb b">Attack -&gt; Embedd JWK</code>选项，复制序列化的JWT并在浏览器中更新我的会话cookie(为了操作cookie，我使用了<a class="ae kx" href="https://cookie-editor.cgagnier.ca/" rel="noopener ugc nofollow" target="_blank"> Cookie编辑器</a>):</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ok"><img src="../Images/52a0b50a1980a534fa02c88d5b9619a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*31XkBnj268hO4n7V.png"/></div></div><figcaption class="oe of gj gh gi og oh bd b be z dk translated">为管理员生成会话cookie</figcaption></figure><p id="a0ef" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我刷新<code class="fe my mz na nb b">/admin</code>页面。我看到的不是错误<code class="fe my mz na nb b">Admin interface only available if logged in as an administrator</code>，而是用户管理页面:</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ol"><img src="../Images/13a2cbdee2fb5432916260f9e97ca3c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ejCB6dSXxq02mmfv.png"/></div></div></figure><p id="8671" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">点击用户<code class="fe my mz na nb b">carlos</code>的<code class="fe my mz na nb b">Delete</code>链接后，实验室更新为</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi om"><img src="../Images/ba523bc6ebb28ce1df324e9c0f16a0ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*0r5sONuerVbdg1V_.png"/></div></div></figure></div><div class="ab cl nd ne hu nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="ij ik il im in"><p id="67a0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="kw">原载于https://github.com</em><a class="ae kx" href="https://github.com/frank-leitner/portswigger-websecurity-academy/tree/main/23_JWT_attacks/JWT_authentication_bypass_via_jwk_header_injection" rel="noopener ugc nofollow" target="_blank"><em class="kw"/></a><em class="kw">。</em></p><p id="f211" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe my mz na nb b"><a class="ae kx" href="https://medium.com/@frank.leitner/membership" rel="noopener">New to Medium? Become a Medium member to access all stories on the platform and support me at no extra cost for you!</a></code></p><h2 id="20d6" class="on lr iq bd ls oo op dn lw oq or dp ma kj os ot me kn ou ov mi kr ow ox mm oy bi translated">来自Infosec的报道:Infosec每天都有很多内容，很难跟上。<a class="ae kx" href="https://weekly.infosecwriteups.com/" rel="noopener ugc nofollow" target="_blank">加入我们的每周简讯</a>以5篇文章、4个线程、3个视频、2个GitHub Repos和工具以及1个工作提醒的形式免费获取所有最新的Infosec趋势！</h2></div></div>    
</body>
</html>