<html>
<head>
<title>Cracking Encrypted Credit Card Numbers Exposed By API</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">破解API暴露的加密信用卡号</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/cracking-encrypted-credit-card-numbers-exposed-by-api-977c6f7b996f?source=collection_archive---------1-----------------------#2021-06-22">https://infosecwriteups.com/cracking-encrypted-credit-card-numbers-exposed-by-api-977c6f7b996f?source=collection_archive---------1-----------------------#2021-06-22</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><p id="7421" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">我发现了一个暴露加密信用卡号码的API。下面是我如何破解它们来揭示完整的卡片细节。</p><figure class="kq kr ks kt gu ku gi gj paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gi gj kp"><img src="../Images/dfac789ebfbdb121a19a80bffc954993.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3Ag20OKldNr49BkS"/></div></div><figcaption class="lb lc gk gi gj ld le bd b be z dk translated">埃弗里·埃文斯在<a class="ae lf" href="https://unsplash.com/s/photos/credit-card?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="e2bc" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">在入侵一个私人bug bounty程序时，我发现一个graphql端点暴露了比它应该暴露的更多的登录用户信息。通过使用“about me”graph QL API请求，我能够猜测并检索数据库中所有登录用户的存储值，而不仅仅是web应用程序披露的值。</p><p id="2be8" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">使用这些猜测的参数，我能够检索添加到用户帐户的所有信用卡。这些信息包括:持卡人姓名、注册地址、卡的有效期、卡的最后4位数字、卡的类型以及完整信用卡号的加密版本。</p><p id="3fa1" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">该应用程序允许用户在其帐户上存储多达10张支付卡，以便在购买产品和服务时更容易结账。为了让公司将来使用它们，我知道它们必须以可解密的格式存储。在提交报告之前，我给自己设定的挑战是破解加密算法并查看原始卡号。</p><h1 id="9949" class="lg lh iu bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">信用卡号码解释</h1><p id="0d87" class="pw-post-body-paragraph jr js iu jt b ju me jw jx jy mf ka kb kc mg ke kf kg mh ki kj kk mi km kn ko in bi translated">信用卡和借记卡号码使用国际公认的标准<a class="ae lf" href="https://en.wikipedia.org/wiki/Payment_card_number" rel="noopener ugc nofollow" target="_blank"/>。支付卡号(PCN)的长度可以是8到19位，前6到8位用于识别发卡银行。这被称为发行人识别号(IIN)。所有美国运通卡都以34或37开头，所有维萨卡都以4开头，等等。</p><p id="c29c" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">还有一系列卡号是为测试目的保留的，永远不会分配给真正的客户。(这是另一个你可以测试的bug——我可以用测试卡购买吗？).我个人最喜欢的是签证:4111 1111 1111 1111。Stripe有一个你可以在任何地方使用的测试卡列表，你可以在谷歌上快速搜索“测试支付卡号”找到更多。</p><p id="1290" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">最后，大多数信用卡号都包含一个使用<a class="ae lf" href="https://en.wikipedia.org/wiki/Luhn_algorithm" rel="noopener ugc nofollow" target="_blank"> Luhn算法</a>的有效性验证号。这样，卡号的最后一位是前面所有数字的校验位。对于“4111 1111 1111 111X ”,校验位值为1。对于“4111 1111 1111 112X ”,校验位值是9。你可以自己用工具玩这个，比如<a class="ae lf" href="https://simplycalc.com/luhn-calculate.php" rel="noopener ugc nofollow" target="_blank">这个</a>。如您所见，只要您知道前缀、长度以及是否使用Luhn算法，任何人都可以为任何给定的银行生成所有可能的卡号。这就是为什么你还需要信用卡有效期和CV2号码来购物。</p><p id="dfa5" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">现在我们对信用卡号码有了更好的理解，我将继续我的攻击。</p><h1 id="4f22" class="lg lh iu bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">尝试1:颠倒算法</h1><p id="679a" class="pw-post-body-paragraph jr js iu jt b ju me jw jx jy mf ka kb kc mg ke kf kg mh ki kj kk mi km kn ko in bi translated">我创建了一个新的用户帐户，并添加了我最喜欢的Visa信用卡号码，“4111 1111 1111 1111”。当我查询API时，我收到了一个16位数字的加密版本的卡。我删除了卡，然后又添加了一次。当我再次查询API时，我收到了相同的加密值。现在我知道结果是使用固定算法静态生成的。</p><p id="48f9" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">然后我意识到API将允许我在一个请求中提交多达10个卡号。我从‘4111 1111 1111 1129’，‘4111 1111 1137’等连续上传了10个号码。试图找出一种模式。我可以看到一种模式出现的迹象，但我无法理解。响应的最后4位数字始终是原始文本的明文:“1111’、1129’、1137’等。前两个数字总是“54”代表Visa，“53”代表美国运通，等等。所以看起来卡片的第一个数字IIN变成了回答的第二个数字，他们总是以5开头。</p><p id="c485" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">由于我从API响应中知道了卡的类型以及最后4个数字，所以我已经有了16个数字中的6个数字来重建上传到应用服务器的任何卡号。</p><p id="dc1b" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">我又推了几个小时，尝试了越来越多的组合，试图尽可能接近“0000 0000 0000 0000”，但只有Luhn验证卡号有效，我仍然无法理解这种模式。我很接近了，但还不够接近。</p><p id="e8bf" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">回到画板上，上床睡觉。</p><h1 id="fbc5" class="lg lh iu bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">尝试2:彩虹桌</h1><p id="416e" class="pw-post-body-paragraph jr js iu jt b ju me jw jx jy mf ka kb kc mg ke kf kg mh ki kj kk mi km kn ko in bi translated">凌晨3点，我带着一个想法醒来。如果为提交相同卡号的所有用户生成相同的加密值，我不需要反转算法，我只需要一个彩虹表，其中包含映射到原始卡号的所有可能的加密值。</p><p id="f5cf" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">彩虹表是一个包含加密值及其对应明文的查找表。这些通常是为MD5之类的散列创建的，但是在这种情况下，我需要一个用于双向加密字符串的散列——一个可以用定制算法加密和解密的散列。</p><p id="66b5" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">第二天早上，我创建了第二个用户帐户，并输入了我的go-to卡号。当我通过API查询时，我得到了一个匹配。两个用户都收到了完全相同的加密16位字符串。太神奇了。</p><p id="f7f7" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">这意味着卡号在没有使用加密盐的情况下被加密。在密码学中，salt是添加到输入中的随机数据，用于防止重复的输入产生重复的加密输出。在不添加salt的情况下，如果有人知道给定输出的输入，其他用户的任何匹配输出都可以映射回已知的输入。由于每个用户使用不同的salt，即使是相同的卡号，输出也总是不同的。</p><p id="980d" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">盐5000的用户1:4111 1111 1111 1111+5000-&gt; 5477 2356 1143 1111</p><p id="e949" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">盐用户2 7992:4111 1111 1111 1111+7992-&gt; 5436 4343 8711 1111</p><h1 id="3bea" class="lg lh iu bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">把所有的放在一起</h1><p id="f186" class="pw-post-body-paragraph jr js iu jt b ju me jw jx jy mf ka kb kc mg ke kf kg mh ki kj kk mi km kn ko in bi translated">现在我知道了:</p><ul class=""><li id="eb23" class="mj mk iu jt b ju jv jy jz kc ml kg mm kk mn ko mo mp mq mr bi translated">该应用程序将信用卡号存储在一个双向加密的16位字符串中</li><li id="4df4" class="mj mk iu jt b ju ms jy mt kc mu kg mv kk mw ko mo mp mq mr bi translated">应用程序对所有用户使用相同的算法</li><li id="9f58" class="mj mk iu jt b ju ms jy mt kc mu kg mv kk mw ko mo mp mq mr bi translated">该应用程序不会对每个用户使用不同的加密盐，因此具有相同卡号的两个用户帐户将生成相同的加密号</li><li id="aefe" class="mj mk iu jt b ju ms jy mt kc mu kg mv kk mw ko mo mp mq mr bi translated">我可以一次上传10个卡号，然后查询所有加密的卡号</li></ul><p id="f43b" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">然后，我编写了一个python脚本，计算每家银行的所有有效卡号，然后使用应用服务器为每家银行生成加密输出。我把他们的应用服务器变成了我自己的支付卡号加密工具。</p><p id="6cba" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">一次提交我生成的10个信用卡号，然后发出‘about me’graph QL查询来取回加密的值。该工具将遍历每个银行所有可能的组合，构建一个彩虹表。由于这只是一个概念验证，为了不浪费应用服务器上的资源，我在几百个周期后终止了这个脚本。(运营团队不喜欢你搞砸东西，占满日志空间)。</p><p id="49ee" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">有了rainbow table概念证明，我就能够为任何登录用户解密应用程序数据库中存储的任何信用卡号。由于“关于我”查询还存储了信用卡到期日、注册用户姓名和注册地址，所以真正支付时唯一缺少的就是CV2号码。</p><h1 id="491e" class="lg lh iu bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">影响</h1><p id="80d7" class="pw-post-body-paragraph jr js iu jt b ju me jw jx jy mf ka kb kc mg ke kf kg mh ki kj kk mi km kn ko in bi translated">宣布这是一个P1或关键漏洞的最大障碍是，它只对登录用户有效。为了利用它，我需要接管受害者的账户。该站点的身份验证保护不完善，在测试时无法进行MFA。暴力攻击、泄露共享密码攻击或网络钓鱼攻击都有可能获得访问权限，但对于这个bug bounty程序来说，这是一步之遥。相反，我们同意了一个较低但仍然不错的严重程度。</p><h1 id="952e" class="lg lh iu bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">补救建议</h1><p id="9ca9" class="pw-post-body-paragraph jr js iu jt b ju me jw jx jy mf ka kb kc mg ke kf kg mh ki kj kk mi km kn ko in bi translated">我总是在我的bug奖励报告中给出补救建议。这一次，最简单的方法就是停止将加密的卡号作为API查询响应的一部分返回。为每个用户添加一个salt是一件好事，但是一旦加密的数字不再暴露给最终用户，风险就被有效地降低了。</p></div><div class="ab cl mx my hy mz" role="separator"><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc"/></div><div class="in io ip iq ir"><p id="b66d" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated">与我私人电子邮件列表中的其他人一起关注我的最新文章、视频、想法等。</p></div><div class="ab cl mx my hy mz" role="separator"><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc"/></div><div class="in io ip iq ir"><p id="4293" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko in bi translated"><em class="ne">原载于2021年6月22日</em><a class="ae lf" href="https://craighays.com/cracking-encrypted-credit-card-numbers-exposed-by-api/" rel="noopener ugc nofollow" target="_blank"><em class="ne">【https://craighays.com】</em></a><em class="ne">。</em></p></div></div>    
</body>
</html>