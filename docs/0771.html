<html>
<head>
<title>Exploiting Sudo Rights| HTB TraceBack [Writeup]</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">利用Sudo权利| HTB追溯</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/exploiting-sudo-rights-htb-traceback-user-d26c427391a9?source=collection_archive---------2-----------------------#2020-08-17">https://infosecwriteups.com/exploiting-sudo-rights-htb-traceback-user-d26c427391a9?source=collection_archive---------2-----------------------#2020-08-17</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="c0d2" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">从网站管理员到系统管理员的横向权限提升|错误配置问题</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/8daef66724c326dc9cbce08ac7d010cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TPFbvkxiiRPxFb7aAaLvVg.png"/></div></div></figure><p id="b94f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><strong class="kw iu">总结</strong></p><p id="2877" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在这台机器中，网站被黑了，用户名和他的信息显示在网站的主页上。在google上快速搜索它的名字和评论，我找到了这个用户和他在网站上提到的后门webshell。使用这个后门web shell，我得到了“web admin”shell。</p><p id="723e" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">此外，我通过利用其工具获得了“系统管理员”帐户的横向权限提升，该工具允许网站管理员执行系统管理员级别权限的命令。</p><p id="29bd" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><strong class="kw iu">使用的工具&amp;技术:</strong></p><ul class=""><li id="ab45" class="lq lr it kw b kx ky la lb ld ls lh lt ll lu lp lv lw lx ly bi translated">用于端口扫描的Nmap</li><li id="fa12" class="lq lr it kw b kx lz la ma ld mb lh mc ll md lp lv lw lx ly bi translated"><code class="fe me mf mg mh b">/bin/bash -i</code>获得交互式外壳</li><li id="5cc4" class="lq lr it kw b kx lz la ma ld mb lh mc ll md lp lv lw lx ly bi translated">在谷歌上追踪用户名</li><li id="a91d" class="lq lr it kw b kx lz la ma ld mb lh mc ll md lp lv lw lx ly bi translated">PHP反向外壳脚本</li><li id="ee4e" class="lq lr it kw b kx lz la ma ld mb lh mc ll md lp lv lw lx ly bi translated"><code class="fe me mf mg mh b">-e os.execute(‘/bin/bash’)</code>利用可由webadmin执行的特权工具来执行sysadmin shell。</li><li id="51cd" class="lq lr it kw b kx lz la ma ld mb lh mc ll md lp lv lw lx ly bi translated"><code class="fe me mf mg mh b">sudo -l</code> -显示调用用户允许和禁止的命令列表</li><li id="625a" class="lq lr it kw b kx lz la ma ld mb lh mc ll md lp lv lw lx ly bi translated"><code class="fe me mf mg mh b">pspy32</code>过程监控/cronjob检测程序</li><li id="ebef" class="lq lr it kw b kx lz la ma ld mb lh mc ll md lp lv lw lx ly bi translated"><code class="fe me mf mg mh b">sudo -l </code>为调用用户显示允许和禁止命令列表的命令。</li><li id="14b5" class="lq lr it kw b kx lz la ma ld mb lh mc ll md lp lv lw lx ly bi translated"><code class="fe me mf mg mh b">ssh -i &lt;host-priv-key&gt; sysadmin@10.10.10.181 </code>以ssh方式进入sysadmin帐户</li></ul><p id="9685" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><strong class="kw iu"> CVE(有):</strong>无</p></div><div class="ab cl mi mj hx mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="im in io ip iq"><p id="a5fb" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><strong class="kw iu"> Nmap扫描输出TCP/UDP </strong></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mp"><img src="../Images/bf1d0cf5aafcef1f87385fa5d6b48118.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5l_8hUa-lDqGNd2R98thtw.png"/></div></div></figure><h2 id="cafe" class="mq mr it bd ms mt mu dn mv mw mx dp my ld mz na nb lh nc nd ne ll nf ng nh ni bi translated">******端口80 HTTP * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *</h2><p id="fb3d" class="pw-post-body-paragraph ku kv it kw b kx nj ju kz la nk jx lc ld nl lf lg lh nm lj lk ll nn ln lo lp im bi translated">运行了dirb、gobuster、nikto工具后，除了少数几个，没有发现什么有趣的东西。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/cf4d987e8c427dc806a42bfe03ab7b52.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*c4VOcg21UVu2vqANpP3fAw.png"/></div></div></figure><p id="a025" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我运行OSINT检查从站点主页的源代码中找到的名称及其注释。我在谷歌搜索上看到了同样的信息。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi np"><img src="../Images/e1ef6e1dd4c931b324846417bf9efff2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ig2G6KDL_2kKIx2uj8EQCg.png"/></div></div></figure><p id="afd8" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在目标URL中发现了“<em class="nq">smevk.php</em>”web shell:<em class="nq">http://10 . 10 . 10 . 181/smevk . PHP</em></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nr"><img src="../Images/c50f24aca96433afe11239b85550e3d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9g4i9IsaK1k442PYy6hTWA.png"/></div></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/b7183e0c7492eaae77ab0bb076f05136.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5A9irzhzE_zyvo2jQc8SfQ.png"/></div></div></figure><p id="9d40" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">github中的<em class="nq">smevk.php</em>代码提供了登录的凭证:<em class="nq"> admin:admin </em></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/db95b093532040e72ca62b0b6184d609.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RZbIaaiDAnFT0372BKfrDg.png"/></div></div></figure><p id="dc08" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">利用这个web shell，我下载、修改、上传了<a class="ae nu" href="http://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet" rel="noopener ugc nofollow" target="_blank"> php反向shell </a>，并在我的主机上执行。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nv"><img src="../Images/25af5923d7af947fa3635762fa680a9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qA0GYD_rEXg5q4vkUaRcLg.png"/></div></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/cbc2131984423b7fc7c5fc4827914b96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1196/format:webp/1*30_kvzLEdmwwOaw5Ixwjww.png"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mp"><img src="../Images/45d207fb9b5298d03853e07435454387.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uzPmL7qGe6inia_IUcxl-Q.png"/></div></div></figure><p id="1bbb" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在我们有了<strong class="kw iu">‘web admin’</strong>shell，我意识到使用python生成shell在这里不起作用:-(</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nx"><img src="../Images/f0e43bd5279e13f8afa50892f7795929.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fKWkkuTVMrNRAAI23KQNow.png"/></div></div></figure><p id="fae2" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">…但是一个简单的命令在这里奏效了！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ny"><img src="../Images/c72049ffcbbb7f728eb0ffebf10552dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ayWag1EuWyBQLHYTUOcnog.png"/></div></div></figure><p id="4844" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在执行<strong class="kw iu"> sudo -l后，</strong>我们发现‘web admin’可以在这台机器上运行下面的<strong class="kw iu"> sysadmin </strong> <strong class="kw iu">命令</strong> (/home/sysadmin/luvit):</p><p id="403c" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><code class="fe me mf mg mh b">sudo -u sysadmin /home/sysadmin/luvit</code></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nz"><img src="../Images/91aceb378f1cd2070267423e9bdc03c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zpWLORSL48DMGWsZN9P6og.png"/></div></div></figure><p id="efe9" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在手动检查时，我还注意到一条<strong class="kw iu"> note.txt </strong>，内容如下:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oa"><img src="../Images/f551aaf406afb5efb8a904ce36082c36.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uqYiJCLJZoZ87YANKBPV9A.png"/></div></div><figcaption class="ob oc gj gh gi od oe bd b be z dk translated">note.txt</figcaption></figure><p id="52ee" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">貌似sysadmin说的工具是<strong class="kw iu">‘luvit’。</strong></p><p id="7af4" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">系统管理员希望网站管理员使用这个工具，所以他的帐户被配置为允许网站管理员执行这个工具。</p><p id="9fa3" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们还知道他提到了练习Lua——这是一种编程语言。</p><p id="2a94" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">因此，如果我们创建一个lua脚本文件来使用‘luvit’工具执行反向shell，我们应该能够获得sysadmin shell。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi of"><img src="../Images/8f5682971c903f58a927a55a9d595e4f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VIn9MVBPs3YIlLnrdTen3Q.png"/></div></div></figure><p id="b841" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">使用GTFObins站点查找Lua的反向shell执行命令，我创建了以下内容:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi og"><img src="../Images/ede292d48f3d84e6a4c660b03e12f68e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*W8WeI7cn6etYfH4CHTI9kA.png"/></div></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oh"><img src="../Images/cc5fb5380d39d0435421185fc8eb8ff9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FZQ76nXVM7vf6ySNa63iyw.png"/></div></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oi"><img src="../Images/23b024da26dbc989570b76320a5af145.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TzKKppmXhpuWKx4Un3NuLA.png"/></div></div><figcaption class="ob oc gj gh gi od oe bd b be z dk translated"><strong class="bd ms">成功了！！！</strong></figcaption></figure></div><div class="ab cl mi mj hx mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="im in io ip iq"><h2 id="4166" class="mq mr it bd ms mt mu dn mv mw mx dp my ld mz na nb lh nc nd ne ll nf ng nh ni bi translated"><strong class="ak">追溯根</strong></h2><h2 id="a664" class="mq mr it bd ms mt mu dn mv mw mx dp my ld mz na nb lh nc nd ne ll nf ng nh ni bi translated">摘要</h2><p id="1760" class="pw-post-body-paragraph ku kv it kw b kx nj ju kz la nk jx lc ld nl lf lg lh nm lj lk ll nn ln lo lp im bi translated">系统管理员有配置错误的问题。脚本文件<strong class="kw iu">/etc/update-motd . d/00-header</strong>以完全访问权限每30秒执行一次。该文件由root所有，属于sysadmin组。我修改了脚本文件以提取根级别的信息。然后，我只需通过ssh进入sysadmin帐户，就可以显示root.txt文件的内容。</p></div><div class="ab cl mi mj hx mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="im in io ip iq"><p id="450b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">下载<code class="fe me mf mg mh b">pspy32</code>来监控cronjob活动。发现<code class="fe me mf mg mh b">update-motd.d</code>目录下的文件每30秒就频繁更新一次。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oj"><img src="../Images/510d644874882e0e2101c929e05cd3b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wcSRgEiCfTWviAQQtDAmDg.png"/></div></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ok"><img src="../Images/ba3f71e2911816dfceaf078239d4f12d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mQGjeXUXgo9mn5seV-OLUw.png"/></div></div></figure><p id="e628" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">看到<strong class="kw iu"> /etc/update-motd.d </strong>下的文件有完全文件权限。这些文件由root和sysadmin作为一个组拥有</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ol"><img src="../Images/f5b535fed4172009f7b4135492519352.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*63L-FKikMCx3L3-XsmUhIQ.png"/></div></div></figure><p id="d961" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">从这里开始，还要注意当您通过ssh进入sysadmin时，会执行文件<strong class="kw iu"> 00-header </strong>中的命令。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi om"><img src="../Images/395b1e41380bba308fd07789cae08200.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ze9tU2hxPJ8BhcTxoV-Zjg.png"/></div></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi on"><img src="../Images/afea2ca3d5ff9f3ad7b1bd4fd8a990fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EEk8WTuGi90NfvTRvtghwQ.png"/></div></div><figcaption class="ob oc gj gh gi od oe bd b be z dk translated"><strong class="bd ms">要SSH进入系统管理员，请确保您的主机公钥已添加到系统管理员的authorised _ keys中，如下所示。</strong></figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oo"><img src="../Images/a284fa5fcd67392fc807265fcfe6fd53.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SI9jfBwilH2rRZKmHTzjPw.png"/></div></div></figure><p id="de37" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们还知道文件每30秒自动更新一次。因此，需要快速执行该命令，提取root.txt内容，并通过登录到webadmin或sysadmin的ssh来读取它。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi op"><img src="../Images/65294575c7699027ddb62c13fcd57827.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P0rpUUvnz9qkLcpiDIAWLA.png"/></div></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oq"><img src="../Images/13d26b0400ac04503261d17a8c48f662.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T29dNocp6n40K0RBslYizw.png"/></div></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi or"><img src="../Images/af6e553101f6bfd138e80a262308bdd0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QMvB1yVDkEKN2TXsc2A08Q.png"/></div></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi os"><img src="../Images/2b937ad5fe373c7c6d0d027956ee4ee9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1392/1*RMSjbDw6dkylJw-liszMrw.gif"/></div></figure></div></div>    
</body>
</html>