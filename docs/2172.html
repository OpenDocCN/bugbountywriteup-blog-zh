<html>
<head>
<title>Malware Traffic Analysis Exercise | Burnincandle | IcedID Malware</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">恶意软件流量分析练习| Burnincandle | IcedID恶意软件</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/malware-traffic-analysis-exercise-burnincandle-icedid-malware-67e78ef1d46c?source=collection_archive---------0-----------------------#2022-07-09">https://infosecwriteups.com/malware-traffic-analysis-exercise-burnincandle-icedid-malware-67e78ef1d46c?source=collection_archive---------0-----------------------#2022-07-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/b95421b9cd5c8674651c8d86351030f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*naksC-4VNjlitK40.jpg"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated"><a class="ae jd" href="https://www.malware-traffic-analysis.net/2022/03/21/index3.html" rel="noopener ugc nofollow" target="_blank">https://www . malware-traffic-analysis . net/2022/03/21/index 3 . html</a></figcaption></figure><div class=""/><p id="12ec" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">欢迎光临！今天我将回顾另一个来自https://www.malware-traffic-analysis.net/<a class="ae jd" href="https://www.malware-traffic-analysis.net/" rel="noopener ugc nofollow" target="_blank">的恶意软件流量分析练习，这是我最近完成的。这个叫做Burnincandle。这篇文章将包括一个执行摘要，被感染主机的详细信息，妥协的指标(国际奥委会的),以及一个技术摘要，其中我将解释我是如何进行分析的，以及我的结论是基于哪些指标。</a></p><h1 id="896e" class="lb lc jg bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated"><strong class="ak">执行摘要</strong></h1><p id="67be" class="pw-post-body-paragraph kd ke jg kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">在2022年3月21日大约2058 UTC时,“patrick.zimmerman”使用的一台Windows主机感染了IcedID恶意软件。在初次感染后，在受害者身上建立了钴打击指挥和控制(C2)信标。</p><h1 id="3ba4" class="lb lc jg bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">受感染主机的详细信息</h1><ul class=""><li id="41f4" class="me mf jg kf b kg lz kk ma ko mg ks mh kw mi la mj mk ml mm bi translated">IP地址:10.0.19.14</li><li id="110a" class="me mf jg kf b kg mn kk mo ko mp ks mq kw mr la mj mk ml mm bi translated">MAC地址:00:60:52:b7:33:0f</li><li id="19aa" class="me mf jg kf b kg mn kk mo ko mp ks mq kw mr la mj mk ml mm bi translated">主机名:DESKTOP-5QS3D5D</li><li id="79c3" class="me mf jg kf b kg mn kk mo ko mp ks mq kw mr la mj mk ml mm bi translated">用户名:帕特里克·齐默曼</li></ul><h1 id="da8f" class="lb lc jg bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">妥协的指标(国际奥委会的)</h1><p id="29ee" class="pw-post-body-paragraph kd ke jg kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated"><strong class="kf jh">与初始IcedID感染相关的网络流量:</strong></p><ul class=""><li id="2021" class="me mf jg kf b kg kh kk kl ko ms ks mt kw mu la mj mk ml mm bi translated">HTTP GET请求—188.166.154.118:80—oceriesfornot . top</li><li id="7b2a" class="me mf jg kf b kg mn kk mo ko mp ks mq kw mr la mj mk ml mm bi translated">157.245.142.66:443——antnosience.com——HTTPS交通</li><li id="15c7" class="me mf jg kf b kg mn kk mo ko mp ks mq kw mr la mj mk ml mm bi translated">dilimoretast.com 91.193.16.181:443 seaskysafe.com的HTTPS交通</li><li id="6dc0" class="me mf jg kf b kg mn kk mo ko mp ks mq kw mr la mj mk ml mm bi translated">160.153.32.99:443 suncoastpinball.com HTTPS交通</li></ul><p id="4ab8" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf jh">与文件共享相关的网络流量:</strong></p><ul class=""><li id="f850" class="me mf jg kf b kg kh kk kl ko ms ks mt kw mu la mj mk ml mm bi translated">185.47.40.36:443 filebin.net HTTPS交通</li><li id="9dd0" class="me mf jg kf b kg mn kk mo ko mp ks mq kw mr la mj mk ml mm bi translated">87.238.33.8:443 87.238.33.7:443到situla.bitbit.net的HTTPS交通</li></ul><p id="6ba4" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf jh">与“钴打击”指挥和控制系统(C2)相关的网络流量:</strong></p><ul class=""><li id="86b4" class="me mf jg kf b kg kh kk kl ko ms ks mt kw mu la mj mk ml mm bi translated">23.227.198.203:757 bupdater.com HTTPS交通</li></ul><h1 id="b8fc" class="lb lc jg bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated"><strong class="ak">技术分析</strong></h1><p id="c973" class="pw-post-body-paragraph kd ke jg kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">完成这些练习后，我做的第一件事就是查看我的security onion控制台中的suricata IDS/IPS警报，以便了解我正在处理的问题，并决定如何指导我的分析。</p><figure class="mw mx my mz gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mv"><img src="../Images/7d476b1a5415fdac8b768af4f70633fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PLhHSdH7fY9dNTwEUStbRg.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">security onion中的Suricata IDS/IPS警报。</figcaption></figure><p id="b576" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">根据当前的警报，我假设前两个警报“ET恶意软件Win32/IcedID请求Cookie”和“ET INFO HTTP请求a *。顶级域”可能会对同一HTTP请求发出警报。这是基于两人都只报警过一次。由于我们讨论的是“IcedID请求cookie ”,受害者可能只会向IcedID恶意软件来源的恶意域发出一个HTTP GET请求，因此两个警报都是单个实例。但是我们不要在理论上花太多时间。</p><p id="ed19" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">深入研究IcedID请求cookie警报，我看到一个HTTP GET请求在cookie参数中有一些奇怪的数据。</p><figure class="mw mx my mz gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi na"><img src="../Images/73d92b6ef208901e576a16250f19ba62.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T76iOPZnRItQlc8s_h8cqw.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">IcedID请求cookie警报。注意HTTP请求的cookie参数中的奇数数据。</figcaption></figure><p id="44ca" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我做了一些研究以了解更多这方面的信息，并看到了一篇文章(<a class="ae jd" href="https://sysopfb.github.io/malware,/icedid/2020/04/28/IcedIDs-updated-photoloader.html" rel="noopener ugc nofollow" target="_blank">https://sys opfb . github . io/malware，/ice did/2020/04/28/ice dids-updated-photo loader . html</a>)，该文章描述了cookie参数中每个值的含义。简而言之，该cookie用于存储受害主机的编码数据，包括主机名、用户名、windows版本等。因此，我现在有明确的证据表明威胁参与者能够列举一些关于受害主机的信息，但我还发现了第一个IOC，因为oceriesfornot.top域和IP被确定为恶意的。</p><figure class="mw mx my mz gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mv"><img src="../Images/094889647d5d943d5328790a8804c067.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Xnf4t7c47c4DfUV_hii3aw.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">oceriesfornot.top域的Virustotal结果。</figcaption></figure><p id="2378" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我还证实了我对“IcedID请求cookie”警报和“HTTP请求到*”的怀疑。顶级域”警报都是由相同的通信量触发的，GET请求被发送到oceriesfornot.top。</p><p id="8bc0" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">“IcedID request cookie”警报发出后，立即观察到受害者IP与IP地址为157.245.142.66的antnosience.com域建立了HTTPS连接，这在virustotal中也被确定为恶意连接。这给了我第二个国际奥委会。</p><figure class="mw mx my mz gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mv"><img src="../Images/efc1409936e3e9c9d55f141a5337d50c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HJDgRYLiGRT7Yz5yQKME8A.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">157.245.142.66 IP地址的病毒总数结果。</figcaption></figure><p id="43cc" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此时，我决定需要关闭并打开networkminer，看看是否可以从pcap中提取任何有趣的文件信息。</p><figure class="mw mx my mz gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mv"><img src="../Images/4ab99ff18ef5c36930a057179e826c4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lV6eU7lvjDDIu7BXfL15Eg.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Networkminer能够向分析师显示pcap文件中哪些文件通过了网络。在本例中是index.gzip</figcaption></figure><p id="cabb" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Networkminer将我的注意力转向了一个名为“index.gzip”的文件。gzip后缀表示该文件是使用gzip工具压缩的。压缩恶意文档是攻击者试图避免被AV、IDS、IPS等检测的常用策略。所以我觉得这很有趣。现在我有了这些信息，我进入wireshark并找到了通过网络发送index.gzip文件的TCP流。在TCP stream 0中，我发现原始的未压缩文件的名字是Copper.txt。至少我是这么想的…</p><figure class="mw mx my mz gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nb"><img src="../Images/ed5ec1ee4103c9cdcb85b778df50d9ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zTIvjg4ycGVPm00sXGaXrg.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">请注意，服务器响应中的内容类型参数表明它是一个gzip压缩文件。还要注意TCP数据中的“Copper.txt”字符串。</figcaption></figure><p id="b79f" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">既然我已经找到了这个gzip文件，我做了一些与IcedID和gzip文件相关的研究。很快，我意识到这种感染远比我当时意识到的要多。本质上，“Copper.txt”字符串只是一个门面。事实上，这里根本没有真正的文件，所有这些数据基本上都是加密的IcedID配置。解密后，恶意软件会将名为license.dat的文件放入恶意软件配置指定的文件夹中，该文件夹位于当前用户的Appdata\Roaming目录中。它还将IcedID主加载程序放到Appdata\Local\目录中。然后，这个主加载程序用于将IcedID有效负载(在license.dat中)加载到内存中并运行它。你可以在binarydefense.com(<a class="ae jd" href="https://www.binarydefense.com/icedid-gziploader-analysis/" rel="noopener ugc nofollow" target="_blank">https://www.binarydefense.com/icedid-gziploader-analysis/</a>)的这篇文章中读到更多关于这一切是如何运作的信息。</p><p id="314e" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">既然我已经基本上确定了感染源，我需要把我的注意力转回到产生IOC的问题上。回顾wireshark，我注意到受害者IP和外部IP之间发生了大量TLS握手，受害者IP的源端口号被快速轮换。在如此短的时间内建立如此多的新关系绝对是不寻常的。我还记得看到一个IDS/IPS警报“OpenSSL Demo CA—Internet wid gits Pty”，表明OpenSSL生成的SSL/TLS证书出现了某种奇怪的情况。触发此警报是因为这些Internet Widgits TLS证书是自签名的，不应被信任。</p><figure class="mw mx my mz gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mv"><img src="../Images/0be78e9b3031ccda8806a217baa523bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Uc1hygByTS4xPb3vCFaEbQ.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">注意TCP数据中的“Internet Widgits字符串”,该数据来自“antnosience.com”域发送给受害者IP的TLS证书。</figcaption></figure><p id="ecc7" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这里，我在networkminer中过滤这些Internet Widgits TLS证书，以找到与此IcedID恶意软件感染相关的其余恶意IP和域。</p><figure class="mw mx my mz gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mv"><img src="../Images/cc9cf930c34cc3337125de6c32ecd809.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xXo1Wk6zGOYA-x4N14iuaA.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">筛选“Internet widget”TLS证书。</figcaption></figure><p id="28fd" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">受害者IP也被观察到在160.153.32.99:443与suncoastpinball.com域名建立了多个奇怪的新TLS连接，给了我另一个IOC。该域的SSL证书不是自签名的，但它是godaddy证书。</p><p id="b484" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">继续搜索networkminer和wireshark，我没有看到任何与自签名Internet Widgits TLS证书相关的额外活动。我决定在wireshark中过滤DNS流量，因为DNS流量可以揭示威胁参与者正在使用哪些域和IP地址来进行恶意活动。应用这个过滤器后，我注意到受害者IP在相对较短的时间内对感兴趣的探测域发出了三个DNS请求。</p><figure class="mw mx my mz gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mv"><img src="../Images/0858fc3174b9a345a7e84c983004a3f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BLZu9UwGS68xUwNN_gwl5w.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">受害者IP为filebin.net和situla.bitbit.net两个文件共享网站发出DNS请求。</figcaption></figure><p id="91f6" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">filebin.net和situla.bitbit.net域都是文件共享站点，之后到这两个域的连接都很短暂，每个都不到10秒。这可能是数据泄露，也可能是恶意软件试图获取额外的资源来攻击受害者，但目前还不清楚。如果我有受害者的TLS私钥，我可以在wireshark中解密该流量，并了解更多关于网络上实际发送的内容，但是在本练习中，我没有受害者的私钥。</p><p id="09bd" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在上图中，还有第三个被查询的域名，bupdater.com。在wireshark中过滤该域的IP地址揭示了一个非常有趣的模式。</p><figure class="mw mx my mz gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nc"><img src="../Images/2cd96647383180c867005ab20343ffb3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GQQMoj177cqcrlNQ5zkL8g.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">请注意，短暂的TLS连接发生在连续的临时端口上。</figcaption></figure><p id="cb01" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在受害者IP和bupdater.com IP之间存在许多通常是短暂的TLS连接。上图中另一个有趣的地方是每个连接末尾的TCP确认号。在许多(但不是所有)连接的末尾，确认号是3718，或者是一个非常接近的值。这很有趣，因为它表明在这些连接中，只有固定数量的TCP数据通过网络发送。换句话说，这看起来像C2心跳活动，其中受害者正在建立到C2服务器的连接，并发送具有指定数据长度的定期pings，在我们的示例中为3717字节。受害者然后检查攻击者提供的任何指令。如果有指示，受害者会取回并执行。</p><p id="4b72" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这种情况下，bupdater.com域和IP地址也被确定为恶意的，甚至被社区明确确定为钴罢工C2服务器。然后我得出结论，威胁者使用了冰dID感染提供的初始访问权限，在受害者身上建立了钴击C2。在这一点上，在真正的调查中，可能最有用的是进行一些端点取证，以生成额外的基于主机的IOC，如文件哈希。</p><h1 id="e5e3" class="lb lc jg bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated"><strong class="ak">结论</strong></h1><p id="8cf8" class="pw-post-body-paragraph kd ke jg kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">这是了解更多关于IcedID恶意软件的一个很好的练习。在这个练习之前，我对IcedID有一点熟悉，但是现在我对这个恶意软件是如何运行的以及它会产生什么样的工件有了更清楚的认识。我还学会了在pcap文件中寻找一种新的模式来识别C2流量。我将继续尝试观察TCP确认号中的模式，看看我是否可以更频繁地使用它来识别C2流量。</p><p id="061e" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">谢谢你访问我的博客！如果你喜欢这篇文章，请给我一个关注并分享这篇文章！</p></div><div class="ab cl nd ne hu nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="ij ik il im in"><p id="fa9c" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">来自Infosec的报道:Infosec上每天都会出现很多难以跟上的内容。 <a class="ae jd" href="https://weekly.infosecwriteups.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="kf jh"> <em class="nk">加入我们的每周简讯</em> </strong> </a> <em class="nk">以5篇文章、4个线程、3个视频、2个Github Repos和工具以及1个工作提醒的形式免费获取所有最新的Infosec趋势！</em></p></div></div>    
</body>
</html>