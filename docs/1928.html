<html>
<head>
<title>ReDoS — Denial of Service by RegEx 😈</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">ReDoS—RegEx拒绝服务😈</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/redos-denial-of-service-by-regex-59c7ffab4880?source=collection_archive---------3-----------------------#2022-03-07">https://infosecwriteups.com/redos-denial-of-service-by-regex-59c7ffab4880?source=collection_archive---------3-----------------------#2022-03-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/1a6fe9d640de36d6859dd9a8f00a4c65.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hJd2AbuVfucAp-gd6k5NSA.png"/></div></div></figure><p id="ce8f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi kz translated">正则表达式(RegEx)是一种定义简单模式的正式语言。它通常用于在大量文本中查找感兴趣的部分或验证数据。它通常很快，有时是一个干净的解决方案。但是，在某些情况下，攻击者可以为易受攻击的正则表达式手工输入，这会导致检查正则表达式输入的时间比预期的要长。</p><h1 id="5e0b" class="li lj it bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">为什么你应该关心</h1><p id="2003" class="pw-post-body-paragraph kb kc it kd b ke mg kg kh ki mh kk kl km mi ko kp kq mj ks kt ku mk kw kx ky im bi translated">我只发现了一个成功的ReDoS“攻击”的例子。2016年，ReDoS ( <a class="ae ml" href="https://stackstatus.net/post/147710624694/outage-postmortem-july-20-2016" rel="noopener ugc nofollow" target="_blank">来源</a>)导致StackOverflow停电34分钟。</p><p id="aded" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">维基百科和<a class="ae ml" href="https://owasp.org/www-community/attacks/Regular_expression_Denial_of_Service_-_ReDoS" rel="noopener ugc nofollow" target="_blank"> OWASP </a>没有提到一次成功的攻击。我猜原因是服务器端不经常使用正则表达式🤷‍♂️:python有很多解析工具<a class="ae ml" href="https://nedbatchelder.com/text/python-parsers.html" rel="noopener ugc nofollow" target="_blank">，但我只依稀记得使用过一次</a><a class="ae ml" href="https://github.com/pyparsing/pyparsing" rel="noopener ugc nofollow" target="_blank"> pyparsing </a>。</p><p id="71b1" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在许多情况下，当您可能想要使用正则表达式时，完全正确地使用它是多余的。比如<a class="ae ml" href="https://stackoverflow.com/questions/201323/how-can-i-validate-an-email-address-using-a-regular-expression" rel="noopener ugc nofollow" target="_blank">邮件正则表达式</a>。不要跳进那个兔子洞，你可以只做一些超级基本的检查，例如，长度是否至少是3，以及是否正好有一个<code class="fe mm mn mo mp b">@</code>符号在那里。然后，您只需发送一封确认电子邮件，确认用户确实可以访问该电子邮件地址。</p><p id="3677" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">对于URL，您通常只需ping它们。对于HTML，您希望使用HTML解析器。对于许多其他情况，使用<code class="fe mm mn mo mp b">split</code>大有帮助。</p><p id="5092" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我想说的是:你可能不需要担心，因为你可能不会在大部分代码中使用正则表达式。尽管如此，这还是很有趣😁</p></div><div class="ab cl mq mr hx ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="im in io ip iq"><h1 id="07df" class="li lj it bd lk ll mx ln lo lp my lr ls lt mz lv lw lx na lz ma mb nb md me mf bi translated">PCRE简介</h1><p id="5b00" class="pw-post-body-paragraph kb kc it kd b ke mg kg kh ki mh kk kl km mi ko kp kq mj ks kt ku mk kw kx ky im bi translated">Perl兼容正则表达式(PCRE)是最常见的正则表达式样式。它们是指定字符串类型的一种方式。它们比通配符模式匹配更加具体。</p><p id="6173" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">例如，以下模式首先匹配单个大写字母，然后匹配任意多个小写字母:</p><pre class="nc nd ne nf gt ng mp nh ni aw nj bi"><span id="7ca1" class="nk lj it mp b gy nl nm l nn no">[A-Z][a-z]*</span></pre><p id="4272" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">方括号<code class="fe mm mn mo mp b">[...]</code>中的字符定义了字符类别。在这种情况下，从<code class="fe mm mn mo mp b">A</code>到<code class="fe mm mn mo mp b">Z</code>的所有角色。<code class="fe mm mn mo mp b">*</code>是一个量词，意思是“至少零个，但最多任意多个”。</p><h1 id="03ae" class="li lj it bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">正则表达式引擎</h1><p id="cc9e" class="pw-post-body-paragraph kb kc it kd b ke mg kg kh ki mh kk kl km mi ko kp kq mj ks kt ku mk kw kx ky im bi translated">在上一节中，您已经看到了正则表达式是如何编写的。接下来，您需要掌握如何检查正则表达式是否匹配给定的文本。这是由正则表达式引擎完成的。</p><p id="1558" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">Python的RegEx引擎使用<strong class="kd iu">递归回溯</strong>，可以有指数级的渐近执行时间(参见<a class="ae ml" href="https://eprints.whiterose.ac.uk/109809/1/jsre_journal_accepted_author_manuscript.pdf" rel="noopener ugc nofollow" target="_blank">用预览优化Unicode正则表达式求值</a>)。有像<a class="ae ml" href="https://github.com/facebook/pyre2" rel="noopener ugc nofollow" target="_blank"> pyre2 </a>这样使用<a class="ae ml" href="https://swtch.com/~rsc/regexp/regexp1.html" rel="noopener ugc nofollow" target="_blank">汤普森NFA算法</a>的引擎。我认为使用回溯算法的唯一原因是反向引用，例如，当你想检查一个单词是否重复时。你可以在正则表达式中通过<code class="fe mm mn mo mp b">\1</code>或类似的词来识别它们。</p><p id="f025" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">递归回溯的思想是逐步匹配字符串。它保留了一个可能匹配的可能性列表，并逐步排除它们。</p><h1 id="53f2" class="li lj it bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">ReDoS攻击是如何工作的？</h1><p id="572e" class="pw-post-body-paragraph kb kc it kd b ke mg kg kh ki mh kk kl km mi ko kp kq mj ks kt ku mk kw kx ky im bi translated">考虑这里表示的正则表达式<code class="fe mm mn mo mp b">(a|a)+b</code>:</p><figure class="nc nd ne nf gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi np"><img src="../Images/66c79f41754dc6f2f1fc3f1a22bc0bf2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5udiwCeCPAb8YDTsTZ4boA.png"/></div></div><figcaption class="nq nr gj gh gi ns nt bd b be z dk translated">正则表达式“(a|a)+b”的非确定性有限自动机(NFA)表示。通过<a class="ae ml" href="https://regexper.com/" rel="noopener ugc nofollow" target="_blank">regexper.com</a>创建</figcaption></figure><p id="22c2" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">尽管第一组的两边都是相同的——只有“a”——但回溯回溯算法仍然会跟踪两个可能的匹配。这意味着输入中每出现一个“a ”,匹配的可能路径就会增加一倍。这意味着如果有26次<code class="fe mm mn mo mp b">a</code>，将有2个⁶ = 67，108，864条路径需要评估:</p><pre class="nc nd ne nf gt ng mp nh ni aw nj bi"><span id="77d5" class="nk lj it mp b gy nl nm l nn no"><strong class="mp iu">import re</strong></span><span id="7f28" class="nk lj it mp b gy nu nm l nn no">pattern = re.compile("<strong class="mp iu">(a|a)+b</strong>")<br/>evil_input = "aaaaaaaaaaaaaaaaaaaaaaaaaa"<br/>if pattern.<strong class="mp iu">match</strong>(evil_input):<br/>    print("💣🧨💥")</span></pre><p id="fa6c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在我的机器上执行这个需要7秒钟——考虑到可能的选项的数量，速度非常快，但是如果你记得你一眼就能看出这个字符串不匹配的话，速度就非常慢了。</p><p id="ccc3" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果您有一个易受攻击的正则表达式(也称为“evil regex”)和一个导致指数匹配时间的输入，机器将占用相当多的CPU资源来计算输入上的表达式。在最坏的情况下，该机器的其他用户将无法使用您的服务。正则表达式拒绝服务攻击(ReDOS)成功。</p><h1 id="b20c" class="li lj it bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">如何防止ReDos攻击？</h1><p id="3ac1" class="pw-post-body-paragraph kb kc it kd b ke mg kg kh ki mh kk kl km mi ko kp kq mj ks kt ku mk kw kx ky im bi translated">如果你不使用正则表达式，也不给你的用户提供使用它们的选项，你就完了。</p><p id="8f26" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果你使用一个不使用回溯的正则表达式引擎，你也应该被保存。</p><p id="4673" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">或者，如果你的正则表达式不“邪恶”，你也没有这个问题。然而，识别邪恶的正则表达式是困难的:</p><div class="nv nw gp gr nx ny"><a href="https://stackoverflow.com/q/12841970/562769" rel="noopener  ugc nofollow" target="_blank"><div class="nz ab fo"><div class="oa ab ob cl cj oc"><h2 class="bd iu gy z fp od fr fs oe fu fw is bi translated">我如何识别一个邪恶的正则表达式？</h2><div class="of l"><h3 class="bd b gy z fp od fr fs oe fu fw dk translated">因为计算机完全按照你的要求去做，即使这不是你的本意或者完全不合理。如果…</h3></div><div class="og l"><p class="bd b dl z fp od fr fs oe fu fw dk translated">stackoverflow.com</p></div></div><div class="oh l"><div class="oi l oj ok ol oh om jz ny"/></div></div></a></div><div class="nv nw gp gr nx ny"><a href="https://stackoverflow.com/questions/58345142/is-this-regex-vulnerable-to-redos-attacks/58347192#58347192" rel="noopener  ugc nofollow" target="_blank"><div class="nz ab fo"><div class="oa ab ob cl cj oc"><h2 class="bd iu gy z fp od fr fs oe fu fw is bi translated">这个正则表达式容易受到REDOS攻击吗</h2><div class="of l"><h3 class="bd b gy z fp od fr fs oe fu fw dk translated">在regex101.com上的测试表明，没有输入的组合会产生失控检查——但是你的正则表达式是…</h3></div><div class="og l"><p class="bd b dl z fp od fr fs oe fu fw dk translated">stackoverflow.com</p></div></div><div class="oh l"><div class="on l oj ok ol oh om jz ny"/></div></div></a></div><h1 id="b727" class="li lj it bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">下一步是什么？</h1><p id="aa2e" class="pw-post-body-paragraph kb kc it kd b ke mg kg kh ki mh kk kl km mi ko kp kq mj ks kt ku mk kw kx ky im bi translated">在这个关于应用安全(AppSec)的系列文章中，我们已经解释了攻击者的一些技术😈以及防守队员的技术😇：</p><ul class=""><li id="9c9d" class="oo op it kd b ke kf ki kj km oq kq or ku os ky ot ou ov ow bi translated">第1部分:<a class="ae ml" href="https://medium.com/faun/sql-injections-e8bc9a14c95" rel="noopener"> SQL注入</a>😈🐝</li><li id="0b18" class="oo op it kd b ke ox ki oy km oz kq pa ku pb ky ot ou ov ow bi translated">第二部:<a class="ae ml" href="https://levelup.gitconnected.com/leaking-secrets-240a3484cb80" rel="noopener ugc nofollow" target="_blank">不要泄露秘密</a>😇</li><li id="4361" class="oo op it kd b ke ox ki oy km oz kq pa ku pb ky ot ou ov ow bi translated">第3部分:<a class="ae ml" href="https://levelup.gitconnected.com/cross-site-scripting-xss-fd374ce71b2f" rel="noopener ugc nofollow" target="_blank">跨站脚本(XSS) </a>😈🐝</li><li id="3691" class="oo op it kd b ke ox ki oy km oz kq pa ku pb ky ot ou ov ow bi translated">第4部分:<a class="ae ml" href="https://levelup.gitconnected.com/password-hashing-eb3b97684636" rel="noopener ugc nofollow" target="_blank">密码哈希</a>😇</li><li id="3613" class="oo op it kd b ke ox ki oy km oz kq pa ku pb ky ot ou ov ow bi translated">第五部分:<a class="ae ml" href="https://medium.com/bugbountywriteup/zip-bombs-30337a1b0112" rel="noopener"> ZIP炸弹</a>😈</li><li id="f7db" class="oo op it kd b ke ox ki oy km oz kq pa ku pb ky ot ou ov ow bi translated">第六部分:<a class="ae ml" href="https://medium.com/plain-and-simple/captcha-500991bd90a3" rel="noopener">验证码</a>😇</li><li id="c29d" class="oo op it kd b ke ox ki oy km oz kq pa ku pb ky ot ou ov ow bi translated">第7部分:<a class="ae ml" href="https://medium.com/bugbountywriteup/email-spoofing-9da8d33406bf" rel="noopener">电子邮件欺骗</a>😈</li><li id="4283" class="oo op it kd b ke ox ki oy km oz kq pa ku pb ky ot ou ov ow bi translated">第8部分:<a class="ae ml" href="https://medium.com/python-in-plain-english/software-composition-analysis-sca-7e573214a98e" rel="noopener">软件组成分析</a> (SCA)😇</li><li id="b2ab" class="oo op it kd b ke ox ki oy km oz kq pa ku pb ky ot ou ov ow bi translated">第九部分:<a class="ae ml" href="https://medium.com/faun/xxe-attacks-750e91448e8f" rel="noopener"> XXE袭击事件</a>😈🐝</li><li id="5787" class="oo op it kd b ke ox ki oy km oz kq pa ku pb ky ot ou ov ow bi translated">第十部分:<a class="ae ml" href="https://levelup.gitconnected.com/effective-access-control-331f883cb0ff" rel="noopener ugc nofollow" target="_blank">有效的访问控制</a>😇</li><li id="237e" class="oo op it kd b ke ox ki oy km oz kq pa ku pb ky ot ou ov ow bi translated">第十一部分:<a class="ae ml" href="https://medium.com/bugbountywriteup/dos-via-a-billion-laughs-9a79be96e139" rel="noopener"> DOS via十亿次大笑</a>😈</li><li id="6d5d" class="oo op it kd b ke ox ki oy km oz kq pa ku pb ky ot ou ov ow bi translated">第十二部分:<a class="ae ml" href="https://medium.com/faun/full-disk-encryption-2090489f9760" rel="noopener">全磁盘加密</a>😇</li><li id="e100" class="oo op it kd b ke ox ki oy km oz kq pa ku pb ky ot ou ov ow bi translated">第13部分:<a class="ae ml" href="https://medium.com/bugbountywriteup/insecure-deserialization-5c64e9943f0e" rel="noopener">不安全的反序列化</a>😈</li><li id="01fe" class="oo op it kd b ke ox ki oy km oz kq pa ku pb ky ot ou ov ow bi translated">第14部分:<a class="ae ml" href="https://levelup.gitconnected.com/docker-security-5f4df118948c" rel="noopener ugc nofollow" target="_blank">码头工人安全</a>😇</li><li id="cd19" class="oo op it kd b ke ox ki oy km oz kq pa ku pb ky ot ou ov ow bi translated">第15部分:<a class="ae ml" href="https://levelup.gitconnected.com/credential-stuffing-ff58ee8c3320" rel="noopener ugc nofollow" target="_blank">证件填充</a>😈🐝</li><li id="aa43" class="oo op it kd b ke ox ki oy km oz kq pa ku pb ky ot ou ov ow bi translated">第16部分:<a class="ae ml" href="https://medium.com/plain-and-simple/multi-factor-authentication-cefff819be95" rel="noopener">多因素认证</a> (MFA/2FA)😇</li><li id="2c28" class="oo op it kd b ke ox ki oy km oz kq pa ku pb ky ot ou ov ow bi translated">第17部分:重做😈</li></ul><p id="0ffd" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">以下文章即将到来:</p><ul class=""><li id="ae97" class="oo op it kd b ke kf ki kj km oq kq or ku os ky ot ou ov ow bi translated">第18部分:安全消息传递😇</li><li id="e123" class="oo op it kd b ke ox ki oy km oz kq pa ku pb ky ot ou ov ow bi translated">第19部分:密码劫持😈</li><li id="be4e" class="oo op it kd b ke ox ki oy km oz kq pa ku pb ky ot ou ov ow bi translated">第20部分:备份😇</li><li id="64a8" class="oo op it kd b ke ox ki oy km oz kq pa ku pb ky ot ou ov ow bi translated">第21部分:加密木马😈</li><li id="0a62" class="oo op it kd b ke ox ki oy km oz kq pa ku pb ky ot ou ov ow bi translated">第22部分:单点登录😇</li><li id="0553" class="oo op it kd b ke ox ki oy km oz kq pa ku pb ky ot ou ov ow bi translated">第23部分:剪贴板劫持😈</li><li id="7801" class="oo op it kd b ke ox ki oy km oz kq pa ku pb ky ot ou ov ow bi translated">第24部分:证书😇</li><li id="c757" class="oo op it kd b ke ox ki oy km oz kq pa ku pb ky ot ou ov ow bi translated">第25部分:区块链的种族条件攻击😈</li><li id="1fde" class="oo op it kd b ke ox ki oy km oz kq pa ku pb ky ot ou ov ow bi translated">第26部分:移动设备管理(MDM)😇</li><li id="15bc" class="oo op it kd b ke ox ki oy km oz kq pa ku pb ky ot ou ov ow bi translated">第27部分:服务器端请求伪造(SSRF)😈</li><li id="e770" class="oo op it kd b ke ox ki oy km oz kq pa ku pb ky ot ou ov ow bi translated">第28部分:网络隔离😇</li><li id="9a92" class="oo op it kd b ke ox ki oy km oz kq pa ku pb ky ot ou ov ow bi translated">第29部分:社会工程(包括钓鱼)😈</li><li id="2297" class="oo op it kd b ke ox ki oy km oz kq pa ku pb ky ot ou ov ow bi translated">第30部分:虚拟专用网络😇</li><li id="33fa" class="oo op it kd b ke ox ki oy km oz kq pa ku pb ky ot ou ov ow bi translated">第31部分:CSRF😈</li></ul><p id="b19d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果您对更多关于AppSec / InfoSec的文章感兴趣，请告诉我！</p></div><div class="ab cl mq mr hx ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="im in io ip iq"><p id="3308" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我喜欢写关于软件开发和技术的文章🤩不要错过更新:<a class="ae ml" href="https://martinthoma.medium.com/subscribe" rel="noopener"> <strong class="kd iu">获取我的免费电子邮件简讯</strong> </a>📧或者<a class="ae ml" href="https://martinthoma.medium.com/membership" rel="noopener">如果你还没有报名参加medium</a>✍️——两者都鼓励我多写点东西🤗</p></div><div class="ab cl mq mr hx ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="im in io ip iq"><p id="90ab" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">Infosec Writeups团队刚刚完成了我们的第一次虚拟网络安全会议和网络活动。我们有16位出色的演讲者，他们主持了非常有价值和鼓舞人心的会议。要查看发言人和主题列表，并获得所有16场演讲的录音版本，请点击此处。</p><div class="nv nw gp gr nx ny"><a href="https://iwcon.live/" rel="noopener  ugc nofollow" target="_blank"><div class="nz ab fo"><div class="oa ab ob cl cj oc"><h2 class="bd iu gy z fp od fr fs oe fu fw is bi translated">IWCon2022 — Infosec书面报告虚拟会议</h2><div class="of l"><h3 class="bd b gy z fp od fr fs oe fu fw dk translated">与世界上最优秀的信息安全专家建立联系。了解网络安全专家如何取得成功。将新技能添加到您的…</h3></div><div class="og l"><p class="bd b dl z fp od fr fs oe fu fw dk translated">iwcon.live</p></div></div><div class="oh l"><div class="pc l oj ok ol oh om jz ny"/></div></div></a></div></div></div>    
</body>
</html>