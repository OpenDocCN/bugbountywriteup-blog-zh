<html>
<head>
<title>Implementing Django-rest API Throttling and Unauthenticated bypass</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">实现Django-rest API节流和未经认证的旁路</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/implementing-django-rest-api-throttling-and-unauthenticated-bypass-dda550b07443?source=collection_archive---------1-----------------------#2022-01-05">https://infosecwriteups.com/implementing-django-rest-api-throttling-and-unauthenticated-bypass-dda550b07443?source=collection_archive---------1-----------------------#2022-01-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="5408" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">以上帝的名义。</p><p id="4b4a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">嗨，研究者们，</p><p id="3477" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这篇文章中，我们将通过节流实现一个Django-Rest项目，并尝试绕过这个特性。如果你以前没有和Django一起工作过，或者对它没有任何概念，不要担心，我们将一步一步地解释它，这样我们对正在发生的事情有一个清楚的了解。</p><h1 id="5b2c" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">什么是节流？</h1><p id="b895" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">根据官方博客，节流类似于权限，因为它决定一个请求是否应该被授权。节流表示一种临时状态，用于控制客户端向API发出请求的速率。</p><h1 id="eb11" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">为什么我们使用速率限制？</h1><p id="8b6d" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">API的速率限制也有助于防范恶意bot攻击。攻击者可以使用机器人对API进行多次重复调用，以至于其他任何人都无法使用该服务，或者使该服务完全崩溃。这是一种DoS或DDoS攻击。攻击者也有可能滥用该服务的缺失，对登录表单、密码重置页面、OTP以及所有其他需要大量请求的攻击进行暴力攻击。</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi lo"><img src="../Images/2f0a8c2868677150e719ff51ceb42995.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KoXrUuua-pOZCCHWkhIdFg.jpeg"/></div></div></figure><h1 id="7262" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">项目设置</h1><p id="2971" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">我们将创建一个简单的API，允许用户查看和编辑系统中的用户和组。</p><p id="49c3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，我们需要安装Django和Django Rest框架:</p><pre class="lp lq lr ls gt ma mb mc md aw me bi"><span id="c708" class="mf km iq mb b gy mg mh l mi mj">pip install django<br/>pip install djangorestframework</span></pre><p id="9ed2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用单个应用程序创建新项目:</p><pre class="lp lq lr ls gt ma mb mc md aw me bi"><span id="a5c6" class="mf km iq mb b gy mg mh l mi mj">django-admin startproject tutorial<br/>cd tutorial<br/>python3 manage.py startapp quickstart</span></pre><p id="cfca" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当我们使用startapp时，我们在项目中创建了一个新的应用程序，通过这个功能，我们可以在一个项目中有多个应用程序，例如，我们可以有一个电子商务应用程序和另一个支持应用程序。</p><p id="b508" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在让我们同步数据库:</p><pre class="lp lq lr ls gt ma mb mc md aw me bi"><span id="023f" class="mf km iq mb b gy mg mh l mi mj">python3 manage.py migrate<br/>python3 manage.py makemigrations </span></pre><p id="2a03" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了在有用户和没有用户的情况下测试我们的应用程序，我们需要创建一个:</p><pre class="lp lq lr ls gt ma mb mc md aw me bi"><span id="ca3f" class="mf km iq mb b gy mg mh l mi mj">python3 manage.py createsuperuser</span></pre><h1 id="fd76" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">序列化程序</h1><p id="e899" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">序列化器允许将复杂数据(如查询集和模型实例)转换为原生Python数据类型，然后可以轻松地呈现到JSON中。</p><p id="bffa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为此，我们需要在快速启动应用程序项目<code class="fe mk ml mm mb b">tutorial/quickstart/serializers.py</code>中创建一个名为“serializers.py”的新文件，并在其中添加以下代码:</p><pre class="lp lq lr ls gt ma mb mc md aw me bi"><span id="1ad2" class="mf km iq mb b gy mg mh l mi mj">from django.contrib.auth.models import User, Group<br/>from rest_framework import serializers<br/><br/>class UserSerializer(serializers.HyperlinkedModelSerializer):<br/>    class Meta:<br/>        model = User<br/>        fields = ['url', 'username', 'email', 'groups']<br/><br/>class GroupSerializer(serializers.HyperlinkedModelSerializer):<br/>    class Meta:<br/>        model = Group<br/>        fields = ['url', 'name']</span></pre><h1 id="65da" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">视图</h1><p id="cf68" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">视图是我们将向最终用户展示的某种东西，打开<code class="fe mk ml mm mb b">tutorial/quickstart/views.py</code>并向其添加以下内容:</p><pre class="lp lq lr ls gt ma mb mc md aw me bi"><span id="b371" class="mf km iq mb b gy mg mh l mi mj">from django.contrib.auth.models import User, Group<br/>from rest_framework import viewsets<br/>from rest_framework import permissions<br/>from quickstart.serializers import UserSerializer, GroupSerializer<br/>from rest_framework.response import Response<br/>from rest_framework.throttling import UserRateThrottle<br/>from rest_framework.views import APIView</span><span id="03dd" class="mf km iq mb b gy mn mh l mi mj">class UserViewSet(viewsets.ModelViewSet):<br/>    queryset = User.objects.all().order_by('-date_joined')<br/>    serializer_class = UserSerializer<br/>    permission_classes = [permissions.IsAuthenticated]</span><span id="baa4" class="mf km iq mb b gy mn mh l mi mj">class GroupViewSet(viewsets.ModelViewSet):<br/>    queryset = Group.objects.all()<br/>    serializer_class = GroupSerializer<br/>    permission_classes = [permissions.IsAuthenticated]</span></pre><h1 id="5da3" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">资源定位符</h1><p id="012e" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">py是一个文件，我们在我们的项目中定义我们的路由，将下面的代码添加到<code class="fe mk ml mm mb b">tutorial/urls.py</code>。</p><pre class="lp lq lr ls gt ma mb mc md aw me bi"><span id="3977" class="mf km iq mb b gy mg mh l mi mj">from django.urls import include, path<br/>from rest_framework import routers<br/>from quickstart import views</span><span id="6302" class="mf km iq mb b gy mn mh l mi mj">router = routers.DefaultRouter()<br/>router.register(r'users', views.UserViewSet)<br/>router.register(r'groups', views.GroupViewSet)</span><span id="e884" class="mf km iq mb b gy mn mh l mi mj">urlpatterns = [<br/>    path('', include(router.urls)),<br/>    path('api-auth/', include('rest_framework.urls', namespace='rest_framework'))<br/>]</span></pre><p id="ee10" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好了，现在我们将分页添加到我们的设置中，以定义每页将显示多少个对象。打开您的<code class="fe mk ml mm mb b">tutorial/settings.py</code>,将这些行添加到其中:</p><pre class="lp lq lr ls gt ma mb mc md aw me bi"><span id="d4b9" class="mf km iq mb b gy mg mh l mi mj">REST_FRAMEWORK = {<br/>    'DEFAULT_PAGINATION_CLASS': 'rest_framework.pagination.PageNumberPagination',<br/>    'PAGE_SIZE': 10<br/>}</span></pre><p id="5f23" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后一个是将“rest_framework”添加到您在上面打开的设置文件中的INSTALLED_APPS:</p><pre class="lp lq lr ls gt ma mb mc md aw me bi"><span id="746a" class="mf km iq mb b gy mg mh l mi mj">INSTALLED_APPS = [<br/>    ...<br/>    'rest_framework',<br/>]</span></pre><p id="0dfd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好了，现在完成了，我们可以用<em class="mo">python 3 manage . py runserver</em>命令运行我们的服务器，如果你想通过网络访问它，你可以这样做<em class="mo">python 3 manage . py runserver IP:PORT</em>但是要确保你在设置中把你的IP添加到ALLOWED_HOST</p><h1 id="135f" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">设置节流</h1><p id="c0ba" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">可以使用<code class="fe mk ml mm mb b">DEFAULT_THROTTLE_CLASSES</code>和<code class="fe mk ml mm mb b">DEFAULT_THROTTLE_RATES</code>设置来全局设置默认节流策略。比如说。将这些行添加到您的设置中。py</p><pre class="lp lq lr ls gt ma mb mc md aw me bi"><span id="20fc" class="mf km iq mb b gy mg mh l mi mj">REST_FRAMEWORK = {<br/>    'DEFAULT_THROTTLE_CLASSES': [<br/>        'rest_framework.throttling.AnonRateThrottle',<br/>        'rest_framework.throttling.UserRateThrottle'<br/>    ],<br/>    'DEFAULT_THROTTLE_RATES': {<br/>        'anon': '50/day',<br/>        'user': '100/day'<br/>    }<br/>}</span></pre><p id="571f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">“Anon”被称为未经认证的用户,“User”是经过认证的用户，因此他们每天可以创建100个请求，Anon每天可以创建50个请求。</p><h1 id="28c6" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">让我们检查一下</h1><p id="f3c3" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">让我们启动我们的burpsuite，向我们的应用程序发出第一个请求:</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi mp"><img src="../Images/6e1845a1cce3e68973ab5b07c23ed736.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UAQ3ouNVMHS9eoZ0-4lC0g.png"/></div></div></figure><p id="44c1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如您所见，它已经启动并运行良好，现在，由于我们仍未通过身份验证，让我们发送50多个请求来检查我们是否被阻止:</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi mq"><img src="../Images/1abf3e99cff446c15cdde58bb98ccc3d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sXewN9D94OKszYfMPtdqNA.png"/></div></div><figcaption class="mr ms gj gh gi mt mu bd b be z dk translated">用户在发送超过50个请求后被阻止</figcaption></figure><p id="7182" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如所料，我们现在被阻止，并从服务器接收429状态代码，现在的主要想法是如何绕过它，没有任何进一步的调查让我们首先看看<a class="ae mv" href="https://www.django-rest-framework.org/api-guide/throttling/#how-clients-are-identified" rel="noopener ugc nofollow" target="_blank">官方文件</a>，它谈到如何识别客户端:</p><blockquote class="mw"><p id="a43f" class="mx my iq bd mz na nb nc nd ne nf kk dk translated"><code class="fe mk ml mm mb b">X-Forwarded-For</code> HTTP头和<code class="fe mk ml mm mb b">REMOTE_ADDR</code> WSGI变量用于唯一标识用于节流的客户端IP地址。如果<code class="fe mk ml mm mb b">X-Forwarded-For</code>头存在，那么它将被使用，否则来自WSGI环境的<code class="fe mk ml mm mb b">REMOTE_ADDR</code>变量的值将被使用。</p></blockquote><p id="60bd" class="pw-post-body-paragraph jn jo iq jp b jq ng js jt ju nh jw jx jy ni ka kb kc nj ke kf kg nk ki kj kk ij bi translated">记住这一点，我们已经测试了所有这些http头，所以让我们用X-Forwarded-For头再次发出请求:</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi nl"><img src="../Images/855935ad339f5349bbcc9e150041b615.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aYnseaQ_fA2Oa7BOAfonTQ.png"/></div></div><figcaption class="mr ms gj gh gi mt mu bd b be z dk translated">绕过带有X-Forwarded-For标头的429</figcaption></figure><p id="376e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通过这样做，我们再次获得了访问权限！但这里有一个小技巧，我们应该在每50个请求后改变转发头的IP，这样我们就可以无限制地访问服务器，因为我检查过像127.0.0.111111这样的IP也可以工作。</p><p id="64a7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">像Nginx这样的一些反向代理可能会添加X-Forwarded-For头来告诉服务器用户的IP地址:</p><blockquote class="nm nn no"><p id="d50e" class="jn jo mo jp b jq jr js jt ju jv jw jx np jz ka kb nq kd ke kf nr kh ki kj kk ij bi translated">传统上，HTTP反向代理使用非标准头来向上游服务器通知用户的IP地址和其他请求属性:</p><p id="8544" class="jn jo mo jp b jq jr js jt ju jv jw jx np jz ka kb nq kd ke kf nr kh ki kj kk ij bi translated">X-Forwarded-For:12.34.56.78，23.45.67.89<br/>X-Real-IP:12.34.56.78<br/>X-Forwarded-Host:example.com<br/>X-Forwarded-Proto:https</p></blockquote><p id="a396" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果我们自己添加X-Forwarded-For头，我们添加的IP地址将是第一个值，Nginx的将是第二个值，所以我们不会面临任何问题。</p><h1 id="e2ce" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">鉴定</h1><p id="bbd1" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">当您通过身份验证时，会有一些不同的情况，让我们登录看看:</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi ns"><img src="../Images/0187b4367820a1f8c3e4e10de919151e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o9kAkS2CSaoCQYtw4FRltw.png"/></div></div></figure><p id="ab33" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">作为登录用户，我们由于克服了限制策略而被阻止，通过测试上述方法和其他一些方法，用户仍将被阻止，因此这里的行为可能是用户和IP一起被阻止。</p></div><div class="ab cl nt nu hu nv" role="separator"><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny"/></div><div class="ij ik il im in"><h1 id="d094" class="kl km iq bd kn ko oa kq kr ks ob ku kv kw oc ky kz la od lc ld le oe lg lh li bi translated">结论</h1><p id="5b14" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">如果您使用这种方法作为您的主要速率限制预防，而没有任何进一步的高级技术来使其更加安全，请注意这种攻击将在您的系统中发生。</p><h1 id="e868" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">参考</h1><div class="of og gp gr oh oi"><a href="https://www.django-rest-framework.org/tutorial/quickstart/" rel="noopener  ugc nofollow" target="_blank"><div class="oj ab fo"><div class="ok ab ol cl cj om"><h2 class="bd ir gy z fp on fr fs oo fu fw ip bi translated">快速入门</h2><div class="op l"><h3 class="bd b gy z fp on fr fs oo fu fw dk translated">我们将创建一个简单的API，允许管理员用户查看和编辑系统中的用户和组。创建一个…</h3></div><div class="oq l"><p class="bd b dl z fp on fr fs oo fu fw dk translated">www.django-rest-framework.org</p></div></div><div class="or l"><div class="os l ot ou ov or ow ly oi"/></div></div></a></div><div class="of og gp gr oh oi"><a href="https://www.django-rest-framework.org/api-guide/throttling/" rel="noopener  ugc nofollow" target="_blank"><div class="oj ab fo"><div class="ok ab ol cl cj om"><h2 class="bd ir gy z fp on fr fs oo fu fw ip bi translated">节流</h2><div class="op l"><h3 class="bd b gy z fp on fr fs oo fu fw dk translated">HTTP/1.1 420增强您的冷静Twitter API速率限制响应节流类似于权限，因为它…</h3></div><div class="oq l"><p class="bd b dl z fp on fr fs oo fu fw dk translated">www.django-rest-framework.org</p></div></div></div></a></div><div class="of og gp gr oh oi"><a href="https://www.nginx.com/resources/wiki/start/topics/examples/forwarded/" rel="noopener  ugc nofollow" target="_blank"><div class="oj ab fo"><div class="ok ab ol cl cj om"><h2 class="bd ir gy z fp on fr fs oo fu fw ip bi translated">使用转发的报头</h2><div class="op l"><h3 class="bd b gy z fp on fr fs oo fu fw dk translated">NGINX配置和部署转发头的注意事项。</h3></div><div class="oq l"><p class="bd b dl z fp on fr fs oo fu fw dk translated">www.nginx.com</p></div></div></div></a></div><h1 id="2637" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">联系我</h1><div class="of og gp gr oh oi"><a href="https://www.linkedin.com/in/hosein-vita-9796ba225/" rel="noopener  ugc nofollow" target="_blank"><div class="oj ab fo"><div class="ok ab ol cl cj om"><h2 class="bd ir gy z fp on fr fs oo fu fw ip bi translated">自由职业者| LinkedIn</h2><div class="op l"><h3 class="bd b gy z fp on fr fs oo fu fw dk translated">查看Hosein Vita在全球最大的职业社区LinkedIn上的个人资料。侯赛因有一个工作列在他们的…</h3></div><div class="oq l"><p class="bd b dl z fp on fr fs oo fu fw dk translated">www.linkedin.com</p></div></div><div class="or l"><div class="ox l ot ou ov or ow ly oi"/></div></div></a></div><p id="5f30" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae mv" href="https://twitter.com/HoseinVita" rel="noopener ugc nofollow" target="_blank">https://twitter.com/HoseinVita</a></p></div></div>    
</body>
</html>