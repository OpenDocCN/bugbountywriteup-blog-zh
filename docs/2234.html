<html>
<head>
<title>Analyzing a Remcos RAT Infection</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">分析一次雷姆科斯鼠感染</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/analyzing-a-remcos-rat-infection-5c9b6bfd7139?source=collection_archive---------3-----------------------#2022-08-02">https://infosecwriteups.com/analyzing-a-remcos-rat-infection-5c9b6bfd7139?source=collection_archive---------3-----------------------#2022-08-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/582f5a20255f583fb24759fd58269c9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*gz3O1xQ4X15H7WfN.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">信用:breakingsecurity.net</figcaption></figure><p id="1e20" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">欢迎光临！今天我将写一些我最近做的恶意软件分析。我在Brad Duncan的网站上看到了一个帖子(<a class="ae la" href="https://www.malware-traffic-analysis.net/2022/01/04/index.html" rel="noopener ugc nofollow" target="_blank">https://www . malware-traffic-analysis . net/2022/01/04/index . html</a>)，其中提供了一些关于Remcos RAT(远程访问木马)感染的信息，该感染源自一个启用了恶意宏的excel文档。Remcos最初旨在作为IT人员控制/管理计算机的合法工具，但由于其预先打包的性质，它已被威胁行为者广泛滥用。</p><p id="ba46" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我决定自己挖进去做一些分析，纯粹是为了自己的学习和体会。</p><h1 id="964b" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">妥协的指标(国际奥委会的)</h1><ul class=""><li id="45c9" class="lz ma iq ke b kf mb kj mc kn md kr me kv mf kz mg mh mi mj bi translated">HTTP GET请求—64.188.19.241:80—atcn.jpg</li><li id="dd02" class="lz ma iq ke b kf mk kj ml kn mm kr mn kv mo kz mg mh mi mj bi translated">HTTP GET请求—104.223.119.167:80—calient.jpg</li><li id="04b6" class="lz ma iq ke b kf mk kj ml kn mm kr mn kv mo kz mg mh mi mj bi translated">HTTP GET请求—13.107.42.13:80—misc . VBS</li><li id="51f3" class="lz ma iq ke b kf mk kj ml kn mm kr mn kv mo kz mg mh mi mj bi translated">TLS加密流量—79.134.225.79:10174—shiestynerd.dvrlists.com</li><li id="93de" class="lz ma iq ke b kf mk kj ml kn mm kr mn kv mo kz mg mh mi mj bi translated">sha 256:b1df 072 EBA 923 c 472 e 461200 b 35823 FDE 7 f 8 e 640 bfb 468 ff 5 AC 707369 a2 fa 35 e</li><li id="a264" class="lz ma iq ke b kf mk kj ml kn mm kr mn kv mo kz mg mh mi mj bi translated">sha 256:95 c 0 a 9 e 6463 a2 EB 1 bbfe 3198 CD 4b 6 CD 74927 a 209 ca 4 ab 17501 c2f 444494 f 4499</li><li id="754b" class="lz ma iq ke b kf mk kj ml kn mm kr mn kv mo kz mg mh mi mj bi translated">sha 256:df6b 921 e5b 1379747 C4 ab 66 ad 27 cc 729 f 387 bb 2c 7 C1 c 247 F3 c 7 BC 5c 9 e 3293 EC 3</li><li id="0262" class="lz ma iq ke b kf mk kj ml kn mm kr mn kv mo kz mg mh mi mj bi translated">sha 256:a 9 E4 bb 0982 f 850d 37 DCF 3079 d6f 631d 4d 8d 52d 79 f 552711 f 88410 ff 3a e9 DBD 1 a</li></ul><h1 id="73f4" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">技术分析</h1><h2 id="58ed" class="mp lc iq bd ld mq mr dn lh ms mt dp ll kn mu mv lp kr mw mx lt kv my mz lx na bi translated"><strong class="ak">电子邮件&amp;恶意Excel电子表格</strong></h2><p id="55db" class="pw-post-body-paragraph kc kd iq ke b kf mb kh ki kj mc kl km kn nb kp kq kr nc kt ku kv nd kx ky kz ij bi translated">首先，我们要看一个eml文件(电子邮件)。这个文件将为我们提供大量的信息进行分析，包括附加的内容、电子邮件标题等。我们可以看到附件中有一个名为“付款汇款通知单000000202213.xlsb”的文件。Content-Type字段指示附件是启用宏的Microsoft Excel工作表，Content-Transfer-Encoding字段指示数据是base64编码的。</p><figure class="nf ng nh ni gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ne"><img src="../Images/40bc61dab95d8d3ccff9b04007515c9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QzTTNWI94f88VRweLc6qRQ.png"/></div></div></figure><p id="6801" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">然后，我们可以将这些base64编码的数据复制到cyberchef中，并对其进行解码。这样做会显示更多的信息，比如文件头开头的“PK ”,表示一个ZIP存档文件。像word文档、powerpoints和excel电子表格这样的Microsoft office文件实际上是由ZIP存档中的多个文件组成的。这和Content_Types.xml字符串一起表明这肯定是一个excel电子表格，就像电子邮件标题告诉我们的那样。</p><figure class="nf ng nh ni gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nj"><img src="../Images/afee795e605a7fabf9d7d45e1ec50cce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P6ieu4uT7AGKlQl2saTkmA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">Base64解码的附件数据。</figcaption></figure><p id="cc07" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">同样使用cyberchef，我们可以通过点击输出区域右上方的软盘图标来下载excel电子表格的副本。现在让我们获取电子表格的哈希值并提交给virustotal。</p><figure class="nf ng nh ni gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nk"><img src="../Images/281fea3c62b0e2629be5567fc045c135.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wQDNJFrT5axjO8oY22Lb2w.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">“付款汇款通知_ 000000202213 . xlsb”excel电子表格的虚拟总结果。</figcaption></figure><p id="dedd" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">很明显，这是一个恶意文件，virustotal上的30个供应商都这样认为。在这一点上，我们应该看到我们可以了解到电子表格中嵌入的宏的哪些信息，因为宏是实际包含恶意功能的组件。使用OLEtools，我们可以很容易地了解这个宏是如何执行其恶意函数的。</p><figure class="nf ng nh ni gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nl"><img src="../Images/4d2d8678a0b6d88e5b91a4547c7cda05.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8cz51rz_Hx69o_o0xOKA-Q.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">excel电子表格中嵌入的恶意宏的olevba输出。</figcaption></figure><p id="d0f7" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">olevba工具为我们提供了一些有用的信息，表明宏正在使用AutoExec函数在打开excel电子表格时自动运行。它还告诉我们，威胁参与者试图混淆宏的功能。</p><h2 id="dd1a" class="mp lc iq bd ld mq mr dn lh ms mt dp ll kn mu mv lp kr mw mx lt kv my mz lx na bi translated"><strong class="ak">第一阶段</strong></h2><p id="c028" class="pw-post-body-paragraph kc kd iq ke b kf mb kh ki kj mc kl km kn nb kp kq kr nc kt ku kv nd kx ky kz ij bi translated">我们还可以将这个excel电子表格提交到一个类似孵化分诊(【https://tria.ge/】T2)的沙盒中，以了解它的更多行为。</p><figure class="nf ng nh ni gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nm"><img src="../Images/c4e83bb8349495f3e2b6818f37645748.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*710Ib8GqvvO3CeQglJN5bQ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">恶意excel电子表格的阴影筛选结果。</figcaption></figure><p id="e44d" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">孵化分类的结果表明，excel进程正在生成powershell.exe进程和ping.exe进程，这两个进程都不应该从excel中生成。威胁者正在使用powershell脚本ping google.com，以确保受害者机器有互联网连接。如果受害者确实有连接，那么脚本将下载并执行第一阶段有效负载，一个名为“misc.vbs”的文件。请注意，下载misc.vbs文件的命令使用反转文本进行了轻微的混淆，然后在脚本运行时取消反转。这是一种通过自动化工具来逃避静态检测的尝试，但是当被优秀的分析师观察时，它每次都会失败。</p><figure class="nf ng nh ni gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nn"><img src="../Images/1e9ad63a6c86aed773afdab48c1e8e00.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mIG_kHN4SGFc_oRqmkfDgA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">从onedrive下载“misc.vbs”的HTTP GET请求。</figcaption></figure><p id="82ba" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">从上图中我们可以看到，受害者正在从powershell脚本中看到的onedrive.live.com URL下载misc.vbs文件。查看misc.vbs文件，我们可以看到它非常混乱，但是，我们可以从中提取一些信息。在文件的底部有一个带有十六进制编码参数的执行函数，该函数参数解码为第二阶段有效载荷的地址。</p><figure class="nf ng nh ni gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi no"><img src="../Images/29a564d92b20f6b5c96539e3e725d219.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pbKnUEK0u44FIUzZ15A67Q.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">misc.vbs中第二阶段有效负载的十六进制编码地址</figcaption></figure><figure class="nf ng nh ni gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi np"><img src="../Images/a71954f4996ecc990b2cbe7bc2466fb4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tdBPtARwqCtYWi-qQcXHpQ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">第二级有效载荷的解码地址。</figcaption></figure><p id="c474" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">此第一阶段有效负载还通过将第二阶段写入Windows注册表，在安装第二阶段之前为其建立持久性。</p><figure class="nf ng nh ni gt jr gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/cf57d365a24c21f6852d6baad0c9f8fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:832/format:webp/1*O5IXEoHS5zUzaSdO2-1seA.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">第二阶段是写入注册表以建立持久性</figcaption></figure><p id="e057" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">现在，即使受害者机器重新启动，威胁参与者仍将保持存在。</p><h2 id="98ee" class="mp lc iq bd ld mq mr dn lh ms mt dp ll kn mu mv lp kr mw mx lt kv my mz lx na bi translated"><strong class="ak">第二阶段</strong></h2><p id="2734" class="pw-post-body-paragraph kc kd iq ke b kf mb kh ki kj mc kl km kn nb kp kq kr nc kt ku kv nd kx ky kz ij bi translated">此时，受害者已经伸手要求第二级有效载荷。请注意，下面的数据表示为JScript代码。然后，该JScript使用提供的十六进制编码的参数运行powershell。</p><figure class="nf ng nh ni gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nr"><img src="../Images/d80f619b153a58984ce412296138dba3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*t0-IyvSBeeUl4Zf2VqC16A.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">十六进制编码的JScript代码被伪装成jpg文件数据。</figcaption></figure><p id="411c" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们可以获取这些数据，用cyberchef对其进行解码，以了解其功能。</p><figure class="nf ng nh ni gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ns"><img src="../Images/ade00824f75e54b69f0944489cd92216.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p7Y075T4uFTyj1fuUa6jmg.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">JScript代码的十六进制解码。</figcaption></figure><p id="13a4" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如上图所示，powershell脚本再次联系104.223.119.167，这次是为了下载一个名为“calient.jpg”的文件。这个calient.jpg文件实际上是一个javascript文件，其中包含一个DLL。这在一篇来自研讯(<a class="ae la" href="https://inquest.net/blog/2022/01/24/analysis-remcos-rat-dropper" rel="noopener ugc nofollow" target="_blank">https://研讯. net/blog/2022/01/24/analysis-rem cos-RAT-dropper</a>)的文章中有描述，简而言之，这个DLL就是最终的Remcos RAT有效载荷。</p><h2 id="704e" class="mp lc iq bd ld mq mr dn lh ms mt dp ll kn mu mv lp kr mw mx lt kv my mz lx na bi translated"><strong class="ak">命令&amp;控制【C2】</strong></h2><p id="be25" class="pw-post-body-paragraph kc kd iq ke b kf mb kh ki kj mc kl km kn nb kp kq kr nc kt ku kv nd kx ky kz ij bi translated">在安装了最终的Remcos RAT有效负载后，在受害机器和IP地址为79.134.225.79的域名“shiestynerd.dvrlists.com”之间可以观察到清晰的C2流量模式。</p><figure class="nf ng nh ni gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nr"><img src="../Images/d37ff486bbe4c3f3f86c916c6b4f2ad6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Vh0szK3RmKC2gAgumayOpg.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">安装Remcos RAT后的C2交通。</figcaption></figure><p id="8173" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">该域名和IP地址被virustotal上的11家供应商识别为恶意域名。</p><figure class="nf ng nh ni gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nt"><img src="../Images/19805ef6b60f1a32f7f0f68adefd5d2b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Mj_MrGlfiviGqOMbuw_GYQ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">C2域的病毒总数结果。</figcaption></figure><h1 id="4d8c" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="4e83" class="pw-post-body-paragraph kc kd iq ke b kf mb kh ki kj mc kl km kn nb kp kq kr nc kt ku kv nd kx ky kz ij bi translated">谢谢你花时间阅读我的博文！我希望你喜欢它，并从中获得一些价值。如果你有，请关注我并分享这篇文章。此外，特别感谢来自研讯的Dmitry Melikov，他的精彩文章详细介绍了一个非常相似的分析。早点回来！</p></div><div class="ab cl nu nv hu nw" role="separator"><span class="nx bw bk ny nz oa"/><span class="nx bw bk ny nz oa"/><span class="nx bw bk ny nz"/></div><div class="ij ik il im in"><p id="9e4e" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><em class="ob">来自Infosec的报道:Infosec上每天都有很多事情发生，很难跟上。</em> <a class="ae la" href="https://weekly.infosecwriteups.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="ke ir"> <em class="ob">加入我们的每周简讯</em> </strong> </a> <em class="ob">以5篇文章、4个线程、3个视频、2个Github Repos和工具以及1个工作提醒的形式免费获取所有最新的Infosec趋势！</em></p></div></div>    
</body>
</html>