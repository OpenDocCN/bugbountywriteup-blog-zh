<html>
<head>
<title>Stealthy Persistence While Using Windows Terminal.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Windows终端时的隐形持久化。</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/stealthy-persistence-while-using-windows-terminal-ff6f4927563a?source=collection_archive---------0-----------------------#2022-11-09">https://infosecwriteups.com/stealthy-persistence-while-using-windows-terminal-ff6f4927563a?source=collection_archive---------0-----------------------#2022-11-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="f818" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">通过误用设置文件</h2></div><p id="6e18" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我偶然发现了一篇有趣的文章，解释了一种使用windows终端配置文件在Windows机器上创建持久性的技术。</p><p id="4536" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然而，在准备这篇文章的时候，我注意到终端窗口会挂起，这是一个明显的妥协迹象。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi lb"><img src="../Images/8fed0198e770655649b79ca7d93dba35.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y_B8yQcJiowwdYbppEZu8w.png"/></div></div><figcaption class="ln lo gj gh gi lp lq bd b be z dk translated">悬挂cmd没有那么隐秘持久</figcaption></figure><p id="cff7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因此，我进一步研究，以找到一种方法来消除悬挂的cmd窗口，并使其更加隐蔽。</p></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><h1 id="9c15" class="ly lz iq bd ma mb mc md me mf mg mh mi jw mj jx mk jz ml ka mm kc mn kd mo mp bi translated">终端文档</h1><p id="015f" class="pw-post-body-paragraph kf kg iq kh b ki mq jr kk kl mr ju kn ko ms kq kr ks mt ku kv kw mu ky kz la ij bi translated">正如在另一篇文章中所解释的，windows终端有一个settings.json，它提供了改变终端配置的可能性。这可以改变颜色，也可以改变其他配置，如启动哪个终端。</p><p id="e731" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">可以在以下文件夹中找到设置文件。</p><p id="2fbd" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">" % local appdata % \ Packages \ Microsoft。windows terminal _&lt;package id&gt;\ local state \ "</strong></p><p id="01c5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我注意到在微软的文档中有一个在另一篇文章中没有使用的方法，叫做startupActions。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi lb"><img src="../Images/7b8abcb7f2868d3227112825bdb9d8cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G4KKa4JJuEFW6nQcQLeDZQ.png"/></div></div><figcaption class="ln lo gj gh gi lp lq bd b be z dk translated">microsoft文档解释了startupAction属性</figcaption></figure><p id="6e45" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用startupActions，可以定义启动时要启动的终端窗口。</p><p id="439e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是一个重要的特性，因为我们想要启动一个“脏”终端，它会执行一些动作，并在事后自动自我销毁。以限制受害者可以查看脏标签的时间。</p><p id="e0a9" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">但首先我们需要定义脏的配置文件。我为终端定义了一个概要文件，它在启动时会启动PowerShell并启动一个新进程(在这个例子中是notepad)。这个命令将创建相同的持久性，但是不显示挂起的终端。</p><pre class="lc ld le lf gt mv mw mx my aw mz bi"><span id="9463" class="na lz iq mw b gy nb nc l nd ne">{<br/>"guid": "{d21dfa6e-2fd4-40ff-86fe-19ccdb2535f9}",<br/>"name": "Proof Of Concept",<br/>"hidden": true,   "commandline":"%SystemRoot%\\System32\\WindowsPowerShell\\v1.0\\powershell.exe Start-Process %SystemRoot%\\System32\\notepad.exe",<br/>},</span></pre><p id="c12c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">之后，我们可以将它添加到我们的启动操作中。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi lb"><img src="../Images/2b037378d0d1c16f93d15e4a1b8c0f59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HOrWXIKxFqBlSBY0ATzBJA.png"/></div></div><figcaption class="ln lo gj gh gi lp lq bd b be z dk translated">startupActions属性</figcaption></figure><p id="5e32" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用这一行，当启动终端应用程序时，所有指定的选项卡都将自动打开。为了更好的隐藏，验证是否已经指定了一个默认的概要文件是明智的。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi nf"><img src="../Images/17c8d8a45588f449e9338531853864c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nfydZF6HaTR1G1Q2HBiSEg.png"/></div></div><figcaption class="ln lo gj gh gi lp lq bd b be z dk translated">微软解释的默认配置文件</figcaption></figure><p id="3a51" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果指定了一个，但还没有startupAction。您可以在启动选项中集成该配置文件，这将创建一个几乎无缝的集成。在没有定义默认配置文件的情况下，终端将回退到PowerShell GUID作为默认配置文件，然后添加该配置文件。</p><p id="d4e5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">下面的代码利用startupActions来启动默认的Powershell属性，并加载概念验证配置文件。</p><pre class="lc ld le lf gt mv mw mx my aw mz bi"><span id="5049" class="na lz iq mw b gy nb nc l nd ne">"startupActions": "new-tab -p \"Windows PowerShell\" — title \"PowerShell\" ; new-tab -p \"Proof Of Concept\" — title \"cmd hanging\" ",</span></pre><p id="e602" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这项技术的有趣之处在于，执行的程序只是wt终端的一部分，持续几秒钟。后来因为Powershell被终止了，程序就和windows终端解耦了。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi lb"><img src="../Images/a6f1cf156ac20c94697b7809a54349c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JNTIjNxUBNeO0KvH3Ya09g.png"/></div></div><figcaption class="ln lo gj gh gi lp lq bd b be z dk translated">进程监视器显示在WindowsTerminal下终止powershell并启动Notepad.exe</figcaption></figure><p id="ef78" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这里PowerShell几乎会立刻被干掉。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi lb"><img src="../Images/0784fba7b2a1c1a62ba26a841ed58161.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bQ-Q9WYJai8NuMAFufUhaA.png"/></div></div><figcaption class="ln lo gj gh gi lp lq bd b be z dk translated">Notepad.exe不再位于WindowsTerminal下，但具有相同的pid。</figcaption></figure><p id="fc3f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在额外的PowerShell被终止(它启动了程序记事本)后，它将有一个不存在的父对象，但是pid仍然是相同的！</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/6a05b83260ab4d86dfc54852f74f2503.png" data-original-src="https://miro.medium.com/v2/resize:fit:736/format:webp/1*QtmL-wV0DxyTtXO8DG0nTg.png"/></div><figcaption class="ln lo gj gh gi lp lq bd b be z dk translated">在Powershell终止后，该程序有一个“不存在的进程”作为父进程</figcaption></figure><p id="a53f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于一些额外的隐藏，隐藏参数可以设置为真。这确保它不是终端界面下拉菜单中的可选项</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi lb"><img src="../Images/c87ee067031c08b40892a314d25e9e68.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*72ritjn30FaxsmZVKgOg2Q.png"/></div></div><figcaption class="ln lo gj gh gi lp lq bd b be z dk translated">隐藏由microsoft文档解释的配置文件</figcaption></figure><p id="ff3e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在它在终端的下拉菜单中不再可见。使得当用户试图打开新终端时不太可能被发现。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi lb"><img src="../Images/7651e2850f83c3224f81a822d76926c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q8QOwaADbw3FdN8jkKS9jA.png"/></div></div><figcaption class="ln lo gj gh gi lp lq bd b be z dk translated">由于隐藏属性，概念验证选项在下拉列表中不可见。</figcaption></figure><p id="a8d1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">作为第二种选择，你可以看一个图标。有一个可以向用户显示cmd窗口的小窗口。与windows的标准悬挂图标，它可以给一些额外的维度，使它更合理的为什么会出错和关闭</p><p id="b4f4" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因此，可以设置图标属性。<br/>“图标”:&lt;图标位置&gt;</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi lb"><img src="../Images/3ec24f9b46d76398e75d222418f75291.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zju7EWkYIdCyCY3hxpMAeA.png"/></div></div><figcaption class="ln lo gj gh gi lp lq bd b be z dk translated">图标选项解释</figcaption></figure><p id="2856" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">给了我灵感的伟大文章可以在这里找到:<a class="ae nh" href="https://nasbench.medium.com/persistence-using-windows-terminal-profiles-5035d3fc86fe." rel="noopener">https://nasbench . medium . com/persistence-using-windows-terminal-profiles-5035d 3 fc 86 Fe。</a>出自<a class="ni nj ep" href="https://medium.com/u/aad5aaf11bbb?source=post_page-----ff6f4927563a--------------------------------" rel="noopener" target="_blank">纳斯雷丁·本奇查利</a></p><h1 id="3074" class="ly lz iq bd ma mb nk md me mf nl mh mi jw nm jx mk jz nn ka mm kc no kd mo mp bi translated"><strong class="ak">结论</strong></h1><p id="8e09" class="pw-post-body-paragraph kf kg iq kh b ki mq jr kk kl mr ju kn ko ms kq kr ks mt ku kv kw mu ky kz la ij bi translated">这个技巧为在使用微软终端应用程序的设备上强制持久性提供了一些简单的可能性。请记住，从2022年10月18日起，微软终端现在是默认终端，这是一个有效且明显的风险。</p><div class="np nq gp gr nr ns"><a href="https://devblogs.microsoft.com/commandline/windows-terminal-is-now-the-default-in-windows-11/" rel="noopener  ugc nofollow" target="_blank"><div class="nt ab fo"><div class="nu ab nv cl cj nw"><h2 class="bd ir gy z fp nx fr fs ny fu fw ip bi translated">Windows终端现在是Windows 11的默认设置</h2><div class="nz l"><h3 class="bd b gy z fp nx fr fs ny fu fw dk translated">这一天终于到来了！Windows终端现在是Windows 11 22H2上默认的命令行体验！🎉这意味着…</h3></div><div class="oa l"><p class="bd b dl z fp nx fr fs ny fu fw dk translated">devblogs.microsoft.com</p></div></div><div class="ob l"><div class="oc l od oe of ob og ll ns"/></div></div></a></div><p id="1676" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">有趣的是，我深入阅读了终端函数是如何工作的，并找到了一种几乎无缝的方法，用我几乎每天都在使用的工具来创建持久性。</p><p id="16a7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我还没有在Mitre Att&amp;ck框架上看到它，也许它是T1546的一个新的sub技术？</p><p id="4f25" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">有关终端的更多信息，请访问:</p><div class="np nq gp gr nr ns"><a href="https://learn.microsoft.com/en-us/windows/terminal/customize-settings/startup" rel="noopener  ugc nofollow" target="_blank"><div class="nt ab fo"><div class="nu ab nv cl cj nw"><h2 class="bd ir gy z fp nx fr fs ny fu fw ip bi translated">Windows终端启动设置</h2><div class="nz l"><h3 class="bd b gy z fp nx fr fs ny fu fw dk translated">下面列出的属性会影响整个终端窗口，不管配置文件的设置如何。这些应该是…</h3></div><div class="oa l"><p class="bd b dl z fp nx fr fs ny fu fw dk translated">learn.microsoft.com</p></div></div><div class="ob l"><div class="oh l od oe of ob og ll ns"/></div></div></a></div><p id="3c4f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你想讨论任何与信息安全相关的话题，我在linkedin上:<a class="ae nh" href="https://www.linkedin.com/in/bobvanderstaak/" rel="noopener ugc nofollow" target="_blank">https://www.linkedin.com/in/bobvanderstaak/</a></p></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><h2 id="e500" class="na lz iq bd ma oi oj dn me ok ol dp mi ko om on mk ks oo op mm kw oq or mo os bi translated">来自Infosec的报道:Infosec每天都有很多内容，很难跟上。<a class="ae nh" href="https://weekly.infosecwriteups.com/" rel="noopener ugc nofollow" target="_blank">加入我们的每周简讯</a>以5篇文章、4条线索、3个视频、2个GitHub Repos和工具以及1个工作提醒的形式免费获取所有最新的Infosec趋势！</h2></div></div>    
</body>
</html>