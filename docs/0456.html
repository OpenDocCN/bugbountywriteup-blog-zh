<html>
<head>
<title>CVE-2019-17556: Unsafe deserialization in Apache Olingo</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">CVE-2019-17556:Apache Olingo中的不安全反序列化</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/cve-2019-17556-unsafe-deserialization-in-apache-olingo-8ebb41b66817?source=collection_archive---------1-----------------------#2019-12-21">https://infosecwriteups.com/cve-2019-17556-unsafe-deserialization-in-apache-olingo-8ebb41b66817?source=collection_archive---------1-----------------------#2019-12-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="fa47" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">不久前，我写了一篇关于我在图书馆发现的安全问题的文章。这篇文章描述了Apache Olingo中的另一个小漏洞。该问题在4.7.0版中也已得到修复。</p><p id="dba0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">顺便说一下，Apache Olingo是一个实现开放数据协议(OData)的Java库。该协议允许以一种简单的方式创建和使用可查询和可互操作的RESTful APIs。</p><p id="ce7f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">(最初发表于<a class="ae ko" href="https://blog.gypsyengineer.com/en/security/cve-2019-17556-unsafe-deserialization-in-apache-olingo.html" rel="noopener ugc nofollow" target="_blank">https://blog.gypsyengineer.com</a></p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi kp"><img src="../Images/c46b753638a7d1f7a697b38e9613774a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*UkvxIDPo2Y23T16E.jpg"/></div></div></figure><h1 id="e84f" class="lb lc it bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">问题</h1><p id="4811" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated">Apache Olingo有<code class="fe me mf mg mh b">AbstractService</code>类，它是公共API的一部分。根据Javadoc，该类是代理模式的入口点。它提供对实体容器实例的访问。该类的构造函数接受压缩的元数据。更准确地说，构造函数期望一个序列化的<code class="fe me mf mg mh b">XMLMetadata</code>对象，它用Base64编码，用GZIP压缩。它使用哪种序列化机制？这是默认的Java序列化，很容易受到反序列化的攻击。下面是构造函数处理压缩元数据的方式:</p><pre class="kq kr ks kt gt mi mh mj mk aw ml bi"><span id="b086" class="mm lc it mh b gy mn mo l mp mq">protected AbstractService(final String compressedMetadata, final String metadataETag,<br/>      final ODataServiceVersion version, final String serviceRoot, final boolean transactional) {</span><span id="f7b3" class="mm lc it mh b gy mr mo l mp mq">ByteArrayInputStream bais = null;<br/>    GZIPInputStream gzis = null;<br/>    ObjectInputStream ois = null;<br/>    XMLMetadata metadata = null;<br/>    try {<br/>      // use commons codec's Base64 in this fashion to stay compatible with Android<br/>      bais = new ByteArrayInputStream(new Base64().decode(compressedMetadata.getBytes("UTF-8")));<br/>      gzis = new GZIPInputStream(bais);<br/>      ois = new ObjectInputStream(gzis);<br/>      metadata = (XMLMetadata) ois.readObject();</span></pre><p id="8b9f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">首先，它使用<code class="fe me mf mg mh b">Base64.decode()</code>方法解码输入数据。然后，它将解码后的数据转换成一个字节数组，并将该数组包装成一个<code class="fe me mf mg mh b">ByteArrayInputStream</code>实例。接下来，输入流被打包成一个<code class="fe me mf mg mh b">GZIPInputStream</code>对象来解压缩数据。最后，GZIP输入流被打包成一个<code class="fe me mf mg mh b">ObjectInputStream</code>来反序列化元数据。</p><p id="9dee" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">默认情况下，<code class="fe me mf mg mh b">ObjectInputStream</code>在反序列化数据时不会应用任何检查。这意味着，如果攻击者能够向扩展了<code class="fe me mf mg mh b">AbstractService</code>的类提供恶意元数据，那么在更糟糕的情况下，可能会导致执行攻击者的代码。</p><p id="3338" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">问题的严重性很大程度上取决于特定应用程序如何使用<code class="fe me mf mg mh b">AbstractService</code>类，以及元数据来自哪里。</p><p id="c41b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果应用程序从受保护的资源加载元数据，攻击者必须想办法将恶意元数据写入受保护的资源。这可能并不容易。例如，如果元数据是从正确配置的数据库中加载的，那么攻击者必须找到一种SQL注入或其他方法，使他能够将恶意数据注入数据库。或者，如果应用程序从具有适当访问权限的文件中加载元数据，那么攻击者必须找到一种方法来写入该文件。</p><p id="0731" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">另一方面，如果应用程序通过网络接收元数据，攻击者可能更容易让应用程序加载他的恶意数据。</p><p id="ab93" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然而，项目维护者同意让<code class="fe me mf mg mh b">AbstractService</code>类使用起来更安全一点。</p><h1 id="5787" class="lb lc it bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">解决方案</h1><p id="4091" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated">通过为允许反序列化的类实现一个白名单，这个问题得到了缓解。例如，可以通过扩展<code class="fe me mf mg mh b">ObjectInputStream</code>类并在被覆盖的<code class="fe me mf mg mh b">resolveClass()</code>方法中实现白名单来实现。但是这不是必要的，因为Olingo使用Apache IO，它提供了用于实现这种白名单的<code class="fe me mf mg mh b">ValidatingObjectInputStream</code>类。另一种选择可能是JEP 290中添加的过滤器，但这种方式需要使用较新版本的Java。</p><p id="41ba" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><a class="ae ko" href="https://github.com/apache/olingo-odata4/pull/60/files" rel="noopener ugc nofollow" target="_blank">修复</a>非常简单:</p><ul class=""><li id="9632" class="ms mt it js b jt ju jx jy kb mu kf mv kj mw kn mx my mz na bi translated">添加了一个工厂方法<code class="fe me mf mg mh b">createObjectInputStream()</code>，它创建了一个<code class="fe me mf mg mh b">ValidatingObjectInputStream</code>实例，配置了一个允许反序列化的类的白名单。</li><li id="58eb" class="ms mt it js b jt nb jx nc kb nd kf ne kj nf kn mx my mz na bi translated"><code class="fe me mf mg mh b">AbstractService</code>类的构造函数调用<code class="fe me mf mg mh b">createObjectInputStream()</code>方法来获取元数据的反序列化器。</li><li id="1957" class="ms mt it js b jt nb jx nc kb nd kf ne kj nf kn mx my mz na bi translated">默认情况下，白名单只包含来自<code class="fe me mf mg mh b">org.apache.olingo</code>包的类。</li><li id="47d2" class="ms mt it js b jt nb jx nc kb nd kf ne kj nf kn mx my mz na bi translated">如果用户想要扩展默认的白名单，他可以覆盖<code class="fe me mf mg mh b">getAllowedClasses()</code>方法，让它返回一个允许类的列表。</li></ul><p id="d1a2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">该补丁已在Apache Olingo 4.7.0中发布。</p><h1 id="8f76" class="lb lc it bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">我的应用程序容易受到攻击吗？</h1><p id="778c" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated">当然，并不是所有使用旧版本Apache Olingo的应用程序都容易受到攻击。在使用Apache Olingo的应用程序中，至少需要检查两件事情:</p><ol class=""><li id="1efc" class="ms mt it js b jt ju jx jy kb mu kf mv kj mw kn ng my mz na bi translated">它使用了<code class="fe me mf mg mh b">AbstractService</code>类吗？</li><li id="d73e" class="ms mt it js b jt nb jx nc kb nd kf ne kj nf kn ng my mz na bi translated">有什么方法可以让某些人将恶意数据输入到这个类中？</li></ol><p id="4d5e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">上述问题的答案取决于具体的应用。如果两个答案都是肯定的，那么应用程序很可能是易受攻击的。</p><h1 id="7a07" class="lb lc it bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="8dfa" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated">此问题是应用程序使用默认Java反序列化机制时反序列化漏洞的另一个示例。默认情况下，并非所有使用Apache Olingo的应用程序都容易受到攻击。不过保险起见还是更新库可能更好。</p><h1 id="08f4" class="lb lc it bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">参考</h1><ul class=""><li id="0c1e" class="ms mt it js b jt lz jx ma kb nh kf ni kj nj kn mx my mz na bi translated"><a class="ae ko" href="https://nvd.nist.gov/vuln/detail/CVE-2019-17556" rel="noopener ugc nofollow" target="_blank">CVE-2019–17556</a></li><li id="b4df" class="ms mt it js b jt nb jx nc kb nd kf ne kj nf kn mx my mz na bi translated"><a class="ae ko" href="https://github.com/apache/olingo-odata4/pull/60" rel="noopener ugc nofollow" target="_blank">补丁</a></li><li id="757a" class="ms mt it js b jt nb jx nc kb nd kf ne kj nf kn mx my mz na bi translated"><a class="ae ko" href="https://mail-archives.apache.org/mod_mbox/olingo-user/201912.mbox/%3CCAGSZ4d4vbSYaVh3aUWAvcVHK2qcFxxCZd3WAx3xbwZXskPX8nw%40mail.gmail.com%3E" rel="noopener ugc nofollow" target="_blank">阿帕奇安全顾问</a></li><li id="0340" class="ms mt it js b jt nb jx nc kb nd kf ne kj nf kn mx my mz na bi translated"><a class="ae ko" href="https://olingo.apache.org/" rel="noopener ugc nofollow" target="_blank">阿帕奇奥林戈</a></li><li id="96b3" class="ms mt it js b jt nb jx nc kb nd kf ne kj nf kn mx my mz na bi translated"><a class="ae ko" href="https://openjdk.java.net/jeps/290" rel="noopener ugc nofollow" target="_blank"> JEP 290 </a></li></ul></div><div class="ab cl nk nl hx nm" role="separator"><span class="nn bw bk no np nq"/><span class="nn bw bk no np nq"/><span class="nn bw bk no np"/></div><div class="im in io ip iq"><p id="5f41" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="nr">原载于2019年12月21日</em><a class="ae ko" href="https://blog.gypsyengineer.com/en/security/cve-2019-17556-unsafe-deserialization-in-apache-olingo.html" rel="noopener ugc nofollow" target="_blank"><em class="nr">https://blog.gypsyengineer.com</em></a><em class="nr">。</em></p></div><div class="ab cl nk nl hx nm" role="separator"><span class="nn bw bk no np nq"/><span class="nn bw bk no np nq"/><span class="nn bw bk no np"/></div><div class="im in io ip iq"><p id="b543" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="nr">关注</em> <a class="ae ko" href="https://medium.com/bugbountywriteup" rel="noopener"> <em class="nr"> Infosec报道</em> </a> <em class="nr">获取更多此类精彩报道。</em></p><div class="ns nt gp gr nu nv"><a href="https://medium.com/bugbountywriteup" rel="noopener follow" target="_blank"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd iu gy z fp oa fr fs ob fu fw is bi translated">信息安全报道</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">收集了世界上最好的黑客的文章，主题从bug奖金和CTF到vulnhub…</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">medium.com</p></div></div><div class="oe l"><div class="of l og oh oi oe oj kz nv"/></div></div></a></div></div></div>    
</body>
</html>