<html>
<head>
<title>Linux Hardening techniques</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Linux加固技术</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/linux-hardening-techniques-802b12bebcae?source=collection_archive---------1-----------------------#2022-06-04">https://infosecwriteups.com/linux-hardening-techniques-802b12bebcae?source=collection_archive---------1-----------------------#2022-06-04</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/75454393e63969f02305e2de0ac84349.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Osq2YkbhVyeraqQC"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">由<a class="ae kf" href="https://unsplash.com/@lukash?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Lukas </a>在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</figcaption></figure><h1 id="b770" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">介绍</h1><p id="8f51" class="pw-post-body-paragraph le lf it lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">这是Linux强化系列的第四篇博文，在这篇博文中，我们学习并讨论了如何保护我们的Linux服务器，这些服务器已经被部署来托管我们在互联网上的应用程序或网站。之前的博文可以在<a class="ae kf" href="https://securitylit.medium.com/securing-your-linux-servers-part-3-23a711a701a7" rel="noopener">这里</a>，这里<a class="ae kf" href="https://medium.com/codex/securing-your-linux-server-part-ii-48e45c581931" rel="noopener">这里</a>，这里<a class="ae kf" href="https://medium.com/codex/securing-your-linux-server-with-these-best-practices-50b30e026bd" rel="noopener">这里</a>找到。</p><p id="4f42" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">在这篇博文中，我们将详细介绍一些你可能没有意识到的东西，并检查这些东西是否被正确安装，或者是否需要相应地删除。</p><h1 id="b92a" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated"><strong class="ak">禁用不需要的服务</strong></h1><p id="a3cc" class="pw-post-body-paragraph le lf it lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">在我们谈论这个之前，让我们先了解一下运行级别。运行级别是Linux操作系统中的运行模式。运行级别本质上与预设是一样的。运行级别用于确定加载操作系统后允许哪些应用程序运行。<em class="mh">共有7个运行级别(从0到6) </em>，均用于不同的目的，例如，如果您想要托管服务器或运行简单的操作系统，您可以根据使用情况选择运行级别。通常，在服务器环境中，您需要寻找<strong class="lg iu">运行级别3 </strong>。</p><p id="01e9" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">您必须删除不需要的包，因为它们会增加攻击面，手动更新它们会带来很多麻烦。此外，跟踪所有已安装的软件包可能不可行，如果在服务器上安装并运行的特定软件包上发现0天，这可能会导致危害。</p><p id="b857" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">要检查已安装的软件包，</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="9f00" class="mr kh it mn b gy ms mt l mu mv">/sbin/chkconfig --list |grep '3:on'</span></pre><p id="08b0" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">一旦您发现了需要删除的服务/包，请使用下面提到的命令:</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="5e75" class="mr kh it mn b gy ms mt l mu mv">service serviceName stop<br/>chkconfig serviceName off</span></pre><p id="452c" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">要删除这些包，您需要检查哪个包管理器用于安装它们。</p><p id="4dcc" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">它通常是三者之一</p><ol class=""><li id="dfd8" class="mw mx it lg b lh mc ll md lp my lt mz lx na mb nb nc nd ne bi translated">容易得到</li><li id="2d8f" class="mw mx it lg b lh nf ll ng lp nh lt ni lx nj mb nb nc nd ne bi translated">妙的</li><li id="a225" class="mw mx it lg b lh nf ll ng lp nh lt ni lx nj mb nb nc nd ne bi translated">突然的</li></ol><p id="43f0" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated"><strong class="lg iu">使用apt-get卸载软件包</strong></p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="fc75" class="mr kh it mn b gy ms mt l mu mv">sudo apt-get remove package-name</span></pre><p id="3d94" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated"><strong class="lg iu">使用yum卸载软件包</strong></p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="f751" class="mr kh it mn b gy ms mt l mu mv">yum –y remove package-name</span></pre><p id="0508" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated"><strong class="lg iu">使用snap卸载软件包</strong></p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="2753" class="mr kh it mn b gy ms mt l mu mv">sudo snap remove package-name</span></pre><h1 id="8c99" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated"><strong class="ak">登录失败后锁定用户账户</strong></h1><figure class="mi mj mk ml gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nk"><img src="../Images/5f9228c1eb1d1b01c15cf5fd0b5fb67d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZfTWMECRfsoV3KM1sbAodg.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated"><a class="ae kf" href="https://www.tecmint.com/find-failed-ssh-login-attempts-in-linux/" rel="noopener ugc nofollow" target="_blank">来源</a></figcaption></figure><p id="c58b" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">如果用户帐户没有启用任何速率限制功能，对手就有可能对用户帐户进行暴力攻击。因此，强烈建议在特定次数的不成功登录尝试后，对用户帐户应用速率限制。</p><p id="8451" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">我们会用两种方法来讨论这个问题。第一种是手动的，另一种是自动的。</p><p id="00d8" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated"><strong class="lg iu">故障日志</strong></p><p id="b065" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">我们将使用faillog从日志文件中获取失败日志。这是一个将显示失败日志数据库内容的命令，该数据库是/var/log/faillog。</p><p id="be04" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">当<strong class="lg iu">失败日志</strong>在没有参数的情况下执行时，它只显示登录失败的用户的失败日志记录。</p><p id="36af" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">一旦您知道哪个帐户有多次失败的登录尝试，您可以使用passwd实用程序锁定它。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="a296" class="mr kh it mn b gy ms mt l mu mv">passwd –l username</span></pre><p id="641e" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">这里-l代表锁定帐户。</p><p id="bb90" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">要解锁帐户，您也可以尝试passwd和faillog</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="2670" class="mr kh it mn b gy ms mt l mu mv">passwd –u username<br/>faillog –u –r username</span></pre><p id="16df" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated"><strong class="lg iu"> Fail2ban </strong></p><figure class="mi mj mk ml gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nl"><img src="../Images/41d4f726cee66c31a1eb9154ec341043.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aCDUtokB1lp9_MSmL4Uteg.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated"><a class="ae kf" href="https://linuxhint.com/whitelist-ip-address-fail2ban/" rel="noopener ugc nofollow" target="_blank">来源</a></figcaption></figure><p id="09db" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">Fail2ban是一个入侵防御框架，提供了很多功能。这个工具被用来保护计算机服务器免受暴力攻击。Fail2ban对日志文件(如/var/log/apache/error log)进行分析，然后禁止表现出恶意行为症状的IP地址，如过多的失败登录尝试或搜索漏洞。</p><p id="52f9" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">然后利用Fail2Ban修改防火墙规则，以便在预定的时间内拒绝IP地址；然而，也可以定义任何任意的其他动作(例如发送电子邮件)。</p><p id="27cf" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">Fail2Ban预配置了针对各种不同服务(apache、courier、ssh等)定制的过滤器。</p><p id="c0c0" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">要安装和初始化fail2ban，请执行以下命令:</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="d67c" class="mr kh it mn b gy ms mt l mu mv"><strong class="mn iu"># To install fail2ban</strong></span><span id="23fe" class="mr kh it mn b gy nm mt l mu mv">sudo apt install fail2ban</span><span id="964d" class="mr kh it mn b gy nm mt l mu mv"><strong class="mn iu"># Create a jail.local filne in /etc/fail2ban directory</strong></span><span id="35ff" class="mr kh it mn b gy nm mt l mu mv">sudo nano /etc/fail2ban/jail.local</span><span id="79a2" class="mr kh it mn b gy nm mt l mu mv"><strong class="mn iu"># Type in the following in the file.</strong></span><span id="6f1a" class="mr kh it mn b gy nm mt l mu mv">[sshd]</span><span id="7b74" class="mr kh it mn b gy nm mt l mu mv">enabled = true</span><span id="fcc2" class="mr kh it mn b gy nm mt l mu mv">banaction = iptables-multiport</span><span id="ff5c" class="mr kh it mn b gy nm mt l mu mv">maxretry = 10</span><span id="32f6" class="mr kh it mn b gy nm mt l mu mv">findtime = 43200</span><span id="3e3f" class="mr kh it mn b gy nm mt l mu mv">bantime = 86400</span></pre><p id="dc4b" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">我们来理解一下上面几行是什么意思。</p><p id="38ff" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">如果来自特定IP地址的用户在12小时(43200秒)内尝试进行10次失败的登录尝试，则该IP地址将被禁止一天(86400秒)</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="7caa" class="mr kh it mn b gy ms mt l mu mv"><strong class="mn iu"># Enable and Restart fail2ban</strong></span><span id="4028" class="mr kh it mn b gy nm mt l mu mv">sudo systemctl enable fail2ban</span><span id="6b6f" class="mr kh it mn b gy nm mt l mu mv">sudo systemctl restart fail2ban</span></pre><h1 id="e6a5" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated"><strong class="ak">检查监听端口号</strong></h1><p id="4217" class="pw-post-body-paragraph le lf it lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">如果我们在同一个服务器上运行多个服务，可能很难跟踪它们。我们可能经常忘记禁用该服务，但它仍然暴露在端口上，并允许连接到您的服务器。可能已经进入您的服务器的攻击者也可能已经安装了一个bind shell，该shell可能正在侦听特定的端口。要检查所有活动的端口以及服务器正在监听的端口，请执行以下操作:</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="3e9f" class="mr kh it mn b gy ms mt l mu mv">netstat –tulpn</span></pre><p id="3a3d" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">您必须识别这些端口上运行的服务，然后您可以使用ufw(防火墙)禁用它们</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="2bc3" class="mr kh it mn b gy ms mt l mu mv">sudo ufw deny PORT-NUMBER</span></pre><h1 id="023c" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated"><strong class="ak">禁用不需要的SUID和SGID二进制文件</strong></h1><p id="3e48" class="pw-post-body-paragraph le lf it lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">使用SUID或SGID位设置的二进制文件可以在执行时为用户提供提升的权限。这可能导致整个Linux服务器受损，因为二进制文件可能以root权限运行。</p><p id="a024" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">要检查设置了SUID位的所有二进制文件:</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="ca43" class="mr kh it mn b gy ms mt l mu mv">find / -type f  \( -perm -4000 -o -perm -2000 \) 2&gt;/dev/null</span></pre><p id="4273" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">如果您可能错误地为任何二进制文件设置了SUID/SGID位，这也很有用。然后，您可以相应地更改权限。</p><p id="6bb2" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">注意:有些文件需要设置SUID或SGID位才能正常工作。在禁用任何二进制文件上的SUID或SGID位之前，请进行适当的研究。</p><h1 id="7b9d" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated"><strong class="ak">避免使用FTP、Telnet、rsh或rlogin </strong></h1><p id="d111" class="pw-post-body-paragraph le lf it lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">虽然FTP和telnet(在一定程度上)今天仍在使用，但rsh和rlogin是遗留的程序/服务。应该避免它们。这些是纯文本协议，网络中的任何人都可以嗅探您的流量以读取明文数据通信。</p><p id="cc67" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">相反，您必须使用OpenSSH、SFTP或FTPS (FTP over SSL)来加密数据通信。</p><p id="5060" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">要通过互联网将数据从一台电脑传输到另一台电脑，您可以使用scp、rsync、ssh。FTP和telnet是某种不安全的协议，因为FTP以明文形式发送数据，因此不能用于通过它发送敏感文件。总是建议使用SSH和公共私有密钥对来访问和转发敏感信息。</p><h1 id="8a74" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated"><strong class="ak">结论</strong></h1><p id="8ac2" class="pw-post-body-paragraph le lf it lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">在这篇博客文章中，我们探讨了一些检测系统上运行和安装的服务和软件包的方法，以及如何停止和卸载它们。我们学习了如何检查他们正在监听的服务和端口，以及如何关闭端口，然后使用faillog、passwd和fail2ban锁定用户帐户。总是建议采用最好的安全措施来确保安全，并在不安全的协议上使用SSH、SFTP或FTPS等协议。</p></div></div>    
</body>
</html>