<html>
<head>
<title>Story of a weird CSRF bug</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">一只奇怪的CSRF虫子的故事</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/story-of-a-weird-csrf-bug-bde1129c106e?source=collection_archive---------1-----------------------#2021-12-29">https://infosecwriteups.com/story-of-a-weird-csrf-bug-bde1129c106e?source=collection_archive---------1-----------------------#2021-12-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="9d71" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">嘿，大家好，</p><p id="e969" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">几个月前，我发现一个上传端点容易受到csrf的攻击，但是当我开始为它创建poc时。我意识到这并不像看起来那么简单。</p><p id="9c76" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是一个<strong class="jp ir">黑客程序</strong>,我向他们要求披露许可，但没有得到任何回应，所以我将把目标称为redacted.com</p><p id="c110" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">关于该应用程序的一些细节，这是一个投标网站，用户需要上传验证文件，如(<em class="kl">驾驶执照，护照等</em>)以访问该网站的投标部分。</p><p id="8bd5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在验证文档上传端点中对此进行了更深入的研究，我注意到它只能提交一次，这意味着一旦您上传了文档，您就不能再对其进行任何更改。然后由工作人员进行人工验证。</p><p id="e91c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是用户上传验证文档时提出的请求:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/a48069005cb5e213357bab05030e3cc5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ADHKumNZiCbO8tkdco262w.png"/></div></div></figure><p id="9816" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这听起来很耳熟，对吗？</p><p id="9835" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个请求中没有<code class="fe ky kz la lb b">csrf token</code>，这意味着它可能容易受到csrf的攻击。我很快使用fetch方法为它创建了一个csrf poc。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="lc ld l"/></div></figure><p id="9fec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当我在浏览器中打开这个html文件时，请求的响应是<strong class="jp ir"> <em class="kl"> 403禁止</em> </strong>。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi le"><img src="../Images/004e0a580ccdc66e190ff30c648c3b49.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2_of11-i-tsYB1lA4ALDTA.png"/></div></div></figure><p id="ad62" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">后来我意识到这是因为原产地检查。在请求截图中，您可以看到Origin头值设置为<code class="fe ky kz la lb b"><a class="ae lf" href="https://www.redacted.com," rel="noopener ugc nofollow" target="_blank">https://www.redacted.com</a></code>，假设我的csrf poc url托管在attacker.com域上。</p><p id="c0c3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">例如<code class="fe ky kz la lb b"><a class="ae lf" href="http://www.attacker.com/csrf.html" rel="noopener ugc nofollow" target="_blank">https://www.attacker.com/csrf.html</a></code>,那么当发出获取请求时，原始报头值应该是<code class="fe ky kz la lb b"><a class="ae lf" href="http://www.attacker.com/csrf.html" rel="noopener ugc nofollow" target="_blank">https://www.attacker.com</a></code>。</p><p id="2f24" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">由于<code class="fe ky kz la lb b"><a class="ae lf" href="http://www.attacker.com/csrf.html" rel="noopener ugc nofollow" target="_blank">https://www.attacker.com</a></code>与<code class="fe ky kz la lb b"><a class="ae lf" href="https://www.redacted.com," rel="noopener ugc nofollow" target="_blank">https://www.redacted.com</a></code>不匹配，所以<strong class="jp ir"> <em class="kl">原点检查</em> </strong>失败，这也是服务器返回<strong class="jp ir"> <em class="kl"> 403禁止错误</em> </strong>的原因。</p><p id="ffe4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后在<em class="kl">原点头</em>里尝试了一些类似<code class="fe ky kz la lb b">redacted.commxyz</code>、<code class="fe ky kz la lb b">redacted.com.xyz</code>、<code class="fe ky kz la lb b">xyz.redacted.com</code>的变体，但是都不行。有时开发人员会在<em class="kl">正则表达式</em>中犯一些错误，比如他们忘记对点字符进行转义，等等。在这些情况下，可以通过使用这样的变化来绕过它。</p><p id="e280" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后我从请求中完全删除了<em class="kl"> Origin </em>头，并转发请求，注意到它工作了<strong class="jp ir"><em class="kl">200 ok response</em></strong>，文件成功上传。</p><p id="da7a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果请求中没有<em class="kl"> Origin </em> header，应用程序不会对其进行验证，这类似于存在<strong class="jp ir"><em class="kl">Referer</em></strong>check的情况，因此您使用了内容属性设置为<code class="fe ky kz la lb b">no-referrer</code>的meta标记</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi lg"><img src="../Images/bfb6bc4de83d6a3d27b291d42dbfaf74.png" data-original-src="https://miro.medium.com/v2/resize:fit:1118/format:webp/1*HgoQu-YaAmgnGX6_Pcx6Xw.png"/></div></figure><p id="00bd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以我开始寻找是否有什么方法可以让我在请求中不发送<em class="kl"> Origin </em>报头的情况下发出请求。我发现了这条微博</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="lh ld l"/></div></figure><p id="2706" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当我尝试这样做时，它成功了。发送的请求没有<em class="kl">源</em>报头。但是只有当我在一个带有<em class="kl">数据</em>协议的<em class="kl"> iframe </em>中使用<strong class="jp ir"> <em class="kl">表单</em>方法</strong>时，才会起作用，在<em class="kl"> fetch </em>和其他类似的相关方法的情况下，总是会发送<em class="kl"> Origin </em>头。</p><p id="42b7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们克服了一个问题，那就是<em class="kl">原点</em>割台，现在还有一个问题要处理。由于我们受困于<strong class="jp ir"> <em class="kl">表单</em> </strong>方法，我们实际上无法实现无交互的csrf poc。</p><p id="1f52" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您再次查看易受攻击的请求:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="lc ld l"/></div></figure><p id="b08f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">看第12行，有一个<em class="kl">文件名</em>参数，然后我们有<em class="kl">图像</em>数据。问题是我们实际上不能在csrf poc中自己包含<em class="kl">文件名</em>参数和图像数据。</p><p id="0c54" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因为它们仅在使用<em class="kl">文件上传输入</em>时包含。你可以阅读这篇文章了解更多信息:</p><div class="li lj gp gr lk ll"><a href="http://aetherlab.net/2013/04/here-it-is-the-file-upload-csrf/" rel="noopener  ugc nofollow" target="_blank"><div class="lm ab fo"><div class="ln ab lo cl cj lp"><h2 class="bd ir gy z fp lq fr fs lr fu fw ip bi translated">这就是，上传CSRF的文件</h2><div class="ls l"><h3 class="bd b gy z fp lq fr fs lr fu fw dk translated">编辑描述</h3></div><div class="lt l"><p class="bd b dl z fp lq fr fs lr fu fw dk translated">aetherlab.net</p></div></div></div></a></div><p id="80f6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当前的概念验证与此类似:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi lu"><img src="../Images/57e72c908c333cf318f7eece84e161e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VPD8mzAHRLlnLIeWdCB2Pw.png"/></div></div></figure><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi lv"><img src="../Images/a6a96f24f5305f97308fcc0d5a57388a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*zPgdlyfxGi2lLm2_gxXElA.gif"/></div></div></figure><p id="c0ee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如你在这张gif中看到的，要利用这个<em class="kl"> csrf漏洞</em>，我们必须告诉受害者点击上传按钮，然后从他们的系统中选择一个文件。</p><p id="c865" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">由于需要用户交互，这使得受害者按照我们的要求上传文件变得非常不现实。</p><p id="15fd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这时，我想起看了一个<strong class="jp ir"> Liveoverflow </strong>的视频，他在视频中谈到了在10万美元黑客奖比赛期间在谷歌云平台(GCP)发现的漏洞。</p><p id="97ff" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请确保在继续之前完整地观看这段视频，因为<strong class="jp ir"> Liveoverflow </strong>已经在这里做了很好的解释:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="lw ld l"/></div></figure><p id="6d23" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在此事件中提交的一个错误是:</p><div class="li lj gp gr lk ll"><a href="https://obmiblog.blogspot.com/2019/12/gcp-5k-file-uploading-csrf.html?m=1" rel="noopener  ugc nofollow" target="_blank"><div class="lm ab fo"><div class="ln ab lo cl cj lp"><h2 class="bd ir gy z fp lq fr fs lr fu fw ip bi translated">[GCP]在谷歌云外壳编辑器中上传CSRF的文件</h2><div class="ls l"><h3 class="bd b gy z fp lq fr fs lr fu fw dk translated">谷歌云壳是一个谷歌云平台的交互式外壳环境，使学习和实验…</h3></div><div class="lt l"><p class="bd b dl z fp lq fr fs lr fu fw dk translated">obmiblog.blogspot.com</p></div></div></div></a></div><p id="3a4e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这篇博客中，研究人员<a class="ae lf" href="https://bughunter.withgoogle.com/profile/40997bbc-945a-4eca-8408-eed302641c96" rel="noopener ugc nofollow" target="_blank"> @obmihail </a>连同<em class="kl"> csrf bug </em>细节，也分享了关于在<em class="kl">多部分请求解析</em>中发现的一个bug的细节，该bug允许他上传任何带有自己内容的文件，这在html表单中是不可能的。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi lx"><img src="../Images/607e7980535bd024a34b3960fc0266df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WexuumPtdTYtxkqGVobKAQ.png"/></div></div></figure><p id="8541" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">提交上述表格后，将发送以下请求正文:</p><pre class="kn ko kp kq gt ly lb lz ma aw mb bi"><span id="4a65" class="mc md iq lb b gy me mf l mg mh">-----------------------------37419614939920406503637463242<br/>Content-Disposition: form-data; name="target"</span><span id="f232" class="mc md iq lb b gy mi mf l mg mh">file:///home/userhome/folder<br/>-----------------------------37419614939920406503637463242<br/>Content-Disposition: form-data; name="upload; filename=the_filename; x"</span><span id="509a" class="mc md iq lb b gy mi mf l mg mh">the content of file<br/>-----------------------------37419614939920406503637463242--</span></pre><p id="d422" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用这个多部分请求解析bug，我可以很容易地克服我之前提到的问题，因为我现在可以完全控制文件内容:</p><p id="c128" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe ky kz la lb b">&gt;To exploit this csrf vulnerability we have to tell the victim to click on the upload button, and then choose a file from their system.</code></p><p id="da5a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我现在可以在没有任何用户交互的情况下执行csrf攻击。</p><p id="138e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是最终的CSRF概念验证:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi mj"><img src="../Images/048042c15d61981ad980f01b6d56c710.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pJiZBR-P96MJfXqkuPP9qw.png"/></div></div></figure><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="lc ld l"/></div><figcaption class="mk ml gj gh gi mm mn bd b be z dk translated">Based64解码部分</figcaption></figure><p id="438c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">更侧重于名称属性:<code class="fe ky kz la lb b">name=’\”;name=file;filename=d0B5jW1O_400x400.png;x’</code>，这个技巧允许我上传任何伪造的文件，而不依赖于受害者上传任何文件，一个图像文件自动得到上传，无需任何用户交互</p><p id="55dd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我在验证了最终的概念验证确实有效并被标记为重复后提交了报告:(</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi mo"><img src="../Images/2dd9a836ae66c35275c6c04b39529d31.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9CfRC2OApMpxpFEryFwrQg.png"/></div></div></figure><p id="7f7b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我被邀请参加该报告，所以我研究了一下，发现有人已经报告了这个问题，但他无法在没有用户交互的情况下提供csrf poc，而且为了克服<code class="fe ky kz la lb b">Origin</code>验证，他演示了一个仅在Mozilla Firefox的非常低版本中工作的poc，同时它要求受害者上传一个文档以使poc工作。他的报告以信息量大而告终，因为它需要太多的用户交互。</p><p id="b8df" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是我的poc不需要任何用户交互，也能在最新版本的Firefox中工作。我向<em class="kl">评审员</em>解释了我的报告与<em class="kl">原始报告</em>的不同之处</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi mp"><img src="../Images/bde641c900feadd83ec657a405a27e70.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qGHMgHR399hDgG3JK1Rzuw.png"/></div></div></figure><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi mq"><img src="../Images/674d26905af277c7999dc651a88ab3e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ehaKn2XbyDlFb-LscK__VA.png"/></div></div></figure><p id="19c5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">那段时间<strong class="jp ir"> <em class="kl">火狐84.0.2 </em> </strong>是最新版本。然后，评审员将报告细节转发给团队</p><p id="8726" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">团队承认了这个问题，并发现它确实不同于重复的报告，该报告被分类并奖励为一个<code class="fe ky kz la lb b">Medium</code>严重性错误，这将允许我代表用户提交虚假的验证文档。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi mr"><img src="../Images/6e95427e1cf452f940190fdd80347e62.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OZ3e2RFhOTxDel77A2JT7A.png"/></div></div></figure><p id="77e9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">由于验证文件只能提交一次，由于伪造的文件，受害者的帐户将不会得到验证。他必须创造一个新的。攻击面仅限于Firefox用户和新创建的acc，他们没有提交任何验证文件，这就是为什么严重性被降低到<code class="fe ky kz la lb b">Medium</code>。</p><p id="13fd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在创建poc的过程中，我学到了很多东西，因此这对我来说是一个双赢的局面。</p><p id="b9ed" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我将在今年年底发表另一篇文章，敬请关注:)</p><p id="4815" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">大家好</p></div></div>    
</body>
</html>