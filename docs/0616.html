<html>
<head>
<title>How I leveraged an interesting CSRF vulnerability to turn self XSS into a persistent attack?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我是如何利用一个有趣的CSRF漏洞将赛尔夫·XSS变成持续攻击的？</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/how-i-leveraged-an-interesting-csrf-vulnerability-to-turn-self-xss-into-a-persistent-attack-b780824042d2?source=collection_archive---------0-----------------------#2020-06-01">https://infosecwriteups.com/how-i-leveraged-an-interesting-csrf-vulnerability-to-turn-self-xss-into-a-persistent-attack-b780824042d2?source=collection_archive---------0-----------------------#2020-06-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="190f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">大家好，今天我将讲述我如何利用一个有趣的CSRF漏洞将赛尔夫XSS变成一个持续攻击。</p><p id="8a84" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在试图寻找这个应用程序的缺陷时，我登陆了编辑个人资料页面。我测试了name字段中的XSS，发现应用程序正在对尖括号进行编码。</p><p id="b71b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是name参数也反映了同一个页面上的JS上下文，所以我尝试这样做。</p><pre class="kl km kn ko gt kp kq kr ks aw kt bi"><span id="09f5" class="ku kv iq kq b gy kw kx l ky kz">Akash'-alert()-</span></pre><p id="f8b6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这将在不破坏上下文的情况下连接alert方法。</p><figure class="kl km kn ko gt lb gh gi paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="gh gi la"><img src="../Images/709b231b5639462250130db487ce28a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EuvSOS6vNhB5j-fcNV4fkg.png"/></div></div></figure><p id="d214" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">而且成功了。</p><p id="9890" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但这只是一个无害的自我XSS漏洞，对不对？嗯，有一个邀请其他用户加入项目的功能。如果攻击者邀请某人参加他的项目，应用程序将发送一封电子邮件，提及邀请并提供项目链接。即使那个人决定忽略加入请求，他仍然会看到攻击者的姓名和电子邮件。</p><p id="7b9f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，这个想法是在一个帐户的名称字段中注入一个有效载荷，然后邀请受害者加入这个项目。当他搜索邀请他的人时，他的帐户中会触发XSS有效载荷，攻击者最终会通过向他控制的服务器发送cookies或通过编程更改他帐户的电子邮件来接管他的帐户。</p><p id="d001" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我继续将此付诸实践，但结果是名称字段仅在攻击者的配置文件中易受攻击。在受害者端，应用程序安全地显示攻击者的名字，所以攻击者没有办法接管一个帐户，除非他发现并链接到另一个漏洞。</p><p id="63d7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我真的想升级这个问题，所以我想检查应用程序是否容易受到登录和注销CSRF攻击。这个想法是将两个漏洞链接在一起，让受害者注销他的帐户，然后让他登录攻击者的帐户。一旦攻击者的账户登录，XSS就会触发。</p><p id="32b7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我继续测试CSRF漏洞。注销端点易受攻击，但我无法将其用于登录端点。经过仔细观察，我意识到令牌是在cookies和POST请求正文中发送的。根据我以前的知识，我知道有时候开发人员会忘记同步两个令牌。我检查了它们是否同步。幸运的是，他们没有，但我仍然不能利用它，因为应用程序期望令牌是一个实际的(有效的)令牌。</p><p id="ce41" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">同样，根据我以前的知识，我知道有时应用程序有一个全局令牌池，并且会接受任何有效的令牌。简而言之，这意味着任何用户的令牌都可以用来策划一次成功的CSRF攻击。我想到的第一件事是检查未经身份验证的(用户没有登录任何帐户的阶段)用户的令牌是否有效以及它是否工作。</p><p id="8191" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">考虑到这一点，我编写了一个PoC代码，其中<em class="li"> img </em> tag会向注销端点发送一个GET请求，注销端点会将用户从其帐户中注销，然后使用JS，登录表单会自动提交攻击者的凭据。一旦攻击者的帐户登录XSS有效载荷将触发，我们将成功地将两个漏洞链接在一起，以创造更大的影响。</p><pre class="kl km kn ko gt kp kq kr ks aw kt bi"><span id="214d" class="ku kv iq kq b gy kw kx l ky kz">&lt;!DOCTYPE html&gt;<br/>&lt;html&gt;<br/>&lt;head&gt;<br/>    &lt;title&gt;PoC&lt;/title&gt;<br/>&lt;/head&gt;<br/>&lt;body&gt;<br/>&lt;img src="https://redacted.com/logout"&gt;<br/>&lt;form method="POST" id="csrfForm" action=LOGIN-ENDPOINT&gt;<br/>    &lt;input type="hidden" name="csrf" value=OLD-CSRF&gt;<br/>    &lt;input type="hidden" name="email" value=ATTACKER-EMAIL&gt;<br/>    &lt;input type="hidden" name="password" value="ATTACKER-PASSWORD&gt;<br/>    &lt;input type="submit" value="Submit"&gt;<br/>&lt;/form&gt;<br/>&lt;script type="text/javascript"&gt;<br/>    document.getElementById("csrfForm").submit()<br/>&lt;/script&gt;<br/>&lt;/body&gt;<br/>&lt;/html&gt;</span></pre><p id="f74e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我希望你喜欢读这篇文章。如有任何问题，欢迎联系<a class="ae lj" href="http://twitter.com/0xAkash" rel="noopener ugc nofollow" target="_blank"> @0xAkash </a>。你也可以在twitter上关注我，我会继续发布这些有趣的文章。</p></div></div>    
</body>
</html>