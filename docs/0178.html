<html>
<head>
<title>Configuring security for REST API in Spring</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Spring中为REST API配置安全性</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/tips-about-configuring-security-for-rest-api-in-spring-d5775e0eaa8c?source=collection_archive---------1-----------------------#2018-10-10">https://infosecwriteups.com/tips-about-configuring-security-for-rest-api-in-spring-d5775e0eaa8c?source=collection_archive---------1-----------------------#2018-10-10</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="446d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在大多数情况下，REST APIs应该只由授权方访问。Spring framework提供了许多为应用程序配置身份验证和授权的方法。另一个好处是框架通常提供相对较好的默认设置。但是尽管如此，理解发生了什么可能比依赖默认值更好。</p><p id="85d4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这篇文章列出了在配置或检查基于Spring (boot)框架的RESTful应用程序的认证和授权设置时需要注意的一些事情。然而，这并不是一个全面的指导方针(如果存在这样的指导方针的话),它告诉我们如何为基于Spring framework的应用程序配置身份验证和授权。它更像是一个技巧和建议的集合。此外，我们非常欢迎任何其他建议和意见。</p><h1 id="a223" class="ko kp it bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">考虑使用OAuth2或JWT</h1><p id="e2c5" class="pw-post-body-paragraph jq jr it js b jt lm jv jw jx ln jz ka kb lo kd ke kf lp kh ki kj lq kl km kn im bi translated">通常只有经过授权的用户或应用程序才能访问RESTful服务。RESTful web应用程序通常不使用HTTP会话。相反，它对每个传入的请求执行访问检查。</p><p id="99d3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">限制访问RESTful应用程序的方法之一是开始使用API键。但是OAuth2或JWT (JSON Web tokens)听起来可能是一个更好的选择。OAuth2和JWT是RFC中描述的认证和授权框架。这些框架允许以比API密钥更灵活的方式配置和控制身份验证和授权过程。但是这样做的代价是额外的基础设施和复杂性。幸运的是，已经有了这些标准的实现，甚至还有提供所有必需基础设施的服务(例如，AWS中的<a class="ae lr" href="https://aws.amazon.com/blogs/aws/built-in-authentication-in-alb/" rel="noopener ugc nofollow" target="_blank">应用负载平衡器支持OAuth2 </a>)。</p><p id="b9e5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">即使应用程序使用OAuth2或JWT，我们也需要确保它正确使用，例如:</p><ul class=""><li id="dcb3" class="ls lt it js b jt ju jx jy kb lu kf lv kj lw kn lx ly lz ma bi translated">应用程序验证每个请求的令牌和访问权限</li><li id="5018" class="ls lt it js b jt mb jx mc kb md kf me kj mf kn lx ly lz ma bi translated">应用程序不公开访问令牌(例如，不应该将任何令牌记录到日志中)</li><li id="3e7e" class="ls lt it js b jt mb jx mc kb md kf me kj mf kn lx ly lz ma bi translated">访问令牌具有正确的生存期</li><li id="e172" class="ls lt it js b jt mb jx mc kb md kf me kj mf kn lx ly lz ma bi translated">等等</li></ul><p id="5d85" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">顺便说一下，<a class="ae lr" href="https://www.owasp.org/index.php/Top_10-2017_A2-Broken_Authentication" rel="noopener ugc nofollow" target="_blank"> OWASP为认证和授权提供了很好的指导方针</a>。</p><h1 id="9436" class="ko kp it bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">强制HTTPS</h1><p id="7e31" class="pw-post-body-paragraph jq jr it js b jt lm jv jw jx ln jz ka kb lo kd ke kf lp kh ki kj lq kl km kn im bi translated">这个建议可以在每一个关于保护web应用程序的指南/文章/书籍/演示中找到。使用TLS非常重要，尤其是当应用程序使用OAuth2(或API密钥)进行身份验证时，因为该协议明确依赖TLS来提供机密性和完整性。你可以考虑使用<a class="ae lr" href="https://blog.gypsyengineer.com/en/security/how-does-tls-1-3-protect-against-downgrade-attacks.html" rel="noopener ugc nofollow" target="_blank"> TLS 1.3，它提供了更好的针对降级攻击的保护</a>，更好的密码套件等等。<a class="ae lr" href="https://blog.gypsyengineer.com/en/security/whats-new-security-features-in-java-11.html" rel="noopener ugc nofollow" target="_blank">Java 11</a>增加了对TLS 1.3的支持。</p><p id="5228" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">春天可以用<code class="fe mg mh mi mj b">requiresSecure()</code>的方法。不要忘记启用<a class="ae lr" href="https://docs.spring.io/spring-security/site/docs/4.2.5.RELEASE/apidocs/org/springframework/security/config/annotation/web/configurers/HeadersConfigurer.html#httpStrictTransportSecurity--" rel="noopener ugc nofollow" target="_blank"> HSTS割台</a>。这里有一个例子:</p><figure class="mk ml mm mn gt mo"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="64a4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">一个应用程序可能只支持普通HTTP，并位于提供TLS的反向代理之后。在这种情况下，确保反向代理配置为使用HTTPS和HSTS报头。代理应该拒绝普通的HTTP连接，或者总是重定向到HTTPS。</p><h1 id="9cd1" class="ko kp it bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">配置会话管理</h1><p id="fc5b" class="pw-post-body-paragraph jq jr it js b jt lm jv jw jx ln jz ka kb lo kd ke kf lp kh ki kj lq kl km kn im bi translated">Spring框架提供了一种建立HTTP会话的机制。如果RESTful服务对每个请求进行认证(大多数情况下都是这样)，那么它不需要任何会话管理机制。在这种情况下，最好指示Spring framework不要创建任何会话:</p><figure class="mk ml mm mn gt mo"><div class="bz fp l di"><div class="mp mq l"/></div></figure><h1 id="a0d1" class="ko kp it bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">禁用登录和注销页面</h1><p id="eeb8" class="pw-post-body-paragraph jq jr it js b jt lm jv jw jx ln jz ka kb lo kd ke kf lp kh ki kj lq kl km kn im bi translated">Spring framework提供了现成的登录表单和注销页面。这对于使用GUI的web应用程序可能很有用，但是RESTful应用程序很可能不需要这些页面。如果应用程序使用OAuth2、JWT或API令牌进行访问控制，肯定会出现这种情况。然后，禁用应用程序的这些功能可能是有意义的:</p><figure class="mk ml mm mn gt mo"><div class="bz fp l di"><div class="mp mq l"/></div></figure><h1 id="d305" class="ko kp it bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">禁用基本HTTP身份验证</h1><p id="0bb1" class="pw-post-body-paragraph jq jr it js b jt lm jv jw jx ln jz ka kb lo kd ke kf lp kh ki kj lq kl km kn im bi translated">RESTful应用程序很可能不需要HTTP基本身份验证，因此最好禁用它:</p><figure class="mk ml mm mn gt mo"><div class="bz fp l di"><div class="mp mq l"/></div></figure><h1 id="2b92" class="ko kp it bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">禁用匿名访问</h1><p id="0606" class="pw-post-body-paragraph jq jr it js b jt lm jv jw jx ln jz ka kb lo kd ke kf lp kh ki kj lq kl km kn im bi translated">如果RESTful服务应该只由授权的客户端访问，那么最好禁用匿名访问:</p><figure class="mk ml mm mn gt mo"><div class="bz fp l di"><div class="mp mq l"/></div></figure><h1 id="1f02" class="ko kp it bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">通过HTTP方法授权请求可能会导致问题</h1><p id="708e" class="pw-post-body-paragraph jq jr it js b jt lm jv jw jx ln jz ka kb lo kd ke kf lp kh ki kj lq kl km kn im bi translated"><code class="fe mg mh mi mj b">antMatchets()</code> method允许指定您想要配置访问的HTTP方法。它可能如下所示:</p><figure class="mk ml mm mn gt mo"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="08d2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">根据安全配置的其余部分，这可能会导致一个问题，因为我们在上面的配置中遗漏了HEAD方法。为了避免这样的问题，最好在<code class="fe mg mh mi mj b">antMatchers()</code>中指定API端点，要求所有请求都经过认证，并在最后调用<code class="fe mg mh mi mj b">denyAll()</code>。<code class="fe mg mh mi mj b">authenticated()</code>和<code class="fe mg mh mi mj b">fullyAuthenticated()</code>方法可用于要求对所有请求进行认证。不同的是，最后一个没有考虑到勿忘我功能。顺便说一下，RESTful服务很可能不需要“勿忘我”。安全配置可能是这样的:</p><figure class="mk ml mm mn gt mo"><div class="bz fp l di"><div class="mp mq l"/></div></figure><h1 id="2497" class="ko kp it bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">禁止使用随机密码创建默认用户</h1><p id="30d5" class="pw-post-body-paragraph jq jr it js b jt lm jv jw jx ln jz ka kb lo kd ke kf lp kh ki kj lq kl km kn im bi translated">默认情况下，Spring framework会创建一个带有随机密码的默认用户<code class="fe mg mh mi mj b">user</code>。然后，框架将密码打印到日志中。它看起来像下面这样:</p><pre class="mk ml mm mn gt mr mj ms mt aw mu bi"><span id="32ce" class="mv kp it mj b gy mw mx l my mz">Using default security password: 94251362-f9cc-4c01-95be-121e5b6e1865</span></pre><p id="1a9b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最有可能的是，一个应用程序不需要在生产中使用它，尤其是当它使用OAuth2或JWT时。所以，即使不疼也可能禁用它比较好。在安全配置中覆盖<code class="fe mg mh mi mj b">authenticationManagerBean()</code>方法是有帮助的，尽管这个解决方案看起来有点奇怪(你可以在这里找到更多的细节<a class="ae lr" href="https://stackoverflow.com/a/41856630" rel="noopener ugc nofollow" target="_blank"/>):</p><figure class="mk ml mm mn gt mo"><div class="bz fp l di"><div class="mp mq l"/></div></figure><h1 id="4ce7" class="ko kp it bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">参考</h1><ul class=""><li id="6008" class="ls lt it js b jt lm jx ln kb na kf nb kj nc kn lx ly lz ma bi translated"><a class="ae lr" href="https://spring.io/guides/gs/securing-web/" rel="noopener ugc nofollow" target="_blank">保护网络应用</a></li><li id="3efd" class="ls lt it js b jt mb jx mc kb md kf me kj mf kn lx ly lz ma bi translated"><a class="ae lr" href="https://spring.io/guides/topicals/spring-security-architecture/" rel="noopener ugc nofollow" target="_blank"> Spring安全架构</a></li><li id="7e9b" class="ls lt it js b jt mb jx mc kb md kf me kj mf kn lx ly lz ma bi translated"><a class="ae lr" href="https://www.owasp.org/index.php/REST_Security_Cheat_Sheet" rel="noopener ugc nofollow" target="_blank">休息安全备忘单</a></li></ul></div><div class="ab cl nd ne hx nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="im in io ip iq"><p id="3fcc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="nk">原载于2018年10月10日</em><a class="ae lr" href="https://blog.gypsyengineer.com/en/security/tips-configuring-security-rest-api-spring.html" rel="noopener ugc nofollow" target="_blank"><em class="nk">blog.gypsyengineer.com</em></a><em class="nk">。</em></p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi nl"><img src="../Images/950d9f80f4efa37f04a7d28653ef6f1c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ip7XmSfDmS3B16ADQ8-ZUg.png"/></div></div><figcaption class="ns nt gj gh gi nu nv bd b be z dk translated">来自<a class="ae lr" href="https://spring.io/projects/spring-framework" rel="noopener ugc nofollow" target="_blank">https://spring.io/projects/spring-framework</a></figcaption></figure></div><div class="ab cl nd ne hx nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="im in io ip iq"><p id="8211" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="nk">关注</em> <a class="ae lr" href="https://medium.com/bugbountywriteup" rel="noopener"> <em class="nk"> Infosec报道</em> </a> <em class="nk">获取更多此类精彩报道。</em></p><div class="nw nx gp gr ny nz"><a href="https://medium.com/bugbountywriteup" rel="noopener follow" target="_blank"><div class="oa ab fo"><div class="ob ab oc cl cj od"><h2 class="bd iu gy z fp oe fr fs of fu fw is bi translated">信息安全报道</h2><div class="og l"><h3 class="bd b gy z fp oe fr fs of fu fw dk translated">收集了世界上最好的黑客的文章，主题从bug奖金和CTF到vulnhub…</h3></div><div class="oh l"><p class="bd b dl z fp oe fr fs of fu fw dk translated">medium.com</p></div></div><div class="oi l"><div class="oj l ok ol om oi on nq nz"/></div></div></a></div></div></div>    
</body>
</html>