<html>
<head>
<title>Write-up: File path traversal, validation of file extension with null byte bypass @ PortSwigger Academy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">向上写:文件路径遍历，用空字节旁路验证文件扩展名</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/write-up-file-path-traversal-validation-of-file-extension-with-null-byte-bypass-portswigger-801300e13799?source=collection_archive---------1-----------------------#2022-09-21">https://infosecwriteups.com/write-up-file-path-traversal-validation-of-file-extension-with-null-byte-bypass-portswigger-801300e13799?source=collection_archive---------1-----------------------#2022-09-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/b2c15025fe51211851702d55f4a237c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*2CJKLrH7W9omsUf4.png"/></div></div></figure><p id="5cc4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这篇关于实验室<em class="kw">文件路径遍历、带空字节旁路的文件扩展名验证</em>的文章是我为<a class="ae kx" href="https://portswigger.net/web-security" rel="noopener ugc nofollow" target="_blank"> PortSwigger的Web安全学院</a>编写的演练系列的一部分。</p><p id="7ab7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">学习路径</strong>:服务器端主题→目录遍历</p><div class="ky kz gp gr la lb"><a href="https://portswigger.net/web-security/file-path-traversal/lab-validate-file-extension-null-byte-bypass" rel="noopener  ugc nofollow" target="_blank"><div class="lc ab fo"><div class="ld ab le cl cj lf"><h2 class="bd ir gy z fp lg fr fs lh fu fw ip bi translated">实验:文件路径遍历，绕过空字节验证文件扩展名|网络安全学院</h2><div class="li l"><h3 class="bd b gy z fp lg fr fs lh fu fw dk translated">练习利用现实目标的弱点。记录你从学徒到专家的进步。看哪里…</h3></div><div class="lj l"><p class="bd b dl z fp lg fr fs lh fu fw dk translated">portswigger.net</p></div></div><div class="lk l"><div class="ll l lm ln lo lk lp jw lb"/></div></div></a></div><p id="4f0d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Python脚本:<a class="ae kx" href="https://github.com/frank-leitner/portswigger-websecurity-academy/blob/main/03-directory_traversal/File_path_traversal%2C_validation_of_file_extension_with_null_byte_bypass/script.py" rel="noopener ugc nofollow" target="_blank"> script.py </a></p><h1 id="4f35" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">实验室描述</h1><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div class="gh gi mo"><img src="../Images/b579aca499d940a1fdfed576b93c10a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1308/format:webp/0*HskLzT_cBmR0XNBs.png"/></div></figure><h1 id="8382" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">步伐</h1><p id="fb28" class="pw-post-body-paragraph jy jz iq ka b kb mt kd ke kf mu kh ki kj mv kl km kn mw kp kq kr mx kt ku kv ij bi translated">第一步照例是网站的分析。与前面的路径遍历实验一样，这是一个商店网站。该页面再次将产品图像作为文件名引用，这表明可能存在路径遍历漏洞。这里，文件名作为基本文件名提供:</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div class="gh gi my"><img src="../Images/f6de3d0a4d04246f0cad24a5c60a3854.png" data-original-src="https://miro.medium.com/v2/resize:fit:1104/format:webp/0*FrBCGPBoLE-gT2me.png"/></div><figcaption class="mz na gj gh gi nb nc bd b be z dk translated">图像文件由文件名引用</figcaption></figure><p id="a10a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">下面的评级图使用的是<code class="fe nd ne nf ng b">images</code>目录。猜测产品图像可能在同一目录中，尝试路径遍历序列是否可行:</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nh"><img src="../Images/cb561abc290f880065c4351f65f22b61.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*BFwtemfizc5zFEN7.png"/></div></div><figcaption class="mz na gj gh gi nb nc bd b be z dk translated">测试文件名中的路径遍历顺序</figcaption></figure><p id="8826" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">事实上，我可以退出并返回到图像目录。现在对<code class="fe nd ne nf ng b">rating2.png</code>文件进行同样的尝试:</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ni"><img src="../Images/71f4d7ad4f4f2dabb43a389c9e7d14cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*OjWx40EqTNeEO-SY.png"/></div></div><figcaption class="mz na gj gh gi nb nc bd b be z dk translated">尝试请求具有不同扩展名的另一个图像</figcaption></figure><p id="7e17" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此请求未提供图像。虽然我当然无法知道这两个<code class="fe nd ne nf ng b">images</code>目录实际上是相同的，但是它给出了文件扩展名被检查的指示(忽略我因为实验室名称而知道的事实)。</p><p id="7bf4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这种检查可以通过简单地比较文件名的最后4个字符和字符串文字<code class="fe nd ne nf ng b">.jpg</code>来完成。任何类型的字符串比较都容易受到一个古老问题的影响:字符串的空终止。</p></div><div class="ab cl nj nk hu nl" role="separator"><span class="nm bw bk nn no np"/><span class="nm bw bk nn no np"/><span class="nm bw bk nn no"/></div><div class="ij ik il im in"><h1 id="22ae" class="lq lr iq bd ls lt nq lv lw lx nr lz ma mb ns md me mf nt mh mi mj nu ml mm mn bi translated">一些背景</h1><p id="a237" class="pw-post-body-paragraph jy jz iq ka b kb mt kd ke kf mu kh ki kj mv kl km kn mw kp kq kr mx kt ku kv ij bi translated">许多像操作系统这样的低级软件都是用c语言编写的。在c语言中，字符串被定义为后跟一个空字节(二进制中全零的完整字节，或URLencoding中的%00)的字符序列。没有办法检查字符串的长度，只能遍历它，直到找到一个空字节。</p><p id="8972" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">只要在保留内存区域内找到空字节，就可以找到字符串的长度。例如，如果在10个字符的范围内，内容是<code class="fe nd ne nf ng b">ABCD%00</code>，那么字符串是长度为4的<code class="fe nd ne nf ng b">ABCD</code>。考虑到空字节，使用的内存量总是比可用长度多一个字节。</p><p id="5f79" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这导致了大量的错误和漏洞。如果开发人员没有考虑这一额外的字节，它可能会导致读取或写入保留的空间，从而导致各种不良后果，如应用程序崩溃(最好的情况)或任意代码执行(对攻击者来说最好的情况)。</p><p id="ba60" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">许多低级功能仍然基于C，所以在找到第一个空字节时终止一个字符串。如果系统的所有组件都同意相同的行为，这不会造成问题(除了无效终止的固有问题之外)。</p><p id="5fef" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是如果组件不同地对待字符串，那么这种不同的行为就可以被利用。</p><p id="41d6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">例如，许多更现代的语言有专门的字符串类型，既不要求也不使用空终止。在本例中，我想访问一个文件，因此在某个时候，请求将从应用程序传递到操作系统</p></div><div class="ab cl nj nk hu nl" role="separator"><span class="nm bw bk nn no np"/><span class="nm bw bk nn no np"/><span class="nm bw bk nn no"/></div><div class="ij ik il im in"><h1 id="e516" class="lq lr iq bd ls lt nq lv lw lx nr lz ma mb ns md me mf nt mh mi mj nu ml mm mn bi translated">恶意负载</h1><p id="3ee1" class="pw-post-body-paragraph jy jz iq ka b kb mt kd ke kf mu kh ki kj mv kl km kn mw kp kq kr mx kt ku kv ij bi translated">我需要构建一个满足这些要求的字符串:</p><ul class=""><li id="6b40" class="nv nw iq ka b kb kc kf kg kj nx kn ny kr nz kv oa ob oc od bi translated">在应用程序中成功完成文件名检查，在这种情况下以<code class="fe nd ne nf ng b">.jpg</code>结束</li><li id="a013" class="nv nw iq ka b kb oe kf of kj og kn oh kr oi kv oa ob oc od bi translated">包含一个空字节，因此操作系统不会处理完整的文件名</li><li id="7ff5" class="nv nw iq ka b kb oe kf of kj og kn oh kr oi kv oa ob oc od bi translated">结果文件名必须引用<code class="fe nd ne nf ng b">/etc/passwd</code></li></ul><p id="d66f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">上面我已经建立了基本的路径遍历是可能的。因此，满足要求的有效文件名应该是<code class="fe nd ne nf ng b">../../../etc/passwd%00DoesNotMatter.jpg</code></p><p id="9389" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所以我在打嗝时捕捉到一个图像请求，并将其发送给中继器。如果您在HTTP历史记录中没有看到它，请检查图像是否在过滤器栏中被过滤掉(默认情况下是隐藏的):</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oj"><img src="../Images/02e6582038656a7de68077c93c8e34e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*7GrU6kT8ixX4M-ow.png"/></div></div><figcaption class="mz na gj gh gi nb nc bd b be z dk translated">使用空字节绕过路径遍历保护的恶意请求</figcaption></figure><p id="9f65" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此时，实验页面更新为</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ok"><img src="../Images/f99bb7dc05858548212826a4ab427c44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*C0fFBddlelUrp0wH.png"/></div></div></figure></div><div class="ab cl nj nk hu nl" role="separator"><span class="nm bw bk nn no np"/><span class="nm bw bk nn no np"/><span class="nm bw bk nn no"/></div><div class="ij ik il im in"><p id="7f35" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="kw">原载于</em><a class="ae kx" href="https://github.com/frank-leitner/portswigger-websecurity-academy/tree/main/03-directory_traversal/File_path_traversal%2C_validation_of_file_extension_with_null_byte_bypass" rel="noopener ugc nofollow" target="_blank"><em class="kw">https://github.com</em></a><em class="kw">。</em></p><p id="6ab5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe nd ne nf ng b"><a class="ae kx" href="https://medium.com/@frank.leitner/membership" rel="noopener">New to Medium? Become a Medium member to access all stories on the platform and support me at no extra cost for you!</a></code></p><h2 id="0bf4" class="ol lr iq bd ls om on dn lw oo op dp ma kj oq or me kn os ot mi kr ou ov mm ow bi translated">来自Infosec的报道:Infosec每天都有很多内容，很难跟上。<a class="ae kx" href="https://weekly.infosecwriteups.com/" rel="noopener ugc nofollow" target="_blank">加入我们的每周简讯</a>以5篇文章、4条线索、3个视频、2个Github Repos和工具以及1个工作提醒的形式免费获取所有最新的Infosec趋势！</h2></div></div>    
</body>
</html>