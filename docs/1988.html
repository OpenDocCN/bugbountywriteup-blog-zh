<html>
<head>
<title>Log Poisoning — Inject payloads in logs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">日志中毒—在日志中注入有效负载</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/log-poisoning-inject-payloads-in-logs-e7f1fa338f2f?source=collection_archive---------1-----------------------#2022-04-04">https://infosecwriteups.com/log-poisoning-inject-payloads-in-logs-e7f1fa338f2f?source=collection_archive---------1-----------------------#2022-04-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="2448" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">日志…这些是文件，其中存储了服务器上的所有活动。这些用于监控、故障排除、修复错误(漏洞)以及许多其他事情。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/e72cacbe988ceb1d38ef5d1757770299.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Ua2AmLSCd8YfP2zB"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">由<a class="ae lb" href="https://unsplash.com/@thkelley?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">托马斯·凯利</a>在<a class="ae lb" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="a3d9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为不同的事物记录活动，例如代理、web服务器等。但是在这里，我们正在学习网络日志中毒。</p><p id="ccbe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">那么，web服务器可能会记录什么呢？所以，最常见的是IP地址，日期和时间，以及用户代理。查看最常见的web服务器Apache 2:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lc"><img src="../Images/ad1e1c24104ecc7a0dcc2fc7009f0701.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PUiQ2ZKd9LNEfDBRqyRB8g.png"/></div></div></figure><p id="0474" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上面，你可以看到我在电脑上运行的Apache 2 web服务器的日志。第一件事是IP地址(这是本地IP-127.0.0.1)，其次是日期和时间，然后是请求方法、web路径、用户代理和其他一些东西。所以让我们先来看看我们能轻松控制什么</p><ul class=""><li id="e451" class="ld le iq jp b jq jr ju jv jy lf kc lg kg lh kk li lj lk ll bi translated">IP地址:不，它是由ISP控制的，我们不能在其中注入有效载荷</li><li id="b832" class="ld le iq jp b jq lm ju ln jy lo kc lp kg lq kk li lj lk ll bi translated">时间和日期:这是网络服务器上的日期和时间，我们无法控制</li><li id="de90" class="ld le iq jp b jq lm ju ln jy lo kc lp kg lq kk li lj lk ll bi translated">请求方法和路径:可以，URL和方法可以控制。</li><li id="26e0" class="ld le iq jp b jq lm ju ln jy lo kc lp kg lq kk li lj lk ll bi translated">用户代理:同样，是的。我们可以控制。</li></ul><h1 id="acaf" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">执行攻击</h1><p id="d085" class="pw-post-body-paragraph jn jo iq jp b jq mp js jt ju mq jw jx jy mr ka kb kc ms ke kf kg mt ki kj kk ij bi translated">现在，让我们来看看我们可以用它来执行哪些攻击。</p><p id="a2c5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">经理和管理员可以手动查看日志。所以最有可能的是他们会在网络浏览器中打开它。那么，对此最有可能的攻击是什么呢？最有可能的是XSS。因此，由于URL、用户代理和请求方法是我们可以控制的，我们可以在其中注入有效负载。这将是一个盲XSS，因为有效载荷不会在我们的浏览器上执行(这很可能是在系统管理员的浏览器上)。所以要做到这一点，我们可以使用XSS亨特，这是一个免费的XSS检测平台。</p><p id="a8db" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，假设服务器没有太多的空间，所以有可能它不会记录所有的请求，但它可能会记录错误以进行故障排除，并使用户体验更好。所以搜索/创建错误:</p><ul class=""><li id="8839" class="ld le iq jp b jq jr ju jv jy lf kc lg kg lh kk li lj lk ll bi translated">检查所有子域，如果它返回4xx或5xx错误(您可以使用我的工具<a class="ae lb" href="https://github.com/shriyanss/HTTPSelfie" rel="noopener ugc nofollow" target="_blank"> httpselfie </a>轻松查看所有子域的截图)</li><li id="d11f" class="ld le iq jp b jq lm ju ln jy lo kc lp kg lq kk li lj lk ll bi translated">发送格式错误的请求(下面的命令会导致错误)</li></ul><p id="9e06" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mu mv mw mx b">curl -X "&lt;payload_here&gt;" -H "User-Agent: &lt;payload&gt;" <a class="ae lb" href="http://target.co" rel="noopener ugc nofollow" target="_blank">http://target.co</a>m/&lt;payload&gt;</code></p><p id="65e7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mu mv mw mx b">cat &lt;wrong_host_header_request&gt;.txt | nc target.com 80</code></p><p id="48e1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">还有更多…</p><ul class=""><li id="018d" class="ld le iq jp b jq jr ju jv jy lf kc lg kg lh kk li lj lk ll bi translated">将用户代理设置为burp中的XSS有效负载</li></ul><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi my"><img src="../Images/1973c1510f6eb089384259b9188fa0e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*yZPuxTvYXN2Hvbtc42UgbQ.gif"/></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">在打嗝中设置有效负载的步骤</figcaption></figure><p id="7c98" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以针对不同的情况进行不同的攻击。假设它记录在SQL数据库中，那么攻击可能是SQL注入等等。</p><h2 id="68f0" class="mz ls iq bd lt na nb dn lx nc nd dp mb jy ne nf mf kc ng nh mj kg ni nj mn nk bi translated">日志中毒的终点</h2><ul class=""><li id="3714" class="ld le iq jp b jq mp ju mq jy nl kc nm kg nn kk li lj lk ll bi translated">登录页面(失败的登录尝试)</li><li id="474b" class="ld le iq jp b jq lm ju ln jy lo kc lp kg lq kk li lj lk ll bi translated">4xx和5xx状态代码页/子域。</li><li id="118c" class="ld le iq jp b jq lm ju ln jy lo kc lp kg lq kk li lj lk ll bi translated">API端点</li><li id="fb9b" class="ld le iq jp b jq lm ju ln jy lo kc lp kg lq kk li lj lk ll bi translated">敏感页面(管理页面等)</li><li id="bc58" class="ld le iq jp b jq lm ju ln jy lo kc lp kg lq kk li lj lk ll bi translated">一次性操作(订阅等)</li><li id="cdbf" class="ld le iq jp b jq lm ju ln jy lo kc lp kg lq kk li lj lk ll bi translated">尝试使用用户名中的有效负载(也包括RCE)登录SSH，并尝试通过LFI或其他方法获取该文件</li><li id="c0e4" class="ld le iq jp b jq lm ju ln jy lo kc lp kg lq kk li lj lk ll bi translated">更多…</li></ul><h1 id="47f0" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">原木中毒的例子</h1><h2 id="276f" class="mz ls iq bd lt na nb dn lx nc nd dp mb jy ne nf mf kc ng nh mj kg ni nj mn nk bi translated">在SSH日志中注入有效负载</h2><p id="f5ef" class="pw-post-body-paragraph jn jo iq jp b jq mp js jt ju mq jw jx jy mr ka kb kc ms ke kf kg mt ki kj kk ij bi translated">因为我们要在SSH日志中注入有效负载，所以我们需要在目标中打开一个SSH端口。因此，我们可以使用用户“<payload>”和一些随机密码登录。确保我们注入所有类型的有效载荷，因为我们不知道它将如何被处理</payload></p><p id="ea54" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">例如，运行以下命令连接到目标(输入某个随机密码):-</p><p id="1776" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mu mv mw mx b">ssh "&lt;img src=myserver.com&gt;"@target.com</code></p><p id="2c75" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我有一个树莓派，所以运行它，看看日志</p><blockquote class="no np nq"><p id="f6f1" class="jn jo nr jp b jq jr js jt ju jv jw jx ns jz ka kb nt kd ke kf nu kh ki kj kk ij bi translated">redacted @ raspberrypi:~ $ sudo cat/var/log/auth . log<br/>redacted<br/>Apr 5 08:59:23 raspberrypi sshd[1121]:无效用户的密码失败<strong class="jp ir">&lt;img src = my server . com&gt;</strong>来自192.168.43.150端口47084 ss H2<br/>Apr 5 08:59:26 raspberrypi sshd[110用户未知<br/>4月5日08:59:28 raspberrypi sshd[1121]:无效用户密码失败<strong class="jp ir">&lt;img src = my server . com&gt;</strong>来自192.168.43.150端口47084 ssh 2<br/>4月5日08:59:29 raspberrypi sshd[1121]:PAM _ UNIX(sshd:auth):检查通过；用户未知<br/>4月5日08:59:32 raspberrypi sshd[1121]:无效用户的密码失败<strong class="jp ir">&lt;img src = my server . com&gt;</strong>来自192.168.43.150端口47084 ss H2<br/>4月5日08:59:32 raspberrypi sshd[1121]:连接被无效用户关闭<strong class="jp ir"> &lt; img src=myserver</strong></p></blockquote><p id="66fb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这里，您可以看到<code class="fe mu mv mw mx b">img</code>标签，如果将它呈现给具有安全措施的浏览器，它会尝试从<code class="fe mu mv mw mx b">myserver.com</code>获取图像。在<code class="fe mu mv mw mx b">myserver.com</code>的根路径，我们可以放置一个记录所有请求和所有参数(例如，用户代理、主机、客户端IP等)的记录器。)</p><h2 id="d595" class="mz ls iq bd lt na nb dn lx nc nd dp mb jy ne nf mf kc ng nh mj kg ni nj mn nk bi translated">在失败的登录日志中注入有效负载</h2><p id="4e93" class="pw-post-body-paragraph jn jo iq jp b jq mp js jt ju mq jw jx jy mr ka kb kc ms ke kf kg mt ki kj kk ij bi translated">比如说<code class="fe mu mv mw mx b">/admin</code>，服务器有特定的端点用于监控和管理，但是它们需要登录。它们是非常敏感的端点，所以每一个可疑的动作都要被记录下来。如果我们试图在所有参数中强制使用有效负载，那么它可能会被记录(就像上面的SSH示例中一样)，如果在没有适当清理的情况下呈现，那么它将导致有效负载被执行。</p><p id="ae8c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">类似地，您可以在不同的端点注入负载，这些端点有更多的机会被记录。并且确保让你的用户代理充满有效载荷</strong></p><h1 id="7665" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">自动化</h1><p id="9786" class="pw-post-body-paragraph jn jo iq jp b jq mp js jt ju mq jw jx jy mr ka kb kc ms ke kf kg mt ki kj kk ij bi translated">对于日志中毒，我创建了一个叫做<a class="ae lb" href="http://github.com/shriyanss/Log-Venom" rel="noopener ugc nofollow" target="_blank">日志毒液</a>的工具。它被设计成用有效载荷毒害所有页面。</p><p id="1c5d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是一个shell脚本，它自动发送不同字段中带有有效负载的请求。</p><p id="bbab" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">需要注意:确保你在这次攻击中没有使用</strong> <code class="fe mu mv mw mx b"><strong class="jp ir">&lt;script&gt;alert(1)&lt;/script&gt; </strong></code> <strong class="jp ir">这样的有效载荷。这是一个盲目攻击，所以请确保您有自己的服务器启动并运行，以记录这些事情</strong></p></div></div>    
</body>
</html>