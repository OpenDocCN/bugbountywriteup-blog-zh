<html>
<head>
<title>TryHackMe | Team Writeup</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">TryHackMe |团队报道</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/tryhackme-team-writeup-e8ba56dcbce9?source=collection_archive---------0-----------------------#2021-03-07">https://infosecwriteups.com/tryhackme-team-writeup-e8ba56dcbce9?source=collection_archive---------0-----------------------#2021-03-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/24e065708679e8c36c19bdb03a8fa3de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E6oFD3gfEXYFPFOAzN6-dA.png"/></div></div></figure></div><div class="ab cl jy jz hu ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="ij ik il im in"><h1 id="0a4e" class="kf kg iq bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated"><strong class="ak">概述</strong></h1><p id="ba58" class="pw-post-body-paragraph ld le iq lf b lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">嘿，大家好。我带着另一篇文章回来了，这次是达莱马扎的《尝试团队》。</p><div class="mb mc gp gr md me"><a href="https://tryhackme.com/room/teamcw" rel="noopener  ugc nofollow" target="_blank"><div class="mf ab fo"><div class="mg ab mh cl cj mi"><h2 class="bd ir gy z fp mj fr fs mk fu fw ip bi translated">TryHackMe |团队</h2><div class="ml l"><h3 class="bd b gy z fp mj fr fs mk fu fw dk translated">初学者友好的boot2root机器</h3></div><div class="mm l"><p class="bd b dl z fp mj fr fs mk fu fw dk translated">tryhackme.com</p></div></div><div class="mn l"><div class="mo l mp mq mr mn ms jw me"/></div></div></a></div><div class="mb mc gp gr md me"><a href="https://tryhackme.com/p/dalemazza" rel="noopener  ugc nofollow" target="_blank"><div class="mf ab fo"><div class="mg ab mh cl cj mi"><h2 class="bd ir gy z fp mj fr fs mk fu fw ip bi translated">TryHackMe | dalemazza</h2><div class="ml l"><h3 class="bd b gy z fp mj fr fs mk fu fw dk translated">TryHackMe是一个免费的学习网络安全的在线平台，使用动手练习和实验室，通过您的…</h3></div><div class="mm l"><p class="bd b dl z fp mj fr fs mk fu fw dk translated">tryhackme.com</p></div></div><div class="mn l"><div class="mt l mp mq mr mn ms jw me"/></div></div></a></div><p id="b091" class="pw-post-body-paragraph ld le iq lf b lg mu li lj lk mv lm ln lo mw lq lr ls mx lu lv lw my ly lz ma ij bi translated">这是一个容易评级的盒子，但在我看来应该是一个中等评级的盒子，因为在机器上获得最初的立足点需要大量的步骤。访问网站时，我们会看到一个默认的Apache2页面。经过一些初步的侦察，我们发现机器正在使用一个虚拟主机域，在访问第二个域时，我们模糊了运行在端口21上的FTP服务的凭证。从那里我们找到了子域的名称，在访问它时，我们看到该域上的php脚本容易受到LFI的攻击。再次使用LFI we，fuzz来查找用户的ssh密钥。登录到机器后，我们首先进行横向权限提升，以获得对机器上另一个用户的访问权。之后，我们编辑一个由root cronjob运行的脚本，以root身份获得一个反向shell。没什么好说的了，我们开始吧。</p><h1 id="c7f3" class="kf kg iq bd kh ki mz kk kl km na ko kp kq nb ks kt ku nc kw kx ky nd la lb lc bi translated">我们闯进去吧！</h1><p id="6b44" class="pw-post-body-paragraph ld le iq lf b lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">像往常一样，从NMap扫描开始。</p><pre class="ne nf ng nh gt ni nj nk nl aw nm bi"><span id="8e96" class="nn kg iq nj b gy no np l nq nr">sudo nmap -sS -sV -sC -oA nmap/team *THM Box IP* -vv</span></pre><blockquote class="ns nt nu"><p id="3f55" class="ld le nv lf b lg mu li lj lk mv lm ln nw mw lq lr nx mx lu lv ny my ly lz ma ij bi translated"><em class="iq"> Here -sS: SYN Scan，-sC:用于“安全”脚本，或默认脚本，-sV:用于版本枚举，-oA:所有格式的输出(Greppable、XML和默认NMap输出)，-vv:用于详细。</em></p></blockquote><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nz"><img src="../Images/edb15d3d9a89f42480f02f0230aeb2c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BMISRrGb0eQAvXYCstrXQg.png"/></div></div></figure><p id="754e" class="pw-post-body-paragraph ld le iq lf b lg mu li lj lk mv lm ln lo mw lq lr ls mx lu lv lw my ly lz ma ij bi translated">在上，运行NMap扫描，我们打开了3个端口:21(ftp)、22(ssh)和80(http)。ftp服务禁用了匿名登录，所以让我们访问运行在端口80上的web服务器。在访问web服务器时，我们会看到一个默认的Apache登录页面。使用GoBuster来寻找任何有趣的东西，我们一无所获。</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nz"><img src="../Images/21ff7c252d37c4c59f5f4f9f1426949f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uJ9Bot-UHpgzd6DVoxI0aQ.png"/></div></div></figure><pre class="ne nf ng nh gt ni nj nk nl aw nm bi"><span id="a758" class="nn kg iq nj b gy no np l nq nr">cat /usr/share/seclists/Discovery/Web-Content/raft-small/words.txt | grep -v -P ‘^\.’ | gobuster dir -u <a class="ae oa" rel="noopener ugc nofollow" target="_blank" href="/*THM">http://*THM</a> box IP*/ -w - -o gobuster.log -t 50 -x php</span></pre><blockquote class="ns nt nu"><p id="9951" class="ld le nv lf b lg mu li lj lk mv lm ln nw mw lq lr nx mx lu lv ny my ly lz ma ij bi translated">这里，dir:指定目录强制，-u指定目标URL，-w指定单词列表，我使用raft-small-words.txt。它包含在GitHub的sec-lists中，您可以在自己的发行版中克隆它，我建议您这样做，因为它们非常有用。否则你可以从<a class="ae oa" href="https://github.com/danielmiessler/SecLists/blob/master/Discovery/Web-Content/raft-small-directories.txt" rel="noopener ugc nofollow" target="_blank"> <strong class="lf ir">这里</strong> </a>下载这个特定的单词表。-x:指定扩展名。这个开关将在每个单词后添加一个. php来检查一个文件是否也存在。您可以指定多种文件类型，用逗号分隔。—线程:指定一次发出请求的进程数量。非常谨慎地使用这个开关，因为在现实世界中，对网站的大量请求会将你列入黑名单。既然这是虚拟环境，应该不是问题。-o:指定输出文件。</p></blockquote><p id="edcf" class="pw-post-body-paragraph ld le iq lf b lg mu li lj lk mv lm ln lo mw lq lr ls mx lu lv lw my ly lz ma ij bi translated">我使用grep删除了所有以“.”开头的行。，因为任何以它开头的东西都会给出一个403(未授权)错误代码，它会使屏幕变得混乱。</p><p id="a0d3" class="pw-post-body-paragraph ld le iq lf b lg mu li lj lk mv lm ln lo mw lq lr ls mx lu lv lw my ly lz ma ij bi translated">在默认页面上一无所获之后，我尝试将<strong class="lf ir"> team.thm </strong>域添加到我的“/etc/hosts”中，这样我的浏览器就可以将我重定向到该域。果然，服务器上又出现了一个网页。似乎服务器正在使用虚拟域名托管。</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nz"><img src="../Images/0246678beb730c76f3fe816681f30ca4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EHi5GguQW7fl6290_skpZA.png"/></div></div></figure><p id="0b43" class="pw-post-body-paragraph ld le iq lf b lg mu li lj lk mv lm ln lo mw lq lr ls mx lu lv lw my ly lz ma ij bi translated">在这个域上使用GoBuster，我们得到了多次点击，但其中只有两次看起来很有趣。访问robots.txt，我们看到文件里只有一个字‘dale’，猜测可能是用户名，我往前移了移。访问/scripts/，我们无权查看根目录，所以让我们再次对其使用GoBuster，看看我们是否有权查看任何文件。GoBuster完成后，我们看到我们只被授权查看一个文件' script.txt '。</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ob"><img src="../Images/a5fa9da20c48af18fd6ca15cf6211257.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F4pmX2uWSGb2ngs7AnDN2Q.png"/></div></div></figure><p id="e14d" class="pw-post-body-paragraph ld le iq lf b lg mu li lj lk mv lm ln lo mw lq lr ls mx lu lv lw my ly lz ma ij bi translated">用户注意到有另一个名为script的文件，但是它的扩展名被更改了，因为它包含了<strong class="lf ir">凭证</strong>。因此，让我们使用ffuf模糊扩展。</p><pre class="ne nf ng nh gt ni nj nk nl aw nm bi"><span id="b05f" class="nn kg iq nj b gy no np l nq nr">ffuf -w /usr/share/seclists/Discovery/Web-content/raft-small-extension -u ‘http://team.thm/scripts/scriptFUZZ’ -fc 403,404</span></pre><blockquote class="ns nt nu"><p id="c055" class="ld le nv lf b lg mu li lj lk mv lm ln nw mw lq lr nx mx lu lv ny my ly lz ma ij bi translated">这里，-w:指定要使用的单词列表，-u:指定要模糊的URL，fuzz:指定要模糊的URL中的位置，-fc:按HTTP状态代码过滤结果。</p></blockquote><p id="dd80" class="pw-post-body-paragraph ld le iq lf b lg mu li lj lk mv lm ln lo mw lq lr ls mx lu lv lw my ly lz ma ij bi translated">使用上面的命令，我们找到了旧脚本的扩展，以及ftp服务器的凭证。</p><p id="b870" class="pw-post-body-paragraph ld le iq lf b lg mu li lj lk mv lm ln lo mw lq lr ls mx lu lv lw my ly lz ma ij bi translated">进入ftp服务器，我们发现一个名为New_site.txt的文件，读取它，我们发现用户也有一个。服务器上托管的“dev”网站。在vhost模式下使用GoBuster，我们为team.thm找到一个子域。</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nz"><img src="../Images/a5fcc69705cbab5d28c1da38ba1b199f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*csPHGcjkudp5FdMz3nql6A.png"/></div></div></figure><pre class="ne nf ng nh gt ni nj nk nl aw nm bi"><span id="ada2" class="nn kg iq nj b gy no np l nq nr">gobuster vhost -u <a class="ae oa" href="http://team.thm/" rel="noopener ugc nofollow" target="_blank">http://team.thm/</a> -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt -o gobuster.vhost.log -t 100</span></pre><p id="a7c7" class="pw-post-body-paragraph ld le iq lf b lg mu li lj lk mv lm ln lo mw lq lr ls mx lu lv lw my ly lz ma ij bi translated">在将新的子域添加到我们的“/etc/hosts/”之后，让我们访问网站。在访问该网站时，很明显该网站仍在开发中。点击网站上唯一的链接，我们看到它是一个PHP脚本，很可能使用了include函数。测试变量‘page’，我们看到它容易受到LFI的攻击。</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ob"><img src="../Images/1199934a1db418ca4bccc721ed4998ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wb0WTu1eP4X4t7K6vgnlZA.png"/></div></div></figure><p id="aa03" class="pw-post-body-paragraph ld le iq lf b lg mu li lj lk mv lm ln lo mw lq lr ls mx lu lv lw my ly lz ma ij bi translated">现在，这部分花了我一分钟来完成。在New_site.txt中提到，用户dale必须复制他的“id_rsa”密钥，并将其保存在配置文件中。在尝试了不同的方法将LFI升级到RCE，并以惊人的失败告终后，我尝试模糊化“id_rsa”。</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nz"><img src="../Images/abf00937e6dca513b414494e1cab6c56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LJ3a5nP0IHbOzKPIx8XCzQ.png"/></div></div></figure><p id="56e2" class="pw-post-body-paragraph ld le iq lf b lg mu li lj lk mv lm ln lo mw lq lr ls mx lu lv lw my ly lz ma ij bi translated">使用<a class="ae oa" href="https://github.com/danielmiessler/SecLists/blob/master/Fuzzing/LFI/LFI-Jhaddix.txt" rel="noopener ugc nofollow" target="_blank">的<a class="ae oa" href="https://github.com/danielmiessler/SecLists" rel="noopener ugc nofollow" target="_blank"> seclists </a>中的</a>词表，以及ffuf，我最终得到了用户dale的‘id _ RSA’。哦！，<em class="nv">甜-释放</em>。</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nz"><img src="../Images/b02fd7e5e245b5fa71eb5c9f690846ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QbP5FF6P3bVNr0xZ975xqg.png"/></div></div></figure><p id="f6a4" class="pw-post-body-paragraph ld le iq lf b lg mu li lj lk mv lm ln lo mw lq lr ls mx lu lv lw my ly lz ma ij bi translated">我把ssh-key留在这里，我知道这是违反规定的，但是伙计，如果你能输入一个完整的ssh密钥而不用去找它，你就是c̶r̶a̶z̶y的奇迹。总之，继续前进。在使用一些Linux-foo将密钥恢复为原始格式之后，让我们通过ssh进入机器。</p><p id="c587" class="pw-post-body-paragraph ld le iq lf b lg mu li lj lk mv lm ln lo mw lq lr ls mx lu lv lw my ly lz ma ij bi translated"><strong class="lf ir">附言</strong>要获得原始格式的密钥，只需将它粘贴到一个文件中。姑且称之为a.txt，然后做<code class="fe oc od oe nj b">cat a.txt | sed ‘s/ #/\r\n/g’ &gt; id_rsa</code>。为了简化这里发生的事情。我们使用sed将任何出现的' # '替换为换行符。</p><p id="d91b" class="pw-post-body-paragraph ld le iq lf b lg mu li lj lk mv lm ln lo mw lq lr ls mx lu lv lw my ly lz ma ij bi translated">或者，您可以手动操作。</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nz"><img src="../Images/aaf267b69e5ad609e7cd596ee932ac90.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1AyDgqc2BbgC0LM6YFEnlA.png"/></div></div></figure><p id="6570" class="pw-post-body-paragraph ld le iq lf b lg mu li lj lk mv lm ln lo mw lq lr ls mx lu lv lw my ly lz ma ij bi translated">进入机器后，我们看到机器中有另一个用户“gyles”。因为Gyles正在指导dale，所以可以安全地假设用户Gyles比我们当前的用户拥有更多的特权。在上，以用户dale的身份运行<code class="fe oc od oe nj b">sudo -l</code>,我们看到我们可以以用户gyles的身份运行脚本‘admin _ checks ’,并具有提升的权限和NOPASSWD。在读取脚本“admin_check”时，它会询问用户名和日期，然后将“日期变量”传递给要执行的“日期命令”。这很容易被利用，只需将“/bin/bash”作为日期传递，我们就有了一个shell。</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nz"><img src="../Images/6bd57aee1fca8c1a70bb8bc9daa10cbe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fGVuTtzjRS6qyaoNUKxXYQ.png"/></div></div></figure><p id="c1ff" class="pw-post-body-paragraph ld le iq lf b lg mu li lj lk mv lm ln lo mw lq lr ls mx lu lv lw my ly lz ma ij bi translated">四处翻找了一番后，我什么也没找到。所以，我把<a class="ae oa" href="https://github.com/DominicBreuker/pspy" rel="noopener ugc nofollow" target="_blank"> pspy </a>从我的机器上转移过来，寻找任何在后台运行的进程。等待一段时间后，我们看到root正在为“script.sh”运行一个cronjob。在检查脚本的权限时，我们看到我们的用户能够编辑脚本。因此，让我们编辑它以在我们的机器上获得一个反向shell。</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nz"><img src="../Images/176051eadf0b4707d26804d7cb0402a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fsMun3koDxIbTuH2_o5aKg.png"/></div></div></figure><p id="41fc" class="pw-post-body-paragraph ld le iq lf b lg mu li lj lk mv lm ln lo mw lq lr ls mx lu lv lw my ly lz ma ij bi translated">保存它，并在您的机器上启动一个监听器，监听来自机器的传入连接。等待几秒钟后，我们作为根用户在我们的机器上得到一个反向shell。</p><figure class="ne nf ng nh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nz"><img src="../Images/f4c9b2de3ec0dc74d95d39577b851516.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZSWIT7V_xRy6-0TvenEWNg.png"/></div></div></figure><p id="de3c" class="pw-post-body-paragraph ld le iq lf b lg mu li lj lk mv lm ln lo mw lq lr ls mx lu lv lw my ly lz ma ij bi translated">这就是那个盒子。希望你们喜欢。</p><p id="650a" class="pw-post-body-paragraph ld le iq lf b lg mu li lj lk mv lm ln lo mw lq lr ls mx lu lv lw my ly lz ma ij bi translated">如果你有任何建议，请在评论中告诉我。</p><p id="f8a4" class="pw-post-body-paragraph ld le iq lf b lg mu li lj lk mv lm ln lo mw lq lr ls mx lu lv lw my ly lz ma ij bi translated">祝你有美好的一天！</p></div></div>    
</body>
</html>