<html>
<head>
<title>TomGhost</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">汤姆鬼影</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/tomghost-f78da95df531?source=collection_archive---------4-----------------------#2021-10-16">https://infosecwriteups.com/tomghost-f78da95df531?source=collection_archive---------4-----------------------#2021-10-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/d9c9fc33b079c6657beef0b97966ec4f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FM3H9E7PCJQPYRGTIZ2K2Q.png"/></div></div></figure><p id="f58c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你好。！这不会是一个机器的常规报道，相反，我想用为OSCP提供的模板作为渗透测试报告。</p><p id="9aa8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我从多个渠道得到这个想法，他们强调有效报告的重要性，这对于一个圣灵降临者来说是非常重要的。所以让我们直接进入这台机器的官方报告，我也将尝试修补最初的漏洞，就像一个建议。</p><h1 id="0d9d" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">目录:</h1><ol class=""><li id="f4e2" class="lu lv iq ka b kb lw kf lx kj ly kn lz kr ma kv mb mc md me bi translated">高级摘要</li><li id="d231" class="lu lv iq ka b kb mf kf mg kj mh kn mi kr mj kv mb mc md me bi translated">方法学</li></ol><p id="1ad9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">2.1信息收集</p><p id="7e98" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">2.2渗透</p><p id="310c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">系统枚举</p><p id="fbeb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">权限提升</p><p id="ddec" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">3条建议(带补丁)</p><h1 id="5dc5" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated"><strong class="ak"> 1。高层总结:</strong></h1><p id="5c32" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj mk kl km kn ml kp kq kr mm kt ku kv ij bi translated">我的任务是对Demo.inc .的一台机器执行内部渗透测试。内部渗透测试是针对内部连接系统的专门攻击。该测试的重点是执行攻击，类似于黑客的攻击并试图渗透。我的总体目标是评估网络，识别系统，并利用缺陷，同时向Demo.inc .报告调查结果。</p><p id="e2c8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这个渗透测试中，我被指示只测试一台暴露在互联网上的机器，并使用Apache Tomcat服务器托管一些web内容。当执行测试时，机器上存在令人担忧的漏洞，这使得我可以完全破坏机器并完全控制它。这主要是由于糟糕的配置和一些过时的补丁。</p><p id="28e9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">系统IP:10.10.48.134</p><h1 id="a3f3" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated"><strong class="ak"> 2。方法论:</strong></h1><p id="6812" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj mk kl km kn ml kp kq kr mm kt ku kv ij bi translated">我利用了一种广泛采用的方法来执行渗透测试，这种方法在测试中是有效的，下面是我如何能够识别和利用各种系统的突破，包括发现的所有单个漏洞。</p><p id="d659" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> 2.1。信息收集:</strong></p><p id="1983" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">渗透测试的信息收集部分侧重于确定渗透测试的范围。在这次渗透测试中，我的任务是利用网络中的一台机器。</p><p id="9c8a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> 2.2穿透:</strong></p><p id="186b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">评估的渗透测试部分重点关注对各种系统的访问。</p><p id="d0c3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">系统IP:10.10.48.134</p><h2 id="6ebe" class="mn kx iq bd ky mo mp dn lc mq mr dp lg kj ms mt lk kn mu mv lo kr mw mx ls my bi translated">服务枚举</h2><p id="eb78" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj mk kl km kn ml kp kq kr mm kt ku kv ij bi translated">渗透测试的服务枚举部分着重于收集关于在一个或多个系统上哪些服务是活动的信息。这对攻击者很有价值，因为它提供了进入系统的潜在攻击媒介的详细信息。在执行实际渗透测试之前，了解系统上运行的应用程序可以为攻击者提供所需的信息。</p><figure class="na nb nc nd gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mz"><img src="../Images/96cee270dd1689e06a75254b379f1f63.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FAkEX2gAiqQtp0-fYz36eg.png"/></div></div><figcaption class="ne nf gj gh gi ng nh bd b be z dk translated">开放端口</figcaption></figure><p id="fb52" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Nmap扫描结果:</p><figure class="na nb nc nd gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ni"><img src="../Images/a00a18029a5e76c8a05f2d56f681df8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w-WKrMk46DK-3M-T83ZwXA.png"/></div></div><figcaption class="ne nf gj gh gi ng nh bd b be z dk translated">服务-扫描</figcaption></figure><p id="5172" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">初始攻击向量:</strong></p><blockquote class="nj nk nl"><p id="55dd" class="jy jz nm ka b kb kc kd ke kf kg kh ki nn kk kl km no ko kp kq np ks kt ku kv ij bi translated">被利用的漏洞:Apache Tomcat-AJP的Ghostcat文件读取/包含</p><p id="b29f" class="jy jz nm ka b kb kc kd ke kf kg kh ki nn kk kl km no ko kp kq np ks kt ku kv ij bi translated">漏洞解释:</p><p id="48fd" class="jy jz nm ka b kb kc kd ke kf kg kh ki nn kk kl km no ko kp kq np ks kt ku kv ij bi translated">Ghost Cat是一个影响Apache Tomcat的漏洞。它目前影响9.0.31之前、8.5.51之前和7.0.100之前的版本。这是由于Tomcat的默认安装中AJP协议的不安全配置造成的，使得攻击者能够造成信息泄露，并可能远程执行代码。</p><p id="8174" class="jy jz nm ka b kb kc kd ke kf kg kh ki nn kk kl km no ko kp kq np ks kt ku kv ij bi translated">如需进一步阅读，请参考:</p><p id="d3e7" class="jy jz nm ka b kb kc kd ke kf kg kh ki nn kk kl km no ko kp kq np ks kt ku kv ij bi translated"><a class="ae nq" href="https://scottc130.medium.com/understanding-the-ghost-cat-vulnerability-cve-2020-1938-79ceae327599" rel="noopener">https://Scott c130 . medium . com/understanding-the-ghost-cat-vulnerability-CVE-2020-1938-79 ceae 327599</a></p><p id="0fba" class="jy jz nm ka b kb kc kd ke kf kg kh ki nn kk kl km no ko kp kq np ks kt ku kv ij bi translated">概念验证代码在这里:<a class="ae nq" href="https://www.exploit-db.com/exploits/48143" rel="noopener ugc nofollow" target="_blank">https://www.exploit-db.com/exploits/48143</a></p></blockquote><p id="66ff" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">利用这个漏洞，我们可以读取一个配置文件<code class="fe nr ns nt nu b">WEB-INF/web.xml.</code></p><p id="d587" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">该文件泄漏了用户skyfuck的凭据，该凭据可用于通过ssh进入机器。</p><figure class="na nb nc nd gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nv"><img src="../Images/dd075716fd89df3eaa05ca676926f673.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HSrGPJ4MkO6WowCn9TPIQw.png"/></div></div></figure><p id="daae" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">以skyfuck的身份登录，我们得到user.txt文件。</p><figure class="na nb nc nd gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nw"><img src="../Images/e6ba1c5b23c11895f3b3f2290f3b2485.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lQKuTrrvKxjrvPPsAnbx5w.png"/></div></div><figcaption class="ne nf gj gh gi ng nh bd b be z dk translated">User.txt</figcaption></figure><p id="3a7c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">权限提升:</strong></p><p id="4d77" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">列出了我们可以看到的梅林的主目录</p><figure class="na nb nc nd gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nx"><img src="../Images/55436b665889ce9a442c386766e467de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d040Xl-_N25vAgL5GEYm5g.png"/></div></div></figure><p id="fa8d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们可以看到。sudo_as_admin_successful，这意味着用户merlin属于sudoers组。因此，我们必须首先找到梅林的凭证，并且在使用我们拥有的用户名和密码尝试sudo时，通过得到skyfuck不在sudoers组中的提示来确认这条路线。</p><p id="9165" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在skyfuck的主目录中列出我们看到的文件:</p><figure class="na nb nc nd gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ny"><img src="../Images/3b2ff685e0c4bffe16a3d108c9eb48b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NcrF4-4cTCcqNWIlX9gcSQ.png"/></div></div><figcaption class="ne nf gj gh gi ng nh bd b be z dk translated">Skyfuck的家</figcaption></figure><p id="704e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们可以看到两个有趣的文件credential.pgp和tryhackme.asc。</p><p id="cd2d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这种加密方法中，我们需要一个私钥tryhackme.asc和一个密码来解密credential.pgp文件。</p><p id="71c5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因为我们不知道密码短语，所以我们必须使用众所周知的rockyou.txt单词表来强制使用它。</p><p id="335e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在此之前，我们已经使用gpg2john将tryhackme.asc文件转换为hash。</p><blockquote class="nj nk nl"><p id="48e1" class="jy jz nm ka b kb kc kd ke kf kg kh ki nn kk kl km no ko kp kq np ks kt ku kv ij bi translated">gpg 2g John tryhackme . ASC &gt; hash</p><p id="5ed9" class="jy jz nm ka b kb kc kd ke kf kg kh ki nn kk kl km no ko kp kq np ks kt ku kv ij bi translated">John hash—word list =/usr/share/word lists/rock you . txt</p></blockquote><p id="aef0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一旦我们得到了密码，我们就可以使用</p><figure class="na nb nc nd gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nz"><img src="../Images/f9d644cbe44db2f8b0135fa3e80c9423.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PGIwdAkuCTfpom_X4nQyJg.png"/></div></div></figure><p id="90c7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在以merlin和基本权限枚举登录，我们将看到</p><figure class="na nb nc nd gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oa"><img src="../Images/0df11e0f3381a3d5eb037d8917ecbd2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ed1jWd08kEgZ-ofDW58UWg.png"/></div></div><figcaption class="ne nf gj gh gi ng nh bd b be z dk translated">Merlin用户</figcaption></figure><blockquote class="nj nk nl"><p id="bb0a" class="jy jz nm ka b kb kc kd ke kf kg kh ki nn kk kl km no ko kp kq np ks kt ku kv ij bi translated"><strong class="ka ir">利用了权限提升漏洞:</strong>允许/usr/bin/zip以root用户身份运行，无需任何身份验证。</p><p id="1fd9" class="jy jz nm ka b kb kc kd ke kf kg kh ki nn kk kl km no ko kp kq np ks kt ku kv ij bi translated"><strong class="ka ir">漏洞解释:</strong> ZIP二进制文件可用于调用shell进程，当该进程被允许以root用户身份运行时，我们会以root用户身份获得shell，从而导致系统完全受损。</p><p id="c03d" class="jy jz nm ka b kb kc kd ke kf kg kh ki nn kk kl km no ko kp kq np ks kt ku kv ij bi translated"><strong class="ka ir">漏洞利用代码:</strong>(<a class="ae nq" href="https://gtfobins.github.io/gtfobins/zip/" rel="noopener ugc nofollow" target="_blank">https://gtfobins.github.io/gtfobins/zip/</a>)</p></blockquote><pre class="na nb nc nd gt ob nu oc od aw oe bi"><span id="c318" class="mn kx iq nu b gy of og l oh oi">TF=$(mktemp -u)<br/>zip $TF /etc/hosts -T -TT 'sh #'<br/>rm $TF</span></pre><p id="f064" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">证明:</p><figure class="na nb nc nd gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oj"><img src="../Images/3a272e4eaed13b0ead67649073e5a3fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w1Evqzy5lzZBY28mjtxCiQ.png"/></div></div></figure><h1 id="7b12" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">3.建议和补丁:</h1><p id="fb8a" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj mk kl km kn ml kp kq kr mm kt ku kv ij bi translated">此系统的最佳解决方案或补丁是修补GhostCat漏洞，因为这可以阻止攻击者获得初始外壳。</p><ol class=""><li id="6a03" class="lu lv iq ka b kb kc kf kg kj ok kn ol kr om kv mb mc md me bi translated">我们可以安装Apache发布的Tomcat的补丁版本，并在/conf/server.xml文件中放置一个密钥</li></ol><blockquote class="nj nk nl"><p id="de0d" class="jy jz nm ka b kb kc kd ke kf kg kh ki nn kk kl km no ko kp kq np ks kt ku kv ij bi translated"><connector port="”8009&quot;" protocol="”AJP/1.3&quot;"/>redirect port = " 8443 "<br/>ADDRESS = " YOUR _ TOMCAT _ IP _ ADDRESS "<br/>SECRET = " YOUR _ TOMCAT _ AJP _ SECRET "/&gt;</p></blockquote><p id="85e2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">2.如果您没有使用AJP协议，那么我们必须注释掉server.xml文件中提到的端口。</p><p id="51a7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">server.xml文件位于机器的:/opt/tomcat/conf/server.xml中</p><figure class="na nb nc nd gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi on"><img src="../Images/09fd2347ed088e5ee70dda0b47e5abd2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jU_eenG8PqxPEvjTmR6SuQ.png"/></div></div></figure><p id="c334" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">注释该行会关闭端口，只有当您不使用AJP协议时，才必须这样做。</p><p id="87b0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">3.如果无法修补，则必须将server.xml文件修改为</p><blockquote class="nj nk nl"><p id="1149" class="jy jz nm ka b kb kc kd ke kf kg kh ki nn kk kl km no ko kp kq np ks kt ku kv ij bi translated"><connector port="”8009&quot;" protocol="”AJP/1.3&quot;"/>redirect port = " 8443 "<br/>ADDRESS = " YOUR _ TOMCAT _ IP _ ADDRESS " required SECRET = " YOUR _ TOMCAT _ AJP _ SECRET "/&gt;</p></blockquote><p id="d811" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">应用此修补程序后，重新启动并检查端口是否仍然打开或易受攻击。</p><p id="766d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">谢谢大家！！</p></div></div>    
</body>
</html>