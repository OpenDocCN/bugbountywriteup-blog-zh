<html>
<head>
<title>Raccoon Stealer v2 Malware Analysis</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">浣熊盗v2恶意软件分析</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/raccoon-stealer-v2-malware-analysis-55cc33774ac8?source=collection_archive---------1-----------------------#2022-09-12">https://infosecwriteups.com/raccoon-stealer-v2-malware-analysis-55cc33774ac8?source=collection_archive---------1-----------------------#2022-09-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/e1643cbe74b6bd6cde59ebcef76b83aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LbtxFhDZg7Hioi5Akm4hvA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">图片来源:Bleepingcomputer.com(<a class="ae kc" href="https://www.bleepingcomputer.com/news/security/malware-dev-infects-own-pc-and-data-ends-up-on-intel-platform/" rel="noopener ugc nofollow" target="_blank">https://www . bleeping computer . com/news/security/malware-dev-infections-own-PC-and-data-ends-up-on-Intel-platform/</a>)</figcaption></figure><h1 id="a411" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">介绍</h1><p id="37a8" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">浣熊窃取者是在地下黑客/网络犯罪论坛上出售的信息窃取者，于2019年初首次观察到。浣熊盗v2首次出现在2022年6月，在开发者从他们在2022年初宣布的所谓“退休”中回来之后。[1]就像浣熊窃取者v1一样，v2能够窃取信息，包括cookies和其他浏览器数据、信用卡数据、用户名和密码。</p><h1 id="0cdc" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">技术分析</h1><p id="8bb3" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">浣熊盗v2是用C/C++编写的，只有大约57kb，是相当轻量级的。下面是打包样本和未打包样本的哈希值。根据我的研究，默认情况下，浣熊偷窃者没有打包出售，相反，任何打包都必须由将部署该恶意软件的客户完成。</p><ul class=""><li id="ab75" class="lz ma iq ld b le mb li mc lm md lq me lu mf ly mg mh mi mj bi translated">包装的sha 256:40 DAA 898 f 98206806 ad 3 ff 78 f 63409d 509922 e0c 482684 cf 4 f 180 faac 8 CAC 273</li><li id="b9ba" class="lz ma iq ld b le mk li ml lm mm lq mn lu mo ly mg mh mi mj bi translated">unpacked sha 256:0123 b 26 df 3c 79 BAC 0 a3 FDA 79072 e 36 c 159 CFD 1824 AE 3 FD 4 b 7 f 9 de a9 BDA 9 c 7909</li></ul><h2 id="9bfa" class="mp ke iq bd kf mq mr dn kj ms mt dp kn lm mu mv kr lq mw mx kv lu my mz kz na bi translated">拆包</h2><p id="90cd" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">打开这个示例非常简单。我所做的只是在一些感兴趣的API调用上设置断点，如VirtualProtect、WriteProcessMemory、CreateProcessInternalW和VirtualAlloc。一旦命中VirtualProtect断点，我就跟踪内存转储中EAX寄存器的地址，然后再次运行程序，直到下一个断点。之后，我能够从内存中转储有效载荷，并继续我的分析。</p><figure class="nc nd ne nf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nb"><img src="../Images/c28bb635eacd571524906e376d2639f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NTE3MdWYprZ5Dy-21dhDwQ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">图一。从内存中转储第二级有效载荷。</figcaption></figure><h2 id="a869" class="mp ke iq bd kf mq mr dn kj ms mt dp kn lm mu mv kr lq mw mx kv lu my mz kz na bi translated">解析导入</h2><p id="8d0d" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">首先，我在PEstudio中打开有效负载来执行一些基本的静态分析，这将指导我如何执行其余的分析。在PEstudio中打开二进制文件，少量的导入函数(只有8个)让我相信恶意软件可能会动态解析其导入。</p><figure class="nc nd ne nf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ng"><img src="../Images/def7310bad05966f442985642126d4dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*z6whO9kvh92jUfI_zNtI4Q.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">图二。PEstudio中显示的导入功能。</figcaption></figure><p id="6035" class="pw-post-body-paragraph lb lc iq ld b le mb lg lh li mc lk ll lm nh lo lp lq ni ls lt lu nj lw lx ly ij bi translated">在Ghidra中反汇编二进制文件时，我在二进制文件的早期就发现了导入解析器函数，正如所料。这个函数简单地使用GetProcAddress API函数来加载它将需要的函数的地址。其中一些功能立刻吸引了我的眼球，这些是图3中突出显示的与互联网相关的功能。</p><figure class="nc nd ne nf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nk"><img src="../Images/c9a4f9ae79735af225b722fc3ddcbd4c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L7Wv-6tnzJ63G7K-Gikakg.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">图3。导入解析器功能中与互联网相关的功能。</figcaption></figure><h2 id="b0c1" class="mp ke iq bd kf mq mr dn kj ms mt dp kn lm mu mv kr lq mw mx kv lu my mz kz na bi translated">解密字符串和C2 IP地址</h2><p id="bfc4" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">该恶意软件还使用Base64编码和RC4加密来混淆其字符串。RC4加密字符串以Base64编码形式存储。这些字符串经过Base64解码，然后使用RC4密钥“edinayarossiya”解密，edinayarossiya在俄语中是“统一俄罗斯”的意思。一旦字符串被解密，恶意软件就会对C2 IP地址执行相同的解密程序，但使用不同的RC4密钥。</p><figure class="nc nd ne nf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nl"><img src="../Images/c8b685661fe7aa5786b61e1e52c4e48d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tg1TB5yXgZJHbES9p5uMZg.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">图4。解码和解密C2 IP地址。</figcaption></figure><p id="9e79" class="pw-post-body-paragraph lb lc iq ld b le mb lg lh li mc lk ll lm nh lo lp lq ni ls lt lu nj lw lx ly ij bi translated">有了这个RC4密钥和Base64编码的数据，我就可以使用cyberchef来获取C2节点的IP地址。</p><figure class="nc nd ne nf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nm"><img src="../Images/81c647eeed880fe190f1dc09126ce9c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dRuEjhjTok9SMX5vMJeMVA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">图5。在赛博咖啡馆提取C2的IP地址。</figcaption></figure><h2 id="e55f" class="mp ke iq bd kf mq mr dn kj ms mt dp kn lm mu mv kr lq mw mx kv lu my mz kz na bi translated">检查互斥体</h2><p id="ef23" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">接下来，恶意软件通过打开值为8724643052的互斥体来检查它的另一个实例是否已经在受感染的机器上运行。如果OpenMutexW函数失败并返回0，恶意软件将使用该值创建一个互斥体，然后继续执行。如果函数成功并返回1(真)，恶意软件退出。</p><figure class="nc nd ne nf gt jr gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/b2653dd4bdeca53e53938038685668b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1328/format:webp/1*hMnyZS8pgBoDXKA03xDrNQ.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">图6。正在检查打开的互斥体。</figcaption></figure><h2 id="0e39" class="mp ke iq bd kf mq mr dn kj ms mt dp kn lm mu mv kr lq mw mx kv lu my mz kz na bi translated">系统检查和进程枚举</h2><p id="d4a5" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">该恶意软件还通过比较当前进程的令牌和系统SID S-1–5–18来检查它是否作为系统运行。</p><figure class="nc nd ne nf gt jr gh gi paragraph-image"><div class="gh gi no"><img src="../Images/200a11465336d7bf10ccf09aa1c4e324.png" data-original-src="https://miro.medium.com/v2/resize:fit:1326/format:webp/1*W7dyZy1HOryii6utJgMmmQ.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">图7。恶意软件检查它是否以系统权限运行。</figcaption></figure><p id="bb4d" class="pw-post-body-paragraph lb lc iq ld b le mb lg lh li mc lk ll lm nh lo lp lq ni ls lt lu nj lw lx ly ij bi translated">如果恶意软件作为系统运行，它将使用CreateToolHelpSnapshot32、Process32First和Process32Next调用进程枚举函数。</p><figure class="nc nd ne nf gt jr gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/75e9c5f2d27dcc7294358408a3c7c370.png" data-original-src="https://miro.medium.com/v2/resize:fit:1328/format:webp/1*yCNzFJW9ENL40rMrIDCrYA.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">图8。枚举受感染机器上的功能。</figcaption></figure><p id="4b25" class="pw-post-body-paragraph lb lc iq ld b le mb lg lh li mc lk ll lm nh lo lp lq ni ls lt lu nj lw lx ly ij bi translated">如果恶意软件<em class="np">不是</em>以系统权限运行，它简单地跳过进程枚举函数并继续执行。</p><h2 id="4e56" class="mp ke iq bd kf mq mr dn kj ms mt dp kn lm mu mv kr lq mw mx kv lu my mz kz na bi translated">主机GUID和用户名</h2><p id="1d10" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">在连接到C2节点之前，恶意软件将通过查询SOFTWARE \ Microsoft \ Cryptography注册表项来检索主机的GUID。</p><figure class="nc nd ne nf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nq"><img src="../Images/4862a16c120f173de3b565e2db6ac988.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*naXyekpI7-LN1yW86G11wA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">图9。从注册表中检索主机GUID。</figcaption></figure><p id="d028" class="pw-post-body-paragraph lb lc iq ld b le mb lg lh li mc lk ll lm nh lo lp lq ni ls lt lu nj lw lx ly ij bi translated">该恶意软件还检索当前用户的用户名，并在联系C2节点之前，将其与机器ID一起移动到堆上。</p><h2 id="7866" class="mp ke iq bd kf mq mr dn kj ms mt dp kn lm mu mv kr lq mw mx kv lu my mz kz na bi translated">C2通信</h2><p id="6d3d" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">首先，恶意软件使用WideCharToMultiByte API函数来形成连接到C2节点所需的所有参数，包括machineID、用户名和configID参数，这些参数将通过POST请求发送到C2节点。值得注意的是，configID参数只是在执行的早期用来解密C2 IP地址的RC4密钥。</p><figure class="nc nd ne nf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/23a10a2aaee32c051c4916312e7b252d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ToFR_iD4wWS4xImhDO01Qg.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">图10。向C2节点发送包含machineID、用户名和configID参数的请求。</figcaption></figure><p id="9eb3" class="pw-post-body-paragraph lb lc iq ld b le mb lg lh li mc lk ll lm nh lo lp lq ni ls lt lu nj lw lx ly ij bi translated">恶意软件然后检查来自C2节点的响应是否大于0x3f(十进制63)字符长度。如果是，恶意软件将继续执行。否则，恶意软件会跳出循环并退出。</p><figure class="nc nd ne nf gt jr gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/8e657b66a9602377621dab1bc9c5d525.png" data-original-src="https://miro.medium.com/v2/resize:fit:1028/format:webp/1*owgJSf-rLyaQSJJjlAY0Lw.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">图11。检查C2节点响应的长度。</figcaption></figure><p id="956a" class="pw-post-body-paragraph lb lc iq ld b le mb lg lh li mc lk ll lm nh lo lp lq ni ls lt lu nj lw lx ly ij bi translated">不幸的是，在我进行分析的时候，C2 IP地址似乎不再可用，因为Shodan显示端口3389 (RDP)是唯一的监听端口。假设C2节点仍在运行并能够与受感染的主机通信，C2节点将返回几个不同的DLL供下载到受感染的主机。然后，这些DLL将被放在“C:\ Documents and Settings \ Administrator \ Local Settings \ Application Data”文件夹中。</p><figure class="nc nd ne nf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nk"><img src="../Images/a9c4b69f06537d4e24f3749caab6ab7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_N4e-h3Z7njvCJVDOz-C9A.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">图12。请注意在将下载的DLL移动到该路径之前设置文件夹路径的函数(C:\ Documents and Settings \ Administrator \ Local Settings \ Application Data)</figcaption></figure><figure class="nc nd ne nf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nk"><img src="../Images/4391ac86f92972eca6dd9bd37fb04c9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m9GV7cpDXb2bbfy61sb-VA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">图13。设置要放置DLL的文件夹路径。</figcaption></figure><p id="fc0c" class="pw-post-body-paragraph lb lc iq ld b le mb lg lh li mc lk ll lm nh lo lp lq ni ls lt lu nj lw lx ly ij bi translated">此时，恶意软件将执行其大部分窃取功能，包括cookies、密码、信用卡数据、密码、浏览器历史记录等。[2]这种功能中的一些将自动执行，而一些将需要来自控制C2节点的操作员的命令。</p><h1 id="163b" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated"><strong class="ak">结论</strong></h1><p id="a64c" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">总之，浣熊窃取者v2是一个相对简单，但非常强大的信息窃取者，就像v1一样。这两个版本的窃取者对所有类型的组织以及个人都构成威胁。这种恶意软件窃取的信息可用于接管所有类型的帐户，包括金融、社交媒体、企业等。</p><p id="c1df" class="pw-post-body-paragraph lb lc iq ld b le mb lg lh li mc lk ll lm nh lo lp lq ni ls lt lu nj lw lx ly ij bi translated">我希望你喜欢这篇文章，并希望你会再次回来！一个关注和分享将是超级赞赏。反馈当然也是受欢迎的。</p><h1 id="f3b0" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">参考</h1><p id="d867" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">[1]<a class="ae kc" href="https://www.cybereason.com/blog/research/hunting-raccoon-stealer-the-new-masked-bandit-on-the-block" rel="noopener ugc nofollow" target="_blank">https://www . bleeping computer . com/news/security/浣熊-steaker-is-back-with-a-new-version-to-steak-your-passwords/</a></p><p id="036a" class="pw-post-body-paragraph lb lc iq ld b le mb lg lh li mc lk ll lm nh lo lp lq ni ls lt lu nj lw lx ly ij bi translated">[2]<a class="ae kc" href="https://blog.sekoia.io/raccoon-stealer-v2-part-2-in-depth-analysis/#h-mutex" rel="noopener ugc nofollow" target="_blank">https://blog . seko ia . io/浣熊-偷窃者-v2-part-2-深入分析/#h-mutex </a></p></div><div class="ab cl ns nt hu nu" role="separator"><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx"/></div><div class="ij ik il im in"><h2 id="dbef" class="mp ke iq bd kf mq mr dn kj ms mt dp kn lm mu mv kr lq mw mx kv lu my mz kz na bi translated">来自Infosec的报道:Infosec每天都有很多内容，很难跟上。<a class="ae kc" href="https://weekly.infosecwriteups.com/" rel="noopener ugc nofollow" target="_blank">加入我们的每周简讯</a>以5篇文章、4个线程、3个视频、2个Github Repos和工具以及1个工作提醒的形式免费获取所有最新的Infosec趋势！</h2></div></div>    
</body>
</html>