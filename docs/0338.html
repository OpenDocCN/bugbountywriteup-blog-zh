<html>
<head>
<title>Android Key Attestation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Android密钥证明</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/android-key-attestation-581da703ac16?source=collection_archive---------0-----------------------#2019-07-14">https://infosecwriteups.com/android-key-attestation-581da703ac16?source=collection_archive---------0-----------------------#2019-07-14</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="dbc9" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph">您仍然不确定用户设备的安全性吗？</h2><div class=""/><div class=""><h2 id="c021" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">安全工程师和建筑师的朋友！</h2></div><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/a3c6766362361fef1e415c5c37ec014b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CyGp5mks4BU0GTDwG1udbA.png"/></div></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated">Android领先的市场份额</figcaption></figure><p id="33de" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi md translated"><span class="l me mf mg bm mh mi mj mk ml di"> A </span> ndroid以<a class="ae mm" href="http://gs.statcounter.com/os-market-share/mobile/worldwide" rel="noopener ugc nofollow" target="_blank">超过75% </a>的市场份额引领着当前的移动时代。如今，移动应用不仅用于休闲目的，还用于有大量敏感数据流的关键业务操作。</p><p id="3ed4" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">不过，Android支持沙盒的美好概念，在正常情况下，沙盒不允许一个应用程序访问任何其他应用程序的数据。仍然建议处理敏感数据的应用程序应该考虑安全处理敏感数据的边缘情况。</p><p id="de6c" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated"><a class="ae mm" href="https://developer.android.com/training/articles/keystore" rel="noopener ugc nofollow" target="_blank">API 18级发布的Android Keystore </a>成为安全架构师和开发者的朋友。密钥库仍在增长，并且自发布以来增长显著。不花太多时间，让我们讨论一下添加到Android安全皇冠上的另一个宝石，名为<strong class="lj jd"> <em class="mn"> Android密钥认证</em> </strong>。</p><p id="ed94" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated"><a class="ae mm" href="https://developer.android.com/training/articles/security-key-attestation" rel="noopener ugc nofollow" target="_blank"> <strong class="lj jd">密钥证明</strong> </a>是允许开发者分析由Android密钥库管理的加密材料的安全性的特性。例如，从应用服务器，我们可以启动密钥证明过程，以检查用户使用的设备是否能够安全地存储加密材料，从而做出数据驱动的决策。</p><p id="110c" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">从Android 8.0开始，密钥证明成为强制性的。对于所有需要获得谷歌应用套件设备认证(CTS)的新设备，此类设备使用由<a class="ae mm" href="https://developer.android.com/training/articles/security-key-attestation#root_certificate" rel="noopener ugc nofollow" target="_blank">谷歌硬件认证根证书</a>签名的认证密钥，并可在密钥认证过程中进行验证。</p><p id="b26d" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">在我们深入探讨密钥证明过程之前，让我们简要地讨论一些广泛使用的术语。</p><h1 id="2f00" class="mo mp it bd mq mr ms mt mu mv mw mx my ki mz kj na kl nb km nc ko nd kp ne nf bi translated">驯服术语</h1><p id="3592" class="pw-post-body-paragraph lh li it lj b lk ng kd lm ln nh kg lp lq ni ls lt lu nj lw lx ly nk ma mb mc im bi translated">为了更好地理解密钥证明的概念，让我们来理解与密钥证明相关的一些关键概念。</p><h2 id="0831" class="nl mp it bd mq nm nn dn mu no np dp my lq nq nr na lu ns nt nc ly nu nv ne iz bi translated"><strong class="ak">可信执行环境</strong></h2><p id="4e1d" class="pw-post-body-paragraph lh li it lj b lk ng kd lm ln nh kg lp lq ni ls lt lu nj lw lx ly nk ma mb mc im bi translated"><a class="ae mm" href="https://en.wikipedia.org/wiki/Trusted_execution_environment" rel="noopener ugc nofollow" target="_blank"> TEE </a>(可信执行环境)是主处理器的一个安全区域，用于处理关键数据。它确保敏感数据在一个隔离和可信的环境中存储、处理和保护。</p><p id="1797" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated"><a class="ae mm" href="https://en.wikipedia.org/wiki/ARM_architecture" rel="noopener ugc nofollow" target="_blank"> ARM </a>(高级<a class="ae mm" href="https://en.wikipedia.org/wiki/Reduced_instruction_set_computer" rel="noopener ugc nofollow" target="_blank"> RISC </a>(精简指令集计算机)通过<a class="ae mm" href="https://www.arm.com/products/security-on-arm/trustzone" rel="noopener ugc nofollow" target="_blank"> <em class="mn"> ARM Trustzone </em> </a>实现了三通的概念。这项技术提供了硬件特性来创建一个与正常执行环境相分离的安全环境。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/28c7daea1121e787713d369358529235.png" data-original-src="https://miro.medium.com/v2/resize:fit:1062/0*LNM3AeCBQFNtKOr9"/></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated"><a class="ae mm" href="http://www.cs.kun.nl/~erikpoll/publications/AndroidSecureStorage.pdf" rel="noopener ugc nofollow" target="_blank"> <em class="nx"> ARM信任区</em> </a></figcaption></figure><p id="45b4" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">如上所示，两个世界中的硬件是分离的，即安全世界和普通世界。创建了包括虚拟处理器和虚拟资源的两个隔离的虚拟环境，使得在正常世界中运行的进程不能直接访问安全资源。</p><h2 id="7265" class="nl mp it bd mq nm nn dn mu no np dp my lq nq nr na lu ns nt nc ly nu nv ne iz bi translated">钥匙大师</h2><p id="cb18" class="pw-post-body-paragraph lh li it lj b lk ng kd lm ln nh kg lp lq ni ls lt lu nj lw lx ly nk ma mb mc im bi translated"><a class="ae mm" href="https://source.android.com/security/keystore#glossary" rel="noopener ugc nofollow" target="_blank"> Keymaster TA </a>(可信应用)是一款在基于ARM的设备上运行于TrustZone等安全环境中的软件。密钥管理员可以访问通过密钥库管理的原始加密材料，并执行所有密钥库操作。</p><h2 id="801b" class="nl mp it bd mq nm nn dn mu no np dp my lq nq nr na lu ns nt nc ly nu nv ne iz bi translated">保险箱</h2><p id="eb7e" class="pw-post-body-paragraph lh li it lj b lk ng kd lm ln nh kg lp lq ni ls lt lu nj lw lx ly nk ma mb mc im bi translated">StrongBox是硬件支持的密钥库的更严格的实现，因为Keymaster HAL(硬件抽象层)是作为硬件安全模块(HSM)实现的。该模块包含其自己的CPU、安全存储器、真随机数发生器等。它是在Android Pie中引入的，支持Android 9及以上版本的设备可以有TrustZone实现，StrongBox实现或者两者都有。</p><h1 id="be58" class="mo mp it bd mq mr ms mt mu mv mw mx my ki mz kj na kl nb km nc ko nd kp ne nf bi translated">密钥证明过程</h1><p id="9db0" class="pw-post-body-paragraph lh li it lj b lk ng kd lm ln nh kg lp lq ni ls lt lu nj lw lx ly nk ma mb mc im bi translated">在密钥证明过程中，我们可以指定密钥对的别名，作为回报，我们可以获得一个证书链，该证书链稍后用于验证密钥对的属性。以下API可用于检索证书链:</p><pre class="ks kt ku kv gt ny nz oa ob aw oc bi"><span id="eca4" class="nl mp it nz b gy od oe l of og">public final <a class="ae mm" href="https://developer.android.com/reference/java/security/cert/Certificate.html" rel="noopener ugc nofollow" target="_blank">Certificate[]</a> getCertificateChain (<a class="ae mm" href="https://developer.android.com/reference/java/lang/String.html" rel="noopener ugc nofollow" target="_blank">String</a> alias)</span></pre><p id="b2db" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">在证明过程中，如果满足以下条件，则意味着底层设备支持硬件级密钥证明，并且密钥材料由硬件支持的密钥库管理:</p><ol class=""><li id="5300" class="oh oi it lj b lk ll ln lo lq oj lu ok ly ol mc om on oo op bi translated">证书链中的根证书是Google硬件证明根证书。</li><li id="9c8e" class="oh oi it lj b lk oq ln or lq os lu ot ly ou mc om on oo op bi translated">Keymaster的安全级别为<em class="mn">可信环境</em>或<em class="mn">保险箱</em>。</li></ol><p id="6ba4" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">或者，如果第一个条件失败，即证明链具有任何其他根证书，则Google不对硬件的安全性做出任何声明。</p><h1 id="af61" class="mo mp it bd mq mr ms mt mu mv mw mx my ki mz kj na kl nb km nc ko nd kp ne nf bi translated">关键证明实施指南</h1><p id="3e78" class="pw-post-body-paragraph lh li it lj b lk ng kd lm ln nh kg lp lq ni ls lt lu nj lw lx ly nk ma mb mc im bi translated">密钥证明过程可以直接在应用程序中实现，但出于安全原因，建议在服务器端实现，这将在后一节中解释。</p><p id="946a" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">以下是安全实现密钥证明的高级指导原则:</p><ol class=""><li id="375b" class="oh oi it lj b lk ll ln lo lq oj lu ok ly ol mc om on oo op bi translated">服务器应通过使用CSPRNG(加密安全随机数生成器)安全地创建一个随机数来启动密钥证明过程，并将该随机数作为质询发送给客户端。</li><li id="3dfa" class="oh oi it lj b lk oq ln or lq os lu ot ly ou mc om on oo op bi translated">客户端应该使用从服务器收到的挑战调用<code class="fe ov ow ox nz b">setAttestationChallenge()</code> API，然后应该使用<code class="fe ov ow ox nz b">KeyStore.getCertificateChain()</code>方法检索证明证书链。</li><li id="367e" class="oh oi it lj b lk oq ln or lq os lu ot ly ou mc om on oo op bi translated">应该将证明响应发送到服务器进行验证，并且应该执行以下检查来验证密钥证明响应:</li></ol><ul class=""><li id="e969" class="oh oi it lj b lk ll ln lo lq oj lu ok ly ol mc oy on oo op bi translated">验证证书链，直到根，并执行证书健全性检查，如有效性、完整性和可信度。</li><li id="c151" class="oh oi it lj b lk oq ln or lq os lu ot ly ou mc oy on oo op bi translated">检查根证书是否用Google认证根密钥签名，这使得认证过程可信。</li><li id="9c28" class="oh oi it lj b lk oq ln or lq os lu ot ly ou mc oy on oo op bi translated">提取证明证书扩展数据，该数据出现在证书链的第一个元素中，并执行以下检查:</li></ul><pre class="ks kt ku kv gt ny nz oa ob aw oc bi"><span id="0603" class="nl mp it nz b gy od oe l of og">a. Verify that the attestation challenge is having the same value which was generated at the server while initiating the attestation process</span><span id="8c71" class="nl mp it nz b gy oz oe l of og">b. Verify the signature in the key attestation response.</span><span id="ff5d" class="nl mp it nz b gy oz oe l of og">c. Now check the security level of the Keymaster to determine if the device has a secure key storage mechanism. The security level will be one of <em class="mn">Software</em>, <em class="mn">TrustedEnvironment</em> or <em class="mn">StrongBox</em>.</span><span id="fa63" class="nl mp it nz b gy oz oe l of og">d. Additionally, you can check the attestation security level which will be one of <em class="mn">Software</em>, <em class="mn">TrustedEnvironment</em> or <em class="mn">StrongBox</em> to check how the attestation certificate was generated.</span><span id="9a4d" class="nl mp it nz b gy oz oe l of og">e. Also, some other checks pertaining to keys can be made such as purpose, access time, authentication requirement, etc. to verify the key attributes.</span></pre><h1 id="d8ac" class="mo mp it bd mq mr ms mt mu mv mw mx my ki mz kj na kl nb km nc ko nd kp ne nf bi translated">解码证明响应</h1><p id="3baf" class="pw-post-body-paragraph lh li it lj b lk ng kd lm ln nh kg lp lq ni ls lt lu nj lw lx ly nk ma mb mc im bi translated">为了更好地理解密钥证明过程，让我们了解一下证明响应。典型的Android密钥库证明响应如下所示:</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pa pb l"/></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated">证明响应</figcaption></figure><p id="bec5" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">证明响应JSON中的关键字具有以下含义:</p><ul class=""><li id="15a9" class="oh oi it lj b lk ll ln lo lq oj lu ok ly ol mc oy on oo op bi translated"><code class="fe ov ow ox nz b">fmt</code>:证明声明格式标识</li><li id="9f2b" class="oh oi it lj b lk oq ln or lq os lu ot ly ou mc oy on oo op bi translated"><code class="fe ov ow ox nz b">authData</code>:表示认证的认证者数据</li><li id="7f55" class="oh oi it lj b lk oq ln or lq os lu ot ly ou mc oy on oo op bi translated"><code class="fe ov ow ox nz b">alg</code>:用于计算证明响应签名的算法</li><li id="970c" class="oh oi it lj b lk oq ln or lq os lu ot ly ou mc oy on oo op bi translated"><code class="fe ov ow ox nz b">sig</code>:认证响应签名</li><li id="700a" class="oh oi it lj b lk oq ln or lq os lu ot ly ou mc oy on oo op bi translated"><code class="fe ov ow ox nz b">x5c</code>:证明证书链</li></ul><h2 id="3e92" class="nl mp it bd mq nm nn dn mu no np dp my lq nq nr na lu ns nt nc ly nu nv ne iz bi translated">签名生成和验证</h2><p id="7f3b" class="pw-post-body-paragraph lh li it lj b lk ng kd lm ln nh kg lp lq ni ls lt lu nj lw lx ly nk ma mb mc im bi translated">通过连接<code class="fe ov ow ox nz b">authData</code>和<code class="fe ov ow ox nz b">clientDataHash</code>(由服务器发送的挑战)并使用<code class="fe ov ow ox nz b">alg</code>签名算法通过凭证私钥进行签名来生成<code class="fe ov ow ox nz b">sig</code>，并且通过使用第一证书中的公钥在服务器端对其进行验证。</p><p id="3171" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">这意味着挑战在密钥证明实现的安全性中起着重要的作用。在实现密钥证明时，强烈建议应在服务器端执行验证，所使用的质询应在服务器端使用加密安全的随机数生成器生成，并且应在证明时进行验证。</p><p id="dceb" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">Android密钥认证的示例代码片段可在<a class="ae mm" href="https://github.com/googlesamples/android-key-attestation/tree/master/server" rel="noopener ugc nofollow" target="_blank"> GoogleSamples </a> repo上获得。</p><h1 id="0525" class="mo mp it bd mq mr ms mt mu mv mw mx my ki mz kj na kl nb km nc ko nd kp ne nf bi translated">参考</h1><ul class=""><li id="2ab7" class="oh oi it lj b lk ng ln nh lq pc lu pd ly pe mc oy on oo op bi translated"><a class="ae mm" href="https://medium.com/@herrjemand/webauthn-fido2-verifying-android-keystore-attestation-4a8835b33e9d" rel="noopener"> WebAuthn/FIDO2 </a>:验证Android密钥库证明</li><li id="3763" class="oh oi it lj b lk oq ln or lq os lu ot ly ou mc oy on oo op bi translated"><a class="ae mm" href="https://fidoalliance.org/wp-content/uploads/Hardware-backed_Keystore_White_Paper_June2018.pdf" rel="noopener ugc nofollow" target="_blank"> FIDO联盟白皮书</a></li><li id="aa63" class="oh oi it lj b lk oq ln or lq os lu ot ly ou mc oy on oo op bi translated"><a class="ae mm" href="https://fidoalliance.org/fido-technotes-the-truth-about-attestation/" rel="noopener ugc nofollow" target="_blank"> FIDO联盟技术说明</a></li><li id="8093" class="oh oi it lj b lk oq ln or lq os lu ot ly ou mc oy on oo op bi translated"><a class="ae mm" href="https://developer.android.com/training/articles/security-key-attestation" rel="noopener ugc nofollow" target="_blank">安卓密钥认证</a></li><li id="4ec1" class="oh oi it lj b lk oq ln or lq os lu ot ly ou mc oy on oo op bi translated"><a class="ae mm" href="https://www.w3.org/TR/webauthn/#android-key-attestation" rel="noopener ugc nofollow" target="_blank"> W3C Android密钥认证</a></li><li id="1067" class="oh oi it lj b lk oq ln or lq os lu ot ly ou mc oy on oo op bi translated"><a class="ae mm" href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Authentication_API/Attestation_and_Assertion" rel="noopener ugc nofollow" target="_blank"> Mozilla:证明和断言</a></li><li id="b1b4" class="oh oi it lj b lk oq ln or lq os lu ot ly ou mc oy on oo op bi translated"><a class="ae mm" href="https://dl.packetstormsecurity.net/papers/general/The_Grey_Matter_of_Securing_Android_Applications_v1.0.pdf" rel="noopener ugc nofollow" target="_blank">保护安卓应用的灰色问题</a></li></ul></div></div>    
</body>
</html>