<html>
<head>
<title>MiniDumpWriteDump via Faultrep!CreateMinidump</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过Faultrep的MiniDumpWriteDump！创建小型转储</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/minidumpwritedump-via-faultrep-createminidump-497efbafe040?source=collection_archive---------1-----------------------#2020-01-27">https://infosecwriteups.com/minidumpwritedump-via-faultrep-createminidump-497efbafe040?source=collection_archive---------1-----------------------#2020-01-27</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="0f79" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我在Windows XP和Windows Server 2003的faultrep.dll中发现了这个旧的未记录的API“CreateMinidumpW”。这个API最终调用dbghelp！通过在运行时动态加载dbghelp.dll来转储进程。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi ko"><img src="../Images/612f700ddf3af139c4719a150ac9b48a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1070/0*PMFcY4tY_kpEDUJO"/></div></figure><p id="2123" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">该函数有3个参数。我真的不知道第三个论点的结构是什么。我将0作为指向该结构的指针传递，因此默认情况下，我们最终得到0x21作为MINIDUMP_TYPE。</p></div><div class="ab cl kw kx hx ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="im in io ip iq"><pre class="kp kq kr ks gt ld le lf lg aw lh bi"><span id="eb1c" class="li lj it le b gy lk ll l lm ln">CreateMinidumpW(<strong class="le iu">DWORD</strong> <!-- -->dwProcessId, <strong class="le iu">LPCWSTR</strong> <!-- -->lpFileName, <strong class="le iu">struct</strong> <!-- -->tagSMDumpOptions *)</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi lo"><img src="../Images/7df1ffc8cb587990489d9d469db7a664.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/0*sImXmHLwb-DkkSXJ"/></div></figure><p id="31f8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这是调用堆栈</p><pre class="kp kq kr ks gt ld le lf lg aw lh bi"><span id="3c9d" class="li lj it le b gy lk ll l lm ln">dbgcore.dll!_MiniDumpWriteDump@28</span><span id="f5a6" class="li lj it le b gy lp ll l lm ln">faultrep.dll!InternalGenerateMinidumpEx(<strong class="le iu">void</strong> <!-- -->*,unsigned <strong class="le iu">long</strong>,<strong class="le iu">void</strong> <!-- -->*,<strong class="le iu">struct</strong> <!-- -->tagSMDumpOptions *,unsigned <strong class="le iu">short</strong> <strong class="le iu">const</strong> <!-- -->*,<strong class="le iu">int</strong>)</span><span id="c7ab" class="li lj it le b gy lp ll l lm ln">faultrep.dll!InternalGenerateMinidump(<strong class="le iu">void</strong> <!-- -->*,unsigned <strong class="le iu">long</strong>,unsigned <strong class="le iu">short</strong> <strong class="le iu">const</strong> <!-- -->*,<strong class="le iu">struct</strong> <!-- -->tagSMDumpOptions *,<strong class="le iu">int</strong>)</span><span id="e4f9" class="li lj it le b gy lp ll l lm ln">faultrep.dll!CreateMinidumpW(unsigned <strong class="le iu">long</strong>,unsigned <strong class="le iu">short</strong> <strong class="le iu">const</strong> <!-- -->*,<strong class="le iu">struct</strong> <!-- -->tagSMDumpOptions *)</span></pre><p id="782d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如您所见，它调用了dbghelp！通过使用LoadLibraryExW API加载dbghelp.dll来实现。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi lo"><img src="../Images/214214e0f1e8178f64ea8688ee30a539.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/0*rcbDKwcVGzL41WIN"/></div></figure><p id="bbf2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">但是，这个函数' faultrep.dll！“InternalGenerateMinidumpEx”不提供完全转储。正如你所看到的，它传递了0x21，或者它比较了第三个参数，这是一个结构，基于这个值，它传递了0x325。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi lo"><img src="../Images/066108d708f3ab629a7639acb9a201b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/0*YgWQdhxxy5kyZIBd"/></div></figure><pre class="kp kq kr ks gt ld le lf lg aw lh bi"><span id="1c24" class="li lj it le b gy lk ll l lm ln">0x21 = MiniDumpWithDataSegs | MiniDumpWithUnloadedModules	</span><span id="d7c9" class="li lj it le b gy lp ll l lm ln">0x325 = MiniDumpWithDataSegs | MiniDumpWithHandleData | MiniDumpWithPrivateReadWriteMemory | MiniDumpWithProcessThreadData | MiniDumpWithUnloadedModules</span></pre><p id="f6b0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">你可以做的是，将它修补为0x2，使其成为“MiniDumpWithFullMemory”。您可以从这里找到64位版本的修补DLL</p><div class="lq lr gp gr ls lt"><a href="https://github.com/OsandaMalith/WindowsInternals/tree/master/CreateMinidump" rel="noopener  ugc nofollow" target="_blank"><div class="lu ab fo"><div class="lv ab lw cl cj lx"><h2 class="bd iu gy z fp ly fr fs lz fu fw is bi translated">OsandaMalith/windows内部</h2><div class="ma l"><h3 class="bd b gy z fp ly fr fs lz fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="mb l"><p class="bd b dl z fp ly fr fs lz fu fw dk translated">github.com</p></div></div><div class="mc l"><div class="md l me mf mg mc mh ku lt"/></div></div></a></div><p id="11be" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这是调用这个API的PoC。您可以从Windows XP中复制DLL，它会工作得很好。不知道这有什么用。只是分享一下我的发现:)</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="mi mj l"/></div></figure><p id="9d3e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我为32位和64位faultrep DLLs编写了一个热补丁。它将允许您通过将MiniDumpWithFullMemory作为MINIDUMP_TYPE来获得一个完整的进程转储。已在Windows XP 32位和64位上测试。在其他系统上，通过将原始dll复制到同一个文件夹中就可以了。你可以从这里找到带有DLL文件的repo</p><div class="lq lr gp gr ls lt"><a href="https://github.com/OsandaMalith/WindowsInternals/tree/master/CreateMinidump/Hot%20Patch" rel="noopener  ugc nofollow" target="_blank"><div class="lu ab fo"><div class="lv ab lw cl cj lx"><h2 class="bd iu gy z fp ly fr fs lz fu fw is bi translated">OsandaMalith/windows内部</h2><div class="ma l"><h3 class="bd b gy z fp ly fr fs lz fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="mb l"><p class="bd b dl z fp ly fr fs lz fu fw dk translated">github.com</p></div></div><div class="mc l"><div class="mk l me mf mg mc mh ku lt"/></div></div></a></div><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="mi mj l"/></div></figure><p id="d91c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">一些用途:)</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="ml mj l"/></div></figure></div><div class="ab cl kw kx hx ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="im in io ip iq"><p id="dfe7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="mm">关注</em> <a class="ae mn" href="https://medium.com/bugbountywriteup" rel="noopener"> <em class="mm"> Infosec报道</em> </a> <em class="mm">获取更多此类精彩报道。</em></p><div class="lq lr gp gr ls lt"><a href="https://medium.com/bugbountywriteup" rel="noopener follow" target="_blank"><div class="lu ab fo"><div class="lv ab lw cl cj lx"><h2 class="bd iu gy z fp ly fr fs lz fu fw is bi translated">信息安全报道</h2><div class="ma l"><h3 class="bd b gy z fp ly fr fs lz fu fw dk translated">收集了世界上最好的黑客的文章，主题从bug奖金和CTF到vulnhub…</h3></div><div class="mb l"><p class="bd b dl z fp ly fr fs lz fu fw dk translated">medium.com</p></div></div><div class="mc l"><div class="mo l me mf mg mc mh ku lt"/></div></div></a></div></div></div>    
</body>
</html>