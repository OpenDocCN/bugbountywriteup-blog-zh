<html>
<head>
<title>Active — A Kerberos and Active Directory HackTheBox Walkthrough</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Active—Kerberos和Active Directory黑客盒子演练</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/active-a-kerberos-and-active-directory-hackthebox-walkthrough-fed9bf755d15?source=collection_archive---------0-----------------------#2018-12-10">https://infosecwriteups.com/active-a-kerberos-and-active-directory-hackthebox-walkthrough-fed9bf755d15?source=collection_archive---------0-----------------------#2018-12-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/e423e4b2ef7154fe16c2439b4dddd9b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CGqaoHjmiL5Bl7wujgY6mw.png"/></div></div></figure><h1 id="4f06" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">摘要</h1><p id="2374" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">Active是一个windows Active Directory服务器，它在SMB共享中包含一个可通过匿名登录访问的<code class="fe lu lv lw lx b">Groups.xml</code>文件。该文件包含一个用户帐户的组策略首选项密码，该密码随后被破解，以便获得对用户标志具有读取权限的服务帐户的访问权限。</p><p id="7eff" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt ij bi translated">通过获取与服务帐户相关联的服务主体名称并检索管理员的Kerberos 5哈希来提升权限。通过psexec之类的工具安装/执行任意服务，可以破解并授予对文件系统和交互式外壳的读/写访问权限。</p><h1 id="12a6" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">侦察</h1><p id="568b" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">我开始在这台主机上进行侦察，用<code class="fe lu lv lw lx b">nmap</code>扫描检查服务版本，并在前1000个最常见的端口上运行默认脚本:</p><pre class="md me mf mg gt mh lx mi mj aw mk bi"><span id="4d8d" class="ml jz iq lx b gy mm mn l mo mp">nmap -sV -sC 10.10.10.100</span></pre><figure class="md me mf mg gt jr"><div class="bz fp l di"><div class="mq mr l"/></div><figcaption class="ms mt gj gh gi mu mv bd b be z dk translated">纳米粒子加速器</figcaption></figure><p id="c01f" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt ij bi translated">这返回了大量端口。由于DNS、Kerberos和LDAP是这台机器上无数服务和端口的一部分，它看起来像是一个域控制器。允许直接用户交互的服务不多，由于缺少在端口445上为SMB收集的信息，这是主机上枚举的下一个目标。</p><pre class="md me mf mg gt mh lx mi mj aw mk bi"><span id="cb76" class="ml jz iq lx b gy mm mn l mo mp">smbclient -L //10.10.10.100 -N</span></pre><blockquote class="mw mx my"><p id="6a1b" class="kw kx mz ky b kz ly lb lc ld lz lf lg na ma lj lk nb mb ln lo nc mc lr ls lt ij bi translated"><code class="fe lu lv lw lx b">-L</code> —上市股票</p><p id="e287" class="kw kx mz ky b kz ly lb lc ld lz lf lg na ma lj lk nb mb ln lo nc mc lr ls lt ij bi translated"><code class="fe lu lv lw lx b">-N</code> —匿名登录</p></blockquote><figure class="md me mf mg gt jr"><div class="bz fp l di"><div class="mq mr l"/></div><figcaption class="ms mt gj gh gi mu mv bd b be z dk translated">中小企业股份</figcaption></figure><p id="2206" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt ij bi translated">同样，这个简单的枚举步骤返回了几个结果。查看对多个SMB共享的访问的一种快速方法是通过一个叫做<code class="fe lu lv lw lx b">smbmap</code>的工具:</p><pre class="md me mf mg gt mh lx mi mj aw mk bi"><span id="57b3" class="ml jz iq lx b gy mm mn l mo mp">smbmap -H 10.10.10.100</span></pre><figure class="md me mf mg gt jr"><div class="bz fp l di"><div class="mq mr l"/></div><figcaption class="ms mt gj gh gi mu mv bd b be z dk translated">smbmap</figcaption></figure><p id="93f4" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt ij bi translated">经过一些检查后，<code class="fe lu lv lw lx b">Replication</code>共享返回了一个<code class="fe lu lv lw lx b">Groups.xml</code>文件，路径为:</p><pre class="md me mf mg gt mh lx mi mj aw mk bi"><span id="5fb5" class="ml jz iq lx b gy mm mn l mo mp">\active.htb\Policies\{31B2F340–016D-11D2–945F-00C04FB984F9}\MACHINE\Preferences\Groups\Groups.xml</span></pre><p id="a13a" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt ij bi translated">查看该文件的内容:</p><figure class="md me mf mg gt jr"><div class="bz fp l di"><div class="mq mr l"/></div><figcaption class="ms mt gj gh gi mu mv bd b be z dk translated">Groups.xml</figcaption></figure><h1 id="a582" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">最初的立足点</h1><p id="6d35" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">有一个用户名<code class="fe lu lv lw lx b">active.htb\SVC_TGS</code>，其值<code class="fe lu lv lw lx b">cpassword</code>包含AES加密的密码。已经创建了几个工具来破解这些密码，其中包括我从PowerSploit中提取的一个函数，以便破解这个文件:</p><figure class="md me mf mg gt jr"><div class="bz fp l di"><div class="mq mr l"/></div><figcaption class="ms mt gj gh gi mu mv bd b be z dk translated">Get-DecryptedCpassword</figcaption></figure><p id="d701" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt ij bi translated">该函数接收组策略首选项密码作为命令行参数，并返回明文字符串。这甚至可以在macOS上的PowerShell Core中运行！</p><figure class="md me mf mg gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nd"><img src="../Images/d077ece0464274ccb305a6e286a4179b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-OUsLpOzd8jLNKscUW5JSw.png"/></div></div><figcaption class="ms mt gj gh gi mu mv bd b be z dk translated">PowerShell核心上的Get-DecryptedCpassword</figcaption></figure><p id="d44b" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt ij bi translated">幸运的是，Kali附带了一个内置工具来解密这个名为<code class="fe lu lv lw lx b">gpp-decrypt</code>的密码:</p><figure class="md me mf mg gt jr"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="93a5" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt ij bi translated">这两种方法都返回相同的密码，并且该帐户能够访问<code class="fe lu lv lw lx b">Users</code>共享并查看<code class="fe lu lv lw lx b">user.txt</code>标志。</p><h1 id="a4d9" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">权限提升</h1><p id="52a7" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">使用<a class="ae ne" href="https://www.secureauth.com/labs/open-source-tools/impacket" rel="noopener ugc nofollow" target="_blank">入包</a>的<code class="fe lu lv lw lx b">GetUserSPNs.py</code>模块，<code class="fe lu lv lw lx b">active.htb\SVC_TGS</code>账户能够找到并获取与普通用户账户相关联的服务主体名称。以下命令列出了管理员帐户</p><pre class="md me mf mg gt mh lx mi mj aw mk bi"><span id="13d0" class="ml jz iq lx b gy mm mn l mo mp">./GetUserSPNs.py active.htb/SVC_TGS:GPPstillStandingStrong2k18 -dc-ip 10.10.10.100 -request</span></pre><blockquote class="mw mx my"><p id="8281" class="kw kx mz ky b kz ly lb lc ld lz lf lg na ma lj lk nb mb ln lo nc mc lr ls lt ij bi translated"><code class="fe lu lv lw lx b">-dc-ip</code> —域控制器的IP地址</p><p id="8949" class="kw kx mz ky b kz ly lb lc ld lz lf lg na ma lj lk nb mb ln lo nc mc lr ls lt ij bi translated"><code class="fe lu lv lw lx b">-request</code> —为用户请求TGS，并以JtR/hashcat格式输出</p></blockquote><figure class="md me mf mg gt jr"><div class="bz fp l di"><div class="mq mr l"/></div><figcaption class="ms mt gj gh gi mu mv bd b be z dk translated">GetUserSPNs.py</figcaption></figure><p id="4d54" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt ij bi translated">这返回了一个Kerberos 5哈希，hashcat可以使用<code class="fe lu lv lw lx b">rockyou.txt</code>单词表和参数破解这个哈希:</p><pre class="md me mf mg gt mh lx mi mj aw mk bi"><span id="9f7c" class="ml jz iq lx b gy mm mn l mo mp">hashcat -m 13100 -d 3 -a 0 -o Active.txt Administrator.hash rockyou.dict</span></pre><p id="2837" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt ij bi translated">破解后的密码被写入<code class="fe lu lv lw lx b">Active.txt</code>。读取文件返回明文密码<code class="fe lu lv lw lx b">Ticketmaster1968</code>。这些凭证可以用来访问<code class="fe lu lv lw lx b">root.txt</code>标志。</p><p id="bcb1" class="pw-post-body-paragraph kw kx iq ky b kz ly lb lc ld lz lf lg lh ma lj lk ll mb ln lo lp mc lr ls lt ij bi translated">使用诸如<code class="fe lu lv lw lx b">psexec</code>之类的工具可以获得一个交互式外壳。许多操作类似于<code class="fe lu lv lw lx b">psexec</code>的工具，如<a class="ae ne" href="https://www.secureauth.com/labs/open-source-tools/impacket" rel="noopener ugc nofollow" target="_blank">插件</a>中的模块，允许命名安装和移除的服务。为安装后不久可能会被删除的内容选择一个服务名，例如对反病毒客户端的<a class="ae ne" href="https://support.symantec.com/en_US/article.TECH102748.html" rel="noopener ugc nofollow" target="_blank">更新，这是一个有助于避免检测的简单步骤。</a></p><pre class="md me mf mg gt mh lx mi mj aw mk bi"><span id="fc74" class="ml jz iq lx b gy mm mn l mo mp">./psexec.py active.htb/Administrator:Ticketmaster1968@10.10.10.100 -service-name LUALL.exe</span></pre><figure class="md me mf mg gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nf"><img src="../Images/948fb1585c2ce63cca9f475bbd90d900.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qq469tqv8ojLhNxE86_KVQ.png"/></div></div><figcaption class="ms mt gj gh gi mu mv bd b be z dk translated">交互式外壳作为系统</figcaption></figure></div></div>    
</body>
</html>