<html>
<head>
<title>Stratosphere — An Apache Struts-Shock HackTheBox Walkthrough</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">平流层—Apache Struts-Shock HackTheBox演练</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/stratosphere-an-apache-struts-shock-hackthebox-walkthrough-daa6282c8eed?source=collection_archive---------0-----------------------#2018-09-02">https://infosecwriteups.com/stratosphere-an-apache-struts-shock-hackthebox-walkthrough-daa6282c8eed?source=collection_archive---------0-----------------------#2018-09-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/700f6828d08a084b018da923679aa729.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tr_1PJvpg_DCfHE9REXIPw.jpeg"/></div></div></figure><h1 id="b096" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">摘要</h1><p id="94cc" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">同温层是运行web服务器的Linux主机，易受CVE 2017–5638:Apache Struts 2中的一个严重漏洞的攻击，该漏洞被利用来以低权限用户的身份在系统上远程执行代码。本地枚举返回了用于访问MySQL本地实例的凭据。这个数据库包含凭证，这些凭证随后被用来作为拥有执行单个Python 2脚本的<code class="fe lu lv lw lx b">sudo</code>特权的用户SSH到机器上。Python 2的输入净化和库导入功能被利用来获得系统的root权限。</p><h1 id="ee69" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">侦察</h1><p id="2deb" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">我开始使用<code class="fe lu lv lw lx b">nmap</code>对这台主机进行全端口扫描，并使用一些参数来提高扫描速度:</p><pre class="ly lz ma mb gt mc lx md me aw mf bi"><span id="4e78" class="mg jz iq lx b gy mh mi l mj mk">nmap -sT --min-rate 5000 --max-retries 1 -p- 10.10.10.64</span></pre><blockquote class="ml mm mn"><p id="e226" class="kw kx mo ky b kz mp lb lc ld mq lf lg mr ms lj lk mt mu ln lo mv mw lr ls lt ij bi translated"><code class="fe lu lv lw lx b">-sT</code> — TCP连接扫描<br/> <code class="fe lu lv lw lx b">--min-rate</code> —使nmap尝试将发送速率保持在或高于指定的每秒数据包数(本例中为每秒5000个数据包)<br/> <code class="fe lu lv lw lx b">--max-retries</code> —限制重新传输次数<br/> <code class="fe lu lv lw lx b">-p-</code> —扫描所有端口；1到65535</p></blockquote><figure class="ly lz ma mb gt jr"><div class="bz fp l di"><div class="mx my l"/></div><figcaption class="mz na gj gh gi nb nc bd b be z dk translated">全端口扫描</figcaption></figure><p id="1989" class="pw-post-body-paragraph kw kx iq ky b kz mp lb lc ld mq lf lg lh ms lj lk ll mu ln lo lp mw lr ls lt ij bi translated">它能够在不到30秒的时间内扫描每个端口！虽然有噪声，但这种方法对于快速返回不常用的端口非常有用。</p><p id="bd93" class="pw-post-body-paragraph kw kx iq ky b kz mp lb lc ld mq lf lg lh ms lj lk ll mu ln lo lp mw lr ls lt ij bi translated">随后我又进行了一次扫描，以枚举服务版本并在3个开放的端口上运行默认脚本，但是<code class="fe lu lv lw lx b">nmap</code>无法识别端口80和8080。每当这种情况发生时，<code class="fe lu lv lw lx b">nmap</code>将以原始html格式将多个请求的响应返回给终端，以便向用户呈现手动识别服务的结果。它弄乱了扫描结果，所以我在下面的输出中用<code class="fe lu lv lw lx b">…</code>编辑了它:</p><pre class="ly lz ma mb gt mc lx md me aw mf bi"><span id="a466" class="mg jz iq lx b gy mh mi l mj mk">nmap -sV -sC -p22,80,8080 10.10.10.64</span></pre><blockquote class="ml mm mn"><p id="8994" class="kw kx mo ky b kz mp lb lc ld mq lf lg mr ms lj lk mt mu ln lo mv mw lr ls lt ij bi translated"><code class="fe lu lv lw lx b">-sV</code> —服务版本扫描<br/> <code class="fe lu lv lw lx b">-sC</code> —运行默认脚本<br/> <code class="fe lu lv lw lx b">-p</code> —指定端口</p></blockquote><figure class="ly lz ma mb gt jr"><div class="bz fp l di"><div class="mx my l"/></div><figcaption class="mz na gj gh gi nb nc bd b be z dk translated">服务版本和默认脚本</figcaption></figure><p id="aeb4" class="pw-post-body-paragraph kw kx iq ky b kz mp lb lc ld mq lf lg lh ms lj lk ll mu ln lo lp mw lr ls lt ij bi translated">这个扫描能够从端口22上的SSH服务返回一个Debian主机。对web服务进行指纹识别要稍微困难一些。在这里，我访问了端口80和8080上的web服务的主页，它们看起来是相同的:</p><figure class="ly lz ma mb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nd"><img src="../Images/f239e0c000f018d30ee2baa62ed99964.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_uugINpwXBuwHmGnjDQlDw.png"/></div></div><figcaption class="mz na gj gh gi nb nc bd b be z dk translated">主页</figcaption></figure><p id="8da1" class="pw-post-body-paragraph kw kx iq ky b kz mp lb lc ld mq lf lg lh ms lj lk ll mu ln lo lp mw lr ls lt ij bi translated">导航到“开始”链接返回了一个简单的页面，上面写着“网站正在建设中”。请稍后再来查看。”…所以我需要在服务器上寻找其他东西。</p><p id="9435" class="pw-post-body-paragraph kw kx iq ky b kz mp lb lc ld mq lf lg lh ms lj lk ll mu ln lo lp mw lr ls lt ij bi translated">从这里，我开始在端口80和8080上使用<code class="fe lu lv lw lx b">gobuster</code>枚举web目录。这些返回了相同的结果。</p><pre class="ly lz ma mb gt mc lx md me aw mf bi"><span id="6b17" class="mg jz iq lx b gy mh mi l mj mk">gobuster -u <a class="ae ne" href="http://10.10.10.64" rel="noopener ugc nofollow" target="_blank">http://10.10.10.64</a> -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt</span></pre><figure class="ly lz ma mb gt jr"><div class="bz fp l di"><div class="mx my l"/></div><figcaption class="mz na gj gh gi nb nc bd b be z dk translated">gobuster</figcaption></figure><p id="6185" class="pw-post-body-paragraph kw kx iq ky b kz mp lb lc ld mq lf lg lh ms lj lk ll mu ln lo lp mw lr ls lt ij bi translated">这次扫描返回了两个web目录:<code class="fe lu lv lw lx b">/manager</code>和<code class="fe lu lv lw lx b">/Monitoring</code>。<code class="fe lu lv lw lx b">/manager</code>目录是一个受密码保护的Tomcat管理页面。因为我们在这一点上没有任何凭证，所以它不是非常有用，但是现在知道它正在运行Apache Tomcat是有帮助的。</p><p id="7d43" class="pw-post-body-paragraph kw kx iq ky b kz mp lb lc ld mq lf lg lh ms lj lk ll mu ln lo lp mw lr ls lt ij bi translated">第二个目录更有趣一些，<code class="fe lu lv lw lx b">/Monitoring</code>实际上被重定向到了<code class="fe lu lv lw lx b">/Monitoring/example/Welcome.action</code>。该页面还提供了登录或注册账户的链接。然而，与主页上的“入门”链接一样，这些链接只返回了一条消息:“此功能正在建设中。请在下一次迭代中重试。</p><figure class="ly lz ma mb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nf"><img src="../Images/415d9b99bff0e2d95f97186ae9991002.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SvV6BzET-clrmacK_DzGYQ.png"/></div></div><figcaption class="mz na gj gh gi nb nc bd b be z dk translated">欢迎，行动</figcaption></figure><p id="d656" class="pw-post-body-paragraph kw kx iq ky b kz mp lb lc ld mq lf lg lh ms lj lk ll mu ln lo lp mw lr ls lt ij bi translated">浏览此页面返回了以下文件:</p><pre class="ly lz ma mb gt mc lx md me aw mf bi"><span id="9bb6" class="mg jz iq lx b gy mh mi l mj mk">http://10.10.10.64/Monitoring/example/Welcome.action<br/>http://10.10.10.64/Monitoring/example/Login_input.action<br/>http://10.10.10.64/Monitoring/example/Register.action</span></pre><p id="f827" class="pw-post-body-paragraph kw kx iq ky b kz mp lb lc ld mq lf lg lh ms lj lk ll mu ln lo lp mw lr ls lt ij bi translated">每个网页文件都有一个<code class="fe lu lv lw lx b">.action</code>扩展名。这是我不常见到的事情。我开始研究这个扩展意味着什么，并找到了涉及这个命名约定和概念的Apache Struts文档。</p><p id="8c62" class="pw-post-body-paragraph kw kx iq ky b kz mp lb lc ld mq lf lg lh ms lj lk ll mu ln lo lp mw lr ls lt ij bi translated">结合网站作为信用监控服务的主题和Apache Struts的web框架，我立即想起了利用Apache Struts框架中的缺陷的Equifax的数据泄露。</p><p id="add9" class="pw-post-body-paragraph kw kx iq ky b kz mp lb lc ld mq lf lg lh ms lj lk ll mu ln lo lp mw lr ls lt ij bi translated">为了验证这一点，我找到了一个检查该漏洞的nmap脚本:</p><pre class="ly lz ma mb gt mc lx md me aw mf bi"><span id="0cb0" class="mg jz iq lx b gy mh mi l mj mk">nmap -p80 --script http-vuln-cve2017–5638 --script-args path=/Monitoring/example/Welcome.action 10.10.10.64</span></pre><figure class="ly lz ma mb gt jr"><div class="bz fp l di"><div class="mx my l"/></div><figcaption class="mz na gj gh gi nb nc bd b be z dk translated">nmap Struts漏洞</figcaption></figure><p id="0b03" class="pw-post-body-paragraph kw kx iq ky b kz mp lb lc ld mq lf lg lh ms lj lk ll mu ln lo lp mw lr ls lt ij bi translated">该扫描能够成功验证服务器易受<a class="ae ne" href="https://nvd.nist.gov/vuln/detail/CVE-2017-5638" rel="noopener ugc nofollow" target="_blank">CVE 2017–5638</a>:Apache Struts远程代码执行漏洞的攻击。</p><h1 id="1030" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">剥削</h1><p id="4714" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">现在漏洞已经被成功识别，我使用<code class="fe lu lv lw lx b">searchsploit</code>来寻找可以利用这个漏洞的漏洞脚本。结果中有许多可用的脚本，我发现<a class="ae ne" href="https://www.exploit-db.com/exploits/41570/" rel="noopener ugc nofollow" target="_blank">这个脚本</a>完成了我所需要的。作为<code class="fe lu lv lw lx b">searchsploit</code>的一部分，它已经位于完整路径的Kali中:</p><pre class="ly lz ma mb gt mc lx md me aw mf bi"><span id="4360" class="mg jz iq lx b gy mh mi l mj mk">/usr/share/exploitdb/exploits/linux/webapps/41570.py</span></pre><p id="c0e0" class="pw-post-body-paragraph kw kx iq ky b kz mp lb lc ld mq lf lg lh ms lj lk ll mu ln lo lp mw lr ls lt ij bi translated">运行该脚本需要两个参数、易受攻击的网页和一个命令。概念证明:</p><figure class="ly lz ma mb gt jr"><div class="bz fp l di"><div class="mx my l"/></div><figcaption class="mz na gj gh gi nb nc bd b be z dk translated">显示本用户信息</figcaption></figure><p id="9b21" class="pw-post-body-paragraph kw kx iq ky b kz mp lb lc ld mq lf lg lh ms lj lk ll mu ln lo lp mw lr ls lt ij bi translated">现在我们可以在服务器上远程执行代码了！</p><h1 id="6a6f" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">本地枚举</h1><p id="f1f4" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">从这里开始，我花了很多时间试图获得一个反向shell，却发现有非常严格的防火墙规则，非常有效地限制了这个选项。我没有与之抗争，而是选择坚持使用远程代码执行脚本，手动收集我的信息。</p><p id="9ad7" class="pw-post-body-paragraph kw kx iq ky b kz mp lb lc ld mq lf lg lh ms lj lk ll mu ln lo lp mw lr ls lt ij bi translated">我能够在<code class="fe lu lv lw lx b">/var/lib/tomcat8/db_connect</code>恢复文件中的凭证:</p><figure class="ly lz ma mb gt jr"><div class="bz fp l di"><div class="mx my l"/></div><figcaption class="mz na gj gh gi nb nc bd b be z dk translated">MySQL凭证</figcaption></figure><p id="d400" class="pw-post-body-paragraph kw kx iq ky b kz mp lb lc ld mq lf lg lh ms lj lk ll mu ln lo lp mw lr ls lt ij bi translated">我还能够验证一个MySQL实例是否运行在一个仅限本地的连接上:</p><figure class="ly lz ma mb gt jr"><div class="bz fp l di"><div class="mx my l"/></div><figcaption class="mz na gj gh gi nb nc bd b be z dk translated">MySQL端口</figcaption></figure><p id="b309" class="pw-post-body-paragraph kw kx iq ky b kz mp lb lc ld mq lf lg lh ms lj lk ll mu ln lo lp mw lr ls lt ij bi translated">我能够在数据库中搜索并转储用户数据库，该数据库只包含Richard F. Smith的一个条目和一个明文密码:</p><figure class="ly lz ma mb gt jr"><div class="bz fp l di"><div class="mx my l"/></div><figcaption class="mz na gj gh gi nb nc bd b be z dk translated">MySQL用户数据库</figcaption></figure><p id="34ab" class="pw-post-body-paragraph kw kx iq ky b kz mp lb lc ld mq lf lg lh ms lj lk ll mu ln lo lp mw lr ls lt ij bi translated">查看<code class="fe lu lv lw lx b">/etc/passwd</code>中可以登录到<code class="fe lu lv lw lx b">/bin/bash</code>的账户，返回理查德的用户身份！</p><figure class="ly lz ma mb gt jr"><div class="bz fp l di"><div class="mx my l"/></div><figcaption class="mz na gj gh gi nb nc bd b be z dk translated">grep /bin/bash /etc/passwd</figcaption></figure><p id="456c" class="pw-post-body-paragraph kw kx iq ky b kz mp lb lc ld mq lf lg lh ms lj lk ll mu ln lo lp mw lr ls lt ij bi translated">然后可以使用这些凭证通过SSH进入服务器。</p><h1 id="ed6e" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">权限提升</h1><p id="8cd1" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">一旦在机器上，因为我们有了Richard的密码，枚举就从<code class="fe lu lv lw lx b">sudo -l</code>开始，看看这个用户是否能以提升的权限运行任何东西。果然:</p><figure class="ly lz ma mb gt jr"><div class="bz fp l di"><div class="mx my l"/></div><figcaption class="mz na gj gh gi nb nc bd b be z dk translated">须岛一号</figcaption></figure><p id="040a" class="pw-post-body-paragraph kw kx iq ky b kz mp lb lc ld mq lf lg lh ms lj lk ll mu ln lo lp mw lr ls lt ij bi translated">Richard能够在他的主目录中运行python脚本。然而，我们只拥有脚本的读取和执行权限。内容如下:</p><figure class="ly lz ma mb gt jr"><div class="bz fp l di"><div class="mx my l"/></div><figcaption class="mz na gj gh gi nb nc bd b be z dk translated">测试. py</figcaption></figure><p id="ce06" class="pw-post-body-paragraph kw kx iq ky b kz mp lb lc ld mq lf lg lh ms lj lk ll mu ln lo lp mw lr ls lt ij bi translated">我承认我很不幸地浪费了时间来破解这个脚本中的所有散列。这是一次学习的经历——在这次挑战之前，我从未听说过BLAKE2b 256。然而，这是一个兔子洞。没有<code class="fe lu lv lw lx b">/root/success.py</code>。</p><p id="134e" class="pw-post-body-paragraph kw kx iq ky b kz mp lb lc ld mq lf lg lh ms lj lk ll mu ln lo lp mw lr ls lt ij bi translated">虽然这个脚本以<code class="fe lu lv lw lx b">#!/usr/bin/python3</code>开始，但是我们可以使用sudo权限为这个脚本运行安装在机器上的任何版本的python。这让我开始研究python3中不再存在的python2漏洞。这让我<a class="ae ne" href="https://intx0x80.blogspot.com/2017/05/python-input-vulnerability_25.html" rel="noopener ugc nofollow" target="_blank">想到了这个脚本中出现的关于python2的易受攻击的<code class="fe lu lv lw lx b">input()</code>函数的文章</a>。我能够利用这一点来实现完全交互式的根shell:</p><figure class="ly lz ma mb gt jr"><div class="bz fp l di"><div class="mx my l"/></div><figcaption class="mz na gj gh gi nb nc bd b be z dk translated">根壳#1</figcaption></figure><p id="c2ab" class="pw-post-body-paragraph kw kx iq ky b kz mp lb lc ld mq lf lg lh ms lj lk ll mu ln lo lp mw lr ls lt ij bi translated">在研究python漏洞的过程中，我还发现了第二种同样适用于python3的方法。这个方法关注于<a class="ae ne" href="https://www.rastating.com/privilege-escalation-via-python-library-hijacking/" rel="noopener ugc nofollow" target="_blank"> Python库劫持</a>，它利用了目录的层次结构，Python在其中寻找要导入的库。python检查的第一个地方是本地目录。</p><p id="36d1" class="pw-post-body-paragraph kw kx iq ky b kz mp lb lc ld mq lf lg lh ms lj lk ll mu ln lo lp mw lr ls lt ij bi translated">由于<code class="fe lu lv lw lx b">hashlib</code>是在<code class="fe lu lv lw lx b">test.py</code>的第2行导入的，我们可以编写一个名为<code class="fe lu lv lw lx b">hashlib.py</code>的简单脚本，每当<code class="fe lu lv lw lx b">test.py</code>运行时，这个脚本就会被导入并执行！概念证明:</p><figure class="ly lz ma mb gt jr"><div class="bz fp l di"><div class="mx my l"/></div><figcaption class="mz na gj gh gi nb nc bd b be z dk translated">hashlib.py</figcaption></figure><p id="2d6f" class="pw-post-body-paragraph kw kx iq ky b kz mp lb lc ld mq lf lg lh ms lj lk ll mu ln lo lp mw lr ls lt ij bi translated">这就是我如何找到两种方法通过python脚本获得完全交互的根外壳，这些脚本可以作为<code class="fe lu lv lw lx b">sudo</code>执行！</p></div></div>    
</body>
</html>