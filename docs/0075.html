<html>
<head>
<title>Content negotiation With CSRF</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">与CSRF进行内容协商</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/content-negotiation-with-csrf-969e639d6a1a?source=collection_archive---------0-----------------------#2018-04-13">https://infosecwriteups.com/content-negotiation-with-csrf-969e639d6a1a?source=collection_archive---------0-----------------------#2018-04-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/></div><div class="ab cl jn jo hu jp" role="separator"><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js"/></div><div class="ij ik il im in"><p id="9c29" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在这篇博文中，我想分享一些执行CSRF请求时的内容协商行为。</p></div><div class="ab cl jn jo hu jp" role="separator"><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js"/></div><div class="ij ik il im in"><p id="c7b8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="ks">在对应用API进行渗透测试时，我遇到了</em> <strong class="jw ir"> <em class="ks">内容协商行为。</em> </strong> <em class="ks">用我遇到的一个活生生的例子来讨论一下吧。</em></p><p id="0eb6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="ks">以下是服务器使用ClientID发出的请求，以便生成身份验证令牌。因为它无法抵御CSRF攻击。</em></p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi kt"><img src="../Images/b6ec063ad5c35ca11a5eb374fe7128de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7P0SGBN4wp-9r-uN3vOLxA.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">来源请求</figcaption></figure><ul class=""><li id="24ad" class="lj lk iq jw b jx jy kb kc kf ll kj lm kn ln kr lo lp lq lr bi translated">我一看到上面的请求，就赶紧试了试CSRF。</li></ul><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi ls"><img src="../Images/14d05e925c1e2bd7f72c8a12cdc6aa9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eGAWp4SUrYpOD73wgbDh0w.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">应最初要求，CSRF</figcaption></figure><ul class=""><li id="1ffd" class="lj lk iq jw b jx jy kb kc kf ll kj lm kn ln kr lo lp lq lr bi translated"><em class="ks"> ~下面是回应~。哎呀</em></li></ul><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi lt"><img src="../Images/031193e3282fa7ebd880ef0d999ef311.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VKdIdMOPzzd7AN0XCTFwEA.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">CSRF最初的要求没有奏效</figcaption></figure><ul class=""><li id="9962" class="lj lk iq jw b jx jy kb kc kf ll kj lm kn ln kr lo lp lq lr bi translated"><strong class="jw ir"> <em class="ks">我们来检查一下打嗝代理历史有什么问题！！！！</em>T19】</strong></li></ul><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi lu"><img src="../Images/daa460459ed16a3b0f395e650464001d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2vmIeQ2cF6K2u9YTDtCDBg.png"/></div></div></figure><ul class=""><li id="e8e6" class="lj lk iq jw b jx jy kb kc kf ll kj lm kn ln kr lo lp lq lr bi translated"><em class="ks">请求看起来不错，应该在服务器端执行，在尝试改变参数和一些事情后，我知道他们只接受</em> <strong class="jw ir"> <em class="ks">有限类型的内容。</em>T25】</strong></li><li id="b786" class="lj lk iq jw b jx lv kb lw kf lx kj ly kn lz kr lo lp lq lr bi translated"><em class="ks">我们先看</em> <strong class="jw ir"> <em class="ks">原要求再看</em> </strong> <em class="ks">。通过看</em> <strong class="jw ir"> <em class="ks">接受:application/vnd . domain-API+JSON；很明显</em> </strong> <em class="ks">服务器期待来自客户端的JSON数据以便验证。</em></li></ul><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi kt"><img src="../Images/b6ec063ad5c35ca11a5eb374fe7128de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7P0SGBN4wp-9r-uN3vOLxA.png"/></div></div></figure></div><div class="ab cl jn jo hu jp" role="separator"><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js"/></div><div class="ij ik il im in"><p id="5abb" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir"> <em class="ks"> ~让我们制作案例以便检查是否绕过:</em> </strong></p><ol class=""><li id="8412" class="lj lk iq jw b jx jy kb kc kf ll kj lm kn ln kr ma lp lq lr bi translated"><strong class="jw ir"> <em class="ks">尝试通过删除请求头:</em> </strong></li></ol><p id="84c9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="ks">接受:application/vnd . domain-API+JSON；版本=2 </em></p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi mb"><img src="../Images/7e1bc44d541b79d6828a621cfe45b365.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G61WwZxmomNvQ9_mDUziMQ.png"/></div></div></figure><ul class=""><li id="6d8e" class="lj lk iq jw b jx jy kb kc kf ll kj lm kn ln kr lo lp lq lr bi translated"><em class="ks">在用</em><strong class="jw ir"><em class="ks">application/x-www-form-urlencoded</em></strong><em class="ks">内容强制服务器上，我们可以看到Application正在严格验证内容为JSON。</em></li></ul><p id="6e77" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="ks">因此，很明显，除了请求头(Accept: JSON)给出的内容之外，我们不能尝试任何其他内容</em></p><ul class=""><li id="2ae3" class="lj lk iq jw b jx jy kb kc kf ll kj lm kn ln kr lo lp lq lr bi translated"><em class="ks">我们也可以使用</em> <strong class="jw ir"> <em class="ks">基于SWF的JSON CSRF漏洞(又名。307绝招)</em> </strong> <em class="ks">这里恶搞一下</em> <strong class="jw ir"> <em class="ks">内容类型:application/vnd . domain-API+JSON；版本=2，</em> </strong> <em class="ks">但是</em> <strong class="jw ir"> <em class="ks"> </em> </strong> <em class="ks">在这种情况下就不起作用了。因为我们的请求数据不在JSON中。</em></li></ul><p id="7567" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir"> 2。<em class="ks">将请求数据转换为JSON数据:</em> </strong></p><ul class=""><li id="6d74" class="lj lk iq jw b jx jy kb kc kf ll kj lm kn ln kr lo lp lq lr bi translated"><em class="ks">现在我们可以选择将请求数据转换成JSON，以便与</em> <strong class="jw ir"> <em class="ks">基于SWF的JSON CSRF利用一起使用。</em>T89】</strong></li></ul><p id="8af0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="ks">所以我需要把下面的请求数据转换成JSON : </em></p><p id="47d5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir"><em class="ks">data _ type = authentic ation&amp;provider = installations&amp;credentials = bffd 87 b 6-b5 C4–4718–80ec-d 146 c 92 e 0319</em>T3】</strong></p><p id="507b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">到</p><p id="7298" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir"> <em class="ks"> { "数据":{ "类型":"认证"，"属性":{ "提供者":"安装"，"凭证":" bffd 87 b 6-b5 C4–4718–80ec-d 146 c92e 0319 " } }</em></strong></p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi mc"><img src="../Images/fced3ad7335fd246f86a7eb8eba04f8b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UrjXOIK73DcExeEVd2HpNA.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">成功！</figcaption></figure><p id="61d6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="ks"> ~继续努力</em></p></div></div>    
</body>
</html>