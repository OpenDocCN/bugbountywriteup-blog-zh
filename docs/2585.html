<html>
<head>
<title>pentesting.cloud part 2: “Is there an echo in here?” AWS CTF walkthrough</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">第二部分:“这里有回音吗？”AWS CTF演练</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/pentesting-cloud-part-2-is-there-an-echo-in-here-ctf-walkthrough-54ec188a585d?source=collection_archive---------1-----------------------#2022-12-01">https://infosecwriteups.com/pentesting-cloud-part-2-is-there-an-echo-in-here-ctf-walkthrough-54ec188a585d?source=collection_archive---------1-----------------------#2022-12-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="b56f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这篇博文中，我将向你展示一种揭示受<code class="fe kl km kn ko b">NoEcho</code>属性保护的云信息值的技术。换句话说，你将学习如何显示隐藏在<code class="fe kl km kn ko b">****</code>后面的已经部署的云阵堆栈的秘密。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi kp"><img src="../Images/d26fb16fd4544a9d3bac76ebd0f5a771.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4pVou7pv_-OrQEjYoAHMIg.png"/></div></div></figure><p id="64cd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是<em class="lb"/><a class="ae lc" href="https://pentesting.cloud/challenge/echo-in-here/" rel="noopener ugc nofollow" target="_blank"><em class="lb">的遍历，这里有回音吗？</em></a><em class="lb"/>来自<a class="ae lc" href="https://pentesting.cloud/" rel="noopener ugc nofollow" target="_blank"> pentesting.cloud </a> CTF的挑战。有许多令人敬畏的AWS安全相关的挑战，所以如果你还没有尝试过，那么跳过阅读剧透，尝试自己解决它！但是如果你在这个挑战中卡住了，或者只是想看看诀窍，你可以直接跳到<a class="ae lc" href="#8d90" rel="noopener ugc nofollow">主</a>部分😉</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi ld"><img src="../Images/d78eba82fa6a2a46ab7372723d14e37b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pJU3XsVBF9bUL561-yq8jA.png"/></div></div></figure><h1 id="4971" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">三、二、一……我们开始吧！</h1><p id="e7db" class="pw-post-body-paragraph jn jo iq jp b jq mc js jt ju md jw jx jy me ka kb kc mf ke kf kg mg ki kj kk ij bi translated">在挑战指令<a class="ae lc" href="https://pentesting.cloud/challenge/echo-in-here/" rel="noopener ugc nofollow" target="_blank">之后，我部署了<em class="lb">“回声”云团堆栈</em>。这就是我们想要的:</a></p><blockquote class="mh mi mj"><p id="98c3" class="jn jo lb jp b jq jr js jt ju jv jw jx mk jz ka kb ml kd ke kf mm kh ki kj kk ij bi translated">该标志是一个md5散列，位于由挑战创建的s3存储桶的根文件夹中的flag.txt中。</p></blockquote><p id="7c31" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要找到它，我们可以使用名为<em class="lb">pentest-user</em>的专用IAM用户，他被授予以下权限:</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi mn"><img src="../Images/9100140b70b3e9a5c4898a966578a806.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N16UlRQPis6VBErKY12PuA.png"/></div></div></figure><p id="1615" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们分析一下<em class="lb">测试用户</em>可以调用的Lambda函数:</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi mo"><img src="../Images/435d79b6706f08cc168ff5965cf70b1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*002z2TVgZrMm24PUlUsIvQ.png"/></div></div></figure><p id="57b7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个简单的函数将显示所有的环境变量(包括访问密钥ID、秘密访问密钥和附加执行角色的会话令牌！)，但前提是在事件对象中传递正确的密码。密码可以在部署的CloudFormation堆栈中找到。然而，它被掩盖了…😔有办法查看吗？当然是！</p><h1 id="8d90" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">发现NoEcho参数的值</h1><p id="144d" class="pw-post-body-paragraph jn jo iq jp b jq mc js jt ju md jw jx jy me ka kb kc mf ke kf kg mg ki kj kk ij bi translated">如果你不想在CloudFormation模板中硬编码一个特定的值，那么你可以在创建栈的时候把它作为一个<a class="ae lc" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/parameters-section-structure.html" rel="noopener ugc nofollow" target="_blank"> <em class="lb">参数</em> </a>来传递。然而，<em class="lb">参数</em>的值反映给任何被允许进行<code class="fe kl km kn ko b">DescribeStacks</code> <a class="ae lc" href="https://docs.aws.amazon.com/cli/latest/reference/cloudformation/describe-stacks.html" rel="noopener ugc nofollow" target="_blank"> API调用</a>的人。但是如果CloudFormation模板中的参数具有属性<code class="fe kl km kn ko b">NoEcho: true</code>，则该值可以被屏蔽。因此，无论您是否在AWS控制台管理或AWS CLI中打开堆栈的参数选项卡，该值都将被屏蔽，例如:</p><pre class="kq kr ks kt gt mp ko mq bn mr ms bi"><span id="0cdc" class="mt lf iq ko b be mu mv l mw mx">$ aws cloudformation describe-stacks --query "Stacks[].Parameters[*]" --profile pentesting-user</span></pre><p id="00e4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">输出:</p><pre class="kq kr ks kt gt mp ko mq bn mr ms bi"><span id="5c4d" class="mt lf iq ko b be mu mv l mw mx">[<br/>    [<br/>        {<br/>            "ParameterKey": "Password",<br/>            "ParameterValue": "****"<br/>        }<br/>    ]<br/>]</span></pre><p id="0c44" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一些AWS用户(我在野外见过很多次)错误地认为这是传递秘密的安全方式，例如数据库密码，尽管AWS <a class="ae lc" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/parameters-section-structure.html" rel="noopener ugc nofollow" target="_blank">文档</a>明确指出，推荐的方法是使用动态参数(例如引用存储在AWS系统管理器参数存储或AWS秘密管理器中的秘密值)\_(ツ)_/</p><p id="73bd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="lb"> pentesting-user </em>拥有<code class="fe kl km kn ko b">cloudformation:UpdateStack</code>权限，足以暴露密码值。我们所要做的就是……&lt;drumroll🥁&gt;……用设置为<code class="fe kl km kn ko b">false</code>的<code class="fe kl km kn ko b">NoEcho</code>属性来更新堆栈(或者简单地删除它)。但是请耐心等待，只是编辑/删除参数属性不会被CloudFormation服务识别为…更改😕让我演示一下。</p><p id="f67e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了更新堆栈，我们当然需要一个模板。<em class="lb"> pentesting-user </em>拥有<code class="fe kl km kn ko b">“cloudformation:Get*”</code>权限，因此我们可以从已经创建的堆栈中获取模板(在CloudFormation仪表盘中，只需点击堆栈名称，然后转到<em class="lb">模板</em>选项卡):</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi my"><img src="../Images/4c123e775b424ce3875bb1f7adbbba67.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n-KT3xXT9o5nFAc4hfwQEw.png"/></div></div></figure><p id="0072" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">全选并保存为<code class="fe kl km kn ko b">template.yaml</code>文件。如果您只删除了<code class="fe kl km kn ko b">NoEcho: true</code>行并试图调用<a class="ae lc" href="https://docs.aws.amazon.com/cli/latest/reference/cloudformation/update-stack.html" rel="noopener ugc nofollow" target="_blank">更新堆栈</a> *操作，那么您将得到以下错误消息:</p><pre class="kq kr ks kt gt mp ko mq bn mr ms bi"><span id="952f" class="mt lf iq ko b be mu mv l mw mx">$ aws cloudformation update-stack --stack-name echo-in-here --template-body file://template.yaml --parameters ParameterKey=Password,UsePreviousValue=true --capabilities CAPABILITY_NAMED_IAM --profile pentesting-user<br/><br/>An error occurred (ValidationError) when calling the UpdateStack operation: No updates are to be performed.</span></pre><blockquote class="mh mi mj"><p id="8a1d" class="jn jo lb jp b jq jr js jt ju jv jw jx mk jz ka kb ml kd ke kf mm kh ki kj kk ij bi translated">* —请注意，如果您不想更新参数值，而是使用已经存在的值，那么您必须在更新堆栈操作期间通过<code class="fe kl km kn ko b">UsePreviousValue=true</code>明确指定它。</p></blockquote><p id="9c12" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="lb">pentest-user</em>没有修改任何资源的权限，但是在<code class="fe kl km kn ko b">Resource</code>部分对CloudFormation模板做一点小小的改变就可以解决这个问题🤯因此，让我们用已经创建的S3桶的名称替换原来的<code class="fe kl km kn ko b">template.yaml</code>中的<code class="fe kl km kn ko b">!Ref S3Bucket</code>(因此没有对任何资源进行更改，但是这种更改被CloudFormation服务识别为新的模板文件):</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi mz"><img src="../Images/d6dff2b816efc149e1e7e60d9e3d7890.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xVxhcdgVBeMtwDaLxh0udQ.png"/></div></div></figure><p id="665e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，让我们再次尝试运行上述相同的命令，但这一次使用更新的<code class="fe kl km kn ko b">template.yaml</code>文件:</p><pre class="kq kr ks kt gt mp ko mq bn mr ms bi"><span id="454f" class="mt lf iq ko b be mu mv l mw mx">$ aws cloudformation update-stack --stack-name echo-in-here --template-body file://template.yaml --parameters ParameterKey=Password,UsePreviousValue=true --capabilities CAPABILITY_NAMED_IAM --profile pentesting-user<br/><br/>{<br/>    "StackId": "arn:aws:cloudformation:us-west-2:XXXXXXXXXXXX:stack/echo-in-here/36f1c740-70c0-11ed-b156-0699d225df8d"<br/>}</span></pre><p id="ee06" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">更新完成后，让我们回到云形成<code class="fe kl km kn ko b">echo-in-here</code>堆栈的参数选项卡，瞧，我们可以看到未屏蔽的<em class="lb">密码</em>值:</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi na"><img src="../Images/810b1598d267bfdb35427d93512183d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*116PUbJWU8N2sPvc_uMctw.png"/></div></div></figure><p id="5524" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，让我们回到<em class="lb">pentest-user</em>可以调用的<code class="fe kl km kn ko b">echo-in-here-VulnerableLambda-7ZS04BaNqpSH</code> Lambda函数。当您从AWS控制台管理中调用Lambda函数时(只需单击Lambda函数<em class="lb">代码</em>选项卡中的<code class="fe kl km kn ko b">Test</code>按钮),然后您可以传递<code class="fe kl km kn ko b">Event.json</code>文件中的参数，在这里您应该使用无屏蔽密码:</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/242aba3c34eb3dee06135341c1356eb4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1086/format:webp/1*hefMZ74s6r3HucFx78Q9gA.png"/></div></figure><p id="5c49" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦Lambda被执行，您可以看到被执行函数的所有环境变量，包括假设的执行角色所使用的凭证:</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi nc"><img src="../Images/5775ffa8010bb061600a390987e7fd31.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yvAbItH6Fk7zO1bxxIL15A.png"/></div></div></figure><p id="ef6c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在让我们将本地终端中的折衷Lambda执行角色配置为<em class="lb">折衷角色</em>配置文件。您可以使用以下命令来完成此操作:</p><pre class="kq kr ks kt gt mp ko mq bn mr ms bi"><span id="d0f1" class="mt lf iq ko b be mu mv l mw mx"># specify the AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY and the region:<br/>$ aws configure --profile compromised-role<br/><br/># specify the AWS_SESSION_TOKEN:<br/>$ aws configure --profile compromised-role set aws_session_token PUT_AWS_SESSION_TOKEN_HERE<br/><br/># check if the profile is correctly configured:<br/>$ aws sts get-caller-identity --profile compromised-role<br/><br/>{<br/>    "UserId": "AROAQWTRZHKUAF6QTSLWX:echo-in-here-VulnerableLambda-7ZS04BaNqpSH",<br/>    "Account": "XXXXXXXXXXXX",<br/>    "Arn": "arn:aws:sts::XXXXXXXXXXXX:assumed-role/echo-in-here-VulnerableRole-UBOWSUETXTJV/echo-in-here-VulnerableLambda-7ZS04BaNqpSH"<br/>}</span></pre><p id="2842" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，我们可以下载并读取<code class="fe kl km kn ko b">flag.txt</code>文件:</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi nd"><img src="../Images/276726bbebeab15b0e16e85c9bfabe1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dObHJTiwliDJ0oQhhcLsqw.png"/></div></div></figure><h1 id="1934" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">结论</h1><p id="74f3" class="pw-post-body-paragraph jn jo iq jp b jq mc js jt ju md jw jx jy me ka kb kc mf ke kf kg mg ki kj kk ij bi translated"><em class="lb"/><a class="ae lc" href="https://pentesting.cloud/challenge/echo-in-here/" rel="noopener ugc nofollow" target="_blank"><em class="lb">这里有回音吗？</em>这里的一个重要教训是<strong class="jp ir">堆栈资源所需的任何秘密都应该存储在CloudFormation </strong>之外(例如，在AWS Systems Manager参数存储或AWS Secrets Manager中)并从CloudFormation模板中动态引用。此外，这样的秘密应该被加密，这将增加额外的访问控制层(委托人不仅需要访问秘密的许可，还需要根据KMS CMK密钥策略解密秘密的许可)。</a></p></div><div class="ab cl ne nf hu ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ij ik il im in"><blockquote class="nl"><p id="7f8a" class="nm nn iq bd no np nq nr ns nt nu kk dk translated">如果您对<a class="ae lc" href="https://pentesting.cloud/" rel="noopener ugc nofollow" target="_blank"> pentesting.cloud </a>挑战赛的下一部分感兴趣，请告诉我👏这篇文章或者在<a class="ae lc" href="https://twitter.com/Rzepsky" rel="noopener ugc nofollow" target="_blank"> Twitter </a> / <a class="ae lc" href="https://www.linkedin.com/in/pawel-rzepa-5326965b/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>上关注我。</p></blockquote></div><div class="ab cl ne nf hu ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ij ik il im in"><h2 id="493a" class="nv lf iq bd lg nw nx dn lk ny nz dp lo jy oa ob ls kc oc od lw kg oe of ma og bi translated">来自Infosec的报道:Infosec每天都有很多内容，很难跟上。<a class="ae lc" href="https://weekly.infosecwriteups.com/" rel="noopener ugc nofollow" target="_blank">加入我们的每周简讯</a>以5篇文章、4个线程、3个视频、2个GitHub Repos和工具以及1个工作提醒的形式免费获取所有最新的Infosec趋势！</h2></div></div>    
</body>
</html>