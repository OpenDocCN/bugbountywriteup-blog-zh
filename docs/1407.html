<html>
<head>
<title>Walk Through on AttacktiveDirectory box(THM)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">走过攻击目录框(THM)</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/walk-through-on-attacktivedirectory-box-thm-eb6c87bedb56?source=collection_archive---------4-----------------------#2021-06-17">https://infosecwriteups.com/walk-through-on-attacktivedirectory-box-thm-eb6c87bedb56?source=collection_archive---------4-----------------------#2021-06-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="7f82" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">Active Directory:-Active Directory是一个数据库和一组服务，将用户与他们完成工作所需的网络资源连接起来。大多数公司都使用活动目录</h2></div><h2 id="87bf" class="kf kg iq bd kh ki kj dn kk kl km dp kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">枚举-1</h2><p id="c366" class="pw-post-body-paragraph lb lc iq ld b le lf jr lg lh li ju lj ko lk ll lm ks ln lo lp kw lq lr ls lt ij bi translated">通过使用具有给定Ip的Nmap，我们可以看到139和445端口是打开的，这是Netbios和Smb程序</p><p id="194c" class="pw-post-body-paragraph lb lc iq ld b le ly jr lg lh lz ju lj ko ma ll lm ks mb lo lp kw mc lr ls lt ij bi translated">Netbios是一个允许不同计算机上的应用程序在局域网内通信的程序</p><p id="7b80" class="pw-post-body-paragraph lb lc iq ld b le ly jr lg lh lz ju lj ko ma ll lm ks mb lo lp kw mc lr ls lt ij bi translated"><strong class="ld ir"> SMB </strong> :- SMB代表服务器消息块，用于共享文件、打印机等</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div class="gh gi md"><img src="../Images/74dbdd16658f5a95d74ef955d6057110.png" data-original-src="https://miro.medium.com/v2/resize:fit:742/format:webp/1*tImbFHw7Y1wL_tr193PmtQ.png"/></div><figcaption class="ml mm gj gh gi mn mo bd b be z dk translated">Nmap扫描输出</figcaption></figure><p id="abb0" class="pw-post-body-paragraph lb lc iq ld b le ly jr lg lh lz ju lj ko ma ll lm ks mb lo lp kw mc lr ls lt ij bi translated">-然后通过使用“Enum4Linux”工具，我们可以枚举这些端口</p><pre class="me mf mg mh gt mp lx mq mr aw ms bi"><span id="c24d" class="kf kg iq lx b gy mt mu l mv mw">enum4linux -A 10.10.14.74</span></pre><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi mx"><img src="../Images/246a52145c3b76477d9cf7eb23fe4429.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BsLs1eudNcPcDoK1ncYO5w.png"/></div></div></figure><p id="ce8e" class="pw-post-body-paragraph lb lc iq ld b le ly jr lg lh lz ju lj ko ma ll lm ks mb lo lp kw mc lr ls lt ij bi translated">通过研究活动目录的名称，我们可以理解“. local”是常用的TLD</p><h2 id="ba67" class="kf kg iq bd kh ki kj dn kk kl km dp kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">枚举-2</h2><p id="2306" class="pw-post-body-paragraph lb lc iq ld b le lf jr lg lh li ju lj ko lk ll lm ks ln lo lp kw lq lr ls lt ij bi translated">在查看Nmap扫描报告时，我们可以找到在88(Kerberos)上运行的其他端口。基本上，Kerberos是活动目录中的一种身份验证服务。打开这个端口，我们可以使用一个叫做<code class="fe lu lv lw lx b">kerbrute</code>的工具来强行发现用户、密码</p><p id="985d" class="pw-post-body-paragraph lb lc iq ld b le ly jr lg lh lz ju lj ko ma ll lm ks mb lo lp kw mc lr ls lt ij bi translated">有了GitHub repo中给定的<code class="fe lu lv lw lx b">userList.txt</code>和<code class="fe lu lv lw lx b">passwordList.txt</code>，我们就可以暴力破解Kerberos</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi nc"><img src="../Images/312379e42c36b26cdd09e422a4561843.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GDyLLHR6vPZaoDqsUOiNDA.png"/></div></div><figcaption class="ml mm gj gh gi mn mo bd b be z dk translated">Kerbrute枚举</figcaption></figure><p id="47fe" class="pw-post-body-paragraph lb lc iq ld b le ly jr lg lh lz ju lj ko ma ll lm ks mb lo lp kw mc lr ls lt ij bi translated">所以很明显，从输出中可以发现是<code class="fe lu lv lw lx b">svc-admin</code> (flag-3)和<code class="fe lu lv lw lx b">backup</code> (Flag-4)</p><h2 id="76b4" class="kf kg iq bd kh ki kj dn kk kl km dp kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">滥用Kerberos</h2><h2 id="3de5" class="kf kg iq bd kh ki kj dn kk kl km dp kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">Kerberos是如何工作的？</h2><ul class=""><li id="4616" class="nd ne iq ld b le lf lh li ko nf ks ng kw nh lt ni nj nk nl bi translated">在Kerberos下，客户端通常向密钥分发服务(KDC)发送请求。KDC为客户端创建一个票据授予票据(TGT)，使用客户端的密码作为密钥对其进行加密，然后将加密的TGT发送回去。通过使用TGT，我们可以请求KDC提供TGS(票证授予服务)来访问ActiveDirectory中的任何特定服务，如SQL，我们还找到了一个运行服务的服务帐户(svc-admin)。因为我们有一张TGS票，所以我们可以将票发送给一个特定的服务，该服务将使用提供的TGS对用户进行身份验证。该服务使用用户名和密码来解密TGS，并声明它是否有效</li><li id="3f18" class="nd ne iq ld b le nm lh nn ko no ks np kw nq lt ni nj nk nl bi translated">在我们的例子中，我们发现了2个特定的用户名，我们没有特定的密码来请求TGT，<strong class="ld ir">但是</strong>，Kerberos中存在一个被称为<code class="fe lu lv lw lx b">ASREPRoasting</code>的攻击特性。ASREPRoasting是一个用户帐户可以拥有特权<code class="fe lu lv lw lx b">DO Not require PreAuthentication</code>，因此这意味着该帐户在请求指定用户帐户上的Kerberos票据之前不需要提供有效的身份证明</li></ul><p id="8673" class="pw-post-body-paragraph lb lc iq ld b le ly jr lg lh lz ju lj ko ma ll lm ks mb lo lp kw mc lr ls lt ij bi translated">为了执行Asreproasting，一个名为<code class="fe lu lv lw lx b">Impacket</code>的工具位于impacket/examples/getnpusers . py中，它将允许我们从密钥分发中心查询ASReproastable帐户。使用这个工具的先决条件是知道我们已经列举的用户名</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/f9ca639249c4eb184d662f6da9a5b951.png" data-original-src="https://miro.medium.com/v2/resize:fit:1178/format:webp/1*1YvPhAu6UCylViKrJ3FKRg.png"/></div><figcaption class="ml mm gj gh gi mn mo bd b be z dk translated">使用GetNPUsers.py工具检索哈希</figcaption></figure><p id="1ca4" class="pw-post-body-paragraph lb lc iq ld b le ly jr lg lh lz ju lj ko ma ll lm ks mb lo lp kw mc lr ls lt ij bi translated">在接收到散列后，我们可以通过使用<em class="ns"> `john` </em>和密码为<em class="ns"> `management2005` </em>的密码列表来破解散列</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi nt"><img src="../Images/b76ce6b1c9c270aba39fa3454953bdb3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PVYV9kA6UynoWdZGwDFHdw.png"/></div></div><figcaption class="ml mm gj gh gi mn mo bd b be z dk translated">约翰(密码检索器)</figcaption></figure><p id="8b57" class="pw-post-body-paragraph lb lc iq ld b le ly jr lg lh lz ju lj ko ma ll lm ks mb lo lp kw mc lr ls lt ij bi translated"><strong class="ld ir">枚举(回到基础):- </strong></p><p id="0c86" class="pw-post-body-paragraph lb lc iq ld b le ly jr lg lh lz ju lj ko ma ll lm ks mb lo lp kw mc lr ls lt ij bi translated">因为我们有用户名和密码，所以我们可以登录到服务器。我们可以使用“smbclient”工具来完成这项工作</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi nu"><img src="../Images/e27ac87adea48e745b16a8c6cd125419.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bez4F7Na1efujYaczmeIPQ.png"/></div></div><figcaption class="ml mm gj gh gi mn mo bd b be z dk translated">中小企业客户端</figcaption></figure><p id="05c7" class="pw-post-body-paragraph lb lc iq ld b le ly jr lg lh lz ju lj ko ma ll lm ks mb lo lp kw mc lr ls lt ij bi translated">通过使用<code class="fe lu lv lw lx b"> secretsdump.py</code>工具，我们可以提取管理员账户<code class="fe lu lv lw lx b"> secretsdump.py spookysec.local/backup:'backup2517860'@10.10.22.125 -just-dc</code>的NTLM哈希</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi nt"><img src="../Images/32795459d7b8e78e22334b3fb6695115.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8gQxQwQ_omA4jzuiY7xPEg.png"/></div></div><figcaption class="ml mm gj gh gi mn mo bd b be z dk translated">secretsdump.py</figcaption></figure><p id="13e5" class="pw-post-body-paragraph lb lc iq ld b le ly jr lg lh lz ju lj ko ma ll lm ks mb lo lp kw mc lr ls lt ij bi translated">接下来，要获得管理员权限，我们可以使用一个名为<code class="fe lu lv lw lx b">psexec.py</code>的工具，命令如下<code class="fe lu lv lw lx b">psexec.py Administrator@10.10.22.125 -hashes aad3b435b51404eeaad3b435b51404ee:0e0363213e37b94221497260b0bcb4fc</code></p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi nv"><img src="../Images/44bbea12faaeb1cf78b3420e8712923a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3LRwR263PWig-_t6tJyw4w.png"/></div></div><figcaption class="ml mm gj gh gi mn mo bd b be z dk translated">帐户访问</figcaption></figure><p id="0796" class="pw-post-body-paragraph lb lc iq ld b le ly jr lg lh lz ju lj ko ma ll lm ks mb lo lp kw mc lr ls lt ij bi translated">获得管理员访问权限后，每个标志都位于用户的桌面文件夹/</p></div><div class="ab cl nw nx hu ny" role="separator"><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob"/></div><div class="ij ik il im in"><p id="6065" class="pw-post-body-paragraph lb lc iq ld b le ly jr lg lh lz ju lj ko ma ll lm ks mb lo lp kw mc lr ls lt ij bi translated">在<a class="ae od" href="https://tryhackme.com/room/attacktivedirectory" rel="noopener ugc nofollow" target="_blank"> TryHackme </a>访问此框</p></div></div>    
</body>
</html>