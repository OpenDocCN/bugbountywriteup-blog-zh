# DGAs 及其检测方法

> 原文：<https://infosecwriteups.com/dgas-and-how-to-detect-them-c3dbf5211ecf?source=collection_archive---------2----------------------->

像宙斯，Conficker 和许多其他恶意软件使用 DGAs(域生成算法)来建立弹性 C2 服务器

实际上，一旦计算机被感染，黑客通过 C2(命令和控制)服务器发送指令(文件传输、更新等)。尽管存在许多方法，如 IRC、P2P 协议、Tor 等，但大多数 C2 使用 DNS 协议在彼此之间交换数据，因为 DNS 有几个优点，如:

*   DNS 流量通常被允许通过防火墙
*   由于 Fast-Flux 或 DGA 等技术，使用 DNS 可以构建更具弹性的僵尸网络

起初，网络犯罪分子在恶意软件中硬编码了 C2 的域名。因此，一旦机器被感染，它只需解析嵌入的域名，以获取 C2 服务器的 IP 地址。即使它是有效的，一旦被发现，硬编码的域名或 C2 的 IP 可以很容易地被列入黑名单。

黑客们通过结合动态 DNS、DGA 和 Fast-Flux 提出了一个有效的解决方案。在本文中，我将进一步解释什么是 DGA 以及我们如何检测它。

> **NB:动态 DNS** ( **DDNS** )是一种自动更新[域名系统](https://en.wikipedia.org/wiki/Domain_Name_System) (DNS)中的[域名服务器](https://en.wikipedia.org/wiki/Name_server)的方法，通常是实时的，使用其配置的主机名、地址或其他信息的活动 DDNS 配置。—维基百科

![](img/a968421f1036548021d80300dec794a7.png)

# 一.什么是 DGA？

DGAs 是用于定期生成大量域名(因此得名)的算法。C2 服务器可以使用这些域名与僵尸网络的僵尸进行通信。僵尸将试图通过请求所有(或仅一部分)生成的域名来联系 C2。如果域名被 DNS 服务器成功解析，他们将收到来自 C2 的更新或命令。

让我们举个例子:被感染电脑上的 DGA 创建了 10000 个域名。与此同时，C2 上的 DGA 创建了与受感染 bot 相同的域名列表，但其 IP 仅映射到一个域名。然后，bot 请求 DNS 服务器从生成的 10000 个域名中获取 1000 个 IP。这些 DNS 请求中的绝大多数(在我们的例子中是 999 个)将由“NXDomain”来回答，这意味着没有 IP 被映射到所请求的域名。但是其中一个域名将被解析为 C2 的 IP，并且可以通过发送加密的 DNS 有效负载或使用 DNS 隧道传输其他应用协议(如 SSH)在 C2 和受感染的计算机之间开始通信

因此，为了工作，C2 必须将其 IP 与 DNS 服务器生成的域名之一进行映射。这就是动态 DNS 的关键所在，因为它允许 C2 在 DNS 服务器中更新其域名

这样，安全人员很难处理它，因为:

*   域名不再是硬编码的，可以很容易地改变。因此，将域名列入黑名单的效率比以前低了
*   查询的域名范围很广，很难猜测哪一个与 C2 的域名相对应
*   如果 C2 以前使用的域名被封锁。C2 将其映射切换到另一个域名
*   与此同时，为了避免 IP 黑名单，C2 也可以通过使用诸如 [Fast flux](https://en.wikipedia.org/wiki/Fast_flux) 之类的技术不断改变他们的 IP

生成的域名取决于算法。有些生成一个伪随机字符序列:

*   hpaxgpkteomjaxywwelr.com

还有一些基于字典中的单词或名称(基于字典的 DGA):

*   mariabellahuddleson.net

你可以在 https://github.com/baderj/domain_generation_algorithms 的[上看到更多例子](https://github.com/baderj/domain_generation_algorithms)

我们将在下一部分看到，我们可以使用由 DGA 生成的域名模式来发现对 C2 的 DNS 请求。

# 二。如何对抗 DGAs？

有几种方法可以检测由 DGA 生成的域名:

*   反动:基于非监督聚类技术和上下文信息，如 NXDomain 响应、WHOIS 命令、TTL(生存时间)……我们可以评估域名的合法性。例如，如果一个域名在过去 10 天返回 100 NXDomain，并且突然被映射到一个 IP，这可能表明 C2 最近映射到该域名。
*   实时:基于深度/ML 学习技术。我们考虑几个因素，域名的熵，加密或未加密，N-gram，域名的大小，字符的频率，……根据这些特征，我们简单地将它们相加，计算出一个分数，告诉我们一个域名由 DGA 生成的可能性有多大。或者我们使用这些特征作为机器学习模型的输入。我们表现最好的是深度学习架构，如 LSTM 或 CNN。
*   逆向工程:如果我们可以访问源代码，我们就可以计算出 DGA 生成的下一个域名列表，并阻止它们。明显的缺点是我们并不总是有生成域名的代码

什么效果最好？从我的个人经验来看，机器学习方法可以产生良好的结果，但有一个问题:生成域名的方法的多样性。

一个基于字典的 DGA 将具有与伪随机 DGA 完全不同的特征:熵、词频……

这就是为什么基于字典的 DGA 更难捕捉的原因:因为它们看起来像合法的域名。解决这个问题的一个方法是结合从域名(熵，长度，…)和上下文信息(NXDomain，TTL，…)计算的特征。通过这种方式，您不仅可以依赖域名，还可以捕获基于字典的 DGA

> 注意:尽管如此，我们最近看到了深层单词嵌入算法检测基于词典的 DGA 的巨大前景
> 
> 注意:当检测到僵尸时，将它重定向到另一个由我们控制的服务器更有用，这样我们就知道僵尸应该发送哪种数据到 C2。我们通过改变机器人使用的 DNS 服务器的映射来做到这一点

即使某些方法产生了良好的结果，您也不应该忘记类似生产环境中的两个主要特征:

*   根据所考虑的网络，DNS 流量可能太重要而无法像您在分析中所做的那样进行解析
*   假设您让一个机器学习模型检测 DGAs，并且您达到了 98%的准确率……请记住，DNS 流量可能非常重要，因此 2%可能仍然是一个相当大的数量

感谢阅读！希望你喜欢它，请随意查看我的另一篇关于 Unix 系统中的竞争条件的文章:[https://infosecwriteups . com/Race-condition-vulnerability-in-Unix-Systems-db 86 b 6 da CEB 6](/race-condition-vulnerability-in-unix-systems-db86b6daceb6)

安:如果你想联系我，这是我的 LinkedIn:【https://www.linkedin.com/in/malo-le-goff-480452170/? locale=en_US