<html>
<head>
<title>Sending out phishing e-mails from @microsoft.com</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从@microsoft.com发送网络钓鱼电子邮件</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/sending-out-phishing-e-mails-from-microsoft-com-84c3b918ada2?source=collection_archive---------0-----------------------#2018-08-07">https://infosecwriteups.com/sending-out-phishing-e-mails-from-microsoft-com-84c3b918ada2?source=collection_archive---------0-----------------------#2018-08-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/bb79bb0e7660e80db33546a7d17d78be.png" data-original-src="https://miro.medium.com/v2/resize:fit:998/format:webp/1*SflP7_yQHaTiTyMfknMpew.jpeg"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">爱因斯坦是对的！(大概)</figcaption></figure><p id="070f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这是一篇关于我两个月前向Microsoft报告的一个漏洞的短文，描述了一个影响他们一个叫做“微软流”的服务的HTML注入问题。由于该漏洞不会被修补，引用:</p><blockquote class="kx ky kz"><p id="99d7" class="jy jz la ka b kb kc kd ke kf kg kh ki lb kk kl km lc ko kp kq ld ks kt ku kv ij bi translated"><em class="iq">高拉夫:</em></p><p id="929e" class="jy jz la ka b kb kc kd ke kf kg kh ki lb kk kl km lc ko kp kq ld ks kt ku kv ij bi translated"><em class="iq">“鉴于此事的严重性和影响，MSRC不再跟踪此事。我们已经结案了。”</em></p></blockquote><p id="69d4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">出于教育目的，我将描述细节及其对客户的影响。这个问题仍然没有补丁，可以利用或进一步研究。</p></div><div class="ab cl le lf hu lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="ij ik il im in"><p id="d984" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">那是一个下雨的晚上，我想我可以试试微软的bug-bounty程序。在准备好我的工具集(一些定制的Python脚本、Burpsuite和一个用于文档的本地web服务器)后，我登录了一个旧的Microsoft帐户并搜索了一个目标。</p><p id="5140" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://stream.microsoft.com/en-us/" rel="noopener ugc nofollow" target="_blank"><strong class="ka ir">stream.microsoft.com</strong></a></p><p id="f001" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">没听说过，没用过，没听过有人用，听起来不错！这确实很好。良好的编程使用REST-ful API的(取决于您的位置:欧盟，亚洲，美国)通信通过XMLHttp为基础的请求令牌-安全与不同的认证头装备后端架构，验证我的请求的每一个字符。“这个应用程序不可能是不安全的”我心想。</p></div><div class="ab cl le lf hu lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="ij ik il im in"><p id="42d7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我的方法始终如一，在每个目标上，我都努力遵循这些全球步骤，以确保取得一些成功:</p><ul class=""><li id="af7a" class="ll lm iq ka b kb kc kf kg kj ln kn lo kr lp kv lq lr ls lt bi translated">侦察(太大，此处不再赘述)</li><li id="982a" class="ll lm iq ka b kb lu kf lv kj lw kn lx kr ly kv lq lr ls lt bi translated">确定正确的应用程序逻辑</li><li id="0fd4" class="ll lm iq ka b kb lu kf lv kj lw kn lx kr ly kv lq lr ls lt bi translated">尝试以任何方式绕过应用程序逻辑(不仅仅是与安全相关的)</li><li id="8546" class="ll lm iq ka b kb lu kf lv kj lw kn lx kr ly kv lq lr ls lt bi translated">注意“bug”也就是应用程序错误</li><li id="b7f7" class="ll lm iq ka b kb lu kf lv kj lw kn lx kr ly kv lq lr ls lt bi translated">尝试将此功能性错误“bug”扩展到安全相关问题</li><li id="6ea6" class="ll lm iq ka b kb lu kf lv kj lw kn lx kr ly kv lq lr ls lt bi translated">试图利用这些安全问题</li><li id="22b5" class="ll lm iq ka b kb lu kf lv kj lw kn lx kr ly kv lq lr ls lt bi translated">试着证明一些影响(低；中等；高)</li><li id="9f05" class="ll lm iq ka b kb lu kf lv kj lw kn lx kr ly kv lq lr ls lt bi translated">尝试通过链接不同的问题或错误(异类)来扩大影响</li></ul><p id="250f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在“微软流”的例子中，迎接我的是“成千上万”的参数和不同的API，所以我把重点放在了文件上传这个核心功能上。在理解了不同参数背后的逻辑之后，我使用了我的Python-fuzzer(可能它会很快发布；<a class="ae kw" href="https://github.com/si9int" rel="noopener ugc nofollow" target="_blank">github.com/si9int</a>)模糊不同的参数，根据HTTP响应和请求时间显示有效和无效输入之间的相关性或差异。</p></div><div class="ab cl le lf hu lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="ij ik il im in"><p id="c110" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我通过使用不同的字符串和有效负载引用不同的攻击媒介来敲打后端，并注意到两件(后来)重要的事情:</p><ol class=""><li id="82f9" class="ll lm iq ka b kb kc kf kg kj ln kn lo kr lp kv lz lr ls lt bi translated">API接受HTML，但对其进行编码，例如:<code class="fe ma mb mc md b">&lt;h1&gt;Hello world!&lt;/h1&gt;</code>是视频标题的有效字符串</li><li id="8d26" class="ll lm iq ka b kb lu kf lv kj lw kn lx kr ly kv lz lr ls lt bi translated">API正在解释Unicode，该API允许注入不同的空格和白块，而不考虑字符限制(1个Unicode = 1个字符)</li></ol><p id="7698" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是，没错，没有反射，没有异常或任何错误，无视JavaScript功能带来的正确和完美的错误处理。我输了比赛，浪费时间，没有动力，上床睡觉。</p></div><div class="ab cl le lf hu lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="ij ik il im in"><p id="75f4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">第二天早上，我坐到办公桌前，查看了我的电子邮件(我几乎每天都是这样)。*唉*我收到了很多来自<code class="fe ma mb mc md b">no-reply-stream@microsoft.com</code>的新邮件，描述我上传的视频被成功渲染“bla bla”。然后我注意到一些事情，我的楼梯开始旋转360度。标题<code class="fe ma mb mc md b">&lt;h1&gt;Hello world!&lt;/h1&gt;</code>被执行，HTML被呈现在电子邮件中。</p><p id="ce1a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">呜呜呜！</strong></p><p id="2a5b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">头奖(有点……；对我来说是在浪费时间之后)。我立即重新访问了编辑视频页面，重新检查了“分享您的视频”功能，并制作了一份概念证明，提交给了“微软安全响应中心”:</p><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi me"><img src="../Images/8b438771cd4046045cba0139894405a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v0PUYlePkhTN6NHEiD79MA.png"/></div></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">嗯是的..它又快又脏..</figcaption></figure><p id="485a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我在一个顶级的微软服务上发现了一个有效的bug！滥用<code class="fe ma mb mc md b">@microsoft.com</code>域名进行网络钓鱼。<strong class="ka ir">感觉难以置信</strong></p><blockquote class="kx ky kz"><p id="953e" class="jy jz la ka b kb kc kd ke kf kg kh ki lb kk kl km lc ko kp kq ld ks kt ku kv ij bi translated"><em class="iq"> *尝试感受我的感受，让它生效* </em></p></blockquote><p id="e6d2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">直到Gaurav把我的报告移到<strong class="ka ir"> N/A </strong>。</p><p id="1474" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">啊是啊..他们认为邮件是以有效载荷命名的，因此很容易发现网络钓鱼企图。我失去了动力，把邮件踢到了/archive。</p></div><div class="ab cl le lf hu lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="ij ik il im in"><p id="e9ed" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">第二天，我和我的一个同学谈论这件事，想起了char限制。从大学回到家后，我立即重新检查了这个问题，并设计了一个新的PoC:</p><p id="daef" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">``嗨，loveley女士，这是微软被黑和滥用的</p></div><div class="ab cl le lf hu lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="ij ik il im in"><p id="073e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">成功了！白块和空格的组合将我的有效载荷推到了侧边栏的右侧(我使用的是“Microsoft Outlook”的实例)，只显示了电子邮件的“合法”标题。</p></div><div class="ab cl le lf hu lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="ij ik il im in"><p id="0288" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">虽然微软的人没有看到任何安全影响，并再次通知我，该漏洞是低级别的，不会被修复。我不认为这是一个好主意，因为可能会有更多的发现和破坏实际的HTML上下文，欺骗HTML本身。这种方法也可以用来制作极其高效的鱼叉式网络钓鱼邮件。</p><p id="2866" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您可以在此处阅读原始报告(我已经在电子邮件对话中添加了第二个PoC):<a class="ae kw" href="https://si9int.sh/view/9/" rel="noopener ugc nofollow" target="_blank">https://si9int.sh/view/9/</a></p><p id="475b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我希望您喜欢这篇短文，欢迎随时向我提问:</p><p id="7323" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">SI9INT(<a class="ae kw" href="https://twitter.com/si9int" rel="noopener ugc nofollow" target="_blank">https://twitter.com/si9int</a>)</p></div></div>    
</body>
</html>