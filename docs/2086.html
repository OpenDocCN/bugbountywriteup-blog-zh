<html>
<head>
<title>AWS IAM Exploitation Techniques</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS IAM开发技术</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/aws-iam-exploitation-techniques-565830bf704b?source=collection_archive---------0-----------------------#2022-05-23">https://infosecwriteups.com/aws-iam-exploitation-techniques-565830bf704b?source=collection_archive---------0-----------------------#2022-05-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="7db7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Amazon Web Services(AWS)提供多种类型的安全服务，身份和访问管理(IAM)是应用最广泛的一种。</p><p id="096a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">IAM是您的AWS帐户的一项功能，免费提供，用于设置用户、组、策略和角色。当您注册成为根用户时，您将获得对所有IAW服务的所有资源的完全访问权。在IAM的帮助下，在root用户或帐户下，您可以设置多个用户帐户，每个帐户都有自己的凭据。IAM用于管理这些AWS用户身份的验证和授权。不幸的是，IAM的错误配置很有可能导致安全漏洞。根据【2021年云安全状况报告，IAM是最常被引用的云错误配置。当您面临一些问题时，您可能会感到痛苦，比如令人困惑的代理问题，幸运的是AWS已经给出了解决方案，但是随着您的用例的扩展和变得复杂，与IAM相关的安全问题将成为AWS管理员和安全审计员的挑战。</p><p id="232c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这篇文章将给出三种与IAM相关的利用技术，希望它们能引起你对可能潜伏在你的云环境中的类似风险的注意。</p><h1 id="644f" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">通过将角色传递给服务来提升权限</h1><p id="0e5d" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">IAM最基本的组成部分是策略。策略是一个对象，当它与用户、用户组或角色相关联时，定义它们的权限。谈到IAM中的安全最佳实践，您一定听说过最小特权原则，并且您知道不应该使用过于宽松的策略。</p><p id="710e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">例如，如果您对下面的策略示例中的<code class="fe lp lq lr ls b">passRole</code>和<code class="fe lp lq lr ls b">Resource: "*"</code>有扎实的了解，您可能会保持警惕，永远不要将这样的IAM策略附加到IAM用户。</p><pre class="lt lu lv lw gt lx ls ly lz aw ma bi"><span id="8a7f" class="mb kn iq ls b gy mc md l me mf">{<br/>    "Version": "2012-10-17",<br/>    "Statement": [<br/>        {<br/>            "Effect": "Allow",<br/>            "Action": "iam:PassRole",<br/>            "Resource": "*"<br/>        }<br/>    ]<br/>}</span></pre><p id="d653" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是随着事情变得复杂，有一个AWS帐户包含一个拥有<code class="fe lp lq lr ls b">iam:AttachUserPolicy</code>权限的角色和一个拥有<code class="fe lp lq lr ls b">iam:PassRole</code>、<code class="fe lp lq lr ls b">lambda:CreateFunction</code>和<code class="fe lp lq lr ls b">lambda:InvokeFunction</code>权限的用户组:</p><pre class="lt lu lv lw gt lx ls ly lz aw ma bi"><span id="c692" class="mb kn iq ls b gy mc md l me mf">{<br/>     "Version": "2012-10-17",<br/>     "Statement": [<br/>     {<br/>         "Sid": "VisualEditor0",<br/>         "Effect": "Allow",<br/>         "Action": [<br/>               "lambda:CreateFunction",<br/>              "iam:PassRole"<br/>         ],<br/>          "Resource": [<br/>             "arn:aws:iam::*:role/*",<br/>             "arn:aws:lambda:*:*:function:*"<br/>         ]<br/>     },<br/>     {<br/>         "Sid": "VisualEditor1",<br/>         "Effect": "Allow",<br/>         "Action": "lambda:CreateEventSourceMapping",<br/>         "Resource": "*"<br/>     }<br/>  ]<br/>}</span></pre><p id="2b15" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于您来说，识别上述组中的用户获得AWS环境的完全管理权限的风险容易吗？</p><p id="facc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在各种AWS服务中，有更多的方法可以用来执行权限提升攻击:</p><p id="8a94" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">01—iam:CreatePolicyVersion<br/>02—iam:setdefaultpolicyversion 2<br/>03—iam:pass role和ec2:run instances<br/>04—iam:CreateAccessKey<br/>05—iam:CreateLoginProfile<br/>06—iam:UpdateLoginProfile<br/>07—iam:AttachUserPolicy<br/>08—iam:attachgroupolicy<br/>09—iam:attachrole policy<br/>10</p><p id="aa3d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你可以在<a class="ae kl" href="https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/" rel="noopener ugc nofollow" target="_blank">https://rhinosecuritylabs . com/AWS/AWS-privilege-escalation-methods-remediation/</a>上找到更多相关信息。</p><h1 id="eae9" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">在云形成中使用偷偷摸摸的资源注入的后门植入</h1><p id="ab2d" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">AWS CloudFormation帮助您设置和管理AWS资源的集合，称为堆栈。您可以使用模板构建和配置堆栈。模板在部署之前被上传到S3存储桶中。这种设计的一个问题是，当terraform执行S3 URL中托管的模板时，它可能不是预先上传的模板，因为在模板上传和后续部署步骤之间存在一些延迟。缺乏对模板文件完整性的保证，使得攻击者有机会通过在部署之前修改原始的CloudFormation模板来植入后门，从而承担跨帐户IAM角色。</p><p id="7e92" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要实施这种攻击，假设存在易受攻击的AWS环境:</p><ol class=""><li id="14e6" class="mg mh iq jp b jq jr ju jv jy mi kc mj kg mk kk ml mm mn mo bi translated">CloudFormation部署步骤使用S3模板URL</li><li id="f6fd" class="mg mh iq jp b jq mp ju mq jy mr kc ms kg mt kk ml mm mn mo bi translated">模板上传和部署之间存在延迟</li><li id="7426" class="mg mh iq jp b jq mp ju mq jy mr kc ms kg mt kk ml mm mn mo bi translated">攻击者可以访问目标帐户中的IAM用户，该用户对S3存储桶拥有以下权限:s3:PutBucketNotification、s3:PutObject和s3:GetObject</li></ol><p id="f7cc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">整个攻击过程如下图所示:</p><figure class="lt lu lv lw gt mv gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi mu"><img src="../Images/8b06d01ca6ee17e4b2a6027f52eb116e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Xq5MqB5GO5UnHVuQFobmgQ.png"/></div></div></figure><p id="b919" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">每当模板被上传到桶时，Lambda将被调用，因为攻击者具有s3:PutBucketNotification权限来配置s3桶，以向攻击者控制的Lambda发布通知。一旦Lambda收到通知，它将从S3桶中检索模板，通过添加IAM策略来修改它，以授予攻击者目标帐户中的<code class="fe lp lq lr ls b">*:*</code>权限。</p><p id="ee19" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">部署工件修改并不是一项新技术，也不是专门针对CloudFormation的。这个向量仍然很可怕，因为它允许权限直接提升到受害者帐户中的管理员角色。</p><p id="815b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">原帖在这里:<a class="ae kl" href="https://rhinosecuritylabs.com/aws/cloud-malware-cloudformation-injection/" rel="noopener ugc nofollow" target="_blank">https://rhinosecuritylabs . com/AWS/cloud-malware-cloud formation-injection/</a></p><h1 id="fc6c" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">临时代币的阴暗面</h1><p id="119b" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">AWS STS是一项AWS服务，它允许您请求临时安全凭据，以便使用有时间限制和受限的权限进行操作。</p><p id="0ea3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">相对于访问密钥和长期凭据，建议使用临时安全令牌。当用户或应用程序执行某些操作时，以及AWS本身在后台执行的自动操作中，都会用到它们。</p><p id="e3e8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是STS也有自己的阴暗面。一旦特权访问密钥泄露，攻击者倾向于利用STS生成临时令牌来隐藏他们的踪迹，而不是直接使用访问密钥。在检测到泄漏之后，即使泄漏的访问密钥已经被撤销，这些临时令牌在外部仍然有效。当泄漏或创建临时令牌时，它可以转换为“永久”令牌。这种转换可以通过使用AssumeRole来生成具有一个临时令牌的临时令牌束，然后使用新创建的临时令牌来创建更多令牌，最终演变成“树分支”结构来实现。</p><figure class="lt lu lv lw gt mv gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/fa3fbd50fb9e4120241184a0b1e2ee0f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1130/format:webp/1*4NZKkhVi508zzehQ10FR_Q.png"/></div></figure><p id="3806" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果两个或更多角色之间存在循环信任，并且假设角色调用可以被链接任意次，则可以利用另一种技术“角色链杂耍”来帮助攻击者无限期地获得对AWS资源的访问权。</p><figure class="lt lu lv lw gt mv gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/ab1b250436b3e3c36f719f3b9774ec54.png" data-original-src="https://miro.medium.com/v2/resize:fit:646/format:webp/1*Lqu9GetSD59qu8jHlvGB-Q.png"/></div></figure><h1 id="2c78" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">摘要</h1><p id="ef62" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">说到安全攻击，你不应该低估攻击者的创造力。众所周知，IAM非常复杂。为了应对常见的IAM威胁并降低风险，我们应该了解恶意行为者使用的各种利用、工具和资源。</p></div></div>    
</body>
</html>