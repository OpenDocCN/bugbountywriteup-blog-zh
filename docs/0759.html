<html>
<head>
<title>Leaking AWS Metadata</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">泄漏AWS元数据</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/leaking-aws-metadata-f5bc8de03284?source=collection_archive---------1-----------------------#2020-08-13">https://infosecwriteups.com/leaking-aws-metadata-f5bc8de03284?source=collection_archive---------1-----------------------#2020-08-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="aee5" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">—不寻常的方式</h2></div><p id="33b2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">以一种不寻常的方式找到AWS实例的凭证并利用它来获得对bucket对象的读/写访问的简短故事。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div class="gh gi lb"><img src="../Images/96138db356c5845b872652822cda4ad1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/1*Z0nwx9WHqf5wpVhMjmHLlA.png"/></div></figure><p id="7434" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">Tl；dr: </strong>通过在响应中泄漏AWS凭据的应用程序的个人资料图片上传功能，找到了对GetCredentialsForIdentity的AWS Cognito API调用。</p><blockquote class="lj lk ll"><p id="78ae" class="kf kg lm kh b ki kj jr kk kl km ju kn ln kp kq kr lo kt ku kv lp kx ky kz la ij bi translated">AWS实例元数据是关于实例的数据，可用于配置或管理正在运行的实例。在AWS中，实例元数据服务(IMDS)使有关计算实例、其网络和存储的信息可供实例上运行的软件使用。IMDS也制作临时国书。在AWS CLI中配置此元数据凭据，用户可以访问与帐户相关的服务。</p></blockquote></div><div class="ab cl lq lr hu ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="ij ik il im in"><p id="f3aa" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">通常的方式</strong></p><p id="e58c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">提取AWS凭据的传统方式是利用SSRF。SSRF攻击授予从目标机器发出请求的权限。如果应用程序运行在任何云服务上，攻击者就可以尝试访问元数据服务。</p><p id="0290" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在AWS云服务的情况下，其路由在自动私有IP地址上通过<a class="ae lx" href="http://169.254.169.254/" rel="noopener ugc nofollow" target="_blank"> http://169.254.169.254/ </a></p><p id="966d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">由于AWS的元数据服务不需要任何特定的头，因此获取URL<a class="ae lx" href="http://169.254.169.254/latest/meta-data/iam/security-credentials/ROLENAME" rel="noopener ugc nofollow" target="_blank">http://169 . 254 . 169 . 254/latest/meta-data/iam/Security-credentials/ROLENAME</a>将返回AccessKeyID、SecretKey和安全令牌。</p><p id="d3bc" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="lm">测试用例:</em></p><p id="be26" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">文件名. ext？URL = http://169 . 254 . 169 . 254/latest/meta-data/iam/security-credentials/rolename</p><pre class="lc ld le lf gt ly lz ma mb aw mc bi"><span id="2364" class="md me iq lz b gy mf mg l mh mi">Tip💡: Use CanaryTokens or Pythonanywhere server to test for SSRF Bugs</span></pre></div><div class="ab cl lq lr hu ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="ij ik il im in"><h1 id="7fa8" class="mj me iq bd mk ml mm mn mo mp mq mr ms jw mt jx mu jz mv ka mw kc mx kd my mz bi translated">我遇到的情况是:</h1><p id="484c" class="pw-post-body-paragraph kf kg iq kh b ki na jr kk kl nb ju kn ko nc kq kr ks nd ku kv kw ne ky kz la ij bi translated">我正在测试一个应用程序，它是一个专业人士的网络平台，就像Linkedin一样，</p><p id="0596" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">打开我的打嗝套件，开始找虫子。在照片上传功能中发现了一个盲SSRF漏洞，但下一个原因是什么？它只是从目标机器发出一个请求，没有其他任何东西，没有响应消息！找不到任何方法来升级它或提取AWS元数据(虽然主要目标),因为在盲SSRF中，我已经知道该服务正在与AWS Elastic beanstalk一起运行，其中一些ec2实例作为服务器ping ec2实例IP。</p><p id="104a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是负责用elastic-beanstalk bucket url更新个人资料图片的请求。(这个&amp;imgurl=参数容易受到盲SSRF的攻击，但是没有用😔)</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="nf ng di nh bf ni"><div class="gh gi ca"><img src="../Images/0e7f4e185944c72a402febe96f18d799.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2-WVNmpb7p_i1jzyO2AvcQ.png"/></div></div></figure><p id="10c8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">但是等等…我怎么忘记看HTTP历史了</p><figure class="lc ld le lf gt lg"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="97e2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在检查burp中的HTTP历史记录时，我发现了一个公开的AWS Cognito API对GetCredentialsForIdentity的调用，作为响应，它给出了AccessKeyID、SecretKey和安全令牌。</p><blockquote class="lj lk ll"><p id="9907" class="kf kg lm kh b ki kj jr kk kl km ju kn ln kp kq kr lo kt ku kv lp kx ky kz la ij bi translated">Amazon Cognito是一种用户身份和数据同步服务，使开发人员可以轻松管理跨多个移动设备或连接设备的应用程序的用户数据。他们可以使用谷歌脸书和亚马逊等公共登录提供商为应用程序的用户创建身份。只需使用Amazon Cognito API保存用户数据并进行同步，用户数据就会安全地同步并存储在AWS云中。如果网站使用其他AWS服务(如亚马逊S3、亚马逊迪纳摩数据库等。)Amazon Cognito为您提供了具有有限权限的临时凭证，用户可以使用这些凭证来访问数据库资源。</p></blockquote><p id="641a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">GetCredentialsForIdentity API请求</p><blockquote class="lj lk ll"><p id="5cd3" class="kf kg lm kh b ki kj jr kk kl km ju kn ln kp kq kr lo kt ku kv lp kx ky kz la ij bi translated">返回所提供身份ID的凭据</p></blockquote><p id="7c1e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">好的，让我倒回去让你看看个人资料图片上传功能的应用流程</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="nf ng di nh bf ni"><div class="gh gi nl"><img src="../Images/145d4e7079d7fd51db540580c3a36654.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pl3-tBa2GfJ5Vu4KTy5ucA.png"/></div></div></figure><p id="c549" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">公开的AWS Cognito API调用GetCredentialsForIdentity，这有助于应用程序通过分配临时凭证将数据放入存储桶。呜哇！我达到了我的目标。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="nf ng di nh bf ni"><div class="gh gi nm"><img src="../Images/fe9ae1b31aca574e9cd226b085f511fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZuIyb5PnikYyZ-8Rv9hhAw.png"/></div></div></figure><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="nf ng di nh bf ni"><div class="gh gi nn"><img src="../Images/fcbf63bb9cce442e97378f018bf95c3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6GDnRrYEtozYhc0pNOraQw.png"/></div></div></figure><p id="11e0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">滥用元数据:</strong></p><p id="5336" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们得到了凭证，现在我们可以做很多坏事，但首先让我们用AWS CLI配置这个凭证</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="nf ng di nh bf ni"><div class="gh gi no"><img src="../Images/1d3530eb95b43a6d13443f5c49ce9d5a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Om8fssZGJxceo2y3"/></div></div></figure><p id="e19a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在只需点击一些CLI命令来提取我们需要的数据。</p><ul class=""><li id="3790" class="np nq iq kh b ki kj kl km ko nr ks ns kw nt la nu nv nw nx bi translated">检查AWS获取呼叫者身份</li></ul><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="nf ng di nh bf ni"><div class="gh gi ny"><img src="../Images/fbd616e6d24316054007cd13dbe5819a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*8ior_zYPv5LcebZs"/></div></div></figure><ul class=""><li id="db41" class="np nq iq kh b ki kj kl km ko nr ks ns kw nt la nu nv nw nx bi translated">列出存储桶对象</li></ul><p id="737e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要列出所有桶对象，您必须给出桶名，否则它将显示拒绝访问。我已经知道了配置文件pic图像位置的存储桶名称。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="nf ng di nh bf ni"><div class="gh gi nz"><img src="../Images/e0ee5302619226d48539431ff2372e51.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*X9hrwqow9KzawFxH"/></div></div></figure><ul class=""><li id="e4bb" class="np nq iq kh b ki kj kl km ko nr ks ns kw nt la nu nv nw nx bi translated">将文件移动到存储桶</li></ul><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="nf ng di nh bf ni"><div class="gh gi oa"><img src="../Images/b8be9d060735e0382552374b8b80c3b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*udx_9mfZ0dxInIjU"/></div></div></figure><ul class=""><li id="f801" class="np nq iq kh b ki kj kl km ko nr ks ns kw nt la nu nv nw nx bi translated">从存储桶中删除任何文件</li></ul><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="nf ng di nh bf ni"><div class="gh gi ob"><img src="../Images/4059d0408ed7792dcf5861f4721c8dc2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*1NkonAjLFrA-KJqD"/></div></div></figure><p id="d766" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">正如您看到的，我们获得了对存储桶的读/写访问权限，这足以显示影响。但是攻击者可以做的更糟，他可以在本地下载所有数据，删除整个bucket，然后从他的帐户中重新创建一个同名的bucket。</p><p id="9ce5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">即使如此，攻击者也可以通过将PHP webshell上传到s3 bucket来升级到RCE，并在那里执行系统级命令。看这里:<a class="ae lx" href="https://www.notsosecure.com/exploiting-ssrf-in-aws-elastic-beanstalk/" rel="noopener ugc nofollow" target="_blank">https://www . notsosecure . com/exploining-ssrf-in-AWS-elastic-beanstalk/</a></p><p id="7799" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">结论:</strong></p><p id="f57e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">查看每个HTTP请求和响应(只需在后台启动您的burp代理，并体验应用程序的所有功能)，尤其是在服务器上读取或写入数据的地方。有时缺陷就在那里，你只需要浏览请求和响应。</p><p id="bfce" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">虽然由于IMDSv2新的安全集成，用SSRF提取数据是不可能的，但仍然有许多应用程序没有更新它，所以仍然有机会取得成功。</p><p id="8ec5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">参考资料:<a class="ae lx" href="https://docs.aws.amazon.com/cognitoidentity/latest/APIReference/API_GetCredentialsForIdentity.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/cognitoidentity/latest/API reference/API _ getcredentialsforidentity . html</a></p><p id="97a6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">感谢瓦图尔·戈亚尔的校对。</p><p id="033b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">❤迷因与安全。对twitter.com/nullb0t的任何讨论都开放</p></div></div>    
</body>
</html>