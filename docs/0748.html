<html>
<head>
<title>Gain access to an internal machine using Port forwarding — Setup experiment environment</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用端口转发访问内部机器—设置实验环境</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/gain-access-to-an-internal-machine-using-port-forwarding-setup-experiment-environment-dd0a50110650?source=collection_archive---------2-----------------------#2020-08-09">https://infosecwriteups.com/gain-access-to-an-internal-machine-using-port-forwarding-setup-experiment-environment-dd0a50110650?source=collection_archive---------2-----------------------#2020-08-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/82269359f924f87e7f2dc37c016269b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sBY1kL6RLTw936BvObOkKA.jpeg"/></div></div></figure><p id="edd3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">端口转发是一种技术，其中一台机器中的端口被隧道传输到另一台机器中的端口。简单地说，对机器<em class="kw">的端口<em class="kw">P1</em>M1</em>的请求被“转发”为对机器<em class="kw">的端口<em class="kw"> P2 </em>的请求。</em></p><p id="6045" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">想象一下一个web应用服务器，其中传入的流量被防火墙过滤，只允许流量通过端口80和443，而拒绝其余的流量。一个恶意用户在端口22找到了登录web应用服务器的密码。但是不幸的是，防火墙拒绝了他的SSH请求。如果恶意用户可以将到达web应用服务器端口80的请求端口转发到它的端口22，会怎么样？这样，在服务器端口80发出的SSH请求将被“转发”到端口22，并最终由服务器的<code class="fe kx ky kz la b">sshd</code>提供服务。</p><h1 id="3614" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">方案</h1><p id="5485" class="pw-post-body-paragraph jy jz iq ka b kb lz kd ke kf ma kh ki kj mb kl km kn mc kp kq kr md kt ku kv ij bi translated">想象你自己是一个渗透测试者。在一次成功的社会工程攻击之后，你进入数据中心，将你的计算机连接到网络。你的社会工程技能是如此有效，以至于你设法学会了跳转服务器(或)堡垒服务器和企业网络内部服务器的SSH登录密码。<strong class="ka ir">你的意图是在企业网络</strong>的内部服务器( <a class="ae me" href="https://en.wikipedia.org/wiki/Watering_hole_attack" rel="noopener ugc nofollow" target="_blank"> <strong class="ka ir">水坑</strong> </a> <strong class="ka ir">)中放置一个恶作剧恶意软件。数据中心的堡垒服务器有两个网络接口。一个连接到企业网络，另一个连接到数据中心网络。</strong></p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mf"><img src="../Images/223c55a33d4a4f7406bf6671877c6ed8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F585GP5VNDNUjG4P5hI8oA.png"/></div></div><figcaption class="mk ml gj gh gi mm mn bd b be z dk translated">情景视觉</figcaption></figure><p id="c08d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们列举一下你所掌握的信息:</p><ul class=""><li id="bc1b" class="mo mp iq ka b kb kc kf kg kj mq kn mr kr ms kv mt mu mv mw bi translated"><strong class="ka ir">数据中心</strong>在<strong class="ka ir"><em class="kw">172 . 17 . 0 . 0/16</em></strong>子网中，<strong class="ka ir">企业</strong>在<strong class="ka ir"> <em class="kw"> 10.10.10.0/24 </em>子网</strong>中。</li><li id="5d10" class="mo mp iq ka b kb mx kf my kj mz kn na kr nb kv mt mu mv mw bi translated"><strong class="ka ir">你的</strong>机的IP地址是<strong class="ka ir"><em class="kw">172 . 17 . 0 . 1</em></strong><em class="kw">。</em></li><li id="ef60" class="mo mp iq ka b kb mx kf my kj mz kn na kr nb kv mt mu mv mw bi translated"><strong class="ka ir">堡垒服务器</strong> <strong class="ka ir">面向数据中心网络</strong>的网络接口IP地址为<strong class="ka ir"><em class="kw">172 . 17 . 0 . 2</em></strong><em class="kw"/>，而<strong class="ka ir">面向企业网络</strong>的网络接口为<strong class="ka ir"><em class="kw">10 . 10 . 2</em></strong><em class="kw">。</em></li><li id="5733" class="mo mp iq ka b kb mx kf my kj mz kn na kr nb kv mt mu mv mw bi translated"><strong class="ka ir">内部服务器</strong>的IP地址为<strong class="ka ir"><em class="kw">10 . 10 . 10 . 3</em>T60。</strong></li><li id="5761" class="mo mp iq ka b kb mx kf my kj mz kn na kr nb kv mt mu mv mw bi translated"><strong class="ka ir">内部服务器</strong> <strong class="ka ir">无法访问互联网</strong>。(不知何故)</li><li id="84fa" class="mo mp iq ka b kb mx kf my kj mz kn na kr nb kv mt mu mv mw bi translated">堡垒服务器的<strong class="ka ir"> SSH登录凭证</strong>为<code class="fe kx ky kz la b">bastion:fortwall</code>，内部服务器的<code class="fe kx ky kz la b">admin:homeportal</code>。</li></ul><p id="126b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这篇博客中，我们将介绍建立复制上述场景的环境的过程。在接下来的博客中，我们将进行渗透测试。</p><h1 id="4fa4" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">让我们边做边学—设置</h1><p id="3839" class="pw-post-body-paragraph jy jz iq ka b kb lz kd ke kf ma kh ki kj mb kl km kn mc kp kq kr md kt ku kv ij bi translated">如上图所示，我们将在本地机器上设置一个环境来执行攻击。</p><p id="35e4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于环境设置，我们将使用<a class="ae me" href="https://www.docker.com/" rel="noopener ugc nofollow" target="_blank"> dockers </a>创建相关的网络和节点。出于本演示的目的，请确保渗透测试机器安装了以下实用程序(其中大部分已预安装在Kali Linux发行版中):</p><ul class=""><li id="f5a9" class="mo mp iq ka b kb kc kf kg kj mq kn mr kr ms kv mt mu mv mw bi translated"><a class="ae me" href="https://linuxhint.com/install_docker_kali_linux/" rel="noopener ugc nofollow" target="_blank">对接引擎</a></li><li id="0a8c" class="mo mp iq ka b kb mx kf my kj mz kn na kr nb kv mt mu mv mw bi translated">nmap</li><li id="0da4" class="mo mp iq ka b kb mx kf my kj mz kn na kr nb kv mt mu mv mw bi translated">ssh(客户端)</li><li id="eb56" class="mo mp iq ka b kb mx kf my kj mz kn na kr nb kv mt mu mv mw bi translated">代理链</li><li id="eb8b" class="mo mp iq ka b kb mx kf my kj mz kn na kr nb kv mt mu mv mw bi translated">python3</li></ul><h2 id="a4c8" class="nc lc iq bd ld nd ne dn lh nf ng dp ll kj nh ni lp kn nj nk lt kr nl nm lx nn bi translated">设置子网</h2><p id="fc70" class="pw-post-body-paragraph jy jz iq ka b kb lz kd ke kf ma kh ki kj mb kl km kn mc kp kq kr md kt ku kv ij bi translated">使用docker-engine提供的默认桥接网络(通常为<em class="kw"> 172.17.0.0/16 </em>)作为数据中心网络。要创建企业网络子网，请运行以下docker命令:</p><pre class="mg mh mi mj gt no la np nq aw nr bi"><span id="234a" class="nc lc iq la b gy ns nt l nu nv">docker network create enterprise --subnet 10.10.10.0/24</span></pre><p id="0908" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当docker引擎运行时(在<code class="fe kx ky kz la b">docker0</code>接口)，渗透测试机自动获取IP地址<em class="kw"> 172.17.0.1 </em>。它是容器与互联网对话的网关)。</p><h2 id="68dd" class="nc lc iq bd ld nd ne dn lh nf ng dp ll kj nh ni lp kn nj nk lt kr nl nm lx nn bi translated">设置节点—修改默认的ssh服务器docker映像</h2><p id="5c47" class="pw-post-body-paragraph jy jz iq ka b kb lz kd ke kf ma kh ki kj mb kl km kn mc kp kq kr md kt ku kv ij bi translated">为了创建一个打开了<code class="fe kx ky kz la b">sshd</code>服务的docker容器，我们将使用<code class="fe kx ky kz la b"><a class="ae me" href="https://hub.docker.com/r/linuxserver/openssh-server" rel="noopener ugc nofollow" target="_blank">linuxserver/openssh-server</a></code> docker图像，在<code class="fe kx ky kz la b">sshd_config</code>中稍加修改。创建一个名为<code class="fe kx ky kz la b">Dockerfile</code>的新文件，并填入以下内容。</p><figure class="mg mh mi mj gt jr"><div class="bz fp l di"><div class="nw nx l"/></div></figure><p id="c3be" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后创建一个名为<code class="fe kx ky kz la b">sshd_config</code>的文件(该文件将用于替换<code class="fe kx ky kz la b">linuxserver/openssh-server</code> docker镜像中的原始配置)，并填入以下内容。</p><figure class="mg mh mi mj gt jr"><div class="bz fp l di"><div class="nw nx l"/></div></figure><p id="3a95" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe kx ky kz la b">sshd_config</code>是<code class="fe kx ky kz la b">linuxserver/openssh-server</code> docker映像的SSHd配置文件的一个简单复制，有以下变化。</p><ul class=""><li id="e4d6" class="mo mp iq ka b kb kc kf kg kj mq kn mr kr ms kv mt mu mv mw bi translated"><code class="fe kx ky kz la b">PasswordAuthentication yes</code></li><li id="e280" class="mo mp iq ka b kb mx kf my kj mz kn na kr nb kv mt mu mv mw bi translated"><code class="fe kx ky kz la b">AllowTcpForwarding yes</code></li></ul><p id="6583" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后，通过运行以下命令构建docker映像。</p><pre class="mg mh mi mj gt no la np nq aw nr bi"><span id="149d" class="nc lc iq la b gy ns nt l nu nv">docker build -t sshserver:latest .</span></pre><h2 id="2289" class="nc lc iq bd ld nd ne dn lh nf ng dp ll kj nh ni lp kn nj nk lt kr nl nm lx nn bi translated">设置节点—堡垒服务器</h2><p id="f627" class="pw-post-body-paragraph jy jz iq ka b kb lz kd ke kf ma kh ki kj mb kl km kn mc kp kq kr md kt ku kv ij bi translated">现在，我们已经有了SSH服务器docker映像，运行下面的命令将一个bastion服务器作为默认桥接网络中的一个容器。</p><pre class="mg mh mi mj gt no la np nq aw nr bi"><span id="b106" class="nc lc iq la b gy ns nt l nu nv">docker run -d -e SUDO_ACCESS=true -e USER_NAME=bastion -e USER_PASSWORD=fortwall -e PASSWORD_ACCESS=true --name bastion sshserver:latest</span></pre><p id="fd8e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要为堡垒服务器创建辅助接口，请运行以下命令。</p><pre class="mg mh mi mj gt no la np nq aw nr bi"><span id="e474" class="nc lc iq la b gy ns nt l nu nv">docker network connect enterprise bastion</span></pre><p id="3657" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">设置完成后，bastion服务器的网络配置如下所示:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ny"><img src="../Images/c6f0aeb6a6677beb5baa106cf0a3d139.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w4ZTKjOgJA16c7hnt9_whw.png"/></div></div><figcaption class="mk ml gj gh gi mm mn bd b be z dk translated">堡垒服务器网络配置</figcaption></figure><h2 id="87e4" class="nc lc iq bd ld nd ne dn lh nf ng dp ll kj nh ni lp kn nj nk lt kr nl nm lx nn bi translated">设置节点—内部服务器</h2><p id="5184" class="pw-post-body-paragraph jy jz iq ka b kb lz kd ke kf ma kh ki kj mb kl km kn mc kp kq kr md kt ku kv ij bi translated">要将内部服务器作为容器运行，请运行以下docker命令。</p><pre class="mg mh mi mj gt no la np nq aw nr bi"><span id="eaa4" class="nc lc iq la b gy ns nt l nu nv">docker run -d -e SUDO_ACCESS=true -e USER_NAME=admin -e USER_PASSWORD=homeportal -e PASSWORD_ACCESS=true --name internal_server --network enterprise sshserver:latest</span></pre><p id="48cb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">设置完成后，内部服务器的网络配置如下所示:</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nz"><img src="../Images/3c1f99b9b9cf0e949a574e2ce7f58b4c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v6Ne263rOcayLe3G69mebw.png"/></div></div><figcaption class="mk ml gj gh gi mm mn bd b be z dk translated">内部服务器网络配置</figcaption></figure><p id="e771" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> <em class="kw">注意</em> </strong> <em class="kw">:如果你的机器上有其他容器在运行，堡垒服务器的</em> <code class="fe kx ky kz la b"><em class="kw">eth0</em></code> <em class="kw">接口IP可能不是172.17.0.2。在攻击过程中，需要记下堡垒服务器获得的IP地址，并使用它来代替172.17.0.2。</em></p><h1 id="bf62" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">这还没有结束</h1><p id="2924" class="pw-post-body-paragraph jy jz iq ka b kb lz kd ke kf ma kh ki kj mb kl km kn mc kp kq kr md kt ku kv ij bi translated">在接下来的<a class="ae me" href="https://medium.com/bugbountywriteup/gain-access-to-an-internal-machine-using-port-forwarding-penetration-testing-518c0b6a4a0e" rel="noopener">博客</a>中，我们将通过执行渗透测试来学习端口转发。</p></div></div>    
</body>
</html>