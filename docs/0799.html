<html>
<head>
<title>Stop scratching the surface, and hack the dependencies</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">不要只触及表面，要破解依赖关系</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/stop-scratching-the-surface-and-hack-the-dependencies-fe4c26cd8ea?source=collection_archive---------0-----------------------#2020-08-31">https://infosecwriteups.com/stop-scratching-the-surface-and-hack-the-dependencies-fe4c26cd8ea?source=collection_archive---------0-----------------------#2020-08-31</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="d851" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">TLDR；</strong>我如何在格拉夫纳发现了四个XSS漏洞，而不是在私人BBP和<strong class="jp ir">狩猎时继续挖掘其表面。)<br/> </strong> <em class="kl"> *但是你必须读完它才能明白为什么</em>😎</p><p id="c3ea" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">不久前，我在我最喜欢的Bug-Bounty程序中搜索，但在其狭窄的范围内找不到任何新的或可疑的东西，所以我没有就此打住，而是决定追寻它们的依赖关系。</p><p id="d0e6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个程序使用Grafana来实现它的一些核心功能，所以我想，为什么不去追求Grafana呢？</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi km"><img src="../Images/4a1d0804108b1a41f1131e26e1f7608b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/0*p6f_g4LCiKE67aJI.gif"/></div></figure><h1 id="437d" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">在表格可视化中排名第一的存储XSS(CVE-2020–12245)</h1><p id="66fe" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">几分钟后，我发现了一个<strong class="jp ir">存储在可视化表中的XSS。</strong></p><p id="2007" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="kl">在此之前我也发现了另一个问题，但它以重复结束，因为它已经是一个已知的问题——</em><a class="ae lx" href="https://github.com/grafana/grafana/pull/23254" rel="noopener ugc nofollow" target="_blank">https://github.com/grafana/grafana/pull/23254</a>。\_(ツ)_/</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="gh gi ly"><img src="../Images/404aac1735e9eff0f6ea660b00c8780f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2OJHm1MIyvt5-UhfWVkpEg.png"/></div></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated">Grafana易受攻击的表格可视化</figcaption></figure><h2 id="2cd4" class="mh kv iq bd kw mi mj dn la mk ml dp le jy mm mn li kc mo mp lm kg mq mr lq ms bi translated">影响</h2><p id="4dbd" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">通过利用此漏洞，攻击者只需查看带有恶意可视化效果的仪表板，就可以在受害者的浏览器上执行任何JavaScript代码。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="gh gi mt"><img src="../Images/2f070b85cf7a74f5e9ebdc9ae020e036.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NK5x5IrSAdhj92G01vi1Eg.png"/></div></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated">带有“受害者”cookies的警告框</figcaption></figure><h2 id="a011" class="mh kv iq bd kw mi mj dn la mk ml dp le jy mm mn li kc mo mp lm kg mq mr lq ms bi translated">参考</h2><ul class=""><li id="49e7" class="mu mv iq jp b jq ls ju lt jy mw kc mx kg my kk mz na nb nc bi translated"><a class="ae lx" href="https://github.com/grafana/grafana/blob/master/CHANGELOG.md#673-2020-04-23" rel="noopener ugc nofollow" target="_blank">https://github . com/grafana/grafana/blob/master/changelog . MD # 673-2020-04-23</a></li></ul><h1 id="0520" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">在饼图面板中排名第二的存储XSS(CVE-2020–13429)</h1><p id="1b6c" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">饼状图是一个官方的Grafana插件，默认安装。</p><p id="49c6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我发现“值头”字段既不验证也不净化用户输入，因此容易受到XSS注入的攻击。<br/>我能够注入一个简单的XSS有效载荷，例如<code class="fe nd ne nf ng b">&lt;img src onerror="confirm(document.cookie)"&gt;</code>。</p><h2 id="b0db" class="mh kv iq bd kw mi mj dn la mk ml dp le jy mm mn li kc mo mp lm kg mq mr lq ms bi translated">影响</h2><p id="d81c" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">通过利用此漏洞，攻击者只需查看带有恶意可视化效果的仪表板，就可以在受害者的浏览器上执行任何JavaScript代码。</p><h2 id="a44e" class="mh kv iq bd kw mi mj dn la mk ml dp le jy mm mn li kc mo mp lm kg mq mr lq ms bi translated">参考</h2><ul class=""><li id="9e5e" class="mu mv iq jp b jq ls ju lt jy mw kc mx kg my kk mz na nb nc bi translated"><a class="ae lx" href="https://github.com/grafana/piechart-panel/issues/218" rel="noopener ugc nofollow" target="_blank">https://github.com/grafana/piechart-panel/issues/218</a></li></ul><h1 id="a8e5" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">在图形可视化中排名第三的存储XSS(CVE-2020–24303)</h1><p id="3813" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">当使用ElasticSearch作为数据源时,“查询”选项卡中的“别名”输入字段既不净化也不验证用户输入，这允许我向该字段注入一个简单的XSS有效负载(例如<code class="fe nd ne nf ng b">&lt;img src onerror="alert(document.cookie)"&gt;</code>)。</p><p id="9fa3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦受害者打开可视化标签，有效载荷就会被触发。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="gh gi nh"><img src="../Images/8ab16e5439a74d8c67c0e79f0f728f64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*XVZ8Y_ZuBUHUrvIMcZf5TQ.gif"/></div></div></figure><h2 id="4eb4" class="mh kv iq bd kw mi mj dn la mk ml dp le jy mm mn li kc mo mp lm kg mq mr lq ms bi translated">影响</h2><p id="457b" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">通过利用此漏洞，攻击者可以通过操纵受害者的浏览器打开恶意可视化的“查询”选项卡，在受害者的浏览器上执行任何JavaScript代码。</p><h2 id="4609" class="mh kv iq bd kw mi mj dn la mk ml dp le jy mm mn li kc mo mp lm kg mq mr lq ms bi translated">参考</h2><ul class=""><li id="3acc" class="mu mv iq jp b jq ls ju lt jy mw kc mx kg my kk mz na nb nc bi translated"><a class="ae lx" href="https://github.com/grafana/grafana/blob/master/CHANGELOG.md#710-beta-1-2020-07-01" rel="noopener ugc nofollow" target="_blank">https://github . com/grafana/grafana/blob/master/changelog . MD # 710-beta-1-2020-07-01</a></li></ul><h1 id="3845" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">#4存储在OpenTSDB数据源中的XSS(CVE-2020–13430)</h1><p id="61b8" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">我通过手动代码审查发现了这个漏洞，由于利用的先决条件(如下所述)，它更难被利用。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="gh gi ni"><img src="../Images/dc3155ad9b18ace05e43d208820e7d85.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fWwqtgUk9ApuW5KtQNPyKQ.png"/></div></div></figure><h2 id="e1d1" class="mh kv iq bd kw mi mj dn la mk ml dp le jy mm mn li kc mo mp lm kg mq mr lq ms bi translated">先决条件</h2><pre class="kn ko kp kq gt nj ng nk nl aw nm bi"><span id="76e3" class="mh kv iq ng b gy nn no l np nq">1. The attacker must be able to push a new tag value to the OpenTSDB data source, e.g.</span><span id="ab4a" class="mh kv iq ng b gy nr no l np nq">curl -X POST <a class="ae lx" href="http://localhost:4242/api/put" rel="noopener ugc nofollow" target="_blank">http://localhost:4242/api/put</a> -d '{"metric":"rotem.cpu.xss","timestamp":1346846400,"value":11,"tags":{"host":"web","dc":"lga<strong class="ng ir">&lt;img src onerror=confirm()&gt;</strong>"}}'</span><span id="3336" class="mh kv iq ng b gy nr no l np nq">2. The OpenTSDB data source must allow special characters for our exploit to work:</span><span id="959b" class="mh kv iq ng b gy nr no l np nq">tsd.core.tag.allow_specialchars = !@#$%^&amp;*()_+{}|: &lt;&gt;?~`-=[]\;',./°</span></pre><h2 id="1cb0" class="mh kv iq bd kw mi mj dn la mk ml dp le jy mm mn li kc mo mp lm kg mq mr lq ms bi translated">影响</h2><p id="0f68" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">通过利用此漏洞，满足上述先决条件的攻击者可以在受害者的浏览器上执行任何JavaScript代码，方法是操纵这些代码执行以下操作:</p><ol class=""><li id="8425" class="mu mv iq jp b jq jr ju jv jy ns kc nt kg nu kk nv na nb nc bi translated">转到现有或新的仪表板并添加新面板</li><li id="c025" class="mu mv iq jp b jq nw ju nx jy ny kc nz kg oa kk nv na nb nc bi translated">在查询的数据源中选择他们的OpenTSDB数据源</li><li id="9ca2" class="mu mv iq jp b jq nw ju nx jy ny kc nz kg oa kk nv na nb nc bi translated">通过单击+号添加新标签</li><li id="05d7" class="mu mv iq jp b jq nw ju nx jy ny kc nz kg oa kk nv na nb nc bi translated">单击值字段，来自OpenTSDB标记值的XSS负载将被触发</li></ol><h2 id="2ec1" class="mh kv iq bd kw mi mj dn la mk ml dp le jy mm mn li kc mo mp lm kg mq mr lq ms bi translated">参考</h2><ul class=""><li id="97c4" class="mu mv iq jp b jq ls ju lt jy mw kc mx kg my kk mz na nb nc bi translated">https://github.com/grafana/grafana/pull/24539<a class="ae lx" href="https://github.com/grafana/grafana/pull/24539" rel="noopener ugc nofollow" target="_blank"/></li></ul></div><div class="ab cl ob oc hu od" role="separator"><span class="oe bw bk of og oh"/><span class="oe bw bk of og oh"/><span class="oe bw bk of og"/></div><div class="ij ik il im in"><h1 id="8230" class="ku kv iq bd kw kx oi kz la lb oj ld le lf ok lh li lj ol ll lm ln om lp lq lr bi translated">现实生活中的剥削</h1><p id="3ac5" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">您可能会问自己，我是如何向列兵BBP报告这些漏洞的，严重性如何。</p><p id="eaf4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我报告了以上所有内容(除了OpenTSDB，它与本程序无关)，并因<strong class="jp ir">的3次批评</strong>而获得奖励。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi on"><img src="../Images/3d90c5161ec0a6a8554fc0a70b65a086.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/0*9erArzs5fQ86P49q.gif"/></div></figure><p id="8a6e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">是的…我没骗你。</p><p id="8e51" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最初，三人组声称这是一个“自我XSS”，因为(据称)我只能影响我自己组织的用户，但这完全是一个错误的假设。<br/>我向他们解释说，Grafana能够与其他用户共享仪表盘，这意味着如果我与另一个登录了他们帐户的用户共享我的恶意Grafana仪表盘，我将能够窃取他们的cookies并劫持他们的帐户。</p><p id="eb8b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好吧…但是关键？</p><p id="b6c5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后我做了下一件事——因为他们在网站上有一个支持聊天，我请求他们允许我为我的恶意仪表板“请求支持”并攻击他们的支持工程师，他们同意了。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi oo"><img src="../Images/03886161384a829658873bd69edc79ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:616/0*oG3eebcBtwGT6YNL.gif"/></div></figure><p id="5332" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第一次尝试时，他们的支持工程师进入了我的恶意仪表板，但出于某种原因，我没有收到他们的会话cookie。在第二次尝试时，我得到了全部。我现在能够以管理员身份登录到他们的生产帐户，管理他们的管理员，查看敏感日志(包括用户令牌)，这足以被认为是非常重要的。</p></div><div class="ab cl ob oc hu od" role="separator"><span class="oe bw bk of og oh"/><span class="oe bw bk of og oh"/><span class="oe bw bk of og"/></div><div class="ij ik il im in"><p id="b438" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是我在格拉夫纳打猎的最佳决定之一。我在那里的短暂旅程既有收获又有乐趣(我非常享受，甚至贡献了其中的两个补丁😂).<br/>我希望在格拉夫纳深化我的研究，将来在那里发现一些更奇特的虫子，但从那以后就没时间做了。</p><p id="b4e8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你喜欢读它，鼓掌。如果你想要更多，<a class="ae lx" href="https://twitter.com/2RS3C" rel="noopener ugc nofollow" target="_blank">在推特上关注我(2RS3C) </a> :D</p></div></div>    
</body>
</html>