<html>
<head>
<title>Server Side Request Forgery — SSRF</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">服务器端请求伪造— SSRF</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/server-side-request-forgery-ssrf-f62235a2c151?source=collection_archive---------0-----------------------#2020-07-27">https://infosecwriteups.com/server-side-request-forgery-ssrf-f62235a2c151?source=collection_archive---------0-----------------------#2020-07-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="5b17" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi kl translated">服务器端请求伪造是web漏洞之一，它允许攻击者使用后端服务器向内部系统发出非预期的请求。通过这种方式，攻击者可以访问被防火墙阻止的内部系统，如果应用程序使用AWS之类的云平台，那么易受攻击的应用程序可能会导致攻击者访问元数据实例，其中包含大量有趣的信息，如IAM角色的安全密钥等。</p><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gh gi ku"><img src="../Images/58b9329770e665b669b3fa88709eca99.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fKNsVcKGKjA_usUOs3_ujw.png"/></div></div><figcaption class="lg lh gj gh gi li lj bd b be z dk translated">SSRF的工作</figcaption></figure><p id="b38e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上图是SSRF工作方式的一个例子。图像中显示的场景包含两台服务器</p><ol class=""><li id="650a" class="lk ll iq jp b jq jr ju jv jy lm kc ln kg lo kk lp lq lr ls bi translated">网络服务器</li><li id="0f87" class="lk ll iq jp b jq lt ju lu jy lv kc lw kg lx kk lp lq lr ls bi translated">受害服务器(受防火墙保护的内部服务器)</li></ol><p id="c304" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们为每台服务器分配Ip地址</p><ol class=""><li id="5cdf" class="lk ll iq jp b jq jr ju jv jy lm kc ln kg lo kk lp lq lr ls bi translated">Web服务器— 192.168.0.3</li><li id="233e" class="lk ll iq jp b jq lt ju lu jy lv kc lw kg lx kk lp lq lr ls bi translated">受害者服务器— 192.168.0.4</li><li id="8da7" class="lk ll iq jp b jq lt ju lu jy lv kc lw kg lx kk lp lq lr ls bi translated">攻击者——222.234.123.1</li></ol><p id="6237" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该系统被设计成网络服务器可以被网络内外的任何IP地址访问。而受害者服务器有防火墙，只允许来自邮件服务器的连接，所以如果攻击者试图直接访问受害者服务器，他/她将被防火墙阻止。</p><p id="1460" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，攻击者必须想办法绕过限制，访问受害者服务器。假设上面提到的网络服务器就像一个在线图片画廊，用户可以上传他们的图片并保存在云中。</p><p id="de52" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">图像可以通过两种方式上传</p><ol class=""><li id="6929" class="lk ll iq jp b jq jr ju jv jy lm kc ln kg lo kk lp lq lr ls bi translated">从他们的设备上传。</li><li id="e373" class="lk ll iq jp b jq lt ju lu jy lv kc lw kg lx kk lp lq lr ls bi translated">存放图像的URL。</li></ol><blockquote class="ly"><p id="44ca" class="lz ma iq bd mb mc md me mf mg mh kk dk translated"><em class="mi">通过URL上传图像意味着网络服务器必须向用户给定的URL发出GET请求，获取图像，然后存储在云中。因此，获取图像的GET请求代表后端web服务器(192.168.0.3)。</em></p></blockquote><p id="46cd" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">如果用户输入的URL没有经过适当的清理，web服务器提供的这个小功能就可能被利用。那么，如果攻击者不是给出实际的图像URL，而是输入一个指向网络内部域(在这种情况下是受害者服务器)的URL，会怎么样呢？</p><p id="9ecb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，攻击者可以在图像URL字段中输入受害者服务器的IP地址-http://192.168.0.4，然后web服务器会向受害者服务器发出GET请求，受害者服务器的防火墙允许该请求，因为该请求是从<strong class="jp ir"> 192.168.0.3 </strong>而不是<strong class="jp ir">222.234.123.1</strong>(攻击者地址)发出的。这会导致攻击者访问内部服务器并绕过防火墙。</p><blockquote class="ly"><p id="15c0" class="lz ma iq bd mb mc mo mp mq mr ms kk dk translated">简而言之，攻击者使用邮件服务器作为代理，让受害服务器相信请求来自授权用户。</p></blockquote></div><div class="ab cl mt mu hu mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="ij ik il im in"><h2 id="abc6" class="na nb iq bd nc nd ne dn nf ng nh dp ni jy nj nk nl kc nm nn no kg np nq nr ns bi translated">我们还能对SSRF做些什么？</h2><p id="5ffb" class="pw-post-body-paragraph jn jo iq jp b jq nt js jt ju nu jw jx jy nv ka kb kc nw ke kf kg nx ki kj kk ij bi translated"><strong class="jp ir">端口枚举:- </strong>一旦发现漏洞，攻击者就可以根据为每个请求提供的响应，开始枚举各种内部服务和端口。这可以通过使用一个叫做<strong class="jp ir"> Burp Suite </strong>的工具来完成，攻击者创建一个所有可能的IP组合和端口号的单词列表，使用Burp Suite中的入侵者功能来枚举不同的端口。Burp允许我们查看它向受害者服务器发出的每个请求的请求和响应头，根据响应我们可以枚举内部系统。</p><p id="619e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">使用AWS -EC2元数据服务窃取AWS访问密钥:- </strong></p><p id="a72e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">易受SSRF攻击的应用程序托管在云虚拟机实例上，那么攻击者就有可能访问只能由机器本身访问的端点，即元数据端点。</p><p id="ec6b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">假设一个应用程序托管在AWS上，AWS的元数据端点是<a class="ae ny" href="http://169.254.169.254/" rel="noopener ugc nofollow" target="_blank"> http://169.254.169.254/ </a>，该端点包含该特定实例的元数据，如本文开头所述，这些元数据实例具有IAM角色的凭证。AWS的<strong class="jp ir"> IMDSv1 </strong>允许我们通过对下面提到的路径的简单get请求来访问IAM角色的凭证，</p><blockquote class="nz oa ob"><p id="6ea1" class="jn jo oc jp b jq jr js jt ju jv jw jx od jz ka kb oe kd ke kf of kh ki kj kk ij bi translated"><a class="ae ny" href="http://169.254.169.254/latest/meta-data/iam/security-credentials/s3access" rel="noopener ugc nofollow" target="_blank">http://169 . 254 . 169 . 254/latest/metadata/iam/security-credentials/S3 access</a></p></blockquote><p id="29a8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这将返回一个包含以下内容的响应:</p><blockquote class="ly"><p id="c556" class="lz ma iq bd mb mc mo mp mq mr ms kk dk translated">{ "Code" : "Success "，" last updated ":" 2020–04–26t 16:39:16Z "，" Type" : "AWS-HMAC "，" access keyid ":" asiaiosfodnn 7 example "，" SecretAccessKey ":" wJalrXUtnFEMI/k7m Deng/bPxRfiCYEXAMPLEKEY "，" Token":"token "，" Expiration ":" 2024–05–17t 15:09:54Z " }</p></blockquote><p id="28a0" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">现在，具备这方面知识的攻击者可以借助云上托管的web应用程序中的SSRF漏洞轻松获得特定IAM角色的访问密钥，然后他可以将密钥添加到<strong class="jp ir"> ~/。aws/credentials </strong>然后访问该特定帐户的数据。</p></div><div class="ab cl mt mu hu mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="ij ik il im in"><p id="a907" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">结论</strong></p><p id="ee3c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">服务器端请求伪造、漏洞可能对现代web应用程序构成巨大威胁，因为它可能危及数据的机密性。SSRF可以通过适当的URL或其他用户输入净化来缓解。开发人员可以创建一个黑名单，限制任何匹配黑名单的用户输入，还可以执行边界检查。</p></div><div class="ab cl mt mu hu mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="ij ik il im in"><p id="3ce0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">更多了解SSRF的资源</strong></p><ol class=""><li id="b65f" class="lk ll iq jp b jq jr ju jv jy lm kc ln kg lo kk lp lq lr ls bi translated"><a class="ae ny" href="https://portswigger.net/web-security/ssrf" rel="noopener ugc nofollow" target="_blank">与SSRF一起动手</a></li><li id="5269" class="lk ll iq jp b jq lt ju lu jy lv kc lw kg lx kk lp lq lr ls bi translated"><a class="ae ny" href="https://www.youtube.com/watch?v=2MslLrPinm0" rel="noopener ugc nofollow" target="_blank">为SSRF开发URL解析器</a></li><li id="c1a7" class="lk ll iq jp b jq lt ju lu jy lv kc lw kg lx kk lp lq lr ls bi translated"><a class="ae ny" href="https://www.youtube.com/watch?v=t5fB6OZsR6c" rel="noopener ugc nofollow" target="_blank">请求WeasyPrint中的伪造(SSRF)以获得Bug赏金&amp; HackerOne的5000万美元CTF </a></li><li id="353f" class="lk ll iq jp b jq lt ju lu jy lv kc lw kg lx kk lp lq lr ls bi translated"><a class="ae ny" href="https://krebsonsecurity.com/2019/08/what-we-can-learn-from-the-capital-one-hack/" rel="noopener ugc nofollow" target="_blank">首都一号口</a></li></ol></div></div>    
</body>
</html>