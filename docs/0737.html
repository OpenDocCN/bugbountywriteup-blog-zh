<html>
<head>
<title>CSRF PoC mistake that broke crucial functions for the end user/victim</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">CSRF PoC错误破坏了最终用户/受害者的重要功能</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/csrf-poc-mistake-that-broke-crucial-functions-for-the-end-user-victim-ef4fa4584ca8?source=collection_archive---------1-----------------------#2020-08-05">https://infosecwriteups.com/csrf-poc-mistake-that-broke-crucial-functions-for-the-end-user-victim-ef4fa4584ca8?source=collection_archive---------1-----------------------#2020-08-05</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="4e14" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您听说过业务逻辑错误。滥用网站功能背后的逻辑，以获得你不应该获得的折扣或类似的东西，即<a class="ae ko" href="https://hackerone.com/reports/336131" rel="noopener ugc nofollow" target="_blank">https://hackerone.com/reports/336131</a>和类似的东西，这种想法并不新鲜。然后，还有其他我过去没有看到的逻辑错误。可能是我没有看我应该看的地方。</p><p id="be3a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在我看来，这是一个非常奇怪的逻辑错误。这是一种全新的扰乱底层逻辑的方式，这取决于网站是如何编码的。在这种情况下，它“只”破坏了最终用户/受害者的一些网站功能，并且可以通过csrf触发。实际上，我是在编写csrf PoC代码时偶然发现的。</p><p id="bf59" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> CSRF发现:</strong></p><p id="2dd9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">对csrf最简单的测试是:跟踪burp的请求头，查看是否没有x-csrf或其他自定义头(如果有，删除它们，并验证请求是否仍能正常通过)，没有来源限制，没有引用限制，等等。最后，请求主体被验证为没有csrf令牌或者csrf令牌没有被正确验证。接下来是有趣的部分。</p><p id="caf9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> CSRF PoC，还有一个错误:</strong></p><p id="02ce" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">已经通过报头和参数验证了csrf没有限制/保护，我继续准备PoC。这是一个简单的html表单，但是它有一个有趣的逻辑。我将尽我所能解释它，考虑到我不能太详细，因为它是私有的bbp，而且最重要的是，param名称可能很容易就能看出我在讨论哪个bbp。</p><p id="f83b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">假设你是一个用户，你可以限制你每月可以发送多少个付费电子邮件，在那里你可以附加一个文件。这意味着，如果达到了限制，你只能发送不带附件的免费电子邮件(相信我，这只是一个最简单的例子，我可以将实际功能转化为真实的东西，真实的东西要有趣得多，但它的细节会很容易地揭示问题中的bbp)。</p><p id="1f54" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">你可以将这个限制设置为可选限制，也就是说，如果你需要的话，你可以在月底之前改变它。或者，您可以将它设置为MandatoryLimit，这意味着必须遵守它，直到该月到期，在该月到期之前，您不能覆盖该限制。</p><p id="07f5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">OptionalLimit的html表单代码如下所示:</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="gh gi kp"><img src="../Images/d5cf08c689e39070a151761c0ef0b14d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1326/format:webp/1*Z3Fs9nks4HuqS9MSKa_MQA.png"/></div></figure><p id="547c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">MandatoryLimit的代码是:</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="gh gi kx"><img src="../Images/5fb066d93553b51610e115677c8ca4dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1366/format:webp/1*yFZ-64cLb2qCrw_FDyKSuw.png"/></div></figure><p id="48cd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">注意两幅图像中突出显示的行(分别是第4行和第5行)。</p><p id="aa25" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> CSRF PoC犯了一个小错误:</strong></p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi ky"><img src="../Images/aa66849cb596ee3c20585fabaedf6d41.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GqJJ5abII_b9guPpAdPhzA.png"/></div></div></figure><p id="e682" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">你能发现这个错误吗？</p><p id="4c09" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">以防万一，这是第4行或第5行:类型的值应该对应于名称OptionalLimit，这意味着在这种情况下，它应该是具有值Optional的类型，或者名称OptionalLimit应该是MandatoryLimit。</p><p id="0192" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">影响:因为值设置为0，这意味着用户/受害者只能发送免费电子邮件，直到该月结束，假设表单设计在下个月初重置。</p><p id="4708" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">影响的严重性进一步增加，因为用户/受害者无法通过网站表单重新调整任何与消息限制相关的内容，因为下拉框不显示任何选项，只有空白字段。因此，解决它的唯一方法是最终用户/受害者使用打嗝中继器或类似设备，并手动输入参数和值，以便将一切恢复正常。</p></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><p id="3abc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">注意html表单中的一切。这可能是有益的。除了显而易见的东西之外，参数名和值都可能有其底层逻辑背后的线索，以及参数名和值是如何相互关联的。我鼓励大家以后在寻找bug的时候注意这种类型的怪异行为。</p></div></div>    
</body>
</html>