<html>
<head>
<title>Web Application Security Misconfiguration — That Will Cost You</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Web应用程序安全错误配置——这会让您付出代价</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/web-application-security-misconfiguration-that-will-cost-you-6cc69d22d2?source=collection_archive---------1-----------------------#2018-03-31">https://infosecwriteups.com/web-application-security-misconfiguration-that-will-cost-you-6cc69d22d2?source=collection_archive---------1-----------------------#2018-03-31</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="47f7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">闭上你的🚪—对攻击者和黑客有70%的防御能力</p><h1 id="66aa" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">描述</h1><p id="9273" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">尽管您的专家团队已经尽了最大努力来减少您系统中的所有错误。作为一名独立的研究人员，跨所有平台研究它，并帮助组织使它对您的客户更加安全。在研究过程中，我发现几乎所有的网络应用都存在漏洞，有时我自己也会报告这一点，但我是一个人，一天的时间不会超过24小时(但我真的想要更多时间:-)。我写这篇文章是希望每当我在你的网站上创建一个新账户时，我的个人数据不会被轻易窃取。</p><h1 id="4d75" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">问题</h1><blockquote class="lo lp lq"><p id="329c" class="jn jo lr jp b jq jr js jt ju jv jw jx ls jz ka kb lt kd ke kf lu kh ki kj kk ij bi translated"><strong class="jp ir"> CORS(跨起点资源共享)报头错误配置<br/>访问控制允许起点→* </strong></p></blockquote><p id="60bc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">哦，你需要我解释这个沉重的(CORS)词，<br/> <strong class="jp ir">起源:</strong>它是某人或你在网络上的身份，用于web应用服务器。(<a class="ae lv" href="http://www.yoursite.com" rel="noopener ugc nofollow" target="_blank">www.yoursite.com</a>，<a class="ae lv" href="http://www.someonesite.com" rel="noopener ugc nofollow" target="_blank">www.someonesite.com</a>)<br/><strong class="jp ir">资源:</strong>资产，从你的服务器(你存储所有文件的地方——代码{ HTML，CSS，JS文件})返回给浏览器的每一个东西。<br/> <strong class="jp ir"> *: </strong>表示全部(<a class="ae lv" href="http://www.anybody.com" rel="noopener ugc nofollow" target="_blank">www.anybody.com</a>)</p><h1 id="ae4e" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">问题影响</h1><p id="aadb" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">如果您在服务器上配置您的web应用程序时将其标记为*，则任何人都可以从任何地方访问您的资源。而且，一旦他们可以与你的后端系统互动，他们很容易拦截你的网络和XHR。</p><p id="e358" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为什么我需要这个？原因和目的..阿汉！我喜欢你的疑问和问题！<br/>因为www.dreamsite.com，数据是你做出决策和运行梦想项目的真正力量，因此，你需要它，因为数据相当于$$$。<br/>而且，我相信你知道通过你的平台公开泄露你的客户和供应商的数据会造成的不良影响，这种影响会在两分钟内损害你的声誉。</p><blockquote class="lo lp lq"><p id="5f00" class="jn jo lr jp b jq jr js jt ju jv jw jx ls jz ka kb lt kd ke kf lu kh ki kj kk ij bi translated">“建立声誉需要20年，毁掉它只需5分钟。如果你考虑到这一点，你会以不同的方式做事。”—沃伦·巴菲特</p></blockquote><h2 id="9c60" class="lw km iq bd kn lx ly dn kr lz ma dp kv jy mb mc kz kc md me ld kg mf mg lh mh bi translated">非常确信！让我们明白如何才能填补这一空白。</h2><h1 id="b18a" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">如何缓解？</h1><p id="7b51" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">1.如果资源包含敏感信息，则不应将“Access-Control-Allow-Origin”设置为*。<br/> 2。缓解很简单，只是一个适当的配置。将Access-Control-Allow-Origin标头配置为仅允许来自您信任的域的请求。例如:Access-Control-Allow-Origin:trusted _ domains . com<br/>3。确保在用于检查原始头值的服务器端验证中，与绝对值进行比较，而不是与正则表达式进行比较。<br/>举个例子:下面的代码做一个和正则表达式的比较:<br/>regex("^<a class="ae lv" href="https://mail.example.com$" rel="noopener ugc nofollow" target="_blank">https://mail . example . com $</a>"<br/>在上面的验证中，点(。)表示任何字符。因此，攻击者可以通过从以下域发出CORS请求来绕过它:<a class="ae lv" href="https://mailxexample.com" rel="noopener ugc nofollow" target="_blank">https://mailxexample.com</a><br/>修补后的代码将是:<br/>if($ _ SERVER[" HTTP _ ORIGIN "]= = "<a class="ae lv" href="https://mail.example.com" rel="noopener ugc nofollow" target="_blank">https://mail.example.com</a>"<br/>{<br/>header(" Access-Control-Allow-ORIGIN:<a class="ae lv" href="https://mail.example.com" rel="noopener ugc nofollow" target="_blank">https://mail.example.com</a>")；<br/> }</p><p id="3ae2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="lr">客户端不应信任未经净化的接收内容，因为这将导致客户端代码执行。例如:如果网站abc.com信任并从example.com获取跨域数据。example.com怀有恶意，开始向abc.com发送恶意javascript，然后abc.com可以通过净化接收到的数据并将其呈现给用户来保护其用户免受跨站脚本攻击。</em></p><p id="fb45" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">示例实现:过滤器类(Java代码)</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="05de" class="lw km iq mn b gy mr ms l mt mu"><br/>import java.io.IOException;<br/>import java.util.ArrayList;<br/>import java.util.Collections;<br/>import java.util.Enumeration;<br/>import java.util.List;</span><span id="4e01" class="lw km iq mn b gy mv ms l mt mu">import javax.servlet.Filter;<br/>import javax.servlet.FilterChain;<br/>import javax.servlet.FilterConfig;<br/>import javax.servlet.ServletException;<br/>import javax.servlet.ServletRequest;<br/>import javax.servlet.ServletResponse;<br/>import javax.servlet.annotation.WebFilter;<br/>import javax.servlet.http.HttpServletRequest;<br/>import javax.servlet.http.HttpServletResponse;</span><span id="07fe" class="lw km iq mn b gy mv ms l mt mu">import net.sf.ehcache.Cache;<br/>import net.sf.ehcache.CacheManager;<br/>import net.sf.ehcache.Element;<br/>import net.sf.ehcache.config.CacheConfiguration;<br/>import net.sf.ehcache.config.PersistenceConfiguration;<br/>import net.sf.ehcache.store.MemoryStoreEvictionPolicy;</span><span id="b054" class="lw km iq mn b gy mv ms l mt mu">/**<br/> * Sample filter implementation to scrutiny CORS “Origin” HTTP header.&lt;br/&gt;<br/> * <br/> * This implementation has a dependency on EHCache API because&lt;br/&gt;<br/> * it use Caching for blacklisted client IP in order to enhance performance.<br/> * <br/> * Assume here that all CORS resources are grouped in context path “/cors/”.<br/> * <br/> */<br/><a class="ae lv" href="http://twitter.com/WebFilter" rel="noopener ugc nofollow" target="_blank">@WebFilter</a>(“/cors/*”)<br/>public class CORSOriginHeaderScrutiny implements Filter {</span><span id="0bc5" class="lw km iq mn b gy mv ms l mt mu">/** Filter configuration */<br/> <a class="ae lv" href="http://twitter.com/SuppressWarnings" rel="noopener ugc nofollow" target="_blank">@SuppressWarnings</a>(“unused”)<br/> private FilterConfig filterConfig = null;</span><span id="5023" class="lw km iq mn b gy mv ms l mt mu">/** Cache used to cache blacklisted Clients (request sender) IP address */<br/> private Cache blackListedClientIPCache = null;</span><span id="5d5a" class="lw km iq mn b gy mv ms l mt mu">/** Domains allowed to access to resources (white list) */<br/> private List&lt;String&gt; allowedDomains = new ArrayList&lt;String&gt;();</span><span id="c2a1" class="lw km iq mn b gy mv ms l mt mu">/**<br/> * {<a class="ae lv" href="http://twitter.com/inheritDoc" rel="noopener ugc nofollow" target="_blank">@inheritDoc</a>}<br/> * <br/> * <a class="ae lv" href="http://twitter.com/see" rel="noopener ugc nofollow" target="_blank">@see</a> Filter#init(FilterConfig)<br/> */<br/> <a class="ae lv" href="http://twitter.com/Override" rel="noopener ugc nofollow" target="_blank">@Override</a><br/> public void init(FilterConfig fConfig) throws ServletException {<br/> // Get filter configuration<br/> this.filterConfig = fConfig;<br/> // Initialize Client IP address dedicated cache with a cache of 60 minutes expiration delay for each item<br/> PersistenceConfiguration cachePersistence = new PersistenceConfiguration();<br/> cachePersistence.strategy(PersistenceConfiguration.Strategy.NONE);<br/> CacheConfiguration cacheConfig = new CacheConfiguration().memoryStoreEvictionPolicy(MemoryStoreEvictionPolicy.FIFO)<br/> .eternal(false)<br/> .timeToLiveSeconds(3600)<br/> .diskExpiryThreadIntervalSeconds(450)<br/> .persistence(cachePersistence)<br/> .maxEntriesLocalHeap(10000)<br/> .logging(false);<br/> cacheConfig.setName(“BlackListedClientsCacheConfig”);<br/> this.blackListedClientIPCache = new Cache(cacheConfig);<br/> this.blackListedClientIPCache.setName(“BlackListedClientsCache”);<br/> CacheManager.getInstance().addCache(this.blackListedClientIPCache);<br/> // Load domains allowed white list (hard coded here only for example)<br/> this.allowedDomains.add(“<a class="ae lv" href="http://www.html5rocks.com" rel="noopener ugc nofollow" target="_blank">http://www.html5rocks.com</a>”);<br/> this.allowedDomains.add(“<a class="ae lv" href="https://www.mydomains.com" rel="noopener ugc nofollow" target="_blank">https://www.mydomains.com</a>”);<br/> }</span><span id="1aff" class="lw km iq mn b gy mv ms l mt mu">/**<br/> * {<a class="ae lv" href="http://twitter.com/inheritDoc" rel="noopener ugc nofollow" target="_blank">@inheritDoc</a>}<br/> * <br/> * <a class="ae lv" href="http://twitter.com/see" rel="noopener ugc nofollow" target="_blank">@see</a> Filter#destroy()<br/> */<br/> <a class="ae lv" href="http://twitter.com/Override" rel="noopener ugc nofollow" target="_blank">@Override</a><br/> public void destroy() {<br/> // Remove Cache<br/> CacheManager.getInstance().removeCache(“BlackListedClientsCache”);<br/> }</span><span id="0f0b" class="lw km iq mn b gy mv ms l mt mu">/**<br/> * {<a class="ae lv" href="http://twitter.com/inheritDoc" rel="noopener ugc nofollow" target="_blank">@inheritDoc</a>}<br/> * <br/> * <a class="ae lv" href="http://twitter.com/see" rel="noopener ugc nofollow" target="_blank">@see</a> Filter#doFilter(ServletRequest, ServletResponse, FilterChain)<br/> */<br/> <a class="ae lv" href="http://twitter.com/Override" rel="noopener ugc nofollow" target="_blank">@Override</a><br/> public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) <br/> throws IOException, ServletException {<br/> HttpServletRequest httpRequest = ((HttpServletRequest) request);<br/> HttpServletResponse httpResponse = ((HttpServletResponse) response);<br/> List&lt;String&gt; headers = null;<br/> boolean isValid = false;<br/> String origin = null;<br/> String clientIP = httpRequest.getRemoteAddr();</span><span id="924c" class="lw km iq mn b gy mv ms l mt mu">/* Step 0 : Check presence of client IP in black list */<br/> if (this.blackListedClientIPCache.isKeyInCache(clientIP)) {<br/> // Return HTTP Error without any information about cause of the request reject !<br/> httpResponse.sendError(HttpServletResponse.SC_FORBIDDEN);<br/> // Add trace here<br/> // ….<br/> // Quick Exit<br/> return;<br/> }</span><span id="5dea" class="lw km iq mn b gy mv ms l mt mu">/* Step 1 : Check that we have only one and non empty instance of the “Origin” header */<br/> headers = CORSOriginHeaderScrutiny.enumAsList(httpRequest.getHeaders(“Origin”));<br/> if ((headers == null) || (headers.size() != 1)) {<br/> // If we reach this point it means that we have multiple instance of the “Origin” header<br/> // Add client IP address to black listed client<br/> addClientToBlacklist(clientIP);<br/> // Return HTTP Error without any information about cause of the request reject !<br/> httpResponse.sendError(HttpServletResponse.SC_FORBIDDEN);<br/> // Add trace here<br/> // ….<br/> // Quick Exit<br/> return;<br/> }<br/> origin = headers.get(0);</span><span id="854f" class="lw km iq mn b gy mv ms l mt mu">/* Step 2 : Check that we have only one and non empty instance of the “Host” header */<br/> headers = CORSOriginHeaderScrutiny.enumAsList(httpRequest.getHeaders(“Host”));<br/> if ((headers == null) || (headers.size() != 1)) {<br/> // If we reach this point it means that we have multiple instance of the “Host” header<br/> // Add client IP address to black listed client<br/> addClientToBlacklist(clientIP);<br/> // Return HTTP Error without any information about cause of the request reject !<br/> httpResponse.sendError(HttpServletResponse.SC_FORBIDDEN);<br/> // Add trace here<br/> // ….<br/> // Quick Exit<br/> return;<br/> }</span><span id="cb1a" class="lw km iq mn b gy mv ms l mt mu">/* Step 3 : Perform analysis — Origin header is required */<br/> if ((origin != null) &amp;&amp; !””.equals(origin.trim())) {<br/> if (this.allowedDomains.contains(origin)) {<br/> // Check if origin is in allowed domain<br/> isValid = true;<br/> } else {<br/> // Add client IP address to black listed client<br/> addClientToBlacklist(clientIP);<br/> isValid = false;<br/> // Add trace here<br/> // ….<br/> }<br/> }</span><span id="01eb" class="lw km iq mn b gy mv ms l mt mu">/* Step 4 : Finalize request next step */<br/> if (isValid) {<br/> // Analysis OK then pass the request along the filter chain<br/> chain.doFilter(request, response);<br/> } else {<br/> // Return HTTP Error without any information about cause of the request reject !<br/> httpResponse.sendError(HttpServletResponse.SC_FORBIDDEN);<br/> }<br/> }</span><span id="14d7" class="lw km iq mn b gy mv ms l mt mu">/**<br/> * Blacklist client<br/> * <br/> * <a class="ae lv" href="http://twitter.com/param" rel="noopener ugc nofollow" target="_blank">@param</a> clientIP Client IP address<br/> */<br/> private void addClientToBlacklist(String clientIP) {<br/> // Add client IP address to black listed client<br/> Element cacheElement = new Element(clientIP, clientIP);<br/> this.blackListedClientIPCache.put(cacheElement);<br/> }</span><span id="6109" class="lw km iq mn b gy mv ms l mt mu">/**<br/> * Convert a enumeration to a list<br/> * <br/> * <a class="ae lv" href="http://twitter.com/param" rel="noopener ugc nofollow" target="_blank">@param</a> tmpEnum Enumeration to convert<br/> * <a class="ae lv" href="http://twitter.com/return" rel="noopener ugc nofollow" target="_blank">@return</a> list of string or null is input enumeration is null<br/> */<br/> private static List&lt;String&gt; enumAsList(Enumeration&lt;String&gt; tmpEnum) {<br/> if (tmpEnum != null) {<br/> return Collections.list(tmpEnum);<br/> }<br/> return null;<br/> }<br/>}</span></pre><p id="7586" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">注意:如果你想CORS过滤器在不同的语言评论如下。</p><p id="a2fa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于Nginx上的CORS:<a class="ae lv" href="https://medium.com/@hariomvashisth/cors-on-nginx-be38dd0e19df" rel="noopener">https://medium . com/@ hariomvashith/CORS-on-Nginx-be 38 DD 0 e 19 df</a></p></div></div>    
</body>
</html>