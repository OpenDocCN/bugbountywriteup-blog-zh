<html>
<head>
<title>Write-up: Upload Vulnerabilities @ TryHackMe</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">报道:上传漏洞@ TryHackMe</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/write-up-upload-vulnerabilities-tryhackme-32bbaca5686c?source=collection_archive---------2-----------------------#2022-08-24">https://infosecwriteups.com/write-up-upload-vulnerabilities-tryhackme-32bbaca5686c?source=collection_archive---------2-----------------------#2022-08-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/28e523439eba63950d0c9d21399e2515.png" data-original-src="https://miro.medium.com/v2/resize:fit:1306/format:webp/0*BHV_Yqm9IiW50x-0.png"/></div></figure><p id="d7ba" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这篇关于房间<em class="ks">上传漏洞</em>的挑战任务的文章是我为<a class="ae kt" href="https://tryhackme.com" rel="noopener ugc nofollow" target="_blank"> TryHackMe </a>所做的走查系列的一部分。</p><div class="ku kv gp gr kw kx"><a href="https://tryhackme.com/room/uploadvulns" rel="noopener  ugc nofollow" target="_blank"><div class="ky ab fo"><div class="kz ab la cl cj lb"><h2 class="bd ir gy z fp lc fr fs ld fu fw ip bi translated">网络安全培训</h2><div class="le l"><h3 class="bd b gy z fp lc fr fs ld fu fw dk translated">TryHackMe是一个免费的学习网络安全的在线平台，使用动手练习和实验室，通过您的…</h3></div><div class="lf l"><p class="bd b dl z fp lc fr fs ld fu fw dk translated">tryhackme.com</p></div></div><div class="lg l"><div class="lh l li lj lk lg ll js kx"/></div></div></a></div><p id="c937" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">房型</strong>:仅限订阅<br/> <strong class="jw ir">难度</strong>:容易</p><h1 id="fd37" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">实验室描述</h1><figure class="ml mm mn mo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mk"><img src="../Images/f0d6ce82c6e5964375d23d44adfc4fd4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*jWDBj2CMHGfsc7UX.png"/></div></div></figure><h1 id="6a19" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">步伐</h1><p id="9ad8" class="pw-post-body-paragraph ju jv iq jw b jx mt jz ka kb mu kd ke kf mv kh ki kj mw kl km kn mx kp kq kr ij bi translated">该网络应用程序是一个图像的幻灯片集，它也允许上传自己的图像。</p><figure class="ml mm mn mo gt jr gh gi paragraph-image"><div class="gh gi my"><img src="../Images/f5e06ad7058076caa9ecd5be7913bfee.png" data-original-src="https://miro.medium.com/v2/resize:fit:826/format:webp/0*q3aEoKwcBSU8L1N-.png"/></div></figure></div><div class="ab cl mz na hu nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="ij ik il im in"><h1 id="3b80" class="lm ln iq bd lo lp ng lr ls lt nh lv lw lx ni lz ma mb nj md me mf nk mh mi mj bi translated">检测内容</h1><p id="fdbb" class="pw-post-body-paragraph ju jv iq jw b jx mt jz ka kb mu kd ke kf mv kh ki kj mw kl km kn mx kp kq kr ij bi translated">该页面本身并没有揭示任何太有趣的东西。我从模糊化开始，看看能否找到更多内容:</p><pre class="ml mm mn mo gt nl nm nn no aw np bi"><span id="0014" class="nq ln iq nm b gy nr ns l nt nu">ffuf -w /usr/share/wordlists/dirb/big.txt -u <a class="ae kt" href="http://jewel.uploadvulns.thm/FUZZ" rel="noopener ugc nofollow" target="_blank">http://jewel.uploadvulns.thm/FUZZ</a></span></pre><figure class="ml mm mn mo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi nv"><img src="../Images/93d9f2669daff027468b1ebbec775259.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*dmCo8wPQvz03Kwpp.png"/></div></div></figure><p id="2b89" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">果然，找到了更多的目录。快速浏览CSS可以看到旋转的背景图片来自于<code class="fe nw nx ny nm b">/content/</code>目录。<code class="fe nw nx ny nm b">/admin/</code>目录显示模块可以在这里激活的提示。</p><figure class="ml mm mn mo gt jr gh gi paragraph-image"><div class="gh gi nz"><img src="../Images/0f482b4b825ce463412db987de99134f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1286/format:webp/0*1hBj8bj1W6sckAJc.png"/></div></figure><p id="5f09" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">其他目录没有显示任何有趣的内容。</p></div><div class="ab cl mz na hu nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="ij ik il im in"><h1 id="8563" class="lm ln iq bd lo lp ng lr ls lt nh lv lw lx ni lz ma mb nj md me mf nk mh mi mj bi translated">检测使用的技术</h1><p id="36b2" class="pw-post-body-paragraph ju jv iq jw b jx mt jz ka kb mu kd ke kf mv kh ki kj mw kl km kn mx kp kq kr ij bi translated">我的下一步是找出页面使用了什么技术，看看它们可能引用什么类型的模块。为此，我用Wappalyzer检查了页面:</p><figure class="ml mm mn mo gt jr gh gi paragraph-image"><div class="gh gi oa"><img src="../Images/f26229a6737f732b3f1db6b2360f576f.png" data-original-src="https://miro.medium.com/v2/resize:fit:990/format:webp/0*TfAvZeiceqacufcD.png"/></div></figure><p id="3c41" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">它显示为运行在<code class="fe nw nx ny nm b">Express</code>框架上的<code class="fe nw nx ny nm b">node.js</code>应用程序。</p></div><div class="ab cl mz na hu nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="ij ik il im in"><h2 id="a838" class="nq ln iq bd lo ob oc dn ls od oe dp lw kf of og ma kj oh oi me kn oj ok mi ol bi translated">在子目录中查找内容</h2><p id="fc50" class="pw-post-body-paragraph ju jv iq jw b jx mt jz ka kb mu kd ke kf mv kh ki kj mw kl km kn mx kp kq kr ij bi translated">我检查子目录中找到的附加内容。单词列表中的命名模式与图片的命名模式相匹配，所以我也用这个列表检查了<code class="fe nw nx ny nm b">/content/</code>目录。</p><pre class="ml mm mn mo gt nl nm nn no aw np bi"><span id="dd65" class="nq ln iq nm b gy nr ns l nt nu">ffuf -w ./UploadVulnsWordlist.txt -u <a class="ae kt" href="http://jewel.uploadvulns.thm/content/FUZZ.jpg" rel="noopener ugc nofollow" target="_blank">http://jewel.uploadvulns.thm/content/FUZZ.jpg</a></span></pre><figure class="ml mm mn mo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi om"><img src="../Images/e6f742f92e66ed18ae30be2bccbe8a02.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*_ZxelRwNUNBfnWUL.png"/></div></div></figure><p id="ed5c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">果然，它找到了用作背景的四幅图像。其他的扫描都没有显示出来。</p></div><div class="ab cl mz na hu nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="ij ik il im in"><h1 id="f0a8" class="lm ln iq bd lo lp ng lr ls lt nh lv lw lx ni lz ma mb nj md me mf nk mh mi mj bi translated">获取反向外壳的脚本</h1><p id="fd76" class="pw-post-body-paragraph ju jv iq jw b jx mt jz ka kb mu kd ke kf mv kh ki kj mw kl km kn mx kp kq kr ij bi translated">我知道这个应用程序是一个Node.js应用程序，所以我从<a class="ae kt" href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md#nodejs" rel="noopener ugc nofollow" target="_blank"> PayloadsAllTheThings </a>中得到一个反向shell，并更改IP/port以匹配我的:</p><figure class="ml mm mn mo gt jr gh gi paragraph-image"><div class="gh gi on"><img src="../Images/ce64ae0de8e5421b6e6ee5e8deeaa2a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1062/format:webp/0*SspkTeA7impa3tkq.png"/></div></figure></div><div class="ab cl mz na hu nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="ij ik il im in"><h2 id="5e4e" class="nq ln iq bd lo ob oc dn ls od oe dp lw kf of og ma kj oh oi me kn oj ok mi ol bi translated">上传外壳</h2><p id="4a75" class="pw-post-body-paragraph ju jv iq jw b jx mt jz ka kb mu kd ke kf mv kh ki kj mw kl km kn mx kp kq kr ij bi translated">我试图上传脚本，但它被应用程序阻止。然而，它是由JavaScript触发的消息，所以我使用Burp history来检查加载的脚本文件。</p><p id="64c4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在<code class="fe nw nx ny nm b">/assets/js/upload.js</code>中，我找到了罪魁祸首，客户端验证码:</p><figure class="ml mm mn mo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi oo"><img src="../Images/61c35b98e3e40ef8eebc01ef4bccc056.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*qNSEku5U7K-h1W6l.png"/></div></div><figcaption class="op oq gj gh gi or os bd b be z dk translated">删除有问题的JavaScript</figcaption></figure><p id="7969" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">要拦截JavaScript文件，我需要更改代理选项来拦截JS文件，因为默认情况下Burp代理不会拦截它们:</p><figure class="ml mm mn mo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi ot"><img src="../Images/5ef2aebfba544cd13698c789c8bca52f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*OW6MIsiK3DLbcuQK.png"/></div></div></figure><p id="b4bf" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">移除了<code class="fe nw nx ny nm b">^.js$</code>条件后，我用Ctrl-F5重新加载页面，强制进行一次完全刷新。</p><p id="490d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">当<code class="fe nw nx ny nm b">upload.js</code>请求被拦截时，我指示Burp拦截它的响应(请求中的RMB并选择<code class="fe nw nx ny nm b">Do Intercept-&gt;Response to this request</code>)并删除上面标记的行。</p><p id="be49" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我尝试重新上传，但还是失败了，这次是通过服务器端的验证。</p><p id="f80b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在理想情况下，服务器应该执行客户机所做的所有验证。毕竟，客户端验证只是为了可用性。安全性只能通过服务器端验证来提供。</p><p id="db32" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">然而，我假设这个世界并不理想，服务器会执行其他验证。我将文件扩展名改为<code class="fe nw nx ny nm b">jpg</code>，并重试上传。这一次，它成功了。</p></div><div class="ab cl mz na hu nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="ij ik il im in"><h1 id="9b8e" class="lm ln iq bd lo lp ng lr ls lt nh lv lw lx ni lz ma mb nj md me mf nk mh mi mj bi translated">查找上传的外壳</h1><p id="b9bc" class="pw-post-body-paragraph ju jv iq jw b jx mt jz ka kb mu kd ke kf mv kh ki kj mw kl km kn mx kp kq kr ij bi translated">我刚刚上传的文件在任何目录中都找不到它的已知名称。我用提供的单词表重新运行了<code class="fe nw nx ny nm b">/contents/</code>目录的模糊化。</p><p id="5585" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这一次，我在那里找到了一个附加文件:</p><figure class="ml mm mn mo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi ou"><img src="../Images/b0879b4cc71470528f3008a1e3aaa92e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*y0Ly8QonL9AXAgC4.png"/></div></div></figure></div><div class="ab cl mz na hu nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="ij ik il im in"><h1 id="0be4" class="lm ln iq bd lo lp ng lr ls lt nh lv lw lx ni lz ma mb nj md me mf nk mh mi mj bi translated">得到一个反壳</h1><p id="d0bf" class="pw-post-body-paragraph ju jv iq jw b jx mt jz ka kb mu kd ke kf mv kh ki kj mw kl km kn mx kp kq kr ij bi translated">在<code class="fe nw nx ny nm b">/admin/</code>页面上，我可以激活<code class="fe nw nx ny nm b">/modules/</code>目录中的模块，服务器应该强制它不接受任何其他位置</p><p id="3981" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我刚刚上传的文件位于<code class="fe nw nx ny nm b">/content/</code>。但是可能没有适当的验证来防止路径遍历。</p><p id="ed31" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我在我的机器上用<code class="fe nw nx ny nm b">nc -nvlp 8888</code>启动一个监听器，并通过它的相对路径<code class="fe nw nx ny nm b">../content/WON.jpg</code>激活模块</p><p id="1f06" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我收到的shell显示应用程序以root用户身份运行。因此，不需要权限提升，我可以直接获得标志:</p><figure class="ml mm mn mo gt jr gh gi paragraph-image"><div class="gh gi ov"><img src="../Images/b7db1eabc7ab36a11d914e230a072b17.png" data-original-src="https://miro.medium.com/v2/resize:fit:1032/format:webp/0*hMKQvYBVoNBQrC99.png"/></div></figure></div><div class="ab cl mz na hu nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="ij ik il im in"><p id="e1fa" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="ks">最初发表于</em><a class="ae kt" href="https://github.com/frank-leitner/tryhackme/tree/main/Upload_Vulnerabilities" rel="noopener ugc nofollow" target="_blank"><em class="ks">https://github.com</em></a><em class="ks">。</em></p><p id="8338" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="ks">来自Infosec的报道:Infosec上每天都会出现很多难以跟上的内容。</em> <a class="ae kt" href="https://weekly.infosecwriteups.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="jw ir"> <em class="ks">加入我们的每周简讯</em> </strong> </a> <em class="ks">以5篇文章、4个线程、3个视频、2个Github Repos和工具以及1个工作提醒的形式免费获取所有最新的Infosec趋势！</em></p></div></div>    
</body>
</html>