<html>
<head>
<title>New Bug in Router NR1800X — Command injection via setUssd</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">路由器NR1800X中的新错误—通过setUssd的命令注入</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/router-nr1800x-command-injection-via-setussd-7291f60b3c95?source=collection_archive---------2-----------------------#2022-11-10">https://infosecwriteups.com/router-nr1800x-command-injection-via-setussd-7291f60b3c95?source=collection_archive---------2-----------------------#2022-11-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="f601" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">嗨，欢迎这篇文章的所有读者。</p><p id="5aac" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在一份<a class="ae kl" href="https://cve.mitre.org/" rel="noopener ugc nofollow" target="_blank"> Mitre </a>出版物中，出现了一个TOTOLink NR1800X路由器(CVE-2022–41525)版本V9.1.0u.6279_B20210910的漏洞，这引起了我的注意，所以我继续了解关于该漏洞的更多信息。</p><p id="dee4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">卖主—【https://www.totolink.net T2】</p><p id="afe5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对报告的漏洞做了一些总结，我继续做了一些测试，比如模拟固件，并在<a class="ae kl" href="https://ghidra-sre.org/" rel="noopener ugc nofollow" target="_blank"> Ghidra </a>中启动我的脚本，以识别其他潜在的危险功能(Rce / BoF)。</p><p id="d73b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">结果，我得到了一个很大的有希望的函数列表(strcpy / system / etc)。其中一个在图片中高亮显示(<strong class="jp ir"> 0x0041a68c </strong>)，指向包含漏洞的函数。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/4e66754b75048d10fc95ba363ed685d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iK3TPxk03HFgnodSX0Uvgw.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">功能列表</figcaption></figure><p id="898e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我已经使用了<a class="ae kl" href="https://ghidra-sre.org" rel="noopener ugc nofollow" target="_blank"> Ghidra </a>之后，我继续分析了<a class="ae kl" href="https://hex-rays.com/ida-pro/" rel="noopener ugc nofollow" target="_blank"> IDA </a>中的二进制文件<strong class="jp ir"> cstecgi.cgi </strong>。(多个工具的使用只是为了方便)。</p><p id="d28e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从函数的静态分析开始，我们可以很快看到漏洞，其中第26行格式化了<strong class="jp ir"> v17 </strong>缓冲区，然后由<strong class="jp ir"> system() </strong>函数作为参数发送。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi lc"><img src="../Images/f714f720fef0faf03a6f312e0c042817.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/1*XOToAuAbEFEbBuEA_MoOxw.png"/></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">在IDA中反转</figcaption></figure><p id="5805" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，为了更详细地了解，我们将看到参数如何传递到内存的整个过程，在系统模式下调试固件。</p><p id="5cca" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，我们在<strong class="jp ir"> websGetVar() </strong>函数中放置一个断点，该函数负责获取请求体中发送的值。在这种情况下，它验证发送的值是<strong class="jp ir"> ussd </strong>。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi ld"><img src="../Images/86c27540d379bfbae0f7b3d908ca175c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-u3ubaWRgZxch9kZ0Rh-fw.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">通过请求发送数据</figcaption></figure><p id="aa73" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后字符串用<strong class="jp ir"> snprintf() </strong>格式化，存储在缓冲区<strong class="jp ir"> 0x7fff5230 </strong>中。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi le"><img src="../Images/30847011f60948c6c6e99fff44ceb234.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WzaAgiWgPpLe1PGSOSyeQw.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">格式化字符串</figcaption></figure><p id="b8b9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里我们可以看到格式化后的字符串在缓冲区中的最终外观。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi lf"><img src="../Images/2e270b33f718b8433eec8dd01081e2e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kofaLiOYxupsdG6704Hq_A.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">用数据缓冲</figcaption></figure><p id="ee15" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，使用堆栈参数调用<strong class="jp ir"> system() </strong>函数。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi lg"><img src="../Images/8ca13c0f5b571c9a745a65878f73954d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a9BSKG8Xyi35kGEmbPM0fA.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">呼叫系统()</figcaption></figure><p id="b439" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了使命令的执行成为可能，需要识别激活动作的名称<strong class="jp ir"> setUssd </strong>，这样我们就可以在路由器中重新创建一个有效负载来启动<strong class="jp ir"> telnetd </strong>服务。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi lh"><img src="../Images/5126f5d30100878380433e9f87f31b34.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1OeUWePbke6pVNeaqZXBXw.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">请求概念证明</figcaption></figure><p id="2c38" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，通过连接两个漏洞来开发漏洞。第一个是绕过身份验证的请求，该请求将会话发送给利用代码执行的第二个请求。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi li"><img src="../Images/3b0949a86f97a0b201d83a9f2062c5da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1226/format:webp/1*1LeQtk7Z1SAA-4XPqNZ1OA.png"/></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">剥削</figcaption></figure><h2 id="5040" class="lj lk iq bd ll lm ln dn lo lp lq dp lr jy ls lt lu kc lv lw lx kg ly lz ma mb bi translated">Poc视频</h2><p id="91a5" class="pw-post-body-paragraph jn jo iq jp b jq mc js jt ju md jw jx jy me ka kb kc mf ke kf kg mg ki kj kk ij bi translated"><a class="ae kl" href="https://www.youtube.com/watch?v=Mcutnejlepk" rel="noopener ugc nofollow" target="_blank">https://www.youtube.com/watch?v=Mcutnejlepk</a></p><h2 id="d6d4" class="lj lk iq bd ll lm ln dn lo lp lq dp lr jy ls lt lu kc lv lw lx kg ly lz ma mb bi translated">结论</h2><p id="cd2a" class="pw-post-body-paragraph jn jo iq jp b jq mc js jt ju md jw jx jy me ka kb kc mf ke kf kg mg ki kj kk ij bi translated">在已经分析过的系统中总能发现新的(0天)漏洞。</p><h2 id="ad92" class="lj lk iq bd ll lm ln dn lo lp lq dp lr jy ls lt lu kc lv lw lx kg ly lz ma mb bi translated">博客</h2><div class="mh mi gp gr mj mk"><a href="https://s1kr10s.github.io/" rel="noopener  ugc nofollow" target="_blank"><div class="ml ab fo"><div class="mm ab mn cl cj mo"><h2 class="bd ir gy z fp mp fr fs mq fu fw ip bi translated">米格尔M.Z - @s1kr10s</h2><div class="mr l"><h3 class="bd b gy z fp mp fr fs mq fu fw dk translated">编辑描述</h3></div><div class="ms l"><p class="bd b dl z fp mp fr fs mq fu fw dk translated">s1kr10s.github.io</p></div></div></div></a></div></div><div class="ab cl mt mu hu mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="ij ik il im in"><h2 id="9e16" class="lj lk iq bd ll lm ln dn lo lp lq dp lr jy ls lt lu kc lv lw lx kg ly lz ma mb bi translated">来自Infosec的报道:Infosec每天都有很多内容，很难跟上。<a class="ae kl" href="https://weekly.infosecwriteups.com/" rel="noopener ugc nofollow" target="_blank">加入我们的每周简讯</a>以5篇文章、4个线程、3个视频、2个GitHub Repos和工具以及1个工作提醒的形式免费获取所有最新的Infosec趋势！</h2></div></div>    
</body>
</html>