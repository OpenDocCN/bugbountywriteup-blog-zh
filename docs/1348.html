<html>
<head>
<title>Automating Burp Suite -4 | Understanding And Customising Custom Header From Response Via Burp Macro — Writing Own Burp Extension</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">自动化Burp Suite -4 |通过Burp宏从响应中了解和定制自定义标题—编写自己的Burp扩展</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/automating-burp-suite-4-understanding-and-customising-custom-header-from-response-via-burp-macro-214332dda012?source=collection_archive---------0-----------------------#2021-05-31">https://infosecwriteups.com/automating-burp-suite-4-understanding-and-customising-custom-header-from-response-via-burp-macro-214332dda012?source=collection_archive---------0-----------------------#2021-05-31</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><blockquote class="jn jo jp"><p id="7aa7" class="jq jr js jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ij bi translated">这是第4篇教程，我使用<strong class="jt ir"> jython </strong>开发了一个Burp扩展，并使用<strong class="jt ir"> Burp Suite宏在从<strong class="jt ir">响应体/响应</strong>头派生的</strong>请求头中的<strong class="jt ir">自定义头上实现了添加。</strong></p></blockquote><p id="7d4f" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">可以直接调用这个自定义标头扩展，它可以用于自动化请求标头中的CSRF令牌或JWT令牌。有多个自定义扩展实现了JWT或授权令牌，但这个扩展可以根据需要进行自定义。此外，这篇博客将指导你如何使用Jython在Burp Suite中编写扩展。这可用于从响应中获取动态值。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi ks"><img src="../Images/5706fd1ecbd7af386c1618e6c2a5c22e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mbwOCCSH7GRx1shKvHwtmA.png"/></div></div><figcaption class="le lf gj gh gi lg lh bd b be z dk translated"><a class="ae li" href="https://www.yeahhub.com/wp-content/uploads/2018/04/burp-suite-disable-detect-portal.png" rel="noopener ugc nofollow" target="_blank">参考</a></figcaption></figure><h1 id="2ab8" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">第2部分—创建通过扩展更新标题的宏</h1><h2 id="4b7f" class="mh lk iq bd ll mi mj dn lp mk ml dp lt kp mm mn lx kq mo mp mb kr mq mr mf ms bi translated">假设:</h2><p id="9d76" class="pw-post-body-paragraph jq jr iq jt b ju mt jw jx jy mu ka kb kp mv ke kf kq mw ki kj kr mx km kn ko ij bi translated">a)要添加到请求主体中的X-CSRF令牌。<br/> b) CSRF令牌来源于响应体。<br/> c)宏的基础知识。根据需要使用自定义正则表达式修改扩展。<br/> e)自定义头已经存在于所有的请求中。自定义打嗝扩展被加载。</p><h2 id="472a" class="mh lk iq bd ll mi mj dn lp mk ml dp lt kp mm mn lx kq mo mp mb kr mq mr mf ms bi translated">创建宏和运行扩展的通用步骤:</h2><ol class=""><li id="15a9" class="my mz iq jt b ju mt jy mu kp na kq nb kr nc ko nd ne nf ng bi translated">在<a class="ae li" href="http://localhost/login.php" rel="noopener ugc nofollow" target="_blank">http://localhost/log in . PHP</a>上运行dvwa</li></ol><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi nh"><img src="../Images/5e542e81ebb0e2b46de676e3734ec704.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MUrLvCgBxJRuvtIgQw57PA.png"/></div></div></figure><p id="7b7b" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">2.因为这是<strong class="jt ir"> DVWA </strong>，所以没有自定义标题。<br/>我们将把<code class="fe ni nj nk nl b">X-CSRF: xxxxxxx</code>替换为从请求体<code class="fe ni nj nk nl b">value='c82d0a16fd455d8db048022a5d6bd0a9'</code>获取的<strong class="jt ir">动态值</strong></p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi nm"><img src="../Images/f389f308c8aa3e7675196b29646c2e97.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hYdnFDwQgo3Z1nKsotIroA.png"/></div></div></figure><p id="75b2" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">3.让我们从Burp历史中选择请求，并快速创建宏。<br/> <strong class="jt ir">项目选项&gt;会话&gt;添加。</strong></p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi nn"><img src="../Images/9b8bd175a8405bcabf5553189254e360.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Wu8ngGz4caiOcNqUWS6Ijw.png"/></div></div></figure><p id="4942" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">4.在<code class="fe ni nj nk nl b">Session handling rule editor</code>中添加<code class="fe ni nj nk nl b">Rule Description:</code>Blog-DynamicResponseHTMLBody。然后在<code class="fe ni nj nk nl b">Rule Actions</code>中点击<code class="fe ni nj nk nl b">Add</code>，然后点击<code class="fe ni nj nk nl b">Run a macro</code>。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi no"><img src="../Images/ebc1b5f47fabc37a7ff131d8f5b2e6d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7_az7qwpv13oxDi12zjxtQ.png"/></div></div></figure><p id="5764" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">5.然后在<code class="fe ni nj nk nl b">Session handling action editor</code>中，选择<code class="fe ni nj nk nl b">Add a new macro</code>。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi np"><img src="../Images/d61501649b635187a1416f0bda6253f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gZL0nKVOgC90HXB0ROIYnQ.png"/></div></div></figure><p id="a6a4" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">6.在<code class="fe ni nj nk nl b">Macro Recorder</code>中，选择包含<strong class="jt ir">动态值</strong>的请求，点击<strong class="jt ir"> OK </strong>。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi nm"><img src="../Images/befe3eb73d065deaaa687037cab12901.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pF_OJrSPMQ2DfwH1UK-lAQ.png"/></div></div></figure><p id="dc51" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">7.在<code class="fe ni nj nk nl b">Macro Editor</code>中，添加<code class="fe ni nj nk nl b">Macro description</code> : FetchDynamicValue。然后点击<code class="fe ni nj nk nl b">Configure Item</code>。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi nq"><img src="../Images/8665221259ec6069cf96704293b4ee67.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*neyh5CXrMomVJ-DSA9hAgg.png"/></div></div></figure><p id="b775" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">8.因为没有饼干，所以上面的盒子没有打钩。现在在<code class="fe ni nj nk nl b">Custom parameter locations in response</code>上，点击<code class="fe ni nj nk nl b">Add</code>。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi np"><img src="../Images/d19546e9a6d8689fbdc5e29851a69534.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vOjzTY-aziDMkIoUJDCQGA.png"/></div></div></figure><h2 id="c7d9" class="mh lk iq bd ll mi mj dn lp mk ml dp lt kp mm mn lx kq mo mp mb kr mq mr mf ms bi translated"><strong class="ak"> A)执行宏从响应体动态更新扩展值。</strong></h2><ol class=""><li id="934e" class="my mz iq jt b ju mt jy mu kp na kq nb kr nc ko nd ne nf ng bi translated">加载用于从请求体获取动态值的Burp扩展。</li></ol><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi nn"><img src="../Images/91efd4ad881de5cf9f97e5af9f161851.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cwkLQN3JTX8WxjKhLl5-7Q.png"/></div></div></figure><p id="af51" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">2.执行上述常见步骤。</p><p id="786c" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">3.对于<code class="fe ni nj nk nl b">Define Custom Parameter</code>，提供<code class="fe ni nj nk nl b">parameter name</code> : <strong class="jt ir"> any_value </strong>(这可以是任何值，我们只是需要它稍后使用Burp API从python扩展获取宏响应)。<br/>从<strong class="jt ir">响应体</strong>中选择数值。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi nr"><img src="../Images/6ef54debddbf943267f92b22872083b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gAYq6O8MQferLr9IJZjsbA.png"/></div></div></figure><p id="f1cb" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">4.<code class="fe ni nj nk nl b">Configure Macro Item</code>中的自定义参数应该有<strong class="jt ir"> any_value </strong>。然后点击<strong class="jt ir">确定</strong>。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi no"><img src="../Images/f4cb03251e4b68070b74d2c9dd02bbfe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ppwkJJv7IeOpIor4GBgzzA.png"/></div></div></figure><p id="b49d" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">5.点击确定，保存并关闭<code class="fe ni nj nk nl b">Macro Editor</code>。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi ns"><img src="../Images/6f6731cb3fbf9bd6f76e150c0e2f7f56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C_5cCib_8GzSyEVCTDxt1g.png"/></div></div></figure><p id="1c15" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">6.对于<code class="fe ni nj nk nl b">Session handling action editor</code>，选择<code class="fe ni nj nk nl b">After running the macro, invoke a Burp extension action handler</code>，选择自己的扩展<a class="ae li" href="https://github.com/justm0rph3u5/BurpSuite-CustomHeader/blob/main/macro_custom_header_resbody.py" rel="noopener ugc nofollow" target="_blank"><strong class="jt ir">macro _ custom _ header _ resbody . py</strong></a><strong class="jt ir">。<br/> </strong>点击<strong class="jt ir">确定。</strong></p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi ns"><img src="../Images/51fe98004a3cc7b98a2290283253d97c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4RUkvup2x_bpSyPdPluoUw.png"/></div></div></figure><p id="311e" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">7.保存<code class="fe ni nj nk nl b">Session handling action editor and switch to Scope</code>。</p><p id="ba43" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">8.在<code class="fe ni nj nk nl b">Session handling rule editor</code>的<code class="fe ni nj nk nl b">Scope</code>页签中，根据需要更换<code class="fe ni nj nk nl b">Tools Scope</code>和<code class="fe ni nj nk nl b">URL Scope</code>。点击<strong class="jt ir">确定</strong>。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi nt"><img src="../Images/2db91c7a10bcf320bf5e92b84dc423a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mxSBxyS4JGjs0miqIUQJpA.png"/></div></div></figure><p id="b94c" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">9.现在添加自定义标题，因为这是演示DVWA，它不包含CSRF标题。我们可以通过调用另一个<a class="ae li" href="https://github.com/PortSwigger/add-custom-header" rel="noopener ugc nofollow" target="_blank">自定义标题扩展</a>来添加自定义标题。</p><p id="4451" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated"><code class="fe ni nj nk nl b">X-CSRF: xxxxxx</code>并发送请求。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi nu"><img src="../Images/1c5171b890891bdae59d5026901995d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RXHki_Qkn84x48PUE2sj5g.png"/></div></div></figure><p id="17f2" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">10.检查<code class="fe ni nj nk nl b">X-CSRF:</code>令牌的值，该值是动态更新的。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi nv"><img src="../Images/da0b2e79c6b05c6c2101306d7c68f4f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hfJvY8i9GmC-KKaER7N7oA.png"/></div></div></figure><h2 id="95e9" class="mh lk iq bd ll mi mj dn lp mk ml dp lt kp mm mn lx kq mo mp mb kr mq mr mf ms bi translated"><strong class="ak"> B)执行宏以动态更新来自响应报头的扩展值。</strong></h2><ol class=""><li id="5bbf" class="my mz iq jt b ju mt jy mu kp na kq nb kr nc ko nd ne nf ng bi translated">加载用于从请求体获取动态值的Burp扩展。</li></ol><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi nt"><img src="../Images/b71e64a8fc9b9baa1b708ba9ef22ff30.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kUX2pnIk2dccMvCUw4YuCQ.png"/></div></div></figure><p id="2e69" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">2.在<code class="fe ni nj nk nl b">Session handling rule editor</code>中添加<code class="fe ni nj nk nl b">Rule Description</code>，在<code class="fe ni nj nk nl b">Rule Actions</code>中选择<code class="fe ni nj nk nl b">Run a macro</code>。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi nq"><img src="../Images/88c9f2ddb2c3a5bd73cb6ffb3d37a461.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gxbIGek5g6yCVlkvHkOUdQ.png"/></div></div></figure><p id="9be7" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">3.在<code class="fe ni nj nk nl b">Session handling rule editor</code>中，选择<code class="fe ni nj nk nl b">Add a new macro</code>。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi nq"><img src="../Images/429ba64df515f9cf21696a4d7ab9b23b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T6Dpm5Bu9mYatZ74ahya4g.png"/></div></div></figure><p id="c282" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">4.对于<code class="fe ni nj nk nl b">Define Custom Parameter</code>，提供<code class="fe ni nj nk nl b">parameter name</code> : <strong class="jt ir"> any_random_value </strong>(这可以是任何值，我们只是需要它稍后使用Burp API从python扩展中获取头值的宏响应)。<br/>从<strong class="jt ir">响应头</strong>中选择数值。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi nw"><img src="../Images/734302b36d5ba6ea0673250aca2e22bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RrxxdeFegFwMxKuAayOrcA.png"/></div></div></figure><p id="d810" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">5.在<code class="fe ni nj nk nl b">Configure Macro Item</code>中，取消勾选<code class="fe ni nj nk nl b">Cookie handling</code>，因为不需要；在<code class="fe ni nj nk nl b">Custom parameter locations in response</code>中，勾选<code class="fe ni nj nk nl b">any_random_value</code>并点击确定。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi nm"><img src="../Images/10c6bec38897e969e2b7b509583ebb66.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DoimFqjsoE9p3t2_FmFBEQ.png"/></div></div></figure><p id="16f6" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">6.然后在<code class="fe ni nj nk nl b">Macro Editor</code>中，进入<code class="fe ni nj nk nl b">Macro Description</code>并点击<strong class="jt ir">确定</strong>。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi np"><img src="../Images/e8b4cf4110557190fab757fae0676f55.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R8KiHwFY92-VA2O2s0gKhQ.png"/></div></div></figure><p id="2249" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">7.然后在<code class="fe ni nj nk nl b">Session handling action editor</code>中选择新创建的宏，即<code class="fe ni nj nk nl b">FetchDynamicValue-Header</code>。之后在<code class="fe ni nj nk nl b">After running the macro, invoke a Burp extension action handler:</code> <a class="ae li" href="https://github.com/justm0rph3u5/BurpSuite-CustomHeader/blob/main/macro_custom_header_resheader.py" rel="noopener ugc nofollow" target="_blank">中选择扩展名macro _ custom _ header _ resh eader . py</a></p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi no"><img src="../Images/c79b1dfedb3516fef3adb2a04cb8a2a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7xYo-Ru3aubQL0ECA-JMBw.png"/></div></div></figure><p id="6a61" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">8.然后切换到<code class="fe ni nj nk nl b">Scope</code>选项卡。对于<code class="fe ni nj nk nl b">Tools Scope</code>,选择<strong class="jt ir">范围</strong>和<strong class="jt ir"> URL范围</strong>。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi nx"><img src="../Images/3f4d3105e7d2b499665faf82b8f4d480.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TYcbzyyT1R_UpzGFPSamzg.png"/></div></div><figcaption class="le lf gj gh gi lg lh bd b be z dk translated">如题</figcaption></figure><p id="5200" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">9.现在添加定制的<code class="fe ni nj nk nl b">X-CSRF: xxxxxxx</code>令牌，并在中继器中发送请求。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi nn"><img src="../Images/8a993ae091c91b03354875b06834ef8c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bl00qIFKwRYVoQt9Xgh8tg.png"/></div></div></figure><p id="35c9" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">10.检查扩展的<strong class="jt ir">值，它根据演示报头进行了修改(我们选择了日期报头，因为DVWA在响应报头中不包含任何csrf令牌)。</strong></p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi nr"><img src="../Images/9d68d6bf4b93342ef48f8265df252e68.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lCiokXs8a7MkSrvnaSLT9w.png"/></div></div></figure><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi nr"><img src="../Images/8450094309a83dc144c0d7bc887b4613.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-hnJyQTBJpWAXZiEWoGKGw.png"/></div></div></figure><h1 id="b81a" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">第2部分—关于扩展的所有内容:</h1><ol class=""><li id="1522" class="my mz iq jt b ju mt jy mu kp na kq nb kr nc ko nd ne nf ng bi translated"><a class="ae li" href="https://github.com/justm0rph3u5/BurpSuite-CustomHeader/blob/main/macro_custom_header_resheader.py" rel="noopener ugc nofollow" target="_blank"> <strong class="jt ir">为响应头</strong> </a> <strong class="jt ir"> : </strong></li></ol><p id="0368" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">a)对于下面提到的响应头，部分是获取响应头。<code class="fe ni nj nk nl b">macro_response_info.<a class="ae li" href="https://portswigger.net/burp/extender/api/burp/iresponseinfo.html" rel="noopener ugc nofollow" target="_blank">getHeaders()</a></code>获取响应头的值。<br/>然后<code class="fe ni nj nk nl b">macro_body_offset.get(1)[14:]</code>从特定索引开始切片。</p><blockquote class="jn jo jp"><p id="625d" class="jq jr js jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ij bi translated"><strong class="jt ir"> <em class="iq">该值需要根据表头的动态值进行更改。</em> </strong></p></blockquote><pre class="kt ku kv kw gt ny nl nz oa aw ob bi"><span id="0217" class="mh lk iq nl b gy oc od l oe of">macro_response_info = self.helpers.analyzeResponse(macroItems[0].getResponse())<br/><br/>self.stdout.println('Loading custom header for Macro complete: By justm0rph3u5')<br/><br/># get the list of headers from the response, if token is present in the response header then we need to list all the header and extract the value<br/>macro_body_offset = macro_response_info.getHeaders()<br/><br/>#from the macro body(which contains the response headers), we are extracting dynamic value of the header<br/>new_header = macro_body_offset.get(1)[14:]</span></pre><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi og"><img src="../Images/4848cacc20b6dfe59dd8a973e3ef6b0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X6DMdMhEHr2dU97al85aLQ.png"/></div></div></figure><p id="0db2" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">b)在加载扩展之前，需要更新提到<code class="fe ni nj nk nl b">X-CSRF</code>头的第二部分。该字符串检查所提到的报头是否出现在请求报头列表中，以执行进一步的修改。</p><p id="fed0" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">在两个地方改变数值<code class="fe ni nj nk nl b">X-CSRf</code>。</p><pre class="kt ku kv kw gt ny nl nz oa aw ob bi"><span id="941a" class="mh lk iq nl b gy oc od l oe of">for header in headers:<br/>    #Change this value according to the custom header present in the request. So if X-SESSION_ID: xxxxxxxx is the header then change the string to 'X_SESSION_ID'<br/>    if '<strong class="nl ir">X-CSRF</strong>' in header:<br/>        head_delete = header<br/><br/>#remove the header<br/>headers.remove(head_delete)<br/><br/>#add new header, some wierd java error may come. please diy<br/>#While adding the new header, kindly change the value to 'X_SESSION_ID', from above example.<br/>headers.add('<strong class="nl ir">X-CSRF:</strong> ' + new_header)</span></pre><p id="de72" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">c)这部分代码更新了Burp套件中的消息体和消息头。</p><pre class="kt ku kv kw gt ny nl nz oa aw ob bi"><span id="43f5" class="mh lk iq nl b gy oc od l oe of"># create new message with headers and body<br/>new_message_request = self.helpers.buildHttpMessage(headers, message_body)<br/>baseRequestResponse.setRequest(new_message_request)</span></pre><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi oh"><img src="../Images/f8453271167b811bb099a1094cb11dc1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jboQanDoRrRZk2cKjBaMaw.png"/></div></div></figure><p id="0366" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">d)最后，定制的Burp套件扩展已经就绪，可用于添加任何具有动态值的标题。<em class="js">这需要进一步修改，但就目前而言，效果很好。</em></p><figure class="kt ku kv kw gt kx"><div class="bz fp l di"><div class="oi oj l"/></div></figure><p id="2b1d" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated"><strong class="jt ir"> 2。</strong> <a class="ae li" href="https://github.com/justm0rph3u5/BurpSuite-CustomHeader/blob/main/macro_custom_header_resbody.py" rel="noopener ugc nofollow" target="_blank"> <strong class="jt ir">为响应体中的动态值</strong> </a></p><p id="9e03" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">a)对于响应体中的动态值，下面提到的部分是获取响应体值。<br/> <code class="fe ni nj nk nl b">macroItems[0].<a class="ae li" href="https://portswigger.net/burp/extender/api/burp/ihttprequestresponse.html" rel="noopener ugc nofollow" target="_blank">getResponse()</a></code>从宏响应中提取令牌。然后<code class="fe ni nj nk nl b">self.helpers.bytesToString(macro_body_value)</code>提供响应内容。将对该内容运行Regex以获取准确的值。</p><pre class="kt ku kv kw gt ny nl nz oa aw ob bi"><span id="8e27" class="mh lk iq nl b gy oc od l oe of">macro_response = self.helpers.analyzeResponse(macroItems[0].getResponse())<br/>self.stdout.println('Loading custom header for Macro complete: By justm0rph3u5')<br/># extract the token from the macro response<br/>macro_message = macroItems[0].getResponse()<br/><br/># print(self.helpers.bytesToString(macro_message))<br/>#this part of the code deals with fetching value of HTML Response Body<br/><br/>macro_offset = macro_response.getBodyOffset()<br/>macro_body_value = macro_message[macro_offset:-1]<br/>macro_body_str = self.helpers.bytesToString(macro_body_value)</span></pre><p id="fe2b" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">b)还要更新正则表达式，这个正则表达式将用于从动态html页面中提取值。<br/>对于<code class="fe ni nj nk nl b">value='c82d0a16fd455d8db048022a5d6bd0a9'</code>，使用该正则表达式<code class="fe ni nj nk nl b">value=\'\S+\'</code>。</p><blockquote class="jn jo jp"><p id="34a0" class="jq jr js jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ij bi translated"><strong class="jt ir"> <em class="iq">这个值需要根据来自身体的动态值来改变。</em> </strong></p></blockquote><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi ok"><img src="../Images/bddf7ddd484bc5cd743244b4756e879f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gBo9wQ-QMKdnrt6i4Enqdw.png"/></div></div></figure><p id="1f4b" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">c)使用python中的<strong class="jt ir"> re模块</strong>并创建regex，该regex从<strong class="jt ir"> HTTP响应体</strong>中提取并切片令牌的<strong class="jt ir">精确值</strong>。</p><p id="0a47" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">根据精确值修改:<code class="fe ni nj nk nl b">match_1.group()[7:-1]</code></p><pre class="kt ku kv kw gt ny nl nz oa aw ob bi"><span id="6525" class="mh lk iq nl b gy oc od l oe of">#Regex checks the value of the Token to be fetched from the html body. Here is was csrf token in the response body. Modify regex and slice it accordingly<br/><br/>matched = re.finditer(regex, macro_body_str, re.MULTILINE)<br/><br/>for matchNum, match_1 in enumerate(matched, start=1):<br/><br/>    #change this value of index according to the regex.<br/>    #Modify this<br/>    new_header=match_1.group()[7:-1]</span></pre><p id="32d2" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">d)在加载扩展之前，需要更新提到<code class="fe ni nj nk nl b">X-CSRF</code>头的部分。该字符串检查所提到的报头是否出现在请求报头列表中，以执行进一步的修改。</p><p id="86fd" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">将两处的值<code class="fe ni nj nk nl b">X-CSRf</code>更改为所需的标题。例如X会话ID、JWT令牌等。</p><pre class="kt ku kv kw gt ny nl nz oa aw ob bi"><span id="73ab" class="mh lk iq nl b gy oc od l oe of">for header in headers:<br/>    if 'X-CSRF' in header:<br/>        head_delete = header<br/><br/>headers.remove(head_delete)<br/><br/># add new header, some wierd java error may come. please diy<br/># While adding the new header, kindly change the value to 'X_SESSION_ID', from above example.<br/>headers.add('X-CSRF: ' + new_header)</span></pre><p id="d7a2" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">e)此代码更新了Burp套件中的消息正文和标题。</p><pre class="kt ku kv kw gt ny nl nz oa aw ob bi"><span id="4c85" class="mh lk iq nl b gy oc od l oe of"># create new message with headers and body<br/>new_message_request = self.helpers.buildHttpMessage(headers, message_body)<br/>baseRequestResponse.setRequest(new_message_request)</span></pre><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi ol"><img src="../Images/6cbcca31e7a5c016394ba99bc2619b91.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jgy2bbdz4_NqN55veJGurw.png"/></div></div></figure><p id="c420" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">d)可能有其他自定义的Burp Suite扩展来修改标题，但在搜索数小时后，该扩展可以与简单的<code class="fe ni nj nk nl b">Burp Macro</code>一起使用，并可以快速获取值和更新标题。</p><figure class="kt ku kv kw gt kx"><div class="bz fp l di"><div class="oi oj l"/></div></figure><p id="01dd" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated"><strong class="jt ir">注:</strong>本文试图解决这个portswigger论坛中提到的问题。</p><div class="om on gp gr oo op"><a href="https://forum.portswigger.net/thread/update-header-in-session-handling-macros-a0132444" rel="noopener  ugc nofollow" target="_blank"><div class="oq ab fo"><div class="or ab os cl cj ot"><h2 class="bd ir gy z fp ou fr fs ov fu fw ip bi translated">更新会话处理/宏中的标题</h2><div class="ow l"><h3 class="bd b gy z fp ou fr fs ov fu fw dk translated">你好，我正在开发一个将CSRF令牌用于登录表单的应用程序。令牌是一个隐藏的值，在…</h3></div><div class="ox l"><p class="bd b dl z fp ou fr fs ov fu fw dk translated">forum.portswigger.net</p></div></div><div class="oy l"><div class="oz l pa pb pc oy pd lc op"/></div></div></a></div><p id="6482" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated"><strong class="jt ir"> <em class="js">最后，我们可以通过会话处理/宏更新Burp套件中的标题。</em>T3】</strong></p><h2 id="dcdc" class="mh lk iq bd ll mi mj dn lp mk ml dp lt kp mm mn lx kq mo mp mb kr mq mr mf ms bi translated">关键要点:</h2><ol class=""><li id="26e8" class="my mz iq jt b ju mt jy mu kp na kq nb kr nc ko nd ne nf ng bi translated">学习了如何在Jython中创建burp扩展。</li><li id="e8c9" class="my mz iq jt b ju pe jy pf kp pg kq ph kr pi ko nd ne nf ng bi translated">学习了Java和Jython编程。</li><li id="5e08" class="my mz iq jt b ju pe jy pf kp pg kq ph kr pi ko nd ne nf ng bi translated">了解Burp APIs和宏。</li><li id="ff8b" class="my mz iq jt b ju pe jy pf kp pg kq ph kr pi ko nd ne nf ng bi translated">成功解决了论坛上长期悬而未决的问题。</li></ol><blockquote class="pj"><p id="aa9e" class="pk pl iq bd pm pn po pp pq pr ps ko dk translated"><a class="ae li" href="https://justm0rph3u5.medium.com/automating-burp-suite-3-creating-macro-to-replace-csrf-token-from-response-body-to-request-param-de37eb54ab5f" rel="noopener">在第三个教程中，从响应体中获取CSRF令牌，并使用<strong class="ak">宏在请求参数中更新它。</strong>阅读第3部分，这将有助于理解自定义标题替换。</a></p></blockquote><h2 id="8974" class="mh lk iq bd ll mi pt dn lp mk pu dp lt kp pv mn lx kq pw mp mb kr px mr mf ms bi translated"><strong class="ak">参考:</strong></h2><ol class=""><li id="e540" class="my mz iq jt b ju mt jy mu kp na kq nb kr nc ko nd ne nf ng bi translated"><a class="ae li" href="https://www.youtube.com/playlist?list=PLD3kJNWBcwYElw-RM7taW9TSPPLvsObvd" rel="noopener ugc nofollow" target="_blank">https://www.youtube.com/playlist?list = PLD 3 kjnwbcwyelw-RM 7 ta w9 tspplvsobvd</a></li><li id="33a0" class="my mz iq jt b ju pe jy pf kp pg kq ph kr pi ko nd ne nf ng bi translated"><a class="ae li" href="https://raesene.github.io/blog/2016/06/19/Burp-Plugin-JWT-Tokens/" rel="noopener ugc nofollow" target="_blank">https://raesene . github . io/blog/2016/06/19/Burp-Plugin-JWT-Tokens/</a></li><li id="b99f" class="my mz iq jt b ju pe jy pf kp pg kq ph kr pi ko nd ne nf ng bi translated"><a class="ae li" href="https://www.okiok.com/burp-extensions-python/" rel="noopener ugc nofollow" target="_blank">https://www.okiok.com/burp-extensions-python/</a></li><li id="a2fc" class="my mz iq jt b ju pe jy pf kp pg kq ph kr pi ko nd ne nf ng bi translated"><a class="ae li" href="https://github.com/subodhkrishna/Digest-Header-Updater-Burp-Extension/blob/master/update-digest_header.py" rel="noopener ugc nofollow" target="_blank">https://github . com/subodh Krishna/Digest-Header-Updater-Burp-Extension/blob/master/update-Digest _ Header . py</a></li><li id="d91e" class="my mz iq jt b ju pe jy pf kp pg kq ph kr pi ko nd ne nf ng bi translated"><a class="ae li" href="https://github.com/parmaviolet/AuthHeaderUpdate/blob/main/auth_header_update.py" rel="noopener ugc nofollow" target="_blank">https://github . com/parma violet/AuthHeaderUpdate/blob/main/auth _ header _ update . py</a></li><li id="9376" class="my mz iq jt b ju pe jy pf kp pg kq ph kr pi ko nd ne nf ng bi translated"><a class="ae li" href="https://forum.portswigger.net/thread/update-header-in-session-handling-macros-a0132444" rel="noopener ugc nofollow" target="_blank">https://forum . ports swigger . net/thread/update-header-in-session-handling-macros-a 0132444</a></li><li id="2e84" class="my mz iq jt b ju pe jy pf kp pg kq ph kr pi ko nd ne nf ng bi translated"><a class="ae li" href="https://forum.portswigger.net/thread/burp-extensions-using-makehttprequest-46572bd1" rel="noopener ugc nofollow" target="_blank">https://forum . ports swigger . net/thread/burp-extensions-using-make http request-46572 BD 1</a></li><li id="d0bc" class="my mz iq jt b ju pe jy pf kp pg kq ph kr pi ko nd ne nf ng bi translated"><a class="ae li" href="https://www.youtube.com/watch?v=IdM4Sc7WVGU" rel="noopener ugc nofollow" target="_blank">https://www.youtube.com/watch?v=IdM4Sc7WVGU</a></li></ol><figure class="kt ku kv kw gt kx gh gi paragraph-image"><a href="https://www.buymeacoffee.com/justmorpheus"><div class="gh gi py"><img src="../Images/4bc5de35955c00939383a18fb66b41d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:340/format:webp/1*9vg3-OY14aZN1UpKwIxxZg.png"/></div></a></figure></div></div>    
</body>
</html>