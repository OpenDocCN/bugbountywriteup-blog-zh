<html>
<head>
<title>Content-Security-Policy Bypass to perform XSS using MIME sniffing</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用MIME嗅探绕过内容安全策略来执行XSS</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/content-security-policy-bypass-to-perform-xss-3c8dd0d40c2e?source=collection_archive---------0-----------------------#2020-12-09">https://infosecwriteups.com/content-security-policy-bypass-to-perform-xss-3c8dd0d40c2e?source=collection_archive---------0-----------------------#2020-12-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><h1 id="a4ce" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">摘要</h1><p id="5867" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">最近，我执行了一个跨站点脚本漏洞，但是一个正常的XSS有效载荷没有被触发，因为CSP阻止了外部Javascript代码(XSS)的执行。通过在另一个端点发现另一个XSS漏洞(再次被CSP阻止)，我设法将它们结合在一起，导致绕过CSP，并使用MIME嗅探触发XSS</p><h1 id="6a25" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">寻找第一个XSS</h1><p id="dbfd" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">下图显示了位于索引中的端点，其参数值被反映到网站正文中。</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div class="gh gi lj"><img src="../Images/aacc7e86dd26a1b34c6f322c1826529d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1058/format:webp/1*Fyq1VB-WOn_KN_yU_ZLs_A.jpeg"/></div></figure><p id="0632" class="pw-post-body-paragraph kl km iq kn b ko lr kq kr ks ls ku kv kw lt ky kz la lu lc ld le lv lg lh li ij bi translated">让我们尝试输入一个简单的HTML有效载荷，而不是给出一个字符串值。我输入了<strong class="kn ir">&lt;h1&gt;kleiton 0x 00&lt;/h1&gt;</strong>，希望有效载荷能够反映并显示为一个HTML内容。</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="gh gi lw"><img src="../Images/14c5d22089c981ae4f2cc1a88d9aad2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KHg8oSA8vM5gLAZnQHomdg.jpeg"/></div></div></figure><p id="f138" class="pw-post-body-paragraph kl km iq kn b ko lr kq kr ks ls ku kv kw lt ky kz la lu lc ld le lv lg lh li ij bi translated">酷，我们有HTML注入，所以让我们尝试利用它到XSS。这次我进入了有史以来最简单的XSS有效载荷:<strong class="kn ir"> &lt;脚本&gt;警戒(1)&lt;/脚本&gt; </strong></p><p id="c537" class="pw-post-body-paragraph kl km iq kn b ko lr kq kr ks ls ku kv kw lt ky kz la lu lc ld le lv lg lh li ij bi translated">如果WAF没有过滤或阻止任何东西，我们将能够触发Javascript负载。</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="gh gi mb"><img src="../Images/5ae6801e7bbe13df907d3b67ac4870ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AhUgcHJriQoYZfz1ugEv7w.jpeg"/></div></div></figure><p id="de4a" class="pw-post-body-paragraph kl km iq kn b ko lr kq kr ks ls ku kv kw lt ky kz la lu lc ld le lv lg lh li ij bi translated">等等？！它被成功地注入了网站，但没有警报1？！？！？查看页面源代码，没有过滤或删除任何内容。</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div class="gh gi mc"><img src="../Images/87ba604c1486d2d371cec8e66202789a.png" data-original-src="https://miro.medium.com/v2/resize:fit:788/format:webp/1*BPtGNIYJlmH7BI6QHSdkKg.jpeg"/></div></figure><h1 id="ca56" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">检测CSP</h1><p id="d798" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在浏览浏览器(控制台)的开发工具时，我意识到这个脚本被<strong class="kn ir">内容安全政策</strong>屏蔽了。</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="gh gi md"><img src="../Images/a557b7bde7cbe681550e714e67dfa903.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-xnKZAw1m86EjoqQTjwNxw.jpeg"/></div></div></figure><p id="b1bb" class="pw-post-body-paragraph kl km iq kn b ko lr kq kr ks ls ku kv kw lt ky kz la lu lc ld le lv lg lh li ij bi translated">这是什么意思？内容安全策略(CSP)是一个附加的安全层，特别是阻止外部代码注入网站的HTTP头。通常，一个实现良好的CSP只允许内部实体(域本身)编写脚本。</p><p id="44d5" class="pw-post-body-paragraph kl km iq kn b ko lr kq kr ks ls ku kv kw lt ky kz la lu lc ld le lv lg lh li ij bi translated">首先，我们必须检测CSP是如何工作的，以及它允许从哪个来源将脚本加载到网站中。</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div class="gh gi me"><img src="../Images/3620e2b37bf448bd35dd504d028e6421.png" data-original-src="https://miro.medium.com/v2/resize:fit:1336/format:webp/1*yf-2jInZ8Ryfto1KDZ-3dQ.jpeg"/></div></figure><p id="b02c" class="pw-post-body-paragraph kl km iq kn b ko lr kq kr ks ls ku kv kw lt ky kz la lu lc ld le lv lg lh li ij bi translated">查看HTTP头，特别是<strong class="kn ir"> Content-Security-Policy: </strong>我们可以看到，CSP有一个规则来接受来自网站本身及其目录和子域的脚本。看起来我们非常有限，因为我们不能注入我们自己的恶意Javascript。</p><h1 id="29bd" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">找到XSS的另一个易受攻击的终点</h1><p id="0d16" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">既然我们无法绕过它，我决定四处看看，试图找到更多的XSS。我打开了索引的页面源代码，在滚动时，我注意到一个php代码有一个参数。有意思！</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div class="gh gi mf"><img src="../Images/0fd193db36438b14db0d4a7e27f7f439.png" data-original-src="https://miro.medium.com/v2/resize:fit:892/format:webp/1*gAA9BoUBzwaUcQPWg7zufA.jpeg"/></div></figure><p id="e5a4" class="pw-post-body-paragraph kl km iq kn b ko lr kq kr ks ls ku kv kw lt ky kz la lu lc ld le lv lg lh li ij bi translated">没有耽误时间，马上上了<strong class="kn ir"> /js/countdown.php </strong></p><p id="562d" class="pw-post-body-paragraph kl km iq kn b ko lr kq kr ks ls ku kv kw lt ky kz la lu lc ld le lv lg lh li ij bi translated">在<strong class="kn ir"> end </strong>参数中，我放了一个简单的字符串值来查看网站的行为。</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="gh gi mg"><img src="../Images/c3dfa79caf5e2cba55f6a7aafb243464.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6UX3ucL-HyHORbJNLAKQ1A.jpeg"/></div></div></figure><p id="b2a2" class="pw-post-body-paragraph kl km iq kn b ko lr kq kr ks ls ku kv kw lt ky kz la lu lc ld le lv lg lh li ij bi translated">我们看到我们的字符串(kleiton0x00)被反映到源代码中。超级！我们可以开始注入javascript代码。</p><h1 id="d092" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">中断Javascript字符串以执行第二个XSS</h1><p id="b34f" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">我们不要输入简单的字符串，而是尝试断开js字符串。如何做到这一点？根据代码，我们的反射输入被添加在数字之后。</p><p id="2cfb" class="pw-post-body-paragraph kl km iq kn b ko lr kq kr ks ls ku kv kw lt ky kz la lu lc ld le lv lg lh li ij bi translated">添加<strong class="kn ir">)；</strong>关闭第2行当前Javascript代码。括号内的<strong class="kn ir"> ) </strong>将关闭变量值和<strong class="kn ir">；</strong>将关闭当前第2行javascript代码。因为代码是封闭的，所以我们可以添加一个新的Javascript代码，这当然是我们的恶意代码，在我们的例子中是<strong class="kn ir">alert(1)；</strong></p><p id="9922" class="pw-post-body-paragraph kl km iq kn b ko lr kq kr ks ls ku kv kw lt ky kz la lu lc ld le lv lg lh li ij bi translated">不幸的是，同一行还有代码:<strong class="kn ir"> *1000)。getTime()；</strong></p><p id="4ff8" class="pw-post-body-paragraph kl km iq kn b ko lr kq kr ks ls ku kv kw lt ky kz la lu lc ld le lv lg lh li ij bi translated">如何摆脱那些？简单，简单地通过评论。因此，在我们输入的末尾，我们添加了<strong class="kn ir"> // </strong></p><p id="3e26" class="pw-post-body-paragraph kl km iq kn b ko lr kq kr ks ls ku kv kw lt ky kz la lu lc ld le lv lg lh li ij bi translated">我们最终的有效载荷是:</p><blockquote class="mh mi mj"><p id="980b" class="kl km mk kn b ko lr kq kr ks ls ku kv ml lt ky kz mm lu lc ld mn lv lg lh li ij bi translated"><strong class="kn ir"><em class="iq">)；警报(1)；// </em> </strong></p></blockquote><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="gh gi mo"><img src="../Images/6115a253e6709a4432a84434444d67ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VW7dqCcSOeKznwOBbPgyGw.jpeg"/></div></div></figure><p id="38f7" class="pw-post-body-paragraph kl km iq kn b ko lr kq kr ks ls ku kv kw lt ky kz la lu lc ld le lv lg lh li ij bi translated">很好，根据源代码，我们已经成功地将Javascript代码注入到目录中。我们得到了第二个XSS！</p><p id="3d74" class="pw-post-body-paragraph kl km iq kn b ko lr kq kr ks ls ku kv kw lt ky kz la lu lc ld le lv lg lh li ij bi translated">所以完整的网址应该是:<a class="ae mp" href="http://website.com/js/countdown.php?end=2534926825);alert(1);//" rel="noopener ugc nofollow" target="_blank"><strong class="kn ir">http://website.com/js/countdown.php?end = 2534926825)；警报(1)；// </strong> </a></p><p id="2f51" class="pw-post-body-paragraph kl km iq kn b ko lr kq kr ks ls ku kv kw lt ky kz la lu lc ld le lv lg lh li ij bi translated">当去给定的网址，没有XSS被反映。为什么？因为我们的XSS又被CSP封杀了。</p><h1 id="9602" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">使用MIME嗅探绕过带有2个XSS的CSP</h1><p id="89fe" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">是时候将我们在索引页上找到的第一个XSS和在<strong class="kn ir">countdown.php上找到的第二个XSS结合起来了。</strong></p><p id="9874" class="pw-post-body-paragraph kl km iq kn b ko lr kq kr ks ls ku kv kw lt ky kz la lu lc ld le lv lg lh li ij bi translated">让我们看看MIME嗅探如何导致XSS漏洞。对于利用MIME嗅探执行XSS攻击的攻击者，必须满足某些前提条件。请注意，前提条件都在客户端:</p><ul class=""><li id="7c60" class="mq mr iq kn b ko lr ks ls kw ms la mt le mu li mv mw mx my bi translated">攻击者应该能够控制服务器响应中的内容，以便注入恶意的JavaScript(我们发现的第二个XSS)</li><li id="4e18" class="mq mr iq kn b ko mz ks na kw nb la nc le nd li mv mw mx my bi translated">攻击者应该能够通过HTML注入或Javascript注入(我们发现的第一个XSS)引入可执行上下文</li></ul><p id="54f2" class="pw-post-body-paragraph kl km iq kn b ko lr kq kr ks ls ku kv kw lt ky kz la lu lc ld le lv lg lh li ij bi translated">我们的XSS有效载荷将基于我们在第一个XSS上发现的(<strong class="kn ir"> &lt;脚本&gt;警报(1)&lt;/脚本&gt; </strong>)。我们将加载countdown.php的URL，即<a class="ae mp" href="http://website.com/js/countdown.php?end=2534926825);alert(1);//" rel="noopener ugc nofollow" target="_blank"><strong class="kn ir">http://website.com/js/countdown.php?，而不是执行Javascriptend = 2534926825)；警报(1)；// </strong> </a></p><p id="fa9d" class="pw-post-body-paragraph kl km iq kn b ko lr kq kr ks ls ku kv kw lt ky kz la lu lc ld le lv lg lh li ij bi translated">因此，结合第一个文件的XSS有效载荷和易受攻击的php文件的URL，我们最终的有效载荷将是:</p><blockquote class="mh mi mj"><p id="d29e" class="kl km mk kn b ko lr kq kr ks ls ku kv ml lt ky kz mm lu lc ld mn lv lg lh li ij bi translated"><strong class="kn ir"> <em class="iq"> &lt;脚本src = ' http://website . com/js/count down . PHP？end = 2534926825)；警报(1)；//&gt;&lt;/脚本&gt; </em> </strong></p></blockquote><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="gh gi ne"><img src="../Images/8e5dd7a2897dcae29ae5020ae1b8829c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gVFn-onsZ2eOsfF9N-7JBA.jpeg"/></div></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated">会导致XSS漏洞。攻击者通过以下方式执行XSS攻击</figcaption></figure><p id="54fb" class="pw-post-body-paragraph kl km iq kn b ko lr kq kr ks ls ku kv kw lt ky kz la lu lc ld le lv lg lh li ij bi translated">我们绕过CSP，使用MIME嗅探成功执行了我们的<strong class="kn ir"> alert(1) </strong>代码。</p></div></div>    
</body>
</html>