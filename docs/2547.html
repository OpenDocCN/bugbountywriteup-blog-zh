<html>
<head>
<title>Pass the Hash Attack</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过哈希攻击</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/pass-the-hash-attack-ddf956cf9551?source=collection_archive---------1-----------------------#2022-11-21">https://infosecwriteups.com/pass-the-hash-attack-ddf956cf9551?source=collection_archive---------1-----------------------#2022-11-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div class="gh gi jq"><img src="../Images/5be7bb4382c8f0d3b6aabde46aa2cbba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/0*FXv0sK_Aq6bOI2iX.jpeg"/></div><figcaption class="jx jy gj gh gi jz ka bd b be z dk translated">由<a class="ae kb" href="https://unsplash.com/@gurysimrat?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上<a class="ae kb" href="https://unsplash.com/@gurysimrat?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Gursimrat Ganda </a>拍摄的照片</figcaption></figure><p id="c52c" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">我们每天都听到关于破坏的消息，有时甚至听到关于系统危害的消息，所以攻击者采取什么步骤以及他如何渗透整个系统都是未知的。让我们明确这一点。</p><p id="f451" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">从攻击者的角度来看，危害系统/网络包括5个阶段。它们是:</p><ol class=""><li id="864a" class="la lb it ke b kf kg kj kk kn lc kr ld kv le kz lf lg lh li bi translated"><strong class="ke iu">侦察</strong>:用于收集系统信息，可以主动也可以被动操作。因此，攻击者试图收集尽可能多的信息，以便尽可能有效地攻击系统。</li><li id="ddfc" class="la lb it ke b kf lj kj lk kn ll kr lm kv ln kz lf lg lh li bi translated"><strong class="ke iu">扫描和枚举</strong>:扫描由攻击者执行，目的是识别系统中的任何漏洞。</li><li id="71a5" class="la lb it ke b kf lj kj lk kn ll kr lm kv ln kz lf lg lh li bi translated"><strong class="ke iu">获得访问权限:</strong>一旦攻击者发现了系统的漏洞，他或她就可以利用这些漏洞来危害系统。</li><li id="0d5b" class="la lb it ke b kf lj kj lk kn ll kr lm kv ln kz lf lg lh li bi translated"><strong class="ke iu">保持访问/利用后:</strong>利用后，攻击者要么试图保持对系统的访问，要么试图攻击网络上的另一个系统，以获取更多信息。</li><li id="d64c" class="la lb it ke b kf lj kj lk kn ll kr lm kv ln kz lf lg lh li bi translated"><strong class="ke iu">清除您的踪迹:</strong>攻击者销毁了他行动的所有证据，这样就没有人能够确定是谁入侵了系统以及获得了什么信息。</li></ol><p id="ebe3" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">出于这篇博客文章的目的，我们将讨论攻击者在后期利用阶段可能利用的一种攻击。这种攻击是后开发阶段的横向移动阶段的一部分。</p><p id="da4e" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated"><strong class="ke iu">后期开发</strong></p><p id="ff85" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">攻击者的主要目标是发射外壳。一旦他做到了这一点，可能性是无穷无尽的，而且这在很大程度上取决于系统管理员已经实现的安全强化过程。</p><p id="77a7" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">在弹出外壳并引用正在打开的会话后，对手采取的任何操作都将被称为后利用。他可以安装恶意软件，甚至在受害者关闭计算机后采取措施保持持久性，甚至泄漏数据。</p><p id="a7e5" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated"><strong class="ke iu">横向移动</strong></p><figure class="lp lq lr ls gt ju gh gi paragraph-image"><div class="gh gi lo"><img src="../Images/d7c880a766ee070e53dafe5d354b5f3d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*B4O_gYbK8qp1VswP.png"/></div><figcaption class="jx jy gj gh gi jz ka bd b be z dk translated"><a class="ae kb" href="https://pberba.github.io/security/2020/04/26/lateral-movement/" rel="noopener ugc nofollow" target="_blank">来源</a></figcaption></figure><p id="9047" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">你会同意我的观点，即被攻击者入侵的计算机/主机不会是网络中唯一的主机。网络包括多台(至少2台)计算机，每台计算机都能够相互通信。横向移动是指攻击者移动或危害网络中其他计算机的过程。在这个过程中，他可能会危及网络中其他更敏感的部分。</p><p id="ac8d" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">传递哈希是攻击者在Windows环境中横向移动时使用的一种后利用技术。</p><p id="8b3b" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated"><strong class="ke iu">简介</strong></p><p id="2561" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">当您登录到拥有多个用户帐户的计算机或公司网络时，您需要提供用户名和密码。您认为Windows会简单地将您的密码与数据库中存储的密码进行比较吗？不。那样不安全。相反，它所做的是找到一个密码的NTLM散列，并与用户名一起存储在一个名为LSASS.exe的文件中。你会想到两个问题。</p><ol class=""><li id="1815" class="la lb it ke b kf kg kj kk kn lc kr ld kv le kz lf lg lh li bi translated">为什么我们的密码是散列的？</li><li id="32ee" class="la lb it ke b kf lj kj lk kn ll kr lm kv ln kz lf lg lh li bi translated">为什么它会把你的密码存在一个文件里？</li></ol><p id="f62d" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">它是散列的，所以即使你的计算机被入侵，攻击者也不会马上得到明文密码。至于第二部分，它存储在一个文件中，因此您不必为必须访问的每个功能输入凭据。在您的家庭环境中，您可能没有考虑到这一点的重要性，但是在企业环境中，有多个服务和任务正在运行。作为用户，要与他们互动，你必须提供你的凭证。如果您必须每5分钟输入一次凭据，这很容易让人感到沮丧。这是SSO的一个概念，您只需输入一次凭据，就可以访问您的用户角色所允许的服务，而无需再次输入密码。</p><p id="adc6" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated"><strong class="ke iu"> NTLM </strong></p><p id="dd38" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">这可能会让你吃惊，但是你的密码从来不会通过网络发送。但是你如何证明你自己呢？NTLM是一种身份验证协议，它使用质询/响应模型来验证用户身份。让我们来了解如何。</p><p id="1a8b" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">假设用户想要访问服务器的服务。服务器向用户发送询问。我们知道现在我们的密码已经被散列并存储在LSASS.exe文件中。使用我们的密码的NTLM散列对挑战进行加密，并连同我们的用户名一起发送回(作为对挑战的响应)服务器。</p><p id="4f7e" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated"><strong class="ke iu">挑战(使用用户的NTML散列加密)- &gt;响应</strong></p><p id="9d3c" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">现在服务器有了我们的用户名、响应和它发送给我们的原始挑战。它将它们发送到域控制器。</p><p id="7c12" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">域控制器是一个独立的实体，拥有我们的用户名和密码的NTLM哈希。它从服务器接收用户名、响应和原始挑战。它获取用户名，并找到用户对应的NTML散列。它接受NTLM散列并使用该散列解密响应。然后，它将解密后的响应与原始质询进行比较。如果它们相等，则用户通过了身份验证。</p><p id="c4e7" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated"><strong class="ke iu">注意:</strong>如果散列与用于加密质询的散列相同，则解密的响应应该与原始质询相同。</p><figure class="lp lq lr ls gt ju gh gi paragraph-image"><div class="gh gi lo"><img src="../Images/9bc7e82d7841fedc26921268f01e74aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*xBFB_WRsQe6sJso-.png"/></div><figcaption class="jx jy gj gh gi jz ka bd b be z dk translated"><a class="ae kb" href="https://www.ionos.com/digitalguide/fileadmin/DigitalGuide/Schaubilder/server-during-ntlm-authentication.png" rel="noopener ugc nofollow" target="_blank">来源</a></figcaption></figure><p id="a32e" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">简而言之，这就是挑战/回应模式的工作方式。这不受网络嗅探攻击的影响，因为无论是哈希还是密码都不会与服务器或域控制器共享。</p><p id="991c" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">但是这使它容易受到一种叫做传递散列的单独类型的攻击。</p><p id="a577" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated"><strong class="ke iu">什么是帕斯哈什？</strong></p><p id="5a93" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">正如我们刚刚了解到的</p><ol class=""><li id="5cad" class="la lb it ke b kf kg kj kk kn lc kr ld kv le kz lf lg lh li bi translated">我们的密码被散列并存储在LSASS.exe文件中。</li><li id="264c" class="la lb it ke b kf lj kj lk kn ll kr lm kv ln kz lf lg lh li bi translated">我们的散列用于加密质询，然后作为响应发送。</li></ol><p id="f662" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">如果对手能够破坏机器，他就可以利用这一点为自己谋利。</p><p id="11b2" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">哈希传递是一种攻击，其中对手使用或发送密码哈希而不是密码本身来验证自己。</p><p id="1722" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">他必须采取的第一步是转储存储在LSASS.exe文件或SAM文件中的NTLM散列。</p><p id="6001" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">然后，他可以使用这些散列来验证自己。完成这一任务的完美工具是<strong class="ke iu"> Mimikatz </strong>。</p><figure class="lp lq lr ls gt ju gh gi paragraph-image"><div class="gh gi lo"><img src="../Images/d0eff81e4b1e73e388cdd1edaabd1dc1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*2-NtGfgIARUMx9pw.png"/></div></figure><p id="e6b5" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated"><strong class="ke iu">补救</strong></p><p id="d20d" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">识别散列攻击是相当困难的。但是，有几种方法可以用来防止这种类型的攻击。</p><p id="924d" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">如果在您的组织中使用SSO，您可以做的是启用多因素身份认证。这将确保即使您的凭据已经被转储和破坏，攻击者也无法破坏其他系统。</p><p id="ba7e" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">您可以使用的另一种补救技术是应用最小特权原则。这在基于云的环境中很常见，也是在企业环境中使用的一种优秀策略。</p><p id="6737" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">最小特权原则认为，用户应该只能访问那些完成工作所需的文件、进程和服务，仅此而已。</p></div><div class="ab cl lt lu hx lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="im in io ip iq"><h2 id="ab22" class="ma mb it bd mc md me dn mf mg mh dp mi kn mj mk ml kr mm mn mo kv mp mq mr ms bi translated">来自Infosec的报道:Infosec每天都有很多内容，很难跟上。<a class="ae kb" href="https://weekly.infosecwriteups.com/" rel="noopener ugc nofollow" target="_blank">加入我们的每周简讯</a>以5篇文章、4个线程、3个视频、2个GitHub Repos和工具以及1个工作提醒的形式免费获取所有最新的Infosec趋势！</h2></div></div>    
</body>
</html>