<html>
<head>
<title>Hacking the Medium partner program</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">破解媒体合作伙伴计划</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/hacking-the-medium-partner-program-84c0e9fa340?source=collection_archive---------0-----------------------#2020-09-26">https://infosecwriteups.com/hacking-the-medium-partner-program-84c0e9fa340?source=collection_archive---------0-----------------------#2020-09-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="f967" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是一段旅程，详细描述了我的名字是如何被添加到<a class="ae kl" href="https://medium.com/humans.txt" rel="noopener"> humans.txt </a>中，以获得我的第一个bug奖励，一个<a class="ae kl" href="https://help.medium.com/hc/en-us/articles/213481308-Bug-Bounty-Disclosure-Program#e237" rel="noopener">严重性2 </a>的奖励！我写这篇文章是因为我个人一直对人们如何发现安全漏洞很感兴趣。此外，漏洞本身非常容易被利用，详情可在本文末尾找到。(请慢慢滚动，以便我可以获得一些合作伙伴计划收入)</p><h1 id="b9d7" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">背景故事</h1><p id="836c" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">我原本打算写一篇文章，描述我进行的测试，试图弄清楚每月5美元的费用中有多少是通过媒体合作伙伴计划给作家的。我曾计划测试我认为可能影响作家报酬的不同互动。例如阅读文章不同的时间量，并查看与文章的交互(通过诸如突出显示文本、鼓掌等手段)是否会影响作者的报酬。由于我的预算有限，我只想支付一个“控制”帐户来做我所有的测试。我最初打算测试20多个不同的场景，但每天只能测试一个，因为中等合作伙伴计划收入是每天计算的，所以我在寻找自动化该过程的方法。因此，我通过chrome开发者工具来分析数据是如何传输回medium.com<a class="ae kl" href="http://medium.com/" rel="noopener">的，看看是否有可能自动化我的一些测试。</a></p><p id="0a25" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我开始一个接一个地阻止对某些url路径的请求，我认为这些请求可能会传输用于计算我的合作伙伴计划收入的指标。经过多次反复试验后，我发现是向<a class="ae kl" href="http://medium.com/_/batch" rel="noopener">medium.com/_/batch</a>发出的请求传输了所有用于计算我的合作伙伴计划收入的数据。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi lp"><img src="../Images/8f66c8894c61f080d92221f19e9bcbac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RWWLPDquGI1bEK-p_hnlEg.png"/></div></div><figcaption class="mb mc gj gh gi md me bd b be z dk translated">通过/_/batch端点传输回medium HQ的部分数据的屏幕截图</figcaption></figure><p id="149c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我没有办法弄清楚传输回<a class="ae kl" href="http://medium.com/_/batch" rel="noopener">medium.com/_/batch</a>端点的大量数据代表什么，我当时计划对向该端点发出的请求执行重放攻击，只修改时间戳数据，使其与重放攻击发起的时间相关(可能是我最初捕获向该端点发出的所有请求后的几天)。</p><p id="9686" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因为我不想将我所有的cookies复制粘贴到我正在编写的python脚本中来执行我的重放攻击。在加载网页后，我尝试清除浏览器中的所有cookie，即使没有任何cookie存在并被传输到<a class="ae kl" href="http://medium.com/_/batch" rel="noopener">medium.com/_/batch</a>我仍然能够获得合作伙伴计划收益。然后，我试图分析请求JSON数据，看看我是否可以简单地一次生成任意持续时间的会话所需的所有post请求数据(实际上是一大堆页面滚动事件)，并一次性将其传输到您的JSON端点medium.com/_/batch T2 T3。(这将允许我自动测试不同长度的会话)。不幸的是，这没有奏效。</p><p id="17ed" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我最初认为，这是因为服务器可能会验证传输时间，以阻止某人在他们不是会员的一段时间内(比如未来几个月或过去几个月)为作者创造潜在的合作伙伴计划收入。但是经过更多的实验(在正确的时间和不同的负载下发送请求),我认为最有可能的解释是，JSON负载中的eventID是某种包含用户ID和页面查看日期的散列，因为eventID中确实存在一种模式，因为ID的前4个字母对于来自相同用户ID和日期的请求来说似乎是相同的。由于代码混淆，我无法弄清楚这些用户标识是如何生成的。</p><h1 id="e33a" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">发现漏洞</h1><p id="7d5a" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">就在这个时候，我意识到除了作为请求有效载荷中每个json对象的一部分的userID之外，没有任何用户独有的东西被传输给<a class="ae kl" href="http://medium.com/_/batch" rel="noopener">medium.com/_/batch</a>(如上图所示)。修改用户ID本身并不能让我获得合作伙伴计划收入。(请记住，无论您从端点请求什么，它都会以“成功”作为响应:真。)所以我在黑暗中试错，试图找出端点是如何认证这些请求的。我相信这是因为我不知道如何计算有效的EventIds(这只是我认为需要做的一件事，我不知道这些id是否代表任何超出随机的字母和数字字符串的东西)。我最初尝试在网站的主HTML文件中使用查找和替换功能，用我拥有的另一个付费帐户的用户ID替换我当前的用户id，然后尝试调用窗口初始化时调用的JS函数。不幸的是，这并没有让我去任何地方，因为medium.com的代码混淆对我来说太激进了，以至于我无法理解发生了什么。我的下一个计划是使用类似MITMProxy的Python库对我自己发起中间人攻击，这将允许我在数据到达我的web浏览器之前的传输过程中找到并替换我的userID，替换为我想模仿的人之一。</p><h1 id="6a82" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">幸运</h1><p id="0f5b" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">我决定尝试为一篇文章的主HTML页面的请求更改请求UID cookie值。令我惊讶的是，medium.com<a class="ae kl" href="http://medium.com/" rel="noopener">在确认会话cookie和uid cookie代表有效的登录会话之前，将UID cookie值作为JSON数据嵌入到网页中。尽管网页正确地将我的uid/会话cookie识别为无效；它仍然会将来自请求cookie的UID数据嵌入到网页中。在响应中，它发回“set-cookie”标头，其中包含以“lo_”开头的新会话UID的信息。因此，无论主web页面请求使用什么UID cookie值，所有批处理请求(您的api端点)都将使用该值作为“UserId”。这里有一个例子，我把用户标识改成了“Hello World”</a></p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi mf"><img src="../Images/0918d444f4293d21ac59dc89fb6b5742.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fY1p1qJP0LjSH90hioKEwg.png"/></div></div><figcaption class="mb mc gj gh gi md me bd b be z dk translated">这是/_/batch端点的请求有效负载，我随机展开了2个数组项</figcaption></figure><p id="ce08" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我还发现找到用户ID非常容易，你只需导航到他们的个人资料，在网页的HTML代码中搜索“{\"ID\ ":”就可以找到他们的用户id，你会看到<a class="ae kl" href="https://medium.com/@NetflixTechBlog" rel="noopener">网飞科技博客</a>的用户id是:“c3aeaf49d8a4”(顺便说一下，这些用户id是公开的)</p><p id="7294" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以现在如果你把你的UID cookie改成一个付费用户，然后加载你在medium上写的一篇文章，Medium就会用别人的userID把数据传输到它的<a class="ae kl" href="https://medium.com/_/batch" rel="noopener"> /_/batch </a>端点。在这一点上，如果你阅读这篇文章，它将为作者创造收入。Medium不会验证userID值，只是假设它们是正确的。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div class="gh gi mg"><img src="../Images/d620f5adfc2ad229cf9cba85539f2238.png" data-original-src="https://miro.medium.com/v2/resize:fit:904/format:webp/1*1ksDgzDQI4CIrLj1F76nnQ.png"/></div><figcaption class="mb mc gj gh gi md me bd b be z dk translated"><a class="ae kl" href="https://medium.com/@mohammad_ali/vzqwfvjhhkzkrwfnbswp-d0bdd6a361d4" rel="noopener">如果你想看的话，这里有篇文章</a></figcaption></figure><p id="6e8f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我可以在一天之内通过模仿10个人赚到34美分。很明显，我不想过度测试这个概念，因为我不想让媒体认为我有恶意。在写这些之前，我首先通过他们的bug bounty程序报告了这个bug。</p><h1 id="54ed" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">结论</h1><ul class=""><li id="80af" class="mh mi iq jp b jq lk ju ll jy mj kc mk kg ml kk mm mn mo mp bi translated">总之，我发现会员阅读时间似乎与合作伙伴计划收入没有关系。(参考上图)</li><li id="e212" class="mh mi iq jp b jq mq ju mr jy ms kc mt kg mu kk mm mn mo mp bi translated">我们了解到，medium.com会将你发送给他们的任何用户标识cookie值嵌入到他们的网页中(这是他们尚未解决的问题)。</li><li id="5f5f" class="mh mi iq jp b jq mq ju mr jy ms kc mt kg mu kk mm mn mo mp bi translated">我们了解到，媒体合作伙伴计划端点并不验证用户是否拥有有效的登录会话，而是盲目地接受用户id并假设它们是正确的。</li><li id="018a" class="mh mi iq jp b jq mq ju mr jy ms kc mt kg mu kk mm mn mo mp bi translated">此外，我们不知道我是否是第一个发现此漏洞的人，Medium partner程序的作者可能被骗走了未知金额的钱，因为他们可能已经与利用此漏洞的人分享了他们的收入。</li></ul><h1 id="ca07" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">雇用我</h1><p id="9240" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">请随时通过电子邮件联系我:Mohammad-Ali@Bandzar.com</p></div></div>    
</body>
</html>