<html>
<head>
<title>Bypassing WAF to perform XSS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">绕过晶圆执行XSS</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/bypassing-waf-to-perform-xss-2d2f5a4367f3?source=collection_archive---------0-----------------------#2020-05-28">https://infosecwriteups.com/bypassing-waf-to-perform-xss-2d2f5a4367f3?source=collection_archive---------0-----------------------#2020-05-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="a908" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最近我在寻找一些XSS，我来到一个网站(出于隐私原因，我们称它为website.com)，在那里有一个管理员登录表单在<strong class="jp ir"> /admin </strong>目录下。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi kl"><img src="../Images/abd1880cc4955a75383bc527b6b2e1d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1156/format:webp/1*5lFCUXubKJ_1ixLidAO0zg.png"/></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk translated">website.com/admin管理面板</figcaption></figure><p id="c024" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">出于本能，我尝试输入随机凭证，看看会得到什么样的响应。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi kx"><img src="../Images/684718a743ef4942c1a7269fdbf1238a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1116/format:webp/1*1BmIw1KTSCtx6onICZ34ug.png"/></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk translated">/admin/index.php？msg =无效的% 20电子邮件% 20和% 20密码</figcaption></figure><blockquote class="ky kz la"><p id="c6ac" class="jn jo lb jp b jq jr js jt ju jv jw jx lc jz ka kb ld kd ke kf le kh ki kj kk ij bi translated"><strong class="jp ir"> /admin/index.php？msg =无效的电子邮件和密码</strong></p></blockquote><p id="346a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是我被重定向到的URL，默认情况下，这是一个非常糟糕的显示错误消息的想法，但这是我在不同网站上看到的一个实现。</p><p id="4d95" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">的任意值<em class="lb">？msg= </em> </strong>可能会反映到网站中，所以让我们试着改变它以便更好地理解。</p><p id="bead" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我尝试的是website.com/admin/index.php?msg=Hello世界</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi lf"><img src="../Images/0065455f6a17d3cc2d68dcd9b225a25a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1082/format:webp/1*AkK3RwX5J0iBEZ2Hk21uhA.png"/></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk translated">？msg=Hello World被反射</figcaption></figure><p id="b64e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们看到，我们输入的每一个输入都反映在红色字体的文本中。</p><p id="51cf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果我尝试注入一些HTML标签呢？</p><blockquote class="ky kz la"><p id="6385" class="jn jo lb jp b jq jr js jt ju jv jw jx lc jz ka kb ld kd ke kf le kh ki kj kk ij bi translated"><strong class="jp ir">？msg =&lt;h1&gt;Hello World&lt;/h1&gt;</strong></p></blockquote><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi lg"><img src="../Images/fab4fd5c3b035421956592942d08b45b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1126/format:webp/1*jSHoRXnO1hXGwybabEV23w.png"/></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk translated">HTML注入</figcaption></figure><p id="f269" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们得到了一个成功的HTML注入，现在是时候放一些Javascript代码了。</p><p id="d28c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我尝试了50多种基本的XSS有效载荷，希望XSS弹出:</p><p id="4207" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">？msg= <script>预警(1) </script> <br/>？msg =&lt;img src = XSS on error = alert(1)&gt;<br/>？msg =&lt;input/onmouseover = " javaSCRIPT&amp;冒号；确认&amp;LPAR；1 &amp; rpar<br/>？msg =&lt;iframe % 00 src = "&amp;Tab；JavaScript:prompt(1)&amp;Tab；"%00 &gt;</p><p id="96df" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你知道我对所有类型的XSS人施暴。所有这些都被服务器屏蔽了，似乎幕后有一个WAF:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi lh"><img src="../Images/ade59bcb94b8fb19c096fda6480aeb7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zBRVo2Ajo5zYD-gmDzgE7w.png"/></div></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk translated">恶意XSS请求被WAF阻止</figcaption></figure><p id="26a1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通过输入50多个XSS有效载荷，我得出了WAF真正过滤的是什么的结论:</p><blockquote class="ky kz la"><p id="c898" class="jn jo lb jp b jq jr js jt ju jv jw jx lc jz ka kb ld kd ke kf le kh ki kj kk ij bi translated">每一个带有<strong class="jp ir"> &lt;脚本&gt;、&lt;帧、&lt;输入、&lt;表单、</strong>的有效载荷都被WAF直接屏蔽。<br/>每一个<strong class="jp ir"> alert( ) </strong>的有效载荷都被WAF直接封锁。</p></blockquote><p id="8f61" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">那么，当alert()被过滤掉时，我们如何弹出一个XSS呢？</p><p id="14d4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一边猜，一边意识到<img wasn="" filtered="" out="" so="" i="" start="" making="" more="" complex="" payload="" based="" on="" that:=""/></p><blockquote class="ky kz la"><p id="b61f" class="jn jo lb jp b jq jr js jt ju jv jw jx lc jz ka kb ld kd ke kf le kh ki kj kk ij bi translated"><strong class="jp ir">？msg =&lt;img/src = ` % 00 `% 20 on error = this . on error = confirm(1)</strong></p></blockquote><p id="312a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">是我的下一个有效载荷，它得到了反映，但没有XSS:(</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi lm"><img src="../Images/4682c2029c93b06c8fef9b823f43e531.png" data-original-src="https://miro.medium.com/v2/resize:fit:1078/format:webp/1*v7bT00oMPvyuR34e0XpM_g.png"/></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk translated"><img bypassed="" but="" no="" xss=""/></figcaption></figure><p id="c0dc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Seems like XSS by image isn’t the right path so I kept enumerating more, since it gets reflected, but it doesn’t execute anything inside it.</p><p id="c54b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Soon, I realised that <strong class="jp ir"><em class="lb">&lt;SVG&gt;</em></strong>没有被过滤掉，所以我一直沿着这条路径走。由于alert()被阻止，我正在尝试confirm()，因为它起作用了。</p><blockquote class="ky kz la"><p id="596e" class="jn jo lb jp b jq jr js jt ju jv jw jx lc jz ka kb ld kd ke kf le kh ki kj kk ij bi translated"><strong class="jp ir"> &lt; svg &gt; &lt;脚本%20？&gt;确认(1) </strong></p></blockquote><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi ln"><img src="../Images/d4a223b3bd08dc38979232bbd86e4e4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1106/format:webp/1*nu1yamkE9B4SAuembW1uNg.png"/></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk translated">svg已注入，但没有XSS弹出窗口</figcaption></figure><p id="d4ad" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我有一种感觉，我很接近了，因为它反映了一个空白的空间，我只是必须继续前进。由于有WAF，我尝试了不同的旁路，包括Base64 decode with<em class="lb">eval . atob</em>。我一直使用<strong class="jp ir"> <em class="lb"> &lt; svg &gt; </em> </strong>，因为它在某种程度上有效。</p><blockquote class="ky kz la"><p id="fb0e" class="jn jo lb jp b jq jr js jt ju jv jw jx lc jz ka kb ld kd ke kf le kh ki kj kk ij bi translated"><strong class="jp ir">&lt;【SVG/onload = eval(atob(' ywxlcnqoj 1 htuycp ')】&gt;</strong></p></blockquote><p id="3e8b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个有效载荷主要解码base64值，即<strong class="jp ir">alert(‘XSS’)</strong>。我立即启动了有效载荷，猜猜我看到了什么，一架XSS！！！</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi lo"><img src="../Images/0fcdb04577d82545939a8179be595f10.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zAhwn7SNIshemvFPKOmzXQ.png"/></div></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk translated">终于有XSS了！！！</figcaption></figure><p id="f569" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将XSS的有效载荷(被WAF过滤掉)编码成base64，这真的给了我执行任何我想做的事情的自由。</p><blockquote class="ky kz la"><p id="d107" class="jn jo lb jp b jq jr js jt ju jv jw jx lc jz ka kb ld kd ke kf le kh ki kj kk ij bi translated"><strong class="jp ir">&lt;【SVG/onload = eval(atob(' ywxlcnqozg 9 jdw 1 lbnquy 29 va 2 llqq = = ')&gt;</strong></p></blockquote><p id="bcbd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面的base64是alert(document.cookie ),它按预期运行。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi lp"><img src="../Images/4e6a4b6715f4cb9174815ae67a600765.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y2X65_HrfNB5M6kF9ezSTg.png"/></div></div></figure><p id="6be7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，我可以自由地执行我想做的任何事情，因为所有的东西都是以Base64编码的，不会被WAF检测到，这是每个人都想要的！此外，这个XSS花了我20分钟，但它对我来说更像是一个有趣的挑战。</p></div></div>    
</body>
</html>