<html>
<head>
<title>Secure Code Review -1 | Cheat sheet For Security Vulnerability In Python — Injection Flaws</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">安全代码审查-1 | Python中安全漏洞的备忘单—注入缺陷</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/secure-code-review-1-cheat-sheet-for-security-vulnerability-in-python-injection-flaws-15c93b9d754f?source=collection_archive---------2-----------------------#2022-05-25">https://infosecwriteups.com/secure-code-review-1-cheat-sheet-for-security-vulnerability-in-python-injection-flaws-15c93b9d754f?source=collection_archive---------2-----------------------#2022-05-25</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="d088" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">基于OWASP十大漏洞。这次我们要寻找与注入缺陷相关的安全编码错误</p><h2 id="8172" class="ko kp it bd kq kr ks dn kt ku kv dp kw kb kx ky kz kf la lb lc kj ld le lf lg bi translated">1)路径遍历攻击</h2><ul class=""><li id="82c1" class="lh li it js b jt lj jx lk kb ll kf lm kj ln kn lo lp lq lr bi translated"><strong class="js iu">易受攻击的代码块</strong></li></ul><pre class="ls lt lu lv gt lw lx ly lz aw ma bi"><span id="b92a" class="ko kp it lx b gy mb mc l md me"><strong class="lx iu">def get_video(self, path=None):</strong><br/>  self.check_user_auth()<br/>  data = None<br/>  if not path:<br/>   path = self.get_video_path()<br/>   path = path[0] if path else None<br/>  if path:<br/>   with open(path, 'rb') as f:<br/>   data = bytearray(f.read())<br/>  return data</span></pre><ul class=""><li id="f886" class="lh li it js b jt ju jx jy kb mf kf mg kj mh kn lo lp lq lr bi translated"><strong class="js iu">冲击</strong></li></ul><p id="7668" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">允许用户将视频路径作为参数传递会使其容易受到路径遍历注入的攻击。对手可以通过操纵路径访问服务器上的任何文件(<code class="fe mi mj mk lx b">get_video('/etc/passwd')</code>)。</p><ul class=""><li id="4c8b" class="lh li it js b jt ju jx jy kb mf kf mg kj mh kn lo lp lq lr bi translated"><strong class="js iu">修复</strong></li></ul><p id="1591" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">建议避免使用不可信的输入来构建文件的路径。应用程序正在服务器端构建<code class="fe mi mj mk lx b">path</code>参数，而不是信任输入值。这样，攻击者将无法通过操纵输入参数来执行路径遍历攻击。</p><pre class="ls lt lu lv gt lw lx ly lz aw ma bi"><span id="cfe1" class="ko kp it lx b gy mb mc l md me">def get_video(self):<br/> self.check_user_auth()<br/> data = None<br/> path = self.get_video_path()<br/> if path:<br/>  with open(path[0], 'rb') as f:<br/>  data = bytearray(f.read())<br/> return data</span></pre><h2 id="2241" class="ko kp it bd kq kr ks dn kt ku kv dp kw kb kx ky kz kf la lb lc kj ld le lf lg bi translated">2)操作系统命令注入</h2><ul class=""><li id="749c" class="lh li it js b jt lj jx lk kb ll kf lm kj ln kn lo lp lq lr bi translated"><strong class="js iu">易受攻击的代码块</strong></li></ul><pre class="ls lt lu lv gt lw lx ly lz aw ma bi"><span id="0a3d" class="ko kp it lx b gy mb mc l md me">def insert_from_yaml(self, client_yaml):</span><span id="2204" class="ko kp it lx b gy ml mc l md me">client = yaml.safe_load(<strong class="lx iu">os.popen('cat %s' % client_yaml))</strong></span><span id="16e2" class="ko kp it lx b gy ml mc l md me">if type(client) is not dict:<br/>            e = ValueError('File %s could not be loaded.' % client_yaml)<br/>            logger.error('%s' % e)<br/>            raise e</span><span id="a706" class="ko kp it lx b gy ml mc l md me">number = client.get('number')<br/>        if number:<br/>            number = self.hasher.encode(number, self.hasher.salt())</span><span id="d02f" class="ko kp it lx b gy ml mc l md me">try:<br/>            conn = Connect()<br/>            cursor = conn.db.cursor()<br/>            cursor.execute(<br/>                """<br/>                INSERT INTO client (username, password,<br/>                    firstname, lastname, number, email_val, description_val)<br/>                    VALUES (%(username)s, %(password)s, %(firstname)s,<br/>                            %(lastname)s, %(number)s, %(email_val)s,<br/>                            %(description_val)s)<br/>                """,<br/>                {<br/>                    'username': client.get('username'),<br/>                    'password': self.hasher.encode(<br/>                        client.get('password'), self.hasher.salt()),<br/>                    'firstname': client.get('firstname'),<br/>                    'lastname': client.get('lastname'),<br/>                    'number': number,<br/>                    'email_val': client.get('email_val'),<br/>                    'description_val': client.get('description_val')<br/>                }<br/>            )<br/>            conn.db.commit()<br/>            logger.info('Client %02d inserted' % cursor.lastrowid)<br/>        except MySQLError as e:<br/>            logger.error('Could not insert client: %s' % e)<br/>        finally:<br/>            conn.db.close()</span><span id="6b48" class="ko kp it lx b gy ml mc l md me">def delete(self, client_id):<br/>        try:<br/>            conn = Connect()<br/>            result = conn.db.cursor().execute(<br/>                """<br/>                DELETE FROM client WHERE id=%(id)s<br/>                """, {'id': client_id}<br/>            )<br/>            conn.db.commit()<br/>            if result:<br/>                logger.warning('Client id %02d deleted' % client_id)<br/>            else:<br/>                logger.warning('Client does not exist')<br/>        except MySQLError as e:<br/>            logger.error('Could not delete client: %s' % e)<br/>        finally:<br/>            conn.db.close()</span></pre><ul class=""><li id="3227" class="lh li it js b jt ju jx jy kb mf kf mg kj mh kn lo lp lq lr bi translated">影响</li></ul><p id="6425" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">使用未初始化的输入值作为操作系统命令调用中的参数，可能会允许攻击者注入恶意的操作系统命令，从而在运行应用程序的服务器中执行未经授权的操作。</p><ul class=""><li id="6e2c" class="lh li it js b jt ju jx jy kb mf kf mg kj mh kn lo lp lq lr bi translated">固定</li></ul><p id="c413" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">建议避免在OS命令调用中使用未初始化的输入参数。此外，使用语言库来执行操作比调用系统级命令更安全。Python应用程序使用<code class="fe mi mj mk lx b">open</code>方法读取文件，而不是调用操作系统命令<code class="fe mi mj mk lx b">cat</code>。通过这种方式，由于没有操作系统命令调用，因此降低了注入风险。</p><pre class="ls lt lu lv gt lw lx ly lz aw ma bi"><span id="e5c0" class="ko kp it lx b gy mb mc l md me">def insert_from_yaml(self, client_yaml):</span><span id="173e" class="ko kp it lx b gy ml mc l md me">client = yaml.safe_load(os.popen('cat %s' % client_yaml))<br/>with open(client_yaml, 'r') as stream:<br/>    client = yaml.safe_load(stream)</span><span id="bb58" class="ko kp it lx b gy ml mc l md me">if type(client) is not dict:<br/>            e = ValueError('File %s could not be loaded.' % client_yaml)<br/>            logger.error('%s' % e)<br/>            raise e</span><span id="eb09" class="ko kp it lx b gy ml mc l md me">number = client.get('number')<br/>        if number:<br/>            number = self.hasher.encode(number, self.hasher.salt())</span><span id="0528" class="ko kp it lx b gy ml mc l md me">try:<br/>            conn = Connect()<br/>            cursor = conn.db.cursor()<br/>            cursor.execute(<br/>                """<br/>                INSERT INTO client (username, password,<br/>                    firstname, lastname, number, email_val, description_val)<br/>                    VALUES (%(username)s, %(password)s, %(firstname)s,<br/>                            %(lastname)s, %(number)s, %(email_val)s,<br/>                            %(description_val)s)<br/>                """,<br/>                {<br/>                    'username': client.get('username'),<br/>                    'password': self.hasher.encode(<br/>                        client.get('password'), self.hasher.salt()),<br/>                    'firstname': client.get('firstname'),<br/>                    'lastname': client.get('lastname'),<br/>                    'number': number,<br/>                    'email_val': client.get('email_val'),<br/>                    'description_val': client.get('description_val')<br/>                }<br/>            )<br/>            conn.db.commit()<br/>            logger.info('Client %02d inserted' % cursor.lastrowid)<br/>        except MySQLError as e:<br/>            logger.error('Could not insert client: %s' % e)<br/>        finally:<br/>            conn.db.close()</span><span id="7175" class="ko kp it lx b gy ml mc l md me">def delete(self, client_id):<br/>        try:<br/>            conn = Connect()<br/>            result = conn.db.cursor().execute(<br/>                """<br/>                DELETE FROM client WHERE id=%(id)s<br/>                """, {'id': client_id}<br/>            )<br/>            conn.db.commit()<br/>            if result:<br/>                logger.warning('Client id %02d deleted' % client_id)<br/>            else:<br/>                logger.warning('Client does not exist')<br/>        except MySQLError as e:<br/>            logger.error('Could not delete client: %s' % e)<br/>        finally:<br/>            conn.db.close()</span></pre><h2 id="ab54" class="ko kp it bd kq kr ks dn kt ku kv dp kw kb kx ky kz kf la lb lc kj ld le lf lg bi translated">操作系统命令注入</h2><ul class=""><li id="97bd" class="lh li it js b jt lj jx lk kb ll kf lm kj ln kn lo lp lq lr bi translated">易受攻击代码块</li></ul><pre class="ls lt lu lv gt lw lx ly lz aw ma bi"><span id="5ac2" class="ko kp it lx b gy mb mc l md me">class ProviderJSON(Provider):<br/> """Provider JSON operations"""<br/> def insert_from_url(self, json_url):<br/> o = urlparse(json_url)<br/> # JSON URL validation<br/>  if not (o.scheme == 'https' and o.hostname in ALLOWED_HOSTS):<br/>   logger.error('JSON URL host is not allowed')<br/>   return<br/>  providers = []<br/>  BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))<br/>  json_file = os.path.join(BASE_DIR, '_provider.json')<br/>  # GET providers list from JSON URL</span><span id="c1fa" class="ko kp it lx b gy ml mc l md me">try:<br/>   <strong class="lx iu">os.system('wget -O %s %s' % (json_file, json_url))</strong><br/>   with open(json_file) as f:<br/>   providers = json.load(f)<br/>   os.remove(json_file)<br/>  except Exception as e:<br/>   logger.error('Could not GET the JSON URL - %s' % e)<br/>   raise e<br/>   # Insert Providers JSON list<br/>  self.insert(providers)</span></pre><ul class=""><li id="6932" class="lh li it js b jt ju jx jy kb mf kf mg kj mh kn lo lp lq lr bi translated">影响</li></ul><p id="9258" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">使用os.system执行os命令来下载文件会使应用程序容易受到OS命令注入攻击。对手可以用恶意表达式(例如，URL；rm -fr /)在生产服务器中执行。</p><ul class=""><li id="064a" class="lh li it js b jt ju jx jy kb mf kf mg kj mh kn lo lp lq lr bi translated">固定</li></ul><p id="df36" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了减轻操作系统命令注入攻击，程序不得执行来自不可信来源的操作系统命令输入来读取文件。</p><pre class="ls lt lu lv gt lw lx ly lz aw ma bi"><span id="3ce7" class="ko kp it lx b gy mb mc l md me">class ProviderJSON(Provider):<br/> """Provider JSON operations"""<br/> def insert_from_url(self, json_url):<br/> o = urlparse(json_url)<br/> # JSON URL validation<br/>  if not (o.scheme == 'https' and o.hostname in ALLOWED_HOSTS):<br/>   logger.error('JSON URL host is not allowed')<br/>   return<br/>  providers = []<br/>  BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))<br/>  json_file = os.path.join(BASE_DIR, '_provider.json')<br/>  # GET providers list from JSON URL</span><span id="1cc5" class="ko kp it lx b gy ml mc l md me">try:<br/>      r = requests.get(o.geturl())<br/>   providers = r.json()<br/>  except Exception as e:<br/>   logger.error('Could not GET the JSON URL - %s' % e)<br/>   raise e<br/>   # Insert Providers JSON list<br/>  self.insert(providers)</span></pre><h1 id="8759" class="mm kp it bd kq mn mo mp kt mq mr ms kw mt mu mv kz mw mx my lc mz na nb lf nc bi translated">参考:</h1><ul class=""><li id="1185" class="lh li it js b jt lj jx lk kb ll kf lm kj ln kn lo lp lq lr bi translated"><a class="ae nd" href="https://www.owasp.org/index.php/Path_Traversal" rel="noopener ugc nofollow" target="_blank">https://www.owasp.org/index.php/Path_Traversal</a></li><li id="5db0" class="lh li it js b jt ne jx nf kb ng kf nh kj ni kn lo lp lq lr bi translated"><a class="ae nd" href="https://www.securecodewarrior.com/showcase/developer/path-traversal/learn-the-basics" rel="noopener ugc nofollow" target="_blank">https://www . securecodewarrior . com/showcase/developer/path-traversal/learn-the-basics</a></li></ul></div></div>    
</body>
</html>