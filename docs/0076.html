<html>
<head>
<title>Bypass CSP by Abusing XSS Filter in Edge</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过在Edge中滥用XSS滤波器绕过CSP</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/bypass-csp-by-abusing-xss-filter-in-edge-43e9106a9754?source=collection_archive---------0-----------------------#2018-04-15">https://infosecwriteups.com/bypass-csp-by-abusing-xss-filter-in-edge-43e9106a9754?source=collection_archive---------0-----------------------#2018-04-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="b966" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本文中，我将分享我在2016年12月发现的微软Edge中的一个内容安全策略(CSP)绕过漏洞。这种绕过是通过滥用浏览器的XSS过滤器实现的。这非常具有讽刺意味，因为XSS滤波器和CSP都是为了保护用户免受XSS攻击而设计的，但该漏洞允许攻击者滥用一种XSS保护机制来绕过另一种。</p><p id="b9cb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">XSS过滤器是在IE 8中首次推出的。XSS滤波器的目的是减轻反射XSS攻击。IE/Edge的XSS过滤器大致是这样工作的:当浏览器加载一个URL时，XSS过滤器首先使用一组预定义的正则表达式检查URL的一些参数是否可能包含XSS有效载荷。例如，<code class="fe kl km kn ko b">http://example.com/index.php?id=100</code>显然是无害的，但是对于像<code class="fe kl km kn ko b">http://example.com/index.php?id=&lt;script&gt;alert(1)&lt;/script&gt;</code>这样的URL，参数<code class="fe kl km kn ko b">id </code>的值可能是XSS有效载荷。然后，为了准确判断是否是反射XSS攻击，IE/Edge检查返回的HTML是否包含子串<code class="fe kl km kn ko b">&lt;script&gt;alert(1)&lt;/script&gt;</code> <em class="kp">。</em>如果是的话，IE/Edge假设它是从<code class="fe kl km kn ko b">id</code>参数中反映出来的。注意，这个假设可能不成立:如果<code class="fe kl km kn ko b">&lt;script&gt;alert(1)&lt;/script&gt;</code>被硬编码在页面中，而<code class="fe kl km kn ko b">id</code>参数实际上没有任何作用，那该怎么办？</p><p id="376c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">XSS滤波器有两种模式:默认模式和阻塞模式。站点可以通过设置HTTP header:X-XSS-保护:1来启用阻止模式；模式=块”。在block模式下，IE/Edge会阻止整个HTML的渲染。在默认模式下，IE/Edge试图通过修改相应的HTML标签来破坏XSS的有效载荷。例如，如果Edge假设<code class="fe kl km kn ko b">&lt;script&gt;alert(1)&lt;/script&gt;</code>是一个XSS，它会将该元素更改为<code class="fe kl km kn ko b">&lt;sc#ipt&gt;alert(1)&lt;/script&gt;</code>。因此，DOM解析器不会将这个片段解析为一个&lt;脚本&gt;元素，所以它不会执行。</p><p id="9c26" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们来看看漏洞，<a class="ae kq" href="https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2017-0135" rel="noopener ugc nofollow" target="_blank">CVE-2017–0135</a>。网站设置内容安全策略有两种方式:通过Content-Security-Policy HTTP response头字段，或者通过&lt; meta &gt;标签。这种元元素的一个例子是:<br/> <code class="fe kl km kn ko b">&lt;meta http-equiv=”Content-Security-Policy” content=”script-src ‘self’”&gt;</code>。现在假设这是URL http://example.com/xss.html:的HTML</p><pre class="kr ks kt ku gt kv ko kw kx aw ky bi"><span id="a2cb" class="kz la iq ko b gy lb lc l ld le">&lt;!DOCTYPE html&gt;<br/>&lt;html&gt;<br/> &lt;head&gt;<br/> &lt;title&gt;CSP Test&lt;/title&gt;<br/>  &lt;meta http-equiv="Content-Security-Policy" content="script-src 'self'"&gt;<br/> &lt;/head&gt;<br/> &lt;body&gt;<br/> &lt;script&gt;alert(document.domain);&lt;/script&gt;<br/> &lt;/body&gt;<br/>&lt;/html&gt;</span></pre><p id="53fa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">CSP应该阻止<code class="fe kl km kn ko b">alert(document.domain)</code>执行。为了绕过CSP，让我们要求用户访问<code class="fe kl km kn ko b">http://example.com/xss.html?&lt;meta http-equiv=”Content-Security-Policy” content=”script-src ‘self’”&gt;</code>(只需将meta元素作为参数添加到URL中。)</p><p id="29a7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，默认情况下，Edge的XSS过滤器简单地将meta标签修改为<code class="fe kl km kn ko b">&lt;me#a http-equiv=”Content-Security-Policy” content=”script-src ‘self’”&gt;</code>，这会杀死CSP，alert就会执行。</p><figure class="kr ks kt ku gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi lf"><img src="../Images/3a68f957201a339fba54ffae2a3b23a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*s7fN-IG6aiUARx3ClTSWrw.png"/></div></div><figcaption class="ln lo gj gh gi lp lq bd b be z dk translated">图1成功绕过CSP的屏幕截图</figcaption></figure><p id="3eb0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2017年3月发布的<a class="ae kq" href="https://technet.microsoft.com/library/security/MS17-007" rel="noopener ugc nofollow" target="_blank"> MS17-007 </a>中修复了该漏洞。已分配<a class="ae kq" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-0135" rel="noopener ugc nofollow" target="_blank"> CVE-2017-0135 </a>。<br/> <br/>当XSS过滤器检测到查询字符串与任何元元素匹配时，无论模式如何，都会阻止整个HTML页面，从而解决这个问题。</p><p id="f760" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">虽然这个漏洞已经被修复，但是设置“X-XSS-保护:1；模式=块”。此外，通过HTTP报头传递的CSP策略不易受到这种绕过攻击。</p></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><p id="097a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">时间线</strong></p><ul class=""><li id="9336" class="ly lz iq jp b jq jr ju jv jy ma kc mb kg mc kk md me mf mg bi translated">2016年12月2日:向MSRC报告的漏洞</li><li id="58b3" class="ly lz iq jp b jq mh ju mi jy mj kc mk kg ml kk md me mf mg bi translated">2017年3月14日:MS17–007中修复的漏洞(漏洞奖金:1500美元)</li></ul></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><p id="7be7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">参考文献</strong></p><ul class=""><li id="0c27" class="ly lz iq jp b jq jr ju jv jy ma kc mb kg mc kk md me mf mg bi translated">Nava，E. V .和Lindsay，d .“<a class="ae kq" href="http://p42.us/ie8xss/Abusing_IE8s_XSS_Filters.pdf" rel="noopener ugc nofollow" target="_blank">滥用Internet Explorer 8的XSS过滤器</a></li><li id="05e3" class="ly lz iq jp b jq mh ju mi jy mj kc mk kg ml kk md me mf mg bi translated">W3C，"<a class="ae kq" href="https://www.w3.org/TR/CSP2/" rel="noopener ugc nofollow" target="_blank">内容安全策略级别2 </a>"</li><li id="d968" class="ly lz iq jp b jq mh ju mi jy mj kc mk kg ml kk md me mf mg bi translated"><a class="ae kq" href="https://blogs.technet.microsoft.com/srd/2008/08/19/ie-8-xss-filter-architecture-implementation/" rel="noopener ugc nofollow" target="_blank"> IE 8 XSS滤波器架构/实现</a></li></ul></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><p id="4514" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">致谢</strong></p><ul class=""><li id="e379" class="ly lz iq jp b jq jr ju jv jy ma kc mb kg mc kk md me mf mg bi translated">非常感谢MSRC修复了这个错误并给了我奖金。</li><li id="7a19" class="ly lz iq jp b jq mh ju mi jy mj kc mk kg ml kk md me mf mg bi translated">本文最初发表于中文网站FreeBuf，链接:【http://www.freebuf.com/articles/web/164871.html】T21。我要感谢他们允许我在Medium上发布英文版。</li></ul></div></div>    
</body>
</html>