<html>
<head>
<title>How a badly configured DB allowed us to own an entire cloud of over 25K hosts (1/2)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">一个配置糟糕的数据库是如何让我们拥有超过25，000台主机的整个云的(1/2)</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/how-a-badly-configured-db-allowed-us-to-own-an-entire-cloud-of-over-25k-hosts-part-1-2-8846beab691e?source=collection_archive---------1-----------------------#2020-09-01">https://infosecwriteups.com/how-a-badly-configured-db-allowed-us-to-own-an-entire-cloud-of-over-25k-hosts-part-1-2-8846beab691e?source=collection_archive---------1-----------------------#2020-09-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="2a94" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://medium.com/bugbountywriteup/how-a-badly-configured-db-allowed-us-to-own-an-entire-cloud-of-over-25k-hosts-part-2-2-5a63da194bc1" rel="noopener">链接到第2部分</a></p><h1 id="4bae" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">介绍</h1><p id="3352" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">在这篇文章中，我们将了解如何将数据库的直接sqlmap连接与BMC/IPMI利用相结合，从而危及大型云托管客户端的安全。</p><h1 id="9d32" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">获得立足点</h1><p id="7788" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">几年前，我们的团队负责在Openstack网络中执行基础设施pentest。它由大约2000台物理服务器组成，托管超过25000个虚拟实例。我们在一个不允许大量出站流量的小子网中开始了pentest。在快速的Nmap扫描后，我们无法找到任何简单的漏洞来利用，所以我们开始研究我们可用的服务。其中，我们发现了一个公开的PostgreSQL服务器，托管在一个开发服务器中。在用公司名称的多个派生创建了一个自定义单词列表后，我们能够用相对简单的凭证登录。用户名是Postgres，为了保护这家公司的匿名性，我们假设密码是“admin”。</p><p id="2889" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们继续使用sqlmap(【https://github.com/sqlmapproject/sqlmap】T2)。创建这个工具是为了利用SQL注入，但是在建立到数据库的直接连接时(如果您有凭证)，它也可以为您提供几个选项。其中一个选项是在被利用的数据库上启动命令外壳。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi lp"><img src="../Images/c11f3461a94ee86daf9a2762749eb399.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fQCQawmmn7ow6dZuoAHCog.jpeg"/></div></div></figure><p id="3d9c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在测试外壳后，我们决定组装一个定制的有效载荷，以便接收一个反向的外壳，让玩具工作起来更舒服。</p><p id="e053" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为此，我们开始用msfvenom组装有效载荷。在本例中，有效负载是一个反向TCP shell，用于x64 Linux机器(您可以看到我们必须在前面的映像中选择DB架构)。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi mb"><img src="../Images/c1c11f9b0601ee568e81e652727157da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6U-njThYNnVmlQVzHw0-dQ.jpeg"/></div></div><figcaption class="mc md gj gh gi me mf bd b be z dk translated">把有效载荷和msfvenom放在一起</figcaption></figure><p id="7b7b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用这个有效负载的一个优点是，您可以用一个简单的Netcat接收连接。大多数其他有效负载需要类似Metasploit的exploit/multi/handler模块来接收反向连接。</p><p id="9e5f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在使用sqlmap shell运行有效负载之后，我们从服务器获得了连接。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi mg"><img src="../Images/fde7ddbb8afe11d42eeae54c38596687.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FR3saBrSEf0B5By5YKt2hg.jpeg"/></div></div><figcaption class="mc md gj gh gi me mf bd b be z dk translated">运行有效负载</figcaption></figure><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div class="gh gi mh"><img src="../Images/a81946f5f897210b1b4311fe3ab6bc34.png" data-original-src="https://miro.medium.com/v2/resize:fit:1274/format:webp/1*GhMsrDqlb34crHucrejZgA.jpeg"/></div><figcaption class="mc md gj gh gi me mf bd b be z dk translated">接收连接返回，并测试访问。</figcaption></figure><h1 id="b406" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">利用BMC设备</h1><p id="4370" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">每当您在进行基础设施测试时，如果您在网络的新网段中危及了一台机器，您应该重新进行扫描，以检查是否有新的可见性。这个数据库允许我们访问公司的云网络，包括大多数虚拟化实例以及主机。我们真的很兴奋得到新的扫描结果，并看到其中的多个BMC设备。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi mi"><img src="../Images/bf9b268e0a3a95f7fbb4ee9dc253e36b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rnzTGAhtkM53_EL_bIm08A.png"/></div></div><figcaption class="mc md gj gh gi me mf bd b be z dk translated">这是我们可以买到的三种不同品牌的BMC设备之一</figcaption></figure><p id="44cb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">BMC(基板管理控制器)基本上是一种嵌入式设备，连接到主服务器，为您提供带外监控。所有大型硬件提供商都为其产品定制了BMC，您可以列出</p><ul class=""><li id="0e5d" class="mj mk iq jp b jq jr ju jv jy ml kc mm kg mn kk mo mp mq mr bi translated">戴尔DRAC公司</li><li id="120c" class="mj mk iq jp b jq ms ju mt jy mu kc mv kg mw kk mo mp mq mr bi translated">IBM IMM公司</li><li id="89e0" class="mj mk iq jp b jq ms ju mt jy mu kc mv kg mw kk mo mp mq mr bi translated">惠普劳工组织</li><li id="93a2" class="mj mk iq jp b jq ms ju mt jy mu kc mv kg mw kk mo mp mq mr bi translated">超微IPMI</li></ul><p id="2bf7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">另一个你需要熟悉的术语，IPMI(智能平台管理接口)，基本上是你用来和这些设备通信的协议(<a class="ae kl" href="https://en.wikipedia.org/wiki/Intelligent_Platform_Management_Interface" rel="noopener ugc nofollow" target="_blank">https://en . Wikipedia . org/wiki/Intelligent _ Platform _ Management _ Interface</a>)。</p><p id="75da" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这么说吧，IPMI是迄今为止你能找到的最不安全的协议之一。给你一个想法，IPMI 2.0的设计方式是，你可以在认证阶段直接从服务器请求用户的散列(真的，查一下)。不仅如此，还有一个认证缺陷，你需要用“密码0”模式登录，这将允许你使用任何密码登录。你可以在这篇Rapid7帖子中找到许多更深入解释/利用的缺陷:<a class="ae kl" href="https://blog.rapid7.com/2013/07/02/a-penetration-testers-guide-to-ipmi/" rel="noopener ugc nofollow" target="_blank">https://blog . rapid 7 . com/2013/07/02/a-penetration-testers-guide-to-IPMI/</a></p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div class="gh gi mx"><img src="../Images/e1f0330a9a31f118268406f162c5edbf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/format:webp/1*DcjoAgEwjXO_XhUKYTtDNQ.png"/></div><figcaption class="mc md gj gh gi me mf bd b be z dk translated">IPMI·布洛克的建筑</figcaption></figure><p id="c186" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可能会发现BMC设备通常没有得到适当的保护，因为它们是那种您在构建数据中心时只设置一次的设备，然后在通过通常方式无法访问服务器时偶尔使用。</p><p id="2ea2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们能够轻松地对一些启用了密码0的设备进行身份验证:</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi my"><img src="../Images/a6a97fafb6fb3ff51d86ddcd8f6284b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aydSI5vOUH-CnOF1WnbPDA.png"/></div></div></figure><p id="eb86" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">丹·法默是BMC/IPMI相关漏洞研究的先驱。你可以在他的网站:【http://fish2.com/ipmi/cipherzero.html<a class="ae kl" href="http://fish2.com/ipmi/cipherzero.html" rel="noopener ugc nofollow" target="_blank"/>上阅读更多关于如何利用ipmitool工具开发cipher 0的信息。现在它似乎关闭了，但你可以随时阅读谷歌的缓存版本。不管怎样，这里你可以看到我们是如何用随机密码登录的。注意“-C 0”部分。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi mz"><img src="../Images/1d231e0020750039fc2c9722be2c4ab9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xgVPd2xwcAnUhOGiXUKNNw.png"/></div></div><figcaption class="mc md gj gh gi me mf bd b be z dk translated">使用随机密码成功登录设备</figcaption></figure><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div class="gh gi na"><img src="../Images/abfce65ec4cb29d30047da108054fd52.png" data-original-src="https://miro.medium.com/v2/resize:fit:1328/format:webp/1*pqkLyNf3JPO6tdlZvfW4aw.png"/></div><figcaption class="mc md gj gh gi me mf bd b be z dk translated">设备的网络信息</figcaption></figure><p id="910a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">即使某些设备没有启用cipher 0，您仍然可以通过其他方式登录。最常见的两种方法是使用默认凭证(系统管理员通常不会费心去更改)，或者利用散列泄露漏洞(然后破解散列)。对于大多数设备，我们不得不采用后者。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi nb"><img src="../Images/50fda6140dafd9f5f28c564c8b974c6f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IMuU8JibbjyEPYRfhwPWvQ.png"/></div></div><figcaption class="mc md gj gh gi me mf bd b be z dk translated">大多数制造商微不足道的违约信用</figcaption></figure><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/f0feab5a7dbab96e07030363fe4abdbf.png" data-original-src="https://miro.medium.com/v2/resize:fit:722/format:webp/1*T52WVgaRRYJUUdrZP8xRAA.png"/></div><figcaption class="mc md gj gh gi me mf bd b be z dk translated">包含我们将从服务器请求的用户散列的单词列表</figcaption></figure><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi nd"><img src="../Images/b8ae31b2d52e3f409a3f5da20995c8d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AEnWz6EbLfQ7Wc5IyQjC-w.png"/></div></div><figcaption class="mc md gj gh gi me mf bd b be z dk translated">使用metasploit公开用户散列</figcaption></figure><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi ne"><img src="../Images/29d34c1698be195175f544bb9f8e4359.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MQnLqlThhd38ip53jaRfDw.png"/></div></div><figcaption class="mc md gj gh gi me mf bd b be z dk translated">琐碎的散列被立即报告</figcaption></figure><p id="cb2b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在列举了所有的散列之后，我们开始破解它们</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi mb"><img src="../Images/900ada288589d97168140dc35c12c435.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JyQWK1GEI73M65b9_s1TZQ.png"/></div></div><figcaption class="mc md gj gh gi me mf bd b be z dk translated">破解第一个哈希</figcaption></figure><p id="bdd6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">几分钟后，我们访问了大约600个BMC。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/1be76125293857f0b9aaba9541063a51.png" data-original-src="https://miro.medium.com/v2/resize:fit:734/format:webp/1*IamQuBbmPFBesCleKhYFaw.jpeg"/></div><figcaption class="mc md gj gh gi me mf bd b be z dk translated">609个哈希成功破解</figcaption></figure><p id="84c5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有几个我们无法破解的惠普ILO设备。幸运的是，从版本1.00到2.50，HP iLO 4中还有一个认证旁路。这允许您通过连接HTTP头中的缓冲区溢出创建一个管理员帐户，由web服务器(<a class="ae kl" href="https://cvedetails.com/cve/CVE-2017-12542/" rel="noopener ugc nofollow" target="_blank">https://cvedetails.com/cve/CVE-2017-12542/</a>)处理。该漏洞利用这个BO来获得对rest API的特权访问，这反过来又给予您帐户创建权限。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi ng"><img src="../Images/7d5d3e2a2a2e7d275aaf4b542f7e26a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_jynIhdFIX5RctyU5zfF0g.png"/></div></div><figcaption class="mc md gj gh gi me mf bd b be z dk translated">剥削CVE-2017–12542</figcaption></figure><p id="ca00" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">经过这些步骤，我们完全控制了公司90%的BMC设备。我将在这里结束第1部分。在第2部分中，我们将解释我们如何使用该设备来控制整个基础设施，以及该公司最终如何解决这些问题。</p></div></div>    
</body>
</html>