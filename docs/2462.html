<html>
<head>
<title>Kerberos: The Ticket Authentication Protocol</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kerberos:票证认证协议</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/kerberos-the-ticket-authentication-protocol-d545dde9fe03?source=collection_archive---------0-----------------------#2022-10-21">https://infosecwriteups.com/kerberos-the-ticket-authentication-protocol-d545dde9fe03?source=collection_archive---------0-----------------------#2022-10-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/a77330897a74ad35a4e410c72fd770fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:926/format:webp/1*Sj2TCk5FINkjqKf0zvDx-g.png"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">演职员表:迷因创造者</figcaption></figure><h1 id="ab6c" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">介绍</h1><p id="3b3f" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">Kerberos是一个第7层(应用层)客户端-服务器网络认证协议。它允许客户端在不安全的网络中使用票证安全地对服务/资源进行身份验证。它使用用户数据报协议(UDP)作为其传输层协议。</p><p id="1c02" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">它是由麻省理工学院在20世纪80年代开发的。该协议是以哈迪斯的三头犬赛伯勒斯命名的。</p><p id="45d3" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated"><em class="lz">有趣的事实:Kerberos标识中的3只狗代表客户、KDC和访问</em>的服务</p><p id="da3b" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">关于加密，Kerberos使用对称加密，即相同的密钥用于加密和解密数据。它支持RC4，DES，AES 256位和AES 128位密码，其中RC4是最古老和最弱的</p><p id="d7bb" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">Kerberos是Active Directory中的<strong class="ky ir">默认认证方法</strong></p><p id="a353" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">Kerberos服务器运行在域控制器上，它侦听端口88/UDP。它也被称为密钥分发中心(KDC)，因为它向客户分发门票。由于KDC在域控制器上运行，它可以获取信息(NT哈希、SID等)。)从活动目录数据库。</p><p id="bc80" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">KDC由两部分组成:</p><ul class=""><li id="006f" class="ma mb iq ky b kz lu ld lv lh mc ll md lp me lt mf mg mh mi bi translated">认证服务器:认证客户端并向其颁发TGT</li><li id="bc47" class="ma mb iq ky b kz mj ld mk lh ml ll mm lp mn lt mf mg mh mi bi translated">票证授予服务(TGS)服务器:验证客户端的TGT并向其颁发TGS</li></ul><p id="ad9e" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">如上所述，Kerberos使用票证向服务/资源认证客户端。有两种类型的票:</p><ul class=""><li id="81a5" class="ma mb iq ky b kz lu ld lv lh mc ll md lp me lt mf mg mh mi bi translated">票证授予票证(TGT):由身份验证服务器发布，用于对域中的客户端进行身份验证，并让它们稍后请求TGS。</li><li id="09ef" class="ma mb iq ky b kz mj ld mk lh ml ll mm lp mn lt mf mg mh mi bi translated">票证授予服务(TGS):用于访问网络中的服务。客户端将其TGT呈现给TGS服务器，以便它可以接收特定服务的TGS，然后访问它。收到TGS后，客户端将其提交给服务进行访问。</li></ul><p id="3ea0" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">默认情况下，这些票证会在10小时后过期。这可以在组策略管理控制台中更改。</p><p id="7187" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">KDC的服务账户是<em class="lz"> krbtgt </em>账户。默认情况下，此帐户存在于域控制器上，不能删除/修改。它的密码又长又复杂，由系统设置并定期更改。krbtgt帐户的nt散列用于加密TGTs。</p><p id="59e8" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">为了识别域中的服务，Kerberos使用服务主体名称(SPN)。这些唯一标识符用于将服务实例与服务帐户相关联，以便我们可以对实例进行身份验证并对其进行管理。</p><p id="759c" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">SPN格式的一个例子是</p><p id="0fbc" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated"><code class="fe mo mp mq mr b">Hostname/Username.Domain.TLD:Port</code></p><p id="0912" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">主机名-&gt;运行该服务的计算机的主机名</p><p id="e466" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">用户名-&gt;服务帐户的用户名</p><p id="abe3" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">端口-&gt;服务监听的端口</p><p id="483d" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">使用Kerberos时，会向TGT和TGS添加一个特殊的证书。它被称为特权属性证书(PAC ),包含用户的特权和信息(组成员、SID等)。)服务使用它来确认用户就是他们所说的那个人。这在Kerberos中是可选的。</p><p id="745e" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">在Kerberos中，领域指的是KDC用于向服务/资源发放票证和验证用户身份的域。</p><h1 id="5a07" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">版本</h1><p id="c016" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">Kerberos版本1–3是在MIT内部开发和使用的。</p><p id="b5e3" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">在20世纪80年代末，Kerberos版本4向公众发布。该协议具有有限的票证功能。它使用弱数据加密标准(DES)密码。为了识别主机，它使用IP地址和“接收方制造权”编码系统。票证的生命周期必须以5分钟为单位指定，并且不支持跨领域身份验证。</p><p id="1f28" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">Kerberos版本5发布于1993年。它以RFC 1510的形式出现，但在2005年被RFC 4120淘汰。关于票证，该协议支持转发、续订和事后更新。对于加密，它使用高级加密标准(AES)密码。该版本支持所有类型的地址，并使用ASN.1编码系统。用户可以设置明确的开始和结束时间，从而允许任意的票证生存期。它支持跨领域身份验证。</p><h1 id="d2e2" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">认证过程</h1><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi ms"><img src="../Images/6934fe1cb1b127c1cb4a968c17eb36d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*r7enebjeFM7i4ZaF.png"/></div></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">学分:tarlogic.com</figcaption></figure><ol class=""><li id="f381" class="ma mb iq ky b kz lu ld lv lh mc ll md lp me lt nb mg mh mi bi translated">一旦客户端登录到他们的计算机，它将发送一个票请求到KDC。用户的计算机将发送用用户的nt散列(将NT散列视为密钥)加密的当前时间、他们的用户名以及他们希望访问的服务(在本例中是krbtgt)。(作为请求)</li><li id="e6fd" class="ma mb iq ky b kz mj ld mk lh ml ll mm lp mn lt nb mg mh mi bi translated">收到该请求后，KDC会检查域中是否存在使用该用户名的用户。为此，它将检查广告数据库。如果它找到用户，它将获取它的NT散列并解密时间。如果发现时间与DC的时钟时间相差不超过5分钟，它将继续前进。这是为了防止重放攻击。KDC将产生一个TGT。这个TGT包含服务名(krbtgt)、截止日期、会话密钥、PAC和客户机的用户名。除了服务名之外的所有内容都用krbtgt用户的NT散列加密。然后用用户的NT散列对会话密钥的副本进行加密，并将它们发送回用户。(AS_REP)</li><li id="aa0f" class="ma mb iq ky b kz mj ld mk lh ml ll mm lp mn lt nb mg mh mi bi translated">用户的计算机将使用用户的NT哈希解密会话密钥的副本。现在，要访问一个服务，客户端的计算机将向KDC发送TGT、他们希望访问的服务的名称和一个验证符。认证者指的是用会话密钥加密的客户端用户名和当前时间。这是为了证明客户端拥有只能使用其nt哈希(TGS请求)解密的会话密钥</li><li id="05e8" class="ma mb iq ky b kz mj ld mk lh ml ll mm lp mn lt nb mg mh mi bi translated">收到这个消息后，KDC将使用krbtgt用户的NT散列解密TGT。通过这样做，它将提取会话密钥并解密验证者。如果这是成功的，它继续进行。然后，KDC将尝试查找该服务名称的SPN，当它找到时，它将获得与之关联的服务帐户。然后它会生成一个TGS。这个TGS包含服务名、截止日期、新的会话密钥、来自TGT的PAC和客户端的用户名。除了服务名之外的所有内容都用服务帐户的NT散列加密。然后用用户的NT散列对新会话密钥的副本进行加密，并将它们发送回用户。(TGS共和国)</li><li id="1047" class="ma mb iq ky b kz mj ld mk lh ml ll mm lp mn lt nb mg mh mi bi translated">客户端的计算机将向服务实例发送TGS和验证器(客户端的用户名和当前时间),它们用新的会话密钥加密。一个新的认证器将证明客户机拥有新的会话密钥，该密钥只能使用它们的nt散列(AP_REQ)来解密</li><li id="e221" class="ma mb iq ky b kz mj ld mk lh ml ll mm lp mn lt nb mg mh mi bi translated">该服务将使用其服务帐户的nt哈希解密TGS，并提取新的会话密钥和PAC。然后，它将使用新的会话密钥解密验证器。如果这是成功的，它继续进行</li><li id="9505" class="ma mb iq ky b kz mj ld mk lh ml ll mm lp mn lt nb mg mh mi bi translated">为了验证这个PAC是否是合法的并且不是伪造的，服务将这个PAC发送到KDC。(验证_PAC)</li><li id="391e" class="ma mb iq ky b kz mj ld mk lh ml ll mm lp mn lt nb mg mh mi bi translated">收到PAC后，KDC会检查它是否有效。如果是，KDC向服务器发送一条消息，让它知道这是有效的。(PAC _验证_响应)</li><li id="aecf" class="ma mb iq ky b kz mj ld mk lh ml ll mm lp mn lt nb mg mh mi bi translated">该服务现在通过读取PAC知道用户的特权，并且它已经验证了用户的身份(用户能够使用会话密钥来加密验证器，该会话密钥只能使用他们的NT散列来解密)。现在允许用户访问服务实例(AP_REP)</li></ol><p id="a12d" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">除了AP_REQ和AP_REP之外的所有步骤都发生在Kerberos协议上。这两个步骤发生在服务实例支持的协议上。</p><h1 id="7106" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">结论</h1><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/28f7f3e6c78be43f5831f0f6f919ff13.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/format:webp/0*5PJyfUV8HaN4xigK.jpg"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">演职员表:本杰明·德尔皮</figcaption></figure><p id="b228" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">尽管与NTLM相比，Kerberos似乎更安全，但该协议中存在多个缺陷，使得攻击者能够访问帐户，甚至接管整个域。我们将在下一篇文章中讨论5种攻击:)</p><p id="0952" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">在LinkedIn上与我联系👉<a class="ae nd" href="https://www.linkedin.com/in/aravbudhiraja/" rel="noopener ugc nofollow" target="_blank">https://www.linkedin.com/in/aravbudhiraja/</a></p></div><div class="ab cl ne nf hu ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ij ik il im in"><h2 id="5b05" class="nl jz iq bd ka nm nn dn ke no np dp ki lh nq nr km ll ns nt kq lp nu nv ku nw bi translated">来自Infosec的报道:Infosec每天都有很多内容，很难跟上。<a class="ae nd" href="https://weekly.infosecwriteups.com/" rel="noopener ugc nofollow" target="_blank">加入我们的每周简讯</a>以5篇文章、4个线程、3个视频、2个GitHub Repos和工具以及1个工作提醒的形式免费获取所有最新的Infosec趋势！</h2></div></div>    
</body>
</html>