<html>
<head>
<title>Pivoting</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">绕轴旋转</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/pivoting-253d65c6c867?source=collection_archive---------3-----------------------#2022-12-13">https://infosecwriteups.com/pivoting-253d65c6c867?source=collection_archive---------3-----------------------#2022-12-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="9451" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">THM-2022年赛博4的第9天来临</h2></div><p id="7927" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">嘿，黑客，今天我将带你完成第九天的旋转任务。我们开始吧！</p><p id="3242" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Docker:如果你看到存在一个文件:/。在根目录下的dockerenv，那么就可以知道应用程序正在docker上运行。</p><p id="9c16" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这个房间是关于在一个叫做Metasploit的框架上交换模块的。Metasploit利用对目标系统的初始访问。有趣的是:它是免费的！</p><p id="845e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">从给定机器上的recon开始，进行基本的nmap扫描:</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi lb"><img src="../Images/3e56d8c23939f7863038a931ac05527b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dWldDnbOTcvGmLh0f2W_DQ.png"/></div></div><figcaption class="ln lo gj gh gi lp lq bd b be z dk translated">我们看到一个开放的端口80，导航到我们看到它使用laravel的网页</figcaption></figure><p id="9c9a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">查找laravel版本8的常见漏洞</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi lr"><img src="../Images/5d9066e7ed21f05d3061aa71b01032ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5_b7jySXNhkpP156-PtSyA.png"/></div></div><figcaption class="ln lo gj gh gi lp lq bd b be z dk translated">目标机器使用的是linux，apache server的版本，所以我们可以使用远程代码执行。</figcaption></figure><p id="c13b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">通过在终端中键入“msfconsole”来启动metasploit。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi ls"><img src="../Images/a720471d1916225a40be3aacc540fc1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X2JCE1_MDXEq5ajVhPtuQQ.png"/></div></div><figcaption class="ln lo gj gh gi lp lq bd b be z dk translated">在vm中设置rhost(目标ip)的值，lhost为tun0，在基于web的kali中设置eth0</figcaption></figure><pre class="lc ld le lf gt lt lu lv bn lw lx bi"><span id="d8e4" class="ly lz iq lu b be ma mb l mc md">set rhosts &lt;machine-ip&gt;<br/>set lhost tun0/eth0<br/>check </span></pre><p id="7567" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用“运行”或“利用”运行利用漏洞。如果它不运行，输入“设置ForceExploit为真”</p><p id="f1d9" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">成功利用目标ip后，您可以获得您的用户的用户id。这是一个不稳定的壳层，要得到一个稳定的壳层，我们需要一个叫做meterpreter的壳层，它在很多方面都很有用。您可以在当前用户上使用命令启动meterpreter会话:</p><pre class="lc ld le lf gt lt lu lv bn lw lx bi"><span id="a6e3" class="ly lz iq lu b be ma mb l mc md">sessions -u 1<br/>and then run using:<br/>sessions -i &lt;session id of meterpreter&gt;</span></pre><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi me"><img src="../Images/90f2ebe4d3d8f2ef5fc7055d2eee6d6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1LexTChUnx0SigVQb2-Shg.png"/></div></div><figcaption class="ln lo gj gh gi lp lq bd b be z dk translated">我们找到了</figcaption></figure><p id="969e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来，让我们列出该用户下的根目录。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi mf"><img src="../Images/9e31b51c4f6468721d5ce6b96c377a00.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VTLFketP6aeKtmM0qoj8Eg.png"/></div></div><figcaption class="ln lo gj gh gi lp lq bd b be z dk translated">现在我们知道它在docker上运行，创建一个shell。</figcaption></figure><p id="59f2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">的。/var/www中的env文件是我们特别感兴趣的，因为它可能包含datab</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi mg"><img src="../Images/bb22eab1048cf2a0a0252e0e76abb550.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xPz_uzWv0bBbxUdJBO1PvA.png"/></div></div><figcaption class="ln lo gj gh gi lp lq bd b be z dk translated">我们可以看到有一个数据库，用户名和密码是“postgres”耶！</figcaption></figure><p id="0d83" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用“退出”退出shell模式。</p><p id="7fa6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因为我们不知道这个名为webservice_database的数据库主机的ip地址:</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div class="gh gi mh"><img src="../Images/7a4132fe555e9de4b4e0a7887a8f4127.png" data-original-src="https://miro.medium.com/v2/resize:fit:776/format:webp/1*pLWtpXk9U6ZDy6E4SrKHcg.png"/></div><figcaption class="ln lo gj gh gi lp lq bd b be z dk translated">记下来，我们需要这个。</figcaption></figure><p id="caec" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，您可以尝试以下命令</p><pre class="lc ld le lf gt lt lu lv bn lw lx bi"><span id="cc2d" class="ly lz iq lu b be ma mb l mc md">ip a or ifconfig </span></pre><p id="ee00" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要查看docker容器所在机器的ip地址。</p><p id="7ed5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">但是在这种情况下这些都不起作用，所以我们采用默认的“127.17.0.1”。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div class="gh gi mi"><img src="../Images/44df5b74983d6f753a2a1ff77d08ad28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1310/format:webp/1*LBbjfczQZRx98lCnIcSDJQ.png"/></div><figcaption class="ln lo gj gh gi lp lq bd b be z dk translated">现在退出shell，并在后台运行当前的meterpreter会话。</figcaption></figure><p id="980a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在让我们搜索数据库漏洞:</p><p id="d589" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">auxiliary/scanner/postgres/postgres _ schema dump是你接下来要使用的漏洞。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi mj"><img src="../Images/80f1c1e41b8464afcaa14f4126a5f094.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QgmYHiIK8dkZOBnqmO6bVg.png"/></div></div><figcaption class="ln lo gj gh gi lp lq bd b be z dk translated">我们有一个名为users的表。</figcaption></figure><p id="4d49" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在我们继续之前，我们需要修改metasploit的内部<em class="mk">路由表。</em></p><p id="7341" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">该路由表决定了通过何处发送网络流量，例如，通过Meterpreter会话。通过这种方式，我们使用Meterpreter来进行pivot:将流量发送到网络上的其他机器。</p><pre class="lc ld le lf gt lt lu lv bn lw lx bi"><span id="5195" class="ly lz iq lu b be ma mb l mc md">route add &lt;IP/subnet&gt; &lt;meterpreter-session-id&gt;</span></pre><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi ml"><img src="../Images/de4d128fc0dec191cf4bb195b741d9f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0qq0ult4xOEDWdcPrT6zUw.png"/></div></div></figure><p id="4971" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在让我们使用auxiliary/admin/postgres/postgres _ readfile:PostgreSQL Server通用查询。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi me"><img src="../Images/219a230e78e73b07ef05e39cbf2c750f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZqsLiTDuQy3KCmOXxlI9tg.png"/></div></div><figcaption class="ln lo gj gh gi lp lq bd b be z dk translated">运行这个，你会得到用户表和“圣诞老人”的密码，呀！</figcaption></figure><p id="4fd2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在这完成了metasploit的基础，接下来是主要部分“旋转”。</p><p id="0145" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">socks代理服务器:启动SOCKS代理服务器-&gt; SOCKS代理是一个中间服务器，支持在两台机器之间中继网络流量。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi ml"><img src="../Images/6869c969c9beb93f9ae6c14e685affe8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kKHs07ZnZxSOkPejpZ6BJQ.png"/></div></div><figcaption class="ln lo gj gh gi lp lq bd b be z dk translated">srvport是1080</figcaption></figure><p id="5e8f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，您可以使用socks代理向docker发送请求。像<code class="fe mm mn mo lu b">curl</code>这样的工具支持通过socks代理服务器经由<code class="fe mm mn mo lu b">--proxy</code>标志发送请求:</p><pre class="lc ld le lf gt lt lu lv bn lw lx bi"><span id="49e4" class="ly lz iq lu b be ma mb l mc md">curl --proxy socks5://127.0.0.1:1080 http://172.17.0.1</span></pre><p id="1f6a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在/etc文件夹中有一个名为proxychains4.conf的文件，打开它并编辑内容</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div class="gh gi mp"><img src="../Images/8b649263b492def160562c59b5e20f66.png" data-original-src="https://miro.medium.com/v2/resize:fit:552/format:webp/1*aD2fpMoH-ZBurPMLNn9x2Q.png"/></div></figure><p id="2189" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，如果该工具本身不支持使用socks代理的选项，ProxyChains可以截获该工具打开新网络连接的请求，并通过socks代理路由该请求。</p><pre class="lc ld le lf gt lt lu lv bn lw lx bi"><span id="ce0d" class="ly lz iq lu b be ma mb l mc md">proxychains curl http://127.17.0.1  //strict chain 127.0.0.1:1080  ...  172.17.0.1:80</span></pre><p id="642a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这意味着我们可以访问docker应用程序。让我们运行一次nmap扫描，看看哪些端口是打开的:</p><pre class="lc ld le lf gt lt lu lv bn lw lx bi"><span id="5770" class="ly lz iq lu b be ma mb l mc md">proxychains nmap -F -sT -Pn 172.17.0.1</span></pre><figure class="lc ld le lf gt lg gh gi paragraph-image"><div class="gh gi mq"><img src="../Images/56e73d4bbf8c3a740adf0ad1c9439a5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1162/format:webp/1*bD2zBnLDTUG-4csX2yz87Q.png"/></div><figcaption class="ln lo gj gh gi lp lq bd b be z dk translated">我们看到ssh是开放的。</figcaption></figure><p id="482c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们回到metasploit并搜索ssh。</p><pre class="lc ld le lf gt lt lu lv bn lw lx bi"><span id="e6f6" class="ly lz iq lu b be ma mb l mc md">run ssh://santa_username_here:santa_password_here@172.17.0.1</span></pre><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi mr"><img src="../Images/ba1fe4d3695a3f80d149c4aa029bf2df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xUb6pY2SjU-ZFPyeYxBO0g.png"/></div></div><figcaption class="ln lo gj gh gi lp lq bd b be z dk translated">获取此的meterpreter会话并找到根标志:)</figcaption></figure><p id="b28f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">天哪，这对于一天来说太多了，但是我们发现了如何从一个应用程序转到另一个应用程序；)使用socks proxy和proxychains之类的工具。</p><p id="0a0b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">还有其他的旋转方法，如果这个主题看起来很有趣，看看是什么！</p><p id="e35b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">继续黑！</p></div><div class="ab cl ms mt hu mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="ij ik il im in"><h2 id="2b31" class="mz lz iq bd na nb nc dn nd ne nf dp ng ko nh ni nj ks nk nl nm kw nn no np nq bi translated">来自Infosec的报道:Infosec每天都有很多内容，很难跟上。<a class="ae nr" href="https://weekly.infosecwriteups.com/" rel="noopener ugc nofollow" target="_blank">加入我们的每周简讯</a>以5篇文章、4个线程、3个视频、2个GitHub Repos和工具以及1个工作提醒的形式免费获取所有最新的Infosec趋势！</h2></div></div>    
</body>
</html>