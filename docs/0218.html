<html>
<head>
<title>Automating AD Enumeration</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">自动化AD枚举</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/automating-ad-enumeration-with-frameworks-f8c7449563be?source=collection_archive---------0-----------------------#2018-12-14">https://infosecwriteups.com/automating-ad-enumeration-with-frameworks-f8c7449563be?source=collection_archive---------0-----------------------#2018-12-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="f837" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">手动做所有事情很酷，但是我们如何节省时间和金钱呢？很多时候，大部分枚举工作都可以自动化。但是要知道，自动化任何任务都需要很多知识。我们大多数人认为，自动化结果/报告必须手动审查/分析，以确保准确、精确和受控的测试。受控？是的，还记得阿米蒂奇，钴和类似的工具吗？我们不想在游戏早期就被IDS/IPS/WAF赶上。</p><p id="67cd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，这里开始了Active Directory特定信息的自动枚举。这些工具被分类为在某些情况下使用的<strong class="jp ir"> <em class="kl">本地和远程枚举</em> </strong>工具。</p><blockquote class="km"><p id="5aed" class="kn ko iq bd kp kq kr ks kt ku kv kk dk translated"><strong class="ak">本地广告枚举工具</strong></p></blockquote><p id="9c0d" class="pw-post-body-paragraph jn jo iq jp b jq kw js jt ju kx jw jx jy ky ka kb kc kz ke kf kg la ki kj kk ij bi translated">在各种技术的帮助下，如果攻击者控制了远程命令执行或获得了用户/管理员外壳，攻击者可以选择<strong class="jp ir"> Bloodhound </strong>和<strong class="jp ir"> Powerup </strong>工具进行帐户/资源/网络/打印机/错误配置等的本地枚举。</p><p id="1fc9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一)<em class="kl">警犬</em></p><p id="96c5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae lb" href="https://github.com/BloodHoundAD/BloodHound/releases" rel="noopener ugc nofollow" target="_blank"> Bloodhound </a>是一个非常有用的工具，基于<a class="ae lb" href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1" rel="noopener ugc nofollow" target="_blank"> PowerView </a>，它将帮助绘制整个网络中的活动目录关系。在pentest中，这一点至关重要，因为在初始访问(用户或管理员)之后，它会让您了解接下来要攻击什么。在大型基础设施中，拥有关于域/林/信任关系和基础设施的信息对于有针对性的利用是至关重要的。Bloodhound的常见用法和包括的步骤:</p><blockquote class="lc ld le"><p id="b57c" class="jn jo kl jp b jq jr js jt ju jv jw jx lf jz ka kb lg kd ke kf lh kh ki kj kk ij bi translated">1.一旦你有了初步的立足点，<a class="ae lb" href="https://github.com/BloodHoundAD/BloodHound/releases" rel="noopener ugc nofollow" target="_blank">下载</a> Bloodhound并在某个地方提取它。点击。请在Bloodhound的根目录下运行。在攻击者机器浏览器中打开bolt://localhost:7687，使用用户名和密码登录。</p><p id="65da" class="jn jo kl jp b jq jr js jt ju jv jw jx lf jz ka kb lg kd ke kf lh kh ki kj kk ij bi translated">2.浏览到某处\猎犬\变种人和复制Sharphound.exe。假设您有Meterpreter或任何其他shell来上传目标上的Sharphound.exe，那么您可以上传. exe</p><p id="ec1e" class="jn jo kl jp b jq jr js jt ju jv jw jx lf jz ka kb lg kd ke kf lh kh ki kj kk ij bi translated">3.对目标执行Sharphound.exe。</p><p id="184f" class="jn jo kl jp b jq jr js jt ju jv jw jx lf jz ka kb lg kd ke kf lh kh ki kj kk ij bi translated">4.这将创建几个CSV文件。主要枚举用户/组成员、本地用户/组成员和会话。</p><p id="1243" class="jn jo kl jp b jq jr js jt ju jv jw jx lf jz ka kb lg kd ke kf lh kh ki kj kk ij bi translated">5.将CSV文件从目标机器下载到攻击者机器上。</p><p id="dc42" class="jn jo kl jp b jq jr js jt ju jv jw jx lf jz ka kb lg kd ke kf lh kh ki kj kk ij bi translated">6.将这些CSV文件上传到bloodhound并进行探索。</p><p id="e938" class="jn jo kl jp b jq jr js jt ju jv jw jx lf jz ka kb lg kd ke kf lh kh ki kj kk ij bi translated">7.这可以提供大量关于目标系统的各种基础设施、信任和成员资格的信息。</p></blockquote><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="gh gi li"><img src="../Images/e15efaf2696dc13a8bc59c7298340e34.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*au4xuaRUClfdeDhKRl7xpA.png"/></div></div></figure><p id="6f9d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">图Bloodhoud域枚举报告的一个非常典型的例子。引用自<a class="ae lb" href="https://wald0.com/?p=68" rel="noopener ugc nofollow" target="_blank">https://wald0.com/?p=68</a>展示了警犬在大型基础设施上的能力。</p><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="gh gi lu"><img src="../Images/5351e9fd34430265fd0e3173c09c72e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*haC-P08_zLGZpKoXNw_YLA.png"/></div></div></figure><p id="2a26" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">图Bloodhound枚举的用户映射。引用自https://wald0.com/?p=68<a class="ae lb" href="https://wald0.com/?p=68" rel="noopener ugc nofollow" target="_blank">的</a>，用于展示警犬在大型基础设施上的能力。</p><p id="eb3d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">b) <em class="kl"> Powersploit通电</em></p><p id="586f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">根据我的观察和经验，<a class="ae lb" href="https://github.com/rebootuser/LinEnum" rel="noopener ugc nofollow" target="_blank"> linenum </a>对于linux来说可能更好。PowerUp旨在成为基于错误配置的常见Windows权限提升途径的信息交换所。显然，加电在权限提升中是有用的，但它是通过检查错误配置和缺失的安全控制/补丁来实现的。</p><p id="d611" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦有了本地远程执行，加载Powershell并执行以下命令:</p><blockquote class="lc ld le"><p id="7377" class="jn jo kl jp b jq jr js jt ju jv jw jx lf jz ka kb lg kd ke kf lh kh ki kj kk ij bi translated">powershell.exe-nop-exec旁路</p></blockquote><p id="4096" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后导入加电模块</p><blockquote class="lc ld le"><p id="86fa" class="jn jo kl jp b jq jr js jt ju jv jw jx lf jz ka kb lg kd ke kf lh kh ki kj kk ij bi translated">导入模块PowerUp.ps1</p></blockquote><p id="e453" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，您可以访问所有PowerUp cmdlets。执行所有的检查运行</p><blockquote class="lc ld le"><p id="4225" class="jn jo kl jp b jq jr js jt ju jv jw jx lf jz ka kb lg kd ke kf lh kh ki kj kk ij bi translated">调用-all checks | Out-File-Encoding ASCII checks . txt</p></blockquote><p id="359c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">获取攻击者机器上的文件并分析有趣的信息。下面是一个示例报告:</p><blockquote class="lc ld le"><p id="93b9" class="jn jo kl jp b jq jr js jt ju jv jw jx lf jz ka kb lg kd ke kf lh kh ki kj kk ij bi translated">运行Invoke-AllChecks <br/>检查未引用的服务路径… <br/> [+]未引用的服务路径:CustomSVC—C:\ Users \ Adam \ Documents \ Visual Studio 2008 \ Projects \ Service \ Service \ bin \ Release \ Service . exe<br/>检查服务可执行文件权限… <br/> [+]易受攻击的服务可执行文件:CustomSVC—C:\ Users \ Adam \ Documents \ Visual Studio 2008 \ Projects \ Service \ Service \ bin \ Release \ Service . exe<br/>检查服务权限….dll位置… <br/>检查AlwaysInstallElevated注册表项… <br/> [+]该计算机已启用AlwaysInstallElevated！<br/>正在注册表中检查自动登录凭证…</p></blockquote><blockquote class="km"><p id="e2e6" class="kn ko iq bd kp kq lv lw lx ly lz kk dk translated">远程AD枚举工具</p></blockquote><p id="e1ab" class="pw-post-body-paragraph jn jo iq jp b jq kw js jt ju kx jw jx jy ky ka kb kc kz ke kf kg la ki kj kk ij bi translated">1.<em class="kl">应答者</em></p><p id="6a2c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">响应器是一个强大的工具，适用于Pentester应该拥有的所有Windows或Active Directory环境。如果域/Windows系统无法通过DNS解析名称，它将回退到通过LLMNR(在Windows Vista中引入)和NetBIOS进行名称解析。通过运行Responder，我们可以将攻击者的机器伪装成所有LLMNR和NetBIOS请求的目标机器。要执行responder，请运行</p><blockquote class="lc ld le"><p id="b1e9" class="jn jo kl jp b jq jr js jt ju jv jw jx lf jz ka kb lg kd ke kf lh kh ki kj kk ij bi translated">响应者-i <your ip=""> -wrf</your></p></blockquote><p id="33c9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.<em class="kl"> Enum4linux </em></p><p id="4603" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae lb" href="https://github.com/portcullislabs/enum4linux" rel="noopener ugc nofollow" target="_blank"> Enum4linux </a>是一个从Windows和Samba系统枚举信息的工具。主要特点:</p><blockquote class="lc ld le"><p id="e777" class="jn jo kl jp b jq jr js jt ju jv jw jx lf jz ka kb lg kd ke kf lh kh ki kj kk ij bi translated">RID循环(当RestrictAnonymous在Windows 2000上设置为1时)</p><p id="ef8d" class="jn jo kl jp b jq jr js jt ju jv jw jx lf jz ka kb lg kd ke kf lh kh ki kj kk ij bi translated">用户列表(当RestrictAnonymous在Windows 2000上设置为0时)</p><p id="80af" class="jn jo kl jp b jq jr js jt ju jv jw jx lf jz ka kb lg kd ke kf lh kh ki kj kk ij bi translated">群组成员信息列表</p><p id="c000" class="jn jo kl jp b jq jr js jt ju jv jw jx lf jz ka kb lg kd ke kf lh kh ki kj kk ij bi translated">共享枚举</p><p id="c74b" class="jn jo kl jp b jq jr js jt ju jv jw jx lf jz ka kb lg kd ke kf lh kh ki kj kk ij bi translated">检测主机是在工作组还是在域中</p><p id="b1d8" class="jn jo kl jp b jq jr js jt ju jv jw jx lf jz ka kb lg kd ke kf lh kh ki kj kk ij bi translated">识别远程操作系统</p><p id="a9cc" class="jn jo kl jp b jq jr js jt ju jv jw jx lf jz ka kb lg kd ke kf lh kh ki kj kk ij bi translated">密码策略检索(使用polenum)来源:<a class="ae lb" href="https://labs.portcullis.co.uk/tools/enum4linux" rel="noopener ugc nofollow" target="_blank"> https://labs。portcullis.co.uk/tools/enum4linux</a></p></blockquote><p id="a04d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要从攻击者机器上执行enum4linux，请使用以下命令:</p><p id="0e99" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用以下命令执行enum4linux并分析结果:</p><blockquote class="lc ld le"><p id="453d" class="jn jo kl jp b jq jr js jt ju jv jw jx lf jz ka kb lg kd ke kf lh kh ki kj kk ij bi translated">enum 4 Linux-用于空会话的target-ip #</p><p id="c579" class="jn jo kl jp b jq jr js jt ju jv jw jx lf jz ka kb lg kd ke kf lh kh ki kj kk ij bi translated">enum 4 Linux-u administrator-p password-A target-IP #用于已知的凭证</p></blockquote><p id="857d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="kl"> 3。Smbmap </em></p><p id="346d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Smbmap 是一个非常有用的工具，它是crackmapexec的一个子集，我们很快就会讨论它。使用正确的凭据，可以使用smbmap完成SMB共享枚举、所有SMB共享的递归目录列表、命令执行、上传/下载/删除、反向外壳等操作。smbmap的大部分选项汇总在下表中:</p><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div class="gh gi ma"><img src="../Images/4722afd75e27c9b1c759689b5f81ff6f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1370/format:webp/1*r_EizbKP1OfTsmqAiIghqA.png"/></div><figcaption class="mb mc gj gh gi md me bd b be z dk translated">SMBmap模块和命令参考。</figcaption></figure><p id="13b5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">4.<em class="kl"> CrackMapExec </em></p><p id="224e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae lb" href="https://github.com/byt3bl33d3r/CrackMapExec" rel="noopener ugc nofollow" target="_blank"> CrackMapExec </a>(又名CME)是一款开发后工具，有助于自动评估大型活动目录网络的安全性。CME在构建时就考虑到了隐蔽性，它滥用内置的活动目录功能/协议来实现其功能，并允许它规避大多数端点保护/IDS/IPS解决方案。</p><p id="14d5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在各个pentest阶段，CME可以做很多事情，如下所述:</p><blockquote class="lc ld le"><p id="b8ab" class="jn jo kl jp b jq jr js jt ju jv jw jx lf jz ka kb lg kd ke kf lh kh ki kj kk ij bi translated">Cme <target>网络枚举</target></p><p id="3a4d" class="jn jo kl jp b jq jr js jt ju jv jw jx lf jz ka kb lg kd ke kf lh kh ki kj kk ij bi translated">Cme smb <target> -u用户名-p密码-local-auth-x whoami #命令执行</target></p><p id="c725" class="jn jo kl jp b jq jr js jt ju jv jw jx lf jz ka kb lg kd ke kf lh kh ki kj kk ij bi translated">CME<target>-u username-p password—Lu users #列出已登录的用户</target></p><p id="a681" class="jn jo kl jp b jq jr js jt ju jv jw jx lf jz ka kb lg kd ke kf lh kh ki kj kk ij bi translated">CME<target>-u username-p password-local-auth–sam #转储本地Sam哈希</target></p><p id="043b" class="jn jo kl jp b jq jr js jt ju jv jw jx lf jz ka kb lg kd ke kf lh kh ki kj kk ij bi translated">CME SMB<target>-u username-H ' lm hash:n hash '—local-auth #传递散列</target></p><p id="8fa4" class="jn jo kl jp b jq jr js jt ju jv jw jx lf jz ka kb lg kd ke kf lh kh ki kj kk ij bi translated">cme <protocol> <target> -u用户名. file -p密码. file #密码brutefoce</target></protocol></p></blockquote><p id="2afa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">CME支持Empire、Metasploit和Mimikatz集成，这使它成为活动目录测试的瑞士军刀。</p><p id="e79f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">大声喊出来:</strong></p><p id="f795" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Bloodhound投稿人:<a class="ae lb" href="https://www.twitter.com/_wald0" rel="noopener ugc nofollow" target="_blank"> @_wald0 </a>，<a class="ae lb" href="https://twitter.com/CptJesus" rel="noopener ugc nofollow" target="_blank"> @CptJesus </a>，<a class="ae lb" href="http://twitter.com/harmj0y" rel="noopener ugc nofollow" target="_blank"> @harmj0y </a></p><p id="4d1d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">CME投稿人:<a class="ae lb" href="http://twitter.com/byt3bl33d3r" rel="noopener ugc nofollow" target="_blank"> @byt3bl33d3r </a></p><p id="3bf0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae lb" href="https://www.ivoidwarranties.tech/posts/pentesting-tuts/cme/crackmapexec/" rel="noopener ugc nofollow" target="_blank">https://www . ivoid warranties . tech/posts/pentesting-tuts/CME/crackmapexec/</a></p></div></div>    
</body>
</html>