<html>
<head>
<title>Detailed Analysis of Ghostcat Vulnerability (Cve-2020–1938) in Apache Tomcat Servers</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Apache Tomcat服务器中Ghostcat漏洞(Cve-2020–1938)的详细分析</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/detailed-analysis-of-ghostcat-vulnerability-cve-2020-1938-in-apache-tomcat-servers-and-using-it-736146c986a3?source=collection_archive---------0-----------------------#2020-04-07">https://infosecwriteups.com/detailed-analysis-of-ghostcat-vulnerability-cve-2020-1938-in-apache-tomcat-servers-and-using-it-736146c986a3?source=collection_archive---------0-----------------------#2020-04-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="1cfc" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">并利用它在Tryhackme上攻破一台Tomcat机器</h2></div><p id="7e61" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">今天我们要讨论的是2020年2月柴天科技安全研究人员发现的一个新漏洞，这个漏洞被研究人员命名为ghostcat</p><p id="ec48" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae lb" href="http://tomcat.apache.org/" rel="noopener ugc nofollow" target="_blank"> Apache Tomcat </a>是一个流行的开源Java servlet容器，因此Ghostcat的发现可以理解地引发了一些警报。这篇博客文章试图通过深入研究可能允许RCE通过漏洞的不太可能的情况，将最令人恐惧的Ghostcat相关场景放入视野中。</p><p id="9f51" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">该漏洞在默认配置下影响Tomcat的所有版本(我们发现该漏洞时，已确认影响Tomcat 9/8/7/6的所有版本，太旧的旧版本未验证)，这意味着它在Tomcat中已休眠十多年。</p><p id="fce0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi lc translated"><span class="l ld le lf bm lg lh li lj lk di"> W </span> <strong class="kh ir">幽灵猫能做什么帽子？</strong></p><p id="42a6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">通过利用Ghostcat漏洞，攻击者可以读取Tomcat上部署的所有webapps的配置文件和源代码文件的内容。</p><p id="8de6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，如果网站应用程序允许用户上传文件，攻击者可以首先将包含恶意JSP脚本代码的文件上传到服务器(上传的文件本身可以是任何类型的文件，如图片、纯文本文件等。)，然后通过利用Ghostcat漏洞包含上传的文件，这最终会导致远程代码执行</p><p id="c2fa" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们先来谈谈AJP (Apache Jserv协议)</p><h1 id="3056" class="ll lm iq bd ln lo lp lq lr ls lt lu lv jw lw jx lx jz ly ka lz kc ma kd mb mc bi translated">《AJP议定书》</h1><p id="c7f2" class="pw-post-body-paragraph kf kg iq kh b ki md jr kk kl me ju kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated"><a class="ae lb" href="https://tomcat.apache.org/connectors-doc/ajp/ajpv13a.html" rel="noopener ugc nofollow" target="_blank"> AJP </a>是Apache Tomcat webserver使用的二进制协议，通过TCP连接与位于webserver后面的servlet容器进行通信。它主要用于集群或反向代理场景，其中web服务器与应用服务器或servlet容器进行通信。</p><p id="5235" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">简单地说，这意味着HTTP连接器向客户端公开，而AJP在web服务器(例如，Apache HTTPD)和Apache Tomcat服务器之间内部使用(如图1所示)。AJP是作为Apache HTTP服务器中的一个模块实现的，表示为mod_jk或mod_proxy_ajp。底线是，AJP本质上并不对外开放。指出这一点很重要，因为这是RCE场景的先决条件之一。</p><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div class="gh gi mi"><img src="../Images/df5aaa982cdd14d3beecd999a637ce79.png" data-original-src="https://miro.medium.com/v2/resize:fit:760/format:webp/1*30NbYnZVHgaqigXqYohpJQ.jpeg"/></div></figure><p id="202a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">GHOSTCAT是一个LFI(本地文件包含)漏洞，它不是RCE(远程代码执行)。默认情况下，在某些情况下，它会成为RCE</p><blockquote class="mq mr ms"><p id="e1f2" class="kf kg mt kh b ki kj jr kk kl km ju kn mu kp kq kr mv kt ku kv mw kx ky kz la ij bi translated"><strong class="kh ir">能让幽灵特工成为RCE的环境</strong></p></blockquote></div><div class="ab cl mx my hu mz" role="separator"><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc"/></div><div class="ij ik il im in"><p id="29a8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">web应用程序需要允许文件上传和在web应用程序本身中存储这些上传的文件，并结合将文件作为JSP处理的能力</p><p id="f472" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">来自巴西的知名安全研究员joo Matos指出了Ghostcat成为RCE的先决条件</p><p id="1327" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">链接-【https://twitter.com/joaomatosf/status/1230895566688792576 T2】</p><p id="1789" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">通过APP功能上传文件</strong>。这第一个先决条件意味着具有文件上传功能的应用程序应该已经安装在系统中，RCE才是可能的。如果是这种情况，潜在的攻击者可以更方便地使用带有文件上传漏洞的web应用程序来上传恶意的web外壳文件。只有在上传漏洞限制某些文件扩展名(如JPG或TXT)的情况下，才需要将文件解释为JSP。</p><p id="4344" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这些文件保存在文档根目录下。一旦攻击者破坏了应用程序并能够上传恶意文件，这些文件将需要保存在应用程序根文件夹中。这个先决条件本身不太可能或很难协调，原因有二:1)在Java应用程序中，将文件保存在其应用程序根文件夹中是不常见的；以及2)应用程序根文件夹是暂时的，因此每当部署应用程序的新版本时，该文件夹被完全覆盖。</p><p id="c6be" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，从开发人员的角度来看，文件上传功能上传根文件夹中的文件没有什么意义，因为大多数Apache Tomcat应用程序都是以. WAR文件的形式部署的，这基本上是一个zip文件。</p><p id="83fa" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">直达AJP港</strong>。最后，在满足这两个先决条件后，潜在的攻击者将必须能够通过反向代理直接从互联网到达Tomcat AJP连接器(默认端口8009 ),这是一个对外公开的AJP。如上所述，这不是推荐的或常见的配置。即使AJP连接器暴露，攻击者试图与之通信，他们也会收到来自web服务器的400错误请求响应，因为AJP是二进制协议。</p><p id="6fbc" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">为什么会存在这个漏洞？</strong></p><p id="4217" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">默认情况下，与HTTP连接相比，Tomcat认为AJP连接具有更高的信任级别。当AJP被正确实现时，该协议需要一个秘密，任何查询该协议的人都需要这个秘密。当使用默认的Tomcat配置时，这个秘密是不启用的，这意味着不会对进入端口8009的请求进行安全检查。这意味着未经验证的攻击者可以访问该端口来读取或可能写入服务器</p><blockquote class="mq mr ms"><p id="824f" class="kf kg mt kh b ki kj jr kk kl km ju kn mu kp kq kr mv kt ku kv mw kx ky kz la ij bi translated"><strong class="kh ir">在TRYHACKME </strong>上演练TOMGHOST机器</p></blockquote><h1 id="5c75" class="ll lm iq bd ln lo lp lq lr ls lt lu lv jw lw jx lx jz ly ka lz kc ma kd mb mc bi translated"><strong class="ak">在我们开始之前，给tryhackme说几句话</strong></h1></div><div class="ab cl mx my hu mz" role="separator"><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc"/></div><div class="ij ik il im in"><p id="307f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Tryhackme是目前学习黑客的最佳平台之一，它包括所有级别的所有课程，所以无论你是今天早上才开始学习黑客，还是你已经学习了2-3年，或者已经超过5年，这肯定会让你心动。这个平台的重点是通过这样做来学习，这对每个信息安全爱好者来说都是必须的</p><div class="ne nf gp gr ng nh"><a href="https://tryhackme.com/" rel="noopener  ugc nofollow" target="_blank"><div class="ni ab fo"><div class="nj ab nk cl cj nl"><h2 class="bd ir gy z fp nm fr fs nn fu fw ip bi translated">黑客培训</h2><div class="no l"><h3 class="bd b gy z fp nm fr fs nn fu fw dk translated">TryHackMe是一个学习和教授网络安全的在线平台，全部通过您的浏览器完成。</h3></div><div class="np l"><p class="bd b dl z fp nm fr fs nn fu fw dk translated">tryhackme.com</p></div></div></div></a></div><p id="2bd3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">现在让我们开始排练</strong></p><div class="ne nf gp gr ng nh"><a href="https://tryhackme.com/room/tomghost" rel="noopener  ugc nofollow" target="_blank"><div class="ni ab fo"><div class="nj ab nk cl cj nl"><h2 class="bd ir gy z fp nm fr fs nn fu fw ip bi translated">尝试黑客| tomghost</h2><div class="no l"><h3 class="bd b gy z fp nm fr fs nn fu fw dk translated">识别最近的漏洞，尝试利用系统或读取您不应访问的文件。</h3></div><div class="np l"><p class="bd b dl z fp nm fr fs nn fu fw dk translated">tryhackme.com</p></div></div><div class="nq l"><div class="nr l ns nt nu nq nv mo nh"/></div></div></a></div><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div role="button" tabindex="0" class="nx ny di nz bf oa"><div class="gh gi nw"><img src="../Images/f6764529e9a763ae8d0b8dd71227505b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-qrTiHynGNIFwza-Mv5VQg.png"/></div></div></figure><p id="ec1d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们首先部署机器</p><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div role="button" tabindex="0" class="nx ny di nz bf oa"><div class="gh gi nw"><img src="../Images/4b8dea095dc4bcf8b528534e787eac56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RhcLJng-H2yR2IAXz_lVzg.png"/></div></div></figure><p id="d095" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在让我们使用nmap对机器进行一些侦察</p><p id="9ff9" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ob oc od oe b"><strong class="kh ir">$ nmap -A -Pn [machine-ip]</strong></code></p><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div role="button" tabindex="0" class="nx ny di nz bf oa"><div class="gh gi nw"><img src="../Images/4e96380d242ea02eda543fdaa97eab75.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*buh1SF3Kcq1HyfrVXRbvwg.png"/></div></div></figure><p id="45e3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">他们把AJP暴露给每个人，我们可以在8009端口上看到完美！！！！！！！！！！！</p><p id="5b1f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，让我们来看看ghostcat漏洞的公开利用</p><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div role="button" tabindex="0" class="nx ny di nz bf oa"><div class="gh gi nw"><img src="../Images/59e13422653862181c65e55c8496dc59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d7ktjUqp_QnQhLQSrXWXFg.png"/></div></div></figure><p id="567a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">链接-<a class="ae lb" href="https://www.exploit-db.com/exploits/48143" rel="noopener ugc nofollow" target="_blank">https://www.exploit-db.com/exploits/48143</a></p><p id="506d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们下载漏洞并运行它</p><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div role="button" tabindex="0" class="nx ny di nz bf oa"><div class="gh gi nw"><img src="../Images/fb386451b766003a5ebd8d2fa01490fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Wp667vcEbDVS7mO5oNnaHg.png"/></div></div></figure><p id="28b8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> $ python2 48143.py -p 8009【机器IP】</strong></p><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div role="button" tabindex="0" class="nx ny di nz bf oa"><div class="gh gi nw"><img src="../Images/f9612e6341ef397671bf2b5473895047.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F-uAgiQBt8BfnNhJdPUWYw.png"/></div></div></figure><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div role="button" tabindex="0" class="nx ny di nz bf oa"><div class="gh gi nw"><img src="../Images/e19f72c221c4fa0ccd604fba8e5217d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JPqOz1aWZNW7R4XrwXyqHQ.png"/></div></div></figure><p id="79c8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是我们运行漏洞后得到的用户名和密码</p><p id="83a5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">好的，从我们的nmap扫描中，我们知道SSH服务在端口22上是打开的，所以让我们使用这些SSH凭据</p><p id="d951" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ob oc od oe b"><strong class="kh ir">$ ssh skyfuck@[machine-ip]</strong></code></p><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div role="button" tabindex="0" class="nx ny di nz bf oa"><div class="gh gi nw"><img src="../Images/3c048ea55173982e93299a1a439aae19.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sWcOciyM2FTg5nQH7g8Jdg.png"/></div></div></figure><p id="0b88" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们进去了</p><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div role="button" tabindex="0" class="nx ny di nz bf oa"><div class="gh gi nw"><img src="../Images/12ceff76d44b45efe12ec528c4f82141.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*t_2Gqau_XXFCgrjDDiq79Q.png"/></div></div></figure><p id="7064" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">好的，让我们来看看user.txt(用户标志)</p><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div role="button" tabindex="0" class="nx ny di nz bf oa"><div class="gh gi nw"><img src="../Images/41c6014fede01fbe6615c01a0a9581bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KVkYtsKbLb5cSWFEtNMVEg.png"/></div></div></figure><p id="99a6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">等等什么！可能有更多的用户这不是我们需要的user.txt文件的用户，所以让我们去/home目录</p><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div role="button" tabindex="0" class="nx ny di nz bf oa"><div class="gh gi nw"><img src="../Images/9d26222549b5a0f33eff57c57bb9340f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pUPYu1tSWFBrmR_ACk_MiQ.png"/></div></div></figure><p id="7a18" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">好的，还有一个用户叫梅林，让我们看看梅林目录的权限，我们可以进入吗</p><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div role="button" tabindex="0" class="nx ny di nz bf oa"><div class="gh gi nw"><img src="../Images/ed4a5c98cafebe5063e9f17216f60c94.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5WrHb0qKDxUuMIWTiqnd6A.png"/></div></div></figure><p id="a74a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">好的，我们被允许，让我们进入那个目录</p><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div role="button" tabindex="0" class="nx ny di nz bf oa"><div class="gh gi nw"><img src="../Images/0b32d2dedbe635f69ac86e3c26ec5f70.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XwS59vKkdNorQdEZolt1ZA.png"/></div></div></figure><p id="bde8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">好的，这是我们的user.txt文件，让我们检查一下在这个文本文件上设置了什么权限，我们可以读取用户标志吗</p><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div role="button" tabindex="0" class="nx ny di nz bf oa"><div class="gh gi nw"><img src="../Images/d911d387031e27bc0b4b7ce24bc86c5f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*S8kyg068v3o3dSQ4IiQPog.png"/></div></div></figure><p id="0a87" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">是的。！！！！我们现在可以使用cat命令读取文件了，但不能显示旗帜，抱歉</p><p id="0b63" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> $ cat user.txt </strong></p><p id="aad3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">好了，现在让我们检查这个用户skyfuck的sudo权限(我们就是)</p><p id="77c8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ob oc od oe b"><strong class="kh ir">$ sudo -l</strong></code></p><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div role="button" tabindex="0" class="nx ny di nz bf oa"><div class="gh gi nw"><img src="../Images/94170433ea52d7efd76d2f38f17f1aeb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RwMWPQsybf21DcHwnRoQ4A.png"/></div></div></figure><p id="a1d8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">哦，这个用户不在sudoers文件中，这意味着这个用户不能运行<em class="mt">特权命令，所以这个用户是没有用的。我们需要成为第二个用户(merlin)才能获得root </em></p><p id="f3fa" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">好吧，让我们看看这些有趣的文件在我们的用户skyfuck的主目录</p><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div role="button" tabindex="0" class="nx ny di nz bf oa"><div class="gh gi nw"><img src="../Images/04f988005d0e3e8853d9ab52053ec14b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-3PkSB28Cg4cHKRZxEhTkg.png"/></div></div></figure><p id="384d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">所以我们有一个名为credentials的pgp文件，它看起来很可疑，所以我们需要使用gpg工具解密这个文件</p><p id="3443" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们使用sftp连接到机器，因为用户在我们自己的系统上快速下载这两个文件</p><p id="9f79" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ob oc od oe b"><strong class="kh ir">$ sftp skyfuck@[machine-ip]</strong></code></p><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div role="button" tabindex="0" class="nx ny di nz bf oa"><div class="gh gi nw"><img src="../Images/faf2eabcc93d4ad592231b8281490fca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RNVODDZManbwY9tpCI6csA.png"/></div></div></figure><p id="f17b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在我们使用sftp连接到机器，现在让我们使用<code class="fe ob oc od oe b">get command</code>下载这两个文件</p><p id="b5e2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ob oc od oe b"><strong class="kh ir">sftp-&gt; get credential.pgp</strong></code></p><p id="2c94" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ob oc od oe b"><strong class="kh ir">sftp-&gt; get tryhackme.asc</strong></code></p><p id="4784" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在我们已经将这些文件下载到我们自己的系统中</p><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div role="button" tabindex="0" class="nx ny di nz bf oa"><div class="gh gi nw"><img src="../Images/3ef1728e494923f469330442e9825f2b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*drOHEb0f12dhOqbY7FLAPQ.png"/></div></div></figure><p id="e01e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们使用gpg2john来获得密钥</p><p id="0cfa" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ob oc od oe b"><strong class="kh ir">$ gpg2john tryhackme.asc &gt; hash</strong></code></p><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div role="button" tabindex="0" class="nx ny di nz bf oa"><div class="gh gi nw"><img src="../Images/617c1034f8eccf258283b6e79670d843.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wmHA5IWUsIn4450xwjnR9w.png"/></div></div></figure><p id="bde1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在让我们通过使用rockyou.txt单词表来破解开膛手约翰的哈希格式</p><p id="5e09" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">链接到word list-<a class="ae lb" href="https://github.com/brannondorsey/naive-hashcat/releases/download/data/rockyou.txt" rel="noopener ugc nofollow" target="_blank">https://github . com/brannon dorsey/naive-hashcat/releases/download/data/rock you . txt</a></p><p id="2faa" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ob oc od oe b"><strong class="kh ir">$ john --wordlist=rockyou.txt hash</strong></code></p><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div role="button" tabindex="0" class="nx ny di nz bf oa"><div class="gh gi nw"><img src="../Images/447ee38e9c24cee93031eee6065937a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nEGQxx77ubp8Df8yX5Z9_w.png"/></div></div></figure><p id="4731" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在我们得到了pgp加密的密码或密钥</p><p id="d802" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在使用命令在gpg中导入pgp密钥</p><p id="9d88" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ob oc od oe b"><strong class="kh ir">$ gpg --import tryhackme.asc</strong></code></p><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div role="button" tabindex="0" class="nx ny di nz bf oa"><div class="gh gi nw"><img src="../Images/03909cf612f43b00b1faaf870661a187.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uCY3Ryoo8CPIGbLD0gCuqQ.png"/></div></div></figure><p id="fe54" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在运行以下命令来解密pgp密钥</p><p id="205d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ob oc od oe b"><strong class="kh ir">$ gpg --decrypt credential.pgp</strong></code></p><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div role="button" tabindex="0" class="nx ny di nz bf oa"><div class="gh gi nw"><img src="../Images/fddeb4ee6cfa315b98b395a061cbf4ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ztl0a7hARhbB_J299V-bTQ.png"/></div></div></figure><p id="00ac" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在你会得到梅林的密码</p><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div role="button" tabindex="0" class="nx ny di nz bf oa"><div class="gh gi nw"><img src="../Images/3c42eeae12bfbb697110076d547561e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4N9Gn13o4i6Orp0QnJ5R4w.png"/></div></div></figure><p id="c5b1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，我们将在SSH会话中更改用户</p><p id="2d99" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ob oc od oe b"><strong class="kh ir">$ su merlin</strong></code></p><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div role="button" tabindex="0" class="nx ny di nz bf oa"><div class="gh gi nw"><img src="../Images/a4e352a8c6ca1c6153bad9fab4a9a6b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tMd7ZIqr-Eai5jDI_SvAZQ.png"/></div></div></figure><p id="f280" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在我们是我们所期望的用户意味着梅林</p><p id="98a5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们检查一下他可以以root用户身份运行哪些命令</p><p id="86cf" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ob oc od oe b"><strong class="kh ir">$ sudo -l</strong></code></p><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div role="button" tabindex="0" class="nx ny di nz bf oa"><div class="gh gi nw"><img src="../Images/b64a562bcbc77f41b148acd15322cfdc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R9uW-E0GYQzpV5IR46-Hlg.png"/></div></div></figure><p id="350f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">好了，现在我们可以以root用户身份运行zip命令，让我们看看如何提升<em class="mt">权限。</em></p><p id="5658" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">有一个关于黑客文章的博客，它告诉我们当一个用户被允许以root用户身份运行zip命令时，这个用户是如何成为root用户的</p><p id="082d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">链接-<a class="ae lb" href="https://www.hackingarticles.in/linux-for-pentester-zip-privilege-escalation/" rel="noopener ugc nofollow" target="_blank">https://www . hacking articles . in/Linux-for-pentester-zip-privilege-escalation/</a></p><p id="69b3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们使用了上面博客中描述的技术来成为root</p><p id="8502" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">首先我们创建一个名为raj.txt的文本文件</p><p id="0c00" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ob oc od oe b"><strong class="kh ir">$ touch raj.txt</strong></code></p><p id="0dd3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ob oc od oe b"><strong class="kh ir">$ </strong></code><strong class="kh ir">sudo zip 1 . zip Raj . txt-T—unzip-command = " sh-c/bin/bash "</strong></p><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div role="button" tabindex="0" class="nx ny di nz bf oa"><div class="gh gi nw"><img src="../Images/61e104ffc761c816e49a65390ef4b067.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OJVMlKOaPr9aqCQgnS0QZg.png"/></div></div></figure><p id="94db" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">huraay！！！！！！！！我们现在是黑客文章博客的粉丝</p><p id="e765" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在我们可以在/root中获得根标志</p><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div role="button" tabindex="0" class="nx ny di nz bf oa"><div class="gh gi nw"><img src="../Images/425414d1bc69264baa8d8f89f7fb86df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G6ZFfKBo0BIML4wbJ9wtFQ.png"/></div></div></figure><blockquote class="mq mr ms"><p id="b459" class="kf kg mt kh b ki kj jr kk kl km ju kn mu kp kq kr mv kt ku kv mw kx ky kz la ij bi translated"><strong class="kh ir">ghost cat漏洞修复</strong></p></blockquote><p id="377e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Apache Tomcat团队为解决Ghostcat问题所做的修复也应该进一步澄清其真正的局限性。在本节中，我们将详细介绍9.0.31版本中的代码修复，该版本主要与其他版本共享相同的代码。</p><p id="d82c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Ghostcat依赖于AJP连接器的错误配置(如下所示),默认情况下，它在/conf/server.xml文件中处于启用状态:</p><p id="2460" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><connector port="”8009″" protocol="”AJP/1.3″" redirectport="”8443″"/></p><p id="2848" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Apache Tomcat团队注释掉了文件中的这一行，从而在提交时默认禁用了AJP连接器<a class="ae lb" href="https://github.com/apache/tomcat/commit/4c933d80e340b4a841a672060351b2190b326782" rel="noopener ugc nofollow" target="_blank"> 4c933d8 </a></p><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div class="gh gi of"><img src="../Images/d858f3f550e89e1ff1d2d0e499020dfa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*4NufYxwm2HlpracAWUJvaw.jpeg"/></div><figcaption class="og oh gj gh gi oi oj bd b be z dk translated">该图显示了默认情况下禁用AJP连接器的提交<a class="ae lb" href="https://github.com/apache/tomcat/commit/4c933d80e340b4a841a672060351b2190b326782" rel="noopener ugc nofollow" target="_blank"> 4c933d8 </a></figcaption></figure><p id="8414" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">就其本身而言，上面的代码修复足以阻止Ghostcat的发生，因为它默认禁用AJP。只有在不使用AJP的情况下，才应该这样做。</p><p id="a1eb" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们详细介绍了第二种修复方法，这种方法不一定会禁用AJP，但会将其限制为默认情况下只侦听环回接口(图4)。Apache Tomcat团队进行了其他更改，以改进AJP协议的整体使用，例如当secretRequired属性设置为true时，强制定义一个秘密(图5)。他们还确保对AJP连接器的任何包含任意和未识别属性的请求都会收到403(禁止)响应</p><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div class="gh gi of"><img src="../Images/932c7f74f87f0a8b4df2d2eb623c6228.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*YU9F1MYa6q72ZG8xGZxG8Q.jpeg"/></div><figcaption class="og oh gj gh gi oi oj bd b be z dk translated">mage显示Commit <a class="ae lb" href="https://github.com/apache/tomcat/commit/0e8a50f0a5958744bea1fd6768c862e04d3b7e75" rel="noopener ugc nofollow" target="_blank"> 0e8a50f0 </a>，默认情况下强制AJP协议监听环回地址，而不是0.0.0.0。</figcaption></figure><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div class="gh gi of"><img src="../Images/24bd898089912d77a573ff4e0f326bad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*YGWZdIr3eUFXBzZMerFriQ.jpeg"/></div><figcaption class="og oh gj gh gi oi oj bd b be z dk translated">显示提交<a class="ae lb" href="https://github.com/apache/tomcat/commit/9ac90532e9a7d239f90952edb229b07c80a9a3eb" rel="noopener ugc nofollow" target="_blank"> 9ac90532 </a>的图像，该图像检查参数secretRequired是否设置为“真”,以及是否存在已定义的“秘密”</figcaption></figure><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div class="gh gi of"><img src="../Images/8fb928681f59ced90d06f0df67e51c8c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*XW_qecXsp_KRbljvHC9_lw.jpeg"/></div><figcaption class="og oh gj gh gi oi oj bd b be z dk translated">显示Commit <a class="ae lb" href="https://github.com/apache/tomcat/commit/64fa5b99442589ef0bf2a7fcd71ad2bc68b35fad" rel="noopener ugc nofollow" target="_blank"> 64fa5b99 </a>的图像，如果包含任何任意和不可识别的属性，该图像将使用403禁止消息响应阻止对AJP连接器的请求</figcaption></figure><h1 id="d1e3" class="ll lm iq bd ln lo lp lq lr ls lt lu lv jw lw jx lx jz ly ka lz kc ma kd mb mc bi translated">结论</h1><p id="3975" class="pw-post-body-paragraph kf kg iq kh b ki md jr kk kl me ju kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">鉴于这篇文章中讨论的所有内容，让用户认识到Ghostcat仍然存在风险仍然很重要，即使它不是默认的RCE。此漏洞已经有许多公开可用的攻击，这一事实应该促使用户尽快将他们的Tomcat更新到最新版本，以降低被利用的风险。</p><p id="961c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">作者:infosec_boy</p><div class="ne nf gp gr ng nh"><a href="https://twitter.com/infosec_boy" rel="noopener  ugc nofollow" target="_blank"><div class="ni ab fo"><div class="nj ab nk cl cj nl"><h2 class="bd ir gy z fp nm fr fs nn fu fw ip bi translated">阿努巴夫·曼德瓦尔</h2><div class="no l"><h3 class="bd b gy z fp nm fr fs nn fu fw dk translated">anubhav mandarwal的最新推文(@infosec_boy)。一个喜欢pwn机器和搜索信息安全漏洞的家伙…</h3></div><div class="np l"><p class="bd b dl z fp nm fr fs nn fu fw dk translated">twitter.com</p></div></div><div class="nq l"><div class="ok l ns nt nu nq nv mo nh"/></div></div></a></div><div class="ne nf gp gr ng nh"><a href="https://www.instagram.com/infosec_boy/" rel="noopener  ugc nofollow" target="_blank"><div class="ni ab fo"><div class="nj ab nk cl cj nl"><h2 class="bd ir gy z fp nm fr fs nn fu fw ip bi translated">登录* Instagram</h2><div class="no l"><h3 class="bd b gy z fp nm fr fs nn fu fw dk translated">欢迎回到Instagram。登录查看您的朋友、家人和兴趣爱好捕捉和分享了什么…</h3></div><div class="np l"><p class="bd b dl z fp nm fr fs nn fu fw dk translated">www.instagram.com</p></div></div></div></a></div><div class="ne nf gp gr ng nh"><a href="https://www.linkedin.com/in/anubhav-mandarwal-318952186/" rel="noopener  ugc nofollow" target="_blank"><div class="ni ab fo"><div class="nj ab nk cl cj nl"><h2 class="bd ir gy z fp nm fr fs nn fu fw ip bi translated">anubhav mandarwal -副威胁研究员-网络| LinkedIn</h2><div class="no l"><h3 class="bd b gy z fp nm fr fs nn fu fw dk translated">查看anubhav mandarwal在世界上最大的职业社区LinkedIn上的个人资料。anubhav有3份工作列在…</h3></div><div class="np l"><p class="bd b dl z fp nm fr fs nn fu fw dk translated">www.linkedin.com</p></div></div><div class="nq l"><div class="ol l ns nt nu nq nv mo nh"/></div></div></a></div><p id="7c68" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">特别感谢博客https://blog . trend micro . com/trend labs-security-intelligence/busting-ghost cat-an-analysis-of-the-Apache-Tomcat-vulnerability-CVE-2020-1938-and-cnvd-2020-10487/提供的精彩信息</p></div></div>    
</body>
</html>