<html>
<head>
<title>Creating a backdoor in PAM in 5 line of code</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用5行代码在PAM中创建一个后门</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/creating-a-backdoor-in-pam-in-5-line-of-code-e23e99579cd9?source=collection_archive---------0-----------------------#2022-06-04">https://infosecwriteups.com/creating-a-backdoor-in-pam-in-5-line-of-code-e23e99579cd9?source=collection_archive---------0-----------------------#2022-06-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/0aae558314b1a41e0222272baa7f9690.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*9Q9FxYR5By3Rqjzn"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">照片由<a class="ae kc" href="https://unsplash.com/@30daysreplay?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">30日在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上播放社交媒体营销</a></figcaption></figure><p id="106b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在Linux(和其他操作系统)下，用户的认证是通过可插拔认证模块进行的，也称为<a class="ae kc" href="https://en.wikipedia.org/wiki/Pluggable_authentication_module" rel="noopener ugc nofollow" target="_blank"> PAM </a>。拥有集中认证是一件好事。但是它有一个缺点:如果你把它锁起来，你会得到所有东西的钥匙。<em class="lb">木马一次，pwn遍地！</em></p><h1 id="094e" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">1/简介</h1><p id="aa4c" class="pw-post-body-paragraph kd ke iq kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la ij bi translated">Pam有三个概念:用户名、密码和服务。它作用是用密码向服务认证用户。<br/> <br/> Pam配置在/etc/pam.d/目录下完成，其中每个服务都有自己的文件:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="27c0" class="mo ld iq mk b gy mp mq l mr ms">root@dojo:/etc/pam.d# ls  <br/> atd             common-password        lightdm-greeter       polkit-1      sudo  <br/> chfn            common-session         login       ppp       systemd-user  <br/> chpasswd        common-session-noninteractive      runuser   vmtoolsd  <br/> chsh            cron                   newusers    runuser-l xscreensaver  <br/> common-account  lightdm                other       sshd  <br/> common-auth     lightdm-autologin      passwd      su  <br/> root@dojo:/etc/pam.d#</span></pre><p id="e480" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">基本上，这些文件中的每一个都调用一个共享库，在那里完成身份验证或其他与身份验证相关的事情:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="2186" class="mo ld iq mk b gy mp mq l mr ms">root@dojo:/etc/pam.d# head login  <br/> #  <br/> # The PAM configuration file for the Shadow `login' service  <br/> #  <br/> # Enforce a minimal delay in case of failure (in microseconds).  <br/> # (Replaces the `FAIL_DELAY' setting from login.defs)  <br/> # Note that other modules may require another minimal delay. (for example,  <br/> # to disable any delay, you should add the nodelay option to pam_unix)  <br/> auth    optional  pam_faildelay.so delay=3000000  <br/> root@dojo:/etc/pam.d#</span></pre><p id="89a9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">所有服务的配置文件都是相同的。我说过，我们想借壳帕姆。我们不想做任何事，我们只是希望能够用一个选择的密码成功地认证，而不依赖于用户的真实密码。<br/> <br/>几乎所有的服务都包含了<strong class="kf ir"> common-auth </strong>文件，你可以通过它的名字猜到这里做了什么。</p><h1 id="96bb" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">2/后门pam_unix.so in common-auth</h1><p id="cdc4" class="pw-post-body-paragraph kd ke iq kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la ij bi translated">common-auth文件有许多指令，但是这里唯一重要的一行是检查用户密码的那一行:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="a9f4" class="mo ld iq mk b gy mp mq l mr ms">auth       [success=1 default=ignore]      pam_unix.so nullok_secure</span></pre><p id="793f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">common-auth文件调用<strong class="kf ir"> pam_unix.so </strong>共享库，用户的认证在这里完成。这个文件的逻辑很容易理解:</p><ul class=""><li id="5eba" class="mt mu iq kf b kg kh kk kl ko mv ks mw kw mx la my mz na nb bi translated">获取用户名</li><li id="8a10" class="mt mu iq kf b kg nc kk nd ko ne ks nf kw ng la my mz na nb bi translated">获取密码</li><li id="00f2" class="mt mu iq kf b kg nc kk nd ko ne ks nf kw ng la my mz na nb bi translated">调用一个子函数来根据用户名验证密码</li></ul><p id="1f48" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">那么，为什么不加一个<strong class="kf ir"> <em class="lb"> if </em> </strong>语句呢？</p><ul class=""><li id="fe6f" class="mt mu iq kf b kg kh kk kl ko mv ks mw kw mx la my mz na nb bi translated">获取用户名</li><li id="294c" class="mt mu iq kf b kg nc kk nd ko ne ks nf kw ng la my mz na nb bi translated">获取密码</li><li id="7fc7" class="mt mu iq kf b kg nc kk nd ko ne ks nf kw ng la my mz na nb bi translated">如果password == "0xMitsurugi "则授予访问权，否则调用合法的子功能</li></ul><p id="a37d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们看看PAM的源代码(取决于您的发行版，使用与您相同的版本号..)并查看pam_unix_auth.c文件中第170/180行:<br/><br/>mitsurugi @ Dojo:~/chall/PAM/PAM _ deb/PAM-1 . 1 . 8 $ VI modules/PAM _ UNIX/PAM _ UNIX _ auth . c</p><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/e80803cf4e6c8af14149199045e9343f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1126/format:webp/0*yd-gw-KNDPigOeGM.png"/></div></figure><p id="a051" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们通过以下方式来改变这一点:</p><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/410ebf6db36f6160011852f4fe73761d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1212/format:webp/0*2s0vHSHqASz89b4k.png"/></div></figure><p id="4063" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">重新编译pam_unix_auth.c，最后替换pam_unix.so文件:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="9b0a" class="mo ld iq mk b gy mp mq l mr ms">mitsurugi@dojo:~/chall/PAM/pam_deb/pam-1.1.8$ make  <br/>  (...)  <br/> mitsurugi@dojo:~/chall/PAM/pam_deb/pam-1.1.8$ sudo cp \  <br/>  /home/mitsurugi/PAM/pam_deb/pam-1.1.8/modules/pam_unix/.libs/pam_unix.so \  <br/>  /lib/x86_64-linux-gnu/security/  <br/> mitsurugi@dojo:~/chall/PAM/pam_deb/pam-1.1.8$</span></pre><h1 id="74a8" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">3/盈利！</h1><p id="466e" class="pw-post-body-paragraph kd ke iq kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la ij bi translated">尝试用<strong class="kf ir">登录</strong>，用<strong class="kf ir">宋承宪</strong>，用<strong class="kf ir">须藤</strong>，用<strong class="kf ir">苏</strong>，用<strong class="kf ir">屏保</strong>，你的访问将被授予“0xMitsurugi”密码。对所有帐户开放访问\o/ <br/> <br/>最好的部分是，其他一切照常工作。输入你的真实密码，就可以了。放一个不好的，失败了。用户可以更改他们的密码，你可以审计影子文件的强度，你可以检查隐藏文件，你可以检查配置文件修改，打开端口，“奇怪的日志”，你会一无所获，但攻击者仍然可以进入。这样做的另一个好处是它可以长时间不被发现。<br/> <br/>您还可以添加日志记录功能，以便捕捉所有输入的密码，这是留给读者的练习。</p><h1 id="b5f9" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">4/负责任地享受</h1><p id="1104" class="pw-post-body-paragraph kd ke iq kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la ij bi translated">真正的朋友不会入侵他们朋友的机器。</p><h2 id="6a25" class="mo ld iq bd le nj nk dn li nl nm dp lm ko nn no lq ks np nq lu kw nr ns ly nt bi translated">5/自动化脚本</h2><p id="73a0" class="pw-post-body-paragraph kd ke iq kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la ij bi translated">点击<a class="ae kc" href="https://github.com/zephrax/linux-pam-backdoor" rel="noopener ugc nofollow" target="_blank">这里</a></p></div></div>    
</body>
</html>