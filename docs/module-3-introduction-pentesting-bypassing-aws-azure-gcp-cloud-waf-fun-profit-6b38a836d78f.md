# 模块 3 |简介-测试和绕过 AWS/Azure/GCP 云 WAF 的乐趣和收益

> 原文：<https://infosecwriteups.com/module-3-introduction-pentesting-bypassing-aws-azure-gcp-cloud-waf-fun-profit-6b38a836d78f?source=collection_archive---------3----------------------->

![](img/1e6fecd028361ad581d827b85a80c233.png)

# 1.为 AWS WAF 设置易受攻击的应用程序

> 我们将为 pentesting WAF 设置自定义 DVWA。

1.1.我们需要设置 ec2 实例，我们将在其中托管 DVWA。让我们首先通过单击“**启动实例**”来创建实例。

![](img/c807e4f9124f98e726b0f15a51dfa6d0.png)

1.2.为服务器选择一个 **Ubuntu 20.04 AMI** ，点击选择。

![](img/d99820e1b9e598455026b5f035976d72.png)

1.3.选择实例类型为 **T2 微**，点击**配置实例详情**。

![](img/2867b9ad9340730b2c73cf832a0e2529.png)

1.4.在**配置实例**中，保留所有默认设置。确保**自动分配公共 IP** 设置为**启用。**

![](img/40c1c4ca8a100d6ce95f94db146a9529.png)

1.5.存储保持 8 GB。它将出现在一个免费层。

![](img/d391505dd223171a0eaa72f31d076b14.png)

1.6.接下来，我们需要为 **HTTP 流量** & **SSH** 配置安全组。然后添加**源**为**我的 IP** 为**所有流量** & **SSH** 。

> 我们也可以选择端口 80，但这是实验室，所以我选择所有流量。对于源，将 IP 保留为 VPN 或静态 IP。我们将在设定 ELB 后再次修改这个。

![](img/53ac1a07e4c48f56575a3fbdd15522e3.png)

1.7.查看实例启动并点击**启动**。

![](img/5540cc9f8a11b63de5d58e0b4559abae.png)

1.8.然后登录到实例，我们将 ssh 键。我们将为 ssh 创建或选择一个现有的密钥对到实例中。

> 给你的密钥对起个名字吧。我们把它命名为 **ssh-key** 。

![](img/247c5a10e5074d7e20356064f6ece515.png)

1.9.检查实例状态，并等待实例启动。实例状态应该是**运行**。

![](img/06ddcf5e231f4772224004c11a287cb5.png)

1.10 .然后，要安装 DVWA，我们需要通过 ssh 登录:

```
#ssh -i ssh-key.pem ubuntu@34.218.245.107
```

![](img/0e420e1bb8074a7d30a70dd7a2d6ab90.png)

1.11.现在我们将安装自定义的 DVWA，它是从原来的 DVWA 派生出来的。

> 我特意定制了 DVWA 来表演和展示其他在最初的 DVWA 中不可能演示的攻击。

1.12 运行下面提到的命令来下载 Ubuntu 的 bash 脚本，它将设置预配置的 DVWA。

```
#sudo su
#wget [https://raw.githubusercontent.com/justmorpheus/waf-dvwa/main/automate.sh](https://raw.githubusercontent.com/justmorpheus/waf-dvwa/main/automate.sh)
#chmod +x automate.sh
#bash automate.sh
```

![](img/2537264e49fb13cbfa088420b76873f0.png)

1.13 现在检查 DVWA 安装，让我们通过 IP 访问实例。我们可以确认它正在工作。

> 不要公开 DVWA，因为它是一个易受攻击的应用程序。

![](img/916c5fa19981c49720de79d6990fdccd.png)

1.14 下面是 DVWA 存储的 XSS 的片段，我修改它来测试我的场景。

```
<!DOCTYPE html>
<html>
<body><?php  
$input = "https%2525252525253A%2525252525252F%2525252525252Fw3schools.in%2525252525252F";
$temp = urldecode($input);
while($temp != $input) {$input = $temp;
  $temp = urldecode($input);}
$message= $input;
echo $message;
?></body>
</html>
```

在这一部分，我试图递归解码多次 URL 编码的字符串。这将解码在任何字符串上执行的多 URL 编码。我从 [StackOverflow](https://stackoverflow.com/questions/22822676/html-url-decode-on-multiple-times-encoded-string) 那里得到这个。

# 2.设置 AWS WAF

2.1 我们需要设置 WAF，但在此之前，我们需要创建一个负载平衡器和目标组。

> 一个[目标组](https://docs.aws.amazon.com/en_pv/elasticloadbalancing/latest/application/load-balancer-target-groups.html)告诉负载均衡器将流量定向到哪里:EC2 实例，固定的 IP 地址；或者[AWSλ](https://aws.amazon.com/lambda/)功能等等。

2.2 我们将首先创建一个**目标群体**。选择位于 ec2 左侧面板的目标组选项，然后点击**创建目标组**。

![](img/c3275630ca7a11b2606b0d9e107bf2ef.png)

2.3.我们需要填写目标组名称的详细信息，并保持 VPC 为默认值。让我们把它保持为 **tg-waf** ，然后点击**下一个**。

![](img/dcadb1988fb7cde015b83e3a6e68ef45.png)

2.4.一旦创建了目标组，我们就需要注册将成为实例的目标。然后选择 EC2 在目标组中注册。

> 这个 ec2 是我们安装了易受攻击的 DVWA 的实例。请确保保持地区不变。

![](img/9b9c03ecac321de129bab84b3661b802.png)

2.5.添加目标后，我们需要单击创建目标组。

> 如果出现错误，我们需要检查“**健康状态详细信息**”。

![](img/b0faa08aed2829be818591839f478db8.png)

2.6.在这里，我们可以检查 ec2 是否已经成功添加到**目标组**中。

![](img/fca35cce45e5e69942d666eb1906ba77.png)

2.7.现在，我们将通过“负载平衡器”选项卡配置负载平衡器。点击**创建负载平衡器**。

![](img/bb91efa4218c367ec0b7262701274a50.png)

2.8.选择**应用负载平衡器**。填写负载平衡器名称并保留 VPC 的区域。

![](img/ca5a83e7c081afbc4934c3d7710feb8c.png)

2.9.我们至少需要选择**两个 VPC** ，这里我们选择了全部四个。

![](img/c4a1af6a49f1a7595f7522919a53f244.png)

2.10.然后在目标类型中选择 ***waf-elb*** ，即我们之前创建的**目标组。**

![](img/ada459802ea22ef166a2d053e05aaaab.png)

2.11.创建负载平衡器后，将对其进行设置。我们需要等待资源调配完成。

![](img/97c381eaf7646c8f487db86707f36c07.png)

2.12.从描述中复制 ALB ***DNS 名称*** 。

![](img/e77dadeb906a56c85243e46f21aa517d.png)

2.13.让我们尝试通过 ALB 访问 ec2。

> 这显示了一个错误，因为我们已经更新了 ec2 的安全组，允许流量通过 ALB。

![](img/59763aa9ff58528278ce0efdf76226bb.png)

2.14.现在，让我们对网络进行更改，以便只能通过 ELB 访问实例。
访问负载平衡器，并在安全中单击安全组。

![](img/8ba4965cc6caa8ef97e2ef5b3ebe6dd0.png)

2.15.在负载平衡器中选择安全组。然后编辑负载平衡器的安全组的入站规则。

> 确保允许从互联网到 ALB 的流量。添加 0.0.0.0/0，以便在未添加的情况下允许来自公众的流量。

![](img/919a796bbe373693dc1c99948604d00f.png)

2.16.然后切换回 ec2 并打开 ec2 实例的安全组。然后选择并编辑**入站流量规则。**

> 在这里，我们将把 ALB 安全组添加到 ec2 实验室入站规则的源中。

![](img/d14e30d525f0089ceaff285354bc9024.png)

2.17.我们需要选择并添加允许在端口 80 上为 HTTP 的流量，对于源，输入负载平衡器 sg-group 以允许从 ELB 到 ec2 实例的流量。

> 这是一个实验，因此选择了所有流量。

![](img/a69ae0035b8c8871f067246635411d0d.png)

2.18.现在，我们将尝试通过 DNS 名称访问 ALB。

![](img/d8b525f174bfd350a11278b5ca895c8c.png)![](img/672d7ef9970760962e3d372f415b5a97.png)

# 3.设置 AWS WAF

3.1.在 AWS 管理控制台中，在顶部的搜索栏中，输入 *WAF* ，在 **Services** 下，点击 **WAF & Shield** 结果。

> AWS Shield 是来自 Amazon 的基于订阅的服务，它保护资源免受拒绝服务(DOS)攻击。

![](img/ba088f1a1eb00153ee015e5cac650e67.png)

3.2.在左侧菜单的 **AWS WAF** 下，点击 **Web ACLs。**

3.3.在右侧，单击**创建 web ACL。**它将打开一个多步向导加载。然后在 **Web ACL 详细信息**部分，向下滚动到**区域**并选择**美国西部(俄勒冈州)。**

![](img/1fecf9294b6cdc603ef5da2ffac161ac.png)

> 我们正在这个地区创造资源。首先设置区域，因为有时更改区域会导致页面重新加载并删除其他表单字段。
> 此外，**云观察指标名称**字段应该会自动填充。

![](img/9c7d12bee726615a1612d4fcaaed56a8.png)

3.4.在右侧的**关联 AWS 资源**部分，点击打开的选项中的**添加 AWS 资源** ，在**资源类型**下，选择**应用负载均衡器。**

![](img/53dae0df574e2b02d1b6d81c1f6452e5.png)

3.5.然后我们需要启用规则。在步骤 2 中，添加规则和规则组。

![](img/f2247262ba0f5ade28f7f350d46563f8.png)

3.6.在**规则**部分，点击**添加规则**并点击**添加受管规则组。** 我们需要启用核心规则集，选择 AWS 管理的规则组，选择核心规则集。

> 受管规则组是由 AWS 或 AWS Marketplace 销售者提供的预定义规则组。
> 
> 来自市场销售者的规则组通常需要订阅并有与之相关的费用。这是使用 AWS WAF 监控 web 请求的附加费用。AWS 管理的规则组可以免费使用。

*   ***您也可以使用自己指定的规则创建自己的规则组。我们将在后面的部分看到这一点。***

![](img/95bb5f788398d3bbd8497d49b40770e1.png)

3.7 要查看可用的 AWS 提供的规则和规则组，请单击 **AWS 管理的规则组。**

![](img/e63b7e00e9ead5125b94140c2aaed2a9.png)

3.8 您将看到该部分展开，以及 AWS 提供的规则组列表。

*   向下滚动到核心规则集，并单击**添加到 web ACL** 切换。
*   选择其他相关规则，并从列表中启用其他规则。

> 注意:AWS 的总 WEB ACL 容量是 1500 个单位。

![](img/7b40bc18f423c1c1a7364e9b285df4a4.png)

# 4.CRS —核心规则集

*   我们上面创建的 ACL 没有定义规则，默认情况下允许所有流量进入。不是很有用是吗！要添加规则，您可以自己编写规则和/或使用预定义的管理规则组。使用托管规则组是最简单的入门方式，所以让我们从这里开始。
*   ModSecurity 是一个开源的基于 web 的防火墙应用程序(或 WAF ),由不同的 web 服务器支持。它附带了一个核心规则集(CRS ),其中包含各种针对跨网站脚本、不良用户代理、SQL 注入、特洛伊木马、会话劫持和其他利用的规则。ModSecurity 是使用核心规则集的引擎，即阻止或允许请求的基于签名的规则。

关于 CRS 的更多信息，请访问 https://coreruleset.org/[](https://coreruleset.org/)****。也为一个深入的教程由 CRS 的共同领导之一&一个惊人的人** [**基督教 Folini**](https://twitter.com/ChrFolini) **访问**[**https://www.netnea.com/cms/tutorials**](https://www.netnea.com/cms/tutorials/)**。****

> ***注意*:使用 AWS CLI，你可以创建一个使用 JSON 描述规则的 Web ACL。您还可以查看现有 Web ACL 的 JSON 定义，如果需要，可以很容易地在它们之间复制/粘贴。**

****4.1 使用托管规则组****

*   **受管规则组是一组预定义的规则，由 AWS 或第三方供应商管理。这些规则集针对各种威胁(如 [OWASP 十大威胁列表](https://owasp.org/www-project-top-ten/))提供即时保护，并不断更新以确保抵御新威胁。AWS 提供的规则是免费使用的，而第三方规则需要付费订阅。**
*   **您已经选择了一个规则组来识别包含已知 SQL 攻击(如 SQL 注入(有时也称为 SQLi)攻击)的 web 请求。SQL 注入攻击通常是包含 SQL 语法的 web 请求。安全性差的 web 应用程序可能会执行 SQL 语法，而不会安全地对其进行转义。如果攻击者可以在系统的 SQL 数据库上运行他们选择的 SQL，那么他们就可以用它来删除和修改数据。他们还可以利用它获得未经授权的更高级别的访问权限，从而危及整个系统。**
*   **实现良好的现代 web 应用程序不应该容易受到这种攻击。然而，大多数信息安全专家推荐一种叫做[深度防御](https://en.wikipedia.org/wiki/Defense_in_depth_(computing))的系统安全方法。这可以概括为将安全控制分层到系统的每个部分。**
*   **当遗留应用程序的安全模型没有被很好地记录或被怀疑是脆弱的时，这种 Web ACL 规则在将遗留应用程序迁移到云时可能特别有用。**

**![](img/950e1c7321a2aaaee7b82e606195ba2e.png)**

**4.2.要完成添加受管规则组，请滚动到底部并单击**添加规则。****

**4.3.您将返回到向导的**添加规则和规则组**部分。**

**4.4.在底部，点击下一个的**。****

**4.5.**设置规则优先级**页面允许您指定当 Web ACL 处理 Web 请求时规则的评估顺序。**

**![](img/7e97266d38495f9f3d360cd19b56a79c.png)****![](img/e0b54b14e6062aacfd2f4122e8152c89.png)**

**4.6.最后，点击**创建 web ACL** 。**

**![](img/f42954d238199e4e7cc33d896d33fc64.png)**

**4.7.名为 **waf-demo** 的 AWS Web 应用防火墙已成功创建。**

**![](img/8565cec041e99e80289659268bb11100.png)**

**4.8.然后访问负载平衡器 DNS 名称[http://waf-Load balancer-594844706 . ca-central-1 . elb . amazonaws . com/DVWA/log in . PHP](http://waf-loadbalancer-594844706.ca-central-1.elb.amazonaws.com/DVWA/login.php)**

**4.9.让我们进入有效载荷并测试晶片。它绝对工作正常。**

**![](img/58122a412ab706fe374b6ca550d92a8d.png)**

**在下一个模块中，我们还将实现 Azure & GCP WAF。**

# **摘要**

*   **参考[之前的博客](https://medium.com/@justm0rph3u5/module-2-owasp-modsecurity-core-rule-set-pentesting-bypassing-cloud-web-application-firewall-2594e17b35c1)了解核心规则集。**
*   **下一篇博客是关于测试 AWS WAF 的规则。**
*   **常见的方法和假阳性。**

# **参考**

*   **[https://medium . com/@ comp 87/deep-dive-into-the-AWS-web-application-firewall-waf-14148 ea 0d 3d](https://medium.com/@comp87/deep-dive-into-the-aws-web-application-firewall-waf-14148ea0d3d)**
*   **[https://medium . com/sec juice/waf-escalation-techniques-718026 d693 D8](https://medium.com/secjuice/waf-evasion-techniques-718026d693d8)**