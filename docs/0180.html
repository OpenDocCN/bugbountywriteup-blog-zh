<html>
<head>
<title>[Bug bounty | mail.ru] Access to the admin panel of the partner site and data disclosure of 2 million users</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">[Bug bounty | mail.ru]访问合作伙伴网站的管理面板，泄露200万用户的数据</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/bug-bounty-mail-ru-234fa6f5a5a?source=collection_archive---------0-----------------------#2018-10-12">https://infosecwriteups.com/bug-bounty-mail-ru-234fa6f5a5a?source=collection_archive---------0-----------------------#2018-10-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/8e750c7a75454638b7a6fb91c927c183.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*u1CYkUF5JTBvY406.png"/></div></div></figure><p id="5222" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi kw translated">相对而言，最近我从在随机网站上搜索漏洞转向了Bug Bounty网站，对于许多人来说，这种选择似乎是显而易见的——在这样的项目中，90%的情况下，研究人员不仅会获得良好的体验，还会因为有效的漏洞获得有保证的奖励，而在随机网站上，你可能会偶然发现误解和威胁。实际上，为了在最大的Bug Bounty——hacker one上获得声誉和“加速”,我们决定专注于寻找主要Bug Bounty程序之一——mail . ru上的漏洞。</p><p id="2695" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">本文将处理mail.ru本身的几个错误，以及mail.ru子域中的一个漏洞，该漏洞允许访问管理面板，因此有可能查看200万用户的个人数据(如电子邮件地址、电话号码、家庭地址等)。)与俄罗斯10多家热门网上商店，以及进入他们的账户无需密码。</p><p id="5753" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了在hackerone 上参与<a class="ae lf" href="https://hackerone.com/mailru" rel="noopener ugc nofollow" target="_blank"> bug bounty mail.ru，对3000个子域名进行了逐一整理和检查。我花了一小部分时间来处理这个漏洞，在大约3个月的时间里，我设法发送了45个有效的漏洞(</a><a class="ae lf" href="https://hackerone.com/w2w/thanks" rel="noopener ugc nofollow" target="_blank"> 40个现已修复，5个处于“已分类”状态</a>)。</p><p id="f59b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">前一段时间我开始研究子域redched _ shop . mail . ru——这是一个品牌产品的在线商店。</p><p id="2ad1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">大多数情况下，测试从个人账户的功能开始，这种情况也不例外。网站上的授权通过o2.mail.ru Oauth或输入电子邮件地址进行。如果我们考虑第二种方法，授权将如下:用户输入一个电子邮件，web app发送给他一个代码，他通过表单发送代码并进入帐户。这里<strong class="ka ir">发现了第一个漏洞——不正确的认证</strong>:</p><p id="9337" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">事实是，除了需要输入到表单中的代码本身之外，还会发送一个链接到表单redacted_shop.mail.ru/？login=hV8oUH，当您访问该帐户时，您将自动登录该帐户。这种链接通常被称为“自动登录”，这种功能存在于旧的WAP网站中。现在这种进账方式因为不安全，几乎不用了。</p><h2 id="b60c" class="lg lh iq bd li lj lk dn ll lm ln dp lo kj lp lq lr kn ls lt lu kr lv lw lx ly bi translated"><strong class="ak">漏洞影响:</strong></h2><ul class=""><li id="506f" class="lz ma iq ka b kb mb kf mc kj md kn me kr mf kv mg mh mi mj bi translated">攻击者可以进行暴力攻击，找出大量自动登录的标识符，进入别人的账号；</li><li id="3cec" class="lz ma iq ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated">登录链接可以被搜索引擎编入索引，并进入谷歌搜索结果问题，攻击者可以解析它们。有时，即使搜索机器人在robots.txt中被禁止，URL也可以在没有内容的情况下被索引。</li></ul><p id="5b6a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在仔细搜索目录之后(我使用dirb程序和一个自定义字典来搜索目录)，我开始测试用于更改个人数据、投递地址等的表单。表格中出现了CSRF代币，试图绕过保护的努力没有成功。没有XSS，也没有其他漏洞的提示(这样的结论是fuzzing后得出的)。</p><p id="95ad" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后，我将我的数据和交付地址更改为js有效载荷，并制作了一个商品测试订单，在注释中输入了另一个js有效载荷。</p><p id="b3bd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在00:10，我发现我的盲xss脚本在我不知道的admin.undefined.com/index站点的管理面板中被执行，并且我在服务器上接收日志。当时，甚至没有想到可以访问管理面板，因为大多数情况下cookies都受到http only标志的保护。</p><figure class="mq mr ms mt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mp"><img src="../Images/335850522088577c90a3747526cb9c55.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*sqFiHdx70MBX1uIv.png"/></div></div></figure><p id="eb2c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是，令我惊讶的是，没有旗帜，我成功地进入了管理区。该网站本身看起来像一个2000-2006年的y. CMS，设计非常陈旧，性能很差(页面加载时间很长),有很多php和sql错误。</p><p id="7e81" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在查看主页后，很明显管理面板与mail.ru有关，并且redated _ shop . mail.ru子域上的订单被信任来管理第三方网站(该团队后来表示它是合作伙伴，并且<br/>redated _ shop . mail . ru不是由mail . ru开发的)。在管理面板中，可以查看、编辑和删除来自10个在线商店(一些大型商店)的所有用户的订单，以及查看2，017，271个用户的个人数据。<strong class="ka ir">第二个漏洞盲XSS被证实。</strong></p><p id="2b9b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果入侵者可以访问管理面板，他可以通过一次点击下载包含所有用户信息的数据库，但是下载功能本身有一个php错误，所以他必须限制自己在管理面板中通过id搜索用户，并使用burp intrusive解析他们。</p><p id="deeb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此外，在管理面板中，每个用户的页面上都有一个自动登录的链接。也许一些读者还记得2007年流行的旧社交网络中的不安全自动登录——spcs . me等。</p><p id="b502" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我一进入管理面板，拍了几张截图，就立刻在hackerone上写了一份报告。<br/>00:20发送了一份详细报告。00:43左右，mail.ru的应用安全负责人谢尔盖·别洛夫(Sergey Belov)在一份报告中回答了我。他要求停止利用我的盲xss，并立即退出管理面板，我做到了。</p><figure class="mq mr ms mt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mu"><img src="../Images/652cbb262e2c9a68900de1bb12594246.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vBLxRKUImp-ARAWdYQHcMA.png"/></div></div></figure><p id="4f54" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">第二天早上，我检查了这个bug，由于日志没有到达我的服务器，我们可以假设它已经被修复了。此外，对管理面板的访问是关闭的，这只是受到IP访问的限制(很可能)。</p><p id="4987" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">不幸的是，redated _ shop . mail.ru子域不在mail . ru程序的Bug Bounty范围内，该漏洞不能声称得到奖励。因此，为了让花费在漏洞上的努力和时间得到回报，我联系了管理面板本身的开发者，并获得了报酬。</p><p id="4371" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我还发送了一份报告，报告了Bug Bounty中的第一个不正确的身份验证漏洞，同时充分了解该Bug很难被利用，我只会获得声誉点。作为漏洞的PoC我发了自动登录URL<em class="mv">redated _ shop . mail . ru/？login=hV8oUH </em>，在报告撰写过程中运行良好。但是，后来我收到了分析师的一条消息，说他无法重现这个错误，显然，开发人员禁用了自动登录功能，再也无法恢复帐户的密码或使用链接进入帐户。</p><p id="bad5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">几个月后，人们发现自动登录功能又被打开了，我把这件事告诉了开发人员，几天前这个错误终于被修复了。</p><h1 id="92ca" class="mw lh iq bd li mx my mz ll na nb nc lo nd ne nf lr ng nh ni lu nj nk nl lx nm bi translated">时间线:</h1><ul class=""><li id="ba64" class="lz ma iq ka b kb mb kf mc kj md kn me kr mf kv mg mh mi mj bi translated">4月12日00:20:50 —通过HackerOne发送报告。</li><li id="1bdd" class="lz ma iq ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated">4月12日00:43:03 —第一个答案。</li><li id="ecab" class="lz ma iq ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated">4月12日00时47分15秒—分庭审理。</li><li id="a0ce" class="lz ma iq ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated">4月26日19时14分38秒—报告标记为“已解决”。</li><li id="6f4c" class="lz ma iq ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated">6月27日00:59 —支付漏洞奖励。</li></ul><h2 id="04e7" class="lg lh iq bd li lj lk dn ll lm ln dp lo kj lp lq lr kn ls lt lu kr lv lw lx ly bi translated">发现的大部分bug是XSS、开放重定向和CSRF，但最有趣的是:</h2><ol class=""><li id="68b8" class="lz ma iq ka b kb mb kf mc kj md kn me kr mf kv nn mh mi mj bi translated">IDOR in lootdog.io支持服务【https://hackerone.com/reports/328337<a class="ae lf" href="https://hackerone.com/reports/328337" rel="noopener ugc nofollow" target="_blank"/>，透露了几百万张门票。</li><li id="5f94" class="lz ma iq ka b kb mk kf ml kj mm kn mn kr mo kv nn mh mi mj bi translated">我想告诉你关于mail.ru上的双重认证旁路漏洞，但不幸的是，7个月来，这个漏洞从未被修复并被标记为“信息性的”，他们不打算在不久的将来修复它，所以，不幸的是，这个漏洞不会在这里。<br/>我只能说，向手机版本的过渡绕过了保护，而在网页版本的保护是有效的。然而，当他们修复它时，你可以在我的推特上看到相关信息。</li><li id="3090" class="lz ma iq ka b kb mk kf ml kj mm kn mn kr mo kv nn mh mi mj bi translated">盲人XSS在宠物名中的pets.mail.ru上，允许黑进管理面板。</li><li id="f120" class="lz ma iq ka b kb mk kf ml kj mm kn mn kr mo kv nn mh mi mj bi translated">在****.mail.ru上发现了存储的XSS，在它的帮助下，有可能解除mail.ru的任何用户的匿名，并获得他的电子邮件，如果他只是按照链接。只需要用js创建一个页面。<br/>由于用户自动登录****.mail.ru，订阅字段中自动替换用户的邮箱，我们可以找到任何一个会关注我们咨询的链接的mail.ru用户的邮箱。有可能在页面的html源代码以及本地存储中看到电子邮件地址，它的值将被我们的嗅探器获取。</li><li id="730b" class="lz ma iq ka b kb mk kf ml kj mm kn mn kr mo kv nn mh mi mj bi translated">kayako.support.my.com/staff/index.php的<a class="ae lf" href="http://kayako.support.my.com/staff/index.php" rel="noopener ugc nofollow" target="_blank">盲XSS(loot dog . io的范围内支持)，后来被标记为“重复”。</a></li></ol><figure class="mq mr ms mt gt jr gh gi paragraph-image"><div class="ab gu cl no"><img src="../Images/2a48a9ed6852ac8aba09ce834d7e5083.png" data-original-src="https://miro.medium.com/v2/format:webp/1*D2MbmLXiW-5iVECZjN9w6w.png"/></div></figure><p id="405d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">6.登录am.ru上的帐户没有速率限制。该网站具有使用otp的登录功能，代码来自电话号码，对枚举号码没有限制，因此暴力攻击将有助于攻击任何只知道电话号码的帐户。</p><p id="af71" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">7.关于****mail.ru上的文章使用pictures @ mail . ru " &gt; CP-filin . mail . ru/pic的页面用户邮箱地址泄露？email=@mail.ru，类似于伊萨娃举报【https://hackerone.com/reports/258318】T2。</p><h1 id="10c7" class="mw lh iq bd li mx my mz ll na nb nc lo nd ne nf lr ng nh ni lu nj nk nl lx nm bi translated">本文的结论:</h1><ul class=""><li id="86aa" class="lz ma iq ka b kb mb kf mc kj md kn me kr mf kv mg mh mi mj bi translated"><strong class="ka ir">千万不要</strong>在授权中使用自动登录。</li><li id="2eb3" class="lz ma iq ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated">通过关闭对管理面板的访问，出现错误403。htaccess(如果您有apache服务器)，通过IP地址限制访问，要求验证。因此，攻击者将更难发现管理面板中的漏洞，此外，如果他窃取cookies或其他数据，他将无法使用它们。</li><li id="05a9" class="lz ma iq ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated">不要在管理面板中使用过时的软件。</li><li id="70ec" class="lz ma iq ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated">总是过滤进入管理区的信息中的禁止字符[" &lt;&gt; '/]，以避免XSS。</li></ul><h1 id="14a7" class="mw lh iq bd li mx my mz ll na nb nc lo nd ne nf lr ng nh ni lu nj nk nl lx nm bi translated">安检人员小贴士【盲人XSS】:</h1><ul class=""><li id="fd7a" class="lz ma iq ka b kb mb kf mc kj md kn me kr mf kv mg mh mi mj bi translated">尝试找到所有可以发送脚本的地方，例如，对页面/用户的投诉，站点评估，日志记录(尝试用脚本替换用户代理，它可能在没有过滤的管理面板的日志中)等等。</li><li id="0f41" class="lz ma iq ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated">由于过滤或CSP设置，您通常不会收到有关成功的盲xss攻击的日志。通过使用其他脚本绕过管理面板中的过滤器(例如meta、img——在许多情况下，这些脚本足以证明漏洞),并关闭标签，以便它们不会干扰执行。</li><li id="829d" class="lz ma iq ka b kb mk kf ml kj mm kn mn kr mo kv mg mh mi mj bi translated">如果管理面板在&lt;&gt;上过滤，试试运气，执行js注入”；警报(1)；//.</li></ul><p id="faa5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">页（page的缩写）s:推荐订阅我的<a class="ae lf" href="https://twitter.com/iSecMax" rel="noopener ugc nofollow" target="_blank"> twitter </a>了解最新文章。</p></div></div>    
</body>
</html>