<html>
<head>
<title>The Zaheck of Android Deep Links!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">安卓深度链接的Zaheck！</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/the-zaheck-of-android-deep-links-a5f57dc4ae4c?source=collection_archive---------1-----------------------#2020-04-19">https://infosecwriteups.com/the-zaheck-of-android-deep-links-a5f57dc4ae4c?source=collection_archive---------1-----------------------#2020-04-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="76f4" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph">有没有想过你的应用程序中的深层链接是攻击者破解你的应用程序的大门之一？</h2><div class=""/><figure class="gl gn ka kb kc kd gh gi paragraph-image"><div class="gh gi jz"><img src="../Images/37a17c5baff2777068bb3b1f1861c9ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1332/format:webp/1*TRhnVoKC6VELOe59YzbwLQ.jpeg"/></div></figure><p id="c7d3" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在当前混合移动架构的时代，网页浏览量和深度链接被广泛使用。前者用于交付动态web内容，而后者用于使应用程序更具交互性。</p><p id="aaf3" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这个故事中，我们将讨论与Webview和深度链接混合相关的常见安全错误配置。我们将主要讨论Bagipro对URL验证不足进行的惊人的安全研究，稍后我们将给出一些建议来缓解这个问题。</p></div><div class="ab cl lf lg hx lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="im in io ip iq"><p id="619b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这个故事也是为了那些可能不了解Android系统基本概念的安全传播者。先决条件一节涵盖了一些稍后会用到的概念，如果你已经清楚这些基本概念，可以跳过这一节。</p><h1 id="2920" class="lm ln it bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">先决条件</h1><h2 id="7929" class="mk ln it bd lo ml mm dn ls mn mo dp lw kr mp mq ma kv mr ms me kz mt mu mi iz bi translated">活动</h2><p id="5215" class="pw-post-body-paragraph kg kh it ki b kj mv kl km kn mw kp kq kr mx kt ku kv my kx ky kz mz lb lc ld im bi translated">activity是Android应用程序的组件之一，通俗地说，它可以被认为是一个<em class="na">屏幕</em>。它有一个用户界面，允许用户与应用程序进行交互。</p><figure class="nc nd ne nf gt kd gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/6d010cc5efa34daad34865d67e834098.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/format:webp/0*5zOhbMUfAIU2jQl7.jpg"/></div><figcaption class="ng nh gj gh gi ni nj bd b be z dk translated">交流意图的使用</figcaption></figure><h2 id="caa5" class="mk ln it bd lo ml mm dn ls mn mo dp lw kr mp mq ma kv mr ms me kz mt mu mi iz bi translated">意图和意图过滤器</h2><p id="47b6" class="pw-post-body-paragraph kg kh it ki b kj mv kl km kn mw kp kq kr mx kt ku kv my kx ky kz mz lb lc ld im bi translated">意图是一个消息传递对象，它允许不同应用程序组件(如活动、内容提供者、服务等)之间的通信。它可用于相同或不同应用程序的应用程序组件之间的通信。</p><p id="98ba" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">强烈推荐你看一下Pg。<a class="ae le" href="https://packetstormsecurity.com/files/download/147088/The_Grey_Matter_of_Securing_Android_Applications_v1.0.pdf" rel="noopener ugc nofollow" target="_blank">的第11和19页<strong class="ki jd">保护Android应用程序的灰色问题</strong> </a>旨在更好地理解意图和意图过滤器的概念。</p><h2 id="25ef" class="mk ln it bd lo ml mm dn ls mn mo dp lw kr mp mq ma kv mr ms me kz mt mu mi iz bi translated">网络视图</h2><p id="929f" class="pw-post-body-paragraph kg kh it ki b kj mv kl km kn mw kp kq kr mx kt ku kv my kx ky kz mz lb lc ld im bi translated">Android允许开发者通过Webviews将网页内容直接显示到他们的应用程序中。您可以将Webview视为应用程序的专用web浏览器。</p><h1 id="6c8b" class="lm ln it bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">深度链接是什么鱼！？</h1><p id="0070" class="pw-post-body-paragraph kg kh it ki b kj mv kl km kn mw kp kq kr mx kt ku kv my kx ky kz mz lb lc ld im bi translated">在web浏览器上浏览web内容时，您可能已经观察到浏览器调用安装在您设备上的特定应用程序来显示web内容的交互。下面这张GIF通过一个深度链接展示了浏览器和应用之间的交互。</p><figure class="nc nd ne nf gt kd gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/07c69327e2faa72458b6eb43c0c5ad4f.png" data-original-src="https://miro.medium.com/v2/resize:fit:600/0*JfB2zBZ9LBCb-vl5.gif"/></div></figure><p id="df42" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">深层链接只不过是特定的URIs(统一资源标识符)，必须由我们的应用程序来处理，以改善用户体验。例如，<strong class="ki jd"><em class="na">FB://profile/33138223345</em></strong>是深度链接，URI包含直接进入脸书移动应用内的特定位置所需的所有信息，在这种情况下，id为‘33138223345’的简档，即脸书应用内的维基百科页面。</p><p id="e3e8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在引擎盖下，我们有一个Android活动，一旦一个深层链接被触发，这个活动就会被调用。我们通常称这样的活动为<strong class="ki jd">可浏览活动</strong>，因为它们被配置为确认可浏览类别意图。可浏览活动必须有一个用三个元素定义的意图过滤器，即。<strong class="ki jd"> <em class="na">动作</em> </strong>，<strong class="ki jd"> <em class="na">类别</em> </strong>和<strong class="ki jd"> <em class="na">数据</em> </strong>如下面的AndroidManifest.xml片段所示。你可以在这里阅读更多关于这个<a class="ae le" href="https://developer.android.com/training/app-links/deep-linking" rel="noopener ugc nofollow" target="_blank"> <em class="na">的</em> </a>。</p><pre class="nc nd ne nf gt nl nm nn no aw np bi"><span id="f247" class="mk ln it nm b gy nq nr l ns nt">&lt;activity<br/>    android:name="com.example.android.GizmosActivity"<br/>    android:label="@string/title_gizmos" &gt;<br/><br/>    &lt;intent-filter android:label="@string/filter_view_example_gizmos"&gt;</span><span id="4900" class="mk ln it nm b gy nu nr l ns nt">        <strong class="nm jd">&lt;<em class="na">action</em> android:name="android.intent.action.VIEW" /&gt;<br/>        &lt;<em class="na">category</em> android:name="android.intent.category.DEFAULT" /&gt;<br/>        &lt;<em class="na">category</em> android:name="android.intent.category.BROWSABLE"/&gt;</strong></span><span id="cd8a" class="mk ln it nm b gy nu nr l ns nt">        &lt;!-- Accepts URIs that begin with "webviewdemoapp://” --&gt;<br/>        <strong class="nm jd">&lt;<em class="na">data</em> android:scheme="webviewdemoapp"/&gt;</strong></span><span id="5237" class="mk ln it nm b gy nu nr l ns nt">    &lt;/intent-filter&gt;<br/>&lt;/activity&gt;</span></pre><figure class="nc nd ne nf gt kd gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/b9133f6d8993d4aef7b74b46d03316fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:924/format:webp/0*ETdX-p25EIvtELdx.png"/></div></figure><p id="4a44" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki jd">注意:</strong>我们使用<strong class="ki jd"><em class="na">android:scheme</em></strong>标签在数据元素中定义了URI方案，因此现在Android系统不仅会使用此方案(<em class="na"> webviewdemoapp:// </em>)来确认URIs，而且一旦触发了此类深度链接，还会调用此可浏览活动，这就是深度链接的工作方式。</p><h1 id="f1eb" class="lm ln it bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">Zaheck</h1><h2 id="266f" class="mk ln it bd lo ml mm dn ls mn mo dp lw kr mp mq ma kv mr ms me kz mt mu mi iz bi translated"><strong class="ak">URL验证不足</strong></h2><p id="362b" class="pw-post-body-paragraph kg kh it ki b kj mv kl km kn mw kp kq kr mx kt ku kv my kx ky kz mz lb lc ld im bi translated">通常，每当我们在可浏览的活动中有Webview组件，并且想法是加载在深度链接URI中传递的web URLs时，强烈建议验证URL，以防止加载任意URL。<br/>2019年3月，<a class="ae le" href="https://hackerone.com/bagipro" rel="noopener ugc nofollow" target="_blank"> Bagipro </a>在Grab Passenger应用中报告了类似问题，他因其惊人的工作获得了7500美元的奖励。你可以在这里了解更多信息<a class="ae le" href="https://hackerone.com/reports/401793" rel="noopener ugc nofollow" target="_blank">。</a></p><pre class="nc nd ne nf gt nl nm nn no aw np bi"><span id="4105" class="mk ln it nm b gy nq nr l ns nt">For example if an application acknowledges the following deep link and opens the highlighted URL in the webview it is suggested that the proper validation should be performed.</span><span id="5363" class="mk ln it nm b gy nu nr l ns nt">webviewdemoapp://issue=1&amp;url=<strong class="nm jd"><em class="na">https://scripts.shivsahni.com/testsample.html</em></strong></span></pre><p id="44bc" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">以下代码片段显示了在webview中加载URL时的验证</p><pre class="nc nd ne nf gt nl nm nn no aw np bi"><span id="e64e" class="mk ln it nm b gy nq nr l ns nt">Uri uri = Uri.parse(deeplinkURL);/*<strong class="nm jd"><em class="na">https://scripts.shivsahni.com/testsample.html*/</em></strong></span><span id="a538" class="mk ln it nm b gy nu nr l ns nt">if("shivsahni.com".equals(uri.getHost() || uri.getHost().endsWith(".shivsahni.com"))<br/>{</span><span id="8c56" class="mk ln it nm b gy nu nr l ns nt">    webView.loadUrl(deeplinkURL);</span><span id="b51e" class="mk ln it nm b gy nu nr l ns nt">}</span></pre><blockquote class="nw"><p id="b9f7" class="nx ny it bd nz oa ob oc od oe of ld dk translated">虽然上述URL验证似乎足以防止URL的任意加载，但是由于<code class="fe og oh oi nm b">android.net.Uri</code>和<code class="fe og oh oi nm b">java.net.URL</code>解析器中的问题，验证仍然可以被绕过，对手仍然可以在我们的应用程序的webview中打开恶意URL</p></blockquote><p id="708d" class="pw-post-body-paragraph kg kh it ki b kj oj kl km kn ok kp kq kr ol kt ku kv om kx ky kz on lb lc ld im bi translated">问题是<code class="fe og oh oi nm b">android.net.Uri</code>和<code class="fe og oh oi nm b">java.net.URL</code>解析器不能识别权限部分中的反斜杠，这使得攻击者可以使用反斜杠来绕过前面提到的验证。同样的情况描述如下:</p><pre class="nc nd ne nf gt nl nm nn no aw np bi"><span id="7ca3" class="mk ln it nm b gy nq nr l ns nt">String url = "http://attacker.com\\\\@legitimate.com/smth"; Log.d("Wow", Uri.parse(url).getHost()); // legitimate.com is printed<br/>webView.loadUrl(url); // attacker.com is loaded</span></pre><p id="c998" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这项广泛的研究是由Bagipro完成的，你可以在这里<a class="ae le" href="https://hackerone.com/reports/431002" rel="noopener ugc nofollow" target="_blank">阅读更多相关信息</a>。</p><p id="39d6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最近，我对此做了更多的分析，发现API级别28及以上的问题现已修复，因为现在触发带有格式错误的URL的深度链接会在Chrome浏览器而不是应用程序的webview中加载攻击者的脚本。我在Pixel XL设备上测试了这种行为。</p><p id="9b4c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这样的问题实际上可以成为P0安全问题，考虑这样一种情况，其中特权Webview(例如:带有<a class="ae le" href="https://developer.android.com/reference/android/webkit/WebView#addJavascriptInterface(java.lang.Object,%20java.lang.String)" rel="noopener ugc nofollow" target="_blank"> JS接口</a>)用于支持这样的功能，缺乏适当的URL验证可能允许对手分发具有恶意JavaScript的攻击者控制的URL的深度链接，这甚至允许通过JS桥执行Java功能，因此甚至可能导致用户的敏感信息如PII和auth令牌的泄露。此外，攻击者只需拥有恶意JavaScript并分发带有恶意URL的deeplink，就可以远程利用该攻击。</p><h2 id="1ebd" class="mk ln it bd lo ml mm dn ls mn mo dp lw kr mp mq ma kv mr ms me kz mt mu mi iz bi translated">建议</h2><p id="608b" class="pw-post-body-paragraph kg kh it ki b kj mv kl km kn mw kp kq kr mx kt ku kv my kx ky kz mz lb lc ld im bi translated">尽管这个问题在API级别28中得到了修复，并且根据统计数据，Android 9占据了主要的市场份额，但我们仍然需要支持以前的API来保持业务照常进行。建议验证完整的URL，包括方案、权限等。最好的方法是使用正则表达式。</p><p id="df30" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">建议的方法之一如下所示:</p><pre class="nc nd ne nf gt nl nm nn no aw np bi"><span id="e633" class="mk ln it nm b gy nq nr l ns nt">private fun validateURL(urlString: String):Boolean{</span><span id="39c3" class="mk ln it nm b gy nu nr l ns nt">try {<br/>    URL urlObject= new URL(urlString);<br/>    if((urlObject.getAuthority()=="shivsahni.com") &amp;&amp; (urlObject.getHost()=="https"))<br/>            return true;<br/>}<br/>catch (MalformedURLException e)<br/>{<br/>    e.printStackTrace();<br/>    return false;<br/>}</span><span id="c7af" class="mk ln it nm b gy nu nr l ns nt">}</span></pre><p id="ae0e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">除了充分的URL验证之外，还建议对webview进行适当的加固，以控制其受到损害的情况下的影响。要强化webview，请记住以下几点:</p><ol class=""><li id="6af8" class="oo op it ki b kj kk kn ko kr oq kv or kz os ld ot ou ov ow bi translated">每当您需要在您的应用webview中加载不可信的web内容时，通过使用<a class="ae le" href="https://developer.chrome.com/multidevice/android/customtabs" rel="noopener ugc nofollow" target="_blank"> Chrome定制标签</a>来执行充分的webview隔离</li><li id="8d78" class="oo op it ki b kj ox kn oy kr oz kv pa kz pb ld ot ou ov ow bi translated">除非明确要求，否则禁止从webview访问JavaScript:: <code class="fe og oh oi nm b">setJavaScriptEnabled(false)</code>、文件系统::<code class="fe og oh oi nm b">setAllowFileAccess(false)</code>和内容提供商::<code class="fe og oh oi nm b">setAllowConentAccess(false)</code>。</li></ol><p id="c928" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">你可以参考这个令人敬畏的关于强化Android webviews的<a class="ae le" href="https://wiki.sei.cmu.edu/confluence/pages/viewpage.action?pageId=87150638" rel="noopener ugc nofollow" target="_blank"> confluence </a>。</p></div></div>    
</body>
</html>