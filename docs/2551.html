<html>
<head>
<title>Write-up: Basic server-side template injection @ PortSwigger Academy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">撰写:基本服务器端模板注入@ PortSwigger Academy</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/write-up-basic-server-side-template-injection-portswigger-academy-8e74931c6bd7?source=collection_archive---------5-----------------------#2022-11-21">https://infosecwriteups.com/write-up-basic-server-side-template-injection-portswigger-academy-8e74931c6bd7?source=collection_archive---------5-----------------------#2022-11-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/9284fd464f3f0cd572dcd2551d973be9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*BHGEwRoYhNMIIHVE.png"/></div></div></figure><p id="502b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这篇关于实验室<em class="kw">基本服务器端模板注入</em>的文章是我为<a class="ae kx" href="https://portswigger.net/web-security" rel="noopener ugc nofollow" target="_blank"> PortSwigger的Web安全学院</a>所做的系列演练的一部分。</p><p id="cfcc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">学习路径</strong>:高级主题→服务器端模板注入</p><div class="ky kz gp gr la lb"><a href="https://portswigger.net/web-security/server-side-template-injection/exploiting/lab-server-side-template-injection-basic" rel="noopener  ugc nofollow" target="_blank"><div class="lc ab fo"><div class="ld ab le cl cj lf"><h2 class="bd ir gy z fp lg fr fs lh fu fw ip bi translated">实验室:基本服务器端模板注入|网络安全学院</h2><div class="li l"><h3 class="bd b gy z fp lg fr fs lh fu fw dk translated">练习利用现实目标的弱点。记录你从学徒到专家的进步。看哪里…</h3></div><div class="lj l"><p class="bd b dl z fp lg fr fs lh fu fw dk translated">portswigger.net</p></div></div><div class="lk l"><div class="ll l lm ln lo lk lp jw lb"/></div></div></a></div><p id="6490" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Python脚本:<a class="ae kx" href="https://github.com/frank-leitner/portswigger-websecurity-academy/blob/main/18_server_side_template_injection/Basic_server-side_template_injection/script.py" rel="noopener ugc nofollow" target="_blank"> script.py </a></p><h1 id="8dde" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">实验室描述</h1><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mo"><img src="../Images/abb29ac68efebe8acac7f84c7f17e788.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*pzQWEnCEiJ6xDLnl.png"/></div></div></figure><h1 id="b571" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">步伐</h1><h2 id="67cb" class="mt lr iq bd ls mu mv dn lw mw mx dp ma kj my mz me kn na nb mi kr nc nd mm ne bi translated">分析</h2><p id="d316" class="pw-post-body-paragraph jy jz iq ka b kb nf kd ke kf ng kh ki kj nh kl km kn ni kp kq kr nj kt ku kv ij bi translated">通常，第一步是分析实验室应用程序的功能。在这个实验室中，它是一个商店网站。</p><p id="cab1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我没有任何凭证，也没有任何登录功能。因此，该漏洞在公共页面上。我浏览了一下，检查了应用程序对URL参数的使用。</p><p id="aa51" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于产品细节，<code class="fe nk nl nm nn b">productID</code>是通过URL传递的，应用程序使用它来加载适当的信息。</p><p id="2748" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于一种产品，我收到了缺货通知。页面上的链接包含普通的<code class="fe nk nl nm nn b">productID</code>参数。应用程序似乎在检查服务器端的可用性。如果产品缺货，服务器会重定向到主页面，并将相应的消息作为URL参数。浏览器随后会请求此页面:</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi no"><img src="../Images/7c96f7d081b291f71750283d4865908c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*LVuvKqER-kL6p3Zn.png"/></div></div></figure><p id="3b4f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">响应包含嵌入在<code class="fe nk nl nm nn b">div</code>标签中的消息。</p></div><div class="ab cl np nq hu nr" role="separator"><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu"/></div><div class="ij ik il im in"><h2 id="334e" class="mt lr iq bd ls mu mv dn lw mw mx dp ma kj my mz me kn na nb mi kr nc nd mm ne bi translated">寻找漏洞</h2><p id="9e4e" class="pw-post-body-paragraph jy jz iq ka b kb nf kd ke kf ng kh ki kj nh kl km kn ni kp kq kr nj kt ku kv ij bi translated">我不知道是否对消息文本进行了任何清理。但是作为URL参数的完整消息文本的存在值得仔细观察。</p><p id="105e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了执行各种测试，我向打嗝中继器发送了<code class="fe nk nl nm nn b">/?message=</code>请求。</p><p id="9246" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">作为第一项检查，我测试了一条包含各种urlencoded特殊字符的消息，这些字符经常在模板<code class="fe nk nl nm nn b">${{&lt;%[%'"}}%\</code>中使用:</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nw"><img src="../Images/8cc8d8071f58d3e8578d1a2cca0eb42a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*K9t9yoPk-tFqpm_W.png"/></div></div></figure><p id="91f9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">结果显示字符<code class="fe nk nl nm nn b">&lt;%</code>不包含在响应中。这可能是由于某些清理或服务器上的某些逻辑(如模板引擎)对其进行了评估。</p><p id="bd51" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">实验室描述引用了ERB模板，所以我去查看了Ruby模板的文档。</p><p id="996a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">文档说明<code class="fe nk nl nm nn b">&lt;%</code>和<code class="fe nk nl nm nn b">%&gt;</code>分别被用作模板表达式的开始和结束。这与我上面的发现一致。</p><p id="b2c4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">表达式可以用语法<code class="fe nk nl nm nn b">&lt;%= Ruby expression %&gt;</code>来计算，所以我尝试执行一个简单的数学运算:</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nx"><img src="../Images/f718b4b49422e5189d0a92dbe98e4ae5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*IlFmmHB7y7xOq_ti.png"/></div></div></figure><p id="a3a6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">响应包含数学结果，而不是消息文本。这表明我可以在服务器上执行任意ERB表达式。</p></div><div class="ab cl np nq hu nr" role="separator"><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu"/></div><div class="ij ik il im in"><h2 id="99cd" class="mt lr iq bd ls mu mv dn lw mw mx dp ma kj my mz me kn na nb mi kr nc nd mm ne bi translated">恶意负载</h2><p id="d747" class="pw-post-body-paragraph jy jz iq ka b kb nf kd ke kf ng kh ki kj nh kl km kn ni kp kq kr nj kt ku kv ij bi translated">根据ERB的文档，任意的ruby代码都可以被<code class="fe nk nl nm nn b">&lt;% Ruby code -- inline with output %&gt;</code>执行。</p><p id="04dd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我继续搜索文档，直到找到合适的方法来删除文件。</p><p id="0a48" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我有了制造恶意载荷所需的所有信息。fileutils模块不是直接可用的，所以我需要先要求它:<code class="fe nk nl nm nn b">&lt;% require 'fileutils'; FileUtils.rm '/home/carlos/morale.txt' %&gt;</code></p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ny"><img src="../Images/2c4bf87675c02ed1800e007dce29317c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*NYgMJTlBRMA2Zmdc.png"/></div></div></figure><p id="088b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">该请求不会导致任何错误。<code class="fe nk nl nm nn b">div</code>为空，但这是意料之中的，因为<code class="fe nk nl nm nn b">FileUtils.rm</code>没有返回任何东西。在浏览器中刷新实验室应用程序显示实验室已解决:</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nz"><img src="../Images/7aebe0d31e68fe40f5dd298489b2b90f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*YdecMrtbarfUbIIp.png"/></div></div></figure></div><div class="ab cl np nq hu nr" role="separator"><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu"/></div><div class="ij ik il im in"><h1 id="27dc" class="lq lr iq bd ls lt oa lv lw lx ob lz ma mb oc md me mf od mh mi mj oe ml mm mn bi translated">如何避免这一缺陷</h1><p id="a49f" class="pw-post-body-paragraph jy jz iq ka b kb nf kd ke kf ng kh ki kj nh kl km kn ni kp kq kr nj kt ku kv ij bi translated">通过在URL中不包含消息文本，而是使用ID和包含消息的服务器端查找表，可以避免这些问题中的大部分(与任意文本消息相比，清理已知的ID格式要容易得多)。</p></div><div class="ab cl np nq hu nr" role="separator"><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu"/></div><div class="ij ik il im in"><p id="b2d9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="kw">最初发表于</em><a class="ae kx" href="https://github.com/frank-leitner/portswigger-websecurity-academy/tree/main/18_server_side_template_injection/Basic_server-side_template_injection" rel="noopener ugc nofollow" target="_blank"><em class="kw">https://github.com</em></a><em class="kw">。</em></p><p id="9517" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe nk nl nm nn b"><a class="ae kx" href="https://medium.com/@frank.leitner/membership" rel="noopener">New to Medium? Become a Medium member to access all stories on the platform and support me at no extra cost for you!</a></code></p></div><div class="ab cl np nq hu nr" role="separator"><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu"/></div><div class="ij ik il im in"><h2 id="8bc7" class="mt lr iq bd ls mu mv dn lw mw mx dp ma kj my mz me kn na nb mi kr nc nd mm ne bi translated">来自Infosec的报道:Infosec每天都有很多内容，很难跟上。<a class="ae kx" href="https://weekly.infosecwriteups.com/" rel="noopener ugc nofollow" target="_blank">加入我们的每周简讯</a>以5篇文章、4个线程、3个视频、2个GitHub Repos和工具以及1个工作提醒的形式免费获取所有最新的Infosec趋势！</h2></div></div>    
</body>
</html>