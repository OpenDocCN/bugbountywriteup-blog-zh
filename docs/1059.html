<html>
<head>
<title>Unauthorized Access to OData Entities + $2K Bounty From Microsoft</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">对OData实体的未授权访问+来自微软的2000美元奖金</h1>
<blockquote>原文：<a href="https://infosecwriteups.com/unauthorized-access-to-odata-entities-2k-bounty-from-microsoft-e070b2ef88c2?source=collection_archive---------0-----------------------#2021-01-10">https://infosecwriteups.com/unauthorized-access-to-odata-entities-2k-bounty-from-microsoft-e070b2ef88c2?source=collection_archive---------0-----------------------#2021-01-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/5ab46ca97c6d7f05e18d4c440df90e35.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*lmTFDSNss95PS5s8SHdwXQ.png"/></div></figure><p id="ebe8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">嗨，这篇文章是关于我从微软发现的一个漏洞。</p><p id="72ea" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如你所知，Office365有各种服务。一项吸引我注意力的服务是微软的表单。这是一个在线调查创建器，是Office 365的一部分。您可以创建表单并与其他用户共享。该服务使用OData与数据进行交互。但是什么是OData呢？</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div class="gh gi ks"><img src="../Images/1c3e6e81f9a8fe80e72577debff5bd42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1194/format:webp/1*4_--l2dINZqHF0BXZlFEtQ.png"/></div></figure></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><h1 id="b19d" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">OData基础知识</h1><blockquote class="mc md me"><p id="9fe2" class="ju jv mf jw b jx jy jz ka kb kc kd ke mg kg kh ki mh kk kl km mi ko kp kq kr ij bi translated">OData协议是一个应用程序级协议，用于通过RESTful接口与数据进行交互。它支持数据模型的描述，以及根据这些模型对数据进行编辑和查询。[docs.microsoft.com]</p></blockquote><p id="d869" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir"> OData </strong>使用了SQL的思想。通过说我不介意什么类型的客户(例如。NET、Java)向我发送一个请求或者站点的数据源是什么，我从客户端接收请求，基于客户端想要的工作类型，我对数据执行CRUD操作，并将结果返回给客户端。</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi mj"><img src="../Images/7d18e7c1da1ac5507d5edab7b6bbe652.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IK_ZqSEn6C88pXk5Z3qnEw.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated"><a class="ae ms" href="https://www.progress.com/blogs/what-is-odata-rest-easy-with-our-quick-guide" rel="noopener ugc nofollow" target="_blank">https://www . progress . com/blogs/what-is-odata-rest-easy-with-our-quick-guide</a></figcaption></figure><p id="d2ae" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为了简单起见，我解释了这个协议的一些概念，并做了一些等价的说明。<strong class="jw ir"> OData元数据</strong>是系统的一个数据模型(在关系数据库中可以认为是<strong class="jw ir"> information_schema </strong>)。对于每个元数据，我们有<strong class="jw ir">实体</strong>(类似于关系数据库中的<strong class="jw ir">表</strong>)和<strong class="jw ir">属性</strong>(类似于<strong class="jw ir">列</strong>)以及不同实体类型之间的关系。每个实体类型都有一个<strong class="jw ir">实体键</strong>，类似于关系数据库中的键。假设我们有一个名为Customers的实体类型，它包含三个属性。此实体类型具有以下记录:</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/b44ccc2893bf6d2a870eae913ee27547.png" data-original-src="https://miro.medium.com/v2/resize:fit:852/format:webp/1*0cEhmzF6bhKX1ibnj-uGeQ.png"/></div></figure><p id="2906" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在上面的例子中，<strong class="jw ir"> ID </strong>是一个实体键。下面的请求返回给定ID为“2”的客户类型的单个记录:</p><pre class="kt ku kv kw gt mu mv mw mx aw my bi"><span id="cf6b" class="mz lf iq mv b gy na nb l nc nd">customerApi/Customers(2)</span></pre><p id="c0c0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">上面的请求返回ID=2的客户信息。类似于SQL，我们可以使用查询选项来查询数据。OData支持各种<strong class="jw ir">查询选项</strong>来查询数据。我们可以使用<strong class="jw ir"> $select </strong>查询选项为每个实体请求一组有限的属性。以下查询是一个示例，它将从Customers实体中获取ID为2的客户的电子邮件:</p><pre class="kt ku kv kw gt mu mv mw mx aw my bi"><span id="dc53" class="mz lf iq mv b gy na nb l nc nd">customerApi/Customers(2)?<strong class="mv ir">$select=email</strong></span></pre><p id="bb9c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在SQL中，上面的示例如下:</p><pre class="kt ku kv kw gt mu mv mw mx aw my bi"><span id="b6ca" class="mz lf iq mv b gy na nb l nc nd">SELECT email FROM Customers WHERE ID=2;</span></pre><p id="3f72" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">到目前为止，我解释的概念足以理解这篇文章的后续部分。除了<strong class="jw ir"> $select </strong>之外，还可以使用不同的查询选项。您可以使用<strong class="jw ir"> $format </strong>选择数据的输出，无论是JSON还是XML。要了解更多细节并熟悉其他查询选项，我建议您<a class="ae ms" href="http://odata.org" rel="noopener ugc nofollow" target="_blank">这个</a>链接，它是OData的主要参考。</p></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><h1 id="30a9" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">攻击场景</h1><blockquote class="ne"><p id="cc62" class="nf ng iq bd nh ni nj nk nl nm nn kr dk translated">“有一件事我一直牢记在心，那就是我会先试着了解系统的概况，然后开始测试每个组件。”T9】</p></blockquote><p id="5af4" class="pw-post-body-paragraph ju jv iq jw b jx np jz ka kb nq kd ke kf nr kh ki kj ns kl km kn nt kp kq kr ij bi translated">在这个目标中，我首先尝试访问OData元数据，因为我知道目标正在使用OData，我最好了解一下元数据的结构。通过向以下URL发送请求，我能够访问目标的元数据:</p><pre class="kt ku kv kw gt mu mv mw mx aw my bi"><span id="01e5" class="mz lf iq mv b gy na nb l nc nd">http://forms.office.com/formapi/api/$metadata</span></pre><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nu"><img src="../Images/e814a4bef48a92b8c5413cde05a7b401.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4U27nEcwY-pnBJ1_clwCDQ.png"/></div></div></figure><p id="7544" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我对上面的XML文档不感兴趣。所以我使用了下面的网站来更好地查看不同实体类型之间的连接:</p><div class="nv nw gp gr nx ny"><a href="http://pragmatiqa.com/xodata" rel="noopener  ugc nofollow" target="_blank"><div class="nz ab fo"><div class="oa ab ob cl cj oc"><h2 class="bd ir gy z fp od fr fs oe fu fw ip bi translated">XOData -在线可视化和探索OData服务</h2><div class="of l"><h3 class="bd b gy z fp od fr fs oe fu fw dk translated">探索OData API - OData元数据图表/文档和OData查询生成器</h3></div><div class="og l"><p class="bd b dl z fp od fr fs oe fu fw dk translated">pragmatiqa.com</p></div></div></div></a></div><p id="09f0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这个网站是一个通用的OData API/服务可视化工具和浏览器。它有一个很酷的功能，你可以给出OData元数据的链接，它向你展示了不同实体类型之间的联系:</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nu"><img src="../Images/b7e42d65b47db87f92259ae415a849c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T4wsCqwr8prWxSMxS_gc5w.png"/></div></div></figure><p id="0bd6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在了解了元数据的概况后，我试图寻找可能包含敏感信息的实体。我发现一个名为<strong class="jw ir">的实体类型形成了</strong>。这个实体有用户生成的表单数据以及<strong class="jw ir">用户的电子邮件</strong> : ‌</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nu"><img src="../Images/4707d5127e3581696bb9955a4771aefb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Nl8EjxmPGYUKEponLV3cwQ.png"/></div></div></figure><p id="ffb4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这封邮件让我思考如何访问其他用户的邮件？伊多和CORS在这里是不可能的。在测试了不同的攻击场景后，我发现了一种访问另一个用户电子邮件的方法。但是问题是我的攻击场景需要用户交互(受害者访问攻击者的站点等等)。用户交互减少了我的攻击场景的影响。在把我的报告送到MSRC后，我只得到了微软的名人堂。</p></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><h1 id="a97c" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated"><strong class="ak">对OData实体的未授权访问</strong></h1><p id="a49c" class="pw-post-body-paragraph ju jv iq jw b jx oh jz ka kb oi kd ke kf oj kh ki kj ok kl km kn ol kp kq kr ij bi translated">在我没有得到任何赏金后，我试着用不同的眼光看待目标。我之前的攻击场景需要用户交互，所以我必须找到一种无需任何用户交互就能访问电子邮件的方法。<br/>在微软表单中，用户可以与其他人共享表单。我试图测试文件共享功能。如果<strong class="jw ir">用户A </strong>想要与<strong class="jw ir">用户B </strong>共享一个表格，需要以下步骤:</p><ol class=""><li id="2bb4" class="om on iq jw b jx jy kb kc kf oo kj op kn oq kr or os ot ou bi translated">用户A选择要共享的表单。服务器为用户a生成一个可共享链接。</li><li id="a418" class="om on iq jw b jx ov kb ow kf ox kj oy kn oz kr or os ot ou bi translated">用户A将上一步生成的链接发送给用户b。</li><li id="3bb3" class="om on iq jw b jx ov kb ow kf ox kj oy kn oz kr or os ot ou bi translated">当用户B提交表单时，提交的数据被发送到服务器。用户A可以在其帐户中查看提交的数据。</li></ol><p id="39ce" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在第三步中，以下请求发送:</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div class="gh gi pa"><img src="../Images/7213b6f59e158940ce8840b5a83a8905.png" data-original-src="https://miro.medium.com/v2/resize:fit:1084/format:webp/1*DAMRZnrRFxEesEtPs_hAWw.png"/></div></figure><p id="5119" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">上述请求具有以下结构:</p><pre class="kt ku kv kw gt mu mv mw mx aw my bi"><span id="793c" class="mz lf iq mv b gy na nb l nc nd">formapi/api/<strong class="mv ir">&lt;ownerTenantID&gt;</strong>/users/<strong class="mv ir">&lt;ownerID&gt;</strong>/forms(<strong class="mv ir">&lt;formID&gt;</strong>)/responses</span></pre><p id="9d9d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">所有参数<strong class="jw ir"> ownerTenantID </strong>、<strong class="jw ir"> ownerID、</strong>和<strong class="jw ir"> ‌formID </strong>都与和我们共享表单的用户<strong class="jw ir">有关</strong>。当我们提交用户的表单时，我们可以访问所有这些参数，所以不需要找到任何参数。</p><p id="fe5c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我想到的情景是，我从受害者那里得到了所有必要的参数。<strong class="jw ir">为什么不使用$select查询选项并从服务器获取受害者的电子邮件呢？为此，我使用了select查询选项并发送了以下请求:</strong></p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div class="gh gi pb"><img src="../Images/f8ae16d8d8ff8af6bf9f9ae510f24dfe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1122/format:webp/1*EPk23qA_mxQwmHYrfkIYeQ.png"/></div></figure><p id="7389" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我发出上面的请求后，得到了404。服务器不允许我访问<strong class="jw ir"> createdBy </strong>属性或用户在<strong class="jw ir"> forms </strong>实体上的电子邮件，所以我试图找到另一种方法来访问<strong class="jw ir"> createdBy </strong>属性的值，于是我想到了一个主意:</p><p id="484e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir"> <em class="mf">"是否有另一个实体具有createdBy属性？并且与forms实体具有相同的实体键(formID)</em>T19】</strong></p><p id="e75e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">可能出现的问题是，为什么实体键应该与表单实体键相同？</p><p id="2ad1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">假设我们正在寻找的实体叫做x。</p><p id="7f6e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">x有<strong class="jw ir"> createdBy </strong>属性，我们的重点是访问这个属性的值，因为这个属性的值就是用户的电子邮件。另一方面，假设X有一个名为<strong class="jw ir"> accountID </strong>的实体键，它是一个随机字符串。要访问该电子邮件，我们必须发送以下请求:</p><pre class="kt ku kv kw gt mu mv mw mx aw my bi"><span id="ff92" class="mz lf iq mv b gy na nb l nc nd">formapi/api/&lt;ownerTenantID&gt;/users/&lt;ownerID&gt;/X(<strong class="mv ir">&lt;accountID&gt;</strong>)<strong class="mv ir">$select=createdBy</strong></span></pre><p id="15de" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这里的问题是<strong class="jw ir"> accountID </strong>因为我们不知道受害者的<strong class="jw ir"> accountID </strong>是什么，但是我们之前看到我们可以使用受害者的共享表单访问<strong class="jw ir"> formID </strong>。</p><p id="69b2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我试图寻找一个具有上述条件的实体类型。在查看了不同实体类型之间的关系后，我能够找到一个名为<strong class="jw ir"> runtimeForms </strong>的实体，它具有<strong class="jw ir"> createdBy </strong>属性，甚至具有与<strong class="jw ir"> forms </strong>相同的实体键！，它拥有我想要的所有条件:</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi pc"><img src="../Images/7af6352fbbd1c8c6ac30583c745fdc1e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*63K48uPocSA5ij3vDKxPbA.png"/></div></div></figure><p id="2fbd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我使用了<strong class="jw ir"> runtimeForms </strong>而不是<strong class="jw ir"> forms </strong>，然后我使用了<strong class="jw ir"> $select </strong>查询选项来访问电子邮件。通过发送以下请求，我终于设法进入了受害者的电子邮件:</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div class="gh gi pd"><img src="../Images/81bee9d860bcb3817dd510005a243dcd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1138/format:webp/1*Cp55rTwB4DtSzp7crHU9KQ.png"/></div></figure><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div class="gh gi pe"><img src="../Images/d023321852e79a9b6814145dc5cf6d61.png" data-original-src="https://miro.medium.com/v2/resize:fit:518/format:webp/1*u_fzGH5jqkYOJEEZkv5tsw.png"/></div></figure><figure class="kt ku kv kw gt jr"><div class="bz fp l di"><div class="pf pg l"/></div></figure><p id="4f53" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在这种攻击场景下，我可以在没有任何用户交互的情况下访问用户的电子邮件。最后，我得到了MSRC 2000美元的赏金；)</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div class="gh gi ph"><img src="../Images/cbddfc3750d2692faf5aba1abba706c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1070/format:webp/1*8EHlKXIlQZlju2sl4C9k5g.png"/></div></figure><p id="0e4f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我希望你喜欢这篇文章。始终在您的目标中寻找边缘案例，以找到更多有趣的漏洞！如果你喜欢这篇文章，请在Twitter上关注我:</p><p id="fcb8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">推特:<a class="ae ms" href="https://twitter.com/LogicalHunter" rel="noopener ugc nofollow" target="_blank"> @LogicalHunter </a></p><p id="d83c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">领英:【https://www.linkedin.com/in/borna-nematzadeh/ T2】</p></div></div>    
</body>
</html>